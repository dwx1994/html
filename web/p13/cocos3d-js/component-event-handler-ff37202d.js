System.register(["./deprecated-fd5a8e75.js","./deprecated-9a4df5e2.js"],(function(e){"use strict";var t,i,s,r,a,n,h,u,o,l,c,_,d,f,v,p,m,y,g,k,S,E,T,w,b,F,M,I,B,O,D,P,A,R,C,x,L,N,U,W,z,V,H,j,Y,G,X,K,q,Z,J,Q,$,ee,te,ie,se,re,ae,ne,he,ue,oe,le,ce,_e,de,fe,ve,pe,me;return{setters:[function(e){t=e.j,i=e.d,s=e.aP,r=e.b,a=e.e,n=e.f,h=e.bl,u=e.l,o=e.x,l=e.z,c=e.y,_=e.v,d=e.P,f=e.D,v=e.i,p=e.I,m=e.U,y=e.as,g=e.p,k=e.bz,S=e.az,E=e.c,T=e.t,w=e._,b=e.s,F=e.F,M=e.g},function(e){I=e.f,B=e.bJ,O=e.bK,D=e.J,P=e.n,A=e.h,R=e.i,C=e.dh,x=e.di,L=e.bC,N=e.bD,U=e.U,W=e.W,z=e.dj,V=e.dk,H=e.dl,j=e.dm,Y=e.a2,G=e.b2,X=e.aj,K=e.dn,q=e.b3,Z=e.dp,J=e.dq,Q=e.G,$=e.R,ee=e.cZ,te=e.C,ie=e.dr,se=e.$,re=e.K,ae=e.cs,ne=e.ct,he=e.bR,ue=e.d3,oe=e.cJ,le=e.cI,ce=e.P,_e=e.ds,de=e.d0,fe=e.bh,ve=e.b9,pe=e.dt,me=e.cX}],execute:function(){var ye=e("R",function(){function e(t){i(this,e),this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._framebuffer=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1}return t(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"shouldSyncSizeWithSwapchain",get:function(){return this._shouldSyncSizeWithSwapchain}},{key:"hasOnScreenAttachments",get:function(){return this._hasOnScreenAttachments}},{key:"hasOffScreenAttachments",get:function(){return this._hasOffScreenAttachments}}],[{key:"registerCreateFunc",value:function(t){t._createWindowFun=function(t){return new e(t)}}}]),t(e,[{key:"initialize",value:function(e,t){void 0!==t.title&&(this._title=t.title),void 0!==t.swapchainBufferIndices&&(this._swapchainBufferIndices=t.swapchainBufferIndices),void 0!==t.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=t.shouldSyncSizeWithSwapchain),this._width=t.width,this._height=t.height,this._nativeWidth=this._width,this._nativeHeight=this._height;for(var i=t.renderPassInfo,s=i.colorAttachments,r=i.depthStencilAttachment,a=0;a<s.length;a++)s[a].format===I.UNKNOWN&&(s[a].format=e.colorFormat);r&&r.format===I.UNKNOWN&&(r.format=e.depthStencilFormat),this._renderPass=e.createRenderPass(t.renderPassInfo);for(var n=0;n<s.length;n++){var h=null;this._swapchainBufferIndices&1<<n?this._hasOnScreenAttachments=!0:(h=e.createTexture({type:B.TEX2D,usage:O.COLOR_ATTACHMENT|O.SAMPLED,format:s[n].format,width:this._width,height:this._height}),this._hasOffScreenAttachments=!0),this._colorTextures.push(h)}return r&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=e.createTexture({type:B.TEX2D,usage:O.DEPTH_STENCIL_ATTACHMENT|O.SAMPLED,format:r.format,width:this._width,height:this._height}),this._hasOffScreenAttachments=!0):this._hasOnScreenAttachments=!0),this._framebuffer=e.createFramebuffer({renderPass:this._renderPass,colorTextures:this._colorTextures,depthStencilTexture:this._depthStencilTexture}),!0}},{key:"destroy",value:function(){this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null)}},{key:"resize",value:function(e,t){if(this._width=e,this._height=t,e>this._nativeWidth||t>this._nativeHeight){this._nativeWidth=e,this._nativeHeight=t;var i=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(e,t),i=!0);for(var s=0;s<this._colorTextures.length;s++){var r=this._colorTextures[s];r&&(r.resize(e,t),i=!0)}i&&this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorTextures:this._colorTextures,depthStencilTexture:this._depthStencilTexture}))}}}]),e}()),ge=e("a",function(){function e(){i(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return t(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}()),ke=new s("Scheduler"),Se=function e(t,s,r,a){i(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=s,this.paused=r,this.markedForDeletion=a};Se.get=function(e,t,i,s){var r=Se._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=s):r=new Se(e,t,i,s),r},Se.put=function(e){Se._listEntries.length<20&&(e.target=null,Se._listEntries.push(e))},Se._listEntries=[];var Ee=function e(t,s,r,a){i(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=s,this.target=r,this.callback=a};Ee.get=function(e,t,i,s){var r=Ee._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=s):r=new Ee(e,t,i,s),r},Ee.put=function(e){Ee._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,Ee._hashUpdateEntries.push(e))},Ee._hashUpdateEntries=[];var Te=function e(t,s,r,a,n,h){i(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=s,this.timerIndex=r,this.currentTimer=a,this.currentTimerSalvaged=n,this.paused=h};Te.get=function(e,t,i,s,r,a){var n=Te._hashTimerEntries.pop();return n?(n.timers=e,n.target=t,n.timerIndex=i,n.currentTimer=s,n.currentTimerSalvaged=r,n.paused=a):n=new Te(e,t,i,s,r,a),n},Te.put=function(e){Te._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,Te._hashTimerEntries.push(e))},Te._hashTimerEntries=[];var we=function(){function e(){i(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return t(e,[{key:"initWithCallback",value:function(e,t,i,s,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=s,this._delay=a,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===u.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();we._timers=[],we.get=function(){return we._timers.pop()||new we},we.put=function(e){we._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,we._timers.push(e))};var be=e("S",function(e){function s(){var e;return i(this,s),(e=a(this,n(s).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=h(!0),e._hashForTimers=h(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return r(s,e),t(s,null,[{key:"enableForTarget",value:function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?o(1513):e.id=ke.getNewId())}}]),t(s,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,s,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,s=(i=this._updatesNegList).length;t<s;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,s=(i=this._updates0List).length;t<s;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,s=(i=this._updatesPosList).length;t<s;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var n=this._arrayForTimers;for(t=0;t<n.length;t++){if(a=n[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,s,r,a){if("function"!=typeof e){var n=e;e=t,t=n}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!s,s=u.macro.REPEAT_FOREVER,r=0),l(t,1502);var h=t.uuid||t.id;if(h){var d,f,v=this._hashForTimers[h];if(v?v.paused!==a&&o(1511):(v=Te.get(null,t,0,null,null,a),this._arrayForTimers.push(v),this._hashForTimers[h]=v),null==v.timers)v.timers=[];else for(f=0;f<v.timers.length;++f)if((d=v.timers[f])&&e===d._callback)return _(1507,d.getInterval(),i),void(d._interval=i);(d=we.get()).initWithCallback(this,e,t,i,s,r),v.timers.push(d),this._currentTarget===v&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else c(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var s=e.uuid||e.id;if(s){var r=this._hashForUpdates[s];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return _(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,n=Se.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,n)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,n,t)),this._hashForUpdates[s]=Ee.get(a,n,e,null)}else c(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var s=this._hashForTimers[i];if(s)for(var r=s.timers,a=0,n=r.length;a<n;a++){var h=r[a];if(e===h._callback)return h!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),r.splice(a,1),we.put(h),s.timerIndex>=a&&s.timerIndex--,void(0===r.length&&(this._currentTarget===s?this._currentTargetSalvaged=!0:this._removeHashElement(s)))}}else c(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else c(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var s=i.timers;s.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=s.length;r<a;r++)we.put(s[r]);s.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else c(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(u.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,s,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(s=this._updatesNegList[t])&&s.priority>=e&&this.unscheduleUpdate(s.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(s=this._updates0List[t])&&this.unscheduleUpdate(s.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(s=this._updatesPosList[t])&&s.priority>=e&&this.unscheduleUpdate(s.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){l(e,1508),l(t,1509);var i=t.uuid||t.id;if(i){var s=this._hashForTimers[i];if(!s)return!1;if(null==s.timers)return!1;for(var r=s.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}c(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(u.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,s,r,a=[],n=this._arrayForTimers;for(i=0,s=n.length;i<s;i++)(t=n[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){l(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var s=this._hashForUpdates[t];s&&(s.entry.paused=!0)}else c(1510)}},{key:"resumeTarget",value:function(e){l(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var s=this._hashForUpdates[t];s&&(s.entry.paused=!1)}else c(1510)}},{key:"isTargetPaused",value:function(e){l(e,1505);var t=e.uuid||e.id;if(!t)return c(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var s=this._hashForUpdates[t];return!!s&&s.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,s=0,r=i.length;s<r;s++)if(i[s]===e){i.splice(s,1);break}Te.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var s=i.list,r=i.entry,a=0,n=s.length;a<n;a++)if(s[a]===r){s.splice(a,1);break}delete this._hashForUpdates[t],Se.put(r),Ee.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var s=0;s<e.length;s++)if(i<e[s].priority)return void e.splice(s,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),s}(ge));be.PRIORITY_SYSTEM=1<<31,be.PRIORITY_NON_SYSTEM=be.PRIORITY_SYSTEM+1,be.ID="scheduler",u.Scheduler=be;var Fe,Me=function(){function e(t){i(this,e),this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new D(t),this.jointAnimationInfo=new P(t)}return t(e,[{key:"releaseSkeleton",value:function(e){this.jointTexturePool.releaseSkeleton(e)}},{key:"releaseAnimationClip",value:function(e){this.jointTexturePool.releaseAnimationClip(e)}},{key:"clear",value:function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}}]),e}(),Ie=e("M",function(){function e(t){i(this,e),this.vData=null,this.iData=null,this.attributes=null,this.vertexBuffers=[],this.indexBuffer=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=t}return t(e,[{key:"initialize",value:function(e,t){this._outOfCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer({usage:A.VERTEX|A.TRANSFER_DST,memUsage:R.HOST|R.DEVICE,size:i,stride:i}));var s=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this.indexBuffer=this._batcher.device.createBuffer({usage:A.INDEX|A.TRANSFER_DST,memUsage:R.HOST|R.DEVICE,size:s,stride:s})),this.attributes=e,this._reallocBuffer()}},{key:"request",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;this.lastByteOffset=this.byteOffset;var i=this.byteOffset+e*this._vertexFormatBytes,s=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._batcher.autoMergeBatches(),this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;var r=this.vData.byteLength,a=this.iData.length;if(i>r||s>a){for(;r<i||a<s;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,a=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=i,this._dirty=!0,!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}},{key:"destroy",value:function(){this.attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this.indexBuffer=null;for(var e=0;e<this._hInputAssemblers.length;e++)C.free(this._hInputAssemblers[e]);this._hInputAssemblers.length=0}},{key:"recordBatch",value:function(){var e=this.indicesOffset-this.indicesStart;if(!e)return x;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(C.alloc(this._batcher.device,this));var t=this._hInputAssemblers[this._nextFreeIAHandle++],i=C.get(t);return i.firstIndex=this.indicesStart,i.indexCount=e,t}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this._dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),s=0,r=t.length;s<r;s++)i[s]=t[s]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,s=0,r=t.length;s<r;s++)i[s]=t[s]}}]),e}());Ie.OPACITY_OFFSET=8,function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL"}(Fe||(Fe={}));var Be=e("b",function(){function e(){i(this,e),this.stage=Fe.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:L.ALWAYS,stencilMask:65535,writeMask:65535,failOp:N.KEEP,zFailOp:N.KEEP,passOp:N.KEEP,ref:1}}return t(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=Fe.CLEAR}},{key:"enterLevel",value:function(){this.stage=Fe.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=Fe.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=Fe.DISABLED:this.stage=Fe.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;if(this.stage===Fe.DISABLED)t.stencilTest=!1,t.func=L.ALWAYS,t.failOp=N.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1;else if(t.stencilTest=!0,this.stage===Fe.ENABLED)t.func=L.EQUAL,t.failOp=N.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask();else if(this.stage===Fe.CLEAR){var i=this._maskStack[this._maskStack.length-1];t.func=L.NEVER,t.failOp=i.inverted?N.REPLACE:N.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}else if(this.stage===Fe.ENTER_LEVEL){var s=this._maskStack[this._maskStack.length-1];t.func=L.NEVER,t.failOp=s.inverted?N.ZERO:N.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}return this._changed(e.passes[0])}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=Fe.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}},{key:"pattern",get:function(){return this._stencilPattern}}]),e}());Be.sharedManager=null,Be.sharedManager=new Be;var Oe=function(e){function s(){var e;return i(this,s),(e=a(this,n(s).call(this)))._subModel=void 0,e.type=U.UI_BATCH,e._subModel=new De,e._subModel.initialize(),e._subModels[0]=e._subModel,e}return r(s,e),t(s,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();this._updateStamp=e,this._transformUpdated&&(this._transformUpdated=!1)}},{key:"directInitialize",value:function(e){this._subModel.directInitialize(e.material.passes,e.hInputAssembler,e.hDescriptorSet)}},{key:"destroy",value:function(){this._subModel.destroy()}}]),s}(W),De=function(e){function s(){return i(this,s),a(this,n(s).apply(this,arguments))}return r(s,e),t(s,[{key:"initialize",value:function(){this._handle=z.alloc(),z.set(this._handle,V.PRIORITY,H.DEFAULT)}},{key:"directInitialize",value:function(e,t,i){this._passes=e,this._flushPassInfo(),z.set(this._handle,V.INPUT_ASSEMBLER,t),z.set(this._handle,V.DESCRIPTOR_SET,i),this._inputAssembler=C.get(t),this._descriptorSet=j.get(i)}},{key:"destroy",value:function(){z.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=H.DEFAULT,this._handle=x,this._patches=null,this._subMesh=null,this._passes=null}}]),s}(Y),Pe={layout:null},Ae=e("U",function(){function e(){i(this,e),this.bufferBatch=null,this.camera=null,this.model=null,this.material=null,this.texture=null,this.sampler=null,this.hInputAssembler=x,this.hDescriptorSet=x,this.useLocalData=null,this.isStatic=!1;var t=u.director.root,s=G.get("builtin-sprite").shaders[0].name;X.getGFXShader(t.device,s,{USE_TEXTURE:!0},t.pipeline),Pe.layout=X.getPipelineLayout(s).setLayouts[K.LOCAL],this.hDescriptorSet=j.alloc(t.device,Pe)}return t(e,[{key:"destroy",value:function(e){this.hDescriptorSet&&(j.free(this.hDescriptorSet),this.hDescriptorSet=x)}},{key:"clear",value:function(){this.bufferBatch=null,this.hInputAssembler=x,this.camera=null,this.material=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1}}]),e}()),Re=function(){function e(){i(this,e),this._material=null,this._pass=null,this._hDescriptorSet=x,this._refCount=0}return t(e,[{key:"initialize",value:function(e){return!!e.material&&(this._material=new q,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._hDescriptorSet=Z.get(this._pass.handle,J.DESCRIPTOR_SET),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"destroy",value:function(){this._material&&(this._material.destroy(),this._material=null),this._refCount=0}},{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}},{key:"hDescriptorSet",get:function(){return this._hDescriptorSet}}]),e}(),Ce=e("v",[{name:Q.ATTR_POSITION,format:I.RGB32F},{name:Q.ATTR_TEX_COORD,format:I.RG32F},{name:Q.ATTR_COLOR,format:I.RGBA32F}]);e("c",Object.freeze({__proto__:null,vfmt:Ce}));var xe=function(){function e(t){var s=this;i(this,e),this.device=void 0,this._screens=[],this._bufferBatchPool=new $((function(){return new Ie(s)}),128),this._drawBatchPool=void 0,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new q,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currCanvas=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._parentOpacity=1,this._root=t,this.device=t.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new d((function(){var e=u.director.root.createModel(Oe);return e.enabled=!0,e.visFlags|=ee.Enum.UI_3D,e}),2),this._modelInUse=new te(10),this._batches=new te(64),this._drawBatchPool=new d((function(){return new Ae}),128),u.director.on(u.Director.EVENT_BEFORE_DRAW,this.update,this)}return t(e,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}}]),t(e,[{key:"initialize",value:function(){return this._attributes=Ce,this._requireBufferBatch(),!0}},{key:"destroy",value:function(){for(var e=this,t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(var i=0;i<this._meshBuffers.length;i++)this._meshBuffers[i].destroy();this._drawBatchPool&&this._drawBatchPool.destroy((function(t){t.destroy(e)})),this._uiModelPool&&this._uiModelPool.destroy((function(e){e.destroy()})),this._meshBuffers.splice(0),u.director.root.destroyScene(this._scene),u.director.off(u.Director.EVENT_BEFORE_DRAW,this.update,this)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new Re;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;i++){var s=t[i];if(s.camera){var r=s.camera.view.visibility,a=this._canvasMaterials.get(r);if(a){for(var n=a.keys(),h=n.next();!h.done;)this._removeUIMaterial(h.value),h=n.next();a.clear()}}}this._screens.push(e),this._screens.sort(this._screenSort);for(var u=0;u<t.length;u++){var o=t[u];o.camera&&(o.camera.view.visibility=ee.BitMask.UI_2D|u+1,this._canvasMaterials.has(o.camera.view.visibility)||this._canvasMaterials.set(o.camera.view.visibility,new Map))}}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var s=t[i];if(s.camera&&s.camera.view.visibility===e)return s}return null}},{key:"removeScreen",value:function(e){var t=this,i=this._screens.indexOf(e);if(-1!==i){if(this._screens.splice(i,1),e.camera){for(var s=this._canvasMaterials.get(e.camera.view.visibility),r=s.keys(),a=r.next();!a.done;)this._removeUIMaterial(a.value),a=r.next();s.clear()}for(var n,h=i;h<this._screens.length;h++)(n=this._screens[h].camera)&&function(){var e=t._canvasMaterials.get(n.view.visibility);n.view.visibility=ee.BitMask.UI_2D|h+1;var i=t._canvasMaterials.get(n.view.visibility);e.forEach((function(e,t){i.set(t,e)})),e.clear()}()}}},{key:"update",value:function(e){if(this._renderScreens(),this._batches.length>0)for(var t=this._meshBuffers,i=0;i<t.length;++i){var s=t[i];s.uploadData(),s.reset()}this.render(),this._reset()}},{key:"sortScreens",value:function(){this._screens.sort(this._screenSort)}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._scene.removeModel(this._modelInUse.get(t)),this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var s=this._batches.array[i];if(s.model){if(s.camera){var r=s.camera.view.visibility;s.model.visFlags=r,s.model.node.layer=r}for(var a=s.model.subModels,n=0;n<a.length;n++)a[n].priority=e++}else{var h=j.get(s.hDescriptorSet),u=ie.SAMPLER_SPRITE;h.bindTexture(u,s.texture),h.bindSampler(u,s.sampler),h.update();var o=this._uiModelPool.alloc();o.directInitialize(s),this._scene.addModel(o),o.subModels[0].priority=e++,s.camera&&(o.visFlags=s.camera.view.visibility,null==this._canvasMaterials.get(s.camera.view.visibility).get(s.material.hash)&&this._canvasMaterials.get(s.camera.view.visibility).set(s.material.hash,1)),this._modelInUse.push(o)}}}},{key:"commitComp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=e,a=t,n=s,h=r.getRenderMaterial(0);h||(h=r._updateBuiltinMaterial(),h=r._updateBlendFunc()),this._currMaterial===h&&this._currTexture===a&&this._currSampler===n||(this.autoMergeBatches(this._currComponent),this._currComponent=r,this._currMaterial=h,this._currTexture=a,this._currSampler=n),i&&(i.fillBuffers(r,this),this._applyOpacity(r))}},{key:"commitModel",value:function(e,t,i){if(this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i){var s=!1;if(Be.sharedManager.handleMaterial(i)){var r=Be.sharedManager.pattern;i.overridePipelineStates({depthStencilState:{stencilTestFront:r.stencilTest,stencilFuncFront:r.func,stencilReadMaskFront:r.stencilMask,stencilWriteMaskFront:r.writeMask,stencilFailOpFront:r.failOp,stencilZFailOpFront:r.zFailOp,stencilPassOpFront:r.passOp,stencilRefFront:r.ref,stencilTestBack:r.stencilTest,stencilFuncBack:r.func,stencilReadMaskBack:r.stencilMask,stencilWriteMaskBack:r.writeMask,stencilFailOpBack:r.failOp,stencilZFailOpBack:r.zFailOp,stencilPassOpBack:r.passOp,stencilRefBack:r.ref}}),s=!0}if(s&&t)for(var a=0;a<t.subModels.length;a++)t.setSubModelMaterial(a,i)}var n=this._currCanvas,h=this._drawBatchPool.alloc();h.camera=n&&n.camera,h.model=t,h.bufferBatch=null,h.material=i,h.texture=null,h.sampler=null,this._currMaterial=this._emptyMaterial,this._currComponent=null,this._currTexture=null,this._currSampler=null,this._batches.push(h)}},{key:"commitStaticBatch",value:function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}},{key:"autoMergeBatches",value:function(e){var t=this._currMeshBuffer,i=this._currCanvas,s=t.recordBatch(),r=this._currMaterial;if(s&&r){if(e&&Be.sharedManager.handleMaterial(r)){this._currMaterial=r=e.getUIMaterialInstance();var a=Be.sharedManager.pattern;r.overridePipelineStates({depthStencilState:{stencilTestFront:a.stencilTest,stencilFuncFront:a.func,stencilReadMaskFront:a.stencilMask,stencilWriteMaskFront:a.writeMask,stencilFailOpFront:a.failOp,stencilZFailOpFront:a.zFailOp,stencilPassOpFront:a.passOp,stencilRefFront:a.ref,stencilTestBack:a.stencilTest,stencilFuncBack:a.func,stencilReadMaskBack:a.stencilMask,stencilWriteMaskBack:a.writeMask,stencilFailOpBack:a.failOp,stencilZFailOpBack:a.zFailOp,stencilPassOpBack:a.passOp,stencilRefBack:a.ref}})}var n=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();n.camera=i&&i.camera,n.bufferBatch=t,n.material=r,n.texture=this._currTexture,n.sampler=this._currSampler,n.hInputAssembler=s,this._batches.push(n),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexture=t,this.autoMergeBatches()}},{key:"finishMergeBatches",value:function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e.children.length,s=this._parentOpacity;if(this._parentOpacity*=e._uiProps.opacity,this._preprocess(e),i>0&&!e._static)for(var r=e.children,a=0;a<r.length;++a){var n=r[a];this._walk(n,t)}this._postprocess(e),this._parentOpacity=s,t+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&(this._currCanvas=i,this._recursiveScreenNode(i.node))}}},{key:"_preprocess",value:function(e){if(e._uiProps.uiTransformComp){e._uiProps.uiTransformComp._canvas=this._currCanvas;var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}}},{key:"_postprocess",value:function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches(this._currComponent)}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._parentOpacity=1,this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=null,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._meshBufferUseCount=0,this._requireBufferBatch(),Be.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}},{key:"_screenSort",value:function(e,t){var i=e.priority-t.priority;return 0===i?e.node.getSiblingIndex()-t.node.getSiblingIndex():i}},{key:"_applyOpacity",value:function(e){for(var t=e.color.a/255,i=this._parentOpacity=this._parentOpacity*t,s=this._currMeshBuffer.byteOffset>>2,r=this._currMeshBuffer.vData,a=this._currMeshBuffer.lastByteOffset>>2;a<s;a+=9)r[a+Ie.OPACITY_OFFSET]=i;this._currMeshBuffer.lastByteOffset=this._currMeshBuffer.byteOffset}},{key:"getFirstRenderCamera",value:function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,i=0;i<t.length;i++){var s=t[i];if(s.visibility&e.layer)return s}return null}}]),e}(),Le=function(){function e(t){var s=this;i(this,e),this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._dataPoolMgr=void 0,this._scenes=[],this._cameras=[],this._views=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._device=t,this._dataPoolMgr=new Me(t),se.registerCreateFunc(this),ye.registerCreateFunc(this),this._cameraPool=new d((function(){return new re(s._device)}),4)}return t(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}}]),t(e,[{key:"initialize",value:function(e){var t=this,i=new ae,s=new ne;return s.depthStoreOp=he.DISCARD,s.stencilStoreOp=he.DISCARD,this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:{colorAttachments:[i],depthStencilAttachment:s},swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,ue.initBuiltinRes(this._device),u.view.on("design-resolution-changed",(function(){var e=u.game.canvas.width,i=u.game.canvas.height;t.resize(e,i)}),this),!0}},{key:"destroy",value:function(){this.clearCameras(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear()}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(var i,s=f(this._windows);!(i=s()).done;){var r=i.value;r.shouldSyncSizeWithSwapchain&&r.resize(e,t)}for(var a,n=f(this._cameras);!(a=n()).done;){var h=a.value;h.isWindowSize&&h.resize(e,t)}}},{key:"setRenderPipeline",value:function(e){if(e||(e=new oe).initialize({flows:[]}),this._pipeline=e,!this._pipeline.activate())return!1;var t=u.director.getScene();return t&&t.globals.activate(),this.onGlobalPipelineStateChanged(),this._ui&&this._ui.destroy(),this._ui=new xe(this),!!this._ui.initialize()||(this.destroy(),!1)}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=0;e<this._cameras.length;e++)this._cameras[e].view.onGlobalPipelineStateChanged();for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged()}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){if(this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._pipeline){this._device.acquire(),this._views.length=0;for(var t=this._cameras,i=u.director.getTotalFrames(),s=0;s<t.length;s++){var r=this._cameras[s],a=r.view;a.isEnable&&a.window&&(r.update(),r.scene.update(i),this._views.push(a))}this._pipeline.render(this._views),this._device.present()}}},{key:"createWindow",value:function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){for(var e,t=f(this._windows);!(e=t()).done;){e.value.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){for(var e,t=f(this._scenes);!(e=t()).done;){e.value.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=new le;return t.initialize(e),t}},{key:"attachCamera",value:function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortViews()}},{key:"detachCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)}},{key:"clearCameras",value:function(){this._cameras.length=0}},{key:"createModel",value:function(e){var t=this._modelPools.get(e);return t||(this._modelPools.set(e,new d((function(){return new e}),10)),t=this._modelPools.get(e)),t.alloc()}},{key:"destroyModel",value:function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):console.warn("'".concat(e.constructor.name,"'is not in the model pool and cannot be destroyed by destroyModel.")),e.destroy()}},{key:"createCamera",value:function(){return this._cameraPool.alloc()}},{key:"destroyCamera",value:function(e){this._cameraPool.free(e),e.destroy(),e.scene&&e.scene.removeCamera(e),e.isWindowSize=!0}},{key:"createLight",value:function(e){var t=this._lightPools.get(e);return t||(this._lightPools.set(e,new d((function(){return new e}),4)),t=this._lightPools.get(e)),t.alloc()}},{key:"destroyLight",value:function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case ce.SPHERE:e.scene.removeSphereLight(e);break;case ce.SPOT:e.scene.removeSpotLight(e)}e.destroy()}},{key:"sortViews",value:function(){this._cameras.sort((function(e,t){return e.view.priority-t.view.priority}))}}]),e}(),Ne=e("D",function(e){function s(){var e;return i(this,s),(e=a(this,n(s).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new be,e._compScheduler=new _e,e._nodeActivator=new de,e._systems=[],u.game.once(fe.EVENT_RENDERER_INITED,e._initOnRendererInitialized,v(e)),e}return r(s,e),t(s,[{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=u.game.container,i=u.view,s=t.getBoundingClientRect(),r=s.left+window.pageXOffset-t.clientLeft,a=s.top+window.pageYOffset-t.clientTop,n=i._devicePixelRatio*(e.x-r),h=i._devicePixelRatio*(a+s.height-e.y);return i._isRotated?p(i._viewportRect.width-h,n):p(n,h)}},{key:"convertToUI",value:function(e){var t=u.game.container,i=u.view,s=t.getBoundingClientRect(),r=s.left+window.pageXOffset-t.clientLeft,a=s.top+window.pageYOffset-t.clientTop,n=p(0,0);return i._isRotated?(n.x=r+e.y/i._devicePixelRatio,n.y=a+s.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(n.x=r+e.x*i._devicePixelRatio,n.y=a+s.height-e.y*i._devicePixelRatio),n}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return m(u.winSize)}},{key:"getWinSizeInPixels",value:function(){return m(u.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){u.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),ve&&ve.setEnabled(!1),u.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),u.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(s.EVENT_RESET),ve&&ve.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){l(e instanceof u.Scene,1216);var s=u.loader._getReferenceKey(e.uuid);u.loader.removeItem(s),e._load();for(var r=Object.keys(u.game._persistRootNodes).map((function(e){return u.game._persistRootNodes[e]})),a=0;a<r.length;a++){var n=r[a];n.emit(u.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var h=e.getChildByUuid(n.uuid);if(h){var o=h.getSiblingIndex();h._destroyImmediate(),e.insertChild(n,o)}else n.parent=e}var c=this._scene,_=c&&c.autoReleaseAssets&&c.dependAssets;pe(_,e.dependAssets,r),u.isValid(c)&&c.destroy(),this._scene=null,y._deferredDestroy(),t&&t(),this.emit(u.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(u.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var s=this;l(e,1205),l(e instanceof u.Scene,1216),e._load(),this.once(u.Director.EVENT_AFTER_DRAW,(function(){s.runSceneImmediate(e,t,i)}))}},{key:"_getSceneUuid",value:function(e){var t=u.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var s=t[i];if(s.url.endsWith(e))return s}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];c(1206,e)}else c(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return c(1208,e,this._loadingScene),!1;var s=this._getSceneUuid(e);if(s){var r=s.uuid;return this.emit(u.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return c(1209,e),!1}},{key:"preloadScene",value:function(e,t,i){var s,r;void 0===i?(r=t,s=void 0):(r=i,s=t);var a=this._getSceneUuid(e);if(a)this.emit(u.Director.EVENT_BEFORE_SCENE_LOADING,e),u.loader.load({uuid:a.uuid,type:"uuid"},s,(function(t,i){t&&c(1210,e,t.message),r&&r(t,i)}));else{var n='Can not preload the scene "'+e+'" because it is not in the build settings.';r&&r(new Error(n)),g("preloadScene: "+n)}}},{key:"_loadSceneByUuid",value:function(e,t,i,s){var r,a;r=t,a=i,console.time("LoadScene "+e),u.AssetLibrary.loadAsset(e,(function(t,i){console.timeEnd("LoadScene "+e);var s=Ke;if(s._loadingScene="",t)g(t="Failed to load scene: "+t);else{if(i instanceof u.SceneAsset){var n=i.scene;return n._id=i._uuid,n._name=i._name,void s.runSceneImmediate(n,a,r)}g(t="The asset "+e+" is not a scene")}r&&r(t)}))}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||_(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){u.Camera.main&&(u.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){u.Camera.main&&(u.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/u.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){u.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(be.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(ge.sortByPriority)}},{key:"unregisterSystem",value:function(e){k.fastRemove(this._systems,e),this._systems.sort(ge.sortByPriority)}},{key:"getSystem",value:function(e){return this._systems.find((function(t){return t.id===e}))}},{key:"getAnimationManager",value:function(){return this.getSystem(u.AnimationManager.ID)}},{key:"startAnimation",value:function(){this._invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this._invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime();var t=this._deltaTime;if(!this._paused){this.emit(s.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(s.EVENT_AFTER_UPDATE),y._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(t)}this.emit(s.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(s.EVENT_AFTER_DRAW),ve.frameUpdateListeners(),me.bookOfChange.clear(),this._totalFrames++}}},{key:"_initOnRendererInitialized",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,ve&&ve.setEnabled(!0),this.registerSystem(be.ID,this._scheduler,200),this.emit(s.EVENT_INIT)}},{key:"_init",value:function(){u.loader.init(this),this._root=new Le(u.game._gfxDevice);return!!this._root.initialize({})||(c(1217),!1)}},{key:"root",get:function(){return this._root}}]),s}(S));Ne.EVENT_INIT="director_init",Ne.EVENT_RESET="director_reset",Ne.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",Ne.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",Ne.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",Ne.EVENT_BEFORE_UPDATE="director_before_update",Ne.EVENT_AFTER_UPDATE="director_after_update",Ne.EVENT_BEFORE_DRAW="director_before_draw",Ne.EVENT_AFTER_DRAW="director_after_draw",Ne.EVENT_BEFORE_PHYSICS="director_before_physics",Ne.EVENT_AFTER_PHYSICS="director_after_physics",Ne.instance=void 0,u.Director=Ne;var Ue,We,ze,Ve,He,je,Ye,Ge,Xe,Ke=e("d",Ne.instance=u.director=new Ne),qe=e("E",(Ue=E("cc.ClickEvent"),We=T(u.Node),Ue((He=w((Ve=function(){function e(){i(this,e),M(this,"target",He,this),M(this,"component",je,this),M(this,"_componentId",Ye,this),M(this,"handler",Ge,this),M(this,"customEventData",Xe,this)}return t(e,[{key:"emit",value:function(e){var t=this.target;if(u.isValid(t)){this._genCompIdIfNeeded();var i=u.js._getClassById(this._componentId),s=t.getComponent(i);if(u.isValid(s)){var r=s[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(s,e))}}}},{key:"_compName2Id",value:function(e){var t=u.js.getClassByName(e);return u.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=u.js._getClassById(e);return u.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(t){for(var i=arguments.length,s=new Array(i>1?i-1:0),r=1;r<i;r++)s[r-1]=arguments[r];for(var a=0,n=t.length;a<n;a++){var h=t[a];h instanceof e&&h.emit(s)}}}]),e}()).prototype,"target",[We],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),je=w(Ve.prototype,"component",[b,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ye=w(Ve.prototype,"_componentId",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ge=w(Ve.prototype,"handler",[b,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xe=w(Ve.prototype,"customEventData",[b,F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ze=Ve))||ze));u.Component.EventHandler=qe}}}));
