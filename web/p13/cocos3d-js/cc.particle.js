System.register(["./deprecated-fd5a8e75.js","./deprecated-9a4df5e2.js","./index-597c71d0.js","./SubContextView-ee466772.js","./component-event-handler-ff37202d.js"],(function(t){"use strict";var e,i,r,a,n,o,s,l,u,h,c,_,d,p,f,m,y,v,b,g,M,w,T,S,O,z,x,C,E,A,R,D,F,k,I,P,L,B,U,V,G,N,H,W,X,j,K,Y,Z,q,Q,J,$,tt,et,it,rt,at,nt,ot,st,lt,ut,ht,ct,_t,dt,pt,ft,mt,yt,vt,bt,gt,Mt,wt,Tt,St,Ot,zt,xt;return{setters:[function(t){e=t.c,i=t.t,r=t.b2,a=t._,n=t.h,o=t.m,s=t.a,l=t.s,u=t.b,h=t.j,c=t.a5,_=t.a4,d=t.d,p=t.e,f=t.f,m=t.g,y=t.i,v=t.K,b=t.Y,g=t.l,M=t.C,w=t.V,T=t.D,S=t.aO,O=t.aj,z=t.a3,x=t.F,C=t.b0,E=t.ad,A=t.H,R=t.b3,D=t.a9,F=t.bK,k=t.M,I=t.Q,P=t.a6,L=t.a7,B=t.a8,U=t.r,V=t.bL,G=t.b5,N=t.ae,H=t.k,W=t.P,X=t.b4,j=t.b6,K=t.bF,Y=t.bM,Z=t.ap,q=t.n},function(t){Q=t.aY,J=t.aA,$=t.t,tt=t.G,et=t.f,it=t.W,rt=t.b3,at=t.d3,nt=t.U,ot=t.h,st=t.i,lt=t.bn,ut=t.c7,ht=t.b4,ct=t.dG,_t=t.aX,dt=t.dg,pt=t.dR,ft=t.d_,mt=t.aq,yt=t.R,vt=t.ai,bt=t.at,gt=t.ce,Mt=t.dQ,wt=t.de,Tt=t.d4,St=t.aO,Ot=t.cX},function(){},function(){},function(t){zt=t.d,xt=t.D}],execute:function(){var Ct,Et,At,Rt,Dt,Ft,kt,It,Pt,Lt,Bt,Ut,Vt,Gt,Nt,Ht,Wt,Xt,jt,Kt,Yt,Zt,qt,Qt,Jt,$t,te,ee,ie,re,ae,ne,oe,se,le,ue,he,ce,_e,de,pe,fe,me,ye,ve,be,ge,Me,we=(Ct=e("cc.Billboard"),Et=n(),At=o(),Rt=i(Q),Dt=i(Q),Ft=s(),kt=s(),It=s(),Pt=s(),Ht=Ct(Lt=Et(Lt=At(Lt=r((Ut=a((Bt=function(t){function e(){var t;return d(this,e),t=p(this,f(e).call(this)),m(t,"_texture",Ut,y(t)),m(t,"_height",Vt,y(t)),m(t,"_width",Gt,y(t)),m(t,"_rotation",Nt,y(t)),t._model=null,t._mesh=null,t._material=null,t._uniform=new v(1,1,0,0),t}return u(e,t),h(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*c(this._rotation))/100},set:function(t){this._rotation=_(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),h(e,[{key:"onLoad",value:function(){this.createModel()}},{key:"onEnable",value:function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"createModel",value:function(){this._mesh=J({primitiveMode:$.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[b.WHITE.r,b.WHITE.g,b.WHITE.b,b.WHITE.a,b.WHITE.r,b.WHITE.g,b.WHITE.b,b.WHITE.a,b.WHITE.r,b.WHITE.g,b.WHITE.b,b.WHITE.a,b.WHITE.r,b.WHITE.g,b.WHITE.b,b.WHITE.a],attributes:[{name:tt.ATTR_POSITION,format:et.RGB32F},{name:tt.ATTR_TEX_COORD,format:et.RG32F},{name:tt.ATTR_COLOR,format:et.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=g.director.root.createModel(it,this.node),this._model.initialize(this.node),null==this._material&&(this._material=new rt,this._material.copy(at.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)}}]),e}(M)).prototype,"_texture",[Rt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(Bt.prototype,"texture",[Dt,Ft],Object.getOwnPropertyDescriptor(Bt.prototype,"texture"),Bt.prototype),Vt=a(Bt.prototype,"_height",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a(Bt.prototype,"height",[kt],Object.getOwnPropertyDescriptor(Bt.prototype,"height"),Bt.prototype),Gt=a(Bt.prototype,"_width",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a(Bt.prototype,"width",[It],Object.getOwnPropertyDescriptor(Bt.prototype,"width"),Bt.prototype),Nt=a(Bt.prototype,"_rotation",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a(Bt.prototype,"rotation",[Pt],Object.getOwnPropertyDescriptor(Bt.prototype,"rotation"),Bt.prototype),Lt=Bt))||Lt)||Lt)||Lt)||Lt,t({Billboard:Ht,BillboardComponent:Ht}),Ht),Te=[{name:tt.ATTR_POSITION,format:et.RGB32F},{name:tt.ATTR_TEX_COORD,format:et.RGBA32F},{name:tt.ATTR_TEX_COORD1,format:et.RGB32F},{name:tt.ATTR_COLOR,format:et.RGBA8,isNormalized:!0}],Se=new w,Oe=new w,ze=function(t){function e(){var t;return d(this,e),(t=p(this,f(e).call(this)))._capacity=void 0,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=null,t._vertCount=0,t._indexCount=0,t._material=null,t.type=nt.LINE,t._capacity=100,t._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},t._iaInfoBuffer=t._device.createBuffer({usage:ot.INDIRECT,memUsage:st.HOST|st.DEVICE,size:lt,stride:lt}),t}return u(e,t),h(e,[{key:"setCapacity",value:function(t){this._capacity=t,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;for(var t,e=T(Te);!(t=e()).done;){var i=t.value;i.offset=this._vertSize,this._vertSize+=ut[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"updateMaterial",value:function(t){this._material=t,S(f(e.prototype),"setSubModelMaterial",this).call(this,0,t)}},{key:"createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer({usage:ot.VERTEX|ot.TRANSFER_DST,memUsage:st.HOST|st.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),r=0,a=0;a<this._capacity-1;++a){var n=2*a;i[r++]=n,i[r++]=n+1,i[r++]=n+2,i[r++]=n+3,i[r++]=n+2,i[r++]=n+1}var o=this._device.createBuffer({usage:ot.INDEX|ot.TRANSFER_DST,memUsage:st.HOST|st.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return o.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new ht([t],Te,$.TRIANGLE_LIST),this._subMeshData.indexBuffer=o,this._subMeshData.indirectBuffer=this._iaInfoBuffer,this.initSubModel(0,this._subMeshData,this._material),e}},{key:"addLineVertexData",value:function(t,e,i){if(t.length>1){var r=0;w.subtract(Se,t[1],t[0]),this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=0,this._vdataF32[r++]=Se.x,this._vdataF32[r++]=Se.y,this._vdataF32[r++]=Se.z,this._vdataUint32[r++]=i.evaluate(0,1)._val,this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=1,this._vdataF32[r++]=Se.x,this._vdataF32[r++]=Se.y,this._vdataF32[r++]=Se.z,this._vdataUint32[r++]=i.evaluate(0,1)._val;for(var a=1;a<t.length-1;a++){w.subtract(Se,t[a-1],t[a]),w.subtract(Oe,t[a+1],t[a]),w.subtract(Oe,Oe,Se);var n=a/t.length;this._vdataF32[r++]=t[a].x,this._vdataF32[r++]=t[a].y,this._vdataF32[r++]=t[a].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(n,1),this._vdataF32[r++]=n,this._vdataF32[r++]=0,this._vdataF32[r++]=Oe.x,this._vdataF32[r++]=Oe.y,this._vdataF32[r++]=Oe.z,this._vdataUint32[r++]=i.evaluate(n,1)._val,this._vdataF32[r++]=t[a].x,this._vdataF32[r++]=t[a].y,this._vdataF32[r++]=t[a].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(n,1),this._vdataF32[r++]=n,this._vdataF32[r++]=1,this._vdataF32[r++]=Oe.x,this._vdataF32[r++]=Oe.y,this._vdataF32[r++]=Oe.z,this._vdataUint32[r++]=i.evaluate(n,1)._val}w.subtract(Se,t[t.length-1],t[t.length-2]),this._vdataF32[r++]=t[t.length-1].x,this._vdataF32[r++]=t[t.length-1].y,this._vdataF32[r++]=t[t.length-1].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=0,this._vdataF32[r++]=Se.x,this._vdataF32[r++]=Se.y,this._vdataF32[r++]=Se.z,this._vdataUint32[r++]=i.evaluate(1,1)._val,this._vdataF32[r++]=t[t.length-1].x,this._vdataF32[r++]=t[t.length-1].y,this._vdataF32[r++]=t[t.length-1].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=1,this._vdataF32[r++]=Se.x,this._vdataF32[r++]=Se.y,this._vdataF32[r++]=Se.z,this._vdataUint32[r++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))}},{key:"updateIA",value:function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),e}(it),xe=C,Ce=O({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),Ee=t("CurveRange",(Wt=e("cc.CurveRange"),Xt=i(Ce),jt=i(ct),Kt=i(ct),Yt=i(ct),Wt((oe=ne=function(){function t(){d(this,t),m(this,"mode",Qt,this),m(this,"curve",Jt,this),m(this,"curveMin",$t,this),m(this,"curveMax",te,this),m(this,"constant",ee,this),m(this,"constantMin",ie,this),m(this,"constantMax",re,this),m(this,"multiplier",ae,this)}return h(t,[{key:"evaluate",value:function(t,e){switch(this.mode){case Ce.Constant:return this.constant;case Ce.Curve:return this.curve.evaluate(t)*this.multiplier;case Ce.TwoCurves:return z(this.curveMin.evaluate(t),this.curveMax.evaluate(t),e)*this.multiplier;case Ce.TwoConstants:return z(this.constantMin,this.constantMax,e)}}},{key:"getMax",value:function(){switch(this.mode){case Ce.Constant:return this.constant;case Ce.Curve:return this.multiplier;case Ce.TwoConstants:return this.constantMax;case Ce.TwoCurves:return this.multiplier}return 0}},{key:"_onBeforeSerialize",value:function(t){return xe[this.mode]}}]),t}(),ne.Mode=Ce,Qt=a((qt=oe).prototype,"mode",[Xt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ce.Constant}}),Jt=a(qt.prototype,"curve",[jt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ct}}),$t=a(qt.prototype,"curveMin",[Kt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ct}}),te=a(qt.prototype,"curveMax",[Yt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ct}}),ee=a(qt.prototype,"constant",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ie=a(qt.prototype,"constantMin",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),re=a(qt.prototype,"constantMax",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ae=a(qt.prototype,"multiplier",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Zt=qt))||Zt));function Ae(t,e,i){switch(t.mode){case Ce.Constant:return t.constant;case Ce.Curve:return t.curve.evaluate(e)*t.multiplier;case Ce.TwoCurves:return 0===i?t.curveMin.evaluate(e)*t.multiplier:t.curveMax.evaluate(e)*t.multiplier;case Ce.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function Re(t){switch(t.mode){case Ce.TwoConstants:case Ce.TwoCurves:return 2;default:return 1}}function De(t,e,i){var r=new _t({width:e,height:i,_data:t,_compressed:!1,format:dt.RGBA32F}),a=new Q;return a.setFilters(pt.NEAREST,pt.NEAREST),a.setMipFilter(pt.NONE),a.setWrapMode(ft.CLAMP_TO_EDGE,ft.CLAMP_TO_EDGE,ft.CLAMP_TO_EDGE),a.image=r,a}function Fe(t,e,i,r,a){for(var n=Math.max(Re(e),Re(i),Re(r)),o=new Float32Array(t*n*4),s=[e,i,r],l=1/(t-1),u=0;u<n;u++)for(var h=0;h<3;h++)for(var c=s[h],_=0,d=0,p=0;p<t;p++){var f=Ae(c,l*p,u);d=a?f:(_+=f)/(p+1),o[4*p+h]=d}return De(o,t,n)}var ke,Ie,Pe,Le,Be,Ue,Ve,Ge,Ne,He,We,Xe,je,Ke,Ye,Ze,qe,Qe,Je,$e,ti,ei,ii,ri,ai,ni,oi,si,li,ui,hi,ci,_i,di,pi,fi,mi,yi,vi,bi,gi,Mi,wi,Ti,Si,Oi,zi,xi,Ci,Ei,Ai,Ri,Di,Fi=O({Blend:0,Fixed:1}),ki=(e("cc.ColorKey")((ue=a((le=function t(){d(this,t),m(this,"color",ue,this),m(this,"time",he,this)}).prototype,"color",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b.WHITE.clone()}}),he=a(le.prototype,"time",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),se=le)),e("cc.AlphaKey")((de=a((_e=function t(){d(this,t),m(this,"alpha",de,this),m(this,"time",pe,this)}).prototype,"alpha",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pe=a(_e.prototype,"time",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce=_e)),e("cc.Gradient")((Me=ge=function(){function t(){d(this,t),m(this,"colorKeys",ye,this),m(this,"alphaKeys",ve,this),m(this,"mode",be,this),this._color=void 0,this._color=b.WHITE.clone()}return h(t,[{key:"setKeys",value:function(t,e){this.colorKeys=t,this.alphaKeys=e}},{key:"sortKeys",value:function(){this.colorKeys.length>1&&this.colorKeys.sort((function(t,e){return t.time-e.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(t,e){return t.time-e.time}))}},{key:"evaluate",value:function(t){return this.getRGB(t),this._color._set_a_unsafe(this.getAlpha(t)),this._color}},{key:"randomColor",value:function(){var t=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],e=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(t.color),this._color._set_a_unsafe(e.alpha),this._color}},{key:"getRGB",value:function(t){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(b.WHITE),this._color);t=E(t,1);for(var e=1;e<this.colorKeys.length;++e){var i=this.colorKeys[e-1].time,r=this.colorKeys[e].time;if(t>=i&&t<r){if(this.mode===Fi.Fixed)return this.colorKeys[e].color;var a=(t-i)/(r-i);return b.lerp(this._color,this.colorKeys[e-1].color,this.colorKeys[e].color,a),this._color}}var n=this.colorKeys.length-1;t<this.colorKeys[0].time?b.lerp(this._color,b.BLACK,this.colorKeys[0].color,t/this.colorKeys[0].time):t>this.colorKeys[n].time&&b.lerp(this._color,this.colorKeys[n].color,b.BLACK,(t-this.colorKeys[n].time)/(1-this.colorKeys[n].time))}},{key:"getAlpha",value:function(t){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;t=E(t,1);for(var e=1;e<this.alphaKeys.length;++e){var i=this.alphaKeys[e-1].time,r=this.alphaKeys[e].time;if(t>=i&&t<r){if(this.mode===Fi.Fixed)return this.alphaKeys[e].alpha;var a=(t-i)/(r-i);return z(this.alphaKeys[e-1].alpha,this.alphaKeys[e].alpha,a)}}var n=this.alphaKeys.length-1;return t<this.alphaKeys[0].time?z(255,this.alphaKeys[0].alpha,t/this.alphaKeys[0].time):t>this.alphaKeys[n].time?z(this.alphaKeys[n].alpha,255,(t-this.alphaKeys[n].time)/(1-this.alphaKeys[n].time)):void 0}}]),t}(),ge.Mode=Fi,ye=a((me=Me).prototype,"colorKeys",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),ve=a(me.prototype,"alphaKeys",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),be=a(me.prototype,"mode",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fi.Blend}}),fe=me))||fe),Ii=C,Pi=O({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Li=(ke=e("cc.GradientRange"),Ie=i(Pi),Pe=i(ki),Le=i(ki),Be=i(ki),Ue=i(Pi),ke((qe=Ze=function(){function t(){d(this,t),m(this,"color",Ne,this),m(this,"colorMin",He,this),m(this,"colorMax",We,this),m(this,"gradient",Xe,this),m(this,"gradientMin",je,this),m(this,"gradientMax",Ke,this),m(this,"_mode",Ye,this),this._color=b.WHITE.clone()}return h(t,[{key:"evaluate",value:function(t,e){switch(this._mode){case Pi.Color:return this.color;case Pi.TwoColors:return b.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case Pi.RandomColor:return this.gradient.randomColor();case Pi.Gradient:return this.gradient.evaluate(t);case Pi.TwoGradients:return b.lerp(this._color,this.gradientMin.evaluate(t),this.gradientMax.evaluate(t),e),this._color;default:return this.color}}},{key:"_onBeforeSerialize",value:function(t){return Ii[this._mode]}},{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),Ze.Mode=Pi,a((Ge=qe).prototype,"mode",[Ie],Object.getOwnPropertyDescriptor(Ge.prototype,"mode"),Ge.prototype),Ne=a(Ge.prototype,"color",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b.WHITE.clone()}}),He=a(Ge.prototype,"colorMin",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b.WHITE.clone()}}),We=a(Ge.prototype,"colorMax",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b.WHITE.clone()}}),Xe=a(Ge.prototype,"gradient",[Pe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki}}),je=a(Ge.prototype,"gradientMin",[Le],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki}}),Ke=a(Ge.prototype,"gradientMax",[Be],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki}}),Ye=a(Ge.prototype,"_mode",[Ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.Color}}),Ve=Ge))||Ve);function Bi(t,e,i){switch(t.mode){case Pi.Color:return t.color;case Pi.TwoColors:return 0===i?t.colorMin:t.colorMax;case Pi.RandomColor:return t.gradient.randomColor();case Pi.Gradient:return t.gradient.evaluate(e);case Pi.TwoGradients:return 0===i?t.gradientMin.evaluate(e):t.gradientMax.evaluate(e);default:return t.color}}function Ui(t,e){for(var i=function(t){switch(t.mode){case Pi.TwoColors:case Pi.TwoGradients:return 2;default:return 1}}(e),r=new Uint8Array(t*i*4),a=1/(t-1),n=0,o=0;o<i;o++)for(var s=0;s<t;s++){var l=Bi(e,a*s,o);r[n]=l.r,r[n+1]=l.g,r[n+2]=l.b,r[n+3]=l.a,n+=4}var u=new Q;return u.create(t,i,dt.RGBA8888),u.setFilters(pt.LINEAR,pt.LINEAR),u.setWrapMode(ft.CLAMP_TO_EDGE,ft.CLAMP_TO_EDGE),u.uploadData(r),u}var Vi,Gi,Ni,Hi,Wi,Xi,ji,Ki,Yi,Zi,qi,Qi,Ji,$i,tr,er,ir,rr,ar,nr,or,sr,lr,ur,hr,cr,_r,dr,pr,fr,mr,yr,vr={parent:null,owner:null,subModelIdx:0},br={CC_USE_WORLD_SPACE:!1},gr=function(e){return t({Line:e,LineComponent:e}),e}((Qe=e("cc.Line"),Je=n(),$e=o(),ti=i(Q),ei=i(Q),ii=R(),ri=s(),ai=R(),ni=s(),oi=i([w]),si=i([w]),li=R(),ui=s(),hi=i(Ee),ci=i(Ee),_i=R(),di=s(),pi=i(A),fi=R(),mi=s(),yi=i(A),vi=R(),bi=s(),gi=i(Li),Mi=i(Li),wi=R(),Ti=s(),Qe(Si=Je(Si=$e(Si=r((zi=a((Oi=function(t){function e(){var t;return d(this,e),t=p(this,f(e).call(this)),m(t,"_texture",zi,y(t)),t._material=null,t._materialInstance=null,m(t,"_worldSpace",xi,y(t)),m(t,"_positions",Ci,y(t)),m(t,"_width",Ei,y(t)),m(t,"_tile",Ai,y(t)),m(t,"_offset",Ri,y(t)),m(t,"_color",Di,y(t)),t._model=null,t._tile_offset=new v,t}return u(e,t),h(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._materialInstance&&this._materialInstance.setProperty("mainTexture",t)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t,this._materialInstance&&(br.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(br),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),h(e,[{key:"onLoad",value:function(){this._model=g.director.root.createModel(ze),this._model.initialize(this.node),null==this._material&&(this._material=new rt,this._material.copy(at.get("default-trail-material")),br.CC_USE_WORLD_SPACE=this.worldSpace,vr.parent=this._material,vr.subModelIdx=0,this._materialInstance=new mt(vr),this._materialInstance.recompileShaders(br)),this._model.updateMaterial(this._materialInstance),this._model.setCapacity(100)}},{key:"onEnable",value:function(){this._model&&(this.attachToScene(),this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))}},{key:"onDisable",value:function(){this._model&&this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}}]),e}(M)).prototype,"_texture",[ti],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(Oi.prototype,"texture",[ei,ii,ri],Object.getOwnPropertyDescriptor(Oi.prototype,"texture"),Oi.prototype),xi=a(Oi.prototype,"_worldSpace",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(Oi.prototype,"worldSpace",[ai,ni],Object.getOwnPropertyDescriptor(Oi.prototype,"worldSpace"),Oi.prototype),Ci=a(Oi.prototype,"_positions",[oi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a(Oi.prototype,"positions",[si,li,ui],Object.getOwnPropertyDescriptor(Oi.prototype,"positions"),Oi.prototype),Ei=a(Oi.prototype,"_width",[hi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),a(Oi.prototype,"width",[ci,_i,di],Object.getOwnPropertyDescriptor(Oi.prototype,"width"),Oi.prototype),Ai=a(Oi.prototype,"_tile",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new A(1,1)}}),a(Oi.prototype,"tile",[pi,fi,mi],Object.getOwnPropertyDescriptor(Oi.prototype,"tile"),Oi.prototype),Ri=a(Oi.prototype,"_offset",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new A(0,0)}}),a(Oi.prototype,"offset",[yi,vi,bi],Object.getOwnPropertyDescriptor(Oi.prototype,"offset"),Oi.prototype),Di=a(Oi.prototype,"_color",[gi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li}}),a(Oi.prototype,"color",[Mi,wi,Ti],Object.getOwnPropertyDescriptor(Oi.prototype,"color"),Oi.prototype),Si=Oi))||Si)||Si)||Si)||Si)),Mr=function t(e){d(this,t),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new w(0,0,0),this.velocity=new w(0,0,0),this.animatedVelocity=new w(0,0,0),this.ultimateVelocity=new w(0,0,0),this.angularVelocity=new w(0,0,0),this.axisOfRotation=new w(0,0,0),this.rotation=new w(0,0,0),this.startSize=new w(0,0,0),this.size=new w(0,0,0),this.startColor=b.WHITE.clone(),this.color=b.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0},wr="colorModule",Tr="forceModule",Sr="limitModule",Or="rotationModule",zr="sizeModule",xr="velocityModule",Cr="textureModule",Er=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],Ar=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],Rr=function(){function t(){d(this,t),this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}return h(t,[{key:"bindTarget",value:function(t){this.target=t}},{key:"update",value:function(t,e){}}]),t}(),Dr=O({World:0,Local:1,Custom:2}),Fr=O({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),kr=O({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Ir=O({Base:0,Edge:1,Shell:2,Volume:3}),Pr=O({Random:0,Loop:1,PingPong:2}),Lr=O({Particles:0}),Br=O({Stretch:0}),Ur=23541,Vr=39825,Gr=90794,Nr=212165,Hr=125292,Wr=197866,Xr=156497,jr=984136,Kr=91041,Yr=(Vi=e("cc.ColorOvertimeModule"),Gi=R(),Ni=i(Li),Hi=R(),Vi((ji=a((Xi=function(t){function e(){var t,i;d(this,e);for(var r=arguments.length,a=new Array(r),n=0;n<r;n++)a[n]=arguments[n];return i=p(this,(t=f(e)).call.apply(t,[this].concat(a))),m(i,"_enable",ji,y(i)),m(i,"color",Ki,y(i)),i.name=wr,i}return u(e,t),h(e,[{key:"animate",value:function(t){t.color.set(t.startColor),t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,D(t.randomSeed+Kr)))}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(Xi.prototype,"enable",[Gi],Object.getOwnPropertyDescriptor(Xi.prototype,"enable"),Xi.prototype),Ki=a(Xi.prototype,"color",[Ni,l,Hi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li}}),Wi=Xi))||Wi),Zr=new w(0,0,-1);function qr(t,e,i,r){return e!==t?(t===Dr.World||k.invert(i,i),k.getRotation(r,i),!0):(I.set(r,0,0,0,1),!1)}function Qr(t,e){A.set(t,Math.cos(e),Math.sin(e))}function Jr(t){var e=L(-1,1),i=L(0,2*Math.PI),r=Math.sqrt(1-e*e),a=r*Math.cos(i),n=r*Math.sin(i);w.set(t,a,n,e)}function $r(t,e,i){Jr(t),w.multiplyScalar(t,t,e+(i-e)*P())}function ta(t,e,i,r){Qr(t,r),t.z=0,w.multiplyScalar(t,t,e+(i-e)*P())}function ea(t){for(var e=0;e<t.length;e++){var i=e+B(0,t.length-e),r=t[i];t[i]=t[e],t[e]=r}}function ia(){var t=L(-1,1);return 0===t&&t++,F(t)}var ra,aa,na,oa,sa,la,ua,ha,ca,_a,da,pa,fa,ma,ya,va,ba,ga,Ma,wa,Ta,Sa,Oa,za,xa,Ca,Ea,Aa,Ra,Da,Fa,ka,Ia,Pa,La,Ba,Ua,Va,Ga,Na,Ha,Wa,Xa,ja,Ka,Ya,Za,qa,Qa,Ja,$a,tn,en,rn,an,nn,on,sn,ln=Nr,un=new w,hn=(Yi=e("cc.ForceOvertimeModule"),Zi=R(),qi=i(Ee),Qi=U(),Ji=R(),$i=s(),tr=i(Ee),er=U(),ir=R(),rr=s(),ar=i(Ee),nr=U(),or=R(),sr=s(),lr=i(Dr),ur=R(),hr=s(),Yi((dr=a((_r=function(t){function e(){var t;return d(this,e),t=p(this,f(e).call(this)),m(t,"_enable",dr,y(t)),m(t,"x",pr,y(t)),m(t,"y",fr,y(t)),m(t,"z",mr,y(t)),m(t,"space",yr,y(t)),t.randomized=!1,t.rotation=void 0,t.needTransform=void 0,t.name=Tr,t.rotation=new I,t.needTransform=!1,t.needUpdate=!0,t}return u(e,t),h(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),h(e,[{key:"update",value:function(t,e){this.needTransform=qr(t,this.space,e,this.rotation)}},{key:"animate",value:function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=w.set(un,this.x.evaluate(i,D(t.randomSeed+ln)),this.y.evaluate(i,D(t.randomSeed+ln)),this.z.evaluate(i,D(t.randomSeed+ln)));this.needTransform&&w.transformQuat(r,r,this.rotation),w.scaleAndAdd(t.velocity,t.velocity,r,e),w.copy(t.ultimateVelocity,t.velocity)}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(_r.prototype,"enable",[Zi],Object.getOwnPropertyDescriptor(_r.prototype,"enable"),_r.prototype),pr=a(_r.prototype,"x",[qi,l,Qi,Ji,$i],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),fr=a(_r.prototype,"y",[tr,l,er,ir,rr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),mr=a(_r.prototype,"z",[ar,l,nr,or,sr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),yr=a(_r.prototype,"space",[lr,l,ur,hr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.Local}}),cr=_r))||cr),cn=Ur,_n=new w,dn=new w,pn=(ra=e("cc.LimitVelocityOvertimeModule"),aa=R(),na=i(Ee),oa=U(),sa=R(),la=s(),ua=i(Ee),ha=U(),ca=R(),_a=s(),da=i(Ee),pa=U(),fa=R(),ma=s(),ya=i(Ee),va=U(),ba=R(),ga=s(),Ma=R(),wa=s(),Ta=R(),Sa=s(),Oa=i(Dr),za=R(),xa=s(),ra((Aa=a((Ea=function(t){function e(){var t;return d(this,e),t=p(this,f(e).call(this)),m(t,"_enable",Aa,y(t)),m(t,"limitX",Ra,y(t)),m(t,"limitY",Da,y(t)),m(t,"limitZ",Fa,y(t)),m(t,"limit",ka,y(t)),m(t,"dampen",Ia,y(t)),m(t,"separateAxes",Pa,y(t)),m(t,"space",La,y(t)),t.drag=null,t.multiplyDragByParticleSize=!1,t.multiplyDragByParticleVelocity=!1,t.name=Sr,t.rotation=void 0,t.needTransform=void 0,t.rotation=new I,t.needTransform=!1,t.needUpdate=!0,t}return u(e,t),h(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),h(e,[{key:"update",value:function(t,e){this.needTransform=qr(t,this.space,e,this.rotation)}},{key:"animate",value:function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=_n;this.separateAxes?(w.set(dn,this.limitX.evaluate(i,D(t.randomSeed+cn)),this.limitY.evaluate(i,D(t.randomSeed+cn)),this.limitZ.evaluate(i,D(t.randomSeed+cn))),this.needTransform&&w.transformQuat(dn,dn,this.rotation),w.set(r,fn(t.ultimateVelocity.x,dn.x,this.dampen),fn(t.ultimateVelocity.y,dn.y,this.dampen),fn(t.ultimateVelocity.z,dn.z,this.dampen))):(w.normalize(r,t.ultimateVelocity),w.multiplyScalar(r,r,fn(t.ultimateVelocity.length(),this.limit.evaluate(i,D(t.randomSeed+cn)),this.dampen))),w.copy(t.ultimateVelocity,r)}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(Ea.prototype,"enable",[aa],Object.getOwnPropertyDescriptor(Ea.prototype,"enable"),Ea.prototype),Ra=a(Ea.prototype,"limitX",[na,l,oa,sa,la],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Da=a(Ea.prototype,"limitY",[ua,l,ha,ca,_a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Fa=a(Ea.prototype,"limitZ",[da,l,pa,fa,ma],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),ka=a(Ea.prototype,"limit",[ya,l,va,ba,ga],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Ia=a(Ea.prototype,"dampen",[l,Ma,wa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),Pa=a(Ea.prototype,"separateAxes",[l,Ta,Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),La=a(Ea.prototype,"space",[Oa,l,za,xa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.Local}}),Ca=Ea))||Ca);function fn(t,e,i){var r=Math.sign(t),a=Math.abs(t);return a>e&&(a=z(a,e,i)),a*r}var mn,yn,vn,bn,gn,Mn,wn,Tn,Sn,On,zn,xn,Cn,En,An,Rn,Dn,Fn,kn,In,Pn,Ln,Bn,Un,Vn,Gn,Nn,Hn,Wn,Xn,jn,Kn,Yn,Zn,qn,Qn,Jn,$n,to,eo,io,ro,ao,no,oo,so,lo,uo,ho,co,_o,po,fo,mo,yo,vo,bo,go,Mo,wo,To,So,Oo,zo,xo,Co,Eo,Ao,Ro,Do,Fo,ko,Io,Po,Lo,Bo,Uo,Vo,Go,No,Ho,Wo,Xo,jo,Ko,Yo,Zo,qo,Qo,Jo,$o,ts,es,is,rs,as,ns,os,ss,ls,us,hs,cs,_s,ds,ps,fs,ms,ys,vs,bs,gs,Ms,ws,Ts,Ss,Os,zs,xs,Cs,Es,As,Rs,Ds,Fs,ks,Is,Ps,Ls,Bs,Us,Vs,Gs,Ns,Hs,Ws,Xs,js,Ks,Ys,Zs,qs,Qs,Js,$s,tl,el,il,rl,al,nl,ol,sl,ll,ul,hl,cl,_l,dl,pl,fl,ml,yl,vl,bl,gl,Ml,wl,Tl=Hr,Sl=(Ba=e("cc.RotationOvertimeModule"),Ua=R(),Va=R(),Ga=s(),Na=i(Ee),Ha=U(),Wa=R(),Xa=s(),ja=i(Ee),Ka=U(),Ya=R(),Za=s(),qa=i(Ee),Qa=U(),Ja=R(),$a=s(),Ba((rn=a((en=function(t){function e(){var t,i;d(this,e);for(var r=arguments.length,a=new Array(r),n=0;n<r;n++)a[n]=arguments[n];return i=p(this,(t=f(e)).call.apply(t,[this].concat(a))),m(i,"_enable",rn,y(i)),m(i,"_separateAxes",an,y(i)),m(i,"x",nn,y(i)),m(i,"y",on,y(i)),m(i,"z",sn,y(i)),i.name=Or,i}return u(e,t),h(e,[{key:"animate",value:function(t,e){var i=1-t.remainingLifetime/t.startLifetime;if(this._separateAxes){var r=D(t.randomSeed+Tl);t.rotation.x+=this.x.evaluate(i,r)*e,t.rotation.y+=this.y.evaluate(i,r)*e,t.rotation.z+=this.z.evaluate(i,r)*e}else t.rotation.z+=this.z.evaluate(i,D(t.randomSeed+Tl))*e}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(en.prototype,"enable",[Ua],Object.getOwnPropertyDescriptor(en.prototype,"enable"),en.prototype),an=a(en.prototype,"_separateAxes",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(en.prototype,"separateAxes",[Va,Ga],Object.getOwnPropertyDescriptor(en.prototype,"separateAxes"),en.prototype),nn=a(en.prototype,"x",[Na,l,Ha,V,Wa,Xa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),on=a(en.prototype,"y",[ja,l,Ka,V,Ya,Za],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),sn=a(en.prototype,"z",[qa,l,Qa,V,Ja,$a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),tn=en))||tn),Ol=Vr,zl=(mn=e("cc.SizeOvertimeModule"),yn=R(),vn=R(),bn=s(),gn=i(Ee),Mn=R(),wn=s(),Tn=i(Ee),Sn=R(),On=s(),zn=i(Ee),xn=R(),Cn=s(),En=i(Ee),An=R(),Rn=s(),mn((kn=a((Fn=function(t){function e(){var t,i;d(this,e);for(var r=arguments.length,a=new Array(r),n=0;n<r;n++)a[n]=arguments[n];return i=p(this,(t=f(e)).call.apply(t,[this].concat(a))),m(i,"_enable",kn,y(i)),m(i,"separateAxes",In,y(i)),m(i,"size",Pn,y(i)),m(i,"x",Ln,y(i)),m(i,"y",Bn,y(i)),m(i,"z",Un,y(i)),i.name=zr,i}return u(e,t),h(e,[{key:"animate",value:function(t,e){if(this.separateAxes){var i=1-t.remainingLifetime/t.startLifetime,r=D(t.randomSeed+Ol);t.size.x=t.startSize.x*this.x.evaluate(i,r),t.size.y=t.startSize.y*this.y.evaluate(i,r),t.size.z=t.startSize.z*this.z.evaluate(i,r)}else w.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,D(t.randomSeed+Ol)))}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(Fn.prototype,"enable",[yn],Object.getOwnPropertyDescriptor(Fn.prototype,"enable"),Fn.prototype),In=a(Fn.prototype,"separateAxes",[l,vn,bn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pn=a(Fn.prototype,"size",[gn,l,Mn,wn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Ln=a(Fn.prototype,"x",[Tn,l,Sn,On],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Bn=a(Fn.prototype,"y",[zn,l,xn,Cn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Un=a(Fn.prototype,"z",[En,l,An,Rn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Dn=Fn))||Dn),xl=Gr,Cl=O({Grid:0}),El=O({WholeSheet:0,SingleRow:1}),Al=(Vn=e("cc.TextureAnimationModule"),Gn=G("numTilesX"),Nn=G("numTilesY"),Hn=R(),Wn=i(Cl),Xn=i(Cl),jn=R(),Kn=s(),Yn=R(),Zn=s(),qn=R(),Qn=s(),Jn=i(El),$n=R(),to=s(),eo=i(Ee),io=R(),ro=s(),ao=i(Ee),no=R(),oo=s(),so=R(),lo=s(),uo=R(),ho=s(),co=R(),_o=s(),Vn((mo=a((fo=function(t){function e(){var t,i;d(this,e);for(var r=arguments.length,a=new Array(r),n=0;n<r;n++)a[n]=arguments[n];return i=p(this,(t=f(e)).call.apply(t,[this].concat(a))),m(i,"_enable",mo,y(i)),m(i,"_numTilesX",yo,y(i)),m(i,"_numTilesY",vo,y(i)),m(i,"_mode",bo,y(i)),m(i,"animation",go,y(i)),m(i,"frameOverTime",Mo,y(i)),m(i,"startFrame",wo,y(i)),m(i,"cycleCount",To,y(i)),m(i,"_flipU",So,y(i)),m(i,"_flipV",Oo,y(i)),m(i,"_uvChannelMask",zo,y(i)),m(i,"randomRow",xo,y(i)),m(i,"rowIndex",Co,y(i)),i.name=Cr,i}return u(e,t),h(e,[{key:"init",value:function(t){t.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=this.startFrame.evaluate(i,D(t.randomSeed+xl))/(this.numTilesX*this.numTilesY);if(this.animation===El.WholeSheet)t.frameIndex=E(this.cycleCount*(this.frameOverTime.evaluate(i,D(t.randomSeed+xl))+r),1);else if(this.animation===El.SingleRow){var a=1/this.numTilesY;if(this.randomRow){var n=E(this.cycleCount*(this.frameOverTime.evaluate(i,D(t.randomSeed+xl))+r),1),o=t.startRow*a,s=o+a;t.frameIndex=z(o,s,n)}else{var l=this.rowIndex*a,u=l+a;t.frameIndex=z(l,u,E(this.cycleCount*(this.frameOverTime.evaluate(i,D(t.randomSeed+xl))+r),1))}}}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t===Cl.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(t){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(t){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(t){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yo=a(fo.prototype,"_numTilesX",[Gn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vo=a(fo.prototype,"_numTilesY",[Nn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a(fo.prototype,"enable",[Hn],Object.getOwnPropertyDescriptor(fo.prototype,"enable"),fo.prototype),bo=a(fo.prototype,"_mode",[Wn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cl.Grid}}),a(fo.prototype,"mode",[Xn,jn,Kn],Object.getOwnPropertyDescriptor(fo.prototype,"mode"),fo.prototype),a(fo.prototype,"numTilesX",[Yn,Zn],Object.getOwnPropertyDescriptor(fo.prototype,"numTilesX"),fo.prototype),a(fo.prototype,"numTilesY",[qn,Qn],Object.getOwnPropertyDescriptor(fo.prototype,"numTilesY"),fo.prototype),go=a(fo.prototype,"animation",[Jn,l,$n,to],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return El.WholeSheet}}),Mo=a(fo.prototype,"frameOverTime",[eo,l,io,ro],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),wo=a(fo.prototype,"startFrame",[ao,l,no,oo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),To=a(fo.prototype,"cycleCount",[l,so,lo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),So=a(fo.prototype,"_flipU",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oo=a(fo.prototype,"_flipV",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zo=a(fo.prototype,"_uvChannelMask",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),xo=a(fo.prototype,"randomRow",[l,uo,ho],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Co=a(fo.prototype,"rowIndex",[l,co,_o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),po=fo))||po),Rl=Wr,Dl=Xr,Fl=jr,kl=new w,Il=(Eo=e("cc.VelocityOvertimeModule"),Ao=R(),Ro=i(Ee),Do=U(),Fo=R(),ko=s(),Io=i(Ee),Po=U(),Lo=R(),Bo=s(),Uo=i(Ee),Vo=U(),Go=R(),No=s(),Ho=i(Ee),Wo=U(),Xo=R(),jo=s(),Ko=i(Dr),Yo=R(),Zo=s(),Eo((Jo=a((Qo=function(t){function e(){var t;return d(this,e),t=p(this,f(e).call(this)),m(t,"_enable",Jo,y(t)),m(t,"x",$o,y(t)),m(t,"y",ts,y(t)),m(t,"z",es,y(t)),m(t,"speedModifier",is,y(t)),m(t,"space",rs,y(t)),t.rotation=void 0,t.needTransform=void 0,t.name=xr,t.rotation=new I,t.speedModifier.constant=1,t.needTransform=!1,t.needUpdate=!0,t}return u(e,t),h(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),h(e,[{key:"update",value:function(t,e){this.needTransform=qr(t,this.space,e,this.rotation)}},{key:"animate",value:function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=w.set(kl,this.x.evaluate(i,D(t.randomSeed^Rl)),this.y.evaluate(i,D(t.randomSeed^Dl)),this.z.evaluate(i,D(t.randomSeed^Fl)));this.needTransform&&w.transformQuat(r,r,this.rotation),w.add(t.animatedVelocity,t.animatedVelocity,r),w.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),w.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,D(t.randomSeed+Rl)))}}]),e}(Rr)).prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(Qo.prototype,"enable",[Ao],Object.getOwnPropertyDescriptor(Qo.prototype,"enable"),Qo.prototype),$o=a(Qo.prototype,"x",[Ro,l,Do,Fo,ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),ts=a(Qo.prototype,"y",[Io,l,Po,Lo,Bo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),es=a(Qo.prototype,"z",[Uo,l,Vo,Go,No],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),is=a(Qo.prototype,"speedModifier",[Ho,l,Wo,Xo,jo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),rs=a(Qo.prototype,"space",[Ko,l,Yo,Zo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.Local}}),qo=Qo))||qo),Pl=(as=e("cc.Burst"),ns=i(Ee),as((ls=a((ss=function(){function t(){d(this,t),m(this,"_time",ls,this),m(this,"_repeatCount",us,this),m(this,"repeatInterval",hs,this),m(this,"count",cs,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}return h(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),h(t,[{key:"update",value:function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=E(t._time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;var r=E(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<r&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(r-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)}}]),t}()).prototype,"_time",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a(ss.prototype,"time",[x],Object.getOwnPropertyDescriptor(ss.prototype,"time"),ss.prototype),us=a(ss.prototype,"_repeatCount",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),a(ss.prototype,"repeatCount",[x],Object.getOwnPropertyDescriptor(ss.prototype,"repeatCount"),ss.prototype),hs=a(ss.prototype,"repeatInterval",[l,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cs=a(ss.prototype,"count",[ns],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),os=ss))||os),Ll=new w(0,0,0),Bl=new Array,Ul=new w(.5,.5,.5),Vl=(_s=e("cc.ShapeModule"),ds=R(),ps=s(),fs=R(),ms=s(),ys=R(),vs=s(),bs=R(),gs=s(),Ms=R(),ws=s(),Ts=R(),Ss=i(kr),Os=G("shapeType"),zs=R(),xs=i(kr),Cs=s(),Es=i(Ir),As=R(),Rs=s(),Ds=R(),Fs=s(),ks=R(),Is=s(),Ps=R(),Ls=s(),Bs=R(),Us=s(),Vs=R(),Gs=s(),Ns=R(),Hs=s(),Ws=i(Pr),Xs=R(),js=s(),Ks=R(),Ys=s(),Zs=i(Ee),qs=R(),Qs=s(),Js=R(),$s=s(),tl=R(),el=s(),_s((a((rl=function(){function t(){d(this,t),m(this,"_enable",al,this),m(this,"_shapeType",nl,this),m(this,"emitFrom",ol,this),m(this,"alignToDirection",sl,this),m(this,"randomDirectionAmount",ll,this),m(this,"sphericalDirectionAmount",ul,this),m(this,"randomPositionAmount",hl,this),m(this,"radius",cl,this),m(this,"radiusThickness",_l,this),m(this,"arcMode",dl,this),m(this,"arcSpread",pl,this),m(this,"arcSpeed",fl,this),m(this,"length",ml,this),m(this,"boxThickness",yl,this),m(this,"_position",vl,this),m(this,"_rotation",bl,this),m(this,"_scale",gl,this),m(this,"_arc",Ml,this),m(this,"_angle",wl,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new k,this.quat=new I,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return h(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return c(this._arc)},set:function(t){this._arc=_(t)}},{key:"angle",get:function(){return Math.round(100*c(this._angle))/100},set:function(t){this._angle=_(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case kr.Box:this.emitFrom===Ir.Base&&(this.emitFrom=Ir.Volume);break;case kr.Cone:this.emitFrom===Ir.Edge&&(this.emitFrom=Ir.Base);break;case kr.Sphere:case kr.Hemisphere:this.emitFrom!==Ir.Base&&this.emitFrom!==Ir.Edge||(this.emitFrom=Ir.Volume)}}}]),h(t,[{key:"onInit",value:function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(t){switch(this.shapeType){case kr.Box:!function(t,e,i,r){switch(t){case Ir.Volume:a=i,n=Ul,w.set(a,L(-n.x,n.x),L(-n.y,n.y),L(-n.z,n.z));break;case Ir.Shell:Bl.splice(0,Bl.length),Bl.push(L(-.5,.5)),Bl.push(L(-.5,.5)),Bl.push(.5*ia()),ea(Bl),Gl(Bl,e),w.set(i,Bl[0],Bl[1],Bl[2]);break;case Ir.Edge:Bl.splice(0,Bl.length),Bl.push(L(-.5,.5)),Bl.push(.5*ia()),Bl.push(.5*ia()),ea(Bl),Gl(Bl,e),w.set(i,Bl[0],Bl[1],Bl[2]);break;default:console.warn(t+" is not supported for box emitter.")}var a,n;w.copy(r,Zr)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case kr.Circle:e=this.radius,i=this.radiusThickness,r=this.generateArcAngle(),a=t.position,n=t.velocity,ta(a,e*(1-i),e,r),w.normalize(n,a);break;case kr.Cone:!function(t,e,i,r,a,n,o,s){switch(t){case Ir.Base:ta(o,e*(1-i),e,r),A.multiplyScalar(s,o,Math.sin(a)),s.z=-Math.cos(a)*e,w.normalize(s,s),o.z=0;break;case Ir.Shell:Qr(o,r),A.multiplyScalar(s,o,Math.sin(a)),s.z=-Math.cos(a),w.normalize(s,s),A.multiplyScalar(o,o,e),o.z=0;break;case Ir.Volume:ta(o,e*(1-i),e,r),A.multiplyScalar(s,o,Math.sin(a)),s.z=-Math.cos(a)*e,w.normalize(s,s),o.z=0,w.add(o,o,w.multiplyScalar(Ll,s,n*P()/-s.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case kr.Sphere:!function(t,e,i,r,a){switch(t){case Ir.Volume:$r(r,e*(1-i),e),w.normalize(a,r);break;case Ir.Shell:Jr(r),w.multiplyScalar(r,r,e),w.normalize(a,r);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case kr.Hemisphere:!function(t,e,i,r,a){switch(t){case Ir.Volume:$r(r,e*(1-i),e),r.z>0&&(r.z*=-1),w.normalize(a,r);break;case Ir.Shell:Jr(r),w.multiplyScalar(r,r,e),r.z>0&&(r.z*=-1),w.normalize(a,r);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}var e,i,r,a,n;if(this.randomPositionAmount>0&&(t.position.x+=L(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=L(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=L(-this.randomPositionAmount,this.randomPositionAmount)),w.transformQuat(t.velocity,t.velocity,this.quat),w.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var o=w.normalize(Ll,t.position);w.lerp(t.velocity,t.velocity,o,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){I.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),k.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===Pr.Random)return L(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case Pr.Loop:return E(t,this._arc);case Pr.PingPong:return N(t,this._arc)}}}]),t}()).prototype,"position",[ds,ps],Object.getOwnPropertyDescriptor(rl.prototype,"position"),rl.prototype),a(rl.prototype,"rotation",[fs,ms],Object.getOwnPropertyDescriptor(rl.prototype,"rotation"),rl.prototype),a(rl.prototype,"scale",[ys,vs],Object.getOwnPropertyDescriptor(rl.prototype,"scale"),rl.prototype),a(rl.prototype,"arc",[bs,gs],Object.getOwnPropertyDescriptor(rl.prototype,"arc"),rl.prototype),a(rl.prototype,"angle",[Ms,ws],Object.getOwnPropertyDescriptor(rl.prototype,"angle"),rl.prototype),al=a(rl.prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(rl.prototype,"enable",[Ts],Object.getOwnPropertyDescriptor(rl.prototype,"enable"),rl.prototype),nl=a(rl.prototype,"_shapeType",[Ss,Os,zs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.Cone}}),a(rl.prototype,"shapeType",[xs,Cs],Object.getOwnPropertyDescriptor(rl.prototype,"shapeType"),rl.prototype),ol=a(rl.prototype,"emitFrom",[Es,l,As,Rs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ir.Volume}}),sl=a(rl.prototype,"alignToDirection",[l,Ds,Fs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ll=a(rl.prototype,"randomDirectionAmount",[l,ks,Is],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ul=a(rl.prototype,"sphericalDirectionAmount",[l,Ps,Ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hl=a(rl.prototype,"randomPositionAmount",[l,Bs,Us],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cl=a(rl.prototype,"radius",[l,Vs,Gs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_l=a(rl.prototype,"radiusThickness",[l,Ns,Hs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dl=a(rl.prototype,"arcMode",[Ws,l,Xs,js],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.Random}}),pl=a(rl.prototype,"arcSpread",[l,Ks,Ys],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fl=a(rl.prototype,"arcSpeed",[Zs,l,qs,Qs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),ml=a(rl.prototype,"length",[l,Js,$s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),yl=a(rl.prototype,"boxThickness",[l,tl,el],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(0,0,0)}}),vl=a(rl.prototype,"_position",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(0,0,0)}}),bl=a(rl.prototype,"_rotation",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(0,0,0)}}),gl=a(rl.prototype,"_scale",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(1,1,1)}}),Ml=a(rl.prototype,"_arc",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _(360)}}),wl=a(rl.prototype,"_angle",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _(25)}}),il=rl))||il);function Gl(t,e){e.x>0&&(t[0]+=.5*L(-e.x,e.x),t[0]=H(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*L(-e.y,e.y),t[1]=H(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*L(-e.z,e.z),t[2]=H(t[2],-.5,.5))}var Nl,Hl,Wl,Xl,jl,Kl,Yl,Zl,ql,Ql,Jl,$l,tu,eu,iu,ru,au,nu,ou,su,lu,uu,hu,cu,_u,du,pu,fu,mu,yu=[0,0,1,0,0,1,1,1],vu=function(t){function e(){var t;return d(this,e),(t=p(this,f(e).call(this)))._capacity=void 0,t._vertAttrs=void 0,t._vertSize=void 0,t._vBuffer=void 0,t._vertAttrsFloatCount=void 0,t._vdataF32=void 0,t._vdataUint32=void 0,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=void 0,t._mesh=void 0,t._vertCount=0,t._indexCount=0,t._startTimeOffset=0,t._lifeTimeOffset=0,t._iaInfoBufferReady=!0,t._material=null,t.type=nt.PARTICLE_BATCH,t._capacity=0,t._vertAttrs=null,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},t._iaInfoBuffer=t._device.createBuffer({usage:ot.INDIRECT,memUsage:st.HOST|st.DEVICE,size:lt,stride:lt}),t._subMeshData=null,t._mesh=null,t}return u(e,t),h(e,[{key:"setCapacity",value:function(t){var e=this._capacity!==t;this._capacity=t,this._inited&&e&&this.rebuild()}},{key:"setVertexAttributes",value:function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertSize=0;for(var i,r=T(this._vertAttrs);!(i=r()).done;){var a=i.value;a.offset=this._vertSize,this._vertSize+=ut[a.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}}},{key:"createSubMeshData",value:function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer({usage:ot.VERTEX|ot.TRANSFER_DST,memUsage:st.HOST|st.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(t){return t.name===tt.ATTR_TEX_COORD3})),r=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,tt.ATTR_POSITION,e,this._vertSize,r),r=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,tt.ATTR_NORMAL,e,this._vertSize,r),r=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===tt.ATTR_TEX_COORD}))].offset,this._mesh.copyAttribute(0,tt.ATTR_TEX_COORD,e,this._vertSize,r),r=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,tt.ATTR_COLOR,e,this._vertSize,r))for(var a=new Uint32Array(e),n=0;n<this._vertCount;++n)a[n*this._vertAttrsFloatCount+r/4]=b.WHITE._val;for(var o=new Float32Array(e),s=1;s<this._capacity;s++)o.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}t.update(e);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var u=1;u<this._capacity;u++)for(var h=0;h<this._indexCount;h++)l[u*this._indexCount+h]=l[h]+u*this._vertCount}else for(var c=0,_=0;_<this._capacity;++_){var d=4*_;l[c++]=d,l[c++]=d+1,l[c++]=d+2,l[c++]=d+3,l[c++]=d+2,l[c++]=d+1}var p=this._device.createBuffer({usage:ot.INDEX|ot.TRANSFER_DST,memUsage:st.HOST|st.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return p.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBufferReady||(this._iaInfoBuffer.initialize({usage:ot.INDIRECT,memUsage:st.HOST|st.DEVICE,size:lt,stride:lt}),this._iaInfoBufferReady=!0),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new ht([t],this._vertAttrs,$.TRIANGLE_LIST),this._subMeshData.indexBuffer=p,this._subMeshData.indirectBuffer=this._iaInfoBuffer,this.initSubModel(0,this._subMeshData,this._material),e}},{key:"updateMaterial",value:function(t){this._material=t,this.setSubModelMaterial(0,t)}},{key:"addParticleVertexData",value:function(t,e){if(this._mesh)for(var i=0;i<this._vertCount;i++){var r=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,r+=2,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4]}else{var a=t*this._vertAttrsFloatCount;this._vdataF32[a++]=e[0].x,this._vdataF32[a++]=e[0].y,this._vdataF32[a++]=e[0].z,this._vdataF32[a++]=e[1].x,this._vdataF32[a++]=e[1].y,this._vdataF32[a++]=e[1].z,this._vdataF32[a++]=e[2].x,this._vdataF32[a++]=e[2].y,this._vdataF32[a++]=e[2].z,this._vdataF32[a++]=e[3].x,this._vdataF32[a++]=e[3].y,this._vdataF32[a++]=e[3].z,this._vdataUint32[a++]=e[4],e[5]&&(this._vdataF32[a++]=e[5].x,this._vdataF32[a++]=e[5].y,this._vdataF32[a++]=e[5].z)}}},{key:"addGPUParticleVertexData",value:function(t,e,i){for(var r=e*this._vertAttrsFloatCount*this._vertCount,a=0;a<this._vertCount;a++){var n=r;this._vdataF32[n++]=t.position.x,this._vdataF32[n++]=t.position.y,this._vdataF32[n++]=t.position.z,this._vdataF32[n++]=i,this._vdataF32[n++]=t.startSize.x,this._vdataF32[n++]=t.startSize.y,this._vdataF32[n++]=t.startSize.z,this._vdataF32[n++]=yu[2*a],this._vdataF32[n++]=t.rotation.x,this._vdataF32[n++]=t.rotation.y,this._vdataF32[n++]=t.rotation.z,this._vdataF32[n++]=yu[2*a+1],this._vdataF32[n++]=t.startColor.r/255,this._vdataF32[n++]=t.startColor.g/255,this._vdataF32[n++]=t.startColor.b/255,this._vdataF32[n++]=t.startColor.a/255,this._vdataF32[n++]=t.velocity.x,this._vdataF32[n++]=t.velocity.y,this._vdataF32[n++]=t.velocity.z,this._vdataF32[n++]=t.startLifetime,this._vdataF32[n++]=t.randomSeed,r+=this._vertAttrsFloatCount}}},{key:"updateGPUParticles",value:function(t,e,i){for(var r=this._vertAttrsFloatCount*this._vertCount,a=0,n=0,o=0,s=0;s<t;++s)a=s*r,n=this._vdataF32[a+this._startTimeOffset],this._vdataF32[a+this._lifeTimeOffset]-(e-n)<i&&(o=--t*r,this._vdataF32.copyWithin(a,o,o+r),s--);return t}},{key:"constructAttributeIndex",value:function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}}},{key:"updateIA",value:function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this._subModels[0].inputAssembler.indexCount=0}},{key:"destroy",value:function(){S(f(e.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer.destroy()}},{key:"rebuild",value:function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._inited=!1,this._iaInfoBufferReady=!1)}}]),e}(it),bu=function(){function t(e){d(this,t),this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}return h(t,[{key:"onInit",value:function(t){this._particleSystem=t}},{key:"onEnable",value:function(){this._particleSystem&&(this.attachToScene(),this._model.initialize(this._particleSystem.node),this._model.enabled=this._particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(g.director.root.destroyModel(this._model),this._model=null)}},{key:"attachToScene",value:function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"setVertexAttributes",value:function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===Fr.Mesh?this._renderInfo.mesh:null,this._vertAttrs)}},{key:"_initModel",value:function(){this._model||(this._model=g.director.root.createModel(vu),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)}},{key:"updateTrailMaterial",value:function(){}},{key:"getDefaultTrailMaterial",value:function(){return null}}]),t}(),gu=new w,Mu=new k,wu=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],Tu=[0,0,1,0,0,1,1,1],Su=[{name:tt.ATTR_POSITION,format:et.RGB32F},{name:tt.ATTR_TEX_COORD,format:et.RGB32F},{name:tt.ATTR_TEX_COORD1,format:et.RGB32F},{name:tt.ATTR_TEX_COORD2,format:et.RGB32F},{name:tt.ATTR_COLOR,format:et.RGBA8,isNormalized:!0}],Ou=[{name:tt.ATTR_POSITION,format:et.RGB32F},{name:tt.ATTR_TEX_COORD,format:et.RGB32F},{name:tt.ATTR_TEX_COORD1,format:et.RGB32F},{name:tt.ATTR_TEX_COORD2,format:et.RGB32F},{name:tt.ATTR_COLOR,format:et.RGBA8,isNormalized:!0},{name:tt.ATTR_COLOR1,format:et.RGB32F}],zu=[{name:tt.ATTR_POSITION,format:et.RGB32F},{name:tt.ATTR_TEX_COORD,format:et.RGB32F},{name:tt.ATTR_TEX_COORD1,format:et.RGB32F},{name:tt.ATTR_TEX_COORD2,format:et.RGB32F},{name:tt.ATTR_COLOR,format:et.RGBA8,isNormalized:!0},{name:tt.ATTR_TEX_COORD3,format:et.RGB32F},{name:tt.ATTR_NORMAL,format:et.RGB32F},{name:tt.ATTR_COLOR1,format:et.RGBA8,isNormalized:!0}],xu={parent:null,owner:null,subModelIdx:0},Cu=function(t){function e(t){var i;return d(this,e),(i=p(this,f(e).call(this,t)))._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._attrs=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._inited=!1,i._model=null,i._frameTile_velLenScale=new v(1,1,0,0),i._node_scale=new v,i._attrs=new Array(5),i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}return u(e,t),h(e,[{key:"onInit",value:function(t){var i=this;S(f(e.prototype),"onInit",this).call(this,t),this._particles=new yt((function(){return new Mr(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0}},{key:"clear",value:function(){this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData()}},{key:"updateRenderMode",value:function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()}},{key:"getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"getDefaultTrailMaterial",value:function(){return this._defaultTrailMat}},{key:"setNewParticle",value:function(t){}},{key:"_initModuleList",value:function(){var t=this;wu.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=Er.length;e<i;e++){var r=this._animateList[Er[e]];r&&this._runAnimateList.push(r)}}},{key:"enableModule",value:function(t,e,i){e?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var r=0,a=Er.length;r<a;r++){var n=this._animateList[Er[r]];n&&this._runAnimateList.push(n)}}},{key:"updateParticles",value:function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;switch(i.node.getWorldMatrix(Mu),i.scaleSpace){case Dr.Local:i.node.getScale(this._node_scale);break;case Dr.World:i.node.getWorldScale(this._node_scale)}(i.getMaterialInstance(0)||this._defaultMat).passes[0].setUniform(this._uScaleHandle,this._node_scale),this._updateList.forEach((function(t,e){t.update(i._simulationSpace,Mu)}));var r=i._trailModule,a=r&&r.enable;a&&r.update();for(var n=function(n){var s=e._particles.data[n];if(s.remainingLifetime-=t,w.set(s.animatedVelocity,0,0,0),s.remainingLifetime<0)return a&&r.removeParticle(s),e._particles.removeAt(n),--n,o=n,"continue";s.velocity.y-=9.8*i.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,D(s.randomSeed))*t,w.copy(s.ultimateVelocity,s.velocity),e._runAnimateList.forEach((function(e){e.animate(s,t)})),w.scaleAndAdd(s.position,s.position,s.ultimateVelocity,t),a&&r.animate(s,t),o=n},o=0;o<this._particles.length;++o)n(o);return this._particles.length}},{key:"updateRenderData",value:function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],r=0,a=this._particleSystem._textureAnimationModule;a&&a.enable&&(r=i.frameIndex),t=4*e,this._fillDataFunc(i,t,r)}this._model.updateIA(this._particles.length)}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"onMaterialModified",value:function(t,e){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())}},{key:"onRebuildPSO",value:function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===t&&i._trailModel.setSubModelMaterial(0,e)}},{key:"_setFillFunc",value:function(){this._renderInfo.renderMode===Fr.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===Fr.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData}},{key:"_fillMeshData",value:function(t,e,i){var r=e/4,a=0;this._attrs[a++]=t.position,gu.z=i,this._attrs[a++]=gu,this._attrs[a++]=t.size,this._attrs[a++]=t.rotation,this._attrs[a++]=t.color._val,this._model.addParticleVertexData(r,this._attrs)}},{key:"_fillStrecthedData",value:function(t,e,i){for(var r=0,a=0;a<4;++a)r=0,this._attrs[r++]=t.position,gu.x=Tu[2*a],gu.y=Tu[2*a+1],gu.z=i,this._attrs[r++]=gu,this._attrs[r++]=t.size,this._attrs[r++]=t.rotation,this._attrs[r++]=t.color._val,this._attrs[r++]=t.ultimateVelocity,this._attrs[r++]=t.ultimateVelocity,this._model.addParticleVertexData(e++,this._attrs)}},{key:"_fillNormalData",value:function(t,e,i){for(var r=0,a=0;a<4;++a)r=0,this._attrs[r++]=t.position,gu.x=Tu[2*a],gu.y=Tu[2*a+1],gu.z=i,this._attrs[r++]=gu,this._attrs[r++]=t.size,this._attrs[r++]=t.rotation,this._attrs[r++]=t.color._val,this._attrs[r++]=null,this._model.addParticleVertexData(e++,this._attrs)}},{key:"_setVertexAttrib",value:function(){switch(this._renderInfo.renderMode){case Fr.StrecthedBillboard:this._vertAttrs=Ou.slice();break;case Fr.Mesh:this._vertAttrs=zu.slice();break;default:this._vertAttrs=Su.slice()}}},{key:"updateMaterialParams",value:function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!=e){var i=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1!==i.indexOf("particle")&&-1===i.indexOf("particle-gpu")||t.setMaterial(null,0)}null==t.sharedMaterial&&null==this._defaultMat&&(xu.parent=at.get("default-particle-material"),xu.owner=this._particleSystem,xu.subModelIdx=0,this._defaultMat=new mt(xu),null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var r=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===Dr.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var a=r.passes[0];this._uScaleHandle=a.getHandle("scale"),this._uLenHandle=a.getHandle("frameTile_velLenScale");var n=this._renderInfo.renderMode,o=this._frameTile_velLenScale;n===Fr.Billboard?this._defines.CC_RENDER_MODE=0:n===Fr.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):n===Fr.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:n===Fr.VerticalBillboard?this._defines.CC_RENDER_MODE=3:n===Fr.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(n," not support."));var s=t._textureAnimationModule;s&&s.enable?(A.set(o,s.numTilesX,s.numTilesY),a.setUniform(this._uLenHandle,o)):a.setUniform(this._uLenHandle,o),r.recompileShaders(this._defines),this._model&&this._model.updateMaterial(r)}}},{key:"updateTrailMaterial",value:function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===Dr.World||e.space===Dr.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(xu.parent=at.get("default-trail-material"),xu.owner=this._particleSystem,xu.subModelIdx=1,this._defaultTrailMat=new mt(xu)),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}}}]),e}(bu),Eu=new k,Au=new v,Ru=new I,Du="a_position_starttime",Fu="a_size_uv",ku="a_rotation_uv",Iu="a_color",Pu="a_dir_life",Lu="a_rndSeed",Bu=[{name:Du,format:et.RGBA32F},{name:Fu,format:et.RGBA32F},{name:ku,format:et.RGBA32F},{name:Iu,format:et.RGBA32F},{name:Pu,format:et.RGBA32F},{name:Lu,format:et.R32F}],Uu=[{name:Du,format:et.RGBA32F},{name:Fu,format:et.RGBA32F},{name:ku,format:et.RGBA32F},{name:Iu,format:et.RGBA32F},{name:Pu,format:et.RGBA32F},{name:Lu,format:et.R32F},{name:tt.ATTR_TEX_COORD,format:et.RGB32F},{name:tt.ATTR_TEX_COORD3,format:et.RGB32F},{name:tt.ATTR_NORMAL,format:et.RGB32F},{name:tt.ATTR_COLOR1,format:et.RGBA8,isNormalized:!0}],Vu={parent:null,owner:null,subModelIdx:0},Gu=function(t){function e(t){var i;return d(this,e),(i=p(this,f(e).call(this,t)))._defines=void 0,i._frameTile_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._uTimeHandle=0,i._uRotHandle=0,i._inited=!1,i._frameTile_velLenScale=new v(1,1,0,0),i._node_scale=new v,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new Mr(null),i._particleNum=0,i}return u(e,t),h(e,[{key:"onInit",value:function(t){S(f(e.prototype),"onInit",this).call(this,t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0}},{key:"updateRenderMode",value:function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()}},{key:"setVertexAttributes",value:function(){S(f(e.prototype),"setVertexAttributes",this).call(this),this._model.constructAttributeIndex()}},{key:"clear",value:function(){this._particleNum=0,this.updateRenderData()}},{key:"onDestroy",value:function(){S(f(e.prototype),"onDestroy",this).call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()}},{key:"enableModule",value:function(t,e,i){var r=this._particleSystem.getMaterialInstance(0)||this._defaultMat;r&&(this.initShaderUniform(r),r.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,r))}},{key:"getFreeParticle",value:function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle}},{key:"setNewParticle",value:function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++}},{key:"updateParticles",value:function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._particleNum}},{key:"updateRenderData",value:function(){this._model.updateIA(this._particleNum)}},{key:"updateShaderUniform",value:function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var i=e.passes[0];Au.x=this._particleSystem._time,Au.y=t,i.setUniform(this._uTimeHandle,Au),this._particleSystem.node.getWorldRotation(Ru),i.setUniform(this._uRotHandle,Ru)}}},{key:"initShaderUniform",value:function(t){var e=t.passes[0];this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),e.setUniform(e.getHandle("scale"),this._node_scale),e.setUniform(e.getHandle("frameTile_velLenScale"),this._frameTile_velLenScale),Au.x=32,Au.y=1/32,e.setUniform(e.getHandle("u_sampleInfo"),Au);var i=!1,r=this._particleSystem._forceOvertimeModule;if(i=r&&r.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=Fe(32,r.x,r.y,r.z);var a=e.getHandle("force_over_time_tex0"),n=vt.getBindingFromHandle(a);e.bindSampler(n,this._forceTexture.getGFXSampler()),e.bindTexture(n,this._forceTexture.getGFXTexture());var o=e.getHandle("u_force_space");e.setUniform(o,r.space);var s=e.getHandle("u_force_mode");e.setUniform(s,this._forceTexture.height)}var l=this._particleSystem._velocityOvertimeModule;if(i=l&&l.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(t,e,i,r,a,n){for(var o=Math.max(Re(e),Re(i),Re(r),Re(a)),s=new Float32Array(t*o*4),l=[e,i,r,a],u=1/(t-1),h=0;h<o;h++)for(var c=0;c<4;c++)for(var _=l[c],d=0,p=0,f=0;f<t;f++){var m=Ae(_,u*f,h);p=n?m:(d+=m)/(f+1),s[4*f+c]=p}return De(s,t,o)}(32,l.x,l.y,l.z,l.speedModifier);var u=e.getHandle("velocity_over_time_tex0"),h=vt.getBindingFromHandle(u);e.bindSampler(h,this._velocityTexture.getGFXSampler()),e.bindTexture(h,this._velocityTexture.getGFXTexture());var c=e.getHandle("u_velocity_space");e.setUniform(c,l.space);var _=e.getHandle("u_velocity_mode");e.setUniform(_,this._velocityTexture.height)}var d=this._particleSystem._colorOverLifetimeModule;if(i=d&&d.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=Ui(32,d.color);var p=e.getHandle("color_over_time_tex0"),f=vt.getBindingFromHandle(p);e.bindSampler(f,this._colorTexture.getGFXSampler()),e.bindTexture(f,this._colorTexture.getGFXTexture());var m=e.getHandle("u_color_mode");e.setUniform(m,this._colorTexture.height)}var y=this._particleSystem._rotationOvertimeModule;if(i=y&&y.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i){this._rotationTexture&&this._rotationTexture.destroy(),y.separateAxes?this._rotationTexture=Fe(32,y.x,y.y,y.z):this._rotationTexture=function(t,e,i){for(var r=Re(e),a=new Float32Array(t*r*4),n=1/(t-1),o=0,s=0;s<r;s++)for(var l=0;l<t;l++){var u=Ae(e,n*l,s);a[o+2]=u,o+=4}return De(a,t,r)}(32,y.z);var v=e.getHandle("rotation_over_time_tex0"),b=vt.getBindingFromHandle(v);e.bindSampler(b,this._rotationTexture.getGFXSampler()),e.bindTexture(b,this._rotationTexture.getGFXTexture());var g=e.getHandle("u_rotation_mode");e.setUniform(g,this._rotationTexture.height)}var M=this._particleSystem._sizeOvertimeModule;if(i=M&&M.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i){this._sizeTexture&&this._sizeTexture.destroy(),M.separateAxes?this._sizeTexture=Fe(32,M.x,M.y,M.z,!0):this._sizeTexture=function(t,e,i){for(var r=Re(e),a=new Float32Array(t*r*4),n=1/(t-1),o=0,s=0,l=0,u=0;u<r;u++){o=0;for(var h=0;h<t;h++){var c=Ae(e,n*h,u);s=i?c:(o+=c)/(h+1),a[l]=s,a[l+1]=s,a[l+2]=s,l+=4}}return De(a,t,r)}(32,M.size,!0);var w=e.getHandle("size_over_time_tex0"),T=vt.getBindingFromHandle(w);e.bindSampler(T,this._sizeTexture.getGFXSampler()),e.bindTexture(T,this._sizeTexture.getGFXTexture());var S=e.getHandle("u_size_mode");e.setUniform(S,this._sizeTexture.height)}var O=this._particleSystem._textureAnimationModule;if(i=O&&O.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(t,e,i,r){for(var a=Math.max(Re(e),Re(i)),n=new Float32Array(t*a*4),o=[e,i],s=1/(t-1),l=0;l<a;l++)for(var u=0;u<2;u++)for(var h=o[u],c=0,_=0,d=0;d<t;d++){var p=Ae(h,s*d,l);_=r?p:(c+=p)/(d+1),n[4*d+u]=_}return De(n,t,a)}(32,O.startFrame,O.frameOverTime);var z=e.getHandle("texture_animation_tex0"),x=vt.getBindingFromHandle(z);e.bindSampler(x,this._animTexture.getGFXSampler()),e.bindTexture(x,this._animTexture.getGFXTexture());var C=e.getHandle("u_anim_info");Au.x=this._animTexture.height,Au.y=O.numTilesX*O.numTilesY,Au.z=O.cycleCount,e.setUniform(C,Au)}}},{key:"getParticleCount",value:function(){return this._particleNum}},{key:"onMaterialModified",value:function(t,e){this._inited&&this.updateMaterialParams()}},{key:"onRebuildPSO",value:function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)}},{key:"_setVertexAttrib",value:function(){switch(this._renderInfo.renderMode){case Fr.StrecthedBillboard:this._vertAttrs=Bu.slice();break;case Fr.Mesh:this._vertAttrs=Uu.slice();break;default:this._vertAttrs=Bu.slice()}}},{key:"updateMaterialParams",value:function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!==e){var i=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1===i.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==t.sharedMaterial&&null==this._defaultMat&&(Vu.parent=at.get("default-particle-gpu-material"),Vu.owner=t,Vu.subModelIdx=0,this._defaultMat=new mt(Vu),null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var r=t.getMaterialInstance(0)||this._defaultMat;switch(t.node.getWorldMatrix(Eu),t.scaleSpace){case Dr.Local:t.node.getScale(this._node_scale);break;case Dr.World:t.node.getWorldScale(this._node_scale)}t._simulationSpace===Dr.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var a=this._renderInfo.renderMode;a===Fr.Billboard?this._defines.CC_RENDER_MODE=0:a===Fr.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):a===Fr.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:a===Fr.VerticalBillboard?this._defines.CC_RENDER_MODE=3:a===Fr.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(a," not support."));var n=t._textureAnimationModule;n&&n.enable&&A.set(this._frameTile_velLenScale,n.numTilesX,n.numTilesY),this.initShaderUniform(r),r.recompileShaders(this._defines),this._model&&this._model.updateMaterial(r)}}}]),e}(bu);function Nu(){var t=zt.root.device;return!!(t.maxVertexTextureUnits>=8&&t.hasFeature(gt.TEXTURE_FLOAT))||(g.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Hu,Wu,Xu,ju,Ku,Yu,Zu,qu,Qu,Ju,$u,th,eh,ih,rh,ah,nh,oh,sh,lh,uh,hh,ch,_h,dh,ph,fh,mh,yh,vh,bh,gh,Mh,wh,Th,Sh,Oh,zh,xh,Ch,Eh,Ah,Rh,Dh,Fh,kh,Ih,Ph,Lh,Bh,Uh,Vh,Gh,Nh,Hh,Wh,Xh,jh,Kh,Yh,Zh,qh,Qh,Jh,$h,tc,ec,ic,rc,ac,nc,oc,sc,lc,uc,hc,cc,_c,dc,pc,fc,mc,yc,vc,bc,gc,Mc,wc,Tc,Sc,Oc,zc,xc,Cc,Ec,Ac,Rc,Dc,Fc,kc,Ic,Pc,Lc,Bc,Uc,Vc,Gc,Nc,Hc,Wc,Xc,jc,Kc,Yc,Zc,qc,Qc,Jc,$c,t_,e_,i_,r_,a_,n_,o_,s_,l_,u_,h_,c_,__,d_,p_,f_,m_,y_,v_,b_,g_,M_,w_,T_,S_,O_,z_,x_,C_,E_,A_,R_,D_,F_,k_,I_,P_,L_,B_,U_,V_,G_,N_,H_,W_,X_,j_,K_,Y_,Z_,q_,Q_,J_,$_,td,ed,id,rd,ad,nd,od,sd,ld,ud,hd,cd,_d,dd,pd,fd,md,yd,vd,bd,gd,Md,wd,Td,Sd,Od,zd,xd,Cd=(Nl=e("cc.ParticleSystemRenderer"),Hl=i(Fr),Wl=R(),Xl=s(),jl=R(),Kl=s(),Yl=R(),Zl=s(),ql=i(Fr),Ql=i(bt),Jl=R(),$l=s(),tu=i(rt),eu=R(),iu=s(),ru=i(rt),au=R(),nu=s(),ou=R(),su=s(),Nl((mu=function(){function t(){d(this,t),m(this,"_renderMode",hu,this),m(this,"_velocityScale",cu,this),m(this,"_lengthScale",_u,this),m(this,"_mesh",du,this),m(this,"_mainTexture",pu,this),m(this,"_useGPU",fu,this),this._particleSystem=null}return h(t,[{key:"onInit",value:function(t){this._particleSystem=t;var e=this._useGPU&&Nu();this._particleSystem.processor=e?new Gu(this):new Cu(this),this._particleSystem.processor.onInit(t)}},{key:"_switchProcessor",value:function(){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Gu(this):new Cu(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(t){this._particleSystem.setMaterial(t,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(t){this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(Nu()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}}]),t}(),uu=mu,a(uu.prototype,"renderMode",[Hl,Wl,Xl],Object.getOwnPropertyDescriptor(uu.prototype,"renderMode"),uu.prototype),a(uu.prototype,"velocityScale",[jl,Kl],Object.getOwnPropertyDescriptor(uu.prototype,"velocityScale"),uu.prototype),a(uu.prototype,"lengthScale",[Yl,Zl],Object.getOwnPropertyDescriptor(uu.prototype,"lengthScale"),uu.prototype),hu=a(uu.prototype,"_renderMode",[ql,l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fr.Billboard}}),cu=a(uu.prototype,"_velocityScale",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_u=a(uu.prototype,"_lengthScale",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),du=a(uu.prototype,"_mesh",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(uu.prototype,"mesh",[Ql,Jl,$l],Object.getOwnPropertyDescriptor(uu.prototype,"mesh"),uu.prototype),a(uu.prototype,"particleMaterial",[tu,eu,iu],Object.getOwnPropertyDescriptor(uu.prototype,"particleMaterial"),uu.prototype),a(uu.prototype,"trailMaterial",[ru,au,nu],Object.getOwnPropertyDescriptor(uu.prototype,"trailMaterial"),uu.prototype),pu=a(uu.prototype,"_mainTexture",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fu=a(uu.prototype,"_useGPU",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(uu.prototype,"useGPU",[ou,su],Object.getOwnPropertyDescriptor(uu.prototype,"useGPU"),uu.prototype),lu=uu))||lu),Ed=Math.cos(_(100)),Ad={position:new w,velocity:new w},Rd=new I,Dd=new k,Fd=new w,kd=new w,Id=new b,Pd=function(){function t(e){for(d(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new w,lifetime:0,width:0,velocity:new w,direction:0,color:new b})}return h(t,[{key:"getElement",value:function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new w,lifetime:0,width:0,velocity:new w,direction:0,color:new b}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]}},{key:"iterateElement",value:function(t,e,i,r){for(var a=this.start>=this.end?this.end+this.trailElements.length:this.end,n=this.start;n<a;n++)e(t,this.trailElements[n%this.trailElements.length],i,r)&&(this.start++,this.start%=this.trailElements.length);this.start===a&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),Ld=(Hu=e("cc.TrailModule"),Wu=R(),Xu=i(Lr),ju=R(),Ku=s(),Yu=i(Ee),Zu=R(),qu=s(),Qu=R(),Ju=s(),$u=i(Dr),th=R(),eh=s(),ih=i(Br),rh=R(),ah=s(),nh=R(),oh=s(),sh=i(Ee),lh=R(),uh=s(),hh=R(),ch=s(),_h=i(Li),dh=R(),ph=s(),fh=i(Li),mh=R(),yh=s(),vh=i(Dr),Hu((a((gh=function(){function t(){d(this,t),m(this,"_enable",Mh,this),m(this,"mode",wh,this),m(this,"lifeTime",Th,this),m(this,"_minParticleDistance",Sh,this),m(this,"existWithParticles",Oh,this),m(this,"textureMode",zh,this),m(this,"widthFromParticle",xh,this),m(this,"widthRatio",Ch,this),m(this,"colorFromParticle",Eh,this),m(this,"colorOverTrail",Ah,this),m(this,"colorOvertime",Rh,this),m(this,"_space",Dh,this),m(this,"_particleSystem",Fh,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:tt.ATTR_POSITION,format:et.RGB32F},{name:tt.ATTR_TEX_COORD,format:et.RGBA32F},{name:tt.ATTR_TEX_COORD1,format:et.RGB32F},{name:tt.ATTR_COLOR,format:et.RGBA8,isNormalized:!0}],this._vertSize=0;for(var e,i=T(this._vertAttrs);!(e=i()).done;){var r=e.value;this._vertSize+=ut[r.format].size}this._particleTrail=new Map}return h(t,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t,this._particleSystem&&this._particleSystem.processor.updateTrailMaterial()}}]),h(t,[{key:"onInit",value:function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,i=t.startLifetime.getMax(),r=t.rateOverTime.getMax(),a=t.duration,n=0,o=t.bursts.length;n<o;n++){e+=t.bursts[n].getMaxCount(t)*Math.ceil(i/a)}this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(r*a+e)),this._trailSegments=new W((function(){return new Pd(10)}),Math.ceil(r*a)),this._enable&&(this.enable=this._enable)}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._particleTrail.clear(),this._detachFromScene()}},{key:"_attachToScene",value:function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))}},{key:"_detachFromScene",value:function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)}},{key:"destroy",value:function(){this.destroySubMeshData(),this._trailModel&&(zt.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy((function(t){t.trailElements.length=0})),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"updateMaterial",value:function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Dr.World&&this._particleSystem._simulationSpace===Dr.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Dd),this._particleSystem.node.getWorldRotation(Rd)):this._needTransform=!1}},{key:"animate",value:function(t,e){if(this._trailSegments){var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var r=i.getElement(i.end-1);if(this._needTransform?w.transformMat4(Fd,t.position,Dd):w.copy(Fd,t.position),!(r&&(i.iterateElement(this,this._updateTrailElement,t,e),w.squaredDistance(r.position,Fd)<this._minSquaredDistance))&&(r=i.addElement())){w.copy(r.position,Fd),r.lifetime=0,this.widthFromParticle?r.width=t.size.x*this.widthRatio.evaluate(0,1):r.width=this.widthRatio.evaluate(0,1);var a=i.count();if(2===a){var n=i.getElement(i.end-2);w.subtract(n.velocity,r.position,n.position)}else if(a>2){var o=i.getElement(i.end-2),s=i.getElement(i.end-3);w.subtract(Fd,s.position,o.position),w.subtract(kd,r.position,o.position),w.subtract(o.velocity,kd,Fd),w.equals(w.ZERO,o.velocity)&&w.copy(o.velocity,Fd),w.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,s)}this.colorFromParticle?r.color.set(t.color):r.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=T(this._particleTrail.keys());!(t=e()).done;){var i=t.value,r=this._particleTrail.get(i);if(-1!==r.start){var a=4*this.vbOffset/this._vertSize,n=r.start>=r.end?r.end+r.trailElements.length:r.end,o=n-r.start,s=1/o,l=r.trailElements[r.start];this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1,1),a,1,0,4);for(var u=r.start+1;u<n;u++){var h=r.trailElements[u%r.trailElements.length],c=u-r.start;this._fillVertexBuffer(h,this.colorOverTrail.evaluate(1-c/o,1),a,1-c*s,c,5)}if(this._needTransform?w.transformMat4(Ad.position,i.position,Dd):w.copy(Ad.position,i.position),1===o||2===o){var _=r.getElement(r.end-1);w.subtract(_.velocity,Ad.position,_.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,w.subtract(Ad.velocity,Ad.position,_.position),this._checkDirectionReverse(Ad,_)}else if(o>2){var d=r.getElement(r.end-1),p=r.getElement(r.end-2);w.subtract(Fd,p.position,d.position),w.subtract(kd,Ad.position,d.position),w.normalize(Fd,Fd),w.normalize(kd,kd),w.subtract(d.velocity,kd,Fd),w.normalize(d.velocity,d.velocity),this._checkDirectionReverse(d,p),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(d,this.colorOverTrail.evaluate(s,1),a,s,o-1,5),w.subtract(Ad.velocity,Ad.position,d.position),w.normalize(Ad.velocity,Ad.velocity),this._checkDirectionReverse(Ad,d)}this.widthFromParticle?Ad.width=i.size.x*this.widthRatio.evaluate(0,1):Ad.width=this.widthRatio.evaluate(0,1),Ad.color=i.color,w.equals(Ad.velocity,w.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Ad,this.colorOverTrail.evaluate(0,1),a,0,o,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=t,this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){this._trailModel||(this._trailModel=g.director.root.createModel(it))}},{key:"rebuild",value:function(){var t=zt.root.device,e=t.createBuffer({usage:ot.VERTEX|ot.TRANSFER_DST,memUsage:st.HOST|st.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);var r=t.createBuffer({usage:ot.INDEX|ot.TRANSFER_DST,memUsage:st.HOST|st.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),r.update(this._iBuffer),this._iaInfoBuffer=t.createBuffer({usage:ot.INDIRECT,memUsage:st.HOST|st.DEVICE,size:lt,stride:lt}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new ht([e],this._vertAttrs,$.TRIANGLE_LIST),this._subMeshData.indexBuffer=r,this._subMeshData.indirectBuffer=this._iaInfoBuffer,this._trailModel.initialize(this._particleSystem.node),this._trailModel.visFlags=this._particleSystem.visibility,this._trailModel.initSubModel(0,this._subMeshData,this._material),this._trailModel.enabled=!0}},{key:"_updateTrailElement",value:function(t,e,i,r){return e.lifetime+=r,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime}},{key:"_fillVertexBuffer",value:function(t,e,i,r,a,n){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,Id.set(t.color),Id.multiply(e),this._vbUint32[this.vbOffset++]=Id._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=Id._val,1&n&&(this._iBuffer[this.ibOffset++]=i+2*a,this._iBuffer[this.ibOffset++]=i+2*a-1,this._iBuffer[this.ibOffset++]=i+2*a+1),4&n&&(this._iBuffer[this.ibOffset++]=i+2*a,this._iBuffer[this.ibOffset++]=i+2*a+1,this._iBuffer[this.ibOffset++]=i+2*a+2)}},{key:"_checkDirectionReverse",value:function(t,e){w.dot(t.velocity,e.velocity)<Ed?t.direction=1-e.direction:t.direction=e.direction}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),t}()).prototype,"enable",[Wu],Object.getOwnPropertyDescriptor(gh.prototype,"enable"),gh.prototype),Mh=a(gh.prototype,"_enable",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wh=a(gh.prototype,"mode",[Xu,l,ju,Ku],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lr.Particles}}),Th=a(gh.prototype,"lifeTime",[Yu,l,Zu,qu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Sh=a(gh.prototype,"_minParticleDistance",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),a(gh.prototype,"minParticleDistance",[Qu,Ju],Object.getOwnPropertyDescriptor(gh.prototype,"minParticleDistance"),gh.prototype),a(gh.prototype,"space",[$u,th,eh],Object.getOwnPropertyDescriptor(gh.prototype,"space"),gh.prototype),Oh=a(gh.prototype,"existWithParticles",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zh=a(gh.prototype,"textureMode",[ih,l,rh,ah],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Br.Stretch}}),xh=a(gh.prototype,"widthFromParticle",[l,nh,oh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ch=a(gh.prototype,"widthRatio",[sh,l,lh,uh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Eh=a(gh.prototype,"colorFromParticle",[l,hh,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ah=a(gh.prototype,"colorOverTrail",[_h,l,dh,ph],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li}}),Rh=a(gh.prototype,"colorOvertime",[fh,l,mh,yh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li}}),Dh=a(gh.prototype,"_space",[vh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.World}}),Fh=a(gh.prototype,"_particleSystem",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bh=gh))||bh),Bd=new k,Ud=new I,Vd=function(e){return t({ParticleSystem:e,ParticleSystemComponent:e}),e}((kh=e("cc.ParticleSystem"),Ih=n(),Ph=o(),Lh=wt(99),Bh=R(),Uh=s(),Vh=i(Li),Gh=R(),Nh=s(),Hh=i(Dr),Wh=R(),Xh=s(),jh=R(),Kh=s(),Yh=G("startSize"),Zh=i(Ee),qh=R(),Qh=s(),Jh=i(Ee),$h=R(),tc=s(),ec=i(Ee),ic=R(),rc=s(),ac=i(Ee),nc=U(),oc=R(),sc=s(),lc=R(),uc=s(),hc=i(Ee),cc=U(),_c=R(),dc=s(),pc=i(Ee),fc=U(),mc=R(),yc=s(),vc=i(Ee),bc=G("startRotation"),gc=U(),Mc=R(),wc=s(),Tc=i(Ee),Sc=R(),Oc=s(),zc=i(Ee),xc=R(),Cc=s(),Ec=R(),Ac=s(),Rc=R(),Dc=s(),Fc=R(),kc=s(),Ic=i(Dr),Pc=R(),Lc=s(),Bc=R(),Uc=s(),Vc=R(),Gc=s(),Nc=i(Ee),Hc=U(),Wc=R(),Xc=s(),jc=i(Ee),Kc=R(),Yc=s(),Zc=i(Ee),qc=R(),Qc=s(),Jc=i([Pl]),$c=R(),t_=s(),e_=i(rt),i_=X(),r_=j(),a_=i(Yr),n_=i(Yr),o_=R(),s_=s(),l_=i(Vl),u_=i(Vl),h_=R(),c_=s(),__=i(zl),d_=i(zl),p_=R(),f_=s(),m_=i(Il),y_=i(Il),v_=R(),b_=s(),g_=i(hn),M_=i(hn),w_=R(),T_=s(),S_=i(pn),O_=i(pn),z_=R(),x_=s(),C_=i(Sl),E_=i(Sl),A_=R(),R_=s(),D_=i(Al),F_=i(Al),k_=R(),I_=s(),P_=i(Ld),L_=i(Ld),B_=R(),U_=s(),V_=i(Cd),G_=R(),N_=s(),H_=R(),W_=s(),kh(X_=Ih(X_=Ph(X_=Lh(X_=r((a((j_=function(t){function e(){var t;return d(this,e),t=p(this,f(e).call(this)),m(t,"startColor",K_,y(t)),m(t,"scaleSpace",Y_,y(t)),m(t,"startSize3D",Z_,y(t)),m(t,"startSizeX",q_,y(t)),m(t,"startSizeY",Q_,y(t)),m(t,"startSizeZ",J_,y(t)),m(t,"startSpeed",$_,y(t)),m(t,"startRotation3D",td,y(t)),m(t,"startRotationX",ed,y(t)),m(t,"startRotationY",id,y(t)),m(t,"startRotationZ",rd,y(t)),m(t,"startDelay",ad,y(t)),m(t,"startLifetime",nd,y(t)),m(t,"duration",od,y(t)),m(t,"loop",sd,y(t)),m(t,"simulationSpeed",ld,y(t)),m(t,"playOnAwake",ud,y(t)),m(t,"gravityModifier",hd,y(t)),m(t,"rateOverTime",cd,y(t)),m(t,"rateOverDistance",_d,y(t)),m(t,"bursts",dd,y(t)),m(t,"_colorOverLifetimeModule",pd,y(t)),m(t,"_shapeModule",fd,y(t)),m(t,"_sizeOvertimeModule",md,y(t)),m(t,"_velocityOvertimeModule",yd,y(t)),m(t,"_forceOvertimeModule",vd,y(t)),m(t,"_limitVelocityOvertimeModule",bd,y(t)),m(t,"_rotationOvertimeModule",gd,y(t)),m(t,"_textureAnimationModule",Md,y(t)),m(t,"_trailModule",wd,y(t)),m(t,"renderer",Td,y(t)),m(t,"enableCulling",Sd,y(t)),t._isPlaying=void 0,t._isPaused=void 0,t._isStopped=void 0,t._isEmitting=void 0,t._time=void 0,t._emitRateTimeCounter=void 0,t._emitRateDistanceCounter=void 0,t._oldWPos=void 0,t._curWPos=void 0,t._customData1=void 0,t._customData2=void 0,t._subEmitters=void 0,m(t,"_prewarm",Od,y(t)),m(t,"_capacity",zd,y(t)),m(t,"_simulationSpace",xd,y(t)),t.processor=null,t.rateOverTime.constant=10,t.startLifetime.constant=5,t.startSizeX.constant=1,t.startSpeed.constant=5,t._isPlaying=!1,t._isPaused=!1,t._isStopped=!0,t._isEmitting=!1,t._time=0,t._emitRateTimeCounter=0,t._emitRateDistanceCounter=0,t._oldWPos=new w,t._curWPos=new w,t._customData1=new A,t._customData2=new A,t._subEmitters=[],t}return u(e,t),h(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"sharedMaterials",get:function(){return S(f(e.prototype),"sharedMaterials",this)},set:function(t){K(f(e.prototype),"sharedMaterials",t,this,!0)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}}]),h(e,[{key:"onLoad",value:function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()}},{key:"_onMaterialModified",value:function(t,e){this.processor.onMaterialModified(t,e)}},{key:"_onRebuildPSO",value:function(t,e){this.processor.onRebuildPSO(t,e)}},{key:"_collectModels",value:function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models}},{key:"_attachToScene",value:function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()}},{key:"_detachFromScene",value:function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()}},{key:"bindModule",value:function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear())}},{key:"getParticleCount",value:function(){return this.processor.getParticleCount()}},{key:"setCustomData1",value:function(t,e){A.set(this._customData1,t,e)}},{key:"setCustomData2",value:function(t,e){A.set(this._customData2,t,e)}},{key:"onDestroy",value:function(){this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()}},{key:"onDisable",value:function(){this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable()}},{key:"update",value:function(t){var e=t*this.simulationSpeed;this._isPlaying&&(this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop(),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData())}},{key:"_onVisibilityChange",value:function(t){this.processor._model&&(this.processor._model.visFlags=t)}},{key:"emit",value:function(t,e){var i=this._time/this.duration;this._simulationSpace===Dr.World&&(this.node.getWorldMatrix(Bd),this.node.getWorldRotation(Ud));for(var r=0;r<t;++r){var a=this.processor.getFreeParticle();if(null===a)return;var n=D(B(0,Y));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(a):(w.set(a.position,0,0,0),w.copy(a.velocity,Zr)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(a),w.multiplyScalar(a.velocity,a.velocity,this.startSpeed.evaluate(i,n)),this._simulationSpace===Dr.World&&(w.transformMat4(a.position,a.position,Bd),w.transformQuat(a.velocity,a.velocity,Ud)),w.copy(a.ultimateVelocity,a.velocity),this.startRotation3D?w.set(a.rotation,this.startRotationX.evaluate(i,n),this.startRotationY.evaluate(i,n),this.startRotationZ.evaluate(i,n)):w.set(a.rotation,0,0,this.startRotationZ.evaluate(i,n)),this.startSize3D?w.set(a.startSize,this.startSizeX.evaluate(i,n),this.startSizeY.evaluate(i,n),this.startSizeZ.evaluate(i,n)):(w.set(a.startSize,this.startSizeX.evaluate(i,n),1,1),a.startSize.y=a.startSize.x),w.copy(a.size,a.startSize),a.startColor.set(this.startColor.evaluate(i,n)),a.color.set(a.startColor),a.startLifetime=this.startLifetime.evaluate(i,n)+e,a.remainingLifetime=a.startLifetime,a.randomSeed=B(0,233280),this.processor.setNewParticle(a)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=Ce.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)}},{key:"_emit",value:function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,t)}this.node.getWorldPosition(this._curWPos);var r=w.distance(this._curWPos,this._oldWPos);if(w.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=r*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var a=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=a,this.emit(a,t)}for(var n,o=T(this.bursts);!(n=o()).done;){n.value.update(this,t)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),w.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(t){this._subEmitters.push(t)}},{key:"removeSubEmitter",value:function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)}},{key:"addBurst",value:function(t){this.bursts.push(t)}},{key:"removeBurst",value:function(t){this.bursts.splice(this.bursts.indexOf(t),1)}},{key:"_onBeforeSerialize",value:function(t){var e=this;return this.enableCulling?t.filter((function(t){return!Ar.includes(t)||e[t]&&e[t].enable})):t}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(Tt)).prototype,"capacity",[Bh,Uh],Object.getOwnPropertyDescriptor(j_.prototype,"capacity"),j_.prototype),K_=a(j_.prototype,"startColor",[Vh,l,Gh,Nh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li}}),Y_=a(j_.prototype,"scaleSpace",[Hh,l,Wh,Xh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.Local}}),Z_=a(j_.prototype,"startSize3D",[l,jh,Kh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q_=a(j_.prototype,"startSizeX",[Yh,Zh,qh,Qh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),Q_=a(j_.prototype,"startSizeY",[Jh,l,$h,tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),J_=a(j_.prototype,"startSizeZ",[ec,l,ic,rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),$_=a(j_.prototype,"startSpeed",[ac,l,nc,oc,sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),td=a(j_.prototype,"startRotation3D",[l,lc,uc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ed=a(j_.prototype,"startRotationX",[hc,l,cc,V,_c,dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),id=a(j_.prototype,"startRotationY",[pc,l,fc,V,mc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),rd=a(j_.prototype,"startRotationZ",[vc,bc,gc,V,Mc,wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),ad=a(j_.prototype,"startDelay",[Tc,l,Sc,Oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),nd=a(j_.prototype,"startLifetime",[zc,l,xc,Cc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),od=a(j_.prototype,"duration",[l,Ec,Ac],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),sd=a(j_.prototype,"loop",[l,Rc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),a(j_.prototype,"prewarm",[Fc,kc],Object.getOwnPropertyDescriptor(j_.prototype,"prewarm"),j_.prototype),a(j_.prototype,"simulationSpace",[Ic,l,Pc,Lc],Object.getOwnPropertyDescriptor(j_.prototype,"simulationSpace"),j_.prototype),ld=a(j_.prototype,"simulationSpeed",[l,Bc,Uc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ud=a(j_.prototype,"playOnAwake",[l,Vc,Gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hd=a(j_.prototype,"gravityModifier",[Nc,l,Hc,Wc,Xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),cd=a(j_.prototype,"rateOverTime",[jc,l,Kc,Yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),_d=a(j_.prototype,"rateOverDistance",[Zc,l,qc,Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ee}}),dd=a(j_.prototype,"bursts",[Jc,l,$c,t_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a(j_.prototype,"sharedMaterials",[Mt,e_,l,i_,r_],Object.getOwnPropertyDescriptor(j_.prototype,"sharedMaterials"),j_.prototype),pd=a(j_.prototype,"_colorOverLifetimeModule",[a_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"colorOverLifetimeModule",[n_,o_,s_],Object.getOwnPropertyDescriptor(j_.prototype,"colorOverLifetimeModule"),j_.prototype),fd=a(j_.prototype,"_shapeModule",[l_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"shapeModule",[u_,h_,c_],Object.getOwnPropertyDescriptor(j_.prototype,"shapeModule"),j_.prototype),md=a(j_.prototype,"_sizeOvertimeModule",[__],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"sizeOvertimeModule",[d_,p_,f_],Object.getOwnPropertyDescriptor(j_.prototype,"sizeOvertimeModule"),j_.prototype),yd=a(j_.prototype,"_velocityOvertimeModule",[m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"velocityOvertimeModule",[y_,v_,b_],Object.getOwnPropertyDescriptor(j_.prototype,"velocityOvertimeModule"),j_.prototype),vd=a(j_.prototype,"_forceOvertimeModule",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"forceOvertimeModule",[M_,w_,T_],Object.getOwnPropertyDescriptor(j_.prototype,"forceOvertimeModule"),j_.prototype),bd=a(j_.prototype,"_limitVelocityOvertimeModule",[S_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"limitVelocityOvertimeModule",[O_,z_,x_],Object.getOwnPropertyDescriptor(j_.prototype,"limitVelocityOvertimeModule"),j_.prototype),gd=a(j_.prototype,"_rotationOvertimeModule",[C_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"rotationOvertimeModule",[E_,A_,R_],Object.getOwnPropertyDescriptor(j_.prototype,"rotationOvertimeModule"),j_.prototype),Md=a(j_.prototype,"_textureAnimationModule",[D_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"textureAnimationModule",[F_,k_,I_],Object.getOwnPropertyDescriptor(j_.prototype,"textureAnimationModule"),j_.prototype),wd=a(j_.prototype,"_trailModule",[P_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a(j_.prototype,"trailModule",[L_,B_,U_],Object.getOwnPropertyDescriptor(j_.prototype,"trailModule"),j_.prototype),Td=a(j_.prototype,"renderer",[V_,l,G_,N_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Cd}}),Sd=a(j_.prototype,"enableCulling",[l,H_,W_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Od=a(j_.prototype,"_prewarm",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zd=a(j_.prototype,"_capacity",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),xd=a(j_.prototype,"_simulationSpace",[l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.Local}}),X_=j_))||X_)||X_)||X_)||X_)||X_)),Gd=t("ParticleUtils",function(){function t(){d(this,t)}return h(t,null,[{key:"instantiate",value:function(t){return this.registeredSceneEvent||(zt.on(xt.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new W((function(){return St(t)||new Ot}),1)),this.particleSystemPool.get(t._uuid).alloc()}},{key:"destroy",value:function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))}},{key:"play",value:function(t){for(var e,i=T(t.getComponentsInChildren(Vd));!(e=i()).done;){e.value.play()}}},{key:"stop",value:function(t){for(var e,i=T(t.getComponentsInChildren(Vd));!(e=i()).done;){e.value.stop()}}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach((function(t){t.destroy((function(t){t.destroy()}))})),this.particleSystemPool.clear()}}]),t}());Gd.particleSystemPool=new Map,Gd.registeredSceneEvent=!1,Z(Pl.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),g.ParticleSystemComponent=Vd,q.setClassAlias(Vd,"cc.ParticleSystemComponent"),g.BillboardComponent=we,q.setClassAlias(we,"cc.BillboardComponent"),g.LineComponent=gr,q.setClassAlias(gr,"cc.LineComponent"),g.ParticleUtils=Gd}}}));
