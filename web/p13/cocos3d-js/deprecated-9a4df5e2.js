System.register(["./deprecated-fd5a8e75.js"],(function(e){"use strict";var t,n,i,r,o,a,s,c,l,u,_,f,h,d,v,m,p,g,y,x,S,C,T,E,A,b,w,I,R,O,P,N,D,z,M,L,F,k,U,B,G,j,V,H,q,W,X,Y,K,Q,J,Z,$,ee,te,ne,ie,re,oe,ae,se,ce,le,ue,_e,fe,he,de,ve,me,pe,ge,ye,xe,Se,Ce,Te,Ee,Ae,be,we,Ie,Re,Oe,Pe,Ne,De,ze,Me,Le,Fe,ke,Ue,Be,Ge,je,Ve,He,qe,We,Xe,Ye,Ke,Qe,Je,Ze,$e,et,tt,nt,it,rt,ot,at,st,ct,lt,ut,_t,ft;return{setters:[function(e){t=e.aJ,n=e.aK,i=e.aL,r=e.j,o=e.d,a=e.l,s=e.V,c=e.b,l=e.e,u=e.f,_=e.E,f=e.M,h=e.O,d=e.aM,v=e.$,m=e.K,p=e.aj,g=e.ar,y=e.k,x=e.ae,S=e.ad,C=e.af,T=e.ao,E=e.ap,A=e.c,b=e._,w=e.s,I=e.F,R=e.g,O=e.aN,P=e.aI,N=e.x,D=e.aO,z=e.D,M=e.aC,L=e.aP,F=e.i,k=e.y,U=e.t,B=e.ai,G=e.aQ,j=e.aR,V=e.w,H=e.aS,q=e.aT,W=e.aU,X=e.Q,Y=e.H,K=e.W,Q=e.T,J=e.aV,Z=e.aW,$=e.ay,ee=e.z,te=e.v,ne=e.as,ie=e.aX,re=e.p,oe=e.aY,ae=e.o,se=e.aZ,ce=e.a_,le=e.a$,ue=e.C,_e=e.b0,fe=e.b1,he=e.b2,de=e.h,ve=e.m,me=e.b3,pe=e.a,ge=e.a2,ye=e.P,xe=e.Y,Se=e.a4,Ce=e.a3,Te=e.aq,Ee=e.b4,Ae=e.b5,be=e.b6,we=e.b7,Ie=e.b8,Re=e.b9,Oe=e.ba,Pe=e.bb,Ne=e.bc,De=e.bd,ze=e.be,Me=e.bf,Le=e.bg,Fe=e.bh,ke=e.bi,Ue=e.bj,Be=e.bk,Ge=e.bl,je=e.bm,Ve=e.bn,He=e.bo,qe=e.bp,We=e.ak,Xe=e.bq,Ye=e.br,Ke=e.bs,Qe=e.n,Je=e.bt,Ze=e.aB,$e=e.bu,et=e.bv,tt=e.ax,nt=e.ac,it=e.X,rt=e.aH,ot=e.bw,at=e.az,st=e.av,ct=e.bx,lt=e.r,ut=e.by,_t=e.bz,ft=e.bA}],execute:function(){e({B:void 0,D:void 0,E:void 0,F:void 0,G:void 0,H:void 0,O:Cf,P:void 0,U:void 0,_:Rt,a:It,a3:void 0,a4:void 0,a5:void 0,aA:Vf,aD:function(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)},aE:function(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t},aF:go,aG:function(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;var o=e;for(;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=yo(o,a),c=t-i(s),l=s,u=0,_=0;c>n&&_++<10;)a*=n/c,s=yo(o,a|=0),c=t-i(s);for(_=0;c<=n&&_++<10;){if(s){var f=fo.exec(s);u=f?f[0].length:1,l=s}s=yo(o,a+=u),c=t-i(s)}0===(a-=u)?(a=1,l=yo(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=yo(o,2));var h=yo(o,0,a),d=void 0;ho.test(l||s)&&(d=vo.exec(h),0===(a-=d?d[0].length:0)&&(a=1),l=yo(o,a),h=yo(o,0,a)),po.test(l)&&(d=mo.exec(h))&&h!==d[0]&&(a-=d[0].length,l=yo(o,a),h=yo(o,0,a)),(0===r.length||(h=h.trim()).length>0)&&r.push(h),t=i(o=l||s)}(0===r.length||(o=o.trim()).length>0)&&r.push(o);return r},aI:fi,aJ:gd,aK:yd,aN:Md,aO:Qd,af:Ps,ag:Ns,ah:void 0,ak:void 0,am:jo,ao:Ac,av:t_,aw:n_,az:function(e){for(var t=e,n=0;n<(arguments.length<=1?0:arguments.length-1);++n){var i=n+1<1||arguments.length<=n+1?void 0:arguments[n+1];if(t_(i)){if(!(i in t))return V('Target object has no property "'.concat(i,'"')),null;t=t[i]}else t=i.get(t);if(null===t)break}return t},b:At,bA:void 0,bB:void 0,bC:void 0,bD:void 0,bE:void 0,bF:void 0,bG:void 0,bH:void 0,bI:void 0,bJ:void 0,bK:void 0,bL:void 0,bM:void 0,bN:void 0,bO:void 0,bP:void 0,bQ:void 0,bR:void 0,bS:void 0,bT:void 0,bU:void 0,bV:void 0,bW:void 0,b_:void 0,bg:void 0,bu:void 0,bw:void 0,bx:void 0,by:void 0,bz:void 0,c:wt,c4:void 0,c8:Qn,c9:Jn,cD:function(e){return e>0&&0==(e&e-1)},c_:Bf,ca:$n,cb:ei,cd:void 0,ce:void 0,d:bt,d6:function(e,t){var n=e,i="";for(;null!==n&&n!==t;)i="".concat(n.name,"/").concat(i),n=n.parent;return i.slice(0,-1)},d7:s_,dH:void 0,dM:function(e){for(var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[n],s=z(a.vertexBundelIndices);!(t=s()).done;)for(var c,l=t.value,u=o.vertexBundles[l],_=u.view.offset,f=u.view,h=f.length,d=f.stride,v=z(u.attributes);!(c=v()).done;){var m=c.value,p=Rf[m.name];p&&(i[p]=(i[p]||[]).concat(Ao(r,m.format,_,h,d))),_+=Kn[m.format].size}var g=a.indexView;return i.indices=Ao(r,an["R".concat(8*g.stride,"UI")],g.offset,g.length),i},dN:Ao,dO:Eo,dP:bo,dR:void 0,dS:void 0,dU:function(e){return"function"==typeof e.lerp},dV:void 0,dX:void 0,d_:void 0,dg:void 0,dk:void 0,dl:void 0,dn:void 0,dq:void 0,dr:void 0,dt:function(e,t,n){var i=a.loader._autoReleaseSetting,r=Ge();if(t)for(var o=0;o<t.length;o++)r[t[o]]=!0;for(var s=0;s<n.length;s++)lp(n[s],r);if(e)for(var c=0;c<e.length;c++){var l=e[c];!1===i[l]||r[l]||a.loader.release(l)}for(var u=Object.keys(i),_=0;_<u.length;_++){var f=u[_];!0!==i[f]||r[f]||a.loader.release(f)}},e:Tt,f:void 0,g:Pt,h:void 0,i:void 0,j:Ct,k:u_,m:Et,o:z_,p:M_,q:L_,s:Ot,t:void 0,v:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,c=void 0===i.capped||i.capped,l=i.arc||2*Math.PI,u=0;c||(e>0&&u++,t>0&&u++);var _=(o+1)*(a+1);c&&(_+=(o+1)*u+o*u);var f=o*a*2*3;c&&(f+=o*u*3);var h=new Array(f),d=new Array(3*_),v=new Array(3*_),m=new Array(2*_),p=Math.max(e,t),g=new s(-p,-r,-p),y=new s(p,r,p),x=Math.sqrt(p*p+r*r),S=0,C=0;T(),c&&(t>0&&E(!1),e>0&&E(!0));return{positions:d,normals:v,uvs:m,indices:h,minPos:g,maxPos:y,boundingRadius:x};function T(){for(var i=[],c=e-t,u=c*c/n*Math.sign(c),_=0;_<=a;_++){for(var f=[],p=_/a,g=p*c+t,y=0;y<=o;++y){var x=y/o,T=x*l,E=Math.sin(T),A=Math.cos(T);d[3*S]=g*E,d[3*S+1]=p*n-r,d[3*S+2]=g*A,s.normalize(rh,s.set(oh,E,-u,A)),v[3*S]=rh.x,v[3*S+1]=rh.y,v[3*S+2]=rh.z,m[2*S]=2*(1-x)%1,m[2*S+1]=p,f.push(S),++S}i.push(f)}for(var b=0;b<a;++b)for(var w=0;w<o;++w){var I=i[b][w],R=i[b+1][w],O=i[b+1][w+1],P=i[b][w+1];h[C]=I,++C,h[C]=P,++C,h[C]=R,++C,h[C]=P,++C,h[C]=O,++C,h[C]=R,++C}}function E(n){for(var i=n?e:t,a=n?1:-1,s=S,c=1;c<=o;++c)d[3*S]=0,d[3*S+1]=r*a,d[3*S+2]=0,v[3*S]=0,v[3*S+1]=a,v[3*S+2]=0,m[2*S]=.5,m[2*S+1]=.5,++S;for(var u=S,_=0;_<=o;++_){var f=_/o*l,p=Math.cos(f),g=Math.sin(f);d[3*S]=i*g,d[3*S+1]=r*a,d[3*S+2]=i*p,v[3*S]=0,v[3*S+1]=a,v[3*S+2]=0,m[2*S]=.5-.5*g*a,m[2*S+1]=.5+.5*p,++S}for(var y=0;y<o;++y){var x=s+y,T=u+y;n?(h[C]=T+1,++C,h[C]=x,++C,h[C]=T,++C):(h[C]=x,++C,h[C]=T+1,++C,h[C]=T,++C)}}},w:Hf,x:qf,y:function(e){var t=function(e){return(e=Hf(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,c=.5*i,l=[],u=[],_=[],f=new s(-a,0,-c),h=new s(a,0,c),d=Math.sqrt(n*n+i*i);s.set(uh,-a,0,c),s.set(_h,a,0,c),s.set(fh,-a,0,-c);for(var v=0;v<=o;v++)for(var m=0;m<=r;m++){var p=m/r,g=v/o;if(s.lerp(ah,uh,_h,p),s.lerp(sh,uh,fh,g),s.subtract(ch,sh,uh),s.add(lh,ah,ch),l.push(lh.x,lh.y,lh.z),t.includeUV&&u.push(p,g),m<r&&v<o){var y=r+1,x=m+v*y,S=m+(v+1)*y,C=m+1+(v+1)*y,T=m+1+v*y;_.push(x,T,S),_.push(T,C,S)}}var E={positions:l,indices:_,minPos:f,maxPos:h,boundingRadius:d};if(t.includeNormal){var A=(o+1)*(r+1),b=new Array(3*A);E.normals=b;for(var w=0;w<A;++w)b[3*w+0]=0,b[3*w+1]=1,b[3*w+2]=0}t.includeUV&&(E.uvs=u);return E},z:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=n-e-t,o=i.sides||32,a=i.heightSegments||32,c=t/n,l=r/n,u=e/n,_=Math.floor(a*c),f=Math.floor(a*u),h=Math.floor(a*l),d=r+t-n/2,v=t-n/2,m=t-n/2,p=i.arc||2*Math.PI,g=[],y=[],x=[],S=[],C=Math.max(e,t),T=new s(-C,-n/2,-C),E=new s(C,n/2,C),A=n/2,b=0,w=[];return R(),I(),O(),{positions:g,normals:y,uvs:x,indices:S,minPos:T,maxPos:E,boundingRadius:A};function I(){for(var n=(e-t)/r,i=0;i<=h;i++){for(var a=[],u=i/h,_=u*(e-t)+t,f=0;f<=o;++f){var d=f/o,m=u*l+c,C=d*p-p/4,T=Math.sin(C),E=Math.cos(C);g.push(_*T),g.push(u*r+v),g.push(_*E),s.normalize(hh,s.set(dh,T,-n,E)),y.push(hh.x),y.push(hh.y),y.push(hh.z),x.push(d,m),a.push(b),++b}w.push(a)}for(var A=0;A<h;++A)for(var I=0;I<o;++I){var R=w[A][I],O=w[A+1][I],P=w[A+1][I+1],N=w[A][I+1];S.push(R),S.push(N),S.push(O),S.push(N),S.push(P),S.push(O)}}function R(){for(var e=0;e<=_;++e)for(var n=e*Math.PI/_/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,u=r,f=Math.cos(c)*i,h=s/o,d=e/a;if(g.push(l*t,u*t+m,f*t),y.push(l,u,f),x.push(h,d),e<_&&s<o){var v=o+1,p=v*e+s,C=v*(e+1)+s,T=v*(e+1)+s+1,E=v*e+s+1;S.push(p,E,C),S.push(E,T,C)}++b}}function O(){for(var t=0;t<=f;++t)for(var n=t*Math.PI/f/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,_=r,v=Math.cos(c)*i,m=s/o,p=t/a+(1-u);if(g.push(l*e,_*e+d,v*e),y.push(l,_,v),x.push(m,p),t<f&&s<o){var C=o+1,T=C*t+s+w[h][o]+1,E=C*(t+1)+s+w[h][o]+1,A=C*(t+1)+s+1+w[h][o]+1,b=C*t+s+1+w[h][o]+1;S.push(T,b,E),S.push(b,A,E)}}}}});var ht=e("db",t("requireComponent")),dt=e("de",t("executionOrder")),vt=e("da",n("disallowMultiple")),mt=e("dQ",(function(e,t,n){return i({__noImplicit:!0,override:!0})(e,t,n)})),pt=e("R",function(){function e(t,n){o(this,e),this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(n);for(var i=0;i<n;++i)this._data[i]=t()}return r(e,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}()),gt=e("C",function(){function e(t,n){o(this,e),this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==n?n:function(e,t){return e-t}}return r(e,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"destroy",value:function(){this.length=0,this.array.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){return this.array.indexOf(e)}}]),e}()),yt=/(\.[^\.\/\?\\]*)(\?.*)?$/,xt=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,St=/[^\.\/]+\/\.\.\//;function Ct(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function Tt(e){var t=yt.exec(e);return t?t[1]:""}function Et(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function At(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return"";var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function bt(e){var t=xt.exec(e);return t?t[2]:""}function wt(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function It(e,t,n){if(0===t.indexOf("."))return wt(e,t);var i=e.indexOf("?"),r="",o=n?Tt(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function Rt(e){var t=e=String(e);do{t=e,e=e.replace(St,"")}while(t.length!==e.length);return e}function Ot(e){return e.replace(/[\/\\]$/,"")}function Pt(){return a.sys.os===a.sys.OS_WINDOWS?"\\":"/"}e("aB",Object.freeze({__proto__:null,join:Ct,extname:Tt,mainFileName:Et,basename:At,dirname:bt,changeExtname:wt,changeBasename:It,_normalize:Rt,stripSep:Ot,getSeperator:Pt}));var Nt=e("du",{SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512}),Dt=new s,zt=new s,Mt=new s,Lt=new s,Ft=new s,kt=new s,Ut=new Array(3),Bt=new Array(3);function Gt(e,t){return s.dot(t.n,e)-t.d}function jt(e,t,n){return s.copy(e,t),s.subtract(Ft,n.center,n.halfExtents),s.add(kt,n.center,n.halfExtents),e.x=e.x<Ft.x?Ft.x:e.x,e.y=e.y<Ft.x?Ft.y:e.y,e.z=e.z<Ft.x?Ft.z:e.z,e.x=e.x>kt.x?kt.x:e.x,e.y=e.y>kt.x?kt.y:e.y,e.z=e.z>kt.x?kt.z:e.z,e}function Vt(e,t,n){s.set(Dt,n.orientation.m00,n.orientation.m01,n.orientation.m02),s.set(zt,n.orientation.m03,n.orientation.m04,n.orientation.m05),s.set(Mt,n.orientation.m06,n.orientation.m07,n.orientation.m08),Ut[0]=Dt,Ut[1]=zt,Ut[2]=Mt,Bt[0]=n.halfExtents.x,Bt[1]=n.halfExtents.y,Bt[2]=n.halfExtents.z,s.subtract(Lt,t,n.center),s.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=s.dot(Lt,Ut[i]);r>Bt[i]&&(r=Bt[i]),r<-Bt[i]&&(r=-Bt[i]),e.x+=r*Ut[i].x,e.y+=r*Ut[i].y,e.z+=r*Ut[i].z}return e}e("dv",Object.freeze({__proto__:null,point_plane:Gt,pt_point_plane:function(e,t,n){var i=Gt(t,n);return s.subtract(e,t,s.multiplyScalar(e,n.n,i))},pt_point_aabb:jt,pt_point_obb:Vt,pt_point_line:function(e,t,n,i){s.subtract(Dt,n,i);var r=Dt,o=s.lengthSqr(r);if(0==o)s.copy(e,n);else{s.subtract(Dt,t,n);var a=s.dot(Dt,r)/o;a<0?s.copy(e,n):a>1?s.copy(e,i):s.scaleAndAdd(e,n,r,a)}}}));var Ht=e("dz",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;o(this,e),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Nt.SHAPE_RAY,this.o=new s(t,n,i),this.d=new s(r,a,c)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,n,i,r,o,a)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return s.copy(e.o,t.o),s.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,n){return s.copy(e.o,t),s.normalize(e.d,s.subtract(e.d,n,t)),e}},{key:"set",value:function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e}}]),r(e,[{key:"computeHit",value:function(e,t){s.normalize(e,this.d),s.scaleAndAdd(e,this.o,e,t)}}]),e}()),qt=new s,Wt=new s,Xt=new s,Yt=new s;function Kt(e){return Math.max(Math.max(e.x,e.y),e.z)}var Qt,Jt=e("dB",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;o(this,e),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=Nt.SHAPE_SPHERE,this.center=new s(t,n,i),this.radius=r}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r){return new e(t,n,i,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return s.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,n){return s.multiplyScalar(e.center,s.add(qt,t,n),.5),e.radius=.5*s.subtract(qt,n,t).length(),e}},{key:"set",value:function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e}},{key:"mergePoint",value:function(e,t,n){if(t.radius<0)return e.center=n,e.radius=0,e;s.subtract(Wt,n,t.center);var i=Wt.length();if(i>t.radius){var r=.5*(i-t.radius);e.radius+=r,s.multiplyScalar(Wt,Wt,r/i),s.add(e.center,e.center,Wt)}return e}},{key:"mergeAABB",value:function(t,n,i){return i.getBoundary(Xt,Yt),e.mergePoint(t,n,Xt),e.mergePoint(t,n,Yt),t}}]),r(e,[{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){s.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),s.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,n,i,r){s.transformMat4(r.center,this.center,e),r.radius=this.radius*Kt(i)}},{key:"translateAndRotate",value:function(e,t,n){s.transformMat4(n.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*Kt(e)}}]),e}()),Zt=e("dA",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;o(this,e),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Nt.SHAPE_TRIANGLE,this.a=new s(t,n,i),this.b=new s(r,a,c),this.c=new s(l,u,_)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,n,i,r,o,a,s,c,l)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return s.copy(e.a,t.a),s.copy(e.b,t.b),s.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,n,i){return s.copy(e.a,t),s.copy(e.b,n),s.copy(e.c,i),e}},{key:"set",value:function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e}}]),e}()),$t=e("bq",16),en=e("br",16),tn=e("bs",4),nn=e("bt",24);!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.FENCE=13]="FENCE",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(Qt||(Qt=e("bu",{})));var rn,on,an,sn,cn,ln,un,_n,fn,hn,dn,vn,mn,pn,gn,yn,xn,Sn,Cn,Tn,En,An,bn,wn,In,Rn,On,Pn,Nn,Dn,zn,Mn,Ln=e("bv",function(){function e(t){o(this,e),this._gfxType=Qt.UNKNOWN,this._gfxType=t}return r(e,[{key:"gfxType",get:function(){return this._gfxType}}]),e}());!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(rn||(rn=e("G",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(on||(on=e("bw",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",e[e.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",e[e.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",e[e.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",e[e.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",e[e.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",e[e.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",e[e.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",e[e.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",e[e.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",e[e.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",e[e.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",e[e.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",e[e.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",e[e.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",e[e.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",e[e.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",e[e.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",e[e.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",e[e.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",e[e.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",e[e.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",e[e.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",e[e.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",e[e.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",e[e.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",e[e.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",e[e.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12"}(an||(an=e("f",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(sn||(sn=e("h",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(cn||(cn=e("i",{}))),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(ln||(ln=e("bx",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(un||(un=e("by",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(_n||(_n=e("t",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(fn||(fn=e("bz",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(hn||(hn=e("bA",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(dn||(dn=e("bB",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(vn||(vn=e("bC",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(mn||(mn=e("bD",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(pn||(pn=e("bE",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(gn||(gn=e("bF",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(yn||(yn=e("bG",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(xn||(xn=e("bH",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(Sn||(Sn=e("bI",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Cn||(Cn=e("bJ",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(Tn||(Tn=e("bK",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(En||(En=e("bL",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(An||(An=e("bM",{}))),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(bn||(bn=e("bN",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER=16]="SAMPLER"}(wn||(wn=e("bO",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(In||(In=e("bP",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Rn||(Rn=e("bQ",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(On||(On=e("bR",{}))),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(Pn||(Pn=e("bS",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Nn||(Nn=e("bT",{}))),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(Dn||(Dn=e("bU",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(zn||(zn=e("bV",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(Mn||(Mn=e("bW",{})));var Fn,kn=e("bX",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;o(this,e),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=t,this.y=n,this.width=i,this.height=r})),Un=e("bY",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;o(this,e),this.left=void 0,this.top=void 0,this.width=void 0,this.height=void 0,this.minDepth=void 0,this.maxDepth=void 0,this.left=t,this.top=n,this.width=i,this.height=r,this.minDepth=a,this.maxDepth=s})),Bn=e("bZ",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;o(this,e),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=t,this.g=n,this.b=i,this.a=r}));!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Fn||(Fn=e("b_",{})));var Gn,jn=e("b$",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;o(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.x=t,this.y=n,this.z=i})),Vn=e("c0",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;o(this,e),this.width=void 0,this.height=void 0,this.depth=void 0,this.width=t,this.height=n,this.depth=i})),Hn=e("c1",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;o(this,e),this.mipLevel=void 0,this.baseArrayLayer=void 0,this.layerCount=void 0,this.mipLevel=t,this.baseArrayLayer=n,this.layerCount=i})),qn=e("c2",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Hn,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new jn,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Hn,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new jn,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Vn;o(this,e),this.srcSubres=void 0,this.srcOffset=void 0,this.dstSubres=void 0,this.dstOffset=void 0,this.extent=void 0,this.srcSubres=t,this.srcOffset=n,this.dstSubres=i,this.dstOffset=r,this.extent=a})),Wn=e("c3",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new jn,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Vn,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Hn;o(this,e),this.buffStride=void 0,this.buffTexHeight=void 0,this.texOffset=void 0,this.texExtent=void 0,this.texSubres=void 0,this.buffStride=t,this.buffTexHeight=n,this.texOffset=i,this.texExtent=r,this.texSubres=a}));!function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Gn||(Gn=e("c4",{})));var Xn=e("c5",(function e(t,n,i,r,a,s,c,l){o(this,e),this.name=void 0,this.size=void 0,this.count=void 0,this.type=void 0,this.hasAlpha=void 0,this.hasDepth=void 0,this.hasStencil=void 0,this.isCompressed=void 0,this.name=t,this.size=n,this.count=i,this.type=r,this.hasAlpha=a,this.hasDepth=s,this.hasStencil=c,this.isCompressed=l})),Yn=e("c6",(function e(){o(this,e),this.bufferSize=0,this.textureSize=0})),Kn=e("c7",Object.freeze([new Xn("UNKNOWN",0,0,Gn.NONE,!1,!1,!1,!1),new Xn("A8",1,1,Gn.UNORM,!0,!1,!1,!1),new Xn("L8",1,1,Gn.UNORM,!1,!1,!1,!1),new Xn("LA8",1,2,Gn.UNORM,!0,!1,!1,!1),new Xn("R8",1,1,Gn.UNORM,!1,!1,!1,!1),new Xn("R8SN",1,1,Gn.SNORM,!1,!1,!1,!1),new Xn("R8UI",1,1,Gn.UINT,!1,!1,!1,!1),new Xn("R8I",1,1,Gn.INT,!1,!1,!1,!1),new Xn("R16F",2,1,Gn.FLOAT,!1,!1,!1,!1),new Xn("R16UI",2,1,Gn.UINT,!1,!1,!1,!1),new Xn("R16I",2,1,Gn.INT,!1,!1,!1,!1),new Xn("R32F",4,1,Gn.FLOAT,!1,!1,!1,!1),new Xn("R32UI",4,1,Gn.UINT,!1,!1,!1,!1),new Xn("R32I",4,1,Gn.INT,!1,!1,!1,!1),new Xn("RG8",2,2,Gn.UNORM,!1,!1,!1,!1),new Xn("RG8SN",2,2,Gn.SNORM,!1,!1,!1,!1),new Xn("RG8UI",2,2,Gn.UINT,!1,!1,!1,!1),new Xn("RG8I",2,2,Gn.INT,!1,!1,!1,!1),new Xn("RG16F",4,2,Gn.FLOAT,!1,!1,!1,!1),new Xn("RG16UI",4,2,Gn.UINT,!1,!1,!1,!1),new Xn("RG16I",4,2,Gn.INT,!1,!1,!1,!1),new Xn("RG32F",8,2,Gn.FLOAT,!1,!1,!1,!1),new Xn("RG32UI",8,2,Gn.UINT,!1,!1,!1,!1),new Xn("RG32I",8,2,Gn.INT,!1,!1,!1,!1),new Xn("RGB8",3,3,Gn.UNORM,!1,!1,!1,!1),new Xn("SRGB8",3,3,Gn.UNORM,!1,!1,!1,!1),new Xn("RGB8SN",3,3,Gn.SNORM,!1,!1,!1,!1),new Xn("RGB8UI",3,3,Gn.UINT,!1,!1,!1,!1),new Xn("RGB8I",3,3,Gn.INT,!1,!1,!1,!1),new Xn("RGB16F",6,3,Gn.FLOAT,!1,!1,!1,!1),new Xn("RGB16UI",6,3,Gn.UINT,!1,!1,!1,!1),new Xn("RGB16I",6,3,Gn.INT,!1,!1,!1,!1),new Xn("RGB32F",12,3,Gn.FLOAT,!1,!1,!1,!1),new Xn("RGB32UI",12,3,Gn.UINT,!1,!1,!1,!1),new Xn("RGB32I",12,3,Gn.INT,!1,!1,!1,!1),new Xn("RGBA8",4,4,Gn.UNORM,!0,!1,!1,!1),new Xn("BGRA8",4,4,Gn.UNORM,!0,!1,!1,!1),new Xn("SRGB8_A8",4,4,Gn.UNORM,!0,!1,!1,!1),new Xn("RGBA8SN",4,4,Gn.SNORM,!0,!1,!1,!1),new Xn("RGBA8UI",4,4,Gn.UINT,!0,!1,!1,!1),new Xn("RGBA8I",4,4,Gn.INT,!0,!1,!1,!1),new Xn("RGBA16F",8,4,Gn.FLOAT,!0,!1,!1,!1),new Xn("RGBA16UI",8,4,Gn.UINT,!0,!1,!1,!1),new Xn("RGBA16I",8,4,Gn.INT,!0,!1,!1,!1),new Xn("RGBA32F",16,4,Gn.FLOAT,!0,!1,!1,!1),new Xn("RGBA32UI",16,4,Gn.UINT,!0,!1,!1,!1),new Xn("RGBA32I",16,4,Gn.INT,!0,!1,!1,!1),new Xn("R5G6B5",2,3,Gn.UNORM,!1,!1,!1,!1),new Xn("R11G11B10F",4,3,Gn.FLOAT,!1,!1,!1,!1),new Xn("RGB5A1",2,4,Gn.UNORM,!0,!1,!1,!1),new Xn("RGBA4",2,4,Gn.UNORM,!0,!1,!1,!1),new Xn("RGB10A2",2,4,Gn.UNORM,!0,!1,!1,!1),new Xn("RGB10A2UI",2,4,Gn.UINT,!0,!1,!1,!1),new Xn("RGB9E5",2,4,Gn.FLOAT,!0,!1,!1,!1),new Xn("D16",2,1,Gn.UINT,!1,!0,!1,!1),new Xn("D16S8",3,2,Gn.UINT,!1,!0,!0,!1),new Xn("D24",3,1,Gn.UINT,!1,!0,!1,!1),new Xn("D24S8",4,2,Gn.UINT,!1,!0,!0,!1),new Xn("D32F",4,1,Gn.FLOAT,!1,!0,!1,!1),new Xn("D32FS8",5,2,Gn.FLOAT,!1,!0,!0,!1),new Xn("BC1",1,3,Gn.UNORM,!1,!1,!1,!0),new Xn("BC1_ALPHA",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC1_SRGB",1,3,Gn.UNORM,!1,!1,!1,!0),new Xn("BC1_SRGB_ALPHA",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC2",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC2_SRGB",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC3",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC3_SRGB",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC4",1,1,Gn.UNORM,!1,!1,!1,!0),new Xn("BC4_SNORM",1,1,Gn.SNORM,!1,!1,!1,!0),new Xn("BC5",1,2,Gn.UNORM,!1,!1,!1,!0),new Xn("BC5_SNORM",1,2,Gn.SNORM,!1,!1,!1,!0),new Xn("BC6H_UF16",1,3,Gn.UFLOAT,!1,!1,!1,!0),new Xn("BC6H_SF16",1,3,Gn.FLOAT,!1,!1,!1,!0),new Xn("BC7",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("BC7_SRGB",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ETC_RGB8",1,3,Gn.UNORM,!1,!1,!1,!0),new Xn("ETC2_RGB8",1,3,Gn.UNORM,!1,!1,!1,!0),new Xn("ETC2_SRGB8",1,3,Gn.UNORM,!1,!1,!1,!0),new Xn("ETC2_RGB8_A1",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ETC2_SRGB8_A1",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ETC2_RGBA8",2,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ETC2_SRGB8_A8",2,4,Gn.UNORM,!0,!1,!1,!0),new Xn("EAC_R11",1,1,Gn.UNORM,!1,!1,!1,!0),new Xn("EAC_R11SN",1,1,Gn.SNORM,!1,!1,!1,!0),new Xn("EAC_RG11",2,2,Gn.UNORM,!1,!1,!1,!0),new Xn("EAC_RG11SN",2,2,Gn.SNORM,!1,!1,!1,!0),new Xn("PVRTC_RGB2",2,3,Gn.UNORM,!1,!1,!1,!0),new Xn("PVRTC_RGBA2",2,4,Gn.UNORM,!0,!1,!1,!0),new Xn("PVRTC_RGB4",2,3,Gn.UNORM,!1,!1,!1,!0),new Xn("PVRTC_RGBA4",2,4,Gn.UNORM,!0,!1,!1,!0),new Xn("PVRTC2_2BPP",2,4,Gn.UNORM,!0,!1,!1,!0),new Xn("PVRTC2_4BPP",2,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_4x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_5x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_5x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_6x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_6x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_8x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_8x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_8x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_10x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_10x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_10x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_10x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_12x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_RGBA_12x12",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_4x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_5x4",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_5x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_6x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_6x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_8x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_8x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_8x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_10x5",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_10x6",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_10x8",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_10x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_12x10",1,4,Gn.UNORM,!0,!1,!1,!0),new Xn("ASTC_SRGBA_12x12",1,4,Gn.UNORM,!0,!1,!1,!0)]));function Qn(e,t,n,i){if(!Kn[e].isCompressed)return t*n*i*Kn[e].size;switch(e){case an.BC1:case an.BC1_ALPHA:case an.BC1_SRGB:case an.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case an.BC2:case an.BC2_SRGB:case an.BC3:case an.BC3_SRGB:case an.BC4:case an.BC4_SNORM:case an.BC6H_SF16:case an.BC6H_UF16:case an.BC7:case an.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case an.BC5:case an.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case an.ETC_RGB8:case an.ETC2_RGB8:case an.ETC2_SRGB8:case an.ETC2_RGB8_A1:case an.EAC_R11:case an.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case an.ETC2_RGBA8:case an.ETC2_SRGB8_A1:case an.EAC_RG11:case an.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case an.PVRTC_RGB2:case an.PVRTC_RGBA2:case an.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case an.PVRTC_RGB4:case an.PVRTC_RGBA4:case an.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case an.ASTC_RGBA_4x4:case an.ASTC_SRGBA_4x4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case an.ASTC_RGBA_5x4:case an.ASTC_SRGBA_5x4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case an.ASTC_RGBA_5x5:case an.ASTC_SRGBA_5x5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case an.ASTC_RGBA_6x5:case an.ASTC_SRGBA_6x5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case an.ASTC_RGBA_6x6:case an.ASTC_SRGBA_6x6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case an.ASTC_RGBA_8x5:case an.ASTC_SRGBA_8x5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case an.ASTC_RGBA_8x6:case an.ASTC_SRGBA_8x6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case an.ASTC_RGBA_8x8:case an.ASTC_SRGBA_8x8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case an.ASTC_RGBA_10x5:case an.ASTC_SRGBA_10x5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case an.ASTC_RGBA_10x6:case an.ASTC_SRGBA_10x6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case an.ASTC_RGBA_10x8:case an.ASTC_SRGBA_10x8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case an.ASTC_RGBA_10x10:case an.ASTC_SRGBA_10x10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case an.ASTC_RGBA_12x10:case an.ASTC_SRGBA_12x10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case an.ASTC_RGBA_12x12:case an.ASTC_SRGBA_12x12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function Jn(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=Qn(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var Zn=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function $n(e){return Zn[e]||0}function ei(e){var t=e.size/e.count;switch(e.type){case Gn.UNORM:case Gn.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Gn.SNORM:case Gn.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Gn.FLOAT:return Float32Array}return Float32Array}var ti,ni,ii=e("cc",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new jn,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Vn,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Hn;o(this,e),this.buffStride=t,this.buffTexHeight=n,this.texOffset=i,this.texExtent=r,this.texSubres=a}return r(e,[{key:"copy",value:function(e){}}]),e}()),ri=Object.freeze({__proto__:null,GFX_MAX_VERTEX_ATTRIBUTES:$t,GFX_MAX_TEXTURE_UNITS:en,GFX_MAX_ATTACHMENTS:tn,GFX_MAX_BUFFER_BINDINGS:nn,get GFXObjectType(){return Qt},GFXObject:Ln,get GFXAttributeName(){return rn},get GFXType(){return on},get GFXFormat(){return an},get GFXBufferUsageBit(){return sn},get GFXMemoryUsageBit(){return cn},get GFXBufferFlagBit(){return ln},get GFXBufferAccessBit(){return un},get GFXPrimitiveMode(){return _n},get GFXPolygonMode(){return fn},get GFXShadeModel(){return hn},get GFXCullMode(){return dn},get GFXComparisonFunc(){return vn},get GFXStencilOp(){return mn},get GFXBlendOp(){return pn},get GFXBlendFactor(){return gn},get GFXColorMask(){return yn},get GFXFilter(){return xn},get GFXAddress(){return Sn},get GFXTextureType(){return Cn},get GFXTextureUsageBit(){return Tn},get GFXSampleCount(){return En},get GFXTextureFlagBit(){return An},get GFXShaderStageFlagBit(){return bn},get GFXDescriptorType(){return wn},get GFXCommandBufferType(){return In},get GFXLoadOp(){return Rn},get GFXStoreOp(){return On},get GFXTextureLayout(){return Pn},get GFXPipelineBindPoint(){return Nn},get GFXDynamicStateFlagBit(){return Dn},get GFXStencilFace(){return zn},get GFXQueueType(){return Mn},GFXRect:kn,GFXViewport:Un,GFXColor:Bn,get GFXClearFlag(){return Fn},GFXOffset:jn,GFXExtent:Vn,GFXTextureSubres:Hn,GFXTextureCopy:qn,GFXBufferTextureCopy:Wn,get GFXFormatType(){return Gn},GFXFormatInfo:Xn,GFXMemoryStatus:Yn,GFXFormatInfos:Kn,GFXFormatSize:Qn,GFXFormatSurfaceSize:Jn,GFXGetTypeSize:$n,getTypedArrayConstructor:ei,BufferTextureCopy:ii}),oi=(e("bm",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;o(this,e),this.vertexCount=void 0,this.firstVertex=void 0,this.indexCount=void 0,this.firstIndex=void 0,this.vertexOffset=void 0,this.instanceCount=void 0,this.firstInstance=void 0,this.vertexCount=t,this.firstVertex=n,this.indexCount=i,this.firstIndex=r,this.vertexOffset=a,this.instanceCount=s,this.firstInstance=c})),e("bn",28),e("bo",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.BUFFER)))._device=void 0,n._usage=sn.NONE,n._memUsage=cn.NONE,n._size=0,n._stride=1,n._count=0,n._flags=ln.NONE,n._bakcupBuffer=null,n._indirectBuffer=null,n._isBufferView=!1,n._device=e,n}return c(t,e),r(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"backupBuffer",get:function(){return this._bakcupBuffer}}]),t}(Ln))),ai=e("bp",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.COMMAND_BUFFER)))._device=void 0,n._queue=null,n._type=In.PRIMARY,n._numDrawCalls=0,n._numInstances=0,n._numTris=0,n._device=e,n}return c(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(Ln));_(an),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GL=1]="GL",e[e.GLES2=2]="GLES2",e[e.GLES3=3]="GLES3",e[e.METAL=4]="METAL",e[e.VULKAN=5]="VULKAN",e[e.DX12=6]="DX12",e[e.WEBGL=7]="WEBGL",e[e.WEBGL2=8]="WEBGL2"}(ti||(ti=e("cd",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D16=7]="FORMAT_D16",e[e.FORMAT_D16S8=8]="FORMAT_D16S8",e[e.FORMAT_D24=9]="FORMAT_D24",e[e.FORMAT_D24S8=10]="FORMAT_D24S8",e[e.FORMAT_D32F=11]="FORMAT_D32F",e[e.FORMAT_D32FS8=12]="FORMAT_D32FS8",e[e.FORMAT_ETC1=13]="FORMAT_ETC1",e[e.FORMAT_ETC2=14]="FORMAT_ETC2",e[e.FORMAT_DXT=15]="FORMAT_DXT",e[e.FORMAT_PVRTC=16]="FORMAT_PVRTC",e[e.FORMAT_ASTC=17]="FORMAT_ASTC",e[e.FORMAT_RGB8=18]="FORMAT_RGB8",e[e.MSAA=19]="MSAA",e[e.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",e[e.COUNT=22]="COUNT"}(ni||(ni=e("ce",{})));var si=e("cf",(function e(){o(this,e),this.bufferOffsets=[],this.samplerOffsets=[]})),ci=e("cg",function(){function e(){o(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=ti.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(ni.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=nn,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._uboOffsetAlignment=1,this._depthBits=0,this._stencilBits=0,this._colorFmt=an.UNKNOWN,this._depthStencilFmt=an.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus={bufferSize:0,textureSize:0},this._clipSpaceMinZ=-1,this._screenSpaceSignY=1,this._UVSpaceSignY=-1}return r(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var n=void 0!==t?t:"";this._macros.set(e,n)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"uboOffsetAlignment",get:function(){return this._uboOffsetAlignment}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"clipSpaceMinZ",get:function(){return this._clipSpaceMinZ}},{key:"screenSpaceSignY",get:function(){return this._screenSpaceSignY}},{key:"UVSpaceSignY",get:function(){return this._UVSpaceSignY}}]),e}()),li=e("ch",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.FRAMEBUFFER)))._device=void 0,n._renderPass=null,n._colorTextures=[],n._depthStencilTexture=null,n._device=e,n}return c(t,e),r(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(Ln)),ui=String.prototype.charCodeAt;function _i(e){return this[e]}function fi(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?ui:_i;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var hi=e("ci",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.INPUT_ASSEMBLER)))._device=void 0,n._attributes=[],n._vertexBuffers=[],n._indexBuffer=null,n._vertexCount=0,n._firstVertex=0,n._indexCount=0,n._firstIndex=0,n._vertexOffset=0,n._instanceCount=0,n._firstInstance=0,n._attributesHash=0,n._indirectBuffer=null,n._device=e,n}return c(t,e),r(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),r(t,[{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"computeAttributesHash",value:function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=",".concat(n.name,",").concat(n.format,",").concat(n.isNormalized,",").concat(n.stream,",").concat(n.isInstanced)}return fi(e,666)}}]),t}(Ln)),di=e("cl",function(){function e(){o(this,e),this.isDiscard=!1,this.polygonMode=fn.FILL,this.shadeModel=hn.GOURAND,this.cullMode=dn.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return r(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}()),vi=e("cm",function(){function e(){o(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=vn.LESS,this.stencilTestFront=!1,this.stencilFuncFront=vn.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=mn.KEEP,this.stencilZFailOpFront=mn.KEEP,this.stencilPassOpFront=mn.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=vn.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=mn.KEEP,this.stencilZFailOpBack=mn.KEEP,this.stencilPassOpBack=mn.KEEP,this.stencilRefBack=1}return r(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}()),mi=e("cn",function(){function e(){o(this,e),this.blend=!1,this.blendSrc=gn.ONE,this.blendDst=gn.ZERO,this.blendEq=pn.ADD,this.blendSrcAlpha=gn.ONE,this.blendDstAlpha=gn.ZERO,this.blendAlphaEq=pn.ADD,this.blendColorMask=yn.ALL}return r(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}()),pi=e("co",(function e(){o(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.targets=[new mi]})),gi=e("cp",(function e(){o(this,e),this.attributes=[]})),yi=e("cq",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.PIPELINE_STATE)))._device=void 0,n._shader=null,n._pipelineLayout=null,n._primitive=_n.TRIANGLE_LIST,n._is=null,n._rs=null,n._dss=null,n._bs=null,n._dynamicStates=Dn.NONE,n._renderPass=null,n._device=e,n}return c(t,e),r(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(Ln)),xi=e("cr",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.QUEUE)))._device=void 0,n._type=Mn.GRAPHICS,n._isAsync=!1,n._device=e,n}return c(t,e),r(t,[{key:"type",get:function(){return this._type}}]),r(t,[{key:"isAsync",value:function(){return this._isAsync}}]),t}(Ln)),Si=e("cs",(function e(){o(this,e),this.format=an.UNKNOWN,this.sampleCount=1,this.loadOp=Rn.CLEAR,this.storeOp=On.STORE,this.beginLayout=Pn.UNDEFINED,this.endLayout=Pn.PRESENT_SRC})),Ci=e("ct",(function e(){o(this,e),this.format=an.UNKNOWN,this.sampleCount=1,this.depthLoadOp=Rn.CLEAR,this.depthStoreOp=On.STORE,this.stencilLoadOp=Rn.CLEAR,this.stencilStoreOp=On.STORE,this.beginLayout=Pn.UNDEFINED,this.endLayout=Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL})),Ti=e("cu",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.RENDER_PASS)))._device=void 0,n._colorInfos=[],n._depthStencilInfo=null,n._subPasses=[],n._hash=0,n._device=e,n}return c(t,e),r(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subPasses}},{key:"hash",get:function(){return this._hash}}]),r(t,[{key:"computeHash",value:function(){var e="";if(this._subPasses.length)for(var t=0;t<this._subPasses.length;++t){var n=this._subPasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=",".concat(r.format,",").concat(r.sampleCount)}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=",".concat(a.format,",").concat(a.sampleCount)}}if(void 0!==n.depthStencil){var s=this._colorInfos[n.depthStencil];e+="ds,".concat(s.format,",").concat(s.sampleCount)}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=",".concat(l.format,",").concat(l.sampleCount)}var u=this._depthStencilInfo;u&&(e+="ds,".concat(u.format,",").concat(u.sampleCount))}return fi(e,666)}}]),t}(Ln)),Ei=e("cv",function(){function e(){o(this,e),this.name="",this.minFilter=xn.LINEAR,this.magFilter=xn.LINEAR,this.mipFilter=xn.NONE,this.addressU=Sn.WRAP,this.addressV=Sn.WRAP,this.addressW=Sn.WRAP,this.maxAnisotropy=16,this.cmpFunc=vn.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return r(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}()),Ai=e("cw",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.SAMPLER)))._device=void 0,n._state=new Ei,n._device=e,n._state=new Ei,n}return c(t,e),r(t,[{key:"state",get:function(){return this._state}}]),t}(Ln)),bi=(e("cx",(function e(){o(this,e),this.stage=bn.NONE,this.source=""})),e("cy",(function e(){o(this,e),this.name="",this.type=on.UNKNOWN,this.count=1})),e("cz",(function e(){o(this,e),this.set=-1,this.binding=-1,this.name="",this.members=[],this.count=1})),e("cA",(function e(){o(this,e),this.set=-1,this.binding=-1,this.name="",this.type=on.UNKNOWN,this.count=1})),e("cB",(function e(){o(this,e),this.name="",this.stages=[],this.attributes=[],this.blocks=[],this.samplers=[]})),e("cC",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.SHADER)))._device=void 0,n._id=void 0,n._name="",n._stages=[],n._attributes=[],n._blocks=[],n._samplers=[],n._device=e,n._id=e.genShaderId(),n}return c(t,e),r(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(Ln)));var wi,Ii=e("cE",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.TEXTURE)))._device=void 0,n._type=Cn.TEX2D,n._usage=Tn.NONE,n._format=an.UNKNOWN,n._width=0,n._height=0,n._depth=1,n._layerCount=1,n._levelCount=1,n._samples=En.X1,n._flags=An.NONE,n._isPowerOf2=!1,n._size=0,n._buffer=null,n._device=e,n}return c(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),t}(Ln)),Ri=e("bj",wn.UNIFORM_BUFFER|wn.DYNAMIC_UNIFORM_BUFFER|wn.STORAGE_BUFFER|wn.DYNAMIC_STORAGE_BUFFER),Oi=e("bk",wn.SAMPLER);e("bl",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.DESCRIPTOR_SET)))._device=void 0,n._layout=null,n._buffers=[],n._textures=[],n._samplers=[],n._isDirty=!1,n._device=e,n}return c(t,e),r(t,[{key:"layout",get:function(){return this._layout}}]),r(t,[{key:"bindBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindings[e],r=this._layout.descriptorIndices[e];i&&i.descriptorType&Ri?this._buffers[r+n]!==t&&(this._buffers[r+n]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.UNIFORM_BUFFER.")}},{key:"bindSampler",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindings[e],r=this._layout.descriptorIndices[e];i&&i.descriptorType&Oi?this._samplers[r+n]!==t&&(this._samplers[r+n]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}},{key:"bindTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=this._layout.bindings[e],r=this._layout.descriptorIndices[e];i&&i.descriptorType&Oi?this._textures[r+n]!==t&&(this._textures[r+n]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}},{key:"getBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._buffers[n+t]}},{key:"getSampler",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._samplers[n+t]}},{key:"getTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._layout.descriptorIndices[e];return this._textures[n+t]}}]),t}(Ln)),e("cj",wn.DYNAMIC_STORAGE_BUFFER|wn.DYNAMIC_UNIFORM_BUFFER),e("ck",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,Qt.DESCRIPTOR_SET_LAYOUT)))._device=void 0,n._bindings=[],n._descriptorIndices=[],n._device=e,n}return c(t,e),r(t,[{key:"bindings",get:function(){return this._bindings}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(Ln));a.GFXDevice=ci,a.GFXBuffer=oi,a.GFXTexture=Ii,a.GFXSampler=Ai,a.GFXShader=bi,a.GFXInputAssembler=hi,a.GFXRenderPass=Ti,a.GFXFramebuffer=li,a.GFXPipelineState=yi,a.GFXCommandBuffer=ai,a.GFXQueue=xi,Object.assign(a,ri),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(wi||(wi=e("dH",{})));var Pi,Ni,Di,zi,Mi,Li,Fi=new s,ki=new s,Ui=new s,Bi=new s,Gi=(Pi=new s(0,0,0),function(e,t){var n=s.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;s.multiplyScalar(Pi,t.n,t.d);var i=s.dot(s.subtract(Pi,Pi,e.o),t.n)/n;return i<0?0:i}),ji=(Ni=new s(0,0,0),Di=new s(0,0,0),zi=new s(0,0,0),Mi=new s(0,0,0),Li=new s(0,0,0),function(e,t,n){s.subtract(Ni,t.b,t.a),s.subtract(Di,t.c,t.a),s.cross(zi,e.d,Di);var i=s.dot(Ni,zi);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;s.subtract(Mi,e.o,t.a);var o=s.dot(Mi,zi)*r;if(o<0||o>1)return 0;s.cross(Li,Mi,Ni);var a=s.dot(e.d,Li)*r;if(a<0||o+a>1)return 0;var c=s.dot(Di,Li)*r;return c<0?0:c}),Vi=function(){var e=new s(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,c=i*i;s.subtract(e,r,o);var l=e.lengthSqr(),u=s.dot(e,a),_=c-(l-u*u);if(_<0)return 0;var f=Math.sqrt(_),h=l<c?u+f:u-f;return h<0?0:h}}(),Hi=function(){var e=new s,t=new s;return function(n,i){return s.subtract(e,i.center,i.halfExtents),s.add(t,i.center,i.halfExtents),qi(n,e,t)}}();function qi(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,_=(n.y-i.y)*a,f=(t.z-i.z)*s,h=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,_)),Math.min(f,h)),v=Math.min(Math.min(Math.max(c,l),Math.max(u,_)),Math.max(f,h));return v<0||d>v?0:d>0?d:v}var Wi,Xi,Yi=function(){var e=new s,t=new s,n=new s,i=new s,r=new s,o=new s,a=new s,c=new Array(3),l=new Array(3),u=new Array(3),_=new Array(6);return function(f,h){c[0]=h.halfExtents.x,c[1]=h.halfExtents.y,c[2]=h.halfExtents.z,e=h.center,t=f.o,n=f.d,s.set(i,h.orientation.m00,h.orientation.m01,h.orientation.m02),s.set(r,h.orientation.m03,h.orientation.m04,h.orientation.m05),s.set(o,h.orientation.m06,h.orientation.m07,h.orientation.m08),s.subtract(a,e,t),l[0]=s.dot(i,n),l[1]=s.dot(r,n),l[2]=s.dot(o,n),u[0]=s.dot(i,a),u[1]=s.dot(r,a),u[2]=s.dot(o,a);for(var d=0;d<3;++d){if(0===l[d]){if(-u[d]-c[d]>0||-u[d]+c[d]<0)return 0;l[d]=1e-7}_[2*d+0]=(u[d]+c[d])/l[d],_[2*d+1]=(u[d]-c[d])/l[d]}var v=Math.max(Math.max(Math.min(_[0],_[1]),Math.min(_[2],_[3])),Math.min(_[4],_[5])),m=Math.min(Math.min(Math.max(_[0],_[1]),Math.max(_[2],_[3])),Math.max(_[4],_[5]));return m<0||v>m?0:v>0?v:m}}(),Ki=function(){var e=new s,t=new s,n=new s,i=new s,r=new s,o=new s,a=new s,c=new Jt;return function(l,u){var _=u.radius*u.radius,f=s.normalize(e,l.d),h=u.ellipseCenter0,d=u.ellipseCenter1,v=s.subtract(t,d,h);if(v.equals(s.ZERO))return c.radius=u.radius,c.center.set(u.ellipseCenter0),Dr.ray_sphere(l,c);var m=l.o,p=s.subtract(n,m,h),g=s.cross(i,f,v),y=g.lengthSqr();if(0===y){c.radius=u.radius;var x=s.subtract(r,d,m);return p.lengthSqr()<x.lengthSqr()?c.center.set(u.ellipseCenter0):c.center.set(u.ellipseCenter1),Dr.ray_sphere(l,c)}var S=s.cross(r,p,v),C=v.lengthSqr(),T=2*s.dot(g,S),E=T*T-4*y*(S.lengthSqr()-_*C);if(E<0)return 0;var A=(-T-Math.sqrt(E))/(2*y);if(A<0){c.radius=u.radius;var b=s.subtract(o,d,m);return p.lengthSqr()<b.lengthSqr()?c.center.set(u.ellipseCenter0):c.center.set(u.ellipseCenter1),Dr.ray_sphere(l,c)}var w=s.scaleAndAdd(o,l.o,f,A),I=s.subtract(a,w,h),R=s.dot(I,v)/C;return R>=0&&R<=1?A:R<0?(c.radius=u.radius,c.center.set(u.ellipseCenter0),Dr.ray_sphere(l,c)):R>1?(c.radius=u.radius,c.center.set(u.ellipseCenter1),Dr.ray_sphere(l,c)):0}}(),Qi=function(){var e=Zt.create(),t={distance:1/0,doubleSided:!1,mode:wi.ANY},n=0,i=function(e,t,i,r,o,a){e===wi.CLOSEST?(n>t||0===n)&&(n=t,a&&(0===a.length?a.push({distance:t,vertexIndex0:i/3,vertexIndex1:r/3,vertexIndex2:o/3}):(a[0].distance=t,a[0].vertexIndex0=i/3,a[0].vertexIndex1=r/3,a[0].vertexIndex2=o/3))):(n=t,a&&a.push({distance:t,vertexIndex0:i/3,vertexIndex1:r/3,vertexIndex2:o/3}))};return function(r,o,a){if(n=0,0===o.geometricInfo.positions.length)return n;var c=void 0===a?t:a;if(qi(r,o.geometricInfo.boundingBox.min,o.geometricInfo.boundingBox.max)){var l=o.primitiveMode,u=o.geometricInfo;!function(t,n,r,o,a){if(r===_n.TRIANGLE_LIST)for(var c=n.length,l=0;l<c;l+=3){var u=3*n[l],_=3*n[l+1],f=3*n[l+2];s.set(e.a,t[u],t[u+1],t[u+2]),s.set(e.b,t[_],t[_+1],t[_+2]),s.set(e.c,t[f],t[f+1],t[f+2]);var h=Dr.ray_triangle(o,e,a.doubleSided);if(!(0===h||h>a.distance)&&(i(a.mode,h,u,_,f,a.result),a.mode===wi.ANY))return h}else if(r===_n.TRIANGLE_STRIP)for(var d=n.length-2,v=0,m=0;m<d;m+=1){var p=3*n[m-v],g=3*n[m+v+1],y=3*n[m+2];s.set(e.a,t[p],t[p+1],t[p+2]),s.set(e.b,t[g],t[g+1],t[g+2]),s.set(e.c,t[y],t[y+1],t[y+2]),v=~v;var x=Dr.ray_triangle(o,e,a.doubleSided);if(!(0===x||x>a.distance)&&(i(a.mode,x,p,g,y,a.result),a.mode===wi.ANY))return x}else if(r===_n.TRIANGLE_FAN){var S=n.length-1,C=3*n[0];s.set(e.a,t[C],t[C+1],t[C+2]);for(var T=1;T<S;T+=1){var E=3*n[T],A=3*n[T+1];s.set(e.b,t[E],t[E+1],t[E+2]),s.set(e.c,t[A],t[A+1],t[A+2]);var b=Dr.ray_triangle(o,e,a.doubleSided);if(!(0===b||b>a.distance)&&(i(a.mode,b,C,E,A,a.result),a.mode===wi.ANY))return b}}}(u.positions,u.indices,l,r,c)}return n}}(),Ji=(Wi=0,Xi={distance:1/0,doubleSided:!1,mode:wi.ANY},function(e,t,n){Wi=0;var i=void 0===n?Xi:n,r=t.renderingSubMeshes.length,o=t.struct.minPosition,a=t.struct.maxPosition;if(o&&a&&!qi(e,o,a))return Wi;for(var s=0;s<r;s++){var c=t.renderingSubMeshes[s],l=Qi(e,c,i);if(l)if(i.mode===wi.CLOSEST)(0===Wi||Wi>l)&&(Wi=l,i.subIndices&&(i.subIndices[0]=s));else if(Wi=l,i.subIndices&&i.subIndices.push(s),i.mode===wi.ANY)return l}return Wi&&i.mode===wi.CLOSEST&&(i.result&&(i.result[0].distance=Wi,i.result.length=1),i.subIndices&&(i.subIndices.length=1)),Wi}),Zi=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:wi.ANY},n=new Ht,i=new f;return function(r,o,a){e=0;var c=void 0===a?t:a,l=o.worldBounds;if(l&&!Hi(r,l))return e;Ht.copy(n,r),o.node&&(f.invert(i,o.node.getWorldMatrix(i)),s.transformMat4(n.o,r.o,i),s.transformMat4Normal(n.d,r.d,i));for(var u=o.subModels,_=0;_<u.length;_++){var h=u[_].subMesh,d=Qi(n,h,c);if(d)if(c.mode===wi.CLOSEST)(0===e||e>d)&&(e=d,c.subIndices&&(c.subIndices[0]=_));else if(e=d,c.subIndices&&c.subIndices.push(_),c.mode===wi.ANY)return d}return e&&c.mode===wi.CLOSEST&&(c.result&&(c.result[0].distance=e,c.result.length=1),c.subIndices&&(c.subIndices.length=1)),e}}(),$i=function(){var e=new s(0,0,0);return function(t,n){s.subtract(e,t.e,t.s);var i=(n.d-s.dot(t.s,n.n))/s.dot(e,n.n);return i<0||i>1?0:i}}(),er=function(){var e=new s(0,0,0),t=new s(0,0,0),n=new s(0,0,0),i=new s(0,0,0),r=new s(0,0,0),o=new s(0,0,0);return function(a,c,l){s.subtract(e,c.b,c.a),s.subtract(t,c.c,c.a),s.subtract(n,a.s,a.e),s.cross(r,e,t);var u=s.dot(n,r);if(u<=0)return 0;s.subtract(i,a.s,c.a);var _=s.dot(i,r);if(_<0||_>u)return 0;s.cross(o,n,i);var f=s.dot(t,o);if(f<0||f>u)return 0;var h=-s.dot(e,o);if(h<0||f+h>u)return 0;if(l){var d=1/u,v=1-(f*=d)-(h*=d);s.set(l,c.a.x*v+c.b.x*f+c.c.x*h,c.a.y*v+c.b.y*f+c.c.y*h,c.a.z*v+c.b.z*f+c.c.z*h)}return 1}}(),tr=new Ht;function nr(e,t){tr.o.set(e.s),s.subtract(tr.d,e.e,e.s),tr.d.normalize();var n=Hi(tr,t);return n<=e.length()?n:0}function ir(e,t){tr.o.set(e.s),s.subtract(tr.d,e.e,e.s),tr.d.normalize();var n=Yi(tr,t);return n<=e.length()?n:0}function rr(e,t){tr.o.set(e.s),s.subtract(tr.d,e.e,e.s),tr.d.normalize();var n=Vi(tr,t);return n<=e.length()?n:0}var or,ar,sr,cr,lr=(or=new s,ar=new s,sr=new s,cr=new s,function(e,t){return s.subtract(or,e.center,e.halfExtents),s.add(ar,e.center,e.halfExtents),s.subtract(sr,t.center,t.halfExtents),s.add(cr,t.center,t.halfExtents),or.x<=cr.x&&ar.x>=sr.x&&or.y<=cr.y&&ar.y>=sr.y&&or.z<=cr.z&&ar.z>=sr.z});function ur(e,t,n,i,r,o){s.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),s.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),s.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),s.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),s.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),s.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),s.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),s.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function _r(e,t){for(var n=s.dot(t,e[0]),i=n,r=1;r<8;++r){var o=s.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var fr,hr,dr,vr=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new s(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new s(0,0,0),i[r]=new s(0,0,0);var o=new s,a=new s;return function(t,r){s.set(e[0],1,0,0),s.set(e[1],0,1,0),s.set(e[2],0,0,1),s.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),s.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),s.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var c=0;c<3;++c)s.cross(e[6+3*c+0],e[c],e[0]),s.cross(e[6+3*c+1],e[c],e[1]),s.cross(e[6+3*c+1],e[c],e[2]);s.subtract(o,t.center,t.halfExtents),s.add(a,t.center,t.halfExtents),function(e,t,n){s.set(n[0],e.x,t.y,t.z),s.set(n[1],e.x,t.y,e.z),s.set(n[2],e.x,e.y,t.z),s.set(n[3],e.x,e.y,e.z),s.set(n[4],t.x,t.y,t.z),s.set(n[5],t.x,t.y,e.z),s.set(n[6],t.x,e.y,t.z),s.set(n[7],t.x,e.y,e.z)}(o,a,n),ur(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var l=0;l<15;++l){var u=_r(n,e[l]),_=_r(i,e[l]);if(_[0]>u[1]||u[0]>_[1])return 0}return 1}}(),mr=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=s.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},pr=function(e,t){var n=e.center;e.getBoundary(Fi,ki),s.subtract(Ui,n,Fi);for(var i=0;i<t.planes.length;i++){var r=t.planes[i],o=s.dot(r.n,n)+r.d;if(Bi.set(d(r.n.x),d(r.n.x),d(r.n.x)),o<-s.dot(Bi,Ui))return 1}return 0},gr=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new s(0,0,0);return function(i,r){for(var o=0,a=!1,c=0;c<r.planes.length;c++){if(-1===(o=mr(i,r.planes[c])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var l=0;l<r.vertices.length;l++)s.subtract(e[l],r.vertices[l],i.center);t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].x>i.halfExtents.x?t++:e[u].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var _=0;_<r.vertices.length;_++)e[_].y>i.halfExtents.y?t++:e[_].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var f=0;f<r.vertices.length;f++)e[f].z>i.halfExtents.z?t++:e[f].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),yr=(fr=new s(0,0,0),hr=new h,function(e,t){return s.subtract(fr,t,e.center),s.transformMat3(fr,fr,h.transpose(hr,e.orientation)),n=fr,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),xr=(dr=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*dr(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*dr(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*dr(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=s.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),Sr=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===xr(e,t.planes[n]))return 0;return 1},Cr=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new s(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var c=0,l=!1,u=0;u<a.planes.length;u++){if(-1===(c=xr(r,a.planes[u])))return 0;1===c&&(l=!0)}if(!l)return 1;for(var _=0;_<a.vertices.length;_++)s.subtract(e[_],a.vertices[_],r.center);n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var d=0;d<a.vertices.length;d++)(t=o(e[d],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Tr=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new s(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new s(0,0,0),i[r]=new s(0,0,0);return function(t,r){s.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),s.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),s.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),s.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),s.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),s.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)s.cross(e[6+3*o+0],e[o],e[0]),s.cross(e[6+3*o+1],e[o],e[1]),s.cross(e[6+3*o+1],e[o],e[2]);ur(t.center,t.halfExtents,e[0],e[1],e[2],n),ur(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var c=_r(n,e[a]),l=_r(i,e[a]);if(l[0]>c[1]||c[0]>l[1])return 0}return 1}}(),Er=function(){for(var e=new Jt,t=new s,n=new s,i=new s,r=new Array(8),o=0;o<8;o++)r[o]=new s;for(var a=new Array(8),c=0;c<8;c++)a[c]=new s;return function(o,c){if(0===s.squaredDistance(c.ellipseCenter0,c.ellipseCenter1))return e.radius=c.radius,e.center.set(c.ellipseCenter0),Dr.sphere_obb(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,ur(o.center,o.halfExtents,t,n,i,r);var l=a,u=s.copy(l[0],t),_=s.copy(l[1],n),f=s.copy(l[2],i);s.subtract(l[3],c.center,o.center).normalize();var h=s.subtract(l[4],c.ellipseCenter0,c.ellipseCenter1);h.normalize(),s.cross(l[5],u,h),s.cross(l[6],_,h),s.cross(l[7],f,h);for(var d=0;d<8;++d){var v=_r(r,l[d]),m=s.dot(l[d],c.ellipseCenter0),p=s.dot(l[d],c.ellipseCenter1),g=Math.max(m,p),y=Math.min(m,p)-c.radius,x=g+c.radius;if(y>v[1]||v[0]>x)return 0}return 1}}(),Ar=function(e,t){var n=s.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},br=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ar(e,t.planes[n]))return 0;return 1},wr=function(){var e=new s(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,c=n.center,l=o.n,u=o.d,_=s.dot(l,c);if(_+a<u)return 0;if(!(_-a>u)){s.add(e,c,s.multiplyScalar(e,l,a));for(var f=0;f<6;f++)if(f!==r&&f!==r+t[r]){var h=i.planes[f];if(s.dot(h.n,e)<h.d)return 0}}}return 1}}(),Ir=function(e,t){var n=e.radius+t.radius;return s.squaredDistance(e.center,t.center)<n*n},Rr=function(){var e=new s;return function(t,n){return jt(e,t.center,n),s.squaredDistance(t.center,e)<t.radius*t.radius}}(),Or=function(){var e=new s;return function(t,n){return Vt(e,t.center,n),s.squaredDistance(t.center,e)<t.radius*t.radius}}(),Pr=function(){var e=new s,t=new s;return function(n,i){var r=n.radius+i.radius,o=r*r,a=s.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return s.squaredDistance(n.center,i.center)<o;s.subtract(e,n.center,i.ellipseCenter0),s.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var c=s.dot(e,t)/a;return c<0?s.squaredDistance(n.center,i.ellipseCenter0)<o:c>1?s.squaredDistance(n.center,i.ellipseCenter1)<o:(s.scaleAndAdd(e,i.ellipseCenter0,t,c),s.squaredDistance(n.center,e)<o)}}(),Nr=function(){var e=new s,t=new s,n=new s,i=new s,r=new s,o=new s;return function(a,c){var l,u,_,f,h=s.subtract(e,a.ellipseCenter1,a.ellipseCenter0),d=s.subtract(t,c.ellipseCenter1,c.ellipseCenter0),m=s.subtract(n,a.ellipseCenter0,c.ellipseCenter0),p=s.dot(h,h),g=s.dot(h,d),y=s.dot(d,d),x=s.dot(h,m),S=s.dot(d,m),C=p*y-g*g,T=C,E=C;C<v?(u=0,T=1,f=S,E=y):(f=p*S-g*x,(u=g*S-y*x)<0?(u=0,f=S,E=y):u>T&&(u=T,f=S+g,E=y)),f<0?(f=0,-x<0?u=0:-x>p?u=T:(u=-x,T=p)):f>E&&(f=E,-x+g<0?u=0:-x+g>p?u=T:(u=-x+g,T=p)),l=Math.abs(u)<v?0:u/T,_=Math.abs(f)<v?0:f/E;var A=i;A.set(m),A.add(s.multiplyScalar(r,h,l)),A.subtract(s.multiplyScalar(o,d,_));var b=a.radius+c.radius;return A.lengthSqr()<b*b}}(),Dr=e("dw",{ray_sphere:Vi,ray_aabb:Hi,ray_obb:Yi,ray_plane:Gi,ray_triangle:ji,ray_capsule:Ki,ray_subMesh:Qi,ray_mesh:Ji,ray_model:Zi,line_sphere:rr,line_aabb:nr,line_obb:ir,line_plane:$i,line_triangle:er,sphere_sphere:Ir,sphere_aabb:Rr,sphere_obb:Or,sphere_plane:Ar,sphere_frustum:br,sphere_frustum_accurate:wr,sphere_capsule:Pr,aabb_aabb:lr,aabb_obb:vr,aabb_plane:mr,aabb_frustum:pr,aabb_frustum_accurate:gr,obb_obb:Tr,obb_plane:xr,obb_frustum:Sr,obb_frustum_accurate:Cr,obb_point:yr,obb_capsule:Er,capsule_capsule:Nr,resolve:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}});Dr[Nt.SHAPE_RAY|Nt.SHAPE_SPHERE]=Vi,Dr[Nt.SHAPE_RAY|Nt.SHAPE_AABB]=Hi,Dr[Nt.SHAPE_RAY|Nt.SHAPE_OBB]=Yi,Dr[Nt.SHAPE_RAY|Nt.SHAPE_PLANE]=Gi,Dr[Nt.SHAPE_RAY|Nt.SHAPE_TRIANGLE]=ji,Dr[Nt.SHAPE_RAY|Nt.SHAPE_CAPSULE]=Ki,Dr[Nt.SHAPE_LINE|Nt.SHAPE_SPHERE]=rr,Dr[Nt.SHAPE_LINE|Nt.SHAPE_AABB]=nr,Dr[Nt.SHAPE_LINE|Nt.SHAPE_OBB]=ir,Dr[Nt.SHAPE_LINE|Nt.SHAPE_PLANE]=$i,Dr[Nt.SHAPE_LINE|Nt.SHAPE_TRIANGLE]=er,Dr[Nt.SHAPE_SPHERE]=Ir,Dr[Nt.SHAPE_SPHERE|Nt.SHAPE_AABB]=Rr,Dr[Nt.SHAPE_SPHERE|Nt.SHAPE_OBB]=Or,Dr[Nt.SHAPE_SPHERE|Nt.SHAPE_PLANE]=Ar,Dr[Nt.SHAPE_SPHERE|Nt.SHAPE_FRUSTUM]=br,Dr[Nt.SHAPE_SPHERE|Nt.SHAPE_FRUSTUM_ACCURATE]=wr,Dr[Nt.SHAPE_SPHERE|Nt.SHAPE_CAPSULE]=Pr,Dr[Nt.SHAPE_AABB]=lr,Dr[Nt.SHAPE_AABB|Nt.SHAPE_OBB]=vr,Dr[Nt.SHAPE_AABB|Nt.SHAPE_PLANE]=mr,Dr[Nt.SHAPE_AABB|Nt.SHAPE_FRUSTUM]=pr,Dr[Nt.SHAPE_AABB|Nt.SHAPE_FRUSTUM_ACCURATE]=gr,Dr[Nt.SHAPE_OBB]=Tr,Dr[Nt.SHAPE_OBB|Nt.SHAPE_PLANE]=xr,Dr[Nt.SHAPE_OBB|Nt.SHAPE_FRUSTUM]=Sr,Dr[Nt.SHAPE_OBB|Nt.SHAPE_FRUSTUM_ACCURATE]=Cr,Dr[Nt.SHAPE_OBB|Nt.SHAPE_CAPSULE]=Er,Dr[Nt.SHAPE_CAPSULE]=Nr;var zr=e("dx",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;o(this,e),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Nt.SHAPE_LINE,this.s=new s(t,n,i),this.e=new s(r,a,c)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return s.copy(e.s,t.s),s.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,n){return s.copy(e.s,t),s.copy(e.e,n),e}},{key:"set",value:function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e}},{key:"len",value:function(e){return s.distance(e.s,e.e)}}]),r(e,[{key:"length",value:function(){return s.distance(this.s,this.e)}}]),e}()),Mr=new s(0,0,0),Lr=new s(0,0,0),Fr=a.mat4(),kr=a.v4(),Ur=e("dy",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;o(this,e),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Nt.SHAPE_PLANE,this.n=new s(t,n,i),this.d=r}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r){return new e(t,n,i,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return s.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,n,i){return s.subtract(Mr,n,t),s.subtract(Lr,i,t),s.normalize(e.n,s.cross(e.n,Mr,Lr)),e.d=s.dot(e.n,t),e}},{key:"set",value:function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,n){return s.copy(e.n,t),e.d=s.dot(t,n),e}},{key:"normalize",value:function(e,t){var n=t.n.length();return s.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e}}]),r(e,[{key:"transform",value:function(e){f.invert(Fr,e),f.transpose(Fr,Fr),m.set(kr,this.n.x,this.n.y,this.n.z,this.d),m.transformMat4(kr,kr,Fr),s.set(this.n,kr.x,kr.y,kr.z),this.d=kr.w}}]),e}()),Br=new s,Gr=new s,jr=new s,Vr=new s,Hr=new h,qr=function(e,t,n){Hr.m00=Math.abs(n.m00),Hr.m01=Math.abs(n.m01),Hr.m02=Math.abs(n.m02),Hr.m03=Math.abs(n.m04),Hr.m04=Math.abs(n.m05),Hr.m05=Math.abs(n.m06),Hr.m06=Math.abs(n.m08),Hr.m07=Math.abs(n.m09),Hr.m08=Math.abs(n.m10),s.transformMat3(e,t,Hr)},Wr=e("dC",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;o(this,e),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Nt.SHAPE_AABB,this.center=new s(t,n,i),this.halfExtents=new s(r,a,c)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return s.copy(e.center,t.center),s.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,n){return s.add(Br,n,t),s.subtract(Gr,n,t),s.multiplyScalar(e.center,Br,.5),s.multiplyScalar(e.halfExtents,Gr,.5),e}},{key:"set",value:function(e,t,n,i,r,o,a){return s.set(e.center,t,n,i),s.set(e.halfExtents,r,o,a),e}},{key:"merge",value:function(t,n,i){return s.subtract(Br,n.center,n.halfExtents),s.subtract(Gr,i.center,i.halfExtents),s.add(jr,n.center,n.halfExtents),s.add(Vr,i.center,i.halfExtents),s.max(Vr,jr,Vr),s.min(jr,Br,Gr),e.fromPoints(t,jr,Vr)}},{key:"transform",value:function(e,t,n){return s.transformMat4(e.center,t.center,n),qr(e.halfExtents,t.halfExtents,n),e}}]),r(e,[{key:"getBoundary",value:function(e,t){s.subtract(e,this.center,this.halfExtents),s.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,n,i,r){s.transformMat4(r.center,this.center,e),qr(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}}]),e}()),Xr=new s,Yr=new s,Kr=new h,Qr=(e("dD",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,f=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,d=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,v=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,m=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,p=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,g=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;o(this,e),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Nt.SHAPE_OBB,this.center=new s(t,n,i),this.halfExtents=new s(r,a,c),this.orientation=new h(l,u,_,f,d,v,m,p,g)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,n,i,r,o,a,s,c,l,u,_,f,h,d,v){return new e(t,n,i,r,o,a,s,c,l,u,_,f,h,d,v)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return s.copy(e.center,t.center),s.copy(e.halfExtents,t.halfExtents),h.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,n){return s.multiplyScalar(e.center,s.add(Xr,t,n),.5),s.multiplyScalar(e.halfExtents,s.subtract(Yr,n,t),.5),h.identity(e.orientation),e}},{key:"set",value:function(e,t,n,i,r,o,a,c,l,u,_,f,d,v,m,p){return s.set(e.center,t,n,i),s.set(e.halfExtents,r,o,a),h.set(e.orientation,c,l,u,_,f,d,v,m,p),e}}]),r(e,[{key:"getBoundary",value:function(e,t){!function(e,t,n){Kr.m00=Math.abs(n.m00),Kr.m01=Math.abs(n.m01),Kr.m02=Math.abs(n.m02),Kr.m03=Math.abs(n.m03),Kr.m04=Math.abs(n.m04),Kr.m05=Math.abs(n.m05),Kr.m06=Math.abs(n.m06),Kr.m07=Math.abs(n.m07),Kr.m08=Math.abs(n.m08),s.transformMat3(e,t,Kr)}(Xr,this.halfExtents,this.orientation),s.subtract(e,this.center,Xr),s.add(t,this.center,Xr)}},{key:"transform",value:function(e,t,n,i,r){s.transformMat4(r.center,this.center,e),h.fromQuat(r.orientation,n),s.multiply(r.halfExtents,this.halfExtents,i)}},{key:"translateAndRotate",value:function(e,t,n){s.transformMat4(n.center,this.center,e),h.fromQuat(n.orientation,t)}},{key:"setScale",value:function(e,t){s.multiply(t.halfExtents,this.halfExtents,e)}}]),e}()),new Array(8));Qr[0]=new s(1,1,1),Qr[1]=new s(-1,1,1),Qr[2]=new s(-1,-1,1),Qr[3]=new s(1,-1,1),Qr[4]=new s(1,1,-1),Qr[5]=new s(-1,1,-1),Qr[6]=new s(-1,-1,-1),Qr[7]=new s(1,-1,-1);var Jr,Zr,$r,eo=e("dE",function(){function e(){o(this,e),this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Nt.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=Ur.create(0,0,0,0);this.vertices=new Array(8);for(var n=0;n<8;++n)this.vertices[n]=new s}return r(e,[{key:"accurate",set:function(e){this._type=e?Nt.SHAPE_FRUSTUM_ACCURATE:Nt.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t._type;for(var n=0;n<6;++n)Ur.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)s.copy(e.vertices[i],t.vertices[i]);return e}}]),r(e,[{key:"update",value:function(e,t){if(s.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),s.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),s.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),s.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),s.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),s.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===Nt.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();s.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)s.transformMat4(this.vertices[o],Qr[o],t)}}},{key:"transform",value:function(e){if(this._type===Nt.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)s.transformMat4(this.vertices[t],this.vertices[t],e);Ur.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Ur.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Ur.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Ur.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Ur.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Ur.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),e}());eo.createOrtho=(Jr=new s,function(e,t,n,i,r,o){var a=t/2,c=n/2;s.set(Jr,a,c,i),s.transformMat4(e.vertices[0],Jr,o),s.set(Jr,-a,c,i),s.transformMat4(e.vertices[1],Jr,o),s.set(Jr,-a,-c,i),s.transformMat4(e.vertices[2],Jr,o),s.set(Jr,a,-c,i),s.transformMat4(e.vertices[3],Jr,o),s.set(Jr,a,c,r),s.transformMat4(e.vertices[4],Jr,o),s.set(Jr,-a,c,r),s.transformMat4(e.vertices[5],Jr,o),s.set(Jr,-a,-c,r),s.transformMat4(e.vertices[6],Jr,o),s.set(Jr,a,-c,r),s.transformMat4(e.vertices[7],Jr,o),Ur.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Ur.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Ur.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Ur.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Ur.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Ur.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Zr||(Zr=e("dX",{}))),function(e){e[e.Default=Zr.Default]="Default",e[e.Normal=Zr.Normal]="Normal",e[e.Reverse=Zr.Reverse]="Reverse",e[e.Loop=Zr.Loop]="Loop",e[e.LoopReverse=Zr.Loop|Zr.Reverse]="LoopReverse",e[e.PingPong=Zr.PingPong]="PingPong",e[e.PingPongReverse=Zr.PingPong|Zr.Reverse]="PingPongReverse"}($r||($r=e("dV",{}))),_($r);e("dW",function(){function e(t){o(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return r(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}());var to=p({Default:Zr.Default,Normal:Zr.Normal,Clamp:Zr.Clamp,Loop:Zr.Loop,PingPong:Zr.PingPong}),no=e("dF",(function e(){o(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}));g.fastDefine("cc.Keyframe",no,{time:0,value:0,inTangent:0,outTangent:0});var io=function(){function e(){o(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return r(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var ro=e("dG",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;o(this,e),this.keyFrames=void 0,this.preWrapMode=to.Loop,this.postWrapMode=to.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new io}return r(e,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,n=e<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(n){case to.Loop:t=S(e-i,r-i)+i;break;case to.PingPong:t=x(e-i,r-i)+i;break;case to.Clamp:t=y(e,i,r)}var o=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)o=this.keyFrames.length-2;else for(var a=0;a<this.keyFrames.length-1;a++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[a+1].time){o=a;break}var s=this.keyFrames[o],c=this.keyFrames[o+1],l=C(s.time,c.time,t),u=c.time-s.time,_=s.outTangent*u,f=c.inTangent*u,h=l*l,d=h*l,v=d-2*h+l,m=d-h,p=-2*d+3*h;return(2*d-3*h+1)*s.value+v*_+m*f+p*c.value}},{key:"evaluate",value:function(e){var t=e,n=e<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(n){case to.Loop:t=S(e-i,r-i)+i;break;case to.PingPong:t=x(e-i,r-i)+i;break;case to.Clamp:t=y(e,i,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var o=this.findIndex(this.cachedKey,t),a=o+1;return a===this.keyFrames.length&&(a-=1),this.calcOptimizedKey(this.cachedKey,o,a),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,n){var i=this.keyFrames[t],r=this.keyFrames[n];e.index=t,e.time=i.time,e.endTime=r.time;var o=r.time-i.time,a=r.value-i.value,s=1/(o*o),c=i.outTangent*o,l=r.inTangent*o;e.coefficient[0]=(c+l-a-a)*s/o,e.coefficient[1]=(a+a+a-c-c-l)*s,e.coefficient[2]=i.outTangent,e.coefficient[3]=i.value}},{key:"findIndex",value:function(e,t){var n=e.index;if(-1!==n)if(t>this.keyFrames[n].time)for(var i=0;i<3;i++){var r=n+i;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var o=0;o<3;o++){var a=n-o;if(a>=0&&this.keyFrames[a-1].time<=t)return a-1}for(var s=0,c=this.keyFrames.length,l=Math.floor((s+c)/2);c-s>1;)this.keyFrames[l].time>=t?c=l:s=l+1,l=Math.floor((s+c)/2);return s}}]),e}());ro.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],g.fastDefine("cc.AnimationCurve",ro,{preWrapMode:to.Default,postWrapMode:to.Default,keyFrames:[]}),T(zr.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),E(Dr,"intersect",[{name:"line_quad"}]);e("aC",.26);var oo,ao,so,co,lo,uo,_o,fo=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,ho=/^[!,.:;'}\]%\?>、‘“》？。，！]/,vo=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,mo=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,po=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function go(e,t){var n=e.measureText(t);return n&&n.width||0}function yo(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}var xo,So=e("aH",A("cc.PrefabInfo")((so=b((ao=function e(){o(this,e),R(this,"root",so,this),R(this,"asset",co,this),R(this,"fileId",lo,this),R(this,"sync",uo,this),R(this,"_synced",_o,this)}).prototype,"root",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),co=b(ao.prototype,"asset",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lo=b(ao.prototype,"fileId",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uo=b(ao.prototype,"sync",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_o=b(ao.prototype,"_synced",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),oo=ao))||oo);a._PrefabInfo=So;var Co=(O(xo={},Gn.UNORM,"Uint"),O(xo,Gn.SNORM,"Int"),O(xo,Gn.UINT,"Uint"),O(xo,Gn.INT,"Int"),O(xo,Gn.UFLOAT,"Float"),O(xo,Gn.FLOAT,"Float"),O(xo,"default","Uint"),xo);function To(e){return(Co[e.type]||Co.default)+e.size/e.count*8}function Eo(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:an.R32F,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=Kn[n];r||(r=o.size);for(var a="set"+To(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=P.isLittleEndian,u=0;u<c;++u)for(var _=i+r*u,f=0;f<o.count;++f){var h=_+s*f;e[a](h,t[o.count*u+f],l)}}function Ao(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:an.R32F,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.byteLength-n,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],a=Kn[t];r||(r=a.size);for(var s="get"+To(a),c=a.size/a.count,l=Math.floor(i/r),u=P.isLittleEndian,_=0;_<l;++_)for(var f=n+r*_,h=0;h<a.count;++h){var d=f+c*h;o[a.count*_+h]=e[s](d,u)}return o}function bo(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:an.R32F,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-i,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6?arguments[6]:void 0;a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=Kn[n];o||(o=s.size);for(var c="set"+To(s),l="get"+To(s),u=s.size/s.count,_=Math.floor(r/o),f=P.isLittleEndian,h=0;h<_;++h)for(var d=i+o*h,v=0;v<s.count;++v){var m=d+u*v,p=e[l](m,f);a[c](m,t(p,v,e),f)}return a}var wo=function(){function e(){o(this,e),this._arrayBufferOrPaddings=[],this._length=0}return r(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer}}]),e}();var Io,Ro,Oo,Po,No,Do,zo,Mo=1024;!function(e){e[e.RGB565=an.R5G6B5]="RGB565",e[e.RGB5A1=an.RGB5A1]="RGB5A1",e[e.RGBA4444=an.RGBA4]="RGBA4444",e[e.RGB888=an.RGB8]="RGB888",e[e.RGB32F=an.RGB32F]="RGB32F",e[e.RGBA8888=an.RGBA8]="RGBA8888",e[e.RGBA32F=an.RGBA32F]="RGBA32F",e[e.A8=an.A8]="A8",e[e.I8=an.L8]="I8",e[e.AI8=an.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=an.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=an.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Mo++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=an.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=an.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Mo++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=an.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Mo++]="RGBA_ETC1",e[e.RGB_ETC2=an.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=an.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=an.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=an.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=an.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=an.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=an.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=an.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=an.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=an.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=an.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=an.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=an.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=an.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=an.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=an.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(Io||(Io=e("dg",{}))),function(e){e[e.REPEAT=Sn.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=Sn.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=Sn.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=Sn.BORDER]="CLAMP_TO_BORDER"}(Ro||(Ro=e("d_",{}))),function(e){e[e.NONE=xn.NONE]="NONE",e[e.LINEAR=xn.LINEAR]="LINEAR",e[e.NEAREST=xn.POINT]="NEAREST"}(Oo||(Oo=e("dR",{})));var Lo,Fo=e("aX",A("cc.ImageAsset")((zo=Do=function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this)))._nativeData=void 0,n._tex=void 0,n._url=void 0,n._exportedExts=void 0,n._format=Io.RGBA8888,n._width=0,n._height=0,n._url="",n.loaded=!1,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}return c(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return(e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement?this._nativeData:this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Io.RGB_ETC1&&this._format<=Io.RGBA_ASTC_12x12||this._format>=Io.RGB_A_PVRTC_2BPPV1&&this._format<=Io.RGBA_ETC1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new a.Texture2D;e.name=this._url,e.image=this,this._tex=e}return this._tex}}]),r(t,[{key:"reset",value:function(e){var t=this;e instanceof HTMLElement?(this._nativeData=e,e.complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",(function(){t._onDataComplete()})),e.addEventListener("error",(function(e){N(3119,e.message)})))):(this._nativeData=e,this._format=e.format,this._onDataComplete())}},{key:"destroy",value:function(){return this.data&&this.data instanceof HTMLImageElement&&(this.data.src="",this._setRawAsset(""),a.loader.removeItem(this.data.id)),D(u(t.prototype),"destroy",this).call(this)}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";for(var n,i=[],r=z(e);!(n=r()).done;){var o=n.value,a=o.split("@"),s=t.extnames.indexOf(a[0]),c=s<0?o:"".concat(s);a[1]&&(c+="@"+a[1]),i.push(c)}return{fmt:i.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,n){var i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);for(var r,o=a.director.root?a.director.root.device:null,s=i.split("_"),c=Number.MAX_VALUE,l=this._format,u="",_=a.macro.SUPPORT_TEXTURE_FORMATS,f=z(s);!(r=f()).done;){var h=r.value.split("@"),d=parseInt(h[0],void 0),v=t.extnames[d]||h.join(),m=_.indexOf(v);if(-1!==m&&m<c){var p=h[1]?parseInt(h[1]):this._format;if(!(".astc"!==v||o&&o.hasFeature(ni.FORMAT_ASTC)))continue;if(!(".pvr"!==v||o&&o.hasFeature(ni.FORMAT_PVRTC)))continue;if(!(p!==Io.RGB_ETC1&&p!==Io.RGBA_ETC1||o&&o.hasFeature(ni.FORMAT_ETC1)))continue;if(!(p!==Io.RGB_ETC2&&p!==Io.RGBA_ETC2||o&&o.hasFeature(ni.FORMAT_ETC2)))continue;if(".webp"===v&&!a.sys.capabilities.webp)continue;c=m,u=v,l=p}}u&&(this._setRawAsset(u),this._format=l);var g=n.customEnv,y=g&&g.uuid;y&&(this._uuid=y,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),t}(M),Do.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],b((No=zo).prototype,"_nativeAsset",[mt],Object.getOwnPropertyDescriptor(No.prototype,"_nativeAsset"),No.prototype),Po=No))||Po);a.ImageAsset=Fo,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(Lo||(Lo=e("ak",{})));var ko=[xn.LINEAR,xn.LINEAR,xn.NONE,Sn.WRAP,Sn.WRAP,Sn.WRAP,8,vn.NEVER,0,0,0],Uo=e("al",jo(ko)),Bo={r:0,g:0,b:0,a:0},Go={};function jo(e){for(var t=0,n=0,i=0;i<ko.length;i++)switch(t=e[i]||ko[i],i){case Lo.minFilter:n|=t;break;case Lo.magFilter:n|=t<<2;break;case Lo.mipFilter:n|=t<<4;break;case Lo.addressU:n|=t<<6;break;case Lo.addressV:n|=t<<8;break;case Lo.addressW:n|=t<<10;break;case Lo.maxAnisotropy:n|=t<<12;break;case Lo.cmpFunc:n|=t<<16;break;case Lo.minLOD:n|=t<<20;break;case Lo.maxLOD:n|=t<<24;break;case Lo.mipLODBias:n|=t<<28}return n}var Vo,Ho,qo,Wo,Xo,Yo,Ko,Qo,Jo,Zo,$o,ea,ta=e("an",new(function(){function e(){o(this,e),this._cache={}}return r(e,[{key:"getSampler",value:function(e,t){t||(t=Uo);var n=this._cache[t];return n||(Go.minFilter=3&t,Go.magFilter=t>>2&3,Go.mipFilter=t>>4&3,Go.addressU=t>>6&3,Go.addressV=t>>8&3,Go.addressW=t>>10&3,Go.maxAnisotropy=t>>12&15,Go.cmpFunc=t>>16&15,Go.minLOD=t>>20&15,Go.maxLOD=t>>24&15,Go.mipLODBias=t>>28&15,Go.borderColor=Bo,this._cache[t]=e.createSampler(Go))}}]),e}()));a.samplerLib=ta;var na=new L("Tex"),ia=e("df",A("cc.TextureBase")((ea=$o=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"_format",qo,F(e)),R(e,"_minFilter",Wo,F(e)),R(e,"_magFilter",Xo,F(e)),R(e,"_mipFilter",Yo,F(e)),R(e,"_wrapS",Ko,F(e)),R(e,"_wrapT",Qo,F(e)),R(e,"_wrapR",Jo,F(e)),R(e,"_anisotropy",Zo,F(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._gfxSampler=null,e._gfxDevice=null,e._id=na.getNewId(),e.loaded=!1,e._gfxDevice=e._getGFXDevice(),e}return c(t,e),r(t,[{key:"isCompressed",get:function(){return this._format>=Io.RGB_ETC1&&this._format<=Io.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),r(t,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,n){this._wrapS=e,this._samplerInfo[Lo.addressU]=e,this._wrapT=t,this._samplerInfo[Lo.addressV]=t,void 0!==n&&(this._wrapR=n,this._samplerInfo[Lo.addressW]=n),this._samplerHash=jo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ta.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Lo.minFilter]=e,this._magFilter=t,this._samplerInfo[Lo.magFilter]=t,this._samplerHash=jo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ta.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Lo.mipFilter]=e,this._samplerInfo[Lo.maxLOD]=e===Oo.NONE?0:15,this._samplerHash=jo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ta.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Lo.maxAnisotropy]=e,this._samplerHash=jo(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=ta.getSampler(this._gfxDevice,this._samplerHash))}},{key:"destroy",value:function(){return D(u(t.prototype),"destroy",this).call(this)}},{key:"getGFXTexture",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"getGFXSampler",value:function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=ta.getSampler(this._gfxDevice,this._samplerHash):k(9302)),this._gfxSampler}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+this._mipFilter+","+this._anisotropy}},{key:"_deserialize",value:function(e,t){var n=e.split(",");n.unshift(""),n.length>=5&&(this.setFilters(parseInt(n[1]),parseInt(n[2])),this.setWrapMode(parseInt(n[3]),parseInt(n[4]))),n.length>=7&&(this.setMipFilter(parseInt(n[5])),this.setAnisotropy(parseInt(n[6])))}},{key:"_getGFXDevice",value:function(){return a.director.root&&a.director.root.device}},{key:"_getGFXFormat",value:function(){return this._getGFXPixelFormat(this._format)}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?Io.RGBA8888:e}},{key:"_getGFXPixelFormat",value:function(e){return e===Io.RGBA_ETC1?e=Io.RGB_ETC1:e===Io.RGB_A_PVRTC_4BPPV1?e=Io.RGB_PVRTC_4BPPV1:e===Io.RGB_A_PVRTC_2BPPV1&&(e=Io.RGB_PVRTC_2BPPV1),e}}]),t}(M),$o.PixelFormat=Io,$o.WrapMode=Ro,$o.Filter=Oo,qo=b((Ho=ea).prototype,"_format",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Io.RGBA8888}}),Wo=b(Ho.prototype,"_minFilter",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.LINEAR}}),Xo=b(Ho.prototype,"_magFilter",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.LINEAR}}),Yo=b(Ho.prototype,"_mipFilter",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oo.NONE}}),Ko=b(Ho.prototype,"_wrapS",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ro.REPEAT}}),Qo=b(Ho.prototype,"_wrapT",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ro.REPEAT}}),Jo=b(Ho.prototype,"_wrapR",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ro.REPEAT}}),Zo=b(Ho.prototype,"_anisotropy",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),Vo=Ho))||Vo);a.TextureBase=ia;var ra,oa=e("b8",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0});a.macro=oa;var aa=[{buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}}];function sa(e){return e&&0==(e&e-1)}var ca,la,ua,_a,fa,ha=A("cc.SimpleTexture")(ra=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._gfxTexture=null,n._mipmapLevel=1,n}return c(t,e),r(t,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"destroy",value:function(){return this._tryDestroyTexture(),D(u(t.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._gfxTexture.levelCount<=t)){var i=this._getGFXDevice();if(i){var r=aa[0];r.texExtent.width=this._gfxTexture.width>>t,r.texExtent.height=this._gfxTexture.height>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,aa):i.copyTexImagesToTexture([e],this._gfxTexture,aa)}}}},{key:"_assignImage",value:function(e,t,n){var i=this,r=function(){var r=e.data;r&&(i.uploadData(r,t,n),i._checkTextureLoaded(),oa.CLEANUP_IMAGE_CACHE&&a.loader.release(e))};if(e.loaded)r();else{if(e.once("load",(function(){r()})),!this.isCompressed){var o=a.builtinResMgr.get("black-texture").image;this.uploadData(o.data,t,n)}a.textureUtil.postLoadImage(e)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}}},{key:"_createTexture",value:function(e){var t=An.NONE;this._mipFilter!==Oo.NONE&&function(e,t,n){return!(e.gfxAPI===ti.WEBGL)||sa(t)&&sa(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=An.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Tn.SAMPLED|Tn.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._gfxTexture=i}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(ia))||ra;a.SimpleTexture=ha;var da=e("aY",(ca=A("cc.Texture2D"),la=U([Fo]),ca((fa=b((_a=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_mipmaps",fa,F(n)),n}return c(t,e),r(t,[{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Io.RGBA8888,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:n,mipmapLevel:i})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],D(u(t.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(e){return{base:D(u(t.prototype),"_serialize",this).call(this,e),mipmaps:this._mipmaps.map((function(t){return t&&t._uuid?e?EditorExtends.UuidUtils.compressUuid(t._uuid,!0):t._uuid:null}))}}},{key:"_deserialize",value:function(e,n){var i=e;D(u(t.prototype),"_deserialize",this).call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Fo,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,"".concat(r),o),this._mipmaps[r]._texture=this}}},{key:"_getGfxTextureCreateInfo",value:function(e){return Object.assign({type:Cn.TEX2D,width:this._width,height:this._height},e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,n=0;n<this._mipmaps.length;++n){if(!this._mipmaps[n].loaded){e=!1;break}}e&&D(u(t.prototype),"_textureReady",this).call(this)}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(ha)).prototype,"_mipmaps",[la],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ua=_a))||ua));a.Texture2D=da;var va={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},ma=e("cZ",function(){function e(){o(this,e)}return r(e,null,[{key:"makeMaskInclude",value:function(e){for(var t,n=0,i=z(e);!(t=i()).done;){n|=t.value}return n}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,n){void 0!==n?n>19||n<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<n,e.Enum[n]=t,e.BitMask[t]=1<<n,e.BitMask[n]=t):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])}}]),e}());ma.Enum=p(va),ma.BitMask=B(Object.assign({},va)),a.Layers=ma;var pa,ga;!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(pa||(pa={})),a.RenderPassStage=pa,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(ga||(ga=e("dl",{})));var ya,xa={bindings:[],record:{}},Sa={bindings:[],record:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_SHADOW=1]="UBO_SHADOW",e[e.SAMPLER_ENVIRONMENT=2]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.COUNT=4]="COUNT"}(ya||(ya={}));var Ca,Ta=ya.SAMPLER_ENVIRONMENT,Ea=ya.COUNT-Ta;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTING_MAP=9]="SAMPLER_LIGHTING_MAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.COUNT=11]="COUNT"}(Ca||(Ca=e("dr",{})));var Aa,ba=Ca.SAMPLER_JOINTS,wa=Ca.COUNT-ba,Ia=function(e){return e!==Aa.MATERIAL};!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Aa||(Aa=e("dn",{})));var Ra=new si;Ra.bufferOffsets=[0,Ta+ba,Ta],Ra.samplerOffsets=[0,Ea+wa,Ea];var Oa=function e(){o(this,e)};Oa.SIZE=4*(Oa.COUNT=(Oa.GLOBAL_FOG_ADD_OFFSET=(Oa.GLOBAL_FOG_BASE_OFFSET=(Oa.GLOBAL_FOG_COLOR_OFFSET=(Oa.AMBIENT_GROUND_OFFSET=(Oa.AMBIENT_SKY_OFFSET=(Oa.MAIN_LIT_COLOR_OFFSET=(Oa.MAIN_LIT_DIR_OFFSET=(Oa.EXPOSURE_OFFSET=(Oa.CAMERA_POS_OFFSET=(Oa.MAT_VIEW_PROJ_INV_OFFSET=(Oa.MAT_VIEW_PROJ_OFFSET=(Oa.MAT_PROJ_INV_OFFSET=(Oa.MAT_PROJ_OFFSET=(Oa.MAT_VIEW_INV_OFFSET=(Oa.MAT_VIEW_OFFSET=(Oa.NATIVE_SIZE_OFFSET=(Oa.SCREEN_SCALE_OFFSET=(Oa.SCREEN_SIZE_OFFSET=(Oa.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4)+4)+4)+4),Oa.BLOCK={stageFlags:bn.ALL,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.GLOBAL,binding:ya.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:on.FLOAT4,count:1},{name:"cc_screenSize",type:on.FLOAT4,count:1},{name:"cc_screenScale",type:on.FLOAT4,count:1},{name:"cc_nativeSize",type:on.FLOAT4,count:1},{name:"cc_matView",type:on.MAT4,count:1},{name:"cc_matViewInv",type:on.MAT4,count:1},{name:"cc_matProj",type:on.MAT4,count:1},{name:"cc_matProjInv",type:on.MAT4,count:1},{name:"cc_matViewProj",type:on.MAT4,count:1},{name:"cc_matViewProjInv",type:on.MAT4,count:1},{name:"cc_cameraPos",type:on.FLOAT4,count:1},{name:"cc_exposure",type:on.FLOAT4,count:1},{name:"cc_mainLitDir",type:on.FLOAT4,count:1},{name:"cc_mainLitColor",type:on.FLOAT4,count:1},{name:"cc_ambientSky",type:on.FLOAT4,count:1},{name:"cc_ambientGround",type:on.FLOAT4,count:1},{name:"cc_fogColor",type:on.FLOAT4,count:1},{name:"cc_fogBase",type:on.FLOAT4,count:1},{name:"cc_fogAdd",type:on.FLOAT4,count:1}]},xa.record[Oa.BLOCK.name]=Oa.BLOCK,xa.bindings[Oa.BLOCK.binding]=Oa.BLOCK;var Pa=function e(){o(this,e)};Pa.SIZE=4*(Pa.COUNT=(Pa.SHADOW_SIZE_OFFSET=(Pa.SHADOW_PCF_OFFSET=(Pa.SHADOW_COLOR_OFFSET=(Pa.MAT_LIGHT_VIEW_PROJ_OFFSET=(Pa.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+16)+4)+4)+4),Pa.BLOCK={stageFlags:bn.ALL,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.GLOBAL,binding:ya.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:on.MAT4,count:1},{name:"cc_matLightViewProj",type:on.MAT4,count:1},{name:"cc_shadowColor",type:on.FLOAT4,count:1},{name:"cc_shadowPCF",type:on.FLOAT4,count:1},{name:"cc_shadowSize",type:on.FLOAT4,count:1}]},xa.record[Pa.BLOCK.name]=Pa.BLOCK,xa.bindings[Pa.BLOCK.binding]=Pa.BLOCK;var Na={stageFlags:bn.FRAGMENT,descriptorType:wn.SAMPLER,count:1,set:Aa.GLOBAL,binding:ya.SAMPLER_SHADOWMAP,name:"cc_shadowMap",type:on.SAMPLER2D};xa.record[Na.name]=Na,xa.bindings[Na.binding]=Na;var Da={stageFlags:bn.FRAGMENT,descriptorType:wn.SAMPLER,count:1,set:Aa.GLOBAL,binding:ya.SAMPLER_ENVIRONMENT,name:"cc_environment",type:on.SAMPLER_CUBE};xa.record[Da.name]=Da,xa.bindings[Da.binding]=Da;var za=function e(){o(this,e)};za.SIZE=4*(za.COUNT=(za.LIGHTINGMAP_UVPARAM=(za.MAT_WORLD_IT_OFFSET=(za.MAT_WORLD_OFFSET=0)+16)+16)+4),za.BLOCK={stageFlags:bn.VERTEX,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:on.MAT4,count:1},{name:"cc_matWorldIT",type:on.MAT4,count:1},{name:"cc_lightingMapUVParam",type:on.FLOAT4,count:1}]},Sa.record[za.BLOCK.name]=za.BLOCK,Sa.bindings[za.BLOCK.binding]=za.BLOCK;var Ma=function e(){o(this,e)};Ma.BATCHING_COUNT=10,Ma.MAT_WORLDS_OFFSET=0,Ma.SIZE=4*(Ma.COUNT=16*Ma.BATCHING_COUNT),Ma.BLOCK={stageFlags:bn.VERTEX,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_LOCAL,name:"CCLocalBatched",members:[{name:"cc_matWorlds",type:on.MAT4,count:Ma.BATCHING_COUNT}]},Sa.record[Ma.BLOCK.name]=Ma.BLOCK,Sa.bindings[Ma.BLOCK.binding]=Ma.BLOCK;var La=function e(){o(this,e)};La.LIGHTS_PER_PASS=1,La.SIZE=4*(La.COUNT=(La.LIGHT_DIR_OFFSET=(La.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(La.LIGHT_COLOR_OFFSET=(La.LIGHT_POS_OFFSET=0)+4*La.LIGHTS_PER_PASS)+4*La.LIGHTS_PER_PASS)+4*La.LIGHTS_PER_PASS)+4*La.LIGHTS_PER_PASS),La.BLOCK={stageFlags:bn.FRAGMENT,descriptorType:wn.DYNAMIC_UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_lightPos",type:on.FLOAT4,count:La.LIGHTS_PER_PASS},{name:"cc_lightColor",type:on.FLOAT4,count:La.LIGHTS_PER_PASS},{name:"cc_lightSizeRangeAngle",type:on.FLOAT4,count:La.LIGHTS_PER_PASS},{name:"cc_lightDir",type:on.FLOAT4,count:La.LIGHTS_PER_PASS}]},Sa.record[La.BLOCK.name]=La.BLOCK,Sa.bindings[La.BLOCK.binding]=La.BLOCK;var Fa=e("dI",(function e(){o(this,e)}));Fa.JOINTS_TEXTURE_INFO_OFFSET=0,Fa.COUNT=Fa.JOINTS_TEXTURE_INFO_OFFSET+4,Fa.SIZE=4*Fa.COUNT,Fa.BLOCK={stageFlags:bn.VERTEX,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointTextureInfo",type:on.FLOAT4,count:1}]},Sa.record[Fa.BLOCK.name]=Fa.BLOCK,Sa.bindings[Fa.BLOCK.binding]=Fa.BLOCK;var ka=e("dK",(function e(){o(this,e)}));ka.JOINTS_ANIM_INFO_OFFSET=0,ka.COUNT=ka.JOINTS_ANIM_INFO_OFFSET+4,ka.SIZE=4*ka.COUNT,ka.BLOCK={stageFlags:bn.VERTEX,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_SKINNING_ANIMATION,name:"CCSkinningAnimation",members:[{name:"cc_jointAnimInfo",type:on.FLOAT4,count:1}]},Sa.record[ka.BLOCK.name]=ka.BLOCK,Sa.bindings[ka.BLOCK.binding]=ka.BLOCK;var Ua=e("dL","a_jointAnimInfo"),Ba=function e(){o(this,e)};Ba.SIZE=4*(Ba.COUNT=(Ba.JOINTS_OFFSET=0)+360),Ba.BLOCK={stageFlags:bn.VERTEX,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_SKINNING_TEXTURE,name:"CCSkinning",members:[{name:"cc_joints",type:on.FLOAT4,count:90}]},Sa.record[Ba.BLOCK.name]=Ba.BLOCK,Sa.bindings[Ba.BLOCK.binding]=Ba.BLOCK;var Ga=function e(){o(this,e)};Ga.MAX_MORPH_TARGET_COUNT=60,Ga.OFFSET_OF_WEIGHTS=0,Ga.OFFSET_OF_VERTICES_COUNT=(Ga.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=(Ga.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Ga.MAX_MORPH_TARGET_COUNT)+4)+4,Ga.COUNT_BASE_4_BYTES=4*Math.ceil(Ga.MAX_MORPH_TARGET_COUNT/4)+4,Ga.SIZE=4*Ga.COUNT_BASE_4_BYTES,Ga.BLOCK={stageFlags:bn.VERTEX,descriptorType:wn.UNIFORM_BUFFER,count:1,set:Aa.LOCAL,binding:Ca.UBO_MORPH,name:"CCMorph",members:[{name:"cc_displacementWeights",type:on.FLOAT4,count:Ga.MAX_MORPH_TARGET_COUNT/4},{name:"cc_displacementTextureInfo",type:on.FLOAT4,count:1}]},Sa.record[Ga.BLOCK.name]=Ga.BLOCK,Sa.bindings[Ga.BLOCK.binding]=Ga.BLOCK;var ja=e("dJ",{stageFlags:bn.VERTEX,descriptorType:wn.SAMPLER,count:1,set:Aa.LOCAL,binding:Ca.SAMPLER_JOINTS,name:"cc_jointTexture",type:on.SAMPLER2D});Sa.record[ja.name]=ja,Sa.bindings[ja.binding]=ja;var Va={stageFlags:bn.VERTEX,descriptorType:wn.SAMPLER,count:1,set:Aa.LOCAL,binding:Ca.SAMPLER_MORPH_POSITION,name:"cc_PositionDisplacements",type:on.SAMPLER2D};Sa.record[Va.name]=Va,Sa.bindings[Va.binding]=Va;var Ha={stageFlags:bn.VERTEX,descriptorType:wn.SAMPLER,count:1,set:Aa.LOCAL,binding:Ca.SAMPLER_MORPH_NORMAL,name:"cc_NormalDisplacements",type:on.SAMPLER2D};Sa.record[Ha.name]=Ha,Sa.bindings[Ha.binding]=Ha;var qa={stageFlags:bn.VERTEX,descriptorType:wn.SAMPLER,count:1,set:Aa.LOCAL,binding:Ca.SAMPLER_MORPH_TANGENT,name:"cc_TangentDisplacements",type:on.SAMPLER2D};Sa.record[qa.name]=qa,Sa.bindings[qa.binding]=qa;var Wa={stageFlags:bn.FRAGMENT,descriptorType:wn.SAMPLER,count:1,set:Aa.LOCAL,binding:Ca.SAMPLER_LIGHTING_MAP,name:"cc_lightingMap",type:on.SAMPLER2D};Sa.record[Wa.name]=Wa,Sa.bindings[Wa.binding]=Wa;var Xa={stageFlags:bn.FRAGMENT,descriptorType:wn.SAMPLER,count:1,set:Aa.LOCAL,binding:Ca.SAMPLER_SPRITE,name:"cc_spriteTexture",type:on.SAMPLER2D};Sa.record[Xa.name]=Xa,Sa.bindings[Xa.binding]=Xa;var Ya=e("dT",ma.makeMaskExclude([ma.BitMask.UI_2D,ma.BitMask.GIZMOS,ma.BitMask.EDITOR,ma.BitMask.SCENE_GIZMO,ma.BitMask.PROFILER])),Ka=ma.makeMaskExclude([ma.BitMask.UI_2D,ma.BitMask.PROFILER]),Qa=ma.Enum.ALL;e("au",Object.freeze({__proto__:null,PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_SHADOW:"ShadowFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return pa},get RenderPriority(){return ga},globalDescriptorSetLayout:xa,localDescriptorSetLayout:Sa,get PipelineGlobalBindings(){return ya},get ModelLocalBindings(){return Ca},isBuiltinBinding:Ia,get SetIndex(){return Aa},bindingMappingInfo:Ra,UBOGlobal:Oa,UBOShadow:Pa,UNIFORM_SHADOWMAP:Na,UNIFORM_ENVIRONMENT:Da,UBOLocal:za,INST_MAT_WORLD:"a_matWorld0",UBOLocalBatched:Ma,UBOForwardLight:La,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Fa,UBOSkinningAnimation:ka,INST_JOINT_ANIM_INFO:Ua,UBOSkinning:Ba,UBOMorph:Ga,UniformJointTexture:ja,UniformPositionMorphTexture:Va,UniformNormalMorphTexture:Ha,UniformTangentMorphTexture:qa,UniformLightingMapSampler:Wa,UniformSpriteSampler:Xa,CAMERA_DEFAULT_MASK:Ya,CAMERA_EDITOR_MASK:Ka,MODEL_ALWAYS_MASK:Qa}));var Ja,Za,$a,es,ts,ns=function(){function e(t,n){if(o(this,e),this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var r=0;r<i;++r){var a=this._mesh.struct.morph.subMeshMorphs[r];a&&(a.targets.length>Ga.MAX_MORPH_TARGET_COUNT?N(10002,Ga.MAX_MORPH_TARGET_COUNT,a.targets.length):this._subMeshRenderings[r]=new is(this._mesh,r,this._mesh.struct.morph,n))}}}return r(e,[{key:"createInstance",value:function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){G(e._mesh.struct.morph);var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null!==r){var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(rn.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(rn.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(rn.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,j(r.requiredPatches())),o}},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=z(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}}}]),e}(),is=function(){function e(t,n,i,r){o(this,e),this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=r;var a=i.subMeshMorphs[n];this._subMeshMorph=a,function(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}(t,n,r);var s=t.struct.vertexBundles[t.struct.primitives[n].vertexBundelIndices[0]].view.count;this._verticesCount=s;var c=a.targets.length,l=function(e,t){var n,i,r,o;e.hasFeature(ni.TEXTURE_FLOAT)?(n=t,r=16,i=da.PixelFormat.RGBA32F,o=Float32Array):(n=4*t,r=4,i=da.PixelFormat.RGBA8888,o=Uint8Array);var a=function(e){e<5&&(e=5);var t=q(e),n=W(t),i=n>>1;return{width:1<<(1&n?i+1:i),height:1<<i}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var t=new ArrayBuffer(s*c*r),n=new Float32Array(t),a=o===Float32Array?n:new o(t),l=new Fo({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new da;u.setFilters(da.Filter.NEAREST,da.Filter.NEAREST),u.setMipFilter(da.Filter.NONE),u.setWrapMode(da.WrapMode.CLAMP_TO_EDGE,da.WrapMode.CLAMP_TO_EDGE,da.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||V("Unexpected: failed to create morph texture?");var _=ta.getSampler(e,u.getSamplerHash());return{get texture(){return u.getGFXTexture()},get sampler(){return _},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}(r,s*c);this._textureInfo={width:l.width,height:l.height},this._attributes=a.attributes.map((function(e,n){var i=l.create(),r=i.valueView;return a.targets.forEach((function(e,i){for(var o=e.displacements[n],a=new Float32Array(t.data.buffer,t.data.byteOffset+o.offset,o.count),c=s*i*4,l=0;l<s;++l)r[c+4*l+0]=a[3*l+0],r[c+4*l+1]=a[3*l+1],r[c+4*l+2]=a[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}return r(e,[{key:"destroy",value:function(){for(var e,t=z(this._attributes);!(e=t()).done;){e.value.morphTexture.destroy()}}},{key:"createInstance",value:function(){var e=this,t=new rs(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=z(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case rn.ATTR_POSITION:a=Va.binding;break;case rn.ATTR_NORMAL:a=Ha.binding;break;case rn.ATTR_TANGENT:a=qa.binding;break;default:V("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(Ga.BLOCK.binding,t.buffer),n.update()},destroy:function(){}}}}]),e}(),rs=function(){function e(t,n){o(this,e),this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=n,this._localBuffer=new DataView(new ArrayBuffer(Ga.SIZE)),this._remoteBuffer=t.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:Ga.SIZE,stride:Ga.SIZE})}return r(e,[{key:"destroy",value:function(){this._remoteBuffer.destroy()}},{key:"setWeights",value:function(e){H(e.length===this._targetCount);for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Ga.OFFSET_OF_WEIGHTS+4*t,e[t],a.sys.isLittleEndian)}},{key:"setMorphTextureInfo",value:function(e,t){this._localBuffer.setFloat32(Ga.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,a.sys.isLittleEndian),this._localBuffer.setFloat32(Ga.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,a.sys.isLittleEndian)}},{key:"setVerticesCount",value:function(e){this._localBuffer.setFloat32(Ga.OFFSET_OF_VERTICES_COUNT,e,a.sys.isLittleEndian)}},{key:"commit",value:function(){this._remoteBuffer.update(this._localBuffer.buffer,this._localBuffer.byteOffset,this._localBuffer.byteLength)}},{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function os(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}var as=e("b4",function(){function e(t,n,i){o(this,e),this.vertexBuffers=void 0,this.attributes=void 0,this.primitiveMode=void 0,this.indexBuffer=void 0,this.indirectBuffer=void 0,this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=void 0,this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this.vertexBuffers=t,this.attributes=n,this.primitiveMode=i}return r(e,[{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:s.ZERO,max:s.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:s.ZERO,max:s.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,rn.ATTR_POSITION),i=e.readIndices(t),r=new s,o=new s,c=this.attributes.find((function(e){return e.name===a.GFXAttributeName.ATTR_POSITION}));if(c){var l=Kn[c.format].count;2===l?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var u=0;u<n.length;u+=l)2===l?(r.x=n[u]>r.x?n[u]:r.x,r.y=n[u+1]>r.y?n[u+1]:r.y,o.x=n[u]<o.x?n[u]:o.x,o.y=n[u+1]<o.y?n[u+1]:o.y):(r.x=n[u]>r.x?n[u]:r.x,r.y=n[u+1]>r.y?n[u+1]:r.y,r.z=n[u+2]>r.z?n[u+2]:r.z,o.x=n[u]<o.x?n[u]:o.x,o.y=n[u+1]<o.y?n[u+1]:o.y,o.z=n[u+2]<o.z?n[u+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){if(this._flatBuffers)return this._flatBuffers;var e=this._flatBuffers=[];if(!this.mesh||void 0===this.subMeshIdx)return e;var t=this.mesh,n=0,i=t.struct.primitives[this.subMeshIdx];i.indexView&&(n=i.indexView.count);for(var r,o=z(i.vertexBundelIndices);!(r=o()).done;){var a=r.value,s=t.struct.vertexBundles[a],c=i.indexView?i.indexView.count:s.view.count,l=s.view.stride,u=l*c,_=new Uint8Array(t.data.buffer,s.view.offset,s.view.length);if(i.indexView){for(var f=new Uint8Array(u),h=t.readIndices(this.subMeshIdx),d=0;d<n;++d)for(var v=d*l,m=h[d]*l,p=0;p<l;++p)f[v+p]=_[m+p];this._flatBuffers.push({stride:l,count:c,buffer:f})}else this._flatBuffers.push({stride:l,count:c,buffer:_})}return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,s=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===s.jointMapIndex||!o.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=a.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=o.vertexBundles[s.vertexBundelIndices[l]];r=0,i=an.UNKNOWN;for(var _=0;_<u.attributes.length;_++){var f=u.attributes[_];if(f.name===rn.ATTR_JOINTS){i=f.format;break}r+=Kn[f.format].size}i?function(){var a=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),_=new DataView(a.slice().buffer),f=o.jointMaps[s.jointMapIndex];bo(_,(function(e){return f.indexOf(e)}),i,r,u.view.length,u.view.stride,_);var h=c.createBuffer({usage:sn.VERTEX|sn.TRANSFER_DST,memUsage:cn.DEVICE,size:u.view.length,stride:u.view.stride});h.update(_.buffer),t.push(h),n.push(l)}():t.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this.indirectBuffer&&(this.indirectBuffer.destroy(),this.indirectBuffer=void 0)}},{key:"enableVertexIdChannel",value:function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this.vertexBuffers.push(i),this.attributes.push({name:"a_vertexId",format:an.R32F,stream:t,isNormalized:!1}),this._vertexIdChannel={stream:t,index:n}}}},{key:"_allocVertexIdBuffer",value:function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer({usage:sn.VERTEX|sn.TRANSFER_DST,memUsage:cn.DEVICE,size:n.byteLength,stride:n.BYTES_PER_ELEMENT});return r.update(n),r}}]),e}()),ss=new s,cs=new s,ls=new Uint8Array,us=e("at",A("cc.Mesh")(($a=b((Za=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"_struct",$a,F(e)),R(e,"_dataLength",es,F(e)),R(e,"_hash",ts,F(e)),e._data=ls,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e.morphRendering=null,e.loaded=!1,e}return c(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),a.loader._cache[this.nativeUrl]&&(a.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=fi(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),r(t,[{key:"initialize",value:function(){var e=this;if(!this._initialized){var t,n;this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),(t=this).loaded?n&&n():t.nativeUrl?a.loader.load({url:t.nativeUrl},(function(e,i){i&&(t.loaded||(t._nativeAsset=i)),n&&n(e)})):n&&n());for(var i=this._data.buffer,r=a.director.root.device,o=this._createVertexBuffers(r,i),s=[],c=function(t){var n=e._struct.primitives[t];if(0===n.vertexBundelIndices.length)return"continue";var a=void 0,c=null;if(n.indexView){var l=n.indexView,u=l.stride,_=l.length;if(4===u&&!r.hasFeature(ni.ELEMENT_INDEX_UINT)){var f=e._struct.vertexBundles[n.vertexBundelIndices[0]].view.count;if(f>=65536)return N(10001,f,65536),"continue";u>>=1,_>>=1}a=r.createBuffer({usage:sn.INDEX|sn.TRANSFER_DST,memUsage:cn.DEVICE,size:_,stride:u}),c=new(os(l.stride))(i,l.offset,l.count),l.stride!==u&&(c=os(u).from(c)),e.loaded?a.update(c):e.once("load",(function(){a.update(c)}))}var h=n.vertexBundelIndices.map((function(e){return o[e]})),d=[];if(n.vertexBundelIndices.length>0){var v=n.vertexBundelIndices[0];d=e._struct.vertexBundles[v].attributes}var m=new as(h,d,n.primitiveMode);m.mesh=e,m.subMeshIdx=t,m.indexBuffer=a,s.push(m)},l=0;l<this._struct.primitives.length;l++)c(l);this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=function(e,t){return new ns(e,t)}(this,r))}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),D(u(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")}},{key:"getBoneSpaceBounds",value:function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Wr(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var c=this.readAttribute(a,rn.ATTR_JOINTS),l=this.readAttribute(a,rn.ATTR_WEIGHTS),u=this.readAttribute(a,rn.ATTR_POSITION);if(c&&l&&u)for(var _=Math.min(c.length/4,l.length/4,u.length/3),f=0;f<_;f++){s.set(ss,u[3*f+0],u[3*f+1],u[3*f+2]);for(var h=0;h<4;++h){var d=4*f+h,v=c[d];if(!(0===l[d]||v>=i.length)){s.transformMat4(cs,ss,i[v]),n[v]=!0;var m=t[v];s.min(m.center,m.center,cs),s.max(m.halfExtents,m.halfExtents,cs)}}}}for(var p=0;p<i.length;p++){var g=t[p];n[p]?Wr.fromPoints(g,g.center,g.halfExtents):t[p]=null}return t}},{key:"merge",value:function(e,t,n){if(n&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;var i=new s,r=t&&new X,o=t&&new Wr;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),c=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(s.add(o.center,a.maxPosition,a.minPosition),s.multiplyScalar(o.center,o.center,.5),s.subtract(o.halfExtents,a.maxPosition,a.minPosition),s.multiplyScalar(o.halfExtents,o.halfExtents,.5),Wr.transform(o,o,t),s.add(a.maxPosition,o.center,o.halfExtents),s.subtract(a.minPosition,o.center,o.halfExtents));for(var l=0;l<a.vertexBundles.length;l++)for(var u=a.vertexBundles[l],_=0;_<u.attributes.length;_++)if(u.attributes[_].name===rn.ATTR_POSITION||u.attributes[_].name===rn.ATTR_NORMAL){var f=u.attributes[_].format,h=new DataView(c.buffer,u.view.offset+_s(u.attributes,_)),d=gs(h,f),v=ys(h,f);if(!d||!v)continue;for(var m=u.view.count,p=u.view.stride,g=ps(f),y=0;y<m;y++){var x=y*p,S=x+g,C=S+g;switch(i.set(d(x),d(S),d(C)),u.attributes[_].name){case rn.ATTR_POSITION:i.transformMat4(t);break;case rn.ATTR_NORMAL:s.transformQuat(i,i,r)}v(x,i.x),v(S,i.y),v(C,i.z)}}}return this.reset({struct:a,data:c}),this.initialize(),!0}for(var T,E,A,b,w,I=new wo,R=0,O=0,P=0,N=0,D=0,M=0,L=0,F=0,k=!1,U=new Array(this._struct.vertexBundles.length),B=0;B<this._struct.vertexBundles.length;++B){var G=this._struct.vertexBundles[B],j=e._struct.vertexBundles[B];P=G.view.offset,N=j.view.offset,O=G.view.stride,R=G.view.count+j.view.count,T=new ArrayBuffer(R*O),E=new Uint8Array(T),P+=(A=this._data.subarray(P,P+G.view.length)).length,N+=(b=e._data.subarray(N,N+j.view.length)).length,E.set(A),D=0;for(var V,H=z(G.attributes);!(V=H()).done;){var q=V.value;L=0,k=!1;for(var W,Y=z(j.attributes);!(W=Y()).done;){var K=W.value;if(q.name===K.name&&q.format===K.format){k=!0;break}L+=Kn[K.format].size}if(k){F=Kn[q.format].size,M=G.view.length+D;for(var Q=0;Q<j.view.count;++Q){if(w=b.subarray(L,L+F),E.set(w,M),(q.name===rn.ATTR_POSITION||q.name===rn.ATTR_NORMAL)&&t){var J=new Float32Array(E.buffer,M,3);switch(i.set(J[0],J[1],J[2]),q.name){case rn.ATTR_POSITION:i.transformMat4(t);break;case rn.ATTR_NORMAL:s.transformQuat(i,i,r)}J[0]=i.x,J[1]=i.y,J[2]=i.z}M+=G.view.stride,L+=j.view.stride}}D+=Kn[q.format].size}U[B]={attributes:G.attributes,view:{offset:I.getLength(),length:T.byteLength,count:R,stride:O}},I.addBuffer(T)}for(var Z,$,ee,te=0,ne=2,ie=0,re=new Array(this._struct.primitives.length),oe=0;oe<this._struct.primitives.length;++oe){var ae=this._struct.primitives[oe],se=e._struct.primitives[oe];re[oe]={primitiveMode:ae.primitiveMode,vertexBundelIndices:ae.vertexBundelIndices};for(var ce,le=z(ae.vertexBundelIndices);!(ce=le()).done;){var ue=ce.value;ie=Math.max(ie,this._struct.vertexBundles[ue].view.count)}if(ae.indexView&&se.indexView){te=ae.indexView.count,te+=se.indexView.count,P=ae.indexView.offset,N=se.indexView.offset,ne=te<256?1:te<65536?2:4;var _e=new ArrayBuffer(te*ne);if(Z=2===ne?new Uint16Array(_e):1===ne?new Uint8Array(_e):new Uint32Array(_e),$=2===ae.indexView.stride?new Uint16Array(this._data.buffer,P,ae.indexView.count):1===ae.indexView.stride?new Uint8Array(this._data.buffer,P,ae.indexView.count):new Uint32Array(this._data.buffer,P,ae.indexView.count),ne===ae.indexView.stride)Z.set($);else for(var fe=0;fe<ae.indexView.count;++fe)Z[fe]=$[fe];P+=ae.indexView.length,ee=2===se.indexView.stride?new Uint16Array(e._data.buffer,N,se.indexView.count):1===se.indexView.stride?new Uint8Array(e._data.buffer,N,se.indexView.count):new Uint32Array(e._data.buffer,N,se.indexView.count);for(var he=0;he<se.indexView.count;++he)Z[ae.indexView.count+he]=ie+ee[he];N+=se.indexView.length,re[oe].indexView={offset:I.getLength(),length:_e.byteLength,count:te,stride:ne},I.setNextAlignment(ne),I.addBuffer(_e)}}var de={vertexBundles:U,primitives:re,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return de.minPosition&&e._struct.minPosition&&de.maxPosition&&e._struct.maxPosition&&(t?(s.add(o.center,e._struct.maxPosition,e._struct.minPosition),s.multiplyScalar(o.center,o.center,.5),s.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),s.multiplyScalar(o.halfExtents,o.halfExtents,.5),Wr.transform(o,o,t),s.add(i,o.center,o.halfExtents),s.max(de.maxPosition,de.maxPosition,i),s.subtract(i,o.center,o.halfExtents),s.min(de.minPosition,de.minPosition,i)):(s.min(de.minPosition,de.minPosition,e._struct.minPosition),s.max(de.maxPosition,de.maxPosition,e._struct.maxPosition))),this.reset({struct:de,data:new Uint8Array(I.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=ei(Kn[o]);if(0===r)return new a;var s=new DataView(n._data.buffer,e.view.offset+_s(e.attributes,t)),c=Kn[o],l=gs(s,o);if(a&&l){for(var u=c.count,_=new a(r*u),f=e.view.stride,h=0;h<r;++h)for(var d=0;d<u;++d)_[u*h+d]=l(f*h+_.BYTES_PER_ELEMENT*d);i=_}})),i}},{key:"copyAttribute",value:function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+_s(e.attributes,t)),u=new DataView(n,r),_=Kn[c],f=gs(l,c),h=ys(u,c);if(f&&h){for(var d=_.count,v=e.view.stride,m=ps(c),p=i,g=m,y=0;y<s;++y)for(var x=0;x<d;++x){h(p*y+g*x,f(v*y+m*x))}a=!0}}else a=!0})),a}},{key:"readIndices",value:function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}},{key:"copyIndices",value:function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?an.R8UI:2===n.indexView.stride?an.R16UI:an.R32UI,o=gs(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+Kn[r].size*a);return!0}},{key:"_accessAttribute",value:function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=this._struct.primitives[e],o=z(r.vertexBundelIndices);!(i=o()).done;){var a=i.value,s=this._struct.vertexBundles[a],c=s.attributes.findIndex((function(e){return e.name===t}));if(!(c<0)){n(s,c);break}}}},{key:"_createVertexBuffers",value:function(e,t){var n=this;return this._struct.vertexBundles.map((function(i){var r=e.createBuffer({usage:sn.VERTEX|sn.TRANSFER_DST,memUsage:cn.DEVICE,size:i.view.length,stride:i.view.stride}),o=new Uint8Array(t,i.view.offset,i.view.length);return n.loaded?r.update(o):n.once("load",(function(){r.update(o)})),r}))}}]),t}(M)).prototype,"_struct",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),es=b(Za.prototype,"_dataLength",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ts=b(Za.prototype,"_hash",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ja=Za))||Ja);function _s(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=Kn[r.format].size}return n}a.Mesh=us;var fs,hs,ds,vs,ms=P.isLittleEndian;function ps(e){var t=Kn[e];return t.size/t.count}function gs(e,t){var n=Kn[t],i=n.size/n.count;switch(n.type){case Gn.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,ms)};case 4:return function(t){return e.getUint32(t,ms)}}break;case Gn.SNORM:case Gn.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,ms)};case 4:return function(t){return e.getInt32(t,ms)}}break;case Gn.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,ms)};case 4:return function(t){return e.getUint32(t,ms)}}break;case Gn.FLOAT:return function(t){return e.getFloat32(t,ms)}}return null}function ys(e,t){var n=Kn[t],i=n.size/n.count;switch(n.type){case Gn.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,ms)};case 4:return function(t,n){return e.setUint32(t,n,ms)}}break;case Gn.SNORM:case Gn.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,ms)};case 4:return function(t,n){return e.setInt32(t,n,ms)}}break;case Gn.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,ms)};case 4:return function(t,n){return e.setUint32(t,n,ms)}}break;case Gn.FLOAT:return function(t,n){return e.setFloat32(t,n,ms)}}return null}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(fs||(fs=e("a3",{}))),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(hs||(hs=e("a4",{})));var xs;!function(e){e[e.UBO=0]="UBO",e[e.SAMPLER=1]="SAMPLER"}(xs||(xs=e("a5",{})));var Ss,Cs=e("a6",(function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return e<<28&4026531840|i<<22&264241152|t<<20&3145728|n<<14&1032192|16383&r})),Ts=e("a7",(function(e){return(4026531840&e)>>>28})),Es=e("a8",(function(e){return(264241152&e)>>>22})),As=(e("a9",(function(e){return(3145728&e)>>>20})),e("aa",(function(e){return(1032192&e)>>>14}))),bs=e("ab",(function(e){return 16383&e})),ws=e("ac",(function(e,t){return-264241153&e|t<<22&264241152})),Is=e("ad",(O(ds={},on.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),O(ds,on.INT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]})),O(ds,on.INT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Y.fromArray(t,e,n)})),O(ds,on.INT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.fromArray(t,e,n)})),O(ds,on.INT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return m.fromArray(t,e,n)})),O(ds,on.FLOAT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]})),O(ds,on.FLOAT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Y.fromArray(t,e,n)})),O(ds,on.FLOAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.fromArray(t,e,n)})),O(ds,on.FLOAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return m.fromArray(t,e,n)})),O(ds,on.MAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return h.fromArray(t,e,n)})),O(ds,on.MAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return f.fromArray(t,e,n)})),ds)),Rs=e("ae",(O(vs={},on.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),O(vs,on.INT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]=t})),O(vs,on.INT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Y.toArray(e,t,n)})),O(vs,on.INT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.toArray(e,t,n)})),O(vs,on.INT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return m.toArray(e,t,n)})),O(vs,on.FLOAT,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[n]=t})),O(vs,on.FLOAT2,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Y.toArray(e,t,n)})),O(vs,on.FLOAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return s.toArray(e,t,n)})),O(vs,on.FLOAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return m.toArray(e,t,n)})),O(vs,on.MAT3,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return h.toArray(e,t,n)})),O(vs,on.MAT4,(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return f.toArray(e,t,n)})),vs)),Os=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Ps(e){switch(e){case on.BOOL:case on.INT:case on.UINT:case on.FLOAT:return Os[0];case on.BOOL2:case on.INT2:case on.UINT2:case on.FLOAT2:return Os[1];case on.BOOL4:case on.INT4:case on.UINT4:case on.FLOAT4:return Os[2];case on.MAT4:return Os[3];case on.SAMPLER2D:return"default-texture";case on.SAMPLER_CUBE:return"default-cube-texture"}return Os[0]}function Ns(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var Ds,zs,Ms,Ls,Fs,ks,Us=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],Bs=e("b7",A("cc.SpriteFrame")(Ss=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e.uvSliced=[],e._rect=new K,e._offset=new Y,e._originalSize=new Q,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return c(t,e),r(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){e&&(this._refreshTexture(e),this._calculateUV())}}],[{key:"createWithImage",value:function(e){var n=e instanceof Fo?e:new Fo(e),i=new da;i.image=n;var r=new t;return r.texture=i,r}}]),r(t,[{key:"textureLoaded",value:function(){return this.texture&&this.texture.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTexture",value:function(){return this._texture.getGFXTexture()}},{key:"getGFXSampler",value:function(){return this._texture.getGFXSampler()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(k(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height)||(k(3301,this.name+"/"+e.name,i,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return D(u(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,n=t.width,i=t.height,r=this._capInsets[0],o=this._capInsets[2],a=e.width-r-o,s=this._capInsets[1],c=this._capInsets[3],l=e.height-s-c,u=this.uvSliced;if(u.length=0,this._rotated){Us[0].u=(e.x+.5)/n,Us[1].u=(e.x+c)/n,Us[2].u=(e.x+c+l)/n,Us[3].u=(e.x+e.height-.5)/n,Us[3].v=(e.y+.5)/i,Us[2].v=(e.y+r)/i,Us[1].v=(e.y+r+a)/i,Us[0].v=(e.y+e.width-.5)/i;for(var _=0;_<4;++_)for(var f=Us[_],h=0;h<4;++h){var d=Us[3-h];u.push({u:f.u,v:d.v})}}else{Us[0].u=(e.x+.5)/n,Us[1].u=(e.x+r)/n,Us[2].u=(e.x+r+a)/n,Us[3].u=(e.x+e.width-.5)/n,Us[3].v=(e.y+.5)/i,Us[2].v=(e.y+s)/i,Us[1].v=(e.y+s+l)/i,Us[0].v=(e.y+e.height-.5)/i;for(var v=0;v<4;++v)for(var m=Us[v],p=0;p<4;++p){var g=Us[p];u.push({u:g.u,v:m.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,n=this.texture,i=n.width,r=n.height;if(this._rotated){var o=0===i?0:(e.x+.5)/i,a=0===i?0:(e.x+e.height-.5)/i,s=0===r?0:(e.y+.5)/r,c=0===r?0:(e.y+e.width-.5)/r;this._flipUv,t[0]=o,t[1]=s,t[2]=o,t[3]=c,t[4]=a,t[5]=s,t[6]=a,t[7]=c}else{var l=0===i?0:(e.x+.5)/i,u=0===i?0:(e.x+e.width-.5)/i,_=0===r?0:(e.y+e.height-.5)/r,f=0===r?0:(e.y+.5)/r;this._flipUv?(t[0]=l,t[1]=f,t[2]=u,t[3]=f,t[4]=l,t[5]=_,t[6]=u,t[7]=_):(t[0]=l,t[1]=_,t[2]=u,t[3]=_,t[4]=l,t[5]=f,t[6]=u,t[7]=f)}for(var h="",d=0;d<t.length;d++)h+=t[d];this.uvHash=fi(h,666);var v=this.vertices;if(v){v.nu.length=0,v.nv.length=0;for(var m=0;m<v.u.length;m++)v.nu[m]=v.u[m]/i,v.nv[m]=v.v[m]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,n,i=this._rect,r=this._offset,o=this._originalSize,a=this._uuid;return this._texture&&(t=this._texture._uuid),a&&e&&(a=EditorExtends.UuidUtils.compressUuid(a,!0)),t&&e&&(t=EditorExtends.UuidUtils.compressUuid(t,!0)),this.vertices&&(n={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{name:this._name,atlas:e?void 0:this._atlasUuid,rect:i,offset:r,originalSize:o,rotated:this._rotated,capInsets:this._capInsets,vertices:n,texture:t}}},{key:"_deserialize",value:function(e,t){var n=e,i=n.rect;i&&(this._rect=new K(i.x,i.y,i.width,i.height));var r=n.offset;n.offset&&(this._offset=new Y(r.x,r.y));var o=n.originalSize;n.originalSize&&(this._originalSize=new Q(o.width,o.height)),this._rotated=!!n.rotated,this._name=n.name;var a=n.capInsets;a&&(this._capInsets[0]=a[0],this._capInsets[1]=a[1],this._capInsets[2]=a[2],this._capInsets[3]=a[3]),n.texture&&t.result.push(this,"_textureSource",n.texture),this.vertices=n.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new K(0,0,e.width,e.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(t.originalSize=new Q(e.width,e.height),n=!0),n&&(this.reset(t),this.onLoaded())}},{key:"_refreshTexture",value:function(e){this._texture=e,e.loaded?this._textureLoaded():e.once("load",this._textureLoaded,this)}}]),t}(M))||Ss);a.SpriteFrame=Bs,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(ks||(ks={}));var Gs=e("aZ",A("cc.TextureCube")((Fs=Ls=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_mipmaps",Ms,F(n)),n}return c(t,e),r(t,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var i=Math.min(void 0===n?this._mipmaps.length:n,this._mipmaps.length-t),r=function(n){var i=t+n;js(e._mipmaps[i],(function(t,n){e._assignImage(t,i,n)}))},o=0;o<i;++o)r(o)}},{key:"destroy",value:function(){return this._mipmaps=[],D(u(t.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(e){return{base:D(u(t.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map((function(t){return e?{front:EditorExtends.UuidUtils.compressUuid(t.front._uuid,!0),back:EditorExtends.UuidUtils.compressUuid(t.back._uuid,!0),left:EditorExtends.UuidUtils.compressUuid(t.left._uuid,!0),right:EditorExtends.UuidUtils.compressUuid(t.right._uuid,!0),top:EditorExtends.UuidUtils.compressUuid(t.top._uuid,!0),bottom:EditorExtends.UuidUtils.compressUuid(t.bottom._uuid,!0)}:{front:t.front._uuid,back:t.back._uuid,left:t.left._uuid,right:t.right._uuid,top:t.top._uuid,bottom:t.bottom._uuid}}))}}},{key:"_deserialize",value:function(e,n){var i=e;D(u(t.prototype),"_deserialize",this).call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Fo,back:new Fo,left:new Fo,right:new Fo,top:new Fo,bottom:new Fo};var o=i.mipmaps[r];n.result.push(this._mipmaps[r],"front",o.front),n.result.push(this._mipmaps[r],"back",o.back),n.result.push(this._mipmaps[r],"left",o.left),n.result.push(this._mipmaps[r],"right",o.right),n.result.push(this._mipmaps[r],"top",o.top),n.result.push(this._mipmaps[r],"bottom",o.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=Object.assign({type:Cn.CUBE,width:this._width,height:this._height,layerCount:6},e);return t.flags=(t.flags||0)|An.CUBEMAP,t}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){js(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+ks.front].image,back:e[a+ks.back].image,left:e[a+ks.left].image,right:e[a+ks.right].image,top:e[a+ks.top].image,bottom:e[a+ks.bottom].image})}return(n=n||new t).mipmaps=i,n}}]),t}(ha),Ls.FaceIndex=ks,Ms=b((zs=Fs).prototype,"_mipmaps",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ds=zs))||Ds);function js(e,t){t(e.front,ks.front),t(e.back,ks.back),t(e.left,ks.left),t(e.right,ks.right),t(e.top,ks.top),t(e.bottom,ks.bottom)}a.TextureCube=Gs;var Vs,Hs,qs,Ws=e("d2",[{name:"builtin-billboard",_uuid:"711ebe11-f673-4cd9-9a83-63c60ba54c5b",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:2143664850,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-graphics",_uuid:"1c02ae6f-4492-4915-b8f8-7492a3b1e4cd",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-graphics|vs:vert|fs:frag"}]}],shaders:[{name:"builtin-graphics|vs:vert|fs:frag",hash:3946667351,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    #ifdef GL_OES_standard_derivatives\n      float aa = fwidth(v_dist);\n    #else\n      float aa = 0.05;\n    #endif\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"builtin-particle-gpu",_uuid:"971bdb23-3ff6-43eb-b422-1c30165a3663",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3696836305,glsl3:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord;\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  layout(std140) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  layout(std140) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  layout(std140) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  layout(std140) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  layout(std140) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  layout(std140) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord;\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture2D(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord;\n  layout(location = 7) in vec3 a_texCoord3;\n  layout(location = 8) in vec3 a_normal;\n  layout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\n  layout(set = 1, binding = 3) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\n  layout(set = 1, binding = 4) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\n  layout(set = 1, binding = 5) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\n  layout(set = 1, binding = 6) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\n  layout(set = 1, binding = 7) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  layout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\n  layout(set = 1, binding = 8) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"builtin-particle-trail",_uuid:"17debcc3-0a6b-4b8a-b00b-dc58b885581e",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:4115155772,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  layout(std140) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  layout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uv;\n  layout(location = 1) in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    layout(location = 2) in vec3 vBarycentric;\n  #endif\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n  layout(set = 1, binding = 1) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"builtin-particle",_uuid:"d1346436-ac96-4271-b863-1f4fdead95b0",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:66662317,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\n  layout(location = 5) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord3;\n  layout(location = 7) in vec3 a_normal;\n  layout(location = 5) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:5},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"builtin-sprite",_uuid:"60f7195c-ec2a-45eb-ba94-8955f60e81d0",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:2679078392,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture2D(tex, uv);\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\n  layout(location = 1) in vec2 uv0;\n  layout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-standard",_uuid:"1baf0fc9-befa-459c-8bdd-af1a450a0319",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"builtin-standard|standard-vs:vert|standard-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:3803722737,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nout vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\nout float v_fog_factor;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  in vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(std140) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nin vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\nin float v_fog_factor;\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nvarying vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_fog_factor;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform lowp vec4 cc_shadowColor;\nuniform lowp vec4 cc_shadowPCF;\nuniform lowp vec4 cc_shadowSize;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nuniform highp vec4 cc_lightPos[1];\nuniform vec4 cc_lightColor[1];\nuniform vec4 cc_lightSizeRangeAngle[1];\nuniform vec4 cc_lightDir[1];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nvarying vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture2D(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nlayout(location = 0) out vec4 v_shadowPos;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 13) in vec3 a_color;\n  layout(location = 1) out vec3 v_color;\n#endif\nlayout(location = 2) out vec3 v_position;\nlayout(location = 3) out vec3 v_normal;\nlayout(location = 4) out vec2 v_uv;\nlayout(location = 5) out vec2 v_uv1;\nlayout(location = 6) out float v_fog_factor;\n#if USE_NORMAL_MAP\n  layout(location = 7) out vec3 v_tangent;\n  layout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) in vec2 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(set = 2, binding = 1) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nlayout(location = 0) in vec4 v_shadowPos;\nlayout(set = 0, binding = 4) uniform sampler2D cc_shadowMap;\nfloat CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  float shadow = step(closestDepth, clipPos.z - 0.001);\n  return shadow;\n}\nfloat CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  float closestDepth = 0.0;\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  shadow += step(closestDepth, clipPos.z - 0.001);\n  return shadow /= 5.0;\n}\nfloat CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 9.0;\n}\nfloat CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float shadow = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n      shadow += step(closestDepth, clipPos.z - 0.001);\n    }\n  }\n  return shadow /= 25.0;\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      float pcf = cc_shadowPCF.x + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) {shadowAttenuation = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadowAttenuation = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadowAttenuation = CCGetShadowFactorX5();}\n      else {shadowAttenuation = CCGetShadowFactorX1();}\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor * (1.0 - cc_shadowColor.a);\n      finalColor = shadowColor.rgb * shadowAttenuation + finalColor.rgb * (1.0 - shadowAttenuation);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(location = 2) in vec3 v_position;\nlayout(location = 4) in vec2 v_uv;\nlayout(location = 5) in vec2 v_uv1;\nlayout(location = 3) in vec3 v_normal;\nlayout(location = 6) in float v_fog_factor;\n#if USE_VERTEX_COLOR\n  layout(location = 1) in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  layout(location = 7) in vec3 v_tangent;\n  layout(location = 8) in vec3 v_bitangent;\n  layout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  layout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  layout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  layout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  layout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["!CC_FORWARD_ADD","CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:15,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:32,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:868488122,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture2D(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"builtin-terrain",_uuid:"1d08ef62-a503-4ce2-8b9a-46c90873f7d3",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},lightMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:298856331,glsl3:{vert:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  in vec3 a_position;\n  in vec3 a_normal;\n  in vec2 a_texCoord;\n  out vec2 uvw;\n  out vec2 uv0;\n  out vec2 uv1;\n  out vec2 uv2;\n  out vec2 uv3;\n  out vec2 luv;\n  out vec3 diffuse;\n  out float factor_fog;\n  layout(std140) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  in vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\n  precision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  attribute vec3 a_position;\n  attribute vec3 a_normal;\n  attribute vec2 a_texCoord;\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec2 luv;\n  varying vec3 diffuse;\n  varying float factor_fog;\n  uniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  varying vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  varying float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture2D(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  layout(location = 0) in vec3 a_position;\n  layout(location = 1) in vec3 a_normal;\n  layout(location = 2) in vec2 a_texCoord;\n  layout(location = 0) out vec2 uvw;\n  layout(location = 1) out vec2 uv0;\n  layout(location = 2) out vec2 uv1;\n  layout(location = 3) out vec2 uv2;\n  layout(location = 4) out vec2 uv3;\n  layout(location = 5) out vec2 luv;\n  layout(location = 6) out vec3 diffuse;\n  layout(location = 7) out float factor_fog;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uvw;\n  layout(location = 1) in vec2 uv0;\n  layout(location = 2) in vec2 uv1;\n  layout(location = 3) in vec2 uv2;\n  layout(location = 4) in vec2 uv3;\n  layout(location = 6) in vec3 diffuse;\n  layout(location = 5) in vec2 luv;\n  layout(set = 1, binding = 1) uniform sampler2D weightMap;\n  layout(set = 1, binding = 2) uniform sampler2D detailMap0;\n  layout(set = 1, binding = 3) uniform sampler2D detailMap1;\n  layout(set = 1, binding = 4) uniform sampler2D detailMap2;\n  layout(set = 1, binding = 5) uniform sampler2D detailMap3;\n  layout(set = 1, binding = 6) uniform sampler2D lightMap;\n  layout(location = 7) in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"LIGHT_MAP",type:"number",range:[0,3]},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"builtin-unlit",_uuid:"a3cd009f-0ab0-420d-9278-b9fdab939bbc",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:4280240937,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  in lowp vec4 a_color;\n  out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  out vec2 v_uv;\n  layout(std140) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nout float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in lowp vec4 v_color;\n#endif\nin float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  attribute lowp vec4 a_color;\n  varying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvarying float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying lowp vec4 v_color;\n#endif\nvarying float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  layout(location = 13) in lowp vec4 a_color;\n  layout(location = 0) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  layout(location = 1) out vec2 v_uv;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nlayout(location = 2) out float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  layout(location = 1) in vec2 v_uv;\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 0) in lowp vec4 v_color;\n#endif\nlayout(location = 2) in float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"pipeline/planar-shadow",_uuid:"9361fd90-ba52-4f84-aa93-6e878fd576ca",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2804795238,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"pipeline/skybox",_uuid:"511d2633-09a7-4bdd-ac42-f778032124b3",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:629379420,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"util/profiler",_uuid:"871c3b6c-7379-419d-bda3-794b239ab90d",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:4021376818,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\n  vec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform mediump vec4 cc_screenSize;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"util/splash-screen",_uuid:"970b0598-bcb0-4714-91fb-2e81440dccd8",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:2106901053,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nlayout(std140) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 0) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,stageFlags:16,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),Xs=function(){function e(){o(this,e),this._device=null,this._resources={}}return r(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,n=document.createElement("canvas"),i=n.getContext("2d"),r=new Fo(n),o=n.width=n.height=2;i.fillStyle="#000",i.fillRect(0,0,o,o);var s=new da;s._uuid="black-texture",s.image=r,t[s._uuid]=s,i.fillStyle="rgba(0,0,0,0)",i.fillRect(0,0,o,o);for(var c=new Uint8Array(16),l=0;l<c.length;++l)c[l]=0;var u=new da;u._uuid="empty-texture",u.image=r,u.uploadData(c),t[u._uuid]=u;var _=new Gs;_._uuid="black-cube-texture",_.setMipFilter(Gs.Filter.LINEAR),_.image={front:new Fo(n),back:new Fo(n),left:new Fo(n),right:new Fo(n),top:new Fo(n),bottom:new Fo(n)},t[_._uuid]=_,i.fillStyle="#777",i.fillRect(0,0,o,o);var f=new da;f._uuid="grey-texture",f.image=r,t[f._uuid]=f,i.fillStyle="#fff",i.fillRect(0,0,o,o);var h=new da;h._uuid="white-texture",h.image=r,t[h._uuid]=h;var d=new Gs;d._uuid="white-cube-texture",d.setMipFilter(Gs.Filter.LINEAR),d.image={front:new Fo(n),back:new Fo(n),left:new Fo(n),right:new Fo(n),top:new Fo(n),bottom:new Fo(n)},t[d._uuid]=d,i.fillStyle="#7f7fff",i.fillRect(0,0,o,o);var v=new da;v._uuid="normal-texture",v.image=r,t[v._uuid]=v,n.width=n.height=16,i.fillStyle="#ddd",i.fillRect(0,0,16,16),i.fillStyle="#555",i.fillRect(0,0,8,8),i.fillStyle="#555",i.fillRect(8,8,8,8);var m=new da;m._uuid="default-texture",m.image=r,t[m._uuid]=m;var p=new Gs;p.setMipFilter(Gs.Filter.LINEAR),p._uuid="default-cube-texture",p.image={front:new Fo(n),back:new Fo(n),left:new Fo(n),right:new Fo(n),top:new Fo(n),bottom:new Fo(n)},t[p._uuid]=p;var g=new Bs,y=r._texture;g.texture=y,g._uuid="default-spriteframe",t[g._uuid]=g,Ws.forEach((function(e){Object.assign(new a.EffectAsset,e).onLoaded()}));var x=new a.Material;x._uuid="standard-material",x.initialize({effectName:"builtin-standard"}),t[x._uuid]=x;var S=new a.Material;S._uuid="missing-effect-material",S.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),S.setProperty("mainColor",a.color("#ffff00")),t[S._uuid]=S;var C=new a.Material;C._uuid="missing-material",C.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),C.setProperty("mainColor",a.color("#ff00ff")),t[C._uuid]=C;var T=new a.Material;T._uuid="ui-base-material",T.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;var E=new a.Material;E._uuid="ui-sprite-material",E.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"builtin-sprite"}),t[E._uuid]=E;var A=new a.Material;A._uuid="ui-sprite-gray-material",A.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"builtin-sprite"}),t[A._uuid]=A;var b=new a.Material;b._uuid="ui-sprite-alpha-sep-material",b.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[b._uuid]=b;var w=new a.Material;w._uuid="ui-sprite-gray-alpha-sep-material",w.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[w._uuid]=w;var I=new a.Material;I._uuid="ui-graphics-material",I.initialize({effectName:"builtin-graphics"}),t[I._uuid]=I;var R=new a.Material;R._uuid="default-particle-material",R.initialize({effectName:"builtin-particle"}),t[R._uuid]=R;var O=new a.Material;O._uuid="default-particle-gpu-material",O.initialize({effectName:"builtin-particle-gpu"}),t[O._uuid]=O;var P=new a.Material;P._uuid="default-trail-material",P.initialize({effectName:"builtin-particle-trail"}),t[P._uuid]=P;var N=new a.Material;N._uuid="default-billboard-material",N.initialize({effectName:"builtin-billboard"}),t[N._uuid]=N}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),Ys=e("d3",a.builtinResMgr=new Xs),Ks=(Vs=new Map,Hs=0,function(e){return"number"==typeof e?e:(Vs.has(e)||(Vs.set(e,1<<Hs),Hs++),Vs.get(e))}),Qs=function(){function e(t,n,i){o(this,e),this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<n)}return r(e,[{key:"allocateNewChunk",value:function(){return new ArrayBuffer(this._chunkSize)}}]),e}(),Js=function e(t,n){o(this,e)},Zs=function(){function e(t,n,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;o(this,e),this._viewCtor=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._bufferViews=[],this._nativePool=void 0,this._viewCtor=n,this._elementCount=i.COUNT,this._entryBits=r;var a=n.BYTES_PER_ELEMENT||1;this._stride=a*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Qs(t,r,this._stride)}return r(e,[{key:"alloc",value:function(){for(var e=0;e<this._freelists.length;e++){var t=this._freelists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=0;a<this._entriesPerChunk;a++)r.push(new this._viewCtor(i,this._stride*a,this._elementCount)),a&&o.push(a);return this._arrayBuffers.push(i),this._bufferViews.push(r),this._freelists.push(o),(e<<this._entryBits)+this._poolFlag}},{key:"get",value:function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;return this._bufferViews[n][i][t]}},{key:"set",value:function(e,t,n){var i=(this._chunkMask&e)>>this._entryBits,r=this._entryMask&e;this._bufferViews[i][r][t]=n}},{key:"free",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;this._bufferViews[t][n].fill(0),this._freelists[t].push(n)}}]),e}(),$s=function(){function e(t,n,i){o(this,e),this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=n,i&&(this._dtor=i),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new Js(t,this._array)}return r(e,[{key:"alloc",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._freelist,r=-1;if(i.length&&(r=i[i.length-1],i.length--,this._array[r]=this._ctor(arguments,this._array[r])),r<0){r=this._array.length;var o=this._ctor(arguments);if(!o)return 0;this._array.push(o)}return r+this._poolFlag}},{key:"get",value:function(e){var t=this._indexMask&e;return this._array[t]}},{key:"free",value:function(e){var t=this._indexMask&e;this._dtor&&this._dtor(this._array[t]),this._freelist.push(t)}}]),e}();!function(e){e[e.RASTERIZER_STATE=0]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=1]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=2]="BLEND_STATE",e[e.DESCRIPTOR_SETS=3]="DESCRIPTOR_SETS",e[e.SHADER=4]="SHADER",e[e.INPUT_ASSEMBLER=5]="INPUT_ASSEMBLER",e[e.PIPELINE_LAYOUT=6]="PIPELINE_LAYOUT",e[e.PASS=7]="PASS",e[e.SUB_MODEL=8]="SUB_MODEL"}(qs||(qs={}));var ec,tc=e("di",0),nc=new $s(qs.RASTERIZER_STATE,(function(){return new di})),ic=new $s(qs.DEPTH_STENCIL_STATE,(function(){return new vi})),rc=new $s(qs.BLEND_STATE,(function(){return new pi})),oc=e("dZ",new $s(qs.SHADER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createShader(e[1])}),(function(e){return e&&e.destroy()}))),ac=e("dm",new $s(qs.DESCRIPTOR_SETS,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createDescriptorSet(e[1])}),(function(e){return e&&e.destroy()}))),sc=e("dh",new $s(qs.INPUT_ASSEMBLER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createInputAssembler(e[1])}),(function(e){return e&&e.destroy()}))),cc=new $s(qs.PIPELINE_LAYOUT,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createPipelineLayout(e[1])}),(function(e){return e&&e.destroy()}));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.BATCHING_SCHEME=3]="BATCHING_SCHEME",e[e.PRIMITIVE=4]="PRIMITIVE",e[e.DYNAMIC_STATES=5]="DYNAMIC_STATES",e[e.HASH=6]="HASH",e[e.RASTERIZER_STATE=7]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=9]="BLEND_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",e[e.COUNT=12]="COUNT"}(ec||(ec=e("dq",{})));var lc,uc=e("dp",new Zs(qs.PASS,Uint32Array,ec));!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.SHADER_0=6]="SHADER_0",e[e.SHADER_1=7]="SHADER_1",e[e.SHADER_2=8]="SHADER_2",e[e.SHADER_3=9]="SHADER_3",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COUNT=12]="COUNT"}(lc||(lc=e("dk",{})));var _c=e("dj",new Zs(qs.SUB_MODEL,Uint32Array,lc));function fc(e){return Math.ceil(Math.log2(Math.max(e,2)))}function hc(e,t){switch(e.type){case"boolean":return("number"==typeof t?t:t?1:0)+"";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function dc(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}function vc(e,t,n){for(var i=e.builtins[n],r=e.blocks,o=0;o<i.blocks.length;o++){var a=i.blocks[o],s=t.record[a.name];if(s&&t.bindings[s.binding].descriptorType&Ri){var c=Object.assign({size:mc(s)},s);r.push(c)}else console.warn("builtin UBO '".concat(a.name,"' not available!"))}for(var l=e.samplers,u=0;u<i.samplers.length;u++){var _=i.samplers[u],f=t.record[_.name];f&&t.bindings[f.binding].descriptorType&Oi?l.push(f):console.warn("builtin sampler '".concat(_.name,"' not available!"))}}function mc(e){return e.members.reduce((function(e,t){return e+$n(t.type)*t.count}),0)}function pc(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}var gc=null,yc=e("aj",new(function(){function e(){o(this,e),this._templates={},this._pipelineLayouts={},this._cache={}}return r(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){for(var n=e,i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=fc(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=fc(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);i>31&&(n.uber=!0),n.samplerStartBinding=n.blocks.length,n.bindings=n.blocks.concat(n.samplers);for(var a=0;a<n.blocks.length;a++){var s=n.blocks[a];s.count=1,s.size=mc(s),s.set=Aa.MATERIAL,s.descriptorType||(s.descriptorType=wn.UNIFORM_BUFFER)}for(var c=0;c<n.samplers.length;c++){var l=n.samplers[c];l.set=Aa.MATERIAL,l.descriptorType||(l.descriptorType=wn.SAMPLER)}n.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=Cs(xs.UBO,i.set,i.binding,s.type,o),o+=($n(s.type)>>2)*s.count}for(var c=0;c<e.samplers.length;c++){var l=e.samplers[c];t[l.name]=Cs(xs.SAMPLER,l.set,l.binding,l.type)}return t}(n),this._templates[e.name]=n,this._pipelineLayouts[e.name]={hPipelineLayout:tc,setLayouts:[]}}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"getPipelineLayout",value:function(e){return this._pipelineLayouts[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=a._offset+(c+"|")}}return r+n.hash}for(var l=0,u=0;u<i.length;u++){var _=i[u],f=t[_.name];if(f&&_._map)l|=_._map(f)<<_._offset}return"".concat(l.toString(16),"|").concat(n.hash)}},{key:"destroyShaderByDefines",value:function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(oc.get(t._cache[e]).name)}))})),o=0;o<r.length;o++){var a=r[o],s=oc.get(this._cache[a]);console.log("destroyed shader ".concat(s.name)),s.destroy(),delete this._cache[a]}}},{key:"getGFXShader",value:function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._pipelineLayouts[t];s.hPipelineLayout||(vc(a,i.globalDescriptorSetLayout,"globals"),vc(a,i.localDescriptorSetLayout,"locals"),s.setLayouts[Aa.GLOBAL]=i.descriptorSetLayout,s.setLayouts[Aa.MATERIAL]||(s.setLayouts[Aa.MATERIAL]=e.createDescriptorSetLayout({bindings:a.bindings})),s.setLayouts[Aa.LOCAL]=gc=gc||e.createDescriptorSetLayout({bindings:i.localDescriptorSetLayout.bindings}),s.hPipelineLayout=cc.alloc(e,{setLayouts:s.setLayouts}));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=hc(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=c.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),"")+"\n",u=a.glsl3;switch(e.gfxAPI){case ti.GLES2:case ti.WEBGL:u=a.glsl1;break;case ti.GLES3:case ti.WEBGL2:u=a.glsl3;break;case ti.VULKAN:case ti.METAL:u=a.glsl4;break;default:console.error("Invalid GFX API!")}var _=[];return function(e,t,n){for(var i=e.attributes,r=0;r<i.length;r++){var o=i[r];pc(o.defines,t)&&n.push(o)}}(a,n,_),this._cache[r]=oc.alloc(e,{name:dc(t,c),blocks:a.blocks,samplers:a.samplers,attributes:_,stages:[{stage:bn.VERTEX,source:l+u.vert},{stage:bn.FRAGMENT,source:l+u.frag}]})}}]),e}()));a.programLib=yc;var xc,Sc={memUsage:cn.HOST|cn.DEVICE,usage:sn.UNIFORM,size:0},Cc={buffer:null,offset:0,range:0},Tc={layout:null};!function(e){e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(xc||(xc=e("ah",{})));var Ec=e("ai",function(){function e(t){o(this,e),this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=tc,this._handle=tc,this._root=t,this._device=t.device}return r(e,null,[{key:"fillPipelineInfo",value:function(e,t){void 0!==t.priority&&uc.set(e,ec.PRIORITY,t.priority),void 0!==t.primitive&&uc.set(e,ec.PRIMITIVE,t.primitive),void 0!==t.stage&&uc.set(e,ec.STAGE,t.stage),void 0!==t.dynamicStates&&uc.set(e,ec.DYNAMIC_STATES,t.dynamicStates),void 0!==t.phase&&uc.set(e,ec.PHASE,Ks(t.phase));var n=rc.get(uc.get(e,ec.BLEND_STATE));if(t.blendState){var i=t.blendState;i.targets&&i.targets.forEach((function(e,t){return Object.assign(n.targets[t]||(n.targets[t]=new mi),e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&Object.assign(n.blendColor,i.blendColor)}Object.assign(nc.get(uc.get(e,ec.RASTERIZER_STATE)),t.rasterizerState),Object.assign(ic.get(uc.get(e,ec.DEPTH_STENCIL_STATE)),t.depthStencilState)}},{key:"getPassHash",value:function(e,t){var n,i=t+","+uc.get(e,ec.PRIMITIVE)+","+uc.get(e,ec.DYNAMIC_STATES);return i+=function(e){for(var t,n=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=z(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,".concat(r.blend,",").concat(r.blendEq,",").concat(r.blendAlphaEq,",").concat(r.blendColorMask),n+=",".concat(r.blendSrc,",").concat(r.blendDst,",").concat(r.blendSrcAlpha,",").concat(r.blendDstAlpha)}return n}(rc.get(uc.get(e,ec.BLEND_STATE))),i+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(ic.get(uc.get(e,ec.DEPTH_STENCIL_STATE))),fi(i+=",rs,"+(n=nc.get(uc.get(e,ec.RASTERIZER_STATE))).cullMode+","+n.depthBias+","+n.isFrontFaceCCW,666)}}]),r(e,[{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:on.UNKNOWN,i=this._propertyHandleMap[e];return i?(n?i=ws(i,n):t&&(i=ws(i,Es(i)-t)),i+t):0}},{key:"getBinding",value:function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1}},{key:"setUniform",value:function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._blocks[i];Rs[r](a,n,o),this._rootBufferDirty=!0}},{key:"getUniform",value:function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._blocks[i];return Is[r](a,n,o)}},{key:"setUniformArray",value:function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=$n(r)>>2,a=this._blocks[i],s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Rs[r](a,n[c],s);this._rootBufferDirty=!0}},{key:"bindTexture",value:function(e,t,n){this._descriptorSet.bindTexture(e,t,n)}},{key:"bindSampler",value:function(e,t,n){this._descriptorSet.bindSampler(e,t,n)}},{key:"setDynamicState",value:function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"update",value:function(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}},{key:"destroy",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];Ia(t.set)||this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._handle&&(nc.free(uc.get(this._handle,ec.RASTERIZER_STATE)),ic.free(uc.get(this._handle,ec.DEPTH_STENCIL_STATE)),rc.free(uc.get(this._handle,ec.BLEND_STATE)),ac.free(uc.get(this._handle,ec.DESCRIPTOR_SET)),uc.free(this._handle),this._handle=tc)}},{key:"resetUniform",value:function(t){var n=this.getHandle(t);if(n){var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=this._blocks[r],s=this._properties[t],c=s&&s.value||Ps(i);Rs[i](a,c,o),this._rootBufferDirty=!0}}},{key:"resetTexture",value:function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":Ps(r),l=Ys.get(c),u=l&&l.getGFXTexture(),_=a&&void 0!==a.samplerHash?a.samplerHash:l&&l.getSamplerHash(),f=ta.getSampler(this._device,_);this._descriptorSet.bindSampler(o,f,n),this._descriptorSet.bindTexture(o,u,n)}}},{key:"resetUBOs",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];if(!Ia(t.set))for(var n=this._blocks[t.binding],i=0,r=0;r<t.members.length;r++){for(var o=t.members[r],a=this._properties[o.name],s=a&&a.value,c=s||Ps(o.type),l=($n(o.type)>>2)*o.count,u=0;u+c.length<=l;u+=c.length)n.set(c,i+u);i+=l}}this._rootBufferDirty=!0}},{key:"resetTextures",value:function(){for(var e=0;e<this._shaderInfo.samplers.length;e++){var t=this._shaderInfo.samplers[e];if(!Ia(t.set))for(var n=0;n<t.count;n++)this.resetTexture(t.name,n)}}},{key:"tryCompile",value:function(){var t=this._root.pipeline;return t?(this._syncBatchingScheme(),this._hShaderDefault=yc.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(uc.set(this._handle,ec.PIPELINE_LAYOUT,yc.getPipelineLayout(this._programName).hPipelineLayout),uc.set(this._handle,ec.HASH,e.getPassHash(this._handle,this._hShaderDefault)),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):null}},{key:"getShaderVariant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),tc;if(!e)return this._hShaderDefault;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=yc.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_doInit",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._handle=uc.alloc();uc.set(i,ec.PRIORITY,ga.DEFAULT),uc.set(i,ec.STAGE,pa.DEFAULT),uc.set(i,ec.PHASE,Ks("default")),uc.set(i,ec.PRIMITIVE,_n.TRIANGLE_LIST),uc.set(i,ec.RASTERIZER_STATE,nc.alloc()),uc.set(i,ec.DEPTH_STENCIL_STATE,ic.alloc()),uc.set(i,ec.BLEND_STATE,rc.alloc()),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?Object.assign({},t.defines):t.defines,this._shaderInfo=yc.getTemplate(t.program),this._properties=t.properties||this._properties;var r=this._device;e.fillPipelineInfo(i,t),t.stateOverrides&&e.fillPipelineInfo(i,t.stateOverrides);var o=yc.getPipelineLayout(t.program).setLayouts;o[Aa.MATERIAL]||(o[Aa.MATERIAL]=r.createDescriptorSetLayout({bindings:this._shaderInfo.bindings})),Tc.layout=o[Aa.MATERIAL];var a=ac.alloc(this._device,Tc);uc.set(this._handle,ec.DESCRIPTOR_SET,a),this._descriptorSet=ac.get(a);for(var s=this._shaderInfo.blocks,c=r.uboOffsetAlignment,l=[],u=0,_=0,f=0;f<s.length;f++){var h=s[f],d=h.size,v=h.set;Ia(v)||(l.push(_),_+=Math.ceil(d/c)*c,u=d)}var m=l[l.length-1]+u;m&&(Sc.size=16*Math.ceil(m/16),this._rootBuffer=r.createBuffer(Sc),this._rootBlock=new ArrayBuffer(m));for(var p=0,g=0;p<s.length;p++){var y=s[p],x=y.size,S=y.set,C=y.binding;if(!Ia(S)){Cc.buffer=this._rootBuffer,Cc.offset=l[g++],Cc.range=16*Math.ceil(x/16);var T=this._buffers[C]=r.createBuffer(Cc);this._blocks[C]=new Float32Array(this._rootBlock,Cc.offset,x/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(C,T)}}var E=this._propertyHandleMap=this._shaderInfo.handleMap,A={};for(var b in this._properties){var w=this._properties[b];w.handleInfo&&(A[b]=this.getHandle.apply(this,w.handleInfo))}Object.assign(E,A)}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_INSTANCING?this._device.hasFeature(ni.INSTANCED_ARRAYS)?uc.set(this._handle,ec.BATCHING_SCHEME,xc.INSTANCING):(this._defines.USE_INSTANCING=!1,uc.set(this._handle,ec.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?uc.set(this._handle,ec.BATCHING_SCHEME,xc.VB_MERGING):uc.set(this._handle,ec.BATCHING_SCHEME,0)}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"setLayouts",get:function(){return yc.getPipelineLayout(this._programName).setLayouts}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"handle",get:function(){return this._handle}},{key:"priority",get:function(){return uc.get(this._handle,ec.PRIORITY)}},{key:"primitive",get:function(){return uc.get(this._handle,ec.PRIMITIVE)}},{key:"stage",get:function(){return uc.get(this._handle,ec.STAGE)}},{key:"phase",get:function(){return uc.get(this._handle,ec.PHASE)}},{key:"rasterizerState",get:function(){return nc.get(uc.get(this._handle,ec.RASTERIZER_STATE))}},{key:"depthStencilState",get:function(){return ic.get(uc.get(this._handle,ec.DEPTH_STENCIL_STATE))}},{key:"blendState",get:function(){return rc.get(uc.get(this._handle,ec.BLEND_STATE))}},{key:"dynamicStates",get:function(){return uc.get(this._handle,ec.DYNAMIC_STATES)}},{key:"batchingScheme",get:function(){return uc.get(this._handle,ec.BATCHING_SCHEME)}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return uc.get(this._handle,ec.HASH)}}]),e}());function Ac(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function bc(e,t){return Math.ceil(e/t)*t}Ec.PropertyType=xs,Ec.getPropertyTypeFromHandle=Ts,Ec.getTypeFromHandle=Es,Ec.getBindingFromHandle=As,Ec.getOffsetFromHandle=bs;var wc,Ic,Rc,Oc,Pc,Nc,Dc,zc,Mc,Lc,Fc,kc,Uc,Bc,Gc,jc,Vc=e("ap",function(){function e(t){o(this,e),this._device=void 0,this._format=an.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Wn,this._region1=new Wn,this._region2=new Wn,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}return r(e,[{key:"initialize",value:function(e){var t=Kn[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=ei(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){this._chunks[e].texture.destroy()}this._chunks.length=0,this._handles.length=0}},{key:"alloc",value:function(e,t){e=bc(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Ac(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"createChunk",value:function(e){var t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture({type:Cn.TEX2D,usage:Tn.SAMPLED|Tn.TRANSFER_DST,format:this._format,width:e,height:e,levelCount:1}),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++}},{key:"update",value:function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)}},{key:"_findAvailableSpace",value:function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1}},{key:"_McDonaldAlloc",value:function(e){e=bc(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,Ac(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l}}]),e}()),Hc={},qc=e("b2",A("cc.EffectAsset")((Dc=Nc=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"techniques",Rc,F(n)),R(n,"shaders",Oc,F(n)),R(n,"combinations",Pc,F(n)),n}return c(t,e),r(t,[{key:"onLoaded",value:function(){this.shaders.forEach((function(e){return yc.define(e)})),a.game.once(a.Game.EVENT_ENGINE_INITED,this._precompile,this),t.register(this)}},{key:"_precompile",value:function(){for(var e=this,t=a.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){var i=r[t],o=[n].concat(j(Array(i.length-1)).map((function(){return Object.assign({},n)})));return o.forEach((function(e,n){return e[t]=i[n]})),e.concat(o)}),[])}),[{}]).forEach((function(e){return yc.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)}}],[{key:"register",value:function(e){Hc[e.name]=e}},{key:"remove",value:function(e){if(Hc[e])delete Hc[e];else for(var t in Hc)if(Hc[t]._uuid===e)return void delete Hc[t]}},{key:"get",value:function(e){if(Hc[e])return Hc[e];for(var t in Hc)if(Hc[t]._uuid===e)return Hc[t];return null}},{key:"getAll",value:function(){return Hc}}]),t}(M),Nc._effects={},Rc=b((Ic=Dc).prototype,"techniques",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oc=b(Ic.prototype,"shaders",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pc=b(Ic.prototype,"combinations",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wc=Ic))||wc);a.EffectAsset=qc;var Wc=new Si;Wc.endLayout=Pn.SHADER_READONLY_OPTIMAL;var Xc,Yc,Kc,Qc,Jc,Zc,$c,el,tl,nl={colorAttachments:[Wc],depthStencilAttachment:new Ci},il={width:1,height:1,renderPassInfo:nl},rl=e("b6",(zc=A("cc.RenderTexture"),Mc=J(),Lc=Z(),Fc=J(),kc=Z(),zc((Gc=b((Bc=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_width",Gc,F(n)),R(n,"_height",jc,F(n)),n._window=null,n}return c(t,e),r(t,[{key:"initialize",value:function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){this._window&&(a.director.root.destroyWindow(this._window),this._window=null);return D(u(t.prototype),"destroy",this).call(this)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)}},{key:"getGFXTexture",value:function(){return this._window&&this._window.framebuffer.colorTextures[0]}},{key:"getGFXSampler",value:function(){var e=a.director.root;return ta.getSampler(e.device,Uo)}},{key:"onLoaded",value:function(){this._initWindow(),this.loaded=!0,this.emit("load")}},{key:"_initWindow",value:function(e){var t=a.director.root;il.title=this._name,il.width=this._width,il.height=this._height,il.renderPassInfo=e&&e.passInfo?e.passInfo:nl,this._window?(this._window.destroy(),this._window.initialize(t.device,il)):this._window=t.createWindow(il)}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"window",get:function(){return this._window}}]),t}(M)).prototype,"_width",[w,Mc,Lc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jc=b(Bc.prototype,"_height",[w,Fc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uc=Bc))||Uc));a.RenderTexture=rl;var ol=e("b3",(Xc=A("cc.Material"),Yc=U(qc),Xc((Jc=b((Qc=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"_effectAsset",Jc,F(e)),R(e,"_techIdx",Zc,F(e)),R(e,"_defines",$c,F(e)),R(e,"_states",el,F(e)),R(e,"_props",tl,F(e)),e._passes=[],e._hash=0,e.loaded=!1,e}return c(t,e),r(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}],[{key:"getHash",value:function(e){for(var t,n=0,i=z(e.passes);!(t=i()).done;){n^=t.value.hash}return n}}]),r(t,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=qc.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),D(u(t.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(e,t){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"overridePipelineStates",value:function(e,t){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=z(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}}},{key:"setProperty",value:function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: ".concat(n,"."));var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=Object.assign({},e._defines[n]);this._states.length=e._states.length;for(var i=0;i<e._states.length;i++)this._states[i]=Object.assign({},e._states[i]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var n=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(n).fill(e)}for(var i=0;i<e.length;++i)Object.assign(t[i]||(t[i]={}),e[i])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,s=r.defines=this._defines[o]||(this._defines[o]={}),c=r.stateOverrides=this._states[o]||(this._states[o]={});if(void 0!==r.propertyIndex&&(Object.assign(s,this._defines[r.propertyIndex]),Object.assign(c,this._states[r.propertyIndex])),void 0!==r.embeddedMacros&&Object.assign(s,r.embeddedMacros),!r.switch||s[r.switch]){var l=new Ec(a.director.root);l.initialize(r),n.push(l)}}return n}},{key:"_update",value:function(){var e=this,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length)for(var i,r=z(this._passes);!(i=r()).done;){var o=i.value;o.destroy()}this._passes=this._createPasses();var a=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=a,n)this._passes.forEach((function(t,n){var i=e._props[n];for(var r in i||(i=e._props[n]={}),i=e._props[t.propertyIndex])e._uploadProperty(t,r,i[r])}));else for(var s=0;s<this._props.length;s++)this._props[s]={}}else{var c=Ys.get("missing-effect-material");c&&(this._passes=c._passes.slice())}this._hash=t.getHash(this)}},{key:"_uploadProperty",value:function(e,t,n){var i=e.getHandle(t);if(!i)return!1;var r=Ec.getPropertyTypeFromHandle(i);if(r===xs.UBO)Array.isArray(n)?e.setUniformArray(i,n):null!==n?e.setUniform(i,n):e.resetUniform(t);else if(r===xs.SAMPLER)if(Array.isArray(n))for(var o=0;o<n.length;o++)this._bindTexture(e,i,n[o],o);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0}},{key:"_bindTexture",value:function(e,t,n,i){var r=Ec.getBindingFromHandle(t);if(n instanceof Ii)e.bindTexture(r,n,i);else if(n instanceof ia||n instanceof Bs||n instanceof rl){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return!1;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length)for(var e,t=z(this._passes);!(e=t()).done;){e.value.destroy()}this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}]),t}(M)).prototype,"_effectAsset",[Yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zc=b(Qc.prototype,"_techIdx",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$c=b(Qc.prototype,"_defines",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),el=b(Qc.prototype,"_states",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tl=b(Qc.prototype,"_props",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kc=Qc))||Kc));a.Material=ol;var al,sl=e("ar",function(e){function t(e,n){var i;o(this,t),(i=l(this,u(t).call(this,e.root)))._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var a=i._shaderInfo.blocks[r];if(!Ia(a.set)){var s=i._blocks[a.binding],c=i._parent.blocks[a.binding];s.set(c)}}i._rootBufferDirty=!0;for(var _=i._parent,f=0;f<i._shaderInfo.samplers.length;f++){var h=i._shaderInfo.samplers[f];if(!Ia(h.set))for(var d=0;d<h.count;d++){var v=_._descriptorSet.getSampler(h.binding,d),m=_._descriptorSet.getTexture(h.binding,d);i._descriptorSet.bindSampler(h.binding,v,d),i._descriptorSet.bindTexture(h.binding,m,d)}}return D(u(t.prototype),"tryCompile",F(i)).call(F(i)),i}return c(t,e),r(t,[{key:"parent",get:function(){return this._parent}}]),r(t,[{key:"overridePipelineStates",value:function(e,t){rc.free(uc.get(this._handle,ec.BLEND_STATE)),nc.free(uc.get(this._handle,ec.RASTERIZER_STATE)),ic.free(uc.get(this._handle,ec.DEPTH_STENCIL_STATE)),uc.set(this._handle,ec.BLEND_STATE,rc.alloc()),uc.set(this._handle,ec.RASTERIZER_STATE,nc.alloc()),uc.set(this._handle,ec.DEPTH_STENCIL_STATE,ic.alloc()),Ec.fillPipelineInfo(this._handle,e),Ec.fillPipelineInfo(this._handle,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!Ns(this._defines,e))return!1;var n=D(u(t.prototype),"tryCompile",this).call(this);return this._onStateChange(),n}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,uc.set(this._handle,ec.BATCHING_SCHEME,0)}},{key:"_onStateChange",value:function(){uc.set(this._handle,ec.HASH,Ec.getPassHash(this._handle,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}]),t}(Ec)),cl=e("aq",function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this)))._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}return c(t,e),r(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),r(t,[{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=z(this._passes);!(n=i()).done;){n.value.tryCompile(e)}else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=ol.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new sl(t[n],this));return e}}]),t}(ol));!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed"}(al||(al=e("bg",{}))),_(al),a.SystemEventType=al;var ll=new Y,ul=e("bb",function(e){function t(e,n,i){var r;return o(this,t),(r=l(this,u(t).call(this,$.MOUSE,n))).movementX=0,r.movementY=0,r.eventType=void 0,r._button=t.BUTTON_MISSING,r._x=0,r._y=0,r._prevX=0,r._prevY=0,r._scrollX=0,r._scrollY=0,r.eventType=e,i&&(r._prevX=i.x,r._prevY=i.y),r}return c(t,e),r(t,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new Y),Y.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new Y),Y.set(e,this._x,a.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new Y),Y.set(e,this._x,this._y),a.view._convertPointWithScale(e),e}},{key:"getPreviousLocation",value:function(e){return e||(e=new Y),Y.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Y),Y.set(e,this._prevX,this._prevY),a.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Y),Y.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new Y),Y.set(e,(this._x-this._prevX)/a.view.getScaleX(),(this._y-this._prevY)/a.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/a.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/a.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=a.view.getViewportRect();return(this._x-e.x)/a.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=a.view.getViewportRect();return(this._y-e.y)/a.view.getScaleY()}}]),t}($));ul.NONE=0,ul.DOWN=1,ul.UP=2,ul.MOVE=3,ul.SCROLL=4,ul.BUTTON_MISSING=-1,ul.BUTTON_LEFT=0,ul.BUTTON_RIGHT=2,ul.BUTTON_MIDDLE=1,ul.BUTTON_4=3,ul.BUTTON_5=4,ul.BUTTON_6=5,ul.BUTTON_7=6,ul.BUTTON_8=7;var _l=e("bc",function(e){function t(e,n,i,r){var a;return o(this,t),(a=l(this,u(t).call(this,$.TOUCH,n))).touch=null,a.simulate=!1,a._eventCode=void 0,a._touches=void 0,a._allTouches=void 0,a._eventCode=i||0,a._touches=e||[],a._allTouches=r||[],a}return c(t,e),r(t,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"getAllTouches",value:function(){return this._allTouches}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Y}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new Y}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Y}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Y}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Y}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new Y}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Y}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new Y}},{key:"getDeltaX",value:function(){return this.touch?this.touch.getDelta(ll).x:0}},{key:"getDeltaY",value:function(){return this.touch?this.touch.getDelta(ll).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),t}($));_l.MAX_TOUCHES=5,_l.BEGAN=0,_l.MOVED=1,_l.ENDED=2,_l.CANCELLED=3;var fl=e("bd",function(e){function t(e,n){var i;return o(this,t),(i=l(this,u(t).call(this,$.ACCELERATION,n))).acc=void 0,i.acc=e,i}return c(t,e),t}($)),hl=e("be",function(e){function t(e,n,i){var r;return o(this,t),(r=l(this,u(t).call(this,$.KEYBOARD,i))).keyCode=void 0,r.rawEvent=void 0,r.isPressed=void 0,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r.isPressed=n,r}return c(t,e),t}($));$.EventMouse=ul,$.EventTouch=_l,$.EventAcceleration=fl,$.EventKeyboard=hl;var dl=e("d9",function(){function e(t,n,i){o(this,e),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=t||0,this._listenerID=n||""}return r(e,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){ee(e&&e.event,1900);var t=e.event;delete e.event;var n=null;if(t===a.EventListener.TOUCH_ONE_BY_ONE?n=new pl:t===a.EventListener.TOUCH_ALL_AT_ONCE?n=new gl:t===a.EventListener.MOUSE?n=new ml:t===a.EventListener.KEYBOARD?n=new xl:t===a.EventListener.ACCELERATION&&(n=new yl(e.callback),delete e.callback),n)for(var i=0,r=Object.keys(e);i<r.length;i++){var o=r[i];n[o]=e[o]}return n}}]),r(e,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),e}());dl.UNKNOWN=0,dl.TOUCH_ONE_BY_ONE=1,dl.TOUCH_ALL_AT_ONCE=2,dl.KEYBOARD=3,dl.MOUSE=4,dl.ACCELERATION=6,dl.CUSTOM=8,dl.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var vl=dl.ListenerID,ml=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,dl.MOUSE,vl.MOUSE,null))).onMouseDown=null,e.onMouseUp=null,e.onMouseMove=null,e.onMouseScroll=null,e._onEvent=function(t){return e._callback(t)},e}return c(t,e),r(t,[{key:"_callback",value:function(e){var t=a.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),t}(dl),pl=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,dl.TOUCH_ONE_BY_ONE,vl.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return c(t,e),r(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(te(1801),!1)}}]),t}(dl),gl=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,dl.TOUCH_ALL_AT_ONCE,vl.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return c(t,e),r(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(te(1802),!1)}}]),t}(dl),yl=function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,dl.ACCELERATION,vl.ACCELERATION,null)))._onAccelerationEvent=null,n._onEvent=function(e){return n._callback(e)},n._onAccelerationEvent=e,n}return c(t,e),r(t,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return ee(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new t(this._onAccelerationEvent)}}]),t}(dl),xl=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this,dl.KEYBOARD,vl.KEYBOARD,null))).onKeyPressed=null,e.onKeyReleased=null,e._onEvent=function(t){return e._callback(t)},e}return c(t,e),r(t,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(te(1800),!1)}}]),t}(dl);a.EventListener=dl;var Sl=dl.ListenerID;var Cl=function(){function e(){o(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return r(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var Tl=e("b9",new(function(){function e(){o(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}return r(e,[{key:"pauseTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof a._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var i=0;i<n.length;++i){var r=n[i];r._setPaused(!0)}if(!0===t){var o=e.children;if(o)for(var s=0;s<o.length;++s){var c=o[s];this.pauseTarget(c,!0)}}}else N(3506)}},{key:"resumeTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof a._BaseNode){var n=this._nodeListenersMap[e.uuid];if(n)for(var i=0;i<n.length;++i){var r=n[i];r._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var o=e.children;if(o)for(var s=0;s<o.length;++s){var c=o[s];this.resumeTarget(c,!0)}}}else N(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var n in e)e[n].empty()&&(delete t[n],delete e[n]);var i=this._toAddedListeners;if(0!==i.length){for(var r=0,o=i.length;r<o;r++)this._forceAddEventListener(i[r]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(ee(e&&t,3503),a.js.isNumber(t)||t instanceof a._BaseNode){if(e instanceof a.EventListener){if(e._isRegistered())return void te(3505)}else ee(!a.js.isNumber(t),3504),e=a.EventListener.create(e);if(e.checkAvailable()){if(a.js.isNumber(t)){if(0===t)return void te(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(n=t)||!n.getComponent("cc.UITransform"))return void te(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var n;return e}}else N(3506)}},{key:"addCustomListener",value:function(e,t){var n=dl.create({event:a.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(n,1),n}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,n=this._listenersMap;for(var i in n){var r=n[i],o=r.getFixedPriorityListeners(),s=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(s,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(o,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete n[i]),t)break}if(!t)for(var c=this._toAddedListeners,l=c.length-1;l>=0;l--){var u=c[l];if(u===e){a.js.array.removeAt(c,l),u._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(a.js.isNumber(e)||e instanceof a._BaseNode)if(void 0!==e._id){var n=this._nodeListenersMap[e._id];if(n){for(var i=a.js.array.copy(n),r=0;r<i.length;++r){var o=i[r];this.removeListener(o)}delete this._nodeListenersMap[e._id]}for(var s=this._toAddedListeners,c=0;c<s.length;){var l=s[c];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),s.splice(c,1)):++c}if(!0===t)for(var u=e.getChildren(),_=0;_<u.length;++_){var f=u[_];this.removeListeners(f,!0)}}else e===a.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Sl.TOUCH_ONE_BY_ONE):e===a.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Sl.TOUCH_ALL_AT_ONCE):e===a.EventListener.MOUSE?this._removeListenersForListenerID(Sl.MOUSE):e===a.EventListener.ACCELERATION?this._removeListenersForListenerID(Sl.ACCELERATION):e===a.EventListener.KEYBOARD?this._removeListenersForListenerID(Sl.KEYBOARD):te(3501);else N(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var n in e)-1===t.indexOf(n)&&this._removeListenersForListenerID(n)}},{key:"setPriority",value:function(e,t){if(null!=e){var n=this._listenersMap;for(var i in n){var r=n[i].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&te(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(a.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=$,n=e.type;return n===t.ACCELERATION?Sl.ACCELERATION:n===t.KEYBOARD?Sl.KEYBOARD:n.startsWith(t.MOUSE)?Sl.MOUSE:(n.startsWith(t.TOUCH)&&te(2e3),"")}(e);this._sortEventListeners(t);var n=this._listenersMap[t];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,e),this._onUpdateListeners(n)),this._inDispatch--}else k(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var n=e.onEvent;return n&&n(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var n=new a.Event.EventCustom(e);n.setUserData(t),this.dispatchEvent(n)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var n=0,i=t.length;n<i;n++){var r=t[n]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var o=e.children,a=0,s=o?o.length:0;a<s;a++)this._setDirtyForNode(o[a])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),n=this._listenersMap[t];if(n||(n=new Cl,this._listenersMap[t]=n),n.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var i=e._getSceneGraphPriority();null===i&&te(3507),this._associateNodeAndEventListener(i,e),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,n=e.length-1;n>=0;n--)(t=e[n])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&a.js.array.removeAt(e,n)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners(),i=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(i),this._removeAllListenersInVector(n),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,o=r.length-1;o>=0;o--){var s=r[o];s&&s._getListenerID()===e&&a.js.array.removeAt(r,o)}}},{key:"_sortEventListeners",value:function(e){var t=0,n=this._priorityDirtyFlagMap;(n[e]&&(t=n[e]),0!==t)&&(n[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&a.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var n=t.getSceneGraphPriorityListeners();n&&0!==n.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var n=e._getSceneGraphPriority(),i=t._getSceneGraphPriority();if(!(t&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return 1;var r=n,o=i,a=!1,s=n._uiProps.uiTransformComp,c=i._uiProps.uiTransformComp;if(s.visibility!==c.visibility)return c.visibility-s.visibility;for(;r.parent._id!==o.parent._id;)r=null===r.parent.parent?(a=!0)&&i:r.parent,o=null===o.parent.parent?(a=!0)&&n:o.parent;if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var l=r.getSiblingIndex(),u=o.getSiblingIndex();return a?l-u:u-l}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var n=t.getFixedPriorityListeners();if(n&&0!==n.length){n.sort(this._sortListenersOfFixedPriorityAsc);for(var i=0,r=n.length;i<r&&!(n[i]._getFixedPriority()>=0);)++i;t.gt0Index=i}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners(),i=this._toRemovedListeners;if(n)for(var r=n.length-1;r>=0;r--){var o=n[r];if(!o._isRegistered()){a.js.array.removeAt(n,r);var s=i.indexOf(o);-1!==s&&i.splice(s,1)}}if(t)for(var c=t.length-1;c>=0;c--){var l=t[c];if(!l._isRegistered()){a.js.array.removeAt(t,c);var u=i.indexOf(l);-1!==u&&i.splice(u,1)}}n&&0===n.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(ee(t>0,3508),!(t>1)){var n;(n=this._listenersMap[Sl.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(n),(n=this._listenersMap[Sl.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(n),ee(1===t,3509);var i=this._toAddedListeners;if(0!==i.length){for(var r=0,o=i.length;r<o;r++)this._forceAddEventListener(i[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var n=e[t],i=this._listenersMap[n._getListenerID()];if(i){var r=i.getFixedPriorityListeners(),o=i.getSceneGraphPriorityListeners();if(o){var a=o.indexOf(n);-1!==a&&o.splice(a,1)}if(r){var s=r.indexOf(n);-1!==s&&r.splice(s,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=n.touch;n.currentTarget=e._getSceneGraphPriority();var r=!1,o=-1,a=n.getEventCode();if(a===_l.BEGAN){if(!oa.ENABLE_MULTI_TOUCH&&Tl._currentTouch){var s=Tl._currentTouchListener._node;if(!s||s.activeInHierarchy)return!1}e.onTouchBegan&&(r=e.onTouchBegan(i,n))&&e._isRegistered()&&(e._claimedTouches.push(i),!oa.ENABLE_MULTI_TOUCH&&Tl._currentTouch||(Tl._currentTouch=i),Tl._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(o=e._claimedTouches.indexOf(i))){if(r=!0,!oa.ENABLE_MULTI_TOUCH&&Tl._currentTouch&&Tl._currentTouch!==i)return!1;a===_l.MOVED&&e.onTouchMoved?e.onTouchMoved(i,n):a===_l.ENDED?(e.onTouchEnded&&e.onTouchEnded(i,n),e._isRegistered()&&e._claimedTouches.splice(o,1),(oa.ENABLE_MULTI_TOUCH||Tl._currentTouch===i)&&(Tl._currentTouch=null),Tl._currentTouchListener=null):a===_l.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(i,n),e._isRegistered()&&e._claimedTouches.splice(o,1),(oa.ENABLE_MULTI_TOUCH||Tl._currentTouch===i)&&(Tl._currentTouch=null),Tl._currentTouchListener=null)}return n.isStopped()?(Tl._updateTouchListeners(n),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(i,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(Sl.TOUCH_ONE_BY_ONE),this._sortEventListeners(Sl.TOUCH_ALL_AT_ONCE);var t=this._getListeners(Sl.TOUCH_ONE_BY_ONE),n=this._getListeners(Sl.TOUCH_ALL_AT_ONCE);if(null!==t||null!==n){var i=e.getTouches(),r=a.js.array.copy(i),o={event:e,needsMutableSet:t&&n,touches:r,selTouch:null};if(t)for(var s=0;s<i.length;++s){var c=i[s];e.touch=c,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,o)}n&&r.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var n=t.event,i=t.touches,r=n.getEventCode();return n.currentTarget=e._getSceneGraphPriority(),r===_l.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(i,n):r===_l.MOVED&&e.onTouchesMoved?e.onTouchesMoved(i,n):r===_l.ENDED&&e.onTouchesEnded?e.onTouchesEnded(i,n):r===_l.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(i,n),!!n.isStopped()&&(Tl._updateTouchListeners(n),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var n=this._nodeListenersMap[e.uuid];n||(n=[],this._nodeListenersMap[e.uuid]=n),n.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var n=this._nodeListenersMap[e.uuid];n&&(a.js.array.remove(n,t),0===n.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,n){var i=!1,r=e.getFixedPriorityListeners(),o=e.getSceneGraphPriorityListeners(),a=0;if(r&&0!==r.length)for(;a<e.gt0Index;++a){var s=r[a];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,n)){i=!0;break}}if(o&&!i)for(var c=0;c<o.length;++c){var l=o[c];if(l.isEnabled()&&!l._isPaused()&&l._isRegistered()&&t(l,n)){i=!0;break}}if(r&&!i)for(;a<r.length;++a){var u=r[a];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,n)){i=!0;break}}}},{key:"_setDirty",value:function(e,t){var n=this._priorityDirtyFlagMap;null==n[e]?n[e]=t:n[e]=t|n[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var i=e[n];if(i._onCustomEvent===t||i.onEvent===t)return i._setRegistered(!1),null!=i._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(i._getSceneGraphPriority(),i),i._setSceneGraphPriority(null)),0===this._inDispatch?a.js.array.removeAt(e,n):this._toRemovedListeners.push(i),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var n=e.length-1;n>=0;n--){var i=e[n];if(i===t)return i._setRegistered(!1),null!=i._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(i._getSceneGraphPriority(),i),i._setSceneGraphPriority(null)),0===this._inDispatch?a.js.array.removeAt(e,n):this._toRemovedListeners.push(i),!0}return!1}}]),e}()));a.eventManager=Tl;ne.Flags.Destroying;var El=new Array(16),Al=null,bl=new Y,wl=[al.TOUCH_START.toString(),al.TOUCH_MOVE.toString(),al.TOUCH_END.toString(),al.TOUCH_CANCEL.toString()],Il=[al.MOUSE_DOWN.toString(),al.MOUSE_ENTER.toString(),al.MOUSE_MOVE.toString(),al.MOUSE_LEAVE.toString(),al.MOUSE_UP.toString(),al.MOUSE_WHEEL.toString()];function Rl(e,t){var n=this.owner;return!(!n||!n._uiProps.uiTransformComp)&&(e.getUILocation(bl),!!n._uiProps.uiTransformComp.isHit(bl,this)&&(t.type=al.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t),!0))}function Ol(e,t){var n=this.owner;if(!n||!n._uiProps.uiTransformComp)return!1;t.type=al.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t)}function Pl(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(e.getUILocation(bl),n._uiProps.uiTransformComp.isHit(bl,this)?t.type=al.TOUCH_END.toString():t.type=al.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function Nl(e,t){var n=this.owner;n&&n._uiProps.uiTransformComp&&(t.type=al.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,n.dispatchEvent(t))}function Dl(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(bl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(bl,this)&&(e.type=al.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function zl(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if(bl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(bl,this))this._previousIn||(Al&&Al.eventProcessor.mouseListener&&(e.type=al.MOUSE_LEAVE,Al.dispatchEvent(e),Al.eventProcessor.mouseListener&&(Al.eventProcessor.mouseListener._previousIn=!1)),Al=t,e.type=al.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=al.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=al.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,Al=null}e.propagationStopped=!0}}function Ml(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(bl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(bl,this)&&(e.type=al.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Ll(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(bl=e.getUILocation(),t._uiProps.uiTransformComp.isHit(bl,this)&&(e.type=al.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Fl(e){var t=a.Mask;if(t)for(var n=0,i=e;i&&a.Node.isNode(i);i=i.parent,++n)if(i.getComponent(t))return{index:n,node:i};return null}function kl(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.bubblingTargets.hasEventListener(t[n]))return!0;if(e.eventProcessor.capturingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}return!0}var Ul,Bl,Gl,jl,Vl,Hl,ql,Wl,Xl,Yl=function(){function e(t){o(this,e),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}return r(e,[{key:"node",get:function(){return this._node}}]),r(e,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=Fl(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=Fl(this._node))}},{key:"destroy",value:function(){Al===this._node&&(Al=null),(this.touchListener||this.mouseListener)&&(Tl.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}},{key:"on",value:function(e,t,n,i){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,n,i):(this.bubblingTargets||(this.bubblingTargets=new ie),this.bubblingTargets.on(e,t,n))}},{key:"once",value:function(e,t,n,i){var r,o=this;(r=this._checknSetupSysEvent(e)&&i?this.capturingTargets=this.capturingTargets||new ie:this.bubblingTargets=this.bubblingTargets||new ie).on(e,t,n,!0),r.on(e,(function(){o.off(e,t,n)}),void 0,!0)}},{key:"off",value:function(e,t,n,i){var r=-1!==wl.indexOf(e),o=!r&&-1!==Il.indexOf(e);r||o?(this._offDispatch(e,t,n,i),r?this.touchListener&&!kl(this._node,wl)&&(Tl.removeListener(this.touchListener),this.touchListener=null):o&&this.mouseListener&&!kl(this._node,Il)&&(Tl.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,n)}},{key:"emit",value:function(e,t,n,i,r,o){this.bubblingTargets&&this.bubblingTargets.emit(e,t,n,i,r,o)}},{key:"dispatchEvent",value:function(e){!function(e,t){var n,i=0;for(t.target=e,El.length=0,e.eventProcessor.getCapturingTargets(t.type,El),t.eventPhase=1,i=El.length-1;i>=0;--i)if((n=El[i]).eventProcessor.capturingTargets&&(t.currentTarget=n,n.eventProcessor.capturingTargets.emit(t.type,t,El),t.propagationStopped))return void(El.length=0);if(El.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,El),t.eventPhase=3,i=0;i<El.length;++i)if((n=El[i]).eventProcessor.bubblingTargets&&(t.currentTarget=n,n.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(El.length=0);El.length=0}(this._node,e),El.length=0}},{key:"hasEventListener",value:function(e,t,n){var i=!1;return this.bubblingTargets&&(i=this.bubblingTargets.hasEventListener(e,t,n)),!i&&this.capturingTargets&&(i=this.capturingTargets.hasEventListener(e,t,n)),i}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!kl(this.node,wl)&&(Tl.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!kl(this.node,Il)&&(Tl.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.capturingTargets&&n.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(n),n=n.parent}},{key:"getBubblingTargets",value:function(e,t){for(var n=this._node.parent;n;)n.eventProcessor.bubblingTargets&&n.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(n),n=n.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,n=!1,i=!1;return-1!==wl.indexOf(e)?(this.touchListener||(this.touchListener=a.EventListener.create({event:a.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:Fl(this._node),onTouchBegan:Rl,onTouchMoved:Ol,onTouchEnded:Pl,onTouchCancelled:Nl}),Tl.addListener(this.touchListener,this._node),n=!0),i=!0):-1!==Il.indexOf(e)&&(this.mouseListener||(this.mouseListener=a.EventListener.create({event:a.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:Fl(this._node),onMouseDown:Dl,onMouseMove:zl,onMouseUp:Ml,onMouseScroll:Ll}),Tl.addListener(this.mouseListener,this._node),n=!0),i=!0),n&&!this._node.activeInHierarchy&&a.director.getScheduler().schedule((function(){t._node.activeInHierarchy||Tl.pauseTarget(t._node)}),this._node,0,0,0,!1),i}},{key:"_onDispatch",value:function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var r=null;return(r=i?this.capturingTargets=this.capturingTargets||new ie:this.bubblingTargets=this.bubblingTargets||new ie).hasEventListener(e,t,n)||r.on(e,t,n),t}k(6800)}},{key:"_offDispatch",value:function(e,t,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,t){var r=i?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,n)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),e}();a.NodeEventProcessor=Yl;var Kl=ne.Flags.Destroying,Ql=ne.Flags.DontDestroy,Jl=ne.Flags.Deactivating,Zl=(ne.Flags.Activating,new L("Node"));function $l(e){return e?"string"==typeof e?fe(e):e:(k(3804),null)}var eu,tu,nu,iu,ru,ou,au,su,cu,lu,uu,_u,fu,hu,du,vu,mu,pu,gu=e("cW",A("cc.BaseNode")((Xl=Wl=function(e){function t(e){var n;return o(this,t),n=l(this,u(t).call(this,e)),R(n,"_parent",Gl,F(n)),R(n,"_children",jl,F(n)),R(n,"_active",Vl,F(n)),R(n,"_components",Hl,F(n)),R(n,"_prefab",ql,F(n)),n._scene=null,n._activeInHierarchy=!1,n._id=Zl.getNewId(),n._name=void 0,n._eventProcessor=new Yl(F(n)),n._eventMask=0,n._siblingIndex=0,n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return c(t,e),r(t,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&Ql)>0},set:function(e){e?this._objFlags|=Ql:this._objFlags&=~Ql}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&a.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof a.Scene?e._scene=e:null==e._parent?re("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null}},{key:"_findComponents",value:function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}}},{key:"_findChildComponent",value:function(e,n){for(var i=0;i<e.length;++i){var r=e[i],o=t._findComponent(r,n);if(o)return o;if(r._children.length>0&&(o=t._findChildComponent(r._children,n)))return o}return null}},{key:"_findChildComponents",value:function(e,n,i){for(var r=0;r<e.length;++r){var o=e[r];t._findComponents(o,n,i),o._children.length>0&&t._findChildComponents(o._children,n,i)}}}]),r(t,[{key:"attr",value:function(e){oe(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(al.PARENT_CHANGED,n),n&&!(n._objFlags&Kl)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(al.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(al.CHILD_ADDED,this)),this._onHierarchyChanged(n)}}},{key:"getChildByUuid",value:function(e){if(!e)return ae("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null}},{key:"getChildByName",value:function(e){if(!e)return ae("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null}},{key:"getChildByPath",value:function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);switch(o){case"continue":continue;default:if("object"===se(o))return o.v}}return n}},{key:"addChild",value:function(e){ee(e,1606),ee(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Jl)k(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,n){var i=1,r=null,o=null,a=0,s=t._stacks[t._stackId];s||(s=[],t._stacks.push(s)),t._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&n&&n(o),s[i]=null,l){if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,t._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var n=$l(e);return n?t._findComponent(this,n):null}},{key:"getComponents",value:function(e){var n=$l(e),i=[];return n&&t._findComponents(this,n,i),i}},{key:"getComponentInChildren",value:function(e){var n=$l(e);return n?t._findChildComponent(this._children,n):null}},{key:"getComponentsInChildren",value:function(e){var n=$l(e),i=[];return n&&(t._findComponents(this,n,i),t._findChildComponents(this._children,n,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=fe(e)))throw a._RF.peek()&&k(3808,e),TypeError(ce(3807,e))}else{if(!e)throw TypeError(ce(3804));t=e}if("function"!=typeof t)throw TypeError(ce(3809));if(!le(t,a.Component))throw TypeError(ce(3810));var n=t._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);var i=new t;return i.node=this,this._components.push(i),this._activeInHierarchy&&a.director._nodeActivator.activateComp(i),i}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof ue?e:this.getComponent(e))&&t.destroy()}else k(3813)}},{key:"on",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case al.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)}},{key:"off",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._eventProcessor.off(e,t,n,i);var r=this._eventProcessor.hasEventListener(e);if(!r)switch(e){case al.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,n,i){this._eventProcessor.once(e,t,n,i)}},{key:"emit",value:function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(al.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!D(u(t.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Kl)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&k(3815)}}else k(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk((function(e){t._setScene(e)})))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=a.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof a.Scene||a.game.removePersistRootNode(this);var n=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==n&&a.director._nodeActivator.activateNode(this,n)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Kl;var e=this._parent,t=!!e&&0!=(e._objFlags&Kl);if(!t&&_e&&this._registerIfAttached(!1),this._persistNode&&a.game.removePersistRootNode(this),!t&&e){this.emit(al.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e.emit&&e.emit(al.CHILD_REMOVED,this)}this.emit(al.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,s=0;s<o.length;++s)o[s]._destroyImmediate();return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var n=e[t];n._enabled&&a.director._compScheduler.disableComp(n)}for(var i=this._children,r=0;r<i.length;++r){var o=i[r];o._active&&o._disableChildComps()}}}]),t}(ne),Wl.idGenerator=Zl,Wl._stacks=[[]],Wl._stackId=0,b((Bl=Xl).prototype,"_persistNode",[i],Object.getOwnPropertyDescriptor(Bl.prototype,"_persistNode"),Bl.prototype),b(Bl.prototype,"name",[I],Object.getOwnPropertyDescriptor(Bl.prototype,"name"),Bl.prototype),b(Bl.prototype,"children",[I],Object.getOwnPropertyDescriptor(Bl.prototype,"children"),Bl.prototype),b(Bl.prototype,"active",[I],Object.getOwnPropertyDescriptor(Bl.prototype,"active"),Bl.prototype),b(Bl.prototype,"activeInHierarchy",[I],Object.getOwnPropertyDescriptor(Bl.prototype,"activeInHierarchy"),Bl.prototype),b(Bl.prototype,"parent",[I],Object.getOwnPropertyDescriptor(Bl.prototype,"parent"),Bl.prototype),Gl=b(Bl.prototype,"_parent",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jl=b(Bl.prototype,"_children",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vl=b(Bl.prototype,"_active",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hl=b(Bl.prototype,"_components",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ql=b(Bl.prototype,"_prefab",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ul=Bl))||Ul);a._BaseNode=gu,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(eu||(eu={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(tu||(tu=e("dS",{}))),a.internal.TransformBit=tu;var yu,xu,Su,Cu,Tu,Eu,Au,bu,wu,Iu,Ru,Ou,Pu,Nu,Du,zu,Mu,Lu=new Y,Fu=new Y,ku=new f,Uu=new f,Bu=new f,Gu=new f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),ju=new K,Vu=e("dc",(nu=A("cc.UITransform"),iu=de(),ru=dt(110),ou=ve(),au=me(),su=pe(),cu=me(),lu=pe(),uu=pe(),nu(_u=iu(_u=ru(_u=ou(_u=he((pu=mu=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_priority",hu,F(n)),n._canvas=null,R(n,"_contentSize",du,F(n)),R(n,"_anchorPoint",vu,F(n)),n}return c(t,e),r(t,[{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onEnable",value:function(){this._updateVisibility(),this.node.on(al.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this.node.off(al.PARENT_CHANGED,this._parentChanged,this),this._canvas=null}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(al.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(al.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var n=this._contentSize.width,i=this._contentSize.height,r=Lu,o=Fu,s=this._canvas;if(s){s.node.getWorldRT(ku);var c=ku.m12,l=ku.m13,u=a.visibleRect.center;if(ku.m12=u.x-(ku.m00*c+ku.m04*l),ku.m13=u.y-(ku.m01*c+ku.m05*l),f.invert(ku,ku),Y.transformMat4(r,e,ku),this.node.getWorldMatrix(Bu),f.invert(ku,Bu),f.strictEquals(ku,Gu))return!1;if(Y.transformMat4(o,r,ku),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i,o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i){if(t&&t.mask){for(var _=t.mask,h=this.node,d=0;h&&d<_.index;++d,h=h.parent);if(h===_.node){var v=h.getComponent(a.Mask);return!v||!v.enabledInHierarchy||v.isHit(r)}return t.mask=null,!0}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(Bu),f.invert(ku,Bu),t||(t=new s),s.transformMat4(t,e,ku)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(Bu),t||(t=new s),s.transformMat4(t,e,Bu)}},{key:"getBoundingBox",value:function(){f.fromRTS(Uu,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new K(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(Uu),n}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(Bu),this.getBoundingBoxTo(Bu)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){f.fromRTS(Uu,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new K(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(f.multiply(Bu,e,Uu),r.transformMat4(Bu),!this.node.children)return r;for(var o,a=this.node.children,s=z(a);!(o=s()).done;){var c=o.value;if(c&&c.active){var l=c.getComponent(t);if(l){var u=l.getBoundingBoxTo(e);u&&K.union(r,r,u)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,n=this._contentSize.height;ju.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),ju.transformMat4(this.node.worldMatrix);var i=ju.x+.5*ju.width,r=ju.y+.5*ju.height,o=this.node.worldPosition.z,a=ju.width/2,s=ju.height/2;if(null==e)return new Wr(i,r,o,a,s,.001);Wr.set(e,i,r,o,a,s,.001)}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent("cc.Canvas");if(t){this._canvas=t;break}}e=e.parent}}},{key:"_parentChanged",value:function(e){this._canvas&&this._canvas.node===this.node||this._sortSiblings()}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n.priority:0)-(i?i.priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r})),this.node.parent._updateSiblingIndex())}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(al.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(al.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(al.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(al.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(al.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(al.ANCHOR_CHANGED,this._anchorPoint))}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?N(9200):(this._priority=e,this._sortSiblings()))}},{key:"visibility",get:function(){return this._canvas?this._canvas.visibility:-1}}]),t}(ue),mu.EventType=al,b((fu=pu).prototype,"contentSize",[au,su],Object.getOwnPropertyDescriptor(fu.prototype,"contentSize"),fu.prototype),b(fu.prototype,"anchorPoint",[cu,lu],Object.getOwnPropertyDescriptor(fu.prototype,"anchorPoint"),fu.prototype),b(fu.prototype,"priority",[uu],Object.getOwnPropertyDescriptor(fu.prototype,"priority"),fu.prototype),hu=b(fu.prototype,"_priority",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),du=b(fu.prototype,"_contentSize",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q(100,100)}}),vu=b(fu.prototype,"_anchorPoint",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Y(.5,.5)}}),_u=fu))||_u)||_u)||_u)||_u)||_u)),Hu=function(){function e(t){o(this,e),this.uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}return r(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(Vu)),this._uiTransformComp},set:function(e){this._uiTransformComp=e}}]),e}(),qu=new s,Wu=new X,Xu=new X,Yu=new Array(10),Ku=new X,Qu=new h,Ju=new h,Zu=new f,$u=new Map,e_=e("cX",(yu=A("cc.Node"),xu=U(s),yu((Ru=Iu=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._uiProps=new Hu(F(n)),n._static=!1,n._pos=new s,n._rot=new X,n._scale=new s(1,1,1),n._mat=new f,R(n,"_lpos",Tu,F(n)),R(n,"_lrot",Eu,F(n)),R(n,"_lscale",Au,F(n)),R(n,"_layer",bu,F(n)),R(n,"_euler",wu,F(n)),n._dirtyFlags=tu.NONE,n._eulerDirty=!1,n}return c(t,e),r(t,[{key:"setParent",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];n&&this.updateWorldTransform(),D(u(t.prototype),"setParent",this).call(this,e,n)}},{key:"_onSetParent",value:function(e,n){if(D(u(t.prototype),"_onSetParent",this).call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),f.multiply(Zu,f.invert(Zu,i._mat),this._mat),f.toRTS(Zu,this._lrot,this._lpos,this._lscale)):(s.copy(this._lpos,this._pos),X.copy(this._lrot,this._rot),s.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(tu.TRS)}},{key:"_onBatchCreated",value:function(){D(u(t.prototype),"_onBatchCreated",this).call(this),$u.set(this._id,tu.TRS),this._dirtyFlags=tu.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"_onPostActivated",value:function(e){e?(Tl.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(tu.TRS)):Tl.pauseTarget(this)}},{key:"translate",value:function(e,t){var n=t||eu.LOCAL;if(n===eu.LOCAL)s.transformQuat(qu,e,this._lrot),this._lpos.x+=qu.x,this._lpos.y+=qu.y,this._lpos.z+=qu.z;else if(n===eu.WORLD)if(this._parent){X.invert(Wu,this._parent.worldRotation),s.transformQuat(qu,e,Wu);var i=this.worldScale;this._lpos.x+=qu.x/i.x,this._lpos.y+=qu.y/i.y,this._lpos.z+=qu.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(tu.POSITION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.POSITION)}},{key:"rotate",value:function(e,t){var n=t||eu.LOCAL;if(X.normalize(Wu,e),n===eu.LOCAL)X.multiply(this._lrot,this._lrot,Wu);else if(n===eu.WORLD){var i=this.worldRotation;X.multiply(Xu,Wu,i),X.invert(Wu,i),X.multiply(Xu,Wu,Xu),X.multiply(this._lrot,this._lrot,Xu)}this._eulerDirty=!0,this.invalidateChildren(tu.ROTATION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(qu),s.subtract(qu,qu,e),s.normalize(qu,qu),X.fromViewUp(Wu,qu,t),this.setWorldRotation(Wu)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,$u.set(this._id,this.hasChangedFlags|e),e|=tu.POSITION;for(var t=this._children.length,n=0;n<t;++n){var i=this._children[n];i.isValid&&i.invalidateChildren(e)}}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)Yu[n++]=t,t=t._parent;for(var i=0;n;)i|=(e=Yu[--n])._dirtyFlags,t?(i&tu.POSITION&&(s.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&tu.RS&&(f.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),f.multiply(e._mat,t._mat,e._mat),i&tu.ROTATION&&X.multiply(e._rot,t._rot,e._lrot),h.fromQuat(Qu,X.conjugate(Ku,e._rot)),h.multiplyMat4(Qu,Qu,e._mat),e._scale.x=Qu.m00,e._scale.y=Qu.m04,e._scale.z=Qu.m08)):(i&tu.POSITION&&(s.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&tu.RS&&(i&tu.ROTATION&&X.copy(e._rot,e._lrot),i&tu.SCALE&&s.copy(e._scale,e._lscale),f.fromRTS(e._mat,e._rot,e._pos,e._scale))),e._dirtyFlags=tu.NONE,t=e}}},{key:"setPosition",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._lpos,e):s.set(this._lpos,e,t,n),this.invalidateChildren(tu.POSITION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.POSITION)}},{key:"getPosition",value:function(e){return e?s.set(e,this._lpos.x,this._lpos.y,this._lpos.z):s.copy(new s,this._lpos)}},{key:"setRotation",value:function(e,t,n,i){void 0===t||void 0===n||void 0===i?X.copy(this._lrot,e):X.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(tu.ROTATION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,n){s.set(this._euler,e,t,n),X.fromEuler(this._lrot,e,t,n),this._eulerDirty=!1,this.invalidateChildren(tu.ROTATION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.ROTATION)}},{key:"getRotation",value:function(e){return e?X.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):X.copy(new X,this._lrot)}},{key:"setScale",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._lscale,e):s.set(this._lscale,e,t,n),this.invalidateChildren(tu.SCALE),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.SCALE)}},{key:"getScale",value:function(e){return e?s.set(e,this._lscale.x,this._lscale.y,this._lscale.z):s.copy(new s,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){s.copy(e,t);for(var n=this,i=0;n._parent;)Yu[i++]=n,n=n._parent;for(;i>=0;)s.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=Yu[--i];return e}},{key:"setWorldPosition",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._pos,e):s.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),s.transformMat4(r,this._pos,f.invert(Zu,i._mat))):s.copy(r,this._pos),this.invalidateChildren(tu.POSITION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?s.copy(e,this._pos):s.copy(new s,this._pos)}},{key:"setWorldRotation",value:function(e,t,n,i){void 0===t||void 0===n||void 0===i?X.copy(this._rot,e):X.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),X.multiply(this._lrot,X.conjugate(this._lrot,this._parent._rot),this._rot)):X.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(tu.ROTATION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,n){X.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),X.multiply(this._lrot,X.conjugate(this._lrot,this._parent._rot),this._rot)):X.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(tu.ROTATION),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?X.copy(e,this._rot):X.copy(new X,this._rot)}},{key:"setWorldScale",value:function(e,t,n){void 0===t||void 0===n?s.copy(this._scale,e):s.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),h.fromQuat(Qu,X.conjugate(Ku,i._rot)),h.multiplyMat4(Qu,Qu,i._mat),Ju.m00=this._scale.x,Ju.m04=this._scale.y,Ju.m08=this._scale.z,h.multiply(Qu,Ju,h.invert(Qu,Qu)),this._lscale.x=s.set(qu,Qu.m00,Qu.m01,Qu.m02).length(),this._lscale.y=s.set(qu,Qu.m03,Qu.m04,Qu.m05).length(),this._lscale.z=s.set(qu,Qu.m06,Qu.m07,Qu.m08).length()):s.copy(this._lscale,this._scale),this.invalidateChildren(tu.SCALE),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?s.copy(e,this._scale):s.copy(new s,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e||(e=new f),f.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e||(e=new f),f.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new f),f.fromRT(e,this._rot,this._pos)}},{key:"setRTS",value:function(e,t,n){var i=0;e&&(i|=tu.ROTATION,void 0!==e.w?(X.copy(this._lrot,e),this._eulerDirty=!0):(s.copy(this._euler,e),X.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(s.copy(this._lpos,t),i|=tu.POSITION),n&&(s.copy(this._lscale,n),i|=tu.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,i))}},{key:"pauseSystemEvents",value:function(e){Tl.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){Tl.resumeTarget(this,e)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(X.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){f.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(tu.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(al.TRANSFORM_CHANGED,tu.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return s.transformQuat(new s,s.FORWARD,this.worldRotation)},set:function(e){var t=e.length();s.multiplyScalar(qu,e,-1/t),X.fromViewUp(Wu,qu),this.setWorldRotation(Wu)}},{key:"up",get:function(){return s.transformQuat(new s,s.UP,this.worldRotation)}},{key:"right",get:function(){return s.transformQuat(new s,s.RIGHT,this.worldRotation)}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return $u.get(this._id)||0},set:function(e){$u.set(this._id,e)}}],[{key:"isNode",value:function(e){return e instanceof t&&(e.constructor===t||!(e instanceof a.Scene))}}]),t}(gu),Iu.bookOfChange=$u,Iu.EventType=al,Iu.NodeSpace=eu,Iu.TransformDirtyBit=tu,Iu.TransformBit=tu,Tu=b((Cu=Ru).prototype,"_lpos",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),Eu=b(Cu.prototype,"_lrot",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new X}}),Au=b(Cu.prototype,"_lscale",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s(1,1,1)}}),bu=b(Cu.prototype,"_layer",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ma.Enum.DEFAULT}}),wu=b(Cu.prototype,"_euler",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),b(Cu.prototype,"eulerAngles",[xu],Object.getOwnPropertyDescriptor(Cu.prototype,"eulerAngles"),Cu.prototype),b(Cu.prototype,"layer",[I],Object.getOwnPropertyDescriptor(Cu.prototype,"layer"),Cu.prototype),Su=Cu))||Su));function t_(e){return"string"==typeof e||"number"==typeof e}function n_(e,t){return e instanceof t}a.Node=e_;var i_=e("ax",A("cc.animation.HierarchyPath")((Nu=b((Pu=function(){function e(t){o(this,e),R(this,"path",Nu,this),this.path=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof e_))return V("Target of hierarchy path should be of type Node."),null;var t=e.getChildByPath(this.path);return t||(V('Node "'.concat(e.name,'" has no path "').concat(this.path,'"')),null)}}]),e}()).prototype,"path",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ou=Pu))||Ou);e("ay",A("cc.animation.ComponentPath")((Mu=b((zu=function(){function e(t){o(this,e),R(this,"component",Mu,this),this.component=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof e_))return V("Target of component path should be of type Node."),null;var t=e.getComponent(this.component);return t||(V('Node "'.concat(e.name,'" has no component "').concat(this.component,'"')),null)}}]),e}()).prototype,"component",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Du=zu))||Du);var r_=e("d5",function(){function e(){o(this,e)}return r(e,null,[{key:"getOrExtract",value:function(t){var n=e.pool.get(t);return n&&n.info.sample===t.sample||(n&&a.director.root.dataPoolManager.releaseAnimationClip(t),n=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&n_(e.modifiers[0],i_)&&t_(e.modifiers[1])){var n=e.modifiers[0].path,i=t[n];i||(i=t[n]={}),i[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var n=Math.ceil(e.sample*e.duration)+1,i=function(){var i=o[r],a=t[i];if(!a)return"continue";Object.defineProperty(a,"worldMatrix",{get:function(){if(!a._worldMatrix){var r=a.position,o=a.rotation,s=a.scale;o_(e,r,n),o_(e,o,n),o_(e,s,n),function(e,t,n){var i=n.position.values,r=n.rotation.values,o=n.scale.values,a=i.map((function(){return new f})),s=t.lastIndexOf("/"),c=null;if(s>0){var l=t.substring(0,s),u=e[l];if(!u)return void console.warn("no data for parent bone?");c=u.worldMatrix.values}for(var _=0;_<i.length;_++){var h=i[_],d=r[_],v=o[_],m=a[_];f.fromRTS(m,d,h,v),c&&f.multiply(m,c[_],m)}Object.keys(n).forEach((function(e){return delete n[e]})),n._worldMatrix={keys:0,interpolate:!1,values:a}}(t,i,a)}return a._worldMatrix}})},r=0,o=Object.keys(t);r<o.length;r++)i();return{info:{frames:n,sample:e.sample},data:t}}(t),e.pool.set(t,n)),n}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}());function o_(e,t,n){var i=e.keys[t.keys],r=[];if(i&&1!==i.length)for(var o=t.values[0]instanceof X,a=0,s=0;a<n;a++){for(var c=a/e.sample;i[s]<=c;)s++;s>i.length-1?c=i[s=i.length-1]:0===s&&(s=1);var l=t.values[s-1].clone(),u=i[s]-i[s-1],_=u?ge((c-i[s-1])/u):1;o?l.slerp(t.values[s],_):l.lerp(t.values[s],_),r[a]=l}else for(var f=0;f<n;f++)r[f]=t.values[0].clone();t.values=r}r_.pool=new Map;var a_=new f;function s_(e,t,n){for(f.identity(n);e!==t;)f.fromRTS(a_,e.rotation,e.position,e.scale),f.multiply(n,a_,n),e=e.parent;return n}var c_=e("u",(function(e,t,n,i){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14})),l_=e("M",480);function u_(e){return e.hasFeature(ni.TEXTURE_FLOAT)?an.RGBA32F:an.RGBA8}new X,new X,new s,new X,new s;function __(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(l_*n,e)/12)}e("l",jo([xn.POINT,xn.POINT,xn.NONE,Sn.CLAMP,Sn.CLAMP,Sn.CLAMP]));var f_=new s,h_=new s,d_=new s,v_=new s,m_=new f,p_=new f,g_=new Wr,y_=Number.MAX_SAFE_INTEGER,x_=(e("J",function(){function e(t){o(this,e),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var n=u_(this._device);this._formatSize=Kn[n].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Vc(t),this._pool.initialize({format:n,roundUpFn:__}),this._customPool=new Vc(t),this._customPool.initialize({format:n,roundUpFn:__})}return r(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),r(e,[{key:"clear",value:function(){this._pool.destroy(),this._textureBuffers.clear()}},{key:"registerCustomTextureLayouts",value:function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}}},{key:"getDefaultPoseTexture",value:function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,c=null,l=!1,u=o.length;if(r)r.refCount++;else{var _=12*u,h=this._chunkIdxMap.get(i),d=void 0!==h?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!d)return r;r={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:d},c=new Float32Array(_),l=!0}s.set(d_,y_,y_,y_),s.set(v_,-y_,-y_,-y_);for(var v=t.getBoneSpaceBounds(e),m=0,p=0;m<u;m++,p+=12){var g=n.getChildByPath(o[m]),y=g?s_(g,n,m_):e.inverseBindposes[m],x=v[m];x&&(Wr.transform(g_,x,y),g_.getBoundary(f_,h_),s.min(d_,d_,f_),s.max(v_,v_,h_)),l&&(g&&f.multiply(y,y,a[m]),c_(c,p,g?y:f.IDENTITY))}var S=[new Wr];return r.bounds.set(t.hash,S),Wr.fromPoints(S[0],d_,v_),l&&(this._pool.update(r.handle,c.buffer),this._textureBuffers.set(i,r)),r}},{key:"getSequencePoseTexture",value:function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,c=e.bindposes,l=r_.getOrExtract(t).info.frames,u=null,_=!1,h=a.length;if(o)o.refCount++;else{var d=12*h*l,v=this._chunkIdxMap.get(r),m=void 0!==v?this._customPool.alloc(d*Float32Array.BYTES_PER_ELEMENT,v):this._pool.alloc(d*Float32Array.BYTES_PER_ELEMENT);if(!m)return null;var p=this._createAnimInfos(e,t,i);o={pixelOffset:m.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:m,animInfos:p},u=new Float32Array(d),_=!0}var g=n.getBoneSpaceBounds(e),y=[];o.bounds.set(n.hash,y);for(var x=0;x<l;x++)y.push(new Wr(y_,y_,y_,-y_,-y_,-y_));for(var S=0,C=0;S<l;S++){for(var T=y[S],E=0;E<h;E++,C+=12){var A=o.animInfos[E],b=A.curveData,w=A.downstream,I=A.bindposeIdx,R=A.bindposeCorrection,O=void 0,P=!0;b&&w?O=f.multiply(m_,b[S],w):b?O=b[S]:w?O=w:(O=e.inverseBindposes[I],P=!1);var N=g[E];if(N){var D=R?f.multiply(p_,O,R):O;Wr.transform(g_,N,D),g_.getBoundary(f_,h_),s.min(T.center,T.center,f_),s.max(T.halfExtents,T.halfExtents,h_)}_&&(P&&f.multiply(m_,O,c[I]),c_(u,C,P?m_:f.IDENTITY))}Wr.fromPoints(T,T.center,T.halfExtents)}return _&&(this._pool.update(o.handle,u.buffer),this._textureBuffers.set(r,o)),o}},{key:"releaseHandle",value:function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}}},{key:"releaseSkeleton",value:function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}}},{key:"releaseAnimationClip",value:function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}}},{key:"_createAnimInfos",value:function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=r_.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.data[l],_=n.getChildByPath(l),h=void 0,d=void 0;!u;){var v=l.lastIndexOf("/");if(l=l.substring(0,v),u=s.data[l],_?(h||(h=new f),f.fromRTS(m_,_.rotation,_.position,_.scale),f.multiply(h,m_,h),_=_.parent):d=l,v<0)break}var m=c,p=void 0;if(void 0!==d&&u){m=c-1;for(var g=0;g<a;g++)if(r[g]===d){m=g,p=new f,f.multiply(p,o[g],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.worldMatrix.values,downstream:h,bindposeIdx:m,bindposeCorrection:p})}return i}}]),e}()),e("n",function(){function e(t){o(this,e),this._pool=new Map,this._device=void 0,this._device=t}return r(e,[{key:"getData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-1",t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:ka.SIZE,stride:ka.SIZE}),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1};return this._pool.set(e,r),r}},{key:"destroy",value:function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}},{key:"switchClip",value:function(e,t){return e.data[0]=0,e.buffer.update(e.data),e.dirty=!1,e}},{key:"clear",value:function(){for(var e,t=z(this._pool.values());!(e=t()).done;){e.value.buffer.destroy()}this._pool.clear()}}]),e}()),{layout:null}),S_=e("a2",function(){function e(){o(this,e),this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=tc,this._priority=ga.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}return r(e,[{key:"initialize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._device=a.director.root.device,this._subMesh=e,this._patches=n,this._passes=t,this._handle=_c.alloc(),this._flushPassInfo(),x_.layout=t[0].setLayouts[Aa.LOCAL];var i=ac.alloc(this._device,x_),r=sc.alloc(this._device,e);_c.set(this._handle,lc.PRIORITY,ga.DEFAULT),_c.set(this._handle,lc.INPUT_ASSEMBLER,r),_c.set(this._handle,lc.DESCRIPTOR_SET,i),this._inputAssembler=sc.get(r),this._descriptorSet=ac.get(i)}},{key:"destroy",value:function(){ac.free(_c.get(this._handle,lc.DESCRIPTOR_SET)),sc.free(_c.get(this._handle,lc.INPUT_ASSEMBLER)),_c.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=ga.DEFAULT,this._handle=tc,this._patches=null,this._subMesh=null,this._passes=null}},{key:"update",value:function(){for(var e=0;e<this._passes.length;++e){this._passes[e].update()}this._descriptorSet.update()}},{key:"onPipelineStateChanged",value:function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"onMacroPatchesStateChanged",value:function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"_flushPassInfo",value:function(){var e=this._passes;if(e){_c.set(this._handle,lc.PASS_COUNT,e.length);for(var t=0;t<e.length;t++)_c.set(this._handle,lc.PASS_0+t,e[t].handle),_c.set(this._handle,lc.SHADER_0+t,e[t].getShaderVariant(this._patches))}}},{key:"passes",set:function(e){this._passes=e,this._flushPassInfo()},get:function(){return this._passes}},{key:"subMesh",set:function(e){this._subMesh=e,this._inputAssembler.destroy(),this._inputAssembler.initialize(e)},get:function(){return this._subMesh}},{key:"priority",set:function(e){this._priority=e,_c.set(this._handle,lc.PRIORITY,e)},get:function(){return this._priority}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}()),C_=function(){function e(t){o(this,e),this.instances=[],this.hPass=tc,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.hPass=t.handle}return r(e,null,[{key:"get",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e._buffers;i.has(t)||i.set(t,{});var r=i.get(t);return r[n]||(r[n]=new e(t))}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}},{key:"merge",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=t.buffer.length;if(r){for(var o=e.inputAssembler,a=e.descriptorSet.getTexture(Wa.binding),s=i||_c.get(e.handle,lc.SHADER_0+n),c=_c.get(e.handle,lc.DESCRIPTOR_SET),l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a){if(u.stride!==r)return;if(u.count>=u.capacity){u.capacity<<=1;var _=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(_),u.data.set(f),u.vb.resize(_)}return u.hShader!==s&&(u.hShader=s),u.hDescriptorSet!==c&&(u.hDescriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var h=this._device.createBuffer({usage:sn.VERTEX|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:32*r,stride:r}),d=new Uint8Array(32*r),v=o.vertexBuffers.slice(),m=o.attributes.slice(),p=o.indexBuffer||void 0,g=0;g<t.list.length;g++){var y=t.list[g],x={name:y.name,format:y.format,stream:v.length,isInstanced:!0};void 0!==y.isNormalized&&(x.isNormalized=y.isNormalized),m.push(x)}d.set(t.buffer),v.push(h);var S=this._device.createInputAssembler({attributes:m,vertexBuffers:v,indexBuffer:p});this.instances.push({count:1,capacity:32,vb:h,data:d,ia:S,stride:r,hShader:s,hDescriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}}},{key:"uploadBuffers",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.count&&(t.ia.instanceCount=t.count,t.vb.update(t.data))}}},{key:"clear",value:function(){for(var e=0;e<this.instances.length;++e){this.instances[e].count=0}this.hasPendingModels=!1}}]),e}();C_._buffers=new Map;var T_,E_=new f,A_=new ye((function(){return new S_}),32),b_=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.UI_BATCH=3]="UI_BATCH",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(T_||(T_=e("U",{})));var w_=jo([xn.LINEAR,xn.LINEAR,xn.NONE,Sn.CLAMP,Sn.CLAMP,Sn.CLAMP]),I_=jo([xn.LINEAR,xn.LINEAR,xn.LINEAR,Sn.CLAMP,Sn.CLAMP,Sn.CLAMP]),R_=e("W",function(){function e(){o(this,e),this.type=T_.DEFAULT,this.scene=null,this.node=null,this.transform=null,this.enabled=!0,this.visFlags=ma.Enum.NONE,this.castShadow=!1,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,list:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(za.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new m,this._receiveShadow=!0,this._device=a.director.root.device}return r(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}}]),r(e,[{key:"initialize",value:function(e){this.transform=this.node=e,this._receiveShadow=!0,this.castShadow=!1}},{key:"destroy",value:function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];n.destroy(),A_.free(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this.isDynamicBatching=!1}},{key:"attachToScene",value:function(e){this.scene=e}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0,this._modelBounds&&this._worldBounds&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.list;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r].view,o[r+1].view,o[r+2].view)}else f.toArray(this._localData,i,za.MAT_WORLD_OFFSET),f.inverseTranspose(E_,i),f.toArray(this._localData,E_,za.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData)}}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=Wr.fromPoints(Wr.create(),e,t),this._worldBounds=Wr.clone(this._modelBounds))}},{key:"initSubModel",value:function(e,t,n){null==this._subModels[e]?this._subModels[e]=A_.alloc():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}},{key:"setSubModelMaterial",value:function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()}},{key:"onMacroPatchesStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))}},{key:"updateLightingmap",value:function(e,t){m.toArray(this._localData,t,za.LIGHTINGMAP_UVPARAM),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Ys.get("empty-texture"));var n=e.getGFXTexture();if(null!==n)for(var i=ta.getSampler(this._device,e.mipmaps.length>1?I_:w_),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Wa.binding,n),a.bindSampler(Wa.binding,i),a.update()}}},{key:"getMacroPatches",value:function(e){return this.receiveShadow?b_:null}},{key:"_updateAttributesAndBinding",value:function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var n=oc.get(_c.get(t.handle,lc.SHADER_0));this._updateInstancedAttributes(n.attributes,t.passes[0])}}},{key:"_getInstancedAttributeIndex",value:function(e){for(var t=this.instancedAttributes.list,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1}},{key:"_updateInstancedAttributes",value:function(e,t){if(t.device.hasFeature(ni.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=Kn[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.list.length=0;for(var a=0,s=o.buffer.buffer,c=0;c<e.length;c++){var l=e[c];if(l.isInstanced){var u=l.format,_=Kn[u],f=new(ei(_))(s,a,_.count),h=l.isNormalized;a+=_.size,o.list.push({name:l.name,format:u,isNormalized:h,view:f})}}t.batchingScheme===xc.INSTANCING&&C_.get(t).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}}},{key:"_initLocalDescriptors",value:function(e){this._localBuffer||(this._localBuffer=this._device.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:za.SIZE,stride:za.SIZE}))}},{key:"_updateLocalDescriptors",value:function(e,t){t.bindBuffer(za.BLOCK.binding,this._localBuffer)}}]),e}()),O_=e("r",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._morphRenderingInstance=null,n._usedMaterials=new Set,n}return c(t,e),r(t,[{key:"getMacroPatches",value:function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):void 0}},{key:"initSubModel",value:function(e,n,i){return D(u(t.prototype),"initSubModel",this).call(this,e,n,this._launderMaterial(i))}},{key:"setSubModelMaterial",value:function(e,n){return D(u(t.prototype),"setSubModelMaterial",this).call(this,e,this._launderMaterial(n))}},{key:"_updateLocalDescriptors",value:function(e,n){D(u(t.prototype),"_updateLocalDescriptors",this).call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)}},{key:"_launderMaterial",value:function(e){return e}},{key:"destroy",value:function(){D(u(t.prototype),"destroy",this).call(this),this._morphRenderingInstance=null}},{key:"setMorphRendering",value:function(e){this._morphRenderingInstance=e}}]),t}(R_)),P_=[],N_=new Map,D_=[{name:"CC_USE_SKINNING",value:!0}];function z_(e,t){for(var n=0,i=f.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,P_[n++]=e,e=e.parent}for(;n>0;){var r=(e=P_[--n]).node;f.fromRTS(e.local,r.rotation,r.position,r.scale),i=f.multiply(e.world,i,e.local)}return i}function M_(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(N_.has(o)){i=N_.get(o);break}i={node:e,local:new f,world:new f,stamp:-1,parent:null},N_.set(o,i),P_[r++]=i,e=e.parent,i=null}for(;r>0;)(n=P_[--r]).parent=i,i=n;return i}function L_(e){for(var t=N_.get(e.uuid)||null;t;)N_.delete(t.node.uuid),t=t.parent}function F_(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var k_,U_,B_,G_,j_,V_=new s,H_=new s,q_=new s,W_=new s,X_=new f,Y_=new Wr,K_=(e("S",function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this))).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=T_.SKINNING,e}return c(t,e),r(t,[{key:"destroy",value:function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}D(u(t.prototype),"destroy",this).call(this)}},{key:"bindSkeleton",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=0;i<this._joints.length;i++)L_(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=M_(c,t),u=e.bindposes[a],_=[],f=[];o?F_(_,f,o,a):(_.push(a),f.push(0)),this._joints.push({indices:_,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),s.set(V_,1/0,1/0,1/0),s.set(H_,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=z_(i.transform,e);Wr.transform(Y_,r,o),Y_.getBoundary(q_,W_),s.min(V_,V_,q_),s.max(H_,H_,W_)}this._modelBounds&&this._worldBounds&&(Wr.fromPoints(this._modelBounds,V_,H_),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateUBOs",value:function(e){D(u(t.prototype),"updateUBOs",this).call(this,e);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;f.multiply(X_,a.world,s);for(var c=0;c<o.length;c++)c_(this._dataArray[o[c]],12*r[c],X_)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0}},{key:"initSubModel",value:function(e,n,i){var r=n.vertexBuffers;n.vertexBuffers=n.jointMappedBuffers,D(u(t.prototype),"initSubModel",this).call(this,e,n,i),n.vertexBuffers=r}},{key:"getMacroPatches",value:function(e){var n=D(u(t.prototype),"getMacroPatches",this).call(this,e);return n?D_.concat(n):D_}},{key:"_updateLocalDescriptors",value:function(e,n){D(u(t.prototype),"_updateLocalDescriptors",this).call(this,e,n);var i=this._buffers[this._bufferIndices[e]];i&&n.bindBuffer(Ba.BLOCK.binding,i)}},{key:"_ensureEnoughBuffers",value:function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:Ba.SIZE,stride:Ba.SIZE})),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Ba.COUNT))}}]),t}(O_)),e("A",function(){function e(){o(this,e),this._enabled=!0,this._skyColor=new xe(51,128,204,1),this._skyIllum=e.SKY_ILLUM,this._groundAlbedo=new xe(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1])}return r(e,[{key:"activate",value:function(){xe.toArray(this._colorArray,this._skyColor),s.toArray(this._albedoArray,this._groundAlbedo)}},{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",set:function(e){this._enabled!==e&&(this._enabled=e,this.activate())},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e,xe.toArray(this._colorArray,this._skyColor)}},{key:"skyIllum",get:function(){return this._skyIllum},set:function(e){this._skyIllum=e}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e,s.toArray(this._albedoArray,this._groundAlbedo)}}]),e}()));K_.SUN_ILLUM=65e3,K_.SKY_ILLUM=2e4,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(k_||(k_=e("B",{}))),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(U_||(U_=e("D",{}))),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(B_||(B_=e("E",{}))),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(G_||(G_=e("F",{}))),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(j_||(j_=e("H",{})));var Q_=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],J_=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Z_=[100,200,400,800],$_=new s,ef=new s,tf=new f,nf=new f,rf=e("I",Fn.STENCIL<<1),of=(e("K",function(){function e(t){o(this,e),this.isWindowSize=!0,this.screenScale=void 0,this.clearStencil=0,this.clearDepth=1,this.clearFlag=Fn.NONE,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._width=void 0,this._height=void 0,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=k_.VERTICAL,this._fov=Se(45),this._nearClip=1,this._farClip=1e3,this._clearColor={r:.2,g:.2,b:.2,a:1},this._viewport=new K(0,0,1,1),this._isProjDirty=!0,this._matView=new f,this._matViewInv=null,this._matProj=new f,this._matProjInv=new f,this._matViewProj=new f,this._matViewProjInv=new f,this._frustum=new eo,this._forward=new s,this._position=new s,this._view=null,this._visibility=Ya,this._priority=0,this._aperture=B_.F16_0,this._apertureValue=void 0,this._shutter=j_.D125,this._shutterValue=0,this._iso=G_.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._device=t,this._apertureValue=Q_[this._aperture],this._shutterValue=J_[this._shutter],this._isoValue=Z_[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this.screenScale=1}return r(e,[{key:"initialize",value:function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._view=a.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),a.director.root.attachCamera(this),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+this._width+"x"+this._height)}},{key:"destroy",value:function(){a.director.root.detachCamera(this),this._view&&(this._view.destroy(),this._view=null),this._name=null}},{key:"attachToScene",value:function(e){this._scene=e,this._view&&this._view.enable(!0)}},{key:"detachFromScene",value:function(){this._scene=null,this._view&&this._view.enable(!1)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width*this._viewport.width/(this._height*this._viewport.height),this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width*this._viewport.width/(this._height*this._viewport.height),this.isWindowSize=!1}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){if((this._node.hasChangedFlags||e)&&(f.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty){var t=this._device.screenSpaceSignY;if(this._view&&this._view.window.hasOffScreenAttachments&&(t*=this._device.UVSpaceSignY),this._proj===U_.PERSPECTIVE)f.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===k_.VERTICAL,this._device.clipSpaceMinZ,t);else{var n=this._orthoHeight*this._aspect,i=this._orthoHeight;f.ortho(this._matProj,-n,n,-i,i,this._nearClip,this._farClip,this._device.clipSpaceMinZ,t)}f.invert(this._matProjInv,this._matProj)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(f.multiply(this._matViewProj,this._matProj,this._matView),f.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,n){if(this._node){if(t=Math.max(t,this._nearClip),n=Math.min(n,this._farClip),f.invert(this._matView,this._node.worldMatrix),this._proj===U_.PERSPECTIVE)f.perspective(tf,this._fov,this._aspect,t,n,this._fovAxis===k_.VERTICAL,this._device.clipSpaceMinZ,this._device.screenSpaceSignY);else{var i=this._orthoHeight*this._aspect,r=this._orthoHeight;f.ortho(tf,-i,i,-r,r,t,n,this._device.clipSpaceMinZ,this._device.screenSpaceSignY)}f.multiply(nf,tf,this._matView),f.invert(tf,nf),e.update(nf,tf)}}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e||a.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))}},{key:"screenPointToRay",value:function(e,t,n){var i=this._viewport.x*this._width,r=this._viewport.y*this._height,o=this._viewport.width*this._width,a=this._viewport.height*this._height;return s.set($_,(t-i)/o*2-1,(n-r)/a*2-1,1),$_.y*=this._device.screenSpaceSignY,s.transformMat4($_,$_,this._matViewProjInv),this._proj===U_.PERSPECTIVE?this._node&&this._node.getWorldPosition(ef):(s.set(ef,(t-i)/o*2-1,(n-r)/a*2-1,-1),ef.y*=this._device.screenSpaceSignY,s.transformMat4(ef,ef,this._matViewProjInv)),Ht.fromPoints(e,ef,$_)}},{key:"screenToWorld",value:function(e,t){var n=this._viewport.x*this._width,i=this._viewport.y*this._height,r=this._viewport.width*this._width,o=this._viewport.height*this._height;return this._proj===U_.PERSPECTIVE?(s.set(e,(t.x-n)/r*2-1,(t.y-i)/o*2-1,1),s.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition($_),s.lerp(e,$_,e,Ce(this._nearClip/this._farClip,1,t.z))):(s.set(e,(t.x-n)/r*2-1,(t.y-i)/o*2-1,2*t.z-1),s.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var n=this._viewport.x*this._width,i=this._viewport.y*this._height,r=this._viewport.width*this._width,o=this._viewport.height*this._height;return s.transformMat4(e,t,this.matViewProj),e.x=n+.5*(e.x+1)*r,e.y=i+.5*(e.y+1)*o,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"enabled",set:function(e){this._enabled=e,this._view&&this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"fovAxis",set:function(e){this._fovAxis=e,this._isProjDirty=!0},get:function(){return this._fovAxis}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.r=e.r,this._clearColor.g=e.g,this._clearColor.b=e.b,this._clearColor.a=e.a},get:function(){return this._clearColor}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=this._device.screenSpaceSignY;this._viewport.x=e.x,this._viewport.y=t>0?e.y:1-e.y-e.height,this._viewport.width=e.width,this._viewport.height=e.height,this.resize(this._width,this._height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e},get:function(){return this._frustum}},{key:"forward",set:function(e){this._forward=e},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e},get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view&&(this._view.visibility=e)},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view?this._view.priority:-1},set:function(e){this._priority=e,this._view&&(this._view.priority=this._priority)}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=Q_[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=J_[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=Z_[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}}]),e}()),e("$",function(){function e(t){o(this,e),this._root=void 0,this._name="",this._cameras=[],this._models=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t}return r(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"rayResultCanvas",get:function(){return vf}},{key:"rayResultModels",get:function(){return ff}},{key:"rayResultAll",get:function(){return mf}},{key:"rayResultSingleModel",get:function(){return pf}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),r(e,[{key:"initialize",value:function(e){return this._name=e.name,!0}},{key:"update",value:function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++){n[i].update()}for(var r=this._spotLights,o=0;o<r.length;o++){r[o].update()}for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels()}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}},{key:"removeCameras",value:function(){for(var e,t=z(this._cameras);!(e=t()).done;){e.value.detachFromScene()}this._cameras.splice(0)}},{key:"setMainLight",value:function(e){this._mainLight=e}},{key:"unsetMainLight",value:function(e){if(this._mainLight===e){var t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=tu.ROTATION)):this._mainLight=null}}},{key:"addDirectionalLight",value:function(e){e.attachToScene(this),this._directionalLights.push(e)}},{key:"removeDirectionalLight",value:function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e)}},{key:"removeModel",value:function(e){for(var t=a.director.root.pipeline,n=0;n<this._models.length;++n)if(this._models[n]===e)return t.shadows.destroyShadowData(e),e.detachFromScene(),void this._models.splice(n,1)}},{key:"removeModels",value:function(){for(var e,t=a.director.root.pipeline,n=z(this._models);!(e=n()).done;){var i=e.value;t.shadows.destroyShadowData(i),i.detachFromScene(),i.destroy()}this._models.length=0}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e,t=z(this._models);!(e=t()).done;){e.value.onGlobalPipelineStateChanged()}}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ma.Enum.DEFAULT|ma.Enum.UI_2D,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,i=this.raycastAllModels(e,t,n),r=this.raycastAllCanvas(e,t,n),o=i||r;return mf.length=0,o&&(Array.prototype.push.apply(mf,ff),Array.prototype.push.apply(mf,vf)),o}},{key:"raycastAllModels",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ma.Enum.DEFAULT,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;_f.reset();for(var i,r=z(this._models);!(i=r()).done;){var o=i.value,a=o.transform;if(a&&o.enabled&&o.node.layer&t&~ma.Enum.IGNORE_RAYCAST&&o.worldBounds){var c=Dr.ray_aabb(e,o.worldBounds);if(!(c<=0||c>=n)){if(o.type===T_.DEFAULT){f.invert(cf,a.getWorldMatrix(cf)),s.transformMat4(af.o,e.o,cf),s.normalize(af.d,s.transformMat4Normal(af.d,e.d,cf)),c=1/0;for(var l=o.subModels,u=0;u<l.length;++u){var _=l[u].subMesh;if(_&&_.geometricInfo){var h=_.geometricInfo,d=h.positions,v=h.indices,m=h.doubleSided;gf(d,v,_.primitiveMode,m,n),c=Math.min(c,lf*s.multiply(sf,af.d,a.worldScale).length())}}}if(c<n){var p=_f.add();p.node=o.node,p.distance=c,ff[_f.length-1]=p}}}}return ff.length=_f.length,ff.length>0}},{key:"raycastSingleModel",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ma.Enum.DEFAULT,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;_f.reset();var r=t,o=r.transform;if(!(o&&r.enabled&&r.node.layer&n&~ma.Enum.IGNORE_RAYCAST&&r.worldBounds))return!1;var a=Dr.ray_aabb(e,r.worldBounds);if(a<=0||a>=i)return!1;if(r.type===T_.DEFAULT){f.invert(cf,o.getWorldMatrix(cf)),s.transformMat4(af.o,e.o,cf),s.normalize(af.d,s.transformMat4Normal(af.d,e.d,cf)),a=1/0;for(var c=r.subModels,l=0;l<c.length;++l){var u=c[l].subMesh;if(u&&u.geometricInfo){var _=u.geometricInfo,h=_.positions,d=_.indices,v=_.doubleSided;gf(h,d,u.primitiveMode,v,i),a=Math.min(a,lf*s.multiply(sf,af.d,o.worldScale).length())}}}if(a<i){var m=_f.add();m.node=r.node,m.distance=a,pf[_f.length-1]=m}return pf.length=_f.length,pf.length>0}},{key:"raycastAllCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ma.Enum.UI_2D,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;df.reset();var i=a.director.getScene().getComponentsInChildren(a.Canvas);if(null!=i&&i.length>0)for(var r=0;r<i.length;r++){var o=i[r].node;null!=o&&o.active&&this._raycastUI2DNodeRecursiveChildren(e,o,t,n)}return vf.length=df.length,vf.length>0}},{key:"_raycastUI2DNode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ma.Enum.UI_2D,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=t._uiProps.uiTransformComp;if(!(null==r||t.layer&ma.Enum.IGNORE_RAYCAST)&&t.layer&n){r.getComputeAABB(hf);var o=Dr.ray_aabb(e,hf);if(!(o<=0)&&o<i){var a=df.add();return a.node=t,a.distance=o,a}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ma.Enum.UI_2D,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=this._raycastUI2DNode(e,t,n,i);null!=r&&(vf[df.length-1]=r);for(var o,a=z(t.children);!(o=a()).done;){var s=o.value;null!=s&&s.active&&this._raycastUI2DNodeRecursiveChildren(e,s,n,i)}}}]),e}())),af=Ht.create(),sf=new s,cf=new f,lf=1/0,uf=Zt.create(),_f=new pt((function(){return{node:null,distance:1/0}}),8),ff=[],hf=new Wr,df=new pt((function(){return{node:null,distance:1/0}}),8),vf=[],mf=[],pf=[],gf=function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0;if(lf=r,n===_n.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var c=3*t[a],l=3*t[a+1],u=3*t[a+2];s.set(uf.a,e[c],e[c+1],e[c+2]),s.set(uf.b,e[l],e[l+1],e[l+2]),s.set(uf.c,e[u],e[u+1],e[u+2]);var _=Dr.ray_triangle(af,uf,i);_<=0||_>=lf||(lf=_)}else if(n===_n.TRIANGLE_STRIP)for(var f=t.length-2,h=0,d=0;d<f;d+=1){var v=3*t[d-h],m=3*t[d+h+1],p=3*t[d+2];s.set(uf.a,e[v],e[v+1],e[v+2]),s.set(uf.b,e[m],e[m+1],e[m+2]),s.set(uf.c,e[p],e[p+1],e[p+2]),h=~h;var g=Dr.ray_triangle(af,uf,i);g<=0||g>=lf||(lf=g)}else if(n===_n.TRIANGLE_FAN){var y=t.length-1,x=3*t[0];s.set(uf.a,e[x],e[x+1],e[x+2]);for(var S=1;S<y;S+=1){var C=3*t[S],T=3*t[S+1];s.set(uf.b,e[C],e[C+1],e[C+2]),s.set(uf.c,e[T],e[T+1],e[T+2]);var E=Dr.ray_triangle(af,uf,i);E<=0||E>=lf||(lf=E)}}};T(of.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),E(of.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Te(of.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect in geometry"},{name:"raycastAllModels",suggest:"using intersect in geometry"},{name:"raycastSingleModel",suggest:"using intersect in geometry"},{name:"raycastAllCanvas",suggest:"using intersect in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var yf=e("L",{});E(yf,"CameraVisFlags",[{name:"GENERAL"}]),T(yf,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:ma.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ma.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ma.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ma.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ma.BitMask,targetName:"UI_2D"}]),a.CameraVisFlags=yf;var xf,Sf=e("V",{});function Cf(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}E(Sf,"VisibilityFlags",[{name:"GENERAL"}]),T(Sf,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:ma.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:ma.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:ma.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:ma.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:ma.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:ma.Enum,targetName:"UI_2D"}]),a.VisibilityFlags=Sf,T(Ec.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(xf||(xf=e("P",{})));var Tf=e("Q",(function(e){return 4*Math.PI*Math.PI*e*e})),Ef=e("T",function(){function e(){o(this,e),this._color=new s(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new s(1,1,1),this._scene=null,this._node=null,this._type=void 0,this._name=null,this._type=xf.UNKNOWN}return r(e,[{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,Cf(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=tu.ROTATION)},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}}]),r(e,[{key:"initialize",value:function(e,t){this._name=e,this._type=xf.UNKNOWN,this._node=t}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._type=xf.UNKNOWN,this._node=null}},{key:"update",value:function(){}}]),e}()),Af=new s(0,0,-1),bf=new s,wf=new X,If=(e("N",function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this)))._dir=new s(1,-1,-1),e._illum=K_.SUN_ILLUM,e._shadowRange=1e3,e._shadowIntensity=0,e._shadowFadeDistance=0,e._shadowDistance=0,e._fadeStart=.8,e._splits=new m(1,0,0,0),e._biasAutoAdjust=1,e._type=xf.DIRECTIONAL,e}return c(t,e),r(t,[{key:"shadowRange",set:function(e){this._shadowRange=e},get:function(){return this._shadowRange}},{key:"shadowIntensitywRange",set:function(e){this._shadowIntensity=e}},{key:"shadowIntensity",get:function(){return this._shadowIntensity}},{key:"shadowFadeDistance",set:function(e){this._shadowFadeDistance=e},get:function(){return this._shadowFadeDistance}},{key:"shadowDistance",set:function(e){this._shadowDistance=e},get:function(){return this._shadowDistance}},{key:"fadeStart",set:function(e){this._fadeStart=e},get:function(){return this._fadeStart}},{key:"splits",set:function(e){this._splits=e},get:function(){return this._splits}},{key:"biasAutoAdjust",set:function(e){this._biasAutoAdjust=e},get:function(){return this._biasAutoAdjust}},{key:"direction",set:function(e){this._dir=e,s.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),r(t,[{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this._dir=s.transformQuat(bf,Af,this._node.getWorldRotation(wf)),s.normalize(this._dir,this._dir))}}]),t}(Ef)),e("dY",function(){function e(){o(this,e)}return r(e,null,[{key:"getOrCreatePipelineState",value:function(e,t,n,i,r){var o=uc.get(t,ec.HASH)^i.hash^r.attributesHash^n.id,a=this._PSOHashMap.get(o);if(!a){var s=cc.get(uc.get(t,ec.PIPELINE_LAYOUT)),c=new gi;c.attributes=r.attributes,a=e.createPipelineState({primitive:uc.get(t,ec.PRIMITIVE),rasterizerState:nc.get(uc.get(t,ec.RASTERIZER_STATE)),depthStencilState:ic.get(uc.get(t,ec.DEPTH_STENCIL_STATE)),blendState:rc.get(uc.get(t,ec.BLEND_STATE)),dynamicStates:uc.get(t,ec.DYNAMIC_STATES),inputState:c,renderPass:i,shader:n,pipelineLayout:s}),this._PSOHashMap.set(o,a)}return a}}]),e}()));If._PSOHashMap=new Map;var Rf,Of=new s(0,0,-1),Pf=new s,Nf=new Wr,Df=new X,zf=(new s(0,1,0),new s),Mf=new s,Lf=new f,Ff=e("X",p({Planar:0,ShadowMap:1})),kf=e("Y",p({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3})),Uf=e("Z",function(){function e(){o(this,e),this._enabled=!1,this._type=Ff.Planar,this._normal=new s(0,1,0),this._distance=0,this._shadowColor=new xe(0,0,0,76),this._matLight=new f,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._record=new Map,this._pendingModels=[],this._material=null,this._instancingMaterial=null,this._device=null,this._globalDescriptorSet=null,this._dirty=!0,this._sphere=new Jt(0,0,0,.01),this.near=1,this.far=30,this.aspect=1,this.orthoSize=1,this.size=new Y(512,512),this.pcf=kf.HARD}return r(e,[{key:"activate",value:function(){var e=a.director.root.pipeline;this._globalDescriptorSet=e.descriptorSet,this._data=e.shadowUBO,xe.toArray(this._data,this._shadowColor,Pa.SHADOW_COLOR_OFFSET),this._globalDescriptorSet.getBuffer(Pa.BLOCK.binding).update(this._data),this._type===Ff.ShadowMap?this._updatePipeline():this._updatePlanarInfo()}},{key:"getWorldMatrix",value:function(e,t){s.negate(zf,t);var n=Math.sqrt(2)*this._sphere.radius;return s.multiplyScalar(Mf,zf,n),s.add(Mf,Mf,this._sphere.center),f.fromRT(Lf,e,Mf),Lf}},{key:"_updatePlanarInfo",value:function(){this._dirty=!0,this._material||(this._material=new ol,this._material.initialize({effectName:"pipeline/planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new ol,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}))}},{key:"_updatePipeline",value:function(){var e=a.director.root,t=e.pipeline;this._enabled&&this._type===Ff.ShadowMap?delete t.macros.CC_RECEIVE_SHADOW:t.macros.CC_RECEIVE_SHADOW=!1,e.onGlobalPipelineStateChanged()}},{key:"updateSphereLight",value:function(e){if(e.node.hasChangedFlags||this._dirty){this._dirty=!1,e.node.getWorldPosition(Pf);var t=this._normal,n=this._distance+.001,i=s.dot(t,Pf),r=Pf.x,o=Pf.y,a=Pf.z,c=t.x,l=t.y,u=t.z,_=this._matLight;_.m00=i-n-r*c,_.m01=-o*c,_.m02=-a*c,_.m03=-c,_.m04=-r*l,_.m05=i-n-o*l,_.m06=-a*l,_.m07=-l,_.m08=-r*u,_.m09=-o*u,_.m10=i-n-a*u,_.m11=-u,_.m12=r*n,_.m13=o*n,_.m14=a*n,_.m15=i,f.toArray(this._data,this._matLight,Pa.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalDescriptorSet.getBuffer(Pa.BLOCK.binding).update(this.data)}}},{key:"updateDirLight",value:function(e){if(e.node.hasChangedFlags||this._dirty){this._dirty=!1,e.node.getWorldRotation(Df),s.transformQuat(Pf,Of,Df);var t=this._normal,n=this._distance+.001,i=1/s.dot(t,Pf),r=Pf.x*i,o=Pf.y*i,a=Pf.z*i,c=t.x,l=t.y,u=t.z,_=this._matLight;_.m00=1-c*r,_.m01=-c*o,_.m02=-c*a,_.m03=0,_.m04=-l*r,_.m05=1-l*o,_.m06=-l*a,_.m07=0,_.m08=-u*r,_.m09=-u*o,_.m10=1-u*a,_.m11=0,_.m12=r*n,_.m13=o*n,_.m14=a*n,_.m15=1,f.toArray(this._data,this._matLight,Pa.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalDescriptorSet.getBuffer(Pa.BLOCK.binding).update(this.data)}}},{key:"updateShadowList",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._pendingModels.length=0,e.mainLight&&n)for(var i=e.models,r=0;r<i.length;r++){var o=i[r];if(o.enabled&&o.node&&o.castShadow&&(!o.worldBounds||(Wr.transform(Nf,o.worldBounds,this._matLight),Dr.aabb_frustum(Nf,t)))){var a=this._record.get(o);a&&!!a.instancedBuffer!==o.isInstancingEnabled&&(this.destroyShadowData(o),a=void 0),a||(a=this.createShadowData(o),this._record.set(o,a)),this._pendingModels.push(a)}}}},{key:"recordCommandBuffer",value:function(e,t,n){this._device=e;var i=this._pendingModels,r=i.length;if(r){var o=C_.get(this._instancingMaterial.passes[0]);o&&o.clear();var a=this._material.passes[0].handle,s=ac.get(uc.get(a,ec.DESCRIPTOR_SET));n.bindDescriptorSet(Aa.MATERIAL,s);for(var c=0;c<r;c++)for(var l=i[c],u=l.model,_=l.hShaders,f=l.instancedBuffer,h=0;h<_.length;h++){var d=u.subModels[h],v=_[h];if(f)f.merge(d,u.instancedAttributes,0,v);else{var m=d.inputAssembler,p=oc.get(v),g=If.getOrCreatePipelineState(e,a,p,t,m);n.bindPipelineState(g),n.bindDescriptorSet(Aa.LOCAL,d.descriptorSet),n.bindInputAssembler(m),n.draw(m)}}if(o&&o.hasPendingModels){o.uploadBuffers(),s=ac.get(uc.get(o.hPass,ec.DESCRIPTOR_SET)),n.bindDescriptorSet(Aa.MATERIAL,s);for(var y=null,x=0;x<o.instances.length;++x){var S=o.instances[x];if(S.count){var C=oc.get(S.hShader),T=If.getOrCreatePipelineState(e,o.hPass,C,t,S.ia);y!==T&&(n.bindPipelineState(T),n.bindDescriptorSet(Aa.LOCAL,ac.get(S.hDescriptorSet)),y=T),n.bindInputAssembler(S.ia),n.draw(S.ia)}}}}}},{key:"createShadowData",value:function(e){for(var t=[],n=e.isInstancingEnabled?this._instancingMaterial:this._material,i=e.isInstancingEnabled?C_.get(n.passes[0]):null,r=e.subModels,o=0;o<r.length;o++){var a=n.passes[0].getShaderVariant(e.getMacroPatches(o));t.push(a)}return{model:e,hShaders:t,instancedBuffer:i}}},{key:"destroyShadowData",value:function(e){this._record.delete(e)}},{key:"destroy",value:function(){this._record.clear(),this._material&&this._material.destroy()}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._dirty=!0,this._enabled?this.activate():this._updatePipeline())}},{key:"normal",get:function(){return this._normal},set:function(e){s.copy(this._normal,e),this._dirty=!0}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._dirty=!0}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e,this._enabled&&(xe.toArray(this._data,e,Pa.SHADOW_COLOR_OFFSET),this._globalDescriptorSet&&this._globalDescriptorSet.getBuffer(Pa.BLOCK.binding).update(this.data)),this._dirty=!0}},{key:"type",get:function(){return this._enabled?this._type:-1},set:function(e){this._type=e,this._updatePipeline(),this._updatePlanarInfo()}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"sphere",get:function(){return this._sphere}}]),e}());function Bf(e,t){if(!t){var n=a.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}a.find=Bf,function(e){e[e.positions=rn.ATTR_POSITION]="positions",e[e.normals=rn.ATTR_NORMAL]="normals",e[e.uvs=rn.ATTR_TEX_COORD]="uvs",e[e.colors=rn.ATTR_COLOR]="colors"}(Rf||(Rf={}));var Gf=[{name:rn.ATTR_POSITION,format:an.RGB32F},{name:rn.ATTR_NORMAL,format:an.RGB32F},{name:rn.ATTR_TEX_COORD,format:an.RG32F},{name:rn.ATTR_TANGENT,format:an.RGBA32F},{name:rn.ATTR_COLOR,format:an.RGBA32F}],jf=new s;function Vf(e,t,n){n=n||{};var i,r=[],o=0,a=[],c=0,l=e.positions.slice();if(l.length>0){if(i=null,e.attributes)for(var u,_=z(e.attributes);!(u=_()).done;){var f=u.value;if(f.name===rn.ATTR_POSITION){i=f;break}}i||(i=Gf[0]),r.push(i);var h=Kn[i.format];c=Math.max(c,Math.floor(l.length/h.count)),a.push({offset:o,data:l,attribute:i}),o+=h.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var d,v=z(e.attributes);!(d=v()).done;){var m=d.value;if(m.name===rn.ATTR_NORMAL){i=m;break}}i||(i=Gf[1]);var p=Kn[i.format];r.push(i),c=Math.max(c,Math.floor(e.normals.length/p.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=p.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var g,y=z(e.attributes);!(g=y()).done;){var x=g.value;if(x.name===rn.ATTR_TEX_COORD){i=x;break}}i||(i=Gf[2]);var S=Kn[i.format];r.push(i),c=Math.max(c,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var C,T=z(e.attributes);!(C=T()).done;){var E=C.value;if(E.name===rn.ATTR_TANGENT){i=E;break}}i||(i=Gf[3]);var A=Kn[i.format];r.push(i),c=Math.max(c,Math.floor(e.tangents.length/A.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=A.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var b,w=z(e.attributes);!(b=w()).done;){var I=b.value;if(I.name===rn.ATTR_COLOR){i=I;break}}i||(i=Gf[4]);var R=Kn[i.format];r.push(i),c=Math.max(c,Math.floor(e.colors.length/R.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=R.size}if(e.customAttributes)for(var O,P=z(e.customAttributes);!(O=P()).done;){var N=O.value,D=Kn[N.attr.format];r.push(N.attr),c=Math.max(c,Math.floor(N.values.length/D.count)),a.push({offset:o,data:N.values,attribute:N.attr}),o+=D.size}for(var M=new wo,L=new ArrayBuffer(c*o),F=new DataView(L),k=0,U=a;k<U.length;k++){var B=U[k];Eo(F,B.data,B.attribute.format,B.offset,o)}M.setNextAlignment(0);var G={attributes:r,view:{offset:M.getLength(),length:L.byteLength,count:c,stride:o}};M.addBuffer(L);var j=null,V=0;if(e.indices){var H=e.indices;V=H.length,j=new ArrayBuffer(2*V),Eo(new DataView(j),H,an.R16UI)}var q={primitiveMode:e.primitiveMode||_n.TRIANGLE_LIST,vertexBundelIndices:[0]};j&&(M.setNextAlignment(2),q.indexView={offset:M.getLength(),length:j.byteLength,count:V,stride:2},M.addBuffer(j));var W=e.minPos;if(!W&&n.calculateBounds){W=s.set(new s,1/0,1/0,1/0);for(var X=0;X<c;++X)s.set(jf,l[3*X+0],l[3*X+1],l[3*X+2]),s.min(W,W,jf)}var Y=e.maxPos;if(!Y&&n.calculateBounds){Y=s.set(new s,-1/0,-1/0,-1/0);for(var K=0;K<c;++K)s.set(jf,l[3*K+0],l[3*K+1],l[3*K+2]),s.max(Y,Y,jf)}var Q={vertexBundles:[G],primitives:[q]};return W&&(Q.minPosition=new s(W.x,W.y,W.z)),Y&&(Q.maxPosition=new s(Y.x,Y.y,Y.z)),t||(t=new us),t.reset({struct:Q,data:new Uint8Array(M.getCombined())}),t}function Hf(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function qf(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,c=[s.set(Qf,-r,-o,a),s.set(Jf,r,-o,a),s.set(Zf,r,o,a),s.set($f,-r,o,a),s.set(eh,r,-o,-a),s.set(th,-r,-o,-a),s.set(nh,-r,o,-a),s.set(ih,r,o,-a)],l=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],u=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],_=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],f=[],h=[],d=[],v=[],m=[],p=new s(-r,-o,-a),g=new s(r,o,a),y=Math.sqrt(r*r+o*o+a*a);function x(e,t,n){var i,r,o,a,p=f.length/3,g=l[e],y=u[e],x=_[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,s.lerp(Wf,c[g[0]],c[g[1]],i),s.lerp(Xf,c[g[0]],c[g[2]],r),s.subtract(Yf,Xf,c[g[0]]),s.add(Kf,Wf,Yf),f.push(Kf.x,Kf.y,Kf.z),h.push(y[0],y[1],y[2]),d.push(i,r),v.push(x[0],x[1],x[2],x[3]),o<t&&a<n){var S=t+1,C=o+a*S,T=o+(a+1)*S,E=o+1+(a+1)*S,A=o+1+a*S;m.push(p+C,p+A,p+T),m.push(p+T,p+A,p+E)}}return x(0,t,n),x(4,i,n),x(1,t,n),x(5,i,n),x(3,t,i),x(2,t,i),{positions:f,normals:h,uvs:d,tangents:v,indices:m,minPos:p,maxPos:g,boundingRadius:y}}var Wf=new s,Xf=new s,Yf=new s,Kf=new s,Qf=new s,Jf=new s,Zf=new s,$f=new s,eh=new s,th=new s,nh=new s,ih=new s,rh=new s(0,0,0),oh=new s(0,0,0);var ah=new s(0,0,0),sh=new s(0,0,0),ch=new s(0,0,0),lh=new s(0,0,0),uh=new s(0,0,0),_h=new s(0,0,0),fh=new s(0,0,0);var hh=new s(0,0,0),dh=new s(0,0,0);var vh,mh,ph,gh,yh,xh,Sh,Ch,Th,Eh,Ah,bh,wh,Ih,Rh,Oh,Ph,Nh,Dh,zh,Mh,Lh,Fh,kh,Uh,Bh,Gh,jh,Vh,Hh,qh,Wh,Xh,Yh,Kh,Qh,Jh,Zh,$h=null,ed=null,td=e("a0",function(){function e(){o(this,e),this._enabled=!1,this._isRGBE=!1,this._useIBL=!1,this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null}return r(e,[{key:"activate",value:function(){var e=a.director.root.pipeline;if(this._globalDescriptorSet=e.descriptorSet,this._default=Ys.get("default-cube-texture"),this._model||(this._model=new R_),ed)ed.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE});else{var t=new ol;t.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:this._isRGBE}}),ed=new cl({parent:t})}$h||($h=Vf(qf({width:2,height:2,length:2}))),this._model.initSubModel(0,$h.renderingSubMeshes[0],ed),this.envmap=this._envmap,this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=this._useIBL?this._isRGBE?2:1:0,t=a.director.root,n=t.pipeline;n.macros.CC_USE_IBL!==e&&(n.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())}},{key:"_updateGlobalBinding",value:function(){var e=this.envmap.getGFXTexture(),t=ta.getSampler(a.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(Da.binding,t),this._globalDescriptorSet.bindTexture(Da.binding,e)}},{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._enabled?this.activate():this._updatePipeline())}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return this._isRGBE},set:function(e){this._isRGBE=e,this._enabled&&(ed&&ed.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this._model&&this._model.setSubModelMaterial(0,ed)),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(a.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}}]),e}()),nd=new s(0,0,-1),id=new X,rd=new f,od=new f,ad=new f,sd=new f,cd=(e("a1",function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this)))._dir=new s(1,-1,-1),e._size=.15,e._range=5,e._luminance=1700/Tf(e._size),e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._type=xf.SPOT,e._aabb=Wr.create(),e._frustum=eo.create(),e._pos=new s,e}return c(t,e),r(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),r(t,[{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),s.transformQuat(this._dir,nd,this._node.getWorldRotation(id)),s.normalize(this._dir,this._dir),Wr.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(rd),f.invert(rd,rd),f.perspective(od,this._angle,1,.001,this._range),f.multiply(ad,od,rd),this._frustum.update(ad,sd),this._needUpdate=!1)}}]),t}(Ef)),function e(){o(this,e),this.material=null,this.vertexCount=0,this.indicesCount=0}),ld=e("dd",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r)))).vData=null,n.uvDirty=!0,n.vertDirty=!0,n._data=[],n._indices=[],n._pivotX=0,n._pivotY=0,n._width=0,n._height=0,n}return c(t,e),r(t,[{key:"updateSizeNPivot",value:function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)}},{key:"clear",value:function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}},{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)ud.free(t[i]);for(i=n;i<e;i++)t[i]=ud.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}],[{key:"add",value:function(){return _d.add()}},{key:"remove",value:function(e){var t=_d.data.indexOf(e);-1!==t&&(_d.data[t].clear(),_d.removeAt(t))}}]),t}(cd)),ud=(e("d$",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n.vertexStart=0,n.indicesStart=0,n.byteStart=0,n.byteCount=0,n._formatByte=9*Float32Array.BYTES_PER_ELEMENT,n}return c(t,e),r(t,[{key:"request",value:function(e,t){var n=this.byteCount+e*this._formatByte,i=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;var c=new Float32Array(this.vData.buffer);this.vData=new Float32Array(a),this.vData.set(c,0);var l=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(s),this.iData.set(l,0)}return this.vertexCount+=e,this.indicesCount+=t,this.byteCount=n,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0}}]),t}(cd)),new ye((function(){return{x:0,y:0,z:0,u:0,v:0,color:xe.WHITE.clone()}}),128)),_d=new pt((function(){return new ld}),32),fd={parent:null,owner:null,subModelIdx:0},hd=e("d4",(vh=A("cc.RenderableComponent"),mh=U([ol]),ph=U(ol),gh=Ee(),vh((Sh=b((xh=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_materials",Sh,F(n)),R(n,"_visFlags",Ch,F(n)),n._materialInstances=[],n._models=[],n}return c(t,e),r(t,[{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof cl&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n?n.parent!==this._materials[t]&&(n.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){fd.parent=this._materials[e],fd.owner=this,fd.subModelIdx=e;var t=new cl(fd);this.setMaterialInstance(e,t)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_collectModels",value:function(){return this._models}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisibilityChange",value:function(e){}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(n,null);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(i,e[i])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}(ue)).prototype,"_materials",[mh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ch=b(xh.prototype,"_visFlags",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ma.Enum.NONE}}),b(xh.prototype,"sharedMaterials",[ph,gh],Object.getOwnPropertyDescriptor(xh.prototype,"sharedMaterials"),xh.prototype),yh=xh))||yh));a.RenderableComponent=hd;var dd=p({OFF:0,ON:1}),vd=p({OFF:0,ON:1}),md=(Th=A("cc.ModelLightmapSettings"),Eh=Ae("_recieveShadow"),Th((wh=b((bh=function(){function e(){o(this,e),R(this,"texture",wh,this),R(this,"uvParam",Ih,this),R(this,"_bakeable",Rh,this),R(this,"_castShadow",Oh,this),R(this,"_receiveShadow",Ph,this),R(this,"_lightmapSize",Nh,this)}return r(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}()).prototype,"texture",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ih=b(bh.prototype,"uvParam",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new m}}),Rh=b(bh.prototype,"_bakeable",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oh=b(bh.prototype,"_castShadow",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ph=b(bh.prototype,"_receiveShadow",[Eh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Nh=b(bh.prototype,"_lightmapSize",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),b(bh.prototype,"bakeable",[I],Object.getOwnPropertyDescriptor(bh.prototype,"bakeable"),bh.prototype),b(bh.prototype,"castShadow",[I],Object.getOwnPropertyDescriptor(bh.prototype,"castShadow"),bh.prototype),b(bh.prototype,"receiveShadow",[I],Object.getOwnPropertyDescriptor(bh.prototype,"receiveShadow"),bh.prototype),b(bh.prototype,"lightmapSize",[I],Object.getOwnPropertyDescriptor(bh.prototype,"lightmapSize"),bh.prototype),Ah=bh))||Ah),pd=(e("as",(Dh=A("cc.MeshRenderer"),zh=de(),Mh=dt(100),Lh=ve(),Fh=U(dd),kh=pe(),Uh=U(vd),Bh=pe(),Gh=U(us),jh=pe(),Vh=be(),Dh(Hh=zh(Hh=Mh(Hh=Lh(Hh=he((Zh=Jh=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"lightmapSettings",Wh,F(e)),R(e,"_mesh",Xh,F(e)),R(e,"_shadowCastingMode",Yh,F(e)),R(e,"_shadowReceivingMode",Kh,F(e)),e._modelType=void 0,e._model=null,e._morphInstance=null,R(e,"_enableMorph",Qh,F(e)),e._modelType=R_,e}return c(t,e),r(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t,n=this._mesh;this._mesh=e,null===(t=this._mesh)||void 0===t||t.initialize(),this._watchMorphInMesh(),this._onMeshChanged(n),this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),r(t,[{key:"onLoad",value:function(){var e;null===(e=this._mesh)||void 0===e||e.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onRestore",value:function(){this._updateModels()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(a.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}},{key:"setWeights",value:function(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)}},{key:"setInstancedAttribute",value:function(e,t){if(this.model)for(var n=this.model.instancedAttributes.list,i=0;i<n.length;i++)if(n[i].name===e){n[i].view.set(t);break}}},{key:"_updateLightmap",value:function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()}},{key:"_updateModels",value:function(){this.enabledInHierarchy&&this._mesh&&(this._model?(this._model.destroy(),this._model.initialize(this.node)):this._createModel(),this._updateModelParams(),this._onUpdateLightingmap())}},{key:"_createModel",value:function(){var e=!!this._morphInstance&&this._modelType===R_?O_:this._modelType;this._model=a.director.root.createModel(e),this._model.visFlags=this.visibility,this._model.initialize(this.node),this._models.length=0,this._models.push(this._model),this._morphInstance&&this._model instanceof O_&&this._model.setMorphRendering(this._morphInstance)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!=this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=tu.POSITION,this._model.transform.hasChangedFlags|=tu.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.subMeshCount:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n),r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0}}},{key:"_onUpdateLightingmap",value:function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)}},{key:"_getBuiltinMaterial",value:function(){return Ys.get("missing-material")}},{key:"_onVisibilityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===dd.OFF?this._model.castShadow=!1:(H(this._shadowCastingMode===dd.ON,"ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")),this._model.castShadow=!0))}},{key:"_updateReceiveShadow",value:function(){this._model&&(this._shadowReceivingMode===vd.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}},{key:"_isBatchingEnabled",value:function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n){if(t.passes[n].batchingScheme)return!0}}return!1}},{key:"_watchMorphInMesh",value:function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){var e=this._mesh.struct.morph;this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,n=0;n<t;++n){var i=e.subMeshMorphs[n];if(i){var r=i.weights||e.weights,o=r?r.slice():new Array(i.targets.length).fill(0);this._morphInstance.setWeights(n,o)}}this._model&&this._model instanceof O_&&this._model.setMorphRendering(this._morphInstance)}}},{key:"_syncMorphWeights",value:function(e){if(this._morphInstance){var t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}}}]),t}(hd),Jh.ShadowCastingMode=dd,Jh.ShadowReceivingMode=vd,Wh=b((qh=Zh).prototype,"lightmapSettings",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new md}}),Xh=b(qh.prototype,"_mesh",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yh=b(qh.prototype,"_shadowCastingMode",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dd.OFF}}),Kh=b(qh.prototype,"_shadowReceivingMode",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vd.ON}}),b(qh.prototype,"shadowCastingMode",[Fh,kh],Object.getOwnPropertyDescriptor(qh.prototype,"shadowCastingMode"),qh.prototype),b(qh.prototype,"receiveShadow",[Uh,Bh],Object.getOwnPropertyDescriptor(qh.prototype,"receiveShadow"),qh.prototype),b(qh.prototype,"mesh",[Gh,jh],Object.getOwnPropertyDescriptor(qh.prototype,"mesh"),qh.prototype),b(qh.prototype,"enableMorph",[Vh],Object.getOwnPropertyDescriptor(qh.prototype,"enableMorph"),qh.prototype),Qh=b(qh.prototype,"_enableMorph",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hh=qh))||Hh)||Hh)||Hh)||Hh)||Hh)),new s);function gd(e,t,n,i){i||(i=new s),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function yd(e,t,n){return n||(n=new s),e.worldToScreen(t,n),n.x=n.x/a.view.getScaleX(),n.y=n.y/a.view.getScaleY(),n}var xd=e("aL",{WorldNode3DToLocalNodeUI:gd,WorldNode3DToWorldNodeUI:yd});a.pipelineUtils=xd,T(a.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||pd;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]);var Sd,Cd,Td,Ed,Ad,bd,wd,Id=Object.freeze({__proto__:null,ccclass:A,property:i,requireComponent:ht,executionOrder:dt,disallowMultiple:vt,executeInEditMode:he,menu:ve,playOnFocus:we,inspector:Ie,icon:Re,help:de,type:U,integer:Oe,float:Pe,boolean:Ne,string:De});e("aM",Id);var Rd=A("cc.MissingClass")((Td=b((Cd=function e(){o(this,e),R(this,"_$erialized",Td,this)}).prototype,"_$erialized",[w,ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sd=Cd))||Sd,Od=e("d1",A("cc.MissingScript")(Ed=Ie()((bd=b((Ad=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"compiled",bd,F(e)),R(e,"_$erialized",wd,F(e)),e}return c(t,e),r(t,null,[{key:"safeFindClass",value:function(e,n){var i=Le(e);return i||(e?(a.deserialize.reportMissingClass(e),t.getMissingWrapper(e,n)):null)}},{key:"getMissingWrapper",value:function(e,n){return n.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||Me.test(e))?t:Rd}}]),r(t,[{key:"onLoad",value:function(){N(4600,this.node.name)}}]),t}(ue)).prototype,"compiled",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wd=b(Ad.prototype,"_$erialized",[w,ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ed=Ad))||Ed)||Ed);a._MissingScript=Od;var Pd=function(){function e(){o(this,e),this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=Ge(!0)}return r(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,ke(this._stillUseUrl)}},{key:"push",value:function(e,t,n,i){i&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(n),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();function Nd(e,t,n,i,r,o){if(t instanceof a.ValueType){r||e.push("if(prop){");var s=qe(t);e.push("s._deserializeTypedObject(o".concat(n,",prop,").concat(s,");")),r||e.push("}else o"+n+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+i+",null,"+!!o+");"),e.push("}else o"+n+"=null;")}Pd.pool=void 0,Pd.pool=new Fe((function(e){e.reset()}),10),Pd.pool.get=function(){return this._get()||new Pd};function Dd(e,t,n,i,r){var o;i.hasOwnProperty("__deserialize__")?o=i.__deserialize__:(o=function(e,t){for(var n=je+"type",i=je+"default",r=je+"saveUrlAsAsset",o=je+"formerlySerializedAs",s=Ue(t),c=t.__values__,l=["var prop;"],u=Me.test(He(t)),_=0;_<c.length;_++){var f=c[_],h=void 0,d=void 0;g.IDENTIFIER_RE.test(f)?(d='"'+f+'"',h="."+f):h="["+(d=g.escapeForJS(f))+"]";var v=h;if(s[f+o]){var m=s[f+o];v=g.IDENTIFIER_RE.test(m)?"."+m:"["+g.escapeForJS(m)+"]"}l.push("prop=d"+v+";"),l.push("if(typeof ".concat("prop",'!=="undefined"){'));var p=s[f+r],y=g.getDefault(s[f+i]);if(u){var x=void 0,S=s[f+n];if(void 0===y&&S)x=S===a.String||S===a.Integer||S===a.Float||S===a.Boolean;else{var C=se(y);x="string"===C&&!p||"number"===C||"boolean"===C}x?l.push("o".concat(h,"=prop;")):Nd(l,y,h,d,!0,p)}else l.push("if(typeof ".concat("prop",'!=="object"){')+"o"+h+"=prop;}else{"),Nd(l,y,h,d,!1,p),l.push("}");l.push("}")}return(a.js.isChildClassOf(t,a._BaseNode)||a.js.isChildClassOf(t,a.Component))&&l.push("d._id&&(o._id=d._id);"),"_$erialized"===c[c.length-1]&&(l.push("o._$erialized=JSON.parse(JSON.stringify(d));"),l.push("s._deserializePrimitiveObject(o._$erialized,d);")),Function("s","o","d","k","t",l.join(""))}(0,i),Ve(i,"__deserialize__",o,!0)),o(e,t,n,i,r)}var zd=function(){function e(t,n,i,r,a){o(this,e),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=t,this.customEnv=r,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return r(e,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,n=t.length;this.deserializedList.length=n;for(var i=0;i<n;i++)t[i]&&(this.deserializedList[i]=this._deserializeObject(t[i],!1));this.deserializedData=n>0?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,n,i,r=e.deserializedList,o=e._idPropList,a=e._idList,s=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<a.length;t++)n=o[t],i=a[t],s[t][n]=r[i]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,n,i,r){var o,s=null,c=null,l=e.__type__;if("TypedArray"===l){var u=e.array;s=new window[e.ctor](u.length);for(var _=0;_<u.length;++_)s[_]=u[_];return s}if(l){if(!(c=this._classFinder(l,e,i,r)))return this._classFinder===Le&&a.deserialize.reportMissingClass(l),null;var f=this;(s=new c)._deserialize?s._deserialize(e.content,f):a.Class._isCCClass(c)?Dd(f,s,e,c,n):f._deserializeTypedObject(s,e,c)}else if(Array.isArray(e)){s=new Array(e.length);for(var h=0;h<e.length;h++)o=e[h],"object"===se(o)&&o?this._deserializeObjField(s,o,""+h,null,t):s[h]=o}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,n,i,r){var o=t.__id__;if(void 0===o){var a=t.__uuid__;a?this.result.push(e,n,a,r):e[n]=this._deserializeObject(t,r)}else{var s=this.deserializedList[o];s?e[n]=s:(this._idList.push(o),this._idObjList.push(e),this._idPropList.push(n))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!==se(i)?"__type__"!==n&&(e[n]=i):i?this._deserializeObjField(e,i,n):e[n]=null}}},{key:"_deserializeTypedObject",value:function(e,t,n){if(n===a.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===a.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==a.Color){if(n===a.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=je+"default",r=Ue(n),o=n.__props__||Object.keys(e),s=0;s<o.length;s++){var c=o[s],l=t[c];void 0!==l&&t.hasOwnProperty(c)||(l=g.getDefault(r[c+i])),"object"!==se(l)?e[c]=l:l?this._deserializeObjField(e,l,c):e[c]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var u=t.a;e.a=void 0===u?255:u}}}]),e}();function Md(e,t,n){var i=(n=n||{}).classFinder||Le,r=n.createAssetRefs||a.sys.platform===a.sys.EDITOR_CORE,o=Be,s=n.customEnv,c=n.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var l=!t;t=t||Pd.pool.get();var u=zd.pool.get(t,o,i,s,c);a.game._isCloning=!0;var _=u.deserialize(e);return a.game._isCloning=!1,zd.pool.put(u),r&&t.assignAssetsBy(EditorExtends.serialize.asAsset),l&&Pd.pool.put(t),_}zd.pool=void 0,zd.pool=new Fe((function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0}),1),zd.pool.get=function(e,t,n,i,r){var o=this._get();return o?(o.result=e,o.customEnv=i,o._classFinder=n,o):new zd(e,t,n,i,r)},Md.Details=Pd,Md.reportMissingClass=function(e){N(5302,e)},a.deserialize=Md;var Ld,Fd,kd,Ud,Bd,Gd,jd,Vd,Hd,qd,Wd,Xd=ne.Flags.Destroyed,Yd=ne.Flags.PersistentMask,Kd=[];function Qd(e,t){var n;if(e instanceof ne){if(e._instantiate)return a.game._isCloning=!0,n=e._instantiate(),a.game._isCloning=!1,n;if(e instanceof a.Asset)throw new TypeError(ce(6903))}return a.game._isCloning=!0,n=Jd(e),a.game._isCloning=!1,n}function Jd(e,t){var n;if(e._iN$t)n=e._iN$t;else if(e.constructor){n=new(0,e.constructor)}else n=Object.create(null);Zd(e,n,t);for(var i=0,r=Kd.length;i<r;++i)Kd[i]._iN$t=null;return Kd.length=0,n}function Zd(e,t,n){Ve(e,"_iN$t",t,!0),Kd.push(e);var i=e.constructor;if(a.Class._isCCClass(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"===se(s)&&s){var c=n[a];c instanceof We&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||$d(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var o=e[r];if("object"===se(o)&&o){if(o===t)continue;t[r]=o._iN$t||$d(o,n)}else t[r]=o}e instanceof ne&&(t._objFlags&=Yd)}function $d(e,t){if(e instanceof We)return e.clone();if(e instanceof a.Asset)return e;var n;if(Array.isArray(e)){var i=e.length;n=new Array(i),e._iN$t=n;for(var r=0;r<i;++r){var o=e[r];"object"===se(o)&&o?n[r]=o._iN$t||$d(o,t):n[r]=o}return Kd.push(e),n}if(e._objFlags&Xd)return null;var s=e.constructor;if(a.Class._isCCClass(s)){if(t)if(t instanceof a.Component){if(e instanceof a._BaseNode||e instanceof a.Component)return e}else if(t instanceof a._BaseNode)if(e instanceof a._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof a.Component&&!e.node.isChildOf(t))return e;n=new s}else if(s===Object)n={};else{if(s)return e;n=Object.create(null)}return Zd(e,n,t),n}Qd._clone=Jd,a.instantiate=Qd,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(qd||(qd={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Wd||(Wd={}));function ev(e,t){return(t<<3)+e}e("aP",A("cc.CompactValueTypeArray")((Vd=jd=function(){function e(){o(this,e),R(this,"_byteOffset",kd,this),R(this,"_unitCount",Ud,this),R(this,"_unitElement",Bd,this),R(this,"_length",Gd,this)}return r(e,[{key:"decompress",value:function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=tv(n.elementType),o=new(nv(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a}}],[{key:"lengthFor",value:function(e,t,n){return tv(t).requiredUnits*e.length*nv(n).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,n,i,r,o,a){for(var s=tv(n),c=nv(i),l=s.requiredUnits*t.length,u=new c(r,o,l),_=0;_<t.length;++_)s.compress(u,_,t[_]);var f=new e;return f._unitElement=ev(i,n),f._byteOffset=a,f._unitCount=l,f._length=t.length,f}}]),e}(),jd.StorageUnit=qd,jd.ElementType=Wd,kd=b((Fd=Vd).prototype,"_byteOffset",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ud=b(Fd.prototype,"_unitCount",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bd=b(Fd.prototype,"_unitElement",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ev(qd.Uint8,Wd.Scalar)}}),Gd=b(Fd.prototype,"_length",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ld=Fd))||Ld);function tv(e){return iv[e]}function nv(e){switch(e){case qd.Uint8:return Uint8Array;case qd.Uint16:return Uint16Array;case qd.Uint32:return Uint32Array;case qd.Int8:return Int8Array;case qd.Int16:return Int16Array;case qd.Int32:return Int32Array;case qd.Float32:return Float32Array;case qd.Float64:return Float64Array}}var iv=(O(Hd={},Wd.Scalar,{requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}}),O(Hd,Wd.Vec2,{requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new s(e[2*t],e[2*t+1])}}),O(Hd,Wd.Vec3,{requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new s(e[3*t],e[3*t+1],e[3*t+2])}}),O(Hd,Wd.Vec4,{requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new m(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),O(Hd,Wd.Quat,{requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new X(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),O(Hd,Wd.Mat4,{requiredUnits:16,compress:function(e,t,n){f.toArray(e,n,16*t)},decompress:function(e,t){return f.fromArray(new f,e,16*t)}}),Hd);function rv(e){var t=[];return function e(t,n){for(var i,r=z(n);!(i=r()).done;){var o=i.value;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}a._decorator=Id;var ov=ne.Flags.Destroyed,av=ne.Flags.PersistentMask,sv=je+"default",cv=g.IDENTIFIER_RE,lv={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},uv=g.escapeForJS,_v=function(){function e(t,n){o(this,e),this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=n}return r(e,[{key:"toString",value:function(){return"var "+this.varName+"="+this.expression+";"}}]),e}();function fv(e,t){return t instanceof _v?new _v(t.varName,e+t.expression):e+t}function hv(e,t,n){Array.isArray(n)?(n[0]=fv(t,n[0]),e.push(n)):e.push(fv(t,n)+";")}var dv=function(){function e(t){o(this,e),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}return r(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];hv(e,t+vv(i[0])+"=",i[1])}}}]),e}();function vv(e){return cv.test(e)?"."+e:"["+uv(e)+"]"}dv.pool=void 0,dv.pool=new Fe((function(e){e._exps.length=0,e._targetExp=null}),1),dv.pool.get=function(e){var t=this._get()||new dv;return t._targetExp=e,t};var mv,pv,gv,yv,xv,Sv,Cv,Tv=function(){function e(t,n){var i;o(this,e),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=n,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Ge(),oe(this.funcModuleCache,lv),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i="var "+this.globalVariables.join(",")+";");var r=rv(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var a=0,s=this.objsToClear_iN$t.length;a<s;++a)this.objsToClear_iN$t[a]._iN$t=null;this.objsToClear_iN$t.length=0}return r(e,[{key:"getFuncModule",value:function(e,t){var n=qe(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,n,i){var r=dv.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),dv.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,n){for(var i=n.__values__,r=Ue(n),o=0;o<i.length;o++){var s=i[o],c=t[s],l=r[s+sv];if(!Ev(l,c))if("object"===se(c)&&c instanceof a.ValueType&&(l=g.getDefault(l))&&l.constructor===c.constructor){var u="o"+vv(s);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,s,c)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new _v(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i){hv(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]))}return n}},{key:"enumerateField",value:function(e,t,n){if("object"===se(n)&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=fv(r+"=",o)}return r}return Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?uv(n):("_objFlags"===t&&e instanceof ne&&(n&=av),n)}},{key:"setObjProp",value:function(e,t,n,i){hv(e,"o"+vv(n)+"=",this.enumerateField(t,n,i))}},{key:"enumerateObject",value:function(e,t){var n=t.constructor;if(a.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"===se(r)&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof a.ValueType)return g.getNewValueTypeCode(e);if(e instanceof a.Asset)return this.getObjRef(e);if(e._objFlags&ov)return null;var t,n=e.constructor;if(a.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof a.Component){if(e instanceof a._BaseNode||e instanceof a.Component)return this.getObjRef(e)}else if(this.parent instanceof a._BaseNode)if(e instanceof a._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof a.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new _v("o","new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new _v("o","{}");else{if(n)return this.getObjRef(e);t=new _v("o","Object.create(null)")}var i=[t];return e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e),this.enumerateObject(i,e),["(function(){",i,"return o;})();"]}}]),e}();function Ev(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof a.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}var Av,bv,wv,Iv,Rv=p({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Ov=e("aR",A("cc.Prefab")((Cv=Sv=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"data",gv,F(e)),R(e,"optimizationPolicy",yv,F(e)),R(e,"asyncLoadAssets",xv,F(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return c(t,e),r(t,[{key:"createNode",value:function(e){var t=a.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){var e,t;this._createFunction=(e=this.data,t=e instanceof a._BaseNode&&e,new Tv(e,t).result)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:N(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==Rv.SINGLE_INSTANCE&&(this.optimizationPolicy===Rv.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(M),Sv.OptimizationPolicy=Rv,Sv.OptimizationPolicyThreshold=3,gv=b((pv=Cv).prototype,"data",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yv=b(pv.prototype,"optimizationPolicy",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rv.AUTO}}),xv=b(pv.prototype,"asyncLoadAssets",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mv=pv))||mv);a.Prefab=Ov,Xe(a,"cc._Prefab","Prefab");var Pv,Nv,Dv,zv=e("aS",A("cc.SceneAsset")((wv=b((bv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"scene",wv,F(n)),R(n,"asyncLoadAssets",Iv,F(n)),n}return c(t,e),t}(M)).prototype,"scene",[I,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Iv=b(bv.prototype,"asyncLoadAssets",[I,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Av=bv))||Av);a.SceneAsset=zv;var Mv,Lv,Fv,kv=e("aT",A("cc.SpriteAtlas")((Dv=b((Nv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"spriteFrames",Dv,F(n)),n}return c(t,e),r(t,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],n=0,i=Object.keys(this.spriteFrames);n<i.length;n++){var r=i[n],o=this.spriteFrames[r],a=o?o._uuid:"";a&&e&&(a=EditorExtends.UuidUtils.compressUuid(a,!0)),t.push(r),t.push(a)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Ge();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1])}}]),t}(M)).prototype,"spriteFrames",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ge()}}),Pv=Nv))||Pv);a.SpriteAtlas=kv;var Uv,Bv,Gv,jv=e("aU",A("cc.TextAsset")((Fv=b((Lv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"text",Fv,F(n)),n}return c(t,e),r(t,[{key:"toString",value:function(){return this.text}}]),t}(M)).prototype,"text",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mv=Lv))||Mv);a.TextAsset=jv;var Vv=e("aV",A("cc.JsonAsset")((Gv=b((Bv=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"json",Gv,F(n)),n}return c(t,e),t}(M)).prototype,"json",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uv=Bv))||Uv);a.JsonAsset=Vv;var Hv="0123456789abcdef".split(""),qv=["","","",""],Wv=qv.concat(qv,"-",qv,"-",qv,"-",qv,"-",qv,qv,qv),Xv=Wv.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Yv(e){var t=e.split("@")[0];if(22!==t.length)return e;Wv[0]=e[0],Wv[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=Ye[e.charCodeAt(n)],o=Ye[e.charCodeAt(n+1)];Wv[Xv[i++]]=Hv[r>>2],Wv[Xv[i++]]=Hv[(3&r)<<2|o>>4],Wv[Xv[i++]]=Hv[15&o]}return e.replace(t,Wv.join(""))}var Kv=e("cQ",{_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=a.loader._getResUuid(e.slice(10),a.Asset,null,!0);if(t)return a.AssetLibrary.getLibUrlNoExt(t,!0)+Tt(e)}else k(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=Ot(e)+"/"}});a.url=Kv;var Qv=function e(t,n){o(this,e),this.uuid=void 0,this.type=void 0,this.uuid=t,this.type=n};function Jv(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}var Zv,$v=function(){function e(){o(this,e),this._pathToUuid=void 0,this._pathToUuid=Ge(!0)}return r(e,[{key:"getUuid",value:function(e,t){e=Kv.normalize(e);var n=this._pathToUuid[e];if(n)if(Array.isArray(n)){if(!t)return n[0].uuid;for(var i=0;i<n.length;i++){var r=n[i];if(le(r.type,t))return r.uuid}}else if(!t||le(n.type,t))return n.uuid;return""}},{key:"getUuidArray",value:function(e,t,n){"/"===(e=Kv.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var i=this._pathToUuid,r=[];for(var o in i)if(o.startsWith(e)&&Jv(o,e)||!e){var a=i[o];if(Array.isArray(a))for(var s=0;s<a.length;s++){var c=a[s];t&&!le(c.type,t)||(r.push(c.uuid),n&&n.push(o))}else t&&!le(a.type,t)||(r.push(a.uuid),n&&n.push(o))}return r}},{key:"add",value:function(e,t,n,i){i&&(e=e.substring(0,e.length-Tt(e).length));var r=new Qv(t,n);Ke(this._pathToUuid,e,r,i)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var n=this._pathToUuid,i=Object.keys(n),r=0;r<i.length;++r){var o=i[r],a=n[o];if(Array.isArray(a))for(var s=0;s<a.length;s++){var c=a[s];if(c.uuid===e)return t.path=o,t.type=c.type,!0}else if(a.uuid===e)return t.path=o,t.type=a.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=Ge(!0)}}]),e}(),em=0|998*Math.random(),tm=Ge(!0),nm=[];!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(Zv||(Zv={}));var im=Ge(!0);function rm(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var n={};return t[1].split("&").forEach((function(e){var t=e.split("=");n[t[0]]=t[1]})),n}}}function om(e,t){var n="object"===se(e)?e.url:e,i={queueId:t,id:n,url:n,rawUrl:void 0,urlParam:rm(n),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:e.uuid&&a.game._sceneInfos.find((function(t){return t.uuid===e.uuid}))};if("object"===se(e)&&(oe(i,e),e.skips))for(var r=0;r<e.skips.length;r++){var o=e.skips[r];i.states[o]=Zv.COMPLETE}return i.rawUrl=i.url,n&&!i.type&&(i.type=Tt(n).toLowerCase().substr(1)),i}var am=[];function sm(e,t,n){if(!e||!t)return!1;var i=!1;if(am.push(t.id),t.deps){var r,o,a=t.deps;for(r=0;r<a.length;r++){if((o=a[r]).id===e.id){i=!0;break}if(!(am.indexOf(o.id)>=0)&&(o.deps&&sm(e,o,!0))){i=!0;break}}}return n||(am.length=0),i}var cm=e("cV",function(e){function t(e,n,i,r){var a;return o(this,t),(a=l(this,u(t).call(this))).onProgress=void 0,a.onComplete=void 0,a.map=Ge(!0),a.completed={},a.totalCount=0,a.completedCount=0,a.active=void 0,a._id=void 0,a._pipeline=void 0,a._errorUrls=[],a._appending=!1,a._ownerQueue=null,a._id=++em,tm[a._id]=F(a),a._pipeline=e,a.onProgress=i,a.onComplete=r,a._pipeline?a.active=!0:a.active=!1,n&&(n.length>0?a.append(n):a.allComplete()),a}return c(t,e),r(t,[{key:"append",value:function(e,n){var i=this;if(!this.active)return[];n&&!n.deps&&(n.deps=[]),this._appending=!0;var r,o,a,s,c=[];for(r=0;r<e.length;++r){if((o=e[r]).queueId&&!this.map[o.id]){if(this.map[o.id]=o,n&&n.deps.push(o),o.complete||sm(n,o)){this.totalCount++,this.itemComplete(o.id);continue}if("continue"===function(){var e=i,r=tm[o.queueId];return r&&(i.totalCount++,t.registerQueueDep(n||i._id,o.id),r.addListener(o.id,(function(t){e.itemComplete(t.id)}))),"continue"}())continue}if("string"==typeof((s=o).url||s)){var l=(a=om(o,this._id)).id;this.map[l]||(this.map[l]=a,this.totalCount++,n&&n.deps.push(a),t.registerQueueDep(n||this._id,l),c.push(a))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(c),c}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=im[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],n=null;return t&&(t.content?n=t.content:t.alias&&(n=t.alias.content)),n}},{key:"getError",value:function(e){var t=this.map[e],n=null;return t&&(t.error?n=t.error:t.alias&&(n=t.alias.error)),n}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var n=this.map[e];if(n){var i=this._errorUrls.indexOf(e);if(n.error&&-1===i?this._errorUrls.push(e):n.error||-1===i||this._errorUrls.splice(i,1),t.finishDep(n.id),this.emit(e,n),this.removeAll(e),this.completed[e]=n,this.completedCount++,this.onProgress){var r=im[this._id];this.onProgress(r?r.completed.length:this.completedCount,r?r.deps.length:this.totalCount,n)}!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=Ge(!0),this.completed={},this.totalCount=0,this.completedCount=0,this.clear(),tm[this._id]=null,im[this._id]&&(im[this._id].completed.length=0,im[this._id].deps.length=0),-1===nm.indexOf(this)&&nm.length<10&&nm.push(this)}},{key:"addListener",value:function(e,n,i){return D(u(t.prototype),"on",this).call(this,e,n,i)}},{key:"hasListener",value:function(e,n,i){return D(u(t.prototype),"hasEventListener",this).call(this,e,n,i)}},{key:"removeListener",value:function(e,n,i){return D(u(t.prototype),"off",this).call(this,e,n,i)}},{key:"removeAllListeners",value:function(e){D(u(t.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,n,i,r){void 0===i?"function"==typeof n&&(r=n,n=i=null):void 0===r&&("function"==typeof n?(r=i,i=n,n=null):(r=i,i=null));var o=nm.pop();return o?(o._pipeline=e,o.onProgress=i,o.onComplete=r,tm[o._id]=o,o._pipeline&&(o.active=!0),n&&o.append(n)):o=new t(e,n,i,r),o}},{key:"getQueue",value:function(e){return e.queueId?tm[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=tm[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=im[e._id];t?(t.completed.length=0,t.deps.length=0):t=im[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var n=e.queueId||e;if(!n)return!1;var i=im[n];if(i)-1===i.deps.indexOf(t)&&i.deps.push(t);else if(e.id)for(var r in im){var o=im[r];-1!==o.deps.indexOf(e.id)&&-1===o.deps.indexOf(t)&&o.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in im){var n=im[t];-1!==n.deps.indexOf(e)&&-1===n.completed.indexOf(e)&&n.completed.push(e)}}}]),t}(ie));cm.ItemState=new a.Enum(Zv),a.LoadingItems=cm;var lm=cm.ItemState;function um(e,t){var n=e.id,i=t.states[n],r=e.next,o=e.pipeline;if(!t.error&&i!==lm.WORKING&&i!==lm.ERROR)if(i===lm.COMPLETE)r?um(r,t):o.flowOut(t);else{t.states[n]=lm.WORKING;var a=e.handle(t,(function(e,i){e?(t.error=e,t.states[n]=lm.ERROR,o.flowOut(t)):(i&&(t.content=i),t.states[n]=lm.COMPLETE,r?um(r,t):o.flowOut(t))}));a instanceof Error?(t.error=a,t.states[n]=lm.ERROR,o.flowOut(t)):void 0!==a&&(null!==a&&(t.content=a),t.states[n]=lm.COMPLETE,r?um(r,t):o.flowOut(t))}}var _m=e("cT",function(){function e(t){o(this,e),this._pipes=void 0,this._cache=Ge(!0),this._pipes=t;for(var n=0;n<t.length;++n){var i=t[n];i.handle&&i.id&&(i.pipeline=this,i.next=n<t.length-1?t[n+1]:null)}}return r(e,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)N(4921);else if(this._pipes.indexOf(e)>0)N(4922);else{e.pipeline=this;var n=null;t<this._pipes.length&&(n=this._pipes[t]);var i=null;t>0&&(i=this._pipes[t-1]),i&&(i.next=e),e.next=n,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var n=this._pipes.indexOf(e);n<0||this.insertPipe(t,n+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,this._pipes.length>0&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,n,i=this._pipes[0];if(i){for(t=0;t<e.length;t++)(n=e[t]).isScene||(this._cache[n.id]=n);for(t=0;t<e.length;t++)um(i,n=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,n){return cm.create(this,(function(e,t){n(e,t),t.destroy()})).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,cm.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var n=0;n<t.length;++n)t[n].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t?(t.alias&&(t=t.alias),t):t}},{key:"removeItem",value:function(e){var t=this._cache[e];return t&&t.complete&&delete this._cache[e],t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),e}());_m.ItemState=lm,a.Pipeline=_m;var fm="MD5Pipe",hm=/(\.[^.\n\\/]*)$/,dm=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var vm=function(){function e(t,n,i){o(this,e),this.id=fm,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=fm,this.async=!1,this.pipeline=null,this.md5AssetsMap=t,this.md5NativeAssetsMap=n,this.libraryBase=i}return r(e,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var n=function(e){var t=e.match(dm);return t?t[1]:""}(e);if(n){var i=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[n];if(i)if(t){var r=a.path.dirname(e),o=a.path.basename(e);e="".concat(r,".").concat(i,"/").concat(o)}else{var s=!1;e=e.replace(hm,(function(e,t){return s=!0,"."+i+t})),s||(e=e+"."+i)}}return e}}]),e}();vm.ID=fm,_m.MD5Pipe=vm;var mm,pm=function(){function e(){o(this,e),this.jsons={}}return r(e,[{key:"load",value:function(e,t){t.length!==e.length&&k(4915);for(var n=0;n<e.length;n++){var i=e[n],r=t[n];this.jsons[i]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),gm=function(){function e(){o(this,e),this.contents={}}return r(e,[{key:"load",value:function(e,t){var n=t.data;n.length!==e.length&&k(4915);for(var i=0;i<e.length;i++)this.contents[e[i]]={base:n[i][0],mipmaps:n[i][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:Qe._getClassId(da),content:t}:null}}]),e}(),ym=/\?/;function xm(e){return a.game.config.noCache&&"string"==typeof e&&(ym.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function Sm(e,t){if(Array.isArray(e))for(var n=0,i=e.length;n<i;n++)Sm(e[n],t);else if("object"===se(e))for(var r in e)Sm(e[r],t),Number.isNaN(Number(r))||(e[t[r]]=e[r],delete e[r]);return null}!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(mm||(mm={}));var Cm=function e(){o(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=mm.Invalid},Tm={},Em={},Am={};function bm(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function wm(e){for(var t in Em=e,e)for(var n=e[t],i=0;i<n.length;i++){var r=n[i],o=1===n.length;Ke(Tm,r,t,o)}}function Im(e,t,n){var i=a.AssetLibrary.getLibUrlNoExt(t)+".json";a.loader.load({url:i,ignoreMaxConcurrency:!0},(function(i,r){if(i)return k(4916,e),n(i);var o=Rm(e,t,r);o?n(null,o):n(bm(e,t))}))}function Rm(e,t,n){var i=Am[t];if(i.state!==mm.Loaded){if("string"==typeof n&&(n=JSON.parse(n)),n.keys&&n.data){var r=n.keys;Sm(n=n.data,r)}Array.isArray(n)?i.unpacker=new pm:n.type===He(da)&&(i.unpacker=new gm),i.unpacker.load(Em[t],n),i.state=mm.Loaded}return i.unpacker.retrieve(e)}function Om(e){for(var t=mm.Invalid,n="",i=0;i<e.length;i++){var r=e[i],o=Am[r];if(o){var a=o.state;if(a===mm.Loaded)return r;a>t&&(t=a,n=r)}}return t!==mm.Invalid?n:e[0]}function Pm(e,t){var n=e.uuid,i=Tm[n];if(i){Array.isArray(i)&&(i=Om(i));var r=Am[i];if(r&&r.state===mm.Loaded){var o=r.unpacker.retrieve(n);return o||bm(n,i)}return r||(console.log("Create unpacker %s for %s",i,n),(r=Am[i]=new Cm).state=mm.Downloading),Im(n,i,t),null}}var Nm=Object.freeze({__proto__:null,initPacks:wm,_loadNewPack:Im,_doPreload:function(e,t){var n=Am[e];n||((n=Am[e]=new Cm).state=mm.Downloading),n.state!==mm.Loaded&&(n.unpacker=new pm,n.unpacker.load(Em[e],t),n.state=mm.Loaded)},_doLoadNewPack:Rm,_selectLoadedPack:Om,load:Pm}),Dm=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var zm=Object.create(null),Mm=function(){function e(t){o(this,e),this.id="SubPackPipe",this.async=!1,this.pipeline=null;var n=function(e){var n=t[e];n.uuids&&n.uuids.forEach((function(e){var t=Yv(e),i=t.split("@").map((function(e){return encodeURIComponent(e)}));t=i.join("@"),zm[t]=n.path}))};for(var i in t)n(i)}return r(e,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(Dm);return t?t[1]:""}(e);if(t){var n=zm[t];if(n)return e.replace("res/raw-assets/",n+"raw-assets/")}return e}}]),e}();Mm.ID="SubPackPipe",_m.SubPackPipe=Mm;var Lm="",Fm="",km=Ge(!0);function Um(e,t){this.url=e,this.type=t}var Bm,Gm=e("aW",{_uuidToAsset:{},loadAsset:function(e,t,n){if("string"!=typeof e)return Je(t,new Error("[AssetLibrary] uuid must be string"),null);var i={uuid:e,type:"uuid"};n&&n.existingAsset&&(i.existingAsset=n.existingAsset),a.loader.load(i,(function(e,n){e||!n?e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error")):(n.constructor,a.SceneAsset),t&&t(e,n)}))},getLibUrlNoExt:function(e,t){var n=(e=Yv(e)).split("@").map((function(e){return encodeURIComponent(e)}));return e=n.join("@"),(t?Fm+"assets/":Lm)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var n=km[e];return n&&!le(n.type,a.Asset)?(t.url=Fm+n.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in km},queryAssetInfo:function(e,t){var n=this._getAssetInfoInRuntime(e);t(null,n.url,n.raw)},parseUuidInEditor:function(e){},loadJson:function(e,t){var n=""+((new Date).getTime()+Math.random()),i={uuid:n,type:"uuid",content:e,skips:[a.loader.assetLoader.id,a.loader.downloader.id]};a.loader.load(i,(function(e,i){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else if(function(e){return e&&(e.constructor===a.SceneAsset||e instanceof a.Scene)}(i)){var r=a.loader._getReferenceKey(n);a.loader.removeItem(r)}i._uuid="",t&&t(e,i)}))},getAssetByUuid:function(e){return Gm._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),Lm=a.path.stripSep(t)+"/",Fm=e.rawAssetsBase;var n=e.md5AssetsMap;if(n&&n.import){var i=0,r=Ge(!0),o=n.import;for(i=0;i<o.length;i+=2){var s=Yv(o[i]).split("@").map((function(e){return encodeURIComponent(e)}));r[s.join("@")]=o[i+1]}var c=Ge(!0);for(o=n["raw-assets"],i=0;i<o.length;i+=2){var l=Yv(o[i]).split("@").map((function(e){return encodeURIComponent(e)}));c[l.join("@")]=o[i+1]}var u=new vm(r,c,Lm);a.loader.insertPipeAfter(a.loader.assetLoader,u),a.loader.md5Pipe=u}var _=e.subPackages;if(_){a.loader.downloader.setSubPackages(_);var f=new Mm(_);a.loader.insertPipeAfter(a.loader.assetLoader,f),a.loader.subPackPipe=f}var h=a.loader._assetTables;for(var d in h)h[d].reset();var v=e.rawAssets;if(v)for(var m in v){var p=v[m];for(var g in p){var y=p[g],x=y[0],S=y[1],C=Le(S);if(C){km[g]=new Um(m+"/"+x,C);var T=1===y[2];h[m]||(h[m]=new $v),h[m].add(x,g,C,!T)}else re("Cannot get",S)}}e.packedAssets&&wm(e.packedAssets),a.url._init(e.mountPaths&&e.mountPaths.assets||Fm+"assets")}});a.AssetLibrary=Gm;var jm,Vm,Hm,qm=e("b1",A("cc.Font")(Bm=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),t}(M))||Bm);a.Font=qm;var Wm,Xm,Ym,Km,Qm,Jm,Zm,$m,ep=e("a_",A("cc.TTFFont")((Hm=b((Vm=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_fontFamily",Hm,F(n)),n}return c(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),t}(qm)).prototype,"_fontFamily",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b(Vm.prototype,"_nativeAsset",[mt,De],Object.getOwnPropertyDescriptor(Vm.prototype,"_nativeAsset"),Vm.prototype),jm=Vm))||jm);a.TTFFont=ep;var tp,np=e("b0",(Wm=A("cc.BitmapFont"),Xm=U(Bs),Wm((Qm=b((Km=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"fntDataStr",Qm,F(n)),R(n,"spriteFrame",Jm,F(n)),R(n,"fontSize",Zm,F(n)),R(n,"fntConfig",$m,F(n)),n}return c(t,e),t}(qm)).prototype,"fntDataStr",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jm=b(Km.prototype,"spriteFrame",[Xm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zm=b(Km.prototype,"fontSize",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$m=b(Km.prototype,"fntConfig",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ym=Km))||Ym));a.BitmapFont=np;var ip=e("a$",A("cc.LabelAtlas")(tp=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),t}(np))||tp);a.LabelAtlas=ip;var rp=[],op=function(){function e(){o(this,e),this.id="AssetLoader",this.async=!0,this.pipeline=null}return r(e,[{key:"handle",value:function(e,t){var n=e.uuid;if(!n)return e.content||null;a.AssetLibrary.queryAssetInfo(n,(function(i,r,o){if(i)t(i);else if(e.url=e.rawUrl=r,e.isRawAsset=o,o){var a=Tt(r).toLowerCase();if(!a)return void t(new Error(ce(4931,n,r)));a=a.substr(1);var s=cm.getQueue(e);rp[0]={queueId:e.queueId,id:r,url:r,type:a,error:null,alias:e,complete:!0},s&&s.append(rp),e.type=a,t(null,e.content)}else e.type="uuid",t(null,e.content)}))}}]),e}();function ap(e,t){var n=a.loader.getItem(e);if(n){var i=n.dependKeys;if(i)for(var r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,ap(o,t))}}}function sp(e,t){if(e._uuid){var n=a.loader._getReferenceKey(e);t[n]||(t[n]=!0,ap(n,t))}}function cp(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=e[n[i]];if("object"===se(r)&&r)if(Array.isArray(r))for(var o=0;o<r.length;o++){var a=r[o];a instanceof Ze&&sp(a,t)}else if(r.constructor&&r.constructor!==Object)r instanceof Ze&&sp(r,t);else for(var s=Object.getOwnPropertyNames(r),c=0;c<s.length;c++){var l=r[s[c]];l instanceof Ze&&sp(l,t)}}}function lp(e,t){for(var n=0;n<e._components.length;n++)cp(e._components[n],t);for(var i=0;i<e._children.length;i++)lp(e._children[i],t)}function up(e){var t={};return ap(e,t),Object.keys(t)}function _p(e,t){var n=e.url,i=a.loader.getXMLHttpRequest(),r="Load binary data failed: "+n;i.open("GET",n,!0),i.responseType="arraybuffer",i.onload=function(){var e=i.response;e?t(null,e):t({status:i.status,errorMessage:r+"(no response)"})},i.onerror=function(){t({status:i.status,errorMessage:r+"(error)"})},i.ontimeout=function(){t({status:i.status,errorMessage:r+"(time out)"})},i.send(null)}function fp(e,t){var n=e.url;n=xm(n);var i=a.loader.getXMLHttpRequest(),r="Load text file failed: "+n;i.open("GET",n,!0),i.overrideMimeType&&i.overrideMimeType("text/plain; charset=utf-8"),i.onload=function(){4===i.readyState?200===i.status||0===i.status?t(null,i.responseText):t({status:i.status,errorMessage:r+"(wrong status)"}):t({status:i.status,errorMessage:r+"(wrong readyState)"})},i.onerror=function(){t({status:i.status,errorMessage:r+"(error)"})},i.ontimeout=function(){t({status:i.status,errorMessage:r+"(time out)"})},i.send(null)}function hp(){return null}function dp(e,t,n){var i=e.url,r=document,o=document.createElement("script");function a(){o.parentNode&&o.parentNode.removeChild(o),o.removeEventListener("load",a,!1),o.removeEventListener("error",s,!1),t(null,i)}function s(){o.parentNode&&o.parentNode.removeChild(o),o.removeEventListener("load",a,!1),o.removeEventListener("error",s,!1),t(new Error(ce(4928,i)))}o.async=!!n,o.src=xm(i),o.addEventListener("load",a,!1),o.addEventListener("error",s,!1),r.body.appendChild(o)}function vp(e,t,n,i){void 0===n&&(n=!0);var r=xm(e.url);function o(){i.removeEventListener("load",o),i.removeEventListener("error",a),i.id=e.id,t(null,i)}function a(){i.removeEventListener("load",o),i.removeEventListener("error",a),"https:"!==window.location.protocol&&i.crossOrigin&&"anonymous"===i.crossOrigin.toLowerCase()?vp(e,t,!1,i):t(new Error(ce(4930,r)))}if(i=i||new Image,n&&"file:"!==window.location.protocol?i.crossOrigin="anonymous":i.crossOrigin=null,i.complete&&i.naturalWidth>0&&i.src===r)return i;i.addEventListener("load",o),i.addEventListener("error",a),i.src=r}op.ID="AssetLoader",_m.AssetLoader=op;var mp={js:dp,png:vp,jpg:vp,bmp:vp,jpeg:vp,gif:vp,ico:vp,tiff:vp,webp:vp,image:vp,pvr:_p,pkm:_p,astc:_p,mp3:$e,ogg:$e,wav:$e,m4a:$e,txt:fp,xml:fp,vsh:fp,fsh:fp,atlas:fp,tmx:fp,tsx:fp,json:fp,ExportJson:fp,plist:fp,fnt:fp,font:hp,eot:hp,ttf:hp,woff:hp,svg:hp,ttc:hp,uuid:function(e,t){var n=Pm(e,t);return void 0===n?this.extMap.json(e,t):n||void 0},binary:_p,bin:_p,default:fp},pp=e("cR",function(){function e(t){o(this,e),this.id="Downloader",this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subPackages={},this.extMap=oe(t,mp)}return r(e,[{key:"setSubPackages",value:function(e){this._subPackages=e}},{key:"addHandlers",value:function(e){oe(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<a.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,t){var n=this,i=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<a.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=i.call(this,e,(function(e,i){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),t&&t(e,i)}))))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=i.call(this,e,t)))return r}else this._loadQueue.push({item:e,callback:t})}},{key:"loadSubpackage",value:function(e,t){var n=this._subPackages[e];n?n.loaded?t&&t():dp({url:n.path},(function(e){e||(n.loaded=!0),t&&t(e)})):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),e}());pp.ID="Downloader",pp.PackDownloader=Nm,_m.Downloader=pp;var gp=new(function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"parse",value:function(e){var t=this._parseXML(e),n=t.documentElement;if("plist"!==n.tagName)return N(5100),{};for(var i=null,r=0,o=n.childNodes.length;r<o&&1!==(i=n.childNodes[r]).nodeType;r++);return t=null,this._parseNode(i)}},{key:"_parseNode",value:function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},n=null,i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t}}]),t}(function(){function e(){o(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return r(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}()));function yp(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function xp(e,t){var n,i;if("string"==typeof e.content)try{if(n=JSON.parse(e.content),!et&&n.keys&&n.data){var r=n.keys;Sm(n=n.data,r)}}catch(t){return new Error(ce(4923,e.id,t.stack))}else{if("object"!==se(e.content))return new Error(ce(4924));n=e.content}if(null==n)return new Error(ce(4923,e.id));var o=yp(n);i=o?a._MissingScript.safeFindClass:function(e){var t=Le(e);return t||(N(4903,e),Object)};var s,c=a.deserialize.Details.pool.get();try{s=a.deserialize(n,c,{classFinder:i,target:e.existingAsset,customEnv:e})}catch(t){return a.deserialize.Details.pool.put(c),console.error(t),new Error("Failed to load asset ".concat(e.id,", exception occurs during deserialization: ").concat(t.stack,"."))}s._uuid=e.uuid;var l=function(e,t,n,i){var r,o,s,c=n.uuidList,l=n.uuidObjList,u=n.uuidPropList,_=n._stillUseUrl,f=e.dependKeys=[];if(i)for(r=[],o=0;o<c.length;o++){s=c[o];var h=l[o],d=u[o],v=a.AssetLibrary._getAssetInfoInRuntime(s);if(v.raw){var m=v.url;h[d]=m,f.push(m)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:h,_ownerProp:d,_stillUseUrl:_[o]})}else{for(r=new Array(c.length),o=0;o<c.length;o++)s=c[o],r[o]={type:"uuid",uuid:s,_owner:l[o],_ownerProp:u[o],_stillUseUrl:_[o]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(e,s,c,function(e,t,n){var i=t.deferredLoadRaw;return i?e instanceof a.Asset&&e.constructor.preventDeferredLoadDependents&&(i=!1):n&&(e instanceof a.SceneAsset||e instanceof a.Prefab)&&(i=e.asyncLoadAssets),i}(s,e,o));a.deserialize.Details.pool.put(c);var u=function(e,n){if(!e&&n.onLoaded)try{n.onLoaded()}catch(t){e=t}t(e,n)};if(0===l.length)return u(null,s);!function(e,t,n,i,r){t.content=n;var o=t.dependKeys;e.flowInDeps(t,i,(function(e,t){var s,c=t.map;for(var l in c)(s=c[l]).uuid&&s.content&&(s.content._uuid=s.uuid);for(var u=0;u<i.length;u++){var _=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==n._uuid&&o.indexOf(e.id)<0&&o.push(e.id)},f=i[u],h=f.uuid,d=f.url;f._owner,f._ownerProp;if(s=c[d]){var v=f;if(s.complete||s.content)s.error?a._throw(s.error):_.call(v,s);else{var m=cm.getQueue(s);m&&m.addListener(h,_,v)}}}n instanceof a.SceneAsset&&n.scene&&function(){for(var e=Object.create(null),t=0,i=o.length;t<i;t++)e[o[t]]=!0,up(o[t]).forEach((function(t){e[t]=!0}));n.scene.dependAssets=Object.keys(e)}(),r(e,n)}))}(this.pipeline,e,s,l,u)}xp.isSceneObj=yp;var Sp,Cp=null,Tp={},Ep=-1,Ap=[],bp=function(){if(!Sp)if(window.FontFace){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);Sp=e?parseInt(e[1],10)>42:!t}else Sp=!1;return Sp};function wp(){for(var e=!0,t=Date.now(),n=Ap.length-1;n>=0;n--){var i=Ap[n],r=i.fontFamilyName;if(t-i.startTime>3e3)N(4933,r),i.callback(null,r),Ap.splice(n,1);else{var o=i.refWidth;Cp.font="40px "+r,o!==go(Cp,"BES bswy:->@123丁ぁᄁ")?(Ap.splice(n,1),i.callback(null,r)):e=!1}}e&&(clearInterval(Ep),Ep=-1)}function Ip(e,t){var n=e.url,i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL";-1!==n.indexOf(" ")&&(n='"'+n+'"');return n}(n);if(Tp[i])return i;if(!Cp){var r=document.createElement("canvas");r.width=100,r.height=100,Cp=r.getContext("2d")}var o="40px "+i;Cp.font=o;var a=go(Cp,"BES bswy:->@123丁ぁᄁ"),s=document.createElement("style");s.type="text/css";var c="";isNaN(i-0)?c+="@font-face { font-family:"+i+"; src:":c+="@font-face { font-family:'"+i+"'; src:",c+="url('"+n+"');",s.textContent=c+"}",document.body.appendChild(s);var l=document.createElement("div"),u=l.style;if(u.fontFamily=i,l.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(l),bp())!function(e,t,n){var i,r=new Promise((function(n,i){!function r(){Date.now()-e>=3e3?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),o=new Promise((function(e,t){i=setTimeout(t,3e3)}));Promise.race([o,r]).then((function(){i&&(clearTimeout(i),i=null),n(null,t)}),(function(){N(4933,t),n(null,t)}))}(Date.now(),i,t);else{var _={fontFamilyName:i,refWidth:a,callback:t,startTime:Date.now()};Ap.push(_),-1===Ep&&(Ep=setInterval(wp,100))}Tp[i]=s}function Rp(e){if("string"!=typeof e.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(e.content)}catch(t){return new Error("JSON Loader: Parse json ["+e.id+"] failed : "+t)}}function Op(e){if(e._owner instanceof a.Asset)return null;var t=e.content;if(a.sys.platform!==a.sys.FB_PLAYABLE_ADS&&!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var n=e.rawUrl,i=e.imageAsset||new Fo;return i._uuid=e.uuid,i._url=n,i._setRawAsset(n,!1),i._nativeAsset=t,i}function Pp(e,t){if(e._owner instanceof a.Asset)return null;var n=new a.AudioClip;return n._setRawAsset(e.rawUrl,!1),n._nativeAsset=e.content,n}function Np(e){return e.load?e.load(e.content):e.content}function Dp(e,t){return e[t]<<8|e[t+1]}var zp={png:Op,jpg:Op,bmp:Op,jpeg:Op,gif:Op,ico:Op,tiff:Op,webp:Op,image:Op,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,n=new Int32Array(t,0,13);if(55727696===n[0]){var i=n[7],r=n[6],o=n[12]+52;return t=t.slice(o,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:i,height:r}}if(559044176===n[11]){var a=n[0],s=n[1],c=n[2];return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:c,height:s}}return new Error("Invalid magic number in PVR header")},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,n=new Uint8Array(t),i=Dp(n,6);if(0!==i&&1!==i&&3!==i)return new Error("Invalid magic number in ETC header");var r=Dp(n,12),o=Dp(n,14);return Dp(n,8),Dp(n,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:o}},astc:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,n=new Uint8Array(t);if(1554098963!==n[0]+(n[1]<<8)+(n[2]<<16)+(n[3]<<24))return new Error("Invalid magic number in ASTC header");var i=n[4],r=n[5],o=n[6];if((i<3||i>6||r<3||r>6||o<3||o>6)&&(i<4||7===i||9===i||11===i||i>12||r<4||7===r||9===r||11===r||r>12||1!==o))return new Error("Invalid block number in ASTC header");var a=function(e,t){return 4===e?Io.RGBA_ASTC_4x4:5===e?4===t?Io.RGBA_ASTC_5x4:Io.RGBA_ASTC_5x5:6===e?5===t?Io.RGBA_ASTC_6x5:Io.RGBA_ASTC_6x6:8===e?5===t?Io.RGBA_ASTC_8x5:6===t?Io.RGBA_ASTC_8x6:Io.RGBA_ASTC_8x8:10===e?5===t?Io.RGBA_ASTC_10x5:6===t?Io.RGBA_ASTC_10x6:8===t?Io.RGBA_ASTC_10x8:Io.RGBA_ASTC_10x10:10===t?Io.RGBA_ASTC_12x10:Io.RGBA_ASTC_12x12}(i,r),s=n[7]+(n[8]<<8)+(n[9]<<16),c=n[10]+(n[11]<<8)+(n[12]<<16);return t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:s,height:c,format:a}},mp3:Pp,ogg:Pp,wav:Pp,m4a:Pp,json:Rp,ExportJson:Rp,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=gp.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:xp,prefab:xp,fire:xp,scene:xp,binary:Np,bin:Np,font:Ip,eot:Ip,ttf:Ip,woff:Ip,svg:Ip,ttc:Ip,default:function(){return null}},Mp=e("cS",function(){function e(t){o(this,e),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=oe(t,zp)}return r(e,[{key:"addHandlers",value:function(e){this.extMap=oe(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),e}());Mp.ID="Loader",_m.Loader=Mp;var Lp=Object.create(null);function Fp(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}Lp.assets=new $v,Lp.internal=new $v;var kp={url:null,raw:!1};function Up(e){var t,n,i;if("object"===se(e)){if(n=e,e.url)return n;t=e.uuid}else n={},t=e;return i=n.type?"uuid"===n.type:a.AssetLibrary._uuidInSettings(t),a.AssetLibrary._getAssetInfoInRuntime(t,kp),n.url=i?kp.url:t,kp.url&&"uuid"===n.type&&kp.raw?(n.type=null,n.isRawAsset=!0):i||(n.isRawAsset=!0),n}var Bp=[],Gp=[],jp=function(e){function t(){var e;o(this,t);var n=new op,i=new pp,r=new Mp;return(e=l(this,u(t).call(this,[n,i,r]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=Fp,e.assetLoader=n,e.md5Pipe=null,e.downloader=i,e.loader=r,e.onProgress=null,e._assetTables=Lp,e._autoReleaseSetting=Ge(!0),e}return c(t,e),r(t,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var i,r,o=this,a=!1;e instanceof Array?i=e:e?(a=!0,i=[e]):i=[],Bp.length=0;for(var s=0;s<i.length;++s){var c=i[s];if(c&&c.id&&(N(4920,c.id),c.uuid||c.url||(c.url=c.id)),(r=Up(c)).url||r.uuid){var l=this._cache[r.url];Bp.push(l||r)}}var u=cm.create(this,t,(function(e,t){Je((function(){if(n){if(a){var i=r.url;n.call(o,t.getError(i),t.getContent(i))}else n.call(o,e,t);n=null}t.destroy()}))}));cm.initQueueDeps(u),u.append(Bp),Bp.length=0}},{key:"flowInDeps",value:function(e,t,n){Gp.length=0;for(var i=0;i<t.length;++i){var r=Up(t[i]);if(r.url||r.uuid){var o=this._cache[r.url];o?Gp.push(o):Gp.push(r)}}var a=cm.create(this,e?function(e,t,n){a._ownerQueue&&a._ownerQueue.onProgress&&a._ownerQueue._childOnProgress(n)}:null,(function(t,i){n(t,i),e&&e.deps&&(e.deps.length=0),i.destroy()}));if(e){var s=cm.getQueue(e);a._ownerQueue=s&&s._ownerQueue||s}var c=a.append(Gp,e);return Gp.length=0,c}},{key:"loadRes",value:function(e,t,n,i,r){5!==arguments.length&&(r=i,i=n,n="assets");var o=this._parseLoadResArgs(t,i,r);t=o.type,i=o.onProgress,r=o.onComplete;var a=this,s=a._getResUuid(e,t,n,!0);s?this.load({type:"uuid",uuid:s},i,(function(e,t){t&&a.setAutoReleaseRecursively(s,!1),r&&r(e,t)})):a._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,n,i,r){if(5!==arguments.length&&(r=i,i=n,n="assets"),Lp[n]){var o=this._parseLoadResArgs(t,i,r);t=o.type,i=o.onProgress,r=o.onComplete;var a=[],s=Lp[n].getUuidArray(e,t,a);this._loadResUuids(s,i,(function(e,t,n){for(var i=t.length,o=0;o<i;++o)if(t[o]instanceof kv){var a=t[o].getSpriteFrames();for(var s in a){var c=a[s];t.push(c),n&&n.push("".concat(n[o],"/").concat(c.name))}}r&&r(e,t,n)}),a)}}},{key:"loadResArray",value:function(e,t,n,i,r){5!==arguments.length&&(r=i,i=n,n="assets");var o=this._parseLoadResArgs(t,i,r);t=o.type,i=o.onProgress,r=o.onComplete;for(var a=[],s=0;s<e.length;s++){var c=e[s],l=this._getResUuid(c,t,n,!0);if(!l)return void this._urlNotFound(c,t,r);a.push(l)}this._loadResUuids(a,i,r)}},{key:"getRes",value:function(e,t){var n=this._cache[e];if(!n){var i=this._getResUuid(e,t,null,!0);if(!i)return null;var r=this._getReferenceKey(i);n=this._cache[r]}return n&&n.alias&&(n=n.alias),n&&n.complete?n.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),n=up(t);return n.push(t),n}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];this.release(n)}else if(e){var i=this._getReferenceKey(e),r=this.getItem(i);if(r){this.removeItem(i);if((e=r.content)instanceof M){var o=e.nativeUrl;o&&this.release(o),e.destroy()}}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,n){var i=this._getResUuid(e,t,n,!0);i?this.release(i):k(4914,e)}},{key:"releaseResDir",value:function(e,t,n){if(Lp[n=n||"assets"])for(var i=Lp[n].getUuidArray(e,t),r=0;r<i.length;r++){var o=i[r];this.release(o)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=_m.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var n=this._getReferenceKey(e);n&&(this._autoReleaseSetting[n]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var n=this._getReferenceKey(e);if(n){this._autoReleaseSetting[n]=t;for(var i=up(n),r=0;r<i.length;r++){var o=i[r];this._autoReleaseSetting[o]=t}}}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,n,i){var r="",o=Lp[n=n||"assets"];if(e&&o){var a=e.indexOf("?");if(-1!==a&&(e=e.substr(0,a)),!(r=o.getUuid(e,t))){var s=Tt(e);s&&(e=e.slice(0,-s.length),(r=o.getUuid(e,t))&&!i&&N(4901,e,s))}}return!r&&t&&(le(t,Bs)||le(t,da)||le(t,Gs))&&N(4934),r}},{key:"_getReferenceKey",value:function(e){var t;return"object"===se(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,void 0,void 0,!0)||e),t?(a.AssetLibrary._getAssetInfoInRuntime(t,kp),this._cache[kp.url]?kp.url:t):(N(4800,e),t)}},{key:"_urlNotFound",value:function(e,t,n){Je((function(){e=a.url.normalize(e);var i="".concat(t?qe(t):"Asset",' in "resources/').concat(e,'" does not exist.');n&&n(new Error(i),[])}))}},{key:"_parseLoadResArgs",value:function(e,t,n){if(void 0===n){var i=le(e,a.RawAsset);t?(n=t,i&&(t=this.onProgress||null)):void 0!==t||i||(n=e,t=this.onProgress||null,e=null),void 0===t||i||(t=e,e=null)}return{type:e,onProgress:t,onComplete:n}}},{key:"_loadResUuids",value:function(e,t,n,i){if(e.length>0){var r=this,o=e.map((function(e){return{type:"uuid",uuid:e}}));this.load(o,t,(function(e,t){if(n){for(var a=[],s=i&&[],c=0;c<o.length;++c){var l=o[c].uuid,u=r._getReferenceKey(l),_=t.getContent(u);_&&(r.setAutoReleaseRecursively(l,!1),a.push(_),s&&s.push(i[c]))}i?n(e,a,s):n(e,a)}}))}else n&&Je((function(){i?n(null,[],[]):n(null,[])}))}}]),t}(_m),Vp=e("cU",a.loader=new jp);var Hp,qp,Wp,Xp,Yp,Kp,Qp,Jp,Zp=Object.freeze({__proto__:null,loadImage:function(e,t,n){ee(!!e,3103);var i=Vp.getRes(e);return i?i.loaded?(t&&t.call(n,null,i),i):(i.once("load",(function(){t&&t.call(n,null,i)}),n),i):(i=new Fo,Vp.load({url:e,imageAsset:i},(function(e,r){if(e)return t&&t.call(n,e||new Error("Unknown error")),i;t&&t.call(n,null,r)})),i)},cacheImage:function(e,t){if(e&&t){var n=new Fo(t),i={id:e,url:e,error:null,content:n,complete:!1};return Vp.flowOut(i),n}},postLoadImage:function(e,t){e.loaded?t&&t():e.nativeUrl?Vp.load({url:e.nativeUrl,skips:e.isCompressed?void 0:["Loader"]},(function(n,i){i&&(e.loaded||(e._nativeAsset=i)),t&&t(n)})):t&&t()}});e("aQ",Zp);var $p,eg,tg,ng,ig,rg,og,ag,sg,cg=e("b5",(Hp=A("cc.Skeleton"),qp=U([tt]),Wp=U([f]),Hp((Kp=b((Yp=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_joints",Kp,F(n)),R(n,"_bindposes",Qp,F(n)),R(n,"_hash",Jp,F(n)),n._invBindposes=null,n}return c(t,e),r(t,[{key:"destroy",value:function(){return a.director.root.dataPoolManager.releaseSkeleton(this),D(u(t.prototype),"destroy",this).call(this)}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new f;f.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=fi(e,666)}return this._hash}}]),t}(M)).prototype,"_joints",[qp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qp=b(Yp.prototype,"_bindposes",[Wp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jp=b(Yp.prototype,"_hash",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xp=Yp))||Xp));a.Skeleton=cg,T(us.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),E(us.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]),E(ia.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),T(rl.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]),a.textureUtil=Zp;var lg,ug,_g,fg,hg,dg,vg,mg,pg,gg,yg,xg,Sg=e("cH",($p=A("RenderStage"),eg=me(),tg=me(),ng=me(),$p((og=b((rg=function(){function e(){o(this,e),R(this,"_name",og,this),R(this,"_priority",ag,this),R(this,"_tag",sg,this)}return r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e,t){this._pipeline=e,this._flow=t}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}()).prototype,"_name",[eg,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ag=b(rg.prototype,"_priority",[tg,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sg=b(rg.prototype,"_tag",[ng,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ig=rg))||ig));a.RenderStage=Sg;var Cg,Tg,Eg,Ag,bg,wg,Ig,Rg,Og=e("cG",(lg=A("RenderFlow"),ug=me(),_g=me(),fg=me(),hg=me(),dg=U([Sg]),lg((pg=b((mg=function(){function e(){o(this,e),R(this,"_name",pg,this),R(this,"_priority",gg,this),R(this,"_tag",yg,this),R(this,"_stages",xg,this)}return r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)}},{key:"render",value:function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].render(e)}},{key:"destroy",value:function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}}]),e}()).prototype,"_name",[ug,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gg=b(mg.prototype,"_priority",[_g,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yg=b(mg.prototype,"_tag",[fg,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xg=b(mg.prototype,"_stages",[hg,dg,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vg=mg))||vg));a.RenderFlow=Og;var Pg,Ng,Dg,zg,Mg,Lg,Fg,kg,Ug,Bg,Gg,jg,Vg,Hg,qg,Wg,Xg,Yg,Kg,Qg,Jg,Zg,$g,ey,ty,ny,iy,ry,oy,ay,sy,cy,ly,uy,_y,fy,hy,dy,vy,my,py,gy,yy,xy,Sy,Cy,Ty,Ey,Ay,by,wy,Iy,Ry,Oy,Py,Ny,Dy,zy,My,Ly,Fy,ky,Uy,By,Gy,jy,Vy,Hy,qy,Wy,Xy,Yy,Ky,Qy,Jy,Zy,$y,ex,tx,nx,ix,rx,ox,ax=e("cF",(Cg=A("cc.RenderPipeline"),Tg=me(),Eg=me(),Ag=U([Og]),Cg((Ig=b((wg=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"_tag",Ig,F(n)),R(n,"_flows",Rg,F(n)),n._globalDescriptorSetLayout={bindings:[],record:{}},n._localDescriptorSetLayout={bindings:[],record:{}},n._macros={},n._commandBuffers=[],n}return c(t,e),r(t,[{key:"initialize",value:function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(){this._device=a.director.root.device,this._descriptorSetLayout=this._device.createDescriptorSetLayout({bindings:xa.bindings}),this._descriptorSet=this._device.createDescriptorSet({layout:this._descriptorSetLayout});for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0}},{key:"render",value:function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=0;i<n.flows.length;i++)n.flows[i].render(n)}},{key:"destroy",value:function(){for(var e=0;e<this._flows.length;e++)this._flows[e].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(var n=0;n<this._commandBuffers.length;n++)this._commandBuffers[n].destroy();return this._commandBuffers.length=0,D(u(t.prototype),"destroy",this).call(this)}},{key:"globalDescriptorSetLayout",get:function(){return this._globalDescriptorSetLayout}},{key:"localDescriptorSetLayout",get:function(){return this._localDescriptorSetLayout}},{key:"macros",get:function(){return this._macros}},{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"device",get:function(){return this._device}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}}]),t}(M)).prototype,"_tag",[Tg,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rg=b(wg.prototype,"_flows",[Eg,Ag,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bg=wg))||bg));a.RenderPipeline=ax,_(Cn),_(Tn),_(On),_(Rn),_(Pn),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(ox||(ox={})),_(ox);Pg=A("RenderTextureDesc"),Ng=U(Cn),Dg=U(Tn),zg=U(an),Pg((Fg=b((Lg=function e(){o(this,e),R(this,"name",Fg,this),R(this,"type",kg,this),R(this,"usage",Ug,this),R(this,"format",Bg,this),R(this,"width",Gg,this),R(this,"height",jg,this)}).prototype,"name",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kg=b(Lg.prototype,"type",[Ng],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cn.TEX2D}}),Ug=b(Lg.prototype,"usage",[Dg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tn.COLOR_ATTACHMENT}}),Bg=b(Lg.prototype,"format",[zg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.UNKNOWN}}),Gg=b(Lg.prototype,"width",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),jg=b(Lg.prototype,"height",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Mg=Lg));var sx,cx=(Vg=A("RenderTextureConfig"),Hg=U(rl),Vg((Xg=b((Wg=function e(){o(this,e),R(this,"name",Xg,this),R(this,"texture",Yg,this)}).prototype,"name",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yg=b(Wg.prototype,"texture",[Hg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qg=Wg))||qg),lx=(Kg=A("MaterialConfig"),Qg=U(ol),Kg(($g=b((Zg=function e(){o(this,e),R(this,"name",$g,this),R(this,"material",ey,this)}).prototype,"name",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ey=b(Zg.prototype,"material",[Qg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jg=Zg))||Jg),ux=(ty=A("FrameBufferDesc"),ny=U([tt]),iy=U(rl),ty((ay=b((oy=function e(){o(this,e),R(this,"name",ay,this),R(this,"renderPass",sy,this),R(this,"colorTextures",cy,this),R(this,"depthStencilTexture",ly,this),R(this,"texture",uy,this)}).prototype,"name",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sy=b(oy.prototype,"renderPass",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cy=b(oy.prototype,"colorTextures",[ny],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ly=b(oy.prototype,"depthStencilTexture",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uy=b(oy.prototype,"texture",[iy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ry=oy)),_y=A("ColorDesc"),fy=U(an),hy=U(Rn),dy=U(On),vy=U(Pn),my=U(Pn),_y((yy=b((gy=function e(){o(this,e),R(this,"format",yy,this),R(this,"loadOp",xy,this),R(this,"storeOp",Sy,this),R(this,"sampleCount",Cy,this),R(this,"beginLayout",Ty,this),R(this,"endLayout",Ey,this)}).prototype,"format",[fy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.UNKNOWN}}),xy=b(gy.prototype,"loadOp",[hy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.CLEAR}}),Sy=b(gy.prototype,"storeOp",[dy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.STORE}}),Cy=b(gy.prototype,"sampleCount",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ty=b(gy.prototype,"beginLayout",[vy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.UNDEFINED}}),Ey=b(gy.prototype,"endLayout",[my],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.PRESENT_SRC}}),py=gy))||py),_x=(Ay=A("DepthStencilDesc"),by=U(an),wy=U(Rn),Iy=U(On),Ry=U(Rn),Oy=U(On),Py=U(Pn),Ny=U(Pn),Ay((My=b((zy=function e(){o(this,e),R(this,"format",My,this),R(this,"depthLoadOp",Ly,this),R(this,"depthStoreOp",Fy,this),R(this,"stencilLoadOp",ky,this),R(this,"stencilStoreOp",Uy,this),R(this,"sampleCount",By,this),R(this,"beginLayout",Gy,this),R(this,"endLayout",jy,this)}).prototype,"format",[by],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return an.UNKNOWN}}),Ly=b(zy.prototype,"depthLoadOp",[wy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.CLEAR}}),Fy=b(zy.prototype,"depthStoreOp",[Iy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.STORE}}),ky=b(zy.prototype,"stencilLoadOp",[Ry],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rn.CLEAR}}),Uy=b(zy.prototype,"stencilStoreOp",[Oy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.STORE}}),By=b(zy.prototype,"sampleCount",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gy=b(zy.prototype,"beginLayout",[Py],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.UNDEFINED}}),jy=b(zy.prototype,"endLayout",[Ny],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),Dy=zy))||Dy);Vy=A("RenderPassDesc"),Hy=U([ux]),qy=U(_x),Vy((Yy=b((Xy=function e(){o(this,e),R(this,"index",Yy,this),R(this,"colorAttachments",Ky,this),R(this,"depthStencilAttachment",Qy,this)}).prototype,"index",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ky=b(Xy.prototype,"colorAttachments",[Hy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qy=b(Xy.prototype,"depthStencilAttachment",[qy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _x}}),Wy=Xy));!function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(sx||(sx={})),_(sx);var fx,hx=(Jy=A("RenderQueueDesc"),Zy=U(sx),$y=U([tt]),Jy((nx=b((tx=function e(){o(this,e),R(this,"isTransparent",nx,this),R(this,"sortMode",ix,this),R(this,"stages",rx,this)}).prototype,"isTransparent",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ix=b(tx.prototype,"sortMode",[Zy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sx.FRONT_TO_BACK}}),rx=b(tx.prototype,"stages",[$y],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ex=tx))||ex);!function(e){e[e.GENERAL=100]="GENERAL"}(fx||(fx={}));var dx,vx;e("cI",function(){function e(){o(this,e),this._name="",this._window=null,this._priority=0,this._visibility=Ya,this._isEnable=!1,this._flows=[]}return r(e,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,a.director.root&&a.director.root.sortViews()}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}]),r(e,[{key:"initialize",value:function(e){return this._camera=e.camera,this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){this._flows.length=0;var t=a.director.root.pipeline.flows;if(e&&1===e.length&&"UIFlow"===e[0]){for(var n=0;n<t.length;n++)if("UIFlow"===t[n].name){this._flows.push(t[n]);break}}else for(var i=0;i<t.length;++i){var r=t[i];(r.tag===ox.SCENE||e&&-1!==e.indexOf(r.name))&&this._flows.push(r)}}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=a.director.root.pipeline.flows,t=0;t<this._flows.length;++t)for(var n=this._flows[t],i=0;i<e.length;i++)if(e[i].name===n.name){this._flows[t]=e[i];break}}}]),e}());function mx(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function px(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}!function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(dx||(dx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(vx||(vx={}));var gx,yx,xx,Sx,Cx,Tx,Ex,Ax,bx,wx,Ix,Rx=function(){function e(t){o(this,e),this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new pt((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new gt(64,this._passDesc.sortFunc)}return r(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset()}},{key:"insertRenderPass",value:function(e,t,n){var i=e.model.subModels[t],r=_c.get(i.handle,lc.PASS_0+n);if(rc.get(uc.get(r,ec.BLEND_STATE)).targets[0].blend!==this._passDesc.isTransparent||!(uc.get(r,ec.PHASE)&this._passDesc.phases))return!1;var o=0|uc.get(r,ec.PRIORITY)<<16|i.priority<<8|n,a=this._passPool.add();return a.hash=o,a.depth=e.depth||0,a.shaderId=_c.get(i.handle,lc.SHADER_0+n),a.subModel=i,a.passIdx=n,this.queue.push(a),!0}},{key:"sort",value:function(){this.queue.sort()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.handle,l=_c.get(c,lc.PASS_0+a),u=oc.get(_c.get(c,lc.SHADER_0+a)),_=If.getOrCreatePipelineState(e,l,u,t,s);n.bindPipelineState(_),n.bindDescriptorSet(Aa.MATERIAL,ac.get(uc.get(l,ec.DESCRIPTOR_SET))),n.bindDescriptorSet(Aa.LOCAL,ac.get(_c.get(c,lc.DESCRIPTOR_SET))),n.bindInputAssembler(s),n.draw(s)}}}]),e}(),Ox=[],Px=e("cP",(gx=A("UIStage"),yx=U([hx]),xx=me(),gx((Ax=Ex=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"renderQueues",Tx,F(n)),n._renderQueues=[],n._renderArea={x:0,y:0,width:0,height:0},n}return c(t,e),r(t,[{key:"initialize",value:function(e){return D(u(t.prototype),"initialize",this).call(this,e),this.renderQueues=[{isTransparent:!0,stages:["default"],sortMode:sx.BACK_TO_FRONT}],!0}},{key:"activate",value:function(e,n){D(u(t.prototype),"activate",this).call(this,e,n);for(var i=0;i<this.renderQueues.length;i++){for(var r=0,o=0;o<this.renderQueues[i].stages.length;o++)r|=Ks(this.renderQueues[i].stages[o]);var a=mx;switch(this.renderQueues[i].sortMode){case sx.BACK_TO_FRONT:a=px;break;case sx.FRONT_TO_BACK:a=mx}this._renderQueues[i]=new Rx({isTransparent:this.renderQueues[i].isTransparent,phases:r,sortFunc:a})}}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,n=t.isHDR;t.isHDR=!1;var i=t.device;this._renderQueues[0].clear();for(var r=t.renderObjects,o=0;o<r.length;o++)for(var a=r[o],s=a.model.subModels,c=0;c<s.length;c++)for(var l=s[c].passes,u=0;u<l.length;u++)this._renderQueues[0].insertRenderPass(a,c,u);this._renderQueues[0].sort();var _=e.camera,f=_.viewport;this._renderArea.x=f.x*_.width,this._renderArea.y=f.y*_.height,this._renderArea.width=f.width*_.width,this._renderArea.height=f.height*_.height,Ox[0]=_.clearColor;var h=t.commandBuffers[0],d=e.window.framebuffer,v=d.colorTextures[0]?d.renderPass:t.getRenderPass(_.clearFlag);h.begin(),h.beginRenderPass(v,d,this._renderArea,[_.clearColor],_.clearDepth,_.clearStencil),h.bindDescriptorSet(Aa.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,v,h),h.endRenderPass(),h.end(),i.queue.submit(t.commandBuffers),t.isHDR=n}}]),t}(Sg),Ex.initInfo={name:"UIStage",priority:dx.UI},Tx=b((Cx=Ax).prototype,"renderQueues",[yx,w,xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sx=Cx))||Sx)),Nx=e("cO",A("UIFlow")((Ix=wx=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"initialize",value:function(e){D(u(t.prototype),"initialize",this).call(this,e);var n=new Px;return n.initialize(Px.initInfo),this._stages.push(n),!0}},{key:"destroy",value:function(){D(u(t.prototype),"destroy",this).call(this)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),D(u(t.prototype),"render",this).call(this,e)}}]),t}(Og),wx.initInfo={name:"UIFlow",priority:vx.UI,tag:ox.UI},bx=Ix))||bx);var Dx=function(){function e(){o(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=0;o<r.value.batches.length;++o){var a=r.value.batches[o];if(a.mergeCount){for(var s=0;s<a.vbs.length;++s)a.vbs[s].update(a.vbDatas[s]);a.vbIdx.update(a.vbIdxData.buffer),a.ubo.update(a.uboData)}}r=i.next()}for(r=(i=this.queue.values()).next();!r.done;){for(var c=!1,l=0;l<r.value.batches.length;++l){var u=r.value.batches[l];if(u.mergeCount){if(!c){var _=oc.get(u.hShader),f=If.getOrCreatePipelineState(e,u.hPass,_,t,u.ia);n.bindPipelineState(f),n.bindDescriptorSet(Aa.MATERIAL,ac.get(uc.get(u.hPass,ec.DESCRIPTOR_SET))),c=!0}n.bindDescriptorSet(Aa.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}r=i.next()}}}]),e}(),zx=function(){function e(){o(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;)r.value.hasPendingModels&&r.value.uploadBuffers(),r=i.next();for(r=(i=this.queue.values()).next();!r.done;){var o=r.value,a=o.instances,s=o.hPass;if(o.hasPendingModels){n.bindDescriptorSet(Aa.MATERIAL,ac.get(uc.get(s,ec.DESCRIPTOR_SET)));for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var _=oc.get(u.hShader),f=If.getOrCreatePipelineState(e,s,_,t,u.ia);c!==f&&(n.bindPipelineState(f),c=f),n.bindDescriptorSet(Aa.LOCAL,ac.get(u.hDescriptorSet),r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}}}]),e}(),Mx=function(){function e(t){o(this,e),this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}return r(e,null,[{key:"get",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e._buffers;i.has(t)||i.set(t,{});var r=i.get(t);return r[n]||(r[n]=new e(t))}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}},{key:"merge",value:function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=_c.get(e.handle,lc.PASS_0+t),c=_c.get(e.handle,lc.SHADER_0+t),l=e.descriptorSet,u=!1,_=0;_<this.batches.length;++_){var h=this.batches[_];if(h.vbs.length===i.length&&h.mergeCount<Ma.BATCHING_COUNT){u=!0;for(var d=0;d<h.vbs.length;++d){if(h.vbs[d].stride!==i[d].stride){u=!1;break}}if(u){for(var v=0;v<h.vbs.length;++v){var m=i[v],p=h.vbs[v],g=h.vbDatas[v];(r=(a+h.vbCount)*m.stride)>p.size&&(p.resize(r),h.vbDatas[v]=new Uint8Array(r),h.vbDatas[v].set(g)),h.vbDatas[v].set(m.buffer,h.vbCount*m.stride)}var y=h.vbIdxData;(o=4*(a+h.vbCount))>h.vbIdx.size&&(h.vbIdx.resize(o),h.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),h.vbIdxData.set(y),y=h.vbIdxData);var x=h.vbCount,S=x+a,C=h.mergeCount;if(y[x]!==C||y[S-1]!==C)for(var T=x;T<S;T++)y[T]=C+.1;return f.toArray(h.uboData,n.model.transform.worldMatrix,Ma.MAT_WORLDS_OFFSET+16*h.mergeCount),h.mergeCount||(l.bindBuffer(Ma.BLOCK.binding,h.ubo),l.update(),h.hPass=s,h.hShader=c,h.descriptorSet=l),++h.mergeCount,h.vbCount+=a,void(h.ia.vertexCount+=a)}}}for(var E=[],A=[],b=[],w=0;w<i.length;++w){var I=i[w],R=this._device.createBuffer({usage:sn.VERTEX|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:I.count*I.stride,stride:I.stride});R.update(I.buffer.buffer),E.push(R),A.push(new Uint8Array(R.size)),b.push(R)}var O=this._device.createBuffer({usage:sn.VERTEX|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:4*a,stride:4}),P=new Float32Array(a);P.fill(0),O.update(P),b.push(O);for(var N=e.inputAssembler.attributes,D=new Array(N.length+1),z=0;z<N.length;++z)D[z]=N[z];D[N.length]={name:"a_dyn_batch_id",format:an.R32F,stream:i.length};var M=this._device.createInputAssembler({attributes:D,vertexBuffers:b}),L=this._device.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:Ma.SIZE});l.bindBuffer(Ma.BLOCK.binding,L),l.update();var F=new Float32Array(Ma.COUNT);f.toArray(F,n.model.transform.worldMatrix,Ma.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:A,vbIdx:O,vbIdxData:P,vbCount:a,ia:M,ubo:L,uboData:F,hPass:s,hShader:c,descriptorSet:l})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),e}();Mx._buffers=new Map;var Lx=new ye((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[]}}),16),Fx=new Float32Array(4),kx=Jt.create(0,0,0,1),Ux=[],Bx=[];function Gx(e,t){return!(!t.worldBounds||Dr.aabb_aabb(t.worldBounds,e.aabb))}function jx(e,t){return!(!t.worldBounds||Dr.aabb_aabb(t.worldBounds,e.aabb)&&Dr.aabb_frustum(t.worldBounds,e.frustum))}var Vx=Ks("forward-add");function Hx(e){for(var t=0;t<e.length;t++)for(var n=e[t].passes,i=0;i<n.length;i++)if(n[i].phase===Vx)return i;return-1}var qx,Wx,Xx,Yx,Kx,Qx,Jx,Zx,$x,eS,tS,nS,iS,rS,oS,aS,sS,cS,lS,uS,_S,fS,hS,dS,vS,mS,pS=function(){function e(t){o(this,e),this._device=void 0,this._validLights=[],this._lightPasses=[],this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstlightBufferView=void 0,this._lightBufferData=void 0,this._isHDR=void 0,this._fpScale=void 0,this._renderObjects=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._device=t.device,this._isHDR=t.isHDR,this._fpScale=t.fpScale,this._renderObjects=t.renderObjects,this._instancedQueue=new zx,this._batchedQueue=new Dx,this._lightBufferStride=Math.ceil(La.SIZE/this._device.uboOffsetAlignment)*this._device.uboOffsetAlignment,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer({memUsage:cn.HOST|cn.DEVICE,usage:sn.UNIFORM,stride:this._lightBufferStride,size:this._lightBufferStride*this._lightBufferCount}),this._firstlightBufferView=this._device.createBuffer({buffer:this._lightBuffer,offset:0,range:La.SIZE}),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}return r(e,[{key:"gatherLightPasses",value:function(e){var t=this._validLights,n=e.camera.scene.sphereLights;this._instancedQueue.clear(),this._batchedQueue.clear(),t.length=0;for(var i=0;i<this._lightPasses.length;i++){this._lightPasses[i].dynamicOffsets.length=0}Lx.freeArray(this._lightPasses),this._lightPasses.length=0;for(var r=0;r<n.length;r++){var o=n[r];Jt.set(kx,o.position.x,o.position.y,o.position.z,o.range),Dr.sphere_frustum(kx,e.camera.frustum)&&t.push(o)}for(var a=e.camera.scene.spotLights,s=0;s<a.length;s++){var c=a[s];Jt.set(kx,c.position.x,c.position.y,c.position.z,c.range),Dr.sphere_frustum(kx,e.camera.frustum)&&t.push(c)}if(t.length){this._updateUBOs(e);for(var l=0;l<this._renderObjects.length;l++){var u=this._renderObjects[l],_=u.model,f=_.subModels,h=Hx(f);if(!(h<0)){Bx.length=0;for(var d=0;d<t.length;d++){var v=t[d],m=!1;switch(v.type){case xf.SPHERE:m=Gx(v,_);break;case xf.SPOT:m=jx(v,_)}m||Bx.push(d)}if(Bx.length)for(var p=0;p<f.length;p++){var g=f[p],y=g.passes[h],x=y.batchingScheme;if(g.descriptorSet.bindBuffer(La.BLOCK.binding,this._firstlightBufferView),g.descriptorSet.update(),x===xc.INSTANCING)for(var S=0;S<Bx.length;S++){var C=Bx[S],T=C_.get(y,C);T.merge(g,_.instancedAttributes,h),T.dynamicOffsets[0]=this._lightBufferStride*C,this._instancedQueue.queue.add(T)}else if(x===xc.VB_MERGING)for(var E=0;E<Bx.length;E++){var A=Bx[E],b=Mx.get(y,A);b.merge(g,h,u),b.dynamicOffsets[0]=this._lightBufferStride*A,this._batchedQueue.queue.add(b)}else{var w=Lx.alloc();w.subModel=g,w.passIdx=h;for(var I=0;I<Bx.length;I++)w.dynamicOffsets.push(this._lightBufferStride*Bx[I]);this._lightPasses.push(w)}}}}}}},{key:"recordCommandBuffer",value:function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._lightPasses.length;i++){var r=this._lightPasses[i],o=r.subModel,a=r.passIdx,s=r.dynamicOffsets,c=oc.get(_c.get(o.handle,lc.SHADER_0+a)),l=o.passes[a],u=o.inputAssembler,_=If.getOrCreatePipelineState(e,l.handle,c,t,u),f=ac.get(uc.get(l.handle,ec.DESCRIPTOR_SET)),h=o.descriptorSet;n.bindPipelineState(_),n.bindDescriptorSet(Aa.MATERIAL,f),n.bindInputAssembler(u);for(var d=0;d<s.length;++d)Ux[0]=s[d],n.bindDescriptorSet(Aa.LOCAL,h,Ux),n.draw(u)}}},{key:"_updateUBOs",value:function(e){var t=e.camera.exposure;this._validLights.length>this._lightBufferCount&&(this._firstlightBufferView.destroy(),this._lightBufferCount=nt(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstlightBufferView.initialize({buffer:this._lightBuffer,offset:0,range:La.SIZE}));for(var n=0,i=0;n<this._validLights.length;n++,i+=this._lightBufferElementCount){var r=this._validLights[n];switch(r.type){case xf.SPHERE:var o=r;if(s.toArray(Fx,o.position),Fx[3]=0,this._lightBufferData.set(Fx,i+La.LIGHT_POS_OFFSET),Fx[0]=o.size,Fx[1]=o.range,Fx[2]=0,this._lightBufferData.set(Fx,i+La.LIGHT_SIZE_RANGE_ANGLE_OFFSET),s.toArray(Fx,r.color),r.useColorTemperature){var a=r.colorTemperatureRGB;Fx[0]*=a.x,Fx[1]*=a.y,Fx[2]*=a.z}this._isHDR?Fx[3]=o.luminance*this._fpScale*this._lightMeterScale:Fx[3]=o.luminance*t*this._lightMeterScale,this._lightBufferData.set(Fx,i+La.LIGHT_COLOR_OFFSET);break;case xf.SPOT:var c=r;if(s.toArray(Fx,c.position),Fx[3]=1,this._lightBufferData.set(Fx,i+La.LIGHT_POS_OFFSET),Fx[0]=c.size,Fx[1]=c.range,Fx[2]=c.spotAngle,this._lightBufferData.set(Fx,i+La.LIGHT_SIZE_RANGE_ANGLE_OFFSET),s.toArray(Fx,c.direction),this._lightBufferData.set(Fx,i+La.LIGHT_DIR_OFFSET),s.toArray(Fx,r.color),r.useColorTemperature){var l=r.colorTemperatureRGB;Fx[0]*=l.x,Fx[1]*=l.y,Fx[2]*=l.z}this._isHDR?Fx[3]=c.luminance*this._fpScale*this._lightMeterScale:Fx[3]=c.luminance*t*this._lightMeterScale,this._lightBufferData.set(Fx,i+La.LIGHT_COLOR_OFFSET)}}this._lightBuffer.update(this._lightBufferData)}}]),e}(),gS=[{r:0,g:0,b:0,a:1}],yS=e("cL",(qx=A("ForwardStage"),Wx=U([hx]),Xx=me(),qx((Zx=Jx=function(e){function t(){var e;return o(this,t),e=l(this,u(t).call(this)),R(e,"renderQueues",Qx,F(e)),e._renderQueues=[],e._renderArea={x:0,y:0,width:0,height:0},e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Ks("default"),e._batchedQueue=new Dx,e._instancedQueue=new zx,e}return c(t,e),r(t,[{key:"initialize",value:function(e){return D(u(t.prototype),"initialize",this).call(this,e),this.renderQueues=[{isTransparent:!1,sortMode:sx.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:sx.BACK_TO_FRONT,stages:["default","planarShadow"]}],!0}},{key:"activate",value:function(e,n){D(u(t.prototype),"activate",this).call(this,e,n);for(var i=0;i<this.renderQueues.length;i++){for(var r=0,o=0;o<this.renderQueues[i].stages.length;o++)r|=Ks(this.renderQueues[i].stages[o]);var a=mx;switch(this.renderQueues[i].sortMode){case sx.BACK_TO_FRONT:a=px;break;case sx.FRONT_TO_BACK:a=mx}this._renderQueues[i]=new Rx({isTransparent:this.renderQueues[i].isTransparent,phases:r,sortFunc:a})}this._additiveLightQueue=new pS(this._pipeline)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);for(var i=t.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],_=u.passes;for(o=0;o<_.length;++o){var f=_[o];if(f.phase===this._phaseID){var h=f.batchingScheme;if(h===xc.INSTANCING){var d=C_.get(f);d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(h===xc.VB_MERGING){var v=Mx.get(f);v.merge(u,o,c),this._batchedQueue.queue.add(v)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(this.renderQueueSortFunc),this._additiveLightQueue.gatherLightPasses(e);var m,p,g=e.camera,y=t.commandBuffers[0],x=g.viewport;if(this._renderArea.x=x.x*g.width,this._renderArea.y=x.y*g.height,this._renderArea.width=x.width*g.width*t.shadingScale,this._renderArea.height=x.height*g.height*t.shadingScale,g.clearFlag&Fn.COLOR)if(t.isHDR){m=gS[0],p=g.clearColor,m.r=p.r*p.r,m.g=p.g*p.g,m.b=p.b*p.b;var S=t.fpScale/g.exposure;gS[0].r*=S,gS[0].g*=S,gS[0].b*=S}else gS[0].r=g.clearColor.r,gS[0].g=g.clearColor.g,gS[0].b=g.clearColor.b;gS[0].a=g.clearColor.a;var C=e.window.framebuffer,T=C.colorTextures[0]?C.renderPass:t.getRenderPass(g.clearFlag);y.begin(),y.beginRenderPass(T,C,this._renderArea,gS,g.clearDepth,g.clearStencil),y.bindDescriptorSet(Aa.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,T,y),this._instancedQueue.recordCommandBuffer(n,T,y),this._batchedQueue.recordCommandBuffer(n,T,y),this._additiveLightQueue.recordCommandBuffer(n,T,y),t.shadows.type===Ff.Planar&&t.shadows.recordCommandBuffer(n,T,y),this._renderQueues[1].recordCommandBuffer(n,T,y),y.endRenderPass(),y.end(),n.queue.submit(t.commandBuffers)}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}}]),t}(Sg),Jx.initInfo={name:"ForwardStage",priority:dx.FORWARD},Qx=b((Kx=Zx).prototype,"renderQueues",[Wx,w,Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yx=Kx))||Yx)),xS=e("cK",A("ForwardFlow")((tS=eS=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"initialize",value:function(e){D(u(t.prototype),"initialize",this).call(this,e);var n=new yS;return n.initialize(yS.initInfo),this._stages.push(n),!0}},{key:"activate",value:function(e){D(u(t.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),D(u(t.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){D(u(t.prototype),"destroy",this).call(this)}}]),t}(Og),eS.initInfo={name:"ForwardFlow",priority:vx.FORWARD},$x=tS))||$x),SS=function(){function e(){o(this,e),this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._shadowMapBuffer=null,this._phaseID=Ks("shadow-add"),this._instancedQueue=new zx,this._batchedQueue=new Dx}return r(e,[{key:"clear",value:function(e){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear(),this._shadowMapBuffer=e}},{key:"add",value:function(e,t,n){var i=e.model.subModels[t],r=i.passes[n];if(r.phase===this._phaseID)if(this._shadowMapBuffer)if(r.batchingScheme===xc.INSTANCING){var o=C_.get(r);o.merge(i,e.model.instancedAttributes,n),this._instancedQueue.queue.add(o)}else if(r.batchingScheme===xc.VB_MERGING){var a=Mx.get(r);a.merge(i,n,e),this._batchedQueue.queue.add(a)}else{var s=oc.get(_c.get(i.handle,lc.SHADER_0+n));this._subModelsArray.push(i),this._shaderArray.push(s),this._passArray.push(r.handle)}else this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()}},{key:"recordCommandBuffer",value:function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=If.getOrCreatePipelineState(e,a,o,t,s),l=ac.get(uc.get(a,ec.DESCRIPTOR_SET));n.bindPipelineState(c),n.bindDescriptorSet(Aa.MATERIAL,l),n.bindDescriptorSet(Aa.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}}}]),e}(),CS=[{r:1,g:1,b:1,a:1}],TS=[],ES=e("cN",A("ShadowStage")((rS=iS=function(e){function t(){var e;return o(this,t),(e=l(this,u(t).call(this)))._additiveShadowQueue=void 0,e._shadowFrameBuffer=null,e._renderArea={x:0,y:0,width:0,height:0},e._additiveShadowQueue=new SS,e}return c(t,e),r(t,[{key:"setShadowFrameBuffer",value:function(e){this._shadowFrameBuffer=e}}]),r(t,[{key:"destroy",value:function(){}},{key:"render",value:function(e){var t,n=this._pipeline,i=n.shadows;if(this._additiveShadowQueue.clear(n.descriptorSet.getBuffer(Pa.BLOCK.binding)),null===(t=e.camera.scene)||void 0===t?void 0:t.mainLight)for(var r=n.shadowObjects,o=0,a=0,s=0;s<r.length;++s){var c=r[s],l=c.model.subModels;for(o=0;o<l.length;o++){var u=l[o].passes;for(a=0;a<u.length;a++)this._additiveShadowQueue.add(c,o,a)}}var _=e.camera,f=n.commandBuffers[0],h=_.viewport,d=i.size;this._renderArea.x=h.x*d.x,this._renderArea.y=h.y*d.y,this._renderArea.width=h.width*d.x*n.shadingScale,this._renderArea.height=h.height*d.y*n.shadingScale;var v=n.device,m=this._shadowFrameBuffer.renderPass;f.begin(),f.beginRenderPass(m,this._shadowFrameBuffer,this._renderArea,CS,_.clearDepth,_.clearStencil),f.bindDescriptorSet(Aa.GLOBAL,n.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(v,m,f),f.endRenderPass(),f.end(),TS[0]=f,v.queue.submit(TS)}}]),t}(Sg),iS.initInfo={name:"ShadowStage",priority:dx.FORWARD},nS=rS))||nS),AS=[xn.LINEAR,xn.LINEAR,xn.NONE,Sn.CLAMP,Sn.CLAMP,Sn.CLAMP],bS=e("cM",A("ShadowFlow")((sS=aS=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r))))._shadowRenderPass=null,n._shadowRenderTargets=[],n._shadowFrameBuffer=null,n._depth=null,n._width=0,n._height=0,n}return c(t,e),r(t,[{key:"initialize",value:function(e){D(u(t.prototype),"initialize",this).call(this,e);var n=new ES;return n.initialize(ES.initInfo),this._stages.push(n),!0}},{key:"activate",value:function(e){D(u(t.prototype),"activate",this).call(this,e);var n=e.device,i=e.shadows.size;this._width=i.x,this._height=i.y,this._shadowRenderPass||(this._shadowRenderPass=n.createRenderPass({colorAttachments:[{format:an.RGBA8,loadOp:Rn.CLEAR,storeOp:On.STORE,sampleCount:1,beginLayout:Pn.UNDEFINED,endLayout:Pn.PRESENT_SRC}],depthStencilAttachment:{format:n.depthStencilFormat,depthLoadOp:Rn.CLEAR,depthStoreOp:On.STORE,stencilLoadOp:Rn.CLEAR,stencilStoreOp:On.STORE,sampleCount:1,beginLayout:Pn.UNDEFINED,endLayout:Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}})),this._shadowRenderTargets.length<1&&this._shadowRenderTargets.push(n.createTexture({type:Cn.TEX2D,usage:Tn.COLOR_ATTACHMENT|Tn.SAMPLED,format:an.RGBA8,width:this._width,height:this._height})),this._depth||(this._depth=n.createTexture({type:Cn.TEX2D,usage:Tn.DEPTH_STENCIL_ATTACHMENT,format:n.depthStencilFormat,width:this._width,height:this._height})),this._shadowFrameBuffer||(this._shadowFrameBuffer=n.createFramebuffer({renderPass:this._shadowRenderPass,colorTextures:this._shadowRenderTargets,depthStencilTexture:this._depth}));for(var r=0;r<this._stages.length;++r)this._stages[r].setShadowFrameBuffer(this._shadowFrameBuffer);var o=jo(AS),a=ta.getSampler(n,o);e.descriptorSet.bindSampler(Na.binding,a),e.descriptorSet.bindTexture(Na.binding,this._shadowRenderTargets[0])}},{key:"render",value:function(e){var n=this._pipeline,i=n.shadows;if(i.type===Ff.ShadowMap){var r=i.size;this._width===r.x&&this._height===r.y||(this.resizeShadowMap(r.x,r.y),this._width=r.x,this._height=r.y),n.updateUBOs(e),D(u(t.prototype),"render",this).call(this,e)}}},{key:"resizeShadowMap",value:function(e,t){if(this._depth&&this._depth.resize(e,t),this._shadowRenderTargets.length>0)for(var n=0;n<this._shadowRenderTargets.length;n++){var i=this._shadowRenderTargets[n];i&&i.resize(e,t)}this._shadowFrameBuffer&&(this._shadowFrameBuffer.destroy(),this._shadowFrameBuffer.initialize({renderPass:this._shadowRenderPass,colorTextures:this._shadowRenderTargets,depthStencilTexture:this._depth}))}},{key:"shadowFrameBuffer",get:function(){return this._shadowFrameBuffer}}]),t}(Og),aS.initInfo={name:"ShadowFlow",priority:vx.SHADOW,tag:ox.SCENE},oS=sS))||oS),wS=p({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),IS=function(){function e(){o(this,e),this._type=wS.LINEAR,this._fogColor=new xe("#C8C8C8"),this._enabled=!1,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._currType=0,this._colorArray=new Float32Array([.2,.2,.2,1])}return r(e,[{key:"activate",value:function(){xe.toArray(this._colorArray,this._fogColor),this._currType=this._enabled?this._type+1:0,this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=a.director.root,t=this._currType,n=e.pipeline;n.macros.CC_USE_FOG!==t&&(n.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())}},{key:"enabled",set:function(e){this._enabled!==e&&(this._enabled=e,this._currType=e?this._type+1:0,this._enabled?this.activate():this._updatePipeline())},get:function(){return this._enabled}},{key:"fogColor",set:function(e){this._fogColor.set(e),xe.toArray(this._colorArray,this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._enabled&&(this._currType=e+1,this._updatePipeline())}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"currType",get:function(){return this._currType}},{key:"colorArray",get:function(){return this._colorArray}}]),e}(),RS=new s,OS=new ye((function(){return{model:null,depth:0}}),128),PS=new ye((function(){return{model:null,depth:0}}),128);function NS(e,t){var n=0;e.node&&(s.subtract(RS,e.node.worldPosition,t.position),n=s.dot(RS,t.forward));var i=OS.alloc();return i.model=e,i.depth=n,i}function DS(e,t){var n=0;e.node&&(s.subtract(RS,e.node.worldPosition,t.position),n=s.dot(RS,t.forward));var i=PS.alloc();return i.model=e,i.depth=n,i}function zS(e,t){var n=t.camera,i=n.scene,r=e.renderObjects;OS.freeArray(r),r.length=0;var o=e.shadowObjects;PS.freeArray(o),o.length=0;var a=i.mainLight,s=e.shadows,c=s.sphere;c.center.set(0,0,0),c.radius=.01,a&&(a.update(),s.type===Ff.Planar&&s.updateDirLight(a)),e.skybox.enabled&&e.skybox.model&&n.clearFlag&rf&&r.push(NS(e.skybox.model,n));for(var l=i.models,u=0;u<l.length;u++){var _=l[u];if(_.enabled)if(t.visibility&ma.BitMask.UI_2D)(_.node&&t.visibility===_.node.layer||t.visibility===_.visFlags)&&r.push(NS(_,n));else if(_.node&&(t.visibility&_.node.layer)===_.node.layer||t.visibility&_.visFlags){if(_.castShadow&&(Jt.mergeAABB(c,c,_.worldBounds),o.push(DS(_,n))),_.worldBounds&&!Dr.aabb_frustum(_.worldBounds,n.frustum))continue;r.push(NS(_,n))}}s.type===Ff.Planar&&s.updateShadowList(i,n.frustum,0!=(n.visibility&ma.BitMask.DEFAULT))}var MS=new f,LS=new f,FS=new m,kS=(e("cJ",(cS=A("ForwardPipeline"),lS=U([cx]),uS=me(),_S=U([lx]),fS=me(),cS((vS=b((dS=function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return n=l(this,(e=u(t)).call.apply(e,[this].concat(r))),R(n,"renderTextures",vS,F(n)),R(n,"materials",mS,F(n)),n.fog=new IS,n.ambient=new K_,n.skybox=new td,n.shadows=new Uf,n.renderObjects=[],n.shadowObjects=[],n._isHDR=!1,n._shadingScale=1,n._fpScale=1/1024,n._renderPasses=new Map,n._globalUBO=new Float32Array(Oa.COUNT),n._shadowUBO=new Float32Array(Pa.COUNT),n}return c(t,e),r(t,[{key:"initialize",value:function(e){D(u(t.prototype),"initialize",this).call(this,e);var n=new bS;n.initialize(bS.initInfo),this._flows.push(n);var i=new xS;i.initialize(xS.initInfo),this._flows.push(i);var r=new Nx;return r.initialize(Nx.initInfo),this._flows.push(r),!0}},{key:"activate",value:function(){return this._globalDescriptorSetLayout=xa,this._localDescriptorSetLayout=Sa,this._macros={},!!D(u(t.prototype),"activate",this).call(this)&&(!!this._activeRenderer()||(console.error("ForwardPipeline startup failed!"),!1))}},{key:"render",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];zS(this,n);for(var i=0;i<n.flows.length;i++)n.flows[i].render(n)}}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);if(t)return t;var n=this.device,i=new Si,r=new Ci;return i.format=n.colorFormat,r.format=n.depthStencilFormat,e&Fn.COLOR||(e&rf?i.loadOp=Rn.DISCARD:(i.loadOp=Rn.LOAD,i.beginLayout=Pn.PRESENT_SRC)),(e&Fn.DEPTH_STENCIL)!==Fn.DEPTH_STENCIL&&(e&Fn.DEPTH||(r.depthLoadOp=Rn.LOAD),e&Fn.STENCIL||(r.stencilLoadOp=Rn.LOAD),r.beginLayout=Pn.DEPTH_STENCIL_ATTACHMENT_OPTIMAL),t=n.createRenderPass({colorAttachments:[i],depthStencilAttachment:r}),this._renderPasses.set(e,t),t}},{key:"updateUBOs",value:function(e){this._updateUBO(e);var t=e.camera.scene.mainLight,n=this.device,i=this.shadows;if(t&&i.type===Ff.ShadowMap){var r=t.node.getWorldMatrix();f.invert(MS,r);var o=i.orthoSize*i.aspect,a=i.orthoSize,s=n.screenSpaceSignY*n.UVSpaceSignY;f.ortho(LS,-o,o,-a,a,i.near,i.far,n.clipSpaceMinZ,s),f.multiply(LS,LS,MS),f.toArray(this._shadowUBO,LS,Pa.MAT_LIGHT_VIEW_PROJ_OFFSET),FS.set(i.pcf),m.toArray(this._shadowUBO,FS,Pa.SHADOW_PCF_OFFSET),FS.set(i.size.x,i.size.y),m.toArray(this._shadowUBO,FS,Pa.SHADOW_SIZE_OFFSET)}this._descriptorSet.getBuffer(Oa.BLOCK.binding).update(this._globalUBO),this._descriptorSet.getBuffer(Pa.BLOCK.binding).update(this._shadowUBO)}},{key:"_activeRenderer",value:function(){var e=this.device;this._commandBuffers.push(e.createCommandBuffer({type:In.PRIMARY,queue:this._device.queue}));var t=e.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:Oa.SIZE});this._descriptorSet.bindBuffer(Oa.BLOCK.binding,t);var n=e.createBuffer({usage:sn.UNIFORM|sn.TRANSFER_DST,memUsage:cn.HOST|cn.DEVICE,size:Pa.SIZE});return this._descriptorSet.bindBuffer(Pa.BLOCK.binding,n),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(ni.TEXTURE_FLOAT),!0}},{key:"_updateUBO",value:function(e){this._descriptorSet.update();var t=a.director.root,n=e.camera,i=n.scene.mainLight,r=this.ambient,o=this.fog,c=this._globalUBO,l=this.device,u=Math.floor(l.width),_=Math.floor(l.height);c[Oa.TIME_OFFSET]=t.cumulativeTime,c[Oa.TIME_OFFSET+1]=t.frameTime,c[Oa.TIME_OFFSET+2]=a.director.getTotalFrames(),c[Oa.SCREEN_SIZE_OFFSET]=l.width,c[Oa.SCREEN_SIZE_OFFSET+1]=l.height,c[Oa.SCREEN_SIZE_OFFSET+2]=1/c[Oa.SCREEN_SIZE_OFFSET],c[Oa.SCREEN_SIZE_OFFSET+3]=1/c[Oa.SCREEN_SIZE_OFFSET+1],c[Oa.SCREEN_SCALE_OFFSET]=n.width/u*this.shadingScale,c[Oa.SCREEN_SCALE_OFFSET+1]=n.height/_*this.shadingScale,c[Oa.SCREEN_SCALE_OFFSET+2]=1/c[Oa.SCREEN_SCALE_OFFSET],c[Oa.SCREEN_SCALE_OFFSET+3]=1/c[Oa.SCREEN_SCALE_OFFSET+1],c[Oa.NATIVE_SIZE_OFFSET]=u,c[Oa.NATIVE_SIZE_OFFSET+1]=_,c[Oa.NATIVE_SIZE_OFFSET+2]=1/c[Oa.NATIVE_SIZE_OFFSET],c[Oa.NATIVE_SIZE_OFFSET+3]=1/c[Oa.NATIVE_SIZE_OFFSET+1],f.toArray(c,n.matView,Oa.MAT_VIEW_OFFSET),f.toArray(c,n.node.worldMatrix,Oa.MAT_VIEW_INV_OFFSET),f.toArray(c,n.matProj,Oa.MAT_PROJ_OFFSET),f.toArray(c,n.matProjInv,Oa.MAT_PROJ_INV_OFFSET),f.toArray(c,n.matViewProj,Oa.MAT_VIEW_PROJ_OFFSET),f.toArray(c,n.matViewProjInv,Oa.MAT_VIEW_PROJ_INV_OFFSET),s.toArray(c,n.position,Oa.CAMERA_POS_OFFSET);var h=l.screenSpaceSignY;e.window.hasOffScreenAttachments&&(h*=l.UVSpaceSignY),c[Oa.CAMERA_POS_OFFSET+3]=h;var d=n.exposure;if(c[Oa.EXPOSURE_OFFSET]=d,c[Oa.EXPOSURE_OFFSET+1]=1/d,c[Oa.EXPOSURE_OFFSET+2]=this._isHDR?1:0,c[Oa.EXPOSURE_OFFSET+3]=this._fpScale/d,i){if(s.toArray(c,i.direction,Oa.MAIN_LIT_DIR_OFFSET),s.toArray(c,i.color,Oa.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var v=i.colorTemperatureRGB;c[Oa.MAIN_LIT_COLOR_OFFSET]*=v.x,c[Oa.MAIN_LIT_COLOR_OFFSET+1]*=v.y,c[Oa.MAIN_LIT_COLOR_OFFSET+2]*=v.z}this._isHDR?c[Oa.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*this._fpScale:c[Oa.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*d}else s.toArray(c,s.UNIT_Z,Oa.MAIN_LIT_DIR_OFFSET),m.toArray(c,m.ZERO,Oa.MAIN_LIT_COLOR_OFFSET);var p=r.colorArray;this._isHDR?p[3]=r.skyIllum*this._fpScale:p[3]=r.skyIllum*d,c.set(p,Oa.AMBIENT_SKY_OFFSET),c.set(r.albedoArray,Oa.AMBIENT_GROUND_OFFSET),o.enabled&&(c.set(o.colorArray,Oa.GLOBAL_FOG_COLOR_OFFSET),c[Oa.GLOBAL_FOG_BASE_OFFSET]=o.fogStart,c[Oa.GLOBAL_FOG_BASE_OFFSET+1]=o.fogEnd,c[Oa.GLOBAL_FOG_BASE_OFFSET+2]=o.fogDensity,c[Oa.GLOBAL_FOG_ADD_OFFSET]=o.fogTop,c[Oa.GLOBAL_FOG_ADD_OFFSET+1]=o.fogRange,c[Oa.GLOBAL_FOG_ADD_OFFSET+2]=o.fogAtten)}},{key:"destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Oa.BLOCK.binding).destroy(),this._descriptorSet.getBuffer(Pa.BLOCK.binding).destroy())}},{key:"destroy",value:function(){this.destroyUBOs();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return D(u(t.prototype),"destroy",this).call(this)}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR!==e&&(this._isHDR=e,this._globalUBO[Oa.EXPOSURE_OFFSET+2]=this._isHDR?1:0)}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"fpScale",get:function(){return this._fpScale}},{key:"shadowUBO",get:function(){return this._shadowUBO}}]),t}(ax)).prototype,"renderTextures",[lS,w,uS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mS=b(dS.prototype,"materials",[_S,w,fS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hS=dS))||hS)),new Y),US=e("bf",function(){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;o(this,e),this._point=new Y,this._prevPoint=new Y,this._lastModified=0,this._id=0,this._startPoint=new Y,this._startPointCaptured=!1,this.setTouchInfo(i,t,n)}return r(e,[{key:"lastModified",get:function(){return this._lastModified}}]),r(e,[{key:"getLocation",value:function(e){return e||(e=new Y),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new Y),e.set(this._point.x,this._point.y),a.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=a.view.getViewportRect();return(this._point.x-e.x)/a.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=a.view.getViewportRect();return(this._point.y-e.y)/a.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new Y),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Y),e.set(this._prevPoint.x,this._prevPoint.y),a.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new Y),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new Y),e.set(this._startPoint.x,this._startPoint.y),a.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Y),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new Y),kS.set(this._point),kS.subtract(this._prevPoint),e.set(a.view.getScaleX(),a.view.getScaleY()),Y.divide(e,kS,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new Y),e.set(this._point.x,a.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new Y),e.set(this._prevPoint.x,a.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new Y),e.set(this._startPoint.x,a.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new Y(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Y(this._point),this._startPointCaptured=!0)}},{key:"setPoint",value:function(e,t){"object"===se(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=a.director.getCurrentTime()}},{key:"setPrevPoint",value:function(e,t){"object"===se(e)?this._prevPoint=new Y(e.x,e.y):this._prevPoint=new Y(e||0,t||0),this._lastModified=a.director.getCurrentTime()}}]),e}());a.Touch=US;var BS,GS=oa.TOUCH_TIMEOUT,jS=new Y,VS=new Y,HS=e("ba",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;o(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=n,this.z=i,this.timestamp=r}));a.internal.Acceleration=HS;var qS=e("d8",new(function(){function e(){o(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Y,this._prevMousePoint=new Y,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}return r(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],n=this._touchesIntegerDict,i=0;i<e.length;++i){var r=e[i],o=r.getID();if(null!==o)if(void 0===n[o]){var a=this._getUnUsedIndex();if(-1===a){te(2300,a);continue}r.getLocation(jS);var s=new US(jS.x,jS.y,o);this._touches[a]=s,r.getPreviousLocation(jS),s.setPrevPoint(jS),n[o]=a,t.push(s)}}if(t.length>0){var c=new _l(t,!1,_l.BEGAN,oa.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Tl.dispatchEvent(c)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],n=this._touches,i=0;i<e.length;++i){var r=e[i],o=r.getID();if(null!==o){var a=this._touchesIntegerDict[o];void 0!==a&&n[a]&&(r.getLocation(jS),n[a].setPoint(jS),r.getPreviousLocation(jS),n[a].setPrevPoint(jS),t.push(n[a]))}}if(t.length>0){var s=new _l(t,!1,_l.MOVED,oa.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Tl.dispatchEvent(s)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new _l(t,!1,_l.ENDED,oa.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Tl.dispatchEvent(n)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var n=new _l(t,!1,_l.CANCELLED,oa.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Tl.dispatchEvent(n)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],n=this._touches,i=this._touchesIntegerDict,r=0;r<e.length;++r){var o=e[r],a=o.getID();if(null!==a){var s=i[a];void 0!==s&&n[s]&&(o.getLocation(jS),n[s].setPoint(jS),o.getPreviousLocation(jS),n[s].setPrevPoint(jS),t.push(n[s]),this._removeUsedIndexBit(s),delete i[a])}}return t}},{key:"getHTMLElementPosition",value:function(e){var t=document.documentElement,n=P.os===P.OS_IOS&&P.isBrowser?window.screenLeft:window.pageXOffset;n-=t.clientLeft;var i=P.os===P.OS_IOS&&P.isBrowser?window.screenTop:window.pageYOffset;if(i-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+n,top:r.top+i,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:n,top:i,width:e.width,height:e.height}:{left:n,top:i,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,n=this._preTouchPool,i=e.getID(),r=n.length-1;r>=0;r--)if(n[r].getID()===i){t=n[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,n=this._preTouchPool,i=e.getID(),r=n.length-1;r>=0;r--)if(n[r].getID()===i){n[r]=e,t=!0;break}t||(n.length<=50?n.push(e):(n[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,n,i){var r=this._preTouchPoint,o=this._glView.convertToLocationInView(t,n,i);this._pointLocked&&(o.x=r.x+e.movementX,o.y=r.y-e.movementY);var a=new US(o.x,o.y,0);return a.setPrevPoint(r.x,r.y),r.x=o.x,r.y=o.y,a}},{key:"getMouseEvent",value:function(e,t,n){var i=this._prevMousePoint,r=new ul(n,!1,i);return i.x=e.x,i.y=e.y,this._glView._convertMouseToLocation(i,t),r.setLocation(i.x,i.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop,{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var n=[],i=this._glView,r=this._preTouchPoint,o=e.changedTouches.length,a=0;a<o;a++){var s=e.changedTouches[a];if(s){var c=void 0;c=P.BROWSER_TYPE_FIREFOX===P.browserType?i.convertToLocationInView(s.pageX,s.pageY,t,jS):i.convertToLocationInView(s.clientX,s.clientY,t,jS);var l=void 0;if(null!=s.identifier?(l=new US(c.x,c.y,s.identifier),this.getPreTouch(l).getLocation(VS),l.setPrevPoint(VS.x,VS.y),this.setPreTouch(l)):(l=new US(c.x,c.y)).setPrevPoint(r.x,r.y),r.x=c.x,r.y=c.y,n.push(l),!oa.ENABLE_MULTI_TOUCH)break}}return n}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=a.view;var t=P.isMobile,n="mouse"in P.capabilities,i="touches"in P.capabilities;n&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),i&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=a.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,n=0,i=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;o&&(n=this._accelMinus*(o.x||0)*.1,i=this._accelMinus*(o.y||0)*.1,r=.1*(o.z||0))}else{var s=e;n=(s.gamma||0)/90*.981,i=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(a.view._isRotated){var c=n;n=-i,i=c}t.x=n,t.y=i,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),a.sys.os===a.sys.OS_ANDROID&&a.sys.browserType!==a.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,Tl.dispatchEvent(new fl(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=a.director.getCurrentTime(),n=0;n<this._maxTouches;n++){if(!(1&e))return this._indexBitsUsed|=1<<n,n;var i=this._touches[n];if(t-i.lastModified>GS){this._removeUsedIndexBit(n);var r=i.getID();return null!==r&&delete this._touchesIntegerDict[r],n}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=a.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_registerWindowMouseEvents",value:function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(n){if(t._mousePressed){t._mousePressed=!1;var i=t.getHTMLElementPosition(e),r=t.getPointByEvent(n,i);if(!it(i.left,i.top,i.width,i.height).contains(new Y(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(n,r.x,r.y,i)]);var o=t.getMouseEvent(r,i,ul.UP);o.setButton(n.button),Tl.dispatchEvent(o)}}}),!1)}},{key:"_registerElementMouseEvents",value:function(e,t){var n=this,i=function(t,i,r){e.addEventListener(t,(function(t){var o=n.getHTMLElementPosition(e),a=n.getPointByEvent(t,o),s=n.getMouseEvent(a,o,i);s.setButton(t.button),r(t,s,a,o),Tl.dispatchEvent(s),t.stopPropagation(),t.preventDefault()}))};t||(i("mousedown",ul.DOWN,(function(t,i,r,o){n._mousePressed=!0,n.handleTouchesBegin([n.getTouchByXY(t,r.x,r.y,o)]),e.focus()})),i("mouseup",ul.UP,(function(e,t,i,r){n._mousePressed=!1,n.handleTouchesEnd([n.getTouchByXY(e,i.x,i.y,r)])})),i("mousemove",ul.MOVE,(function(e,t,i,r){n.handleTouchesMove([n.getTouchByXY(e,i.x,i.y,r)]),n._mousePressed||t.setButton(ul.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),i("mousewheel",ul.SCROLL,(function(e,t,n,i){t.setScrollData(0,e.wheelDelta)})),i("DOMMouseScroll",ul.SCROLL,(function(e,t,n,i){t.setScrollData(0,-120*e.detail)}))}},{key:"_registerMousePointerEvents",value:function(e){var t=this,n={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},i=function(i){var r=n[i];e.addEventListener(i,(function(n){var i=t.getHTMLElementPosition(e);i.left-=document.documentElement.scrollLeft,i.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(n,n.clientX,n.clientY,i)]),n.stopPropagation()}),!1)};for(var r in n)i(r)}},{key:"_registerTouchEvents",value:function(e){var t=this,n=function(n){return function(i){if(i.changedTouches){var r=t.getHTMLElementPosition(e),o=document.body;r.left-=o.scrollLeft||0,r.top-=o.scrollTop||0,n(t.getTouchesByEvent(i,r)),i.stopPropagation(),i.preventDefault()}}};e.addEventListener("touchstart",n((function(n){t.handleTouchesBegin(n),e.focus()})),!1),e.addEventListener("touchmove",n((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",n((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",n((function(e){t.handleTouchesCancel(e)})),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=a.game.canvas;e.addEventListener("keydown",(function(e){Tl.dispatchEvent(new hl(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){Tl.dispatchEvent(new hl(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new HS,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,a.sys.browserType===a.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";BS=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,BS,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";BS&&window.removeEventListener(e,BS,!1)}},{key:"_getUsefulTouches",value:function(){var e=[],t=this._touchesIntegerDict;for(var n in t){var i=t[parseInt(n)];if(null!=i){var r=this._touches[i];e.push(r)}}return e}}]),e}()));a.internal.inputManager=qS;var WS=e("bh",function(e){function t(){var e,n;o(this,t);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(n=l(this,(e=u(t)).call.apply(e,[this].concat(r)))).frame=null,n.container=null,n.canvas=null,n.renderType=-1,n.eventTargetOn=D(u(t.prototype),"on",F(n)),n.eventTargetOnce=D(u(t.prototype),"once",F(n)),n.config={},n.onStart=null,n._persistRootNodes={},n._paused=!0,n._configLoaded=!1,n._isCloning=!1,n._inited=!1,n._rendererInitialized=!1,n._gfxDevice=null,n._intervalId=null,n._lastTime=null,n._frameTime=null,n._sceneInfos=[],n.collisionMatrix=[],n.groupList=[],n}return c(t,e),r(t,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){a.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){a.director.once(a.Director.EVENT_AFTER_DRAW,(function(){for(var e in a.game._persistRootNodes)a.game.removePersistRootNode(a.game._persistRootNodes[e]);a.director.getScene().destroy(),a.Object._deferredDestroy(),a.director.reset(),a.game.pause(),a.game._loadRenderPipeline((function(){a.game.resume(),a.game._safeEmit(a.Game.EVENT_RESTART)}))}))}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,n,i,r){this._inited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOn(e,n,i,r)}},{key:"once",value:function(e,n,i){this._inited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)}},{key:"init",value:function(e){return this._initConfig(e),this.config.assetOptions&&Gm.init(this.config.assetOptions),this._initEngine(),this._initEvents(),a.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),this._inited}},{key:"run",value:function(e,t){if(this._initEvents(),"function"!=typeof e&&t){var n=this.onStart;this.init(n),this.onStart=t}else this.onStart=e;this._setAnimFrame(),this._runMainLoop(),DT.config.registerSystemEvent&&qS.registerSystemEvent(DT.canvas),this._loadRenderPipeline(null)}},{key:"addPersistRootNode",value:function(e){if(a.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=a.director._scene;if(a.isValid(n))if(e.parent){if(!(e.parent instanceof a.Scene))return void N(3801);if(e.parent!==n)return void N(3802)}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0}}else N(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"_initEngine",value:function(){this._initDevice(),a.director._init(),console.log("Cocos Creator 3D v"+a.ENGINE_VERSION),this.emit(t.EVENT_ENGINE_INITED),this._inited=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=a.game.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),60!==e&&30!==e?(window.rAF=this._stTime,window.cAF=this._ctTime):(window.rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),n=Math.max(0,t-a.game._lastTime),i=Math.max(0,a.game._frameTime-n),r=window.setTimeout(e,i);return a.game._lastTime=t+i,r}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var e,t=this,n=this.config,i=a.director,r=!0,o=n.frameRate;rt(!!n.showFPS),i.startAnimation(),e=function(n){t._paused||(t._intervalId=window.rAF(e),30===o&&(r=!r)||i.mainLoop(n))},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(e),this._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],ot(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,n=parseInt(e.renderMode);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(0===n?a.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):a.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):1===n&&a.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):2===n&&a.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(ce(3820,n))}},{key:"_initDevice",value:function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],n=!!window.WebGL2RenderingContext,i=window.navigator.userAgent.toLowerCase();(-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||P.browserType===P.BROWSER_TYPE_UC)&&(n=!1),n&&a.WebGL2Device&&e.push(a.WebGL2Device),a.WebGLDevice&&e.push(a.WebGLDevice);for(var r={canvasElm:this.canvas,debug:!0,isAntialias:oa.ENABLE_WEBGL_ANTIALIAS,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*window.devicePixelRatio),nativeHeight:Math.floor(screen.height*window.devicePixelRatio),bindingMappingInfo:Ra},o=0;o<e.length&&(this._gfxDevice=new e[o],!this._gfxDevice.initialize(r));o++);}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!a._isContextMenuEnable)return!1}}}},{key:"_initEvents",value:function(){var e,n=window;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var i=!1;function r(){i||(i=!0,a.game.emit(t.EVENT_HIDE))}function o(){i&&(i=!1,a.game.emit(t.EVENT_SHOW))}if(e)for(var s=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],c=0;c<s.length;c++)document.addEventListener(s[c],(function(t){var n=document[e];(n=n||t.hidden)?r():o()}));else n.addEventListener("blur",r),n.addEventListener("focus",o);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(n.onfocus=o),"onpageshow"in window&&"onpagehide"in window&&(n.addEventListener("pagehide",r),n.addEventListener("pageshow",o),document.addEventListener("pagehide",r),document.addEventListener("pageshow",o)),this.on(t.EVENT_HIDE,(function(){a.game.pause()})),this.on(t.EVENT_SHOW,(function(){a.game.resume()}))}},{key:"_loadRenderPipeline",value:function(e){var n=this,i=a.internal.SplashScreen,r=this.config.renderPipeline;if(r)a.loader.load({uuid:r},(function(o,s){if(!o&&s instanceof ax)try{n._setRenderPipeline(s)}catch(e){console.warn(e),console.warn("Failed load renderpipeline: ".concat(r,", engine failed to initialize, will fallback to default pipeline")),n._setRenderPipeline()}else console.warn("Failed load renderpipeline: ".concat(r,", engine failed to initialize, will fallback to default pipeline")),console.warn(o),n._setRenderPipeline();if(n._safeEmit(t.EVENT_GAME_INITED),i){var c=a.internal.SplashScreen.instance;c.main(a.director.root),c.setOnFinish((function(){n.onStart&&n.onStart(),e&&e()})),c.loadFinish=!0}else n.onStart&&n.onStart(),e&&e()}));else if(this._setRenderPipeline(),this._safeEmit(t.EVENT_GAME_INITED),i){var o=a.internal.SplashScreen.instance;o.main(a.director.root),o.setOnFinish((function(){n.onStart&&n.onStart(),e&&e()})),o.loadFinish=!0}else this.onStart&&this.onStart(),e&&e()}},{key:"_setRenderPipeline",value:function(e){a.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)}},{key:"_safeEmit",value:function(e){this.emit(e)}},{key:"inited",get:function(){return this._inited}}]),t}(at));WS.EVENT_HIDE="game_on_hide",WS.EVENT_SHOW="game_on_show",WS.EVENT_GAME_INITED="game_inited",WS.EVENT_ENGINE_INITED="engine_inited",WS.EVENT_RENDERER_INITED="renderer_inited",WS.EVENT_RESTART="game_on_restart",WS.RENDER_TYPE_CANVAS=0,WS.RENDER_TYPE_WEBGL=1,WS.RENDER_TYPE_OPENGL=2,a.Game=WS;var XS,YS,KS,QS,JS,ZS,$S,eC,tC,nC,iC,rC,oC,aC,sC,cC,lC,uC,_C,fC,hC,dC,vC,mC,pC,gC,yC,xC,SC,CC,TC,EC,AC,bC,wC,IC,RC,OC,PC,NC,DC,zC,MC,LC,FC,kC,UC,BC,GC,jC,VC,HC,qC,WC,XC,YC,KC,QC,JC,ZC,$C,eT,tT,nT,iT,rT,oT,aT,sT,cT,lT,uT,_T,fT,hT,dT,vT,mT,pT,gT,yT,xT,ST,CT,TT,ET,AT,bT,wT,IT,RT,OT,PT,NT,DT=e("bi",a.game=new WS),zT=new s(0,1,0),MT=new s,LT=new X,FT=(XS=A("cc.AmbientInfo"),YS=U(st),XS((JS=b((QS=function(){function e(){o(this,e),R(this,"_skyColor",JS,this),R(this,"_skyIllum",ZS,this),R(this,"_groundAlbedo",$S,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.skyColor=this._skyColor,this._resource.skyIllum=this._skyIllum,this._resource.groundAlbedo=this._groundAlbedo}},{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)},get:function(){return this._groundAlbedo}}]),e}()).prototype,"_skyColor",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xe(51,128,204,1)}}),ZS=b(QS.prototype,"_skyIllum",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return K_.SKY_ILLUM}}),$S=b(QS.prototype,"_groundAlbedo",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xe(51,51,51,255)}}),b(QS.prototype,"skyColor",[I],Object.getOwnPropertyDescriptor(QS.prototype,"skyColor"),QS.prototype),b(QS.prototype,"skyIllum",[I,YS],Object.getOwnPropertyDescriptor(QS.prototype,"skyIllum"),QS.prototype),b(QS.prototype,"groundAlbedo",[I],Object.getOwnPropertyDescriptor(QS.prototype,"groundAlbedo"),QS.prototype),KS=QS))||KS);a.AmbientInfo=FT;var kT=(eC=A("cc.SkyboxInfo"),tC=U(Gs),nC=U(Gs),eC((oC=b((rC=function(){function e(){o(this,e),R(this,"_envmap",oC,this),R(this,"_isRGBE",aC,this),R(this,"_enabled",sC,this),R(this,"_useIBL",cC,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.activate(),this._resource.enabled=this._enabled,this._resource.isRGBE=this._isRGBE,this._resource.envmap=this._envmap,this._resource.useIBL=this._useIBL}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}}]),e}()).prototype,"_envmap",[tC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aC=b(rC.prototype,"_isRGBE",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sC=b(rC.prototype,"_enabled",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cC=b(rC.prototype,"_useIBL",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b(rC.prototype,"enabled",[I],Object.getOwnPropertyDescriptor(rC.prototype,"enabled"),rC.prototype),b(rC.prototype,"useIBL",[I],Object.getOwnPropertyDescriptor(rC.prototype,"useIBL"),rC.prototype),b(rC.prototype,"envmap",[I,nC],Object.getOwnPropertyDescriptor(rC.prototype,"envmap"),rC.prototype),b(rC.prototype,"isRGBE",[I],Object.getOwnPropertyDescriptor(rC.prototype,"isRGBE"),rC.prototype),iC=rC))||iC);a.SkyboxInfo=kT;var UT=(lC=A("cc.FogInfo"),uC=U(wS),_C=be(),fC=U(st),hC=lt(),dC=ut(),vC=me(),mC=be(),pC=U(st),gC=ut(),yC=me(),xC=be(),SC=U(st),CC=ut(),TC=me(),EC=be(),AC=U(st),bC=J(),wC=ut(),IC=me(),RC=be(),OC=U(st),PC=ut(),NC=me(),DC=be(),zC=U(st),MC=ut(),LC=me(),lC((KC=YC=function(){function e(){o(this,e),R(this,"_type",UC,this),R(this,"_fogColor",BC,this),R(this,"_enabled",GC,this),R(this,"_fogDensity",jC,this),R(this,"_fogStart",VC,this),R(this,"_fogEnd",HC,this),R(this,"_fogAtten",qC,this),R(this,"_fogTop",WC,this),R(this,"_fogRange",XC,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.enabled=this._enabled,this._resource.fogColor=this._fogColor,this._resource.type=this._type,this._resource.fogDensity=this._fogDensity,this._resource.fogStart=this._fogStart,this._resource.fogEnd=this._fogEnd,this._resource.fogAtten=this._fogAtten,this._resource.fogTop=this._fogTop,this._resource.fogRange=this._fogRange}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"fogColor",set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),YC.FogType=wS,UC=b((kC=KC).prototype,"_type",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wS.LINEAR}}),BC=b(kC.prototype,"_fogColor",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xe("#C8C8C8")}}),GC=b(kC.prototype,"_enabled",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jC=b(kC.prototype,"_fogDensity",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),VC=b(kC.prototype,"_fogStart",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),HC=b(kC.prototype,"_fogEnd",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),qC=b(kC.prototype,"_fogAtten",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),WC=b(kC.prototype,"_fogTop",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),XC=b(kC.prototype,"_fogRange",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),b(kC.prototype,"enabled",[I],Object.getOwnPropertyDescriptor(kC.prototype,"enabled"),kC.prototype),b(kC.prototype,"fogColor",[I],Object.getOwnPropertyDescriptor(kC.prototype,"fogColor"),kC.prototype),b(kC.prototype,"type",[I,uC],Object.getOwnPropertyDescriptor(kC.prototype,"type"),kC.prototype),b(kC.prototype,"fogDensity",[_C,fC,hC,dC,ct,vC],Object.getOwnPropertyDescriptor(kC.prototype,"fogDensity"),kC.prototype),b(kC.prototype,"fogStart",[mC,pC,gC,yC],Object.getOwnPropertyDescriptor(kC.prototype,"fogStart"),kC.prototype),b(kC.prototype,"fogEnd",[xC,SC,CC,TC],Object.getOwnPropertyDescriptor(kC.prototype,"fogEnd"),kC.prototype),b(kC.prototype,"fogAtten",[EC,AC,bC,wC,IC],Object.getOwnPropertyDescriptor(kC.prototype,"fogAtten"),kC.prototype),b(kC.prototype,"fogTop",[RC,OC,PC,NC],Object.getOwnPropertyDescriptor(kC.prototype,"fogTop"),kC.prototype),b(kC.prototype,"fogRange",[DC,zC,MC,LC],Object.getOwnPropertyDescriptor(kC.prototype,"fogRange"),kC.prototype),FC=kC))||FC),BT=(QC=A("cc.ShadowsInfo"),JC=U(Ff),ZC=be(),$C=U(st),eT=be(),tT=U(kf),nT=be(),iT=U(st),rT=be(),oT=U(st),aT=be(),sT=U(st),cT=be(),lT=be(),uT=U(st),_T=be(),QC((dT=b((hT=function(){function e(){o(this,e),R(this,"_type",dT,this),R(this,"_enabled",vT,this),R(this,"_normal",mT,this),R(this,"_distance",pT,this),R(this,"_shadowColor",gT,this),R(this,"_pcf",yT,this),R(this,"_near",xT,this),R(this,"_far",ST,this),R(this,"_aspect",CT,this),R(this,"_orthoSize",TT,this),R(this,"_size",ET,this),this._resource=null}return r(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(LT),this.normal=s.transformQuat(MT,zT,LT),e.getWorldPosition(MT),this.distance=s.dot(this._normal,MT)}},{key:"activate",value:function(e){this._resource=e,this._resource.type=this._type,this._resource.near=this._near,this._resource.far=this._far,this._resource.orthoSize=this._orthoSize,this._resource.size=this._size,this._resource.normal=this._normal,this._resource.distance=this._distance,this._resource.shadowColor=this._shadowColor,this._resource.pcf=this._pcf,this._resource.enabled=this._enabled}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"type",set:function(e){this._type=e,this._resource&&(this._resource.type=e)},get:function(){return this._type}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"normal",set:function(e){s.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"pcf",set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)},get:function(){return this._pcf}},{key:"near",set:function(e){this._near=e,this._resource&&(this._resource.near=e)},get:function(){return this._near}},{key:"far",set:function(e){this._far=e,this._resource&&(this._resource.far=e)},get:function(){return this._far}},{key:"orthoSize",set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)},get:function(){return this._orthoSize}},{key:"shadowMapSize",set:function(e){this._size.set(e),this._resource&&(this._resource.size=e)},get:function(){return this._size}},{key:"aspect",set:function(e){this._aspect=e,this._resource&&(this._resource.aspect=e)},get:function(){return this._aspect}}]),e}()).prototype,"_type",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ff.Planar}}),vT=b(hT.prototype,"_enabled",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mT=b(hT.prototype,"_normal",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s(0,1,0)}}),pT=b(hT.prototype,"_distance",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gT=b(hT.prototype,"_shadowColor",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xe(0,0,0,76)}}),yT=b(hT.prototype,"_pcf",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kf.HARD}}),xT=b(hT.prototype,"_near",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ST=b(hT.prototype,"_far",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),CT=b(hT.prototype,"_aspect",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TT=b(hT.prototype,"_orthoSize",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ET=b(hT.prototype,"_size",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Y(512,512)}}),b(hT.prototype,"enabled",[I],Object.getOwnPropertyDescriptor(hT.prototype,"enabled"),hT.prototype),b(hT.prototype,"type",[I,JC],Object.getOwnPropertyDescriptor(hT.prototype,"type"),hT.prototype),b(hT.prototype,"shadowColor",[I],Object.getOwnPropertyDescriptor(hT.prototype,"shadowColor"),hT.prototype),b(hT.prototype,"normal",[ZC],Object.getOwnPropertyDescriptor(hT.prototype,"normal"),hT.prototype),b(hT.prototype,"distance",[$C,eT],Object.getOwnPropertyDescriptor(hT.prototype,"distance"),hT.prototype),b(hT.prototype,"pcf",[tT,nT],Object.getOwnPropertyDescriptor(hT.prototype,"pcf"),hT.prototype),b(hT.prototype,"near",[iT,rT],Object.getOwnPropertyDescriptor(hT.prototype,"near"),hT.prototype),b(hT.prototype,"far",[oT,aT],Object.getOwnPropertyDescriptor(hT.prototype,"far"),hT.prototype),b(hT.prototype,"orthoSize",[sT,cT],Object.getOwnPropertyDescriptor(hT.prototype,"orthoSize"),hT.prototype),b(hT.prototype,"shadowMapSize",[lT],Object.getOwnPropertyDescriptor(hT.prototype,"shadowMapSize"),hT.prototype),b(hT.prototype,"aspect",[uT,_T],Object.getOwnPropertyDescriptor(hT.prototype,"aspect"),hT.prototype),fT=hT))||fT);a.ShadowsInfo=BT;var GT,jT,VT,HT,qT=(AT=A("cc.SceneGlobals"),bT=U(kT),AT((RT=b((IT=function(){function e(){o(this,e),R(this,"ambient",RT,this),R(this,"shadows",OT,this),R(this,"_skybox",PT,this),R(this,"fog",NT,this)}return r(e,[{key:"activate",value:function(){var e=a.director.root.pipeline;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)}},{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}()).prototype,"ambient",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FT}}),OT=b(IT.prototype,"shadows",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BT}}),PT=b(IT.prototype,"_skybox",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kT}}),NT=b(IT.prototype,"fog",[I,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UT}}),b(IT.prototype,"skybox",[I,bT],Object.getOwnPropertyDescriptor(IT.prototype,"skybox"),IT.prototype),wT=IT))||wT);a.SceneGlobals=qT;var WT,XT=e("cY",A("cc.Scene")((b((jT=function(e){function t(e){var n;return o(this,t),n=l(this,u(t).call(this,e)),R(n,"autoReleaseAssets",VT,F(n)),R(n,"_globals",HT,F(n)),n._renderScene=null,n.dependAssets=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=s.ZERO,n._rot=X.IDENTITY,n._scale=s.ONE,n._mat=f.IDENTITY,n._dirtyFlags=0,n._activeInHierarchy=!1,a.director&&a.director.root&&(n._renderScene=a.director.root.createScene({})),n._inited=!a.game||!a.game._isCloning,n}return c(t,e),r(t,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),r(t,[{key:"destroy",value:function(){var e=D(u(t.prototype),"destroy",this).call(this);return a.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){throw new Error(ce(3822))}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){D(u(t.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,n=0;n<e;++n)this._children[n]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return s.copy(e||new s,s.ZERO)}},{key:"getRotation",value:function(e){return X.copy(e||new X,X.IDENTITY)}},{key:"getScale",value:function(e){return s.copy(e||new s,s.ONE)}},{key:"getWorldPosition",value:function(e){return s.copy(e||new s,s.ZERO)}},{key:"getWorldRotation",value:function(e){return X.copy(e||new X,X.IDENTITY)}},{key:"getWorldScale",value:function(e){return s.copy(e||new s,s.ONE)}},{key:"getWorldMatrix",value:function(e){return f.copy(e||new f,f.IDENTITY)}},{key:"getWorldRS",value:function(e){return f.copy(e||new f,f.IDENTITY)}},{key:"getWorldRT",value:function(e){return f.copy(e||new f,f.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(gu._setScene)}},{key:"_activate",value:function(e){e=!1!==e,a.director._nodeActivator.activateNode(this,e),this._globals.activate()}},{key:"position",get:function(){return s.ZERO}},{key:"worldPosition",get:function(){return s.ZERO}},{key:"rotation",get:function(){return X.IDENTITY}},{key:"worldRotation",get:function(){return X.IDENTITY}},{key:"scale",get:function(){return s.ONE}},{key:"worldScale",get:function(){return s.ONE}},{key:"eulerAngles",get:function(){return s.ZERO}},{key:"worldMatrix",get:function(){return f.IDENTITY}}]),t}(gu)).prototype,"globals",[I],Object.getOwnPropertyDescriptor(jT.prototype,"globals"),jT.prototype),VT=b(jT.prototype,"autoReleaseAssets",[w,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HT=b(jT.prototype,"_globals",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qT}}),GT=jT))||GT);a.Scene=XT;var YT=ne.Flags.HideInHierarchy,KT=e("c$",A("cc.PrivateNode")(WT=function(e){function t(e){var n;return o(this,t),(n=l(this,u(t).call(this,e)))._objFlags|=YT,n}return c(t,e),t}(e_))||WT);a.PrivateNode=KT;var QT=_t.fastRemoveAt,JT=ne.Flags.IsStartCalled,ZT=ne.Flags.IsOnEnableCalled;ne.Flags.IsEditorOnEnableCalled;function $T(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function eE(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r._enabled&&r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}var tE=function e(t){o(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var n=ft;this._zero=new n([]),this._neg=new n([]),this._pos=new n([]),this._invoke=t};function nE(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}tE.stableRemoveInactive=eE;var iE=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){eE(this._zero,e),eE(this._neg,e),eE(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(nE),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(nE),this._invoke(t),t.array.length=0)}}]),t}(tE),rE=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=$T(n,e);i<0&&n.splice(~i,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=$T(n.array,e);i>=0&&n.removeAt(i)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),t}(tE);function oE(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){a._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){a._throw(e),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var aE=oE("c.start();c._objFlags|="+JT,!1,JT),sE=oE("c.update(dt)",!0),cE=oE("c.lateUpdate(dt)",!0),lE=function(e){var t=a.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];if(i._enabled)i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i)}},uE=(e("ds",function(){function e(){o(this,e),this._deferredComps=[],this.unscheduleAll()}return r(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new iE(aE),this.updateInvoker=new rE(sE),this.lateUpdateInvoker=new rE(cE),this._updating=!1}},{key:"_onEnabled",value:function(e){a.director.getScheduler().resumeTarget(e),e._objFlags|=ZT,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){a.director.getScheduler().pauseTarget(e),e._objFlags&=~ZT;var t=this._deferredComps.indexOf(e);t>=0?QT(this._deferredComps,t):(!e.start||e._objFlags&JT||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&ZT)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&ZT&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}},{key:"_startForNewComps",value:function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}},{key:"_scheduleImmediate",value:function(e){"function"!=typeof e.start||e._objFlags&JT||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0}}]),e}()),ne.Flags.IsPreloadStarted),_E=ne.Flags.IsOnLoadStarted,fE=ne.Flags.IsOnLoadCalled,hE=ne.Flags.Deactivating,dE=function(e){function t(){return o(this,t),l(this,u(t).apply(this,arguments))}return c(t,e),r(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){tE.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(tE),vE=oE("c.__preload();"),mE=oE("c.onLoad();c._objFlags|="+fE,!1,fE),pE=new Fe(4);function gE(e,t,n){t?e._removeComponent(t):_t.removeAt(e._components,n)}pE.get=function(){var e=this._get()||{preload:new dE(vE),onLoad:new iE(mE),onEnable:new iE(lE)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};e("d0",function(){function e(){o(this,e),this.resetComp=void 0,this.reset()}return r(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var n=pE.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),pE.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=this._activatingStack,o=z(r);!(i=o()).done;){var a=i.value;a.preload.cancelInactive(uE),a.onLoad.cancelInactive(_E),a.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,n,i){if(e._objFlags&uE||(e._objFlags|=uE,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&_E||(e._objFlags|=_E,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=fE):e._objFlags|=fE),e._enabled){if(!e.node._activeInHierarchy)return;a.director._compScheduler.enableComp(e,i)}}},{key:"destroyComp",value:function(e){a.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&fE&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,n,i){if(e._objFlags&hE)k(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var s=e._components[o];s instanceof a.Component?this.activateComp(s,t,n,i):(gE(e,s,o),--o,--r)}e._childArrivalOrder=e._children.length;for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=hE,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(a.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~hE)}for(var r=0,o=e._children.length;r<o;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~hE)}e._onPostActivated(!1),e._objFlags&=~hE}}]),e}());T(gu.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),T(e_.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Y),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Q),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setContentSize(e,t)}}]),E(e_.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),E(ma,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),T(ma,"Layers",[{name:"Default",newName:"DEFAULT",target:ma.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:ma.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:ma.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:ma.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:ma.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:ma.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:ma.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:ma.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:ma,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:ma,targetName:"Layers"}]),E(ma.Enum,"Layers.Enum",[{name:"ALWAYS"}]),E(ma.BitMask,"Layers.BitMask",[{name:"ALWAYS"}])}}}));
