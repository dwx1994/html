System.register(["./deprecated-fd5a8e75.js","./deprecated-9a4df5e2.js","./index-597c71d0.js","./SubContextView-ee466772.js","./component-event-handler-ff37202d.js","./ammo-instantiated-8bca311f.js","./index-b1fc77a7.js","./terrain-asset-cc69bca3.js","./array-collision-matrix-7cbcfe04.js"],(function(){"use strict";var t,i,e,s,o,n,r,a,l,h,d,c,u,p,_,y,S,f,g,C;return{setters:[function(p){t=p.V,i=p.Q,e=p.j,s=p.d,o=p.b,n=p.e,r=p.f,a=p.aO,l=p.ah,h=p.x,d=p.w,c=p.ap,u=p.ao},function(t){p=t.t,_=t.dS},function(){},function(){},function(){},function(t){y=t.A},function(t){S=t.P,f=t.E,g=t.s},function(){},function(t){C=t.A}],execute:function(){function E(t,i){return t.setValue(i.x,i.y,i.z),t}function v(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t}function m(t,i){return t.setValue(i.x,i.y,i.z,i.w),t}function T(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t.w=i.w(),t}function A(t,i){delete i.__cache__[t.ptr]}function b(t,i){for(var e=i.renderingSubMeshes.length,s=0;s<e;s++){var o=i.renderingSubMeshes[s],n=o.geometricInfo;if(n){var r=o.primitiveMode,a=n.positions,l=n.indices;if(r==p.TRIANGLE_LIST)for(var h=l.length,d=0;d<h;d+=3){var c=3*l[d],u=3*l[d+1],_=3*l[d+2],S=new y.btVector3(a[c],a[c+1],a[c+2]),f=new y.btVector3(a[u],a[u+1],a[u+2]),g=new y.btVector3(a[_],a[_+1],a[_+2]);t.addTriangle(S,f,g),y.destroy(S),y.destroy(f),y.destroy(g)}else if(r==p.TRIANGLE_STRIP)for(var C=l.length-2,E=0;E<C;E+=1){var v=3*l[E-0],m=3*l[E+0+1],T=3*l[E+2],A=new y.btVector3(a[v],a[v+1],a[v+2]),b=new y.btVector3(a[m],a[m+1],a[m+2]),O=new y.btVector3(a[T],a[T+1],a[T+2]);t.addTriangle(A,b,O),y.destroy(A),y.destroy(b),y.destroy(O)}else if(r==p.TRIANGLE_FAN)for(var P=l.length-1,B=3*l[0],R=new y.btVector3(a[B],a[B+1],a[B+2]),I=1;I<P;I+=1){var k=3*l[I],w=3*l[I+1],D=new y.btVector3(a[k],a[k+1],a[k+2]),Y=new y.btVector3(a[w],a[w+1],a[w+2]);t.addTriangle(R,D,Y),y.destroy(R),y.destroy(D),y.destroy(Y)}}}return t}var O,P,B,R,I,k,w,D,Y;!function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(O||(O={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(P||(P={})),y.AmmoCollisionFlags=P,function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(B||(B={})),y.AmmoCollisionObjectTypes=B,function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(R||(R={})),function(t){t[t.CF_ANISOTROPIC_FRICTION_DISABLED=0]="CF_ANISOTROPIC_FRICTION_DISABLED",t[t.CF_ANISOTROPIC_FRICTION=1]="CF_ANISOTROPIC_FRICTION",t[t.CF_ANISOTROPIC_ROLLING_FRICTION=2]="CF_ANISOTROPIC_ROLLING_FRICTION"}(I||(I={})),y.AmmoAnisotropicFrictionFlags=I,function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(k||(k={})),y.AmmoRigidBodyFlags=k,function(t){t[t.BOX_SHAPE_PROXYTYPE=0]="BOX_SHAPE_PROXYTYPE",t[t.TRIANGLE_SHAPE_PROXYTYPE=1]="TRIANGLE_SHAPE_PROXYTYPE",t[t.TETRAHEDRAL_SHAPE_PROXYTYPE=2]="TETRAHEDRAL_SHAPE_PROXYTYPE",t[t.CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE=3]="CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE",t[t.CONVEX_HULL_SHAPE_PROXYTYPE=4]="CONVEX_HULL_SHAPE_PROXYTYPE",t[t.CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE=5]="CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE",t[t.CUSTOM_POLYHEDRAL_SHAPE_TYPE=6]="CUSTOM_POLYHEDRAL_SHAPE_TYPE",t[t.IMPLICIT_CONVEX_SHAPES_START_HERE=7]="IMPLICIT_CONVEX_SHAPES_START_HERE",t[t.SPHERE_SHAPE_PROXYTYPE=8]="SPHERE_SHAPE_PROXYTYPE",t[t.MULTI_SPHERE_SHAPE_PROXYTYPE=9]="MULTI_SPHERE_SHAPE_PROXYTYPE",t[t.CAPSULE_SHAPE_PROXYTYPE=10]="CAPSULE_SHAPE_PROXYTYPE",t[t.CONE_SHAPE_PROXYTYPE=11]="CONE_SHAPE_PROXYTYPE",t[t.CONVEX_SHAPE_PROXYTYPE=12]="CONVEX_SHAPE_PROXYTYPE",t[t.CYLINDER_SHAPE_PROXYTYPE=13]="CYLINDER_SHAPE_PROXYTYPE",t[t.UNIFORM_SCALING_SHAPE_PROXYTYPE=14]="UNIFORM_SCALING_SHAPE_PROXYTYPE",t[t.MINKOWSKI_SUM_SHAPE_PROXYTYPE=15]="MINKOWSKI_SUM_SHAPE_PROXYTYPE",t[t.MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE=16]="MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE",t[t.BOX_2D_SHAPE_PROXYTYPE=17]="BOX_2D_SHAPE_PROXYTYPE",t[t.CONVEX_2D_SHAPE_PROXYTYPE=18]="CONVEX_2D_SHAPE_PROXYTYPE",t[t.CUSTOM_CONVEX_SHAPE_TYPE=19]="CUSTOM_CONVEX_SHAPE_TYPE",t[t.CONCAVE_SHAPES_START_HERE=20]="CONCAVE_SHAPES_START_HERE",t[t.TRIANGLE_MESH_SHAPE_PROXYTYPE=21]="TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE=22]="SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.FAST_CONCAVE_MESH_PROXYTYPE=23]="FAST_CONCAVE_MESH_PROXYTYPE",t[t.TERRAIN_SHAPE_PROXYTYPE=24]="TERRAIN_SHAPE_PROXYTYPE",t[t.GIMPACT_SHAPE_PROXYTYPE=25]="GIMPACT_SHAPE_PROXYTYPE",t[t.MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE=26]="MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE",t[t.EMPTY_SHAPE_PROXYTYPE=27]="EMPTY_SHAPE_PROXYTYPE",t[t.STATIC_PLANE_PROXYTYPE=28]="STATIC_PLANE_PROXYTYPE",t[t.CUSTOM_CONCAVE_SHAPE_TYPE=29]="CUSTOM_CONCAVE_SHAPE_TYPE",t[t.CONCAVE_SHAPES_END_HERE=30]="CONCAVE_SHAPES_END_HERE",t[t.COMPOUND_SHAPE_PROXYTYPE=31]="COMPOUND_SHAPE_PROXYTYPE",t[t.SOFTBODY_SHAPE_PROXYTYPE=32]="SOFTBODY_SHAPE_PROXYTYPE",t[t.HFFLUID_SHAPE_PROXYTYPE=33]="HFFLUID_SHAPE_PROXYTYPE",t[t.HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE=34]="HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE",t[t.INVALID_SHAPE_PROXYTYPE=35]="INVALID_SHAPE_PROXYTYPE",t[t.MAX_BROADPHASE_COLLISION_TYPES=36]="MAX_BROADPHASE_COLLISION_TYPES"}(w||(w={})),y.AmmoBroadphaseNativeTypes=w,function(t){t[t.DefaultFilter=1]="DefaultFilter",t[t.StaticFilter=2]="StaticFilter",t[t.KinematicFilter=4]="KinematicFilter",t[t.DebrisFilter=8]="DebrisFilter",t[t.SensorTrigger=16]="SensorTrigger",t[t.CharacterFilter=32]="CharacterFilter",t[t.AllFilter=-1]="AllFilter"}(D||(D={})),y.AmmoCollisionFilterGroups=D,function(t){t[t.CD_STATIC_STATIC_REPORTED=1]="CD_STATIC_STATIC_REPORTED",t[t.CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD=2]="CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD",t[t.CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION=4]="CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION"}(Y||(Y={})),y.AmmoDispatcherFlags=Y;var H={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},L={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},N=function(){function t(){s(this,t),this.EMPTY_SHAPE=new y.btEmptyShape,this.TRANSFORM=new y.btTransform,this.VECTOR3_0=new y.btVector3,this.VECTOR3_1=new y.btVector3,this.QUAT_0=new y.btQuaternion}return e(t,null,[{key:"instance",get:function(){return null==t._instance&&(t._instance=new t),t._instance}}]),t}();N._instance=void 0;var M=new t,F=new t,x=new i,V=M,G=F,X=function(){function i(){s(this,i),this.id=void 0,this._isEnabled=!1,this.id=i.idCounter++}return e(i,[{key:"setMass",value:function(t){var i=N.instance.VECTOR3_0;i.setValue(1.6666666269302368,1.6666666269302368,1.6666666269302368);var e=this.impl.getCollisionShape();e.isCompound()?this._sharedBody.bodyCompoundShape.getNumChildShapes()>0&&e.calculateLocalInertia(this._rigidBody.mass,i):e.calculateLocalInertia(this._rigidBody.mass,i),this.impl.setMassProps(t,i),this._wakeUpIfSleep(),this._sharedBody.dirty|=O.BODY_RE_ADD}},{key:"setLinearDamping",value:function(t){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)}},{key:"setAngularDamping",value:function(t){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)}},{key:"setIsKinematic",value:function(t){var i=this.impl.getCollisionFlags();t?i|=P.CF_KINEMATIC_OBJECT:i&=~P.CF_KINEMATIC_OBJECT,this.impl.setCollisionFlags(i)}},{key:"useGravity",value:function(i){var e=this.impl.getFlags();i?e&=~k.BT_DISABLE_WORLD_GRAVITY:(this.impl.setGravity(E(N.instance.VECTOR3_0,t.ZERO)),e|=k.BT_DISABLE_WORLD_GRAVITY),this.impl.setFlags(e),this._wakeUpIfSleep(),this._sharedBody.dirty|=O.BODY_RE_ADD}},{key:"fixRotation",value:function(i){i?this.impl.setAngularFactor(E(N.instance.VECTOR3_0,t.ZERO)):this.impl.setAngularFactor(E(N.instance.VECTOR3_0,this._rigidBody.angularFactor)),this._wakeUpIfSleep()}},{key:"setLinearFactor",value:function(t){this.impl.setLinearFactor(E(N.instance.VECTOR3_0,t)),this._wakeUpIfSleep()}},{key:"setAngularFactor",value:function(t){this._rigidBody.fixedRotation||this.impl.setAngularFactor(E(N.instance.VECTOR3_0,t)),this._wakeUpIfSleep()}},{key:"setAllowSleep",value:function(t){t?this.impl.forceActivationState(R.ACTIVE_TAG):this.impl.forceActivationState(R.DISABLE_DEACTIVATION),this._wakeUpIfSleep()}},{key:"isAwake",get:function(){var t=this.impl.getActivationState();return t==R.ACTIVE_TAG||t==R.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return this.impl.getActivationState()==R.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return this.impl.getActivationState()==R.ISLAND_SLEEPING}},{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}}]),e(i,[{key:"clearState",value:function(){this.impl.clearState()}},{key:"clearVelocity",value:function(){this.setLinearVelocity(t.ZERO),this.setAngularVelocity(t.ZERO)}},{key:"clearForces",value:function(){this.impl.clearForces()}},{key:"initialize",value:function(t){this._rigidBody=t,this._sharedBody=S.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0}},{key:"onEnable",value:function(){this._isEnabled=!0,this.setGroup(this._rigidBody.group),S.instance.useCollisionMatrix&&this.setMask(S.instance.collisionMatrix[this._rigidBody.group]),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setIsKinematic(this._rigidBody.isKinematic),this.fixRotation(this._rigidBody.fixedRotation),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0}},{key:"onDisable",value:function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1}},{key:"onDestroy",value:function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null}},{key:"wakeUp",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.impl.activate(t)}},{key:"sleep",value:function(){return this.impl.wantsSleeping()}},{key:"setSleepThreshold",value:function(t){this._wakeUpIfSleep(),this.impl.setSleepingThresholds(t,t)}},{key:"getSleepThreshold",value:function(){return this.impl.getLinearSleepingThreshold()}},{key:"getType",value:function(){return this.impl.isStaticOrKinematicObject()?this.impl.isKinematicObject()?f.KINEMATIC:f.STATIC:f.DYNAMIC}},{key:"getLinearVelocity",value:function(t){return v(t,this.impl.getLinearVelocity())}},{key:"setLinearVelocity",value:function(t){this._wakeUpIfSleep(),E(this.impl.getLinearVelocity(),t)}},{key:"getAngularVelocity",value:function(t){return v(t,this.impl.getAngularVelocity())}},{key:"setAngularVelocity",value:function(t){this._wakeUpIfSleep(),E(this.impl.getAngularVelocity(),t)}},{key:"applyLocalForce",value:function(i,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=t.transformQuat(V,i,s),n=e?t.transformQuat(G,e,s):t.ZERO;this.impl.applyForce(E(N.instance.VECTOR3_0,o),E(N.instance.VECTOR3_1,n))}},{key:"applyLocalTorque",value:function(i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),t.transformQuat(V,i,this._sharedBody.node.worldRotation),this.impl.applyTorque(E(N.instance.VECTOR3_0,V))}},{key:"applyLocalImpulse",value:function(i,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=t.transformQuat(V,i,s),n=e?t.transformQuat(G,e,s):t.ZERO;this.impl.applyImpulse(E(N.instance.VECTOR3_0,o),E(N.instance.VECTOR3_1,n))}},{key:"applyForce",value:function(i,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=e||t.ZERO;this.impl.applyForce(E(N.instance.VECTOR3_0,i),E(N.instance.VECTOR3_1,s))}},{key:"applyTorque",value:function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),this.impl.applyTorque(E(N.instance.VECTOR3_0,t))}},{key:"applyImpulse",value:function(i,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=e||t.ZERO;this.impl.applyImpulse(E(N.instance.VECTOR3_0,i),E(N.instance.VECTOR3_1,s))}},{key:"getGroup",value:function(){return this._sharedBody.collisionFilterGroup}},{key:"setGroup",value:function(t){this._sharedBody.collisionFilterGroup=t}},{key:"addGroup",value:function(t){this._sharedBody.collisionFilterGroup|=t}},{key:"removeGroup",value:function(t){this._sharedBody.collisionFilterGroup&=~t}},{key:"getMask",value:function(){return this._sharedBody.collisionFilterMask}},{key:"setMask",value:function(t){this._sharedBody.collisionFilterMask=t}},{key:"addMask",value:function(t){this._sharedBody.collisionFilterMask|=t}},{key:"removeMask",value:function(t){this._sharedBody.collisionFilterMask&=~t}},{key:"_wakeUpIfSleep",value:function(){this.isAwake||this.impl.activate(!0)}}]),i}();X.idCounter=0;var U=function(){function t(){s(this,t)}return e(t,null,[{key:"bodyStructs",get:function(){return this.bodyAndGhosts}},{key:"ghostStructs",get:function(){return this.bodyAndGhosts}}]),t}();U.bodyAndGhosts={};var W=M,z=x,K=0,j=function(){function t(i,e){s(this,t),this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.dirty=0,this._collisionFilterGroup=S.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._wrappedBody=null,this.id=t.idCounter++,this.wrappedWorld=e,this.node=i}return e(t,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.shape}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.shape}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!=this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=O.BODY_RE_ADD,this.dirty|=O.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!=this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=O.BODY_RE_ADD,this.dirty|=O.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){t?this.bodyIndex<0&&(this.bodyIndex=this.wrappedWorld.bodies.length,this.body.clearState(),this.wrappedWorld.addSharedBody(this),this.syncInitialBody()):this.bodyIndex>=0&&(0==this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0==this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0==this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(this.body.clearState(),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0==this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0==this.ref&&this.destroy()}}],[{key:"getSharedBody",value:function(i,e,s){var o,n=i.uuid;return t.sharedBodesMap.has(n)?o=t.sharedBodesMap.get(n):(o=new t(i,e),t.sharedBodesMap.set(i.uuid,o)),s&&(o._wrappedBody=s),o}}]),e(t,[{key:"_instantiateBodyStruct",value:function(){if(!this._bodyStruct){var t=new y.btTransform;t.setIdentity(),E(t.getOrigin(),this.node.worldPosition);var i=new y.btQuaternion;m(i,this.node.worldRotation),t.setRotation(i);var e=new y.btDefaultMotionState(t),s=new y.btVector3(1.6666666269302368,1.6666666269302368,1.6666666269302368),o=new y.btCompoundShape,n=new y.btRigidBodyConstructionInfo(0,e,N.instance.EMPTY_SHAPE,s),r=new y.btRigidBody(n),a=S.instance.sleepThreshold;r.setSleepingThresholds(a,a),this._bodyStruct={id:K++,body:r,localInertia:s,motionState:e,startTransform:t,shape:o,rbInfo:n,worldQuat:i,wrappedShapes:[],useCompound:!1},U.bodyStructs["KEY"+this._bodyStruct.id]=this._bodyStruct,this.body.setUserIndex(this._bodyStruct.id),this.body.setActivationState(R.DISABLE_DEACTIVATION),y.CC_CONFIG.ignoreSelfBody&&this._ghostStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0)}}},{key:"_instantiateGhostStruct",value:function(){if(!this._ghostStruct){var t=new y.btCollisionObject,i=new y.btCompoundShape;t.setCollisionShape(i),t.setCollisionFlags(P.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:K++,ghost:t,shape:i,worldQuat:new y.btQuaternion,wrappedShapes:[]},U.ghostStructs["KEY"+this._ghostStruct.id]=this._ghostStruct,this.ghost.setUserIndex(this._ghostStruct.id),this.ghost.setActivationState(R.DISABLE_DEACTIVATION),y.CC_CONFIG.ignoreSelfBody&&this._bodyStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0)}}},{key:"addShape",value:function(t,i){function e(t,i){t.body.setCollisionShape(i),t.dirty|=O.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!=s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var o=0;o<s;o++){this.bodyStruct.wrappedShapes[o].setCompound(this.bodyCompoundShape)}e(this,this.bodyStruct.shape)}else e(this,t.impl)}this.bodyEnabled=!0}}},{key:"removeShape",value:function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(this.ghostStruct.wrappedShapes.splice(e,1),t.setCompound(null),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(null):this.body.setCollisionShape(N.instance.EMPTY_SHAPE),this.body.activate(!0),this.dirty|=O.BODY_RE_ADD,this.bodyStruct.wrappedShapes.splice(s,1),this.bodyEnabled=!1)}}},{key:"updateDirty",value:function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&O.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&O.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)}},{key:"syncSceneToPhysics",value:function(){if(this.node.hasChangedFlags){var t=this.body.getWorldTransform();if(E(t.getOrigin(),this.node.worldPosition),m(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat),this.isBodySleeping()&&this.body.activate(),this.node.hasChangedFlags&_.SCALE)for(var i=0;i<this.bodyStruct.wrappedShapes.length;i++)this.bodyStruct.wrappedShapes[i].setScale()}}},{key:"syncPhysicsToScene",value:function(){if(!this.body.isStaticObject()&&!this.isBodySleeping()){var t=this.body.getWorldTransform();this.node.worldPosition=v(W,t.getOrigin()),t.getBasis().getRotation(this.bodyStruct.worldQuat),this.node.worldRotation=T(z,this.bodyStruct.worldQuat);var i=this.ghost.getWorldTransform();E(i.getOrigin(),this.node.worldPosition),m(this.ghostStruct.worldQuat,this.node.worldRotation),i.setRotation(this.ghostStruct.worldQuat)}}},{key:"syncSceneToGhost",value:function(){if(this.node.hasChangedFlags){var t=this.ghost.getWorldTransform();if(E(t.getOrigin(),this.node.worldPosition),m(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat),this.ghost.activate(),this.node.hasChangedFlags&_.SCALE)for(var i=0;i<this.ghostStruct.wrappedShapes.length;i++)this.ghostStruct.wrappedShapes[i].setScale()}}},{key:"syncInitialBody",value:function(){var t=this.body.getWorldTransform();E(t.getOrigin(),this.node.worldPosition),m(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat);for(var i=0;i<this.bodyStruct.wrappedShapes.length;i++)this.bodyStruct.wrappedShapes[i].setScale();this.body.activate()}},{key:"syncInitialGhost",value:function(){var t=this.ghost.getWorldTransform();E(t.getOrigin(),this.node.worldPosition),m(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat);for(var i=0;i<this.ghostStruct.wrappedShapes.length;i++)this.ghostStruct.wrappedShapes[i].setScale();this.ghost.activate()}},{key:"updateBodyByReAdd",value:function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))}},{key:"updateGhostByReAdd",value:function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))}},{key:"destroy",value:function(){if(t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var i=this._bodyStruct;y.destroy(i.localInertia),y.destroy(i.worldQuat),y.destroy(i.startTransform),y.destroy(i.motionState),y.destroy(i.rbInfo),y.destroy(i.shape),A(i.shape,y.btCollisionShape),y.castObject(i.body,y.btRigidBody).wrapped=null,A(i.body,y.btRigidBody),A(i.body,y.btCollisionObject);var e="KEY"+i.id;delete U.bodyStructs[e],this._bodyStruct=null}if(this._ghostStruct){var s=this._ghostStruct;y.destroy(s.worldQuat),y.destroy(s.shape),A(s.shape,y.btCollisionShape),y.destroy(s.ghost);var o="KEY"+s.id;delete U.bodyStructs[o],this._ghostStruct=null}}},{key:"isBodySleeping",value:function(){return this.body.getActivationState()==R.ISLAND_SLEEPING}}]),t}();j.idCounter=0,j.sharedBodesMap=new Map;var Q=function(){function t(){s(this,t),this.data=void 0,this.data={keys:[]}}return e(t,[{key:"get",value:function(t,i){if(t>i){var e=i;i=t,t=e}return this.data[t+"-"+i]}},{key:"set",value:function(t,i,e){if(t>i){var s=i;i=t,t=s}var o=t+"-"+i;if(null==e){var n=this.data.keys.indexOf(o);if(-1!=n)return this.data.keys.splice(n,1),delete this.data[o],e}return this.get(t,i)||this.data.keys.push(o),this.data[o]=e,this.data[o]}},{key:"reset",value:function(){for(var t=this.data,i=t.keys;i.length>0;){delete t[i.pop()]}}},{key:"getLength",value:function(){return this.data.keys.length}},{key:"getKeyByIndex",value:function(t){return this.data.keys[t]}},{key:"getDataByKey",value:function(t){return this.data[t]}}]),t}(),J=function(){function o(t){s(this,o),this.impl=null,this.event=void 0,this.event=t}return e(o,[{key:"isBodyA",get:function(){var t=this.event.selfCollider.shape.sharedBody.body,i=this.event.impl.getBody0();return Ammo.compare(i,t)}}]),e(o,[{key:"getLocalPointOnA",value:function(t){this.impl&&v(t,this.impl.m_localPointA)}},{key:"getLocalPointOnB",value:function(t){this.impl&&v(t,this.impl.m_localPointB)}},{key:"getWorldPointOnA",value:function(t){this.impl&&v(t,this.impl.m_positionWorldOnA)}},{key:"getWorldPointOnB",value:function(t){this.impl&&v(t,this.impl.m_positionWorldOnB)}},{key:"getLocalNormalOnB",value:function(e){if(this.impl){var s=x,o=N.instance.QUAT_0;this.event.impl.getBody1().getWorldTransform().getBasis().getRotation(o),T(s,o),i.invert(s,s),v(e,this.impl.m_normalWorldOnB),t.transformQuat(e,e,s)}}},{key:"getWorldNormalOnB",value:function(t){this.impl&&v(t,this.impl.m_normalWorldOnB)}}]),o}(),Z=[],q=M,$=F,tt=function(){function i(t){s(this,i),this._btWorld=void 0,this._btBroadphase=void 0,this._btSolver=void 0,this._btDispatcher=void 0,this._btGravity=void 0,this.bodies=[],this.ghosts=[],this.constraints=[],this.triggerArrayMat=new C,this.collisionArrayMat=new C,this.contactsDic=new Q,this.oldContactsDic=new Q,this.closeHitCB=new y.ClosestRayResultCallback(new y.btVector3,new y.btVector3),this.allHitsCB=new y.AllHitsRayResultCallback(new y.btVector3,new y.btVector3);var e=new y.btDefaultCollisionConfiguration;this._btDispatcher=new y.btCollisionDispatcher(e),this._btDispatcher.setDispatcherFlags(Y.CD_STATIC_STATIC_REPORTED),this._btBroadphase=new y.btDbvtBroadphase,this._btSolver=new y.btSequentialImpulseConstraintSolver,this._btWorld=new y.btDiscreteDynamicsWorld(this._btDispatcher,this._btBroadphase,this._btSolver,e),this._btGravity=new y.btVector3(0,-10,0),this._btWorld.setGravity(this._btGravity)}return e(i,[{key:"setAllowSleep",value:function(t){}},{key:"setDefaultMaterial",value:function(t){}},{key:"setGravity",value:function(t){E(this._btGravity,t),this._btWorld.setGravity(this._btGravity)}},{key:"impl",get:function(){return this._btWorld}}]),e(i,[{key:"step",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(0!=this.bodies.length||0!=this.ghosts.length){null==i&&(i=t),this._btWorld.stepSimulation(i,e,t);for(var s=0;s<this.bodies.length;s++)this.bodies[s].syncPhysicsToScene()}}},{key:"syncSceneToPhysics",value:function(){for(var t=0;t<this.ghosts.length;t++)this.ghosts[t].updateDirty(),this.ghosts[t].syncSceneToGhost();for(var i=0;i<this.bodies.length;i++)this.bodies[i].updateDirty(),this.bodies[i].syncSceneToPhysics()}},{key:"raycast",value:function(i,e,s,o){var n=E(this.allHitsCB.m_rayFromWorld,i.o);i.computeHit(q,e.maxDistance);var r=E(this.allHitsCB.m_rayToWorld,q);this.allHitsCB.m_collisionFilterGroup=-1,this.allHitsCB.m_collisionFilterMask=e.mask,this.allHitsCB.m_closestHitFraction=1,this.allHitsCB.m_shapePart=-1,this.allHitsCB.m_collisionObject=null,this.allHitsCB.m_shapeParts.clear(),this.allHitsCB.m_hitFractions.clear(),this.allHitsCB.m_collisionObjects.clear();var a=this.allHitsCB.m_hitPointWorld,l=this.allHitsCB.m_hitNormalWorld;if(a.clear(),l.clear(),this._btWorld.rayTest(n,r,this.allHitsCB),this.allHitsCB.hasHit()){for(var h=0,d=this.allHitsCB.m_collisionObjects.size();h<d;h++){var c=this.allHitsCB.m_collisionObjects.at(h),u=c.getCollisionShape(),p=void 0;if(u.isCompound()){var _=this.allHitsCB.m_shapeParts.at(h),y=c.getUserIndex();p=U.bodyAndGhosts["KEY"+y].wrappedShapes[_]}else p=u.wrapped;v(q,a.at(h)),v($,l.at(h));var S=t.distance(i.o,q),f=s.add();f._assign(q,S,p.collider,$),o.push(f)}return!0}return!1}},{key:"raycastClosest",value:function(i,e,s){var o=E(this.closeHitCB.m_rayFromWorld,i.o);i.computeHit(q,e.maxDistance);var n=E(this.closeHitCB.m_rayToWorld,q);if(this.closeHitCB.m_collisionFilterGroup=-1,this.closeHitCB.m_collisionFilterMask=e.mask,this.closeHitCB.m_closestHitFraction=1,this.closeHitCB.m_collisionObject=null,this._btWorld.rayTest(o,n,this.closeHitCB),this.closeHitCB.hasHit()){var r,a=this.closeHitCB.m_collisionObject,l=a.getCollisionShape();if(l.isCompound()){var h=a.getUserIndex(),d=U.bodyAndGhosts["KEY"+h],c=this.closeHitCB.m_shapePart;r=d.wrappedShapes[c]}else r=l.wrapped;v(q,this.closeHitCB.m_hitPointWorld),v($,this.closeHitCB.m_hitNormalWorld);var u=t.distance(i.o,q);return s._assign(q,u,r.collider,$),!0}return!1}},{key:"getSharedBody",value:function(t,i){return j.getSharedBody(t,this,i)}},{key:"addSharedBody",value:function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),this._btWorld.addRigidBody(t.body,t.collisionFilterGroup,t.collisionFilterMask))}},{key:"removeSharedBody",value:function(t){var i=this.bodies.indexOf(t);i>=0&&(this.bodies.splice(i,1),this._btWorld.removeRigidBody(t.body))}},{key:"addGhostObject",value:function(t){this.ghosts.indexOf(t)<0&&(this.ghosts.push(t),this._btWorld.addCollisionObject(t.ghost,t.collisionFilterGroup,t.collisionFilterMask))}},{key:"removeGhostObject",value:function(t){var i=this.ghosts.indexOf(t);i>=0&&(this.ghosts.splice(i,1),this._btWorld.removeCollisionObject(t.ghost))}},{key:"addConstraint",value:function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),this._btWorld.addConstraint(t.impl,!t.constraint.enableCollision),t.index=i)}},{key:"removeConstraint",value:function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),this._btWorld.removeConstraint(t.impl),t.index=-1)}},{key:"updateCollisionMatrix",value:function(t,i){for(var e=0;e<this.ghosts.length;e++){var s=this.ghosts[e];s.collisionFilterGroup==t&&(s.collisionFilterMask=i)}for(var o=0;o<this.bodies.length;o++){var n=this.bodies[o];n.collisionFilterGroup==t&&(n.collisionFilterMask=i)}}},{key:"emitEvents",value:function(){for(var t=this._btDispatcher.getNumManifolds(),i=0;i<t;i++){var e=this._btDispatcher.getManifoldByIndexInternal(i),s=e.getBody0(),o=e.getBody1();if((y.CC_CONFIG.emitStaticCollision||!s.isStaticObject()||!o.isStaticObject())&&(!s.useCharacter&&!o.useCharacter))for(var n=s.useCCD||o.useCCD,r=e.getNumContacts(),a=0;a<r;a++){var l=e.getContactPoint(a);if(l.getDistance()<=0){var h=l.getShape0(),d=l.getShape1(),c=void 0,u=void 0;if(n){if(s.useCCD){var p=s.wrapped.sharedBody;if(!p)continue;c=p.bodyStruct.wrappedShapes[0]}else{var _=s.getCollisionShape();if(_.isCompound())continue;c=_.wrapped}if(o.useCCD){var S=o.wrapped.sharedBody;if(!S)continue;u=S.bodyStruct.wrappedShapes[0]}else{var f=o.getCollisionShape();if(f.isCompound())continue;u=f.wrapped}}else{if(h.isCompound())c=y.castObject(h,y.btCompoundShape).getChildShape(l.m_index0).wrapped;else c=h.wrapped;if(d.isCompound())u=y.castObject(d,y.btCompoundShape).getChildShape(l.m_index1).wrapped;else u=d.wrapped}if(c.collider.needTriggerEvent||u.collider.needTriggerEvent||c.collider.needCollisionEvent||u.collider.needCollisionEvent){var g=this.contactsDic.get(c.id,u.id);null==g&&(g=this.contactsDic.set(c.id,u.id,{shape0:c,shape1:u,contacts:[],impl:e})),g.contacts.push(l)}}}}for(var C=this.contactsDic.getLength();C--;){Z.push.apply(Z,L.contacts),L.contacts.length=0;var E=this.contactsDic.getKeyByIndex(C),v=this.contactsDic.getDataByKey(E),m=v.shape0,T=v.shape1;this.oldContactsDic.set(m.id,T.id,v);var A=m.collider,b=T.collider;if(A&&b){if(A.isTrigger||b.isTrigger)this.triggerArrayMat.get(m.id,T.id)?H.type="onTriggerStay":(H.type="onTriggerEnter",this.triggerArrayMat.set(m.id,T.id,!0)),H.impl=v.impl,H.selfCollider=A,H.otherCollider=b,A.emit(H.type,H),H.selfCollider=b,H.otherCollider=A,b.emit(H.type,H);else{var O=A.attachedRigidBody,P=b.attachedRigidBody;if(O&&P){if(O.isSleeping&&P.isSleeping)continue}else if(null==O&&P){if(P.isSleeping)continue}else if(null==P&&O&&O.isSleeping)continue;this.collisionArrayMat.get(m.id,T.id)?L.type="onCollisionStay":(L.type="onCollisionEnter",this.collisionArrayMat.set(m.id,T.id,!0));for(var B=0;B<v.contacts.length;B++){var R=v.contacts[B];if(Z.length>0){var I=Z.pop();I.impl=R,L.contacts.push(I)}else{var k=new J(L);k.impl=R,L.contacts.push(k)}}L.impl=v.impl,L.selfCollider=A,L.otherCollider=b,A.emit(L.type,L),L.selfCollider=b,L.otherCollider=A,b.emit(L.type,L)}null==this.oldContactsDic.get(m.id,T.id)&&this.oldContactsDic.set(m.id,T.id,v)}}for(var w=this.oldContactsDic.getLength();w--;){var D=this.oldContactsDic.getKeyByIndex(w),Y=this.oldContactsDic.getDataByKey(D),N=Y.shape0,M=Y.shape1,F=N.collider,x=M.collider;if(F&&x){var V=F.isTrigger||x.isTrigger;if(null==this.contactsDic.getDataByKey(D))if(V)this.triggerArrayMat.get(N.id,M.id)&&(H.type="onTriggerExit",H.selfCollider=F,H.otherCollider=x,F.emit(H.type,H),H.selfCollider=x,H.otherCollider=F,x.emit(H.type,H),this.triggerArrayMat.set(N.id,M.id,!1),this.oldContactsDic.set(N.id,M.id,null));else if(this.collisionArrayMat.get(N.id,M.id)){Z.push.apply(Z,L.contacts),L.contacts.length=0;for(var G=0;G<Y.contacts.length;G++){var X=Y.contacts[G];if(Z.length>0){var U=Z.pop();U.impl=X,L.contacts.push(U)}else{var W=new J(L);W.impl=X,L.contacts.push(W)}}L.type="onCollisionExit",L.selfCollider=F,L.otherCollider=x,F.emit(L.type,L),L.selfCollider=x,L.otherCollider=F,x.emit(L.type,L),this.collisionArrayMat.set(N.id,M.id,!1),this.oldContactsDic.set(N.id,M.id,null)}}}this.contactsDic.reset()}}]),i}(),it=M,et=function(){function o(t){s(this,o),this.id=void 0,this.type=void 0,this._index=-1,this._isEnabled=!1,this._isBinding=!1,this._isTrigger=!1,this._btCompound=null,this.transform=void 0,this.pos=void 0,this.quat=void 0,this.scale=void 0,this.type=t,this.id=o.idCounter++,this.pos=new y.btVector3,this.quat=new y.btQuaternion,this.transform=new y.btTransform(this.quat,this.pos),this.transform.setIdentity(),this.scale=new y.btVector3(1,1,1)}return e(o,[{key:"setMaterial",value:function(t){!this._isTrigger&&this._isEnabled&&t&&(this._btCompound?this._btCompound.setMaterial(this._index,t.friction,t.restitution,t.rollingFriction,t.spinningFriction):(this._sharedBody.body.setFriction(t.friction),this._sharedBody.body.setRestitution(t.restitution),this._sharedBody.body.setRollingFriction(t.rollingFriction),this._sharedBody.body.setSpinningFriction(t.spinningFriction)))}},{key:"setCenter",value:function(i){t.copy(it,i),it.multiply(this._collider.node.worldScale),E(this.transform.getOrigin(),it),this.updateCompoundTransform()}},{key:"setAsTrigger",value:function(t){this._isTrigger!=t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"index",get:function(){return this._index}}]),e(o,[{key:"getAABB",value:function(i){var e=N.instance.TRANSFORM;e.setIdentity(),e.setRotation(m(N.instance.QUAT_0,this._collider.node.worldRotation));var s=N.instance.VECTOR3_0,o=N.instance.VECTOR3_1;this._btShape.getAabb(e,s,o),i.halfExtents.set((o.x()-s.x())/2,(o.y()-s.y())/2,(o.z()-s.z())/2),t.add(i.center,this._collider.node.worldPosition,this._collider.center)}},{key:"getBoundingSphere",value:function(i){i.radius=this._btShape.getLocalBoundingSphere(),t.add(i.center,this._collider.node.worldPosition,this._collider.center)}},{key:"initialize",value:function(t){this._collider=t,this._isBinding=!0,this.onComponentSet(),this.setWrapper(),this._sharedBody=S.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0}},{key:"onComponentSet",value:function(){}},{key:"onLoad",value:function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)}},{key:"onEnable",value:function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)}},{key:"onDisable",value:function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)}},{key:"onDestroy",value:function(){this._sharedBody.reference=!1,this._btCompound=null,this._collider=null,y.castObject(this._btShape,y.btCollisionShape).wrapped=null,y.destroy(this.pos),y.destroy(this.quat),y.destroy(this.scale),y.destroy(this.transform),y.destroy(this._btShape),A(this._btShape,y.btCollisionShape),this._btShape=null,this.transform=null,this.pos=null,this.quat=null,this.scale=null}},{key:"getGroup",value:function(){return this._sharedBody.collisionFilterGroup}},{key:"setGroup",value:function(t){this._sharedBody.collisionFilterGroup=t}},{key:"addGroup",value:function(t){this._sharedBody.collisionFilterGroup|=t}},{key:"removeGroup",value:function(t){this._sharedBody.collisionFilterGroup&=~t}},{key:"getMask",value:function(){return this._sharedBody.collisionFilterMask}},{key:"setMask",value:function(t){this._sharedBody.collisionFilterMask=t}},{key:"addMask",value:function(t){this._sharedBody.collisionFilterMask|=t}},{key:"removeMask",value:function(t){this._sharedBody.collisionFilterMask&=~t}},{key:"setCompound",value:function(t){this._btCompound&&(this._btCompound.removeChildShape(this._btShape),this._index=-1),t&&(this._index=t.getNumChildShapes(),t.addChildShape(this.transform,this._btShape)),this._btCompound=t}},{key:"setWrapper",value:function(){y.castObject(this._btShape,y.btCollisionShape).wrapped=this}},{key:"setScale",value:function(){this.setCenter(this._collider.center)}},{key:"updateCompoundTransform",value:function(){this._btCompound?this._btCompound.updateChildTransform(this.index,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=O.BODY_RE_ADD)}},{key:"needCompound",value:function(){return this.type==w.TERRAIN_SHAPE_PROXYTYPE||!this._collider.center.equals(t.ZERO)}},{key:"debugTransform",value:function(e){var s;null==o._debugTransform&&(o._debugTransform=new y.btTransform),s=this._isTrigger?this._sharedBody.ghost.getWorldTransform():this._sharedBody.body.getWorldTransform();var n=this.transform;o._debugTransform.setIdentity(),o._debugTransform.op_mul(s).op_mul(n);var r=o._debugTransform.getOrigin();e.worldPosition=new t(r.x(),r.y(),r.z());var a=o._debugTransform.getRotation();e.worldRotation=new i(a.x(),a.y(),a.z(),a.w());var l=this.impl.getLocalScaling();e.scale=new t(l.x(),l.y(),l.z())}}]),o}();et.idCounter=0,et._debugTransform=void 0;var st=M,ot=function(i){function l(){var t;return s(this,l),(t=n(this,r(l).call(this,w.BOX_SHAPE_PROXYTYPE))).halfExt=void 0,t.halfExt=new y.btVector3(.5,.5,.5),t._btShape=new y.btBoxShape(t.halfExt),t}return o(l,i),e(l,[{key:"setSize",value:function(i){t.multiplyScalar(st,i,.5),E(this.halfExt,st),this.impl.setUnscaledHalfExtents(this.halfExt),this.updateCompoundTransform()}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(l,[{key:"onComponentSet",value:function(){this.setSize(this.collider.size),this.setScale()}},{key:"onDestroy",value:function(){y.destroy(this.halfExt),A(this.halfExt,y.btVector3),this.halfExt=null,a(r(l.prototype),"onDestroy",this).call(this)}},{key:"setScale",value:function(){a(r(l.prototype),"setScale",this).call(this),E(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()}}]),l}(et),nt=M,rt=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.SPHERE_SHAPE_PROXYTYPE)))._btShape=new y.btSphereShape(.5),t}return o(i,t),e(i,[{key:"setRadius",value:function(t){this.impl.setUnscaledRadius(t),this.updateCompoundTransform()}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(i,[{key:"onComponentSet",value:function(){this.setRadius(this.collider.radius),this.setScale()}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this);var t=this._collider.node.worldScale,e=Math.abs(t.x),s=Math.abs(t.y),o=Math.abs(t.z),n=Math.max(Math.max(e,s),o);nt.set(n,n,n),E(this.scale,nt),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()}}]),i}(et),at=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.CAPSULE_SHAPE_PROXYTYPE)))._btShape=new y.btCapsuleShape(.5,1),t}return o(i,t),e(i,[{key:"setCylinderHeight",value:function(t){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)}},{key:"setDirection",value:function(t){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)}},{key:"setRadius",value:function(t){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(i,[{key:"onLoad",value:function(){a(r(i.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this),this.setRadius(this.collider.radius)}},{key:"updateProperties",value:function(t,i,e,s){var o=s,n=e;if(1==n){var r=t*Math.abs(l(o.x,o.z)),a=i/2*Math.abs(o.y);this.impl.updateProp(r,a,n)}else if(0==n){var h=t*Math.abs(l(o.y,o.z)),d=i/2*Math.abs(o.x);this.impl.updateProp(h,d,n)}else{var c=t*Math.abs(l(o.x,o.y)),u=i/2*Math.abs(o.z);this.impl.updateProp(c,u,n)}this.updateCompoundTransform()}}]),i}(et),lt=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.TRIANGLE_MESH_SHAPE_PROXYTYPE))).refBtTriangleMesh=null,t}return o(i,t),e(i,[{key:"setMesh",value:function(t){if(this._isBinding)if(null!=this._btShape&&this._btShape!=N.instance.EMPTY_SHAPE)h(9620);else{var i=t;if(i&&i.renderingSubMeshes.length>0){var e=this._getBtTriangleMesh(i);this.collider.convex?this._btShape=new y.btConvexTriangleMeshShape(e,!0):this._btShape=new y.btBvhTriangleMeshShape(e,!0,!0),E(this.scale,this._collider.node.worldScale),this._btShape.setMargin(.01),this._btShape.setLocalScaling(this.scale),this.setWrapper(),this.setCompound(this._btCompound)}else this._btShape=N.instance.EMPTY_SHAPE}}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),e(i,[{key:"onComponentSet",value:function(){this.setMesh(this.collider.mesh)}},{key:"onDestroy",value:function(){this.refBtTriangleMesh&&y.destroy(this.refBtTriangleMesh),a(r(i.prototype),"onDestroy",this).call(this)}},{key:"setCompound",value:function(t){a(r(i.prototype),"setCompound",this).call(this,t),this.impl.setUserIndex(this._index)}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this),E(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()}},{key:"_getBtTriangleMesh",value:function(t){var i;if(y.CC_CACHE.btTriangleMesh.enable){if(null==y.CC_CACHE.btTriangleMesh[t._uuid]){var e=new y.btTriangleMesh;y.CC_CACHE.btTriangleMesh[t._uuid]=e,b(e,t)}i=y.CC_CACHE.btTriangleMesh[t._uuid]}else this.refBtTriangleMesh=i=new y.btTriangleMesh,b(i,t);return i}}]),i}(et),ht=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.CYLINDER_SHAPE_PROXYTYPE))).halfExtents=void 0,t.halfExtents=new y.btVector3(.5,1,.5),t._btShape=new y.btCylinderShape(t.halfExtents),t}return o(i,t),e(i,[{key:"setHeight",value:function(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}},{key:"setDirection",value:function(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}},{key:"setRadius",value:function(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(i,[{key:"onLoad",value:function(){a(r(i.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}},{key:"onDestroy",value:function(){y.destroy(this.halfExtents),A(this.halfExtents,y.btVector3),a(r(i.prototype),"onDestroy",this).call(this)}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this),this.setRadius(this.collider.radius)}},{key:"updateProperties",value:function(t,i,e,s){var o=s,n=e;if(1==n){var r=i*Math.abs(o.y),a=t*Math.abs(l(o.x,o.z)),h=r/2;this.impl.updateProp(a,h,n)}else if(0==n){var d=i*Math.abs(o.x),c=t*Math.abs(l(o.y,o.z)),u=d/2;this.impl.updateProp(c,u,n)}else{var p=i*Math.abs(o.z),_=t*Math.abs(l(o.x,o.y)),y=p/2;this.impl.updateProp(_,y,n)}this.updateCompoundTransform()}}]),i}(et),dt=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.CONE_SHAPE_PROXYTYPE)))._btShape=new y.btConeShape(.5,1),t}return o(i,t),e(i,[{key:"setHeight",value:function(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}},{key:"setDirection",value:function(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}},{key:"setRadius",value:function(t){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(i,[{key:"onLoad",value:function(){a(r(i.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this),this.setRadius(this.collider.radius)}},{key:"updateProperties",value:function(t,i,e,s){var o=s,n=e;if(1==n){var r=i*Math.abs(o.y),a=t*Math.abs(l(o.x,o.z));this.impl.setRadius(a),this.impl.setHeight(r)}else if(0==n){var h=i*Math.abs(o.x),d=t*Math.abs(l(o.y,o.z));this.impl.setRadius(d),this.impl.setHeight(h)}else{var c=i*Math.abs(o.z),u=t*Math.abs(l(o.x,o.y));this.impl.setRadius(u),this.impl.setHeight(c)}this.impl.setConeUpIndex(n),this.scale.setValue(1,1,1),this.impl.setLocalScaling(this.scale),this.updateCompoundTransform()}}]),i}(et),ct=function(i){function l(){var i;return s(this,l),(i=n(this,r(l).call(this,w.TERRAIN_SHAPE_PROXYTYPE)))._terrainID=void 0,i._buffPtr=void 0,i._tileSize=void 0,i._localOffset=void 0,i._terrainID="",i._buffPtr=0,i._tileSize=0,i._localOffset=new t,i}return o(l,i),e(l,[{key:"setTerrain",value:function(t){if(this._isBinding)if(null!=this._btShape&&this._btShape!=N.instance.EMPTY_SHAPE)d("[Physics] Ammo change the terrain asset after initialization is not support.");else{var i=t;if(i){this._terrainID=i._uuid,this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._buffPtr=y._malloc(4*e*s);for(var o=0,n=Number.MIN_VALUE,r=Number.MAX_VALUE,a=0;a<s;a++)for(var l=0;l<e;l++){var h=i.getHeight(l,a);y.HEAPF32[this._buffPtr+o>>2]=h,n=n<h?h:n,r=r>h?h:r,o+=4}n+=.1,r-=.1,this._localOffset.set((e-1)/2*this._tileSize,(n+r)/2,(s-1)/2*this._tileSize);this._btShape=new y.btHeightfieldTerrainShape(e,s,this._buffPtr,1,r,n,1,"PHY_FLOAT",!1),this.scale.setValue(this._tileSize,1,this._tileSize),this._btShape.setLocalScaling(this.scale)}else this._btShape=N.instance.EMPTY_SHAPE}}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),e(l,[{key:"onComponentSet",value:function(){this.setTerrain(this.collider.terrain)}},{key:"onDestroy",value:function(){this._buffPtr&&y._free(this._buffPtr),a(r(l.prototype),"onDestroy",this).call(this)}},{key:"setCompound",value:function(t){a(r(l.prototype),"setCompound",this).call(this,t),this.impl.setUserIndex(this._index)}},{key:"setCenter",value:function(i){t.copy(M,i),M.add(this._localOffset),M.multiply(this._collider.node.worldScale),E(this.transform.getOrigin(),M),this.updateCompoundTransform()}}]),l}(et),ut=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.TETRAHEDRAL_SHAPE_PROXYTYPE))).VERTICES=[],t._btShape=new y.btBU_Simplex1to4,t}return o(i,t),e(i,[{key:"setShapeType",value:function(t){this._isBinding}},{key:"setVertices",value:function(t){for(var i=this.VERTICES.length,e=0;e<i;e++)E(this.VERTICES[e],t[e]);E(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(i,[{key:"onComponentSet",value:function(){for(var t=this.collider.shapeType,i=this.collider.vertices,e=0;e<t;e++)this.VERTICES[e]=new y.btVector3,E(this.VERTICES[e],i[e]),this.impl.addVertex(this.VERTICES[e]);E(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale)}},{key:"onLoad",value:function(){a(r(i.prototype),"onLoad",this).call(this),this.collider.updateVertices()}},{key:"onDestroy",value:function(){for(var t=this.VERTICES.length,e=0;e<t;e++)y.destroy(this.VERTICES[e]);this.VERTICES=null,a(r(i.prototype),"onDestroy",this).call(this)}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this),E(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)}}]),i}(et),pt=function(t){function i(){var t;return s(this,i),(t=n(this,r(i).call(this,w.STATIC_PLANE_PROXYTYPE))).NORMAL=void 0,t.NORMAL=new y.btVector3(0,1,0),t._btShape=new y.btStaticPlaneShape(t.NORMAL,0),t}return o(i,t),e(i,[{key:"setNormal",value:function(t){E(this.impl.getPlaneNormal(),t),this.updateCompoundTransform()}},{key:"setConstant",value:function(t){this.impl.setPlaneConstant(t),this.updateCompoundTransform()}},{key:"setScale",value:function(){a(r(i.prototype),"setScale",this).call(this),E(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e(i,[{key:"onComponentSet",value:function(){E(this.impl.getPlaneNormal(),this.collider.normal),this.impl.setPlaneConstant(this.collider.constant),this.setScale()}},{key:"onDestroy",value:function(){a(r(i.prototype),"onDestroy",this).call(this),y.destroy(this.NORMAL),A(this.NORMAL,y.btVector3),this.NORMAL=null}}]),i}(et),_t=function(){function t(){s(this,t),this.dirty=0,this.index=-1,this._rigidBody=null,this._collided=!1}return e(t,[{key:"setConnectedBody",value:function(t){}},{key:"setEnableCollision",value:function(t){this._collided!=t&&(this._collided=t,this.updateByReAdd())}},{key:"updateByReAdd",value:function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}}},{key:"initialize",value:function(t){this._com=t,this._rigidBody=t.attachedBody,this._collided=t.enableCollision,this.onComponentSet()}},{key:"onComponentSet",value:function(){}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){this._rigidBody&&this._rigidBody.body.sharedBody.wrappedWorld.addConstraint(this)}},{key:"onDisable",value:function(){this._rigidBody&&this._rigidBody.body.sharedBody.wrappedWorld.removeConstraint(this)}},{key:"onDestroy",value:function(){y.destroy(this._impl),this._com=null,this._rigidBody=null,this._impl=null}},{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),yt=function(i){function a(){return s(this,a),n(this,r(a).apply(this,arguments))}return o(a,i),e(a,[{key:"setPivotA",value:function(i){this._pivotA&&(t.multiply(M,i,this._com.node.worldScale),E(this._pivotA,M),this.impl.setPivotA(this._pivotA))}},{key:"setPivotB",value:function(i){t.copy(M,i);var e=this._com.connectedBody;e?t.multiply(M,i,e.node.worldScale):(t.add(M,M,this._com.node.worldPosition),t.multiply(F,this.constraint.pivotA,this._com.node.worldScale),t.add(M,M,F)),E(this._pivotB,M),this.impl.setPivotB(this._pivotB)}},{key:"onComponentSet",value:function(){if(this._rigidBody){var t,i=this._rigidBody.body.impl,e=this.constraint.connectedBody;e&&(t=e.body.impl),this._pivotA=new y.btVector3,this._pivotB=new y.btVector3,this._impl=t?new y.btPoint2PointConstraint(i,t,this._pivotA,this._pivotB):new y.btPoint2PointConstraint(i,this._pivotA),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)}}},{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),a}(_t),St=function(a){function l(){return s(this,l),n(this,r(l).apply(this,arguments))}return o(l,a),e(l,[{key:"setPivotA",value:function(i){this._pivotA&&(t.multiply(M,i,this._com.node.worldScale),E(this._pivotA,M))}},{key:"setPivotB",value:function(i){if(this._pivotB){t.copy(M,i);var e=this._com.connectedBody;e&&t.multiply(M,i,e.node.worldScale),E(this._pivotB,M)}}},{key:"setAxisA",value:function(t){}},{key:"setAxisB",value:function(t){}},{key:"onComponentSet",value:function(){if(this._rigidBody){var e,s=this._rigidBody.body.impl,o=this.constraint.connectedBody;if(o&&(e=o.body.impl),this._pivotA=new y.btVector3,this._pivotB=new y.btVector3,this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this._axisA=new y.btVector3,this._axisB=new y.btVector3,E(this._axisA,this.constraint.axisA),E(this._axisB,this.constraint.axisB),e)this._impl=new y.btHingeConstraint(s,e,this._pivotA,this._pivotB,this._axisA,this._axisB);else{var n=new i;i.rotationTo(n,t.UNIT_Z,this.constraint.axisA);var r=new y.btQuaternion(n.x,n.y,n.z,n.w),a=new y.btTransform;a.setIdentity(),a.setOrigin(this._pivotA),a.setRotation(r),this._impl=new y.btHingeConstraint(s,a)}}}},{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),l}(_t);c(at.prototype,"shape.prototype",[{name:"setHeight",suggest:"You should use the interface provided by the component."}]),u(J.prototype,"IContactEquation.prototype",[{name:"contactA",newName:"getLocalPointOnA",customGetter:function(){var i=new t;return J.prototype.getLocalPointOnA.call(this,i),i}},{name:"contactB",newName:"getLocalPointOnB",customGetter:function(){var i=new t;return J.prototype.getLocalPointOnB.call(this,i),i}},{name:"normal",newName:"getLocalNormalOnB",customGetter:function(){var i=new t;return J.prototype.getLocalNormalOnB.call(this,i),i}}]),g("ammo.js",{PhysicsWorld:tt,RigidBody:X,BoxShape:ot,SphereShape:rt,CapsuleShape:at,TrimeshShape:lt,CylinderShape:ht,ConeShape:dt,TerrainShape:ct,SimplexShape:ut,PlaneShape:pt,PointToPointConstraint:yt,HingeConstraint:St}),null==window.atob&&(window.atob=function(t){var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="",s=0,o=0,n=0,r=0,a=0,l=0,h=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{s=i.indexOf(t.charAt(h++))<<2|(r=i.indexOf(t.charAt(h++)))>>4,o=(15&r)<<4|(a=i.indexOf(t.charAt(h++)))>>2,n=(3&a)<<6|(l=i.indexOf(t.charAt(h++))),e+=String.fromCharCode(s),64!==a&&(e+=String.fromCharCode(o)),64!==l&&(e+=String.fromCharCode(n))}while(h<t.length);return e}),window.Ammo=y,y.CC_CONFIG={ignoreSelfBody:!0,emitStaticCollision:!1},y.CC_CACHE={btTriangleMesh:{enable:!1}}}}}));
