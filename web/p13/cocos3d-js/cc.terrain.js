System.register(["./deprecated-fd5a8e75.js","./deprecated-9a4df5e2.js","./component-event-handler-ff37202d.js","./terrain-asset-cc69bca3.js"],(function(t){"use strict";var e,i,r,a,n,s,l,h,o,u,_,f,c,g,y,p,d,v,b,M,k,w,S,m,z,C,x,A,I,E,T,R,L,N,P,B,H,O,D,U,V,F,Y,W,G,X,j,K,q,Z,$,J,Q,tt,et;return{setters:[function(t){e=t.j,i=t.d,r=t.k,a=t.c,n=t._,s=t.t,l=t.b2,h=t.s,o=t.F,u=t.l,_=t.H,f=t.K,c=t.W,g=t.h,y=t.b6,p=t.bO,d=t.T,v=t.g,b=t.b,M=t.e,k=t.f,w=t.aO,S=t.i,m=t.D,z=t.at,C=t.V,x=t.C},function(t){A=t.b2,I=t.da,E=t.c$,T=t.h,R=t.i,L=t.G,N=t.f,P=t.b4,B=t.t,H=t.W,O=t.aY,D=t.dg,U=t.dR,V=t.d_,F=t.b3,Y=t.d3,W=t.d4},function(t){G=t.d},function(e){X=e.T,j=e.a,K=e.b,q=e.c,Z=e.d,$=e.e,J=e.f,Q=e.g,tt=e.h,et=e.i;var i={};i.TERRAIN_BLOCK_TILE_COMPLEXITY=e.b,i.TERRAIN_BLOCK_VERTEX_COMPLEXITY=e.a,i.TERRAIN_BLOCK_VERTEX_SIZE=e.c,i.TERRAIN_DATA_VERSION=e.p,i.TERRAIN_DATA_VERSION2=e.q,i.TERRAIN_DATA_VERSION3=e.r,i.TERRAIN_DATA_VERSION_DEFAULT=e.s,i.TERRAIN_EAST_INDEX=e.o,i.TERRAIN_HEIGHT_BASE=e.h,i.TERRAIN_HEIGHT_FACTORY=e.i,i.TERRAIN_HEIGHT_FMAX=e.f,i.TERRAIN_HEIGHT_FMIN=e.g,i.TERRAIN_MAX_BLEND_LAYERS=e.k,i.TERRAIN_MAX_LAYER_COUNT=e.d,i.TERRAIN_MAX_LEVELS=e.j,i.TERRAIN_NORTH_INDEX=e.l,i.TERRAIN_SOUTH_INDEX=e.m,i.TERRAIN_WEST_INDEX=e.n,i.TerrainAsset=e.T,i.TerrainLayerInfo=e.e,t(i)}],execute:function(){t("HeightField",function(){function t(e,r){i(this,t),this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=r,this.data=new Uint16Array(e*r);for(var a=0;a<e*r;++a)this.data[a]=0}return e(t,[{key:"set",value:function(t,e,i){this.data[e*this.w+t]=i}},{key:"get",value:function(t,e){return this.data[e*this.w+t]}},{key:"getClamp",value:function(t,e){return t=r(t,0,this.w-1),e=r(e,0,this.h-1),this.get(t,e)}},{key:"getAt",value:function(t,e){var i=t,a=e,n=Math.floor(i),s=Math.floor(a),l=n+1,h=s+1,o=i-n,u=a-s;n=r(n,0,this.w-1),s=r(s,0,this.h-1),l=r(l,0,this.w-1),h=r(h,0,this.h-1);var _=this.get(n,s),f=this.get(l,s),c=this.get(n,h),g=this.get(l,h),y=.5*(f+c);return o+u<=1?g=y+(y-_):_=y+(y-g),(_*(1-o)+f*o)*(1-u)+(c*(1-o)+g*o)*u}}]),t}());var it,rt,at,nt,st,lt,ht,ot,ut,_t,ft,ct,gt,yt,pt,dt,vt,bt,Mt,kt,wt,St,mt,zt,Ct,xt,At,It,Et,Tt,Rt,Lt,Nt,Pt,Bt,Ht,Ot,Dt,Ut=t("TerrainInfo",a("cc.TerrainInfo")((at=n((rt=function(){function t(){i(this,t),v(this,"tileSize",at,this),v(this,"blockCount",nt,this),v(this,"weightMapSize",st,this),v(this,"lightMapSize",lt,this)}return e(t,[{key:"size",get:function(){var t=new d(0,0);return t.width=this.blockCount[0]*K*this.tileSize,t.height=this.blockCount[1]*K*this.tileSize,t}},{key:"tileCount",get:function(){var t=[0,0];return t[0]=this.blockCount[0]*K,t[1]=this.blockCount[1]*K,t}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}}]),t}()).prototype,"tileSize",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nt=n(rt.prototype,"blockCount",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),st=n(rt.prototype,"weightMapSize",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),lt=n(rt.prototype,"lightMapSize",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),it=rt))||it),Vt=t("TerrainLayer",a("cc.TerrainLayer")((ut=n((ot=function t(){i(this,t),v(this,"detailMap",ut,this),v(this,"tileSize",_t,this)}).prototype,"detailMap",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_t=n(ot.prototype,"tileSize",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ht=ot))||ht),Ft=function(t){function r(){var t,e;i(this,r);for(var a=arguments.length,n=new Array(a),s=0;s<a;s++)n[s]=arguments[s];return(e=M(this,(t=k(r)).call.apply(t,[this].concat(n))))._model=null,e._meshData=null,e._brushMaterial=null,e._currentMaterial=null,e._currentMaterialLayers=0,e}return b(r,t),e(r,[{key:"destroy",value:function(){return null!=this._model&&(u.director.root.destroyModel(this._model),this._model=null),w(k(r.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(t,e){if(null!=this._meshData&&null!=this._model){var i=t.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new F,this._currentMaterial.initialize({effectAsset:t.getTerrain().getEffectAsset(),defines:t._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);e&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(t,e){null!=this._model&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(t,e){this._model&&this._model.setSubModelMaterial(t,e)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return Y.get("missing-material")}}]),r}(W),Yt=t("TerrainBlockInfo",a("cc.TerrainBlockInfo")((gt=n((ct=function t(){i(this,t),v(this,"layers",gt,this)}).prototype,"layers",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),ft=ct))||ft),Wt=t("TerrainBlockLightmapInfo",a("cc.TerrainBlockLightmapInfo")((dt=n((pt=function t(){i(this,t),v(this,"texture",dt,this),v(this,"UOff",vt,this),v(this,"VOff",bt,this),v(this,"UScale",Mt,this),v(this,"VScale",kt,this)}).prototype,"texture",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vt=n(pt.prototype,"UOff",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bt=n(pt.prototype,"VOff",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mt=n(pt.prototype,"UScale",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kt=n(pt.prototype,"VScale",[h,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yt=pt))||yt),Gt=t("TerrainBlock",function(){function t(e,r,a){i(this,t),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._terrain=e,this._info=e.getBlockInfo(r,a),this._index[0]=r,this._index[1]=a,this._lightmapInfo=e._getLightmapInfo(r,a),this._node=new E(""),this._node.setParent(this._terrain.node),this._node._objFlags|=u.Object.Flags.DontSave,this._renderable=this._node.addComponent(Ft)}return e(t,[{key:"build",value:function(){for(var t=G.root.device,e=new Float32Array(q*j*j),i=0,r=0;r<j;++r)for(var a=0;a<j;++a){var n=this._index[0]*K+a,s=this._index[1]*K+r,l=this._terrain.getPosition(n,s),h=this._terrain.getNormal(n,s),o=new _(a/K,r/K);e[i++]=l.x,e[i++]=l.y,e[i++]=l.z,e[i++]=h.x,e[i++]=h.y,e[i++]=h.z,e[i++]=o.x,e[i++]=o.y}var f=t.createBuffer({usage:T.VERTEX|T.TRANSFER_DST,memUsage:R.HOST|R.DEVICE,size:q*Float32Array.BYTES_PER_ELEMENT*j*j,stride:q*Float32Array.BYTES_PER_ELEMENT});f.update(e);var c=[{name:L.ATTR_POSITION,format:N.RGB32F},{name:L.ATTR_NORMAL,format:N.RGB32F},{name:L.ATTR_TEX_COORD,format:N.RG32F}];(this._renderable._meshData=new P([f],c,B.TRIANGLE_LIST)).indexBuffer=this._terrain._getSharedIndexBuffer()||void 0,this._renderable._model=u.director.root.createModel(H),this._renderable._model.initialize(this._node),this._renderable._getRenderScene().addModel(this._renderable._model),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var t=this._renderable._currentMaterial;if(null!=t){var e=this.getMaxLayer(),i=new f(1,1,1,1);if(0===e)if(-1!==this.layers[0]){var r=this._terrain.getLayer(this.layers[0]);null!=r&&(i.x=1/r.tileSize),t.setProperty("detailMap0",null!=r?r.detailMap:null)}else t.setProperty("detailMap0",u.builtinResMgr.get("default-texture"));else if(1===e){var a=this._terrain.getLayer(this.layers[0]),n=this._terrain.getLayer(this.layers[1]);null!=a&&(i.x=1/a.tileSize),null!=n&&(i.y=1/n.tileSize),t.setProperty("weightMap",this._weightMap),t.setProperty("detailMap0",null!=a?a.detailMap:null),t.setProperty("detailMap1",null!=n?n.detailMap:null)}else if(2===e){var s=this._terrain.getLayer(this.layers[0]),l=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]);null!=s&&(i.x=1/s.tileSize),null!=l&&(i.y=1/l.tileSize),null!=h&&(i.z=1/h.tileSize),t.setProperty("weightMap",this._weightMap),t.setProperty("detailMap0",null!=s?s.detailMap:null),t.setProperty("detailMap1",null!=l?l.detailMap:null),t.setProperty("detailMap2",null!=h?h.detailMap:null)}else if(3===e){var o=this._terrain.getLayer(this.layers[0]),_=this._terrain.getLayer(this.layers[1]),c=this._terrain.getLayer(this.layers[2]),g=this._terrain.getLayer(this.layers[3]);null!=o&&(i.x=1/o.tileSize),null!=_&&(i.y=1/_.tileSize),null!=c&&(i.z=1/c.tileSize),null!=g&&(i.z=1/g.tileSize),t.setProperty("weightMap",this._weightMap),t.setProperty("detailMap0",null!=o?o.detailMap:null),t.setProperty("detailMap1",null!=_?_.detailMap:null),t.setProperty("detailMap2",null!=c?c.detailMap:null),t.setProperty("detailMap3",null!=g?g.detailMap:null)}t.setProperty("UVScale",i),null!=this.lightmap&&(t.setProperty("lightMap",this.lightmap),t.setProperty("lightMapUVParam",this.lightmapUVParam))}}},{key:"setBrushMaterial",value:function(t){this._renderable._brushMaterial!==t&&(this._renderable._brushMaterial=t,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var t=new c;return t.x=this._index[0]*K,t.y=this._index[1]*K,t.width=K,t.height=K,t}},{key:"setLayer",value:function(t,e){this.layers[t]!==e&&(this.layers[t]=e,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(t){return this.layers[t]}},{key:"getMaxLayer",value:function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0}},{key:"_getMaterialDefines",value:function(t){if(null!=this.lightmap){if(0===t)return{LAYERS:1,LIGHT_MAP:1};if(1===t)return{LAYERS:2,LIGHT_MAP:1};if(2===t)return{LAYERS:3,LIGHT_MAP:1};if(3===t)return{LAYERS:4,LIGHT_MAP:1}}else{if(0===t)return{LAYERS:1};if(1===t)return{LAYERS:2};if(2===t)return{LAYERS:3};if(3===t)return{LAYERS:4}}return{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(t){this._renderable._updateMaterial(this,t)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var t=new Float32Array(q*j*j),e=0,i=0;i<j;++i)for(var r=0;r<j;++r){var a=this._index[0]*K+r,n=this._index[1]*K+i,s=this._terrain.getPosition(a,n),l=this._terrain.getNormal(a,n),h=new _(r/j,i/j);t[e++]=s.x,t[e++]=s.y,t[e++]=s.z,t[e++]=l.x,t[e++]=l.y,t[e++]=l.z,t[e++]=h.x,t[e++]=h.y}this._renderable._meshData.vertexBuffers[0].update(t)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new O,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,D.RGBA8888),this._weightMap.setFilters(U.LINEAR,U.LINEAR),this._weightMap.setWrapMode(V.CLAMP_TO_EDGE,V.CLAMP_TO_EDGE));for(var t=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),e=0,i=0;i<this._terrain.weightMapSize;++i)for(var r=0;r<this._terrain.weightMapSize;++r){var a=this._index[0]*this._terrain.weightMapSize+r,n=this._index[1]*this._terrain.weightMapSize+i,s=this._terrain.getWeight(a,n);t[4*e+0]=Math.floor(255*s.x),t[4*e+1]=Math.floor(255*s.y),t[4*e+2]=Math.floor(255*s.z),t[4*e+3]=Math.floor(255*s.w),e+=1}this._weightMap.uploadData(t)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"_updateLightmap",value:function(t){this._lightmapInfo=t,this._invalidMaterial()}},{key:"layers",get:function(){return this._info.layers}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new f(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new f(0,0,0,0)}}]),t}());t("Terrain",(wt=a("cc.Terrain"),St=g(),mt=s(X),zt=s(A),Ct=y(),xt=s(Vt),At=s(X),It=y(),Et=s(A),Tt=y(),Rt=s(Ut),wt(Lt=St(Lt=l(Lt=I((Pt=n((Nt=function(t){function a(){var t;i(this,a),t=M(this,k(a).call(this)),v(t,"__asset",Pt,S(t)),v(t,"_effectAsset",Bt,S(t)),v(t,"_layers",Ht,S(t)),v(t,"_blockInfos",Ot,S(t)),v(t,"_lightmapInfos",Dt,S(t)),t._tileSize=1,t._blockCount=[1,1],t._weightMapSize=128,t._lightMapSize=128,t._heights=new Uint16Array,t._weights=new Uint8Array,t._normals=[],t._blocks=[],t._sharedIndexBuffer=null;for(var e=0;e<Z;++e)t._layers.push(null);return t}return b(a,t),e(a,[{key:"build",value:function(t){return this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildImp()}},{key:"rebuild",value:function(t){for(var e=[],i=0;i<t.blockCount[0]*t.blockCount[1];++i)e.push(new Yt);for(var r=Math.min(this._blockCount[0],t.blockCount[0]),a=Math.min(this._blockCount[1],t.blockCount[1]),n=0;n<a;++n)for(var s=0;s<r;++s){var l=n*t.blockCount[0]+s,h=n*this.blockCount[0]+s;e[l]=this._blockInfos[h]}this._blockInfos=e;for(var o,u=m(this._blocks);!(o=u()).done;){o.value.destroy()}this._blocks=[],this._rebuildHeights(t),this._rebuildWeights(t),this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildNormals();for(var _=0;_<this._blockCount[1];++_)for(var f=0;f<this._blockCount[0];++f)this._blocks.push(new Gt(this,f,_));for(var c,g=m(this._blocks);!(c=g()).done;){c.value.build()}}},{key:"importHeightField",value:function(t,e){for(var i=0,r=0;r<this.vertexCount[1];++r)for(var a=0;a<this.vertexCount[0];++a){var n=a/this.tileCount[0],s=r/this.tileCount[1],l=t.getAt(n*t.w,s*t.h)*e;this._heights[i++]=l}this._buildNormals();for(var h,o=m(this._blocks);!(h=o()).done;){h.value._updateHeight()}}},{key:"exportHeightField",value:function(t,e){for(var i=0,r=0;r<t.h;++r)for(var a=0;a<t.w;++a){var n=a/(t.w-1),s=r/(t.h-1),l=n*this.size.width,h=s*this.size.height,o=this.getHeightAt(l,h);null!=o&&(t.data[i++]=o*e)}}},{key:"exportAsset",value:function(){var t=new X;t.tileSize=this.tileSize,t.blockCount=this.blockCount,t.lightMapSize=this.lightMapSize,t.weightMapSize=this.weightMapSize,t.heights=this.heights,t.weights=this.weights,t.layerBuffer=new Array(4*this._blocks.length);for(var e=0;e<this._blocks.length;++e)t.layerBuffer[4*e+0]=this._blocks[e].layers[0],t.layerBuffer[4*e+1]=this._blocks[e].layers[1],t.layerBuffer[4*e+2]=this._blocks[e].layers[2],t.layerBuffer[4*e+3]=this._blocks[e].layers[3];for(var i=0;i<this._layers.length;++i){var r=this._layers[i];if(r&&r.detailMap&&z(r.detailMap)){var a=new $;a.slot=i,a.tileSize=r.tileSize,a.detailMap=r.detailMap._uuid,t.layerInfos.push(a)}}return t}},{key:"getEffectAsset",value:function(){return null===this._effectAsset?u.EffectAsset.get("builtin-terrain"):this._effectAsset}},{key:"onLoad",value:function(){for(var t=u.director.root.device,e=new Uint16Array(K*K*6),i=0,r=0;r<K;++r)for(var a=0;a<K;++a){var n=r*j+a,s=r*j+a+1,l=(r+1)*j+a,h=(r+1)*j+a+1;e[i++]=n,e[i++]=l,e[i++]=s,e[i++]=s,e[i++]=l,e[i++]=h}this._sharedIndexBuffer=t.createBuffer({usage:T.INDEX|T.TRANSFER_DST,memUsage:R.HOST|R.DEVICE,size:Uint16Array.BYTES_PER_ELEMENT*K*K*6,stride:Uint16Array.BYTES_PER_ELEMENT}),this._sharedIndexBuffer.update(e)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){for(var t,e=m(this._blocks);!(t=e()).done;){t.value.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var t=0;t<this._layers.length;++t)this._layers[t]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp(!0)}},{key:"update",value:function(t){for(var e,i=m(this._blocks);!(e=i()).done;){e.value.update()}}},{key:"addLayer",value:function(t){for(var e=0;e<this._layers.length;++e)if(null==this._layers[e])return this._layers[e]=t,e;return-1}},{key:"setLayer",value:function(t,e){this._layers[t]=e}},{key:"removeLayer",value:function(t){this._layers[t]=null}},{key:"getLayer",value:function(t){return-1===t?null:this._layers[t]}},{key:"getPosition",value:function(t,e){var i=t*this._tileSize,r=e*this._tileSize,a=this.getHeight(t,e);return new C(i,a,r)}},{key:"getHeightField",value:function(){return this._heights}},{key:"setHeight",value:function(t,e,i){i=r(i,Q,J),this._heights[e*this.vertexCount[0]+t]=tt+i/et}},{key:"getHeight",value:function(t,e){return(this._heights[e*this.vertexCount[0]+t]-tt)*et}},{key:"getHeightClamp",value:function(t,e){return t=r(t,0,this.vertexCount[0]-1),e=r(e,0,this.vertexCount[1]-1),this.getHeight(t,e)}},{key:"getHeightAt",value:function(t,e){var i=t/this.tileSize,a=e/this.tileSize,n=Math.floor(i),s=Math.floor(a),l=n+1,h=s+1,o=i-n,u=a-s;if(n<0||n>this.vertexCount[0]-1||s<0||s>this.vertexCount[1]-1)return null;n=r(n,0,this.vertexCount[0]-1),s=r(s,0,this.vertexCount[1]-1),l=r(l,0,this.vertexCount[0]-1),h=r(h,0,this.vertexCount[1]-1);var _=this.getHeight(n,s),f=this.getHeight(l,s),c=this.getHeight(n,h),g=this.getHeight(l,h),y=.5*(f+c);return o+u<=1?g=y+(y-_):_=y+(y-g),(_*(1-o)+f*o)*(1-u)+(c*(1-o)+g*o)*u}},{key:"_setNormal",value:function(t,e,i){var r=e*this.vertexCount[0]+t;this._normals[3*r+0]=i.x,this._normals[3*r+1]=i.y,this._normals[3*r+2]=i.z}},{key:"getNormal",value:function(t,e){var i=e*this.vertexCount[0]+t,r=new C;return r.x=this._normals[3*i+0],r.y=this._normals[3*i+1],r.z=this._normals[3*i+2],r}},{key:"getNormalAt",value:function(t,e){var i=t/this.tileSize,a=e/this.tileSize,n=Math.floor(i),s=Math.floor(a),l=n+1,h=s+1,o=i-n,u=a-s;if(n<0||n>this.vertexCount[0]-1||s<0||s>this.vertexCount[1]-1)return null;n=r(n,0,this.vertexCount[0]-1),s=r(s,0,this.vertexCount[1]-1),l=r(l,0,this.vertexCount[0]-1),h=r(h,0,this.vertexCount[1]-1);var _=this.getNormal(n,s),f=this.getNormal(l,s),c=this.getNormal(n,h),g=this.getNormal(l,h),y=new C;C.add(y,f,c).multiplyScalar(.5),o+u<=1?(g.set(y),g.subtract(_),g.add(y)):(_.set(y),_.subtract(g),_.add(y));var p=new C,d=new C,v=new C;return C.lerp(p,_,f,o),C.lerp(d,c,g,o),C.lerp(v,p,d,u),v}},{key:"setWeight",value:function(t,e,i){var r=e*this._weightMapSize*this._blockCount[0]+t;this._weights[4*r+0]=255*i.x,this._weights[4*r+1]=255*i.y,this._weights[4*r+2]=255*i.z,this._weights[4*r+3]=255*i.w}},{key:"getWeight",value:function(t,e){var i=e*this._weightMapSize*this._blockCount[0]+t,r=new f;return r.x=this._weights[4*i+0]/255,r.y=this._weights[4*i+1]/255,r.z=this._weights[4*i+2]/255,r.w=this._weights[4*i+3]/255,r}},{key:"getWeightAt",value:function(t,e){var i=t/this.tileSize,a=e/this.tileSize,n=Math.floor(i),s=Math.floor(a),l=n+1,h=s+1,o=i-n,u=a-s;if(n<0||n>this.vertexCount[0]-1||s<0||s>this.vertexCount[1]-1)return null;n=r(n,0,this.vertexCount[0]-1),s=r(s,0,this.vertexCount[1]-1),l=r(l,0,this.vertexCount[0]-1),h=r(h,0,this.vertexCount[1]-1);var _=this.getWeight(n,s),c=this.getWeight(l,s),g=this.getWeight(n,h),y=this.getWeight(l,h),p=new f;f.add(p,c,g).multiplyScalar(.5),o+u<=1?(y=new f,f.subtract(y,p,_).add(p)):(_=new f,f.subtract(_,p,y).add(p));var d=new f,v=new f,b=new f;return f.lerp(d,_,c,o),f.lerp(v,g,y,o),f.lerp(b,d,v,u),b}},{key:"getBlockInfo",value:function(t,e){return this._blockInfos[e*this._blockCount[0]+t]}},{key:"getBlock",value:function(t,e){return this._blocks[e*this._blockCount[0]+t]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"rayCheck",value:function(t,e,i){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=2e3,n=t;r&&C.subtract(n,t,this.node.getWorldPosition());var s=new C;s.set(e),s.multiplyScalar(i);var l=null;if(e.equals(new C(0,1,0))){var h=this.getHeightAt(n.x,n.z);null!=h&&n.y<=h&&(l=new C(n.x,h,n.z))}else if(e.equals(new C(0,-1,0))){var o=this.getHeightAt(n.x,n.z);null!=o&&n.y>=o&&(l=new C(n.x,o,n.z))}else{for(var u=0;u++<a;){var _=this.getHeightAt(n.x,n.z);if(null!=_&&n.y<=_)break;n.add(e)}for(;u++<a;){var f=this.getHeightAt(n.x,n.z);if(null!=f&&n.y<=f){l=new C(n.x,f,n.z);break}n.add(s)}}return l}},{key:"_getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"_resetLightmap",value:function(t){if(this._lightmapInfos.length=0,t)for(var e=0;e<this._blockCount[0]*this._blockCount[1];++e)this._lightmapInfos.push(new Wt)}},{key:"_updateLightmap",value:function(t,e,i,r,a,n){this._lightmapInfos[t].texture=e,this._lightmapInfos[t].UOff=i,this._lightmapInfos[t].VOff=r,this._lightmapInfos[t].UScale=a,this._lightmapInfos[t].VScale=n,this._blocks[t]._updateLightmap(this._lightmapInfos[t])}},{key:"_getLightmapInfo",value:function(t,e){var i=e*this._blockCount[0]+t;return i<this._lightmapInfos.length?this._lightmapInfos[i]:null}},{key:"_calcNormal",value:function(t,e){var i,r,a=1,n=this.getPosition(t,e);t<this.vertexCount[0]-1?i=this.getPosition(t+1,e):(a*=-1,i=this.getPosition(t-1,e)),e<this.vertexCount[1]-1?r=this.getPosition(t,e+1):(a*=-1,r=this.getPosition(t,e-1)),i.subtract(n),r.subtract(n);var s=new C;return s.set(r),s.cross(i),s.multiplyScalar(a),s.normalize(),s}},{key:"_buildNormals",value:function(){for(var t=0,e=0;e<this.vertexCount[1];++e)for(var i=0;i<this.vertexCount[0];++i){var r=this._calcNormal(i,e);this._normals[3*t+0]=r.x,this._normals[3*t+1]=r.y,this._normals[3*t+2]=r.z,t+=1}}},{key:"_buildImp",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.valid)return!0;if(!e&&null!=this.__asset){this._tileSize=this.__asset.tileSize,this._blockCount=this.__asset.blockCount,this._weightMapSize=this.__asset.weightMapSize,this._lightMapSize=this.__asset.lightMapSize,this._heights=this.__asset.heights,this._weights=this.__asset.weights;for(var i=!0,r=0;r<this._layers.length;++r)null!=this._layers[r]&&(i=!1);if(i&&null!=this._asset)for(var a,n=function(){var e=a.value,i=new Vt;i.tileSize=e.tileSize,u.loader.loadRes(e.detailMap,O,(function(t,e){i.detailMap=e})),t._layers[e.slot]=i},s=m(this._asset.layerInfos);!(a=s()).done;)n()}if(0===this._blockCount[0]||0===this._blockCount[1])return!1;var l=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==l){this._heights=new Uint16Array(l),this._normals=new Array(3*l);for(var h=0;h<l;++h)this._heights[h]=tt,this._normals[3*h+0]=0,this._normals[3*h+1]=1,this._normals[3*h+2]=0}else this._normals=new Array(3*l),this._buildNormals();var o=this._weightMapSize*this._blockCount[0],_=this._weightMapSize*this._blockCount[1];if(this._weights.length!==o*_*4){this._weights=new Uint8Array(o*_*4);for(var f=0;f<o*_;++f)this._weights[4*f+0]=255,this._weights[4*f+1]=0,this._weights[4*f+2]=0,this._weights[4*f+3]=0}if(this._blockInfos.length!==this._blockCount[0]*this._blockCount[1]){this._blockInfos=[];for(var c=0;c<this._blockCount[1];++c)for(var g=0;g<this._blockCount[0];++g){var y=new Yt;null!=this._asset&&(y.layers[0]=this._asset.getLayer(g,c,0),y.layers[1]=this._asset.getLayer(g,c,1),y.layers[1]===y.layers[0]&&(y.layers[1]=-1),y.layers[2]=this._asset.getLayer(g,c,2),y.layers[2]===y.layers[0]&&(y.layers[2]=-1),y.layers[3]=this._asset.getLayer(g,c,3),y.layers[3]===y.layers[0]&&(y.layers[3]=-1)),this._blockInfos.push(y)}}for(var p=0;p<this._blockCount[1];++p)for(var d=0;d<this._blockCount[0];++d)this._blocks.push(new Gt(this,d,p));for(var v,b=m(this._blocks);!(v=b()).done;){var M=v.value;M.build()}}},{key:"_rebuildHeights",value:function(t){if(this.vertexCount[0]===t.vertexCount[0]&&this.vertexCount[1]===t.vertexCount[1])return!1;for(var e=new Uint16Array(t.vertexCount[0]*t.vertexCount[1]),i=0;i<e.length;++i)e[i]=tt;for(var r=Math.min(this.vertexCount[0],t.vertexCount[0]),a=Math.min(this.vertexCount[1],t.vertexCount[1]),n=0;n<a;++n)for(var s=0;s<r;++s){var l=n*t.vertexCount[0]+s,h=n*this.vertexCount[0]+s;e[l]=this._heights[h]}return this._heights=e,!0}},{key:"_rebuildWeights",value:function(t){var e=this,i=this._weightMapSize,r=this._weightMapSize*this._blockCount[0],a=this._weightMapSize*this._blockCount[1],n=t.weightMapSize*t.blockCount[0],s=t.weightMapSize*t.blockCount[1];if(n===r&&s===a)return!1;for(var l=new Uint8Array(n*s*4),h=0;h<n*s;++h)l[4*h+0]=255,l[4*h+1]=0,l[4*h+2]=0,l[4*h+3]=0;for(var o=Math.min(t.blockCount[0],this._blockCount[0]),u=Math.min(t.blockCount[1],this._blockCount[1]),_=function(t,e,i){var a=e*r+t,n=new f;return n.x=i[4*a+0]/255,n.y=i[4*a+1]/255,n.z=i[4*a+2]/255,n.w=i[4*a+3]/255,n},c=function(t,i,r,a,n){var s=Math.floor(t),l=Math.floor(i),h=s+1,o=l+1,u=t-s,c=i-l,g=_(s+r,l+a,e._weights),y=_(h+r,l+a,e._weights),p=_(s+r,o+a,e._weights),d=_(h+r,o+a,e._weights),v=new f;f.add(v,y,p).multiplyScalar(.5),u+c<=1?(d.set(v),d.subtract(g),d.add(v)):(g.set(v),g.subtract(d),g.add(v));var b=new f,M=new f,k=new f;return f.lerp(b,g,y,u),f.lerp(M,p,d,u),f.lerp(k,b,M,c),k},g=0;g<u;++g)for(var y=0;y<o;++y)for(var p=y*i,d=g*i,v=0;v<t.weightMapSize;++v)for(var b=0;b<t.weightMapSize;++b){var M=void 0;if(t.weightMapSize===i)M=_(b+p,v+d,this._weights);else M=c(b/(t.weightMapSize-1)*(i-1),v/(t.weightMapSize-1)*(i-1),p,d,this._weights);var k=y*t.weightMapSize+b,w=(g*t.weightMapSize+v)*n+k;l[4*w+0]=255*M.x,l[4*w+1]=255*M.y,l[4*w+2]=255*M.z,l[4*w+3]=255*M.w}return this._weights=l,!0}},{key:"_asset",set:function(t){if(this.__asset!==t&&(this.__asset=t,null!=this.__asset&&this.valid)){for(var e,i=m(this._blocks);!(e=i()).done;){e.value.destroy()}this._blocks=[],this._blockInfos=[],this._buildImp()}},get:function(){return this.__asset}},{key:"effectAsset",set:function(t){if(this._effectAsset!==t){this._effectAsset=t;for(var e,i=m(this._blocks);!(e=i()).done;){e.value._invalidMaterial()}}},get:function(){return this._effectAsset}},{key:"size",get:function(){var t=new d(0,0);return t.width=this.blockCount[0]*K*this.tileSize,t.height=this.blockCount[1]*K*this.tileSize,t}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[this.blockCount[0]*K,this.blockCount[1]*K]}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var t=new Ut;return t.tileSize=this.tileSize,t.blockCount[0]=this.blockCount[0],t.blockCount[1]=this.blockCount[1],t.weightMapSize=this.weightMapSize,t.lightMapSize=this.lightMapSize,t}}]),a}(x)).prototype,"__asset",[mt,h,p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bt=n(Nt.prototype,"_effectAsset",[zt,h,p,Ct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ht=n(Nt.prototype,"_layers",[xt,h,p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ot=n(Nt.prototype,"_blockInfos",[h,p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dt=n(Nt.prototype,"_lightmapInfos",[h,p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n(Nt.prototype,"_asset",[At,It],Object.getOwnPropertyDescriptor(Nt.prototype,"_asset"),Nt.prototype),n(Nt.prototype,"effectAsset",[Et,Tt],Object.getOwnPropertyDescriptor(Nt.prototype,"effectAsset"),Nt.prototype),n(Nt.prototype,"info",[Rt],Object.getOwnPropertyDescriptor(Nt.prototype,"info"),Nt.prototype),Lt=Nt))||Lt)||Lt)||Lt)||Lt))}}}));
