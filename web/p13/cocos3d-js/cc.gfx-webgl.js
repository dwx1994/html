System.register(["./deprecated-fd5a8e75.js","./deprecated-9a4df5e2.js","./fence-c02d550c.js","./SubContextView-ee466772.js","./webgl-define-e2dc6f1a.js"],(function(e){"use strict";var t,r,s,a,i,n,l,u,_,c,o,f,h,d,g,E,p,T,S,A,R,C,B,m,x,b,v,P,y,O,F,G,L,M,I,D,k,N,U,w,W,V,H,X,z,K,Y,j,q,Z,Q,J,$,ee,te,re,se,ae,ie,ne,le,ue,_e,ce,oe,fe,he,de;return{setters:[function(e){t=e.b,r=e.d,s=e.e,a=e.f,i=e.j,n=e.y,l=e.aZ,u=e.p,_=e.D,c=e.aI,o=e.bJ,f=e.x,h=e.w,d=e.l},function(e){g=e.bj,E=e.bk,p=e.bl,T=e.f,S=e.bM,A=e.c7,R=e.b_,C=e.bm,B=e.i,m=e.h,x=e.bJ,b=e.c8,v=e.bL,P=e.bQ,y=e.bG,O=e.bB,F=e.bU,G=e.bV,L=e.bw,M=e.C,I=e.bN,D=e.bx,k=e.bo,N=e.bP,U=e.bp,w=e.ch,W=e.ci,V=e.cj,H=e.ck,X=e.cq,z=e.cr,K=e.cu,Y=e.bH,j=e.cw,q=e.cC,Z=e.br,Q=e.cl,J=e.cm,$=e.co,ee=e.bq,te=e.cD,re=e.c9,se=e.cE,ae=e.cf,ie=e.b8,ne=e.cd,le=e.ce,ue=e.bW,_e=e.bK,ce=e.cb,oe=e.cg},function(e){fe=e.a,he=e.G},function(){},function(e){de=e.W}],execute:function(){var ge=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuDescriptorSet=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorCount,a=t.descriptorIndices;this._buffers=Array(s).fill(null),this._textures=Array(s).fill(null),this._samplers=Array(s).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:a};for(var n=0;n<r.length;++n)for(var l=r[n],u=0;u<l.count;u++)i.push({type:l.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&g){var r=this._buffers[t];r&&(e[t].gpuBuffer=r.gpuBuffer||r.gpuBufferView)}else e[t].type&E&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}},{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),n}(p);function Ee(e,t){switch(e){case T.R8:return t.UNSIGNED_BYTE;case T.R8SN:return t.BYTE;case T.R8UI:return t.UNSIGNED_BYTE;case T.R8I:return t.BYTE;case T.R16F:return de.HALF_FLOAT_OES;case T.R16UI:return t.UNSIGNED_SHORT;case T.R16I:return t.SHORT;case T.R32F:return t.FLOAT;case T.R32UI:return t.UNSIGNED_INT;case T.R32I:return t.INT;case T.RG8:return t.UNSIGNED_BYTE;case T.RG8SN:return t.BYTE;case T.RG8UI:return t.UNSIGNED_BYTE;case T.RG8I:return t.BYTE;case T.RG16F:return de.HALF_FLOAT_OES;case T.RG16UI:return t.UNSIGNED_SHORT;case T.RG16I:return t.SHORT;case T.RG32F:return t.FLOAT;case T.RG32UI:return t.UNSIGNED_INT;case T.RG32I:return t.INT;case T.RGB8:case T.SRGB8:return t.UNSIGNED_BYTE;case T.RGB8SN:return t.BYTE;case T.RGB8UI:return t.UNSIGNED_BYTE;case T.RGB8I:return t.BYTE;case T.RGB16F:return de.HALF_FLOAT_OES;case T.RGB16UI:return t.UNSIGNED_SHORT;case T.RGB16I:return t.SHORT;case T.RGB32F:return t.FLOAT;case T.RGB32UI:return t.UNSIGNED_INT;case T.RGB32I:return t.INT;case T.BGRA8:case T.RGBA8:case T.SRGB8_A8:return t.UNSIGNED_BYTE;case T.RGBA8SN:return t.BYTE;case T.RGBA8UI:return t.UNSIGNED_BYTE;case T.RGBA8I:return t.BYTE;case T.RGBA16F:return de.HALF_FLOAT_OES;case T.RGBA16UI:return t.UNSIGNED_SHORT;case T.RGBA16I:return t.SHORT;case T.RGBA32F:return t.FLOAT;case T.RGBA32UI:return t.UNSIGNED_INT;case T.RGBA32I:return t.INT;case T.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case T.R11G11B10F:return t.FLOAT;case T.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case T.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case T.RGB10A2:return t.UNSIGNED_BYTE;case T.RGB10A2UI:return t.UNSIGNED_INT;case T.RGB9E5:return t.UNSIGNED_BYTE;case T.D16:return t.UNSIGNED_SHORT;case T.D16S8:return de.UNSIGNED_INT_24_8_WEBGL;case T.D24:return t.UNSIGNED_INT;case T.D24S8:return de.UNSIGNED_INT_24_8_WEBGL;case T.D32F:return t.UNSIGNED_INT;case T.D32F_S8:return de.UNSIGNED_INT_24_8_WEBGL;case T.BC1:case T.BC1_SRGB:case T.BC2:case T.BC2_SRGB:case T.BC3:case T.BC3_SRGB:case T.BC4:return t.UNSIGNED_BYTE;case T.BC4_SNORM:return t.BYTE;case T.BC5:return t.UNSIGNED_BYTE;case T.BC5_SNORM:return t.BYTE;case T.BC6H_SF16:case T.BC6H_UF16:return t.FLOAT;case T.BC7:case T.BC7_SRGB:case T.ETC_RGB8:case T.ETC2_RGB8:case T.ETC2_SRGB8:case T.ETC2_RGB8_A1:case T.ETC2_SRGB8_A1:case T.ETC2_RGB8:case T.ETC2_SRGB8:case T.EAC_R11:return t.UNSIGNED_BYTE;case T.EAC_R11SN:return t.BYTE;case T.EAC_RG11:return t.UNSIGNED_BYTE;case T.EAC_RG11SN:return t.BYTE;case T.PVRTC_RGB2:case T.PVRTC_RGBA2:case T.PVRTC_RGB4:case T.PVRTC_RGBA4:case T.PVRTC2_2BPP:case T.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case T.ASTC_RGBA_4x4:case T.ASTC_RGBA_5x4:case T.ASTC_RGBA_5x5:case T.ASTC_RGBA_6x5:case T.ASTC_RGBA_6x6:case T.ASTC_RGBA_8x5:case T.ASTC_RGBA_8x6:case T.ASTC_RGBA_8x8:case T.ASTC_RGBA_10x5:case T.ASTC_RGBA_10x6:case T.ASTC_RGBA_10x8:case T.ASTC_RGBA_10x10:case T.ASTC_RGBA_12x10:case T.ASTC_RGBA_12x12:case T.ASTC_SRGBA_4x4:case T.ASTC_SRGBA_5x4:case T.ASTC_SRGBA_5x5:case T.ASTC_SRGBA_6x5:case T.ASTC_SRGBA_6x6:case T.ASTC_SRGBA_8x5:case T.ASTC_SRGBA_8x6:case T.ASTC_SRGBA_8x8:case T.ASTC_SRGBA_10x5:case T.ASTC_SRGBA_10x6:case T.ASTC_SRGBA_10x8:case T.ASTC_SRGBA_10x10:case T.ASTC_SRGBA_12x10:case T.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function pe(e,t){switch(e){case T.A8:return t.ALPHA;case T.L8:return t.LUMINANCE;case T.LA8:return t.LUMINANCE_ALPHA;case T.RGB8:case T.RGB16F:case T.RGB32F:return t.RGB;case T.BGRA8:case T.RGBA8:case T.RGBA16F:case T.RGBA32F:return t.RGBA;case T.R5G6B5:return t.RGB565;case T.RGB5A1:return t.RGB5_A1;case T.RGBA4:return t.RGBA4;case T.D16:return t.DEPTH_COMPONENT;case T.D16S8:return t.DEPTH_STENCIL;case T.D24:return t.DEPTH_COMPONENT;case T.D24S8:return t.DEPTH_STENCIL;case T.D32F:return t.DEPTH_COMPONENT;case T.D32F_S8:return t.DEPTH_STENCIL;case T.BC1:return de.COMPRESSED_RGB_S3TC_DXT1_EXT;case T.BC1_ALPHA:return de.COMPRESSED_RGBA_S3TC_DXT1_EXT;case T.BC1_SRGB:return de.COMPRESSED_SRGB_S3TC_DXT1_EXT;case T.BC1_SRGB_ALPHA:return de.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case T.BC2:return de.COMPRESSED_RGBA_S3TC_DXT3_EXT;case T.BC2_SRGB:return de.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case T.BC3:return de.COMPRESSED_RGBA_S3TC_DXT5_EXT;case T.BC3_SRGB:return de.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case T.ETC_RGB8:return de.COMPRESSED_RGB_ETC1_WEBGL;case T.ETC2_RGB8:return de.COMPRESSED_RGB8_ETC2;case T.ETC2_SRGB8:return de.COMPRESSED_SRGB8_ETC2;case T.ETC2_RGB8_A1:return de.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case T.ETC2_SRGB8_A1:return de.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case T.ETC2_RGBA8:return de.COMPRESSED_RGBA8_ETC2_EAC;case T.ETC2_SRGB8_A8:return de.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case T.EAC_R11:return de.COMPRESSED_R11_EAC;case T.EAC_R11SN:return de.COMPRESSED_SIGNED_R11_EAC;case T.EAC_RG11:return de.COMPRESSED_RG11_EAC;case T.EAC_RG11SN:return de.COMPRESSED_SIGNED_RG11_EAC;case T.PVRTC_RGB2:return de.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case T.PVRTC_RGBA2:return de.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case T.PVRTC_RGB4:return de.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case T.PVRTC_RGBA4:return de.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case T.ASTC_RGBA_4x4:return de.COMPRESSED_RGBA_ASTC_4x4_KHR;case T.ASTC_RGBA_5x4:return de.COMPRESSED_RGBA_ASTC_5x4_KHR;case T.ASTC_RGBA_5x5:return de.COMPRESSED_RGBA_ASTC_5x5_KHR;case T.ASTC_RGBA_6x5:return de.COMPRESSED_RGBA_ASTC_6x5_KHR;case T.ASTC_RGBA_6x6:return de.COMPRESSED_RGBA_ASTC_6x6_KHR;case T.ASTC_RGBA_8x5:return de.COMPRESSED_RGBA_ASTC_8x5_KHR;case T.ASTC_RGBA_8x6:return de.COMPRESSED_RGBA_ASTC_8x6_KHR;case T.ASTC_RGBA_8x8:return de.COMPRESSED_RGBA_ASTC_8x8_KHR;case T.ASTC_RGBA_10x5:return de.COMPRESSED_RGBA_ASTC_10x5_KHR;case T.ASTC_RGBA_10x6:return de.COMPRESSED_RGBA_ASTC_10x6_KHR;case T.ASTC_RGBA_10x8:return de.COMPRESSED_RGBA_ASTC_10x8_KHR;case T.ASTC_RGBA_10x10:return de.COMPRESSED_RGBA_ASTC_10x10_KHR;case T.ASTC_RGBA_12x10:return de.COMPRESSED_RGBA_ASTC_12x10_KHR;case T.ASTC_RGBA_12x12:return de.COMPRESSED_RGBA_ASTC_12x12_KHR;case T.ASTC_SRGBA_4x4:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case T.ASTC_SRGBA_5x4:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case T.ASTC_SRGBA_5x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case T.ASTC_SRGBA_6x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case T.ASTC_SRGBA_6x6:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case T.ASTC_SRGBA_8x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case T.ASTC_SRGBA_8x6:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case T.ASTC_SRGBA_8x8:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case T.ASTC_SRGBA_10x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case T.ASTC_SRGBA_10x6:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case T.ASTC_SRGBA_10x8:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case T.ASTC_SRGBA_10x10:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case T.ASTC_SRGBA_12x10:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case T.ASTC_SRGBA_12x12:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function Te(e,t){switch(e){case T.A8:return t.ALPHA;case T.L8:return t.LUMINANCE;case T.LA8:return t.LUMINANCE_ALPHA;case T.RGB8:case T.RGB16F:case T.RGB32F:return t.RGB;case T.BGRA8:case T.RGBA8:case T.RGBA16F:case T.RGBA32F:return t.RGBA;case T.R5G6B5:return t.RGB;case T.RGB5A1:case T.RGBA4:return t.RGBA;case T.D16:return t.DEPTH_COMPONENT;case T.D16S8:return t.DEPTH_STENCIL;case T.D24:return t.DEPTH_COMPONENT;case T.D24S8:return t.DEPTH_STENCIL;case T.D32F:return t.DEPTH_COMPONENT;case T.D32F_S8:return t.DEPTH_STENCIL;case T.BC1:return de.COMPRESSED_RGB_S3TC_DXT1_EXT;case T.BC1_ALPHA:return de.COMPRESSED_RGBA_S3TC_DXT1_EXT;case T.BC1_SRGB:return de.COMPRESSED_SRGB_S3TC_DXT1_EXT;case T.BC1_SRGB_ALPHA:return de.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case T.BC2:return de.COMPRESSED_RGBA_S3TC_DXT3_EXT;case T.BC2_SRGB:return de.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case T.BC3:return de.COMPRESSED_RGBA_S3TC_DXT5_EXT;case T.BC3_SRGB:return de.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case T.ETC_RGB8:return de.COMPRESSED_RGB_ETC1_WEBGL;case T.ETC2_RGB8:return de.COMPRESSED_RGB8_ETC2;case T.ETC2_SRGB8:return de.COMPRESSED_SRGB8_ETC2;case T.ETC2_RGB8_A1:return de.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case T.ETC2_SRGB8_A1:return de.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case T.ETC2_RGBA8:return de.COMPRESSED_RGBA8_ETC2_EAC;case T.ETC2_SRGB8_A8:return de.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case T.EAC_R11:return de.COMPRESSED_R11_EAC;case T.EAC_R11SN:return de.COMPRESSED_SIGNED_R11_EAC;case T.EAC_RG11:return de.COMPRESSED_RG11_EAC;case T.EAC_RG11SN:return de.COMPRESSED_SIGNED_RG11_EAC;case T.PVRTC_RGB2:return de.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case T.PVRTC_RGBA2:return de.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case T.PVRTC_RGB4:return de.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case T.PVRTC_RGBA4:return de.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case T.ASTC_RGBA_4x4:return de.COMPRESSED_RGBA_ASTC_4x4_KHR;case T.ASTC_RGBA_5x4:return de.COMPRESSED_RGBA_ASTC_5x4_KHR;case T.ASTC_RGBA_5x5:return de.COMPRESSED_RGBA_ASTC_5x5_KHR;case T.ASTC_RGBA_6x5:return de.COMPRESSED_RGBA_ASTC_6x5_KHR;case T.ASTC_RGBA_6x6:return de.COMPRESSED_RGBA_ASTC_6x6_KHR;case T.ASTC_RGBA_8x5:return de.COMPRESSED_RGBA_ASTC_8x5_KHR;case T.ASTC_RGBA_8x6:return de.COMPRESSED_RGBA_ASTC_8x6_KHR;case T.ASTC_RGBA_8x8:return de.COMPRESSED_RGBA_ASTC_8x8_KHR;case T.ASTC_RGBA_10x5:return de.COMPRESSED_RGBA_ASTC_10x5_KHR;case T.ASTC_RGBA_10x6:return de.COMPRESSED_RGBA_ASTC_10x6_KHR;case T.ASTC_RGBA_10x8:return de.COMPRESSED_RGBA_ASTC_10x8_KHR;case T.ASTC_RGBA_10x10:return de.COMPRESSED_RGBA_ASTC_10x10_KHR;case T.ASTC_RGBA_12x10:return de.COMPRESSED_RGBA_ASTC_12x10_KHR;case T.ASTC_RGBA_12x12:return de.COMPRESSED_RGBA_ASTC_12x12_KHR;case T.ASTC_SRGBA_4x4:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case T.ASTC_SRGBA_5x4:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case T.ASTC_SRGBA_5x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case T.ASTC_SRGBA_6x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case T.ASTC_SRGBA_6x6:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case T.ASTC_SRGBA_8x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case T.ASTC_SRGBA_8x6:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case T.ASTC_SRGBA_8x8:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case T.ASTC_SRGBA_10x5:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case T.ASTC_SRGBA_10x6:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case T.ASTC_SRGBA_10x8:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case T.ASTC_SRGBA_10x10:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case T.ASTC_SRGBA_12x10:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case T.ASTC_SRGBA_12x12:return de.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function Se(e,t){switch(e){case L.BOOL:return t.BOOL;case L.BOOL2:return t.BOOL_VEC2;case L.BOOL3:return t.BOOL_VEC3;case L.BOOL4:return t.BOOL_VEC4;case L.INT:return t.INT;case L.INT2:return t.INT_VEC2;case L.INT3:return t.INT_VEC3;case L.INT4:return t.INT_VEC4;case L.UINT:return t.UNSIGNED_INT;case L.FLOAT:return t.FLOAT;case L.FLOAT2:return t.FLOAT_VEC2;case L.FLOAT3:return t.FLOAT_VEC3;case L.FLOAT4:return t.FLOAT_VEC4;case L.MAT2:return t.FLOAT_MAT2;case L.MAT3:return t.FLOAT_MAT3;case L.MAT4:return t.FLOAT_MAT4;case L.SAMPLER2D:return t.SAMPLER_2D;case L.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),L.UNKNOWN}}function Ae(e,t){switch(e){case t.BOOL:return L.BOOL;case t.BOOL_VEC2:return L.BOOL2;case t.BOOL_VEC3:return L.BOOL3;case t.BOOL_VEC4:return L.BOOL4;case t.INT:return L.INT;case t.INT_VEC2:return L.INT2;case t.INT_VEC3:return L.INT3;case t.INT_VEC4:return L.INT4;case t.UNSIGNED_INT:return L.UINT;case t.FLOAT:return L.FLOAT;case t.FLOAT_VEC2:return L.FLOAT2;case t.FLOAT_VEC3:return L.FLOAT3;case t.FLOAT_VEC4:return L.FLOAT4;case t.FLOAT_MAT2:return L.MAT2;case t.FLOAT_MAT3:return L.MAT3;case t.FLOAT_MAT4:return L.MAT4;case t.SAMPLER_2D:return L.SAMPLER2D;case t.SAMPLER_CUBE:return L.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),L.UNKNOWN}}function Re(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Ce(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}var Be,me=[512,513,514,515,516,517,518,519],xe=[0,7680,7681,7682,7683,5386,34055,34056],be=[32774,32778,32779,32774,32774],ve=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(Be||(Be={}));var Pe=function e(t){r(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},ye=function(e){function n(){var e;return r(this,n),(e=s(this,a(n).call(this,Be.BEGIN_RENDER_PASS))).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=R.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return t(n,e),i(n,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),n}(Pe),Oe=function(e){function n(){var e;return r(this,n),(e=s(this,a(n).call(this,Be.BIND_STATES))).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=[],e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return t(n,e),i(n,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),n}(Pe),Fe=function(e){function n(){var e;return r(this,n),(e=s(this,a(n).call(this,Be.DRAW))).drawInfo=new C,e}return t(n,e),i(n,[{key:"clear",value:function(){}}]),n}(Pe),Ge=function(e){function n(){var e;return r(this,n),(e=s(this,a(n).call(this,Be.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return t(n,e),i(n,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),n}(Pe),Le=function(e){function n(){var e;return r(this,n),(e=s(this,a(n).call(this,Be.COPY_BUFFER_TO_TEXTURE))).gpuTexture=null,e.buffers=[],e.regions=[],e}return t(n,e),i(n,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),n}(Pe),Me=function(){function e(){r(this,e),this.cmds=new M(1),this.beginRenderPassCmds=new M(1),this.bindStatesCmds=new M(1),this.drawCmds=new M(1),this.updateBufferCmds=new M(1),this.copyBufferToTextureCmds=new M(1)}return i(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function Ie(e,t,r,s,a){if(t.usage&m.UNIFORM)ArrayBuffer.isView(r)?t.vf32.set(r,s/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(r),s/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&m.INDIRECT)t.indirects.length=s,Array.prototype.push.apply(t.indirects,r.drawInfos);else{var i=r,n=e.gl,l=e.stateCache;switch(t.glTarget){case n.ARRAY_BUFFER:e.useVAO&&l.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case n.ELEMENT_ARRAY_BUFFER:e.useVAO&&l.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}a===i.byteLength?n.bufferSubData(t.glTarget,s,i):n.bufferSubData(t.glTarget,s,i.slice(0,a))}}var De={gpuPipelineState:null,gpuInputAssembler:null,gpuShader:null,glPrimitive:0,reverseCW:!1};function ke(e,t,r,s,a,i,n){De.gpuInputAssembler=null,De.gpuShader=null;var l=e.gl,u=e.stateCache,_=0;if(r&&t){if(u.glFramebuffer!==r.glFramebuffer){l.bindFramebuffer(l.FRAMEBUFFER,r.glFramebuffer),u.glFramebuffer=r.glFramebuffer;var c=!!r.glFramebuffer;if(c!==De.reverseCW){De.reverseCW=c;var o=!e.stateCache.rs.isFrontFaceCCW;l.frontFace(o?l.CCW:l.CW),e.stateCache.rs.isFrontFaceCCW=o}}u.viewport.left===s.x&&u.viewport.top===s.y&&u.viewport.width===s.width&&u.viewport.height===s.height||(l.viewport(s.x,s.y,s.width,s.height),u.viewport.left=s.x,u.viewport.top=s.y,u.viewport.width=s.width,u.viewport.height=s.height),u.scissorRect.x===s.x&&u.scissorRect.y===s.y&&u.scissorRect.width===s.width&&u.scissorRect.height===s.height||(l.scissor(s.x,s.y,s.width,s.height),u.scissorRect.x=s.x,u.scissorRect.y=s.y,u.scissorRect.width=s.width,u.scissorRect.height=s.height);var f=a.length;e.WEBGL_draw_buffers||(f=1);for(var h=0;h<f;++h){var d=t.colorAttachments[h];if(d.format!==T.UNKNOWN)switch(d.loadOp){case P.LOAD:break;case P.CLEAR:u.bs.targets[0].blendColorMask!==y.ALL&&l.colorMask(!0,!0,!0,!0);var g=a[0];l.clearColor(g.r,g.g,g.b,g.a),_|=l.COLOR_BUFFER_BIT;break;case P.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==T.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case P.LOAD:break;case P.CLEAR:u.dss.depthWrite||l.depthMask(!0),l.clearDepth(i),_|=l.DEPTH_BUFFER_BIT;break;case P.DISCARD:}if(A[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case P.LOAD:break;case P.CLEAR:u.dss.stencilWriteMaskFront||l.stencilMaskSeparate(l.FRONT,65535),u.dss.stencilWriteMaskBack||l.stencilMaskSeparate(l.BACK,65535),l.clearStencil(n),_|=l.STENCIL_BUFFER_BIT;break;case P.DISCARD:}}if(_&&l.clear(_),_&l.COLOR_BUFFER_BIT){var E=u.bs.targets[0].blendColorMask;if(E!==y.ALL){var p=(E&y.R)!==y.NONE,S=(E&y.G)!==y.NONE,R=(E&y.B)!==y.NONE,C=(E&y.A)!==y.NONE;l.colorMask(p,S,R,C)}}_&l.DEPTH_BUFFER_BIT&&!u.dss.depthWrite&&l.depthMask(!1),_&l.STENCIL_BUFFER_BIT&&(u.dss.stencilWriteMaskFront||l.stencilMaskSeparate(l.FRONT,0),u.dss.stencilWriteMaskBack||l.stencilMaskSeparate(l.BACK,0))}}function Ne(e,t,r,s,a,i,n,l,_,c,o,f,h){var d,g,E,p=e.gl,T=e.stateCache,S=De.gpuShader=t&&t.gpuShader,A=!1;if(t&&De.gpuPipelineState!==t){if(De.gpuPipelineState=t,De.glPrimitive=t.glPrimitive,t.gpuShader){var R=t.gpuShader.glProgram;T.glProgram!==R&&(p.useProgram(R),T.glProgram=R,A=!0)}var C=t.rs;if(C){if(T.rs.cullMode!==C.cullMode){switch(C.cullMode){case O.NONE:p.disable(p.CULL_FACE);break;case O.FRONT:p.enable(p.CULL_FACE),p.cullFace(p.FRONT);break;case O.BACK:p.enable(p.CULL_FACE),p.cullFace(p.BACK)}T.rs.cullMode=C.cullMode}var B=De.reverseCW?!C.isFrontFaceCCW:C.isFrontFaceCCW;T.rs.isFrontFaceCCW!==B&&(p.frontFace(B?p.CCW:p.CW),T.rs.isFrontFaceCCW=B),T.rs.depthBias===C.depthBias&&T.rs.depthBiasSlop===C.depthBiasSlop||(p.polygonOffset(C.depthBias,C.depthBiasSlop),T.rs.depthBias=C.depthBias,T.rs.depthBiasSlop=C.depthBiasSlop),T.rs.lineWidth!==C.lineWidth&&(p.lineWidth(C.lineWidth),T.rs.lineWidth=C.lineWidth)}var m=t.dss;m&&(T.dss.depthTest!==m.depthTest&&(m.depthTest?p.enable(p.DEPTH_TEST):p.disable(p.DEPTH_TEST),T.dss.depthTest=m.depthTest),T.dss.depthWrite!==m.depthWrite&&(p.depthMask(m.depthWrite),T.dss.depthWrite=m.depthWrite),T.dss.depthFunc!==m.depthFunc&&(p.depthFunc(me[m.depthFunc]),T.dss.depthFunc=m.depthFunc),T.dss.stencilTestFront===m.stencilTestFront&&T.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?p.enable(p.STENCIL_TEST):p.disable(p.STENCIL_TEST),T.dss.stencilTestFront=m.stencilTestFront,T.dss.stencilTestBack=m.stencilTestBack),T.dss.stencilFuncFront===m.stencilFuncFront&&T.dss.stencilRefFront===m.stencilRefFront&&T.dss.stencilReadMaskFront===m.stencilReadMaskFront||(p.stencilFuncSeparate(p.FRONT,me[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),T.dss.stencilFuncFront=m.stencilFuncFront,T.dss.stencilRefFront=m.stencilRefFront,T.dss.stencilReadMaskFront=m.stencilReadMaskFront),T.dss.stencilFailOpFront===m.stencilFailOpFront&&T.dss.stencilZFailOpFront===m.stencilZFailOpFront&&T.dss.stencilPassOpFront===m.stencilPassOpFront||(p.stencilOpSeparate(p.FRONT,xe[m.stencilFailOpFront],xe[m.stencilZFailOpFront],xe[m.stencilPassOpFront]),T.dss.stencilFailOpFront=m.stencilFailOpFront,T.dss.stencilZFailOpFront=m.stencilZFailOpFront,T.dss.stencilPassOpFront=m.stencilPassOpFront),T.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(p.stencilMaskSeparate(p.FRONT,m.stencilWriteMaskFront),T.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),T.dss.stencilFuncBack===m.stencilFuncBack&&T.dss.stencilRefBack===m.stencilRefBack&&T.dss.stencilReadMaskBack===m.stencilReadMaskBack||(p.stencilFuncSeparate(p.BACK,me[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),T.dss.stencilFuncBack=m.stencilFuncBack,T.dss.stencilRefBack=m.stencilRefBack,T.dss.stencilReadMaskBack=m.stencilReadMaskBack),T.dss.stencilFailOpBack===m.stencilFailOpBack&&T.dss.stencilZFailOpBack===m.stencilZFailOpBack&&T.dss.stencilPassOpBack===m.stencilPassOpBack||(p.stencilOpSeparate(p.BACK,xe[m.stencilFailOpBack],xe[m.stencilZFailOpBack],xe[m.stencilPassOpBack]),T.dss.stencilFailOpBack=m.stencilFailOpBack,T.dss.stencilZFailOpBack=m.stencilZFailOpBack,T.dss.stencilPassOpBack=m.stencilPassOpBack),T.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(p.stencilMaskSeparate(p.BACK,m.stencilWriteMaskBack),T.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var x=t.bs;if(x){T.bs.isA2C!==x.isA2C&&(x.isA2C?p.enable(p.SAMPLE_ALPHA_TO_COVERAGE):p.disable(p.SAMPLE_ALPHA_TO_COVERAGE),T.bs.isA2C=x.isA2C),T.bs.blendColor.r===x.blendColor.r&&T.bs.blendColor.g===x.blendColor.g&&T.bs.blendColor.b===x.blendColor.b&&T.bs.blendColor.a===x.blendColor.a||(p.blendColor(x.blendColor.r,x.blendColor.g,x.blendColor.b,x.blendColor.a),T.bs.blendColor.r=x.blendColor.r,T.bs.blendColor.g=x.blendColor.g,T.bs.blendColor.b=x.blendColor.b,T.bs.blendColor.a=x.blendColor.a);var b=x.targets[0],v=T.bs.targets[0];v.blend!==b.blend&&(b.blend?p.enable(p.BLEND):p.disable(p.BLEND),v.blend=b.blend),v.blendEq===b.blendEq&&v.blendAlphaEq===b.blendAlphaEq||(p.blendEquationSeparate(be[b.blendEq],be[b.blendAlphaEq]),v.blendEq=b.blendEq,v.blendAlphaEq=b.blendAlphaEq),v.blendSrc===b.blendSrc&&v.blendDst===b.blendDst&&v.blendSrcAlpha===b.blendSrcAlpha&&v.blendDstAlpha===b.blendDstAlpha||(p.blendFuncSeparate(ve[b.blendSrc],ve[b.blendDst],ve[b.blendSrcAlpha],ve[b.blendDstAlpha]),v.blendSrc=b.blendSrc,v.blendDst=b.blendDst,v.blendSrcAlpha=b.blendSrcAlpha,v.blendDstAlpha=b.blendDstAlpha),v.blendColorMask!==b.blendColorMask&&(p.colorMask((b.blendColorMask&y.R)!==y.NONE,(b.blendColorMask&y.G)!==y.NONE,(b.blendColorMask&y.B)!==y.NONE,(b.blendColorMask&y.A)!==y.NONE),v.blendColorMask=b.blendColorMask)}}if(t&&t.gpuPipelineLayout&&S){for(var P=S.glBlocks.length,L=t.gpuPipelineLayout.dynamicOffsetIndices,M=0;M<P;M++){var I=S.glBlocks[M],D=s[I.set],k=D&&D.gpuDescriptors[I.binding],N=null,U=0;if(k&&k.gpuBuffer){var w=k.gpuBuffer,W=L[I.set],V=W&&W[I.binding];V>=0&&(U=a[V]),"vf32"in w?N=w.vf32:(U+=w.offset,N=w.gpuBuffer.vf32),U>>=2}if(N)for(var H=I.glActiveUniforms.length,X=0;X<H;X++){var z=I.glActiveUniforms[X];switch(z.glType){case p.BOOL:case p.INT:for(var K=0;K<z.array.length;++K){var Y=z.begin+U+K;if(N[Y]!==z.array[K]){for(var j=K,q=Y;j<z.array.length;++j,++q)z.array[j]=N[q];p.uniform1iv(z.glLoc,z.array);break}}break;case p.BOOL_VEC2:case p.INT_VEC2:for(var Z=0;Z<z.array.length;++Z){var Q=z.begin+U+Z;if(N[Q]!==z.array[Z]){for(var J=Z,$=Q;J<z.array.length;++J,++$)z.array[J]=N[$];p.uniform2iv(z.glLoc,z.array);break}}break;case p.BOOL_VEC3:case p.INT_VEC3:for(var ee=0;ee<z.array.length;++ee){var te=z.begin+U+ee;if(N[te]!==z.array[ee]){for(var re=ee,se=te;re<z.array.length;++re,++se)z.array[re]=N[se];p.uniform3iv(z.glLoc,z.array);break}}break;case p.BOOL_VEC4:case p.INT_VEC4:for(var ae=0;ae<z.array.length;++ae){var ie=z.begin+U+ae;if(N[ie]!==z.array[ae]){for(var ne=ae,le=ie;ne<z.array.length;++ne,++le)z.array[ne]=N[le];p.uniform4iv(z.glLoc,z.array);break}}break;case p.FLOAT:for(var ue=0;ue<z.array.length;++ue){var _e=z.begin+U+ue;if(N[_e]!==z.array[ue]){for(var ce=ue,oe=_e;ce<z.array.length;++ce,++oe)z.array[ce]=N[oe];p.uniform1fv(z.glLoc,z.array);break}}break;case p.FLOAT_VEC2:for(var fe=0;fe<z.array.length;++fe){var he=z.begin+U+fe;if(N[he]!==z.array[fe]){for(var de=fe,ge=he;de<z.array.length;++de,++ge)z.array[de]=N[ge];p.uniform2fv(z.glLoc,z.array);break}}break;case p.FLOAT_VEC3:for(var Ee=0;Ee<z.array.length;++Ee){var pe=z.begin+U+Ee;if(N[pe]!==z.array[Ee]){for(var Te=Ee,Se=pe;Te<z.array.length;++Te,++Se)z.array[Te]=N[Se];p.uniform3fv(z.glLoc,z.array);break}}break;case p.FLOAT_VEC4:for(var Ae=0;Ae<z.array.length;++Ae){var Re=z.begin+U+Ae;if(N[Re]!==z.array[Ae]){for(var Ce=Ae,Be=Re;Ce<z.array.length;++Ce,++Be)z.array[Ce]=N[Be];p.uniform4fv(z.glLoc,z.array);break}}break;case p.FLOAT_MAT2:for(var Pe=0;Pe<z.array.length;++Pe){var ye=z.begin+U+Pe;if(N[ye]!==z.array[Pe]){for(var Oe=Pe,Fe=ye;Oe<z.array.length;++Oe,++Fe)z.array[Oe]=N[Fe];p.uniformMatrix2fv(z.glLoc,!1,z.array);break}}break;case p.FLOAT_MAT3:for(var Ge=0;Ge<z.array.length;++Ge){var Le=z.begin+U+Ge;if(N[Le]!==z.array[Ge]){for(var Me=Ge,Ie=Le;Me<z.array.length;++Me,++Ie)z.array[Me]=N[Ie];p.uniformMatrix3fv(z.glLoc,!1,z.array);break}}break;case p.FLOAT_MAT4:for(var ke=0;ke<z.array.length;++ke){var Ne=z.begin+U+ke;if(N[Ne]!==z.array[ke]){for(var Ue=ke,we=Ne;Ue<z.array.length;++Ue,++we)z.array[Ue]=N[we];p.uniformMatrix4fv(z.glLoc,!1,z.array);break}}}}else u("Buffer binding '".concat(I.name,"' at set ").concat(I.set," binding ").concat(I.binding," is not bounded"))}for(var We=S.glSamplers.length,Ve=0;Ve<We;Ve++)for(var He,Xe=S.glSamplers[Ve],ze=s[Xe.set],Ke=null!==(He=null==ze?void 0:ze.descriptorIndices[Xe.binding])&&void 0!==He?He:-1,Ye=ze&&ze.gpuDescriptors[Ke],je=Xe.units.length,qe=0;qe<je;qe++){var Ze=Xe.units[qe];if(Ye&&Ye.gpuSampler){if(Ye.gpuTexture&&Ye.gpuTexture.size>0){var Qe=Ye.gpuTexture,Je=T.glTexUnits[Ze];Je.glTexture!==Qe.glTexture&&(T.texUnit!==Ze&&(p.activeTexture(p.TEXTURE0+Ze),T.texUnit=Ze),Qe.glTexture?p.bindTexture(Qe.glTarget,Qe.glTexture):p.bindTexture(Qe.glTarget,e.nullTex2D.gpuTexture.glTexture),Je.glTexture=Qe.glTexture);var $e=Ye.gpuSampler;Qe.isPowerOf2?(d=$e.glWrapS,g=$e.glWrapT):(d=p.CLAMP_TO_EDGE,g=p.CLAMP_TO_EDGE),E=Qe.isPowerOf2?Qe.mipLevel<=1&&($e.glMinFilter===p.LINEAR_MIPMAP_NEAREST||$e.glMinFilter===p.LINEAR_MIPMAP_LINEAR)?p.LINEAR:$e.glMinFilter:$e.glMinFilter===p.LINEAR||$e.glMinFilter===p.LINEAR_MIPMAP_NEAREST||$e.glMinFilter===p.LINEAR_MIPMAP_LINEAR?p.LINEAR:p.NEAREST,Qe.glWrapS!==d&&(T.texUnit!==Ze&&(p.activeTexture(p.TEXTURE0+Ze),T.texUnit=Ze),p.texParameteri(Qe.glTarget,p.TEXTURE_WRAP_S,d),Qe.glWrapS=d),Qe.glWrapT!==g&&(T.texUnit!==Ze&&(p.activeTexture(p.TEXTURE0+Ze),T.texUnit=Ze),p.texParameteri(Qe.glTarget,p.TEXTURE_WRAP_T,g),Qe.glWrapT=g),Qe.glMinFilter!==E&&(T.texUnit!==Ze&&(p.activeTexture(p.TEXTURE0+Ze),T.texUnit=Ze),p.texParameteri(Qe.glTarget,p.TEXTURE_MIN_FILTER,E),Qe.glMinFilter=E),Qe.glMagFilter!==$e.glMagFilter&&(T.texUnit!==Ze&&(p.activeTexture(p.TEXTURE0+Ze),T.texUnit=Ze),p.texParameteri(Qe.glTarget,p.TEXTURE_MAG_FILTER,$e.glMagFilter),Qe.glMagFilter=$e.glMagFilter)}Ye=ze.gpuDescriptors[++Ke]}else u("Sampler binding '".concat(Xe.name,"' at set ").concat(Xe.set," binding ").concat(Xe.binding," index ").concat(qe," is not bounded"))}}if(r&&S&&(A||De.gpuInputAssembler!==r)){De.gpuInputAssembler=r;var et=e.ANGLE_instanced_arrays;if(e.useVAO){var tt=e.OES_vertex_array_object,rt=r.glVAOs.get(S.glProgram);if(!rt){var st;rt=tt.createVertexArrayOES(),r.glVAOs.set(S.glProgram,rt),tt.bindVertexArrayOES(rt),p.bindBuffer(p.ARRAY_BUFFER,null),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,null),T.glArrayBuffer=null,T.glElementArrayBuffer=null;for(var at=S.glInputs.length,it=0;it<at;it++){var nt=S.glInputs[it];st=null;for(var lt=r.glAttribs.length,ut=0;ut<lt;ut++){var _t=r.glAttribs[ut];if(_t.name===nt.name){st=_t;break}}if(st){T.glArrayBuffer!==st.glBuffer&&(p.bindBuffer(p.ARRAY_BUFFER,st.glBuffer),T.glArrayBuffer=st.glBuffer);for(var ct=0;ct<st.componentCount;++ct){var ot=nt.glLoc+ct,ft=st.offset+st.size*ct;p.enableVertexAttribArray(ot),T.glCurrentAttribLocs[ot]=!0,p.vertexAttribPointer(ot,st.count,st.glType,st.isNormalized,st.stride,ft),et&&et.vertexAttribDivisorANGLE(ot,st.isInstanced?1:0)}}}var ht=r.gpuIndexBuffer;ht&&p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,ht.glBuffer),tt.bindVertexArrayOES(null),p.bindBuffer(p.ARRAY_BUFFER,null),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,null),T.glArrayBuffer=null,T.glElementArrayBuffer=null}T.glVAO!==rt&&(tt.bindVertexArrayOES(rt),T.glVAO=rt)}else{for(var dt=0;dt<e.maxVertexAttributes;++dt)T.glCurrentAttribLocs[dt]=!1;for(var gt=S.glInputs.length,Et=0;Et<gt;Et++){for(var pt=S.glInputs[Et],Tt=null,St=r.glAttribs.length,At=0;At<St;At++){var Rt=r.glAttribs[At];if(Rt.name===pt.name){Tt=Rt;break}}if(Tt){T.glArrayBuffer!==Tt.glBuffer&&(p.bindBuffer(p.ARRAY_BUFFER,Tt.glBuffer),T.glArrayBuffer=Tt.glBuffer);for(var Ct=0;Ct<Tt.componentCount;++Ct){var Bt=pt.glLoc+Ct,mt=Tt.offset+Tt.size*Ct;!T.glEnabledAttribLocs[Bt]&&Bt>=0&&(p.enableVertexAttribArray(Bt),T.glEnabledAttribLocs[Bt]=!0),T.glCurrentAttribLocs[Bt]=!0,p.vertexAttribPointer(Bt,Tt.count,Tt.glType,Tt.isNormalized,Tt.stride,mt),et&&et.vertexAttribDivisorANGLE(Bt,Tt.isInstanced?1:0)}}}var xt=r.gpuIndexBuffer;xt&&T.glElementArrayBuffer!==xt.glBuffer&&(p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,xt.glBuffer),T.glElementArrayBuffer=xt.glBuffer);for(var bt=0;bt<e.maxVertexAttributes;++bt)T.glEnabledAttribLocs[bt]!==T.glCurrentAttribLocs[bt]&&(p.disableVertexAttribArray(bt),T.glEnabledAttribLocs[bt]=!1)}}if(t)for(var vt=t.dynamicStates.length,Pt=0;Pt<vt;Pt++){switch(t.dynamicStates[Pt]){case F.VIEWPORT:i&&(T.viewport.left===i.left&&T.viewport.top===i.top&&T.viewport.width===i.width&&T.viewport.height===i.height||(p.viewport(i.left,i.top,i.width,i.height),T.viewport.left=i.left,T.viewport.top=i.top,T.viewport.width=i.width,T.viewport.height=i.height));break;case F.SCISSOR:n&&(T.scissorRect.x===n.x&&T.scissorRect.y===n.y&&T.scissorRect.width===n.width&&T.scissorRect.height===n.height||(p.scissor(n.x,n.y,n.width,n.height),T.scissorRect.x=n.x,T.scissorRect.y=n.y,T.scissorRect.width=n.width,T.scissorRect.height=n.height));break;case F.LINE_WIDTH:l&&T.rs.lineWidth!==l&&(p.lineWidth(l),T.rs.lineWidth=l);break;case F.DEPTH_BIAS:_&&(T.rs.depthBias===_.constantFactor&&T.rs.depthBiasSlop===_.slopeFactor||(p.polygonOffset(_.constantFactor,_.slopeFactor),T.rs.depthBias=_.constantFactor,T.rs.depthBiasSlop=_.slopeFactor));break;case F.BLEND_CONSTANTS:T.bs.blendColor.r===c[0]&&T.bs.blendColor.g===c[1]&&T.bs.blendColor.b===c[2]&&T.bs.blendColor.a===c[3]||(p.blendColor(c[0],c[1],c[2],c[3]),T.bs.blendColor.r=c[0],T.bs.blendColor.g=c[1],T.bs.blendColor.b=c[2],T.bs.blendColor.a=c[3]);break;case F.STENCIL_WRITE_MASK:if(f)switch(f.face){case G.FRONT:T.dss.stencilWriteMaskFront!==f.writeMask&&(p.stencilMaskSeparate(p.FRONT,f.writeMask),T.dss.stencilWriteMaskFront=f.writeMask);break;case G.BACK:T.dss.stencilWriteMaskBack!==f.writeMask&&(p.stencilMaskSeparate(p.BACK,f.writeMask),T.dss.stencilWriteMaskBack=f.writeMask);break;case G.ALL:T.dss.stencilWriteMaskFront===f.writeMask&&T.dss.stencilWriteMaskBack===f.writeMask||(p.stencilMask(f.writeMask),T.dss.stencilWriteMaskFront=f.writeMask,T.dss.stencilWriteMaskBack=f.writeMask)}break;case F.STENCIL_COMPARE_MASK:if(h)switch(h.face){case G.FRONT:T.dss.stencilRefFront===h.reference&&T.dss.stencilReadMaskFront===h.compareMask||(p.stencilFuncSeparate(p.FRONT,me[T.dss.stencilFuncFront],h.reference,h.compareMask),T.dss.stencilRefFront=h.reference,T.dss.stencilReadMaskFront=h.compareMask);break;case G.BACK:T.dss.stencilRefBack===h.reference&&T.dss.stencilReadMaskBack===h.compareMask||(p.stencilFuncSeparate(p.BACK,me[T.dss.stencilFuncBack],h.reference,h.compareMask),T.dss.stencilRefBack=h.reference,T.dss.stencilReadMaskBack=h.compareMask);break;case G.ALL:T.dss.stencilRefFront===h.reference&&T.dss.stencilReadMaskFront===h.compareMask&&T.dss.stencilRefBack===h.reference&&T.dss.stencilReadMaskBack===h.compareMask||(p.stencilFunc(me[T.dss.stencilFuncBack],h.reference,h.compareMask),T.dss.stencilRefFront=h.reference,T.dss.stencilReadMaskFront=h.compareMask,T.dss.stencilRefBack=h.reference,T.dss.stencilReadMaskBack=h.compareMask)}}}}function Ue(e,t){var r=e.gl,s=e.ANGLE_instanced_arrays,a=De.gpuInputAssembler,i=De.gpuShader,n=De.glPrimitive;if(a&&i)if(a.gpuIndirectBuffer)for(var l=a.gpuIndirectBuffer.indirects.length,u=0;u<l;u++){var _=a.gpuIndirectBuffer.indirects[u],c=a.gpuIndexBuffer;if(_.instanceCount&&s)if(c){if(_.indexCount>0){var o=_.firstIndex*c.stride;s.drawElementsInstancedANGLE(n,_.indexCount,a.glIndexType,o,_.instanceCount)}}else s.drawArraysInstancedANGLE(n,_.firstVertex,_.vertexCount,_.instanceCount);else if(c){if(_.indexCount>0){var f=_.firstIndex*c.stride;r.drawElements(n,_.indexCount,a.glIndexType,f)}}else r.drawArrays(n,_.firstVertex,_.vertexCount)}else{var h=a.gpuIndexBuffer;if(t.instanceCount&&s)if(h){if(t.indexCount>0){var d=t.firstIndex*h.stride;s.drawElementsInstancedANGLE(n,t.indexCount,a.glIndexType,d,t.instanceCount)}}else s.drawArraysInstancedANGLE(n,t.firstVertex,t.vertexCount,t.instanceCount);else if(h){if(t.indexCount>0){var g=t.firstIndex*h.stride;r.drawElements(n,t.indexCount,a.glIndexType,g)}}else r.drawArrays(n,t.firstVertex,t.vertexCount)}}var we=new Array(Be.COUNT);function We(e,t){we.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=we[s]++;switch(s){case Be.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];ke(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case Be.BIND_STATES:var n=t.bindStatesCmds.array[a];Ne(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.viewport,n.scissor,n.lineWidth,n.depthBias,n.blendConstants,n.depthBounds,n.stencilWriteMask,n.stencilCompareMask);break;case Be.DRAW:Ue(e,t.drawCmds.array[a].drawInfo);break;case Be.UPDATE_BUFFER:var l=t.updateBufferCmds.array[a];Ie(e,l.gpuBuffer,l.buffer,l.offset,l.size);break;case Be.COPY_BUFFER_TO_TEXTURE:var u=t.copyBufferToTextureCmds.array[a];Ve(e,u.buffers,u.gpuTexture,u.regions)}}}function Ve(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,l=1,u=1,_=0,c=A[r.format].isCompressed;switch(r.glTarget){case a.TEXTURE_2D:for(var o=0;o<s.length;o++){var f=s[o];l=f.texExtent.width,u=f.texExtent.height;var h=t[n++];c?r.glInternalFmt===de.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?a.compressedTexImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,r.glInternalFmt,l,u,0,h):a.compressedTexSubImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,l,u,r.glFormat,h):a.texSubImage2D(a.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,l,u,r.glFormat,r.glType,h)}break;case a.TEXTURE_CUBE_MAP:for(var d=0;d<s.length;d++){var g=s[d],E=g.texSubres.baseArrayLayer+g.texSubres.layerCount;for(_=g.texSubres.baseArrayLayer;_<E;++_){l=g.texExtent.width,u=g.texExtent.height;var p=t[n++];c?r.glInternalFmt===de.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,g.texSubres.mipLevel,r.glInternalFmt,l,u,0,p):a.compressedTexSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,g.texSubres.mipLevel,g.texOffset.x,g.texOffset.y,l,u,r.glFormat,p):a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+_,g.texSubres.mipLevel,g.texOffset.x,g.texOffset.y,l,u,r.glFormat,r.glType,p)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&S.GEN_MIPMAP&&a.generateMipmap(r.glTarget)}var He=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=void 0!==e.flags?e.flags:D.NONE,this._usage&m.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._flags&D.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._usage&m.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&m.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&m.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&B.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&m.VERTEX){t.glTarget=r.ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&m.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&m.UNIFORM?(t.glTarget=r.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&m.INDIRECT||t.usage&m.TRANSFER_DST||t.usage&m.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=r.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null),this._bakcupBuffer=null}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bakcupBuffer){var r=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(r),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}var s,a,i,n,l;this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer?this._gpuBuffer.buffer=this._uniformBuffer:this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=e,e>0&&(s=this._device,a=this._gpuBuffer,i=s.gl,n=s.stateCache,l=a.memUsage&B.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW,a.usage&m.VERTEX?(s.useVAO&&n.glVAO&&(s.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),s.stateCache.glArrayBuffer!==a.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,a.glBuffer),a.buffer?i.bufferData(i.ARRAY_BUFFER,a.buffer,l):i.bufferData(i.ARRAY_BUFFER,a.size,l),i.bindBuffer(i.ARRAY_BUFFER,null),s.stateCache.glArrayBuffer=null):a.usage&m.INDEX?(s.useVAO&&n.glVAO&&(s.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),s.stateCache.glElementArrayBuffer!==a.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a.glBuffer),a.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,a.buffer,l):i.bufferData(i.ELEMENT_ARRAY_BUFFER,a.size,l),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),s.stateCache.glElementArrayBuffer=null):a.usage&m.UNIFORM?a.buffer&&(a.vf32=new Float32Array(a.buffer.buffer)):(a.usage&m.INDIRECT||a.usage&m.TRANSFER_DST||a.usage&m.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),a.glTarget=i.NONE),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}}},{key:"update",value:function(e,t,r){if(this._isBufferView)console.warn("cannot update through buffer views!");else{var s;if(s=void 0!==r?r:this._usage&m.INDIRECT?0:e.byteLength,this._bakcupBuffer&&e!==this._bakcupBuffer.buffer){var a=new Uint8Array(e,0,r);this._bakcupBuffer.set(a,t)}Ie(this._device,this._gpuBuffer,e,t||0,s)}}},{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),n}(k),Xe=function(){function e(t,s){r(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(s),this._freeCmds=new M(s);for(var a=0;a<s;++a)this._frees[a]=new t;this._freeIdx=s-1}return i(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var l=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++l.refCount,l}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),ze=function(){function e(){r(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Xe(ye,1),this.bindStatesCmdPool=new Xe(Oe,1),this.drawCmdPool=new Xe(Fe,1),this.updateBufferCmdPool=new Xe(Ge,1),this.copyBufferToTextureCmdPool=new Xe(Le,1)}return i(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),e}(),Ke=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l)))).cmdPackage=new Me,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=[],t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return t(n,e),i(n,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}},{key:"begin",value:function(e){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(var t=0;t<this._curDynamicOffsets.length;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,r,s,a,i){var n=this._webGLAllocator.beginRenderPassCmdPool.alloc(ye);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea=r,n.clearColors.length=s.length;for(var l=0;l<s.length;++l)n.clearColors[l]=s[l];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(Be.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){for(var a=this._curDynamicOffsets[e],i=0;i<r.length;i++)a[i]=r[i];a.length=r.length,this._isStateInvalied=!0}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth}}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,r){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===r||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=r,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:r},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,r){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===r||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=r,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:r},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===N.PRIMARY&&this._isInRenderPass||this._type===N.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(Fe);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(Be.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var r=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,r,s){if(this._type===N.PRIMARY&&!this._isInRenderPass||this._type===N.SECONDARY){var a=e.gpuBuffer;if(a){var i=this._webGLAllocator.updateBufferCmdPool.alloc(Ge);if(i){var n;n=void 0!==s?s:e.usage&m.INDIRECT?0:t.byteLength;var l=t;i.gpuBuffer=a,i.buffer=l,i.offset=void 0!==r?r:0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(Be.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,r){if(this._type===N.PRIMARY&&!this._isInRenderPass||this._type===N.SECONDARY){var s=t.gpuTexture;if(s){var a=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(Le);a&&(a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(Be.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var l=s.cmdPackage.bindStatesCmds.array[n];++l.refCount,this.cmdPackage.bindStatesCmds.push(l)}for(var u=0;u<s.cmdPackage.drawCmds.length;++u){var _=s.cmdPackage.drawCmds.array[u];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var c=0;c<s.cmdPackage.updateBufferCmds.length;++c){var o=s.cmdPackage.updateBufferCmds.array[c];++o.refCount,this.cmdPackage.updateBufferCmds.push(o)}for(var f=0;f<s.cmdPackage.copyBufferToTextureCmds.length;++f){var h=s.cmdPackage.copyBufferToTextureCmds.array[f];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(Oe);if(e){e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(var t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Be.BIND_STATES),this._isStateInvalied=!1}}},{key:"webGLDevice",get:function(){return this._device}}]),n}(U),Ye=function(e){function n(){return r(this,n),s(this,a(n).apply(this,arguments))}return t(n,e),i(n,[{key:"initialize",value:function(e){return!0}},{key:"destroy",value:function(){}},{key:"wait",value:function(){}},{key:"reset",value:function(){}}]),n}(fe),je=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuFramebuffer=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,e.depStencilMipmapLevel&&0!==e.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0."),e.colorMipmapLevels&&e.colorMipmapLevels.length>0)for(var t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn("The mipmap level of th texture image to be attached of color attachment ".concat(t," should be 0. Convert to 0."));var r=[];if(void 0!==e.colorTextures)for(var s,a=_(e.colorTextures);!(s=a()).done;){var i=s.value;i&&r.push(i.gpuTexture)}var n=null;return e.depthStencilTexture&&(n=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:n,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var r=e.gl,s=[],a=r.createFramebuffer();if(a){t.glFramebuffer=a,e.stateCache.glFramebuffer!==t.glFramebuffer&&(r.bindFramebuffer(r.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var i=0;i<t.gpuColorTextures.length;++i){var n=t.gpuColorTextures[i];n&&(n.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+i,n.glTarget,n.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0+i,r.RENDERBUFFER,n.glRenderbuffer),s.push(r.COLOR_ATTACHMENT0+i))}var l=t.gpuDepthStencilTexture;if(l){var u=A[l.format].hasStencil?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT;l.glTexture?r.framebufferTexture2D(r.FRAMEBUFFER,u,l.glTarget,l.glTexture,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,u,r.RENDERBUFFER,l.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(s);var _=r.checkFramebufferStatus(r.FRAMEBUFFER);if(_!==r.FRAMEBUFFER_COMPLETE)switch(_){case r.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case r.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case r.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer),!0}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}},{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),n}(w),qe=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuInputAssembler=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}var l=null;return void 0!==e.indirectBuffer&&(l=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:l,glAttribs:[],glIndexType:n,glVAOs:new Map},function(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,l=t.gpuVertexBuffers[n],u=Ee(i.format,r),_=A[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:l.glBuffer,glType:u,size:_,count:A[i.format].count,stride:l.stride,componentCount:Ce(u,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=_}}(this._device,this._gpuInputAssembler),!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var r=t.glVAOs.values(),s=r.next();!s.done;)e.OES_vertex_array_object.deleteVertexArrayOES(s.value),s=r.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}},{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),n}(W),Ze=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuDescriptorSetLayout=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=0;r<this._bindings.length;r++){var s=this._bindings[r];this._descriptorIndices.push(t),t+=s.count}this._descriptorIndices.push(t);for(var a=[],i=0;i<this._bindings.length;i++){var n=this._bindings[i];if(n.descriptorType&V)for(var l=0;l<n.count;l++)a.push(i)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:a,descriptorIndices:this._descriptorIndices,descriptorCount:t},!0}},{key:"destroy",value:function(){this._bindings.length=0}},{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),n}(H),Qe=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuPipelineLayout=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=[],a=0,i=0,n=0;n<this._setLayouts.length;n++){var l=this._setLayouts[n],u=l.gpuDescriptorSetLayout.dynamicBindings,_=l.bindings,c=[];r.push(l.gpuDescriptorSetLayout);for(var o=0,f=0;o<_.length;o++)if(u[f]===o)for(c.push(i);u[f]===o;)f++,i++;else c.push(-1);t.push(c),s.push(a),a+=u.length}return this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetCount:a,dynamicOffsetOffsets:s,dynamicOffsetIndices:t},!0}},{key:"destroy",value:function(){this._setLayouts.length=0}},{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),n}(he),Je=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],$e=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuPipelineState=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass;for(var t=[],r=0;r<31;r++)this._dynamicStates&1<<r&&t.push(1<<r);return this._gpuPipelineState={glPrimitive:Je[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:t},!0}},{key:"destroy",value:function(){this._gpuPipelineState=null}},{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),n}(X),et=[],tt=function(e){function n(){return r(this,n),s(this,a(n).apply(this,arguments))}return t(n,e),i(n,[{key:"beginRenderPass",value:function(e,t,r,s,a,i){ke(this._device,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),Ue(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,r,s){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var a,i=e.gpuBuffer;if(i)void 0===r&&(r=0),a=void 0!==s?s:e.usage&m.INDIRECT?0:t.byteLength,Ie(this._device,i,t,r,a)}}},{key:"copyBuffersToTexture",value:function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&Ve(this._device,e,s,r)}}},{key:"execute",value:function(e,t){for(var r=0;r<t;++r){var s=e[r];We(this._device,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}}},{key:"bindStates",value:function(){et.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(et,this._curDynamicOffsets[e]);Ne(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,et,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}]),n}(Ke),rt=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l)))).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}return t(n,e),i(n,[{key:"initialize",value:function(e){return this._type=e.type,!0}},{key:"destroy",value:function(){}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var r=e.length,s=0;s<r;s++){var a=e[s];this.numDrawCalls+=a.numDrawCalls,this.numInstances+=a.numInstances,this.numTris+=a.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),n}(z),st=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuRenderPass=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subPasses&&(this._subPasses=e.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}},{key:"destroy",value:function(){this._gpuRenderPass=null}},{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),n}(K),at=[10497,33648,33071,33071],it=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuSampler=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,r=0,s=this._state.minFilter,a=this._state.magFilter,i=this._state.mipFilter;t=s===Y.LINEAR||s===Y.ANISOTROPIC?i===Y.LINEAR||i===Y.ANISOTROPIC?9987:i===Y.POINT?9985:9729:i===Y.LINEAR||i===Y.ANISOTROPIC?9986:i===Y.POINT?9984:9728,r=a===Y.LINEAR||a===Y.ANISOTROPIC?9729:9728;var n=at[this._state.addressU],l=at[this._state.addressV],u=at[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:r,glWrapS:n,glWrapT:l,glWrapR:u},!0}},{key:"destroy",value:function(){this._gpuSampler=null}},{key:"gpuSampler",get:function(){return this._gpuSampler}}]),n}(j),nt=function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l))))._gpuShader=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}return function(e,t){for(var r=e.gl,s=function(e){var s=t.gpuStages[e],a=0,i="",n=1;switch(s.type){case I.VERTEX:i="VertexShader",a=r.VERTEX_SHADER;break;case I.FRAGMENT:i="FragmentShader",a=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var l=r.createShader(a);if(l&&(s.glShader=l,r.shaderSource(s.glShader,s.source),r.compileShader(s.glShader),!r.getShaderParameter(s.glShader,r.COMPILE_STATUS))){console.error(i+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",s.source.replace(/^|\n/g,(function(){return"\n".concat(n++," ")}))),console.error(r.getShaderInfoLog(s.glShader));for(var u=0;u<t.gpuStages.length;u++){var _=t.gpuStages[e];_.glShader&&(r.deleteShader(_.glShader),_.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var i=s(a);if("object"===l(i))return i.v}var n=r.createProgram();if(n){t.glProgram=n;for(var u=0;u<t.gpuStages.length;u++){var _=t.gpuStages[u];r.attachShader(t.glProgram,_.glShader)}if(r.linkProgram(t.glProgram),e.destroyShadersImmediately)for(var c=0;c<t.gpuStages.length;c++){var o=t.gpuStages[c];o.glShader&&(r.detachShader(t.glProgram,o.glShader),r.deleteShader(o.glShader),o.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));console.info("Shader '"+t.name+"' compilation succeeded.");var f=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(f);for(var h=0;h<f;++h){var d=r.getActiveAttrib(t.glProgram,h);if(d){var g=void 0,E=d.name.indexOf("[");g=-1!==E?d.name.substr(0,E):d.name;var p=r.getAttribLocation(t.glProgram,g),T=Ae(d.type,r),S=Re(d.type,r);t.glInputs[h]={binding:p,name:g,type:T,stride:S,count:d.size,size:S*d.size,glType:d.type,glLoc:p}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var A=0;A<t.blocks.length;++A){var R=t.blocks[A],C={set:R.set,binding:R.binding,name:R.name,size:0,glUniforms:new Array(R.members.length),glActiveUniforms:[]};t.glBlocks[A]=C;for(var B=0;B<R.members.length;++B){var m=R.members[B],x=Se(m.type,r),b=Re(x,r),v=b*m.count,P=C.size/4,y=new Array(v/4);y.fill(0),C.glUniforms[B]={binding:-1,name:m.name,type:m.type,stride:b,count:m.count,size:v,offset:C.size,glType:x,glLoc:-1,array:y,begin:P},C.size+=v}}}if(t.samplers.length>0){t.glSamplers=new Array(t.samplers.length);for(var O=0;O<t.samplers.length;++O){var F=t.samplers[O];t.glSamplers[O]={set:F.set,binding:F.binding,name:F.name,type:F.type,units:[],glUnits:null,glType:Se(F.type,r),glLoc:-1}}}for(var G=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORMS),L=0,M=[],D=0;D<G;++D){var k=r.getActiveUniform(t.glProgram,D);if(k){var N=r.getUniformLocation(t.glProgram,k.name);if(null!==N){var U=void 0,w=k.name.indexOf("[");if(U=-1!==w?k.name.substr(0,w):k.name,k.type===r.SAMPLER_2D||k.type===r.SAMPLER_CUBE)for(var W=0;W<t.glSamplers.length;W++){var V=t.glSamplers[W];if(V.name===U){for(var H=0;H<k.size;++H)V.units.push(L+H);V.glLoc=N,L+=k.size,M.push(V);break}}else for(var X=0;X<t.glBlocks.length;X++)for(var z=t.glBlocks[X],K=0;K<z.glUniforms.length;K++){var Y=z.glUniforms[K];if(Y.name===U){Y.glLoc=N,z.glActiveUniforms.push(Y);break}}}}}if(M.length){e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var j=0;j<M.length;j++){var q=M[j];q.glUnits=new Int32Array(q.units),r.uniform1iv(q.glLoc,q.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}for(var Z=0;Z<t.glBlocks.length;)t.glBlocks[Z].glActiveUniforms.length?Z++:(t.glBlocks[Z]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);for(var Q=0;Q<t.glSamplers.length;)t.glSamplers[Q].units.length?Q++:(t.glSamplers[Q]=t.glSamplers[t.glSamplers.length-1],t.glSamplers.length--)}}(this._device,this._gpuShader),!0}},{key:"destroy",value:function(){this._gpuShader&&(!function(e,t){if(t.glProgram){var r=e.gl;if(!e.destroyShadersImmediately)for(var s=0;s<t.gpuStages.length;s++){var a=t.gpuStages[s];a.glShader&&(r.detachShader(t.glProgram,a.glShader),r.deleteShader(a.glShader),a.glShader=null)}r.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}},{key:"gpuShader",get:function(){return this._gpuShader}}]),n}(q),lt=function e(){r(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTexUnits=new Array(Z),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Q,this.dss=new J,this.bs=new $,this.glEnabledAttribLocs=new Array(ee),this.glCurrentAttribLocs=new Array(ee),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<Z;++t)this.glTexUnits[t]={glTexture:null}},ut=function(e){function l(){var e,t;r(this,l);for(var i=arguments.length,n=new Array(i),u=0;u<i;u++)n[u]=arguments[u];return(t=s(this,(e=a(l)).call.apply(e,[this].concat(n))))._gpuTexture=null,t}return t(l,e),i(l,[{key:"initialize",value:function(e){return"texture"in e?(console.log("WebGL does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.layerCount&&(this._layerCount=e.layerCount),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=te(this._width)&&te(this._height),this._size=re(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&S.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var r=e.gl;t.glInternalFmt=pe(t.format,r),t.glFormat=Te(t.format,r),t.glType=Ee(t.format,r);var s=t.width,a=t.height;switch(t.type){case x.TEX2D:t.glTarget=r.TEXTURE_2D;var i=Math.max(s,a);if(i>e.maxTextureSize&&n(9100,i,e.maxTextureSize),!e.WEBGL_depth_texture&&A[t.format].hasDepth){var l=r.createRenderbuffer();l&&t.size>0&&(t.glRenderbuffer=l,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),t.glInternalFmt===r.DEPTH_COMPONENT&&(t.glInternalFmt=r.DEPTH_COMPONENT16),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,s,a))}else if(t.samples===v.X1){var u=r.createTexture();if(u&&t.size>0){t.glTexture=u;var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),_.glTexture=t.glTexture),A[t.format].isCompressed)if(t.glInternalFmt!==de.COMPRESSED_RGB_ETC1_WEBGL)for(var c=0;c<t.mipLevel;++c){var o=b(t.format,s,a,1),f=new Uint8Array(o);r.compressedTexImage2D(r.TEXTURE_2D,c,t.glInternalFmt,s,a,0,f),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}else{var h=b(t.format,2,2,1),d=new Uint8Array(h);r.compressedTexImage2D(r.TEXTURE_2D,0,t.glInternalFmt,2,2,0,d)}else for(var g=0;g<t.mipLevel;++g)r.texImage2D(r.TEXTURE_2D,g,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1);t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}else r.deleteTexture(u)}break;case x.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var E=Math.max(s,a);E>e.maxCubeMapTextureSize&&n(9100,E,e.maxTextureSize);var p=r.createTexture();if(p&&t.size>0){t.glTexture=p;var T=e.stateCache.glTexUnits[e.stateCache.texUnit];if(T.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),T.glTexture=t.glTexture),A[t.format].isCompressed)if(t.glInternalFmt!==de.COMPRESSED_RGB_ETC1_WEBGL)for(var S=0;S<6;++S){s=t.width,a=t.height;for(var R=0;R<t.mipLevel;++R){var C=b(t.format,s,a,1),B=new Uint8Array(C);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+S,R,t.glInternalFmt,s,a,0,B),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}else for(var m=0;m<6;++m){var P=b(t.format,2,2,1),y=new Uint8Array(P);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,t.glInternalFmt,2,2,0,y)}else for(var O=0;O<6;++O){s=t.width,a=t.height;for(var F=0;F<t.mipLevel;++F)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+O,F,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=x.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null}},{key:"resize",value:function(e,t){var r=this._size;this._width=e,this._height=t,this._size=re(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var r=e.gl;t.glInternalFmt=pe(t.format,r),t.glFormat=Te(t.format,r),t.glType=Ee(t.format,r);var s=t.width,a=t.height;switch(t.type){case x.TEX2D:t.glTarget=r.TEXTURE_2D;var i=Math.max(s,a);if(i>e.maxTextureSize&&n(9100,i,e.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,s,a);else if(t.glTexture){var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),A[t.format].isCompressed){if(t.glInternalFmt!==de.COMPRESSED_RGB_ETC1_WEBGL)for(var u=0;u<t.mipLevel;++u){var _=b(t.format,s,a,1),c=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,u,t.glInternalFmt,s,a,0,c),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}else for(var o=0;o<t.mipLevel;++o)r.texImage2D(r.TEXTURE_2D,o,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}break;case x.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var f=Math.max(s,a);f>e.maxCubeMapTextureSize&&n(9100,f,e.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),A[t.format].isCompressed){if(t.glInternalFmt!==de.COMPRESSED_RGB_ETC1_WEBGL)for(var d=0;d<6;++d){s=t.width,a=t.height;for(var g=0;g<t.mipLevel;++g){var E=b(t.format,s,a,1),p=new Uint8Array(E);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+d,g,t.glInternalFmt,s,a,0,p),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}}}else for(var T=0;T<6;++T){s=t.width,a=t.height;for(var S=0;S<t.mipLevel;++S)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+T,S,t.glInternalFmt,s,a,0,t.glFormat,t.glType,null),s=Math.max(1,s>>1),a=Math.max(1,a>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=x.TEX2D,t.glTarget=r.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=r,this._device.memoryStatus.textureSize+=this._size)}},{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l}(se),_t=e("WebGLDevice",function(e){function n(){var e,t;r(this,n);for(var i=arguments.length,l=new Array(i),u=0;u<i;u++)l[u]=arguments[u];return(t=s(this,(e=a(n)).call.apply(e,[this].concat(l)))).stateCache=new lt,t.cmdAllocator=new ze,t.nullTex2D=null,t.nullTexCube=null,t._webGLRC=null,t._isAntialias=!0,t._isPremultipliedAlpha=!0,t._useVAO=!1,t._destroyShadersImmediately=!0,t._noCompressedTexSubImage2D=!1,t._bindingMappingInfo=new ae,t._webGLContextLostHandler=null,t._extensions=null,t._EXT_texture_filter_anisotropic=null,t._EXT_frag_depth=null,t._EXT_shader_texture_lod=null,t._EXT_sRGB=null,t._OES_vertex_array_object=null,t._EXT_color_buffer_half_float=null,t._WEBGL_color_buffer_float=null,t._WEBGL_compressed_texture_etc1=null,t._WEBGL_compressed_texture_etc=null,t._WEBGL_compressed_texture_pvrtc=null,t._WEBGL_compressed_texture_astc=null,t._WEBGL_compressed_texture_s3tc=null,t._WEBGL_compressed_texture_s3tc_srgb=null,t._WEBGL_debug_shaders=null,t._WEBGL_draw_buffers=null,t._WEBGL_lose_context=null,t._WEBGL_depth_texture=null,t._WEBGL_debug_renderer_info=null,t._OES_texture_half_float=null,t._OES_texture_half_float_linear=null,t._OES_texture_float=null,t._OES_texture_float_linear=null,t._OES_standard_derivatives=null,t._OES_element_index_uint=null,t._ANGLE_instanced_arrays=null,t}return t(n,e),i(n,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,void 0!==e.isAntialias&&(this._isAntialias=e.isAntialias),void 0!==e.isPremultipliedAlpha&&(this._isPremultipliedAlpha=e.isPremultipliedAlpha),void 0!==e.bindingMappingInfo&&(this._bindingMappingInfo=e.bindingMappingInfo),this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:ie.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=ne.WEBGL,this._deviceName="WebGL";var r=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=r.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=r.getParameter(r.RENDERER),this._vendor=r.getParameter(r.VENDOR)),this._version=r.getParameter(r.VERSION),this._maxVertexAttributes=r.getParameter(r.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=r.getParameter(r.DEPTH_BITS),this._stencilBits=r.getParameter(r.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=T.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=T.D24S8:this._depthStencilFmt=T.D24:8===this._stencilBits?this._depthStencilFmt=T.D16S8:this._depthStencilFmt=T.D16,this._extensions=r.getSupportedExtensions();var s="";if(this._extensions){for(var a,i=_(this._extensions);!(a=i()).done;){s+=a.value+" "}console.debug("EXTENSIONS: "+s)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),c.os===c.OS_IOS&&14===c.osMainVersion&&c.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),c.browserType===c.BROWSER_TYPE_UC&&(this._ANGLE_instanced_arrays=null),(c.os===c.OS_IOS&&c.osMainVersion<=10||o)&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[le.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[le.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[le.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[le.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[le.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[le.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[le.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[le.FORMAT_D16]=!0,this._features[le.FORMAT_D24]=!0,this._features[le.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[le.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[le.INSTANCED_ARRAYS]=!0);var n="";this._WEBGL_compressed_texture_etc1&&(this._features[le.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[le.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[le.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[le.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[le.FORMAT_ASTC]=!0,n+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+n),this.initStates(r),this._queue=this.createQueue({type:ue.GRAPHICS});this._webGLRC.canvas;this.nullTex2D=new ut(this),this.nullTex2D.initialize({type:x.TEX2D,usage:_e.SAMPLED,format:T.RGBA8,width:2,height:2,flags:S.GEN_MIPMAP}),this.nullTexCube=new ut(this),this.nullTexCube.initialize({type:x.TEX2D,usage:_e.SAMPLED,format:T.RGBA8,width:2,height:2,layerCount:6,flags:S.CUBEMAP|S.GEN_MIPMAP});var l={buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{mipLevel:0,baseArrayLayer:0,layerCount:1}},u=new Uint8Array(this.nullTex2D.size);return u.fill(0),this.copyBuffersToTexture([u],this.nullTex2D,[l]),l.texSubres.layerCount=6,this.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[l]),!0}},{key:"destroy",value:function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._extensions=null,this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"acquire",value:function(){this.cmdAllocator.releaseCmds()}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===N.PRIMARY?tt:Ke)(this);return t.initialize(e),t}},{key:"createBuffer",value:function(e){var t=new He(this);return t.initialize(e)?t:null}},{key:"createTexture",value:function(e){var t=new ut(this);return t.initialize(e)?t:null}},{key:"createSampler",value:function(e){var t=new it(this);return t.initialize(e)?t:null}},{key:"createDescriptorSet",value:function(e){var t=new ge(this);return t.initialize(e)?t:null}},{key:"createShader",value:function(e){var t=new nt(this);return t.initialize(e)?t:null}},{key:"createInputAssembler",value:function(e){var t=new qe(this);return t.initialize(e)?t:null}},{key:"createRenderPass",value:function(e){var t=new st(this);return t.initialize(e)?t:null}},{key:"createFramebuffer",value:function(e){var t=new je(this);return t.initialize(e)?t:null}},{key:"createDescriptorSetLayout",value:function(e){var t=new Ze(this);return t.initialize(e)?t:null}},{key:"createPipelineLayout",value:function(e){var t=new Qe(this);return t.initialize(e)?t:null}},{key:"createPipelineState",value:function(e){var t=new $e(this);return t.initialize(e)?t:null}},{key:"createFence",value:function(e){var t=new Ye(this);return t.initialize(e)?t:null}},{key:"createQueue",value:function(e){var t=new rt(this);return t.initialize(e)?t:null}},{key:"copyBuffersToTexture",value:function(e,t,r){Ve(this,e,t.gpuTexture,r)}},{key:"copyTexImagesToTexture",value:function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,l=0;switch(r.glTarget){case a.TEXTURE_2D:for(var u=0;u<s.length;u++){var _=s[u];a.texSubImage2D(a.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,r.glFormat,r.glType,t[n++])}break;case a.TEXTURE_CUBE_MAP:for(var c=0;c<s.length;c++){var o=s[c],f=o.texSubres.baseArrayLayer+o.texSubres.layerCount;for(l=o.texSubres.baseArrayLayer;l<f;++l)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,o.texSubres.mipLevel,o.texOffset.x,o.texOffset.y,r.glFormat,r.glType,t[n++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&S.GEN_MIPMAP&&r.isPowerOf2&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)}},{key:"copyFramebufferToBuffer",value:function(e,t,r){var s=this._webGLRC,a=e.gpuFramebuffer,i=a.gpuColorTextures[0].format,n=Te(i,s),l=Ee(i,s),u=ce(A[i]),c=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==a.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,a.glFramebuffer),this.stateCache.glFramebuffer=a.glFramebuffer);for(var o,f=new u(t),h=_(r);!(o=h()).done;){var d=o.value,g=d.texExtent.width,E=d.texExtent.height;s.readPixels(d.texOffset.x,d.texOffset.y,g,E,n,l,f)}this.stateCache.glFramebuffer!==c&&(s.bindFramebuffer(s.FRAMEBUFFER,c),this.stateCache.glFramebuffer=c)}},{key:"blitFramebuffer",value:function(e,t,r,s,a){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],r=0;r<t.length;++r){var s=this.gl.getExtension(t[r]+e);if(s)return s}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}},{key:"_onWebGLContextLost",value:function(e){f(11e3),h(e)}},{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"destroyShadersImmediately",get:function(){return this._destroyShadersImmediately}},{key:"noCompressedTexSubImage2D",get:function(){return this._noCompressedTexSubImage2D}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),n}(oe));d.WebGLDevice=_t}}}));
