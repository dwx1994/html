System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:Xt,CCClass:Ge,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:Yt,Eventify:on,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Bw,WorldNode3DToWorldNodeUI:Fw,absMax:fi,absMaxComponent:hi,approx:Kn,assert:m,assertID:I,bezier:Fp,bezierByTime:e_,ccenum:Zt,clamp:Qn,clamp01:Zn,color:mi,computeRatioByType:yU,createDefaultPipeline:BM,debug:v,deserialize:kh,earcut:xZ,enumerableProps:pi,equals:Yn,error:d,errorID:w,find:OD,fragmentText:sj,getBaselineOffset:function(){return 0},getError:R,getPathFromRoot:function(t,e){for(var n=t,i="";null!==n&&n!==e;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(t){return t[ul]},getWorldTransformUntilRoot:KG,instantiate:rf,inverseLerp:ui,isCustomTargetModifier:nH,isDisplayStats:D,isElementModifier:eH,isPropertyModifier:tH,isUnicodeCJK:ij,isUnicodeSpace:rj,isValid:Qe,lerp:Jn,log:p,logID:b,markAsWarning:void 0,mat4:Li,murmurhash2_32_gc:Da,nextPow2:si,pingPong:li,pseudoRandom:ri,pseudoRandomRange:oi,pseudoRandomRangeInt:ai,quat:Ri,randomRange:ni,randomRangeInt:ii,rect:qi,removeProperty:void 0,repeat:ci,replaceProperty:void 0,safeMeasureText:oj,sampleAnimationCurve:gU,setDefaultLogTimes:function(t){t>0&&(Hn=t)},setDisplayStats:O,size:ji,toDegree:ti,toRadian:$n,tween:RIt,tweenUtil:DIt,v2:Ui,v3:xi,v4:Gi,warn:_,warnID:E});var n="undefined"==typeof window?global:window,i=t("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=false,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!1,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0,n.CC_UI_GPU_DRIVEN=!1;var r=t("VERSION","3.4.1");n.CocosEngine=i.ENGINE_VERSION=r,n.cc=i;var o="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",a=null,s=console.log.bind(console),c=s,l=s,u=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+f.apply(void 0,[e].concat(i)))}},h=s;function f(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return i.js.formatStr.apply(null,[t].concat(n))}function p(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return s.apply(void 0,[t].concat(n))}function _(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return c.apply(void 0,[t].concat(n))}function d(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return l.apply(void 0,[t].concat(n))}function m(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return u.apply(void 0,[t,e].concat(i))}function v(){return h.apply(void 0,arguments)}function g(t){if(s=c=l=u=h=function(){},t!==A.NONE){if(t>A.ERROR){var e=function(t){if(i.game.canvas){if(!a){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",i.game.canvas.height);var n=e.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(a=document.createElement("textarea")).setAttribute("rows","20"),a.setAttribute("cols","30"),a.setAttribute("disabled","true");var r=a.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",e.appendChild(a),i.game.canvas.parentNode.appendChild(e)}a.value=a.value+t+"\r\n",a.scrollTop=a.scrollHeight}};l=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("ERROR :  "+f.apply(void 0,[t].concat(i)))},u=function(t,n){if(!t){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];e("ASSERT: "+f.apply(void 0,[n].concat(r)))}},t!==A.ERROR_FOR_WEB_PAGE&&(c=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("WARN :  "+f.apply(void 0,[t].concat(i)))}),t===A.INFO_FOR_WEB_PAGE&&(s=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e(f.apply(void 0,[t].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.error.apply(console,[t].concat(n))},u=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=f.apply(void 0,[e].concat(i));throw new Error(o)}});if(t!==A.ERROR&&(c=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.warn.apply(console,[t].concat(n))}),t<=A.INFO&&(s=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.log.apply(console,[t].concat(n))}),t<=A.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);h=function(){return n.apply(void 0,arguments)}}}}function y(t){d(t.stack||t)}function x(t){return function(e){for(var n=t+" "+e+", please go to "+o+"#"+e+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var S=x("Log");function b(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];p(S.apply(void 0,[t].concat(n)))}var T=x("Warning");function E(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];_(T.apply(void 0,[t].concat(n)))}var C=x("Error");function w(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];d(C.apply(void 0,[t].concat(n)))}var A,P=x("Assert");function I(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];m(!1,P.apply(void 0,[e].concat(i)))}}function R(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return C.apply(void 0,[t].concat(n))}function D(){return!!i.profiler&&i.profiler.isShowingStats()}function O(t){i.profiler&&(t?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(A||(A=t("DebugMode",{})));var M=Object.freeze({__proto__:null,log:p,warn:_,error:d,assert:m,debug:v,_resetDebugSetting:g,_throw:y,logID:b,warnID:E,errorID:w,assertID:I,get DebugMode(){return A},getError:R,isDisplayStats:D,setDisplayStats:O});function N(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function L(t,e,n){return e&&N(t.prototype,e),n&&N(t,n),t}function B(){return(B=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function F(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,U(t,e)}function z(t){return(z=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function U(t,e){return(U=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function k(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function G(t,e,n){return(G=k()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&U(r,n.prototype),r}).apply(null,arguments)}function H(t){var e="function"==typeof Map?new Map:void 0;return(H=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return G(t,arguments,z(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),U(i,t)})(t)}function V(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function j(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function W(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return j(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?j(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}function q(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function X(t,e,n,i,r){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}var Y=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},L(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function K(t,e){t.splice(e,1)}function Q(t,e){var n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function Z(t,e){var n=t.indexOf(e);return n>=0&&(K(t,n),!0)}function J(t,e){return t.indexOf(e)>=0}var $=Object.freeze({__proto__:null,removeAt:K,fastRemoveAt:Q,remove:Z,fastRemove:function(t,e){var n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:function(t,e){var n=t.findIndex(e);if(n>=0){var i=t[n];return K(t,n),i}},verifyType:function(t,e){if(t&&t.length>0)for(var n,i=W(t);!(n=i()).done;)if(!(n.value instanceof e))return b(1300),!1;return!0},removeArray:function(t,e){for(var n=0,i=e.length;n<i;n++)Z(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0].concat(e)),t},contains:J,copy:function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:Y}),tt=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();tt.global=new tt("global");var et=new tt("TmpCId."),nt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),it="__cid__";function rt(t){return"number"==typeof t||t instanceof Number}function ot(t){return"string"==typeof t||t instanceof String}function at(t){for(var e in t)return!1;return!0}var st,ct=(st={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,n,i,r){st.value=n,st.writable=i,st.enumerable=r,Object.defineProperty(t,e,st),st.value=void 0}),lt=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),t.get=i,t.set=r,t.enumerable=o,t.configurable=a,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}}(),ut=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.get=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0}}(),ht=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.set=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.set=void 0}}();function ft(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function pt(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var n="";if(t.name&&(n=t.name),t.toString){var i,r=t.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return t&&t.constructor?pt(t.constructor):""}function _t(t,e,n,i){var r=/([^.]+)$/,o=r.exec(e)[0],a=r.exec(n)[0];function s(){return this[a]}i?lt(t,o,s,(function(t){this[a]=t})):ut(t,o,s)}function dt(t,e,n,i){for(var r in n)_t(t,e+"."+r,n[r],i)}var mt=/(%d)|(%s)/,vt=/%s/;function gt(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+t;var r="string"==typeof t&&mt.test(t);if(r)for(var o,a=W(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?mt:vt;if(c.test(t)){var l=""+s;t=t.replace(c,l)}else t+=" "+s}else for(var u,h=W(n);!(u=h()).done;){var f=u.value;t+=" "+f}return t}function yt(){for(var t=arguments.length-1,e=new Array(t),n=0;n<t;++n)e[n]=arguments[n+1];return e}function xt(t,e){for(;t;){var n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function St(t,e,n){var i=xt(e,t);i&&Object.defineProperty(n,t,i)}function bt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){w(5402,a);continue}for(var s in a)s in t||St(s,a,t)}}return t}function Tt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){w(5403,a);continue}for(var s in a)St(s,a,t)}}return t}function Et(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Ct(t){var e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function wt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Ct(t)))return!1;if(t===e)return!0}}return!1}function At(t){for(var e=0,n=Object.keys(t);e<n.length;e++)delete t[n[e]]}var Pt=ft(!0),It=ft(!0);function Rt(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],ct(i.prototype,t,n),n){var r=e[n];r&&r!==i?d("A Class already exists with the same "+t+' : "'+n+'".'):e[n]=i}}}var Dt=Rt("__cid__",Pt),Ot=Rt("__classname__",It);function Mt(t,e){if(Ot(t,e),!e.prototype.hasOwnProperty(it)){var n=t||et.getNewId();n&&Dt(n,e)}}function Nt(t,e){var n=It[e],i=Pt[e],r=!0;if(n&&n!==t&&(d('"'+e+'" has already been set as name or alias of another class.'),r=!1),i&&i!==t&&(d('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var o=t[nt];o||(o=[],t[nt]=o),o.push(e),It[e]=t,Pt[e]=t}}function Lt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var i=0,r=e;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Pt[s];var c=a.__classname__;c&&delete It[c];var l=a[nt];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete It[h],delete Pt[h]}}}function Bt(t){return Pt[t]}function Ft(t){return It[t]}function zt(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(it))return t.prototype.__cid__;if(t&&t.constructor){var n=t.constructor.prototype;if(n&&n.hasOwnProperty(it))return t.__cid__}return""}var Ut=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),kt=$,Gt={IDGenerator:tt,Pool:Ut,array:$,isNumber:rt,isString:ot,isEmptyObject:at,getPropertyDescriptor:xt,addon:bt,mixin:Tt,extend:Et,getSuper:Ct,isChildClassOf:wt,clear:At,value:ct,getset:lt,get:ut,set:ht,unregisterClass:Lt,getClassName:pt,setClassName:Mt,setClassAlias:Nt,getClassByName:Ft,get _registeredClassNames(){return B({},It)},set _registeredClassNames(t){At(It),Object.assign(It,t)},get _registeredClassIds(){return B({},Pt)},set _registeredClassIds(t){At(Pt),Object.assign(Pt,t)},_getClassId:zt,_setClassId:Dt,_getClassById:Bt,obsolete:_t,obsoletes:dt,formatStr:gt,shiftArguments:yt,createMap:ft};i.js=Gt,t("js",Object.freeze({__proto__:null,array:kt,js:Gt,IDGenerator:tt,Pool:Ut,isNumber:rt,isString:ot,isEmptyObject:at,value:ct,getset:lt,get:ut,set:ht,createMap:ft,getClassName:pt,obsolete:_t,obsoletes:dt,formatStr:gt,shiftArguments:yt,getPropertyDescriptor:xt,addon:bt,mixin:Tt,extend:Et,getSuper:Ct,isChildClassOf:wt,clear:At,_idToClass:Pt,_nameToClass:It,_setClassId:Dt,setClassName:Mt,setClassAlias:Nt,unregisterClass:Lt,_getClassById:Bt,getClassByName:Ft,_getClassId:zt}));var Ht=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,Gt.array.fastRemoveAt(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),Vt=function(){function t(){this._poolHandle=-1,Ht.addContainer(this)}return t.prototype.destroy=function(){Ht.removeContainer(this)},t}(),jt=t("Pool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(e());return r}F(e,t);var n=e.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(t){this._freepool[++this._nextAvail]=t},n.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&E(14100);var n=e||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(Vt)),Wt=t("RecyclePool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=e();return r}F(e,t);var n=e.prototype;return n.reset=function(){this._count=0},n.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},n.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}},L(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(Vt)),qt=t("CachedArray",function(t){function e(e,n){var i;return(i=t.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(e),i._initSize=e,i.length=0,i._compareFn=void 0!==n?n:function(t,e){return t-e},i}F(e,t);var n=e.prototype;return n.push=function(t){this.array[this.length++]=t},n.pop=function(){return this.array[--this.length]},n.get=function(t){return this.array[t]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},n.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},n.indexOf=function(t){for(var e=0,n=this.length;e<n;++e)if(this.array[e]===t)return e;return-1},e}(Vt));function Xt(t){if("__bitmask__"in t)return t;ct(t,"__bitmask__",null,!0);for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&ct(t,a,r)}return t}function Yt(t){return"__enums__"in t?t:(ct(t,"__enums__",null,!0),Yt.update(t))}function Kt(t){t.hasOwnProperty("__enums__")}function Qt(t){Kt(t);var e=t.__enums__||[];for(var n in e.length=0,t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function Zt(t){"__enums__"in t||ct(t,"__enums__",null,!0)}t("memop",Object.freeze({__proto__:null,Pool:jt,RecyclePool:Wt,CachedArray:qt})),Xt.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},Xt.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var n in t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),e},i.BitMask=Xt,Yt.update=function(t){for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&ct(t,a,r)}return Array.isArray(t.__enums__)&&Qt(t),t},Yt||(Yt=t("Enum",{})),Yt.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},Yt.getList=function(t){return Kt(t),t.__enums__?t.__enums__:Qt(t)},i.Enum=Yt;var Jt=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return w(100,pt(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){w(100,pt(this)+".set")},e.toString=function(){return""+{}},t}());Mt("cc.ValueType",Jt),i.ValueType=Jt;var $t=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});i.macro=$t;for(var te=/^(?:cc|dragonBones|sp|ccsg)\..+/,ee=new Array(123),ne=0;ne<123;++ne)ee[ne]=64;for(var ie=0;ie<64;++ie)ee["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(ie)]=ie;var re=ee;function oe(t,e,n){function i(t,e,n,i){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[n]=r.get),r.set&&i&&(t[i]=r.set);else{var o=t[n];lt(t,e,o,t[i])}}for(var r,o=t.prototype,a=0;a<e.length;a++){var s=(r=e[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function ae(t,e,n,i){var r=t[e];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):t[e]=i?[n,r]:[r,n]:t[e]=n}function se(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}function ce(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function le(t,e,n){t&&setTimeout((function(){t(e,n)}),0)}function ue(t){return!(!t||t.constructor!==Object)&&at(t)}function he(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t<n?t:n}function fe(t){return t*$t.RAD}function pe(t){return t*$t.DEG}i.misc={BUILTIN_CLASSID_RE:te,BASE64_VALUES:re,propertyDefine:oe,pushToMap:ae,contains:se,isDomNode:ce,callInNextTick:le,isPlainEmptyObj_DEV:ue,clampf:he,degreesToRadians:fe,radiansToDegrees:pe},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:te,BASE64_VALUES:re,propertyDefine:oe,pushToMap:ae,contains:se,isDomNode:ce,callInNextTick:le,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ue,clampf:he,degreesToRadians:fe,radiansToDegrees:pe}));var _e="$_$";function de(t,e){var n=e?Object.create(e):{};return ct(t,"__attrs__",n),n}function me(t){if("function"!=typeof t)return de(t,ge(t.constructor));for(var e,n=i.Class.getInheritanceChain(t),r=n.length-1;r>=0;r--){var o=n[r];o.hasOwnProperty("__attrs__")&&o.__attrs__||de(o,(e=n[r+1])&&e.__attrs__)}return de(t,(e=n[0])&&e.__attrs__),t.__attrs__}function ve(t,e){var n=ge(t),i=e+_e,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function ge(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||me(t)}function ye(t,e,n,i){ge(t)[e+_e+n]=i}var xe=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),Se=t("CCInteger",new xe("Integer",0));i.Integer=Se,i.CCInteger=Se;var be=t("CCFloat",new xe("Float",0));i.Float=be,i.CCFloat=be;var Te=t("CCBoolean",new xe("Boolean",!1));i.Boolean=Te,i.CCBoolean=Te;var Ee=t("CCString",new xe("String",""));function Ce(t,e){return function(n,i){var r='"'+pt(n)+"."+i+'"',o=ve(n,i),a=o.type;if(a===Se||a===be?a="Number":a!==Ee&&a!==Te||(a=""+a),a===t){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ue(s)){var c=typeof s,l=t.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;E(3605,r,pt(o.ctor))}else"Number"!==t&&E(3606,e,r,t);else{if("function"===c)return;t===Ee.default&&null==s?E(3607,r):E(3611,e,r,c)}delete o.type}}}else E(3604,r)}}i.String=Ee,i.CCString=Ee;var we=Object.freeze({__proto__:null,DELIMETER:_e,createAttrsSingle:de,createAttrs:me,attr:ve,getClassAttrs:ge,setClassAttr:ye,PrimitiveType:xe,CCInteger:Se,CCFloat:be,CCBoolean:Te,CCString:Ee,getTypeChecker_ET:Ce,getObjTypeChecker_ET:function(t){return function(e,n){Ce("Object","type")(e,n);var r=ge(e)[n+_e+"default"],o=i.Class.getDefault(r);if(!Array.isArray(o)&&wt(t,i.ValueType)){var a=pt(t),s=gt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',pt(e),n,a);r?p(s):E(3612,s,a,pt(e),n,a)}}}}),Ae={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Pe(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,n.call(this,e)};var o={};for(var a in i[r]=o,Ae){var s=Ae[a];t.hasOwnProperty(a)&&(o[a]=t[a],s.canUsedInGet||delete t[a])}}}function Ie(t,e,n,r){if(Array.isArray(e)){if(!(e.length>0))return w(5508,n,r);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=i.String:e===Boolean?t.type=i.Boolean:e===Number&&(t.type=i.Float))}function Re(t,e,n){var i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function De(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Re(e,[],t);if("function"==typeof t){var n=t;return Re(e,wt(n,i.ValueType)?new n:null,n)}return Re(e,t instanceof xe?t.default:t)}return null}var Oe=[];function Me(){return Oe[Oe.length-1]}i._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),Oe.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){var t=Oe.pop(),e=t.module,n=e.exports;if(n===t.exports){for(var i in n)return;e.exports=n=t.cls}},peek:Me};var Ne=_e,Le={datas:null,push:function(t){if(this.datas)this.datas.push(t);else{this.datas=[t];var e=this;setTimeout((function(){e.init()}),0)}},init:function(){var t=this.datas;if(t){for(var e=0;e<t.length;++e){var n=t[e],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=pt(i);r?ke(i,o,r,i.$super,n.mixins):w(3633,o)}this.datas=null}}};function Be(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),Ve(t,i,e,n)}function Fe(t,e,n,i){var r=i.get;i.set,r&&(Ve(t,i,e,n),ye(t,n,"serializable",!1))}function ze(t){return"function"==typeof t?t():t}function Ue(t,e,n){for(var i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,xt(e,i))}function ke(t,e,n,i,r){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter((function(e){return t.__props__.indexOf(e)<0}))))}if(n)for(var s in function(t,e){for(var n in t){var i=t[n],r=De(i,!1);if(r&&(i=t[n]=r),i){var o=i.notify;o&&Pe(i,n,o,t),"type"in i&&Ie(i,i.type,e,n)}}}(n,e),n){var c=n[s];c.get||c.set?Fe(t,e,s,c):Be(t,e,s,c)}var l=ge(t);t.__values__=t.__props__.filter((function(t){return!1!==l[t+Ne+"serializable"]}))}function Ge(t){var e=t.name,n=t.extends,r=t.mixins,o=function(t,e,n,r){var o=i.Component,a=Me();if(a&&wt(e,o)){if(wt(a.cls,o))return w(3615),null;t=t||a.script}var s=function(t,e,n,i){var r=i.ctor,o=[r],a=r;ct(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(e&&(a.$super=e),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Ue(s,l.prototype),Ge._isCCClass(l)&&Ue(ge(a),ge(l))}s.constructor=a}return Mt(t,a),a}(t,e,n,r);if(a)if(wt(e,o)){var c=a.uuid;c&&Dt(c,s),a.cls=s}else wt(a.cls,o)||(a.cls=s);return s}(e,n,r,t);e||(e=i.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);var a=t.properties;"function"==typeof a||n&&null===n.__props__||r&&r.some((function(t){return null===t.__props__}))?(Le.push({cls:o,props:a,mixins:r}),o.__props__=o.__values__=null):ke(o,e,a,n,t.mixins);var s=t.editor;return s&&wt(n,i.Component)&&i.Component._registerEditorProps(o,s),o}Ge._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Ge.fastDefine=function(t,e,n){Mt(t,e);for(var i=e.__props__=e.__values__=Object.keys(n),r=ge(e),o=0;o<i.length;o++){var a=i[o];r[a+Ne+"visible"]=!1,r[a+Ne+"default"]=n[a]}},Ge.Attr=we,Ge.attr=ve,Ge.getInheritanceChain=function(t){for(var e=[];t=Ct(t);)t!==Object&&e.push(t);return e};var He={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Ve(t,e,n,i){var r=null,o="";function a(){return o=i+Ne,r=ge(t)}"type"in e&&void 0===e.type&&E(3660,i,n);var s=e.type;s&&(He[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Yt.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Yt.getList(s)):Xt.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Xt.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in e&&((r||a())[o+"default"]=e.default);var c,l=function(t,n){if(t in e){var i=e[t];typeof i===n&&((r||a())[o+t]=i)}};e.editorOnly&&((r||a())[o+"editorOnly"]=!0),e.__noImplicit?(r||a())[o+"serializable"]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=e.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Ge.isArray=function(t){return t=ze(t),Array.isArray(t)},Ge.getDefault=ze,Ge.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Ge.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Ge.getNewValueTypeCode=function(t){for(var e=pt(t),n=t.constructor,i="new "+e+"(",r=0;r<n.__props__.length;r++)i+=t[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},i.Class=Ge;var je,We=t("editorExtrasTag","__editorExtras__"),qe=1<<22,Xe=[],Ye=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=Xe.length,e=0;e<t;++e){var n=Xe[e];1&n._objFlags||n._destroyImmediate()}t===Xe.length?Xe.length=0:Xe.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(E(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Xe.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var n,r=t instanceof i._BaseNode||t instanceof i.Component,o=r?"_id":null,a={};for(n in t)if(t.hasOwnProperty(n)){if(n===o)continue;switch(typeof t[n]){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(Ge._isCCClass(e))for(var s=i.Class.Attr.getClassAttrs(e),c=e.__props__,l=0;l<c.length;l++){var u=(n=c[l])+i.Class.Attr.DELIMETER+"default";if(u in s){if(r&&"_id"===n)continue;switch(typeof s[u]){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var f;f=Ge.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Ge.escapeForJS(n)+"]=";var p=a[n];""===p&&(p='""'),h+=f+p+";\n"}return Function("o",h)}(this,t),ct(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?w(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},L(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var n=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&qe)},set:function(t){t?this._objFlags|=qe:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),Ke=Ye.prototype;function Qe(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}Ke._deserialize=null,Ke._onPreDestroy=null,Ge.fastDefine("cc.Object",Ye,((je={_name:"",_objFlags:0})[We]={},je)),Ge.Attr.setClassAttr(Ye,We,"editorOnly",!0),Ge.Attr.setClassAttr(Ye,"replicated","visible",!1),ct(Ye,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=Qe,i.Object=Ye;var Ze=kt.fastRemoveAt;function Je(){}var $e=function(){function t(){this.callback=Je,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,n){this.callback=t||Je,this.target=e,this.once=!!n},e.reset=function(){this.target=void 0,this.callback=Je,this.once=!1},e.check=function(){return!(this.target instanceof Ye&&!Qe(this.target,!0))},t}(),tn=new jt((function(){return new $e}),32),en=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),tn.free(n),Ze(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),tn.free(n),Ze(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Ze(this.callbackInfos,t),tn.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),tn.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Ze(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),nn=new jt((function(){return new en}),16),rn=function(){function t(){this._callbackTable=ft(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,n,i){if(!this.hasEventListener(t,e,n)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=nn.alloc());var o=tn.alloc();o.set(e,n,i),r.callbackInfos.push(o)}return e},e.hasEventListener=function(t,e,n){var i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;var r=i.callbackInfos;if(!e){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===e&&s.target===n)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var n=this._callbackTable&&this._callbackTable[t];n&&(n.isInvoking?n.cancelAll():(n.clear(),nn.free(n),delete this._callbackTable[t]))}else if(t)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,n){var i,r=this._callbackTable&&this._callbackTable[t];if(r){var o=r.callbackInfos;if(e)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===e&&s.target===n){r.cancel(a);break}}else this.removeAll(t)}null===(i=this._offCallback)||void 0===i||i.call(this)},e.emit=function(t,e,n,i,r,o){var a=this._callbackTable&&this._callbackTable[t];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var f=h.callback,p=h.target;h.once&&this.off(t,f,p),h.check()?p?f.call(p,e,n,i,r,o):f(e,n,i,r,o):this.off(t,f,p)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),nn.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function on(t){for(var e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._callbackTable=ft(!0),e}F(e,t);var n=e.prototype;return n.once=function(t,e,n){return this.on(t,e,n,!0)},n.targetOff=function(t){this.removeAll(t)},e}(t),n=rn.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in e.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(e.prototype,o,a)}}return e}var an,sn,cn,ln,un,hn,fn=t("EventTarget",on((function(){})));i.EventTarget=fn,function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(an||(an={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(sn||(sn={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(cn||(cn={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(ln||(ln={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(un||(un={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(hn||(hn={}));var pn=new(function(t){function e(){var e,n,i;(i=t.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(t){i._battery=t})),i.networkType=cn.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?un.MOBILE_BROWSER:un.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:sn.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,f=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);f&&(c=!0,u=f[1]||"",h=parseInt(u)||0),(f=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=f[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var p=ln.UNKNOWN;-1!==o.appVersion.indexOf("Win")?p=ln.WINDOWS:l?p=ln.IOS:-1!==o.appVersion.indexOf("Mac")?p=ln.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?p=ln.LINUX:c?p=ln.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(p=ln.LINUX),i.os=p,i.osVersion=u,i.osMainVersion=h,i.browserType=an.UNKNOWN;var _=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=_?_[0].toLowerCase():ln.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=an.ANDROID);var m={micromessenger:an.WECHAT,wechat:an.WECHAT,weixin:an.WECHAT,trident:an.IE,edge:an.EDGE,"360 aphone":an.BROWSER_360,mxbrowser:an.MAXTHON,"opr/":an.OPERA,ubrowser:an.UC,huaweibrowser:an.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(t){x=!0,null==t||t.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,b=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[hn.WEBP]=g,n[hn.IMAGE_BITMAP]=x,n[hn.WEB_VIEW]=!0,n[hn.VIDEO_PLAYER]=!0,n[hn.SAFE_AREA]=!1,n[hn.INPUT_TOUCH]=S,n[hn.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[hn.EVENT_MOUSE]=b,n[hn.EVENT_TOUCH]=S||b,n[hn.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}F(e,t);var n=e.prototype;return n._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,e.emit("hide"))},r=function(t,i,r,o,a){n&&(n=!1,e.emit("show",t,i,r,o,a))};if(t)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(e){var n=document[t];(n=n||e.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(t){return this._featureMap[t]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(t){window.open(t)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},e}(fn)),_n=/(\.[^\.\/\?\\]*)(\?.*)?$/,dn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,mn=/[^\.\/]+\/\.\.\//;function vn(){for(var t="",e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function gn(t){var e=_n.exec(t);return e?e[1]:""}function yn(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function xn(t,e){var n=t.indexOf("?");n>0&&(t=t.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;var r=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function Sn(t){var e=dn.exec(t);return e?e[2]:""}function bn(t,e){e=e||"";var n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),(n=t.lastIndexOf("."))<0?t+e+i:t.substring(0,n)+e+i}function Tn(t,e,n){if(0===e.indexOf("."))return bn(t,e);var i=t.indexOf("?"),r="",o=n?gn(t):"";return i>0&&(r=t.substring(i),t=t.substring(0,i)),i=(i=t.lastIndexOf("/"))<=0?0:i+1,t.substring(0,i)+e+o+r}function En(t){var e=t=String(t);do{e=t,t=t.replace(mn,"")}while(e.length!==t.length);return t}function Cn(t){return t.replace(/[\/\\]$/,"")}function wn(){return pn.os===ln.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:vn,extname:gn,mainFileName:yn,basename:xn,dirname:Sn,changeExtname:bn,changeBasename:Tn,_normalize:En,stripSep:Cn,getSeperator:wn})),i.log=p,i.warn=_,i.error=d,i.assert=m,i._throw=y,i.logID=b,i.warnID=E,i.errorID=w,i.assertID=I,i.debug=M,i.path={join:vn,extname:gn,mainFileName:yn,basename:xn,dirname:Sn,changeExtname:bn,changeBasename:Tn,_normalize:En,stripSep:Cn,get sep(){return wn()}};var An=0,Pn={},In=2147483647;function Rn(t){return(t>0)-(t<0)}function Dn(t){var e,n;return e=(t>65535)<<4,e|=n=((t>>>=e)>255)<<3,e|=n=((t>>>=n)>15)<<2,(e|=n=((t>>>=n)>3)<<1)|(t>>>=n)>>1}function On(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function Mn(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}var Nn=new Array(256);!function(t){for(var e=0;e<256;++e){var n=e,i=e,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;t[e]=i<<r&255}}(Nn);var Ln=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:In,INT_MIN:-2147483648,sign:Rn,abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:Dn,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:On,nextPow2:Mn,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return Nn[255&t]<<24|Nn[t>>>8&255]<<16|Nn[t>>>16&255]<<8|Nn[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>On(t)+1}});t("bits",Ln);var Bn,Fn,zn,Un,kn,Gn,Hn=10,Vn=0,jn=new Map;Un=function(t,e,n,i,r,o,a){var s=jn.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,n+"."+i),s.count++)},Bn=t("replaceProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=Vn++;jn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Hn});var r=null!=n.target?n.target:t,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:e,s=r===t,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)t[n.name]=function(){var t;return Un(e,n.name,a,o,_,i,c),(t=n.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(t,n.name,{get:function(){return Un(e,n.name,a,o,_,i,c),n.customGetter.call(this)},set:function(t){Un(e,n.name,a,o,_,i,c),n.customSetter.call(this,t)},enumerable:!1}):l?Object.defineProperty(t,n.name,{set:function(t){Un(e,n.name,a,o,_,i,c),n.customSetter.call(this,t)},enumerable:!1}):u&&Object.defineProperty(t,n.name,{get:function(){return Un(e,n.name,a,o,_,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get:function(){return Un(e,n.name,a,o,_,i,c),s?this[o]:r[o]},set:function(t){Un(e,n.name,a,o,_,i,c),s?this[o]=t:r[o]=t},enumerable:!1})}))})),Gn=function(t,e,n,i,r){var o=jn.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,t+"."+e),o.count++)},Fn=t("removeProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=Vn++;jn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Hn});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(t,n.name,{get:function(){return Gn(e,n.name,d,i,r)},set:function(){Gn(e,n.name,d,i,r)},enumerable:!1})}))})),kn=function(t,e,n,i,r){var o=jn.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,t+"."+e),o.count++)},zn=t("markAsWarning",(function(t,e,n){null!=t&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(t,i);if(r&&r.configurable){var o=Vn++;jn.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:Hn});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;t[i]=function(){return kn(e,i,_,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(t,i,{configurable:!0,get:function(){return kn(e,i,_,o,a),c}}),r.writable&&Object.defineProperty(t,i,{set:function(t){kn(e,i,_,o,a),c=t}})}else!function(e,n,i,r,o,a){if(e.get){var s=e.get;e.get=function(){return kn(n,i,r,o,a),s.call(this)}}if(e.set){var c=e.set;e.set=function(t){kn(n,i,r,o,a),c.call(this,t)}}Object.defineProperty(t,i,e)}(r,e,i,_,o,a);Object.defineProperty(t,i,{enumerable:!1})}}))}));var Wn=Math.PI/180,qn=180/Math.PI,Xn=t("EPSILON",1e-6);function Yn(t,e){return Math.abs(t-e)<=Xn*Math.max(1,Math.abs(t),Math.abs(e))}function Kn(t,e,n){return n=n||Xn,Math.abs(t-e)<=n}function Qn(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t>n?n:t}function Zn(t){return t<0?0:t>1?1:t}function Jn(t,e,n){return t+(e-t)*n}function $n(t){return t*Wn}function ti(t){return t*qn}var ei=t("random",Math.random);function ni(t,e){return Math.random()*(e-t)+t}function ii(t,e){return Math.floor(ni(t,e))}function ri(t){return(t=(9301*t+49297)%233280)/233280}function oi(t,e,n){return ri(t)*(n-e)+e}function ai(t,e,n){return Math.floor(oi(t,e,n))}function si(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function ci(t,e){return t-Math.floor(t/e)*e}function li(t,e){return t=ci(t,2*e),e-Math.abs(t-e)}function ui(t,e,n){return(n-t)/(e-t)}function hi(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function fi(t,e){return Math.abs(t)>Math.abs(e)?t:e}function pi(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var _i=1/255,di=t("Color",function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this)._val=0,"string"==typeof e?o.fromHEX(e):void 0!==n?o.set(e,n,i,r):o.set(e),o}F(e,t),e.clone=function(t){var n=new e;return t._val?n._val=t._val:n._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,n},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,n,i,r){return t.r=e,t.g=n,t.b=i,t.a=r,t},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var n=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(n)?255:n,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t},e.subtract=function(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t},e.multiply=function(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t},e.divide=function(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t},e.scale=function(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t},e.lerp=function(t,e,n,i){var r=e.r,o=e.g,a=e.b,s=e.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,t._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),t},e.toArray=function(t,n,i){void 0===i&&(i=0);var r=n instanceof e||n.a>1?1/255:1;return t[i+0]=n.r*r,t[i+1]=n.g*r,t[i+2]=n.b*r,t[i+3]=n.a*r,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var n=e.prototype;return n.clone=function(){var t=new e;return t._val=this._val,t},n.equals=function(t){return t&&this._val===t._val},n.lerp=function(t,e){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,r+=(t.b-r)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*_i).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},n.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|e),this},n.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",n=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===t&&n.push((this.a<16?e:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(t,e,n){var i=0,r=0,o=0;if(0===e)i=r=o=n;else if(0===n)i=r=o=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),s=t-a,c=n*(1-e),l=n*(1-e*s),u=n*(1-e*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var t=this.r*_i,e=this.g*_i,n=this.b*_i,i={h:0,s:0,v:0},r=Math.max(t,e,n),o=Math.min(t,e,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=t===r?(e-n)/a:e===r?2+(n-t)/a:4+(t-e)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this},n.multiply=function(t){var e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&i|65280&n|255&e,this},n._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},n._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},n._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},n._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},L(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~Qn(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~Qn(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~Qn(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~Qn(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*_i},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*_i},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*_i},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*_i},set:function(t){this.a=255*t}}]),e}(Jt));function mi(t,e,n,i){return new di(t,e,n,i)}di.WHITE=Object.freeze(new di(255,255,255,255)),di.GRAY=Object.freeze(new di(127,127,127,255)),di.BLACK=Object.freeze(new di(0,0,0,255)),di.TRANSPARENT=Object.freeze(new di(0,0,0,0)),di.RED=Object.freeze(new di(255,0,0,255)),di.GREEN=Object.freeze(new di(0,255,0,255)),di.BLUE=Object.freeze(new di(0,0,255,255)),di.CYAN=Object.freeze(new di(0,255,255,255)),di.MAGENTA=Object.freeze(new di(255,0,255,255)),di.YELLOW=Object.freeze(new di(255,255,0,255)),Ge.fastDefine("cc.Color",di,{r:0,g:0,b:0,a:255}),i.Color=di,i.color=mi;var vi=t("Vec3",function(t){function e(e,n,i){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=n||0,r.z=i||0),r}F(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,n,i){return t.x=e,t.y=n,t.z=i,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.sqrt(n*n+i*i+r*r)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r},e.len=function(t){var e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var n=e.x,i=e.y,r=e.z;return Math.abs(n)<Xn?t.x=0:t.x=1/n,Math.abs(i)<Xn?t.y=0:t.y=1/i,Math.abs(r)<Xn?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=r*o),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z;return t.x=r*c-o*s,t.y=o*a-i*c,t.z=i*s-r*a,t},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t},e.random=function(t,e){e=e||1;var n=2*ei()*Math.PI,i=2*ei()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,t.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,t.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,t},e.transformMat4Normal=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o)*a,t.y=(n.m01*i+n.m05*r+n.m09*o)*a,t.z=(n.m02*i+n.m06*r+n.m10*o)*a,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=i*n.m00+r*n.m03+o*n.m06,t.y=i*n.m01+r*n.m04+o*n.m07,t.z=i*n.m02+r*n.m05+o*n.m08,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13,t.x=n.m02*i+n.m06*r+n.m10*o+n.m14,t},e.transformQuat=function(t,e,n){var i=n.w*e.x+n.y*e.z-n.z*e.y,r=n.w*e.y+n.z*e.x-n.x*e.z,o=n.w*e.z+n.x*e.y-n.y*e.x,a=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,t.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,t.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,t},e.transformRTS=function(t,e,n,i,r){var o=e.x*r.x,a=e.y*r.y,s=e.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return t.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,t.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,t.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,t},e.transformInverseRTS=function(t,e,n,i,r){var o=e.x-i.x,a=e.y-i.y,s=e.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return t.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,t.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,t.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,t},e.rotateX=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateY=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateZ=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,n){void 0===n&&(n=Xn);var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},e.angle=function(t,n){e.normalize(gi,t),e.normalize(yi,n);var i=e.dot(gi,yi);return i>1?0:i<-1?Math.PI:Math.acos(i)},e.projectOnPlane=function(t,n,i){return e.subtract(t,n,e.project(t,n,i))},e.project=function(t,n,i){var r=e.lengthSqr(i);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,i,e.dot(n,i)/r)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z)},n.set=function(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this},n.equals=function(t,e){return void 0===e&&(e=Xn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},n.equals3f=function(t,e,n,i){return void 0===i&&(i=Xn),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},n.strictEquals3f=function(t,e,n){return this.x===t&&this.y===e&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.add3f=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subtract3f=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiply3f=function(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divide3f=function(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(t,e){return this.x=Qn(this.x,t.x,e.x),this.y=Qn(this.y,t.y,e.y),this.z=Qn(this.z,t.z,e.z),this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=t.m03*e+t.m07*n+t.m11*i+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*r,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*r,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*r,this},e}(Jt));vi.UNIT_X=Object.freeze(new vi(1,0,0)),vi.UNIT_Y=Object.freeze(new vi(0,1,0)),vi.UNIT_Z=Object.freeze(new vi(0,0,1)),vi.RIGHT=Object.freeze(new vi(1,0,0)),vi.UP=Object.freeze(new vi(0,1,0)),vi.FORWARD=Object.freeze(new vi(0,0,-1)),vi.ZERO=Object.freeze(new vi(0,0,0)),vi.ONE=Object.freeze(new vi(1,1,1)),vi.NEG_ONE=Object.freeze(new vi(-1,-1,-1));var gi=new vi,yi=new vi;function xi(t,e,n){return new vi(t,e,n)}Ge.fastDefine("cc.Vec3",vi,{x:0,y:0,z:0}),i.Vec3=vi,i.v3=xi;var Si=t("Mat3",function(t){function e(e,n,i,r,o,a,s,c,l){var u;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=t.call(this)||this,"object"==typeof e?(u.m00=e.m00,u.m01=e.m01,u.m02=e.m02,u.m03=e.m03,u.m04=e.m04,u.m05=e.m05,u.m06=e.m06,u.m07=e.m07,u.m08=e.m08):(u.m00=e,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}F(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,n,i,r,o,a,s,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=u*a-s*l,f=-u*o+s*c,p=l*o-a*c,_=n*h+i*f+r*p;return 0===_?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(_=1/_,t.m00=h*_,t.m01=(-u*i+r*l)*_,t.m02=(s*i-r*a)*_,t.m03=f*_,t.m04=(u*n-r*c)*_,t.m05=(-s*n+r*o)*_,t.m06=p*_,t.m07=(-l*n+i*c)*_,t.m08=(a*n-i*o)*_,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08;return e*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=n.m00,p=n.m01,_=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return t.m00=f*i+p*a+_*l,t.m01=f*r+p*s+_*u,t.m02=f*o+p*c+_*h,t.m03=d*i+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.multiplyMat4=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=n.m00,p=n.m01,_=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return t.m00=f*i+p*a+_*l,t.m01=f*r+p*s+_*u,t.m02=f*o+p*c+_*h,t.m03=d*i+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.transform=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=n.x,p=n.y;return t.m00=i,t.m01=r,t.m02=o,t.m03=a,t.m04=s,t.m05=c,t.m06=f*i+p*a+l,t.m07=f*r+p*s+u,t.m08=f*o+p*c+h,t},e.scale=function(t,e,n){var i=n.x,r=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=Math.sin(n),p=Math.cos(n);return t.m00=p*i+f*a,t.m01=p*r+f*s,t.m02=p*o+f*c,t.m03=p*a-f*i,t.m04=p*s-f*r,t.m05=p*c-f*o,t.m06=l,t.m07=u,t.m08=h,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,n,i){return vi.lengthSqr(n)<Xn*Xn?(e.identity(t),t):(i=i||vi.UNIT_Y,vi.normalize(bi,vi.cross(bi,i,n)),vi.lengthSqr(bi)<Xn*Xn?(e.identity(t),t):(vi.cross(Ti,n,bi),e.set(t,bi.x,bi.y,bi.z,Ti.x,Ti.y,Ti.z,n.x,n.y,n.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,p=r*s,_=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-_,t.m03=u-v,t.m06=f+m,t.m01=u+v,t.m04=1-l-_,t.m07=p-d,t.m02=f-m,t.m05=p+d,t.m08=1-l-h,t},e.inverseTransposeMat4=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,p=e.m11,_=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,b=i*l-o*s,T=r*l-o*c,E=u*d-h*_,C=u*m-f*_,w=u*v-p*_,A=h*m-f*d,P=h*v-p*d,I=f*v-p*m,R=g*I-y*P+x*A+S*w-b*C+T*E;return R?(R=1/R,t.m00=(s*I-c*P+l*A)*R,t.m01=(c*w-a*I-l*C)*R,t.m02=(a*P-s*w+l*E)*R,t.m03=(r*P-i*I-o*A)*R,t.m04=(n*I-r*w+o*C)*R,t.m05=(i*w-n*P-o*E)*R,t.m06=(d*T-m*b+v*S)*R,t.m07=(m*x-_*T-v*y)*R,t.m08=(_*b-d*x+v*g)*R,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var n=e.prototype;return n.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},n.set=function(t,e,n,i,r,o,a,s,c){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(t,e){return void 0===e&&(e=Xn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},n.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,f=t*l+e*u+n*h;return 0===f?(this.set(0,0,0,0,0,0,0,0,0),this):(f=1/f,this.m00=l*f,this.m01=(-c*e+n*s)*f,this.m02=(o*e-n*r)*f,this.m03=u*f,this.m04=(c*t-n*a)*f,this.m05=(-o*t+n*i)*f,this.m06=h*f,this.m07=(-s*t+e*a)*f,this.m08=(r*t-e*i)*f,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return t*(c*r-o*s)+e*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=t.m00,h=t.m01,f=t.m02,p=t.m03,_=t.m04,d=t.m05,m=t.m06,v=t.m07,g=t.m08;return this.m00=u*e+h*r+f*s,this.m01=u*n+h*o+f*c,this.m02=u*i+h*a+f*l,this.m03=p*e+_*r+d*s,this.m04=p*n+_*o+d*c,this.m05=p*i+_*a+d*l,this.m06=m*e+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},n.scale=function(t){var e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(t),h=Math.cos(t);return this.m00=h*e+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*e,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,f=i*a,p=i*s,_=r*o,d=r*a,m=r*s;return this.m00=1-u-p,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-p,this.m07=f-_,this.m02=h-d,this.m05=f+_,this.m08=1-c-u,this},e}(Jt));Si.IDENTITY=Object.freeze(new Si);var bi=new vi,Ti=new vi;Ge.fastDefine("cc.Mat3",Si,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=Si;var Ei=t("Quat",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}F(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,n,i){var r=vi.dot(n,i);return r<-.999999?(vi.cross(Ai,vi.UNIT_X,n),Ai.length()<1e-6&&vi.cross(Ai,vi.UNIT_Y,n),vi.normalize(Ai,Ai),e.fromAxisAngle(t,Ai,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(vi.cross(Ai,n,i),t.x=Ai.x,t.y=Ai.y,t.z=Ai.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n},e.multiply=function(t,e,n){var i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,r=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,o=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,a=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=r,t.z=o,t.w=a,t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.rotateX=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+c*i,t.y=a*r+s*i,t.z=s*r-a*i,t.w=c*r-o*i,t},e.rotateY=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r-s*i,t.y=a*r+c*i,t.z=s*r+o*i,t.w=c*r-a*i,t},e.rotateZ=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+a*i,t.y=a*r-o*i,t.z=s*r+c*i,t.w=c*r-s*i,t},e.rotateAround=function(t,n,i,r){return e.invert(Ci,n),vi.transformQuat(Ai,i,Ci),e.fromAxisAngle(Ci,Ai,r),e.multiply(t,n,Ci),t},e.rotateAroundLocal=function(t,n,i,r){return e.fromAxisAngle(Ci,i,r),e.multiply(t,n,Ci),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.slerp=function(t,e,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),f=Math.sin(h);r=Math.sin((1-i)*h)/f,o=Math.sin(i*h)/f}else r=1-i,o=i;return t.x=r*e.x+o*a,t.y=r*e.y+o*s,t.z=r*e.z+o*c,t.w=r*e.w+o*l,t},e.sqlerp=function(t,n,i,r,o,a){return e.slerp(Ci,n,o,a),e.slerp(wi,i,r,a),e.slerp(t,Ci,wi,2*a*(1-a)),t},e.invert=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t},e.fromAxes=function(t,n,i,r){return Si.set(Pi,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,Pi))},e.fromViewUp=function(t,n,i){return Si.fromViewUp(Pi,n,i),e.normalize(t,e.fromMat3(t,Pi))},e.fromAxisAngle=function(t,e,n){n*=.5;var i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t},e.fromMat3=function(t,e){var n=e.m00,i=e.m03,r=e.m06,o=e.m01,a=e.m04,s=e.m07,c=e.m02,l=e.m05,u=e.m08,h=n+a+u;if(h>0){var f=.5/Math.sqrt(h+1);t.w=.25/f,t.x=(l-s)*f,t.y=(r-c)*f,t.z=(o-i)*f}else if(n>a&&n>u){var p=2*Math.sqrt(1+n-a-u);t.w=(l-s)/p,t.x=.25*p,t.y=(i+o)/p,t.z=(r+c)/p}else if(a>u){var _=2*Math.sqrt(1+a-n-u);t.w=(r-c)/_,t.x=(i+o)/_,t.y=.25*_,t.z=(s+l)/_}else{var d=2*Math.sqrt(1+u-n-a);t.w=(o-i)/d,t.x=(r+c)/d,t.y=(s+l)/d,t.z=.25*d}return t},e.fromEuler=function(t,e,n,i){e*=Ii,n*=Ii,i*=Ii;var r=Math.sin(e),o=Math.cos(e),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=r*s*l+o*a*c,t.y=o*a*l+r*s*c,t.z=o*s*c-r*a*l,t.w=o*s*l-r*a*c,t},e.fromAngleZ=function(t,e){return e*=Ii,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t},e.toAxisY=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=i*e.x-r*e.w,t.y=1-n*e.x-r*e.z,t.z=r*e.y+n*e.w,t},e.toAxisZ=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=r*e.x-i*e.w,t.y=r*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t},e.toEuler=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=ti(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-ti(2*Math.atan2(i,a)),l=-90;else{var h=i*i,f=r*r,p=o*o;s=ti(Math.atan2(2*i*a-2*r*o,1-2*h-2*p)),c=ti(Math.atan2(2*r*a-2*i*o,1-2*f-2*p)),l=ti(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=s,t.y=c,t.z=l,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(t,e){return void 0===e&&(e=Xn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.getEulerAngles=function(t){return e.toEuler(t,this)},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},n.slerp=function(t,n){return e.slerp(this,this,t,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(Jt));Ei.IDENTITY=Object.freeze(new Ei);var Ci=new Ei,wi=new Ei,Ai=new vi,Pi=new Si,Ii=.5*Math.PI/180;function Ri(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),new Ei(t,e,n,i)}Ge.fastDefine("cc.Quat",Ei,{x:0,y:0,z:0,w:1}),i.Quat=Ei,i.quat=Ri;var Di=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Oi=t("Mat4",function(t){function e(e,n,i,r,o,a,s,c,l,u,h,f,p,_,d,m){var v;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===f&&(f=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=t.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof e?(v.m00=e.m00,v.m01=e.m01,v.m02=e.m02,v.m03=e.m03,v.m04=e.m04,v.m05=e.m05,v.m06=e.m06,v.m07=e.m07,v.m08=e.m08,v.m09=e.m09,v.m10=e.m10,v.m11=e.m11,v.m12=e.m12,v.m13=e.m13,v.m14=e.m14,v.m15=e.m15):(v.m00=e,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=f,v.m12=p,v.m13=_,v.m14=d,v.m15=m),v}F(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d,m){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t.m09=u,t.m10=h,t.m11=f,t.m12=p,t.m13=_,t.m14=d,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m03,o=e.m06,a=e.m07,s=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=o,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=s}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,p=e.m11,_=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,b=i*l-o*s,T=r*l-o*c,E=u*d-h*_,C=u*m-f*_,w=u*v-p*_,A=h*m-f*d,P=h*v-p*d,I=f*v-p*m,R=g*I-y*P+x*A+S*w-b*C+T*E;return 0===R?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(R=1/R,t.m00=(s*I-c*P+l*A)*R,t.m01=(r*P-i*I-o*A)*R,t.m02=(d*T-m*b+v*S)*R,t.m03=(f*b-h*T-p*S)*R,t.m04=(c*w-a*I-l*C)*R,t.m05=(n*I-r*w+o*C)*R,t.m06=(m*x-_*T-v*y)*R,t.m07=(u*T-f*x+p*y)*R,t.m08=(a*P-s*w+l*E)*R,t.m09=(i*w-n*P-o*E)*R,t.m10=(_*b-d*x+v*g)*R,t.m11=(h*x-u*b-p*g)*R,t.m12=(s*C-a*A-c*E)*R,t.m13=(n*A-i*C+r*E)*R,t.m14=(d*y-_*S-m*g)*R,t.m15=(u*S-h*y+f*g)*R,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,f=t.m11,p=t.m12,_=t.m13,d=t.m14,m=t.m15;return(e*a-n*o)*(h*m-f*d)-(e*s-i*o)*(u*m-f*_)+(e*c-r*o)*(u*d-h*_)+(n*s-i*a)*(l*m-f*p)-(n*c-r*a)*(l*d-h*p)+(i*c-r*s)*(l*_-u*p)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,f=e.m09,p=e.m10,_=e.m11,d=e.m12,m=e.m13,v=e.m14,g=e.m15,y=n.m00,x=n.m01,S=n.m02,b=n.m03;return t.m00=y*i+x*s+S*h+b*d,t.m01=y*r+x*c+S*f+b*m,t.m02=y*o+x*l+S*p+b*v,t.m03=y*a+x*u+S*_+b*g,y=n.m04,x=n.m05,S=n.m06,b=n.m07,t.m04=y*i+x*s+S*h+b*d,t.m05=y*r+x*c+S*f+b*m,t.m06=y*o+x*l+S*p+b*v,t.m07=y*a+x*u+S*_+b*g,y=n.m08,x=n.m09,S=n.m10,b=n.m11,t.m08=y*i+x*s+S*h+b*d,t.m09=y*r+x*c+S*f+b*m,t.m10=y*o+x*l+S*p+b*v,t.m11=y*a+x*u+S*_+b*g,y=n.m12,x=n.m13,S=n.m14,b=n.m15,t.m12=y*i+x*s+S*h+b*d,t.m13=y*r+x*c+S*f+b*m,t.m14=y*o+x*l+S*p+b*v,t.m15=y*a+x*u+S*_+b*g,t},e.transform=function(t,e,n){var i=n.x,r=n.y,o=n.z;if(e===t)t.m12=e.m00*i+e.m04*r+e.m08*o+e.m12,t.m13=e.m01*i+e.m05*r+e.m09*o+e.m13,t.m14=e.m02*i+e.m06*r+e.m10*o+e.m14,t.m15=e.m03*i+e.m07*r+e.m11*o+e.m15;else{var a=e.m00,s=e.m01,c=e.m02,l=e.m03,u=e.m04,h=e.m05,f=e.m06,p=e.m07,_=e.m08,d=e.m09,m=e.m10,v=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=s,t.m02=c,t.m03=l,t.m04=u,t.m05=h,t.m06=f,t.m07=p,t.m08=_,t.m09=d,t.m10=m,t.m11=v,t.m12=a*i+u*r+_*o+e.m12,t.m13=s*i+h*r+d*o+e.m13,t.m14=c*i+f*r+m*o+e.m14,t.m15=l*i+p*r+v*o+e.m15}return t},e.translate=function(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t},e.scale=function(t,e,n){var i=n.x,r=n.y,o=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<Xn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=e.m00,f=e.m01,p=e.m02,_=e.m03,d=e.m04,m=e.m05,v=e.m06,g=e.m07,y=e.m08,x=e.m09,S=e.m10,b=e.m11,T=r*r*u+l,E=o*r*u+a*c,C=a*r*u-o*c,w=r*o*u-a*c,A=o*o*u+l,P=a*o*u+r*c,I=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return t.m00=h*T+d*E+y*C,t.m01=f*T+m*E+x*C,t.m02=p*T+v*E+S*C,t.m03=_*T+g*E+b*C,t.m04=h*w+d*A+y*P,t.m05=f*w+m*A+x*P,t.m06=p*w+v*A+S*P,t.m07=_*w+g*A+b*P,t.m08=h*I+d*R+y*D,t.m09=f*I+m*R+x*D,t.m10=p*I+v*R+S*D,t.m11=_*I+g*R+b*D,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,f=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*r+l*i,t.m05=a*r+u*i,t.m06=s*r+h*i,t.m07=c*r+f*i,t.m08=l*r-o*i,t.m09=u*r-a*i,t.m10=h*r-s*i,t.m11=f*r-c*i,t},e.rotateY=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m08,u=e.m09,h=e.m10,f=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r-l*i,t.m01=a*r-u*i,t.m02=s*r-h*i,t.m03=c*r-f*i,t.m08=o*i+l*r,t.m09=a*i+u*r,t.m10=s*i+h*r,t.m11=c*i+f*r,t},e.rotateZ=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m04,u=e.m05,h=e.m06,f=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r+l*i,t.m01=a*r+u*i,t.m02=s*r+h*i,t.m03=c*r+f*i,t.m04=l*r-o*i,t.m05=u*r-a*i,t.m06=h*r-s*i,t.m07=f*r-c*i,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<Xn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=r*i*l+o*s,t.m02=o*i*l-r*s,t.m03=0,t.m04=i*r*l-o*s,t.m05=r*r*l+c,t.m06=o*r*l+i*s,t.m07=0,t.m08=i*o*l+r*s,t.m09=r*o*l-i*s,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,p=r*c,_=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return t.m00=1-(p+d),t.m01=h+g,t.m02=f-v,t.m03=0,t.m04=h-g,t.m05=1-(u+d),t.m06=_+m,t.m07=0,t.m08=f+v,t.m09=_-m,t.m10=1-(u+p),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var n=Ni.m00=e.m00,i=Ni.m01=e.m01,r=Ni.m02=e.m02,o=Ni.m03=e.m04,a=Ni.m04=e.m05,s=Ni.m05=e.m06,c=Ni.m06=e.m08,l=Ni.m07=e.m09,u=Ni.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+r*r),t.y=Math.sqrt(o*o+a*a+s*s),t.z=Math.sqrt(c*c+l*l+u*u),Si.determinant(Ni)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var n=e.m00+e.m05+e.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t},e.toRTS=function(t,e,n,i){i.x=vi.set(Mi,t.m00,t.m01,t.m02).length(),Ni.m00=t.m00/i.x,Ni.m01=t.m01/i.x,Ni.m02=t.m02/i.x,i.y=vi.set(Mi,t.m04,t.m05,t.m06).length(),Ni.m03=t.m04/i.y,Ni.m04=t.m05/i.y,Ni.m05=t.m06/i.y,i.z=vi.set(Mi,t.m08,t.m09,t.m10).length(),Ni.m06=t.m08/i.z,Ni.m07=t.m09/i.z,Ni.m08=t.m10/i.z,Si.determinant(Ni)<0&&(i.x*=-1,Ni.m00*=-1,Ni.m01*=-1,Ni.m02*=-1),Ei.fromMat3(e,Ni),vi.set(n,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=e.w,c=r+r,l=o+o,u=a+a,h=r*c,f=r*l,p=r*u,_=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,b=i.z;return t.m00=(1-(_+m))*x,t.m01=(f+y)*x,t.m02=(p-g)*x,t.m03=0,t.m04=(f-y)*S,t.m05=(1-(h+m))*S,t.m06=(d+v)*S,t.m07=0,t.m08=(p+g)*b,t.m09=(d-v)*b,t.m10=(1-(h+_))*b,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,n,i,r){var o=e.x,a=e.y,s=e.z,c=e.w,l=o+o,u=a+a,h=s+s,f=o*l,p=o*u,_=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,b=i.y,T=i.z,E=r.x,C=r.y,w=r.z;return t.m00=(1-(d+v))*S,t.m01=(p+x)*S,t.m02=(_-y)*S,t.m03=0,t.m04=(p-x)*b,t.m05=(1-(f+v))*b,t.m06=(m+g)*b,t.m07=0,t.m08=(_+y)*T,t.m09=(m-g)*T,t.m10=(1-(f+d))*T,t.m11=0,t.m12=n.x+E-(t.m00*E+t.m04*C+t.m08*w),t.m13=n.y+C-(t.m01*E+t.m05*C+t.m09*w),t.m14=n.z+w-(t.m02*E+t.m06*C+t.m10*w),t.m15=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,p=r*s,_=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-_,t.m01=u+v,t.m02=f-m,t.m03=0,t.m04=u-v,t.m05=1-l-_,t.m06=p+d,t.m07=0,t.m08=f+m,t.m09=p-d,t.m10=1-l-h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,n,i,r,o,a){var s=1/(n-e),c=1/(r-i),l=1/(o-a);return t.m00=2*o*s,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(n+e)*s,t.m09=(r+i)*c,t.m10=(a+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*o*2*l,t.m15=0,t},e.perspective=function(t,e,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(e/2),u=1/(i-r),h=o?l/n:l,f=(o?l:l*n)*s,p=Di[c];return t.m00=h*p[0],t.m01=h*p[1],t.m02=0,t.m03=0,t.m04=f*p[2],t.m05=f*p[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*i)*u,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*i*u*(1-a),t.m15=0,t},e.ortho=function(t,e,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(e-n),h=1/(i-r)*c,f=1/(o-a),p=-2*u,_=-2*h,d=(e+n)*u,m=(r+i)*h,v=Di[l];return t.m00=p*v[0],t.m01=p*v[1],t.m02=0,t.m03=0,t.m04=_*v[2],t.m05=_*v[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=f*(1-s),t.m11=0,t.m12=d*v[0]+m*v[2],t.m13=d*v[1]+m*v[3],t.m14=(o-s*a)*f,t.m15=1,t},e.lookAt=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,f=a-n.z,p=1/Math.sqrt(u*u+h*h+f*f),_=c*(f*=p)-l*(h*=p),d=l*(u*=p)-s*f,m=s*h-c*u,v=h*(m*=p=1/Math.sqrt(_*_+d*d+m*m))-f*(d*=p),g=f*(_*=p)-u*m,y=u*d-h*_;return t.m00=_,t.m01=v,t.m02=u,t.m03=0,t.m04=d,t.m05=g,t.m06=h,t.m07=0,t.m08=m,t.m09=y,t.m10=f,t.m11=0,t.m12=-(_*r+d*o+m*a),t.m13=-(v*r+g*o+y*a),t.m14=-(u*r+h*o+f*a),t.m15=1,t},e.inverseTranspose=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,p=e.m11,_=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,b=i*l-o*s,T=r*l-o*c,E=u*d-h*_,C=u*m-f*_,w=u*v-p*_,A=h*m-f*d,P=h*v-p*d,I=f*v-p*m,R=g*I-y*P+x*A+S*w-b*C+T*E;return R?(R=1/R,t.m00=(s*I-c*P+l*A)*R,t.m01=(c*w-a*I-l*C)*R,t.m02=(a*P-s*w+l*E)*R,t.m03=0,t.m04=(r*P-i*I-o*A)*R,t.m05=(n*I-r*w+o*C)*R,t.m06=(i*w-n*P-o*E)*R,t.m07=0,t.m08=(d*T-m*b+v*S)*R,t.m09=(m*x-_*T-v*y)*R,t.m10=(_*b-d*x+v*g)*R,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var n=e.prototype;return n.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===d&&(d=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=f,this.m13=p,this.m14=_,this.m15=d,this.m00=t),this},n.equals=function(t,e){return void 0===e&&(e=Xn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,p=this.m13,_=this.m14,d=this.m15,m=t*o-e*r,v=t*a-n*r,g=t*s-i*r,y=e*a-n*o,x=e*s-i*o,S=n*s-i*a,b=c*p-l*f,T=c*_-u*f,E=c*d-h*f,C=l*_-u*p,w=l*d-h*p,A=u*d-h*_,P=m*A-v*w+g*C+y*E-x*T+S*b;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(o*A-a*w+s*C)*P,this.m01=(n*w-e*A-i*C)*P,this.m02=(p*S-_*x+d*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*E-r*A-s*T)*P,this.m05=(t*A-n*E+i*T)*P,this.m06=(_*g-f*S-d*v)*P,this.m07=(c*S-u*g+h*v)*P,this.m08=(r*w-o*E+s*b)*P,this.m09=(e*E-t*w-i*b)*P,this.m10=(f*x-p*g+d*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(o*T-r*C-a*b)*P,this.m13=(t*C-e*T+n*b)*P,this.m14=(p*v-f*y-_*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,p=this.m13,_=this.m14,d=this.m15;return(t*o-e*r)*(u*d-h*_)-(t*a-n*r)*(l*d-h*p)+(t*s-i*r)*(l*_-u*p)+(e*a-n*o)*(c*d-h*f)-(e*s-i*o)*(c*_-u*f)+(n*s-i*a)*(c*p-l*f)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,f=this.m11,p=this.m12,_=this.m13,d=this.m14,m=this.m15,v=t.m00,g=t.m01,y=t.m02,x=t.m03;return this.m00=v*e+g*o+y*l+x*p,this.m01=v*n+g*a+y*u+x*_,this.m02=v*i+g*s+y*h+x*d,this.m03=v*r+g*c+y*f+x*m,v=t.m04,g=t.m05,y=t.m06,x=t.m07,this.m04=v*e+g*o+y*l+x*p,this.m05=v*n+g*a+y*u+x*_,this.m06=v*i+g*s+y*h+x*d,this.m07=v*r+g*c+y*f+x*m,v=t.m08,g=t.m09,y=t.m10,x=t.m11,this.m08=v*e+g*o+y*l+x*p,this.m09=v*n+g*a+y*u+x*_,this.m10=v*i+g*s+y*h+x*d,this.m11=v*r+g*c+y*f+x*m,v=t.m12,g=t.m13,y=t.m14,x=t.m15,this.m12=v*e+g*o+y*l+x*p,this.m13=v*n+g*a+y*u+x*_,this.m14=v*i+g*s+y*h+x*d,this.m15=v*r+g*c+y*f+x*m,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},n.translate=function(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},n.scale=function(t){var e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(t,e){var n=e.x,i=e.y,r=e.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<Xn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(t),s=Math.cos(t),c=1-s,l=this.m00,u=this.m01,h=this.m02,f=this.m03,p=this.m04,_=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,b=i*n*c+r*a,T=r*n*c-i*a,E=n*i*c-r*a,C=i*i*c+s,w=r*i*c+n*a,A=n*r*c+i*a,P=i*r*c-n*a,I=r*r*c+s;return this.m00=l*S+p*b+v*T,this.m01=u*S+_*b+g*T,this.m02=h*S+d*b+y*T,this.m03=f*S+m*b+x*T,this.m04=l*E+p*C+v*w,this.m05=u*E+_*C+g*w,this.m06=h*E+d*C+y*w,this.m07=f*E+m*C+x*w,this.m08=l*A+p*P+v*I,this.m09=u*A+_*P+g*I,this.m10=h*A+d*P+y*I,this.m11=f*A+m*P+x*I,this},n.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},n.getScale=function(t){var e=Ni.m00=this.m00,n=Ni.m01=this.m01,i=Ni.m02=this.m02,r=Ni.m03=this.m04,o=Ni.m04=this.m05,a=Ni.m05=this.m06,s=Ni.m06=this.m08,c=Ni.m07=this.m09,l=Ni.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(s*s+c*c+l*l),Si.determinant(Ni)<0&&(t.x*=-1),t},n.getRotation=function(t){var e=this.m00+this.m05+this.m10,n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t},n.fromRTS=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,p=r*c,_=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(p+d))*y,this.m01=(h+g)*y,this.m02=(f-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+d))*x,this.m06=(_+m)*x,this.m07=0,this.m08=(f+v)*S,this.m09=(_-m)*S,this.m10=(1-(u+p))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,f=i*a,p=i*s,_=r*o,d=r*a,m=r*s;return this.m00=1-u-p,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-p,this.m06=f+_,this.m07=0,this.m08=h+d,this.m09=f-_,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(Jt));Oi.IDENTITY=Object.freeze(new Oi);var Mi=new vi,Ni=new Si;function Li(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d){return new Oi(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d)}Ge.fastDefine("cc.Mat4",Oi,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=Oi,i.mat4=Li;var Bi=t("Vec2",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=n||0),i}F(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,n){return t.x=e,t.y=n,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i},e.len=function(t){var e=t.x,n=t.y;return Math.sqrt(e*e+n*n)},e.lengthSqr=function(t){var e=t.x,n=t.y;return e*e+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y;return Math.abs(n)<Xn?t.x=0:t.x=1/n,Math.abs(i)<Xn?t.y=0:t.y=1/i,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,n){return t instanceof vi?(t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,n,i){var r=e.x,o=e.y;return t.x=r+i*(n.x-r),t.y=o+i*(n.y-o),t},e.random=function(t,e){e=e||1;var n=2*ei()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m03*r+n.m06,t.y=n.m01*i+n.m04*r+n.m07,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m04*r+n.m12,t.y=n.m01*i+n.m05*r+n.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,n){e.normalize(Fi,t),e.normalize(zi,n);var i=e.dot(Fi,zi);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y)},n.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},n.equals=function(t,e){return void 0===e&&(e=Xn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},n.equals2f=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},n.strictEquals2f=function(t,e){return this.x===t&&this.y===e},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(t,e){var n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this},n.clampf=function(t,e){return this.x=Qn(this.x,t.x,e.x),this.y=Qn(this.y,t.y,e.y),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this},n.add2f=function(t,e){return this.x+=t,this.y+=e,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},n.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},n.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this},n.divide2f=function(t,e){return this.x/=t,this.y/=e,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(t){return this.x*t.x+this.y*t.y},n.cross=function(t){return this.x*t.y-this.y*t.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var t=this.x,e=this.y,n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(t){var e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(t)/Math.sqrt(e*n);return i=Qn(i,-1,1),Math.acos(i)},n.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},n.rotate=function(t){var e=this.x,n=this.y,i=Math.sin(t),r=Math.cos(t);return this.x=r*e-i*n,this.y=i*e+r*n,this},n.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},n.transformMat4=function(t){var e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this},e}(Jt));Bi.ZERO=Object.freeze(new Bi(0,0)),Bi.ONE=Object.freeze(new Bi(1,1)),Bi.NEG_ONE=Object.freeze(new Bi(-1,-1)),Bi.UNIT_X=Object.freeze(new Bi(1,0)),Bi.UNIT_Y=Object.freeze(new Bi(0,1));var Fi=new Bi,zi=new Bi;function Ui(t,e){return new Bi(t,e)}Ge.fastDefine("cc.Vec2",Bi,{x:0,y:0}),i.Vec2=Bi,i.v2=Ui;var ki=t("Vec4",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=r||0),o}F(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return Math.sqrt(n*n+i*i+r*r+o*o)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return n*n+i*i+r*r+o*o},e.len=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return Math.sqrt(e*e+n*n+i*i+r*r)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return e*e+n*n+i*i+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w;return Math.abs(n)<Xn?t.x=0:t.x=1/n,Math.abs(i)<Xn?t.y=0:t.y=1/i,Math.abs(r)<Xn?t.z=0:t.z=1/r,Math.abs(o)<Xn?t.w=0:t.w=1/o,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a,t.z=r*a,t.w=o*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.random=function(t,e){e=e||1;var n=2*ei()*Math.PI,i=2*ei()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t.w=0,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,t.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,t.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,t.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,t.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,t.w=e.w,t},e.transformQuat=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,p=-a*i-s*r-c*o;return t.x=u*l+p*-a+h*-c-f*-s,t.y=h*l+p*-s+f*-a-u*-c,t.z=f*l+p*-c+u*-s-h*-a,t.w=e.w,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=Xn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this},n.equals=function(t,e){return void 0===e&&(e=Xn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.equals4f=function(t,e,n,i,r){return void 0===r&&(r=Xn),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.strictEquals4f=function(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=r+e*(t.z-r),this.w=o+e*(t.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(t,e){return this.x=Qn(this.x,t.x,e.x),this.y=Qn(this.y,t.y,e.y),this.z=Qn(this.z,t.z,e.z),this.w=Qn(this.w,t.w,e.w),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.add4f=function(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.subtract4f=function(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.multiply4f=function(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},n.divide4f=function(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)},n.lengthSqr=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=this.w,r=t*t+e*e+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*r,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*r,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*r,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*r,this},e}(Jt));function Gi(t,e,n,i){return new ki(t,e,n,i)}ki.ZERO=Object.freeze(new ki(0,0,0,0)),ki.ONE=Object.freeze(new ki(1,1,1,1)),ki.NEG_ONE=Object.freeze(new ki(-1,-1,-1,-1)),Ge.fastDefine("cc.Vec4",ki,{x:0,y:0,z:0,w:0}),i.Vec4=ki,i.v4=Gi,Bn(Bi,"Vec2",[{name:"sub",newName:"subtract",target:Bi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Bi,targetName:"Vec2"},{name:"div",newName:"divide",target:Bi,targetName:"Vec2"},{name:"dist",newName:"distance",target:Bi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Bi,targetName:"Vec2"},{name:"mag",newName:"len",target:Bi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Bi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Bi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Bi,targetName:"Vec2"}]),Bn(Bi.prototype,"Vec2",[{name:"mag",newName:"length",target:Bi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Bi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Bi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Bi.prototype,targetName:"Vec2"}]),Bn(vi,"Vec3",[{name:"sub",newName:"subtract",target:vi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:vi,targetName:"Vec3"},{name:"div",newName:"divide",target:vi,targetName:"Vec3"},{name:"dist",newName:"distance",target:vi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:vi,targetName:"Vec3"},{name:"mag",newName:"len",target:vi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:vi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:vi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:vi,targetName:"Vec3"}]),Bn(vi.prototype,"Vec3",[{name:"mag",newName:"length",target:vi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:vi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:vi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:vi.prototype,targetName:"Vec3"}]),Bn(ki,"Vec4",[{name:"sub",newName:"subtract",target:ki,targetName:"Vec4"},{name:"mul",newName:"multiply",target:ki,targetName:"Vec4"},{name:"div",newName:"divide",target:ki,targetName:"Vec4"},{name:"dist",newName:"distance",target:ki,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:ki,targetName:"Vec4"},{name:"mag",newName:"len",target:ki,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:ki,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ki,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ki,targetName:"Vec4"}]),Bn(ki.prototype,"Vec4",[{name:"mag",newName:"length",target:ki.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:ki.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ki.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ki.prototype,targetName:"Vec4"}]),Bn(Ei,"Quat",[{name:"mag",newName:"len",target:Ei,targetName:"Quat"},{name:"mul",newName:"multiply",target:Ei,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Ei,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Ei,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ei,targetName:"Quat"}]),Bn(Ei.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Ei.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ei.prototype,targetName:"Quat"}]),Bn(di,"Color",[{name:"sub",newName:"subtract",target:di,targetName:"Color"},{name:"mul",newName:"multiply",target:di,targetName:"Color"},{name:"div",newName:"divide",target:di,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:di,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var r=e[1].toString(16);return i.Color.fromHEX(e[0],r)}}]),Bn(Si,"Mat3",[{name:"sub",newName:"subtract",target:Si,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Si,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Si,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Si,targetName:"Mat3"}]),Bn(Si.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Si.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Si.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Si.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Si.prototype,targetName:"Mat3"}]),Bn(Oi,"Mat4",[{name:"sub",newName:"subtract",target:Oi,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Oi,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Oi,targetName:"Mat4"}]),Bn(Oi.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Oi.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Oi.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Oi.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Oi.prototype,targetName:"Mat4"}]);var Hi=t("AffineTransform",function(){function t(t,e,n,i,r,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=o}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,n){var i=e.a,r=e.b,o=e.c,a=e.d,s=e.tx,c=e.ty;t.a=i*n.a+r*n.c,t.b=i*n.b+r*n.d,t.c=o*n.a+a*n.c,t.d=o*n.b+a*n.d,t.tx=s*n.a+c*n.c+n.tx,t.ty=s*n.b+c*n.d+n.ty},t.invert=function(t,e){var n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,n,i){var r,o;void 0===i?(i=n,r=e.x,o=e.y):(r=e,o=n),t.x=i.a*r+i.c*o+i.tx,t.y=i.b*r+i.d*o+i.ty},t.transformSize=function(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height},t.transformRect=function(t,e,n){var i=e.x+e.width,r=e.y+e.height,o=n.a*e.x+n.c*e.y+n.tx,a=n.b*e.x+n.d*e.y+n.ty,s=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*r+n.tx,u=n.b*e.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,f=n.b*i+n.d*r+n.ty,p=Math.min(o,s,l,h),_=Math.max(o,s,l,h),d=Math.min(a,c,u,f),m=Math.max(a,c,u,f);t.x=p,t.y=d,t.width=_-p,t.height=m-d},t.transformObb=function(t,e,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;e.x=a,e.y=s,n.x=c+a,n.y=l+s,t.x=u+a,t.y=h+s,i.x=c+u+a,i.y=l+h+s},t}());i.AffineTransform=Hi;var Vi=t("Size",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.width=e.width,i.height=e.height):(i.width=e||0,i.height=n||0),i}F(e,t),e.lerp=function(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t};var n=e.prototype;return n.clone=function(){return new e(this.width,this.height)},n.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},n.equals=function(t){return this.width===t.width&&this.height===t.height},n.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},L(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(Jt));function ji(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new Vi(t,e)}Vi.ZERO=Object.freeze(new Vi(0,0)),Vi.ONE=Object.freeze(new Vi(1,1)),Ge.fastDefine("cc.Size",Vi,{width:0,height:0}),i.size=ji,i.Size=Vi;var Wi=t("Rect",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=n||0,o.width=i||0,o.height=r||0),o}F(e,t),e.fromMinMax=function(t,e,n){var i=Math.min(e.x,n.x),r=Math.min(e.y,n.y),o=Math.max(e.x,n.x),a=Math.max(e.y,n.y);return t.x=i,t.y=r,t.width=o-i,t.height=a-r,t},e.lerp=function(t,e,n,i){var r=e.x,o=e.y,a=e.width,s=e.height;return t.x=r+(n.x-r)*i,t.y=o+(n.y-o)*i,t.width=a+(n.width-a)*i,t.height=s+(n.height-s)*i,t},e.intersection=function(t,e,n){var i=e.x,r=e.y,o=e.x+e.width,a=e.y+e.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return t.x=Math.max(i,s),t.y=Math.max(r,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(a,u)-t.y,t},e.union=function(t,e,n){var i=e.x,r=e.y,o=e.width,a=e.height,s=n.x,c=n.y,l=n.width,u=n.height;return t.x=Math.min(i,s),t.y=Math.min(r,c),t.width=Math.max(i+o,s+l)-t.x,t.height=Math.max(r+a,c+u)-t.y,t};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.width,this.height)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this},n.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=r+(t.width-r)*e,this.height=o+(t.height-o)*e,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(t){var e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,r=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||r<this.y)},n.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},n.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},n.transformMat4=function(t){var e=this.x,n=this.y,i=e+this.width,r=n+this.height,o=t.m00*e+t.m04*n+t.m12,a=t.m01*e+t.m05*n+t.m13,s=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*r+t.m12,u=t.m01*e+t.m05*r+t.m13,h=t.m00*i+t.m04*r+t.m12,f=t.m01*i+t.m05*r+t.m13,p=Math.min(o,s,l,h),_=Math.max(o,s,l,h),d=Math.min(a,c,u,f),m=Math.max(a,c,u,f);return this.x=p,this.y=d,this.width=_-p,this.height=m-d,this},n.transformMat4ToPoints=function(t,e,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*s+t.m04*a+t.m12,r.y=t.m01*s+t.m05*a+t.m13,n.x=t.m00*o+t.m04*c+t.m12,n.y=t.m01*o+t.m05*c+t.m13,i.x=t.m00*s+t.m04*c+t.m12,i.y=t.m01*s+t.m05*c+t.m13},L(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new Bi(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new Bi(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new Vi(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(Jt));function qi(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),new Wi(t,e,n,i)}Ge.fastDefine("cc.Rect",Wi,{x:0,y:0,width:0,height:0}),i.Rect=Wi,i.rect=qi;var Xi=t("MATH_FLOAT_ARRAY",Float64Array),Yi=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.createFloatArray=function(t){return new Xi(t)},L(e,[{key:"array",get:function(){return this._array}}]),e}(Jt)),Ki=Object.freeze({__proto__:null,bits:Ln,Vec2:Bi,v2:Ui,Vec3:vi,v3:xi,Vec4:ki,v4:Gi,Quat:Ei,quat:Ri,Mat3:Si,Mat4:Oi,mat4:Li,AffineTransform:Hi,Size:Vi,size:ji,Rect:Wi,rect:qi,Color:di,color:mi,EPSILON:Xn,equals:Yn,approx:Kn,clamp:Qn,clamp01:Zn,lerp:Jn,toRadian:$n,toDegree:ti,random:ei,randomRange:ni,randomRangeInt:ii,pseudoRandom:ri,pseudoRandomRange:oi,pseudoRandomRangeInt:ai,nextPow2:si,repeat:ci,pingPong:li,inverseLerp:ui,absMaxComponent:hi,absMax:fi,enumerableProps:pi,MATH_FLOAT_ARRAY:Xi,MathBase:Yi});t("math",Ki);var Qi=function(){function t(){this._groundAlbedoHDR=new ki(.2,.2,.2,1),this._skyColorHDR=new ki(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new ki(.2,.2,.2,1),this._skyColorLDR=new ki(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var e=t.prototype;return e.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},e._destroy=function(){},e.destroy=function(){this._destroy()},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(t){this._mipmapCount=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();Qi.SUN_ILLUM=65e3,Qi.SKY_ILLUM=2e4,i.Ambient=Qi;var Zi=function(){function t(){this._enabled=!1,this._minPos=new vi(0,0,0),this._maxPos=new vi(0,0,0),this._depth=0}var e=t.prototype;return e.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e._destroy=function(){},e.destroy=function(){this._destroy()},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Ji=new vi,$i=new vi,tr=new vi,er=new vi,nr=new vi,ir=new vi,rr=new Array(3),or=new Array(3);function ar(t,e){return vi.dot(e.n,t)-e.d}function sr(t,e,n){return vi.copy(t,e),vi.subtract(nr,n.center,n.halfExtents),vi.add(ir,n.center,n.halfExtents),t.x=t.x<nr.x?nr.x:t.x,t.y=t.y<nr.y?nr.y:t.y,t.z=t.z<nr.z?nr.z:t.z,t.x=t.x>ir.x?ir.x:t.x,t.y=t.y>ir.y?ir.y:t.y,t.z=t.z>ir.z?ir.z:t.z,t}function cr(t,e,n){vi.set(Ji,n.orientation.m00,n.orientation.m01,n.orientation.m02),vi.set($i,n.orientation.m03,n.orientation.m04,n.orientation.m05),vi.set(tr,n.orientation.m06,n.orientation.m07,n.orientation.m08),rr[0]=Ji,rr[1]=$i,rr[2]=tr,or[0]=n.halfExtents.x,or[1]=n.halfExtents.y,or[2]=n.halfExtents.z,vi.subtract(er,e,n.center),vi.set(t,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=vi.dot(er,rr[i]);r>or[i]&&(r=or[i]),r<-or[i]&&(r=-or[i]),t.x+=r*rr[i].x,t.y+=r*rr[i].y,t.z+=r*rr[i].z}return t}var lr=Object.freeze({__proto__:null,point_plane:ar,pt_point_plane:function(t,e,n){var i=ar(e,n);return vi.subtract(t,e,vi.multiplyScalar(t,n.n,i))},pt_point_aabb:sr,pt_point_obb:cr,pt_point_line:function(t,e,n,i){vi.subtract(Ji,n,i);var r=Ji,o=vi.lengthSqr(r);if(0==o)vi.copy(t,n);else{vi.subtract(Ji,e,n);var a=vi.dot(Ji,r)/o;a<0?vi.copy(t,n):a>1?vi.copy(t,i):vi.scaleAndAdd(t,n,r,a)}}}),ur={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},hr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=ur.SHAPE_LINE,this.s=new vi(t,e,n),this.e=new vi(i,r,o)}return t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return vi.copy(t.s,e.s),vi.copy(t.e,e.e),t},t.fromPoints=function(t,e,n){return vi.copy(t.s,e),vi.copy(t.e,n),t},t.set=function(t,e,n,i,r,o,a){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=r,t.e.y=o,t.e.z=a,t},t.len=function(t){return vi.distance(t.s,t.e)},t.prototype.length=function(){return vi.distance(this.s,this.e)},L(t,[{key:"type",get:function(){return this._type}}]),t}(),fr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=ur.SHAPE_RAY,this.o=new vi(t,e,n),this.d=new vi(i,r,o)}return t.create=function(e,n,i,r,o,a){return void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return vi.copy(t.o,e.o),vi.copy(t.d,e.d),t},t.fromPoints=function(t,e,n){return vi.copy(t.o,e),vi.normalize(t.d,vi.subtract(t.d,n,e)),t},t.set=function(t,e,n,i,r,o,a){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=r,t.d.y=o,t.d.z=a,t},t.prototype.computeHit=function(t,e){vi.normalize(t,this.d),vi.scaleAndAdd(t,this.o,t,e)},L(t,[{key:"type",get:function(){return this._type}}]),t}(),pr=new vi,_r=new vi,dr=new vi,mr=new vi;function vr(t){return Math.max(Math.max(t.x,t.y),t.z)}var gr,yr,xr,Sr,br,Tr,Er,Cr,wr,Ar,Pr,Ir,Rr,Dr,Or,Mr,Nr,Lr,Br,Fr,zr,Ur,kr,Gr,Hr,Vr,jr,Wr,qr,Xr,Yr,Kr,Qr,Zr,Jr,$r,to,eo,no,io,ro,oo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new vi(0,0,0),this._radius=0,this._type=void 0,this._type=ur.SHAPE_SPHERE,this._center=new vi(t,e,n),this._radius=i}t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return vi.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,n){return vi.multiplyScalar(t.center,vi.add(pr,e,n),.5),t.radius=.5*vi.subtract(pr,n,e).length(),t},t.set=function(t,e,n,i,r){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){vi.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),vi.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,n,i,r){vi.transformMat4(r.center,this.center,t),r.radius=this.radius*vr(i)},e.translateAndRotate=function(t,e,n){vi.transformMat4(n.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*vr(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),vi.subtract(_r,t,this.center);var e=_r.length();if(e>this.radius){var n=.5*(e-this.radius);this.radius+=n,vi.multiplyScalar(_r,_r,n/e),vi.add(this.center,this.center,_r)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var n=0;n<e;n++)this.mergePoint(t[n])}},e.mergeAABB=function(t){t.getBoundary(dr,mr),this.mergePoint(dr),this.mergePoint(mr)},L(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),ao=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=ur.SHAPE_TRIANGLE,this.a=new vi(t,e,n),this.b=new vi(i,r,o),this.c=new vi(a,s,c)}return t.create=function(e,n,i,r,o,a,s,c,l){return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new t(e,n,i,r,o,a,s,c,l)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return vi.copy(t.a,e.a),vi.copy(t.b,e.b),vi.copy(t.c,e.c),t},t.fromPoints=function(t,e,n,i){return vi.copy(t.a,e),vi.copy(t.b,n),vi.copy(t.c,i),t},t.set=function(t,e,n,i,r,o,a,s,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=r,t.b.y=o,t.b.z=a,t.c.x=s,t.c.y=c,t.c.z=l,t},L(t,[{key:"type",get:function(){return this._type}}]),t}(),so=function(t,e,n){for(var i=0;i<e.length;++i)t.length<=i&&t.push(new n),t[i].copy(e[i]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(gr||(gr={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(yr||(yr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(xr||(xr={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(Sr||(Sr={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=20]="COUNT"}(br||(br={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(Tr||(Tr={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(Er||(Er={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(Cr||(Cr={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(wr||(wr={})),function(t){t[t.NONE=0]="NONE"}(Ar||(Ar={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(Pr||(Pr={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(Ir||(Ir={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Rr||(Rr={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Dr||(Dr={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Or||(Or={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Mr||(Mr={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(Nr||(Nr={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(Lr||(Lr={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Br||(Br={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(Fr||(Fr={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(zr||(zr={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ur||(Ur={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(kr||(kr={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Gr||(Gr={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Hr||(Hr={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Vr||(Vr={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(jr||(jr={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Wr||(Wr={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(qr||(qr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(Xr||(Xr={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Yr||(Yr={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(Kr||(Kr={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(Qr||(Qr={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(Zr||(Zr={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Jr||(Jr={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}($r||($r={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(to||(to={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(eo||(eo={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(no||(no={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(io||(io={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(ro||(ro={}));var co,lo=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),uo=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d,m,v,g,y,x,S){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=1),void 0===_&&(_=0),void 0===d&&(d=0),void 0===m&&(m=new lo),void 0===v&&(v=new lo),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=f,this.uboOffsetAlignment=p,this.maxComputeSharedMemorySize=_,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),ho=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),fo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),po=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.width=t,this.height=e,this.depth=n}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),_o=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),mo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=n,this.layerCount=i}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),vo=function(){function t(t,e,n,i,r){void 0===t&&(t=new _o),void 0===e&&(e=new ho),void 0===n&&(n=new _o),void 0===i&&(i=new ho),void 0===r&&(r=new po),this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),go=function(){function t(t,e,n,i,r,o){void 0===t&&(t=new _o),void 0===e&&(e=new ho),void 0===n&&(n=new po),void 0===i&&(i=new _o),void 0===r&&(r=new ho),void 0===o&&(o=new po),this.srcSubres=t,this.srcOffset=e,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),yo=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=new ho),void 0===i&&(i=new po),void 0===r&&(r=new _o),this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=r}return t.prototype.copy=function(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),xo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),So=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=n,this.w=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),bo=function(){function t(t,e,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=0),this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}return t.prototype.copy=function(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this},t}(),To=function(){function t(t,e,n,i){void 0===t&&(t=null),void 0===e&&(e=Nr.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=t,this.vsyncMode=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),Eo=function(){function t(t){void 0===t&&(t=new bo),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),Co=function(){function t(t,e,n,i,r){void 0===t&&(t=wr.NONE),void 0===e&&(e=Ir.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=Ar.NONE),this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),wo=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===n&&(n=0),this.buffer=t,this.offset=e,this.range=n}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),Ao=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),Po=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),Io=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return so(this.drawInfos,t.drawInfos,Ao),this},t}(),Ro=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=Rr.TEX2D),void 0===e&&(e=Dr.NONE),void 0===n&&(n=Tr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Or.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Mr.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=t,this.usage=e,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),Do=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=null),void 0===e&&(e=Rr.TEX2D),void 0===n&&(n=Tr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),Oo=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=Lr.LINEAR),void 0===e&&(e=Lr.LINEAR),void 0===n&&(n=Lr.NONE),void 0===i&&(i=Br.WRAP),void 0===r&&(r=Br.WRAP),void 0===o&&(o=Br.WRAP),void 0===a&&(a=0),void 0===s&&(s=Fr.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),Mo=function(){function t(t,e,n){void 0===t&&(t=""),void 0===e&&(e=Cr.UNKNOWN),void 0===n&&(n=0),this.name=t,this.type=e,this.count=n}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),No=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.members=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,so(this.members,t.members,Mo),this.count=t.count,this},t}(),Lo=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=Cr.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Bo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Fo=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=Cr.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),zo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=Cr.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=Pr.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Uo=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=Pr.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.count=i,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),ko=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Go=function(){function t(t,e){void 0===t&&(t=Hr.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Ho=function(){function t(t,e,n,i,r,o){void 0===t&&(t=""),void 0===e&&(e=Tr.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=t,this.format=e,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),Vo=function(){function t(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return t.prototype.copy=function(t){return this.name=t.name,so(this.stages,t.stages,Go),so(this.attributes,t.attributes,Ho),so(this.blocks,t.blocks,No),so(this.buffers,t.buffers,Uo),so(this.samplerTextures,t.samplerTextures,Lo),so(this.samplers,t.samplers,Bo),so(this.textures,t.textures,Fo),so(this.images,t.images,zo),so(this.subpassInputs,t.subpassInputs,ko),this},t}(),jo=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}return t.prototype.copy=function(t){return so(this.attributes,t.attributes,Ho),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),Wo=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=Tr.UNKNOWN),void 0===e&&(e=Mr.ONE),void 0===n&&(n=Vr.CLEAR),void 0===i&&(i=jr.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Wr.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),qo=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=Tr.UNKNOWN),void 0===e&&(e=Mr.ONE),void 0===n&&(n=Vr.CLEAR),void 0===i&&(i=jr.STORE),void 0===r&&(r=Vr.CLEAR),void 0===o&&(o=jr.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Wr.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Xo=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=qr.NONE),void 0===s&&(s=qr.NONE),this.inputs=t,this.colors=e,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),Yo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=n,this.dstAccesses=i}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this},t}(),Ko=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=new qo),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=n,this.dependencies=i}return t.prototype.copy=function(t){return so(this.colorAttachments,t.colorAttachments,Wo),this.depthStencilAttachment.copy(t.depthStencilAttachment),so(this.subpasses,t.subpasses,Xo),so(this.dependencies,t.dependencies,Yo),this},t}(),Qo=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.prevAccesses=t,this.nextAccesses=e}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this},t}(),Zo=function(){function t(t,e,n,i,r){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=t,this.nextAccesses=e,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),Jo=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===n&&(n=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),$o=function(){function t(t,e,n,i,r){void 0===t&&(t=-1),void 0===e&&(e=to.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Hr.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),ta=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return so(this.bindings,t.bindings,$o),this},t}(),ea=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),na=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),ia=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return so(this.attributes,t.attributes,Ho),this},t}(),ra=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=io.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),oa=function(){function t(t){void 0===t&&(t=eo.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),aa=function(){function t(t,e,n){void 0===t&&(t=no.OCCLUSION),void 0===e&&(e=65536),void 0===n&&(n=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=n}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),sa=function(t,e,n,i,r,o,a,s){void 0===t&&(t=""),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=Er.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},ca=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),la=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.writeMask=t,this.compareMask=e,this.reference=n}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),ua=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=new xo),void 0===e&&(e=new fo),void 0===n&&(n=new So),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new la),void 0===u&&(u=new la),this.viewport=t,this.scissor=e,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),ha=function(){function t(e){this._objectType=gr.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=t._idTable[gr.UNKNOWN]++,this._typedID=t._idTable[e]++}return L(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}();ha._idTable=Array(gr.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(co||(co={}));var fa=Object.freeze([new sa("UNKNOWN",0,0,Er.NONE,!1,!1,!1,!1),new sa("A8",1,1,Er.UNORM,!0,!1,!1,!1),new sa("L8",1,1,Er.UNORM,!1,!1,!1,!1),new sa("LA8",1,2,Er.UNORM,!0,!1,!1,!1),new sa("R8",1,1,Er.UNORM,!1,!1,!1,!1),new sa("R8SN",1,1,Er.SNORM,!1,!1,!1,!1),new sa("R8UI",1,1,Er.UINT,!1,!1,!1,!1),new sa("R8I",1,1,Er.INT,!1,!1,!1,!1),new sa("R16F",2,1,Er.FLOAT,!1,!1,!1,!1),new sa("R16UI",2,1,Er.UINT,!1,!1,!1,!1),new sa("R16I",2,1,Er.INT,!1,!1,!1,!1),new sa("R32F",4,1,Er.FLOAT,!1,!1,!1,!1),new sa("R32UI",4,1,Er.UINT,!1,!1,!1,!1),new sa("R32I",4,1,Er.INT,!1,!1,!1,!1),new sa("RG8",2,2,Er.UNORM,!1,!1,!1,!1),new sa("RG8SN",2,2,Er.SNORM,!1,!1,!1,!1),new sa("RG8UI",2,2,Er.UINT,!1,!1,!1,!1),new sa("RG8I",2,2,Er.INT,!1,!1,!1,!1),new sa("RG16F",4,2,Er.FLOAT,!1,!1,!1,!1),new sa("RG16UI",4,2,Er.UINT,!1,!1,!1,!1),new sa("RG16I",4,2,Er.INT,!1,!1,!1,!1),new sa("RG32F",8,2,Er.FLOAT,!1,!1,!1,!1),new sa("RG32UI",8,2,Er.UINT,!1,!1,!1,!1),new sa("RG32I",8,2,Er.INT,!1,!1,!1,!1),new sa("RGB8",3,3,Er.UNORM,!1,!1,!1,!1),new sa("SRGB8",3,3,Er.UNORM,!1,!1,!1,!1),new sa("RGB8SN",3,3,Er.SNORM,!1,!1,!1,!1),new sa("RGB8UI",3,3,Er.UINT,!1,!1,!1,!1),new sa("RGB8I",3,3,Er.INT,!1,!1,!1,!1),new sa("RGB16F",6,3,Er.FLOAT,!1,!1,!1,!1),new sa("RGB16UI",6,3,Er.UINT,!1,!1,!1,!1),new sa("RGB16I",6,3,Er.INT,!1,!1,!1,!1),new sa("RGB32F",12,3,Er.FLOAT,!1,!1,!1,!1),new sa("RGB32UI",12,3,Er.UINT,!1,!1,!1,!1),new sa("RGB32I",12,3,Er.INT,!1,!1,!1,!1),new sa("RGBA8",4,4,Er.UNORM,!0,!1,!1,!1),new sa("BGRA8",4,4,Er.UNORM,!0,!1,!1,!1),new sa("SRGB8_A8",4,4,Er.UNORM,!0,!1,!1,!1),new sa("RGBA8SN",4,4,Er.SNORM,!0,!1,!1,!1),new sa("RGBA8UI",4,4,Er.UINT,!0,!1,!1,!1),new sa("RGBA8I",4,4,Er.INT,!0,!1,!1,!1),new sa("RGBA16F",8,4,Er.FLOAT,!0,!1,!1,!1),new sa("RGBA16UI",8,4,Er.UINT,!0,!1,!1,!1),new sa("RGBA16I",8,4,Er.INT,!0,!1,!1,!1),new sa("RGBA32F",16,4,Er.FLOAT,!0,!1,!1,!1),new sa("RGBA32UI",16,4,Er.UINT,!0,!1,!1,!1),new sa("RGBA32I",16,4,Er.INT,!0,!1,!1,!1),new sa("R5G6B5",2,3,Er.UNORM,!1,!1,!1,!1),new sa("R11G11B10F",4,3,Er.FLOAT,!1,!1,!1,!1),new sa("RGB5A1",2,4,Er.UNORM,!0,!1,!1,!1),new sa("RGBA4",2,4,Er.UNORM,!0,!1,!1,!1),new sa("RGB10A2",2,4,Er.UNORM,!0,!1,!1,!1),new sa("RGB10A2UI",2,4,Er.UINT,!0,!1,!1,!1),new sa("RGB9E5",2,4,Er.FLOAT,!0,!1,!1,!1),new sa("DEPTH",4,1,Er.FLOAT,!1,!0,!1,!1),new sa("DEPTH_STENCIL",5,2,Er.FLOAT,!1,!0,!0,!1),new sa("BC1",1,3,Er.UNORM,!1,!1,!1,!0),new sa("BC1_ALPHA",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC1_SRGB",1,3,Er.UNORM,!1,!1,!1,!0),new sa("BC1_SRGB_ALPHA",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC2",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC2_SRGB",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC3",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC3_SRGB",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC4",1,1,Er.UNORM,!1,!1,!1,!0),new sa("BC4_SNORM",1,1,Er.SNORM,!1,!1,!1,!0),new sa("BC5",1,2,Er.UNORM,!1,!1,!1,!0),new sa("BC5_SNORM",1,2,Er.SNORM,!1,!1,!1,!0),new sa("BC6H_UF16",1,3,Er.UFLOAT,!1,!1,!1,!0),new sa("BC6H_SF16",1,3,Er.FLOAT,!1,!1,!1,!0),new sa("BC7",1,4,Er.UNORM,!0,!1,!1,!0),new sa("BC7_SRGB",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ETC_RGB8",1,3,Er.UNORM,!1,!1,!1,!0),new sa("ETC2_RGB8",1,3,Er.UNORM,!1,!1,!1,!0),new sa("ETC2_SRGB8",1,3,Er.UNORM,!1,!1,!1,!0),new sa("ETC2_RGB8_A1",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ETC2_SRGB8_A1",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ETC2_RGBA8",2,4,Er.UNORM,!0,!1,!1,!0),new sa("ETC2_SRGB8_A8",2,4,Er.UNORM,!0,!1,!1,!0),new sa("EAC_R11",1,1,Er.UNORM,!1,!1,!1,!0),new sa("EAC_R11SN",1,1,Er.SNORM,!1,!1,!1,!0),new sa("EAC_RG11",2,2,Er.UNORM,!1,!1,!1,!0),new sa("EAC_RG11SN",2,2,Er.SNORM,!1,!1,!1,!0),new sa("PVRTC_RGB2",2,3,Er.UNORM,!1,!1,!1,!0),new sa("PVRTC_RGBA2",2,4,Er.UNORM,!0,!1,!1,!0),new sa("PVRTC_RGB4",2,3,Er.UNORM,!1,!1,!1,!0),new sa("PVRTC_RGBA4",2,4,Er.UNORM,!0,!1,!1,!0),new sa("PVRTC2_2BPP",2,4,Er.UNORM,!0,!1,!1,!0),new sa("PVRTC2_4BPP",2,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_4x4",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_5x4",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_5x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_6x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_6x6",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_8x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_8x6",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_8x8",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_10x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_10x6",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_10x8",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_10x10",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_12x10",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_RGBA_12x12",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_4x4",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_5x4",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_5x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_6x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_6x6",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_8x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_8x6",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_8x8",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_10x5",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_10x6",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_10x8",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_10x10",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_12x10",1,4,Er.UNORM,!0,!1,!1,!0),new sa("ASTC_SRGBA_12x12",1,4,Er.UNORM,!0,!1,!1,!0)]),pa=to.UNIFORM_BUFFER|to.DYNAMIC_UNIFORM_BUFFER|to.STORAGE_BUFFER|to.DYNAMIC_STORAGE_BUFFER,_a=to.SAMPLER_TEXTURE|to.SAMPLER|to.TEXTURE|to.STORAGE_IMAGE|to.INPUT_ATTACHMENT,da=to.DYNAMIC_STORAGE_BUFFER|to.DYNAMIC_UNIFORM_BUFFER,ma=28;function va(t){return t>0&&0==(t&t-1)}function ga(t,e,n,i){if(!fa[t].isCompressed)return e*n*i*fa[t].size;switch(t){case Tr.BC1:case Tr.BC1_ALPHA:case Tr.BC1_SRGB:case Tr.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case Tr.BC2:case Tr.BC2_SRGB:case Tr.BC3:case Tr.BC3_SRGB:case Tr.BC4:case Tr.BC4_SNORM:case Tr.BC6H_SF16:case Tr.BC6H_UF16:case Tr.BC7:case Tr.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Tr.BC5:case Tr.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case Tr.ETC_RGB8:case Tr.ETC2_RGB8:case Tr.ETC2_SRGB8:case Tr.ETC2_RGB8_A1:case Tr.EAC_R11:case Tr.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case Tr.ETC2_RGBA8:case Tr.ETC2_SRGB8_A1:case Tr.EAC_RG11:case Tr.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Tr.PVRTC_RGB2:case Tr.PVRTC_RGBA2:case Tr.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case Tr.PVRTC_RGB4:case Tr.PVRTC_RGBA4:case Tr.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case Tr.ASTC_RGBA_4X4:case Tr.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Tr.ASTC_RGBA_5X4:case Tr.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case Tr.ASTC_RGBA_5X5:case Tr.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_6X5:case Tr.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_6X6:case Tr.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case Tr.ASTC_RGBA_8X5:case Tr.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_8X6:case Tr.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case Tr.ASTC_RGBA_8X8:case Tr.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case Tr.ASTC_RGBA_10X5:case Tr.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case Tr.ASTC_RGBA_10X6:case Tr.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case Tr.ASTC_RGBA_10X8:case Tr.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case Tr.ASTC_RGBA_10X10:case Tr.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case Tr.ASTC_RGBA_12X10:case Tr.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case Tr.ASTC_RGBA_12X12:case Tr.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function ya(t,e,n,i,r){for(var o=0,a=0;a<r;++a)o+=ga(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return o}var xa=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Sa(t){return xa[t]||0}function ba(t){var e=t.size/t.count;switch(t.type){case Er.UNORM:case Er.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Er.SNORM:case Er.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Er.FLOAT:return Float32Array}return Float32Array}var Ta=Object.freeze({__proto__:null,get ObjectType(){return gr},get Status(){return yr},get API(){return xr},get SurfaceTransform(){return Sr},get Feature(){return br},get Format(){return Tr},get FormatType(){return Er},get Type(){return Cr},get BufferUsageBit(){return wr},get BufferFlagBit(){return Ar},get MemoryAccessBit(){return Pr},get MemoryUsageBit(){return Ir},get TextureType(){return Rr},get TextureUsageBit(){return Dr},get TextureFlagBit(){return Or},get SampleCount(){return Mr},get VsyncMode(){return Nr},get Filter(){return Lr},get Address(){return Br},get ComparisonFunc(){return Fr},get StencilOp(){return zr},get BlendFactor(){return Ur},get BlendOp(){return kr},get ColorMask(){return Gr},get ShaderStageFlagBit(){return Hr},get LoadOp(){return Vr},get StoreOp(){return jr},get AccessType(){return Wr},get ResolveMode(){return qr},get PipelineBindPoint(){return Xr},get PrimitiveMode(){return Yr},get PolygonMode(){return Kr},get ShadeModel(){return Qr},get CullMode(){return Zr},get DynamicStateFlagBit(){return Jr},get StencilFace(){return $r},get DescriptorType(){return to},get QueueType(){return eo},get QueryType(){return no},get CommandBufferType(){return io},get ClearFlagBit(){return ro},Size:lo,DeviceCaps:uo,Offset:ho,Rect:fo,Extent:po,TextureSubresLayers:_o,TextureSubresRange:mo,TextureCopy:vo,TextureBlit:go,BufferTextureCopy:yo,Viewport:xo,Color:So,BindingMappingInfo:bo,SwapchainInfo:To,DeviceInfo:Eo,BufferInfo:Co,BufferViewInfo:wo,DrawInfo:Ao,DispatchInfo:Po,IndirectBuffer:Io,TextureInfo:Ro,TextureViewInfo:Do,SamplerInfo:Oo,Uniform:Mo,UniformBlock:No,UniformSamplerTexture:Lo,UniformSampler:Bo,UniformTexture:Fo,UniformStorageImage:zo,UniformStorageBuffer:Uo,UniformInputAttachment:ko,ShaderStage:Go,Attribute:Ho,ShaderInfo:Vo,InputAssemblerInfo:jo,ColorAttachment:Wo,DepthStencilAttachment:qo,SubpassInfo:Xo,SubpassDependency:Yo,RenderPassInfo:Ko,GlobalBarrierInfo:Qo,TextureBarrierInfo:Zo,FramebufferInfo:Jo,DescriptorSetLayoutBinding:$o,DescriptorSetLayoutInfo:ta,DescriptorSetInfo:ea,PipelineLayoutInfo:na,InputState:ia,CommandBufferInfo:ra,QueueInfo:oa,QueryPoolInfo:aa,FormatInfo:sa,MemoryStatus:ca,DynamicStencilStates:la,DynamicStates:ua,GFXObject:ha,get AttributeName(){return co},FormatInfos:fa,DESCRIPTOR_BUFFER_TYPE:pa,DESCRIPTOR_SAMPLER_TYPE:_a,DESCRIPTOR_DYNAMIC_TYPE:da,DRAW_INFO_SIZE:ma,IsPowerOf2:va,FormatSize:ga,FormatSurfaceSize:ya,GetTypeSize:Sa,getTypedArrayConstructor:ba}),Ea=function(t){function e(){var e;return(e=t.call(this,gr.BUFFER)||this)._usage=wr.NONE,e._memUsage=Ir.NONE,e._size=0,e._stride=1,e._count=0,e._flags=Ar.NONE,e._isBufferView=!1,e}return F(e,t),L(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(ha),Ca=function(t){function e(){var e;return(e=t.call(this,gr.COMMAND_BUFFER)||this)._queue=null,e._type=io.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return F(e,t),L(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(ha),wa=function(){function t(){this._gfxAPI=xr.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(br.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ca,this._caps=new uo,this._bindingMappingInfo=new bo,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return t.prototype.hasFeature=function(t){return this._features[t]},L(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();wa.canvas=void 0;var Aa=function(t){function e(){var e;return(e=t.call(this,gr.SWAPCHAIN)||this)._transform=Sr.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return F(e,t),L(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(ha),Pa=function(t){function e(){var e;return(e=t.call(this,gr.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return F(e,t),L(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(ha),Ia=String.prototype.charCodeAt;function Ra(t){return this[t]}function Da(t,e){for(var n=t.length,i=e^n,r=0,o="string"==typeof t?Ia:Ra;n>=4;){var a=255&o.call(t,r)|(255&o.call(t,++r))<<8|(255&o.call(t,++r))<<16|(255&o.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(t,r+2))<<16;case 2:i^=(255&o.call(t,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(t,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Oa=function(t){function e(){var e;return(e=t.call(this,gr.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new Ao,e}F(e,t);var n=e.prototype;return n.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},n.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var n=this.attributes[e];t+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return Da(t,666)},L(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo}}]),e}(ha),Ma=function(t){function e(){var e;return(e=t.call(this,gr.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}F(e,t);var n=e.prototype;return n.bindBuffer=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&pa){var o=this._layout.descriptorIndices[t];this._buffers[o+n]!==e&&(this._buffers[o+n]=e,this._isDirty=!0)}},n.bindSampler=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&_a){var o=this._layout.descriptorIndices[t];this._samplers[o+n]!==e&&(this._samplers[o+n]=e,this._isDirty=!0)}},n.bindTexture=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&_a){var o=this._layout.descriptorIndices[t];this._textures[o+n]!==e&&(this._textures[o+n]=e,this._isDirty=!0)}},n.getBuffer=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._buffers[n+e]},n.getSampler=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._samplers[n+e]},n.getTexture=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._textures[n+e]},L(e,[{key:"layout",get:function(){return this._layout}}]),e}(ha),Na=function(t){function e(){var e;return(e=t.call(this,gr.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return F(e,t),L(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(ha),La=function(t){function e(){var e;return(e=t.call(this,gr.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return F(e,t),L(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(ha),Ba=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h){void 0===t&&(t=!1),void 0===e&&(e=Kr.FILL),void 0===n&&(n=Qr.GOURAND),void 0===i&&(i=Zr.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=Kr.FILL,this.shadeModel=Qr.GOURAND,this.cullMode=Zr.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},L(t,[{key:"native",get:function(){return this}}]),t}(),Fa=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d,m,v,g){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===n&&(n=Fr.LESS),void 0===i&&(i=!1),void 0===r&&(r=Fr.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=zr.KEEP),void 0===c&&(c=zr.KEEP),void 0===l&&(l=zr.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===f&&(f=Fr.ALWAYS),void 0===p&&(p=65535),void 0===_&&(_=65535),void 0===d&&(d=zr.KEEP),void 0===m&&(m=zr.KEEP),void 0===v&&(v=zr.KEEP),void 0===g&&(g=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=f,this.stencilReadMaskBack=p,this.stencilWriteMaskBack=_,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Fr.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Fr.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=zr.KEEP,this.stencilZFailOpFront=zr.KEEP,this.stencilPassOpFront=zr.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Fr.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=zr.KEEP,this.stencilZFailOpBack=zr.KEEP,this.stencilPassOpBack=zr.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},L(t,[{key:"native",get:function(){return this}}]),t}(),za=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=!1),void 0===e&&(e=Ur.ONE),void 0===n&&(n=Ur.ZERO),void 0===i&&(i=kr.ADD),void 0===r&&(r=Ur.ONE),void 0===o&&(o=Ur.ZERO),void 0===a&&(a=kr.ADD),void 0===s&&(s=Gr.ALL),this.blend=t,this.blendSrc=e,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=Ur.ONE,this.blendDst=Ur.ZERO,this.blendEq=kr.ADD,this.blendSrcAlpha=Ur.ONE,this.blendDstAlpha=Ur.ZERO,this.blendAlphaEq=kr.ADD,this.blendColorMask=Gr.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),Ua=function(){function t(t,e,n,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===n&&(n=new So),void 0===i&&(i=[new za]),this.isA2C=t,this.isIndepend=e,this.blendColor=n,this.targets=i}var e=t.prototype;return e.setTarget=function(t,e){var n=this.targets[t];n||(n=this.targets[t]=new za),Object.assign(n,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},L(t,[{key:"native",get:function(){return this}}]),t}(),ka=function(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),void 0===i&&(i=new ia),void 0===r&&(r=new Ba),void 0===o&&(o=new Fa),void 0===a&&(a=new Ua),void 0===s&&(s=Yr.TRIANGLE_LIST),void 0===c&&(c=Jr.NONE),void 0===l&&(l=Xr.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Ga=function(t){function e(){var e;return(e=t.call(this,gr.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=Yr.TRIANGLE_LIST,e._is=null,e._rs=new Ba,e._dss=new Fa,e._bs=new Ua,e._dynamicStates=Jr.NONE,e._renderPass=null,e}return F(e,t),L(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(ha),Ha=function(t){function e(){var e;return(e=t.call(this,gr.QUEUE)||this)._type=eo.GRAPHICS,e}return F(e,t),L(e,[{key:"type",get:function(){return this._type}}]),e}(ha),Va=function(t){function e(){var e;return(e=t.call(this,gr.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return F(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var n=this._subpasses[e];if(n.inputs.length){t+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];t+=","+r.format+","+r.sampleCount}}if(n.colors.length){t+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];t+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];t+="ds,"+s.format+","+s.sampleCount}}else{t+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];t+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(t+="ds,"+u.format+","+u.sampleCount)}return Da(t,666)},L(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(ha),ja=function(t){function e(e,n){var i;return(i=t.call(this,gr.SAMPLER)||this)._info=new Oo,i._hash=0,i._info.copy(e),i._hash=n,i}return F(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new Oo;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},L(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(ha),Wa=function(t){function e(){var e;return(e=t.call(this,gr.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return F(e,t),L(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(ha),qa=function(t){function e(){var e;return(e=t.call(this,gr.TEXTURE)||this)._type=Rr.TEX2D,e._usage=Dr.NONE,e._format=Tr.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=Mr.ONE,e._flags=Or.NONE,e._isPowerOf2=!1,e._size=0,e}return F(e,t),L(e,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),e}(ha),Xa=function(t){function e(e,n){var i;return(i=t.call(this,gr.GLOBAL_BARRIER)||this)._info=new Qo,i._hash=0,i._info.copy(e),i._hash=n,i}return F(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return Da(e,666)},L(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(ha),Ya=function(t){function e(e,n){var i;return(i=t.call(this,gr.TEXTURE_BARRIER)||this)._info=new Zo,i._hash=0,i._info.copy(e),i._hash=n,i}return F(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,Da(e+=t.dstQueue?t.dstQueue.type:0,666)},L(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(ha),Ka={Device:wa,Swapchain:Aa,Buffer:Ea,Texture:qa,Sampler:ja,Shader:Wa,InputAssembler:Oa,RenderPass:Va,Framebuffer:Pa,DescriptorSet:Ma,DescriptorSetLayout:Na,PipelineLayout:La,PipelineState:Ga,CommandBuffer:Ca,Queue:Ha,GlobalBarrier:Xa,TextureBarrier:Ya,RasterizerState:Ba,BlendState:Ua,BlendTarget:za,DepthStencilState:Fa,PipelineStateInfo:ka};Object.assign(Ka,Ta),i.gfx=Ka;var Qa,Za={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var Ja in i.gfx)if("__esModule"!==Ja){var $a=Za[Ja];""===$a?$a=Ja:void 0===$a&&($a="GFX"+Ja),Bn(i,"cc",[{name:$a,newName:Ja,target:i.gfx,targetName:"cc.gfx"}])}t("gfx",Object.freeze({__proto__:null,DescriptorSet:Ma,Buffer:Ea,CommandBuffer:Ca,get ObjectType(){return gr},get Status(){return yr},get API(){return xr},get SurfaceTransform(){return Sr},get Feature(){return br},get Format(){return Tr},get FormatType(){return Er},get Type(){return Cr},get BufferUsageBit(){return wr},get BufferFlagBit(){return Ar},get MemoryAccessBit(){return Pr},get MemoryUsageBit(){return Ir},get TextureType(){return Rr},get TextureUsageBit(){return Dr},get TextureFlagBit(){return Or},get SampleCount(){return Mr},get VsyncMode(){return Nr},get Filter(){return Lr},get Address(){return Br},get ComparisonFunc(){return Fr},get StencilOp(){return zr},get BlendFactor(){return Ur},get BlendOp(){return kr},get ColorMask(){return Gr},get ShaderStageFlagBit(){return Hr},get LoadOp(){return Vr},get StoreOp(){return jr},get AccessType(){return Wr},get ResolveMode(){return qr},get PipelineBindPoint(){return Xr},get PrimitiveMode(){return Yr},get PolygonMode(){return Kr},get ShadeModel(){return Qr},get CullMode(){return Zr},get DynamicStateFlagBit(){return Jr},get StencilFace(){return $r},get DescriptorType(){return to},get QueueType(){return eo},get QueryType(){return no},get CommandBufferType(){return io},get ClearFlagBit(){return ro},Size:lo,DeviceCaps:uo,Offset:ho,Rect:fo,Extent:po,TextureSubresLayers:_o,TextureSubresRange:mo,TextureCopy:vo,TextureBlit:go,BufferTextureCopy:yo,Viewport:xo,Color:So,BindingMappingInfo:bo,SwapchainInfo:To,DeviceInfo:Eo,BufferInfo:Co,BufferViewInfo:wo,DrawInfo:Ao,DispatchInfo:Po,IndirectBuffer:Io,TextureInfo:Ro,TextureViewInfo:Do,SamplerInfo:Oo,Uniform:Mo,UniformBlock:No,UniformSamplerTexture:Lo,UniformSampler:Bo,UniformTexture:Fo,UniformStorageImage:zo,UniformStorageBuffer:Uo,UniformInputAttachment:ko,ShaderStage:Go,Attribute:Ho,ShaderInfo:Vo,InputAssemblerInfo:jo,ColorAttachment:Wo,DepthStencilAttachment:qo,SubpassInfo:Xo,SubpassDependency:Yo,RenderPassInfo:Ko,GlobalBarrierInfo:Qo,TextureBarrierInfo:Zo,FramebufferInfo:Jo,DescriptorSetLayoutBinding:$o,DescriptorSetLayoutInfo:ta,DescriptorSetInfo:ea,PipelineLayoutInfo:na,InputState:ia,CommandBufferInfo:ra,QueueInfo:oa,QueryPoolInfo:aa,FormatInfo:sa,MemoryStatus:ca,DynamicStencilStates:la,DynamicStates:ua,GFXObject:ha,get AttributeName(){return co},FormatInfos:fa,DESCRIPTOR_BUFFER_TYPE:pa,DESCRIPTOR_SAMPLER_TYPE:_a,DESCRIPTOR_DYNAMIC_TYPE:da,DRAW_INFO_SIZE:ma,IsPowerOf2:va,FormatSize:ga,FormatSurfaceSize:ya,GetTypeSize:Sa,getTypedArrayConstructor:ba,Device:wa,Swapchain:Aa,Framebuffer:Pa,InputAssembler:Oa,DescriptorSetLayout:Na,PipelineLayout:La,RasterizerState:Ba,DepthStencilState:Fa,BlendTarget:za,BlendState:Ua,PipelineStateInfo:ka,PipelineState:Ga,Queue:Ha,RenderPass:Va,Sampler:ja,Shader:Wa,Texture:qa,GlobalBarrier:Xa,TextureBarrier:Ya})),function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(Qa||(Qa={}));var ts,es,ns,is,rs,os,as,ss,cs=(ts=new vi(0,0,0),function(t,e){var n=vi.dot(t.d,e.n);if(Math.abs(n)<Number.EPSILON)return 0;vi.multiplyScalar(ts,e.n,e.d);var i=vi.dot(vi.subtract(ts,ts,t.o),e.n)/n;return i<0?0:i}),ls=(es=new vi(0,0,0),ns=new vi(0,0,0),is=new vi(0,0,0),rs=new vi(0,0,0),os=new vi(0,0,0),function(t,e,n){vi.subtract(es,e.b,e.a),vi.subtract(ns,e.c,e.a),vi.cross(is,t.d,ns);var i=vi.dot(es,is);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;vi.subtract(rs,t.o,e.a);var o=vi.dot(rs,is)*r;if(o<0||o>1)return 0;vi.cross(os,rs,es);var a=vi.dot(t.d,os)*r;if(a<0||o+a>1)return 0;var s=vi.dot(ns,os)*r;return s<0?0:s}),us=function(){var t=new vi(0,0,0);return function(e,n){var i=n.radius,r=n.center,o=e.o,a=e.d,s=i*i;vi.subtract(t,r,o);var c=t.lengthSqr(),l=vi.dot(t,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),f=c<s?l+h:l-h;return f<0?0:f}}(),hs=(as=new vi,ss=new vi,function(t,e){return vi.subtract(as,e.center,e.halfExtents),vi.add(ss,e.center,e.halfExtents),fs(t,as,ss)});function fs(t,e,n){var i=t.o,r=t.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(e.x-i.x)*o,l=(n.x-i.x)*o,u=(e.y-i.y)*a,h=(n.y-i.y)*a,f=(e.z-i.z)*s,p=(n.z-i.z)*s,_=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(f,p)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(f,p));return d<0||_>d?0:_>0?_:d}var ps,_s,ds,ms,vs=function(){var t=new vi,e=new vi,n=new vi,i=new vi,r=new vi,o=new vi,a=new vi,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,f){s[0]=f.halfExtents.x,s[1]=f.halfExtents.y,s[2]=f.halfExtents.z,t=f.center,e=h.o,n=h.d,vi.set(i,f.orientation.m00,f.orientation.m01,f.orientation.m02),vi.set(r,f.orientation.m03,f.orientation.m04,f.orientation.m05),vi.set(o,f.orientation.m06,f.orientation.m07,f.orientation.m08),vi.subtract(a,t,e),c[0]=vi.dot(i,n),c[1]=vi.dot(r,n),c[2]=vi.dot(o,n),l[0]=vi.dot(i,a),l[1]=vi.dot(r,a),l[2]=vi.dot(o,a);for(var p=0;p<3;++p){if(0===c[p]){if(-l[p]-s[p]>0||-l[p]+s[p]<0)return 0;c[p]=1e-7}u[2*p+0]=(l[p]+s[p])/c[p],u[2*p+1]=(l[p]-s[p])/c[p]}var _=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||_>d?0:_>0?_:d}}(),gs=function(){var t=new vi,e=new vi,n=new vi,i=new vi,r=new vi,o=new vi,a=new vi,s=new oo;return function(c,l){var u=l.radius*l.radius,h=vi.normalize(t,c.d),f=l.ellipseCenter0,p=l.ellipseCenter1,_=vi.subtract(e,p,f);if(_.equals(vi.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),nc.raySphere(c,s);var d=c.o,m=vi.subtract(n,d,f),v=vi.cross(i,h,_),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=vi.subtract(r,p,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),nc.raySphere(c,s)}var x=vi.cross(r,m,_),S=_.lengthSqr(),b=2*vi.dot(v,x),T=b*b-4*g*(x.lengthSqr()-u*S);if(T<0)return 0;var E=(-b-Math.sqrt(T))/(2*g);if(E<0){s.radius=l.radius;var C=vi.subtract(o,p,d);return m.lengthSqr()<C.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),nc.raySphere(c,s)}var w=vi.scaleAndAdd(o,c.o,h,E),A=vi.subtract(a,w,f),P=vi.dot(A,_)/S;return P>=0&&P<=1?E:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),nc.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),nc.raySphere(c,s)):0}}(),ys=(ps=ao.create(),_s={distance:1/0,doubleSided:!1,mode:Qa.ANY},ds=0,ms=function(t,e,n,i,r,o){t===Qa.CLOSEST?(ds>e||0===ds)&&(ds=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(ds=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(t,e,n){if(ds=0,0===e.geometricInfo.positions.length)return ds;var i=void 0===n?_s:n;if(fs(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,o=e.geometricInfo;!function(t,e,n,i,r){if(n===Yr.TRIANGLE_LIST)for(var o=e.length,a=0;a<o;a+=3){var s=3*e[a],c=3*e[a+1],l=3*e[a+2];vi.set(ps.a,t[s],t[s+1],t[s+2]),vi.set(ps.b,t[c],t[c+1],t[c+2]),vi.set(ps.c,t[l],t[l+1],t[l+2]);var u=nc.rayTriangle(i,ps,r.doubleSided);if(!(0===u||u>r.distance)&&(ms(r.mode,u,s,c,l,r.result),r.mode===Qa.ANY))return u}else if(n===Yr.TRIANGLE_STRIP)for(var h=e.length-2,f=0,p=0;p<h;p+=1){var _=3*e[p-f],d=3*e[p+f+1],m=3*e[p+2];vi.set(ps.a,t[_],t[_+1],t[_+2]),vi.set(ps.b,t[d],t[d+1],t[d+2]),vi.set(ps.c,t[m],t[m+1],t[m+2]),f=~f;var v=nc.rayTriangle(i,ps,r.doubleSided);if(!(0===v||v>r.distance)&&(ms(r.mode,v,_,d,m,r.result),r.mode===Qa.ANY))return v}else if(n===Yr.TRIANGLE_FAN){var g=e.length-1,y=3*e[0];vi.set(ps.a,t[y],t[y+1],t[y+2]);for(var x=1;x<g;x+=1){var S=3*e[x],b=3*e[x+1];vi.set(ps.b,t[S],t[S+1],t[S+2]),vi.set(ps.c,t[b],t[b+1],t[b+2]);var T=nc.rayTriangle(i,ps,r.doubleSided);if(!(0===T||T>r.distance)&&(ms(r.mode,T,y,S,b,r.result),r.mode===Qa.ANY))return T}}}(o.positions,o.indices,r,t,i)}return ds}),xs=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:Qa.ANY};return function(n,i,r){t=0;var o=void 0===r?e:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!fs(n,s,c))return t;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=ys(n,u,o);if(h)if(o.mode===Qa.CLOSEST)(0===t||t>h)&&(t=h,o.subIndices&&(o.subIndices[0]=l));else if(t=h,o.subIndices&&o.subIndices.push(l),o.mode===Qa.ANY)return h}return t&&o.mode===Qa.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),Ss=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:Qa.ANY},n=new fr,i=new Oi;return function(r,o,a){t=0;var s=void 0===a?e:a,c=o.worldBounds;if(c&&!hs(r,c))return t;fr.copy(n,r),o.node&&(Oi.invert(i,o.node.getWorldMatrix(i)),vi.transformMat4(n.o,r.o,i),vi.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,f=ys(n,h,s);if(f)if(s.mode===Qa.CLOSEST)(0===t||t>f)&&(t=f,s.subIndices&&(s.subIndices[0]=u));else if(t=f,s.subIndices&&s.subIndices.push(u),s.mode===Qa.ANY)return f}return t&&s.mode===Qa.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),bs=function(){var t=new vi(0,0,0);return function(e,n){vi.subtract(t,e.e,e.s);var i=(n.d-vi.dot(e.s,n.n))/vi.dot(t,n.n);return i<0||i>1?0:i}}(),Ts=function(){var t=new vi(0,0,0),e=new vi(0,0,0),n=new vi(0,0,0),i=new vi(0,0,0),r=new vi(0,0,0),o=new vi(0,0,0);return function(a,s,c){vi.subtract(t,s.b,s.a),vi.subtract(e,s.c,s.a),vi.subtract(n,a.s,a.e),vi.cross(r,t,e);var l=vi.dot(n,r);if(l<=0)return 0;vi.subtract(i,a.s,s.a);var u=vi.dot(i,r);if(u<0||u>l)return 0;vi.cross(o,n,i);var h=vi.dot(e,o);if(h<0||h>l)return 0;var f=-vi.dot(t,o);if(f<0||h+f>l)return 0;if(c){var p=1/l,_=1-(h*=p)-(f*=p);vi.set(c,s.a.x*_+s.b.x*h+s.c.x*f,s.a.y*_+s.b.y*h+s.c.y*f,s.a.z*_+s.b.z*h+s.c.z*f)}return 1}}(),Es=new fr;function Cs(t,e){Es.o.set(t.s),vi.subtract(Es.d,t.e,t.s),Es.d.normalize();var n=hs(Es,e);return n<=t.length()?n:0}function ws(t,e){Es.o.set(t.s),vi.subtract(Es.d,t.e,t.s),Es.d.normalize();var n=vs(Es,e);return n<=t.length()?n:0}function As(t,e){Es.o.set(t.s),vi.subtract(Es.d,t.e,t.s),Es.d.normalize();var n=us(Es,e);return n<=t.length()?n:0}var Ps,Is,Rs,Ds,Os=(Ps=new vi,Is=new vi,Rs=new vi,Ds=new vi,function(t,e){return vi.subtract(Ps,t.center,t.halfExtents),vi.add(Is,t.center,t.halfExtents),vi.subtract(Rs,e.center,e.halfExtents),vi.add(Ds,e.center,e.halfExtents),Ps.x<=Ds.x&&Is.x>=Rs.x&&Ps.y<=Ds.y&&Is.y>=Rs.y&&Ps.z<=Ds.z&&Is.z>=Rs.z});function Ms(t,e,n,i,r,o){vi.set(o[0],t.x+n.x*e.x+i.x*e.y+r.x*e.z,t.y+n.y*e.x+i.y*e.y+r.y*e.z,t.z+n.z*e.x+i.z*e.y+r.z*e.z),vi.set(o[1],t.x-n.x*e.x+i.x*e.y+r.x*e.z,t.y-n.y*e.x+i.y*e.y+r.y*e.z,t.z-n.z*e.x+i.z*e.y+r.z*e.z),vi.set(o[2],t.x+n.x*e.x-i.x*e.y+r.x*e.z,t.y+n.y*e.x-i.y*e.y+r.y*e.z,t.z+n.z*e.x-i.z*e.y+r.z*e.z),vi.set(o[3],t.x+n.x*e.x+i.x*e.y-r.x*e.z,t.y+n.y*e.x+i.y*e.y-r.y*e.z,t.z+n.z*e.x+i.z*e.y-r.z*e.z),vi.set(o[4],t.x-n.x*e.x-i.x*e.y-r.x*e.z,t.y-n.y*e.x-i.y*e.y-r.y*e.z,t.z-n.z*e.x-i.z*e.y-r.z*e.z),vi.set(o[5],t.x+n.x*e.x-i.x*e.y-r.x*e.z,t.y+n.y*e.x-i.y*e.y-r.y*e.z,t.z+n.z*e.x-i.z*e.y-r.z*e.z),vi.set(o[6],t.x-n.x*e.x+i.x*e.y-r.x*e.z,t.y-n.y*e.x+i.y*e.y-r.y*e.z,t.z-n.z*e.x+i.z*e.y-r.z*e.z),vi.set(o[7],t.x-n.x*e.x-i.x*e.y+r.x*e.z,t.y-n.y*e.x-i.y*e.y+r.y*e.z,t.z-n.z*e.x-i.z*e.y+r.z*e.z)}function Ns(t,e){for(var n=vi.dot(e,t[0]),i=n,r=1;r<8;++r){var o=vi.dot(e,t[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ls,Bs,Fs,zs=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new vi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new vi(0,0,0),i[r]=new vi(0,0,0);var o=new vi,a=new vi;return function(e,r){vi.set(t[0],1,0,0),vi.set(t[1],0,1,0),vi.set(t[2],0,0,1),vi.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),vi.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),vi.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)vi.cross(t[6+3*s],t[s],t[3]),vi.cross(t[7+3*s],t[s],t[4]),vi.cross(t[7+3*s],t[s],t[5]);vi.subtract(o,e.center,e.halfExtents),vi.add(a,e.center,e.halfExtents),function(t,e,n){vi.set(n[0],t.x,e.y,e.z),vi.set(n[1],t.x,e.y,t.z),vi.set(n[2],t.x,t.y,e.z),vi.set(n[3],t.x,t.y,t.z),vi.set(n[4],e.x,e.y,e.z),vi.set(n[5],e.x,e.y,t.z),vi.set(n[6],e.x,t.y,e.z),vi.set(n[7],e.x,t.y,t.z)}(o,a,n),Ms(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var c=0;c<15;++c){var l=Ns(n,t[c]),u=Ns(i,t[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Us=function(t,e){var n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=vi.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},ks=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Us(t,e.planes[n]))return 0;return 1},Gs=function(){for(var t=new Array(8),e=0,n=0,i=0;i<t.length;i++)t[i]=new vi(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Us(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)vi.subtract(t[c],r.vertices[c],i.center);e=0,n=0;for(var l=0;l<r.vertices.length;l++)t[l].x>i.halfExtents.x?e++:t[l].x<-i.halfExtents.x&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var u=0;u<r.vertices.length;u++)t[u].y>i.halfExtents.y?e++:t[u].y<-i.halfExtents.y&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var h=0;h<r.vertices.length;h++)t[h].z>i.halfExtents.z?e++:t[h].z<-i.halfExtents.z&&n++;return e===r.vertices.length||n===r.vertices.length?0:1}}(),Hs=(Ls=new vi(0,0,0),Bs=new Si,function(t,e){return vi.subtract(Ls,e,t.center),vi.transformMat3(Ls,Ls,Si.transpose(Bs,t.orientation)),n=Ls,i=t.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Vs=(Fs=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)},function(t,e){var n=t.halfExtents.x*Fs(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*Fs(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*Fs(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),i=vi.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1}),js=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Vs(t,e.planes[n]))return 0;return 1},Ws=function(){for(var t=new Array(8),e=0,n=0,i=0,r=0;r<t.length;r++)t[r]=new vi(0,0,0);var o=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Vs(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)vi.subtract(t[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(e=o(t[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:e<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(e=o(t[f],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:e<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var p=0;p<a.vertices.length;p++)(e=o(t[p],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:e<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),qs=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new vi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new vi(0,0,0),i[r]=new vi(0,0,0);return function(e,r){vi.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),vi.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),vi.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),vi.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),vi.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),vi.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)vi.cross(t[6+3*o],t[o],t[3]),vi.cross(t[7+3*o],t[o],t[4]),vi.cross(t[8+3*o],t[o],t[5]);Ms(e.center,e.halfExtents,t[0],t[1],t[2],n),Ms(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var a=0;a<15;++a){var s=Ns(n,t[a]),c=Ns(i,t[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Xs=function(){for(var t=new oo,e=new vi,n=new vi,i=new vi,r=new Array(8),o=0;o<8;o++)r[o]=new vi;for(var a=new Array(8),s=0;s<8;s++)a[s]=new vi;return function(o,s){if(0===vi.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return t.radius=s.radius,t.center.set(s.ellipseCenter0),nc.sphereOBB(t,o);e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ms(o.center,o.halfExtents,e,n,i,r);var c=a,l=vi.copy(c[0],e),u=vi.copy(c[1],n),h=vi.copy(c[2],i);vi.subtract(c[3],s.center,o.center).normalize();var f=vi.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);f.normalize(),vi.cross(c[5],l,f),vi.cross(c[6],u,f),vi.cross(c[7],h,f);for(var p=0;p<8;++p){var _=Ns(r,c[p]),d=vi.dot(c[p],s.ellipseCenter0),m=vi.dot(c[p],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>_[1]||_[0]>y)return 0}return 1}}(),Ys=function(t,e){var n=vi.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},Ks=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Ys(t,e.planes[n]))return 0;return 1},Qs=function(){var t=new vi(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=vi.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){vi.add(t,s,vi.multiplyScalar(t,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+e[r]){var f=i.planes[h];if(vi.dot(f.n,t)<f.d)return 0}}}return 1}}(),Zs=function(t,e){var n=t.radius+e.radius;return vi.squaredDistance(t.center,e.center)<n*n},Js=function(){var t=new vi;return function(e,n){return sr(t,e.center,n),vi.squaredDistance(e.center,t)<e.radius*e.radius}}(),$s=function(){var t=new vi;return function(e,n){return cr(t,e.center,n),vi.squaredDistance(e.center,t)<e.radius*e.radius}}(),tc=function(){var t=new vi,e=new vi;return function(n,i){var r=n.radius+i.radius,o=r*r,a=vi.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return vi.squaredDistance(n.center,i.center)<o;vi.subtract(t,n.center,i.ellipseCenter0),vi.subtract(e,i.ellipseCenter1,i.ellipseCenter0);var s=vi.dot(t,e)/a;return s<0?vi.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?vi.squaredDistance(n.center,i.ellipseCenter1)<o:(vi.scaleAndAdd(t,i.ellipseCenter0,e,s),vi.squaredDistance(n.center,t)<o)}}(),ec=function(){var t=new vi,e=new vi,n=new vi,i=new vi,r=new vi,o=new vi;return function(a,s){var c,l,u=vi.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=vi.subtract(e,s.ellipseCenter1,s.ellipseCenter0),f=vi.subtract(n,a.ellipseCenter0,s.ellipseCenter0),p=vi.dot(u,u),_=vi.dot(u,h),d=vi.dot(h,h),m=vi.dot(u,f),v=vi.dot(h,f),g=p*d-_*_,y=g,x=g;g<Xn?(c=0,y=1,l=v,x=d):(l=p*v-_*m,(c=_*v-d*m)<0?(c=0,l=v,x=d):c>y&&(c=y,l=v+_,x=d)),l<0?(l=0,-m<0?c=0:-m>p?c=y:(c=-m,y=p)):l>x&&(l=x,-m+_<0?c=0:-m+_>p?c=y:(c=-m+_,y=p));var S=Math.abs(c)<Xn?0:c/y,b=Math.abs(l)<Xn?0:l/x,T=i;T.set(f),T.add(vi.multiplyScalar(r,u,S)),T.subtract(vi.multiplyScalar(o,h,b));var E=a.radius+s.radius;return T.lengthSqr()<E*E}}(),nc={raySphere:us,rayAABB:hs,rayOBB:vs,rayPlane:cs,rayTriangle:ls,rayCapsule:gs,raySubMesh:ys,rayMesh:xs,rayModel:Ss,lineSphere:As,lineAABB:Cs,lineOBB:ws,linePlane:bs,lineTriangle:Ts,sphereWithSphere:Zs,sphereAABB:Js,sphereOBB:$s,spherePlane:Ys,sphereFrustum:Ks,sphereFrustumAccurate:Qs,sphereCapsule:tc,aabbWithAABB:Os,aabbWithOBB:zs,aabbPlane:Us,aabbFrustum:ks,aabbFrustumAccurate:Gs,obbWithOBB:qs,obbPlane:Vs,obbFrustum:js,obbFrustumAccurate:Ws,obbPoint:Hs,obbCapsule:Xs,capsuleWithCapsule:ec,resolve:function(t,e,n){void 0===n&&(n=null);var i=t._type,r=e._type,o=this[i|r];return i<r?o(t,e,n):o(e,t,n)}};nc[ur.SHAPE_RAY|ur.SHAPE_SPHERE]=us,nc[ur.SHAPE_RAY|ur.SHAPE_AABB]=hs,nc[ur.SHAPE_RAY|ur.SHAPE_OBB]=vs,nc[ur.SHAPE_RAY|ur.SHAPE_PLANE]=cs,nc[ur.SHAPE_RAY|ur.SHAPE_TRIANGLE]=ls,nc[ur.SHAPE_RAY|ur.SHAPE_CAPSULE]=gs,nc[ur.SHAPE_LINE|ur.SHAPE_SPHERE]=As,nc[ur.SHAPE_LINE|ur.SHAPE_AABB]=Cs,nc[ur.SHAPE_LINE|ur.SHAPE_OBB]=ws,nc[ur.SHAPE_LINE|ur.SHAPE_PLANE]=bs,nc[ur.SHAPE_LINE|ur.SHAPE_TRIANGLE]=Ts,nc[ur.SHAPE_SPHERE]=Zs,nc[ur.SHAPE_SPHERE|ur.SHAPE_AABB]=Js,nc[ur.SHAPE_SPHERE|ur.SHAPE_OBB]=$s,nc[ur.SHAPE_SPHERE|ur.SHAPE_PLANE]=Ys,nc[ur.SHAPE_SPHERE|ur.SHAPE_FRUSTUM]=Ks,nc[ur.SHAPE_SPHERE|ur.SHAPE_FRUSTUM_ACCURATE]=Qs,nc[ur.SHAPE_SPHERE|ur.SHAPE_CAPSULE]=tc,nc[ur.SHAPE_AABB]=Os,nc[ur.SHAPE_AABB|ur.SHAPE_OBB]=zs,nc[ur.SHAPE_AABB|ur.SHAPE_PLANE]=Us,nc[ur.SHAPE_AABB|ur.SHAPE_FRUSTUM]=ks,nc[ur.SHAPE_AABB|ur.SHAPE_FRUSTUM_ACCURATE]=Gs,nc[ur.SHAPE_OBB]=qs,nc[ur.SHAPE_OBB|ur.SHAPE_PLANE]=Vs,nc[ur.SHAPE_OBB|ur.SHAPE_FRUSTUM]=js,nc[ur.SHAPE_OBB|ur.SHAPE_FRUSTUM_ACCURATE]=Ws,nc[ur.SHAPE_OBB|ur.SHAPE_CAPSULE]=Xs,nc[ur.SHAPE_CAPSULE]=ec,Bn(hr.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Fn(nc,"intersect",[{name:"line_quad"}]);var ic,rc,oc,ac,sc,cc,lc,uc=new vi(0,0,0),hc=new vi(0,0,0),fc=i.mat4(),pc=i.v4(),_c=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=ur.SHAPE_PLANE,this.n=new vi(t,e,n),this.d=i}return t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return vi.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,n,i){return vi.subtract(uc,n,e),vi.subtract(hc,i,e),vi.normalize(t.n,vi.cross(t.n,uc,hc)),t.d=vi.dot(t.n,e),t},t.set=function(t,e,n,i,r){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=r,t},t.fromNormalAndPoint=function(t,e,n){return vi.copy(t.n,e),t.d=vi.dot(e,n),t},t.normalize=function(t,e){var n=e.n.length();return vi.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t},t.prototype.transform=function(t){Oi.invert(fc,t),Oi.transpose(fc,fc),ki.set(pc,this.n.x,this.n.y,this.n.z,this.d),ki.transformMat4(pc,pc,fc),vi.set(this.n,pc.x,pc.y,pc.z),this.d=pc.w},L(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),dc=function(){function t(t,e,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(lc||(lc={}));var mc,vc,gc=function(){function t(t,e,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new dc(t,r,this._stride);var o=lc.NEVER,a=!1,s=!1;for(var c in e){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=e[c],a||o!==lc.FLOAT32?s||o!==lc.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][n]},e.getTypedArray=function(t,e){var n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t,r=e,o=(this._dataType[e]===lc.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[e];return o.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freeLists[e].push(n)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(mc||(mc={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(vc||(vc={}));var yc,xc=((ic={})[vc.DIRTY_FLAG]=lc.UINT32,ic[vc.LAYER]=lc.UINT32,ic[vc.WORLD_SCALE]=lc.FLOAT32,ic[vc.WORLD_POSITION]=lc.FLOAT32,ic[vc.WORLD_ROTATION]=lc.FLOAT32,ic[vc.WORLD_MATRIX]=lc.FLOAT32,ic[vc.LOCAL_SCALE]=lc.FLOAT32,ic[vc.LOCAL_POSITION]=lc.FLOAT32,ic[vc.LOCAL_ROTATION]=lc.FLOAT32,ic[vc.COUNT]=lc.NEVER,ic),Sc=((rc={})[vc.DIRTY_FLAG]=vc.LAYER-vc.DIRTY_FLAG,rc[vc.LAYER]=vc.WORLD_SCALE-vc.LAYER,rc[vc.WORLD_SCALE]=vc.WORLD_POSITION-vc.WORLD_SCALE,rc[vc.WORLD_POSITION]=vc.WORLD_ROTATION-vc.WORLD_POSITION,rc[vc.WORLD_ROTATION]=vc.WORLD_MATRIX-vc.WORLD_ROTATION,rc[vc.WORLD_MATRIX]=vc.LOCAL_SCALE-vc.WORLD_MATRIX,rc[vc.LOCAL_SCALE]=vc.LOCAL_POSITION-vc.LOCAL_SCALE,rc[vc.LOCAL_POSITION]=vc.LOCAL_ROTATION-vc.LOCAL_POSITION,rc[vc.LOCAL_ROTATION]=vc.COUNT-vc.LOCAL_ROTATION,rc[vc.COUNT]=1,rc),bc=new gc(mc.NODE,xc,Sc,vc);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(yc||(yc={}));var Tc,Ec=((oc={})[yc.PRIORITY]=lc.UINT32,oc[yc.STAGE]=lc.UINT32,oc[yc.PHASE]=lc.UINT32,oc[yc.PRIMITIVE]=lc.UINT32,oc[yc.BATCHING_SCHEME]=lc.UINT32,oc[yc.DYNAMIC_STATE]=lc.UINT32,oc[yc.HASH]=lc.UINT32,oc[yc.COUNT]=lc.NEVER,oc),Cc=((ac={})[yc.PRIORITY]=yc.STAGE-yc.PRIORITY,ac[yc.STAGE]=yc.PHASE-yc.STAGE,ac[yc.PHASE]=yc.PRIMITIVE-yc.PHASE,ac[yc.PRIMITIVE]=yc.BATCHING_SCHEME-yc.PRIMITIVE,ac[yc.BATCHING_SCHEME]=yc.DYNAMIC_STATE-yc.BATCHING_SCHEME,ac[yc.DYNAMIC_STATE]=yc.HASH-yc.DYNAMIC_STATE,ac[yc.HASH]=yc.COUNT-yc.HASH,ac[yc.COUNT]=1,ac),wc=new gc(mc.PASS,Ec,Cc,yc);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(Tc||(Tc={}));var Ac=((sc={})[Tc.CENTER]=lc.FLOAT32,sc[Tc.HALFEXTENTS]=lc.FLOAT32,sc[Tc.COUNT]=lc.NEVER,sc),Pc=((cc={})[Tc.CENTER]=Tc.HALFEXTENTS-Tc.CENTER,cc[Tc.HALFEXTENTS]=Tc.COUNT-Tc.HALFEXTENTS,cc[Tc.COUNT]=1,cc),Ic=new gc(mc.AABB,Ac,Pc,Tc),Rc=new vi,Dc=new vi,Oc=new vi,Mc=new vi,Nc=new Si,Lc=function(t,e,n){Nc.m00=Math.abs(n.m00),Nc.m01=Math.abs(n.m01),Nc.m02=Math.abs(n.m02),Nc.m03=Math.abs(n.m04),Nc.m04=Math.abs(n.m05),Nc.m05=Math.abs(n.m06),Nc.m06=Math.abs(n.m08),Nc.m07=Math.abs(n.m09),Nc.m08=Math.abs(n.m10),vi.transformMat3(t,e,Nc)},Bc=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=ur.SHAPE_AABB,this.center=new vi(t,e,n),this.halfExtents=new vi(i,r,o)}t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return vi.copy(t.center,e.center),vi.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,n){return vi.add(Rc,n,e),vi.subtract(Dc,n,e),vi.multiplyScalar(t.center,Rc,.5),vi.multiplyScalar(t.halfExtents,Dc,.5),t},t.set=function(t,e,n,i,r,o,a){return t.center.set(e,n,i),t.halfExtents.set(r,o,a),t},t.merge=function(e,n,i){return vi.subtract(Rc,n.center,n.halfExtents),vi.subtract(Dc,i.center,i.halfExtents),vi.add(Oc,n.center,n.halfExtents),vi.add(Mc,i.center,i.halfExtents),vi.max(Mc,Oc,Mc),vi.min(Oc,Rc,Dc),t.fromPoints(e,Oc,Mc)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,n){return vi.transformMat4(t.center,e.center,n),Lc(t.halfExtents,e.halfExtents,n),t};var e=t.prototype;return e.getBoundary=function(t,e){vi.subtract(t,this.center,this.halfExtents),vi.add(e,this.center,this.halfExtents)},e.transform=function(t,e,n,i,r){vi.transformMat4(r.center,this.center,t),Lc(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary(Rc,Dc),t.x<Rc.x&&(Rc.x=t.x),t.y<Rc.y&&(Rc.y=t.y),t.z<Rc.z&&(Rc.z=t.z),t.x>Dc.x&&(Dc.x=t.x),t.y>Dc.y&&(Dc.y=t.y),t.z>Dc.z&&(Dc.z=t.z),vi.add(Oc,Rc,Dc),this.center.set(vi.multiplyScalar(Oc,Oc,.5)),this.halfExtents.set(Dc.x-Oc.x,Dc.y-Oc.y,Dc.z-Oc.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},L(t,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Fc=new vi,zc=new vi,Uc=new Si,kc=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===_&&(_=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=ur.SHAPE_OBB,this.center=new vi(t,e,n),this.halfExtents=new vi(i,r,o),this.orientation=new Si(a,s,c,l,u,h,f,p,_)}t.create=function(e,n,i,r,o,a,s,c,l,u,h,f,p,_,d){return new t(e,n,i,r,o,a,s,c,l,u,h,f,p,_,d)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return vi.copy(t.center,e.center),vi.copy(t.halfExtents,e.halfExtents),Si.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,n){return vi.multiplyScalar(t.center,vi.add(Fc,e,n),.5),vi.multiplyScalar(t.halfExtents,vi.subtract(zc,n,e),.5),Si.identity(t.orientation),t},t.set=function(t,e,n,i,r,o,a,s,c,l,u,h,f,p,_,d){return vi.set(t.center,e,n,i),vi.set(t.halfExtents,r,o,a),Si.set(t.orientation,s,c,l,u,h,f,p,_,d),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,n){Uc.m00=Math.abs(n.m00),Uc.m01=Math.abs(n.m01),Uc.m02=Math.abs(n.m02),Uc.m03=Math.abs(n.m03),Uc.m04=Math.abs(n.m04),Uc.m05=Math.abs(n.m05),Uc.m06=Math.abs(n.m06),Uc.m07=Math.abs(n.m07),Uc.m08=Math.abs(n.m08),vi.transformMat3(t,e,Uc)}(Fc,this.halfExtents,this.orientation),vi.subtract(t,this.center,Fc),vi.add(e,this.center,Fc)},e.transform=function(t,e,n,i,r){vi.transformMat4(r.center,this.center,t),Si.fromQuat(r.orientation,n),vi.multiply(r.halfExtents,this.halfExtents,i)},e.translateAndRotate=function(t,e,n){vi.transformMat4(n.center,this.center,t),Si.fromQuat(n.orientation,e)},e.setScale=function(t,e){vi.multiply(e.halfExtents,this.halfExtents,t)},L(t,[{key:"type",get:function(){return this._type}}]),t}(),Gc=function(){function t(t,e,n){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=ur.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new vi,this.rotation=new Ei,this.ellipseCenter0=new vi(0,e,0),this.ellipseCenter1=new vi(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,n,i,r){var o=i,a=hi(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,vi.transformMat4(r.center,this.center,t),Ei.multiply(r.rotation,this.rotation,n),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),vi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),vi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},L(t,[{key:"type",get:function(){return this._type}}]),t}(),Hc=new Array(8);Hc[0]=new vi(1,1,1),Hc[1]=new vi(-1,1,1),Hc[2]=new vi(-1,-1,1),Hc[3]=new vi(1,-1,1),Hc[4]=new vi(1,1,-1),Hc[5]=new vi(-1,1,-1),Hc[6]=new vi(-1,-1,-1),Hc[7]=new vi(1,-1,-1);var Vc,jc,Wc=new vi,qc=new vi,Xc=new vi,Yc=function(){function t(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=ur.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=_c.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new vi}t.createFromAABB=function(t,e){var n=new vi,i=new vi;return vi.subtract(n,e.center,e.halfExtents),vi.add(i,e.center,e.halfExtents),t.vertices[0].set(n.x,i.y,n.z),t.vertices[1].set(i.x,i.y,n.z),t.vertices[2].set(i.x,n.y,n.z),t.vertices[3].set(n.x,n.y,n.z),t.vertices[4].set(n.x,i.y,i.z),t.vertices[5].set(i.x,i.y,i.z),t.vertices[6].set(i.x,n.y,i.z),t.vertices[7].set(n.x,n.y,i.z),t._type!==ur.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,n,i,r){var o=Math.tan(.5*e.fov),a=o*e.aspect;Wc.set(i*a,i*o,i),qc.set(r*a,r*o,r);var s=t.vertices;return Xc.set(Wc.x,Wc.y,Wc.z),vi.transformMat4(s[0],Xc,n),Xc.set(-Wc.x,Wc.y,Wc.z),vi.transformMat4(s[1],Xc,n),Xc.set(-Wc.x,-Wc.y,Wc.z),vi.transformMat4(s[2],Xc,n),Xc.set(Wc.x,-Wc.y,Wc.z),vi.transformMat4(s[3],Xc,n),Xc.set(qc.x,qc.y,qc.z),vi.transformMat4(s[4],Xc,n),Xc.set(-qc.x,qc.y,qc.z),vi.transformMat4(s[5],Xc,n),Xc.set(-qc.x,-qc.y,qc.z),vi.transformMat4(s[6],Xc,n),Xc.set(qc.x,-qc.y,qc.z),vi.transformMat4(s[7],Xc,n),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e._type;for(var n=0;n<6;++n)_c.copy(t.planes[n],e.planes[n]);for(var i=0;i<8;++i)vi.copy(t.vertices[i],e.vertices[i]);return t};var e=t.prototype;return e.update=function(t,e){if(vi.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),vi.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),vi.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),vi.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),vi.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),vi.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===ur.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();vi.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)vi.transformMat4(this.vertices[o],Hc[o],e)}},e.transform=function(t){if(this._type===ur.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)vi.transformMat4(this.vertices[e],this.vertices[e],t);_c.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),_c.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),_c.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),_c.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),_c.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),_c.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},e.updatePlanes=function(){_c.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),_c.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),_c.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),_c.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),_c.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),_c.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},L(t,[{key:"accurate",set:function(t){this._type=t?ur.SHAPE_FRUSTUM_ACCURATE:ur.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();Yc.createOrtho=function(t,e,n,i,r,o){var a=e/2,s=n/2;vi.set(Xc,a,s,-i),vi.transformMat4(t.vertices[0],Xc,o),vi.set(Xc,-a,s,-i),vi.transformMat4(t.vertices[1],Xc,o),vi.set(Xc,-a,-s,-i),vi.transformMat4(t.vertices[2],Xc,o),vi.set(Xc,a,-s,-i),vi.transformMat4(t.vertices[3],Xc,o),vi.set(Xc,a,s,-r),vi.transformMat4(t.vertices[4],Xc,o),vi.set(Xc,-a,s,-r),vi.transformMat4(t.vertices[5],Xc,o),vi.set(Xc,-a,-s,-r),vi.transformMat4(t.vertices[6],Xc,o),vi.set(Xc,a,-s,-r),vi.transformMat4(t.vertices[7],Xc,o),_c.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),_c.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),_c.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),_c.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),_c.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),_c.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Vc||(Vc={})),function(t){t[t.Default=Vc.Default]="Default",t[t.Normal=Vc.Normal]="Normal",t[t.Reverse=Vc.Reverse]="Reverse",t[t.Loop=Vc.Loop]="Loop",t[t.LoopReverse=Vc.Loop|Vc.Reverse]="LoopReverse",t[t.PingPong=Vc.PingPong]="PingPong",t[t.PingPongReverse=Vc.PingPong|Vc.Reverse]="PingPongReverse"}(jc||(jc={})),Zt(jc);var Kc=function(){function t(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return t.prototype.set=function(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex},t}();function Qc(t,e,n){void 0===n&&(n=1e-6);for(var i=0,r=t.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=t[o];if(a>e+n)r=o-1;else{if(!(a<e-n))return o;i=o+1}}return~i}var Zc=function(){},Jc=function(){return Zc},$c=tl((function(){}));function tl(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function el(t){return function(e){return function(n){!function(t,e,n){var i=il(t);if(i){var r=rl(i,"proto");rl(r,"editor")[e]=n}}(n,t,e)}}}var nl="__ccclassCache__";function il(t){return rl(t,nl)}function rl(t,e){return t[e]||(t[e]={})}var ol=tl((function(t,e){var n=Gt.getSuper(t);n===Object&&(n=null);var i={name:e,extends:n,ctor:t},r=t[nl];if(r){var o=r.proto;o&&Gt.mixin(i,o),t[nl]=void 0}return Ge(i)})),al=el("requireComponent"),sl=el("executionOrder"),cl=$c;function ll(t,e,n){var i=null;function r(t,e,n){var r=il(t.constructor);if(r){var o=rl(r,"proto"),a=rl(o,"properties");!function(t,e,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=De(i,s));var c=e[n],l=Gt.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(r.initializer));else{var u=o.default||(o.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(t));u.hasOwnProperty(n)&&(l.default=u[n])}e[n]=l}(t.constructor,a,e,i,n,r)}}return void 0===t?ll({type:void 0}):void 0===e?(i=t,r):void r(t,e,n)}var ul=Symbol("cc:SerializationMetadata"),hl=function(t,e,n){return ll(_l({}))(t,e,n)};function fl(t){return ll(_l({formerlySerializedAs:t}))}var pl=function(t,e,n){return ll({editorOnly:!0})(t,e,n)};function _l(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}var dl=Zc,ml=$c,vl=Jc,gl=$c,yl=Jc,xl=Jc,Sl=Jc,bl=Zc,Tl=Jc,El=Zc,Cl=Jc,wl=Jc,Al=Jc,Pl=Jc,Il=Jc,Rl=Jc,Dl=Zc,Ol=Jc,Ml=Zc,Nl=Zc,Ll=Zc,Bl=kl(Se),Fl=kl(be),zl=kl(Te),Ul=kl(Ee);function kl(t){return ll({type:t})}var Gl,Hl,Vl,jl,Wl,ql,Xl,Yl,Kl,Ql=function(t,e,n){return ll({__noImplicit:!0,override:!0})(t,e,n)},Zl=ol("cc.KeyframeCurve")((Gl=Symbol.iterator,ql=function(){function t(){q(this,"_times",jl,this),q(this,"_values",Wl,this)}var e=t.prototype;return e[Gl]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var n=[t._times[e],t._values[e]];return++e,{done:!1,value:n}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return Qc(this._times,t)},e.updateTime=function(t,e){var n=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,n)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return Qc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,n){return 0===e||t>n[e-1]||Kn(t,n[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var n=this._times,i=this._values,r=n.length,o=Qc(n,t);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(t),i.unshift(e)):a===r?(n.push(t),i.push(e)):(n.splice(a-1,0,t),i.splice(a-1,0,e)),a},L(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}(),jl=X((Vl=ql).prototype,"_times",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wl=X(Vl.prototype,"_values",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hl=Vl))||Hl;function Jl(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(Xl||(Xl=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(Yl||(Yl=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(Kl||(Kl=t("TangentWeightMode",{})));var $l=function(){},tu=Object.freeze({__proto__:null,uniquelyReferenced:dl,ccclass:ol,property:ll,requireComponent:al,executionOrder:sl,disallowMultiple:cl,allowReplicated:function(t){Ge.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:ml,menu:vl,playOnFocus:gl,inspector:yl,icon:xl,help:Sl,type:kl,integer:Bl,float:Fl,boolean:zl,string:Ul});t("_decorator",tu);var eu=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Gt.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=Gt.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},L(t,[{key:"count",get:function(){return this._count}}]),t}(),nu=function(){function t(e,n){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(E(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var n=0,i=e.length;n<i;){var r=(0,e[n])(t);if(r)return t.isFinish=!0,r;++n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var n=this;(0,this.pipes[t])(e,(function(i){i?(e.isFinish=!0,e.dispatch("complete",i)):++t<n.pipes.length?(e.input=e.output,e.output=null,n._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))},t}();nu._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=Gt.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var n=this.get(e);n&&t(n,e)}},e.find=function(t){for(var e in this._weakMap){var n=this.get(e);if(n&&t(n,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},L(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var iu,ru=new eu,ou=new eu,au=new eu,su=new eu,cu=new nu("normal load",[]),lu=new nu("fetch",[]),uu=new nu("transform url",[]);!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(iu||(iu={}));var hu,fu={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(hu||(hu={}));var pu=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var n;return 0!==t._deadPool.length?(n=t._deadPool.pop()).set(e):n=new t(e),n};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,n,i,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,r);break;case"error":this.onError&&this.onError(e,n,i,r);break;default:var o="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[o]&&this[o](e,n,i,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();pu.MAX_DEAD_NUM=500,pu._taskId=0,pu._deadPool=[];var _u="0123456789abcdef".split(""),du=["","","",""],mu=du.concat(du,"-",du,"-",du,"-",du,"-",du,du,du),vu=mu.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function gu(t){var e=t.split("@")[0];if(22!==e.length)return t;mu[0]=t[0],mu[1]=t[1];for(var n=2,i=2;n<22;n+=2){var r=re[t.charCodeAt(n)],o=re[t.charCodeAt(n+1)];mu[vu[i++]]=_u[r>>2],mu[vu[i++]]=_u[(3&r)<<2|o>>4],mu[vu[i++]]=_u[15&o]}return t.replace(e,mu.join(""))}var yu=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function xu(t){var e=yu.exec(t);return e?e[1]:""}function Su(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var n=su.find((function(e){return!!e.getAssetInfo(t)}));return n&&(e.bundle=n.name),Eu(t,e)}function bu(t){return!!t&&(t instanceof i.SceneAsset||t instanceof i.Scene)}function Tu(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function Eu(t,e){var n=pu.create({input:t,options:e}),i=[];try{for(var r,o=W(uu.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(t){for(var c,l=W(n.output);!(c=l()).done;)c.value.recycle();d(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var Cu,wu,Au,Pu,Iu,Ru,Du,Ou,Mu=Object.freeze({__proto__:null,getUuidFromURL:xu,getUrlWithUuid:Su,isScene:bu,normalize:Tu,transform:Eu,decodeUuid:gu}),Nu=new(function(){function t(){this._finalizationRegistry=null}var e=t.prototype;return e.registerGCObject=function(t){return t},e.unregisterGCObject=function(){},e.init=function(){},e.finalizationRegistryCallback=function(t){t.isValid&&t.destroy()},e.destroy=function(){},t}()),Lu=ol("cc.GCObject")(Cu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return e=t.call.apply(t,[this].concat(i))||this,Nu.registerGCObject(V(e))||V(e)}F(e,t);var n=e.prototype;return n.equals=function(t){return!!t&&t===this},n.destroy=function(){return Nu.unregisterGCObject(this),t.prototype.destroy.call(this)},e}(Ye))||Cu,Bu=t("Asset",ol("cc.Asset")((Iu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).loaded=!0,q(e,"_native",Pu,V(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(V(e),"_uuid",{value:"",writable:!0}),e}F(e,t),e.deserialize=function(t){return i.deserialize(t)};var n=e.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},n.addRef=function(){return this._ref++,this},n.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&i.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return v(R(12101,this._uuid)),t.prototype.destroy.call(this)},L(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Su(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Su(this._uuid,{__nativeName__:t,nativeExt:gn(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(on(Lu)),Pu=X((Au=Iu).prototype,"_native",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),X(Au.prototype,"_nativeAsset",[ll],Object.getOwnPropertyDescriptor(Au.prototype,"_nativeAsset"),Au.prototype),wu=Au))||wu);Bu.prototype.createNode=null,i.Asset=Bu;var Fu=t("Script",ol("cc.Script")(Ru=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Bu))||Ru);i._Script=Fu;var zu=t("JavaScript",ol("cc.JavaScript")(Du=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Fu))||Du);i._JavaScript=zu;var Uu,ku,Gu,Hu,Vu,ju,Wu,qu,Xu,Yu,Ku,Qu=t("TypeScript",ol("cc.TypeScript")(Ou=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Fu))||Ou);i._TypeScript=Qu;var Zu,Ju,$u,th,eh=new tt("Comp"),nh=Ye.Flags.IsOnLoadCalled,ih=t("Component",(Uu=ol("cc.Component"),ku=Cl(),Gu=kl(Fu),Hu=wl(),Uu((Ku=Yu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"node",Wu,V(e)),q(e,"_enabled",qu,V(e)),q(e,"__prefab",Xu,V(e)),e._sceneGetter=null,e._id=eh.getNewId(),e}F(e,t);var n=e.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(t){return this.node.addComponent(t)},n.getComponent=function(t){return this.node.getComponent(t)},n.getComponents=function(t){return this.node.getComponents(t)},n.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},n.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},n.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(t){return t||(t=i.instantiate._clone(this,this)),t&&(t.node=null),t},n.schedule=function(t,e,n,r){void 0===e&&(e=0),void 0===n&&(n=i.macro.REPEAT_FOREVER),void 0===r&&(r=0),I(t,1619),I((e=e||0)>=0,1620),n=Number.isNaN(n)?i.macro.REPEAT_FOREVER:n,r=r||0;var o=i.director.getScheduler(),a=o.isTargetPaused(this);o.schedule(t,this,e,n,r,a)},n.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},n.unschedule=function(t){t&&i.director.getScheduler().unschedule(t,this)},n.unscheduleAllCallbacks=function(){i.director.getScheduler().unscheduleAllForTarget(this)},L(e,[{key:"name",get:function(){if(this._name)return this._name;var t=pt(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=i.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&nh}}]),e}(Ye),Yu.system=null,X((ju=Ku).prototype,"__scriptAsset",[ku,Gu,Hu,Ll],Object.getOwnPropertyDescriptor(ju.prototype,"__scriptAsset"),ju.prototype),Wu=X(ju.prototype,"node",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qu=X(ju.prototype,"_enabled",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xu=X(ju.prototype,"__prefab",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vu=ju))||Vu)),rh=ih.prototype;rh.update=null,rh.lateUpdate=null,rh.__preload=null,rh.onLoad=null,rh.start=null,rh.onEnable=null,rh.onDisable=null,rh.onDestroy=null,rh.onFocusInEditor=null,rh.onLostFocusInEditor=null,rh.resetInEditor=null,rh._getLocalBounds=null,rh.onRestore=null,ih._requireComponent=null,ih._executionOrder=0,ct(ih,"_registerEditorProps",(function(t,e){var n=e.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),t._requireComponent=n);var i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)})),i.Component=ih;var oh,ah=t("MissingScript",ol("cc.MissingScript")(Zu=yl()((th=function(t){function e(){var e;return q(e=t.call(this)||this,"_$erialized",$u,V(e)),e}return F(e,t),e.safeFindClass=function(t){var e=Bt(t);if(e)return e;i.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){E(4600,this.node.name)},e}(ih),$u=X((Ju=th).prototype,"_$erialized",[hl,pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zu=Ju))||Zu)||Zu);i._MissingScript=ah;try{var sh=ah.__values__;0!==sh.length&&"_$erialized"===sh[sh.length-1]||(d("The '_$erialized' prop in MissingScript is missing. Please contact jare."),d("    Error props: ['"+sh+"']"))}catch(or){d("Error when checking MissingScript 5, "+or)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(oh||(oh={}));var ch,lh={auto:oh.AUTO,landscape:oh.LANDSCAPE,portrait:oh.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(ch||(ch={}));var uh=new(function(t){function e(){var e,n,i,r,o,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new Vi(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=oh.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(n=e._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var s=e._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)e._fn[s[0][l]]=a[l];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}F(e,t);var n=e.prototype;return n.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=lh[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var t=this;return new Promise((function(e,n){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var i=t._getFullscreenTarget();i?i.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var t=this;return new Promise((function(e,n){var i=document[t._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(n):(t.windowSize=t._cachedFrameSize,e())}))},n._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(t){var e=t.clone(),n=this.devicePixelRatio;return e.width/=n,e.height/=n,e},n._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===ch.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var t=this._windowType;return t===ch.Fullscreen?document[this._fn.fullscreenElement]:t===ch.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var t=this;return new Promise((function(e,n){if(t._supportFullScreen){var i=t._getFullscreenTarget();if(i){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=i[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(n):(t._onFullscreenChange=e,t._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=pn.isMobile&&(e&&t===oh.PORTRAIT||!e&&t===oh.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void E(9201);var t,e,n=i.view.getDesignResolutionSize(),r=this._gameFrame,o=r.clientWidth,a=r.clientHeight,s=n.width,c=n.height,l=o/s,u=a/c,h=this._gameContainer.style;l<u?(t=o,e=c*l):(t=s*u,e=a),h.width=t+"px",h.height=e+"px"}else{var f=this._gameContainer.style;f.width="100%",f.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else E(9201)},L(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===ch.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):E(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new Vi(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new Vi(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(E(9201),new Vi(0,0));var t,e,n;switch(this._windowType){case ch.SubFrame:return this._gameFrame?new Vi(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(E(9201),new Vi(0,0));case ch.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,n=this.isFrameRotated?t.clientWidth:t.clientHeight,new Vi(e,n);case ch.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new Vi(e,n);case ch.Unknown:default:return new Vi(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?ch.Fullscreen:this._gameFrame?this._exactFitScreen?ch.BrowserWindow:ch.SubFrame:(E(9201),ch.Unknown)}}]),e}(fn)),hh=function(){function t(){}var e=t.prototype;return e._init=function(t){uh.init(t,(function(){var t,e=i.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=uh.resolutionScale:E(1220)}))},e.fullScreen=function(){return uh.isFullScreen},e.requestFullScreen=function(t,e,n){return arguments.length>0&&E(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),uh.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==n||n()}))},e.exitFullScreen=function(){return uh.exitFullScreen()},e.autoFullScreen=function(t,e){var n;null===(n=this.requestFullScreen(t,e))||void 0===n||n.catch((function(){}))},e.disableAutoFullScreen=function(){},L(t,[{key:"devicePixelRatio",get:function(){return uh.devicePixelRatio}},{key:"windowSize",get:function(){return uh.windowSize},set:function(t){uh.windowSize=t}},{key:"resolution",get:function(){return uh.resolution}},{key:"supportsFullScreen",get:function(){return uh.supportFullScreen}}]),t}(),fh=t("screen",new hh);i.screen=fh;var ph=t("sys",{Feature:hn,hasFeature:function(t){return pn.hasFeature(t)},NetworkType:cn,Language:sn,OS:ln,Platform:un,BrowserType:an,isNative:pn.isNative,isBrowser:pn.isBrowser,isMobile:pn.isMobile,isLittleEndian:pn.isLittleEndian,platform:pn.platform,language:pn.language,languageCode:pn.nativeLanguage,os:pn.os,osVersion:pn.osVersion,osMainVersion:pn.osMainVersion,browserType:pn.browserType,browserVersion:pn.browserVersion,windowPixelResolution:fh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:pn.hasFeature(hn.WEBP),imageBitmap:pn.hasFeature(hn.IMAGE_BITMAP),touches:pn.hasFeature(hn.INPUT_TOUCH),mouse:pn.hasFeature(hn.EVENT_MOUSE),keyboard:pn.hasFeature(hn.EVENT_KEYBOARD),accelerometer:pn.hasFeature(hn.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return pn.networkType},getBatteryLevel:function(){return pn.getBatteryLevel()},garbageCollect:function(){pn.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",p(t+="Using "+(i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){pn.openURL(t)},now:function(){return pn.now()},restartVM:function(){pn.restartJSVM()},getSafeAreaRect:function(){var t=i.view,e=uh.safeAreaEdge,n=uh.windowSize,r=new Bi(e.left,e.bottom),o=new Bi(n.width-e.right,n.height-e.top);t._convertToUISpace(r),t._convertToUISpace(o);var a=r.x,s=r.y,c=o.x-r.x,l=o.y-r.y;return new Wi(a,s,c,l)}});!function(){try{var t=ph.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){E(5200)};ph.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}ph.__isWebIOS14OrIPadOS14Env=(ph.os===ln.IOS||ph.os===ln.OSX)&&pn.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),i.sys=ph;var _h=t("serializeTag",Symbol("[[Serialize]]")),dh=t("deserializeTag",Symbol("[[Deserialize]]")),mh=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return L(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function vh(t){var e=t;return{chunks:e.chunks,document:e.document}}function gh(t){if(t.length<16)throw new yh(R(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new yh(R(13100));var n=e.getUint32(4,!0);if(1!==n)throw new yh(R(13101,n));if(e.getUint32(8,!0)!==e.byteLength)throw new yh(R(13102));var i=12,r=e.getUint32(i,!0);i+=4;var o=new Uint8Array(e.buffer,i+e.byteOffset,r);i+=r;var a,s=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(R(13104))}(o);try{a=JSON.parse(s)}catch(t){throw new yh(t)}for(var c=[];i<e.byteLength;){i%8!=0&&(i+=8-i%8);var l=e.getUint32(i,!0);i+=4,c.push(new Uint8Array(e.buffer,i+e.byteOffset,l)),i+=l}if(i!==e.byteLength)throw new yh(R(13102));return new mh(a,c)}var yh=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(H(Error));function xh(t,e,n,r,o){if(e instanceof i.ValueType){o||t.push("if(prop){");var a=pt(e);t.push("s._deserializeFastDefinedObject(o"+n+",prop,"+a+");"),o||t.push("}else o"+n+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+r+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),e),e+=n.byteLength)})),t},L(t,[{key:"byteLength",get:function(){return this._length}}])}(),i.internal.parseCCONJson=vh,i.internal.decodeCCONBinary=gh,i.internal.CCON=mh;var Sh="$_$default",bh="$_$formerlySerializedAs",Th=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return F(e,t),e.prototype.get=function(t,e,n,i,r){var o=this._get();return o?(o.reset(t,e,n,i,r),o):new Eh(t,e,n,i,r)},e}(Ut),Eh=function(){function t(t,e,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,n,i){this.result=t,this.customEnv=i,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,n=!1;t instanceof mh?(n=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:n};var i=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,n,i){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,n,i):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,n=t.length,i=t.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,n)},e._deserializeArray=function(t){for(var e,n=new Array(t.length),i=0;i<t.length;i++)"object"==typeof(e=t[i])&&e?this._deserializeAndAssignField(n,e,""+i)&&(n[i]=null):n[i]=e;return n},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,n,i){var r=this,o=t.__type__,a=this._classFinder(o,t,n,i);if(!a)return this._classFinder===Bt&&this._reportMissingClass(o),null;var s=function(t){var n=new t;return e>=0&&(r.deserializedList[e]=n),n}(a);return this._deserializeInto(t,s,a),s},e._deserializeInto=function(t,e,n,r){void 0===r&&(r=!1),r||!e[dh]?e._deserialize?e._deserialize(t.content,this):i.Class._isCCClass(n)?this._deserializeFireClass(e,t,n):this._deserializeFastDefinedObject(e,t,n):this._runCustomizedDeserialize(t,e,n)},e._runCustomizedDeserialize=function(t,e,n){var i=this,r={readProperty:function(e){var n=t[e];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(t,e,n,!0)},readSuper:function(){var r=Ct(n);r&&i._deserializeInto(t,e,r)}};e[dh](r,this._context)},e._deserializeFireClass=function(t,e,n){var r;if(n.hasOwnProperty("__deserialize__"))r=n.__deserialize__;else{r=function(t,e){for(var n=ge(e),r=e.__values__,o=["var prop;"],a=te.test(zt(e)),s=0;s<r.length;s++){var c=r[s],l=void 0,u=void 0;Ge.IDENTIFIER_RE.test(c)?(u='"'+c+'"',l="."+c):l="["+(u=Ge.escapeForJS(c))+"]";var h=l;if(n[c+bh]){var f=n[c+bh];h=Ge.IDENTIFIER_RE.test(f)?"."+f:"["+Ge.escapeForJS(f)+"]"}o.push("prop=d"+h+";"),o.push('if(typeof prop!=="undefined"){');var p=Ge.getDefault(n[c+Sh]);if(a){var _=void 0,d=n[c+"$_$type"];if(void 0===p&&d)_=d instanceof xe;else{var m=typeof p;_="string"===m||"number"===m||"boolean"===m}_?o.push("o"+l+"=prop;"):xh(o,p,l,u,!0)}else o.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),xh(o,p,l,u,!1),o.push("}");o.push("}")}return(i.js.isChildClassOf(e,i._BaseNode)||i.js.isChildClassOf(e,i.Component))&&o.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(o.push("o._$erialized=JSON.parse(JSON.stringify(d));"),o.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",o.join(""))}(0,n);try{if(n===ah){var o=n.__values__;0!==o.length&&"_$erialized"===o[o.length-1]||(d("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),d("    Error props: ['"+o+"']. Please contact jare."));var a=r;r=function(t,e,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||d("Unable to load previously serialized data. "+JSON.stringify(n))}catch(t){d("Error when checking MissingScript 7, "+t)}a(t,e,n,i)}}}catch(t){d("Error when checking MissingScript 6, "+t)}ct(n,"__deserialize__",r,!0)}r(this,t,e,n)},e._deserializeAndAssignField=function(t,e,n){var i=e.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)t[n]=r;else{var o,a=this._serializedData[i];t[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,t,n)}}else{var s=e.__uuid__;if(s){var c=e.__expectedType__;this.result.push(t,n,s,c)}else t[n]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var n=this.deserializedList[e];if(n)return n;var i=this._serializedData[e];return this._deserializeObject(i,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];"object"!=typeof i?"__type__"!==n&&(t[n]=i):i?this._deserializeAndAssignField(t,i,n)&&(t[n]=null):t[n]=null}},e._deserializeFastDefinedObject=function(t,e,n){if(n===i.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(n===i.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(n!==i.Color){if(n===i.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var r=ge(n),o=n.__values__,a=0;a<o.length;a++){var s=o[a],c=e[s];void 0!==c||e.hasOwnProperty(s)||(c=Ge.getDefault(r[s+Sh])),"object"!=typeof c?t[s]=c:c?this._deserializeAndAssignField(t,c,s):t[s]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var l=e.a;t.a=void 0===l?255:l}},t}();Eh.pool=new Th;var Ch=[Bi,vi,ki,Ei,di,Vi,Wi,Oi];function wh(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var Ah=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},wh,wh,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){Oi.fromArray(t,e,1)}],Ph=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,n,i){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n),this.uuidTypeList.push(i||"")},t}());function Ih(t,e){for(var n=t[4][e[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=e[c];for(;c<e.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Lh[u])(t,r,l,e[c])}return r}function Rh(t,e,n){var i=new e;return i._deserialize?i._deserialize(n,t[0]):w(5303,pt(e)),i}function Dh(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function Oh(t){return function(e,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)t(e,r,o,r[o])}}function Mh(t,e,n,i){e[n]=null,t[8][i]=e}function Nh(t,e,n,i){e[n]=Ih(t,i)}Ph.pool=new Ut((function(t){t.reset()}),5),Ph.pool.get=function(){return this._get()||new Ph};var Lh=new Array(13);function Bh(t,e,n){return t||n(e),Object}function Fh(t,e,n,i,r,o,a){var s=t(e);if(!s){if(r)return void(n[i]=function(e,n,i){return function(){var r=t(i)||Bh(o,i,a);return e[n]=r,new r}}(n,i,e));s=Bh(o,e,a)}n[i]=s}function zh(t,e,n,i){for(var r=n||Bt,o=t[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Fh(r,s[0],s,0,e,n,i):Fh(r,s,o,a,e,n,i)}}function Uh(t){var e=t[4];if(e)for(var n=t[3],i=0;i<e.length;++i){var r=e[i];r[0]=n[r[0]]}}function kh(t,e,n){"string"==typeof t&&(t=JSON.parse(t));var r,o=!e;if(e=e||Ph.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Gh}return!1}(t)){e.init(t),n=n||{};var a,s=t[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(R(5304,s));n._version=s,n.result=e,t[0]=n,c||(zh(t,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:kh.reportMissingClass),Uh(t)),i.game._isCloning=!0;var l=t[5],u=function(t){var e=t[5],n=t[6],i=0===n?0:n.length,r=e[e.length-1],o=e.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)e[a]=Ih(t,e[a]);for(var s=t[3],c=0;c<i;++c,++a){var l=n[c],u=e[a];if(l>=0){var h=s[l];e[a]=Rh(t,h,u)}else(0,Lh[l=~l])(t,e,a,u)}return r}(t);i.game._isCloning=!1,t[7]&&function(t,e,n){for(var i=t.length-1,r=0,o=3*t[i];r<o;r+=3){var a=t[r],s=e[t[r+2]],c=t[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=e[t[r]],u=e[t[r+2]],h=t[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(t[7],l,t[2]),function(t){for(var e=t[5],n=t[2],i=t[1],r=t[8],o=t[9],a=t[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=e[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(t),r=l[u]}else r=function(t,e,n){var r,o=(n=n||{}).classFinder||Bt,a=n.createAssetRefs||ph.platform===un.EDITOR_CORE,s=n.customEnv,c=n.ignoreEditorOnly,l=null!==(r=n.reportMissingClass)&&void 0!==r?r:i.deserialize.reportMissingClass;e.init();var u=Eh.pool.get(e,o,l,s,c);i.game._isCloning=!0;var h=u.deserialize(t);return i.game._isCloning=!1,Eh.pool.put(u),a&&e.assignAssetsBy(EditorExtends.serialize.asAsset),h}(t,e,n);return o&&Ph.pool.put(e),r}Lh[0]=function(t,e,n,i){e[n]=i},Lh[1]=Dh,Lh[2]=Oh(Dh),Lh[3]=Oh(Mh),Lh[4]=Nh,Lh[5]=function(t,e,n,i){Ah[i[0]](e[n],i)},Lh[6]=Mh,Lh[7]=function(t,e,n,i){e[n].set(i)},Lh[8]=function(t,e,n,i){var r=new Ch[i[0]];Ah[i[0]](r,i),e[n]=r},Lh[9]=Oh(Nh),Lh[10]=function(t,e,n,i){var r=t[3][i[0]];e[n]=Rh(t,r,i[1])},Lh[11]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Lh[s])(t,r,a,c)}},Lh[12]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Lh[s])(t,r,o,a)}},kh.Details=Ph,kh.reportMissingClass=function(t){w(5302,t)};var Gh=function(t){this.preprocessed=!0,this.version=t};function Hh(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}i.deserialize=kh;var Vh,jh,Wh,qh,Xh,Yh,Kh,Qh,Zh,Jh,$h,tf=Ye.Flags.Destroyed,ef=Ye.Flags.PersistentMask,nf=[];function rf(t){var e;if(t instanceof Ye){if(t._instantiate)return i.game._isCloning=!0,e=t._instantiate(null,!0),i.game._isCloning=!1,e;if(t instanceof i.Asset)throw new TypeError(R(6903))}return i.game._isCloning=!0,e=of(t),i.game._isCloning=!1,e}function of(t,e){var n;af(t,n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var i=0,r=nf.length;i<r;++i)nf[i]._iN$t=null;return nf.length=0,n}function af(t,e,n){Gt.value(t,"_iN$t",e,!0),nf.push(t);var r=t.constructor;if(i.Class._isCCClass(r))!function(t,e,n,i){for(var r=t.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];if("object"==typeof s&&s){var c=n[a];c instanceof Jt&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||sf(s,i)}else n[a]=s}}(r,t,e,n);else for(var o in t)if(t.hasOwnProperty(o)&&(95!==o.charCodeAt(0)||95!==o.charCodeAt(1)||"__type__"===o||"__prefab"===o)){var a=t[o];if("object"==typeof a&&a){if(a===e)continue;e[o]=a._iN$t||sf(a,n)}else e[o]=a}t instanceof Ye&&(e._objFlags&=ef)}function sf(t,e){if(t instanceof Jt)return t.clone();if(t instanceof i.Asset)return t;var n;if(ArrayBuffer.isView(t)){var r=t.length;n=new t.constructor(r),t._iN$t=n,nf.push(t);for(var o=0;o<r;++o)n[o]=t[o];return n}if(Array.isArray(t)){var a=t.length;n=new Array(a),t._iN$t=n,nf.push(t);for(var s=0;s<a;++s){var c=t[s];n[s]="object"==typeof c&&c?c._iN$t||sf(c,e):c}return n}if(t._objFlags&tf)return null;var l=t.constructor;if(i.Class._isCCClass(l)){if(e)if(e instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return t}else if(e instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof i.Component&&t.node&&!t.node.isChildOf(e))return t;n=new l}else if(l===Object)n={};else{if(l)return t;n=Object.create(null)}return af(t,n,e),n}function cf(t,e){return(e<<3)+t}function lf(t){return hf[t]}function uf(t){switch(t){case Jh.Uint8:return Uint8Array;case Jh.Uint16:return Uint16Array;case Jh.Uint32:return Uint32Array;case Jh.Int8:return Int8Array;case Jh.Int16:return Int16Array;case Jh.Int32:return Int32Array;case Jh.Float32:return Float32Array;case Jh.Float64:return Float64Array}}rf._clone=of,i.instantiate=rf,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(Jh||(Jh={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}($h||($h={})),t("CompactValueTypeArray",ol("cc.CompactValueTypeArray")((Qh=Kh=function(){function t(){q(this,"_byteOffset",Wh,this),q(this,"_unitCount",qh,this),q(this,"_unitElement",Xh,this),q(this,"_length",Yh,this)}return t.lengthFor=function(t,e,n){return lf(e).requiredUnits*t.length*uf(n).BYTES_PER_ELEMENT},t.compress=function(e,n,i,r,o,a){for(var s=lf(n),c=uf(i),l=s.requiredUnits*e.length,u=new c(r,o,l),h=0;h<e.length;++h)s.compress(u,h,e[h]);var f=new t;return f._unitElement=cf(i,n),f._byteOffset=a,f._unitCount=l,f._length=e.length,f},t.prototype.decompress=function(t){for(var e,n={storageUnit:7&(e=this._unitElement),elementType:e>>3},i=n.storageUnit,r=lf(n.elementType),o=new(uf(i))(t,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},t}(),Kh.StorageUnit=Jh,Kh.ElementType=$h,Wh=X((jh=Qh).prototype,"_byteOffset",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qh=X(jh.prototype,"_unitCount",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xh=X(jh.prototype,"_unitElement",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cf(Jh.Uint8,$h.Scalar)}}),Yh=X(jh.prototype,"_length",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vh=jh))||Vh);var hf=((Zh={})[$h.Scalar]={requiredUnits:1,compress:function(t,e,n){t[e]=n},decompress:function(t,e){return t[e]}},Zh[$h.Vec2]={requiredUnits:2,compress:function(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:function(t,e){return new vi(t[2*e],t[2*e+1])}},Zh[$h.Vec3]={requiredUnits:3,compress:function(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:function(t,e){return new vi(t[3*e],t[3*e+1],t[3*e+2])}},Zh[$h.Vec4]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new ki(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Zh[$h.Quat]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Ei(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Zh[$h.Mat4]={requiredUnits:16,compress:function(t,e,n){Oi.toArray(t,n,16*e)},decompress:function(t,e){return Oi.fromArray(new Oi,t,16*e)}},Zh);function ff(){return 0}function pf(t){return t}function _f(t){return t*t}function df(t){return t*(2-t)}function mf(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function vf(t){return t*t*t}function gf(t){return--t*t*t+1}function yf(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function xf(t){return t*t*t*t}function Sf(t){return 1- --t*t*t*t}function bf(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function Tf(t){return t*t*t*t*t}function Ef(t){return--t*t*t*t*t+1}function Cf(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function wf(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function Af(t){return Math.sin(t*Math.PI/2)}function Pf(t){return.5*(1-Math.cos(Math.PI*t))}function If(t){return 0===t?0:Math.pow(1024,t-1)}function Rf(t){return 1===t?1:1-Math.pow(2,-10*t)}function Df(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function Of(t){return 1-Math.sqrt(1-t*t)}function Mf(t){return Math.sqrt(1- --t*t)}function Nf(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function Lf(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function Bf(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function Ff(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function zf(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function Uf(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function kf(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function Gf(t){return 1-Hf(1-t)}function Hf(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function Vf(t){return t<.5?.5*Gf(2*t):.5*Hf(2*t-1)+.5}function jf(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function Wf(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}i._decorator=tu;var qf=np(_f,df),Xf=np(vf,gf),Yf=np(xf,Sf),Kf=np(Tf,Ef),Qf=np(wf,Af),Zf=np(If,Rf),Jf=np(Of,Mf),$f=np(Lf,Bf),tp=np(zf,Uf),ep=np(Gf,Hf);function np(t,e){return function(n){return n<.5?e(2*n)/2:t(2*n-1)/2+.5}}var ip,rp,op=Object.freeze({__proto__:null,constant:ff,linear:pf,quadIn:_f,quadOut:df,quadInOut:mf,cubicIn:vf,cubicOut:gf,cubicInOut:yf,quartIn:xf,quartOut:Sf,quartInOut:bf,quintIn:Tf,quintOut:Ef,quintInOut:Cf,sineIn:wf,sineOut:Af,sineInOut:Pf,expoIn:If,expoOut:Rf,expoInOut:Df,circIn:Of,circOut:Mf,circInOut:Nf,elasticIn:Lf,elasticOut:Bf,elasticInOut:Ff,backIn:zf,backOut:Uf,backInOut:kf,bounceIn:Gf,bounceOut:Hf,bounceInOut:Vf,smooth:jf,fade:Wf,quadOutIn:qf,cubicOutIn:Xf,quartOutIn:Yf,quintOutIn:Kf,sineOutIn:Qf,expoOutIn:Zf,circOutIn:Jf,elasticOutIn:$f,backOutIn:tp,bounceOutIn:ep});t("easing",op),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(rp||(rp={}));var ap,sp,cp,lp,up,hp=((ip={})[rp.CONSTANT]=ff,ip[rp.LINEAR]=pf,ip[rp.QUAD_IN]=_f,ip[rp.QUAD_OUT]=df,ip[rp.QUAD_IN_OUT]=mf,ip[rp.QUAD_OUT_IN]=qf,ip[rp.CUBIC_IN]=vf,ip[rp.CUBIC_OUT]=gf,ip[rp.CUBIC_IN_OUT]=yf,ip[rp.CUBIC_OUT_IN]=Xf,ip[rp.QUART_IN]=xf,ip[rp.QUART_OUT]=Sf,ip[rp.QUART_IN_OUT]=bf,ip[rp.QUART_OUT_IN]=Yf,ip[rp.QUINT_IN]=Tf,ip[rp.QUINT_OUT]=Ef,ip[rp.QUINT_IN_OUT]=Cf,ip[rp.QUINT_OUT_IN]=Kf,ip[rp.SINE_IN]=wf,ip[rp.SINE_OUT]=Af,ip[rp.SINE_IN_OUT]=Pf,ip[rp.SINE_OUT_IN]=Qf,ip[rp.EXPO_IN]=If,ip[rp.EXPO_OUT]=Rf,ip[rp.EXPO_IN_OUT]=Df,ip[rp.EXPO_OUT_IN]=Zf,ip[rp.CIRC_IN]=Of,ip[rp.CIRC_OUT]=Mf,ip[rp.CIRC_IN_OUT]=Nf,ip[rp.CIRC_OUT_IN]=Jf,ip[rp.ELASTIC_IN]=Lf,ip[rp.ELASTIC_OUT]=Bf,ip[rp.ELASTIC_IN_OUT]=Ff,ip[rp.ELASTIC_OUT_IN]=$f,ip[rp.BACK_IN]=zf,ip[rp.BACK_OUT]=Uf,ip[rp.BACK_IN_OUT]=kf,ip[rp.BACK_OUT_IN]=tp,ip[rp.BOUNCE_IN]=Gf,ip[rp.BOUNCE_OUT]=Hf,ip[rp.BOUNCE_IN_OUT]=Vf,ip[rp.BOUNCE_OUT_IN]=ep,ip[rp.SMOOTH]=jf,ip[rp.FADE]=Wf,ip);function fp(t){return hp[t]}var pp,_p,dp,mp=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).interpolationMode=Xl.LINEAR,e.tangentWeightMode=Kl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=rp.LINEAR,e}return F(e,t),e}($l);function vp(t){var e=new mp;if("number"==typeof t)e.value=t;else{var n=t.interpolationMode,i=t.tangentWeightMode,r=t.value,o=t.rightTangent,a=t.rightTangentWeight,s=t.leftTangent,c=t.leftTangentWeight,l=t.easingMethod,u=t[We];e.value=null!=r?r:e.value,e.rightTangent=null!=o?o:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=s?s:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=n?n:e.interpolationMode,e.tangentWeightMode=null!=i?i:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,u&&(e[We]=u)}return e}Ge.fastDefine("cc.RealKeyframeValue",mp,{interpolationMode:Xl.LINEAR,tangentWeightMode:Kl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:rp.LINEAR}),Ge.Attr.setClassAttr(mp,We,"editorOnly",!0),(pp=mp,null!==(dp=(_p=pp)[ul])&&void 0!==dp?dp:_p[ul]={}).uniquelyReferenced=!0;var gp,yp=t("RealCurve",ol("cc.RealCurve")((up=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",cp,V(e)),q(e,"postExtrapolation",lp,V(e)),e}F(e,t);var n=e.prototype;return n.evaluate=function(t){var e=this._times,n=this._values,i=e.length;if(0===i)return 0;var r=e[0],o=e[i-1];if(t<r){var a=this.preExtrapolation,s=n[0];if(a===Yl.CLAMP||i<2)return s.value;switch(a){case Yl.LINEAR:return Lp(r,n[0].value,e[1],n[1].value,t);case Yl.LOOP:t=Mp(t,r,o);break;case Yl.PING_PONG:t=Np(t,r,o);break;default:return s.value}}else if(t>o){var c=this.postExtrapolation,l=n[i-1];if(c===Yl.CLAMP||i<2)return l.value;switch(c){case Yl.LINEAR:return Lp(o,l.value,e[i-2],n[i-2].value,t);case Yl.LOOP:t=Mp(t,r,o);break;case Yl.PING_PONG:t=Np(t,r,o);break;default:return l.value}}var u=Qc(e,t);if(u>=0)return n[u].value;var h=~u,f=h-1,p=e[f],_=n[f],d=e[h];return function(t,e,n,i,r){var o=n-t;switch(e.interpolationMode){default:case Xl.CONSTANT:return e.value;case Xl.LINEAR:var a=e.easingMethod===rp.LINEAR?r:fp(e.easingMethod)(r);return Jn(e.value,i.value,a);case Xl.CUBIC:var s=1/3,c=e.rightTangent,l=e.rightTangentWeight,u=0!=(e.tangentWeightMode&Kl.RIGHT),h=i.leftTangent,f=i.leftTangentWeight,p=0!=(i.tangentWeightMode&Kl.LEFT);if(u||p){var _=0;if(u)_=l;else{var d=o,m=o*c;_=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*_+t,y=Math.sin(v)*_+e.value,x=0;if(p)x=f;else{var S=o,b=o*h;x=Math.sqrt(S*S+b*b)*s}var T=Math.atan(h),E=(g-t)/o,C=(-Math.cos(T)*x+n-t)/o,w=y,A=-Math.sin(T)*x+i.value,P=[0,0,0],I=function(t,e,n,i,r){var o=n/i,a=e/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+t/i),u=c*c*c,h=l*l+u,f=0;if(Jl(h)){if(Jl(l))return r[0]=0,1;var p=Math.cbrt(-l);return r[0]=2*p,r[1]=-p,2}if(h<0){var _=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(_),r[1]=-d*Math.cos(_+Math.PI/3),r[2]=-d*Math.cos(_-Math.PI/3),f=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,f=1}for(var y=1/3*o,x=0;x<f;++x)r[x]-=y;return f}(0-r,3*E,3*C-6*E,3*(E-C)+1,P),R=function(t,e,n){var i=n;if(1===e)i=t[0];else{i=-1/0;for(var r=0;r<e;++r){var o=t[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(P,I,r);return Bp(e.value,w,A,i.value,R)}var D=e.value+s*c*o,O=i.value-s*h*o;return Bp(e.value,D,O,i.value,r)}}(p,_,d,n[h],(t-p)/(d-p))},n.addKeyFrame=function(e,n){return t.prototype.addKeyFrame.call(this,e,vp(n))},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return vp(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return vp(t[1])})))}},n.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(n){return Kn(n.value,e,t)}))},n[_h]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+xp+xp+Sp+bp*r+Rp*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=xp,o.setUint8(a,this.postExtrapolation),a+=xp,o.setUint32(a,r,!0),a+=Sp,n.forEach((function(t,e){return o.setFloat32(a+bp*e,t,!0)})),a+=bp*r;for(var s,c=W(i);!(s=c()).done;){var l=s.value;a=Dp(o,l,a)}var u=new Uint8Array(o.buffer,0,a);t.writeProperty("bytes",u);var h=i.map((function(t){return t[We]}));h.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",h)}else t.writeThis()},n[dh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=xp,this.postExtrapolation=i.getUint8(r),r+=xp;var o=i.getUint32(r,!0);r+=Sp;var a=Array.from({length:o},(function(t,e){return i.getFloat32(r+bp*e,!0)}));r+=bp*o;for(var s=new Array(o),c=0;c<o;++c){var l=vp({});r=Op(i,l,r),s[c]=l}n.byteLength;var u=t.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(t,e){return s[e][We]=t}))),this._times=a,this._values=s}else t.readThis()},e}(Zl),cp=X((sp=up).prototype,"preExtrapolation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yl.CLAMP}}),lp=X(sp.prototype,"postExtrapolation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yl.CLAMP}}),ap=sp))||ap);!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(gp||(gp={}));var xp=1,Sp=4,bp=4,Tp=vp({}),Ep=Tp.interpolationMode,Cp=Tp.tangentWeightMode,wp=Tp.leftTangent,Ap=Tp.leftTangentWeight,Pp=Tp.rightTangent,Ip=Tp.rightTangentWeight,Rp=26;function Dp(t,e,n){var i=0,r=n,o=r;r+=4;var a=e.value,s=e.interpolationMode,c=e.tangentWeightMode,l=e.rightTangent,u=e.rightTangentWeight,h=e.leftTangent,f=e.leftTangentWeight,p=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,s!==Ep&&(i|=gp.INTERPOLATION_MODE,t.setUint8(r,s),r+=1),c!==Cp&&(i|=gp.TANGENT_WEIGHT_MODE,t.setUint8(r,c),r+=1),h!==wp&&(i|=gp.LEFT_TANGENT,t.setFloat32(r,h,!0),r+=4),f!==Ap&&(i|=gp.LEFT_TANGENT_WEIGHT,t.setFloat32(r,f,!0),r+=4),l!==Pp&&(i|=gp.RIGHT_TANGENT,t.setFloat32(r,l,!0),r+=4),u!==Ip&&(i|=gp.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,u,!0),r+=4),i|=p<<8,t.setUint32(o,i,!0),r}function Op(t,e,n){var i=n,r=t.getUint32(i,!0);i+=4,e.value=t.getFloat32(i,!0),i+=4,r&gp.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(i),i+=1),r&gp.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(i),i+=1),r&gp.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(i,!0),i+=4),r&gp.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(i,!0),i+=4),r&gp.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(i,!0),i+=4),r&gp.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return e.easingMethod=o,i}function Mp(t,e,n){return e+ci(t-e,n-e)}function Np(t,e,n){return e+li(t-e,n-e)}function Lp(t,e,n,i,r){return e+(i-e)/(n-t)*(r-t)}function Bp(t,e,n,i,r){var o=1-r;return o*o*o*t+3*o*o*r*e+3*o*r*r*n+r*r*r*i}function Fp(t,e,n,i,r){var o=1-r;return o*(o*(t+(3*e-t)*r)+3*n*r*r)+i*r*r*r}i.bezier=Fp;var zp,Up,kp,Gp,Hp,Vp,jp,Wp,qp,Xp,Yp,Kp=Math.cos,Qp=Math.acos,Zp=Math.max,Jp=2*Math.PI,$p=Math.sqrt;function t_(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function e_(t,e){var n=function(t,e){var n,i,r,o,a=e-0,s=e-t[0],c=3*a,l=3*s,u=3*(e-t[2]),h=1/(-a+l-u+(e-1)),f=1/3,p=(c-6*s+u)*h,_=p*f,d=(-c+l)*h,m=(3*d-p*p)*f,v=m*f,g=(2*p*p*p-9*p*d+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*f,b=$p(S*S*S),T=-g/(2*b),E=Qp(T<-1?-1:T>1?1:T),C=2*t_(b);return i=C*Kp(E*f)-_,r=C*Kp((E+Jp)*f)-_,o=C*Kp((E+2*Jp)*f)-_,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Zp(i,r,o):Zp(i,r):o>=0&&o<=1?Zp(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Zp(r,o):r:o}if(0===x)return r=-(n=y<0?t_(-y):-t_(y))-_,(i=2*n-_)>=0&&i<=1?r>=0&&r<=1?Zp(i,r):i:r;var w=$p(x);return(n=t_(-y+w))-t_(y+w)-_}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}i.bezierByTime=e_,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Yp||(Yp=t("QuatInterpolationMode",{})));var n_=ol("cc.QuatKeyframeValue")(zp=dl((kp=X((Up=function(t){var e=void 0===t?{}:t,n=e.value,i=e.interpolationMode,r=e.easingMethod;q(this,"interpolationMode",kp,this),q(this,"value",Gp,this),q(this,"easingMethod",Hp,this),this.value=n?Ei.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yp.SLERP}}),Gp=X(Up.prototype,"value",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ei.clone(Ei.IDENTITY)}}),Hp=X(Up.prototype,"easingMethod",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rp.LINEAR}}),zp=Up))||zp)||zp;function i_(t){return new n_(t)}var r_,o_=t("QuatCurve",ol("cc.QuatCurve")((Xp=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",Wp,V(e)),q(e,"postExtrapolation",qp,V(e)),e}F(e,t);var n=e.prototype;return n.evaluate=function(t,e){var n;null!==(n=e)&&void 0!==n||(e=new Ei);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return e;var c=i[0],l=i[s-1];if(t<c){var u=r[0];switch(a){case Yl.LOOP:t=c+ci(t-c,l-c);break;case Yl.PING_PONG:t=c+li(t-c,l-c);break;case Yl.CLAMP:default:return Ei.copy(e,u.value)}}else if(t>l){var h=r[s-1];switch(o){case Yl.LOOP:t=c+ci(t-c,l-c);break;case Yl.PING_PONG:t=c+li(t-c,l-c);break;case Yl.CLAMP:default:return Ei.copy(e,h.value)}}var f=Qc(i,t);if(f>=0)return Ei.copy(e,r[f].value);var p=~f,_=p-1,d=i[_],m=r[_],v=i[p],g=r[p],y=(t-d)/(v-d);switch(m.interpolationMode){default:case Yp.CONSTANT:return Ei.copy(e,m.value);case Yp.SLERP:var x=m.easingMethod,S=x===rp.LINEAR?y:Array.isArray(x)?e_(x,y):fp(x)(y);return Ei.slerp(e,m.value,g.value,S)}},n.addKeyFrame=function(e,n){var i=new n_(n);return t.prototype.addKeyFrame.call(this,e,i)},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return i_(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return i_(t[1])})))}},n[_h]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(t,e,n){var i=n[0];r&&t.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=m_*(r?1:o),s=i.reduce((function(t,e){var n=e.easingMethod;return t+(Array.isArray(n)?v_+4*y_:v_)}),0),c=0,l=new DataView(new ArrayBuffer(c+=f_+p_+__*o+4*d_*o+s+a+0)),u=0,h=0;r&&(h|=r_.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=f_,l.setUint32(u,o,!0),u+=p_,n.forEach((function(t,e){return l.setFloat32(u+__*e,t,!0)})),u+=__*o,i.forEach((function(t,e){var n=t.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*d_*e;l.setFloat32(s+0*d_,i,!0),l.setFloat32(s+1*d_,r,!0),l.setFloat32(s+2*d_,o,!0),l.setFloat32(s+3*d_,a,!0)})),u+=4*d_*o,i.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(l.setUint8(u,g_),++u,l.setFloat32(u+0*y_,e[0],!0),l.setFloat32(u+1*y_,e[1],!0),l.setFloat32(u+2*y_,e[2],!0),l.setFloat32(u+3*y_,e[3],!0),u+=4*y_):(l.setUint8(u,e),++u)}));var f=u;u+=a;var p=f;i.forEach((function(t){var e=t.interpolationMode;l.setUint8(p,e),r||(p+=m_)}));var _=new Uint8Array(l.buffer);t.writeProperty("bytes",_)}else t.writeThis()},n[dh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=f_;var a=o&r_.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=p_;var c=Array.from({length:s},(function(t,e){return i.getFloat32(r+__*e,!0)})),l=r+=__*s;r+=4*d_*s;var u=Array.from({length:s},(function(t,e){var n=l+4*d_*e,o=i.getFloat32(n+0*d_,!0),a=i.getFloat32(n+1*d_,!0),s=i.getFloat32(n+2*d_,!0),c=i.getFloat32(n+3*d_,!0),u=i.getUint8(r);++r;var h=i_({value:{x:o,y:a,z:s,w:c}});return u!==g_?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*y_,!0),i.getFloat32(r+1*y_,!0),i.getFloat32(r+2*y_,!0),i.getFloat32(r+3*y_,!0)],r+=4*y_),h}));if(a){var h=i.getUint8(r);++r;for(var f=0;f<s;++f)u[f].interpolationMode=h}else{for(var p=0;p<s;++p){var _=i.getUint8(r+p);u[p].interpolationMode=_}r+=s}this._times=c,this._values=u}else t.readThis()},e}(Zl),Wp=X((jp=Xp).prototype,"preExtrapolation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yl.CLAMP}}),qp=X(jp.prototype,"postExtrapolation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yl.CLAMP}}),Vp=jp))||Vp);!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(r_||(r_={}));var a_,s_,c_,l_,u_,h_,f_=1,p_=4,__=4,d_=4,m_=1,v_=1,g_=255,y_=4,x_=t("ObjectCurve",ol("cc.ObjectCurve")(a_=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var n=Qn(~e-1,0,this._values.length-1);return this._values[n]},e}(Zl))||a_),S_=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Ge.fastDefine("cc.Keyframe",S_,{time:0,value:0,inTangent:0,outTangent:0});var b_=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n},t}(),T_=ol("cc.AnimationCurve")((h_=u_=function(){function t(t){if(void 0===t&&(t=null),q(this,"_curve",l_,this),this.cachedKey=void 0,t instanceof yp)this._curve=t;else{var e=new yp;this._curve=e,e.preExtrapolation=Yl.LOOP,e.postExtrapolation=Yl.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Xl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:Xl.CUBIC,value:1}],[1,{interpolationMode:Xl.CUBIC,value:1}]])}this.cachedKey=new b_}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:Xl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=t,o=t<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case Yl.LOOP:r=ci(t-a,s-a)+a;break;case Yl.PING_PONG:r=li(t-a,s-a)+a;break;case Yl.CLAMP:default:r=Qn(t,a,s)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var c=this.findIndex(e,r),l=Math.min(c+1,i);return this.calcOptimizedKey(e,c,l),e.evaluate(r)},e.calcOptimizedKey=function(t,e,n){var i=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(e),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;t.index=e,t.time=i,t.endTime=r;var h=r-i,f=l-a,p=1/(h*h),_=s*h,d=u*h;t.coefficient[0]=(_+d-f-f)*p/h,t.coefficient[1]=(f+f+f-_-_-d)*p,t.coefficient[2]=s,t.coefficient[3]=a},e.findIndex=function(t,e){var n=this._curve,i=n.keyFramesCount,r=t.index;if(-1!==r)if(e>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>e)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=e)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=e?h=l:u=l;return u},L(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],n=t[1],i=new S_;return i.time=e,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Xl.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return C_(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=E_(t)}},{key:"postWrapMode",get:function(){return C_(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=E_(t)}}]),t}(),u_.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],l_=X((c_=h_).prototype,"_curve",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),s_=c_))||s_;function E_(t){switch(t){default:case Vc.Default:case Vc.Normal:case Vc.Clamp:return Yl.CLAMP;case Vc.PingPong:return Yl.PING_PONG;case Vc.Loop:return Yl.LOOP}}function C_(t){switch(t){default:case Yl.LINEAR:case Yl.CLAMP:return Vc.Clamp;case Yl.PING_PONG:return Vc.PingPong;case Yl.LOOP:return Vc.Loop}}function w_(){var t=new yp;return t.assignSorted([[0,{interpolationMode:Xl.CUBIC,value:1}],[1,{interpolationMode:Xl.CUBIC,value:1}]]),t}function A_(t,e){console.warn(t+" is deprecated, please use "+e+" instead.")}Bn(nc,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var P_=function(t){function e(){var e;return e=t.call(this)||this,A_("line","Line"),e}return F(e,t),e}(hr),I_=function(t){function e(){var e;return e=t.call(this)||this,A_("plane","Plane"),e}return F(e,t),e}(_c),R_=function(t){function e(){var e;return e=t.call(this)||this,A_("ray","Ray"),e}return F(e,t),e}(fr),D_=function(t){function e(){var e;return e=t.call(this)||this,A_("triangle","Triangle"),e}return F(e,t),e}(ao),O_=function(t){function e(){var e;return e=t.call(this)||this,A_("sphere","Sphere"),e}return F(e,t),e}(oo),M_=function(t){function e(){var e;return e=t.call(this)||this,A_("aabb","AABB"),e}return F(e,t),e}(Bc),N_=function(t){function e(){var e;return e=t.call(this)||this,A_("obb","OBB"),e}return F(e,t),e}(kc),L_=function(t){function e(){var e;return e=t.call(this)||this,A_("capsule","Capsule"),e}return F(e,t),e}(Gc),B_=function(t){function e(){var e;return e=t.call(this)||this,A_("frustum","Frustum"),e}return F(e,t),e}(Yc),F_=Object.freeze({__proto__:null,distance:lr,enums:ur,intersect:nc,Line:hr,Plane:_c,Ray:fr,Triangle:ao,Sphere:oo,AABB:Bc,OBB:kc,Capsule:Gc,Frustum:Yc,Keyframe:S_,AnimationCurve:T_,get ERaycastMode(){return Qa},line:P_,plane:I_,ray:R_,triangle:D_,sphere:O_,aabb:M_,obb:N_,capsule:L_,frustum:B_});t("geometry",F_);var z_={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},U_=t("Layers",function(){function t(){}return t.makeMaskInclude=function(t){for(var e,n=0,i=W(t);!(e=i()).done;)n|=e.value;return n},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;t.Enum[e],R(2104,e),t.Enum[e]=i,Gt.value(t.Enum,String(i),e),t.BitMask[e]=i,Gt.value(t.BitMask,String(i),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var n=1<<e;delete t.Enum[t.Enum[n]],delete t.Enum[n],delete t.BitMask[t.BitMask[n]],delete t.BitMask[n]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):Dn(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());U_.Enum=Yt(z_),U_.BitMask=Xt(B({},z_)),i.Layers=U_;var k_,G_,H_="MainFlow",V_="ForwardFlow",j_="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(k_||(k_={})),i.RenderPassStage=k_,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(G_||(G_={}));var W_,q_={bindings:[],layouts:{}},X_={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(W_||(W_={}));var Y_,K_=W_.SAMPLER_SHADOWMAP,Q_=W_.COUNT-K_;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(Y_||(Y_={}));var Z_,J_=Y_.SAMPLER_JOINTS,$_=Y_.COUNT-J_;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(Z_||(Z_={}));var td=new bo;td.bufferOffsets=[0,K_+J_,K_],td.samplerOffsets=[-K_,Q_+$_,Q_-J_],td.flexibleSet=1;var ed=function(){};ed.SIZE=4*(ed.COUNT=4+(ed.SCREEN_SIZE_OFFSET=4+(ed.NATIVE_SIZE_OFFSET=4+(ed.TIME_OFFSET=0)))),ed.NAME="CCGlobal",ed.BINDING=W_.UBO_GLOBAL,ed.DESCRIPTOR=new $o(ed.BINDING,to.UNIFORM_BUFFER,1,Hr.ALL),ed.LAYOUT=new No(Z_.GLOBAL,ed.BINDING,ed.NAME,[new Mo("cc_time",Cr.FLOAT4,1),new Mo("cc_screenSize",Cr.FLOAT4,1),new Mo("cc_nativeSize",Cr.FLOAT4,1)],1),q_.layouts[ed.NAME]=ed.LAYOUT,q_.bindings[ed.BINDING]=ed.DESCRIPTOR;var nd=function(){};nd.SIZE=4*(nd.COUNT=4+(nd.VIEW_PORT_OFFSET=4+(nd.NEAR_FAR_OFFSET=4+(nd.GLOBAL_FOG_ADD_OFFSET=4+(nd.GLOBAL_FOG_BASE_OFFSET=4+(nd.GLOBAL_FOG_COLOR_OFFSET=4+(nd.AMBIENT_GROUND_OFFSET=4+(nd.AMBIENT_SKY_OFFSET=4+(nd.MAIN_LIT_COLOR_OFFSET=4+(nd.MAIN_LIT_DIR_OFFSET=4+(nd.EXPOSURE_OFFSET=4+(nd.SCREEN_SCALE_OFFSET=4+(nd.CAMERA_POS_OFFSET=16+(nd.MAT_VIEW_PROJ_INV_OFFSET=16+(nd.MAT_VIEW_PROJ_OFFSET=16+(nd.MAT_PROJ_INV_OFFSET=16+(nd.MAT_PROJ_OFFSET=16+(nd.MAT_VIEW_INV_OFFSET=16+(nd.MAT_VIEW_OFFSET=0))))))))))))))))))),nd.NAME="CCCamera",nd.BINDING=W_.UBO_CAMERA,nd.DESCRIPTOR=new $o(nd.BINDING,to.UNIFORM_BUFFER,1,Hr.ALL),nd.LAYOUT=new No(Z_.GLOBAL,nd.BINDING,nd.NAME,[new Mo("cc_matView",Cr.MAT4,1),new Mo("cc_matViewInv",Cr.MAT4,1),new Mo("cc_matProj",Cr.MAT4,1),new Mo("cc_matProjInv",Cr.MAT4,1),new Mo("cc_matViewProj",Cr.MAT4,1),new Mo("cc_matViewProjInv",Cr.MAT4,1),new Mo("cc_cameraPos",Cr.FLOAT4,1),new Mo("cc_screenScale",Cr.FLOAT4,1),new Mo("cc_exposure",Cr.FLOAT4,1),new Mo("cc_mainLitDir",Cr.FLOAT4,1),new Mo("cc_mainLitColor",Cr.FLOAT4,1),new Mo("cc_ambientSky",Cr.FLOAT4,1),new Mo("cc_ambientGround",Cr.FLOAT4,1),new Mo("cc_fogColor",Cr.FLOAT4,1),new Mo("cc_fogBase",Cr.FLOAT4,1),new Mo("cc_fogAdd",Cr.FLOAT4,1),new Mo("cc_nearFar",Cr.FLOAT4,1),new Mo("cc_viewPort",Cr.FLOAT4,1)],1),q_.layouts[nd.NAME]=nd.LAYOUT,q_.bindings[nd.BINDING]=nd.DESCRIPTOR;var id=function(){};id.SIZE=4*(id.COUNT=4+(id.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(id.SHADOW_COLOR_OFFSET=4+(id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(id.SHADOW_PROJ_INFO_OFFSET=4+(id.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(id.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(id.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(id.MAT_LIGHT_VIEW_OFFSET=16+(id.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),id.NAME="CCShadow",id.BINDING=W_.UBO_SHADOW,id.DESCRIPTOR=new $o(id.BINDING,to.UNIFORM_BUFFER,1,Hr.ALL),id.LAYOUT=new No(Z_.GLOBAL,id.BINDING,id.NAME,[new Mo("cc_matLightPlaneProj",Cr.MAT4,1),new Mo("cc_matLightView",Cr.MAT4,1),new Mo("cc_matLightViewProj",Cr.MAT4,1),new Mo("cc_shadowInvProjDepthInfo",Cr.FLOAT4,1),new Mo("cc_shadowProjDepthInfo",Cr.FLOAT4,1),new Mo("cc_shadowProjInfo",Cr.FLOAT4,1),new Mo("cc_shadowNFLSInfo",Cr.FLOAT4,1),new Mo("cc_shadowWHPBInfo",Cr.FLOAT4,1),new Mo("cc_shadowLPNNInfo",Cr.FLOAT4,1),new Mo("cc_shadowColor",Cr.FLOAT4,1),new Mo("cc_planarNDInfo",Cr.FLOAT4,1)],1),q_.layouts[id.NAME]=id.LAYOUT,q_.bindings[id.BINDING]=id.DESCRIPTOR;var rd=W_.SAMPLER_SHADOWMAP,od=new $o(rd,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),ad=new Lo(Z_.GLOBAL,rd,"cc_shadowMap",Cr.SAMPLER2D,1);q_.layouts.cc_shadowMap=ad,q_.bindings[rd]=od;var sd=W_.SAMPLER_ENVIRONMENT,cd=new $o(sd,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),ld=new Lo(Z_.GLOBAL,sd,"cc_environment",Cr.SAMPLER_CUBE,1);q_.layouts.cc_environment=ld,q_.bindings[sd]=cd;var ud=W_.SAMPLER_DIFFUSEMAP,hd=new $o(ud,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),fd=new Lo(Z_.GLOBAL,ud,"cc_diffuseMap",Cr.SAMPLER_CUBE,1);q_.layouts.cc_diffuseMap=fd,q_.bindings[ud]=hd;var pd=W_.SAMPLER_SPOT_LIGHTING_MAP,_d=new $o(pd,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),dd=new Lo(Z_.GLOBAL,pd,"cc_spotLightingMap",Cr.SAMPLER2D,1);q_.layouts.cc_spotLightingMap=dd,q_.bindings[pd]=_d;var md=function(){};md.SIZE=4*(md.COUNT=4+(md.LIGHTINGMAP_UVPARAM=16+(md.MAT_WORLD_IT_OFFSET=16+(md.MAT_WORLD_OFFSET=0)))),md.NAME="CCLocal",md.BINDING=Y_.UBO_LOCAL,md.DESCRIPTOR=new $o(md.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX|Hr.COMPUTE),md.LAYOUT=new No(Z_.LOCAL,md.BINDING,md.NAME,[new Mo("cc_matWorld",Cr.MAT4,1),new Mo("cc_matWorldIT",Cr.MAT4,1),new Mo("cc_lightingMapUVParam",Cr.FLOAT4,1)],1),X_.layouts[md.NAME]=md.LAYOUT,X_.bindings[md.BINDING]=md.DESCRIPTOR;var vd=function(){};vd.SIZE=4*(vd.COUNT=4+(vd.WORLD_BOUND_HALF_EXTENTS=4+(vd.WORLD_BOUND_CENTER=0))),vd.NAME="CCWorldBound",vd.BINDING=Y_.UBO_LOCAL,vd.DESCRIPTOR=new $o(vd.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX|Hr.COMPUTE),vd.LAYOUT=new No(Z_.LOCAL,vd.BINDING,vd.NAME,[new Mo("cc_worldBoundCenter",Cr.FLOAT4,1),new Mo("cc_worldBoundHalfExtents",Cr.FLOAT4,1)],1),X_.layouts[vd.NAME]=vd.LAYOUT,X_.bindings[vd.BINDING]=vd.DESCRIPTOR;var gd="a_matWorld0",yd=function(){};yd.BATCHING_COUNT=10,yd.MAT_WORLDS_OFFSET=0,yd.SIZE=4*(yd.COUNT=16*yd.BATCHING_COUNT),yd.NAME="CCLocalBatched",yd.BINDING=Y_.UBO_LOCAL,yd.DESCRIPTOR=new $o(yd.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX|Hr.COMPUTE),yd.LAYOUT=new No(Z_.LOCAL,yd.BINDING,yd.NAME,[new Mo("cc_matWorlds",Cr.MAT4,yd.BATCHING_COUNT)],1),X_.layouts[yd.NAME]=yd.LAYOUT,X_.bindings[yd.BINDING]=yd.DESCRIPTOR;var xd=function(){};xd.LIGHTS_PER_PASS=1,xd.SIZE=4*(xd.COUNT=(xd.LIGHT_DIR_OFFSET=(xd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(xd.LIGHT_COLOR_OFFSET=(xd.LIGHT_POS_OFFSET=0)+4*xd.LIGHTS_PER_PASS)+4*xd.LIGHTS_PER_PASS)+4*xd.LIGHTS_PER_PASS)+4*xd.LIGHTS_PER_PASS),xd.NAME="CCForwardLight",xd.BINDING=Y_.UBO_FORWARD_LIGHTS,xd.DESCRIPTOR=new $o(xd.BINDING,to.DYNAMIC_UNIFORM_BUFFER,1,Hr.FRAGMENT),xd.LAYOUT=new No(Z_.LOCAL,xd.BINDING,xd.NAME,[new Mo("cc_lightPos",Cr.FLOAT4,xd.LIGHTS_PER_PASS),new Mo("cc_lightColor",Cr.FLOAT4,xd.LIGHTS_PER_PASS),new Mo("cc_lightSizeRangeAngle",Cr.FLOAT4,xd.LIGHTS_PER_PASS),new Mo("cc_lightDir",Cr.FLOAT4,xd.LIGHTS_PER_PASS)],1),X_.layouts[xd.NAME]=xd.LAYOUT,X_.bindings[xd.BINDING]=xd.DESCRIPTOR;var Sd=function(){};Sd.LIGHTS_PER_PASS=10;var bd=function(){};bd.SIZE=4*(bd.COUNT=4+(bd.JOINTS_TEXTURE_INFO_OFFSET=0)),bd.NAME="CCSkinningTexture",bd.BINDING=Y_.UBO_SKINNING_TEXTURE,bd.DESCRIPTOR=new $o(bd.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX),bd.LAYOUT=new No(Z_.LOCAL,bd.BINDING,bd.NAME,[new Mo("cc_jointTextureInfo",Cr.FLOAT4,1)],1),X_.layouts[bd.NAME]=bd.LAYOUT,X_.bindings[bd.BINDING]=bd.DESCRIPTOR;var Td=function(){};Td.SIZE=4*(Td.COUNT=4+(Td.JOINTS_ANIM_INFO_OFFSET=0)),Td.NAME="CCSkinningAnimation",Td.BINDING=Y_.UBO_SKINNING_ANIMATION,Td.DESCRIPTOR=new $o(Td.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX),Td.LAYOUT=new No(Z_.LOCAL,Td.BINDING,Td.NAME,[new Mo("cc_jointAnimInfo",Cr.FLOAT4,1)],1),X_.layouts[Td.NAME]=Td.LAYOUT,X_.bindings[Td.BINDING]=Td.DESCRIPTOR;var Ed="a_jointAnimInfo",Cd=function(){};Cd.SIZE=4*(Cd.COUNT=360+(Cd.JOINTS_OFFSET=0)),Cd.NAME="CCSkinning",Cd.BINDING=Y_.UBO_SKINNING_TEXTURE,Cd.DESCRIPTOR=new $o(Cd.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX),Cd.LAYOUT=new No(Z_.LOCAL,Cd.BINDING,Cd.NAME,[new Mo("cc_joints",Cr.FLOAT4,90)],1),X_.layouts[Cd.NAME]=Cd.LAYOUT,X_.bindings[Cd.BINDING]=Cd.DESCRIPTOR;var wd=function(){};wd.MAX_MORPH_TARGET_COUNT=60,wd.OFFSET_OF_WEIGHTS=0,wd.OFFSET_OF_VERTICES_COUNT=4+(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*wd.MAX_MORPH_TARGET_COUNT)),wd.COUNT_BASE_4_BYTES=4*Math.ceil(wd.MAX_MORPH_TARGET_COUNT/4)+4,wd.SIZE=4*wd.COUNT_BASE_4_BYTES,wd.NAME="CCMorph",wd.BINDING=Y_.UBO_MORPH,wd.DESCRIPTOR=new $o(wd.BINDING,to.UNIFORM_BUFFER,1,Hr.VERTEX),wd.LAYOUT=new No(Z_.LOCAL,wd.BINDING,wd.NAME,[new Mo("cc_displacementWeights",Cr.FLOAT4,wd.MAX_MORPH_TARGET_COUNT/4),new Mo("cc_displacementTextureInfo",Cr.FLOAT4,1)],1),X_.layouts[wd.NAME]=wd.LAYOUT,X_.bindings[wd.BINDING]=wd.DESCRIPTOR;var Ad=function(){};Ad.NAME="CCUILocal",Ad.BINDING=Y_.UBO_UI_LOCAL,Ad.DESCRIPTOR=new $o(Ad.BINDING,to.DYNAMIC_UNIFORM_BUFFER,1,Hr.VERTEX),Ad.LAYOUT=new No(Z_.LOCAL,Ad.BINDING,Ad.NAME,[new Mo("cc_local_data",Cr.FLOAT4,1)],1),X_.layouts[Ad.NAME]=Ad.LAYOUT,X_.bindings[Ad.BINDING]=Ad.DESCRIPTOR;var Pd=Y_.SAMPLER_JOINTS,Id=new $o(Pd,to.SAMPLER_TEXTURE,1,Hr.VERTEX),Rd=new Lo(Z_.LOCAL,Pd,"cc_jointTexture",Cr.SAMPLER2D,1);X_.layouts.cc_jointTexture=Rd,X_.bindings[Pd]=Id;var Dd=Y_.SAMPLER_MORPH_POSITION,Od=new $o(Dd,to.SAMPLER_TEXTURE,1,Hr.VERTEX),Md=new Lo(Z_.LOCAL,Dd,"cc_PositionDisplacements",Cr.SAMPLER2D,1);X_.layouts.cc_PositionDisplacements=Md,X_.bindings[Dd]=Od;var Nd=Y_.SAMPLER_MORPH_NORMAL,Ld=new $o(Nd,to.SAMPLER_TEXTURE,1,Hr.VERTEX),Bd=new Lo(Z_.LOCAL,Nd,"cc_NormalDisplacements",Cr.SAMPLER2D,1);X_.layouts.cc_NormalDisplacements=Bd,X_.bindings[Nd]=Ld;var Fd=Y_.SAMPLER_MORPH_TANGENT,zd=new $o(Fd,to.SAMPLER_TEXTURE,1,Hr.VERTEX),Ud=new Lo(Z_.LOCAL,Fd,"cc_TangentDisplacements",Cr.SAMPLER2D,1);X_.layouts.cc_TangentDisplacements=Ud,X_.bindings[Fd]=zd;var kd=Y_.SAMPLER_LIGHTMAP,Gd=new $o(kd,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),Hd=new Lo(Z_.LOCAL,kd,"cc_lightingMap",Cr.SAMPLER2D,1);X_.layouts.cc_lightingMap=Hd,X_.bindings[kd]=Gd;var Vd=Y_.SAMPLER_SPRITE,jd=new $o(Vd,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),Wd=new Lo(Z_.LOCAL,Vd,"cc_spriteTexture",Cr.SAMPLER2D,1);X_.layouts.cc_spriteTexture=Wd,X_.bindings[Vd]=jd;var qd=Y_.SAMPLER_REFLECTION,Xd=new $o(qd,to.SAMPLER_TEXTURE,1,Hr.FRAGMENT),Yd=new Lo(Z_.LOCAL,qd,"cc_reflectionTexture",Cr.SAMPLER2D,1);X_.layouts.cc_reflectionTexture=Yd,X_.bindings[qd]=Xd;var Kd=Y_.STORAGE_REFLECTION,Qd=new $o(Kd,to.STORAGE_IMAGE,1,Hr.COMPUTE),Zd=new zo(Z_.LOCAL,Kd,"cc_reflectionStorage",Cr.IMAGE2D,1);X_.layouts.cc_reflectionStorage=Zd,X_.bindings[Kd]=Qd;var Jd,$d,tm,em,nm,im=U_.makeMaskExclude([U_.BitMask.UI_2D,U_.BitMask.GIZMOS,U_.BitMask.EDITOR,U_.BitMask.SCENE_GIZMO,U_.BitMask.PROFILER]),rm=U_.makeMaskExclude([U_.BitMask.UI_2D,U_.BitMask.PROFILER]),om=U_.Enum.ALL;function am(t){return t.hasFeature(br.COLOR_FLOAT)&&t.hasFeature(br.TEXTURE_FLOAT)&&!(t.gfxAPI===xr.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:H_,PIPELINE_FLOW_FORWARD:V_,PIPELINE_FLOW_SHADOW:j_,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return k_},get RenderPriority(){return G_},globalDescriptorSetLayout:q_,localDescriptorSetLayout:X_,get PipelineGlobalBindings(){return W_},get ModelLocalBindings(){return Y_},get SetIndex(){return Z_},bindingMappingInfo:td,UBOGlobal:ed,UBOCamera:nd,UBOShadow:id,UNIFORM_SHADOWMAP_BINDING:rd,UNIFORM_ENVIRONMENT_BINDING:sd,UNIFORM_DIFFUSEMAP_BINDING:ud,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:pd,UBOLocal:md,UBOWorldBound:vd,INST_MAT_WORLD:gd,UBOLocalBatched:yd,UBOForwardLight:xd,UBODeferredLight:Sd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:bd,UBOSkinningAnimation:Td,INST_JOINT_ANIM_INFO:Ed,UBOSkinning:Cd,UBOMorph:wd,UBOUILocal:Ad,UNIFORM_JOINT_TEXTURE_BINDING:Pd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Dd,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Nd,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Fd,UNIFORM_LIGHTMAP_TEXTURE_BINDING:kd,UNIFORM_SPRITE_TEXTURE_BINDING:Vd,UNIFORM_REFLECTION_TEXTURE_BINDING:qd,UNIFORM_REFLECTION_STORAGE_BINDING:Kd,CAMERA_DEFAULT_MASK:im,CAMERA_EDITOR_MASK:rm,MODEL_ALWAYS_MASK:om,supportsHalfFloatTexture:function(t){return t.hasFeature(br.COLOR_HALF_FLOAT)&&t.hasFeature(br.TEXTURE_HALF_FLOAT)&&!(t.gfxAPI===xr.WEBGL)},supportsFloatTexture:am})),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Jd||(Jd={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}($d||($d={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(tm||(tm={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(em||(em={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(nm||(nm={}));var sm,cm,lm,um,hm,fm,pm,_m=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],dm=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],mm=[100,200,400,800],vm=new vi,gm=new vi,ym=new Oi,xm=ro.STENCIL<<1,Sm=[],bm=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Jd.VERTICAL,this._fov=$n(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new So(.2,.2,.2,1),this._viewport=new Wi(0,0,1,1),this._orientedViewport=new Wi(0,0,1,1),this._curTransform=Sr.IDENTITY,this._isProjDirty=!0,this._matView=new Oi,this._matProj=new Oi,this._matProjInv=new Oi,this._matViewProj=new Oi,this._matViewProjInv=new Oi,this._frustum=new Yc,this._forward=new vi,this._position=new vi,this._priority=0,this._aperture=tm.F16_0,this._apertureValue=void 0,this._shutter=nm.D125,this._shutterValue=0,this._iso=em.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=ro.NONE,this._clearDepth=1,this._visibility=im,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=_m[this._aperture],this._shutterValue=dm[this._shutter],this._isoValue=mm[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Sm.length){var e=t.capabilities.clipSpaceSignY;Sm[Sr.IDENTITY]=new Oi(1,0,0,0,0,e),Sm[Sr.ROTATE_90]=new Oi(0,1,0,0,-e,0),Sm[Sr.ROTATE_180]=new Oi(-1,0,0,0,0,-e),Sm[Sr.ROTATE_270]=new Oi(0,-1,0,0,e,0)}}var e=t.prototype;return e._setWidth=function(t){this._width=t},e._setHeight=function(t){this._height=t},e._setScene=function(t){this._scene=t},e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||Sr.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e._init=function(){},e.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=ro.NONE,this.clearDepth=1,this.visibility=im,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e._destroy=function(){},e.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},e.attachToScene=function(t){this._enabled=!0,this._setScene(t)},e.detachFromScene=function(){this._enabled=!1,this._setScene(null)},e.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},e.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var n=!1;(this._node.hasChangedFlags||t)&&(Oi.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=i&&i.surfaceTransform||Sr.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===$d.PERSPECTIVE)Oi.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Jd.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Oi.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Oi.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Oi.multiply(this._matViewProj,this._matProj,this._matView),Oi.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,n=t.x,i=t.width,r=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||Sr.IDENTITY){case Sr.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case Sr.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case Sr.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case Sr.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||i.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var n=e.swapchain;(n&&n.surfaceTransform||Sr.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===$d.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Di[this._curTransform];vi.set(vm,(e-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var f=vm.x,p=vm.y;return vm.x=f*h[0]+p*h[2]*u,vm.y=f*h[1]+p*h[3]*u,vi.transformMat4(l?vm:t.o,vm,this._matViewProjInv),l?(this._node.getWorldPosition(gm),fr.fromPoints(t,gm,vm)):vi.transformQuat(t.d,vi.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Di[this._curTransform];if(this._proj===$d.PERSPECTIVE){vi.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,1);var u=t.x,h=t.y;t.x=u*l[0]+h*l[2]*c,t.y=u*l[1]+h*l[3]*c,vi.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(vm),vi.lerp(t,vm,t,Jn(this._nearClip/this._farClip,1,e.z))}else{vi.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,2*e.z-1);var f=t.x,p=t.y;t.x=f*l[0]+p*l[2]*c,t.y=f*l[1]+p*l[3]*c,vi.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var n=this._device.capabilities.clipSpaceSignY,i=Di[this._curTransform];vi.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*i[0]+o*i[2]*n,t.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return t.x=c+.5*(t.x+1)*u,t.y=l+.5*(t.y+1)*h,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,n,i){Oi.multiply(t,this._matViewProj,e),Oi.multiply(t,Sm[this._curTransform],t);var r=n/2,o=i/2;return Oi.identity(ym),Oi.transform(ym,ym,vi.set(vm,r,o,0)),Oi.scale(ym,ym,vi.set(vm,r,o,1)),Oi.multiply(t,ym,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},L(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){E(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=_m[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=dm[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=mm[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}(),Tm=1024;function Em(t){return!!(i.sys.hasFeature(i.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}!function(t){t[t.RGB565=Tr.R5G6B5]="RGB565",t[t.RGB5A1=Tr.RGB5A1]="RGB5A1",t[t.RGBA4444=Tr.RGBA4]="RGBA4444",t[t.RGB888=Tr.RGB8]="RGB888",t[t.RGB32F=Tr.RGB32F]="RGB32F",t[t.RGBA8888=Tr.RGBA8]="RGBA8888",t[t.RGBA32F=Tr.RGBA32F]="RGBA32F",t[t.A8=Tr.A8]="A8",t[t.I8=Tr.L8]="I8",t[t.AI8=Tr.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=Tr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=Tr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=Tm++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=Tr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=Tr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=Tm++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=Tr.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=Tm++]="RGBA_ETC1",t[t.RGB_ETC2=Tr.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=Tr.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=Tr.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=Tr.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=Tr.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=Tr.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=Tr.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=Tr.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=Tr.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=Tr.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=Tr.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=Tr.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=Tr.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=Tr.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=Tr.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=Tr.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(sm||(sm={})),function(t){t[t.REPEAT=Br.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Br.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Br.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Br.BORDER]="CLAMP_TO_BORDER"}(cm||(cm={})),function(t){t[t.NONE=Lr.NONE]="NONE",t[t.LINEAR=Lr.LINEAR]="LINEAR",t[t.NEAREST=Lr.POINT]="NEAREST"}(lm||(lm={}));var Cm,wm,Am,Pm,Im,Rm,Dm,Om,Mm,Nm,Lm,Bm,Fm=t("ImageAsset",ol("cc.ImageAsset")((pm=fm=function(t){function e(e){var n;return(n=t.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=sm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}F(e,t);var n=e.prototype;return n.reset=function(t){Em(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Em(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(t){var n="";"string"==typeof t?n=t:(this._width=t.w,this._height=t.h,n=t.fmt);for(var r,o=i.director.root?i.director.root.device:null,a=n.split("_"),s=Number.MAX_VALUE,c=this._format,l="",u=i.macro.SUPPORT_TEXTURE_FORMATS,h=W(a);!(r=h()).done;){var f=r.value.split("@"),p=parseInt(f[0],void 0),_=e.extnames[p]||f[0],d=u.indexOf(_);if(-1!==d&&d<s){var m=f[1]?parseInt(f[1]):this._format;if(!(".astc"!==_||o&&o.hasFeature(br.FORMAT_ASTC)))continue;if(!(".pvr"!==_||o&&o.hasFeature(br.FORMAT_PVRTC)))continue;if(!(m!==sm.RGB_ETC1&&m!==sm.RGBA_ETC1||o&&o.hasFeature(br.FORMAT_ETC1)))continue;if(!(m!==sm.RGB_ETC2&&m!==sm.RGBA_ETC2||o&&o.hasFeature(br.FORMAT_ETC2)))continue;if(".webp"===_&&!i.sys.hasFeature(i.sys.Feature.WEBP))continue;s=d,l=_,c=m}}l?(this._setRawAsset(l),this._format=c):E(3121)},n.initDefault=function(n){if(t.prototype.initDefault.call(this,n),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),e._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},L(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||Em(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||Em(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=sm.RGB_ETC1&&this._format<=sm.RGBA_ASTC_12x12||this._format>=sm.RGB_A_PVRTC_2BPPV1&&this._format<=sm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Bu),fm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],fm._sharedPlaceHolderCanvas=null,X((hm=pm).prototype,"_nativeAsset",[Ql],Object.getOwnPropertyDescriptor(hm.prototype,"_nativeAsset"),hm.prototype),um=hm))||um);i.ImageAsset=Fm,Zt(Tr);var zm=new tt("Tex"),Um=ol("cc.TextureBase")((Bm=Lm=function(t){function e(){var e;return q(e=t.call(this)||this,"_format",Am,V(e)),q(e,"_minFilter",Pm,V(e)),q(e,"_magFilter",Im,V(e)),q(e,"_mipFilter",Rm,V(e)),q(e,"_wrapS",Dm,V(e)),q(e,"_wrapT",Om,V(e)),q(e,"_wrapR",Mm,V(e)),q(e,"_anisotropy",Nm,V(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new Oo,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=zm.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=Da(e._id,666),e}F(e,t);var n=e.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(t,e,n){void 0===n&&(n=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var e,n=t.prototype.destroy.call(this);return n&&(null===(e=i.director.root)||void 0===e?void 0:e.batcher2D)&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):w(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},n._getGFXDevice=function(){return i.director.root?i.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(t){this._format=void 0===t?sm.RGBA8888:t},n._getGFXPixelFormat=function(t){return t===sm.RGBA_ETC1?t=sm.RGB_ETC1:t===sm.RGB_A_PVRTC_4BPPV1?t=sm.RGB_PVRTC_4BPPV1:t===sm.RGB_A_PVRTC_2BPPV1&&(t=sm.RGB_PVRTC_2BPPV1),t},L(e,[{key:"isCompressed",get:function(){return this._format>=sm.RGB_ETC1&&this._format<=sm.RGBA_ASTC_12x12||this._format>=sm.RGB_A_PVRTC_2BPPV1&&this._format<=sm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Bu),Lm.PixelFormat=sm,Lm.WrapMode=cm,Lm.Filter=lm,Am=X((wm=Bm).prototype,"_format",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sm.RGBA8888}}),Pm=X(wm.prototype,"_minFilter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.LINEAR}}),Im=X(wm.prototype,"_magFilter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.LINEAR}}),Rm=X(wm.prototype,"_mipFilter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.NONE}}),Dm=X(wm.prototype,"_wrapS",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cm.REPEAT}}),Om=X(wm.prototype,"_wrapT",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cm.REPEAT}}),Mm=X(wm.prototype,"_wrapR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cm.REPEAT}}),Nm=X(wm.prototype,"_anisotropy",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cm=wm))||Cm;i.TextureBase=Um;var km=new WeakMap,Gm=new WeakSet,Hm=new WeakSet;function Vm(t,e){var n;n=ah.safeFindClass;var i,r=Ph.pool.get();try{i=kh(t,r,{classFinder:n,customEnv:e})}catch(t){throw d(t),Ph.pool.put(r),t}i._uuid=e.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:gu(h),owner:a[u],prop:s[u],type:Gt._getClassById(c[u])}}return km.set(i,l),i._native&&Gm.add(i),Ph.pool.put(r),i}var jm,Wm=new(function(){function t(){this._depends=new eu}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?B({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),n=[];return this._descend(t,e,n),n},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var n,i,r=null;if(Array.isArray(e)||e.__type__||e instanceof mh){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(i=(n=e[5])[n.length-1])&&i<0)try{var o=Vm(e,{__uuid__:t});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=t),au.add(t+"@import",o)}catch(e){ou.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},n=km.get(t),i=0,r=n.length;i<r;i++)e.deps.push(n[i].uuid);return Gm.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return n=(e=t)[1],e[10].map((function(t){return n[t]}));var e,n}(t);return e.forEach((function(t,n){return e[n]=gu(t)})),e},e._descend=function(t,e,n){for(var i=this.getDeps(t),r=0;r<i.length;r++){var o=i[r];e[o]||(e[o]=!0,n.push(o),this._descend(o,e,n))}},t}()),qm=[new yo];function Xm(t){return t&&0==(t&t-1)}var Ym,Km,Qm,Zm,Jm,$m,tv=ol("cc.SimpleTexture")(jm=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}F(e,t);var n=e.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),t.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(t,e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var i=this._getGFXDevice();if(i){var r=qm[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,qm):i.copyTexImagesToTexture([t],this._gfxTexture,qm)}}},n._assignImage=function(t,e,n){var i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),$t.CLEANUP_IMAGE_CACHE)){var r=Wm.getDeps(this._uuid),o=r.indexOf(t._uuid);-1!==o&&(Q(r,o),t.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&this._createTexture(t)}},n._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=Or.NONE;this._mipFilter!==lm.NONE&&function(t,e,n){return!(t.gfxAPI===xr.WEBGL)||Xm(e)&&Xm(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var n=Math.max(t,e),i=0;n;)n>>=1,i++;return i}(this._width,this._height),e=Or.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Dr.SAMPLED|Dr.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(n){var i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},L(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Um))||jm;i.SimpleTexture=tv;var ev,nv,iv,rv,ov,av,sv,cv=t("Texture2D",(Ym=ol("cc.Texture2D"),Km=kl([Fm]),Ym(($m=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_mipmaps",Jm,V(e)),e}F(e,t);var n=e.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.create=function(t,e,n,i){void 0===n&&(n=sm.RGBA8888),void 0===i&&(i=1),this.reset({width:t,height:e,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),i=0;i<n;++i){var r=t+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Fm,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,Gt._getClassId(Fm))}},n._getGfxTextureCreateInfo=function(t){var e=new Ro(Rr.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Fm;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},L(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){e._assignImage(t,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(tv),Jm=X((Zm=$m).prototype,"_mipmaps",[Km],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qm=Zm))||Qm));i.Texture2D=cv,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(sv||(sv={}));var lv=t("TextureCube",ol("cc.TextureCube")((av=ov=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"isRGBE",iv,V(e)),q(e,"_mipmaps",rv,V(e)),e}F(e,t),e.fromTexture2DArray=function(t,n){for(var i=[],r=t.length/6,o=0;o<r;o++){var a=6*o;i.push({front:t[a+sv.front].image,back:t[a+sv.back].image,left:t[a+sv.left].image,right:t[a+sv.right].image,top:t[a+sv.top].image,bottom:t[a+sv.bottom].image})}return(n=n||new e).mipmaps=i,n};var n=e.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(t,e){var n=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;uv(n._mipmaps[i],(function(t,e){n._assignImage(t,i,e)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Fm,back:new Fm,left:new Fm,right:new Fm,top:new Fm,bottom:new Fm};var o=i.mipmaps[r],a=Gt._getClassId(Fm);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(t){var e=new Ro(Rr.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Fm;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},L(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){uv(t,(function(t,i){e._assignImage(t,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(tv),ov.FaceIndex=sv,iv=X((nv=av).prototype,"isRGBE",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rv=X(nv.prototype,"_mipmaps",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ev=nv))||ev);function uv(t,e){e(t.front,sv.front),e(t.back,sv.back),e(t.left,sv.left),e(t.right,sv.right),e(t.top,sv.top),e(t.bottom,sv.bottom)}i.TextureCube=lv;var hv,fv,pv=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2766437914,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite-gpu",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",hash:2450198964,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCUILocal",defines:[]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_batch_id",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2672216600,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3653711100,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),_v=4227858432,dv=66060288,mv=1044480,vv=function(t,e,n,i){return void 0===i&&(i=0),e<<26&_v|t<<20&dv|n<<12&mv|4095&i},gv=function(t){return(t&_v)>>>26},yv=function(t){return(t&dv)>>>20},xv=function(t){return(t&mv)>>>12},Sv=function(t){return 4095&t},bv=function(t,e){return 67108863&t|e<<26&_v},Tv=((hv={})[Cr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},hv[Cr.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]},hv[Cr.INT2]=function(t,e,n){return void 0===n&&(n=0),Bi.fromArray(e,t,n)},hv[Cr.INT3]=function(t,e,n){return void 0===n&&(n=0),vi.fromArray(e,t,n)},hv[Cr.INT4]=function(t,e,n){return void 0===n&&(n=0),ki.fromArray(e,t,n)},hv[Cr.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]},hv[Cr.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Bi.fromArray(e,t,n)},hv[Cr.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),vi.fromArray(e,t,n)},hv[Cr.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),ki.fromArray(e,t,n)},hv[Cr.MAT3]=function(t,e,n){return void 0===n&&(n=0),Si.fromArray(e,t,n)},hv[Cr.MAT4]=function(t,e,n){return void 0===n&&(n=0),Oi.fromArray(e,t,n)},hv),Ev=((fv={})[Cr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},fv[Cr.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},fv[Cr.INT2]=function(t,e,n){return void 0===n&&(n=0),Bi.toArray(t,e,n)},fv[Cr.INT3]=function(t,e,n){return void 0===n&&(n=0),vi.toArray(t,e,n)},fv[Cr.INT4]=function(t,e,n){return void 0===n&&(n=0),ki.toArray(t,e,n)},fv[Cr.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},fv[Cr.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Bi.toArray(t,e,n)},fv[Cr.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),vi.toArray(t,e,n)},fv[Cr.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),ki.toArray(t,e,n)},fv[Cr.MAT3]=function(t,e,n){return void 0===n&&(n=0),Si.toArray(t,e,n)},fv[Cr.MAT4]=function(t,e,n){return void 0===n&&(n=0),Oi.toArray(t,e,n)},fv),Cv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function wv(t){switch(t){case Cr.BOOL:case Cr.INT:case Cr.UINT:case Cr.FLOAT:return Cv[0];case Cr.BOOL2:case Cr.INT2:case Cr.UINT2:case Cr.FLOAT2:return Cv[1];case Cr.BOOL4:case Cr.INT4:case Cr.UINT4:case Cr.FLOAT4:return Cv[2];case Cr.MAT4:return Cv[3];case Cr.SAMPLER2D:return"default-texture";case Cr.SAMPLER_CUBE:return"default-cube-texture"}return Cv[0]}function Av(t,e){for(var n=Object.entries(e),i=!1,r=0;r<n.length;r++)t[n[r][0]]!==n[r][1]&&(t[n[r][0]]=n[r][1],i=!0);return i}var Pv=new ta;function Iv(t){return Math.ceil(Math.log2(Math.max(t,2)))}function Rv(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function Dv(t,e,n,i,r){for(var o=t.builtins[i],a=[],s=function(t){var e=o.blocks[t],i=n.layouts[e.name],s=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&s&&s.descriptorType&pa))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var l=[],u=function(t){var e=o.samplerTextures[t],i=n.layouts[e.name],a=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&a&&a.descriptorType&_a))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,l),r&&r.sort((function(t,e){return t.binding-e.binding}))}function Ov(t){return t.members.reduce((function(t,e){return t+Sa(e.type)*e.count}),0)}function Mv(t,e){for(var n=0;n<t.length;n++){var i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function Nv(t){switch(t.gfxAPI){case xr.GLES2:case xr.WEBGL:return"glsl1";case xr.GLES3:case xr.WEBGL2:return"glsl3";default:return"glsl4"}}var Lv=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var n=0;n<t.techniques.length;n++)for(var i=t.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var n=B({},t),i=0,r=function(t){var e=n.defines[t],r=1;if("number"===e.type){var o=e.range;r=Iv(o[1]-o[0]+1),e._map=function(t){return t-o[0]}}else"string"===e.type?(r=Iv(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[t.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Vo,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Ov(l)),s.bindings.push(new $o(l.binding,to.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new No(Z_.MATERIAL,l.binding,l.name,l.members.map((function(t){return new Mo(t.name,t.type,t.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new $o(h.binding,to.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Lo(Z_.MATERIAL,h.binding,h.name,h.type,h.count))}for(var f=0;f<n.samplers.length;f++){var p=n.samplers[f];s.bindings.push(new $o(p.binding,to.SAMPLER,p.count,p.stageFlags)),s.shaderInfo.samplers.push(new Bo(Z_.MATERIAL,p.binding,p.name,p.count))}for(var _=0;_<n.textures.length;_++){var d=n.textures[_];s.bindings.push(new $o(d.binding,to.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new Fo(Z_.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new $o(v.binding,to.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Uo(Z_.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new $o(y.binding,to.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new zo(Z_.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new $o(S.binding,to.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new ko(Z_.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var b=0;b<n.attributes.length;b++){var T=n.attributes[b];s.gfxAttributes.push(new Ho(T.name,T.format,T.isNormalized,0,T.isInstanced,T.location))}Dv(n,s,X_,"locals"),s.shaderInfo.stages.push(new Go(Hr.VERTEX,"")),s.shaderInfo.stages.push(new Go(Hr.FRAGMENT,"")),s.handleMap=function(t){for(var e={},n=0;n<t.blocks.length;n++)for(var i=t.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];e[s.name]=vv(i.binding,s.type,s.count,o),o+=(Sa(s.type)>>2)*s.count}for(var c=0;c<t.samplerTextures.length;c++){var l=t.samplerTextures[c];e[l.name]=vv(l.binding,l.type,l.count)}return e}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,n){void 0===n&&(n=!1);var i=this._templates[e],r=this._templateInfos[i.hash];return r.setLayouts.length||(Pv.bindings=r.bindings,r.setLayouts[Z_.MATERIAL]=t.createDescriptorSetLayout(Pv),Pv.bindings=X_.bindings,r.setLayouts[Z_.LOCAL]=t.createDescriptorSetLayout(Pv)),r.setLayouts[n?Z_.LOCAL:Z_.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var n=this._templates[t],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=e[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],f=e[h.name];f&&h._map&&(l|=h._map(f)<<h._offset)}return l.toString(16)+"|"+n.hash},e.destroyShaderByDefines=function(t){var e=this,n=Object.keys(t);if(n.length)for(var i=n.map((function(e){var n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+e+n)})),r=Object.keys(this._cache).filter((function(t){return i.every((function(n){return n.test(e._cache[t].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];v("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(e,n));var o=this._cache[r];if(o)return o;var a=this._templates[e],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(t,e),Dv(a,s,q_,"globals"),s.setLayouts[Z_.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=t.createPipelineLayout(new na(s.setLayouts)));var c=function(t,e){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=r.name,a=t[o],s=Rv(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),u=a.glsl3,h=Nv(t);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(t,e,n){for(var i=[],r=t.attributes,o=e.gfxAttributes,a=0;a<r.length;a++)Mv(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,c),this._cache[r]=t.createShader(s.shaderInfo)},t}());i.programLib=Lv;var Bv,Fv,zv,Uv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute float a_batch_id;\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nuniform vec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nvarying vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * max(0.02, 0.001 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.02)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec2 a_texCoord;\nin float a_batch_id;\nout vec2 v_uv0;\nout float v_uvMode;\nout vec4 v_uvSizeOffset;\nout vec4 v_uvParams0;\nout vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nlayout(std140) uniform CCUILocal {\nvec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\n};\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nout vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\nin vec2 v_uv0;\nin float v_uvMode;\nin vec4 v_uvSizeOffset;\nin vec4 v_uvParams0;\nin vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * max(0.02, 0.001 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.02)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},kv=function(){function t(){this._device=null,this._resources={}}var e=t.prototype;return e.initBuiltinRes=function(t){var e=this;this._device=t;for(var n=this._resources,r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=new Uint8Array(16),l=0,u=0;u<4;u++)r[l]=0,r[l+1]=0,r[l+2]=0,r[l+3]=255,o[l]=0,o[l+1]=0,o[l+2]=0,o[l+3]=0,a[l]=119,a[l+1]=119,a[l+2]=119,a[l+3]=255,s[l]=255,s[l+1]=255,s[l+2]=255,s[l+3]=255,c[l]=127,c[l+1]=127,c[l+2]=255,c[l+3]=255,l+=4;var h=new Uint8Array(1024);l=0;for(var f=0;f<256;f++)h[l]=221,h[l+1]=221,h[l+2]=221,h[l+3]=255,l+=4;l=0;for(var p=0;p<8;p++){for(var _=0;_<8;_++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}l+=32;for(var d=0;d<8;d++){for(var m=0;m<8;m++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}var v={width:2,height:2,_data:r,_compressed:!1,format:cv.PixelFormat.RGBA8888},g={width:2,height:2,_data:o,_compressed:!1,format:cv.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:cv.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:cv.PixelFormat.RGBA8888},S={width:2,height:2,_data:c,_compressed:!1,format:cv.PixelFormat.RGBA8888},b={width:16,height:16,_data:h,_compressed:!1,format:cv.PixelFormat.RGBA8888},T=new Fm(v),E=new cv;E._uuid="black-texture",E.image=T,n[E._uuid]=E;var C=new Fm(g),w=new cv;w._uuid="empty-texture",w.image=C,n[w._uuid]=w;var A=new lv;A._uuid="black-cube-texture",A.setMipFilter(lv.Filter.NEAREST),A.image={front:new Fm(v),back:new Fm(v),left:new Fm(v),right:new Fm(v),top:new Fm(v),bottom:new Fm(v)},n[A._uuid]=A;var P=new Fm(y),I=new cv;I._uuid="grey-texture",I.image=P,n[I._uuid]=I;var R=new Fm(x),D=new cv;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var O=new lv;O._uuid="white-cube-texture",O.setMipFilter(lv.Filter.NEAREST),O.image={front:new Fm(x),back:new Fm(x),left:new Fm(x),right:new Fm(x),top:new Fm(x),bottom:new Fm(x)},n[O._uuid]=O;var M=new Fm(S),N=new cv;N._uuid="normal-texture",N.image=M,n[N._uuid]=N;var L=new Fm(b),B=new cv;B._uuid="default-texture",B.image=L,n[B._uuid]=B;var F=new lv;if(F.setMipFilter(lv.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new Fm(b),back:new Fm(b),left:new Fm(b),right:new Fm(b),top:new Fm(b),bottom:new Fm(b)},n[F._uuid]=F,i.SpriteFrame){var z=new i.SpriteFrame,U=T,k=new cv;k.image=U,z.texture=k,z._uuid="default-spriteframe",n[z._uuid]=z}var G=Nv(t);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=Uv[G];return H?Promise.resolve().then((function(){pv.forEach((function(t,e){var n=Object.assign(new i.EffectAsset,t);n.shaders.forEach((function(t,n){var i=H[e][n];i&&(t[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),e._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},e.get=function(t){return this._resources[t]},e._initMaterials=function(){var t=this._resources,e=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);var r=new i.Material;r._uuid="missing-effect-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",i.color("#ffff00")),t[r._uuid]=r,e.push(r);var o=new i.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",i.color("#ff00ff")),t[o._uuid]=o,e.push(o);var a=new i.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[a._uuid]=a,e.push(a);var s=new i.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[s._uuid]=s,e.push(s);var c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);var l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);var u=new i.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);var h=new i.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[h._uuid]=h,e.push(h);var f=new i.Material;f._uuid="ui-sprite-gray-alpha-sep-material",f.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[f._uuid]=f,e.push(f);var p=new i.Material;p._uuid="ui-graphics-material",p.initialize({effectName:"graphics"}),t[p._uuid]=p,e.push(p);var _=new i.Material;_._uuid="default-particle-material",_.initialize({effectName:"particle"}),t[_._uuid]=_,e.push(_);var d=new i.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),t[d._uuid]=d,e.push(d);var m=new i.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);var v=new i.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),t[v._uuid]=v,e.push(v);var g=new i.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),i.game.on(i.Game.EVENT_GAME_INITED,(function(){for(var t=0;t<e.length;++t)for(var n=e[t],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},t}(),Gv=t("builtinResMgr",i.builtinResMgr=new kv),Hv=t("getPhaseID",(Bv=new Map,Fv=0,function(t){return"number"==typeof t?t:(Bv.has(t)||(Bv.set(t,1<<Fv),Fv++),Bv.get(t))})),Vv=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,n,i){void 0===i&&(i=null);var r=e.buffer.length;if(r){var o=t.inputAssembler,a=t.descriptorSet.getTexture(kd),s=i;s||(s=t.shaders[n]);for(var c=t.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(h),u.data.set(f),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(e.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var p=this._device.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,32*r,r)),_=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<e.attributes.length;g++){var y=e.attributes[g],x=new Ho(y.name,y.format,y.isNormalized,d.length,!0);m.push(x)}_.set(e.buffer),d.push(p);var S=new jo(m,d,v),b=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:p,data:_,ia:b,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),jv=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],n=0;n<e.vbs.length;++n)e.vbs[n].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,n){var i=t.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=t.passes[e],c=t.shaders[e],l=t.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var f=this.batches[h];if(f.vbs.length===i.length&&f.mergeCount<yd.BATCHING_COUNT){u=!0;for(var p=0;p<f.vbs.length;++p)if(f.vbs[p].stride!==i[p].stride){u=!1;break}if(u){for(var _=0;_<f.vbs.length;++_){var d=i[_],m=f.vbs[_],v=f.vbDatas[_];(r=(a+f.vbCount)*d.stride)>m.size&&(m.resize(r),f.vbDatas[_]=new Uint8Array(r),f.vbDatas[_].set(v)),f.vbDatas[_].set(d.buffer,f.vbCount*d.stride)}var g=f.vbIdxData;(o=4*(a+f.vbCount))>f.vbIdx.size&&(f.vbIdx.resize(o),f.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),f.vbIdxData.set(g),g=f.vbIdxData);var y=f.vbCount,x=y+a,S=f.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var b=y;b<x;b++)g[b]=S+.1;return Oi.toArray(f.uboData,n.transform.worldMatrix,yd.MAT_WORLDS_OFFSET+16*f.mergeCount),f.mergeCount||(l.bindBuffer(yd.BINDING,f.ubo),l.update(),f.pass=s,f.shader=c,f.descriptorSet=l),++f.mergeCount,f.vbCount+=a,void(f.ia.vertexCount+=a)}}}for(var T=[],E=[],C=[],w=0;w<i.length;++w){var A=i[w],P=this._device.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,A.count*A.stride,A.stride));P.update(A.buffer.buffer),T.push(P),E.push(new Uint8Array(P.size)),C.push(P)}var I=this._device.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),I.update(R),C.push(I);for(var D=t.inputAssembler.attributes,O=new Array(D.length+1),M=0;M<D.length;++M)O[M]=D[M];O[D.length]=new Ho("a_dyn_batch_id",Tr.R32F,!1,i.length);var N=new jo(O,C),L=this._device.createInputAssembler(N),B=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,yd.SIZE,yd.SIZE));l.bindBuffer(yd.BINDING,B),l.update();var F=new Float32Array(yd.COUNT);Oi.toArray(F,n.transform.worldMatrix,yd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:T,vbDatas:E,vbIdx:I,vbIdxData:R,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),Wv=new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.DEVICE),qv=new wo(null),Xv=new ea(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(zv||(zv={}));var Yv=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Ua,this._dss=new Fa,this._rs=new Ba,this._priority=G_.DEFAULT,this._stage=k_.DEFAULT,this._phase=Hv("default"),this._primitive=Yr.TRIANGLE_LIST,this._batchingScheme=zv.NONE,this._dynamicStates=Jr.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(Hv(e.phase));var n=t._bs;if(e.blendState){var i=e.blendState,r=i.targets;r&&r.forEach((function(t,e){n.setTarget(e,t)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,n=Lv.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return n+=function(t){for(var e,n=",bs,"+t.isA2C,i=W(t.targets);!(e=i()).done;){var r=e.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(t._bs),n+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),Da(n+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=Cr.UNKNOWN);var i=this._propertyHandleMap[t];return i?(n?i=bv(i,n):e&&(i=bv(i,gv(i)-e)),i+e):0},e.getBinding=function(e){var n=this.getHandle(e);return n?t.getBindingFromHandle(n):-1},e.setUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);Ev[r](a,n,o),this._setRootBufferDirty(!0)},e.getUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);return Tv[r](a,n,o)},e.setUniformArray=function(e,n){for(var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=Sa(r)>>2,a=this._getBlockView(r,i),s=t.getOffsetFromHandle(e),c=0;c<n.length;c++,s+=o)null!==n[c]&&Ev[r](a,n[c],s);this._setRootBufferDirty(!0)},e.bindTexture=function(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)},e.bindSampler=function(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)},e.setDynamicState=function(t,e){var n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):w(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new Vv(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new jv(this))},e._initNative=function(){},e._destroy=function(){},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},e.resetUniform=function(e){var n=this.getHandle(e);if(n){for(var i=t.getTypeFromHandle(n),r=t.getBindingFromHandle(n),o=t.getOffsetFromHandle(n),a=t.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[e],l=c&&c.value||wv(i),u=(Sa(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},e.resetTexture=function(e,n){var i=this.getHandle(e);if(i){var r=t.getTypeFromHandle(i),o=t.getBindingFromHandle(i),a=this._properties[e],s=a&&a.value,c=s?s+"-texture":wv(r),l=Gv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?ja.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),f=this._device.getSampler(h);this._descriptorSet.bindSampler(o,f,n),this._descriptorSet.bindTexture(o,u,n)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],n=0,i=0;i<e.members.length;i++){for(var r=e.members[i],o=this._getBlockView(r.type,e.binding),a=this._properties[r.name],s=a&&a.value||wv(r.type),c=(Sa(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],n=0;n<e.count;n++)this.resetTexture(e.name,n)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var n=Lv.getGFXShader(this._device,this._programName,this._defines,e);return n?(this._shader=n,this._setPipelineLayout(Lv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,n=0;n<t.length;n++){var i=t[n];this._defines[i.name]=i.value}for(var r=Lv.getGFXShader(this._device,this._programName,this._defines,e),o=0;o<t.length;o++){var a=t[o];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._setPriority=function(t){this._priority=t},e._setStage=function(t){this._stage=t},e._setPhase=function(t){this._phase=t},e._setPrimitive=function(t){this._primitive=t},e._setState=function(t,e,n,i){this._bs=t,this._dss=e,this._rs=n,this._descriptorSet=i},e._doInit=function(e,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(G_.DEFAULT),this._setStage(k_.DEFAULT),this._setPhase(Hv("default")),this._setPrimitive(Yr.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=n?B({},e.defines):e.defines,this._shaderInfo=Lv.getTemplate(e.program),this._properties=e.properties||this._properties;var i=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),Xv.layout=Lv.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(Xv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Lv.getTemplateInfo(e.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,f=0;f<r.length;f++){var p=a[f];l.push(h),h+=Math.ceil(p/c)*c,u=p}var _=l[l.length-1]+u;_&&(Wv.size=16*Math.ceil(_/16),this._rootBuffer=i.createBuffer(Wv),this._rootBlock=new ArrayBuffer(_));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];qv.buffer=this._rootBuffer,qv.offset=l[m++],qv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(qv);this._blocks[v]=new Float32Array(this._rootBlock,qv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var b in this._properties){var T=this._properties[b];T.handleInfo&&(S[b]=this.getHandle.apply(this,T.handleInfo))}Object.assign(x,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(br.INSTANCED_ARRAYS)?this._setBatchingScheme(zv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(zv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(zv.VB_MERGING):this._setBatchingScheme(zv.NONE)},e._setBatchingScheme=function(t){this._batchingScheme=t},e._setDynamicState=function(t){this._dynamicStates=t},e._setHash=function(t){this._hash=t},e._getBlockView=function(t,e){return t<Cr.FLOAT?this._blocksInt[e]:this._blocks[e]},e._setPipelineLayout=function(t){this._pipelineLayout=t},e._initPassFromTarget=function(t,e,n,i){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(n,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(Lv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^i)},L(t,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Lv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();Yv.getTypeFromHandle=gv,Yv.getBindingFromHandle=yv,Yv.getCountFromHandle=xv,Yv.getOffsetFromHandle=Sv;var Kv,Qv=new ea(null),Zv=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=G_.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var e=t.prototype;return e._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},e._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},e._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},e._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},e._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},e._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},e._setSubMesh=function(t){this._subMesh=t},e._init=function(){},e.initialize=function(t,e,n){void 0===n&&(n=null);var r=i.director.root;this._device=r.device,Qv.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(Qv);var o=i.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),a=new ea(null);if(a.layout=o.localSetLayout,this._createWorldBoundDescriptorSet(a),this._setSubMesh(t),this._patches=n,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===zv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=G_.DEFAULT,e[0].phase===Hv("reflection")){var s=r.mainWindow.width,c=r.mainWindow.height,l=512;c<s?(s=l*s/c,c=l):c=l*c/(s=l),this._reflectionTex=this._device.createTexture(new Ro(Rr.TEX2D,Dr.STORAGE|Dr.TRANSFER_SRC|Dr.SAMPLED,Tr.RGBA8,s,c)),this.descriptorSet.bindTexture(qd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Oo(Lr.LINEAR,Lr.LINEAR,Lr.NONE,Br.CLAMP,Br.CLAMP,Br.CLAMP)),this.descriptorSet.bindSampler(qd,this._reflectionSampler),this.descriptorSet.bindTexture(Kd,this._reflectionTex)}},e._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowShader=function(){var t=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},e._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},e._destroy=function(){},e.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=G_.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var n=0;n<e.length;n++){var i=e[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,n=t.length;e<n;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},L(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?w(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===zv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Qv.layout=t[0].localSetLayout,this._createDescriptorSet(Qv)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===zv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Jv=new Oi,$v=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Kv||(Kv={}));var tg,eg,ng=new Oo(Lr.LINEAR,Lr.LINEAR,Lr.NONE,Br.CLAMP,Br.CLAMP,Br.CLAMP),ig=new Oo(Lr.LINEAR,Lr.LINEAR,Lr.LINEAR,Br.CLAMP,Br.CLAMP,Br.CLAMP),rg=function(){function t(){this.type=Kv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(md.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new ki,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=U_.Enum.NONE,this._device=i.director.root.device}var e=t.prototype;return e._setReceiveShadow=function(t){this._receiveShadow=t},e._init=function(){},e.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=U_.Enum.NONE,this._inited=!0)},e._destroySubmodel=function(t){t.destroy()},e._destroy=function(){},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var n=this._subModels[e];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e._applyLocalData=function(){},e._applyLocalBuffer=function(){},e._applyWorldBoundBuffer=function(){},e.updateUBOs=function(t){for(var e=this._subModels,n=0;n<e.length;n++)e[n].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Oi.toArray(this._localData,i,md.MAT_WORLD_OFFSET),Oi.inverseTranspose(Jv,i);var a=Math.abs(Oi.determinant(Jv)),s=1/Math.sqrt(a);Oi.multiplyScalar(Jv,Jv,s),Oi.toArray(this._localData,Jv,md.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},e._updateNativeBounds=function(){},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=Bc.fromPoints(Bc.create(),t,e),this._worldBounds=Bc.clone(this._modelBounds),this._updateNativeBounds())},e._createSubModel=function(){return new Zv},e.initSubModel=function(t,e,n){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){ki.toArray(this._localData,e,md.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Gv.get("empty-texture"));var n=t.getGFXTexture();if(n)for(var i=this._device.getSampler(t.mipmaps.length>1?ig:ng),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(kd,n),a.bindSampler(kd,i),a.update()}},e.getMacroPatches=function(){return this.receiveShadow?$v:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var n=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(n.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,n=0;n<e.length;n++)if(e[n].name===t)return n;return-1},e._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(br.INSTANCED_ARRAYS)){for(var n=0,i=0;i<t.length;i++){var r=t[i];r.isInstanced&&(n+=fa[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<t.length;s++){var c=t[s];if(c.isInstanced){var l=new Ho;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=fa[c.format],h=new(ba(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}e.batchingScheme===zv.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(gd)),this._localDataUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.DEVICE,md.SIZE,md.SIZE)),this._applyLocalBuffer())},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.DEVICE,vd.SIZE,vd.SIZE)),this._applyWorldBoundBuffer())},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(md.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(vd.BINDING,this._worldBoundBuffer)},L(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(tg||(tg={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(eg||(eg={})),i.internal.TransformBit=eg;var og,ag,sg,cg,lg,ug,hg,fg,pg=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.activate=function(){},e.update=function(t){var e=this._mainLight;e&&e.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(t),c.updateUBOs(t))}},e._destroy=function(){},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=W(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=eg.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=W(this._models);!(t=e()).done;){var n=t.value;n.detachFromScene(),n.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=W(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},e._createNativeObject=function(){},L(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}(),_g=t("EffectAsset",ol("cc.EffectAsset")((fg=hg=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"techniques",sg,V(e)),q(e,"shaders",cg,V(e)),q(e,"combinations",lg,V(e)),q(e,"hideInEditor",ug,V(e)),e}F(e,t),e.register=function(t){e._effects[t.name]=t},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return void delete e._effects[n]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return e._effects[n];return null},e.getAll=function(){return e._effects};var n=e.prototype;return n.onLoaded=function(){Lv.register(this),e.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var t=this,e=i.director.root,n=function(n){var i=t.shaders[n],r=t.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,n){for(var i=r[e],o=0;o<i.length;++o){var a=B({},n);a[e]=i[o],t.push(a)}return t}),[])}),[{}]).forEach((function(t){return Lv.getGFXShader(e.device,i.name,t,e.pipeline)}))},r=0;r<this.shaders.length;r++)n(r)},n.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},n.initDefault=function(n){t.prototype.initDefault.call(this,n);var i=e.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Bu),hg._effects={},sg=X((ag=fg).prototype,"techniques",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cg=X(ag.prototype,"shaders",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lg=X(ag.prototype,"combinations",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ug=X(ag.prototype,"hideInEditor",[hl,pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),og=ag))||og);i.EffectAsset=_g;var dg=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,n,i,r){var o=e.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=e.pipelineLayout,c=new ia(r.attributes),l=new ka(n,s,i,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},t}());dg._PSOHashMap=new Map;var mg=new xo,vg=new fo;function gg(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var yg,xg,Sg,bg,Tg,Eg,Cg,wg,Ag,Pg,Ig=null;function Rg(t,e,n,i,r){if(i&&i.enabled&&r===Ig){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;mg.width=vg.width=r.window.width,mg.height=vg.height=r.window.height;var u=dg.getOrCreatePipelineState(t,s[0],c[0],e,a);n.setViewport(mg),n.setScissor(vg),n.bindPipelineState(u),n.bindDescriptorSet(Z_.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Z_.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Dg=new ki,Og=t("Material",(yg=ol("cc.Material"),xg=kl(_g),yg((Pg=function(t){function e(){var e;return q(e=t.call(this)||this,"_effectAsset",Tg,V(e)),q(e,"_techIdx",Eg,V(e)),q(e,"_defines",Cg,V(e)),q(e,"_states",wg,V(e)),q(e,"_props",Ag,V(e)),e._passes=[],e._hash=0,e}F(e,t),e.getHash=function(t){for(var e,n=0,i=W(t.passes);!(e=i()).done;)n^=e.value.hash;return n};var n=e.prototype;return n.initialize=function(t){this._passes.length?E(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},n.reset=function(t){this.initialize(t)},n.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var n,i=W(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(t,e,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,t,e)&&(this._props[c.propertyIndex][t]=e,i=!0)}i||console.warn("illegal property name: "+t+".")},n.getProperty=function(t,e){if(void 0===e)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(t in o)return o[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},n.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var n=0;n<t._props.length;n++)this._props[n]=B({},t._props[n]);this._defines.length=t._defines.length;for(var i=0;i<t._defines.length;i++)this._defines[i]=B({},t._defines[i]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=B({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},n._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=_g.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},n._prepareInfo=function(t,e){var n=t;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(e[r]||(e[r]={}),n[r])},n._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,n=[],r=0;r<e;++r){var o=t.passes[r],a=o.passIndex=r,s=o.defines=this._defines[a]||(this._defines[a]={});if(o.stateOverrides=this._states[a]||(this._states[a]={}),void 0!==o.propertyIndex&&Object.assign(s,this._defines[o.propertyIndex]),void 0!==o.embeddedMacros&&Object.assign(s,o.embeddedMacros),!o.switch||s[o.switch]){var c=new Yv(i.director.root);c.initialize(o),n.push(c)}}return n},n._update=function(t){var n=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,t)this._passes.forEach((function(t,e){var i=n._props[e];for(var r in i||(i=n._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,n._props[t.propertyIndex]),i)n._uploadProperty(t,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},n._uploadProperty=function(t,e,n){var i=t.getHandle(e);if(!i)return!1;if(Yv.getTypeFromHandle(i)<Cr.SAMPLER1D)if(Array.isArray(n))t.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=t.properties[e])||void 0===r?void 0:r.linear){var o=n;gg(Dg,o),Dg.w=o.w,n=Dg}t.setUniform(i,n)}else t.resetUniform(e);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(t,i,n[a],a);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0},n._bindTexture=function(t,e,n,i){var r=Yv.getBindingFromHandle(e);if(n instanceof qa)t.bindTexture(r,n,i);else if(n instanceof Um){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;t.bindTexture(r,o,i),t.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=W(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new di("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},L(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Bu),Tg=X((bg=Pg).prototype,"_effectAsset",[xg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Eg=X(bg.prototype,"_techIdx",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cg=X(bg.prototype,"_defines",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wg=X(bg.prototype,"_states",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ag=X(bg.prototype,"_props",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sg=bg))||Sg));i.Material=Og;var Mg=Yt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Ng=Yt({Planar:0,ShadowMap:1}),Lg=Yt({HARD:0,SOFT:1,SOFT_2X:2}),Bg=Ng.ShadowMap+1,Fg=function(){function t(){this.fixedSphere=new oo(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Oi,this.matShadowProj=new Oi,this.matShadowViewProj=new Oi,this._normal=new vi(0,1,0),this._shadowColor=new di(0,0,0,76),this._matLight=new Oi,this._material=null,this._instancingMaterial=null,this._size=new Bi(512,512),this._enabled=!1,this._distance=0,this._type=Bg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var e=t.prototype;return e.getPlanarShader=function(t){return this._material||(this._material=new Og,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(t)},e.getPlanarInstanceShader=function(t){return this._instancingMaterial||(this._instancingMaterial=new Og,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(t)},e._setEnable=function(t){this._enabled=t},e._setType=function(t){this._type=this.enabled?t:Bg},e.initialize=function(t){this.near=t.near,this.far=t.far,this.invisibleOcclusionRange=t.invisibleOcclusionRange,this.shadowDistance=t.shadowDistance,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.fixedArea=t.fixedArea,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation},e.activate=function(){this.enabled&&this.type===Ng.Planar&&this._updatePlanarInfo()},e._updatePlanarInfo=function(){this._material||(this._material=new Og,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Og,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},e._destroy=function(){},e.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){vi.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=t}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.activate()}},{key:"near",get:function(){return this._near},set:function(t){this._near=t}},{key:"far",get:function(){return this._far},set:function(t){this._far=t}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t}},{key:"saturation",get:function(){return this._saturation},set:function(t){this._saturation=t}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),t}();Fg.MAX_FAR=2e3,Fg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=Fg,Fn(pg.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Fn(pg.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var zg={};Fn(zg,"CameraVisFlags",[{name:"GENERAL"}]),Bn(zg,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:U_.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:U_.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:U_.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:U_.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:U_.BitMask,targetName:"UI_2D"}]),i.CameraVisFlags=zg;var Ug,kg={};function Gg(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),r=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}Fn(kg,"VisibilityFlags",[{name:"GENERAL"}]),Bn(kg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:U_.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:U_.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:U_.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:U_.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:U_.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:U_.Enum,targetName:"UI_2D"}]),i.VisibilityFlags=kg,Bn(Yv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),Fn(bm.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),Fn(Fg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Ug||(Ug={}));var Hg=function(t){return 4*Math.PI*Math.PI*t*t},Vg=function(){function t(){this._baked=!1,this._color=new vi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new vi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Ug.UNKNOWN}var e=t.prototype;return e._init=function(){},e._destroy=function(){},e.initialize=function(){this._init(),this.color=new vi(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null,this._destroy()},e.update=function(){},L(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,Gg(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=eg.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}(),jg=new vi(0,0,-1),Wg=new vi,qg=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new vi(1,-1,-1),e._illuminanceHDR=Qi.SUN_ILLUM,e._illuminanceLDR=1,e._type=Ug.DIRECTIONAL,e}F(e,t);var n=e.prototype;return n.initialize=function(){t.prototype.initialize.call(this),this.illuminance=Qi.SUN_ILLUM,this.direction=new vi(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=vi.transformQuat(Wg,jg,this._node.worldRotation))},L(e,[{key:"direction",get:function(){return this._dir},set:function(t){vi.normalize(this._dir,t)}},{key:"illuminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),e}(Vg),Xg=function(t){function e(e,n){var i;(i=t.call(this,e.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var f=c._descriptorSet.getSampler(u.binding,h),p=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,f,h),i._descriptorSet.bindTexture(u.binding,p,h)}return t.prototype.tryCompile.call(V(i)),i}F(e,t);var n=e.prototype;return n.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Yv.fillPipelineInfo(this,t),Yv.fillPipelineInfo(this,e),this._onStateChange()},n.tryCompile=function(e){if(e&&!Av(this._defines,e))return!1;var n=t.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(zv.NONE)},n._onStateChange=function(){this._setHash(Yv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},L(e,[{key:"parent",get:function(){return this._parent}}]),e}(Yv),Yg=function(t){function e(e){var n;return(n=t.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}F(e,t);var n=e.prototype;return n.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var n,i=W(this._passes);!(n=i()).done;)n.value.tryCompile(t);else this._passes[e].tryCompile(t)},n.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in t)o[a]=t[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[e]||(this._states[e]={});for(var c in t)s[c]=t[c];this._passes[e].overridePipelineStates(n[e],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(t){this._hash=Og.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var n=0;n<e.length;++n)t.push(new Xg(e[n],this));return t},L(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}(Og),Kg=null,Qg=null,Zg=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var e=t.prototype;return e._setEnabled=function(t){this._enabled=t},e._setUseIBL=function(t){this._useIBL=t},e._setUseHDR=function(t){this._useHDR=t},e._setUseDiffuseMap=function(t){this._useDiffuseMap=t},e.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var n=i.director.root;n.pipeline.pipelineSceneData.isHDR?t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel):e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=i.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=Gv.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!Qg){var n=new Og;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),Qg=new Yg({parent:n})}this.enabled&&(Kg||(Kg=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Kg.renderingSubMeshes[0],Qg)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},e._updatePipeline=function(){var t=i.director.root,e=t.pipeline,n=this.useIBL?this.isRGBE?2:1:0,r=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,o=this.useHDR;e.macros.CC_USE_IBL===n&&e.macros.CC_USE_DIFFUSEMAP===r&&e.macros.CC_USE_HDR===o||(e.macros.CC_USE_IBL=n,e.macros.CC_USE_DIFFUSEMAP=r,e.macros.CC_USE_HDR=o,t.onGlobalPipelineStateChanged()),this.enabled&&Qg&&Qg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Qg)},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=i.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var n=e.getGFXTexture(),r=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(sd,r),this._globalDSManager.bindTexture(sd,n)}var o=this.diffuseMap?this.diffuseMap:this._default;if(o){var a=o.getGFXTexture(),s=t.getSampler(o.getSamplerInfo());this._globalDSManager.bindSampler(ud,s),this._globalDSManager.bindTexture(ud,a)}this._globalDSManager.update()}},e._destroy=function(){},e.destroy=function(){this._destroy()},L(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}();i.Skybox=Zg;var Jg,$g,ty=function(t){F(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=Bc.create(),e._pos=new vi,e._type=Ug.SPHERE,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Hg(.15),this.luminanceLDR=1},e.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;Bc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},L(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),n}(Vg),ey=new vi(0,0,-1),ny=new Ei,iy=new Oi,ry=new Oi,oy=new Oi,ay=new Oi,sy=function(t){F(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._dir=new vi(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=Bc.create(),e._frustum=Yc.create(),e._pos=new vi,e._type=Ug.SPOT,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e._setDirection=function(t){this._dir.set(t)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Hg(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new vi(1,-1,-1))},e.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),vi.transformQuat(this._dir,ey,this._node.getWorldRotation(ny)),vi.normalize(this._dir,this._dir),Bc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(iy),Oi.invert(iy,iy),Oi.perspective(ry,this._angle,1,.001,this._range),Oi.multiply(oy,ry,iy),this._frustum.update(oy,ay),this._needUpdate=!1)},L(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(Vg),cy=Object.freeze({__proto__:null,Ambient:Qi,Octree:Zi,get CameraFOVAxis(){return Jd},get CameraProjection(){return $d},get CameraAperture(){return tm},get CameraISO(){return em},get CameraShutter(){return nm},SKYBOX_FLAG:xm,Camera:bm,CameraVisFlags:zg,VisibilityFlags:kg,DirectionalLight:qg,ColorTemperatureToRGB:Gg,get LightType(){return Ug},nt2lm:Hg,Light:Vg,get ModelType(){return Kv},Model:rg,ShadowSize:Mg,ShadowType:Ng,PCFType:Lg,Shadows:Fg,RenderScene:pg,Skybox:Zg,SphereLight:ty,SpotLight:sy,SubModel:Zv,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function ly(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function uy(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(Jg||(Jg={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}($g||($g={}));var hy=function(){function t(t){this._device=void 0,this._format=Tr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new yo,this._region1=new yo,this._region2=new yo,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=fa[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=ba(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=uy(t,this._alignment);var n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(t,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=t;var a={chunkIdx:n,start:i,end:i+t,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(t/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,ly(s)),l=this._chunks[this.createChunk(c)];l.start+=t;var u={chunkIdx:this._chunkCount-1,start:0,end:t,texture:l.texture};return this._handles.push(u),u},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;v("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var n={texture:this._device.createTexture(new Ro(Rr.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++},e.update=function(t,e){var n=[],i=[],r=t.start/this._formatSize,o=e.byteLength/this._formatSize,a=r%t.texture.width,s=Math.floor(r/t.texture.width),c=Math.min(t.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)},e._findAvailableSpace=function(t,e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<o.length;a++){var s=o[a];if(r+t<=s.start){i=!0;break}r=s.end}!i&&r+t<=n.size&&(i=!0)}return i?r:-1},e._McDonaldAlloc=function(t){t=uy(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.end?i=!0:r>n.end?r+t<=n.size?i=!0:t<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;var o={chunkIdx:e,start:r,end:r+t,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(t/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,ly(a)),c=this._chunks[this.createChunk(s)];c.start+=t;var l={chunkIdx:this._chunkCount,start:0,end:t,texture:c.texture};return this._handles.push(l),l},t}(),fy=function(t){if(void 0===Pn[t]){var e=1<<An;Pn[t]=e,An+=1}},py=Object.freeze({__proto__:null,addStage:fy,scene:cy,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var n=[],i=e.positions.length/3,r=0;r<i;++r)n.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&n.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&n.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&n.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var o=[];o.push(new Ho(co.ATTR_POSITION,Tr.RGB32F)),e.normals&&o.push(new Ho(co.ATTR_NORMAL,Tr.RGB32F)),e.uvs&&o.push(new Ho(co.ATTR_TEX_COORD,Tr.RG32F)),e.colors&&o.push(new Ho(co.ATTR_COLOR,Tr.RGB32F));var a=t.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return e.indices&&(s=t.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new jo(o,[a],s))},get RenderQueue(){return Jg},get PassStage(){return $g},genHandle:vv,getTypeFromHandle:gv,getBindingFromHandle:yv,getCountFromHandle:xv,getOffsetFromHandle:Sv,customizeType:bv,type2reader:Tv,type2writer:Ev,getDefaultFromType:wv,overrideMacros:Av,get BatchingSchemes(){return zv},Pass:Yv,getDeviceShaderVersion:Nv,programLib:Lv,nearestPOT:ly,TextureBufferPool:hy,MaterialInstance:Yg,PassInstance:Xg,get PoolType(){return mc},NULL_HANDLE:0,get NodeView(){return vc},NodePool:bc,get PassView(){return yc},PassPool:wc,get AABBView(){return Tc},AABBPool:Ic});t("renderer",py);var _y=new vi,dy=(new vi,new vi,new vi),my=new Oi,vy=new Bc,gy=new Bc,yy=!1,xy=oo.create(0,0,0,1),Sy=new oo,by=new Yc;by.accurate=!0;var Ty=new Yc;Ty.accurate=!0;var Ey=new Yc,Cy=new Oi,wy=new Oi,Ay=new Oi,Py=new Oi,Iy=new Oi,Ry=new Oi,Dy=new Oi,Oy=new vi,My=new Bi,Ny=new vi,Ly=new vi,By=new vi(0,0,0),Fy=(new Bc,new jt((function(){return{model:null,depth:0}}),128)),zy=new jt((function(){return{model:null,depth:0}}),128),Uy=new jt((function(){return{model:null,depth:0}}),128);function ky(t,e){var n=0;t.node&&(vi.subtract(_y,t.node.worldPosition,e.position),n=vi.dot(_y,e.forward));var i=Fy.alloc();return i.model=t,i.depth=n,i}function Gy(t,e){var n=0;t.node&&(vi.subtract(_y,t.node.worldPosition,e.position),n=vi.dot(_y,e.forward));var i=zy.alloc();return i.model=t,i.depth=n,i}function Hy(t,e){var n=0;t.node&&(vi.subtract(_y,t.node.worldPosition,e.position),n=vi.dot(_y,e.forward));var i=Uy.alloc();return i.model=t,i.depth=n,i}function Vy(t,e,n){var i=e.direction,r=t.normal,o=t.distance+.001,a=1/vi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,p=t.matLight;p.m00=1-u*s,p.m01=-u*c,p.m02=-u*l,p.m03=0,p.m04=-h*s,p.m05=1-h*c,p.m06=-h*l,p.m07=0,p.m08=-f*s,p.m09=-f*c,p.m10=1-f*l,p.m11=0,p.m12=s*o,p.m13=c*o,p.m14=l*o,p.m15=1,Oi.toArray(n,p,id.MAT_LIGHT_PLANE_PROJ_OFFSET)}function jy(t,e){vi.normalize(_y,t.normal),e[id.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=_y.x,e[id.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=_y.y,e[id.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=_y.z,e[id.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}function Wy(t,e){var n=t.pipelineSceneData.validPunctualLights;n.length=0;for(var i=e.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(oo.set(xy,o.position.x,o.position.y,o.position.z,o.range),nc.sphereFrustum(xy,e.frustum)&&n.push(o))}for(var a=e.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(oo.set(xy,c.position.x,c.position.y,c.position.z,c.range),nc.sphereFrustum(xy,e.frustum)&&n.push(c))}}function qy(t,e){var n=e.scene,i=n.mainLight,r=t.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;Fy.freeArray(s),s.length=0;var c=r.castShadowObjects;Uy.freeArray(c),c.length=0,yy=!1;var l=null;if(o.enabled&&(t.pipelineUBO.updateShadowUBORange(id.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Ng.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,zy.freeArray(l),l.length=0,i&&i.node)!function(t,e,n,i,r){var o=e.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Oi.fromRT(Cy,n.node.getWorldRotation(),n.node.getWorldPosition()),Oi.invert(wy,Cy),Oi.ortho(Py,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Oi.multiply(Iy,Py,wy),Oi.invert(Ay,wy),r.matShadowView=wy,r.matShadowProj=Py,r.matShadowViewProj=Iy,Yc.createOrtho(t,2*a,2*s,c,l,Ay)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(t,e){if(e.node){var n=e.node,i=n.getWorldPosition(),r=n.getWorldRotation();Oi.fromRT(t,r,i),t.m08*=-1,t.m09*=-1,t.m10*=-1}}(my,i),Yc.split(by,i,my,.1,r.shadowDistance),Ty=Yc.clone(by),Oi.fromRT(Cy,n.node.rotation,By),Oi.invert(wy,Cy),Oi.invert(Ay,wy);var f=wy.clone();Ty.transform(wy),Bc.fromPoints(vy,new vi(1e7,1e7,1e7),new vi(-1e7,-1e7,-1e7)),vy.mergeFrustum(Ty);var p=2*vy.halfExtents.z;dy.set(vy.center.x,vy.center.y,vy.center.z+vy.halfExtents.z+u),vi.transformMat4(dy,dy,Ay),Oi.fromRT(Cy,n.node.rotation,dy),Oi.invert(wy,Cy),Oi.invert(Ay,wy);var _=vi.distance(by.vertices[0],by.vertices[6]);Sy.center.set(0,0,0),Sy.radius=-1,Sy.mergePoints(by.vertices);var d=.8*_+.4*Sy.radius;r.shadowCameraFar=p+u;var m=.5*d;if(Oi.ortho(Py,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Oi.multiply(Ry,Py,f),vi.transformMat4(Oy,dy,Ry);var v=2/h;My.set(v,v);var g=Oy.x%My.x,y=Oy.y%My.y;Ny.set(Oy.x-g,Oy.y-y,Oy.z),Oi.invert(Dy,Ry),vi.transformMat4(Ly,Ny,Dy),Oi.fromRT(Cy,n.node.rotation,Ly),Oi.invert(wy,Cy),Oi.invert(Ay,wy),Yc.createOrtho(t,d,d,.1,r.shadowCameraFar,Ay)}else{for(var x=0;x<8;x++)t.vertices[x].set(0,0,0);t.updatePlanes()}Oi.multiply(Iy,Py,wy),r.matShadowView=wy,r.matShadowProj=Py,r.matShadowViewProj=Iy}}(Ey,t,i,e,o);else{for(var u=0;u<8;u++)Ey.vertices[u].set(0,0,0);Ey.updatePlanes()}i&&o.type===Ng.Planar&&function(t,e){var n=t.pipelineSceneData.shadows,i=e.direction,r=n.normal,o=n.distance+.001,a=1/vi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,p=n.matLight;p.m00=1-u*s,p.m01=-u*c,p.m02=-u*l,p.m03=0,p.m04=-h*s,p.m05=1-h*c,p.m06=-h*l,p.m07=0,p.m08=-f*s,p.m09=-f*c,p.m10=1-f*l,p.m11=0,p.m12=s*o,p.m13=c*o,p.m14=l*o,p.m15=1,t.pipelineUBO.updateShadowUBORange(id.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(t,i),a.enabled&&a.model&&e.clearFlag&xm&&s.push(ky(a.model,e));for(var h=n.models,f=e.visibility,p=0;p<h.length;p++){var _=h[p];if(_.enabled&&(_.castShadow&&c.push(Hy(_,e)),o.firstSetCSM&&_.worldBounds&&(yy||(gy.copy(_.worldBounds),yy=!0),Bc.merge(gy,gy,_.worldBounds)),_.node&&(f&_.node.layer)===_.node.layer||f&_.visFlags)){if(null!=l&&_.castShadow&&_.worldBounds&&nc.aabbFrustum(_.worldBounds,Ey)&&l.push(Gy(_,e)),_.worldBounds&&!nc.aabbFrustum(_.worldBounds,e.frustum))continue;s.push(ky(_,e))}}o.firstSetCSM&&(o.shadowDistance=2*gy.halfExtents.length(),o.firstSetCSM=!1)}var Xy,Yy,Ky,Qy,Zy,Jy,$y,tx,ex,nx,ix=new Oo(Lr.LINEAR,Lr.LINEAR,Lr.NONE,Br.CLAMP,Br.CLAMP,Br.CLAMP),rx=new Oo(Lr.POINT,Lr.POINT,Lr.NONE,Br.CLAMP,Br.CLAMP,Br.CLAMP),ox=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(ix),this._pointSampler=this._device.getSampler(rx);var e=new ta(q_.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new ea(this._descriptorSetLayout))}var e=t.prototype;return e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(t,e),i=n.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(t,e),i=n.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(t,e),i=n.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var n=this._globalDescriptorSet,i=e.createDescriptorSet(new ea(this._descriptorSetLayout));this._descriptorSetMap.set(t,i);for(var r=W_.UBO_GLOBAL;r<W_.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=e.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,id.SIZE,id.SIZE));i.bindBuffer(id.BINDING,o),i.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},L(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}(),ax=new Oi,sx=new Oi,cx=new Oi,lx=new ki,ux=new ki(0,0,1,0),hx=function(){function t(){this._globalUBO=new Float32Array(ed.COUNT),this._cameraUBO=new Float32Array(nd.COUNT),this._shadowUBO=new Float32Array(id.COUNT)}t.updateGlobalUBOView=function(t,e){var n=i.director.root,r=e,o=Math.floor(t.width),a=Math.floor(t.height);r[ed.TIME_OFFSET]=n.cumulativeTime,r[ed.TIME_OFFSET+1]=n.frameTime,r[ed.TIME_OFFSET+2]=i.director.getTotalFrames(),r[ed.SCREEN_SIZE_OFFSET]=o,r[ed.SCREEN_SIZE_OFFSET+1]=a,r[ed.SCREEN_SIZE_OFFSET+2]=1/o,r[ed.SCREEN_SIZE_OFFSET+3]=1/a,r[ed.NATIVE_SIZE_OFFSET]=o,r[ed.NATIVE_SIZE_OFFSET+1]=a,r[ed.NATIVE_SIZE_OFFSET+2]=1/r[ed.NATIVE_SIZE_OFFSET],r[ed.NATIVE_SIZE_OFFSET+3]=1/r[ed.NATIVE_SIZE_OFFSET+1]},t.updateCameraUBOView=function(t,e,n){var r=(n.scene?n.scene:i.director.getScene().renderScene).mainLight,o=t.pipelineSceneData,a=o.ambient,s=o.fog,c=o.shadows,l=e,u=n.exposure,h=o.isHDR;if(l[nd.SCREEN_SCALE_OFFSET]=o.shadingScale,l[nd.SCREEN_SCALE_OFFSET+1]=o.shadingScale,l[nd.SCREEN_SCALE_OFFSET+2]=1/l[nd.SCREEN_SCALE_OFFSET],l[nd.SCREEN_SCALE_OFFSET+3]=1/l[nd.SCREEN_SCALE_OFFSET+1],l[nd.EXPOSURE_OFFSET]=u,l[nd.EXPOSURE_OFFSET+1]=1/u,l[nd.EXPOSURE_OFFSET+2]=h?1:0,l[nd.EXPOSURE_OFFSET+3]=0,r){var f=c.enabled&&c.type===Ng.ShadowMap?1:0,p=r.direction;if(ux.set(p.x,p.y,p.z,f),ki.toArray(l,ux,nd.MAIN_LIT_DIR_OFFSET),vi.toArray(l,r.color,nd.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var _=r.colorTemperatureRGB;l[nd.MAIN_LIT_COLOR_OFFSET]*=_.x,l[nd.MAIN_LIT_COLOR_OFFSET+1]*=_.y,l[nd.MAIN_LIT_COLOR_OFFSET+2]*=_.z}l[nd.MAIN_LIT_COLOR_OFFSET+3]=h?r.illuminance*u:r.illuminance}else ux.set(0,0,1,0),ki.toArray(l,ux,nd.MAIN_LIT_DIR_OFFSET),ki.toArray(l,ki.ZERO,nd.MAIN_LIT_COLOR_OFFSET);var d=a.skyColor;d.w=h?a.skyIllum*u:a.skyIllum,l[nd.AMBIENT_SKY_OFFSET+0]=d.x,l[nd.AMBIENT_SKY_OFFSET+1]=d.y,l[nd.AMBIENT_SKY_OFFSET+2]=d.z,l[nd.AMBIENT_SKY_OFFSET+3]=d.w,l[nd.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,l[nd.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,l[nd.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,l[nd.AMBIENT_GROUND_OFFSET+3]=a.mipmapCount,Oi.toArray(l,n.matView,nd.MAT_VIEW_OFFSET),Oi.toArray(l,n.node.worldMatrix,nd.MAT_VIEW_INV_OFFSET),vi.toArray(l,n.position,nd.CAMERA_POS_OFFSET),Oi.toArray(l,n.matProj,nd.MAT_PROJ_OFFSET),Oi.toArray(l,n.matProjInv,nd.MAT_PROJ_INV_OFFSET),Oi.toArray(l,n.matViewProj,nd.MAT_VIEW_PROJ_OFFSET),Oi.toArray(l,n.matViewProjInv,nd.MAT_VIEW_PROJ_INV_OFFSET),l[nd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=s.colorArray;l[nd.GLOBAL_FOG_COLOR_OFFSET]=m.x,l[nd.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,l[nd.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,l[nd.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,l[nd.GLOBAL_FOG_BASE_OFFSET]=s.fogStart,l[nd.GLOBAL_FOG_BASE_OFFSET+1]=s.fogEnd,l[nd.GLOBAL_FOG_BASE_OFFSET+2]=s.fogDensity,l[nd.GLOBAL_FOG_ADD_OFFSET]=s.fogTop,l[nd.GLOBAL_FOG_ADD_OFFSET+1]=s.fogRange,l[nd.GLOBAL_FOG_ADD_OFFSET+2]=s.fogAtten,l[nd.NEAR_FAR_OFFSET]=n.nearClip,l[nd.NEAR_FAR_OFFSET+1]=n.farClip,l[nd.VIEW_PORT_OFFSET]=o.shadingScale*n.window.width*n.viewport.x,l[nd.VIEW_PORT_OFFSET+1]=o.shadingScale*n.window.height*n.viewport.y,l[nd.VIEW_PORT_OFFSET+2]=o.shadingScale*n.window.width*n.viewport.z,l[nd.VIEW_PORT_OFFSET+3]=o.shadingScale*n.window.height*n.viewport.w},t.updateShadowUBOView=function(t,e,n){var i=t.device,r=n.scene.mainLight,o=t.pipelineSceneData.shadows,a=e;if(o.enabled){if(r&&o.type===Ng.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Oi.toArray(e,l,id.MAT_LIGHT_VIEW_OFFSET),a[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[id.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[id.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[id.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[id.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Oi.toArray(e,h,id.MAT_LIGHT_VIEW_PROJ_OFFSET);var f=am(i)?0:1;a[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=f,a[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Ng.Planar&&(Vy(o,r,a),jy(o,a));di.toArray(a,o.shadowColor,id.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,n){var i=t.device,r=t.pipelineSceneData.shadows,o=e,a=am(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case Ug.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Oi.toArray(e,l,id.MAT_LIGHT_VIEW_OFFSET),o[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[id.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[id.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[id.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[id.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Oi.toArray(e,h,id.MAT_LIGHT_VIEW_PROJ_OFFSET),lx.set(s,c,0,1-r.saturation),ki.toArray(o,lx,id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),lx.set(0,a,r.normalBias,0),ki.toArray(o,lx,id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Ug.SPOT:Oi.invert(ax,n.node.getWorldMatrix()),Oi.toArray(o,ax,id.MAT_LIGHT_VIEW_OFFSET),Oi.perspective(sx,n.angle,n.aspect,.001,n.range),Oi.multiply(cx,sx,ax),Oi.toArray(o,cx,id.MAT_LIGHT_VIEW_PROJ_OFFSET),lx.set(.01,n.range,0,1-r.saturation),ki.toArray(o,lx,id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),lx.set(1,a,r.normalBias,0),ki.toArray(o,lx,id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}lx.set(r.size.x,r.size.y,r.pcf,r.bias),ki.toArray(o,lx,id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),di.toArray(o,r.shadowColor,id.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=t.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,ed.SIZE,ed.SIZE));n.bindBuffer(ed.BINDING,i);var r=t.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,nd.SIZE,nd.SIZE));n.bindBuffer(nd.BINDING,r);var o=t.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,id.SIZE,id.SIZE));n.bindBuffer(id.BINDING,o)},e.updateGlobalUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(i.getBuffer(ed.BINDING),this._globalUBO),n.bindBuffer(ed.BINDING,i.getBuffer(ed.BINDING)),n.update()},e.updateCameraUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(i.getBuffer(nd.BINDING),this._cameraUBO),n.bindBuffer(nd.BINDING,i.getBuffer(nd.BINDING)),n.update()},e.updateShadowUBO=function(e){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=e.scene.mainLight;a&&o.has(a)&&i.bindTexture(rd,o.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,e),i.update(),r[0].updateBuffer(i.getBuffer(id.BINDING),this._shadowUBO)}},e.updateShadowUBOLight=function(e,n){t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),e.bindTexture(rd,Gv.get("default-texture").getGFXTexture()),e.bindTexture(pd,Gv.get("default-texture").getGFXTexture()),e.update(),e.getBuffer(id.BINDING).update(this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof Oi?Oi.toArray(this._shadowUBO,e,t):e instanceof di&&di.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();hx._combineSignY=0;var fx,px,_x,dx,mx,vx,gx,yx,xx,Sx,bx,Tx,Ex,Cx=t("RenderStage",(Xy=ol("RenderStage"),Yy=Ol(),Ky=Ol(),Qy=Ol(),Xy((nx=function(){function t(){q(this,"_name",$y,this),q(this,"_priority",tx,this),this._enabled=!0,q(this,"_tag",ex,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},L(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),$y=X((Jy=nx).prototype,"_name",[Yy,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),tx=X(Jy.prototype,"_priority",[Ky,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ex=X(Jy.prototype,"_tag",[Qy,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zy=Jy))||Zy));i.RenderStage=Cx;var wx,Ax=t("RenderFlow",(fx=ol("RenderFlow"),px=Ol(),_x=Ol(),dx=Ol(),mx=Ol(),vx=kl([Cx]),fx((Ex=function(){function t(){q(this,"_name",xx,this),q(this,"_priority",Sx,this),q(this,"_tag",bx,this),q(this,"_stages",Tx,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},L(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),xx=X((yx=Ex).prototype,"_name",[px,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Sx=X(yx.prototype,"_priority",[_x,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bx=X(yx.prototype,"_tag",[dx,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tx=X(yx.prototype,"_stages",[mx,vx,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gx=yx))||gx));i.RenderFlow=Ax,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(wx||(wx=t("PipelineEventType",{})));var Px,Ix,Rx,Dx,Ox,Mx,Nx,Lx,Bx,Fx,zx,Ux,kx,Gx,Hx,Vx=t("PipelineEventProcessor",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}F(e,t);var n=e.prototype;return n.on=function(t,e,n,i){return this.eventTargetOn(t,e,n,i)},n.once=function(t,e,n){return this.eventTargetOnce(t,e,n)},e}(fn)),jx=new fo,Wx=new xo,qx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},Xx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},Yx=t("RenderPipeline",(Px=ol("cc.RenderPipeline"),Ix=Ol(),Rx=Ol(),Dx=kl([Ax]),Px((Bx=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_tag",Nx,V(e)),q(e,"_flows",Lx,V(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new Vx,e._commandBuffers=[],e._pipelineUBO=new hx,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new fo,e._clusterEnabled=!1,e._bloomEnabled=!1,e}F(e,t);var n=e.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},n.createRenderPass=function(t,e,n){var i=this._device,r=new Wo,o=new qo;r.format=e,o.format=n,o.stencilStoreOp=jr.DISCARD,o.depthStoreOp=jr.DISCARD,t&ro.COLOR||(t&xm?r.loadOp=Vr.DISCARD:(r.loadOp=Vr.LOAD,r.beginAccesses=[Wr.COLOR_ATTACHMENT_WRITE])),(t&ro.DEPTH_STENCIL)!==ro.DEPTH_STENCIL&&(t&ro.DEPTH||(o.depthLoadOp=Vr.LOAD),t&ro.STENCIL||(o.stencilLoadOp=Vr.LOAD)),o.beginAccesses=[Wr.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Ko([r],o);return i.createRenderPass(a)},n.getRenderPass=function(t,e){var n=this._renderPasses.get(t);return n||(n=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,n),n)},n.applyFramebufferRatio=function(t){for(var e=this.pipelineSceneData,n=this._width*e.shadingScale,i=this._height*e.shadingScale,r=t.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);t.depthStencilTexture&&t.depthStencilTexture.resize(n,i),t.destroy(),t.initialize(new Jo(t.renderPass,r,t.depthStencilTexture))},n.generateRenderArea=function(t,e){var n=t.viewport,i=t.window.width,r=t.window.height;e.x=n.x*i,e.y=n.y*r,e.width=n.width*i,e.height=n.height*r},n.generateViewport=function(t,e){this.generateRenderArea(t,jx),e||(e=Wx);var n=this.pipelineSceneData.shadingScale;return e.left=jx.x*n,e.top=jx.y*n,e.width=jx.width*n,e.height=jx.height*n,e},n.generateScissor=function(t,e){e||(e=jx),this.generateRenderArea(t,e);var n=this.pipelineSceneData.shadingScale;return e.x*=n,e.y*=n,e.width*=n,e.height*=n,e},n.activate=function(){var t=i.director.root;this._device=t.device,this._generateConstantMacros(),this._globalDSManager=new ox(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(wx.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var n=t[e];if(n.window.swapchain)return void(Ig=n)}Ig=null}(t);for(var e=0;e<t.length;e++){var n=t[e];if(n.scene){this.emit(wx.RENDER_CAMERA_BEGIN,n),Wy(this,n),qy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(wx.RENDER_CAMERA_END,n)}}this.emit(wx.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var n=0;n<e.downsampleTexs.length;++n)e.downsampleTexs[n].destroy(),e.downsampleFramebuffers[n].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var i=0;i<e.upsampleTexs.length;++i)e.upsampleTexs[i].destroy(),e.upsampleFramebuffers[i].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(t,e){var n=new Float32Array(16),i=e.x/this._width,r=(e.x+e.width)/this._width,o=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(t){case Sr.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case Sr.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case Sr.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case Sr.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var t=new Xx,e=4*Float32Array.BYTES_PER_ELEMENT,n=4*e,i=this._device.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE|Ir.HOST,n,e));if(!i)return t;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,o,r));if(!a)return t;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Ho("a_position",Tr.RG32F),c[1]=new Ho("a_texCoord",Tr.RG32F);var l=this._device.createInputAssembler(new jo(c,[i],a));return t.quadIB=a,t.quadVB=i,t.quadIA=l,t},n.updateQuadVertexData=function(t,e){var n=this._lastUsedRenderArea;if(n.x!==t.x||n.y!==t.y||n.width!==t.width||n.height!==t.height){var i=this._genQuadVertexData(Sr.IDENTITY,t);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||Sr.IDENTITY,t);this._quadVBOnscreen.update(r),n.copy(t)}},n.destroy=function(){for(var e,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),t.prototype.destroy.call(this)},n._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(br.TEXTURE_FLOAT)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(br.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(pn.os===ln.ANDROID&&pn.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+($t.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=t},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new qx,e=this.device,n=new Wo;n.format=Tr.RGBA8,n.loadOp=Vr.CLEAR,n.storeOp=jr.STORE,n.endAccesses=[Wr.COLOR_ATTACHMENT_WRITE],t.renderPass=e.createRenderPass(new Ko([n]));var i=this._width,r=this._height;t.prefiterTex=e.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Tr.RGBA8,i>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new Jo(t.renderPass,[t.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)t.downsampleTexs.push(e.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Tr.RGBA8,i>>1,r>>1))),t.downsampleFramebuffers[o]=e.createFramebuffer(new Jo(t.renderPass,[t.downsampleTexs[o]])),t.upsampleTexs.push(e.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Tr.RGBA8,i,r))),t.upsampleFramebuffers[o]=e.createFramebuffer(new Jo(t.renderPass,[t.upsampleTexs[o]])),i>>=1,r>>=1;t.combineTex=e.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Tr.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new Jo(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},n.on=function(t,e,n,i){return this._eventProcessor.on(t,e,n,i)},n.once=function(t,e,n){return this._eventProcessor.once(t,e,n)},n.off=function(t,e,n){this._eventProcessor.off(t,e,n)},n.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},n.targetOff=function(t){this._eventProcessor.targetOff(t)},n.removeAll=function(t){this._eventProcessor.removeAll(t)},n.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},L(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}}]),e}(Bu),Nx=X((Mx=Bx).prototype,"_tag",[Ix,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lx=X(Mx.prototype,"_flows",[Rx,Dx,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ox=Mx))||Ox));i.RenderPipeline=Yx,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(Fx||(Fx={})),function(t){t[t.FORWARD=10]="FORWARD"}(zx||(zx={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(Ux||(Ux={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(kx||(kx={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(Gx||(Gx={}));var Kx=new Wo;Kx.format=Tr.RGBA8,Kx.beginAccesses=[Wr.FRAGMENT_SHADER_READ_TEXTURE],Kx.endAccesses=[Wr.FRAGMENT_SHADER_READ_TEXTURE];var Qx=new qo;Qx.format=Tr.DEPTH_STENCIL;var Zx,Jx,$x,tS,eS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,fS,pS,_S,dS,mS,vS,gS,yS,xS,SS,bS,TS,ES,CS,wS,AS,PS,IS,RS,DS,OS,MS,NS,LS,BS,FS,zS,US,kS,GS,HS,VS,jS,WS,qS,XS,YS,KS,QS,ZS,JS,$S,tb,eb,nb,ib,rb,ob,ab,sb,cb,lb,ub,hb,fb,pb,_b,db,mb,vb,gb,yb,xb,Sb,bb=new Ko([Kx],Qx),Tb={width:1,height:1,renderPassInfo:bb},Eb=t("RenderTexture",ol("cc.RenderTexture")(Hx=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._window=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},n.reset=function(t){this.initialize(t)},n.destroy=function(){if(this._window){var e=i.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},n.resize=function(t,e){this._width=Math.floor(Qn(t,1,2048)),this._height=Math.floor(Qn(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(e,n){var i=e;this._width=i.w,this._height=i.h,this._name=i.n,t.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(t){var e=i.director.root;Tb.title=this._name,Tb.width=this._width,Tb.height=this._height,Tb.renderPassInfo=t&&t.passInfo?t.passInfo:bb,this._window?(this._window.destroy(),this._window.initialize(e.device,Tb)):this._window=e.createWindow(Tb)},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return w(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return w(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new yo;return u.texOffset.x=t,u.texOffset.y=e,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},L(e,[{key:"window",get:function(){return this._window}}]),e}(Um))||Hx);i.RenderTexture=Eb,Zt(Rr),Zt(Dr),Zt(jr),Zt(Vr),Zt(Wr),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(Sb||(Sb={})),Zt(Sb),Zx=ol("RenderTextureDesc"),Jx=kl(Rr),$x=kl(Dr),tS=kl(Tr),Zx((nS=X((eS=function(){q(this,"name",nS,this),q(this,"type",iS,this),q(this,"usage",rS,this),q(this,"format",oS,this),q(this,"width",aS,this),q(this,"height",sS,this)}).prototype,"name",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iS=X(eS.prototype,"type",[Jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rr.TEX2D}}),rS=X(eS.prototype,"usage",[$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.COLOR_ATTACHMENT}}),oS=X(eS.prototype,"format",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tr.UNKNOWN}}),aS=X(eS.prototype,"width",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),sS=X(eS.prototype,"height",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),eS));var Cb,wb=(cS=ol("RenderTextureConfig"),lS=kl(Eb),cS((fS=X((hS=function(){q(this,"name",fS,this),q(this,"texture",pS,this)}).prototype,"name",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pS=X(hS.prototype,"texture",[lS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uS=hS))||uS),Ab=(_S=ol("MaterialConfig"),dS=kl(Og),_S((vS=X((mS=function(){q(this,"name",vS,this),q(this,"material",gS,this)}).prototype,"name",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gS=X(mS.prototype,"material",[dS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mS)),yS=ol("FrameBufferDesc"),xS=kl([Ee]),SS=kl(Eb),yS((TS=X((bS=function(){q(this,"name",TS,this),q(this,"renderPass",ES,this),q(this,"colorTextures",CS,this),q(this,"depthStencilTexture",wS,this),q(this,"texture",AS,this)}).prototype,"name",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ES=X(bS.prototype,"renderPass",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CS=X(bS.prototype,"colorTextures",[xS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wS=X(bS.prototype,"depthStencilTexture",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AS=X(bS.prototype,"texture",[SS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bS)),PS=ol("ColorDesc"),IS=kl(Tr),RS=kl(Vr),DS=kl(jr),OS=kl([Wr]),MS=kl([Wr]),PS((BS=X((LS=function(){q(this,"format",BS,this),q(this,"loadOp",FS,this),q(this,"storeOp",zS,this),q(this,"sampleCount",US,this),q(this,"beginAccesses",kS,this),q(this,"endAccesses",GS,this)}).prototype,"format",[IS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tr.UNKNOWN}}),FS=X(LS.prototype,"loadOp",[RS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vr.CLEAR}}),zS=X(LS.prototype,"storeOp",[DS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jr.STORE}}),US=X(LS.prototype,"sampleCount",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kS=X(LS.prototype,"beginAccesses",[OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GS=X(LS.prototype,"endAccesses",[MS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Wr.COLOR_ATTACHMENT_WRITE]}}),NS=LS))||NS),Pb=(HS=ol("DepthStencilDesc"),VS=kl(Tr),jS=kl(Vr),WS=kl(jr),qS=kl(Vr),XS=kl(jr),YS=kl([Wr]),KS=kl([Wr]),HS((JS=X((ZS=function(){q(this,"format",JS,this),q(this,"depthLoadOp",$S,this),q(this,"depthStoreOp",tb,this),q(this,"stencilLoadOp",eb,this),q(this,"stencilStoreOp",nb,this),q(this,"sampleCount",ib,this),q(this,"beginAccesses",rb,this),q(this,"endAccesses",ob,this)}).prototype,"format",[VS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tr.UNKNOWN}}),$S=X(ZS.prototype,"depthLoadOp",[jS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vr.CLEAR}}),tb=X(ZS.prototype,"depthStoreOp",[WS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jr.STORE}}),eb=X(ZS.prototype,"stencilLoadOp",[qS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vr.CLEAR}}),nb=X(ZS.prototype,"stencilStoreOp",[XS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jr.STORE}}),ib=X(ZS.prototype,"sampleCount",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rb=X(ZS.prototype,"beginAccesses",[YS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ob=X(ZS.prototype,"endAccesses",[KS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Wr.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),QS=ZS))||QS);ab=ol("RenderPassDesc"),sb=kl([Ab]),cb=kl(Pb),ab((ub=X((lb=function(){q(this,"index",ub,this),q(this,"colorAttachments",hb,this),q(this,"depthStencilAttachment",fb,this)}).prototype,"index",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),hb=X(lb.prototype,"colorAttachments",[sb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fb=X(lb.prototype,"depthStencilAttachment",[cb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pb}}),lb)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(Cb||(Cb={})),Zt(Cb);var Ib=(pb=ol("RenderQueueDesc"),_b=kl(Cb),db=kl([Ee]),pb((gb=X((vb=function(){q(this,"isTransparent",gb,this),q(this,"sortMode",yb,this),q(this,"stages",xb,this)}).prototype,"isTransparent",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yb=X(vb.prototype,"sortMode",[_b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cb.FRONT_TO_BACK}}),xb=X(vb.prototype,"stages",[db],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mb=vb))||mb);function Rb(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function Db(t,e){return t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var Ob=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new Wt((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new qt(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,n){var i=t.model.subModels[e],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=t.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=dg.getOrCreatePipelineState(t,c,l,e,s);n.bindPipelineState(u),n.bindDescriptorSet(Z_.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Z_.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}();function Mb(t){for(var e=0,n=0;n<t.stages.length;n++)e|=Hv(t.stages[n]);var i=Rb;switch(t.sortMode){case Cb.BACK_TO_FRONT:i=Db;break;case Cb.FRONT_TO_BACK:i=Rb}return new Ob({isTransparent:t.isTransparent,phases:e,sortFunc:i})}function Nb(t){t.clear()}function Lb(t){t.sort()}var Bb=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}n=e.next()}},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=dg.getOrCreatePipelineState(t,s.pass,c,e,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Z_.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(Z_.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},t}(),Fb=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(t),n=e.next()},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Z_.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,f=dg.getOrCreatePipelineState(t,s,h,e,u.ia);c!==f&&(n.bindPipelineState(f),c=f),n.bindDescriptorSet(Z_.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},t}(),zb=new jt((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Ub=new Float32Array(4),kb=[],Gb=[],Hb=new Oi,Vb=new Oi;function jb(t,e){return!(!e.worldBounds||nc.aabbWithAABB(e.worldBounds,t.aabb))}function Wb(t,e){return!(!e.worldBounds||nc.aabbWithAABB(e.worldBounds,t.aabb)&&nc.aabbFrustum(e.worldBounds,t.frustum))}var qb=Hv("forward-add"),Xb=[];function Yb(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===qb){o=a,n=!0;break}e.push(o)}return n}var Kb,Qb,Zb,Jb,$b,tT,eT,nT,iT,rT,oT,aT=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(id.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new Fb,this._batchedQueue=new Bb;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(xd.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new wo(this._lightBuffer,0,xd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}zb.freeArray(this._lightPasses),this._lightPasses.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,n=0;n<e.length;n++){var i=e[n],r=t.get(i);r&&(r.getBuffer(id.BINDING).destroy(),r.getTexture(rd).destroy(),r.getTexture(pd).destroy(),r.destroy()),t.delete(i)}},e.gatherLightPasses=function(t,e){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(Yb(a,Xb)&&(Gb.length=0,this._lightCulling(o,n),Gb.length))for(var s=0;s<a.length;s++){var c=Xb[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(xd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],f=a.inputAssembler,p=dg.getOrCreatePipelineState(t,u,h,e,f),_=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(p),n.bindDescriptorSet(Z_.MATERIAL,_),n.bindInputAssembler(f);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);kb[0]=c[m],n.bindDescriptorSet(Z_.GLOBAL,g),n.bindDescriptorSet(Z_.LOCAL,d,kb),n.draw(f)}}},e._lightCulling=function(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=!1;switch(i.type){case Ug.SPHERE:r=jb(i,t);break;case Ug.SPOT:r=Wb(i,t)}r||Gb.push(n)}},e._addRenderQueue=function(t,e,n,i){var r=t.batchingScheme;if(r===zv.INSTANCING)for(var o=0;o<Gb.length;o++){var a=Gb[o],s=t.getInstancedBuffer(a);s.merge(e,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===zv.VB_MERGING)for(var c=0;c<Gb.length;c++){var l=Gb[c],u=t.getBatchedBuffer(l);u.merge(e,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=zb.alloc();h.subModel=e,h.passIdx=i;for(var f=0;f<Gb.length;f++){var p=Gb[f];h.lights.push(p),h.dynamicOffsets.push(this._lightBufferStride*p)}this._lightPasses.push(h)}},e._updateLightDescriptorSet=function(t,e){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=t.scene.mainLight,s=am(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],f=c.getOrCreateDescriptorSet(u);if(f){var p=void 0,_=void 0;switch(h.type){case Ug.SPHERE:a&&(Vy(r,a,this._shadowUBO),jy(r,this._shadowUBO)),this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,di.toArray(this._shadowUBO,r.shadowColor,id.SHADOW_COLOR_OFFSET);break;case Ug.SPOT:if(a&&(Vy(r,a,this._shadowUBO),jy(r,this._shadowUBO)),Oi.invert(Hb,h.node.getWorldMatrix()),Oi.perspective(Vb,h.angle,h.aspect,.001,h.range),p=Vb.clone(),_=Vb.clone().invert(),Oi.multiply(Vb,Vb,Hb),Oi.toArray(this._shadowUBO,Hb,id.MAT_LIGHT_VIEW_OFFSET),Oi.toArray(this._shadowUBO,Vb,id.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[id.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[id.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[id.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[id.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[id.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=_.m10,this._shadowUBO[id.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=_.m14,this._shadowUBO[id.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=_.m11,this._shadowUBO[id.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=_.m15,this._shadowUBO[id.SHADOW_PROJ_INFO_OFFSET+0]=p.m00,this._shadowUBO[id.SHADOW_PROJ_INFO_OFFSET+1]=p.m05,this._shadowUBO[id.SHADOW_PROJ_INFO_OFFSET+2]=1/p.m00,this._shadowUBO[id.SHADOW_PROJ_INFO_OFFSET+3]=1/p.m05,di.toArray(this._shadowUBO,r.shadowColor,id.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&f.bindTexture(pd,m)}}f.update(),e.updateBuffer(f.getBuffer(id.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var n=t.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=si(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new wo(this._lightBuffer,0,xd.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case Ug.SPHERE:if(vi.toArray(Ub,l.position),Ub[3]=0,this._lightBufferData.set(Ub,c+xd.LIGHT_POS_OFFSET),Ub[0]=l.size,Ub[1]=l.range,Ub[2]=0,Ub[3]=o.enabled&&o.type===Ng.ShadowMap?1:0,this._lightBufferData.set(Ub,c+xd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),vi.toArray(Ub,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;Ub[0]*=u.x,Ub[1]*=u.y,Ub[2]*=u.z}Ub[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(Ub,c+xd.LIGHT_COLOR_OFFSET);break;case Ug.SPOT:if(vi.toArray(Ub,l.position),Ub[3]=1,this._lightBufferData.set(Ub,c+xd.LIGHT_POS_OFFSET),Ub[0]=l.size,Ub[1]=l.range,Ub[2]=l.spotAngle,Ub[3]=o.enabled&&o.type===Ng.ShadowMap?1:0,this._lightBufferData.set(Ub,c+xd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),vi.toArray(Ub,l.direction),this._lightBufferData.set(Ub,c+xd.LIGHT_DIR_OFFSET),vi.toArray(Ub,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;Ub[0]*=h.x,Ub[1]*=h.y,Ub[2]*=h.z}Ub[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(Ub,c+xd.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),sT=new Bc,cT=function(){function t(t){this._pendingModels=[],this._castModels=[],this._instancedQueue=new Fb,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Ng.Planar&&!(i.normal.length()<1e-6)){var r=t.scene,o=t.frustum,a=0!=(t.visibility&U_.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var f=this._castModels[h];if(!f.worldBounds||(Bc.transform(sT,f.worldBounds,i.matLight),nc.aabbFrustum(sT,o)))if(f.isInstancingEnabled)for(var p=f.subModels,_=0;_<p.length;_++){var d=p[_];u.merge(d,f.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Ng.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Z_.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,f=u.inputAssembler,p=dg.getOrCreatePipelineState(t,r,h,e,f);n.bindPipelineState(p),n.bindDescriptorSet(Z_.LOCAL,u.descriptorSet),n.bindInputAssembler(f),n.draw(f)}}},t}(),lT=function(){function t(){this._phaseID=Hv("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=t.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(t.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var f=s.shaders[u],p=s.inputAssembler,_=dg.getOrCreatePipelineState(i,h,f,e,p);r.bindPipelineState(_),r.bindDescriptorSet(Z_.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(Z_.LOCAL,d),r.bindInputAssembler(p),r.draw(p)}}}},t}(),uT=[new So(0,0,0,1)],hT=t("ForwardStage",(Kb=ol("ForwardStage"),Qb=kl([Ib]),Zb=Ol(),Kb((nT=eT=function(t){function e(){var e;return q(e=t.call(this)||this,"renderQueues",tT,V(e)),e._renderQueues=[],e._renderArea=new fo,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Hv("default"),e._clearFlag=4294967295,e._batchedQueue=new Bb,e._instancedQueue=new Fb,e._uiPhase=new lT,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Mb(this.renderQueues[i]);this._additiveLightQueue=new aT(this._pipeline),this._planarQueue=new cT(this._pipeline),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(Nb);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var p=f.batchingScheme;if(p===zv.INSTANCING){var _=f.getInstancedBuffer();_.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(_)}else if(p===zv.VB_MERGING){var d=f.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(Lb);var m=e.commandBuffers[0];e.pipelineUBO.updateShadowUBO(t),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(t,m),this._planarQueue.gatherShadowPasses(t,m),t.clearFlag&ro.COLOR&&(uT[0].x=t.clearColor.x,uT[0].y=t.clearColor.y,uT[0].z=t.clearColor.z,uT[0].w=t.clearColor.w),e.generateRenderArea(t,this._renderArea);var v=t.window.framebuffer,g=e.getRenderPass(t.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,uT,t.clearDepth,t.clearStencil),m.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(t,g),Rg(n,g,m,e.profiler,t),m.endRenderPass()},e}(Cx),eT.initInfo={name:"ForwardStage",priority:zx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:Cb.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Cb.BACK_TO_FRONT,stages:["default","planarShadow"]}]},tT=X(($b=nT).prototype,"renderQueues",[Qb,hl,Zb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jb=$b))||Jb)),fT=t("ForwardFlow",ol("ForwardFlow")((oT=rT=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new hT;n.initialize(hT.initInfo),this._stages.push(n)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Ax),rT.initInfo={name:V_,priority:Ux.FORWARD,stages:[]},iT=oT))||iT),pT=new Oi,_T=new Oi,dT=new Oi,mT=new Bc,vT=Hv("shadow-caster"),gT=[];function yT(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===vT){o=a,n=!0;break}e.push(o)}return n}var xT,ST,bT,TT,ET,CT,wT=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new Fb,this._batchedQueue=new Bb}var e=t.prototype;return e.gatherLightPasses=function(t,e,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===Ng.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case Ug.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;yT(l.subModels,gT)&&this.add(l,gT)}break;case Ug.SPOT:Oi.invert(pT,n.node.getWorldMatrix()),Oi.perspective(_T,n.angle,n.aspect,.001,n.range),Oi.multiply(dT,_T,pT);for(var u=0;u<s.length;u++){var h=s[u].model;yT(h.subModels,gT)&&(h.worldBounds&&(Bc.transform(mT,h.worldBounds,dT),!nc.aabbFrustum(mT,e.frustum))||this.add(h,gT))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t,e){for(var n=t.subModels,i=0;i<n.length;i++){var r=n[i],o=e[i],a=r.passes[o];if(a.batchingScheme===zv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,t.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===zv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,t),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=dg.getOrCreatePipelineState(t,a,o,e,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Z_.MATERIAL,l),n.bindDescriptorSet(Z_.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}(),AT=[new So(1,1,1,1)],PT=t("ShadowStage",ol("ShadowStage")((bT=ST=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowFrameBuffer=null,e._renderArea=new fo,e._light=null,e._globalDS=null,e}F(e,t);var n=e.prototype;return n.setUsage=function(t,e,n){this._globalDS=t,this._light=e,this._shadowFrameBuffer=n},n.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},n.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){AT[0].w=t.clearColor.w;var e=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;e.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,AT,t.clearDepth,t.clearStencil),e.endRenderPass()}},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=e.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,t,this._light,a);var s=t.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=e.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,AT,t.clearDepth,t.clearStencil),a.bindDescriptorSet(Z_.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._additiveShadowQueue=new wT(e)},e}(Cx),ST.initInfo={name:"ShadowStage",priority:zx.FORWARD,tag:0},xT=bT))||xT),IT=[],RT=t("ShadowFlow",ol("ShadowFlow")((CT=ET=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new PT;n.initialize(PT.initInfo),this._stages.push(n)}return!0},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData.shadows,i=e.pipelineSceneData.shadowFrameBufferMap,r=e.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Ng.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===Ug.SPOT&&(IT.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=t.scene.mainLight;if(l){var u=e.descriptorSet;i.has(l)||this._initShadowFrameBuffer(e,l,t.window.swapchain);for(var h=i.get(l),f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(u,l,h),p.render(t)}}for(var _=0;_<IT.length;_++){var d=IT[_],m=e.globalDSManager.getOrCreateDescriptorSet(_);i.has(d)||this._initShadowFrameBuffer(e,d,t.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(t)}}IT.length=0}else this.clearShadowMap(IT,t)}},n.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(e.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(t,e){var n=t.device,i=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,o=am(n)?Tr.R32F:Tr.RGBA8;if(!this._shadowRenderPass){var a=new Wo;a.format=o,a.loadOp=Vr.CLEAR,a.storeOp=jr.STORE,a.sampleCount=1;var s=new qo;s.format=Tr.DEPTH_STENCIL,s.depthLoadOp=Vr.CLEAR,s.depthStoreOp=jr.DISCARD,s.stencilLoadOp=Vr.CLEAR,s.stencilStoreOp=jr.DISCARD,s.sampleCount=1;var c=new Ko([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new Ro(Rr.TEX2D,Dr.DEPTH_STENCIL_ATTACHMENT,Tr.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Jo(this._shadowRenderPass,l,u));r.set(e,h)},n.clearShadowMap=function(t,e){var n=this._pipeline,i=n.pipelineSceneData,r=e.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(e)}}for(var l=0;l<t.length;l++){var u=t[l],h=i.shadowFrameBufferMap.get(u),f=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var p=0;p<this._stages.length;p++){var _=this._stages[p];_.setUsage(f,u,h),_.clearFramebuffer(e)}}},n.resizeShadowMap=function(){for(var t=this._pipeline.pipelineSceneData.shadows,e=t.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=am(i)?Tr.R32F:Tr.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,o,e.x,e.y)));var u=c.depthStencilTexture;u&&u.resize(e.x,e.y);var h=c.renderPass;c.destroy(),c.initialize(new Jo(h,l,u)),s=a.next()}else s=a.next()}t.shadowMapDirty=!1},e}(Ax),ET.initInfo={name:j_,priority:Ux.SHADOW,tag:Sb.SCENE,stages:[]},TT=CT))||TT),DT=new ki,OT=Yt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),MT=OT.LAYERED+1,NT=function(){function t(){this._fogColor=new di("#C8C8C8"),this._colorArray=new ki(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var e=t.prototype;return e._setType=function(t){this._type=this.enabled?t:MT},e._setEnable=function(t){this._enabled=t},e._setAccurate=function(t){this._accurate=t},e.initialize=function(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline()},e._updatePipeline=function(){var t=i.director.root,e=this.enabled?this.type:MT,n=this.accurate?1:0,r=t.pipeline;r.macros.CC_USE_FOG===e&&r.macros.CC_USE_ACCURATE_FOG===n||(r.macros.CC_USE_FOG=e,r.macros.CC_USE_ACCURATE_FOG=n,t.onGlobalPipelineStateChanged())},e._destroy=function(){},e.destroy=function(){this._destroy()},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),t?this.activate():(this._type=MT,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._setAccurate(t),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),DT.set(t.x,t.y,t.z,t.w),gg(this._colorArray,DT)}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),t}();function LT(t,e){for(var n,i=W(e);!(n=i()).done;){var r=n.value;Array.isArray(r)?LT(t,r):t.push(r)}}function BT(t){var e=[];return LT(e,t),e.join("")}i.Fog=NT;var FT=Ye.Flags.Destroyed,zT=Ye.Flags.PersistentMask,UT=Ge.IDENTIFIER_RE,kT="var ",GT="o",HT={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},VT=Ge.escapeForJS,jT=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return kT+this.varName+"="+this.expression+";"},t}();function WT(t,e){return e instanceof jT?new jT(e.varName,t+e.expression):t+e}function qT(t,e,n){Array.isArray(n)?(n[0]=WT(e,n[0]),t.push(n)):t.push(WT(e,n)+";")}var XT=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];qT(t,e+YT(i[0])+"=",i[1])}},t}();function YT(t){return UT.test(t)?"."+t:"["+VT(t)+"]"}XT.pool=void 0,XT.pool=new Ut((function(t){t._exps.length=0,t._targetExp=null}),1),XT.pool.get=function(t){var e=this._get()||new XT;return e._targetExp=t,e};var KT=function(){function t(t,e){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ft(),Tt(this.funcModuleCache,HT),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n=kT+this.globalVariables.join(",")+";");var i=BT(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var n=pt(t);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=t===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(t){}}}var o=this.funcs.indexOf(t);o<0&&(o=this.funcs.length,this.funcs.push(t));var a="F["+o+"]";return e&&(a="("+a+")"),this.funcModuleCache[n]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,n,i){var r=XT.pool.get(i),o=e.constructor.__props__;o||(o=Object.keys(e));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(e[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(t),XT.pool.put(r)},e.enumerateCCClass=function(t,e,n){for(var r=n.__values__,o=ge(n),a=0;a<r.length;a++){var s=r[a],c=e[s],l=o[s+"$_$default"];if(!QT(l,c))if("object"==typeof c&&c instanceof i.ValueType&&(l=Ge.getDefault(l))&&l.constructor===c.constructor){var u=GT+YT(s);this.setValueType(t,l,c,u)}else this.setObjProp(t,e,s,c)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,n=[new jT(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var i=0;i<t.length;++i)qT(n,e+"["+i+"]=",this.enumerateField(t,i,t[i]));return n},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var n="a"+ ++this.localVariableId,i=[new jT(n,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&qT(i,n+"["+r+"]=",t[r]);return i},e.enumerateField=function(t,e,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=WT(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?VT(n):("_objFlags"===e&&t instanceof Ye&&(n&=zT),n)},e.setObjProp=function(t,e,n,i){qT(t,GT+YT(n)+"=",this.enumerateField(e,n,i))},e.enumerateObject=function(t,e){var n=e.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var o=e[r];"object"==typeof o&&o&&o===e._iN$t||this.setObjProp(t,e,r,o)}},e.instantiateObj=function(t){if(t instanceof i.ValueType)return Ge.getNewValueTypeCode(t);if(t instanceof i.Asset)return this.getObjRef(t);if(t._objFlags&FT)return null;var e,n=t.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return this.getObjRef(t)}else if(this.parent instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof i.Component&&!t.node.isChildOf(this.parent))return this.getObjRef(t);e=new jT(GT,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)e=new jT(GT,"{}");else{if(n)return this.getObjRef(t);e=new jT(GT,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function QT(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof i.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return at(t)&&at(e)}return!1}var ZT,JT,$T,tE,eE,nE,iE,rE,oE,aE,sE=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},L(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?E(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();Ye.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(ZT||(ZT={}));var cE=Ye.Flags.Destroying,lE=Ye.Flags.DontDestroy,uE=Ye.Flags.Deactivating,hE=new tt("Node");function fE(t){return t?"string"==typeof t?Ft(t):t:(w(3804),null)}var pE,_E,dE,mE,vE,gE,yE,xE,SE,bE,TE,EE=t("BaseNode",ol("cc.BaseNode")((aE=oE=function(t){F(n,t),n._setScene=function(t){t._updateScene()},n._findComponent=function(t,e){var n=e,i=t._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===e)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof e)return s}return null},n._findComponents=function(t,e,n){var i=e,r=t._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===e&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof e&&n.push(c)}},n._findChildComponent=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],o=n._findComponent(r,e);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,e)))return o}return null},n._findChildComponents=function(t,e,i){for(var r=0;r<t.length;++r){var o=t[r];n._findComponents(o,e,i),o._children.length>0&&n._findChildComponents(o._children,e,i)}};var e=n.prototype;function n(e){var n;return q(n=t.call(this,e)||this,"_parent",tE,V(n)),q(n,"_children",eE,V(n)),q(n,"_active",nE,V(n)),q(n,"_components",iE,V(n)),q(n,"_prefab",rE,V(n)),n._scene=null,n._activeInHierarchy=!1,n._id=hE.getNewId(),n._name=void 0,n._eventProcessor=new i.NodeEventProcessor(V(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return e._updateScene=function(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){Tt(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(ZT.PARENT_CHANGED,n),n&&!(n._objFlags&cE)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(ZT.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(ZT.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},e.getChildByUuid=function(t){if(!t)return p("Invalid uuid"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null},e.getChildByName=function(t){if(!t)return p("Invalid name"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null},e.getChildByPath=function(t){for(var e=t.split("/"),n=this,i=function(t){var i=e[t];if(0===i.length)return"continue";var r=n.children.find((function(t){return t.name===i}));if(!r)return{v:null};n=r},r=0;r<e.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&uE)w(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&t?t(o):l&&e&&e(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var n=t[e];n&&(n.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=fE(t);return e?n._findComponent(this,e):null},e.getComponents=function(t){var e=fE(t),i=[];return e&&n._findComponents(this,e,i),i},e.getComponentInChildren=function(t){var e=fE(t);return e?n._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=fE(t),i=[];return e&&(n._findComponents(this,e,i),n._findChildComponents(this._children,e,i)),i},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=Ft(t)))throw i._RF.peek()&&w(3808,t),TypeError(R(3807,t))}else{if(!t)throw TypeError(R(3804));e=t}if("function"!=typeof e)throw TypeError(R(3809));if(!wt(e,i.Component))throw TypeError(R(3810));var n=e._requireComponent;if(n)if(Array.isArray(n))for(var r=0;r<n.length;r++){var o=n[r];this.getComponent(o)||this.addComponent(o)}else{var a=n;this.getComponent(a)||this.addComponent(a)}var s=new e;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof ih?t:this.getComponent(t))&&e.destroy()}else w(3813)},e.on=function(t,e,n,i){switch(void 0===i&&(i=!1),t){case ZT.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)},e.off=function(t,e,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case ZT.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,n,i){this._eventProcessor.once(t,e,n,i)},e.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(ZT.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&cE)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&w(3815)}}else w(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(ZT.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=i.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof i.Scene||i.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&i.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=cE;var t=this._parent,e=!!t&&0!=(t._objFlags&cE);if(this._persistNode&&i.game.removePersistRootNode(this),!e&&t){this.emit(ZT.PARENT_CHANGED,this);var n=t._children.indexOf(this);t._children.splice(n,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(ZT.CHILD_REMOVED,this)}this.emit(ZT.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var r=this._children,o=0;o<r.length;++o)r[o]._destroyImmediate();for(var a=this._components,s=0;s<a.length;++s)a[s]._destroyImmediate();return e},L(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&lE)>0},set:function(t){t?this._objFlags|=lE:this._objFlags&=~lE}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&i.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Ye),oE.idGenerator=hE,oE._stacks=[[]],oE._stackId=0,X(($T=aE).prototype,"_persistNode",[ll],Object.getOwnPropertyDescriptor($T.prototype,"_persistNode"),$T.prototype),X($T.prototype,"name",[bl],Object.getOwnPropertyDescriptor($T.prototype,"name"),$T.prototype),X($T.prototype,"children",[bl],Object.getOwnPropertyDescriptor($T.prototype,"children"),$T.prototype),X($T.prototype,"active",[bl],Object.getOwnPropertyDescriptor($T.prototype,"active"),$T.prototype),X($T.prototype,"activeInHierarchy",[bl],Object.getOwnPropertyDescriptor($T.prototype,"activeInHierarchy"),$T.prototype),X($T.prototype,"parent",[bl],Object.getOwnPropertyDescriptor($T.prototype,"parent"),$T.prototype),tE=X($T.prototype,"_parent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eE=X($T.prototype,"_children",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nE=X($T.prototype,"_active",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iE=X($T.prototype,"_components",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rE=X($T.prototype,"_prefab",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JT=$T))||JT);i._BaseNode=EE;var CE=new vi,wE=new Ei,AE=new Ei,PE=new Ei,IE=new Si,RE=new Si,DE=new Oi,OE=[],ME=[],NE=[],LE=function(){function t(){this._chunks=[],this._freelists=[],this._createChunk()}var e=t.prototype;return e.alloc=function(){for(var t=this._freelists.length,e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)},e.free=function(t,e){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===t)return void this._freelists[i].push(e)},e.clear=function(){for(var t=this._chunks.length,e=0;e<t;++e)this._chunks[e].fill(0)},e._createChunk=function(){this._chunks.push(new Uint32Array(t.CAPACITY_PER_CHUNK));for(var e=[],n=t.CAPACITY_PER_CHUNK-1;n>=0;n--)e.push(n);this._freelists.push(e)},e._createView=function(t){return NE[0]=this._chunks[t],NE[1]=this._freelists[t].pop(),NE},t}();LE.CAPACITY_PER_CHUNK=256;var BE,FE,zE,UE,kE,GE,HE,VE,jE,WE,qE,XE,YE,KE,QE,ZE,JE,$E,tC,eC,nC,iC,rC,oC,aC,sC,cC,lC,uC,hC,fC,pC,_C,dC,mC,vC,gC,yC,xC,SC,bC,TC,EC,CC,wC,AC,PC,IC,RC,DC,OC,MC,NC,LC,BC,FC,zC,UC,kC,GC,HC,VC,jC,WC,qC,XC,YC,KC,QC,ZC=new LE,JC=Symbol("ReserveContentsForAllSyncablePrefab"),$C=t("Node",(pE=ol("cc.Node"),_E=kl(vi),pE((TE=bE=function(t){F(n,t);var e=n.prototype;function n(e){var n;return(n=t.call(this,e)||this)._uiProps=new sE(V(n)),n._static=!1,q(n,"_lpos",vE,V(n)),q(n,"_lrot",gE,V(n)),q(n,"_lscale",yE,V(n)),q(n,"_layer",xE,V(n)),q(n,"_euler",SE,V(n)),n._dirtyFlagsPri=eg.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return e._init=function(){var t=ZC.alloc(),e=t[0],n=t[1];this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=n;var i=new Uint32Array(e.buffer,e.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new vi,this._rot=new Ei,this._scale=new vi(1,1,1),this._mat=new Oi},n.isNode=function(t){return t instanceof n&&(t.constructor===n||!(t instanceof i.Scene))},e._onPreDestroy=function(){var t=this._onPreDestroyBase();return ZC.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t},e[_h]=function(t){t.writeThis()},e.setParent=function(e,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,n)},e._onSetParent=function(e,n){if(t.prototype._onSetParent.call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),Oi.multiply(DE,Oi.invert(DE,i._mat),this._mat),Oi.toRTS(DE,this._lrot,this._lpos,this._lscale)):(vi.copy(this._lpos,this._pos),Ei.copy(this._lrot,this._rot),vi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(eg.TRS)},e._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},e._onBatchCreated=function(t){this.hasChangedFlags=eg.TRS,this._dirtyFlags|=eg.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(t)},e._onBeforeSerialize=function(){this.eulerAngles},e._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(eg.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},e.translate=function(t,e){var n=e||tg.LOCAL;if(n===tg.LOCAL)vi.transformQuat(CE,t,this._lrot),this._lpos.x+=CE.x,this._lpos.y+=CE.y,this._lpos.z+=CE.z;else if(n===tg.WORLD)if(this._parent){Ei.invert(wE,this._parent.worldRotation),vi.transformQuat(CE,t,wE);var i=this.worldScale;this._lpos.x+=CE.x/i.x,this._lpos.y+=CE.y/i.y,this._lpos.z+=CE.z/i.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(eg.POSITION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.POSITION)},e.rotate=function(t,e){var n=e||tg.LOCAL;if(Ei.normalize(wE,t),n===tg.LOCAL)Ei.multiply(this._lrot,this._lrot,wE);else if(n===tg.WORLD){var i=this.worldRotation;Ei.multiply(AE,wE,i),Ei.invert(wE,i),Ei.multiply(AE,wE,AE),Ei.multiply(this._lrot,this._lrot,AE)}this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.ROTATION)},e.lookAt=function(t,e){this.getWorldPosition(CE),vi.subtract(CE,CE,t),vi.normalize(CE,CE),Ei.fromViewUp(wE,CE,e),this.setWorldRotation(wE)},e._setDirtyNode=function(t,e){OE[t]=e},e.invalidateChildren=function(t){var e,n,i,r=0,o=0,a=0,s=0,c=0,l=t|eg.POSITION;for(OE[0]=this;r>=0;){if(c=(e=OE[r--])._hasChangedFlags[0],s=e._dirtyFlagsPri,e.isValid&&(s&c&t)!==t)for(s|=t,e._dirtyFlagsPri=s,e._hasChangedFlags[0]=c|t,a=(i=e._children).length,o=0;o<a;o++)n=i[o],OE[++r]=n;t=l}},e.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,n=0;e&&e._dirtyFlags;)this._setDirtyNode(n++,e),e=e._parent;for(var i=0;n;)i|=(t=OE[--n])._dirtyFlags,e?(i&eg.POSITION&&(vi.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&eg.RS&&(Oi.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Oi.multiply(t._mat,e._mat,t._mat),i&eg.ROTATION&&Ei.multiply(t._rot,e._rot,t._lrot),Si.fromQuat(IE,Ei.conjugate(PE,t._rot)),Si.multiplyMat4(IE,IE,t._mat),t._scale.x=IE.m00,t._scale.y=IE.m04,t._scale.z=IE.m08)):(i&eg.POSITION&&(vi.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&eg.RS&&(i&eg.ROTATION&&Ei.copy(t._rot,t._lrot),i&eg.SCALE&&(vi.copy(t._scale,t._lscale),Oi.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=eg.NONE,e=t}},e.setPosition=function(t,e,n){void 0===e&&void 0===n?vi.copy(this._lpos,t):void 0===n?vi.set(this._lpos,t,e,this._lpos.z):vi.set(this._lpos,t,e,n),this.invalidateChildren(eg.POSITION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.POSITION)},e.getPosition=function(t){return t?vi.set(t,this._lpos.x,this._lpos.y,this._lpos.z):vi.copy(new vi,this._lpos)},e.setRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Ei.copy(this._lrot,t):Ei.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.ROTATION)},e.setRotationFromEuler=function(t,e,n){var i=void 0===n?this._euler.z:n;void 0===e?(vi.copy(this._euler,t),Ei.fromEuler(this._lrot,t.x,t.y,t.z)):(vi.set(this._euler,t,e,i),Ei.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.ROTATION)},e.getRotation=function(t){return t?Ei.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Ei.copy(new Ei,this._lrot)},e.setScale=function(t,e,n){void 0===e&&void 0===n?vi.copy(this._lscale,t):void 0===n?vi.set(this._lscale,t,e,this._lscale.z):vi.set(this._lscale,t,e,n),this.invalidateChildren(eg.SCALE),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.SCALE)},e.getScale=function(t){return t?vi.set(t,this._lscale.x,this._lscale.y,this._lscale.z):vi.copy(new vi,this._lscale)},e.inverseTransformPoint=function(t,e){vi.copy(t,e);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)vi.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=OE[--i];return t},e.setWorldPosition=function(t,e,n){void 0===e||void 0===n?vi.copy(this._pos,t):vi.set(this._pos,t,e,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),vi.transformMat4(r,this._pos,Oi.invert(DE,i._mat))):vi.copy(r,this._pos),this.invalidateChildren(eg.POSITION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.POSITION)},e.getWorldPosition=function(t){return this.updateWorldTransform(),t?vi.copy(t,this._pos):vi.copy(new vi,this._pos)},e.setWorldRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Ei.copy(this._rot,t):Ei.set(this._rot,t,e,n,i),this._parent?(this._parent.updateWorldTransform(),Ei.multiply(this._lrot,Ei.conjugate(this._lrot,this._parent._rot),this._rot)):Ei.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.ROTATION)},e.setWorldRotationFromEuler=function(t,e,n){Ei.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),Ei.multiply(this._lrot,Ei.conjugate(this._lrot,this._parent._rot),this._rot)):Ei.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.ROTATION)},e.getWorldRotation=function(t){return this.updateWorldTransform(),t?Ei.copy(t,this._rot):Ei.copy(new Ei,this._rot)},e.setWorldScale=function(t,e,n){void 0===e||void 0===n?vi.copy(this._scale,t):vi.set(this._scale,t,e,n);var i=this._parent;i?(i.updateWorldTransform(),Si.fromQuat(IE,Ei.conjugate(PE,i._rot)),Si.multiplyMat4(IE,IE,i._mat),RE.m00=this._scale.x,RE.m04=this._scale.y,RE.m08=this._scale.z,Si.multiply(IE,RE,Si.invert(IE,IE)),this._lscale.x=vi.set(CE,IE.m00,IE.m01,IE.m02).length(),this._lscale.y=vi.set(CE,IE.m03,IE.m04,IE.m05).length(),this._lscale.z=vi.set(CE,IE.m06,IE.m07,IE.m08).length()):vi.copy(this._lscale,this._scale),this.invalidateChildren(eg.SCALE),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.SCALE)},e.getWorldScale=function(t){return this.updateWorldTransform(),t?vi.copy(t,this._scale):vi.copy(new vi,this._scale)},e.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new Oi;return Oi.copy(e,this._mat)},e.getWorldRS=function(t){this.updateWorldTransform();var e=t||new Oi;return Oi.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},e.getWorldRT=function(t){this.updateWorldTransform();var e=t||new Oi;return Oi.fromRT(e,this._rot,this._pos)},e.setRTS=function(t,e,n){var i=0;t&&(i|=eg.ROTATION,void 0!==t.w?(Ei.copy(this._lrot,t),this._eulerDirty=!0):(vi.copy(this._euler,t),Ei.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(vi.copy(this._lpos,e),i|=eg.POSITION),n&&(vi.copy(this._lscale,n),i|=eg.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,i))},e.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},e.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},n.resetHasChangedFlags=function(){ZC.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,OE.length=0,ME.length=0)},L(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(t){this._dirtyFlagsPri=t}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Ei.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){vi.set(this._euler,0,0,t),Ei.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(eg.ROTATION),1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){Oi.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(eg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(ZT.TRANSFORM_CHANGED,eg.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return vi.transformQuat(new vi,vi.FORWARD,this.worldRotation)},set:function(t){var e=t.length();vi.multiplyScalar(CE,t,-1/e),Ei.fromViewUp(wE,CE),this.setWorldRotation(wE)}},{key:"up",get:function(){return vi.transformQuat(new vi,vi.UP,this.worldRotation)}},{key:"right",get:function(){return vi.transformQuat(new vi,vi.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(ZT.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}}]),n}(EE),bE.EventType=ZT,bE.NodeSpace=tg,bE.TransformDirtyBit=eg,bE.TransformBit=eg,bE.reserveContentsForAllSyncablePrefabTag=JC,bE.ClearFrame=0,bE.ClearRound=1e3,vE=X((mE=TE).prototype,"_lpos",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),gE=X(mE.prototype,"_lrot",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei}}),yE=X(mE.prototype,"_lscale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(1,1,1)}}),xE=X(mE.prototype,"_layer",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U_.Enum.DEFAULT}}),SE=X(mE.prototype,"_euler",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),X(mE.prototype,"eulerAngles",[_E],Object.getOwnPropertyDescriptor(mE.prototype,"eulerAngles"),mE.prototype),X(mE.prototype,"angle",[bl],Object.getOwnPropertyDescriptor(mE.prototype,"angle"),mE.prototype),X(mE.prototype,"layer",[bl],Object.getOwnPropertyDescriptor(mE.prototype,"layer"),mE.prototype),dE=mE))||dE));i.Node=$C;var tw=ol("cc.TargetInfo")((zE=X((FE=function(){q(this,"localID",zE,this)}).prototype,"localID",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BE=FE))||BE,ew=(UE=ol("cc.TargetOverrideInfo"),kE=kl(Ye),GE=kl(tw),HE=kl($C),VE=kl(tw),UE((qE=X((WE=function(){q(this,"source",qE,this),q(this,"sourceInfo",XE,this),q(this,"propertyPath",YE,this),q(this,"target",KE,this),q(this,"targetInfo",QE,this)}).prototype,"source",[hl,kE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XE=X(WE.prototype,"sourceInfo",[hl,GE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YE=X(WE.prototype,"propertyPath",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KE=X(WE.prototype,"target",[hl,HE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QE=X(WE.prototype,"targetInfo",[hl,VE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jE=WE))||jE),nw=ol("cc.CompPrefabInfo")(($E=X((JE=function(){q(this,"fileId",$E,this)}).prototype,"fileId",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZE=JE))||ZE,iw=(tC=ol("CCPropertyOverrideInfo"),eC=kl(tw),tC((sC=function(){function t(){q(this,"targetInfo",rC,this),q(this,"propertyPath",oC,this),q(this,"value",aC,this)}return t.prototype.isTarget=function(){},t}(),rC=X((iC=sC).prototype,"targetInfo",[hl,eC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oC=X(iC.prototype,"propertyPath",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aC=X(iC.prototype,"value",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nC=iC))||nC),rw=(cC=ol("cc.MountedChildrenInfo"),lC=kl(tw),uC=kl([$C]),cC((dC=function(){function t(){q(this,"targetInfo",pC,this),q(this,"nodes",_C,this)}return t.prototype.isTarget=function(){},t}(),pC=X((fC=dC).prototype,"targetInfo",[hl,lC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_C=X(fC.prototype,"nodes",[hl,uC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hC=fC))||hC),ow=(mC=ol("cc.MountedComponentsInfo"),vC=kl(tw),gC=kl([ih]),mC((TC=function(){function t(){q(this,"targetInfo",SC,this),q(this,"components",bC,this)}return t.prototype.isTarget=function(){},t}(),SC=X((xC=TC).prototype,"targetInfo",[hl,vC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bC=X(xC.prototype,"components",[hl,gC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yC=xC))||yC),aw=(EC=ol("cc.PrefabInstance"),CC=kl($C),wC=kl([rw]),AC=kl([ow]),PC=kl([iw]),IC=kl([tw]),EC((zC=function(){function t(){q(this,"fileId",OC,this),q(this,"prefabRootNode",MC,this),q(this,"mountedChildren",NC,this),q(this,"mountedComponents",LC,this),q(this,"propertyOverrides",BC,this),q(this,"removedComponents",FC,this),this.targetMap={}}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),OC=X((DC=zC).prototype,"fileId",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MC=X(DC.prototype,"prefabRootNode",[hl,CC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NC=X(DC.prototype,"mountedChildren",[hl,wC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LC=X(DC.prototype,"mountedComponents",[hl,AC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BC=X(DC.prototype,"propertyOverrides",[hl,PC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FC=X(DC.prototype,"removedComponents",[hl,IC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RC=DC))||RC),sw=(UC=ol("cc.PrefabInfo"),kC=kl($C),GC=kl(aw),HC=kl([ew]),UC((WC=X((jC=function(){q(this,"root",WC,this),q(this,"asset",qC,this),q(this,"fileId",XC,this),q(this,"instance",YC,this),q(this,"targetOverrides",KC,this),q(this,"nestedPrefabInstanceRoots",QC,this)}).prototype,"root",[hl,kC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qC=X(jC.prototype,"asset",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XC=X(jC.prototype,"fileId",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),YC=X(jC.prototype,"instance",[hl,GC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KC=X(jC.prototype,"targetOverrides",[hl,HC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QC=X(jC.prototype,"nestedPrefabInstanceRoots",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),VC=jC))||VC);function cw(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return w(3701,t.name),void(e.instance=void 0);var n=t._objFlags,r=t._parent,o=t._id,a=t._prefab;t[We],i.game._isCloning=!0,e.asset._doInstantiate(t),i.game._isCloning=!1,t._objFlags=n,t._parent=r,t._id=o,t._prefab&&(t._prefab.instance=null==a?void 0:a.instance)}}function lw(t,e,n){var i;if(e&&t){var r=e,o=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&o&&(e[o.fileId]={},r=e[o.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var s=t.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<t.children.length;u++)lw(t.children[u],r,!1)}}function uw(t,e){if(!t)return null;for(var n=e,i=0;i<t.length;i++){if(!n)return null;n=n[t[i]]}return n}function hw(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=uw(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,lw(u,a,!1),u._siblingIndex=o._children.length-1,mw(u,!0))}}}}function fw(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=uw(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function pw(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r){var o=uw(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function _w(t,e,n){if(!(e.length<=0))for(var i=null,r=0;r<e.length;r++){var o=e[r];if(o&&o.targetInfo){if(!(i=uw(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof Jt?a[c].set(o.value):a[c]=o.value}}}}function dw(t){var e,n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=uw(c.localID,h.targetMap))}if(s){var f,p=a.targetInfo;if(p){var _=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(_&&_.targetMap&&(f=uw(p.localID,_.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=f}}}}}}function mw(t,e){void 0===e&&(e=!1);var n=t._prefab,i=null==n?void 0:n.instance;if(i){cw(t);var r={};i.targetMap=r,lw(t,r,!0),hw(0,i.mountedChildren,r),pw(0,i.removedComponents,r),fw(0,i.mountedComponents,r),_w(0,i.propertyOverrides,r)}e&&t&&t.children&&t.children.forEach((function(t){mw(t,!0)}))}function vw(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){mw(t)}))}i._PrefabInfo=sw;var gw,yw,xw,Sw,bw,Tw,Ew,Cw,ww,Aw,Pw,Iw,Rw,Dw,Ow=Object.freeze({__proto__:null,TargetInfo:tw,TargetOverrideInfo:ew,CompPrefabInfo:nw,PropertyOverrideInfo:iw,MountedChildrenInfo:rw,MountedComponentsInfo:ow,PrefabInstance:aw,PrefabInfo:sw,createNodeWithPrefab:cw,generateTargetMap:lw,getTarget:uw,applyMountedChildren:hw,applyMountedComponents:fw,applyRemovedComponents:pw,applyPropertyOverrides:_w,applyTargetOverrides:dw,expandPrefabInstanceNode:mw,expandNestedPrefabInstanceNode:vw}),Mw=Yt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Nw=t("Prefab",ol("cc.Prefab")((Ew=Tw=function(t){function e(){var e;return q(e=t.call(this)||this,"data",xw,V(e)),q(e,"optimizationPolicy",Sw,V(e)),q(e,"persistent",bw,V(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}F(e,t);var n=e.prototype;return n.createNode=function(t){var e=i.instantiate(this);e.name=this.name,t(null,e)},n.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof i._BaseNode&&t,new KT(t,e).result)},n._doInstantiate=function(t){return this.data._prefab||E(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},n._instantiate=function(){var t;return this.optimizationPolicy!==Mw.SINGLE_INSTANCE&&(this.optimizationPolicy===Mw.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new $C,this.data.name="(Missing Node)";var n=new i._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var t=this.data;vw(t),dw(t)},e}(Bu),Tw.OptimizationPolicy=Mw,Tw.OptimizationPolicyThreshold=3,xw=X((yw=Ew).prototype,"data",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sw=X(yw.prototype,"optimizationPolicy",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mw.AUTO}}),bw=X(yw.prototype,"persistent",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gw=yw))||gw);Gt.value(Nw,"_utils",Ow),i.Prefab=Nw,_t(i,"cc._Prefab","Prefab"),t("PrefabLink",(Cw=ol("cc.PrefabLink"),ww=kl(Nw),Aw=Tl(),Cw((Dw=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"prefab",Rw,V(e)),e}return F(e,t),e}(ih),Rw=X((Iw=Dw).prototype,"prefab",[ww,hl,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pw=Iw))||Pw));var Lw=new vi;function Bw(t,e,n,i){i||(i=new vi),t.convertToUINode(e,n,i);var r=n.position;return i.add(r),i}function Fw(t,e,n){return n||(n=new vi),t.worldToScreen(e,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}var zw,Uw,kw=t("convertUtils",{WorldNode3DToLocalNodeUI:Bw,WorldNode3DToWorldNodeUI:Fw});i.pipelineUtils=kw,Bn(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[0],r=e[3]||Lw;return i.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]),Fn(Um.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Bn(Eb.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Gw,Hw=t("BufferAsset",ol("cc.BufferAsset")((X((Uw=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._buffer=null,e}F(e,t);var n=e.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},L(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Bu)).prototype,"_nativeAsset",[Ql],Object.getOwnPropertyDescriptor(Uw.prototype,"_nativeAsset"),Uw.prototype),zw=Uw))||zw);i.BufferAsset=Hw;var Vw=((Gw={})[Er.UNORM]="Uint",Gw[Er.SNORM]="Int",Gw[Er.UINT]="Uint",Gw[Er.INT]="Int",Gw[Er.UFLOAT]="Float",Gw[Er.FLOAT]="Float",Gw.default="Uint",Gw);function jw(t){return""+(Vw[t.type]||Vw.default)+t.size/t.count*8}function Ww(t,e,n,i,r){void 0===n&&(n=Tr.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=fa[n];r||(r=o.size);for(var a="set"+jw(o),s=o.size/o.count,c=Math.floor(e.length/o.count),l=ph.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,f=0;f<o.count;++f){var p=h+s*f;t[a](p,e[o.count*u+f],l)}}function qw(t,e,n,i,r,o){void 0===e&&(e=Tr.R32F),void 0===n&&(n=0),void 0===i&&(i=t.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=fa[e];r||(r=a.size);for(var s="get"+jw(a),c=a.size/a.count,l=Math.floor(i/r),u=ph.isLittleEndian,h=0;h<l;++h)for(var f=n+r*h,p=0;p<a.count;++p){var _=f+c*p;o[a.count*h+p]=t[s](_,u)}return o}function Xw(t,e,n,i,r,o,a){void 0===n&&(n=Tr.R32F),void 0===i&&(i=0),void 0===r&&(r=t.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var s=fa[n];o||(o=s.size);for(var c="set"+jw(s),l="get"+jw(s),u=s.size/s.count,h=Math.floor(r/o),f=ph.isLittleEndian,p=0;p<h;++p)for(var _=i+o*p,d=0;d<s.count;++d){var m=_+u*d,v=t[l](m,f);a[c](m,e(v,d,t),f)}return a}var Yw,Kw,Qw=t("RenderingSubMesh",function(){var t=e.prototype;function e(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new jo(e,t,i,r),this._init()}return t._init=function(){},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(e=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=t.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=t.readIndices(this.subMeshIdx),f=0;f<e;++f)for(var p=f*s,_=h[f]*s,d=0;d<s;++d)u[p+d]=l[_+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},t.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new Ho("a_vertexId",Tr.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}},t._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e),i=0;i<e;++i)n[i]=i+.5;var r=t.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},L(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:vi.ZERO,max:vi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:vi.ZERO,max:vi.ZERO}};var t=this.mesh,e=this.subMeshIdx,n=t.readAttribute(e,co.ATTR_POSITION),i=t.readIndices(e),r=new vi,o=new vi,a=this.attributes.find((function(t){return t.name===co.ATTR_POSITION}));if(a){var s=fa[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var r,o,a=this.mesh.struct,s=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===s.jointMapIndex||!a.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=i.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=a.vertexBundles[s.vertexBundelIndices[l]];o=0,r=Tr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var f=u.attributes[h];if(f.name===co.ATTR_JOINTS){r=f.format;break}o+=fa[f.format].size}r?function(){var i=new Uint8Array(t.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(i.slice().buffer),f=a.jointMaps[s.jointMapIndex];Xw(h,(function(t){return f.indexOf(t)}),r,o,u.view.length,u.view.stride,h);var p=c.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,u.view.length,u.view.stride));p.update(h.buffer),e.push(p),n.push(l)}():e.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(c)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}());!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Yw||(Yw=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(Kw||(Kw={})),i.SystemEventType=Yw;var Zw,Jw=new Array(16),$w=null,tA=new Bi,eA=[ZT.TOUCH_START,ZT.TOUCH_MOVE,ZT.TOUCH_END,ZT.TOUCH_CANCEL],nA=[ZT.MOUSE_DOWN,ZT.MOUSE_ENTER,ZT.MOUSE_MOVE,ZT.MOUSE_LEAVE,ZT.MOUSE_UP,ZT.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(Zw||(Zw={}));var iA,rA,oA,aA,sA,cA,lA,uA,hA,fA,pA,_A,dA,mA,vA,gA,yA,xA,SA,bA,TA,EA,CA,wA,AA,PA,IA,RA,DA,OA,MA,NA,LA,BA,FA,zA,UA,kA,GA,HA,VA,jA,WA,qA,XA,YA,KA,QA,ZA,JA,$A,tP,eP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,fP,pP,_P,dP,mP,vP,gP,yP,xP,SP,bP,TP,EP,CP,wP,AP,PP,IP,RP,DP,OP,MP,NP,LP,BP,FP,zP,UP,kP,GP,HP,VP,jP,WP,qP,XP,YP,KP,QP,ZP,JP,$P,tI,eI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,fI,pI,_I,dI,mI,vI,gI,yI,xI,SI,bI,TI,EI,CI,wI,AI,PI,II,RI,DI,OI,MI,NI,LI,BI,FI,zI,UI,kI,GI,HI,VI,jI,WI,qI,XI,YI,KI,QI,ZI,JI,$I,tR,eR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,fR,pR,_R,dR,mR,vR,gR,yR,xR,SR,bR,TR,ER,CR,wR,AR,PR,IR,RR,DR,OR,MR,NR,LR,BR,FR=function(){var t=e.prototype;function e(t){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(Zw.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t._searchComponentsInParent=function(t){var e=this.node;if(t){for(var n=0,i=[],r=e;r&&$C.isNode(r);r=r.parent,++n){var o=r.getComponent(t);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){$w===this._node&&($w=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(Zw.REMOVE_POINTER_EVENT_PROCESSOR,this)},t._isTouchEvent=function(t){return-1!==eA.indexOf(t)},t._isMouseEvent=function(t){return-1!==nA.indexOf(t)},t._hasTouchListeners=function(){for(var t=0;t<eA.length;++t){var e=eA[t];if(this.hasEventListener(e))return!0}return!1},t._hasMouseListeners=function(){for(var t=0;t<nA.length;++t){var e=nA[t];if(this.hasEventListener(e))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(Zw.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new rn;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(Zw.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t.on=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n),e},t.once=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n,!0),e},t.off=function(t,e,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(Zw.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(t,e,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,n,i,r,o)},t.dispatchEvent=function(t){var e,n=this.node,i=0;for(t.target=n,Jw.length=0,this.getCapturingTargets(t.type,Jw),t.eventPhase=1,i=Jw.length-1;i>=0;--i)if((e=Jw[i]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,Jw),t.propagationStopped))return void(Jw.length=0);if(Jw.length=0,t.eventPhase=2,t.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,Jw),t.eventPhase=3,i=0;i<Jw.length;++i)if((e=Jw[i]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(Jw.length=0);Jw.length=0},t.hasEventListener=function(t,e,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(t,e,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(t,e,n)),i},t.getCapturingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t.getBubblingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t._handleEventMouse=function(t){switch(t.type){case Kw.MOUSE_DOWN:return this._handleMouseDown(t);case Kw.MOUSE_MOVE:return this._handleMouseMove(t);case Kw.MOUSE_UP:return this._handleMouseUp(t);case Kw.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},t._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(tA=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(tA)||(t.type=ZT.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(tA=t.getUILocation(),e._uiProps.uiTransformComp.isHit(tA)?(this.previousMouseIn||($w&&$w!==e&&(t.type=ZT.MOUSE_LEAVE,$w.dispatchEvent(t),$w.eventProcessor.previousMouseIn=!1),$w=e,t.type=ZT.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=ZT.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=ZT.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,$w=null),1)))},t._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(tA=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(tA)||(t.type=ZT.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(tA=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(tA)||(t.type=ZT.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleEventTouch=function(t){switch(t.type){case Kw.TOUCH_START:return this._handleTouchStart(t);case Kw.TOUCH_MOVE:return this._handleTouchMove(t);case Kw.TOUCH_END:return this._handleTouchEnd(t);case Kw.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},t._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getUILocation(tA),!e._uiProps.uiTransformComp.isHit(tA)||(t.type=ZT.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))},t._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=ZT.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))},t._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getUILocation(tA),e._uiProps.uiTransformComp.isHit(tA)?t.type=ZT.TOUCH_END:t.type=ZT.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},t._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=ZT.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},L(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();FR._maskComp=null,FR.callbacksInvoker=new rn,i.NodeEventProcessor=FR;var zR=new vi(0,1,0),UR=new vi,kR=new ki,GR=new di,HR=new Ei,VR=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},jR=(iA=ol("cc.AmbientInfo"),rA=Sl(),oA=fl("_skyColor"),aA=fl("_skyIllum"),sA=fl("_groundAlbedo"),cA=Tl(),lA=wl(),uA=kl(be),hA=wl(),fA=Tl(),pA=wl(),iA(_A=rA((bA=function(){function t(){q(this,"_skyColorHDR",mA,this),q(this,"_skyIllumHDR",vA,this),q(this,"_groundAlbedoHDR",gA,this),q(this,"_skyColorLDR",yA,this),q(this,"_skyIllumLDR",xA,this),q(this,"_groundAlbedoLDR",SA,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},L(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=i.director.root.pipeline.pipelineSceneData.isHDR;return kR.set(t?this._skyColorHDR:this._skyColorLDR),VR(kR),GR.set(255*kR.x,255*kR.y,255*kR.z,255)},set:function(t){kR.set(t.x,t.y,t.z,t.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(kR):this._skyColorLDR.set(kR),this._resource&&this._resource.skyColor.set(kR)}},{key:"skyColor",set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=i.director.root.pipeline.pipelineSceneData.isHDR;return kR.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),VR(kR),GR.set(255*kR.x,255*kR.y,255*kR.z,255)},set:function(t){kR.set(t.x,t.y,t.z,t.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(kR):this._groundAlbedoLDR.set(kR),this._resource&&this._resource.groundAlbedo.set(kR)}},{key:"groundAlbedo",set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}(),mA=X((dA=bA).prototype,"_skyColorHDR",[hl,oA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(.2,.5,.8,1)}}),vA=X(dA.prototype,"_skyIllumHDR",[hl,aA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qi.SKY_ILLUM}}),gA=X(dA.prototype,"_groundAlbedoHDR",[hl,sA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(.2,.2,.2,1)}}),yA=X(dA.prototype,"_skyColorLDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(.2,.5,.8,1)}}),xA=X(dA.prototype,"_skyIllumLDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qi.SKY_ILLUM}}),SA=X(dA.prototype,"_groundAlbedoLDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki(.2,.2,.2,1)}}),X(dA.prototype,"skyLightingColor",[cA,bl,lA],Object.getOwnPropertyDescriptor(dA.prototype,"skyLightingColor"),dA.prototype),X(dA.prototype,"skyIllum",[bl,uA,hA],Object.getOwnPropertyDescriptor(dA.prototype,"skyIllum"),dA.prototype),X(dA.prototype,"groundLightingColor",[fA,bl,pA],Object.getOwnPropertyDescriptor(dA.prototype,"groundLightingColor"),dA.prototype),_A=dA))||_A)||_A);i.AmbientInfo=jR;var WR=(TA=ol("cc.SkyboxInfo"),EA=Sl(),CA=kl(lv),wA=fl("_envmap"),AA=kl(lv),PA=kl(lv),IA=kl(lv),RA=Tl(),DA=wl(),OA=wl(),MA=wl(),NA=wl(),LA=kl(lv),BA=wl(),FA=Tl(),zA=kl(lv),TA(UA=EA((KA=function(){function t(){q(this,"_applyDiffuseMap",GA,this),q(this,"_envmapHDR",HA,this),q(this,"_envmapLDR",VA,this),q(this,"_diffuseMapHDR",jA,this),q(this,"_diffuseMapLDR",WA,this),q(this,"_enabled",qA,this),q(this,"_useIBL",XA,this),q(this,"_useHDR",YA,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},L(t,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(t){this._applyDiffuseMap=t,this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=t:this._envmapLDR=t,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=t)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),t}(),GA=X((kA=KA).prototype,"_applyDiffuseMap",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HA=X(kA.prototype,"_envmapHDR",[hl,CA,wA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VA=X(kA.prototype,"_envmapLDR",[hl,AA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jA=X(kA.prototype,"_diffuseMapHDR",[hl,PA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WA=X(kA.prototype,"_diffuseMapLDR",[hl,IA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qA=X(kA.prototype,"_enabled",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XA=X(kA.prototype,"_useIBL",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YA=X(kA.prototype,"_useHDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(kA.prototype,"applyDiffuseMap",[RA,bl,DA],Object.getOwnPropertyDescriptor(kA.prototype,"applyDiffuseMap"),kA.prototype),X(kA.prototype,"enabled",[bl,OA],Object.getOwnPropertyDescriptor(kA.prototype,"enabled"),kA.prototype),X(kA.prototype,"useIBL",[bl,MA],Object.getOwnPropertyDescriptor(kA.prototype,"useIBL"),kA.prototype),X(kA.prototype,"useHDR",[bl,NA],Object.getOwnPropertyDescriptor(kA.prototype,"useHDR"),kA.prototype),X(kA.prototype,"envmap",[bl,LA,BA],Object.getOwnPropertyDescriptor(kA.prototype,"envmap"),kA.prototype),X(kA.prototype,"diffuseMap",[FA,bl,El,zA],Object.getOwnPropertyDescriptor(kA.prototype,"diffuseMap"),kA.prototype),UA=kA))||UA)||UA);i.SkyboxInfo=WR;var qR=(QA=ol("cc.FogInfo"),ZA=Sl(),JA=wl(),$A=wl(),tP=wl(),eP=kl(OT),nP=wl(),iP=Tl(),rP=kl(be),oP=Al(),aP=Rl(),sP=Ol(),cP=wl(),lP=Tl(),uP=kl(be),hP=Rl(),fP=Ol(),pP=wl(),_P=Tl(),dP=kl(be),mP=Rl(),vP=Ol(),gP=wl(),yP=Tl(),xP=kl(be),SP=Pl(),bP=Rl(),TP=Ol(),EP=wl(),CP=Tl(),wP=kl(be),AP=Rl(),PP=Ol(),IP=wl(),RP=Tl(),DP=kl(be),OP=Rl(),MP=Ol(),NP=wl(),QA(LP=ZA((YP=XP=function(){function t(){q(this,"_type",FP,this),q(this,"_fogColor",zP,this),q(this,"_enabled",UP,this),q(this,"_fogDensity",kP,this),q(this,"_fogStart",GP,this),q(this,"_fogEnd",HP,this),q(this,"_fogAtten",VP,this),q(this,"_fogTop",jP,this),q(this,"_fogRange",WP,this),q(this,"_accurate",qP,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),XP.FogType=OT,FP=X((BP=YP).prototype,"_type",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OT.LINEAR}}),zP=X(BP.prototype,"_fogColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di("#C8C8C8")}}),UP=X(BP.prototype,"_enabled",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kP=X(BP.prototype,"_fogDensity",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),GP=X(BP.prototype,"_fogStart",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),HP=X(BP.prototype,"_fogEnd",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),VP=X(BP.prototype,"_fogAtten",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),jP=X(BP.prototype,"_fogTop",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),WP=X(BP.prototype,"_fogRange",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),qP=X(BP.prototype,"_accurate",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(BP.prototype,"enabled",[bl,JA],Object.getOwnPropertyDescriptor(BP.prototype,"enabled"),BP.prototype),X(BP.prototype,"accurate",[bl,$A],Object.getOwnPropertyDescriptor(BP.prototype,"accurate"),BP.prototype),X(BP.prototype,"fogColor",[bl,tP],Object.getOwnPropertyDescriptor(BP.prototype,"fogColor"),BP.prototype),X(BP.prototype,"type",[bl,eP,nP],Object.getOwnPropertyDescriptor(BP.prototype,"type"),BP.prototype),X(BP.prototype,"fogDensity",[iP,rP,oP,aP,Dl,sP,cP],Object.getOwnPropertyDescriptor(BP.prototype,"fogDensity"),BP.prototype),X(BP.prototype,"fogStart",[lP,uP,hP,fP,pP],Object.getOwnPropertyDescriptor(BP.prototype,"fogStart"),BP.prototype),X(BP.prototype,"fogEnd",[_P,dP,mP,vP,gP],Object.getOwnPropertyDescriptor(BP.prototype,"fogEnd"),BP.prototype),X(BP.prototype,"fogAtten",[yP,xP,SP,bP,TP,EP],Object.getOwnPropertyDescriptor(BP.prototype,"fogAtten"),BP.prototype),X(BP.prototype,"fogTop",[CP,wP,AP,PP,IP],Object.getOwnPropertyDescriptor(BP.prototype,"fogTop"),BP.prototype),X(BP.prototype,"fogRange",[RP,DP,OP,MP,NP],Object.getOwnPropertyDescriptor(BP.prototype,"fogRange"),BP.prototype),LP=BP))||LP)||LP),XR=(KP=ol("cc.ShadowsInfo"),QP=Sl(),ZP=wl(),JP=kl(Ng),$P=Tl(),tI=Tl(),eI=wl(),nI=kl(be),iI=wl(),rI=Tl(),oI=Al(),aI=kl(be),sI=wl(),cI=Tl(),lI=kl(Lg),uI=wl(),hI=Tl(),fI=kl(Se),pI=Tl(),_I=kl(be),dI=wl(),mI=Tl(),vI=kl(be),gI=wl(),yI=Tl(),xI=kl(Mg),SI=wl(),bI=Tl(),TI=kl(Te),EI=wl(),CI=Tl(),wI=kl(be),AI=wl(),PI=Tl(),II=kl(be),RI=wl(),DI=Tl(),OI=Al(),MI=kl(be),NI=wl(),LI=Tl(),BI=Al(),FI=kl(be),zI=wl(),UI=Tl(),kI=kl(be),GI=wl(),HI=Tl(),KP(VI=QP((lR=function(){function t(){q(this,"_type",WI,this),q(this,"_enabled",qI,this),q(this,"_normal",XI,this),q(this,"_distance",YI,this),q(this,"_shadowColor",KI,this),q(this,"_firstSetCSM",QI,this),q(this,"_fixedArea",ZI,this),q(this,"_pcf",JI,this),q(this,"_bias",$I,this),q(this,"_normalBias",tR,this),q(this,"_near",eR,this),q(this,"_far",nR,this),q(this,"_shadowDistance",iR,this),q(this,"_invisibleOcclusionRange",rR,this),q(this,"_orthoSize",oR,this),q(this,"_maxReceived",aR,this),q(this,"_size",sR,this),q(this,"_saturation",cR,this),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(HR),this.normal=vi.transformQuat(UR,zR,HR),t.getWorldPosition(UR),this.distance=vi.dot(this._normal,UR)},e.activate=function(t){this.pcf=Math.min(this._pcf,Lg.SOFT_2X),this._resource=t,this._resource.initialize(this),this._resource.activate()},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"normal",get:function(){return this._normal},set:function(t){vi.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"saturation",get:function(){return this._saturation},set:function(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t,this._resource&&(this._resource.bias=t)}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t,this._resource&&(this._resource.fixedArea=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._resource&&(this._resource.near=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=Math.min(t,Fg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=Math.min(t,Fg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,Fg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}}]),t}(),WI=X((jI=lR).prototype,"_type",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ng.Planar}}),qI=X(jI.prototype,"_enabled",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XI=X(jI.prototype,"_normal",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,1,0)}}),YI=X(jI.prototype,"_distance",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KI=X(jI.prototype,"_shadowColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(0,0,0,76)}}),QI=X(jI.prototype,"_firstSetCSM",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZI=X(jI.prototype,"_fixedArea",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JI=X(jI.prototype,"_pcf",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lg.HARD}}),$I=X(jI.prototype,"_bias",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),tR=X(jI.prototype,"_normalBias",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eR=X(jI.prototype,"_near",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nR=X(jI.prototype,"_far",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),iR=X(jI.prototype,"_shadowDistance",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),rR=X(jI.prototype,"_invisibleOcclusionRange",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),oR=X(jI.prototype,"_orthoSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),aR=X(jI.prototype,"_maxReceived",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),sR=X(jI.prototype,"_size",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(512,512)}}),cR=X(jI.prototype,"_saturation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),X(jI.prototype,"enabled",[bl,ZP],Object.getOwnPropertyDescriptor(jI.prototype,"enabled"),jI.prototype),X(jI.prototype,"type",[bl,JP],Object.getOwnPropertyDescriptor(jI.prototype,"type"),jI.prototype),X(jI.prototype,"shadowColor",[$P],Object.getOwnPropertyDescriptor(jI.prototype,"shadowColor"),jI.prototype),X(jI.prototype,"normal",[tI,eI],Object.getOwnPropertyDescriptor(jI.prototype,"normal"),jI.prototype),X(jI.prototype,"distance",[nI,iI,rI],Object.getOwnPropertyDescriptor(jI.prototype,"distance"),jI.prototype),X(jI.prototype,"saturation",[bl,oI,Dl,aI,sI,cI],Object.getOwnPropertyDescriptor(jI.prototype,"saturation"),jI.prototype),X(jI.prototype,"pcf",[lI,uI,hI],Object.getOwnPropertyDescriptor(jI.prototype,"pcf"),jI.prototype),X(jI.prototype,"maxReceived",[fI,pI],Object.getOwnPropertyDescriptor(jI.prototype,"maxReceived"),jI.prototype),X(jI.prototype,"bias",[_I,dI,mI],Object.getOwnPropertyDescriptor(jI.prototype,"bias"),jI.prototype),X(jI.prototype,"normalBias",[vI,gI,yI],Object.getOwnPropertyDescriptor(jI.prototype,"normalBias"),jI.prototype),X(jI.prototype,"shadowMapSize",[xI,SI,bI],Object.getOwnPropertyDescriptor(jI.prototype,"shadowMapSize"),jI.prototype),X(jI.prototype,"fixedArea",[TI,EI,CI],Object.getOwnPropertyDescriptor(jI.prototype,"fixedArea"),jI.prototype),X(jI.prototype,"near",[wI,AI,PI],Object.getOwnPropertyDescriptor(jI.prototype,"near"),jI.prototype),X(jI.prototype,"far",[II,RI,DI],Object.getOwnPropertyDescriptor(jI.prototype,"far"),jI.prototype),X(jI.prototype,"invisibleOcclusionRange",[bl,OI,Dl,MI,NI,LI],Object.getOwnPropertyDescriptor(jI.prototype,"invisibleOcclusionRange"),jI.prototype),X(jI.prototype,"shadowDistance",[bl,BI,Dl,FI,zI,UI],Object.getOwnPropertyDescriptor(jI.prototype,"shadowDistance"),jI.prototype),X(jI.prototype,"orthoSize",[kI,GI,HI],Object.getOwnPropertyDescriptor(jI.prototype,"orthoSize"),jI.prototype),VI=jI))||VI)||VI);i.ShadowsInfo=XR;var YR=new vi(-1024,-1024,-1024),KR=new vi(1024,1024,1024),QR=(uR=ol("cc.OctreeInfo"),hR=Sl(),fR=wl(),pR=wl(),_R=Cl(),dR=wl(),mR=Cl(),vR=Al(),gR=kl(Se),yR=wl(),uR(xR=hR((wR=function(){function t(){q(this,"_enabled",bR,this),q(this,"_minPos",TR,this),q(this,"_maxPos",ER,this),q(this,"_depth",CR,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}(),bR=X((SR=wR).prototype,"_enabled",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TR=X(SR.prototype,"_minPos",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(YR)}}),ER=X(SR.prototype,"_maxPos",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(KR)}}),CR=X(SR.prototype,"_depth",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),X(SR.prototype,"enabled",[bl,fR],Object.getOwnPropertyDescriptor(SR.prototype,"enabled"),SR.prototype),X(SR.prototype,"minPos",[bl,pR,_R],Object.getOwnPropertyDescriptor(SR.prototype,"minPos"),SR.prototype),X(SR.prototype,"maxPos",[bl,dR,mR],Object.getOwnPropertyDescriptor(SR.prototype,"maxPos"),SR.prototype),X(SR.prototype,"depth",[bl,vR,gR,yR],Object.getOwnPropertyDescriptor(SR.prototype,"depth"),SR.prototype),xR=SR))||xR)||xR),ZR=(AR=ol("cc.SceneGlobals"),PR=kl(WR),AR((BR=function(){function t(){q(this,"ambient",DR,this),q(this,"shadows",OR,this),q(this,"_skybox",MR,this),q(this,"fog",NR,this),q(this,"octree",LR,this)}return t.prototype.activate=function(){var t=i.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)},L(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),DR=X((RR=BR).prototype,"ambient",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jR}}),OR=X(RR.prototype,"shadows",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XR}}),MR=X(RR.prototype,"_skybox",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new WR}}),NR=X(RR.prototype,"fog",[bl,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qR}}),X(RR.prototype,"skybox",[bl,PR],Object.getOwnPropertyDescriptor(RR.prototype,"skybox"),RR.prototype),LR=X(RR.prototype,"octree",[bl,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QR}}),IR=RR))||IR);i.SceneGlobals=ZR;var JR=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());JR.NO_TYPE="no_type",JR.TOUCH="touch",JR.MOUSE="mouse",JR.KEYBOARD="keyboard",JR.ACCELERATION="acceleration",JR.NONE=0,JR.CAPTURING_PHASE=1,JR.AT_TARGET=2,JR.BUBBLING_PHASE=3,i.Event=JR;var $R=t("EventAcceleration",function(t){function e(e,n){var i;return(i=t.call(this,Yw.DEVICEMOTION,n)||this).acc=void 0,i.acc=e,i}return F(e,t),e}(JR));JR.EventAcceleration=$R;var tD=t("EventKeyboard",function(t){function e(e,n,i){var r;return"boolean"==typeof n&&(n=n?Yw.KEY_DOWN:Yw.KEY_UP),(r=t.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==Yw.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return F(e,t),L(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(JR));JR.EventKeyboard=tD;var eD=t("EventMouse",function(t){function e(n,i,r){var o;return(o=t.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=e.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}F(e,t);var n=e.prototype;return n.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(t,e){this._x=t,this._y=e},n.getLocation=function(t){return t||(t=new Bi),Bi.set(t,this._x,this._y),t},n.getLocationInView=function(t){return t||(t=new Bi),Bi.set(t,this._x,i.view._designResolutionSize.height-this._y),t},n.getUILocation=function(t){return t||(t=new Bi),Bi.set(t,this._x,this._y),i.view._convertToUISpace(t),t},n.getPreviousLocation=function(t){return t||(t=new Bi),Bi.set(t,this._prevX,this._prevY),t},n.getUIPreviousLocation=function(t){return t||(t=new Bi),Bi.set(t,this._prevX,this._prevY),i.view._convertToUISpace(t),t},n.getDelta=function(t){return t||(t=new Bi),Bi.set(t,this._x-this._prevX,this._y-this._prevY),t},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(t){return t||(t=new Bi),Bi.set(t,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),t},n.getUIDeltaX=function(){return(this._x-this._prevX)/i.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/i.view.getScaleY()},n.setButton=function(t){this._button=t},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var t=i.view.getViewportRect();return(this._x-t.x)/i.view.getScaleX()},n.getUILocationY=function(){var t=i.view.getViewportRect();return(this._y-t.y)/i.view.getScaleY()},L(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(JR));eD.BUTTON_MISSING=-1,eD.BUTTON_LEFT=0,eD.BUTTON_RIGHT=2,eD.BUTTON_MIDDLE=1,eD.BUTTON_4=3,eD.BUTTON_5=4,eD.BUTTON_6=5,eD.BUTTON_7=6,eD.BUTTON_8=7,JR.EventMouse=eD;var nD=new Bi,iD=t("EventTouch",function(t){function e(e,n,i,r){var o;return void 0===r&&(r=[]),(o=t.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=e||[],o._allTouches=r,o}F(e,t);var n=e.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},n.getLocation=function(t){return this.touch?this.touch.getLocation(t):new Bi},n.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new Bi},n.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new Bi},n.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new Bi},n.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new Bi},n.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new Bi},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(t){return this.touch?this.touch.getDelta(t):new Bi},n.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new Bi},n.getDeltaX=function(){return this.touch?this.touch.getDelta(nD).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(nD).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(JR));iD.MAX_TOUCHES=5,JR.EventTouch=iD;var rD,oD=t("Acceleration",(function(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(rD||(rD=t("KeyCode",{})));var aD=new Bi,sD=t("Touch",function(){function t(t,e,n){void 0===n&&(n=0),this._point=new Bi,this._prevPoint=new Bi,this._lastModified=0,this._id=0,this._startPoint=new Bi,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new Bi),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new Bi),t.set(this._point.x,this._point.y),i.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=i.view.getViewportRect();return(this._point.x-t.x)/i.view.getScaleX()},e.getUILocationY=function(){var t=i.view.getViewportRect();return(this._point.y-t.y)/i.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new Bi),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new Bi),t.set(this._prevPoint.x,this._prevPoint.y),i.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new Bi),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new Bi),t.set(this._startPoint.x,this._startPoint.y),i.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new Bi),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new Bi),aD.set(this._point),aD.subtract(this._prevPoint),t.set(i.view.getScaleX(),i.view.getScaleY()),Bi.divide(t,aD,t),t},e.getLocationInView=function(t){return t||(t=new Bi),t.set(this._point.x,i.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new Bi),t.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new Bi),t.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,n){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new Bi(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new Bi(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=i.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new Bi(t.x,t.y):new Bi(t||0,e||0),this._lastModified=i.game.frameStartTime},L(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());i.Touch=sD;var cD,lD,uD=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new fn,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,pn.browserType===an.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=t.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=t;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(uh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),pn.os===ln.ANDROID&&pn.browserType!==an.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new oD(n,i,r,l),h=new $R(u);this._eventTarget.emit(Kw.DEVICEMOTION,h)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),hD={Backspace:rD.BACKSPACE,Tab:rD.TAB,Enter:rD.ENTER,ShiftLeft:rD.SHIFT_LEFT,ControlLeft:rD.CTRL_LEFT,AltLeft:rD.ALT_LEFT,ShiftRight:rD.SHIFT_RIGHT,ControlRight:rD.CTRL_RIGHT,AltRight:rD.ALT_RIGHT,Pause:rD.PAUSE,CapsLock:rD.CAPS_LOCK,Escape:rD.ESCAPE,Space:rD.SPACE,PageUp:rD.PAGE_UP,PageDown:rD.PAGE_DOWN,End:rD.END,Home:rD.HOME,ArrowLeft:rD.ARROW_LEFT,ArrowUp:rD.ARROW_UP,ArrowRight:rD.ARROW_RIGHT,ArrowDown:rD.ARROW_DOWN,Insert:rD.INSERT,Delete:rD.DELETE,Digit0:rD.DIGIT_0,Digit1:rD.DIGIT_1,Digit2:rD.DIGIT_2,Digit3:rD.DIGIT_3,Digit4:rD.DIGIT_4,Digit5:rD.DIGIT_5,Digit6:rD.DIGIT_6,Digit7:rD.DIGIT_7,Digit8:rD.DIGIT_8,Digit9:rD.DIGIT_9,KeyA:rD.KEY_A,KeyB:rD.KEY_B,KeyC:rD.KEY_C,KeyD:rD.KEY_D,KeyE:rD.KEY_E,KeyF:rD.KEY_F,KeyG:rD.KEY_G,KeyH:rD.KEY_H,KeyI:rD.KEY_I,KeyJ:rD.KEY_J,KeyK:rD.KEY_K,KeyL:rD.KEY_L,KeyM:rD.KEY_M,KeyN:rD.KEY_N,KeyO:rD.KEY_O,KeyP:rD.KEY_P,KeyQ:rD.KEY_Q,KeyR:rD.KEY_R,KeyS:rD.KEY_S,KeyT:rD.KEY_T,KeyU:rD.KEY_U,KeyV:rD.KEY_V,KeyW:rD.KEY_W,KeyX:rD.KEY_X,KeyY:rD.KEY_Y,KeyZ:rD.KEY_Z,Numpad0:rD.NUM_0,Numpad1:rD.NUM_1,Numpad2:rD.NUM_2,Numpad3:rD.NUM_3,Numpad4:rD.NUM_4,Numpad5:rD.NUM_5,Numpad6:rD.NUM_6,Numpad7:rD.NUM_7,Numpad8:rD.NUM_8,Numpad9:rD.NUM_9,NumpadMultiply:rD.NUM_MULTIPLY,NumpadAdd:rD.NUM_PLUS,NumpadSubtract:rD.NUM_SUBTRACT,NumpadDecimal:rD.NUM_DECIMAL,NumpadDivide:rD.NUM_DIVIDE,NumpadEnter:rD.NUM_ENTER,F1:rD.F1,F2:rD.F2,F3:rD.F3,F4:rD.F4,F5:rD.F5,F6:rD.F6,F7:rD.F7,F8:rD.F8,F9:rD.F9,F10:rD.F10,F11:rD.F11,F12:rD.F12,NumLock:rD.NUM_LOCK,ScrollLock:rD.SCROLL_LOCK,Semicolon:rD.SEMICOLON,Equal:rD.EQUAL,Comma:rD.COMMA,Minus:rD.DASH,Period:rD.PERIOD,Slash:rD.SLASH,Backquote:rD.BACK_QUOTE,BracketLeft:rD.BRACKET_LEFT,Backslash:rD.BACKSLASH,BracketRight:rD.BRACKET_RIGHT,Quote:rD.QUOTE},fD=function(){function t(){this._eventTarget=new fn,this._registerEvent()}var e=t.prototype;return e._registerEvent=function(){var t=this,e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",(function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var n=t._getInputEvent(e,Kw.KEY_PRESSING);t._eventTarget.emit(Kw.KEY_PRESSING,n)}else{var i=t._getInputEvent(e,Kw.KEY_DOWN);t._eventTarget.emit(Kw.KEY_DOWN,i)}})),null==e||e.addEventListener("keyup",(function(e){var n=t._getInputEvent(e,Kw.KEY_UP);e.stopPropagation(),e.preventDefault(),t._eventTarget.emit(Kw.KEY_UP,n)}))},e._getInputEvent=function(t,e){var n,i=(n=t.code,hD[n]||rD.NONE);return new tD(i,e)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),pD=function(){function t(){this._canvas=void 0,this._eventTarget=new fn,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Bi,pn.hasFeature(hn.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Wi(e.x,e.y,e.width,e.height):new Wi(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),n=uh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/n-t.movementY:e.y+e.height-t.clientY;return new Bi(i*=n,r*=n)},e._registerEvent=function(){var t,e,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._createCallback(Kw.MOUSE_DOWN)),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._createCallback(Kw.MOUSE_MOVE));var o=this._createCallback(Kw.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(n){var i,r=e._getLocation(n),o=n.button;switch(t){case Kw.MOUSE_DOWN:null===(i=e._canvas)||void 0===i||i.focus(),e._isPressed=!0;break;case Kw.MOUSE_UP:e._isPressed=!1;break;case Kw.MOUSE_MOVE:e._isPressed||(o=eD.BUTTON_MISSING)}var a=new eD(t,!1,e._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,e._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),e._eventTarget.emit(t,a)}},e._handleMouseWheel=function(t){var e=Kw.MOUSE_WHEEL,n=this._getLocation(t),i=t.button,r=new eD(e,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(n.x,n.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),_D=new Bi,dD=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation(_D);var n=new sD(_D.x,_D.y,e);return t.getLocation(_D),n.setPoint(_D.x,_D.y),t.getPreviousLocation(_D),n.setPrevPoint(_D),n},e._createTouch=function(t,e,n){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var i=new sD(e,n,t);return this._touchMap.set(t,i),this._updateTouch(i,e,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,n){var i=this._touchMap.get(t);return i?this._updateTouch(i,e,n):i=this._createTouch(t,e,n),i?this._cloneTouch(i):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(n){if(n){var i=t._cloneTouch(n);e.push(i)}})),e},e._updateTouch=function(t,e,n){t.getLocation(_D),t.setPrevPoint(_D),t.setPoint(e,n)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var n=$t.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(t){i-t.lastModified>$t.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),n>=this._touchMap.size},t}()),mD=function(){function t(){this._canvas=void 0,this._eventTarget=new fn,pn.hasFeature(hn.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,n,i;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(Kw.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(Kw.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(Kw.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(Kw.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(n){for(var i,r=e._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=e._getLocation(c,r),h=dD.getTouch(l,u.x,u.y);h&&(t!==Kw.TOUCH_END&&t!==Kw.TOUCH_CANCEL||dD.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),t===Kw.TOUCH_START&&(null===(i=e._canvas)||void 0===i||i.focus()),o.length>0){var f=new iD(o,!1,t,$t.ENABLE_MULTI_TOUCH?dD.getAllTouches():o);e._eventTarget.emit(t,f)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Wi(e.x,e.y,e.width,e.height):new Wi(0,0,0,0)},e._getLocation=function(t,e){var n=t.clientX-e.x,i=e.y+e.height-t.clientY;if(uh.isFrameRotated){var r=n;n=e.height-i,i=r}var o=uh.devicePixelRatio;return new Bi(n*=o,i*=o)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}(lD||(lD={}));var vD=function(){function t(t){this.priority=lD.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),gD=((cD={})[Kw.MOUSE_DOWN]=Kw.TOUCH_START,cD[Kw.MOUSE_MOVE]=Kw.TOUCH_MOVE,cD[Kw.MOUSE_UP]=Kw.TOUCH_END,cD),yD=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new fn,this._touchInput=new mD,this._mouseInput=new pD,this._keyboardInput=new fD,this._accelerometerInput=new uD,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new vD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var e=t.prototype;return e.on=function(t,e,n){return this._eventTarget.on(t,e,n),e},e.once=function(t,e,n){return this._eventTarget.once(t,e,n),e},e.off=function(t,e,n){this._eventTarget.off(t,e,n)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=gD[t.type],n=dD.getTouch(0,t.getLocationX(),t.getLocationY());if(n){var i=[n],r=new iD(i,!1,e,i);e===Kw.TOUCH_END&&dD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,n=0;n<e&&this._eventDispatcherList[n].dispatchEvent(t);++n);},e._registerEvent=function(){var t=this;if(ph.hasFeature(ph.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(Kw.TOUCH_START,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(Kw.TOUCH_MOVE,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(Kw.TOUCH_END,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(Kw.TOUCH_CANCEL,(function(n){t._dispatchOrPushEventTouch(n,e)}))}if(ph.hasFeature(ph.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(Kw.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(Kw.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(Kw.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(Kw.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,n)}))}if(ph.hasFeature(ph.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(Kw.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(Kw.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(Kw.KEY_UP,(function(e){t._dispatchOrPushEvent(e,i)}))}if(ph.hasFeature(ph.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(Kw.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var n=t.getTouches(),i=n.length,r=0;r<i;++r)t.touch=n[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,n=t.length;e<n;++e){var i=t[e];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,f=0,p=h.length;f<p;++f){var _=h[f];this._emitEvent(_)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._emitEvent(g)}this._clearEvents()},t}());yD.EventType=Kw;var xD=t("input",new yD),SD=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,xD.on(Kw.MOUSE_DOWN,(function(t){e.emit(Yw.MOUSE_DOWN,t)})),xD.on(Kw.MOUSE_MOVE,(function(t){e.emit(Yw.MOUSE_MOVE,t)})),xD.on(Kw.MOUSE_UP,(function(t){e.emit(Yw.MOUSE_UP,t)})),xD.on(Kw.MOUSE_WHEEL,(function(t){e.emit(Yw.MOUSE_WHEEL,t)})),xD.on(Kw.TOUCH_START,(function(t){e.emit(Yw.TOUCH_START,t.touch,t)})),xD.on(Kw.TOUCH_MOVE,(function(t){e.emit(Yw.TOUCH_MOVE,t.touch,t)})),xD.on(Kw.TOUCH_END,(function(t){e.emit(Yw.TOUCH_END,t.touch,t)})),xD.on(Kw.TOUCH_CANCEL,(function(t){e.emit(Yw.TOUCH_CANCEL,t.touch,t)})),xD.on(Kw.KEY_DOWN,(function(t){e.emit(Yw.KEY_DOWN,t)})),xD.on(Kw.KEY_PRESSING,(function(t){e.emit(Yw.KEY_DOWN,t)})),xD.on(Kw.KEY_UP,(function(t){e.emit(Yw.KEY_UP,t)})),xD.on(Kw.DEVICEMOTION,(function(t){e.emit(Yw.DEVICEMOTION,t)})),e}F(e,t);var n=e.prototype;return n.setAccelerometerEnabled=function(t){xD.setAccelerometerEnabled(t)},n.setAccelerometerInterval=function(t){xD.setAccelerometerInterval(t)},n.on=function(e,n,i,r){return t.prototype.on.call(this,e,n,i,r),n},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i)},e}(fn));SD.EventType=Yw,i.SystemEvent=SD;var bD,TD=t("systemEvent",new SD);i.systemEvent=TD,Bn(Yw,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),Bn(JR,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:SD.EventType,targetName:"SystemEvent.EventType"}]),zn(JR,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),Bn(eD,"EventMouse",["DOWN","UP","MOVE"].map((function(t){return{name:t,newName:"MOUSE_"+t,target:SD.EventType,targetName:"SystemEvent.EventType"}}))),Bn(eD,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:SD.EventType,targetName:"SystemEvent.EventType"}]),zn(eD.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),Bn(iD,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:SD.EventType,targetName:"SystemEvent.EventType"}]),Bn(iD,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:SD.EventType,targetName:"SystemEvent.EventType"}]),Bn(iD,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:SD.EventType,targetName:"SystemEvent.EventType"}]),Bn(iD,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:SD.EventType,targetName:"SystemEvent.EventType"}]),zn(iD.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),Bn(iD.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:iD,targetName:"EventTouch"}]),zn($t.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(t){return{name:t}}))),zn($t.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),zn($t.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),zn($t.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),zn($t,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),Bn(EE.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),Bn($C.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new Bi),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new Vi),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),Fn(ZR.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),Fn($C.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Bn(sE.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),Fn(U_,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),Bn(U_,"Layers",[{name:"Default",newName:"DEFAULT",target:U_.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:U_.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:U_.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:U_.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:U_.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:U_.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:U_.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:U_.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:U_,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:U_,targetName:"Layers"}]),Fn(U_.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Fn(U_.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var ED,CD,wD,AD,PD=Ye.Flags.HideInHierarchy,ID=Ye.Flags.DontSave,RD=t("PrivateNode",ol("cc.PrivateNode")(bD=function(t){function e(e){var n;return E(12003,(n=t.call(this,e)||this).name),n.hideFlags|=ID|PD,n}return F(e,t),e}($C))||bD);Bn(Yw,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(t){return{name:t,target:$C.EventType,targetName:"Node.EventType"}}))),Bn($C.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:SD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:SD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:SD.EventType,targetName:"SystemEvent.EventType"}]),i.PrivateNode=RD;var DD=t("Scene",ol("cc.Scene")((X((CD=function(t){F(n,t);var e=n.prototype;function n(e){var n;return q(n=t.call(this,e)||this,"autoReleaseAssets",wD,V(n)),q(n,"_globals",AD,V(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=vi.ZERO,n._rot=Ei.IDENTITY,n._scale=vi.ONE,n._mat=Oi.IDENTITY,n._dirtyFlags=0,n._lpos=vi.ZERO,n._lrot=Ei.IDENTITY,n._lscale=vi.ONE,n._activeInHierarchy=!1,i.director&&i.director.root&&(n._renderScene=i.director.root.createScene({})),n._inited=!i.game||!i.game._isCloning,n._init(),n}return e._updateScene=function(){this._scene=this},e._init=function(){},e.destroy=function(){var t=Ye.prototype.destroy.call(this);if(t)for(var e=this._children,n=0;n<e.length;++n)e[n].active=!1;return this._renderScene&&i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(R(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},e.getPosition=function(t){return vi.copy(t||new vi,vi.ZERO)},e.getRotation=function(t){return Ei.copy(t||new Ei,Ei.IDENTITY)},e.getScale=function(t){return vi.copy(t||new vi,vi.ONE)},e.getWorldPosition=function(t){return vi.copy(t||new vi,vi.ZERO)},e.getWorldRotation=function(t){return Ei.copy(t||new Ei,Ei.IDENTITY)},e.getWorldScale=function(t){return vi.copy(t||new vi,vi.ONE)},e.getWorldMatrix=function(t){return Oi.copy(t||new Oi,Oi.IDENTITY)},e.getWorldRS=function(t){return Oi.copy(t||new Oi,Oi.IDENTITY)},e.getWorldRT=function(t){return Oi.copy(t||new Oi,Oi.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(vw(this),dw(this),this._onBatchCreated(false),this._inited=!0),this.walk(EE._setScene)},e._activate=function(t){t=!1!==t,i.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()},L(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return vi.ZERO}},{key:"worldPosition",get:function(){return vi.ZERO}},{key:"rotation",get:function(){return Ei.IDENTITY}},{key:"worldRotation",get:function(){return Ei.IDENTITY}},{key:"scale",get:function(){return vi.ONE}},{key:"worldScale",get:function(){return vi.ONE}},{key:"eulerAngles",get:function(){return vi.ZERO}},{key:"worldMatrix",get:function(){return Oi.IDENTITY}}]),n}(EE)).prototype,"globals",[bl],Object.getOwnPropertyDescriptor(CD.prototype,"globals"),CD.prototype),wD=X(CD.prototype,"autoReleaseAssets",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AD=X(CD.prototype,"_globals",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZR}}),ED=CD))||ED);function OD(t,e){if(!e){var n=i.director.getScene();if(!n)return null;e=n}return e.getChildByPath(t)}i.Scene=DD,i.find=OD;var MD=kt.fastRemoveAt,ND=Ye.Flags.IsStartCalled,LD=Ye.Flags.IsOnEnableCalled;function BD(t,e){for(var n=e.constructor._executionOrder,i=e._id,r=0,o=t.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=t[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function FD(t,e){for(var n=t.array,i=t.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(t.removeAt(i),e&&(r._objFlags&=~e))}}Ye.Flags.IsEditorOnEnableCalled;var zD=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=Y;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function UD(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}zD.stableRemoveInactive=FD;var kD=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},n.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},n.cancelInactive=function(t){FD(this._zero,t),FD(this._neg,t),FD(this._pos,t)},n.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(UD),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(UD),this._invoke(e),e.array.length=0)},e}(zD),GD=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var n=e<0?this._neg.array:this._pos.array,i=BD(n,t);i<0&&n.splice(~i,0,t)}},n.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var n=e<0?this._neg:this._pos,i=BD(n.array,t);i>=0&&n.removeAt(i)}},n.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(zD);function HD(t,e,n){var r="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",o=e?Function("it","dt",r):Function("it",r);return function(t,e,n){return function(r,o){try{e(r,o)}catch(e){i._throw(e);var a=r.array;for(n&&(a[r.i]._objFlags|=n),++r.i;r.i<a.length;++r.i)try{t(a[r.i],o)}catch(t){i._throw(t),n&&(a[r.i]._objFlags|=n)}}}}(Function("c","dt",t),o,n)}var VD=HD("c.start();c._objFlags|="+ND,!1,ND),jD=HD("c.update(dt)",!0),WD=HD("c.lateUpdate(dt)",!0),qD=function(t){var e=i.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){var r=n[t.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||e._onEnabled(r))}},XD=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new kD(VD),this.updateInvoker=new GD(jD),this.lateUpdateInvoker=new GD(WD),this._updating=!1},e._onEnabled=function(t){i.director.getScheduler().resumeTarget(t),t._objFlags|=LD,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){i.director.getScheduler().pauseTarget(t),t._objFlags&=~LD;var e=this._deferredComps.indexOf(t);e>=0?MD(this._deferredComps,e):(!t.start||t._objFlags&ND||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&LD)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&LD&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&ND||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),YD=Ye.Flags.IsPreloadStarted,KD=Ye.Flags.IsOnLoadStarted,QD=Ye.Flags.IsOnLoadCalled,ZD=Ye.Flags.Deactivating,JD=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.add=function(t){this._zero.array.push(t)},n.remove=function(t){this._zero.fastRemove(t)},n.cancelInactive=function(t){zD.stableRemoveInactive(this._zero,t)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(zD),$D=HD("c.__preload();"),tO=HD("c.onLoad();c._objFlags|="+QD,!1,QD),eO=new Ut(4);function nO(t,e,n){w(3817,t.name,n),console.log("Corrupted component value:",e),e?t._removeComponent(e):kt.removeAt(t._components,n)}eO.get=function(){var t=this._get()||{preload:new JD($D),onLoad:new kD(tO),onEnable:new kD(qD)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var iO,rO,oO,aO,sO,cO,lO,uO,hO=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var n=eO.get();this._activatingStack.push(n),this._activateNodeRecursively(t,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),eO.put(n)}else{this._deactivateNodeRecursively(t);for(var i,r=W(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(YD),o.onLoad.cancelInactive(KD),o.onEnable.cancelInactive()}}t.emit(ZT.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,n,r){if(Qe(t,!0)&&(t._objFlags&YD||(t._objFlags|=YD,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&KD||(t._objFlags|=KD,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=QD):t._objFlags|=QD),t._enabled)){if(!t.node._activeInHierarchy)return;i.director._compScheduler.enableComp(t,r)}},e.destroyComp=function(t){i.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&QD&&t.onDestroy()},e._activateNodeRecursively=function(t,e,n,r){if(t._objFlags&ZD)w(3816,t.name);else{t._activeInHierarchy=!0;for(var o=t._components.length,a=0;a<o;++a){var s=t._components[a];s instanceof i.Component?this.activateComp(s,e,n,r):(nO(t,s,a),--a,--o)}for(var c=0,l=t._children.length;c<l;++c){var u=t._children[c];u._active&&this._activateNodeRecursively(u,e,n,r)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=ZD,t._activeInHierarchy=!1;for(var e=t._components.length,n=0;n<e;++n){var r=t._components[n];if(r._enabled&&(i.director._compScheduler.disableComp(r),t._activeInHierarchy))return void(t._objFlags&=~ZD)}for(var o=0,a=t._children.length;o<a;++o){var s=t._children[o];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),t._activeInHierarchy))return void(t._objFlags&=~ZD)}t._onPostActivated(!1),t._objFlags&=~ZD},t}()),fO=t("SceneAsset",ol("cc.SceneAsset")((aO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"scene",oO,V(e)),e}F(e,t);var n=e.prototype;return n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new DD("New Scene")},n.validate=function(){return!!this.scene},e}(Bu),oO=X((rO=aO).prototype,"scene",[bl,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iO=rO))||iO);i.SceneAsset=fO;var pO,_O,dO,mO,vO=t("TextAsset",ol("cc.TextAsset")((uO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"text",lO,V(e)),e}return F(e,t),e.prototype.toString=function(){return this.text},e}(Bu),lO=X((cO=uO).prototype,"text",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sO=cO))||sO);i.TextAsset=vO;var gO=t("JsonAsset",ol("cc.JsonAsset")((mO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"json",dO,V(e)),e}return F(e,t),e}(Bu),dO=X((_O=mO).prototype,"json",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pO=_O))||pO);i.JsonAsset=gO;var yO,xO,SO,bO,TO,EO,CO,wO,AO,PO,IO,RO,DO,OO,MO,NO,LO,BO,FO,zO,UO,kO,GO,HO,VO,jO,WO,qO,XO,YO,KO,QO,ZO,JO,$O,tM,eM,nM,iM=function(){var t=e.prototype;function e(){this.fog=new NT,this.ambient=new Qi,this.skybox=new Zg,this.shadows=new Fg,this.octree=new Zi,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return t._init=function(){},t.activate=function(t,e){return this._device=t,this._pipeline=e,this.initOcclusionQuery(),!0},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new Og;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant()}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},t.onGlobalPipelineStateChanged=function(){},t.destroy=function(){var t,e,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=t.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=t.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Ho("a_position",Tr.RGB32F)],c=new jo(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)},L(e,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale!==t&&(this._shadingScale=t,this._pipeline.emit(wx.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(),rM=t("ForwardPipeline",(yO=ol("ForwardPipeline"),xO=kl([wb]),SO=Ol(),yO((CO=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"renderTextures",EO,V(e)),e._postRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new RT;n.initialize(RT.initInfo),this._flows.push(n);var i=new fT;i.initialize(fT.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new iM,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(w(2402),1))},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(rd,e),this._descriptorSet.bindTexture(rd,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(pd,e),this._descriptorSet.bindTexture(pd,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(ed.BINDING).destroy(),this._descriptorSet.getBuffer(id.BINDING).destroy(),this._descriptorSet.getBuffer(nd.BINDING).destroy(),this._descriptorSet.getTexture(rd).destroy(),this._descriptorSet.getTexture(pd).destroy())},L(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(Yx),EO=X((TO=CO).prototype,"renderTextures",[xO,hl,SO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bO=TO))||bO)),oM=[new So(0,0,0,0),new So(0,0,0,0),new So(0,0,0,0)],aM=t("GbufferStage",(wO=ol("GbufferStage"),AO=kl([Ib]),PO=Ol(),wO((MO=OO=function(t){function e(){var e;return q(e=t.call(this)||this,"renderQueues",DO,V(e)),e._renderQueues=[],e._renderArea=new fo,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Hv("default"),e._batchedQueue=new Bb,e._instancedQueue=new Fb,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Mb(this.renderQueues[i])},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(Nb),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var p=f.batchingScheme;if(p===zv.INSTANCING){var _=f.getInstancedBuffer();_.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(_)}else if(p===zv.VB_MERGING){var d=f.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(Lb);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&ro.COLOR&&(e.pipelineSceneData.isHDR?gg(oM[0],t.clearColor):(oM[0].x=t.clearColor.x,oM[0].y=t.clearColor.y,oM[0].z=t.clearColor.z)),oM[0].w=t.clearColor.w;var v=e.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,oM,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},e}(Cx),OO.initInfo={name:"GbufferStage",priority:kx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:Cb.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Cb.BACK_TO_FRONT,stages:["default"]}]},DO=X((RO=MO).prototype,"renderQueues",[AO,hl,PO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IO=RO))||IO)),sM=[new So(0,0,0,1)],cM=t("LightingStage",(NO=ol("LightingStage"),LO=kl(Og),BO=Ol(),FO=kl([Ib]),zO=Ol(),NO((jO=VO=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=Sd.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new fo,e._uiPhase=void 0,q(e,"_deferredMaterial",GO,V(e)),q(e,"renderQueues",HO,V(e)),e._phaseID=Hv("default"),e._renderQueues=[],e._uiPhase=new lT,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.gatherLights=function(t){for(var e=this._pipeline,n=e.commandBuffers[0],i=t.scene.sphereLights,r=t.scene.spotLights,o=oo.create(0,0,0,1),a=new Float32Array(4),s=t.exposure,c=0,l=ki.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var f=i[h];if(oo.set(o,f.position.x,f.position.y,f.position.z,f.range),nc.sphereFrustum(o,t.frustum)){if(vi.toArray(a,f.position),a[3]=0,this._lightBufferData.set(a,c*l),vi.toArray(a,f.color),f.useColorTemperature){var p=f.colorTemperatureRGB;a[0]*=p.x,a[1]*=p.y,a[2]*=p.z}e.pipelineSceneData.isHDR?a[3]=f.luminance*s*this._lightMeterScale:a[3]=f.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=f.size,a[1]=f.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var _=0;_<r.length&&c<this._maxDeferredLights;_++,++c){var d=r[_];if(oo.set(o,d.position.x,d.position.y,d.position.z,d.range),nc.sphereFrustum(o,t.frustum)){if(vi.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),vi.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),vi.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._uiPhase.activate(e);for(var i=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Mb(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new wo(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new ta(X_.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new ea(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(xd.BINDING,a),this._planarQueue=new cT(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(t){var e=this._pipeline,n=e.device,i=e.commandBuffers[0],r=e.pipelineSceneData,o=r.renderObjects;this.gatherLights(t),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(t,i),i.bindDescriptorSet(Z_.LOCAL,this._descriptorSet,[0]),e.generateRenderArea(t,this._renderArea),t.clearFlag&ro.COLOR&&(sM[0].x=t.clearColor.x,sM[0].y=t.clearColor.y,sM[0].z=t.clearColor.z),sM[0].w=0;var a=e.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;e.pipelineUBO.updateShadowUBO(t),i.beginRenderPass(c,s,this._renderArea,sM,t.clearDepth,t.clearStencil),i.setScissor(e.generateScissor(t)),i.setViewport(e.generateViewport(t)),i.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(Z_.MATERIAL,l.descriptorSet);var f=e.quadIAOffscreen,p=null;null!=l&&null!=u&&null!=f&&(p=dg.getOrCreatePipelineState(n,l,u,c,f)),null!=p&&(i.bindPipelineState(p),i.bindInputAssembler(f),i.draw(f)),this._renderQueues.forEach(Nb);for(var _=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(_=0;_<y.length;++_){var x=y[_].passes;for(d=0;d<x.length;++d)if(x[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,_,d)}}if(o.length>0){this._renderQueues.forEach(Lb);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(t,c),i.endRenderPass()},e}(Cx),VO.initInfo={name:"LightingStage",priority:kx.LIGHTING,tag:0},GO=X((kO=jO).prototype,"_deferredMaterial",[LO,hl,BO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HO=X(kO.prototype,"renderQueues",[FO,hl,zO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),UO=kO))||UO)),lM=[new So(0,0,0,1)],uM=t("PostProcessStage",(WO=ol("PostProcessStage"),qO=kl(Og),XO=Ol(),YO=kl([Ib]),KO=Ol(),WO((eM=tM=function(t){function e(){var e;return q(e=t.call(this)||this,"_postProcessMaterial",JO,V(e)),q(e,"renderQueues",$O,V(e)),e._renderArea=new fo,e._uiPhase=new lT,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){var e=this._pipeline,n=e.device,i=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var o=t.viewport;this._renderArea.x=o.x*t.window.width,this._renderArea.y=o.y*t.window.height,this._renderArea.width=o.width*t.window.width,this._renderArea.height=o.height*t.window.height;var a=e.getPipelineRenderData(),s=t.window.framebuffer,c=e.getRenderPass(t.clearFlag,s);t.clearFlag&ro.COLOR&&(lM[0].x=t.clearColor.x,lM[0].y=t.clearColor.y,lM[0].z=t.clearColor.z),lM[0].w=t.clearColor.w,r.beginRenderPass(c,s,this._renderArea,lM,t.clearDepth,t.clearStencil),r.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();e.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(Z_.MATERIAL,l.descriptorSet);var h=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=h&&(f=dg.getOrCreatePipelineState(n,l,u,c,h));var p=e.pipelineSceneData.renderObjects;null!=f&&p.length>0&&(r.bindPipelineState(f),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(t,c),Rg(n,c,r,e.profiler,t),r.endRenderPass()},e}(Cx),tM.initInfo={name:"PostProcessStage",priority:Fx.POST_PROCESS,tag:0},JO=X((ZO=eM).prototype,"_postProcessMaterial",[qO,hl,XO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$O=X(ZO.prototype,"renderQueues",[YO,hl,KO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QO=ZO))||QO));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(nM||(nM={}));var hM,fM,pM,_M,dM,mM,vM,gM,yM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._antiAliasing=nM.NONE,e}F(e,t);var n=e.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),e.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var t=new Og;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var n=new Og;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Og;r._uuid="builtin-post-process-material",$t.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=nM.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(e,n){return t.prototype.activate.call(this,e,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},L(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var n=new Og;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}(iM),xM=[new So(0,0,0,1)],SM=function(){};SM.SIZE=4*(SM.COUNT=4+(SM.TEXTURE_SIZE_OFFSET=0));var bM,TM,EM,CM,wM,AM,PM,IM,RM,DM,OM=t("BloomStage",(hM=ol("BloomStage"),fM=kl(Og),pM=Ol(),hM((gM=vM=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,q(e,"_bloomMaterial",mM,V(e)),e._renderArea=new fo,e._bloomUBO=[],e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(t){var e,n=this._pipeline;if(n.generateBloomRenderData(),((null===(e=t.window)||void 0===e?void 0:e.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,SM.SIZE,SM.SIZE));t.clearFlag&ro.COLOR&&(xM[0].x=t.clearColor.x,xM[0].y=t.clearColor.y,xM[0].z=t.clearColor.z),xM[0].w=t.clearColor.w,this._prefilterPass(t,n),this._downsamplePass(t,n),this._upsamplePass(t,n),this._combinePass(t,n)}},n._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(SM.COUNT);a[SM.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,xM,0,0),n.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Z_.MATERIAL,i.descriptorSet);var s=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=dg.getOrCreatePipelineState(e.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,o=new Float32Array(SM.COUNT),a=0;a<this.iterations;++a){o[SM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[SM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,xM,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Z_.MATERIAL,s.descriptorSet);var l=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=dg.getOrCreatePipelineState(e.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(t,e){var n=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,o=new Float32Array(SM.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[SM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[SM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,xM,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Z_.MATERIAL,c.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=dg.getOrCreatePipelineState(e.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(SM.COUNT);a[SM.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,xM,0,0),n.bindDescriptorSet(Z_.GLOBAL,e.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Z_.MATERIAL,s.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=dg.getOrCreatePipelineState(e.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},e}(Cx),vM.initInfo={name:"BloomStage",priority:Fx.BLOOM,tag:0},mM=X((dM=gM).prototype,"_bloomMaterial",[fM,hl,pM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_M=dM))||_M)),MM=t("MainFlow",ol("MainFlow")((EM=TM=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new aM;n.initialize(aM.initInfo),this._stages.push(n);var i=new cM;i.initialize(cM.initInfo),this._stages.push(i);var r=new OM;r.initialize(OM.initInfo),this._stages.push(r);var o=new uM;o.initialize(uM.initInfo),this._stages.push(o)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Ax),TM.initInfo={name:H_,priority:Gx.MAIN,stages:[]},bM=EM))||bM),NM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return F(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),LM=t("DeferredPipeline",(CM=ol("DeferredPipeline"),wM=kl([wb]),AM=Ol(),CM((DM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,q(e,"renderTextures",RM,V(e)),e}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new RT;n.initialize(RT.initInfo),this._flows.push(n);var i=new MM;i.initialize(MM.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new yM,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(w(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(rd,n),this._descriptorSet.bindTexture(rd,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(pd,n),this._descriptorSet.bindTexture(pd,Gv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new Xx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Wo;o.format=Tr.RGBA16F,o.loadOp=Vr.CLEAR,o.storeOp=jr.STORE;var a=new Wo;a.format=Tr.RGBA16F,a.loadOp=Vr.CLEAR,a.storeOp=jr.STORE;var s=new Wo;s.format=Tr.RGBA16F,s.loadOp=Vr.CLEAR,s.storeOp=jr.STORE;var c=new qo;c.format=Tr.DEPTH_STENCIL,c.depthLoadOp=Vr.CLEAR,c.depthStoreOp=jr.STORE,c.stencilLoadOp=Vr.CLEAR,c.stencilStoreOp=jr.STORE;var l=new Ko([o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Wo;u.format=Tr.RGBA8,u.loadOp=Vr.CLEAR,u.storeOp=jr.STORE,u.endAccesses=[Wr.COLOR_ATTACHMENT_WRITE];var h=new qo;h.format=Tr.DEPTH_STENCIL,h.depthLoadOp=Vr.LOAD,h.depthStoreOp=jr.DISCARD,h.stencilLoadOp=Vr.LOAD,h.stencilStoreOp=jr.DISCARD,h.beginAccesses=[Wr.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Wr.DEPTH_STENCIL_ATTACHMENT_WRITE];var f=new Ko([u],h);this._lightingRenderPass=e.createRenderPass(f)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(ed.BINDING).destroy(),this._descriptorSet.getBuffer(id.BINDING).destroy(),this._descriptorSet.getBuffer(nd.BINDING).destroy(),this._descriptorSet.getTexture(rd).destroy(),this._descriptorSet.getTexture(pd).destroy())},n._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var n=0;n<t.outputRenderTargets.length;n++)t.outputRenderTargets[n].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var t=this,e=this.device,n=this._pipelineRenderData=new NM,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(e.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Tr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=e.createTexture(new Ro(Rr.TEX2D,Dr.DEPTH_STENCIL_ATTACHMENT|Dr.SAMPLED,Tr.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=e.createFramebuffer(new Jo(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(e.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED,Tr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=e.createFramebuffer(new Jo(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(wx.ATTACHMENT_SCALE_CAHNGED,(function(e){n.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(n.gbufferFrameBuffer),t.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},e}(Yx),RM=X((IM=DM).prototype,"renderTextures",[wM,hl,AM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PM=IM))||PM));function BM(){var t=new rM;return t.initialize({flows:[]}),t}var FM=new Bi,zM=function(){var t=e.prototype;function e(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return t.pauseRendering=function(){this.isPause=!0},t.resumeRendering=function(){this.isPause=!1},t.main=function(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){var e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new So(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new So(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{i.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?i.view.setDesignResolutionSize(n.width,n.height,n.policy):i.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,i.game.once(i.Game.EVENT_GAME_INITED,(function(){i.director._lateUpdate=performance.now()}),i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")},t.setOnFinish=function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t},t._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new So(t.x,t.y,t.z,t.w)];var e=this.device,n=this.swapchain;this.renderArea=new fo(0,0,n.width,n.height),this.cmdBuff=e.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=e.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=e.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Ho("a_position",Tr.RG32F),new Ho("a_texCoord",Tr.RG32F)],u=new jo(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(u),this.projection=new Oi,Oi.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,n.surfaceTransform)},t.init=function(){var t=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),i.game.pause(),this.handle=requestAnimationFrame((function e(n){if(!t.cancelAnimate){var i=t.settings,r=t.device,o=t.swapchain;Oi.ortho(t.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;t.startTime<0&&(t.startTime=n);var l=n-t.startTime,u=gf(Zn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=t.logoTexture.width,f=t.logoTexture.height,p=c*i.displayRatio,_=p*h/f,d=p;if(o.surfaceTransform!==Sr.ROTATE_90&&o.surfaceTransform!==Sr.ROTATE_270||(_=p*a/s,d=p*f/h*s/a),t.logoMat.setProperty("resolution",FM.set(a,s),0),t.logoMat.setProperty("scale",FM.set(_,d),0),t.logoMat.setProperty("translate",FM.set(.5*a,.5*s),0),t.logoMat.setProperty("percent",u),t.logoMat.setProperty("u_projection",t.projection),t.logoMat.passes[0].update(),i.displayWatermark&&t.watermarkMat){var m=.5*c,v=t.watermarkTexture.width,g=m,y=m*t.watermarkTexture.height/v;o.surfaceTransform!==Sr.ROTATE_90&&o.surfaceTransform!==Sr.ROTATE_270||(g=.5*m,y=m*a/s*.5),t.watermarkMat.setProperty("resolution",FM.set(a,s),0),t.watermarkMat.setProperty("scale",FM.set(g,y),0),t.watermarkMat.setProperty("translate",FM.set(.5*a,.1*s),0),t.watermarkMat.setProperty("percent",u),t.watermarkMat.setProperty("u_projection",t.projection),t.watermarkMat.passes[0].update()}t.isPause||(t.frame(),l>i.totalTime&&(t.splashFinish=!0)),requestAnimationFrame(e)}}))},t.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},t.initLogo=function(){var t=this.device;this.logoMat=new Og,this.logoMat.initialize({effectName:"splash-screen"});var e=new Oo;e.addressU=Br.CLAMP,e.addressV=Br.CLAMP,e.addressW=Br.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new Ro(Rr.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,Tr.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new yo;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=e.measureText(n);e.fillText(n,(330-i.width)/2,6);var r=new yo;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Ro(Rr.TEX2D,Dr.SAMPLED|Dr.TRANSFER_DST,Tr.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new Og,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;t.acquire([e]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=e.width,r.height=e.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=dg.getOrCreatePipelineState(t,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Z_.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=dg.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Z_.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),t.flushCommands([n]),t.queue.submit([n]),t.present()},t.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0},L(e,[{key:"splashFinish",set:function(t){this._splashFinish=t,this._tryToStart()}},{key:"loadFinish",set:function(t){this._loadFinish=t,this._tryToStart()}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();zM._ins=void 0,i.internal.SplashScreen=zM;var UM=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},L(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());UM.Priority=Yt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var kM=new tt("Scheduler"),GM=function(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i};GM.get=function(t,e,n,i){var r=GM._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=n,r.markedForDeletion=i):r=new GM(t,e,n,i),r},GM.put=function(t){GM._listEntries.length<20&&(t.target=null,GM._listEntries.push(t))},GM._listEntries=[];var HM=function(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i};HM.get=function(t,e,n,i){var r=HM._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=n,r.callback=i):r=new HM(t,e,n,i),r},HM.put=function(t){HM._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,HM._hashUpdateEntries.push(t))},HM._hashUpdateEntries=[];var VM=function(t,e,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};VM.get=function(t,e,n,i,r,o){var a=VM._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new VM(t,e,n,i,r,o),a},VM.put=function(t){VM._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,VM._hashTimerEntries.push(t))},VM._hashTimerEntries=[];var jM=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,n,r,o,a){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=r,this._delay=a,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();jM._timers=[],jM.get=function(){return jM._timers.pop()||new jM},jM.put=function(t){jM._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,jM._timers.push(t))};var WM,qM=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=ft(!0),e._hashForTimers=ft(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}F(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?E(1513):t.id=kM.getNewId())};var n=e.prototype;return n.setTimeScale=function(t){this._timeScale=t},n.getTimeScale=function(){return this._timeScale},n.update=function(t){var e,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=(n=this._updatesNegList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updates0List).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updatesPosList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(o=a[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updates0List;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updatesPosList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(t,e,n,r,o,a){if("function"!=typeof t){var s=t;t=e,e=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!r,r=i.macro.REPEAT_FOREVER,o=0),I(e,1502);var c=e.uuid||e.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==a&&E(1511):(h=VM.get(null,e,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&t===l._callback)return b(1507,l.getInterval(),n),void(l._interval=n);(l=jM.get()).initWithCallback(this,t,e,n,r,o),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else w(1510)},n.scheduleUpdate=function(t,e,n){var i=t.uuid||t.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return b(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(t)}var o,a=GM.get(t,e,n,!1);0===e?(o=this._updates0List,this._appendIn(o,a)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,e)),this._hashForUpdates[i]=HM.get(o,a,t,null)}else w(1510)},n.unschedule=function(t,e){if(e&&t){var n=e.uuid||e.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(t===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),jM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else w(1510)}},n.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else w(1510)}},n.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)jM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}else w(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(UM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(t){var e,n,i,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)n=r[e],this.unscheduleAllForTarget(n.target);var o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[e])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&e++},n.isScheduled=function(t,e){I(t,1508),I(e,1509);var n=e.uuid||e.id;if(!n)return w(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(t===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(UM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(t){var e,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(e=a[n])&&(e.paused=!0,o.push(e.target));if(t<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));if(t<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},n.pauseTarget=function(t){I(t,1503);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!0);var i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}else w(1510)},n.resumeTarget=function(t){I(t,1504);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!1);var i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}else w(1510)},n.isTargetPaused=function(t){I(t,1505);var e=t.uuid||t.id;if(!e)return w(1510),!1;var n=this._hashForTimers[e];if(n)return n.paused;var i=this._hashForUpdates[e];return!!i&&i.entry.paused},n._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}VM.put(t)},n._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,n=this._hashForUpdates[e];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[e],GM.put(r),HM.put(n)}},n._priorityIn=function(t,e,n){for(var i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)},n._appendIn=function(t,e){t.push(e)},e}(UM));qM.ID="scheduler",i.Scheduler=qM;var XM=((WM={})[oh.PORTRAIT]=Sr.IDENTITY,WM[oh.LANDSCAPE_RIGHT]=Sr.ROTATE_90,WM[oh.PORTRAIT_UPSIDE_DOWN]=Sr.ROTATE_180,WM[oh.LANDSCAPE_LEFT]=Sr.ROTATE_270,WM),YM=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var n=0;n<e.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(t.createTexture(new Ro(Rr.TEX2D,Dr.COLOR_ATTACHMENT|Dr.SAMPLED|Dr.TRANSFER_SRC,e.renderPassInfo.colorAttachments[n].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==Tr.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new Ro(Rr.TEX2D,Dr.DEPTH_STENCIL_ATTACHMENT|Dr.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new Jo(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,XM[uh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Jo(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=W(this._cameras);!(i=r()).done;)i.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},e._init=function(){},e._destroy=function(){},e._setSwapchain=function(t){this._swapchain=t},e._setFrameBuffer=function(t){this._framebuffer=t},L(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),t}(),KM=function(){var t=e.prototype;function e(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(t),pg.registerCreateFunc(this),YM.registerCreateFunc(this),this._cameraPool=new jt((function(){return new bm(e._device)}),4,(function(t){return t.destroy()}))}return t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(t){this._cumulativeTime+=t},t._setFrameTime=function(t){this._frameTime=t},t.initialize=function(){this._init();var t=i.game._swapchain,e=new Wo;e.format=t.colorTexture.format;var n=new qo;n.format=t.depthStencilTexture.format,n.depthStoreOp=jr.DISCARD,n.stencilStoreOp=jr.DISCARD;var r=new Ko([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:r,swapchain:t}),this._curWindow=this._mainWindow,Promise.resolve(Gv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(t,e){for(var n,i=W(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(t,e)}},t.setRenderPipeline=function(t){t instanceof LM&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=BM(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature(br.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;var n=i.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(t){this._curWindow=t},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var n=this._windows,r=[],o=0;o<n.length;o++)n[o].extractRenderCameras(r);if(this._pipeline&&r.length>0){this._device.acquire([i.game._swapchain]);var a=this._scenes,s=i.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var c=0;c<a.length;c++)a[c].update(s);i.director.emit(i.Director.EVENT_BEFORE_COMMIT),r.sort((function(t,e){return t.priority-e.priority})),this._pipeline.render(r),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},t.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},t.destroyWindows=function(){for(var t,e=W(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},t.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},t.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},t.destroyScenes=function(){for(var t,e=W(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},t.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new jt((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):E(1300,t.constructor.name),t.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new jt((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case Ug.SPHERE:t.scene.removeSphereLight(t);break;case Ug.SPOT:t.scene.removeSpotLight(t)}t.destroy()},L(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();i.Root=KM;var QM=t("Game",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}F(e,t);var n=e.prototype;return n.setFrameRate=function(t){this.frameRate=t},n.getFrameRate=function(){return this.frameRate},n.step=function(){i.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(xD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var t=this;return new Promise((function(t){return i.director.once(i.Director.EVENT_END_FRAME,(function(){return t()}))})).then((function(){for(var n in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[n]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),i.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then((function(){t.resume(),t._safeEmit(e.EVENT_RESTART)}))}))},n.end=function(){pn.close()},n.on=function(t,n,i,r){return(this._engineInited&&t===e.EVENT_ENGINE_INITED||this._inited&&t===e.EVENT_GAME_INITED||this._rendererInitialized&&t===e.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(t,n,i,r)},n.once=function(t,n,i){return this._engineInited&&t===e.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(t,n,i)},n.init=function(t){var e=this;if(this._initConfig(t),fh._init({configOrientation:t.orientation||"auto",exactFitScreen:t.exactFitScreen}),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,r=0;r<n.length;r++){var o=n[r],a=Dn(o.value);U_.addLayer(o.name,a)}return this._initEngine().then((function(){return e._initEvents(),i.director.root&&i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),e._engineInited}))},n.run=function(t,e){var n,i=this;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,Nu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(t){if(i.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var n=i.director._scene;if(i.isValid(n))if(t.parent){if(!(t.parent instanceof i.Scene))return void E(3801);if(t.parent!==n)return void E(3802);t._originalSceneId=n.uuid}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(t)}}else E(3800)},n.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",i.assetManager._releaseManager._removePersistNodeRef(t))},n.isPersistRootNode=function(t){return!!t._persistNode},n.onEngineInitedAsync=function(t){this._onEngineInitedCallback.push(t)},n._initEngine=function(){var t=this;this._initDevice();var n=i.director;return Promise.resolve(n._init()).then((function(){i.view.init(),p("Cocos Creator v"+r),t.emit(e.EVENT_ENGINE_INITED),t._engineInited=!0,i.internal.dynamicAtlasManager&&(i.internal.dynamicAtlasManager.enabled=!$t.CLEANUP_IMAGE_CACHE)})).then((function(){var e=t._onEngineInitedCallback.map((function(t){return t()})).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)}))},n._setAnimFrame=function(){var t=this._frameRate,e=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==t&&30!==t?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=e||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(t){var e=performance.now(),n=Math.max(0,e-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(t,i)},n._ctTime=function(t){window.clearTimeout(t)},n._calculateDT=function(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>e.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},n._updateCallback=function(){var t,e=this,n=i.director;if(30===this._frameRate){var r=!0;t=function(t){e._intervalId=window.rAF(e._frameCB),(r=!r)||n.tick(e._calculateDT(t))}}else t=function(t){n.tick(e._calculateDT(t)),e._intervalId=window.rAF(e._frameCB)};this._frameCB=t},n._runMainLoop=function(){if(this._inited){var t=this.config,e=i.director;O(!!t.showFPS),e.startAnimation(),this.resume()}},n._initConfig=function(t){"number"!=typeof t.debugMode&&(t.debugMode=A.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);var e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,g(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate},n._determineRenderType=function(){var t=this.config,n=parseInt(t.renderMode,10);this.renderType=e.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=e.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=e.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=e.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(R(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===e.RENDER_TYPE_WEBGL){var n=new Eo(td),r=!!window.WebGL2RenderingContext,o=window.navigator.userAgent.toLowerCase();(-1!==o.indexOf("safari")&&-1===o.indexOf("chrome")||ph.browserType===an.UC)&&(r=!1);var a=[];r&&i.WebGL2Device&&a.push(i.WebGL2Device),i.WebGLDevice&&a.push(i.WebGLDevice),i.EmptyDevice&&a.push(i.EmptyDevice),wa.canvas=this.canvas;for(var s=0;s<a.length&&(this._gfxDevice=new a[s],!this._gfxDevice.initialize(n));s++);}else this.renderType===e.RENDER_TYPE_HEADLESS&&i.EmptyDevice&&(this._gfxDevice=new i.EmptyDevice,this._gfxDevice.initialize(new Eo(td)));if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=e.RENDER_TYPE_CANVAS);var c=new To(this.canvas),l=fh.windowSize;c.width=l.width,c.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(c),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){pn.on("show",this._onShow,this),pn.on("hide",this._onHide,this)},n._onHide=function(){this.emit(e.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(e.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var t=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(t._showSplashScreen()).then((function(){t._inited=!0,t._initTime=performance.now(),t._runMainLoop(),t._safeEmit(e.EVENT_GAME_INITED),t.onStart&&t.onStart()}))}))},n._setupRenderPipeline=function(){var t=this,e=this.config.renderPipeline;return e?new Promise((function(t,n){i.assetManager.loadAny(e,(function(e,i){return!e&&i instanceof Yx?t(i):n(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(n){_(n),_("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(i.internal.SplashScreen){var t=i.internal.SplashScreen.instance;return t.main(i.director.root),new Promise((function(e){t.setOnFinish((function(){return e()})),t.loadFinish=!0}))}return null},n._setRenderPipeline=function(t){i.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(e.EVENT_RENDERER_INITED)},n._safeEmit=function(t){this.emit(t)},L(e,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),e}(fn));QM.EVENT_HIDE="game_on_hide",QM.EVENT_SHOW="game_on_show",QM.EVENT_LOW_MEMORY="game_on_low_memory",QM.EVENT_GAME_INITED="game_inited",QM.EVENT_ENGINE_INITED="engine_inited",QM.EVENT_RENDERER_INITED="renderer_inited",QM.EVENT_RESTART="game_on_restart",QM.RENDER_TYPE_CANVAS=0,QM.RENDER_TYPE_WEBGL=1,QM.RENDER_TYPE_OPENGL=2,QM.RENDER_TYPE_HEADLESS=3,QM.DEBUG_DT_THRESHOLD=1,i.Game=QM;var ZM=t("game",i.game=new QM),JM=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new qM,e._compScheduler=new XD,e._nodeActivator=new hO,e._systems=[],ZM.once(QM.EVENT_RENDERER_INITED,e._initOnRendererInitialized,V(e)),e}F(e,t);var n=e.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(e.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(t,e,n){t instanceof fO&&(t=t.scene),I(t instanceof DD,1216),t._load();for(var r=Object.keys(ZM._persistRootNodes).map((function(t){return ZM._persistRootNodes[t]})),o=0;o<r.length;o++){var a=r[o];a.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var s=t.uuid===a._originalSceneId&&t.getChildByUuid(a.uuid);if(s){var c=s.getSiblingIndex();s._destroyImmediate(),t.insertChild(a,c)}else a.parent=t}var l=this._scene;i.isValid(l)&&l.destroy(),i.assetManager._releaseManager._autoRelease(l,t,ZM._persistRootNodes),this._scene=null,Ye._deferredDestroy(),e&&e(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,t)},n.runScene=function(t,e,n){var r=this;t instanceof fO&&(t=t.scene),I(t,1205),I(t instanceof DD,1216),t._load(),this.once(i.Director.EVENT_END_FRAME,(function(){r.runSceneImmediate(t,e,n)}))},n.loadScene=function(t,e,n){var r=this;if(this._loadingScene)return E(1208,t,this._loadingScene),!1;var o=i.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return o?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),o.loadScene(t,(function(i,o){console.timeEnd("LoadScene "+t),r._loadingScene="",i?(d(i),e&&e(i)):r.runSceneImmediate(o,n,e)})),!0):(w(1209,t),!1)},n.preloadScene=function(t,e,n){var r=i.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(r)r.preloadScene(t,null,e,n);else{var o='Can not preload the scene "'+t+'" because it is not in the build settings.';n&&n(new Error(o)),d("preloadScene: "+o)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return ZM.deltaTime},n.getTotalTime=function(){return ZM.totalTime},n.getCurrentTime=function(){return ZM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(qM.ID,t,200))},n.registerSystem=function(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(UM.sortByPriority)},n.unregisterSystem=function(t){kt.fastRemove(this._systems,t),this._systems.sort(UM.sortByPriority)},n.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},n.getAnimationManager=function(){return this.getSystem(i.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(t){var e;e=ZM._calculateDT(t),this.tick(e)},n.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),xD._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var n=0;n<this._systems.length;++n)this._systems[n].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),Ye._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),$C.resetHasChangedFlags(),$C.clearNodeArray(),Ht.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(qM.ID,this._scheduler,200),this.emit(e.EVENT_INIT)},n._init=function(){return this._root=new KM(ZM._gfxDevice),this._root.initialize({}).catch((function(t){return w(1217),Promise.reject(t)}))},L(e,[{key:"root",get:function(){return this._root}}]),e}(fn));JM.EVENT_INIT="director_init",JM.EVENT_RESET="director_reset",JM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",JM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",JM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",JM.EVENT_BEFORE_UPDATE="director_before_update",JM.EVENT_AFTER_UPDATE="director_after_update",JM.EVENT_BEFORE_DRAW="director_before_draw",JM.EVENT_AFTER_DRAW="director_after_draw",JM.EVENT_BEFORE_COMMIT="director_before_commit",JM.EVENT_BEFORE_PHYSICS="director_before_physics",JM.EVENT_AFTER_PHYSICS="director_after_physics",JM.EVENT_BEGIN_FRAME="director_begin_frame",JM.EVENT_END_FRAME="director_end_frame",JM.instance=void 0,i.Director=JM;var $M=t("director",JM.instance=i.director=new JM),tN={};Bn(tN,"vmath",[{name:"vec2",newName:"Vec2",target:Ki,targetName:"math"},{name:"vec3",newName:"Vec3",target:Ki,targetName:"math"},{name:"vec4",newName:"Vec4",target:Ki,targetName:"math"},{name:"quat",newName:"Quat",target:Ki,targetName:"math"},{name:"mat3",newName:"Mat3",target:Ki,targetName:"math"},{name:"mat4",newName:"Mat4",target:Ki,targetName:"math"},{name:"color4",newName:"Color",target:Ki,targetName:"math"},{name:"rect",newName:"Rect",target:Ki,targetName:"math"},{name:"approx",newName:"approx",target:Ki,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Ki,targetName:"math"},{name:"equals",newName:"equals",target:Ki,targetName:"math"},{name:"clamp",newName:"clamp",target:Ki,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Ki,targetName:"math"},{name:"lerp",newName:"lerp",target:Ki,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Ki,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Ki,targetName:"math"},{name:"random",newName:"random",target:Ki,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Ki,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Ki,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Ki,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Ki,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Ki,targetName:"math"},{name:"repeat",newName:"repeat",target:Ki,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Ki,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Ki,targetName:"math"}]),i.vmath=tN,Bn(qM.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:qM,targetName:"Scheduler"}]),Bn(qM,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return UM.Priority.SCHEDULER}}]),Fn(qM,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),Bn(Zv.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Fn(Zv.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),Bn(KM.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),zn(ZM,"game",[{name:"collisionMatrix"},{name:"groupList"}]),zn(JM.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),Fn(JM.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var eN,nN={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,n=this.height=t.height,i=t.x,r=t.y,o=r+n,a=i+e;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+e/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+e/2,this.bottom.y=r,this.center.x=i+e/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};i.visibleRect=nN;var iN=new Vi,rN=((eN={})[$t.ORIENTATION_AUTO]=oh.AUTO,eN[$t.ORIENTATION_LANDSCAPE]=oh.LANDSCAPE,eN[$t.ORIENTATION_PORTRAIT]=oh.PORTRAIT,eN),oN=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var n=aN,i=sN;return e._designResolutionSize=new Vi(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Wi(0,0,0,0),e._visibleRect=new Wi(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new cN(n.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new cN(n.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new cN(n.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new cN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new cN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}F(e,t);var n=e.prototype;return n.init=function(){var t=fh.windowSize,e=t.width,n=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=n,this._viewportRect.width=e,this._viewportRect.height=n,this._visibleRect.width=e,this._visibleRect.height=n,iN.width=this._visibleRect.width,iN.height=this._visibleRect.height,nN&&nN.init(this._visibleRect),uh.on("window-resize",this._updateAdaptResult,this),uh.on("orientation-change",this._updateAdaptResult,this),uh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(t){uh.handleResizeEvent=t},n.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},n.setOrientation=function(t){uh.orientation=rN[t]},n.adjustViewportMeta=function(){},n.enableRetina=function(t){this._retinaEnabled=!!t},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&fh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(t,e){uh.resolutionScale=1;var n=uh.devicePixelRatio,i=new Vi(t*n,e*n);fh.windowSize=i},n.getCanvasSize=function(){return fh.windowSize},n.getFrameSize=function(){var t=uh.devicePixelRatio,e=fh.windowSize;return e.width/=t,e.height/=t,e},n.setFrameSize=function(t,e){var n=uh.devicePixelRatio;fh.windowSize=new Vi(t*n,e*n)},n.getVisibleSize=function(){return new Vi(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new Vi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Bi(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Bi(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(t){if(t instanceof cN)this._resolutionPolicy=t;else{var e=cN;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=lN.getDesignResolutionSize();lN.setDesignResolutionSize(e.width,e.height,t)},n.setDesignResolutionSize=function(t,e,n){if(t>0&&e>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),iN.width=this._visibleRect.width,iN.height=this._visibleRect.height,nN&&nN.init(this._visibleRect),this.emit("design-resolution-changed")}else w(2200)},n.getDesignResolutionSize=function(){return new Vi(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(t,e,n){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return uh.devicePixelRatio},n.convertToLocationInView=function(t,e,n,i){void 0===i&&(i=new Bi);var r=uh.devicePixelRatio*(t-n.left),o=uh.devicePixelRatio*(n.top+n.height-e);return uh.isFrameRotated?(i.x=fh.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},n._updateAdaptResult=function(){var t;i.director.root.resize(fh.windowSize.width,fh.windowSize.height);var e=this._designResolutionSize.width,n=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}(fn));oN.instance=void 0;var aN=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=ZM.canvas;if(t){var e=fh.windowSize;t.width=e.width,t.height=e.height}},t}();aN.EQUAL_TO_FRAME=void 0,aN.PROPORTION_TO_FRAME=void 0;var sN=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,n,i,r,o){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);var a=new Wi(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},t}();sN.EXACT_FIT=void 0,sN.SHOW_ALL=void 0,sN.NO_BORDER=void 0,sN.FIXED_HEIGHT=void 0,sN.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="EqualToFrame",e}return F(e,t),e.prototype.apply=function(){uh.isProportionalToFrame=!1,this._setupCanvas()},e}(aN),e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ProportionalToFrame",e}return F(e,t),e.prototype.apply=function(){uh.isProportionalToFrame=!0,this._setupCanvas()},e}(aN);aN.EQUAL_TO_FRAME=new t,aN.PROPORTION_TO_FRAME=new e;var n=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ExactFit",e}return F(e,t),e.prototype.apply=function(t,e){var n=fh.windowSize,i=n.width,r=n.height,o=i/e.width,a=r/e.height;return this._buildResult(i,r,i,r,o,a)},e}(sN),i=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ShowAll",e}return F(e,t),e.prototype.apply=function(t,e){var n,i,r=fh.windowSize,o=r.width,a=r.height,s=e.width,c=e.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},e}(sN),r=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="NoBorder",e}return F(e,t),e.prototype.apply=function(t,e){var n,i,r,o=fh.windowSize,a=o.width,s=o.height,c=e.width,l=e.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},e}(sN),o=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedHeight",e}return F(e,t),e.prototype.apply=function(t,e){var n=fh.windowSize,i=n.width,r=n.height,o=r/e.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(sN),a=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedWidth",e}return F(e,t),e.prototype.apply=function(t,e){var n=fh.windowSize,i=n.width,r=n.height,o=i/e.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(sN);sN.EXACT_FIT=new n,sN.SHOW_ALL=new i,sN.NO_BORDER=new r,sN.FIXED_HEIGHT=new o,sN.FIXED_WIDTH=new a}();var cN=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof aN&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof sN&&(this._contentStrategy=t)},L(t,[{key:"canvasSize",get:function(){return fh.windowSize}}]),t}());cN.EXACT_FIT=0,cN.NO_BORDER=1,cN.SHOW_ALL=2,cN.FIXED_HEIGHT=3,cN.FIXED_WIDTH=4,cN.UNKNOWN=5,cN.ContainerStrategy=aN,cN.ContentStrategy=sN,i.ResolutionPolicy=cN;var lN=t("view",oN.instance=i.view=new oN);i.winSize=iN,Fn(oN.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),zn(oN.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),zn(i,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),zn(ph,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),Bn(ph,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(t){return{name:"LANGUAGE_"+t,newName:t,target:ph.Language,targetName:"sys.Language"}}))),Bn(ph,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(t){return{name:"OS_"+t,newName:t,target:ph.OS,targetName:"sys.OS"}}))),Bn(ph,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(t){return{name:"BROWSER_TYPE_"+t,newName:t,target:ph.BrowserType,targetName:"sys.BrowserType"}}))),Bn(ph,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:ph.BrowserType,targetName:"sys.BrowserType"}]),Bn(ph,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(t){return{name:t,target:ph.Platform,targetName:"sys.Platform"}}))),Bn(ph,"sys",[{name:"IPHONE",newName:"IOS",target:ph.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:ph.Platform,targetName:"sys.Platform"}]),Fn(ph,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(t){return{name:t}}))),Bn(ph,"sys",[{name:"windowPixelResolution",target:fh,targetName:"screen",newName:"windowSize"}]),zn(fh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var uN=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new eu,this.scenes=new eu,this.paths=new eu}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,n=t.paths,i=t.types,r=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,s=e.length;a<s;a++)e[a]=gu(e[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),f=0,p=e.length;f<p;f++){var _=e[f];e[f]=h[_]=gu(_)}e=h}for(var d in n){var m=n[d];o[e[d]]=m}var v=t.scenes;for(var g in v){var y=v[g];v[g]=e[y]}var x=t.packs;for(var S in x)for(var b=x[S],T=0;T<b.length;++T)b[T]=e[b[T]];var E=t.versions;if(E)for(var C in E)for(var w=E[C],A=0;A<w.length;A+=2){var P=w[A];w[A]=e[P]||P}var I=t.redirect;if(I)for(var R=0;R<I.length;R+=2)I[R]=e[I[R]],I[R+1]=r[I[R+1]];if(t.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(i,r){t.extensionMap[n][r]=e[i]||i}))};for(var O in t.extensionMap)D(O)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(t){var i=e.assetInfos.get(t);i&&(i.extension=n)}))};for(var i in t.extensionMap)n(i)},e.getInfoWithPath=function(t,e){if(!t)return null;t=Tu(t);var n=this.paths.get(t);if(n){if(!e)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(Gt.isChildClassOf(o.ctor,e))return o}}return null},e.getDirWithPath=function(t,e,n){"/"===(t=Tu(t))[t.length-1]&&(t=t.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var o=0,a=n.length;o<a;o++){var s=n[o];e&&!Gt.isChildClassOf(s.ctor,e)||i.push(s)}})),i},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,n){return n.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,n=t.length;e<n;e++){var i=t[e];this.assetInfos.add(i,{uuid:i})}}},e._initPath=function(t){if(t){var e=this.paths;for(var n in e.clear(),t){var i=t[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=Gt._getClassById(o),e.has(r)?a?e.get(r).push(s):e.get(r).unshift(s):e.add(r,[s])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var n=this.assetInfos;for(var i in t){var r=t[i],o=n.get(r);o.url=i,e.add(i,o)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var n in t){var i=t[n],r={uuid:n,packedUuids:i,ext:".json"};e.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=e.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,n=t.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];e.get(o).ver=n[i+1]}if(n=t.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];e.get(c).nativeVer=n[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,n=0,i=t.length;n<i;n+=2){var r=t[n];e.get(r).redirect=t[n+1]}},t}();function hN(t,e){t._uuid&&e.push(t._uuid)}function fN(t,e){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=t[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Bu&&hN(s,e)}else if(o.constructor&&o.constructor!==Object)o instanceof Bu&&hN(o,e);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Bu&&hN(u,e)}}}}function pN(t,e){for(var n=0;n<t._components.length;n++)fN(t._components[n],e);for(var i=0;i<t._children.length;i++)pN(t._children[i],e)}function _N(t,e,n,i){n.push(t._uuid);for(var r=Wm.getDeps(t._uuid),o=0,a=r.length;o<a;o++){var s=ru.get(r[o]);if(s){var c=s._uuid;c in e?e[c]+=i:e[c]=s.refCount+i,n.includes(c)||_N(s,e,n,i)}}}var dN=[],mN=new(function(){function t(){this._persistNodeDeps=new eu,this._toDelete=new eu,this._eventListener=!1}var e=t.prototype;return e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];pN(t,e);for(var n=0,i=e.length;n<i;n++){var r=ru.get(e[n]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),n=0,i=e.length;n<i;n++){var r=ru.get(e[n]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,n){if(t){for(var i=Wm.getDeps(t.uuid),r=0,o=i.length;r<o;r++){var a=ru.get(i[r]);a&&a.decRef(t.autoReleaseAssets)}var s=Wm._depends.get(t.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=ru.get(c[l]);h&&h.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&Wm.remove(t.uuid)}var f=Wm._depends.get(e.uuid);for(var p in f&&(f.persistDeps=[]),n){for(var _,d,m=n[p],v=this._persistNodeDeps.get(m.uuid),g=W(v);!(d=g()).done;){var y=d.value,x=ru.get(y);x&&x.addRef()}f&&(_=f.persistDeps).push.apply(_,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Bu&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,le(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var n=t._uuid;if(this._toDelete.remove(n),Qe(t,!0)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,_N(t,e,dN,-1),dN.length=0,0!==e[t._uuid])return e[t._uuid];for(var n in e)0!==e[n]&&_N(ru.get(n),e,dN,1);return dN.length=0,e[t._uuid]}(t)>0)){ru.remove(n);for(var i=Wm.getDeps(n),r=0,o=i.length;r<o;r++){var a=ru.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),Wm.remove(n)}},t}()),vN=null;function gN(t,e){for(var n=0,i=t.input.length;n<i;n++){var r=t.input[n];e&&!r.isNative&&r.content instanceof Bu&&r.content.decRef(!1),r.recycle()}t.input=null}function yN(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function xN(t,e,n,i,r){void 0===r&&(r=0),t(r,(function(o,a){r++,!o||r>e?i&&i(o,a):setTimeout((function(){xN(t,e,n,i,r)}),n)}))}function SN(t,e,n,i,r){try{for(var o=Wm.parse(t,e),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(B({},o.nativeDep)))}catch(t){d(t.message,t.stack)}}function bN(t,e,n){e&&(n=void 0!==n?n:i.assetManager.cacheAsset,bu(e)||!n||e.isDefault||ru.add(t,e))}function TN(t,e,n){var i=0,r=[],o=t.length;0===o&&n&&n(r);for(var a=function(t){t&&r.push(t),++i===o&&n&&n(r)},s=0;s<o;s++)e(t[s],a)}function EN(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a="function"==typeof t;e?(o=e,a||(r=null)):void 0===e&&a&&(o=t,i=null,r=null),void 0!==e&&a&&(r=t,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function CN(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a=Gt.isChildClassOf(t,Bu);e?(o=e,a&&(r=null)):void 0!==e||a||(o=t,r=null,i=null),void 0===e||a||(r=t,i=null)}return{type:i,onProgress:r||vN,onComplete:o}}function wN(t,e,n,i){if(void 0===i&&(i={}),!n[e]||i[e])return!1;i[e]=!0;var r=!1,o=Wm.getDeps(e);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===t||wN(t,c,n,i)){r=!0;break}}return r}function AN(t){return function(e,n){if(t){var i=[];Array.isArray(n)?n.forEach((function(t){return t instanceof Bu&&i.push(t.addRef())})):n instanceof Bu&&i.push(n.addRef()),le((function(){i.forEach((function(t){return t.decRef(!1)})),t(e,n)}))}}}var PN=function(){function t(){this._config=new uN}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,n){return this._config.getDirWithPath(t,e,n)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),su.add(t.name,this)},e.load=function(t,e,n,r){var o=CN(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete,l={__requestType__:iu.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(t)};i.assetManager.loadAny(t,l,s,c)},e.preload=function(t,e,n,r){var o=CN(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(t,{__requestType__:iu.PATH,type:a,bundle:this.name},s,c)},e.loadDir=function(t,e,n,r){var o=CN(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.loadAny(t,{__requestType__:iu.DIR,type:a,bundle:this.name,__outputAsArray__:!0},s,c)},e.preloadDir=function(t,e,n,r){var o=CN(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(t,{__requestType__:iu.DIR,type:a,bundle:this.name},s,c)},e.loadScene=function(t,e,n,r){var o=EN(e,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,i.assetManager.loadAny({scene:t},a,s,(function(t,e){if(t)d(t.message,t.stack);else if(e instanceof fO&&e.scene){var n=e.scene;n._id=e._uuid,n.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");c&&c(t,e)}))},e.preloadScene=function(t,e,n,r){var o=EN(e,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.bundle=this.name,i.assetManager.preloadAny({scene:t},a,s,(function(e){e&&w(1210,t,e.message),c&&c(e)}))},e.get=function(t,e){var n=this.getInfoWithPath(t,e);return n&&ru.get(n.uuid)||null},e.release=function(t,e){var n=this.get(t,e);n&&mN.tryRelease(n,!0)},e.releaseUnusedAssets=function(){var t=this;ru.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&mN.tryRelease(e)}))},e.releaseAll=function(){var t=this;ru.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&mN.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},L(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),IN=t("resources",new PN);function RN(t,e,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(R(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=t,i}function DN(t,e,n,i){var r=new XMLHttpRequest,o="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(t){t.lengthComputable&&n(t.loaded,t.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}i.resources=IN;var ON={};function MN(t,e,n){if(ON[t])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),ON[t]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(R(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var NN=/^(?:\w+:\/\/|\.+\/).+/,LN=function(t,e,n){(ph.hasFeature(ph.Feature.IMAGE_BITMAP)&&i.assetManager.allowImageBitmap?BN:RN)(t,e,n)},BN=function(t,e,n){e.xhrResponseType="blob",DN(t,e,e.onFileProgress,n)},FN=function(t,e,n){e.xhrResponseType="json",DN(t,e,e.onFileProgress,n)},zN=function(t,e,n){e.xhrResponseType="arraybuffer",DN(t,e,e.onFileProgress,n)},UN=function(t,e,n){FN(t,e,(function(e,i){if(e)n(e);else{var r=vh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){zN(""+yn(t)+n,{},(function(t,n){e?r(e):i(new Uint8Array(n))}))}))}))).then((function(t){var e=new mh(r.document,t);n(null,e)})).catch((function(t){n(t)}))}}))},kN=function(t,e,n){zN(t,e,(function(t,e){if(t)n(t);else try{var i=gh(new Uint8Array(e));n(null,i)}catch(t){n(t)}}))},GN=function(t,e,n){e.xhrResponseType="text",DN(t,e,e.onFileProgress,n)},HN=function(t,e,n){var i=xn(t),r=t;NN.test(r)||(r=-1!==VN.remoteBundles.indexOf(i)?VN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=e.version||VN.bundleVers[i],a=0,s=null,c=null;FN(r+"/config."+(o?o+".":"")+"json",e,(function(t,e){c=t,(s=e)&&(s.base=r+"/"),2==++a&&n(c,s)})),MN(r+"/index."+(o?o+".":"")+"js",e,(function(t){c=t,2==++a&&n(t,s)}))},VN=new(function(){function t(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=RN,this.downloadDomAudio=null,this.downloadFile=DN,this.downloadScript=MN,this._downloaders={".png":LN,".jpg":LN,".bmp":LN,".jpeg":LN,".gif":LN,".ico":LN,".tiff":LN,".webp":LN,".image":LN,".pvr":zN,".pkm":zN,".astc":zN,".txt":GN,".xml":GN,".vsh":GN,".fsh":GN,".atlas":GN,".tmx":GN,".tsx":GN,".json":FN,".ExportJson":FN,".plist":GN,".ccon":UN,".cconb":kN,".fnt":GN,".binary":zN,".bin":zN,".dbbin":zN,".skel":zN,".js":MN,bundle:HN,default:GN},this._downloading=new eu,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n},e.register=function(t,e){"object"==typeof t?Tt(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,n,i,r){var o=this,a=ou.get(t);if(a)r(null,a);else{var s=this._downloading.get(t);if(s){s.push(r);var c=this._queue.find((function(e){return e.id===t}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,f=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,p=this._downloaders[n]||this._downloaders.default;xN((function(n,a){if(0===n&&o._downloading.add(t,[r]),o.limited){o._updateTime();var s=function(t,e){o._totalNum--,o._handleQueueInNextFrame(h,f),a(t,e)};o._totalNum<h&&o._totalNumThisPeriod<f?(p(yN(e,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:s,handler:p}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,f))}else p(yN(e,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(e,n){e||ou.add(t,n);for(var i=o._downloading.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))}}},e.loadSubpackage=function(t,e){i.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=i.game.deltaTime,n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(yN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(le(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},L(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}());function jN(t,e,n,i){var r=null,o=null;try{(r=new Fm)._nativeUrl=t,r._nativeAsset=e}catch(t){o=t}i(o,r)}function WN(t,e,n,i){var r=new gO;r.json=e,i(null,r)}function qN(t,e,n,i){var r=new vO;r.text=e,i(null,r)}function XN(t,e,n,i){var r=new Hw;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function YN(t,e,n,i){var r=new Bu;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function KN(t,n,i,r){var o=su.get(n.name);o||(o=n.name===hu.RESOURCES?IN:new PN,n.base=n.base||t+"/",o.init(n)),e.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var QN=new(function(){function t(){this._creating=new eu,this._producers={".png":jN,".jpg":jN,".bmp":jN,".jpeg":jN,".gif":jN,".ico":jN,".tiff":jN,".webp":jN,".image":jN,".pvr":jN,".pkm":jN,".txt":qN,".xml":qN,".vsh":qN,".fsh":qN,".atlas":qN,".tmx":qN,".tsx":qN,".fnt":qN,".json":WN,".ExportJson":WN,".binary":XN,".bin":XN,".dbbin":XN,".skel":XN,bundle:KN,default:YN}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?Gt.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=ru.get(t);if(i.reloadAsset||!s){var c=this._creating.get(t);c?c.push(r):(this._creating.add(t,[r]),a(t,e,i,(function(e,n){!e&&n instanceof Bu&&(n._uuid=t,bN(t,n,i.cacheAsset));for(var r=o._creating.remove(t),a=0,s=r.length;a<s;a++)r[a](e,n)})))}else r(null,s)},t}()),ZN=new(function(){function t(){this._loading=new eu,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,n,i){var r=Gt.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(R(5304,t[0]));zh(t,!0,void 0,kh.reportMissingClass),Uh(t);for(var e=new Gh(t[0]),n=t[1],i=t[2],r=t[3],o=t[4],a=t[5],s=0;s<a.length;++s)a[s].unshift(e,n,i,r,o);return a}(e)).length!==t.length&&w(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var s=Gt._getClassId(cv),c=Gt._getClassId(Fm);if(e.type===s&&e.data){var l=e.data;l.length!==t.length&&w(4915);for(var u=0;u<t.length;u++)r[t[u]+"@import"]=Hh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(e.type===c&&e.data){var h=e.data;h.length!==t.length&&w(4915);for(var f=0;f<t.length;f++)r[t[f]+"@import"]=h[f]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?Gt.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,n,i,r){e?(0,this._unpackers[n])(t,e,i,r):r(new Error("package data is wrong!"))},e.load=function(t,e,n){var i=this;if(!t.isNative&&t.info&&t.info.packs)if(ou.has(t.id))n(null,ou.get(t.id));else{var r=t.info.packs,o=r.find((function(t){return i._loading.has(t.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:t.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:t.id}]);var a=Eu(o.uuid,{ext:o.ext,bundle:t.config.name});VN.download(o.uuid,a,o.ext,t.options,(function(e,n){ou.remove(o.uuid),e&&d(e.message,e.stack),i.unpack(o.packedUuids,n,o.ext,t.options,(function(t,n){if(!t)for(var r in n)ou.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(e||t)l.onComplete(e||t);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else VN.download(t.id,t.url,t.ext,t.options,n)},t}());function JN(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var r=t.options,o=t.progress,a=[],s=o.total,c=r.__exclude__=r.__exclude__||Object.create(null);t.output=[],TN(t.input,(function(r,l){if(!r.isNative&&ru.has(r.uuid)){var u=ru.get(r.uuid);return r.content=u.addRef(),t.output.push(r),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r),void l()}ZN.load(r,t.options,(function(u,h){u?t.isFinish||(!i.assetManager.force||n?(d(u.message,u.stack),o.canInvoke=!1,e(u)):(t.output.push(r),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r))):t.isFinish||(r.file=h,t.output.push(r),r.isNative||(c[r.uuid]=!0,SN(r.uuid,h,c,a,r.config),o.total=s+a.length),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r)),l()}))}),(function(){if(t.isFinish)return gN(t,!0),void t.dispatch("error");if(a.length>0){var i=pu.create({input:a,progress:o,options:r,onProgress:t.onProgress,onError:pu.prototype.recycle,onComplete:function(r){var o;r||((o=t.output).push.apply(o,i.output),i.recycle()),n&&$N(t),e(r)}});lu.async(i)}else n&&$N(t),e()}))}function $N(t){for(var e=t.output,n=0,i=e.length;n<i;n++)e[n].content&&e[n].content.decRef(!1)}var tL=new(function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return E(5100),{};for(var n=null,i=0,r=e.childNodes.length;i<r&&1!==(n=e.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(t){var e=null,n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e},n._parseArray=function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var r=t.childNodes[n];1===r.nodeType&&e.push(this._parseNode(r))}return e},n._parseDict=function(t){for(var e={},n="",i=0,r=t.childNodes.length;i<r;i++){var o=t.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:e[n]=this._parseNode(o))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function eL(t,e){return t[e]<<8|t[e+1]}var nL=new(function(){function t(){this._parsing=new eu,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){n(null,t)}),(function(t){n(t,null)}))},e.parsePVRTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],f=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:f,height:h,format:0}}}catch(t){i=t}n(i,r)},e.parsePKMTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o),s=eL(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=eL(a,12),l=eL(a,14);eL(a,8),eL(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(t){i=t}n(i,r)},e.parseASTCTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(t,e){return 4===t?sm.RGBA_ASTC_4x4:5===t?4===e?sm.RGBA_ASTC_5x4:sm.RGBA_ASTC_5x5:6===t?5===e?sm.RGBA_ASTC_6x5:sm.RGBA_ASTC_6x6:8===t?5===e?sm.RGBA_ASTC_8x5:6===e?sm.RGBA_ASTC_8x6:sm.RGBA_ASTC_8x8:10===t?5===e?sm.RGBA_ASTC_10x5:6===e?sm.RGBA_ASTC_10x6:8===e?sm.RGBA_ASTC_10x8:sm.RGBA_ASTC_10x10:10===e?sm.RGBA_ASTC_12x10:sm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),f=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:f,format:u}}catch(t){i=t}n(i,r)},e.parsePlist=function(t,e,n){var i=null,r=tL.parse(t);r||(i=new Error("parse failed")),n(i,r)},e.parseImport=function(t,e,n){if(t){var i=null,r=null;try{i=Vm(t,e)}catch(t){r=t}n(r,i)}else n(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?Tt(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,n,i,r){var o=this,a=au.get(t);if(a)r(null,a);else{var s=this._parsing.get(t);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(t,[r]),c(e,i,(function(e,n){e?ou.remove(t):bu(n)||au.add(t,n);for(var i=o._parsing.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))):r(null,e)}}},t}());function iL(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var r=t.options,o=t.progress;r.__exclude__=r.__exclude__||Object.create(null),t.output=[],TN(t.input,(function(a,s){var c=pu.create({input:a,onProgress:t.onProgress,options:r,progress:o,onComplete:function(r,l){r&&!t.isFinish&&(!i.assetManager.force||n?(d(r.message,r.stack),o.canInvoke=!1,e(r)):o.canInvoke&&t.dispatch("progress",++o.finish,o.total,a)),t.output.push(l),c.recycle(),s(null)}});rL.async(c)}),(function(){if(r.__exclude__=null,t.isFinish)return gN(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var n=t.output=[],i=0,r=e.length;i<r;i++)n.push(e[i].content);else t.output=e[0].content}(t),gN(t,!0),e()}))}var rL=new nu("loadOneAsset",[function(t,e){var n=t.output=t.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&ru.has(o)?e():ZN.load(n,t.options,(function(t,i){n.file=i,e(t)}))},function(t,e){var n=t.output=t.input,i=t.progress,r=t.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)nL.parse(o,a,n.ext,s,(function(r,a){r?e(r):(n.content=a,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),ou.remove(o),au.remove(o),e())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,f=l.err,p=l.callbacks;i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),u||wN(c,c,r)?(h&&h.addRef(),n.content=h,e(f)):p.push({done:e,item:n})}else if(!s.reloadAsset&&ru.has(c)){var _=ru.get(c);n.content=_.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()}else s.__uuid__=c,nL.parse(o,a,"import",s,(function(n,i){n?e(n):function(t,e,n){var i=t.input,r=t.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];e.addRef&&e.addRef(),SN(a,e,Object.create(null),h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=h.length,i);var f=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:n,item:i}]},p=pu.create({input:h,options:t.options,onProgress:t.onProgress,onError:pu.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),f.finish=!0,f.err=t,!t){for(var n,i=Array.isArray(p.output)?p.output:[p.output],r=Object.create(null),o=W(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Bu?c._uuid+"@import":a+"@native"]=c)}!function(t,e,n){var i=km.get(e);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(d("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Bu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}km.delete(e)}Gm.has(e)&&(n[t+"@native"]?e._nativeAsset=n[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),Gm.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||Hm.has(e)||Gm.has(e)||(e.onLoaded(),Hm.add(e))}catch(t){d("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}ou.remove(s),au.remove(s),bN(a,e,u),p.recycle()}for(var l=f.callbacks,h=0,_=l.length;h<_;h++){var m=l[h];e.addRef&&e.addRef(),m.item.content=e,m.done(t)}l.length=0}});cu.async(p)}(t,i,e)}))}}]);function oL(t,e){var n=t.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case iu.PATH:case iu.UUID:case iu.DIR:case iu.SCENE:case iu.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}t.options=r;var a=pu.create({input:t.input,options:i}),s=null;try{t.output=t.source=uu.sync(a)}catch(t){s=t;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),e(s)}var aL=function(){function t(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},L(t,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),t}();aL.MAX_DEAD_NUM=500,aL._deadPool=[];var sL=[];function cL(t){var e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var i=function(i){var r,o=n[i],a=aL.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[e.__requestType__||iu.UUID]=n[i]),"object"==typeof o)for(var l in bt(o,e),o.preset&&bt(o,fu[o.preset]),o){switch(l){case iu.UUID:if("break"===function(){var t,e=a.uuid=gu(o.uuid);if(!o.bundle){var n=su.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=n&&n.name}if(su.has(o.bundle)){if(s=su.get(o.bundle).config,(c=s.getAssetInfo(e))&&c.redirect){if(!su.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=su.get(c.redirect).config,c=s.getAssetInfo(e)}a.config=s,a.info=c}return a.ext=o.ext||(null===(t=c)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case iu.DIR:if(su.has(o.bundle)){su.get(o.bundle).config.getDirWithPath(o.dir,o.type,sL);for(var u,h=W(sL);!(u=h()).done;){var f=u.value;n.push({uuid:f.uuid,__isNative__:!1,ext:f.extension||".json",bundle:o.bundle})}sL.length=0}a.recycle(),a=null;break;case iu.PATH:if(su.has(o.bundle)){if(s=su.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!su.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=su.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case iu.SCENE:if(!o.bundle){var p=su.find((function(t){return!!t.getSceneInfo(o.scene)}));o.bundle=p&&p.name}if(su.has(o.bundle)){if(s=su.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!su.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=su.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case iu.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||gn(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function lL(t){for(var e=t.output=t.input,n=0;n<e.length;n++){var r=e[n];if(!r.url){var o,a,s=r.config;a=r.isNative?s&&s.nativeBase?s.base+s.nativeBase:i.assetManager.generalNativeBase:s&&s.importBase?s.base+s.importBase:i.assetManager.generalImportBase;var c=r.uuid,l="";r.info&&(l=r.isNative?r.info.nativeVer?"."+r.info.nativeVer:"":r.info.ver?"."+r.info.ver:""),o=".ttf"===r.ext?a+"/"+c.slice(0,2)+"/"+c+l+"/"+r.options.__nativeName__:a+"/"+c.slice(0,2)+"/"+c+l+r.ext,r.url=o}}return null}var uL=t("AssetManager",function(){function t(){this.pipeline=cu.append(oL).append(iL),this.fetchPipeline=lu.append(oL).append(JN),this.transformPipeline=uu.append(cL).append(lL),this.bundles=su,this.assets=ru,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Wm,this.force=!1,this.allowImageBitmap=!ph.isMobile,this.utils=Mu,this.downloader=VN,this.parser=nL,this.packManager=ZN,this.cacheAsset=!0,this.cacheManager=null,this.presets=fu,this.factory=QN,this.preprocessPipe=oL,this.fetchPipe=JN,this.loadPipe=iL,this.references=null,this._releaseManager=mN,this._files=ou,this._parsed=au,this._parsePipeline=null}var e=t.prototype;return e.init=function(t){void 0===t&&(t={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();var e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));var n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n},e.getBundle=function(t){return su.get(t)||null},e.removeBundle=function(t){t._destroy(),su.remove(t.name)},e.loadAny=function(t,e,n,i){var r=EN(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",t=Array.isArray(t)?t.slice():t;var c=pu.create({input:t,onProgress:a,onComplete:AN(s),options:o});cu.async(c)},e.preloadAny=function(t,e,n,i){var r=EN(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",t=Array.isArray(t)?t.slice():t;var c=pu.create({input:t,onProgress:a,onComplete:AN(s),options:o});lu.async(c)},e.loadRemote=function(t,e,n){var i=EN(e,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,n){e?(d(e.message,e.stack),o&&o(e,n)):QN.create(t,n,r.ext||gn(t),r,(function(t,e){o&&o(t,e)}))}))):AN(o)(null,this.assets.get(t))},e.loadBundle=function(t,e,n){var i=EN(e,void 0,n),r=i.options,o=i.onComplete,a=xn(t);this.bundles.has(a)?AN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,n){e?(d(e.message,e.stack),o&&o(e,n)):QN.create(t,n,"bundle",r,(function(t,e){o&&o(t,e)}))})))},e.releaseAsset=function(t){mN.tryRelease(t,!0)},e.releaseUnusedAssets=function(){ru.forEach((function(t){mN.tryRelease(t)}))},e.releaseAll=function(){ru.forEach((function(t){mN.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},L(t,[{key:"main",get:function(){return su.get(hu.MAIN)||null}},{key:"resources",get:function(){return su.get(hu.RESOURCES)||null}}]),t}());uL.Pipeline=nu,uL.Task=pu,uL.Cache=eu,uL.RequestItem=aL,uL.Bundle=PN,uL.BuiltinBundleName=hu;var hL=t("assetManager",i.assetManager=new uL);i.AssetManager=uL;var fL=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],pL=[".mp3",".ogg",".wav",".m4a"];function _L(){return!0}var dL={transformURL:function(t){var e=xu(t);if(!e)return t;var n=su.find((function(t){return!!t.getAssetInfo(e)}));if(!n)return t;var i,r=n.getAssetInfo(e);if(!(i=t.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==t.indexOf(i))return t;var o=!1;if(".ttf"===gn(t)&&(o=!0),o){var a=Sn(t),s=xn(t);t=a+"."+i+"/"+s}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(t){return t+"."+i}));return t}},mL=t("CCLoader",function(){function t(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=CN}var e=t.prototype;return e.load=function(t,e,n){void 0===n&&void 0!==e&&(n=e,e=null);for(var i=Array.isArray(t)?t:[t],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];hL.loadAny(i,null,(function(t,n,i){i.content&&(fL.includes(i.ext)?a.push(i.content):pL.includes(i.ext)&&s.push(i.content)),e&&e(t,n,i)}),(function(t,e){var r=null;if(!t){e=Array.isArray(e)?e:[e];for(var o=function(t){var n=e[t];if(!(n instanceof Bu)){var r=n,o=i[t].url;a.includes(r)?QN.create(o,n,".png",{},(function(n,i){r=e[t]=i})):s.includes(r)&&QN.create(o,n,".mp3",{},(function(n,i){r=e[t]=i})),ru.add(o,r)}},c=0;c<e.length;c++)o(c);if(e.length>1){var l=Object.create(null);e.forEach((function(t){l[t._uuid]=t})),r={isCompleted:_L,_map:l}}else r=e[0]}n&&n(t,r)}))},e.getXMLHttpRequest=function(){return new XMLHttpRequest},e.getItem=function(t){return hL.assets.has(t)?{content:hL.assets.get(t)}:null},e.loadRes=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=gn(t);c&&!IN.getInfoWithPath(t,o)&&(t=t.slice(0,-c.length)),IN.load(t,o,a,s)},e.loadResArray=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;t.forEach((function(e,n){var i=gn(e);i&&!IN.getInfoWithPath(e,o)&&(t[n]=e.slice(0,-i.length))})),IN.load(t,o,a,s)},e.loadResDir=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;IN.loadDir(t,o,a,(function(e,n){var i=[];e||(i=IN.getDirWithPath(t,o).map((function(t){return t.path}))),s&&s(e,n,i)}))},e.getRes=function(t,e){return ru.has(t)?ru.get(t):IN.get(t,e)},e.getResCount=function(){return ru.count},e.getDependsRecursively=function(t){if(!t)return[];var e="string"==typeof t?t:t._uuid;return Wm.getDepsRecursively(e).concat([e])},e.addDownloadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({url:t},n)}};for(var i in t)n(i);VN.register(e)},e.addLoadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({content:t},n)}};for(var i in t)n(i);nL.register(e)},e.release=function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=ru.get(n)),hL.releaseAsset(n)}else t&&("string"==typeof t&&(t=ru.get(t)),hL.releaseAsset(t))},e.releaseAsset=function(t){hL.releaseAsset(t)},e.releaseRes=function(t,e){IN.release(t,e)},e.releaseAll=function(){hL.releaseAll(),ru.clear()},e.removeItem=function(t){return!!ru.remove(t)},e.setAutoRelease=function(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e},e.setAutoReleaseRecursively=function(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;for(var n=Wm.getDepsRecursively(t),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=e},e.isAutoRelease=function(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]},L(t,[{key:"onProgress",set:function(t){vN=t}},{key:"_cache",get:function(){if(ru instanceof eu)return ru._map;var t={};return ru.forEach((function(e,n){t[n]=e})),t}},{key:"md5Pipe",get:function(){return dL}},{key:"downloader",get:function(){return VN}},{key:"loader",get:function(){return hL.parser}}]),t}()),vL=t("loader",new mL),gL=t("AssetLibrary",{init:function(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,hL.init(t),t.rawAssets&&IN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:hu.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset:function(t,e){hL.loadAny(t,e)}}),yL=t("url",{});Bn(yL,"url",[{name:"normalize",target:hL.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(t){return t.startsWith("resources/")?Eu({path:bn(t.substr(10)),bundle:hu.RESOURCES,__isNative__:!0,ext:gn(t)}):""}}]),Fn(gL,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),Fn(vL,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),Bn(i,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return vL}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return gL}},{name:"Pipeline",target:uL,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return yL}}]),Fn(i,"cc",[{name:"LoadingItems",suggest:R(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),Bn($t,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:VN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),Bn($M,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(t){var e;return hL.main?null===(e=hL.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),Bn(ZM,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var t=[];return hL.main&&hL.main.config.scenes.forEach((function(e){t.push(e)})),t}}]);var xL,SL,bL,TL,EL,CL,wL,AL,PL,IL,RL,DL,OL,ML,NL=mN._autoRelease;mN._autoRelease=function(t,e,n){NL.call(mN,t,e,n);for(var i=vL._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=ru.get(a);s&&mN.tryRelease(s)}}};var LL,BL,FL,zL,UL,kL,GL,HL,VL,jL,WL,qL,XL,YL,KL,QL,ZL,JL,$L,tB,eB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB,fB,pB,_B,dB,mB,vB,gB,yB,xB,SB,bB,TB,EB,CB,wB,AB,PB,IB,RB,DB,OB,MB,NB,LB,BB,FB,zB,UB,kB,GB,HB,VB,jB,WB,qB,XB,YB=t("EventHandler",(xL=ol("cc.ClickEvent"),SL=kl(i.Node),bL=wl(),TL=wl(),EL=wl(),CL=wl(),xL((ML=function(){function t(){q(this,"target",PL,this),q(this,"component",IL,this),q(this,"_componentId",RL,this),q(this,"handler",DL,this),q(this,"customEventData",OL,this)}t.emitEvents=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=e.length;o<a;o++){var s=e[o];s instanceof t&&s.emit(i)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(i.isValid(e)){this._genCompIdIfNeeded();var n=i.js._getClassById(this._componentId),r=e.getComponent(n);if(i.isValid(r)){var o=r[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),o.apply(r,t))}}},e._compName2Id=function(t){var e=i.js.getClassByName(t);return i.js._getClassId(e)},e._compId2Name=function(t){var e=i.js._getClassById(t);return i.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},L(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),PL=X((AL=ML).prototype,"target",[hl,SL,hl,bL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IL=X(AL.prototype,"component",[hl,bl,TL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RL=X(AL.prototype,"_componentId",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DL=X(AL.prototype,"handler",[hl,bl,EL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OL=X(AL.prototype,"customEventData",[hl,bl,CL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wL=AL))||wL));i.Component.EventHandler=YB;var KB,QB,ZB,JB,$B,tF,eF,nF,iF,rF,oF,aF=new vi,sF=Yt($d),cF=Yt(Jd),lF=Yt(tm),uF=Yt(nm),hF=Yt(em),fF=Yt({SKYBOX:xm|ro.DEPTH_STENCIL,SOLID_COLOR:ro.ALL,DEPTH_ONLY:ro.DEPTH_STENCIL,DONT_CLEAR:ro.NONE}),pF=(LL=ol("cc.Camera"),BL=Sl(),FL=vl(),zL=Ol(),UL=wl(),kL=kl(U_.BitMask),GL=Ol(),HL=wl(),VL=kl(fF),jL=Ol(),WL=wl(),qL=Ol(),XL=wl(),YL=Ol(),KL=wl(),QL=Ol(),ZL=wl(),JL=kl(sF),$L=Ol(),tB=wl(),eB=kl(cF),nB=Ol(),iB=wl(),rB=Ol(),oB=wl(),aB=Ol(),sB=wl(),cB=Ol(),lB=wl(),uB=Ol(),hB=wl(),fB=kl(lF),pB=Ol(),_B=wl(),dB=kl(uF),mB=Ol(),vB=wl(),gB=kl(hF),yB=Ol(),xB=wl(),SB=Ol(),bB=wl(),TB=kl(Eb),EB=Ol(),CB=wl(),KB=LL(wB=BL(wB=FL(wB=ml((XB=qB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_projection",PB,V(e)),q(e,"_priority",IB,V(e)),q(e,"_fov",RB,V(e)),q(e,"_fovAxis",DB,V(e)),q(e,"_orthoHeight",OB,V(e)),q(e,"_near",MB,V(e)),q(e,"_far",NB,V(e)),q(e,"_color",LB,V(e)),q(e,"_depth",BB,V(e)),q(e,"_stencil",FB,V(e)),q(e,"_clearFlags",zB,V(e)),q(e,"_rect",UB,V(e)),q(e,"_aperture",kB,V(e)),q(e,"_shutter",GB,V(e)),q(e,"_iso",HB,V(e)),q(e,"_screenScale",VB,V(e)),q(e,"_visibility",jB,V(e)),q(e,"_targetTexture",WB,V(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=eg.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(t,e,n){return n||(n=fr.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n},n.worldToScreen=function(t,e){return e||(e=new vi),this._camera&&this._camera.worldToScreen(e,t),e},n.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},n.convertToUINode=function(t,e,n){if(n||(n=new vi),!this._camera)return n;this.worldToScreen(t,aF);var r=e.getComponent("cc.UITransform"),o=lN.getVisibleSize(),a=aF.x-.5*this._camera.width,s=aF.y-.5*this._camera.height;return aF.x=a/i.view.getScaleX()+.5*o.width,aF.y=s/i.view.getScaleY()+.5*o.height,r&&r.convertToNodeSpaceAR(aF,n),n},n._createCamera=function(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=$n(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},L(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Jd.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=$n(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var n=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}}]),e}(ih),qB.ProjectionType=sF,qB.FOVAxis=cF,qB.ClearFlag=fF,qB.Aperture=lF,qB.Shutter=uF,qB.ISO=hF,qB.TARGET_TEXTURE_CHANGE="tex-change",PB=X((AB=XB).prototype,"_projection",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sF.PERSPECTIVE}}),IB=X(AB.prototype,"_priority",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RB=X(AB.prototype,"_fov",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),DB=X(AB.prototype,"_fovAxis",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cF.VERTICAL}}),OB=X(AB.prototype,"_orthoHeight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),MB=X(AB.prototype,"_near",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),NB=X(AB.prototype,"_far",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),LB=X(AB.prototype,"_color",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di("#333333")}}),BB=X(AB.prototype,"_depth",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FB=X(AB.prototype,"_stencil",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zB=X(AB.prototype,"_clearFlags",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fF.SOLID_COLOR}}),UB=X(AB.prototype,"_rect",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wi(0,0,1,1)}}),kB=X(AB.prototype,"_aperture",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lF.F16_0}}),GB=X(AB.prototype,"_shutter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uF.D125}}),HB=X(AB.prototype,"_iso",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hF.ISO100}}),VB=X(AB.prototype,"_screenScale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jB=X(AB.prototype,"_visibility",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return im}}),WB=X(AB.prototype,"_targetTexture",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(AB.prototype,"priority",[zL,UL],Object.getOwnPropertyDescriptor(AB.prototype,"priority"),AB.prototype),X(AB.prototype,"visibility",[kL,GL,HL],Object.getOwnPropertyDescriptor(AB.prototype,"visibility"),AB.prototype),X(AB.prototype,"clearFlags",[VL,jL,WL],Object.getOwnPropertyDescriptor(AB.prototype,"clearFlags"),AB.prototype),X(AB.prototype,"clearColor",[qL,XL],Object.getOwnPropertyDescriptor(AB.prototype,"clearColor"),AB.prototype),X(AB.prototype,"clearDepth",[YL,KL],Object.getOwnPropertyDescriptor(AB.prototype,"clearDepth"),AB.prototype),X(AB.prototype,"clearStencil",[QL,ZL],Object.getOwnPropertyDescriptor(AB.prototype,"clearStencil"),AB.prototype),X(AB.prototype,"projection",[JL,$L,tB],Object.getOwnPropertyDescriptor(AB.prototype,"projection"),AB.prototype),X(AB.prototype,"fovAxis",[eB,nB,iB],Object.getOwnPropertyDescriptor(AB.prototype,"fovAxis"),AB.prototype),X(AB.prototype,"fov",[rB,oB],Object.getOwnPropertyDescriptor(AB.prototype,"fov"),AB.prototype),X(AB.prototype,"orthoHeight",[aB,sB],Object.getOwnPropertyDescriptor(AB.prototype,"orthoHeight"),AB.prototype),X(AB.prototype,"near",[cB,lB],Object.getOwnPropertyDescriptor(AB.prototype,"near"),AB.prototype),X(AB.prototype,"far",[uB,hB],Object.getOwnPropertyDescriptor(AB.prototype,"far"),AB.prototype),X(AB.prototype,"aperture",[fB,pB,_B],Object.getOwnPropertyDescriptor(AB.prototype,"aperture"),AB.prototype),X(AB.prototype,"shutter",[dB,mB,vB],Object.getOwnPropertyDescriptor(AB.prototype,"shutter"),AB.prototype),X(AB.prototype,"iso",[gB,yB,xB],Object.getOwnPropertyDescriptor(AB.prototype,"iso"),AB.prototype),X(AB.prototype,"rect",[SB,bB],Object.getOwnPropertyDescriptor(AB.prototype,"rect"),AB.prototype),X(AB.prototype,"targetTexture",[TB,EB,CB],Object.getOwnPropertyDescriptor(AB.prototype,"targetTexture"),AB.prototype),wB=AB))||wB)||wB)||wB)||wB,t({Camera:KB,CameraComponent:KB}),KB);i.Camera=pF;var _F,dF,mF,vF,gF,yF,xF,SF,bF={parent:null,owner:null,subModelIdx:0},TF=t("RenderableComponent",(QB=ol("cc.RenderableComponent"),ZB=kl([Og]),JB=kl(Og),$B=Ol(),tF=Cl(),QB((oF=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_materials",iF,V(e)),q(e,"_visFlags",rF,V(e)),e._materialInstances=[],e._models=[],e}F(e,t);var n=e.prototype;return n.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},n.setMaterial=function(t,e){t&&t instanceof Yg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var n=this._materialInstances[e];n&&(n.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},n.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){bF.parent=this._materials[t],bF.owner=this,bF.subModelIdx=t;var e=new Yg(bF);bF.parent=null,bF.owner=null,bF.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},n.setMaterialInstance=function(t,e){if("number"==typeof t){E(12007);var n=t;t=e,e=n}var i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)},n.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},L(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var n=this._materials.length-e;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}}]),e}(ih),iF=X((nF=oF).prototype,"_materials",[ZB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rF=X(nF.prototype,"_visFlags",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U_.Enum.NONE}}),X(nF.prototype,"sharedMaterials",[JB,$B,tF],Object.getOwnPropertyDescriptor(nF.prototype,"sharedMaterials"),nF.prototype),eF=nF))||eF));function EF(t){return"string"==typeof t||"number"==typeof t}i.RenderableComponent=TF,Bn(pF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),Bn(pF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),i.CameraComponent=pF,Gt.setClassAlias(pF,"cc.CameraComponent");var CF,wF,AF,PF,IF,RF,DF,OF,MF,NF,LF,BF,FF,zF,UF,kF,GF,HF,VF,jF,WF,qF,XF=ol("cc.animation.HierarchyPath")((vF=function(){function t(t){q(this,"path",mF,this),this.path=t||""}return t.prototype.get=function(t){return t instanceof $C?t.getChildByPath(this.path)||(E(3926,t.name,this.path),null):(E(3925),null)},t}(),mF=X((dF=vF).prototype,"path",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_F=dF))||_F,YF=ol("cc.animation.ComponentPath")((SF=function(){function t(t){q(this,"component",xF,this),this.component=t||""}return t.prototype.get=function(t){return t instanceof $C?t.getComponent(this.component)||(E(3928,t.name,this.component),null):(E(3927),null)},t}(),xF=X((yF=SF).prototype,"component",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gF=yF))||gF,KF=ol("cc.animation.UniformProxyFactory")((RF=function(){function t(t,e){q(this,"passIndex",AF,this),q(this,"uniformName",PF,this),q(this,"channelIndex",IF,this),this.passIndex=e||0,this.uniformName=t||""}return t.prototype.forTarget=function(t){var e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error('Material "'+t.name+'" has no uniform "'+this.uniformName+'"');if(Yv.getTypeFromHandle(n)<Cr.SAMPLER1D){var r=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,Cr.FLOAT);if(!r)throw new Error('Uniform "'+this.uniformName+" (in material "+t.name+") has no channel "+this.channelIndex+'"');return function(t,e){for(var n,i=W(t.shaderInfo.blocks);!(n=i()).done;)for(var r,o=W(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===e)return a.count>1}return!1}(e,this.uniformName)?{set:function(t){e.setUniformArray(r,t)}}:{set:function(t){e.setUniform(r,t)}}}var o=Yv.getBindingFromHandle(n),a=e.properties[this.uniformName],s=a&&a.value?a.value+"-texture":wv(a.type),c=Gv.get(s);return c||(_("Illegal texture default value: "+s+"."),c=Gv.get("default-texture")),{set:function(t){t||(t=c);var n=t.getGFXTexture();n&&n.width&&n.height&&(e.bindTexture(o,n),t instanceof Um&&e.bindSampler(o,i.game._gfxDevice.getSampler(t.getSamplerInfo())))}}},t}(),AF=X((wF=RF).prototype,"passIndex",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PF=X(wF.prototype,"uniformName",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IF=X(wF.prototype,"channelIndex",[Fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),CF=wF))||CF,QF=ol("cc.animation.MorphWeightValueProxy")((LF=function(){function t(){q(this,"subMeshIndex",MF,this),q(this,"shapeIndex",NF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeight(n,e.subMeshIndex,e.shapeIndex)}}},t}(),MF=X((OF=LF).prototype,"subMeshIndex",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NF=X(OF.prototype,"shapeIndex",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DF=OF))||DF,ZF=ol("cc.animation.MorphWeightsValueProxy")((UF=function(){function t(){q(this,"subMeshIndex",zF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeights(n,e.subMeshIndex)}}},t}(),zF=X((FF=UF).prototype,"subMeshIndex",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BF=FF))||BF,JF=ol("cc.animation.MorphWeightsAllValueProxy")(kF=function(){function t(){}return t.prototype.forTarget=function(t){return{set:function(e){for(var n,i,r=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)t.setWeights(e,o)}}},t}())||kF;function $F(t,e,n,i){var r,o,a,s,c,l,u=new e,h=new e,f=new e,p=ol(t)((l=function(){function t(t,n,i){q(this,"dataPoint",a,this),q(this,"inTangent",s,this),q(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}var r=t.prototype;return r.lerp=function(t,e,r){var o=this.dataPoint,a=t.dataPoint;h=n(h,this.inTangent,r),f=n(f,t.outTangent,r);var s=e*e*e,c=e*e,l=s-2*c+e,p=-2*s+3*c,_=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,p),u=i(u,u,f,_)},r.getNoLerp=function(){return this.dataPoint},t}(),a=X((o=l).prototype,"dataPoint",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=X(o.prototype,"inTangent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=X(o.prototype,"outTangent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),r=o))||r;if(e===Ei){var _=p.prototype.lerp;p.prototype.lerp=function(t,e,n){var i=_.call(this,t,e,n);return Ei.normalize(i,i),i}}return p}var tz=t("CubicSplineVec2Value",$F("cc.CubicSplineVec2Value",Bi,Bi.multiplyScalar,Bi.scaleAndAdd));i.CubicSplineVec2Value=tz;var ez=t("CubicSplineVec3Value",$F("cc.CubicSplineVec3Value",vi,vi.multiplyScalar,vi.scaleAndAdd));i.CubicSplineVec3Value=ez;var nz=t("CubicSplineVec4Value",$F("cc.CubicSplineVec4Value",ki,ki.multiplyScalar,ki.scaleAndAdd));i.CubicSplineVec4Value=nz;var iz=t("CubicSplineQuatValue",$F("cc.CubicSplineQuatValue",Ei,Ei.multiplyScalar,Ei.scaleAndAdd));i.CubicSplineQuatValue=iz;var rz=t("CubicSplineNumberValue",ol("cc.CubicSplineNumberValue")((qF=function(){function t(t,e,n){q(this,"dataPoint",VF,this),q(this,"inTangent",jF,this),q(this,"outTangent",WF,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}var e=t.prototype;return e.lerp=function(t,e,n){var i=this.dataPoint,r=t.dataPoint,o=e*e*e,a=e*e;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+e)+r*(-2*o+3*a)+t.inTangent*n*(o-a)},e.getNoLerp=function(){return this.dataPoint},t}(),VF=X((HF=qF).prototype,"dataPoint",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jF=X(HF.prototype,"inTangent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WF=X(HF.prototype,"outTangent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GF=HF))||GF);i.CubicSplineNumberValue=rz;var oz,az,sz,cz,lz,uz,hz,fz,pz,_z,dz,mz,vz,gz,yz,xz,Sz,bz,Tz,Ez,Cz,wz,Az,Pz,Iz,Rz,Dz,Oz=Symbol("CreateEval"),Mz=Symbol("NormalizedFollow"),Nz=Symbol("ConvertAsTrsPath"),Lz=Symbol("TrackBinding"),Bz=ol("cc.animation.TrackPath")((cz=function(){function t(){q(this,"_paths",sz,this)}var e=t.prototype;return e.toProperty=function(t){return this._paths.push(t),this},e.toElement=function(t){return this._paths.push(t),this},e.toHierarchy=function(t){return this._paths.push(new XF(t)),this},e.toComponent=function(t){var e=new YF("string"==typeof t?t:Gt.getClassName(t));return this._paths.push(e),this},e.toCustomized=function(t){return this._paths.push(t),this},e.append=function(){for(var t,e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];var r=(t=this._paths).concat.apply(t,n.map((function(t){return t._paths})));return this._paths=r,this},e.isPropertyAt=function(t){return"string"==typeof this._paths[t]},e.parsePropertyAt=function(t){return this._paths[t]},e.isElementAt=function(t){return"number"==typeof this._paths[t]},e.parseElementAt=function(t){return this._paths[t]},e.isHierarchyAt=function(t){return this._paths[t]instanceof XF},e.parseHierarchyAt=function(t){return this.isHierarchyAt(t),this._paths[t].path},e.isComponentAt=function(t){return this._paths[t]instanceof YF},e.parseComponentAt=function(t){return this.isComponentAt(t),this._paths[t].component},e.slice=function(e,n){var i=new t;return i._paths=this._paths.slice(e,n),i},e.trace=function(t,e,n){var i,r;return null!==(i=e)&&void 0!==i||(e=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[Mz](t,e,n)},e[Nz]=function(){for(var t,e=this._paths,n=e.length,i=0,r="";i<n;++i){var o=e[i];if(!(o instanceof XF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(e[i]){case"position":case"scale":case"rotation":case"eulerAngles":t=e[i];break;default:return null}return{node:r,property:t}},e[Mz]=function(t,e,n){for(var i=this._paths,r=t,o=e;o<n;++o){var a=i[o];if(EF(a)){if(!(a in r))return E(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},L(t,[{key:"length",get:function(){return this._paths.length}}]),t}(),sz=X((az=cz).prototype,"_paths",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oz=az))||oz,Fz=ol("cc.animation.TrackBinding")(lz=dl((pz=function(){function t(){q(this,"path",hz,this),q(this,"proxy",fz,this)}var e=t.prototype;return e.parseTrsPath=function(){return this.proxy?null:this.path[Nz]()},e.createRuntimeBinding=function(t,e,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[Mz](t,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(t){c.set(t)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return w(3921),null}var h,f=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),p=i[Mz](t,0,o-1);return null===p?null:e&&p instanceof $C&&("position"===(h=f)||"rotation"===h||"scale"===h||"eulerAngles"===h)?e.createPoseWriter(p,f,n):{setValue:function(t){p[f]=t},getValue:function(){return p[f]}}},t}(),hz=X((uz=pz).prototype,"path",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bz}}),fz=X(uz.prototype,"proxy",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lz=uz))||lz)||lz,zz=ol("cc.animation.Track")((vz=function(){function t(){q(this,"_binding",mz,this)}var e=t.prototype;return e.channels=function(){return[]},e.range=function(){for(var t,e={min:1/0,max:-1/0},n=W(this.channels());!(t=n()).done;){var i=t.value;e.min=Math.min(e.min,i.curve.rangeMin),e.max=Math.max(e.max,i.curve.rangeMax)}return e},L(t,[{key:"path",get:function(){return this._binding.path},set:function(t){this._binding.path=t}},{key:"proxy",get:function(){return this._binding.proxy},set:function(t){this._binding.proxy=t}},{key:Lz,get:function(){return this._binding}}]),t}(),mz=X((dz=vz).prototype,"_binding",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fz}}),_z=dz))||_z,Uz=ol("cc.animation.Channel")((Sz=function(){function t(t){this.name="",q(this,"_curve",xz,this),this._curve=t}return L(t,[{key:"curve",get:function(){return this._curve}}]),t}(),xz=X((yz=Sz).prototype,"_curve",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gz=yz))||gz,kz=ol("cc.animation.SingleChannelTrack")((Cz=function(t){function e(){var e;return q(e=t.call(this)||this,"_channel",Ez,V(e)),e._channel=new Uz(e.createCurve()),e}F(e,t);var n=e.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[Oz]=function(){var t=this._channel.curve;return new Gz(t)},L(e,[{key:"channel",get:function(){return this._channel}}]),e}(zz),Ez=X((Tz=Cz).prototype,"_channel",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),bz=Tz))||bz,Gz=function(){function t(t){this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t)},t}(),Hz=ol("cc.animation.RealTrack")(wz=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.createCurve=function(){return new yp},e}(kz))||wz;function Vz(t){return 0===t.keyFramesCount?void 0:t}var jz,Wz,qz,Xz,Yz,Kz,Qz,Zz,Jz,$z,tU=["X","Y","Z","W"],eU=ol("cc.animation.VectorTrack")((Dz=function(t){function e(){var e;q(e=t.call(this)||this,"_channels",Iz,V(e)),q(e,"_nComponents",Rz,V(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new Uz(new yp);i.name=tU[n],e._channels[n]=i}return e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Oz]=function(){switch(this._nComponents){default:case 2:return new nU(Vz(this._channels[0].curve),Vz(this._channels[1].curve));case 3:return new iU(Vz(this._channels[0].curve),Vz(this._channels[1].curve),Vz(this._channels[2].curve));case 4:return new rU(Vz(this._channels[0].curve),Vz(this._channels[1].curve),Vz(this._channels[2].curve),Vz(this._channels[3].curve))}},L(e,[{key:"componentsCount",get:function(){return this._nComponents},set:function(t){this._nComponents=t}}]),e}(zz),Iz=X((Pz=Dz).prototype,"_channels",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Rz=X(Pz.prototype,"_nComponents",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),Az=Pz))||Az,nU=function(){function t(t,e){this._result=new Bi,this._x=t,this._y=e}return t.prototype.evaluate=function(t,e){return this._x&&this._y||!e.getValue||Bi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result},t}(),iU=function(){function t(t,e,n){this._result=new vi,this._x=t,this._y=e,this._z=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z||!e.getValue||vi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result},t}(),rU=function(){function t(t,e,n,i){this._result=new ki,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||ki.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result},t}(),oU=ol("cc.animation.QuatTrack")(jz=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.createCurve=function(){return new o_},n[Oz]=function(){return new aU(this.channels()[0].curve)},e}(kz))||jz,aU=function(){function t(t){this._result=new Ei,this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t,this._result),this._result},t}(),sU=["Red","Green","Blue","Alpha"],cU=ol("cc.animation.ColorTrack")((Yz=function(t){function e(){var e;q(e=t.call(this)||this,"_channels",Xz,V(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new Uz(new yp);i.name=sU[n],e._channels[n]=i}return e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Oz]=function(){return new lU(Vz(this._channels[0].curve),Vz(this._channels[1].curve),Vz(this._channels[2].curve),Vz(this._channels[3].curve))},e}(zz),Xz=X((qz=Yz).prototype,"_channels",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wz=qz))||Wz,lU=function(){function t(t,e,n,i){this._result=new di,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||di.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result},t}(),uU=["Width","Height"],hU=ol("cc.animation.SizeTrack")((Jz=function(t){function e(){var e;q(e=t.call(this)||this,"_channels",Zz,V(e)),e._channels=new Array(2);for(var n=0;n<e._channels.length;++n){var i=new Uz(new yp);i.name=uU[n],e._channels[n]=i}return e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Oz]=function(){return new fU(Vz(this._channels[0].curve),Vz(this._channels[1].curve))},e}(zz),Zz=X((Qz=Jz).prototype,"_channels",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kz=Qz))||Kz,fU=function(){function t(t,e){this._result=new Vi,this._width=t,this._height=e}return t.prototype.evaluate=function(t,e){if((!this._width||!this._height)&&e.getValue){var n=e.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result},t}(),pU=ol("cc.animation.ObjectTrack")($z=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.createCurve=function(){return new x_},e}(kz))||$z;t("animation",Object.freeze({__proto__:null,UniformProxyFactory:KF,MorphWeightValueProxy:QF,MorphWeightsValueProxy:ZF,MorphWeightsAllValueProxy:JF,Track:zz,TrackPath:Bz,RealTrack:Hz,VectorTrack:eU,QuatTrack:oU,ColorTrack:cU,SizeTrack:hU,ObjectTrack:pU,isPropertyPath:EF,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:XF,ComponentPath:YF,CubicSplineVec2Value:tz,CubicSplineVec3Value:ez,CubicSplineVec4Value:nz,CubicSplineQuatValue:iz,CubicSplineNumberValue:rz}));var _U=Symbol("BakeNodeCurves"),dU=function(){function t(){}return t.getOrExtract=function(e){var n=t.pool.get(e);if(!n||n.samples!==e.sample){n&&i.director.root.dataPoolManager.releaseAnimationClip(e);var r=Math.ceil(e.sample*e.duration)+1,o=e.sample;n=e[_U](0,o,r),t.pool.set(e,n)}return n},t.destroy=function(e){t.pool.delete(e)},t}();dU.pool=new Map;var mU=t("RatioSampler",function(){function t(t){var e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var i=!0,r=1,o=t.length;r<o;r++)if(e=t[r]-t[r-1],1===r)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?xU:Qc}return t.prototype.sample=function(t){return this._findRatio(this.ratios,t)},t}());i.RatioSampler=mU;var vU=t("AnimCurve",function(){function t(e,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=e.values;var i=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?t.Linear:t.Bezier(e):t.Linear};if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(e.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(e.easingMethods[a])}}else this.type=null;var s=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=IU(s)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}t.Bezier=function(t){return t};var e=t.prototype;return e.hasLerp=function(){return!!this._lerp},e.valueAt=function(t){if(void 0===this._array){var e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*t+n];return this._array},e.valueBetween=function(t,e,n,i,r){if(this._lerp){var o=this.types?this.types[e]:this.type,a=r-n,s=(t-n)/a;if(o&&(s=yU(s,o)),void 0===this._array){var c=this._values[e],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*e+u],f=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,f,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(var p=0;p<this._array.length;++p)this._array[p]=this._values[this._array.length*e+p];return this._array},e.empty=function(){return 0===this._values.length},e.constant=function(){return 1===this._values.length},t}());function gU(t,e,n){var i=e.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function yU(t,e){if("string"==typeof e){var n=op[e];n?t=n(t):w(3906,e)}else Array.isArray(e)&&(t=e_(e,t));return t}function xU(t,e){var n=t.length-1;if(0===n)return 0;var i=t[0];if(e<i)return 0;var r=t[n];if(e>r)return n;var o=(e=(e-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}vU.Linear=null,i.AnimCurve=vU,t("EventInfo",function(){function t(){this.events=[]}return t.prototype.add=function(t,e){this.events.push({func:t||"",params:e||[]})},t}()),i.sampleAnimationCurve=gU;var SU,bU,TU,EU,CU,wU,AU,PU,IU=function(){function t(t,e,n,i){return t.lerp(e,n,i)}return function(e){if(null!==e){if("number"==typeof e)return Jn;if("object"==typeof e&&e.constructor){if(e instanceof Ei)return n=new Ei,function(t,e,i){return Ei.slerp(n,t,e,i)};if(e instanceof Jt)return function(t){var e=new t;return function(n,i,r){return t.lerp(e,n,i,r),e}}(e.constructor);if(e.constructor===Number)return Jn;if("function"==typeof e.lerp)return t}var n}}}(),RU=ol("cc.animation.UntypedTrackChannel")((EU=function(t){function e(){var e;return q(e=t.call(this,new yp)||this,"property",TU,V(e)),e}return F(e,t),e}(Uz),TU=X((bU=EU).prototype,"property",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SU=bU))||SU,DU=ol("cc.animation.UntypedTrack")((PU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_channels",AU,V(e)),e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[Oz]=function(t){var e=this;if(!t.getValue)throw new Error(R(3930));var n=function(t){var n;return null===(n=e._channels.find((function(e){return e.property===t})))||void 0===n?void 0:n.curve},i=t.getValue();switch(!0){default:throw new Error(R(3931));case i instanceof Bi:return new nU(n("x"),n("y"));case i instanceof vi:return new iU(n("x"),n("y"),n("z"));case i instanceof ki:return new rU(n("x"),n("y"),n("z"),n("w"));case i instanceof di:return new lU(n("r"),n("g"),n("b"),n("a"));case i instanceof Vi:return new fU(n("width"),n("height"))}},n.addChannel=function(t){var e=new RU;return e.property=t,this._channels.push(e),e},n.upgrade=function(t){var e=this,n=function(t,n){var i=e.channels().find((function(e){return e.property===t}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new eU;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new cU,h=u.channels(),f=h[0],p=h[1],_=h[2],d=h[3];return n("r",f),n("g",p),n("b",_),n("a",d),n("x",f),n("y",p),n("z",_),n("w",d),u;case"size":}return null},e}(zz),AU=X((wU=PU).prototype,"_channels",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CU=wU))||CU,OU=function(){function t(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}var e=t.prototype;return e.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},e.toTracks=function(){for(var t,e=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(t,e,n){for(var i,r=new Bz,o=W(e);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof XF?r.toHierarchy(a.path):a instanceof YF?r.toComponent(a.component):r.toCustomized(a)}t.path=r,t.proxy=n},a=r.map((function(t){var n=new DU;return o(n,t.modifiers,t.valueAdapter),e.push(n),n})),s=function(){var i,r=t.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var f=new NU(s,l.length),p=function(t){o(t,r.modifiers,r.valueAdapter)},_=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(t){return"number"==typeof t})))return E(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return E(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;_=m}!function(){if("number"==typeof u){if(!c.every((function(t){return"number"==typeof t})))return void E(3934);var t;if(_)t=_;else{var n=new Hz;p(n),e.push(n),t=n.channel.curve}var i=h?Xl.LINEAR:Xl.CONSTANT;return t.assignSorted(l,c.map((function(t){return{value:t,interpolationMode:i}}))),void f.convert(t)}if("object"==typeof u)switch(!0){default:break;case MU(c,Bi):case MU(c,vi):case MU(c,ki):var r=u instanceof Bi?2:u instanceof vi?3:4,o=new eU;p(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?Xl.LINEAR:Xl.CONSTANT,y=function(t){return{value:t,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(t){return y(t.w)}))),f.convert(v);case 3:m.assignSorted(l,c.map((function(t){return y(t.z)}))),f.convert(m);default:s.assignSorted(l,c.map((function(t){return y(t.x)}))),f.convert(s),d.assignSorted(l,c.map((function(t){return y(t.y)}))),f.convert(d)}return void e.push(o);case MU(c,Ei):var x=new oU;p(x);var S=h?Yp.SLERP:Yp.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(t){return{value:Ei.clone(t),interpolationMode:S}}))),f.convertQuatCurve(x.channel.curve),void e.push(x);case MU(c,di):var b=new cU;p(b);var T=b.channels(),C=T[0].curve,w=T[1].curve,A=T[2].curve,P=T[3].curve,I=h?Xl.LINEAR:Xl.CONSTANT,R=function(t){return{value:t,interpolationMode:I}};return C.assignSorted(l,c.map((function(t){return R(t.r)}))),f.convert(C),w.assignSorted(l,c.map((function(t){return R(t.g)}))),f.convert(w),A.assignSorted(l,c.map((function(t){return R(t.b)}))),f.convert(A),P.assignSorted(l,c.map((function(t){return R(t.a)}))),f.convert(P),void e.push(b);case MU(c,Vi):var D=new hU;p(D);var O=D.channels(),M=O[0].curve,N=O[1].curve,L=h?Xl.LINEAR:Xl.CONSTANT,B=function(t){return{value:t,interpolationMode:L}};return M.assignSorted(l,c.map((function(t){return B(t.width)}))),f.convert(M),N.assignSorted(l,c.map((function(t){return B(t.height)}))),f.convert(N),void e.push(D);case MU(c,rz):var F=new Hz;p(F);var z=h?Xl.CUBIC:Xl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(t){return{value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:z}}))),void e.push(F);case MU(c,tz):case MU(c,ez):case MU(c,nz):var U=u instanceof tz?2:u instanceof ez?3:4,k=new eU;p(k),k.componentsCount=U;var G=k.channels(),H=G[0],V=G[1],j=G[2],W=G[3],q=h?Xl.LINEAR:Xl.CONSTANT,X=function(t,e,n){return{value:t,leftTangent:e,rightTangent:n,interpolationMode:q}};switch(U){case 4:W.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.w,t.inTangent.w,t.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.z,t.inTangent.z,t.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.y,t.inTangent.y,t.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.x,t.inTangent.x,t.outTangent.x)})))}return void e.push(k);case c.every((function(t){return t instanceof iz})):E(3935)}var Y=new pU;p(Y),Y.channel.curve.assignSorted(l,c),e.push(Y)}()},c=W(i);!(t=c()).done;)s();return e},e._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map((function(e){return new mU(e.map((function(e){return e/t._duration})))})),this._runtimeCurves=this._curves.map((function(e){return{curve:new vU(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}}))},L(t,[{key:"keys",get:function(){return this._keys},set:function(t){this._keys=t}},{key:"curves",get:function(){return this._curves},set:function(t){this._curves=t,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(t){this._commonTargets=t}},{key:"data",get:function(){return this._data}}]),t}();function MU(t,e){return t.every((function(t){return t instanceof e}))}var NU=function(){function t(t,e){this._easingMethods=void 0;var n=t.easingMethods;Array.isArray(n)?0===n.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(e).fill(t.easingMethod):Array.from({length:e},(function(t,e){var i;return null!==(i=n[e])&&void 0!==i?i:null}))}var e=t.prototype;return e.convert=function(t){var e,n,i,r,o,a,s,c,l,u,h,f,p,_,d,m,v,g,y,x,S,b,T=this._easingMethods;if(T){var E=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(T)&&T.length;for(var C=E-1,w=0;w<C;++w){var A=T[w];A&&(Array.isArray(A)?(e=A,n=t.getKeyframeTime(w),i=t.getKeyframeValue(w),r=t.getKeyframeTime(w+1),o=t.getKeyframeValue(w+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,f=void 0,p=void 0,_=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,b=void 0,s=e[0],c=e[1],l=e[2],u=e[3],h=i.value,f=3*(r-n),p=3*(o.value-h),m=(1-l)*f,v=(1-u)*p,g=1/3,y=(d=c*p)/(_=s*f),x=Math.sqrt(_*_+d*d)*g,S=v/m,b=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Xl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===Kl.NONE?Kl.RIGHT:a===Kl.LEFT?Kl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(t){return t===Kl.NONE?Kl.LEFT:t===Kl.RIGHT?Kl.BOTH:t}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=b):LU(A,t,w))}}}},e.convertQuatCurve=function(t){var e=this._easingMethods;if(e){var n=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(e)&&e.length;for(var i=n-1,r=0;r<i;++r){var o=e[r];o&&(Array.isArray(o)?t.getKeyframeValue(r).easingMethod=o.slice():BU(o,t,r))}}}},L(t,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(t){return null==t}))}}]),t}();function LU(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=fk[t];r===rp.CONSTANT?i.interpolationMode=Xl.CONSTANT:(i.interpolationMode=Xl.LINEAR,i.easingMethod=r)}function BU(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=fk[t];i.easingMethod=r}var FU,zU,UU,kU,GU,HU,VU,jU,WU,qU,XU,YU,KU,QU,ZU,JU,$U,tk,ek,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,fk={constant:rp.CONSTANT,linear:rp.LINEAR,quadIn:rp.QUAD_IN,quadOut:rp.QUAD_OUT,quadInOut:rp.QUAD_IN_OUT,quadOutIn:rp.QUAD_OUT_IN,cubicIn:rp.CUBIC_IN,cubicOut:rp.CUBIC_OUT,cubicInOut:rp.CUBIC_IN_OUT,cubicOutIn:rp.CUBIC_OUT_IN,quartIn:rp.QUART_IN,quartOut:rp.QUART_OUT,quartInOut:rp.QUART_IN_OUT,quartOutIn:rp.QUART_OUT_IN,quintIn:rp.QUINT_IN,quintOut:rp.QUINT_OUT,quintInOut:rp.QUINT_IN_OUT,quintOutIn:rp.QUINT_OUT_IN,sineIn:rp.SINE_IN,sineOut:rp.SINE_OUT,sineInOut:rp.SINE_IN_OUT,sineOutIn:rp.SINE_OUT_IN,expoIn:rp.EXPO_IN,expoOut:rp.EXPO_OUT,expoInOut:rp.EXPO_IN_OUT,expoOutIn:rp.EXPO_OUT_IN,circIn:rp.CIRC_IN,circOut:rp.CIRC_OUT,circInOut:rp.CIRC_IN_OUT,circOutIn:rp.CIRC_OUT_IN,elasticIn:rp.ELASTIC_IN,elasticOut:rp.ELASTIC_OUT,elasticInOut:rp.ELASTIC_IN_OUT,elasticOutIn:rp.ELASTIC_OUT_IN,backIn:rp.BACK_IN,backOut:rp.BACK_OUT,backInOut:rp.BACK_IN_OUT,backOutIn:rp.BACK_OUT_IN,bounceIn:rp.BOUNCE_IN,bounceOut:rp.BOUNCE_OUT,bounceInOut:rp.BOUNCE_IN_OUT,bounceOutIn:rp.BOUNCE_OUT_IN,smooth:rp.SMOOTH,fade:rp.FADE};function pk(){throw new Error("split() only valid in Editor.")}ol("cc.animation.ExoticAnimation")((UU=function(){function t(){q(this,"_nodeAnimations",zU,this)}var e=t.prototype;return e.createEvaluator=function(t){return new Tk(this._nodeAnimations,t)},e.addNodeAnimation=function(t){var e=new _k(t);return this._nodeAnimations.push(e),e},e.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(t){return t.path}))))},e.split=function(){return pk()},e.toHashString=function(){return this._nodeAnimations.map((function(t){return t.toHashString()})).join("\n")},t}(),zU=X((FU=UU).prototype,"_nodeAnimations",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FU));var _k=ol("cc.animation.ExoticNodeAnimation")((qU=function(){function t(t){q(this,"_path",HU,this),q(this,"_position",VU,this),q(this,"_rotation",jU,this),q(this,"_scale",WU,this),this._path=t}var e=t.prototype;return e.createPosition=function(t,e){this._position=new xk(t,new gk(e))},e.createRotation=function(t,e){this._rotation=new xk(t,new yk(e))},e.createScale=function(t,e){this._scale=new xk(t,new gk(e))},e.createEvaluator=function(t){return new Ek(this._path,this._position,this._rotation,this._scale,t)},e.split=function(){return pk()},e.toHashString=function(){var t,e,n,i,r,o;return this._path+"\n"+(null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},L(t,[{key:"path",get:function(){return this._path}}]),t}(),HU=X((GU=qU).prototype,"_path",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VU=X(GU.prototype,"_position",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jU=X(GU.prototype,"_rotation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WU=X(GU.prototype,"_scale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kU=GU))||kU;function dk(t){return t.toPrecision(2)}function mk(t){return t.map(dk).join(" ")}var vk=ol("cc.animation.ExoticVectorLikeTrackValues")((ZU=function(){function t(t){q(this,"_values",KU,this),q(this,"_isQuantized",QU,this),this._values=t,this._isQuantized=!1}var e=t.prototype;return e.quantize=function(t){this._isQuantized,this._values=function(t,e){var n=wk[e],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;t.forEach((function(t){r=Math.min(t,r),o=Math.max(t,o)}));var a=o-r,s=n.from(t,(function(t){return(t-r)/a*i}));return new Gk(Ak(t),s,a,r)}(this._values,t),this._isQuantized=!0},e.toHashString=function(){var t=this._isQuantized,e=this._values;return t+" "+(t?e.toHashString():mk(e))},L(t,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:Ak(this._values)}}]),t}(),KU=X((YU=ZU).prototype,"_values",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QU=X(YU.prototype,"_isQuantized",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XU=YU))||XU,gk=ol("cc.animation.ExoticVec3TrackValues")(JU=function(t){function e(){return t.apply(this,arguments)||this}F(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?jk(n,t,e):vi.fromArray(e,n,3*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(jk(a,t,i),jk(a,e,r)):(vi.fromArray(i,a,3*t),vi.fromArray(r,a,3*e)),vi.lerp(o,i,r,n)},e}(vk))||JU,yk=ol("cc.animation.ExoticQuatTrackValues")($U=function(t){function e(){return t.apply(this,arguments)||this}F(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?Wk(n,t,e):Ei.fromArray(e,n,4*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(Wk(a,t,i),Wk(a,e,r)):(Ei.fromArray(i,a,4*t),Ei.fromArray(r,a,4*e)),Ei.slerp(o,i,r,n)},e}(vk))||$U,xk=ol("cc.animation.ExoticTrack")((rk=function(){function t(t,e){q(this,"times",nk,this),q(this,"values",ik,this),this.times=t,this.values=e}return t.prototype.toHashString=function(){var t=this.times,e=this.values;return"times: "+mk(t)+"; values: "+e.toHashString()},t}(),nk=X((ek=rk).prototype,"times",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ik=X(ek.prototype,"values",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tk=ek))||tk;function Sk(t,e){t.length,t.length;var n=0,i=0,r=Qc(t,e);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=t[o],c=t[a];i=(e-c)/(s-c)}return{index:n,ratio:i}}!function(){function t(){this._reset()}var e=t.prototype;e.transformTime=function(t){return t-this._timeOffset},e.calculate=function(t,e,n){this._reset();var i=t.length;if(i){var r=t[0],o=t[i-1],a=Qn(e,r,o),s=Qn(n,r,o);this._timeOffset=a;var c=function(t,e,n){var i=t.length;n>=e&&e>=t[0]&&t[i-1];var r=Sk(t,e),o=r.index,a=r.ratio,s=Sk(t,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(t,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,f=c.toRatio,p=!u,_=!f;l!==h||u!==f?(p||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=p?l:l+1,this.directKeyframesEnd=h+1,_||(this.postLerpIndex=h,this.postLerpRatio=f)):p?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},e._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},L(t,[{key:"keyframesCount",get:function(){var t=this.preLerpIndex,e=this.directKeyframesBegin;return 0+(t<0?0:1)+(this.directKeyframesEnd-e)+(this.postLerpIndex<0?0:1)}}])}();var bk,Tk=function(){function t(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(t){return t.createEvaluator(e)}))}return t.prototype.evaluate=function(t){this._nodeEvaluations.forEach((function(e){e.evaluate(t)}))},t}(),Ek=function(){function t(t,e,n,i,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=Vk(e.times,e.values,vi,t,"position",r)),n&&(this._rotation=Vk(n.times,n.values,Ei,t,"rotation",r)),i&&(this._scale=Vk(i.times,i.values,vi,t,"scale",r))}return t.prototype.evaluate=function(t){if(this._position){var e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){var n=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(i)}},t}(),Ck=function(){function t(t,e,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return t.prototype.evaluate=function(t){var e=this._times,n=this._values,i=this._resultValue;if(0===e.length)return i;var r=function(t,e,n){var i=t.length,r=t[0],o=t[i-1];if(e<r)n.just=!0,n.index=0;else if(e>o)n.just=!0,n.index=i-1;else{var a=Qc(t,e);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=t[c],u=t[s],h=(e-t[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(e,t,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},t}(),wk={uint8:Uint8Array,uint16:Uint16Array};function Ak(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return bk.FLOAT_32;case 8:return bk.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(bk||(bk={}));var Pk,Ik,Rk,Dk,Ok,Mk,Nk,Lk,Bk,Fk,zk,Uk,kk,Gk=ol("cc.animation.QuantizedFloatArray")((hk=function(){function t(t,e,n,i){void 0===i&&(i=0),q(this,"originalPrecision",sk,this),q(this,"min",ck,this),q(this,"extent",lk,this),q(this,"values",uk,this),this.originalPrecision=t,this.values=e,this.extent=n,this.min=i}return t.prototype.toHashString=function(){var t=this.originalPrecision,e=this.min,n=this.extent,i=this.values;return t+" "+dk(e)+" "+dk(n)+" "+i.join(" ")},L(t,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),t}(),sk=X((ak=hk).prototype,"originalPrecision",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ck=X(ak.prototype,"min",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lk=X(ak.prototype,"extent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uk=X(ak.prototype,"values",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ok=ak))||ok;function Hk(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function Vk(t,e,n,i,r,o){var a=new Fz;a.path=(new Bz).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new Ck(t,e,n)}:null}function jk(t,e,n){vi.set(n,Hk(t,3*e+0),Hk(t,3*e+1),Hk(t,3*e+2))}function Wk(t,e,n){Ei.set(n,Hk(t,4*e+0),Hk(t,4*e+1),Hk(t,4*e+2),Hk(t,4*e+3))}var qk=Symbol("SearchForRootBonePath"),Xk=Symbol("ExoticAnimation"),Yk=t("AnimationClip",ol("cc.AnimationClip")((kk=Uk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"sample",Rk,V(e)),q(e,"speed",Dk,V(e)),q(e,"wrapMode",Ok,V(e)),q(e,"enableTrsBlending",Mk,V(e)),q(e,"_duration",Nk,V(e)),q(e,"_hash",Lk,V(e)),e.frameRate=0,q(e,"_tracks",Bk,V(e)),q(e,"_exoticAnimation",Fk,V(e)),e._legacyData=void 0,e._legacyDataDirty=!1,q(e,"_events",zk,V(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}F(e,t),e.createWithSpriteFrames=function(t,n){var i=new e;i.sample=n||i.sample,i.duration=t.length/i.sample;var r=1/i.sample,o=new pU;return o.path=(new Bz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map((function(t,e){return[r*e,t]}))),i.addTrack(o),i};var n=e.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var t={min:1/0,max:-1/0},e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i].range();t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max)}return t},n.getTrack=function(t){return this._tracks[t]},n.addTrack=function(t){var e=this._tracks.length;return this._tracks.push(t),e},n.removeTrack=function(t){this._tracks.splice(t,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(t){return new nG(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(t){var e=this,n=t.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,e.enableTrsBlending?t.pose:void 0,!1);return null!=r?r:void 0}),t.rootMotion)},n.destroy=function(){var e;return(null===(e=i.director.root)||void 0===e?void 0:e.dataPoolManager)&&i.director.root.dataPoolManager.releaseAnimationClip(this),dU.destroy(this),t.prototype.destroy.call(this)},n[_U]=function(t,e,n){for(var i=1/e,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Oi}))};var c=r.reduce((function(t,e){return t[e]=new Zk,t}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var f=l.substring(0,h),p=c[f];p&&(u.parent=p)}}for(var _=this._createEvalWithBinder(void 0,(function(t){var e=t.parseTrsPath();if(e){var n=c[e.node];if(n)return eG(n,e.property)}}),void 0),d=0;d<n;++d){var m=t+i*d;_.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Oi.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:e,frames:n,joints:a}},n.upgradeUntypedTracks=function(t){for(var e=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof DU){var s=a.upgrade(t);s&&(e.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)kt.remove(i,n[l]);i.push.apply(i,e)},n[qk]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(t,e,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(t,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(t){return 0===t.curve.keyFramesCount}))){var h=e(u[Lz]);if(h){var f=u[Oz](h);a.push({binding:h,trackEval:f})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new Kk(a,o,i)},n._createRootMotionEvaluation=function(t,e,n){if(t instanceof $C){var i=this._searchForRootBonePath();if(i){var r=t.getChildByPath(i);if(r){for(var o=new Qk,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Lz].parseTrsPath();if(h&&h.node===i){n.push(u);var f=eG(o,h.property);if(f){var p=u[Oz](f);a.push({binding:f,trackEval:p})}}}return new $k(r,this._duration,o,a)}E(3924)}else E(3923)}else w(3920)},n._searchForRootBonePath=function(){var t=this._tracks.map((function(t){var e=t[Lz].parseTrsPath();if(e){var n=e.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));t.sort((function(t,e){return t.rank-e.rank}));var e=t.findIndex((function(t){return 0!==t.rank}));if(e<0)return"";for(var n=t.length,i=t[e],r=!0,o=e+1;o<n;++o){var a=t[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var t=new OU(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t},n._fromLegacy=function(t){for(var e=t.toTracks(),n=e.length,i=0;i<n;++i)this.addTrack(e[i])},n._collectAnimatedJoints=function(){for(var t=new Set,e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i][Lz].parseTrsPath();r&&t.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)t.add(o[s]);return Array.from(t)},L(e,[{key:"duration",get:function(){return this._duration},set:function(t){this._duration=t}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var t,e;if(this._hash)return this._hash;var n="Exotic:"+(null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"");return this._hash=Da(n,666)}},{key:"events",get:function(){return this._events},set:function(t){var e=this;this._events=t;for(var n=[],i=[],r=this.events.sort((function(t,e){return t.frame-e.frame})),o=r.length,a=function(t){var o=r[t],a=o.frame/e._duration,s=n.findIndex((function(t){return t===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:Xk,get:function(){return this._exoticAnimation}},{key:Xk,set:function(t){this._exoticAnimation=t}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(t){this._getLegacyData().curves=t}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),e}(Bu),Uk.WrapMode=jc,Rk=X((Ik=kk).prototype,"sample",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Dk=X(Ik.prototype,"speed",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ok=X(Ik.prototype,"wrapMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jc.Normal}}),Mk=X(Ik.prototype,"enableTrsBlending",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Nk=X(Ik.prototype,"_duration",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lk=X(Ik.prototype,"_hash",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bk=X(Ik.prototype,"_tracks",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fk=X(Ik.prototype,"_exoticAnimation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zk=X(Ik.prototype,"_events",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pk=Ik))||Pk);i.AnimationClip=Yk;var Kk=function(){function t(t,e,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=n}var e=t.prototype;return e.evaluate=function(t){for(var e=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=e.length,r=0;r<i;++r){var o=e[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}n&&n.evaluate(t)},e.evaluateRootMotion=function(t,e){var n=this._rootMotionEvaluation;n&&n.evaluate(t,e)},t}(),Qk=function(){function t(){this.position=new vi,this.scale=new vi(1,1,1),this.rotation=new Ei,this.eulerAngles=new vi}return t.prototype.getTransform=function(t){Oi.fromRTS(t,this.rotation,this.position,this.scale)},t}(),Zk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).parent=null,e._dirty=!0,e._transform=new Oi,e}return F(e,t),e.prototype.invalidate=function(){this._dirty=!0},L(e,[{key:"globalTransform",get:function(){var t=this._transform;return this._dirty&&(this._dirty=!1,Oi.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Oi.multiply(t,this.parent.globalTransform,t)),this._transform}}]),e}(Qk),Jk=new Oi,$k=function(){function t(t,e,n,i){this._initialTransformCache=new Oi,this._clipEndTransformCache=new Oi,this._startTransformCache=new Oi,this._endTransformCache=new Oi,this._motionTransformCache=new Oi,this._translationMotionCache=new vi,this._rotationMotionCache=new Ei,this._scaleMotionCache=new vi,this._rootBone=t,this._duration=e,this._boneTransform=n,this._trackEvalStatuses=i}var e=t.prototype;return e.evaluate=function(t,e){var n=this._calcMotionTransform(t,e,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Oi.toRTS(n,r,i,o),vi.add(i,i,a.position),a.setPosition(i),Ei.multiply(r,r,a.rotation),a.setRotation(r),vi.multiply(o,o,a.scale),a.setScale(o)},e._calcMotionTransform=function(t,e,n){var i=this._duration,r=i-t,o=this._evaluateAt(t,this._startTransformCache);if(e<r){var a=this._evaluateAt(t+e,this._endTransformCache);tG(n,o,a)}else{Oi.identity(n);var s=function(t,e){tG(Jk,t,e),Oi.multiply(n,n,Jk)},c=e-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),f=this._evaluateAt(i,this._clipEndTransformCache),p=this._evaluateAt(u,this._endTransformCache);s(o,f),tG(Jk,h,f);for(var _=0;_<l;++_)Oi.multiply(n,n,Jk);s(h,p)}return n},e._evaluateAt=function(t,e){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}return this._boneTransform.getTransform(e),e},t}();function tG(t,e,n){Oi.invert(t,e),Oi.multiply(t,n,t)}function eG(t,e){switch(e){default:return;case"position":return{setValue:function(e){vi.copy(t.position,e)}};case"rotation":return{setValue:function(e){Ei.copy(t.rotation,e)}};case"scale":return{setValue:function(e){vi.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){vi.copy(t.eulerAngles,e)}}}}var nG=function(){function t(t,e,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=n,this._wrapMode=i}var e=t.prototype;return e.setWrapMode=function(t){this._wrapMode=t},e.ignore=function(t,e){this._ignoreIndex=-1,this._sampled=!1;var n=rG(t,this._ratios);n<0&&(n=~n-1,e<0&&(n+=1),this._ignoreIndex=n)},e.sample=function(t,e,n){var i=this._eventGroups.length,r=rG(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=e);var o=this._wrapMode,a=iG(n),s=iG(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){e=l;do{if(c!==r){if(-1===e&&0===c&&r>0?((o&Vc.PingPong)===Vc.PingPong?e*=-1:c=i,s++):1===e&&c===i-1&&r<i-1&&((o&Vc.PingPong)===Vc.PingPong?e*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=e,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=e},e._doFire=function(t,e){e?i.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)},e._checkAndFire=function(t){if(this._targetNode&&this._targetNode.isValid){var e=this._eventGroups;if(!(t<0||t>=e.length||this._ignoreIndex===t))for(var n=e[t],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},t}();function iG(t){return t-(0|t)==0&&(t-=1),0|t}function rG(t,e){return Qc(e,t)}var oG,aG=function(){function t(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var e=t.prototype;return e.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(R(3912)):(this._isPlaying=!0,this.onPlay())},e.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},e.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},e.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},e.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},e.update=function(){},e.onPlay=function(){},e.onPause=function(){},e.onResume=function(){},e.onStop=function(){},e.onError=function(){},L(t,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),t}(),sG=function(){function t(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0},e.createPoseWriter=function(t,e,n){var i=this._pose.createWriter(t,e,this,n);return this._blendStateWriters.push(i),i},t}();!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(oG||(oG={})),Zt(oG);var cG=t("AnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=jc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new Kc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=0,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=n||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||v("Clip "+e.name+" has zero duration."),i}F(e,t);var n=e.prototype;return n.initialize=function(t,e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Vc.Loop)===Vc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,o,a,s=null!==(r=null!=e?e:null===(o=i.director.getAnimationManager())||void 0===o?void 0:o.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new sG(s)),this._clipEval=n.createEvaluator({target:t,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||i.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];i.director.getAnimationManager().pushDelayEvent(this._emit,this,e)},n.on=function(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null},n.once=function(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null},n.off=function(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)},n.allowLastFrameEvent=function(t){this._allowLastFrame=t},n._setEventTarget=function(t){this._target=t},n.setTime=function(t){this._currentFramePlayed=!1,this.time=t||0;var e,n=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(n.ratio,n.direction)},n.update=function(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(oG.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(oG.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(oG.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(oG.PAUSE,this)},n._sampleCurves=function(t){var e=this._poseOutput,n=this._clipEval;e&&(e.weight=this.weight),n&&n.evaluate(t)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var t,e=this.sample();this._allowLastFrame&&(t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Kc(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(oG.LASTFRAME,this),t.set(e)),e.stopped&&(this.stop(),this.emit(oG.FINISHED,this))},n.simpleProcess=function(){var t=this._playbackRange.min,e=this._playbackDuration,n=this.time%e;n<0&&(n+=e);var i=(t+n)*this._invDuration;this._sampleCurves(t+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(oG.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(t){var e=this.wrapMode,n=!1;return(e&Vc.PingPong)===Vc.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&Vc.Reverse)===Vc.Reverse&&(n=!n),n},n.getWrappedInfo=function(t,e){e=e||new Kc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(t-=n)>0?t/i:-t/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),t=s*i*(t>0?1:-1)}if(t>i){var c=t%i;t=0===c?i:c}else t<0&&0!=(t%=i)&&(t+=i);var l=!1,u=this._wrapMode&Vc.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(t=i-t),e.time=n+t,e.ratio=e.time/this.duration,e.direction=h,e.stopped=r,e.iterations=a,e},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)},n._emit=function(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)},n._onReplayOrResume=function(){i.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){i.director.getAnimationManager().removeAnimation(this)},L(e,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(t){var e;this._wrapMode=t,this.time=0,t&Vc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t;var e=this._wrapMode&Vc.ShouldWrap,n=(this.wrapMode&Vc.Reverse)===Vc.Reverse;this._useSimpleProcess=t===1/0&&!e&&!n}},{key:"delay",get:function(){return this._delay},set:function(t){this._delayTime=this._delay=t}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),e}(aG));i.AnimationState=cG;var lG,uG,hG,fG,pG,_G,dG,mG,vG,gG,yG,xG,SG,bG,TG,EG,CG,wG=function(t){function e(e){var n;return(n=t.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=e?e:i.director.getAnimationManager(),n}F(e,t);var n=e.prototype;return n.update=function(t){if(!this.isMotionless){var e=this._managedStates,n=this._fadings;if(1===e.length&&1===n.length){var i=e[0].state;i&&(i.weight=1)}else this._calculateWeights(t);1===e.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();var i=this._managedStates.find((function(e){return e.state===t}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var t=0;t<this._managedStates.length;++t){var e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){t.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){t.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){t.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){t.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(t){for(var e=this._managedStates,n=this._fadings,i=0;i<e.length;++i){var r=e[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=t;var l=0===c.easeDuration?1:Zn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var f=n[h];--f.target.reference,f.target.reference<=0&&(f.target.state&&f.target.state.stop(),Z(this._managedStates,f.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},e}(aG),AG=function(e){return t({AnimationComponent:e,Animation:e}),e}((lG=ol("cc.Animation"),uG=Sl(),hG=sl(99),fG=vl(),pG=kl([Yk]),_G=wl(),dG=kl(Yk),mG=wl(),vG=wl(),gG=kl([Yk]),lG(yG=uG(yG=hG(yG=ml(yG=fG((CG=EG=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"playOnLoad",SG,V(e)),e._crossFade=new wG,e._nameToState=ft(!0),q(e,"_clips",bG,V(e)),q(e,"_defaultClip",TG,V(e)),e._hasBeenPlayed=!1,e}F(e,t);var n=e.prototype;return n.onLoad=function(){for(var t in this.clips=this._clips,this._nameToState)this._nameToState[t].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var t in this._crossFade.stop(),this._nameToState)this._nameToState[t].destroy();this._nameToState=ft(!0)},n.play=function(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)},n.crossFade=function(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;var n=this._nameToState[t];n&&this.doPlayOrCrossFade(n,e)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(t){return this.getState(t)},n.getState=function(t){var e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},n.createState=function(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)},n.removeState=function(t){var e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])},n.addClip=function(t,e){return J(this._clips,t)||this._clips.push(t),this.createState(t,e)},n.removeClip=function(t,e){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===t){n=r;break}}if(t===this._defaultClip){if(!e)return void E(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void E(3903);n.stop()}this._clips=this._clips.filter((function(e){return e!==t})),n&&delete this._nameToState[n.name]},n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return e===oG.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return e===oG.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),e===oG.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(t,e){return new cG(t,e)},n._doCreateState=function(t,e){var n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(oG.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)},n._removeStateOfAutomaticClip=function(t){for(var e in this._nameToState){var n=this._nameToState[e];PG(t,n.clip)&&(n.stop(),delete this._nameToState[e])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(oG.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(oG.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)},L(e,[{key:"clips",get:function(){return this._clips},set:function(t){var e=this;this._crossFade&&this._crossFade.clear();for(var n,i=W(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=W(t);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=t.find((function(t){return PG(t,e._defaultClip)}));this._defaultClip=c||null,this._clips=t}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){this._defaultClip=t,t&&(this._clips.findIndex((function(e){return PG(e,t)}))>=0||(this._clips.push(t),this.createState(t)))}}]),e}(on(ih)),EG.EventType=oG,X((xG=CG).prototype,"clips",[pG,_G],Object.getOwnPropertyDescriptor(xG.prototype,"clips"),xG.prototype),X(xG.prototype,"defaultClip",[dG,mG],Object.getOwnPropertyDescriptor(xG.prototype,"defaultClip"),xG.prototype),SG=X(xG.prototype,"playOnLoad",[hl,vG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bG=X(xG.prototype,"_clips",[gG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TG=X(xG.prototype,"_defaultClip",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yG=xG))||yG)||yG)||yG)||yG)||yG));function PG(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}Bn(AG.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var t=arguments.length<=0?void 0:arguments[0];return AG.prototype.removeState.call(this,t.name)}}]),i.AnimationComponent=AG,Gt.setClassAlias(AG,"cc.AnimationComponent");var IG,RG,DG,OG=function(){function t(){this._nodeBlendStates=new Map}var e=t.prototype;return e.createWriter=function(t,e,n,i){var r=this.ref(t,e);return new MG(t,e,r,n,i)},e.destroyWriter=function(t){var e=t;this.deRef(e.node,e.property)},e.ref=function(t,e){var n=this._nodeBlendStates.get(t);return n||(n=new FG,this._nodeBlendStates.set(t,n)),n.refProperty(e)},e.deRef=function(t,e){var n=this._nodeBlendStates.get(t);n&&(n.deRefProperty(e),n.empty&&this._nodeBlendStates.delete(t))},e.apply=function(){this._nodeBlendStates.forEach((function(t,e){t.apply(e)}))},t}(),MG=function(){function t(t,e,n,i,r){this._node=t,this._property=e,this._propertyBlendState=n,this._host=i,this._constants=r}var e=t.prototype;return e.getValue=function(){return this._node[this._property]},e.setValue=function(t){var e=this._propertyBlendState,n=this._host.weight;e.blend(t,n)},L(t,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),t}(),NG=function(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},LG=function(t){function e(){return t.call(this,new vi)||this}F(e,t);var n=e.prototype;return n.blend=function(t,e){var n=this.blendedValue;1===e?vi.copy(n,t):vi.scaleAndAdd(n,n,t,e),this.blendedWeight+=e},n.reset=function(){this.blendedWeight=0,vi.zero(this.blendedValue)},e}(NG),BG=function(t){function e(){return t.call(this,new Ei)||this}F(e,t);var n=e.prototype;return n.blend=function(t,e){if(0!==e){var n=this.blendedValue,i=this.blendedWeight;if(1===e)Ei.copy(n,t);else{var r=e/(i+e);Ei.slerp(n,n,t,r)}this.blendedWeight+=e}},n.reset=function(){this.blendedWeight=0,Ei.identity(this.blendedValue)},e}(NG),FG=function(){function t(){this._properties={}}var e=t.prototype;return e.refProperty=function(t){var e,n,i,r=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":i=null!==(e=r[t])&&void 0!==e?e:r[t]=new LG;break;case"rotation":i=null!==(n=r[t])&&void 0!==n?n:r[t]=new BG}return++i.refCount,i},e.deRefProperty=function(t){var e=this._properties,n=e[t];n&&(--n.refCount,n.refCount>0||delete e[t])},e.apply=function(t){var e,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,f=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(t.position,1-o.blendedWeight),e=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(t.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(f=!0,c.blendedWeight<1&&c.blend(t.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(t.rotation,1-s.blendedWeight),i=s.blendedValue),(i||e||n)&&t.setRTS(i,e,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),f&&c.reset()},L(t,[{key:"empty",get:function(){var t=this._properties;return!(t.position||t.rotation||t.eulerAngles||t.scale)}}]),t}(),zG=[],UG=new Map;function kG(t,e){for(var n=0,i=Oi.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,zG[n++]=t,t=t.parent}for(;n>0;){t=zG[--n],zG[n]=null;var r=t.node;Oi.fromRTS(t.local,r.rotation,r.position,r.scale),i=Oi.multiply(t.world,i,t.local)}return i}function GG(t,e){for(var n,i=null,r=0;t!==e;){var o=t.uuid;if(UG.has(o)){i=UG.get(o);break}i={node:t,local:new Oi,world:new Oi,stamp:-1,parent:null},UG.set(o,i),zG[r++]=i,t=t.parent,i=null}for(;r>0;)n=zG[--r],zG[r]=null,n.parent=i,i=n;return i}function HG(t){for(var e=UG.get(t.uuid)||null;e;)UG.delete(e.node.uuid),e=e.parent}var VG=t("AnimationManager",ol((DG=RG=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._anims=new Y([]),e._crossFades=new Y([]),e._delayEvents=[],e._blendStateBuffer=new OG,e._sockets=[],e}F(e,t);var n=e.prototype;return n.addCrossFade=function(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)},n.removeCrossFade=function(t){var e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):w(3907)},n.update=function(t){var e=this._delayEvents,n=this._crossFades,r=this._sockets,o=n.array;for(n.i=0;n.i<o.length;++n.i)o[n.i].update(t);var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var c=s[a.i];c.isMotionless||c.update(t)}this._blendStateBuffer.apply();for(var l=i.director.getTotalFrames(),u=0,h=r.length;u<h;u++){var f=r[u],p=f.target,_=f.transform;p.matrix=kG(_,l)}for(var d=0,m=e.length;d<m;d++){var v=e[d];v.fn.apply(v.thisArg,v.args)}e.length=0},n.destruct=function(){},n.addAnimation=function(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)},n.removeAnimation=function(t){var e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):w(3907)},n.pushDelayEvent=function(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})},n.addSockets=function(t,e){for(var n=this,i=function(i){var r=e[i];if(n._sockets.find((function(t){return t.target===r.target})))return"continue";var o=t.getChildByPath(r.path),a=r.target&&o&&GG(o,t);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<e.length;++r)i(r)},n.removeSockets=function(t,e){for(var n=0;n<e.length;++n)for(var i=e[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){HG(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},L(e,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),e}(UM),RG.ID="animation",IG=DG))||IG);$M.on(JM.EVENT_INIT,(function(){var t=new VG;$M.registerSystem(VG.ID,t,UM.Priority.HIGH)})),i.AnimationManager=VG;var jG,WG,qG,XG,YG=new Oi;function KG(t,e,n){for(Oi.identity(n);t!==e;)Oi.fromRTS(YG,t.rotation,t.position,t.scale),Oi.multiply(n,YG,n),t=t.parent;return n}i.easing=op;var QG=t("HierachyModifier",ol("cc.HierachyModifier")(jG=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(XF))||jG);i.HierachyModifier=QG;var ZG=t("ComponentModifier",ol("cc.ComponentModifier")(WG=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(YF))||WG);i.ComponentModifier=ZG;var JG=t("CurveValueAdapter",ol("cc.CurveValueAdapter")(qG=function(){function t(){}return t.prototype.forTarget=function(){return{set:function(){}}},t}())||qG);i.CurveValueAdapter=JG;var $G=t("UniformCurveValueAdapter",ol("cc.UniformCurveValueAdapter")(XG=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(KF))||XG);function tH(t){return"string"==typeof t}function eH(t){return"number"==typeof t}function nH(t,e){return t instanceof e}i.UniformCurveValueAdapter=$G,i.isPropertyModifier=tH,i.isElementModifier=eH,i.isCustomTargetModifier=nH,i.math=Ki,i.geometry=F_;var iH=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},t}());i.NodePool=iH,i.renderer=py;var rH,oH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&pa){var n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&_a&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},L(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(Ma);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(rH||(rH={}));var aH=function(){function t(){}return t.setInstance=function(e){t._instance=e},L(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function sH(t,e){switch(t){case Tr.R8:return e.UNSIGNED_BYTE;case Tr.R8SN:return e.BYTE;case Tr.R8UI:return e.UNSIGNED_BYTE;case Tr.R8I:return e.BYTE;case Tr.R16F:return rH.HALF_FLOAT_OES;case Tr.R16UI:return e.UNSIGNED_SHORT;case Tr.R16I:return e.SHORT;case Tr.R32F:return e.FLOAT;case Tr.R32UI:return e.UNSIGNED_INT;case Tr.R32I:return e.INT;case Tr.RG8:return e.UNSIGNED_BYTE;case Tr.RG8SN:return e.BYTE;case Tr.RG8UI:return e.UNSIGNED_BYTE;case Tr.RG8I:return e.BYTE;case Tr.RG16F:return rH.HALF_FLOAT_OES;case Tr.RG16UI:return e.UNSIGNED_SHORT;case Tr.RG16I:return e.SHORT;case Tr.RG32F:return e.FLOAT;case Tr.RG32UI:return e.UNSIGNED_INT;case Tr.RG32I:return e.INT;case Tr.RGB8:case Tr.SRGB8:return e.UNSIGNED_BYTE;case Tr.RGB8SN:return e.BYTE;case Tr.RGB8UI:return e.UNSIGNED_BYTE;case Tr.RGB8I:return e.BYTE;case Tr.RGB16F:return rH.HALF_FLOAT_OES;case Tr.RGB16UI:return e.UNSIGNED_SHORT;case Tr.RGB16I:return e.SHORT;case Tr.RGB32F:return e.FLOAT;case Tr.RGB32UI:return e.UNSIGNED_INT;case Tr.RGB32I:return e.INT;case Tr.BGRA8:case Tr.RGBA8:case Tr.SRGB8_A8:return e.UNSIGNED_BYTE;case Tr.RGBA8SN:return e.BYTE;case Tr.RGBA8UI:return e.UNSIGNED_BYTE;case Tr.RGBA8I:return e.BYTE;case Tr.RGBA16F:return rH.HALF_FLOAT_OES;case Tr.RGBA16UI:return e.UNSIGNED_SHORT;case Tr.RGBA16I:return e.SHORT;case Tr.RGBA32F:return e.FLOAT;case Tr.RGBA32UI:return e.UNSIGNED_INT;case Tr.RGBA32I:return e.INT;case Tr.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case Tr.R11G11B10F:return e.FLOAT;case Tr.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case Tr.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case Tr.RGB10A2:return e.UNSIGNED_BYTE;case Tr.RGB10A2UI:return e.UNSIGNED_INT;case Tr.RGB9E5:return e.UNSIGNED_BYTE;case Tr.DEPTH:return e.UNSIGNED_INT;case Tr.DEPTH_STENCIL:return rH.UNSIGNED_INT_24_8_WEBGL;case Tr.BC1:case Tr.BC1_SRGB:case Tr.BC2:case Tr.BC2_SRGB:case Tr.BC3:case Tr.BC3_SRGB:case Tr.BC4:return e.UNSIGNED_BYTE;case Tr.BC4_SNORM:return e.BYTE;case Tr.BC5:return e.UNSIGNED_BYTE;case Tr.BC5_SNORM:return e.BYTE;case Tr.BC6H_SF16:case Tr.BC6H_UF16:return e.FLOAT;case Tr.BC7:case Tr.BC7_SRGB:case Tr.ETC_RGB8:case Tr.ETC2_RGB8:case Tr.ETC2_SRGB8:case Tr.ETC2_RGB8_A1:case Tr.ETC2_SRGB8_A1:case Tr.EAC_R11:return e.UNSIGNED_BYTE;case Tr.EAC_R11SN:return e.BYTE;case Tr.EAC_RG11:return e.UNSIGNED_BYTE;case Tr.EAC_RG11SN:return e.BYTE;case Tr.PVRTC_RGB2:case Tr.PVRTC_RGBA2:case Tr.PVRTC_RGB4:case Tr.PVRTC_RGBA4:case Tr.PVRTC2_2BPP:case Tr.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case Tr.ASTC_RGBA_4X4:case Tr.ASTC_RGBA_5X4:case Tr.ASTC_RGBA_5X5:case Tr.ASTC_RGBA_6X5:case Tr.ASTC_RGBA_6X6:case Tr.ASTC_RGBA_8X5:case Tr.ASTC_RGBA_8X6:case Tr.ASTC_RGBA_8X8:case Tr.ASTC_RGBA_10X5:case Tr.ASTC_RGBA_10X6:case Tr.ASTC_RGBA_10X8:case Tr.ASTC_RGBA_10X10:case Tr.ASTC_RGBA_12X10:case Tr.ASTC_RGBA_12X12:case Tr.ASTC_SRGBA_4X4:case Tr.ASTC_SRGBA_5X4:case Tr.ASTC_SRGBA_5X5:case Tr.ASTC_SRGBA_6X5:case Tr.ASTC_SRGBA_6X6:case Tr.ASTC_SRGBA_8X5:case Tr.ASTC_SRGBA_8X6:case Tr.ASTC_SRGBA_8X8:case Tr.ASTC_SRGBA_10X5:case Tr.ASTC_SRGBA_10X6:case Tr.ASTC_SRGBA_10X8:case Tr.ASTC_SRGBA_10X10:case Tr.ASTC_SRGBA_12X10:case Tr.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function cH(t,e){switch(t){case Cr.BOOL:return e.BOOL;case Cr.BOOL2:return e.BOOL_VEC2;case Cr.BOOL3:return e.BOOL_VEC3;case Cr.BOOL4:return e.BOOL_VEC4;case Cr.INT:return e.INT;case Cr.INT2:return e.INT_VEC2;case Cr.INT3:return e.INT_VEC3;case Cr.INT4:return e.INT_VEC4;case Cr.UINT:return e.UNSIGNED_INT;case Cr.FLOAT:return e.FLOAT;case Cr.FLOAT2:return e.FLOAT_VEC2;case Cr.FLOAT3:return e.FLOAT_VEC3;case Cr.FLOAT4:return e.FLOAT_VEC4;case Cr.MAT2:return e.FLOAT_MAT2;case Cr.MAT3:return e.FLOAT_MAT3;case Cr.MAT4:return e.FLOAT_MAT4;case Cr.SAMPLER2D:return e.SAMPLER_2D;case Cr.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Cr.UNKNOWN}}function lH(t){switch(t){case Cr.BOOL:case Cr.BOOL2:case Cr.BOOL3:case Cr.BOOL4:case Cr.INT:case Cr.INT2:case Cr.INT3:case Cr.INT4:case Cr.UINT:return Int32Array;case Cr.FLOAT:case Cr.FLOAT2:case Cr.FLOAT3:case Cr.FLOAT4:case Cr.MAT2:case Cr.MAT3:case Cr.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function uH(t,e){switch(t){case e.BOOL:return Cr.BOOL;case e.BOOL_VEC2:return Cr.BOOL2;case e.BOOL_VEC3:return Cr.BOOL3;case e.BOOL_VEC4:return Cr.BOOL4;case e.INT:return Cr.INT;case e.INT_VEC2:return Cr.INT2;case e.INT_VEC3:return Cr.INT3;case e.INT_VEC4:return Cr.INT4;case e.UNSIGNED_INT:return Cr.UINT;case e.FLOAT:return Cr.FLOAT;case e.FLOAT_VEC2:return Cr.FLOAT2;case e.FLOAT_VEC3:return Cr.FLOAT3;case e.FLOAT_VEC4:return Cr.FLOAT4;case e.FLOAT_MAT2:return Cr.MAT2;case e.FLOAT_MAT3:return Cr.MAT3;case e.FLOAT_MAT4:return Cr.MAT4;case e.SAMPLER_2D:return Cr.SAMPLER2D;case e.SAMPLER_CUBE:return Cr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Cr.UNKNOWN}}function hH(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function fH(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}aH._instance=null;var pH,_H=[512,513,514,515,516,517,518,519],dH=[0,7680,7681,7682,7683,5386,34055,34056],mH=[32774,32778,32779,32775,32776],vH=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(pH||(pH={}));var gH=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},yH=function(t){function e(){var e;return(e=t.call(this,pH.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new fo,e.clearFlag=ro.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return F(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(gH),xH=function(t){function e(){var e;return(e=t.call(this,pH.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new ua,e}return F(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(gH),SH=function(t){function e(){var e;return(e=t.call(this,pH.DRAW)||this).drawInfo=new Ao,e}return F(e,t),e.prototype.clear=function(){},e}(gH),bH=function(t){function e(){var e;return(e=t.call(this,pH.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return F(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(gH),TH=function(t){function e(){var e;return(e=t.call(this,pH.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return F(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(gH),EH=function(){function t(){this.cmds=new qt(1),this.beginRenderPassCmds=new qt(1),this.bindStatesCmds=new qt(1),this.drawCmds=new qt(1),this.updateBufferCmds=new qt(1),this.copyBufferToTextureCmds=new qt(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function CH(t,e,n,i,r){if(e.usage&wr.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&wr.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),wH.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),wH.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r))}}var wH={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function AH(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;t.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var f=e.colorAttachments[h];if(f.format!==Tr.UNKNOWN)switch(f.loadOp){case Vr.LOAD:break;case Vr.CLEAR:c.bs.targets[0].blendColorMask!==Gr.ALL&&s.colorMask(!0,!0,!0,!0);var p=r[0];s.clearColor(p.x,p.y,p.z,p.w),l|=s.COLOR_BUFFER_BIT;break;case Vr.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==Tr.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Vr.LOAD:break;case Vr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Vr.DISCARD:}if(fa[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Vr.LOAD:break;case Vr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Vr.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var _=c.bs.targets[0].blendColorMask;if(_!==Gr.ALL){var d=(_&Gr.R)!==Gr.NONE,m=(_&Gr.G)!==Gr.NONE,v=(_&Gr.B)!==Gr.NONE,g=(_&Gr.A)!==Gr.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function PH(t,e,n,i,r,o){var a,s,c,l=t.gl,u=t.stateCache,h=e&&e.gpuShader,f=!1;if(e&&wH.gpuPipelineState!==e){if(wH.gpuPipelineState=e,wH.glPrimitive=e.glPrimitive,e.gpuShader){var p=e.gpuShader.glProgram;u.glProgram!==p&&(l.useProgram(p),u.glProgram=p,f=!0)}var _=e.rs;if(_){if(u.rs.cullMode!==_.cullMode){switch(_.cullMode){case Zr.NONE:l.disable(l.CULL_FACE);break;case Zr.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Zr.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=_.cullMode}var m=_.isFrontFaceCCW;u.rs.isFrontFaceCCW!==m&&(l.frontFace(m?l.CCW:l.CW),u.rs.isFrontFaceCCW=m),u.rs.depthBias===_.depthBias&&u.rs.depthBiasSlop===_.depthBiasSlop||(l.polygonOffset(_.depthBias,_.depthBiasSlop),u.rs.depthBias=_.depthBias,u.rs.depthBiasSlop=_.depthBiasSlop),u.rs.lineWidth!==_.lineWidth&&(l.lineWidth(_.lineWidth),u.rs.lineWidth=_.lineWidth)}var v=e.dss;v&&(u.dss.depthTest!==v.depthTest&&(v.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=v.depthTest),u.dss.depthWrite!==v.depthWrite&&(l.depthMask(v.depthWrite),u.dss.depthWrite=v.depthWrite),u.dss.depthFunc!==v.depthFunc&&(l.depthFunc(_H[v.depthFunc]),u.dss.depthFunc=v.depthFunc),u.dss.stencilTestFront===v.stencilTestFront&&u.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=v.stencilTestFront,u.dss.stencilTestBack=v.stencilTestBack),u.dss.stencilFuncFront===v.stencilFuncFront&&u.dss.stencilRefFront===v.stencilRefFront&&u.dss.stencilReadMaskFront===v.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,_H[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),u.dss.stencilFuncFront=v.stencilFuncFront,u.dss.stencilRefFront=v.stencilRefFront,u.dss.stencilReadMaskFront=v.stencilReadMaskFront),u.dss.stencilFailOpFront===v.stencilFailOpFront&&u.dss.stencilZFailOpFront===v.stencilZFailOpFront&&u.dss.stencilPassOpFront===v.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,dH[v.stencilFailOpFront],dH[v.stencilZFailOpFront],dH[v.stencilPassOpFront]),u.dss.stencilFailOpFront=v.stencilFailOpFront,u.dss.stencilZFailOpFront=v.stencilZFailOpFront,u.dss.stencilPassOpFront=v.stencilPassOpFront),u.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,v.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),u.dss.stencilFuncBack===v.stencilFuncBack&&u.dss.stencilRefBack===v.stencilRefBack&&u.dss.stencilReadMaskBack===v.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,_H[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),u.dss.stencilFuncBack=v.stencilFuncBack,u.dss.stencilRefBack=v.stencilRefBack,u.dss.stencilReadMaskBack=v.stencilReadMaskBack),u.dss.stencilFailOpBack===v.stencilFailOpBack&&u.dss.stencilZFailOpBack===v.stencilZFailOpBack&&u.dss.stencilPassOpBack===v.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,dH[v.stencilFailOpBack],dH[v.stencilZFailOpBack],dH[v.stencilPassOpBack]),u.dss.stencilFailOpBack=v.stencilFailOpBack,u.dss.stencilZFailOpBack=v.stencilZFailOpBack,u.dss.stencilPassOpBack=v.stencilPassOpBack),u.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,v.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var g=e.bs;if(g){u.bs.isA2C!==g.isA2C&&(g.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=g.isA2C),u.bs.blendColor.x===g.blendColor.x&&u.bs.blendColor.y===g.blendColor.y&&u.bs.blendColor.z===g.blendColor.z&&u.bs.blendColor.w===g.blendColor.w||(l.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),u.bs.blendColor.x=g.blendColor.x,u.bs.blendColor.y=g.blendColor.y,u.bs.blendColor.z=g.blendColor.z,u.bs.blendColor.w=g.blendColor.w);var y=g.targets[0],x=u.bs.targets[0];x.blend!==y.blend&&(y.blend?l.enable(l.BLEND):l.disable(l.BLEND),x.blend=y.blend),x.blendEq===y.blendEq&&x.blendAlphaEq===y.blendAlphaEq||(l.blendEquationSeparate(mH[y.blendEq],mH[y.blendAlphaEq]),x.blendEq=y.blendEq,x.blendAlphaEq=y.blendAlphaEq),x.blendSrc===y.blendSrc&&x.blendDst===y.blendDst&&x.blendSrcAlpha===y.blendSrcAlpha&&x.blendDstAlpha===y.blendDstAlpha||(l.blendFuncSeparate(vH[y.blendSrc],vH[y.blendDst],vH[y.blendSrcAlpha],vH[y.blendDstAlpha]),x.blendSrc=y.blendSrc,x.blendDst=y.blendDst,x.blendSrcAlpha=y.blendSrcAlpha,x.blendDstAlpha=y.blendDstAlpha),x.blendColorMask!==y.blendColorMask&&(l.colorMask((y.blendColorMask&Gr.R)!==Gr.NONE,(y.blendColorMask&Gr.G)!==Gr.NONE,(y.blendColorMask&Gr.B)!==Gr.NONE,(y.blendColorMask&Gr.A)!==Gr.NONE),x.blendColorMask=y.blendColorMask)}}if(e&&e.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,b=e.gpuPipelineLayout.dynamicOffsetIndices,T=0;T<S;T++){var E=h.glBlocks[T],C=i[E.set],w=C&&C.descriptorIndices[E.binding],A=w>=0&&C.gpuDescriptors[w],P=null,I=0;if(A&&A.gpuBuffer){var R=A.gpuBuffer,D=b[E.set],O=D&&D[E.binding];O>=0&&(I=r[O]),"vf32"in R?P=R.vf32:(I+=R.offset,P=R.gpuBuffer.vf32),I>>=2}if(P)for(var M=E.glActiveUniforms.length,N=0;N<M;N++){var L=E.glActiveUniforms[N];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+I+B;if(P[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=P[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+I+k;if(P[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=P[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<L.array.length;++j){var W=L.offset+I+j;if(P[W]!==L.array[j]){for(var q=j,X=W;q<L.array.length;++q,++X)L.array[q]=P[X];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+I+Y;if(P[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=P[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+I+J;if(P[$]!==L.array[J]){for(var tt=J,et=$;tt<L.array.length;++tt,++et)L.array[tt]=P[et];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var nt=0;nt<L.array.length;++nt){var it=L.offset+I+nt;if(P[it]!==L.array[nt]){for(var rt=nt,ot=it;rt<L.array.length;++rt,++ot)L.array[rt]=P[ot];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var at=0;at<L.array.length;++at){var st=L.offset+I+at;if(P[st]!==L.array[at]){for(var ct=at,lt=st;ct<L.array.length;++ct,++lt)L.array[ct]=P[lt];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ut=0;ut<L.array.length;++ut){var ht=L.offset+I+ut;if(P[ht]!==L.array[ut]){for(var ft=ut,pt=ht;ft<L.array.length;++ft,++pt)L.array[ft]=P[pt];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var _t=0;_t<L.array.length;++_t){var dt=L.offset+I+_t;if(P[dt]!==L.array[_t]){for(var mt=_t,vt=dt;mt<L.array.length;++mt,++vt)L.array[mt]=P[vt];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var gt=0;gt<L.array.length;++gt){var yt=L.offset+I+gt;if(P[yt]!==L.array[gt]){for(var xt=gt,St=yt;xt<L.array.length;++xt,++St)L.array[xt]=P[St];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var bt=0;bt<L.array.length;++bt){var Tt=L.offset+I+bt;if(P[Tt]!==L.array[bt]){for(var Et=bt,Ct=Tt;Et<L.array.length;++Et,++Ct)L.array[Et]=P[Ct];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else d("Buffer binding '"+E.name+"' at set "+E.set+" binding "+E.binding+" is not bounded")}for(var wt=h.glSamplerTextures.length,At=0;At<wt;At++)for(var Pt=h.glSamplerTextures[At],It=i[Pt.set],Rt=It&&It.descriptorIndices[Pt.binding],Dt=Rt>=0&&It.gpuDescriptors[Rt],Ot=Pt.units.length,Mt=0;Mt<Ot;Mt++){var Nt=Pt.units[Mt];if(Dt&&Dt.gpuSampler){if(Dt.gpuTexture&&Dt.gpuTexture.size>0){var Lt=Dt.gpuTexture,Bt=u.glTexUnits[Nt];Bt.glTexture!==Lt.glTexture&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),Lt.glTexture?l.bindTexture(Lt.glTarget,Lt.glTexture):l.bindTexture(Lt.glTarget,t.nullTex2D.gpuTexture.glTexture),Bt.glTexture=Lt.glTexture);var Ft=Dt.gpuSampler;Lt.isPowerOf2?(a=Ft.glWrapS,s=Ft.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Lt.isPowerOf2?Lt.mipLevel<=1&&(Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Ft.glMinFilter:Ft.glMinFilter===l.LINEAR||Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Lt.glWrapS!==a&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_WRAP_S,a),Lt.glWrapS=a),Lt.glWrapT!==s&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_WRAP_T,s),Lt.glWrapT=s),Lt.glMinFilter!==c&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_MIN_FILTER,c),Lt.glMinFilter=c),Lt.glMagFilter!==Ft.glMagFilter&&(u.texUnit!==Nt&&(l.activeTexture(l.TEXTURE0+Nt),u.texUnit=Nt),l.texParameteri(Lt.glTarget,l.TEXTURE_MAG_FILTER,Ft.glMagFilter),Lt.glMagFilter=Ft.glMagFilter)}Dt=It.gpuDescriptors[++Rt]}else d("Sampler binding '"+Pt.name+"' at set "+Pt.set+" binding "+Pt.binding+" index "+Mt+" is not bounded")}}if(n&&h&&(f||wH.gpuInputAssembler!==n)){wH.gpuInputAssembler=n;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var Ut=t.extensions.OES_vertex_array_object,kt=n.glVAOs.get(h.glProgram);if(!kt){var Gt;kt=Ut.createVertexArrayOES(),n.glVAOs.set(h.glProgram,kt),Ut.bindVertexArrayOES(kt),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var Ht=h.glInputs.length,Vt=0;Vt<Ht;Vt++){var jt=h.glInputs[Vt];Gt=null;for(var Wt=n.glAttribs.length,qt=0;qt<Wt;qt++){var Xt=n.glAttribs[qt];if(Xt.name===jt.name){Gt=Xt;break}}if(Gt){u.glArrayBuffer!==Gt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Gt.glBuffer),u.glArrayBuffer=Gt.glBuffer);for(var Yt=0;Yt<Gt.componentCount;++Yt){var Kt=jt.glLoc+Yt,Qt=Gt.offset+Gt.size*Yt;l.enableVertexAttribArray(Kt),u.glCurrentAttribLocs[Kt]=!0,l.vertexAttribPointer(Kt,Gt.count,Gt.glType,Gt.isNormalized,Gt.stride,Qt),zt&&zt.vertexAttribDivisorANGLE(Kt,Gt.isInstanced?1:0)}}}var Zt=n.gpuIndexBuffer;Zt&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Zt.glBuffer),Ut.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==kt&&(Ut.bindVertexArrayOES(kt),u.glVAO=kt)}else{for(var Jt=0;Jt<t.capabilities.maxVertexAttributes;++Jt)u.glCurrentAttribLocs[Jt]=!1;for(var $t=h.glInputs.length,te=0;te<$t;te++){for(var ee=h.glInputs[te],ne=null,ie=n.glAttribs.length,re=0;re<ie;re++){var oe=n.glAttribs[re];if(oe.name===ee.name){ne=oe;break}}if(ne){u.glArrayBuffer!==ne.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ne.glBuffer),u.glArrayBuffer=ne.glBuffer);for(var ae=0;ae<ne.componentCount;++ae){var se=ee.glLoc+ae,ce=ne.offset+ne.size*ae;!u.glEnabledAttribLocs[se]&&se>=0&&(l.enableVertexAttribArray(se),u.glEnabledAttribLocs[se]=!0),u.glCurrentAttribLocs[se]=!0,l.vertexAttribPointer(se,ne.count,ne.glType,ne.isNormalized,ne.stride,ce),zt&&zt.vertexAttribDivisorANGLE(se,ne.isInstanced?1:0)}}}var le=n.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ue=0;ue<t.capabilities.maxVertexAttributes;++ue)u.glEnabledAttribLocs[ue]!==u.glCurrentAttribLocs[ue]&&(l.disableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!1)}}if(e&&e.dynamicStates.length)for(var he=e.dynamicStates.length,fe=0;fe<he;fe++)switch(e.dynamicStates[fe]){case Jr.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Jr.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Jr.BLEND_CONSTANTS:var pe=o.blendConstant;u.bs.blendColor.x===pe.x&&u.bs.blendColor.y===pe.y&&u.bs.blendColor.z===pe.z&&u.bs.blendColor.w===pe.w||(l.blendColor(pe.x,pe.y,pe.z,pe.w),u.bs.blendColor.copy(pe));break;case Jr.STENCIL_WRITE_MASK:var _e=o.stencilStatesFront,de=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==_e.writeMask&&(l.stencilMaskSeparate(l.FRONT,_e.writeMask),u.dss.stencilWriteMaskFront=_e.writeMask),u.dss.stencilWriteMaskBack!==de.writeMask&&(l.stencilMaskSeparate(l.BACK,de.writeMask),u.dss.stencilWriteMaskBack=de.writeMask);break;case Jr.STENCIL_COMPARE_MASK:var me=o.stencilStatesFront,ve=o.stencilStatesBack;u.dss.stencilRefFront===me.reference&&u.dss.stencilReadMaskFront===me.compareMask||(l.stencilFuncSeparate(l.FRONT,_H[u.dss.stencilFuncFront],me.reference,me.compareMask),u.dss.stencilRefFront=me.reference,u.dss.stencilReadMaskFront=me.compareMask),u.dss.stencilRefBack===ve.reference&&u.dss.stencilReadMaskBack===ve.compareMask||(l.stencilFuncSeparate(l.BACK,_H[u.dss.stencilFuncBack],ve.reference,ve.compareMask),u.dss.stencilRefBack=ve.reference,u.dss.stencilReadMaskBack=ve.compareMask)}}function IH(t,e){var n=t.gl,i=t.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=wH.gpuInputAssembler,s=wH.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var f=0;f<l.drawCount;f++)l.instances[f]&&r?r.drawArraysInstancedANGLE(s,l.offsets[f],l.counts[f],l.instances[f]):n.drawArrays(s,l.offsets[f],l.counts[f])}else if(e.instanceCount&&r)if(c){if(e.indexCount>0){var p=e.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,e.indexCount,a.glIndexType,p,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(c){if(e.indexCount>0){var _=e.firstIndex*c.stride;n.drawElements(s,e.indexCount,a.glIndexType,_)}}else e.vertexCount>0&&n.drawArrays(s,e.firstVertex,e.vertexCount)}}var RH=new Array(pH.COUNT);function DH(t,e){RH.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=RH[i]++;switch(i){case pH.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];AH(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case pH.BIND_STATES:var a=e.bindStatesCmds.array[r];PH(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case pH.DRAW:IH(t,e.drawCmds.array[r].drawInfo);break;case pH.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];CH(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case pH.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];OH(t,c.buffers,c.gpuTexture,c.regions)}}}function OH(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=fa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var p=e[a++];u?n.glInternalFmt===rH.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,p):r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,p):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,p)}break;case r.TEXTURE_CUBE_MAP:for(var _=0;_<i.length;_++){var d=i[_],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=e[a++];u?n.glInternalFmt===rH.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Or.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var MH=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=Mn(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),NH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&wr.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new MH,glTarget:0,glBuffer:null},this._usage&wr.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&Ir.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&wr.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),wH.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&wr.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),wH.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&wr.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&wr.INDIRECT||e.usage&wr.TRANSFER_DST||e.usage&wr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(aH.instance,this._gpuBuffer),aH.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),wH.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),wH.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(aH.instance,this._gpuBuffer),aH.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&Ir.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&wr.VERTEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),wH.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&wr.INDEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),wH.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&wr.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&wr.INDIRECT||e.usage&wr.TRANSFER_DST||e.usage&wr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(aH.instance,this._gpuBuffer),aH.instance.memoryStatus.bufferSize-=e,aH.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&wr.INDIRECT?0:t.byteLength,CH(aH.instance,this._gpuBuffer,t,0,n))},L(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(Ea),LH=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new qt(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),BH=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new LH(yH,1),this.bindStatesCmdPool=new LH(xH,1),this.drawCmdPool=new LH(SH,1),this.updateBufferCmdPool=new LH(bH,1),this.copyBufferToTextureCmdPool=new LH(TH,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),FH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new EH,e._cmdAllocator=new BH,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new ua,e._isStateInvalied=!1,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=aH.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(yH);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(pH.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&$r.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&$r.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&$r.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&$r.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===io.PRIMARY&&this._isInRenderPass||this._type===io.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(SH);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(pH.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===io.PRIMARY&&!this._isInRenderPass||this._type===io.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(bH),a=0;t.usage&wr.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(pH.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===io.PRIMARY&&!this._isInRenderPass||this._type===io.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(TH);r&&(r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(pH.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var p=i.cmdPackage.copyBufferToTextureCmds.array[f];++p.refCount,this.cmdPackage.copyBufferToTextureCmds.push(p)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(xH);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(pH.BIND_STATES),this._isStateInvalied=!1)},e}(Ca),zH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;++n){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=fa[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(aH.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=aH.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},L(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(Pa),UH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=sH(o.format,n),l=fa[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:fa[o.format].count,stride:s.stride,componentCount:fH(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(aH.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=aH.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.extensions.OES_vertex_array_object,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},L(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(Oa),kH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&da)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},L(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(Na),GH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},L(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(La),HH=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],VH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:HH[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},L(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(Ga),jH=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){AH(aH.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;IH(aH.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=aH.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=aH.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&wr.INDIRECT?0:e.byteLength,CH(aH.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&OH(aH.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];DH(aH.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){PH(aH.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(FH),WH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=t.length,n=0;n<e;n++){var i=t[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Ha),qH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},L(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Va),XH=[10497,33648,33071,33071],YH=function(t){function e(e,n){var i;(i=t.call(this,e,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Lr.LINEAR||a===Lr.ANISOTROPIC?c===Lr.LINEAR||c===Lr.ANISOTROPIC?9987:c===Lr.POINT?9985:9729:c===Lr.LINEAR||c===Lr.ANISOTROPIC?9986:c===Lr.POINT?9984:9728,o=s===Lr.LINEAR||s===Lr.ANISOTROPIC?9729:9728;var l=XH[i._info.addressU],u=XH[i._info.addressV],h=XH[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return F(e,t),L(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(ja),KH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Hr.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Hr.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}if(n.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));v("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var f=0;f<h;++f){var p=n.getActiveAttrib(e.glProgram,f);if(p){var _,d=p.name.indexOf("[");_=-1!==d?p.name.substr(0,d):p.name;var m=n.getAttribLocation(e.glProgram,_),g=uH(p.type,n),y=hH(p.type,n);e.glInputs[f]={binding:m,name:_,type:g,stride:y,count:p.size,size:y*p.size,glType:p.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var x=0;x<e.blocks.length;++x){var S=e.blocks[x],b={set:S.set,binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[]};e.glBlocks[x]=b;for(var T=0;T<S.members.length;++T){var E=S.members[T],C=cH(E.type,n),w=hH(C,n),A=w*E.count;b.glUniforms[T]={binding:-1,name:E.name,type:E.type,stride:w,count:E.count,size:A,offset:0,glType:C,glLoc:null,array:null}}}}for(var P=0;P<e.subpassInputs.length;++P){var I=e.subpassInputs[P];e.samplerTextures.push(new Lo(I.set,I.binding,I.name,Cr.SAMPLER2D,I.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var R=0;R<e.samplerTextures.length;++R){var D=e.samplerTextures[R];e.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:cH(D.type,n),glLoc:null}}}for(var O=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS),M=0;M<O;++M){var N=n.getActiveUniform(e.glProgram,M);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(e.glProgram,N.name);if(t.extensions.isLocationActive(L)){var B,F=N.name.indexOf("[");B=-1!==F?N.name.substr(0,F):N.name;for(var z=0;z<e.glBlocks.length;z++)for(var U=e.glBlocks[z],k=0;k<U.glUniforms.length;k++){var G=U.glUniforms[k];if(G.name===B){G.glLoc=L,G.count=N.size,G.size=G.stride*G.count,G.array=new(lH(G.type))(G.size/4),U.glActiveUniforms.push(G);break}}}}}for(var H=0;H<e.glBlocks.length;H++)for(var V=e.glBlocks[H],j=0;j<V.glUniforms.length;j++){var W=V.glUniforms[j];W.offset=V.size/4,V.size+=W.size}for(var q=[],X=[],Y=t.bindingMappingInfo,K=t.stateCache.texUnitCacheMap,Q=0,Z=0;Z<e.blocks.length;++Z)e.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=n.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(q.push(e.glSamplerTextures[$]),X.push(et)),void 0===K[tt.name]){var nt=tt.binding+Y.samplerOffsets[tt.set]+J;tt.set===Y.flexibleSet&&(nt-=Q),K[tt.name]=nt%t.capabilities.maxTextureUnits,J+=tt.count-1}}if(q.length){for(var it=[],rt=0;rt<q.length;++rt){var ot=q[rt],at=K[ot.name];if(void 0!==at){ot.glLoc=X[rt];for(var st=0;st<ot.count;++st){for(;it[at];)at=(at+1)%t.capabilities.maxTextureUnits;ot.units.push(at),it[at]=!0}}}for(var ct=0,lt=0;lt<q.length;++lt){var ut=q[lt];if(!t.extensions.isLocationActive(ut.glLoc)){ut.glLoc=X[lt];for(var ht=0;ht<ut.count;++ht){for(;it[ct];)ct=(ct+1)%t.capabilities.maxTextureUnits;void 0===K[ut.name]&&(K[ut.name]=ct),ut.units.push(ct),it[ct]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var ft=0;ft<q.length;ft++){var pt=q[ft];pt.glUnits=new Int32Array(pt.units),n.uniform1iv(pt.glLoc,pt.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(var _t=0;_t<e.glBlocks.length;)e.glBlocks[_t].glActiveUniforms.length?_t++:(e.glBlocks[_t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=q}}(aH.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var n=t.gl;if(!t.extensions.destroyShadersImmediately)for(var i=0;i<e.gpuStages.length;i++){var r=e.gpuStages[i];r.glShader&&(n.detachShader(e.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(aH.instance,this._gpuShader),this._gpuShader=null)},L(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Wa),QH=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new xo,this.scissorRect=new fo(0,0,0,0),this.rs=new Ba,this.dss=new Fa,this.bs=new Ua,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var n=0;n<t;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),ZH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=va(this._width)&&va(this._height),this._size=ya(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var n=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case Tr.A8:return e.ALPHA;case Tr.L8:return e.LUMINANCE;case Tr.LA8:return e.LUMINANCE_ALPHA;case Tr.RGB8:case Tr.RGB16F:case Tr.RGB32F:return e.RGB;case Tr.BGRA8:case Tr.RGBA8:case Tr.SRGB8_A8:case Tr.RGBA16F:case Tr.RGBA32F:return e.RGBA;case Tr.R5G6B5:return e.RGB;case Tr.RGB5A1:case Tr.RGBA4:return e.RGBA;case Tr.DEPTH:return e.DEPTH_COMPONENT;case Tr.DEPTH_STENCIL:return e.DEPTH_STENCIL;case Tr.BC1:return rH.COMPRESSED_RGB_S3TC_DXT1_EXT;case Tr.BC1_ALPHA:return rH.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Tr.BC1_SRGB:return rH.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Tr.BC1_SRGB_ALPHA:return rH.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Tr.BC2:return rH.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Tr.BC2_SRGB:return rH.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Tr.BC3:return rH.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Tr.BC3_SRGB:return rH.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Tr.ETC_RGB8:return rH.COMPRESSED_RGB_ETC1_WEBGL;case Tr.ETC2_RGB8:return rH.COMPRESSED_RGB8_ETC2;case Tr.ETC2_SRGB8:return rH.COMPRESSED_SRGB8_ETC2;case Tr.ETC2_RGB8_A1:return rH.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_SRGB8_A1:return rH.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Tr.ETC2_RGBA8:return rH.COMPRESSED_RGBA8_ETC2_EAC;case Tr.ETC2_SRGB8_A8:return rH.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Tr.EAC_R11:return rH.COMPRESSED_R11_EAC;case Tr.EAC_R11SN:return rH.COMPRESSED_SIGNED_R11_EAC;case Tr.EAC_RG11:return rH.COMPRESSED_RG11_EAC;case Tr.EAC_RG11SN:return rH.COMPRESSED_SIGNED_RG11_EAC;case Tr.PVRTC_RGB2:return rH.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGBA2:return rH.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Tr.PVRTC_RGB4:return rH.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Tr.PVRTC_RGBA4:return rH.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Tr.ASTC_RGBA_4X4:return rH.COMPRESSED_RGBA_ASTC_4x4_KHR;case Tr.ASTC_RGBA_5X4:return rH.COMPRESSED_RGBA_ASTC_5x4_KHR;case Tr.ASTC_RGBA_5X5:return rH.COMPRESSED_RGBA_ASTC_5x5_KHR;case Tr.ASTC_RGBA_6X5:return rH.COMPRESSED_RGBA_ASTC_6x5_KHR;case Tr.ASTC_RGBA_6X6:return rH.COMPRESSED_RGBA_ASTC_6x6_KHR;case Tr.ASTC_RGBA_8X5:return rH.COMPRESSED_RGBA_ASTC_8x5_KHR;case Tr.ASTC_RGBA_8X6:return rH.COMPRESSED_RGBA_ASTC_8x6_KHR;case Tr.ASTC_RGBA_8X8:return rH.COMPRESSED_RGBA_ASTC_8x8_KHR;case Tr.ASTC_RGBA_10X5:return rH.COMPRESSED_RGBA_ASTC_10x5_KHR;case Tr.ASTC_RGBA_10X6:return rH.COMPRESSED_RGBA_ASTC_10x6_KHR;case Tr.ASTC_RGBA_10X8:return rH.COMPRESSED_RGBA_ASTC_10x8_KHR;case Tr.ASTC_RGBA_10X10:return rH.COMPRESSED_RGBA_ASTC_10x10_KHR;case Tr.ASTC_RGBA_12X10:return rH.COMPRESSED_RGBA_ASTC_12x10_KHR;case Tr.ASTC_RGBA_12X12:return rH.COMPRESSED_RGBA_ASTC_12x12_KHR;case Tr.ASTC_SRGBA_4X4:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Tr.ASTC_SRGBA_5X4:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Tr.ASTC_SRGBA_5X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Tr.ASTC_SRGBA_6X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Tr.ASTC_SRGBA_6X6:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Tr.ASTC_SRGBA_8X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Tr.ASTC_SRGBA_8X6:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Tr.ASTC_SRGBA_8X8:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Tr.ASTC_SRGBA_10X5:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Tr.ASTC_SRGBA_10X6:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Tr.ASTC_SRGBA_10X8:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Tr.ASTC_SRGBA_10X10:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Tr.ASTC_SRGBA_12X10:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Tr.ASTC_SRGBA_12X12:return rH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=sH(e.format,n);var i=e.width,r=e.height;switch(e.type){case Rr.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&w(9100,o,t.capabilities.maxTextureSize),!t.extensions.WEBGL_depth_texture&&fa[e.format].hasDepth)e.glInternalFmt=function(t,e){switch(t){case Tr.R5G6B5:return e.RGB565;case Tr.RGB5A1:return e.RGB5_A1;case Tr.RGBA4:return e.RGBA4;case Tr.RGBA16F:return rH.RGBA16F_EXT;case Tr.RGBA32F:return rH.RGBA32F_EXT;case Tr.SRGB8_A8:return rH.SRGB8_ALPHA8_EXT;case Tr.DEPTH:return e.DEPTH_COMPONENT16;case Tr.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r));else if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),fa[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ga(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;case Rr.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>t.capabilities.maxCubeMapTextureSize&&w(9100,h,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var f=t.stateCache.glTexUnits[t.stateCache.texUnit];if(f.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),f.glTexture=e.glTexture),fa[e.format].isCompressed)for(var p=0;p<6;++p){i=e.width,r=e.height;for(var _=0;_<e.mipLevel;++_){var d=ga(e.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=Rr.TEX2D,e.glTarget=n.TEXTURE_2D}}(aH.instance,this._gpuTexture),aH.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(aH.instance,this._gpuTexture),aH.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=ya(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case Rr.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&w(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),fa[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ga(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Rr.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>t.capabilities.maxCubeMapTextureSize&&w(9100,h,t.capabilities.maxTextureSize);var f=t.stateCache.glTexUnits[t.stateCache.texUnit];if(f.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),f.glTexture=e.glTexture),fa[e.format].isCompressed)for(var p=0;p<6;++p){i=e.width,r=e.height;for(var _=0;_<e.mipLevel;++_){var d=ga(e.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=Rr.TEX2D,e.glTarget=n.TEXTURE_2D}}}(aH.instance,this._gpuTexture),aH.instance.memoryStatus.textureSize-=n,aH.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new Ro;e.format=t.format,e.usage=fa[t.format].hasDepth?Dr.DEPTH_STENCIL_ATTACHMENT:Dr.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},L(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(qa),JH="webglcontextlost";function $H(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function tV(t){var e={EXT_texture_filter_anisotropic:$H(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:$H(t,"EXT_blend_minmax"),EXT_frag_depth:$H(t,"EXT_frag_depth"),EXT_shader_texture_lod:$H(t,"EXT_shader_texture_lod"),EXT_sRGB:$H(t,"EXT_sRGB"),OES_vertex_array_object:$H(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:$H(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:$H(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:$H(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:$H(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:$H(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:$H(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:$H(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:$H(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:$H(t,"WEBGL_draw_buffers"),WEBGL_lose_context:$H(t,"WEBGL_lose_context"),WEBGL_depth_texture:$H(t,"WEBGL_depth_texture"),OES_texture_half_float:$H(t,"OES_texture_half_float"),OES_texture_half_float_linear:$H(t,"OES_texture_half_float_linear"),OES_texture_float:$H(t,"OES_texture_float"),OES_texture_float_linear:$H(t,"OES_texture_float_linear"),OES_standard_derivatives:$H(t,"OES_standard_derivatives"),OES_element_index_uint:$H(t,"OES_element_index_uint"),ANGLE_instanced_arrays:$H(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:$H(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return pn.os===ln.IOS&&14===pn.osMainVersion&&pn.isBrowser||(e.WEBGL_compressed_texture_astc=$H(t,"WEBGL_compressed_texture_astc")),pn.os!==ln.ANDROID&&pn.os!==ln.IOS&&(e.WEBGL_multi_draw=$H(t,"WEBGL_multi_draw")),pn.browserType===an.UC&&(e.ANGLE_instanced_arrays=null),pn.os===ln.IOS&&pn.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var eV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new QH,e.cmdAllocator=new BH,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(JH,this._onWebGLContextLost);var e=aH.instance.gl;this.stateCache.initialize(aH.instance.capabilities.maxTextureUnits,aH.instance.capabilities.maxVertexAttributes),this._extensions=tV(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=Tr.RGBA8,i=Tr.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=Tr.DEPTH_STENCIL:r&&(i=Tr.DEPTH),this._colorTexture=new ZH,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new ZH,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=aH.instance.createTexture(new Ro(Rr.TEX2D,Dr.SAMPLED,Tr.RGBA8,2,2,Or.GEN_MIPMAP)),this.nullTexCube=aH.instance.createTexture(new Ro(Rr.CUBE,Dr.SAMPLED,Tr.RGBA8,2,2,Or.GEN_MIPMAP,6));var a=new yo;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),aH.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,aH.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(JH,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(v("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){E(11e3),_(t)},L(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(Aa),nV=t("WebGLDevice",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){aH.setInstance(this),this._gfxAPI=xr.WEBGL,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:$t.ENABLE_TRANSPARENT_CANVAS,antialias:$t.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",n)}catch(t){return null}return e}(wa.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new oa(eo.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ra(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=W(n);!(r=o()).done;)i+=r.value+" ";var a=tV(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[br.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[br.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[br.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[br.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[br.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[br.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[br.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[br.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[br.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[br.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[br.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[br.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[br.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[br.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[br.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[br.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[br.FORMAT_ASTC]=!0,c+="astc "),v("WebGL device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===io.PRIMARY?jH:FH);return e.initialize(t),e},n.createSwapchain=function(t){var e=new eV;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new NH;return e.initialize(t),e},n.createTexture=function(t){var e=new ZH;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new oH;return e.initialize(t),e},n.createShader=function(t){var e=new KH;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new UH;return e.initialize(t),e},n.createRenderPass=function(t){var e=new qH;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new zH;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new kH;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new GH;return e.initialize(t),e},n.createPipelineState=function(t){var e=new VH;return e.initialize(t),e},n.createQueue=function(t){var e=new WH;return e.initialize(t),e},n.getSampler=function(t){var e=ja.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new YH(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Xa.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Xa(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Ya.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Ya(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){OH(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Or.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},L(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(wa));i.WebGLDevice=nV;var iV=[new Ho(co.ATTR_POSITION,Tr.RGB32F)],rV=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_COLOR,Tr.RGBA32F)],oV=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RG32F),new Ho(co.ATTR_COLOR,Tr.RGBA32F)],aV=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RG32F),new Ho(co.ATTR_COLOR,Tr.RGBA32F),new Ho(co.ATTR_COLOR2,Tr.RGBA32F)];function sV(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=fa[i.format].count}return e}function cV(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=fa[i.format].size}return e}i.internal.vfmtPosUvColor=oV,i.internal.vfmtPosUvTwoColor=aV,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:iV,vfmtPosColor:rV,vfmtPosUvColor:oV,vfmtPosUvTwoColor:aV,getComponentPerVertex:sV,getAttributeStride:cV}));var lV=new vi,uV=new Oi;function hV(t,e,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;t.getWorldMatrix(uV);for(var c=0,l=0;l<s;l++){var u=o[l];vi.set(lV,u.x,u.y,0),vi.transformMat4(lV,lV,uV),a[c++]=lV.x,a[c++]=lV.y,a[c++]=lV.z,di.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,f=r.vertexOffset,p=r.vertexAccessor.getMeshBuffer(r.bufferId),_=r.vertexAccessor.getIndexBuffer(h),d=p.indexOffset,m=0,v=s/4;m<v;m++){var g=f+4*m;_[d++]=g,_[d++]=g+1,_[d++]=g+2,_[d++]=g+1,_[d++]=g+3,_[d++]=g+2}p.indexOffset+=n.indexCount,p.setDirty()}var fV=function(){function t(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new pV;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var e=t.prototype;return e.insertSpriteFrame=function(t){var e=t.rect,n=t.texture,r=this._innerTextureInfos[n.getId()],o=e.x,a=e.y;if(r)o+=r.x,a+=r.y;else{var s=n.width,c=n.height;if(this._x+s+2>this._width&&(this._x=2,this._y=this._nexty),this._y+c+2>this._nexty&&(this._nexty=this._y+c+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((s<=8||c<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,o+=this._x,a+=this._y,this._x+=s+2}var l={x:o,y:a,texture:this._texture};return this._innerSpriteFrames.push(t),l},e.deleteInnerTexture=function(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)},e.isEmpty=function(){return this._count<=0},e.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var t=this._innerSpriteFrames,e=0,n=t.length;e<n;e++){var i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},e.destroy=function(){this.reset(),this._texture.destroy()},t}(),pV=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=sm.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new yo;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(cv),_V=function(){function t(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var e=t.prototype;return e.newAtlas=function(){var t=this._atlases[++this._atlasIndex];return t||(t=new fV(this._textureSize,this._textureSize),this._atlases.push(t)),t},e.beforeSceneLoad=function(){this.reset()},e.insertSpriteFrame=function(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;var e=t.texture.getSamplerInfo();if(e.minFilter!==lm.LINEAR||e.magFilter!==lm.LINEAR||e.mipFilter!==lm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(t)},e.reset=function(){for(var t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1},e.deleteAtlasSpriteFrame=function(t){if(t._original){for(var e,n=this._atlases.length-1;n>=0;n--)e=this._atlases[n],Gt.array.fastRemove(e._innerSpriteFrames,t);var i=t._original._texture;this.deleteAtlasTexture(i)}},e.deleteAtlasTexture=function(t){if(t)for(var e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)},e.packToDynamicAtlas=function(t,e){if(e&&!e._original&&e.packable){var n=this.insertSpriteFrame(e);n&&e._setDynamicAtlasFrame(n)}},L(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(t){this._maxAtlasCount=t}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(t){this._textureBleeding=t}},{key:"textureSize",get:function(){return this._textureSize},set:function(t){this._textureSize=t}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(t){this._maxFrameSize=t}}]),t}();_V.instance=void 0;var dV,mV,vV,gV=t("dynamicAtlasManager",_V.instance=new _V);i.internal.dynamicAtlasManager=gV;var yV,xV,SV,bV,TV=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],EV=t("SpriteFrame",ol("cc.SpriteFrame")((vV=mV=function(t){function e(){var e;return(e=t.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new Wi,e._offset=new Bi,e._originalSize=new Vi,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}F(e,t),e.createWithImage=function(t){var n=t instanceof Fm?t:new Fm(t),i=new cv;i.image=n;var r=new e;return r.texture=i,r};var n=e.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(t){this.rotated=t},n.getRect=function(t){return t?(t.set(this._rect),t):this._rect.clone()},n.setRect=function(t){this.rect=t},n.getOriginalSize=function(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()},n.setOriginalSize=function(t){this.originalSize=t},n.getOffset=function(t){return t?(t.set(this._offset),t):this._offset.clone()},n.setOffset=function(t){this.offset=t},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(t,e){void 0===e&&(e=!1);var n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(t){var e=this._rect,n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(w(3300,this.name+"/"+t.name,n,t.width),!1):!(i>t.height&&(w(3301,this.name+"/"+t.name,i,t.height),1))},n.destroy=function(){return this._packable&&gV&&gV.deleteAtlasSpriteFrame(this),t.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var t=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=t.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=t.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){TV[0].u=t.x/i,TV[1].u=(t.x+l)/i,TV[2].u=(t.x+l+u)/i,TV[3].u=(t.x+t.height)/i,TV[3].v=t.y/r,TV[2].v=(t.y+o)/r,TV[1].v=(t.y+o+s)/r,TV[0].v=(t.y+t.width)/r;for(var f=0;f<4;++f)for(var p=TV[f],_=0;_<4;++_){var d=TV[3-_];h.push({u:p.u,v:d.v})}}else{TV[0].u=t.x/i,TV[1].u=(t.x+o)/i,TV[2].u=(t.x+o+s)/i,TV[3].u=(t.x+t.width)/i,TV[3].v=t.y/r,TV[2].v=(t.y+c)/r,TV[1].v=(t.y+c+u)/r,TV[0].v=(t.y+t.height)/r;for(var m=0;m<4;++m)for(var v=TV[m],g=0;g<4;++g){var y=TV[g];h.push({u:y.u,v:v.v})}}this.emit(e.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:t.x/r,s=0===r?1:(t.x+t.height)/r,c=0===o?0:t.y/o,l=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=s,e[1]=l,e[2]=s,e[3]=c,e[4]=a,e[5]=l,e[6]=a,e[7]=c):this._isFlipUVX?(e[0]=s,e[1]=c,e[2]=s,e[3]=l,e[4]=a,e[5]=c,e[6]=a,e[7]=l):this._isFlipUVY?(e[0]=a,e[1]=l,e[2]=a,e[3]=c,e[4]=s,e[5]=l,e[6]=s,e[7]=c):(e[0]=a,e[1]=c,e[2]=a,e[3]=l,e[4]=s,e[5]=c,e[6]=s,e[7]=l);var u=0===r?0:t.x/r,h=0===r?1:(t.x+t.height)/r,f=0===o?0:t.y/o,p=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=p,n[2]=h,n[3]=f,n[4]=u,n[5]=p,n[6]=u,n[7]=f):this._isFlipUVX?(n[0]=h,n[1]=f,n[2]=h,n[3]=p,n[4]=u,n[5]=f,n[6]=u,n[7]=p):this._isFlipUVY?(n[0]=u,n[1]=p,n[2]=u,n[3]=f,n[4]=h,n[5]=p,n[6]=h,n[7]=f):(n[0]=u,n[1]=f,n[2]=u,n[3]=p,n[4]=h,n[5]=f,n[6]=h,n[7]=p)}else{var _=0===r?0:t.x/r,d=0===r?1:(t.x+t.width)/r,m=0===o?1:(t.y+t.height)/o,v=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=d,e[1]=v,e[2]=_,e[3]=v,e[4]=d,e[5]=m,e[6]=_,e[7]=m):this._isFlipUVX?(e[0]=d,e[1]=m,e[2]=_,e[3]=m,e[4]=d,e[5]=v,e[6]=_,e[7]=v):this._isFlipUVY?(e[0]=_,e[1]=v,e[2]=d,e[3]=v,e[4]=_,e[5]=m,e[6]=d,e[7]=m):(e[0]=_,e[1]=m,e[2]=d,e[3]=m,e[4]=_,e[5]=v,e[6]=d,e[7]=v);var g=0===r?0:t.x/r,y=0===r?1:(t.x+t.width)/r,x=0===o?1:(t.y+t.height)/o,S=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var b=this.vertices;if(b){b.nu.length=0,b.nv.length=0;for(var T=0;T<b.u.length;T++)b.nu[T]=b.u[T]/r,b.nv[T]=b.v[T]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var t=gV;if(t){var e=this._texture;if(e instanceof cv&&!e.isCompressed){var n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(t){var e=t,n=e.rect;n&&(this._rect=new Wi(n.x,n.y,n.width,n.height));var i=e.offset;e.offset&&(this._offset=new Bi(i.x,i.y));var r=e.originalSize;e.originalSize&&(this._originalSize=new Vi(r.width,r.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable;var o=e.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var t,n,i,r,o,a,s,c,l=new e,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(t=u.nu)||void 0===t?void 0:t.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(t){this._texture=t;var e=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(n.rect=new Wi(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new Vi(e.width,e.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new cv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},n._calculateTillingOffset=function(){this._rotated?(this.tillingOffset[0]=this.uv[4]-this.uv[0],this.tillingOffset[1]=this.uv[3]-this.uv[5],this.tillingOffset[2]=this.uv[0],this.tillingOffset[3]=this.uv[5],this.tillingOffset[0]=-this.tillingOffset[0]):(this.tillingOffset[0]=this.uv[2]-this.uv[0],this.tillingOffset[1]=this.uv[1]-this.uv[5],this.tillingOffset[2]=this.uv[4],this.tillingOffset[3]=this.uv[5])},n._calculateSlicedData=function(){var t=this._rect,e=this._capInsets[0],n=this._capInsets[2],i=t.width-e-n,r=this._capInsets[1],o=this._capInsets[3],a=t.height-r-o,s=this.slicedData;s.length=0,s[0]=e/t.width,s[1]=r/t.height,s[2]=(e+i)/t.width,s[3]=(r+a)/t.height},L(e,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t)}},{key:"rotated",get:function(){return this._rotated},set:function(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(t){this._atlasUuid=t}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(t){this._isFlipUVX=t,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(t){this._isFlipUVY=t,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(t){this._packable=t}},{key:"original",get:function(){return this._original}}]),e}(Bu),mV.EVENT_UV_UPDATED="uv_updated",dV=vV))||dV);i.SpriteFrame=EV;var CV,wV=t("SpriteAtlas",ol("cc.SpriteAtlas")((bV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"spriteFrames",SV,V(e)),e}F(e,t);var n=e.prototype;return n.getTexture=function(){var t=Object.keys(this.spriteFrames);if(t.length>0){var e=this.spriteFrames[t[0]];return e&&e.texture}return null},n.getSpriteFrame=function(t){var e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null},n.getSpriteFrames=function(){for(var t=[],e=this.spriteFrames,n=0,i=Object.keys(e);n<i.length;n++){var r=i[n];t.push(e[r])}return t},n._serialize=function(){},n._deserialize=function(t,e){var n=t;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=ft();for(var r=0;r<i.length;r+=2)e.result.push(this.spriteFrames,i[r],i[r+1],zt(EV))},e}(Bu),SV=X((xV=bV).prototype,"spriteFrames",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ft()}}),yV=xV))||yV);i.SpriteAtlas=wV;var AV,PV,IV,RV,DV=t("Font",ol("cc.Font")(CV=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Bu))||CV);i.Font=DV;var OV,MV,NV,LV,BV,FV,zV,UV,kV,GV=t("TTFFont",ol("cc.TTFFont")((RV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_fontFamily",IV,V(e)),e}return F(e,t),e.prototype.initDefault=function(e){this._fontFamily="Arial",t.prototype.initDefault.call(this,e)},L(e,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(t){this._fontFamily=t||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:gn(this._native),__isNative__:!0}}}]),e}(DV),IV=X((PV=RV).prototype,"_fontFamily",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(PV.prototype,"_nativeAsset",[Ql,Ul],Object.getOwnPropertyDescriptor(PV.prototype,"_nativeAsset"),PV.prototype),X(PV.prototype,"_nativeDep",[Ql],Object.getOwnPropertyDescriptor(PV.prototype,"_nativeDep"),PV.prototype),AV=PV))||AV);i.TTFFont=GV;var HV,VV=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},jV=function(){function t(t){this.letterDefinitions={},this.texture=t}var e=t.prototype;return e.addLetterDefinitions=function(t,e){this.letterDefinitions[t]=e},e.cloneLetterDefinition=function(){for(var t={},e=0,n=Object.keys(this.letterDefinitions);e<n.length;e++){var i=n[e],r=new VV;Tt(r,this.letterDefinitions[i]),t[i]=r}return t},e.getTexture=function(){return this.texture},e.getLetter=function(t){return this.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t){var e=t.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},e.clear=function(){this.letterDefinitions={}},t}(),WV=t("BitmapFont",(OV=ol("cc.BitmapFont"),MV=kl(EV),OV((kV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"fntDataStr",BV,V(e)),q(e,"spriteFrame",FV,V(e)),q(e,"fontSize",zV,V(e)),q(e,"fntConfig",UV,V(e)),e}return F(e,t),e.prototype.onLoaded=function(){var t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new jV(t.texture));var e=this.fntConfig;if(e){var n=e.fontDefDictionary;for(var i in n){var r=new VV,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else _("The fnt config is not exists!")},e}(DV),BV=X((LV=kV).prototype,"fntDataStr",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),FV=X(LV.prototype,"spriteFrame",[MV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zV=X(LV.prototype,"fontSize",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),UV=X(LV.prototype,"fntConfig",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NV=LV))||NV));i.BitmapFont=WV;var qV=t("LabelAtlas",ol("cc.LabelAtlas")(HV=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(WV))||HV);i.LabelAtlas=qV;var XV=t("BASELINE_RATIO",.26),YV=t("MIDDLE_RATIO",(XV+1)/2-XV);var KV=new Ut(2);KV.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var QV,ZV=new(function(){function t(t){this.count=0,this.limit=0,this.datas={},this.limit=t}var e=t.prototype;return e.moveToHead=function(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t},e.put=function(t,e){var n=KV.get();if(n.key=t,n.value=e,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,KV.put(i)}this.moveToHead(n)},e.remove=function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--},e.get=function(t){var e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null},e.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},e.has=function(t){return!!this.datas[t]},e.delete=function(t){var e=this.datas[t];this.remove(e)},t}())(100),JV=/([a-zA-Z0-9--]+|\S)/,$V=/^[!,.:;'}\]%\?>]/,tj=/([a-zA-Z0-9--]+|\S)$/,ej=/[a-zA-Z0-9--]+$/,nj=/^[a-zA-Z0-9--]/;function ij(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function rj(t){var e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function oj(t,e,n){var i=(n||t.font)+""+e,r=ZV.get(i);if(null!==r)return r;var o=t.measureText(e),a=o&&o.width||0;return ZV.put(i,a),a}function aj(t,e,n){var i=e,r=n,o=t[e];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==e){var a=t[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return t.substring(i,r)}function sj(t,e,n,i){var r=[];if(0===t.length||n<0)return r.push(""),r;for(var o=t;e>n&&o.length>1;){for(var a=o.length*(n/e)|0,s=aj(o,a),c=e-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=e-i(s=aj(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var f=JV.exec(s);u=f?f[0].length:1,l=s}c=e-i(s=aj(o,a+=u))}0==(a-=u)?(a=1,l=aj(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=aj(o,2));var p=aj(o,0,a),_=void 0;$V.test(l||s)&&(0==(a-=(_=tj.exec(p))?_[0].length:0)&&(a=1),l=aj(o,a),p=aj(o,0,a)),nj.test(l)&&(_=ej.exec(p))&&p!==_[0]&&(l=aj(o,a-=_[0].length),p=aj(o,0,a)),(0===r.length||(p=p.trim()).length>0)&&r.push(p),e=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var cj,lj,uj,hj,fj,pj,_j,dj,mj,vj,gj,yj,xj,Sj,bj,Tj=t("CanvasPool",function(){function t(){this.pool=[]}t.getInstance=function(){return QV||(QV=new t),QV};var e=t.prototype;return e.get=function(){var t=this.pool.pop();if(!t){var e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t},e.put=function(t){this.pool.length>=$t.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)},t}()),Ej=di.WHITE.clone(),Cj=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},wj="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",Aj=function(){function t(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}var e=t.prototype;return e.updateRenderData=function(){this._updateProperties(),this._updateTexture()},e.destroy=function(){this.image=null},e._updateProperties=function(){if(this.data=Tj.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var t=oj(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+XV)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*XV/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Fm),this.image.reset(this.canvas)},e._updateTexture=function(){if(this.context&&this.canvas){var t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=wj,t.fillRect(0,0,n,i),t.font=e.fontDesc;var r=e.fontSize,o=n/2,a=i/2+r*YV+0*r,s=e.color;if(t.lineJoin="round",t.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",e.isOutlined){var c=e.out||Ej;t.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",t.lineWidth=2*e.margin,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}},t}(),Pj=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=sm.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new yo;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(cv),Ij=function(){function t(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new Pj;n.initWithSize(t,e),this.fontDefDictionary=new jV(n),this._halfBleed=1,this._width=t,this._height=e,$M.on(JM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var e=t.prototype;return e.insertLetterTexture=function(t){var e=t.image,n=$M.root.device;if(!e||!this.fontDefDictionary||!n)return null;var i=e.width,r=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return E(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;var o=new Cj;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o},e.update=function(){this._dirty&&(this._dirty=!1)},e.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},e.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},e.getTexture=function(){return this.fontDefDictionary.getTexture()},e.beforeSceneLoad=function(){this.clearAllCache()},e.clearAllCache=function(){this.destroy();var t=new Pj;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t},e.getLetter=function(t){return this.fontDefDictionary.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t,e){var n=t.charCodeAt(0)+e.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new Aj(t,e);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},L(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(),Rj={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:di.WHITE.clone(),isOutlined:!1,out:di.WHITE.clone(),margin:0},Dj=cV(oV)>>2,Oj=t("BaseRenderData",function(){function t(t){void 0===t&&(t=oV),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=oV,this._floatStride=t===oV?Dj:cV(t)>>2,this._vertexFormat=t}var e=t.prototype;return e.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},e.resize=function(t,e){if(t!==this._vc||e!==this._ic||!this.chunk){this._vc=t,this._ic=e;var n=$M.root.batcher2D.switchBufferAccessor(this._vertexFormat);this.chunk&&(n.recycleChunk(this.chunk),this.chunk=null),this.chunk=n.allocateChunk(t,e)}},L(t,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),t}()),Mj=t("RenderData",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).vertDirty=!0,e._data=[],e._indices=[],e._pivotX=0,e._pivotY=0,e._width=0,e._height=0,e.frame=void 0,e.layer=0,e.blendHash=-1,e.textureHash=0,e.nodeDirty=!0,e.passDirty=!0,e.textureDirty=!0,e.hashDirty=!0,e}F(e,t),e.add=function(t){void 0===t&&(t=oV);var e=Fj.add();return e._floatStride=t===oV?Dj:cV(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=Fj.data.indexOf(t);-1!==e&&(Fj.data[e].clear(),Fj.removeAt(e))};var n=e.prototype;return n.resize=function(e,n){t.prototype.resize.call(this,e,n),this.updateHash()},n.updateNode=function(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var t=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Da(t,666),this.hashDirty=!1},n.updateRenderData=function(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0,this._vertexFormat=oV},L(e,[{key:"dataLength",get:function(){return this._data.length},set:function(t){var e=this._data;if(e.length!==t){var n=e.length,i=0;for(i=t;i<n;i++)Bj.free(e[i]);for(i=n;i<t;i++)e[i]=Bj.alloc();e.length=t}}},{key:"data",get:function(){return this._data}}]),e}(Oj)),Nj=t("MeshRenderData",function(t){function e(e){var n;return void 0===e&&(e=oV),(n=t.call(this,e)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}F(e,t),e.add=function(t){void 0===t&&(t=oV);var e=zj.add();return e._floatStride=t===oV?Dj:cV(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=zj.data.indexOf(t);-1!==e&&(zj.data[e].clear(),zj.removeAt(e))};var n=e.prototype;return n.request=function(t,e){var n=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=n,!0)},n.reserve=function(t,e){var n=this._byteLength+t*this.stride,i=this.indexCount+e;if(t+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(t,e){var n=t*this.stride;t>=0&&e>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=n,this.updateRange(0,t,0,e)},n.updateRange=function(t,e,n,i){e>=0&&i>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=n,this.vertexRange=e,this.indexRange=i},n.requestIA=function(t){this._initIAInfo(t);var e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,t),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(e);var r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(t){var e=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,r,r))),this._iaInfo=new jo(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Wt((function(){return t.createInputAssembler(e._iaInfo)}),1,(function(t){t.destroy()}))}},n._reallocBuffer=function(t,e){var n=this.vData;this.vData=new Float32Array(t),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(e),i&&this.iData.set(i,0)},L(e,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),e}(Oj)),Lj=t("QuadRenderData",function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n._fillQuadBuffer=function(){for(var t=this.iData.length/6,e=this.iData,n=0,i=0;n<t;n++){var r=4*n;e[i++]=r,e[i++]=r+1,e[i++]=r+2,e[i++]=r+1,e[i++]=r+3,e[i++]=r+2}},n._reallocBuffer=function(e,n){t.prototype._reallocBuffer.call(this,e,n),this._fillQuadBuffer()},e}(Nj)),Bj=new jt((function(){return{x:0,y:0,z:0,u:0,v:0,color:di.WHITE.clone()}}),128),Fj=new Wt((function(){return new Mj}),32),zj=new Wt((function(){return new Nj}),32),Uj=new Bi,kj=new Bi,Gj=new vi,Hj=new Oi,Vj=new Oi,jj=new Oi,Wj=new Oi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),qj=new Wi,Xj=function(e){return t({UITransform:e,UITransformComponent:e}),e}((cj=ol("cc.UITransform"),lj=Sl(),uj=sl(110),hj=vl(),fj=Ol(),pj=wl(),_j=Ol(),dj=wl(),cj(mj=lj(mj=uj(mj=hj(mj=cl(mj=ml((Sj=xj=function(t){function e(){var e;return(e=t.call(this)||this)._priority=0,q(e,"_contentSize",gj,V(e)),q(e,"_anchorPoint",yj,V(e)),e}F(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&e.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(ZT.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(ZT.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(t,e){var n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(ZT.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(t,e){var n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(ZT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(t){for(var e,n=this._contentSize.width,i=this._contentSize.height,r=Uj,o=kj,a=null===(e=this.node)||void 0===e?void 0:e.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(Hj);var u=Hj.m12,h=Hj.m13,f=nN.center;if(Hj.m12=f.x-(Hj.m00*u+Hj.m04*h),Hj.m13=f.y-(Hj.m01*u+Hj.m05*h),Oi.invert(Hj,Hj),Bi.transformMat4(r,t,Hj),this.node.getWorldMatrix(jj),Oi.invert(Hj,jj),!Oi.strictEquals(Hj,Wj)){Bi.transformMat4(o,r,Hj),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var p=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(p=!0,a&&a.maskList))for(var _=a.maskList,d=this.node,m=_?_.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=_[g];if(v===y.index){if(d!==y.comp.node){_.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){p=!1;break}g++}else if(v>y.index){_.length=g;break}}if(p)return!0}}}return!1},n.convertToNodeSpaceAR=function(t,e){return this.node.getWorldMatrix(jj),Oi.invert(Hj,jj),e||(e=new vi),vi.transformMat4(e,t,Hj)},n.convertToWorldSpaceAR=function(t,e){return this.node.getWorldMatrix(jj),e||(e=new vi),vi.transformMat4(e,t,jj)},n.getBoundingBox=function(){Oi.fromRTS(Vj,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,e=this._contentSize.height,n=new Wi(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(Vj),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(jj),this.getBoundingBoxTo(jj)):this.getBoundingBox()},n.getBoundingBoxTo=function(t){Oi.fromRTS(Vj,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Wi(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Oi.multiply(jj,t,Vj),r.transformMat4(jj),!this.node.children)return r;for(var o,a=W(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(e);if(c){var l=c.getBoundingBoxTo(t);l&&Wi.union(r,r,l)}}}return r},n.getComputeAABB=function(t){var e=this._contentSize.width,n=this._contentSize.height;qj.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),qj.transformMat4(this.node.worldMatrix);var i=qj.x+.5*qj.width,r=qj.y+.5*qj.height,o=this.node.worldPosition.z,a=qj.width/2,s=qj.height/2;return null!=t?(Bc.set(t,i,r,o,a,s,.001),t):new Bc(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))},n.checkAndUpdateRect=function(t,e){if(this._rectDirty){this._rectWithScale.x=e.x*this.width,this._rectWithScale.y=e.y*this.height,this._rectWithScale.z=e.z;var n=(.5-this.anchorPoint.x)*this.width*e.x,i=(.5-this.anchorPoint.y)*this.height*e.y;vi.transformQuat(this._anchorCache,Gj.set(n,i,0),t)}},n.setRectDirty=function(t){t&eg.RS&&(this._rectDirty=!0)},e.insertChangeMap=function(t){var n=t.uuid;e.priorityChangeNodeMap.has(n)||e.priorityChangeNodeMap.set(n,t)},e._sortChildrenSibling=function(t){var e=t.children;e&&e.sort((function(t,e){var n=t._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))},e._sortSiblings=function(){e.priorityChangeNodeMap.forEach((function(t){e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()},e._cleanChangeMap=function(){e.priorityChangeNodeMap.clear()},L(e,[{key:"contentSize",get:function(){return this._contentSize},set:function(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(ZT.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(ZT.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(ZT.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(ZT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(ZT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(ZT.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?E(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var t=$M.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}},{key:"cameraPriority",get:function(){var t=$M.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}}]),e}(ih),xj.EventType=ZT,xj.priorityChangeNodeMap=new Map,X((vj=Sj).prototype,"contentSize",[fj,pj],Object.getOwnPropertyDescriptor(vj.prototype,"contentSize"),vj.prototype),X(vj.prototype,"anchorPoint",[_j,dj],Object.getOwnPropertyDescriptor(vj.prototype,"anchorPoint"),vj.prototype),gj=X(vj.prototype,"_contentSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi(100,100)}}),yj=X(vj.prototype,"_anchorPoint",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(.5,.5)}}),mj=vj))||mj)||mj)||mj)||mj)||mj)||mj));$M.on(JM.EVENT_AFTER_UPDATE,Xj._sortSiblings),$M.on(JM.EVENT_BEFORE_SCENE_LAUNCH,Xj._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(bj||(bj={}));var Yj,Kj,Qj,Zj,Jj,$j,tW,eW,nW,iW,rW,oW,aW,sW,cW,lW,uW,hW,fW,pW,_W=t("StencilManager",function(){function t(){this.stage=bj.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Fr.ALWAYS,stencilMask:65535,writeMask:65535,failOp:zr.KEEP,zFailOp:zr.KEEP,passOp:zr.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var e=t.prototype;return e.pushMask=function(t){this._maskStack.push(t)},e.clear=function(t){t.stencilStage=t.inverted?bj.CLEAR_INVERTED:bj.CLEAR},e.enterLevel=function(t){t.graphics.stencilStage=t.inverted?bj.ENTER_LEVEL_INVERTED:bj.ENTER_LEVEL},e.enableMask=function(){this.stage=bj.ENABLED},e.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=bj.DISABLED:this.stage=bj.ENABLED)},e.getWriteMask=function(){return 1<<this._maskStack.length-1},e.getExitWriteMask=function(){return 1<<this._maskStack.length},e.getStencilRef=function(){for(var t=0,e=0;e<this._maskStack.length;++e)t+=1<<e;return t},e.reset=function(){this._maskStack.length=0,this.stage=bj.DISABLED},e.destroy=function(){this.stencilStateMap.forEach((function(t){t.destroy()})),this.stencilStateMap.clear()},e.getStencilStage=function(t,e){var n=0,i=!1,r=!1,o=Fr.LESS,a=this.stencilStateMap;if(e&&e.passes[0]){var s=e.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|t<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(t);var u=new Fa(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},e.getStencilHash=function(t){return t<<8|this._maskStack.length},e.setStateFromStage=function(t){var e=this._stencilPattern;t===bj.DISABLED?(e.stencilTest=!1,e.func=Fr.ALWAYS,e.failOp=zr.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===bj.ENABLED?(e.func=Fr.EQUAL,e.failOp=zr.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===bj.CLEAR?(e.func=Fr.NEVER,e.failOp=zr.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===bj.CLEAR_INVERTED||t===bj.ENTER_LEVEL?(e.func=Fr.NEVER,e.failOp=zr.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===bj.ENTER_LEVEL_INVERTED&&(e.func=Fr.NEVER,e.failOp=zr.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))},L(t,[{key:"pattern",get:function(){return this._stencilPattern}}]),t}());_W.sharedManager=null,_W.sharedManager=new _W,Zt(Ur),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(pW||(pW=t("InstanceMaterialType",{})));var dW,mW,vW,gW,yW,xW,SW,bW,TW,EW,CW,wW,AW,PW,IW,RW,DW,OW,MW,NW,LW,BW,FW,zW,UW,kW,GW,HW,VW,jW,WW,qW,XW,YW,KW,QW,ZW,JW,$W,tq,eq,nq,iq,rq,oq,aq,sq,cq,lq,uq,hq,fq,pq,_q,dq,mq,vq,gq,yq,xq,Sq,bq,Tq,Eq,Cq,wq,Aq,Pq,Iq,Rq,Dq=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((Yj=ol("cc.Renderable2D"),Kj=al(Xj),Qj=Tl(),Zj=kl(Og),Jj=kl(Og),$j=Ol(),tW=wl(),eW=Cl(),nW=Ol(),iW=wl(),Yj(rW=Kj(rW=cl(rW=ml((fW=hW=function(t){function e(){var e;return q(e=t.call(this)||this,"_materials",aW,V(e)),q(e,"_customMaterial",sW,V(e)),e.stencilStage=bj.DISABLED,q(e,"_srcBlendFactor",cW,V(e)),q(e,"_dstBlendFactor",lW,V(e)),q(e,"_color",uW,V(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new Ua,e._blendHash=0,e._lastParent=null,e}F(e,t);var n=e.prototype;return n.updateBlendHash=function(){var t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(ZT.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(ZT.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(ZT.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(ZT.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var t=0;t<this._materialInstances.length;t++){var e=this._materialInstances[t];e&&e.destroy()}this._renderData=null,this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(t){if(void 0===t&&(t=!0),this._renderFlag=this._canRender(),t&&this._renderFlag){var e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)},n.requestRenderData=function(){var t=Mj.add();return this._renderData=t,t},n.destroyRenderData=function(){this._renderData&&(Mj.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(t){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1),this._renderFlag&&this._render(t)},n.postUpdateAssembler=function(t){this._postAssembler&&this._renderFlag&&this._postRender(t)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var t=this._blendState.targets[0];t||(t=new za,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Ur.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var t=0;t<this.node.children.length;++t){var n=this.node.children[t].getComponent(e);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(e,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),t.prototype._onMaterialModified.call(this,e,n)},n._updateBuiltinMaterial=function(){var t;switch(this._instanceMaterialType){case pW.ADD_COLOR:t=Gv.get("ui-base-material");break;case pW.GRAYSCALE:t=Gv.get("ui-sprite-gray-material");break;case pW.USE_ALPHA_SEPARATED:t=Gv.get("ui-sprite-alpha-sep-material");break;case pW.USE_ALPHA_SEPARATED_AND_GRAY:t=Gv.get("ui-sprite-gray-alpha-sep-material");break;default:t=Gv.get("ui-sprite-material")}return t},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},L(e,[{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&E(12001),this._srcBlendFactor},set:function(t){this._customMaterial?E(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&E(12001),this._dstBlendFactor},set:function(t){this._customMaterial?E(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(t){this._delegateSrc=t}},{key:"blendHash",get:function(){return this._blendHash}}]),e}(TF),hW.BlendState=Ur,hW.Assembler=null,hW.PostAssembler=null,aW=X((oW=fW).prototype,"_materials",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(oW.prototype,"sharedMaterials",[Ql,Qj],Object.getOwnPropertyDescriptor(oW.prototype,"sharedMaterials"),oW.prototype),sW=X(oW.prototype,"_customMaterial",[Zj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(oW.prototype,"customMaterial",[Jj,$j,tW,eW],Object.getOwnPropertyDescriptor(oW.prototype,"customMaterial"),oW.prototype),X(oW.prototype,"color",[nW,iW],Object.getOwnPropertyDescriptor(oW.prototype,"color"),oW.prototype),cW=X(oW.prototype,"_srcBlendFactor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ur.SRC_ALPHA}}),lW=X(oW.prototype,"_dstBlendFactor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ur.ONE_MINUS_SRC_ALPHA}}),uW=X(oW.prototype,"_color",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),rW=oW))||rW)||rW)||rW)||rW));i.internal.Renderable2D=Dq,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(Aq||(Aq=t("HorizontalTextAlignment",{}))),Zt(Aq),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(Pq||(Pq=t("VerticalTextAlignment",{}))),Zt(Pq),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(Iq||(Iq=t("Overflow",{}))),Zt(Iq),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(Rq||(Rq=t("CacheMode",{}))),Zt(Rq);var Oq,Mq,Nq,Lq=function(e){return t({Label:e,LabelComponent:e}),e}((dW=ol("cc.Label"),mW=Sl(),vW=sl(110),gW=vl(),yW=Ol(),xW=wl(),SW=kl(Aq),bW=Ol(),TW=wl(),EW=kl(Pq),CW=Ol(),wW=wl(),AW=Ol(),PW=wl(),IW=Ol(),RW=Tl(),DW=wl(),OW=Ol(),MW=wl(),NW=Tl(),LW=Ol(),BW=wl(),FW=kl(Iq),zW=Ol(),UW=wl(),kW=Ol(),GW=wl(),HW=kl(DV),VW=Ol(),jW=Tl(),WW=wl(),qW=Ol(),XW=wl(),YW=kl(Rq),KW=Ol(),QW=wl(),ZW=Ol(),JW=wl(),$W=Ol(),tq=wl(),eq=Ol(),nq=wl(),iq=Tl(),rq=Ol(),oq=wl(),dW(aq=mW(aq=vW(aq=gW((wq=Cq=function(t){function e(){var e;return q(e=t.call(this)||this,"_string",cq,V(e)),q(e,"_horizontalAlign",lq,V(e)),q(e,"_verticalAlign",uq,V(e)),q(e,"_actualFontSize",hq,V(e)),q(e,"_fontSize",fq,V(e)),q(e,"_fontFamily",pq,V(e)),q(e,"_lineHeight",_q,V(e)),q(e,"_overflow",dq,V(e)),q(e,"_enableWrapText",mq,V(e)),q(e,"_font",vq,V(e)),q(e,"_isSystemFontUsed",gq,V(e)),q(e,"_spacingX",yq,V(e)),q(e,"_isItalic",xq,V(e)),q(e,"_isBold",Sq,V(e)),q(e,"_isUnderline",bq,V(e)),q(e,"_underlineHeight",Tq,V(e)),q(e,"_cacheMode",Eq,V(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var n=e;n.image&&n.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,t.prototype.onDestroy.call(this)},n.updateRenderData=function(t){void 0===t&&(t=!1),this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){t.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!t.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof WV){var n=e.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var t=this._font;if(t instanceof WV){var e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===Rq.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new EV,this._assemblerData=this._assembler.getAssemblerData();var n=new Fm(this._assemblerData.canvas),i=new cv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==Rq.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var t=!1;if(this.cacheMode!==Rq.CHAR){var e=this._texture.texture;if(e instanceof Um){var n=e.getPixelFormat();t=n===sm.RGBA_ETC1||n===sm.RGB_A_PVRTC_4BPPV1||n===sm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?pW.USE_ALPHA_SEPARATED:pW.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},L(e,[{key:"string",get:function(){return this._string},set:function(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(t){this._actualFontSize=t}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode!==Rq.BITMAP||this._font instanceof WV||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===Rq.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(t){this._fontAtlas=t}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof WV?this._font.fontSize:-1}}]),e}(Dq),Cq.HorizontalAlign=Aq,Cq.VerticalAlign=Pq,Cq.Overflow=Iq,Cq.CacheMode=Rq,Cq._canvasPool=Tj.getInstance(),X((sq=wq).prototype,"string",[yW,xW,Nl],Object.getOwnPropertyDescriptor(sq.prototype,"string"),sq.prototype),X(sq.prototype,"horizontalAlign",[SW,bW,TW],Object.getOwnPropertyDescriptor(sq.prototype,"horizontalAlign"),sq.prototype),X(sq.prototype,"verticalAlign",[EW,CW,wW],Object.getOwnPropertyDescriptor(sq.prototype,"verticalAlign"),sq.prototype),X(sq.prototype,"fontSize",[AW,PW],Object.getOwnPropertyDescriptor(sq.prototype,"fontSize"),sq.prototype),X(sq.prototype,"fontFamily",[IW,RW,DW],Object.getOwnPropertyDescriptor(sq.prototype,"fontFamily"),sq.prototype),X(sq.prototype,"lineHeight",[OW,MW],Object.getOwnPropertyDescriptor(sq.prototype,"lineHeight"),sq.prototype),X(sq.prototype,"spacingX",[NW,LW,BW],Object.getOwnPropertyDescriptor(sq.prototype,"spacingX"),sq.prototype),X(sq.prototype,"overflow",[FW,zW,UW],Object.getOwnPropertyDescriptor(sq.prototype,"overflow"),sq.prototype),X(sq.prototype,"enableWrapText",[kW,GW],Object.getOwnPropertyDescriptor(sq.prototype,"enableWrapText"),sq.prototype),X(sq.prototype,"font",[HW,VW,jW,WW],Object.getOwnPropertyDescriptor(sq.prototype,"font"),sq.prototype),X(sq.prototype,"useSystemFont",[qW,XW],Object.getOwnPropertyDescriptor(sq.prototype,"useSystemFont"),sq.prototype),X(sq.prototype,"cacheMode",[YW,KW,QW],Object.getOwnPropertyDescriptor(sq.prototype,"cacheMode"),sq.prototype),X(sq.prototype,"isBold",[ZW,JW],Object.getOwnPropertyDescriptor(sq.prototype,"isBold"),sq.prototype),X(sq.prototype,"isItalic",[$W,tq],Object.getOwnPropertyDescriptor(sq.prototype,"isItalic"),sq.prototype),X(sq.prototype,"isUnderline",[eq,nq],Object.getOwnPropertyDescriptor(sq.prototype,"isUnderline"),sq.prototype),X(sq.prototype,"underlineHeight",[iq,bl,rq,oq],Object.getOwnPropertyDescriptor(sq.prototype,"underlineHeight"),sq.prototype),cq=X(sq.prototype,"_string",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),lq=X(sq.prototype,"_horizontalAlign",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aq.CENTER}}),uq=X(sq.prototype,"_verticalAlign",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pq.CENTER}}),hq=X(sq.prototype,"_actualFontSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fq=X(sq.prototype,"_fontSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),pq=X(sq.prototype,"_fontFamily",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),_q=X(sq.prototype,"_lineHeight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),dq=X(sq.prototype,"_overflow",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iq.NONE}}),mq=X(sq.prototype,"_enableWrapText",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vq=X(sq.prototype,"_font",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gq=X(sq.prototype,"_isSystemFontUsed",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yq=X(sq.prototype,"_spacingX",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xq=X(sq.prototype,"_isItalic",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sq=X(sq.prototype,"_isBold",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bq=X(sq.prototype,"_isUnderline",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Tq=X(sq.prototype,"_underlineHeight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Eq=X(sq.prototype,"_cacheMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rq.NONE}}),aq=sq))||aq)||aq)||aq)||aq));!function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(Oq||(Oq={})),Zt(Oq),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(Mq||(Mq={})),Zt(Mq),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(Nq||(Nq={})),Zt(Nq);var Bq=Math.PI,Fq=Math.min,zq=Math.max,Uq=Math.cos,kq=Math.sin,Gq=Math.abs,Hq=Math.sign,Vq=.5522847493;function jq(t,e,n,i,r){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+r*Vq,e-i*Vq,n+r,e,n+r),t.bezierCurveTo(e+i*Vq,n+r,e+i,n+r*Vq,e+i,n),t.bezierCurveTo(e+i,n-r*Vq,e+i*Vq,n-r,e,n-r),t.bezierCurveTo(e-i*Vq,n-r,e-i,n-r*Vq,e-i,n),t.close()}function Wq(t,e,n,i,r,o,a,s,c,l,u){var h,f,p,_,d,m,v,g,y,x,S,b,T,E,C,w;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(e+i))+(p=.5*(i+o))),g=.5*((f=.5*(n+r))+(_=.5*(r+a))),((C=Gq((i-s)*(E=c-n)-(r-c)*(T=s-e)))+(w=Gq((o-s)*E-(a-c)*T)))*(C+w)<t.tessTol*(T*T+E*E)?t.addPoint(s,c,0===u?u|Nq.PT_BEVEL:u):(Wq(t,e,n,h,f,v,g,S=.5*(v+(y=.5*(p+d))),b=.5*(g+(x=.5*(_+m))),l+1,0),Wq(t,S,b,y,x,d,m,s,c,l+1,u)))}var qq,Xq,Yq,Kq,Qq,Zq,Jq,$q,tX,eX,nX,iX,rX,oX,aX,sX,cX,lX,uX,hX,fX,pX,_X,dX,mX,vX,gX,yX,xX,SX,bX,TX,EX,CX,wX,AX,PX,IX,RX,DX,OX,MX,NX,LX,BX,FX,zX,UX,kX,GX=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return F(e,t),e.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},e}(Bi),HX=function(){function t(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return t.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t}(),VX=function(){function t(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=di.WHITE.clone(),this.lineCap=Oq.BUTT,this.strokeColor=di.BLACK.clone(),this.lineJoin=Mq.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var e=t.prototype;return e.moveTo=function(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,Nq.PT_CORNER),this._commandX=t,this._commandY=e},e.lineTo=function(t,e){this.addPoint(t,e,Nq.PT_CORNER),this._commandX=t,this._commandY=e},e.bezierCurveTo=function(t,e,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==t||s.y!==e||n!==r||i!==o?(Wq(this,s.x,s.y,t,e,n,i,r,o,0,Nq.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},e.quadraticCurveTo=function(t,e,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(t-r),o+2/3*(e-o),n+2/3*(t-n),i+2/3*(e-i),n,i)},e.arc=function(t,e,n,i,r,o){!function(t,e,n,i,r,o,a){var s,c,l=0,u=0,h=0,f=0,p=0,_=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,b=0;if(u=o-r,a=a||!1)if(Gq(u)>=2*Bq)u=2*Bq;else for(;u<0;)u+=2*Bq;else if(Gq(u)>=2*Bq)u=2*-Bq;else for(;u>0;)u-=2*Bq;for(c=0|zq(1,Fq(Gq(u)/(.5*Bq)+.5,5)),h=Gq(4/3*(1-Uq(s=u/c/2))/kq(s)),a||(h=-h),b=0;b<=c;b++)_=e+(f=Uq(l=r+u*(b/c)))*i,d=n+(p=kq(l))*i,m=-p*i*h,v=f*i*h,0===b?t.moveTo(_,d):t.bezierCurveTo(g+x,y+S,_-m,d-v,_,d),g=_,y=d,x=m,S=v}(this,t,e,n,i,r,o)},e.ellipse=function(t,e,n,i){jq(this,t,e,n,i),this._curPath.complex=!1},e.circle=function(t,e,n){jq(this,t,e,n,n),this._curPath.complex=!1},e.rect=function(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1},e.roundRect=function(t,e,n,i,r){!function(t,e,n,i,r,o){if(o<.1)t.rect(e,n,i,r);else{var a=Fq(o,.5*Gq(i))*Hq(i),s=Fq(o,.5*Gq(r))*Hq(r);t.moveTo(e,n+s),t.lineTo(e,n+r-s),t.bezierCurveTo(e,n+r-s*(1-Vq),e+a*(1-Vq),n+r,e+a,n+r),t.lineTo(e+i-a,n+r),t.bezierCurveTo(e+i-a*(1-Vq),n+r,e+i,n+r-s*(1-Vq),e+i,n+r-s),t.lineTo(e+i,n+s),t.bezierCurveTo(e+i,n+s*(1-Vq),e+i-a*(1-Vq),n,e+i-a,n),t.lineTo(e+a,n),t.bezierCurveTo(e+a*(1-Vq),n,e,n+s*(1-Vq),e,n+s),t.close()}}(this,t,e,n,i,r),this._curPath.complex=!1},e.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,e=0,n=t.length;e<n;e++){var i=t[e];i&&Nj.remove(i)}this._renderDataList.length=0},e.close=function(){this._curPath.closed=!0},e.requestRenderData=function(){var t=Nj.add();return this._renderDataList.push(t),t},e.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},e.addPoint=function(t,e,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=t,a.y=e):(a=new GX(t,e),r.push(a)),a.flags=n,o.push(a)}},e._addPath=function(){var t=this.pathLength,e=this.paths[t];return e?e.reset():(e=new HX,this.paths.push(e)),this.pathLength++,this._curPath=e,e},t}(),jX=rV.concat([new Ho("a_dist",Tr.R32F)]),WX=sV(jX),qX=cV(jX),XX=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((qq=ol("cc.Graphics"),Xq=Sl(),Yq=sl(110),Kq=vl(),Qq=wl(),Zq=kl(Mq),Jq=wl(),$q=kl(Oq),tX=wl(),eX=wl(),nX=wl(),iX=wl(),rX=Tl(),qq(oX=Xq(oX=Yq(oX=Kq((_X=pX=function(t){function e(){var e;return(e=t.call(this)||this).impl=null,e.model=null,q(e,"_lineWidth",sX,V(e)),q(e,"_strokeColor",cX,V(e)),q(e,"_lineJoin",lX,V(e)),q(e,"_lineCap",uX,V(e)),q(e,"_fillColor",hX,V(e)),q(e,"_miterLimit",fX,V(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=pW.ADD_COLOR,e.impl=new VX,e}F(e,t);var n=e.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=$M.root.createModel(rg),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){t.prototype.onDisable.call(this)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this._sceneGetter=null,this.model&&($M.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var n=0;n<e;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)},n.moveTo=function(t,e){this.impl&&this.impl.moveTo(t,e)},n.lineTo=function(t,e){this.impl&&this.impl.lineTo(t,e)},n.bezierCurveTo=function(t,e,n,i,r,o){this.impl&&this.impl.bezierCurveTo(t,e,n,i,r,o)},n.quadraticCurveTo=function(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)},n.arc=function(t,e,n,i,r,o){this.impl&&this.impl.arc(t,e,n,i,r,o)},n.ellipse=function(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)},n.circle=function(t,e,n){this.impl&&this.impl.circle(t,e,n)},n.rect=function(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)},n.roundRect=function(t,e,n,i,r){this.impl&&this.impl.roundRect(t,e,n,i,r)},n.fillRect=function(t,e,n,i){this.rect(t,e,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var t;this._customMaterial?t=this.getMaterialInstance(0):(t=Gv.get("ui-graphics-material"),this.setMaterial(t,0),(t=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(t){if(this.model){if(this.model.subModels.length<=t){var e=i.director.root.device,n=e.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,65535*qX,qX)),r=e.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new Qw([n],jX,Yr.TRIANGLE_LIST,r);o.subMeshIdx=0,this.model.initSubModel(t,o,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(o)}}else E(4500,this.node.name)},n._uploadData=function(){var t=this.impl;if(t){var e=t&&t.getRenderDataList();if(!(e.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<e.length;i++){var r=e[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*WX);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(t){if(this._isNeedUploadData){if(this.impl){var e=this.impl.getRenderDataList(),n=this.model.subModels.length;if(e.length>n)for(var i=n;i<e.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)},n._canRender=function(){return!!t.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},L(e,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}},{key:"lineCap",get:function(){return this._lineCap},set:function(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(t){this._miterLimit=t}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),e}(Dq),pX.LineJoin=Mq,pX.LineCap=Oq,X((aX=_X).prototype,"lineWidth",[bl,Qq],Object.getOwnPropertyDescriptor(aX.prototype,"lineWidth"),aX.prototype),X(aX.prototype,"lineJoin",[Zq,Jq],Object.getOwnPropertyDescriptor(aX.prototype,"lineJoin"),aX.prototype),X(aX.prototype,"lineCap",[$q,tX],Object.getOwnPropertyDescriptor(aX.prototype,"lineCap"),aX.prototype),X(aX.prototype,"strokeColor",[eX],Object.getOwnPropertyDescriptor(aX.prototype,"strokeColor"),aX.prototype),X(aX.prototype,"fillColor",[nX],Object.getOwnPropertyDescriptor(aX.prototype,"fillColor"),aX.prototype),X(aX.prototype,"miterLimit",[iX],Object.getOwnPropertyDescriptor(aX.prototype,"miterLimit"),aX.prototype),X(aX.prototype,"color",[Ql,rX],Object.getOwnPropertyDescriptor(aX.prototype,"color"),aX.prototype),sX=X(aX.prototype,"_lineWidth",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cX=X(aX.prototype,"_strokeColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.BLACK.clone()}}),lX=X(aX.prototype,"_lineJoin",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mq.MITER}}),uX=X(aX.prototype,"_lineCap",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oq.BUTT}}),hX=X(aX.prototype,"_fillColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),fX=X(aX.prototype,"_miterLimit",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),oX=aX))||oX)||oX)||oX)||oX)),YX=new Oi,KX=new Bi,QX=new Oi,ZX=[];!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(kX||(kX={})),Zt(kX);var JX=function(e){return t({Mask:e,MaskComponent:e}),e}((dX=ol("cc.Mask"),mX=Sl(),vX=sl(110),gX=vl(),yX=kl(kX),xX=Ol(),SX=wl(),bX=Ol(),TX=wl(),EX=Tl(),CX=kl(EV),wX=Tl(),AX=Tl(),PX=Al(),IX=Tl(),RX=Tl(),dX(DX=mX(DX=vX(DX=gX((UX=zX=function(t){function e(){var e;return(e=t.call(this)||this)._clearStencilMtl=null,e._clearModel=null,q(e,"_type",MX,V(e)),q(e,"_inverted",NX,V(e)),q(e,"_segments",LX,V(e)),q(e,"_spriteFrame",BX,V(e)),q(e,"_alphaThreshold",FX,V(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=pW.ADD_COLOR,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),t.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){t.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){t.prototype.onDestroy.call(this),this._clearModel&&this._clearModelMesh&&($M.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()},n.isHit=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,r=n.height,o=KX;this.node.getWorldMatrix(YX),Oi.invert(QX,YX),Bi.transformMat4(o,t,QX);var a=e.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===kX.RECT||this.type===kX.GRAPHICS_STENCIL||this.type===kX.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===kX.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(t){t.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(e){t.prototype._nodeStateChange.call(this,e),this._updateGraphics()},n._canRender=function(){return!!t.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==kX.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this),n=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var t=this._graphics=new XX;t._objFlags|=Ye.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;var e=di.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===kX.RECT||this._type===kX.ELLIPSE)){var t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();var n=t.contentSize,i=n.width,r=n.height,o=t.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===kX.RECT)e.rect(a,s,i,r);else if(this._type===kX.ELLIPSE){for(var c=function(t,e,n){ZX.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)ZX.push(new vi(e.x*Math.cos(i*r)+t.x,e.y*Math.sin(i*r)+t.y,0));return ZX}(new vi(a+i/2,s+r/2,0),new vi(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?e.moveTo(u.x,u.y):e.lineTo(u.x,u.y)}e.close()}e.fill()}},n._createClearModel=function(){if(!this._clearModel){var t=Gv.get("default-clear-stencil");this._clearStencilMtl=new Yg({parent:t,owner:this,subModelIdx:0}),this._clearModel=$M.root.createModel(rg),this._clearModel.node=this._clearModel.transform=this.node;var e=cV(iV),n=i.director.root.device,r=n.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,4*e,e)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(o);var a=n.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);a.update(s),this._clearModelMesh=new Qw([r],iV,Yr.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var t,e=this._graphics;e.stencilStage=bj.DISABLED,this._type===kX.IMAGE_STENCIL?(t=Gv.get("ui-alpha-test-material"),e.setMaterial(t,0),(t=e.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(t=Gv.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==kX.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},L(e,[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==kX.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(t){this._inverted=t,this.stencilStage=bj.DISABLED,this._graphics&&(this._graphics.stencilStage=bj.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(t){this._segments!==t&&(this._segments=Qn(t,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this._type===kX.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===kX.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),e}(Dq),zX.Type=kX,X((OX=UX).prototype,"type",[yX,xX,SX],Object.getOwnPropertyDescriptor(OX.prototype,"type"),OX.prototype),X(OX.prototype,"inverted",[bX,TX],Object.getOwnPropertyDescriptor(OX.prototype,"inverted"),OX.prototype),X(OX.prototype,"segments",[EX],Object.getOwnPropertyDescriptor(OX.prototype,"segments"),OX.prototype),X(OX.prototype,"spriteFrame",[CX,wX],Object.getOwnPropertyDescriptor(OX.prototype,"spriteFrame"),OX.prototype),X(OX.prototype,"alphaThreshold",[AX,PX,Dl],Object.getOwnPropertyDescriptor(OX.prototype,"alphaThreshold"),OX.prototype),X(OX.prototype,"color",[Ql,IX],Object.getOwnPropertyDescriptor(OX.prototype,"color"),OX.prototype),X(OX.prototype,"customMaterial",[Ql,RX],Object.getOwnPropertyDescriptor(OX.prototype,"customMaterial"),OX.prototype),MX=X(OX.prototype,"_type",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kX.RECT}}),NX=X(OX.prototype,"_inverted",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LX=X(OX.prototype,"_segments",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),BX=X(OX.prototype,"_spriteFrame",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FX=X(OX.prototype,"_alphaThreshold",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),DX=OX))||DX)||DX)||DX)||DX));FR._maskComp=JX,i.Mask=JX;var $X,tY,eY,nY,iY,rY,oY,aY,sY,cY,lY,uY,hY,fY,pY,_Y,dY,mY,vY,gY,yY,xY,SY,bY,TY,EY,CY,wY,AY,PY,IY,RY,DY,OY,MY,NY,LY,BY,FY,zY,UY,kY,GY,HY,VY,jY,WY,qY,XY,YY,KY,QY,ZY,JY,$Y,tK,eK,nK,iK,rK,oK=/^(click)(\s)*=|(param)(\s)*=/,aK=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,sK=t("HtmlTextParser",function(){function t(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var e=t.prototype;return e.parse=function(t){this._resultObjectArray.length=0,this._stack.length=0;for(var e=0,n=t.length;e<n;){var i=t.indexOf(">",e),r=-1;if(i>=0&&(r=t.lastIndexOf("<",i))<e-1&&(r=t.indexOf("<",i+1),i=t.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{var o=t.substring(e,r),a=t.substring(r+1,i);""===a&&(o=t.substring(e,i+1)),this._processResult(o),-1===i?i=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(a),e=i+1}}return this._resultObjectArray},e._attributeToObject=function(t){t=t.trim();var e={},n=/^(color|size)(\s)*=/.exec(t),i="",r=0,o="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(r=t.indexOf(" "),i[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(o=t.substring(r+1).trim(),e.event=this._processEventHandler(o)),e}if((n=/^(br(\s)*\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=aK.exec(t);for(var c=!1;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}e.isImage=!0,e.src=s}else if("height"===i)e.imageHeight=parseInt(s);else if("width"===i)e.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}e.imageAlign=s.toLowerCase()}else"offset"===i?e.imageOffset=s:"click"===i&&(e.event=this._processEventHandler(i+"="+s));e.event&&"param"===i&&(e.event[i]=s.replace(/^"|"$/g,"")),n=aK.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t)){var l={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),"click"===i?e.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),e.event&&"param"===i&&(e.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(t)}e.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(t))&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e},e._processEventHandler=function(t){for(var e={},n=0,i=!1,r=oK.exec(t);r;){var o=r[0],a="";if(i=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))(n=t.indexOf('"',1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))(n=t.indexOf("'",1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(t);n=(a=s?s[0]:"").length}i&&(e[o=o.substring(0,o.length-1).trim()]=a),t=t.substring(n).trim(),r=oK.exec(t)}return e},e._addToStack=function(t){var e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)e[i]||(e[i]=n[i]);this._stack.push(e)}},e._processResult=function(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))},e._escapeSpecialSymbol=function(t){for(var e,n=W(this._specialSymbolArray);!(e=n()).done;){var i=e.value,r=i[0],o=i[1];t=t.replace(r,o)}return t},t}()),cK=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}(($X=ol("cc.LabelOutline"),tY=Sl(),eY=sl(110),nY=vl(),iY=al(Lq),rY=wl(),oY=wl(),$X(aY=tY(aY=eY(aY=nY(aY=iY(aY=ml((uY=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_color",cY,V(e)),q(e,"_width",lY,V(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(Lq);t&&t.updateRenderData(!0)},L(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this._updateRenderData())}}]),e}(ih),cY=X((sY=uY).prototype,"_color",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(0,0,0,255)}}),lY=X(sY.prototype,"_width",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(sY.prototype,"color",[rY],Object.getOwnPropertyDescriptor(sY.prototype,"color"),sY.prototype),X(sY.prototype,"width",[oY],Object.getOwnPropertyDescriptor(sY.prototype,"width"),sY.prototype),aY=sY))||aY)||aY)||aY)||aY)||aY)||aY));!function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(eK||(eK={})),Zt(eK),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(nK||(nK={})),Zt(nK),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(iK||(iK={})),Zt(iK),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(rK||(rK={}));var lK,uK,hK,fK,pK,_K,dK,mK,vK,gK,yK,xK,SK,bK,TK,EK,CK,wK,AK,PK,IK,RK,DK,OK,MK,NK,LK,BK,FK,zK,UK,kK,GK,HK,VK,jK,WK,qK,XK,YK,KK,QK,ZK,JK,$K,tQ,eQ,nQ,iQ,rQ=function(e){return t({Sprite:e,SpriteComponent:e}),e}((hY=ol("cc.Sprite"),fY=Sl(),pY=sl(110),_Y=vl(),dY=kl(Og),mY=Ol(),vY=Cl(),gY=kl(wV),yY=Ol(),xY=wl(),SY=kl(EV),bY=Ol(),TY=wl(),EY=kl(eK),CY=Ol(),wY=wl(),AY=kl(nK),PY=wl(),IY=wl(),RY=Al(),DY=wl(),OY=Al(),MY=wl(),NY=Tl(),LY=Ol(),BY=wl(),FY=wl(),zY=kl(iK),UY=Ol(),kY=wl(),hY(GY=fY(GY=pY(GY=_Y((tK=$Y=function(t){function e(){var e;return q(e=t.call(this)||this,"_spriteFrame",VY,V(e)),q(e,"_type",jY,V(e)),q(e,"_fillType",WY,V(e)),q(e,"_sizeMode",qY,V(e)),q(e,"_fillCenter",XY,V(e)),q(e,"_fillStart",YY,V(e)),q(e,"_fillRange",KY,V(e)),q(e,"_isTrimmedMode",QY,V(e)),q(e,"_useGrayscale",ZY,V(e)),q(e,"_atlas",JY,V(e)),e}F(e,t);var n=e.prototype;return n.__preload=function(){this.changeMaterialForDefine(),t.prototype.__preload.call(this)},n.onEnable=function(){t.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===eK.SLICED&&e.on(EV.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===eK.SLICED&&this._spriteFrame.off(EV.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){this.destroyRenderData(),t.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(t){if(this._atlas){var e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var t,e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);var n=!1;if(t instanceof Um){var i=t.getPixelFormat();n=i===sm.RGBA_ETC1||i===sm.RGB_A_PVRTC_4BPPV1||i===sm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=pW.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=pW.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=pW.GRAYSCALE:this._instanceMaterialType=pW.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var e=t.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof Eb){var n=B({SAMPLE_FROM_RT:!0},e.passes[0].defines),i=new Og;i.initialize({effectAsset:e.effectAsset,defines:n}),e=i}return e},n._render=function(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!t.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===eK.SLICED?this._spriteFrame.on(EV.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(EV.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(iK.RAW===this._sizeMode){var t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(iK.TRIMMED===this._sizeMode){var e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(t){var e=this._spriteFrame;t&&this._type===eK.SLICED&&t.off(EV.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;e&&(t&&t.texture===e.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===eK.SLICED&&e.on(EV.EVENT_UV_UPDATED,this._updateUVs,this))},n._calculateSlicedData=function(t){var e=this.node._uiProps.uiTransformComp.contentSize,n=e.width,i=e.height,r=this.spriteFrame.insetLeft,o=n-r-this.spriteFrame.insetRight,a=this.spriteFrame.insetTop,s=i-a-this.spriteFrame.insetBottom;return t.length=0,t[0]=r/n,t[1]=a/i,t[2]=(r+o)/n,t[3]=(a+s)/i,t},n.calculateTiledData=function(t){var e=this.node._uiProps.uiTransformComp.contentSize,n=this.spriteFrame.rect;t.x=e.width/n.width,t.y=e.height/n.height},n._updateUVWithTrim=function(){this.tillingOffsetWithTrim.length=0;var t=this.spriteFrame,e=t.originalSize,n=t.rect,i=t.texture,r=i.width,o=i.height,a=0,s=0;t.original&&(a=n.x-t.original._x,s=n.y-t.original._y);var c=0===r?0:a/r,l=0===r?1:(a+e.width)/r,u=0===o?1:(s+e.height)/o,h=0===o?0:s/o;t.rotated&&(c=0===r?0:a/r,l=0===r?1:(a+e.height)/r,h=0===o?0:s/o,u=0===o?1:(s+e.width)/o),this.tillingOffsetWithTrim[0]=l-c,this.tillingOffsetWithTrim[1]=u-h,this.tillingOffsetWithTrim[2]=c,this.tillingOffsetWithTrim[3]=h,t.rotated&&(this.tillingOffsetWithTrim[0]=-this.tillingOffsetWithTrim[0])},L(e,[{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(t){this._atlas!==t&&(this._atlas=t)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(t){this._fillType!==t&&(t===nK.RADIAL||this._fillType===nK.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===eK.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(t){this._fillStart=Qn(t,0,1),this._type===eK.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(t){this._fillRange=Qn(t,-1,1),this._type===eK.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===eK.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(t){this._useGrayscale!==t&&(this._useGrayscale=t,this._instanceMaterialType=!0===t?pW.GRAYSCALE:pW.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,t!==iK.CUSTOM&&this._applySpriteSize())}}]),e}(Dq),$Y.FillType=nK,$Y.Type=eK,$Y.SizeMode=iK,$Y.EventType=rK,X((HY=tK).prototype,"customMaterial",[dY,mY,vY,Ql],Object.getOwnPropertyDescriptor(HY.prototype,"customMaterial"),HY.prototype),X(HY.prototype,"spriteAtlas",[gY,yY,xY],Object.getOwnPropertyDescriptor(HY.prototype,"spriteAtlas"),HY.prototype),X(HY.prototype,"spriteFrame",[SY,bY,TY],Object.getOwnPropertyDescriptor(HY.prototype,"spriteFrame"),HY.prototype),X(HY.prototype,"type",[EY,CY,wY],Object.getOwnPropertyDescriptor(HY.prototype,"type"),HY.prototype),X(HY.prototype,"fillType",[AY,PY],Object.getOwnPropertyDescriptor(HY.prototype,"fillType"),HY.prototype),X(HY.prototype,"fillCenter",[IY],Object.getOwnPropertyDescriptor(HY.prototype,"fillCenter"),HY.prototype),X(HY.prototype,"fillStart",[RY,DY],Object.getOwnPropertyDescriptor(HY.prototype,"fillStart"),HY.prototype),X(HY.prototype,"fillRange",[OY,MY],Object.getOwnPropertyDescriptor(HY.prototype,"fillRange"),HY.prototype),X(HY.prototype,"trim",[NY,LY,BY],Object.getOwnPropertyDescriptor(HY.prototype,"trim"),HY.prototype),X(HY.prototype,"grayscale",[bl,FY],Object.getOwnPropertyDescriptor(HY.prototype,"grayscale"),HY.prototype),X(HY.prototype,"sizeMode",[zY,UY,kY],Object.getOwnPropertyDescriptor(HY.prototype,"sizeMode"),HY.prototype),VY=X(HY.prototype,"_spriteFrame",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jY=X(HY.prototype,"_type",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eK.SIMPLE}}),WY=X(HY.prototype,"_fillType",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nK.HORIZONTAL}}),qY=X(HY.prototype,"_sizeMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iK.TRIMMED}}),XY=X(HY.prototype,"_fillCenter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(0,0)}}),YY=X(HY.prototype,"_fillStart",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KY=X(HY.prototype,"_fillRange",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QY=X(HY.prototype,"_isTrimmedMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZY=X(HY.prototype,"_useGrayscale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JY=X(HY.prototype,"_atlas",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GY=HY))||GY)||GY)||GY)||GY)),oQ=t("RenderRoot2D",ol("cc.RenderRoot2D")(lK=sl(100)(lK=vl()(lK=al(Xj)(lK=cl(lK=ml(lK=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.onEnable=function(){i.director.root.batcher2D.addScreen(this)},n.onDisable=function(){i.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){i.director.root.batcher2D.removeScreen(this)},e}(ih))||lK)||lK)||lK)||lK)||lK)||lK),aQ=new vi,sQ=Yt({OVERLAY:0,INTERSPERSE:1}),cQ=function(e){return t({Canvas:e,CanvasComponent:e}),e}((uK=ol("cc.Canvas"),hK=Sl(),fK=sl(100),pK=vl(),_K=kl(pF),dK=wl(),mK=wl(),vK=kl(pF),uK(gK=hK(gK=fK(gK=pK(gK=ml(gK=cl((X((yK=function(t){function e(){var e;return q(e=t.call(this)||this,"_cameraComponent",xK,V(e)),q(e,"_alignCanvasWithScreen",SK,V(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new vi,e._renderMode=sQ.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(V(e)),e}F(e,t);var n=e.prototype;return n.__preload=function(){var t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(pF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(ZT.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){t.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(pF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){t.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(pF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.node.off(ZT.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=nN.height/2;else{var t=fh.windowSize;this._cameraComponent.orthoHeight=t.height/lN.getScaleY()/2}this.node.getWorldPosition(aQ),this._cameraComponent.node.setWorldPosition(aQ.x,aQ.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var t,e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return this._renderMode===sQ.OVERLAY?e|1<<30:e&~(1<<30)}return 0},L(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}}]),e}(oQ)).prototype,"cameraComponent",[_K,dK],Object.getOwnPropertyDescriptor(yK.prototype,"cameraComponent"),yK.prototype),X(yK.prototype,"alignCanvasWithScreen",[mK],Object.getOwnPropertyDescriptor(yK.prototype,"alignCanvasWithScreen"),yK.prototype),xK=X(yK.prototype,"_cameraComponent",[vK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SK=X(yK.prototype,"_alignCanvasWithScreen",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gK=yK))||gK)||gK)||gK)||gK)||gK)||gK));i.Canvas=cQ,Fn(t("UIComponent",ol("cc.UIComponent")(bK=al(Xj)(bK=sl(110)(bK=cl(bK=ml(bK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastParent=null,e.stencilStage=bj.DISABLED,e}F(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},e}(ih))||bK)||bK)||bK)||bK)||bK).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),Bn(cQ.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:di.BLACK},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),zn(Dq.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),zn(Xj.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),i.UITransformComponent=Xj,Gt.setClassAlias(Xj,"cc.UITransformComponent"),Gt.setClassAlias(Dq,"cc.RenderComponent"),i.CanvasComponent=cQ,Gt.setClassAlias(cQ,"cc.CanvasComponent");var lQ=new sK,uQ="RICHTEXT_CHILD",hQ="RICHTEXT_Image_CHILD",fQ=new Ut((function(t){if(!i.isValid(t.node))return!1;var e=t.node.getComponent(cK);return e&&(e.width=0),!0}),20),pQ=new Ut((function(t){return i.isValid(t.node)}),10);function _Q(t){return{node:new $C(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function dQ(t,e){var n;t===uQ?n=fQ._get():t===hQ&&(n=pQ._get());var i=(n=n||_Q(t)).node;return i||(i=new $C(t)),i.hideFlags|=Ye.Flags.DontSave|Ye.Flags.HideInHierarchy,t===hQ?(n.comp=i.getComponent(rQ)||i.addComponent(rQ),n.comp.spriteFrame=e,n.comp.type=rQ.Type.SLICED,n.comp.sizeMode=rQ.SizeMode.CUSTOM):(n.comp=i.getComponent(Lq)||i.addComponent(Lq),n.comp.string=e,n.comp.horizontalAlign=Aq.LEFT,n.comp.verticalAlign=Pq.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var mQ,vQ,gQ,yQ,xQ,SQ,bQ,TQ,EQ,CQ,wQ,AQ,PQ,IQ,RQ,DQ,OQ,MQ,NQ,LQ,BQ,FQ,zQ,UQ,kQ,GQ,HQ,VQ,jQ,WQ,qQ=function(e){return t({RichText:e,RichTextComponent:e}),e}((TK=ol("cc.RichText"),EK=Sl(),CK=sl(110),wK=vl(),AK=wl(),PK=kl(Aq),IK=wl(),RK=wl(),DK=wl(),OK=kl(DV),MK=wl(),NK=wl(),LK=kl(Rq),BK=wl(),FK=wl(),zK=wl(),UK=kl(wV),kK=wl(),GK=wl(),TK(HK=EK(HK=CK(HK=wK(HK=ml((iQ=nQ=function(t){function e(){var e;return q(e=t.call(this)||this,"_lineHeight",jK,V(e)),q(e,"_string",WK,V(e)),q(e,"_horizontalAlign",qK,V(e)),q(e,"_fontSize",XK,V(e)),q(e,"_maxWidth",YK,V(e)),q(e,"_fontFamily",KK,V(e)),q(e,"_font",QK,V(e)),q(e,"_isSystemFontUsed",ZK,V(e)),q(e,"_userDefinedFont",JK,V(e)),q(e,"_cacheMode",$K,V(e)),q(e,"_imageAtlas",tQ,V(e)),q(e,"_handleTouchEvent",eQ,V(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this.node.on(ZT.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(ZT.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var t,e=W(this._segments);!(t=e()).done;){var n=t.value;n.node.removeFromParent(),n.type===uQ?fQ.put(n):n.type===hQ&&pQ.put(n)}this.node.off(ZT.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(ZT.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(ZT.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(ZT.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},n._createFontLabel=function(t){return dQ(uQ,t)},n._createImage=function(t){return dQ(hQ,t)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(t,e){var n=this,i=function(e){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(e),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(Lq).string=e,i.styleIndex=t,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i},n._onTouchEnded=function(t){for(var e,n=this,i=this.node.getComponents(ih),r=function(){var r=e.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,t.touch.getUILocation())&&(i.forEach((function(e){var n=e[o];e.enabledInHierarchy&&n&&n.call(e,t,a)})),t.propagationStopped=!0)},o=W(this._segments);!(e=o()).done;)r()},n._containsTouchLocation=function(t,e){var n=t.node.getComponent(Xj);return!!n&&n.getBoundingBoxToWorld().contains(e)},n._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var n=t[e];if(n.name===uQ||n.name===hQ){n.parent===this.node?n.parent=null:t.splice(e,1);var i=_Q(n.name);i.node=n,n.name===uQ?(i.comp=n.getComponent(Lq),fQ.put(i)):(i.comp=n.getComponent(rQ),pQ.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var n=this.node.children[e];n.name!==uQ&&n.name!==hQ||(n.active=t)}},n._addLabelSegment=function(t,e){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(Lq);i&&(i.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(t,e,n){var i=e;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,r,t.length),a=t.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=t.substr(0,r);this._addLabelSegment(c,n),t=t.substr(r,t.length),i=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=sj(t,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],f=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=f.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(t,n)},n._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(t){if(t.style){var e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,e.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(r.imageOffset=e.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=e.imageWidth||0,u=e.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=e.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else E(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var t=lQ.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(c,i),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+XV)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(t,e,n){var i=t.charAt(e);if(ij(i)||rj(i))return 1;for(var r=1,o=e+1;o<n&&!rj(i=t.charAt(o))&&!ij(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var t=0,e=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>e&&(t=0,e=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case Aq.LEFT:break;case Aq.CENTER:l-=this._linesWidth[c-1]/2;break;case Aq.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(t+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===e&&(t+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(rQ)){var h=s.node.position.clone(),f=this._lineHeight,p=this._lineHeight*(1+XV);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=f+(p-f)/2;break;case.5:h.y+=p/2;break;default:h.y+=(p-f)/2}if(s.imageOffset){var _=s.imageOffset.split(",");if(1===_.length&&_[0]){var d=parseFloat(_[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===_.length){var m=parseFloat(_[0]),v=parseFloat(_[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(cK);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(t){var e=t.toUpperCase();return di[e]?di[e]:(new di).fromHEX(t)},n._applyTextAttribute=function(t){var e=t.node.getComponent(Lq);if(e){this._resetLabelState(e);var n,i=t.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){var r=t.node.getComponent(cK);r||(r=t.node.addComponent(cK)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";var o=n.event;o&&(t.clickHandler=o.click||"",t.clickParam=o.param||"")}e.cacheMode=this._cacheMode,this._font instanceof DV&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);var a=e._assembler;a&&a.updateRenderData(e)}},n._applyLayer=function(){for(var t,e=W(this._segments);!(t=e()).done;)t.value.node.layer=this.node.layer},n._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=di.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},L(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}(ih),nQ.HorizontalAlign=Aq,nQ.VerticalAlign=Pq,X((VK=iQ).prototype,"string",[Nl,AK],Object.getOwnPropertyDescriptor(VK.prototype,"string"),VK.prototype),X(VK.prototype,"horizontalAlign",[PK,IK],Object.getOwnPropertyDescriptor(VK.prototype,"horizontalAlign"),VK.prototype),X(VK.prototype,"fontSize",[RK],Object.getOwnPropertyDescriptor(VK.prototype,"fontSize"),VK.prototype),X(VK.prototype,"fontFamily",[DK],Object.getOwnPropertyDescriptor(VK.prototype,"fontFamily"),VK.prototype),X(VK.prototype,"font",[OK,MK],Object.getOwnPropertyDescriptor(VK.prototype,"font"),VK.prototype),X(VK.prototype,"useSystemFont",[NK],Object.getOwnPropertyDescriptor(VK.prototype,"useSystemFont"),VK.prototype),X(VK.prototype,"cacheMode",[LK,BK],Object.getOwnPropertyDescriptor(VK.prototype,"cacheMode"),VK.prototype),X(VK.prototype,"maxWidth",[FK],Object.getOwnPropertyDescriptor(VK.prototype,"maxWidth"),VK.prototype),X(VK.prototype,"lineHeight",[zK],Object.getOwnPropertyDescriptor(VK.prototype,"lineHeight"),VK.prototype),X(VK.prototype,"imageAtlas",[UK,kK],Object.getOwnPropertyDescriptor(VK.prototype,"imageAtlas"),VK.prototype),X(VK.prototype,"handleTouchEvent",[GK],Object.getOwnPropertyDescriptor(VK.prototype,"handleTouchEvent"),VK.prototype),jK=X(VK.prototype,"_lineHeight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),WK=X(VK.prototype,"_string",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),qK=X(VK.prototype,"_horizontalAlign",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aq.LEFT}}),XK=X(VK.prototype,"_fontSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YK=X(VK.prototype,"_maxWidth",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KK=X(VK.prototype,"_fontFamily",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),QK=X(VK.prototype,"_font",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZK=X(VK.prototype,"_isSystemFontUsed",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JK=X(VK.prototype,"_userDefinedFont",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$K=X(VK.prototype,"_cacheMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rq.NONE}}),tQ=X(VK.prototype,"_imageAtlas",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eQ=X(VK.prototype,"_handleTouchEvent",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HK=VK))||HK)||HK)||HK)||HK)||HK)),XQ=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(ol("cc.UIMeshRenderer")(mQ=Sl()(mQ=sl(110)(mQ=vl()(mQ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._models=null,e._modelComponent=null,e.stencilStage=bj.DISABLED,e}F(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(t){if(this._models){this._modelComponent._detachFromScene();for(var e,n=W(this._models);!(e=n()).done;){var i=e.value;t.commitModel.call(t,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var t=this._modelComponent.sharedMaterials.length,e=0;e<t;e++){var n=this._modelComponent.getMaterialInstance(e);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=G_.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},L(e,[{key:"modelComponent",get:function(){return this._modelComponent}}]),e}(ih))||mQ)||mQ)||mQ)||mQ),YQ=U_.Enum.NONE|U_.Enum.UI_3D,KQ=t("UIDrawBatch",function(){function t(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=YQ,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.destroy=function(){this._passes=[]},e.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=YQ,this.renderScene=null},e.fillPasses=function(t,e,n,r,o,a){if(t){var s=t.passes;if(!s)return;var c=0;this._shaders.length=s.length;for(var l=0;l<s.length;l++){this._passes[l]||(this._passes[l]=new Yv(i.director.root));var u=s[l],h=this._passes[l];u.update(),e||(e=u.depthStencilState,n=0),r||(r=u.blendState,o=0),-1===o&&(o=0),c=n<<16|o,h._initPassFromTarget(u,e,r,c),this._shaders[l]=h.getShaderVariant(a)}}},L(t,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(t){this._inputAssembler=t}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(t){this._descriptorSet=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),t}()),QQ=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((vQ=ol("cc.UIStaticBatch"),gQ=Sl(),yQ=vl(),xQ=sl(110),SQ=Tl(),vQ(bQ=gQ(bQ=yQ(bQ=xQ((X((TQ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}F(e,t);var n=e.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var t=new KQ;return t.isStatic=!0,this._uiDrawBatchList.push(t),t},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var t=this._getBatcher(),e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return $M.root&&$M.root.batcher2D?$M.root.batcher2D:(E(9301),null)},L(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),e}(Dq)).prototype,"color",[Ql,SQ],Object.getOwnPropertyDescriptor(TQ.prototype,"color"),TQ.prototype),bQ=TQ))||bQ)||bQ)||bQ)||bQ)),ZQ=t("LabelShadow",(EQ=ol("cc.LabelShadow"),CQ=Sl(),wQ=sl(110),AQ=vl(),PQ=al(Lq),IQ=wl(),RQ=wl(),DQ=wl(),EQ(OQ=CQ(OQ=wQ(OQ=AQ(OQ=PQ(OQ=ml((FQ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_color",NQ,V(e)),q(e,"_offset",LQ,V(e)),q(e,"_blur",BQ,V(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(Lq);t&&t.updateRenderData(!0)},L(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(t){this._blur=t,this._updateRenderData()}}]),e}(ih),NQ=X((MQ=FQ).prototype,"_color",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(0,0,0,255)}}),LQ=X(MQ.prototype,"_offset",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(2,2)}}),BQ=X(MQ.prototype,"_blur",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(MQ.prototype,"color",[IQ],Object.getOwnPropertyDescriptor(MQ.prototype,"color"),MQ.prototype),X(MQ.prototype,"offset",[RQ],Object.getOwnPropertyDescriptor(MQ.prototype,"offset"),MQ.prototype),X(MQ.prototype,"blur",[DQ],Object.getOwnPropertyDescriptor(MQ.prototype,"blur"),MQ.prototype),OQ=MQ))||OQ)||OQ)||OQ)||OQ)||OQ)||OQ)),JQ=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}((zQ=ol("cc.UIOpacity"),UQ=Sl(),kQ=sl(110),GQ=vl(),HQ=wl(),zQ(VQ=UQ(VQ=kQ(VQ=GQ(VQ=ml((X((jQ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_opacity",WQ,V(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},L(e,[{key:"opacity",get:function(){return this._opacity},set:function(t){this._opacity!==t&&(t=he(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}}]),e}(ih)).prototype,"opacity",[bl,HQ],Object.getOwnPropertyDescriptor(jQ.prototype,"opacity"),jQ.prototype),WQ=X(jQ.prototype,"_opacity",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),VQ=jQ))||VQ)||VQ)||VQ)||VQ)||VQ));i.MaskComponent=JX,Gt.setClassAlias(JX,"cc.MaskComponent"),i.LabelComponent=Lq,Gt.setClassAlias(Lq,"cc.LabelComponent"),i.LabelOutlineComponent=cK,Gt.setClassAlias(cK,"cc.LabelOutlineComponent"),i.RichTextComponent=qQ,Gt.setClassAlias(qQ,"cc.RichTextComponent"),i.SpriteComponent=rQ,Gt.setClassAlias(rQ,"cc.SpriteComponent"),i.UIModelComponent=XQ,Gt.setClassAlias(XQ,"cc.UIModelComponent"),i.GraphicsComponent=XX,Gt.setClassAlias(XX,"cc.GraphicsComponent"),Gt.setClassAlias(QQ,"cc.UIStaticBatchComponent"),Gt.setClassAlias(JQ,"cc.UIOpacityComponent");var $Q=function(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n};function tZ(t,e,n,i,r){var o=0,a=null;if(r===function(t,e,n,i){for(var r=0,o=e,a=n-i;o<n;o+=i)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,n,i)>0)for(o=e;o<n;o+=i)a=gZ(o,t[o],t[o+1],a);else for(o=n-i;o>=e;o-=i)a=gZ(o,t[o],t[o+1],a);return a&&_Z(a,a.next)&&(yZ(a),a=a.next),a}function eZ(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var n=t,i=!1;do{if(i=!1,n.steiner||!_Z(n,n.next)&&0!==pZ(n.prev,n,n.next))n=n.next;else{if(yZ(n),(n=e=n.prev)===n.next)return null;i=!0}}while(i||n!==e);return e}function nZ(t,e,n,i,r,o,a){if(void 0===a&&(a=0),t){!a&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=lZ(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,i=n,s=0,e=0;e<l&&(s++,i=i.nextZ);e++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(t,i,r,o);for(var s=t,c=null,l=null;t.prev!==t.next;)if(c=t.prev,l=t.next,o?rZ(t,i,r,o):iZ(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),yZ(t),t=l.next,s=l.next;else if((t=l)===s){a?1===a?nZ(t=oZ(t,e,n),e,n,i,r,o,2):2===a&&aZ(t,e,n,i,r,o):nZ(eZ(t),e,n,i,r,o,1);break}}}function iZ(t){var e=t.prev,n=t,i=t.next;if(pZ(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(hZ(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&pZ(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function rZ(t,e,n,i){var r=t.prev,o=t,a=t.next;if(pZ(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=lZ(s,c,e,n,i),f=lZ(l,u,e,n,i),p=t.nextZ;p&&p.z<=f;){if(p!==t.prev&&p!==t.next&&hZ(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&pZ(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(p=t.prevZ;p&&p.z>=h;){if(p!==t.prev&&p!==t.next&&hZ(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&pZ(p.prev,p,p.next)>=0)return!1;p=p.prevZ}return!0}function oZ(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!_Z(r,o)&&dZ(r,i,i.next,o)&&mZ(r,o)&&mZ(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),yZ(i),yZ(i.next),i=t=o),i=i.next}while(i!==t);return i}function aZ(t,e,n,i,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&fZ(a,s)){var c=vZ(a,s);return a=eZ(a,a.next),c=eZ(c,c.next),nZ(a,e,n,i,r,o),void nZ(c,e,n,i,r,o)}s=s.next}a=a.next}while(a!==t)}function sZ(t,e){return t.x-e.x}function cZ(t,e){if(e=function(t,e){var n=e,i=t.x,r=t.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,f=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&hZ(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<f||c===f&&n.x>a.x)&&mZ(n,t)&&(a=n,f=c),n=n.next;return a}(t,e)){var n=vZ(e,t);eZ(n,n.next)}}function lZ(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function uZ(t){var e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function hZ(t,e,n,i,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(i-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function fZ(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&dZ(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&mZ(t,e)&&mZ(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function pZ(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function _Z(t,e){return t.x===e.x&&t.y===e.y}function dZ(t,e,n,i){return!!(_Z(t,e)&&_Z(n,i)||_Z(t,i)&&_Z(n,e))||pZ(t,e,n)>0!=pZ(t,e,i)>0&&pZ(n,i,t)>0!=pZ(n,i,e)>0}function mZ(t,e){return pZ(t.prev,t,t.next)<0?pZ(t,e,t.next)>=0&&pZ(t,t.prev,e)>=0:pZ(t,e,t.prev)<0||pZ(t,t.next,e)<0}function vZ(t,e){var n=new $Q(t.i,t.x,t.y),i=new $Q(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function gZ(t,e,n,i){var r=new $Q(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function yZ(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function xZ(t,e,n){n=n||3;var i=e?e.length:0,r=i?e[0]*n:t.length,o=tZ(t,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,f=0,p=0;if(i&&(o=function(t,e,n,i){var r,o=[],a=0,s=null;for(a=0,r=e.length;a<r;a++)(s=tZ(t,e[a]*i,a<r-1?e[a+1]*i:t.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(uZ(s)));if(o.sort(sZ),!n)return n;for(a=0;a<o.length;a++)cZ(o[a],n),n=eZ(n,n.next);return n}(t,e,o,n)),t.length>80*n){s=l=t[0],c=u=t[1];for(var _=n;_<r;_+=n)(h=t[_])<s&&(s=h),(f=t[_+1])<c&&(c=f),h>l&&(l=h),f>u&&(u=f);p=Math.max(l-s,u-c)}return nZ(o,a,n,s,c,p),a}for(var SZ=Math.PI,bZ=Math.min,TZ=Math.max,EZ=Math.ceil,CZ=Math.acos,wZ=Math.cos,AZ=Math.sin,PZ=Math.atan2,IZ=null,RZ=null,DZ=new di,OZ=[],MZ=0;MZ<4;MZ++)OZ.push(new vi);function NZ(t,e,n){return t<e?e:t>n?n:t}var LZ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!RZ)return null;var n=RZ.getRenderDataList(),i=n[RZ.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+e:0;return(o>65535||3*o>131070)&&(++RZ.dataOffset,RZ.dataOffset<n.length?i=n[RZ.dataOffset]:(i=RZ.requestRenderData(),n[RZ.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(e,3*e),i},stroke:function(t){di.copy(DZ,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){di.copy(DZ,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e,n,i,r,o=.5*t.lineWidth,a=t.lineCap,s=t.lineJoin,c=t.miterLimit;if(RZ=t.impl){var l=(e=o,n=SZ,i=RZ.tessTol,r=2*CZ(e/(e+i)),TZ(2,EZ(n/r)));this._calculateJoins(RZ,o,s,c);for(var u=RZ.paths,h=0,f=RZ.pathOffset,p=RZ.pathLength;f<p;f++){var _=u[f],d=_.points.length;s===Mq.ROUND?h+=2*(d+_.bevel*(l+2)+1):h+=2*(d+5*_.bevel+1),_.closed||(a===Oq.ROUND?h+=2*(2*l+2):h+=12)}var m=IZ=this.getRenderData(t,h);if(m){for(var v=m.vData,g=m.iData,y=RZ.pathOffset,x=RZ.pathLength;y<x;y++){var S=u[y],b=S.points,T=b.length,E=m.vertexStart,C=void 0,w=void 0,A=0,P=0,I=S.closed;if(I?(C=b[T-1],w=b[0],A=0,P=T):(C=b[0],w=b[1],A=1,P=T-1),w=w||C,!I){var R=new GX(w.x,w.y);R.subtract(C),R.normalize();var D=R.x,O=R.y;a===Oq.BUTT?this._buttCapStart(C,D,O,o,0):a===Oq.SQUARE?this._buttCapStart(C,D,O,o,o):a===Oq.ROUND&&this._roundCapStart(C,D,O,o,l)}for(var M=A;M<P;++M)s===Mq.ROUND?this._roundJoin(C,w,o,o,l):0!=(w.flags&(Nq.PT_BEVEL|Nq.PT_INNERBEVEL))?this._bevelJoin(C,w,o,o):(this._vSet(w.x+w.dmx*o,w.y+w.dmy*o,1),this._vSet(w.x-w.dmx*o,w.y-w.dmy*o,-1)),C=w,w=b[M+1];if(I){var N=8*E;this._vSet(v[N],v[N+1],1),this._vSet(v[N+8],v[N+8+1],-1)}else{var L=new GX(w.x,w.y);L.subtract(C),L.normalize();var B=L.x,F=L.y;a===Oq.BUTT?this._buttCapEnd(w,B,F,o,0):a===Oq.SQUARE?this._buttCapEnd(w,B,F,o,o):a===Oq.ROUND&&this._roundCapEnd(w,B,F,o,l)}for(var z=m.indexStart,U=E+2,k=m.vertexStart;U<k;U++)g[z++]=U-2,g[z++]=U-1,g[z++]=U;m.indexStart=z}IZ=null,RZ=null}}},_expandFill:function(t){if(RZ=t.impl){for(var e=RZ.paths,n=0,i=RZ.pathOffset,r=RZ.pathLength;i<r;i++)n+=e[i].points.length;var o=IZ=this.getRenderData(t,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=RZ.pathOffset,u=RZ.pathLength;l<u;l++){var h=e[l],f=h.points,p=f.length;if(0!==p){for(var _=o.vertexStart,d=0;d<p;++d)this._vSet(f[d].x,f[d].y);var m=o.indexStart;if(h.complex){for(var v=[],g=_,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=xZ(v,null,3);if(!S||0===S.length)continue;for(var b=0,T=S.length;b<T;b++)c[m++]=S[b]+_}else for(var E=_,C=_+2,w=a.vertexStart;C<w;C++)c[m++]=E,c[m++]=C-1,c[m++]=C;a.indexStart=m}}IZ=null,RZ=null}}},_calculateJoins:function(t,e,n,i){var r=0;e>0&&(r=1/e);for(var o=t.paths,a=t.pathOffset,s=t.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],f=l[0];c.bevel=0;for(var p=0;p<u;p++){var _,d,m=h.dy,v=-h.dx,g=f.dy,y=-f.dx;if(f.dmx=.5*(m+g),f.dmy=.5*(v+y),(_=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var x=1/_;x>600&&(x=600),f.dmx*=x,f.dmy*=x}f.dx*h.dy-h.dx*f.dy>0&&(f.flags|=Nq.PT_LEFT),_*(d=TZ(11,bZ(h.len,f.len)*r))*d<1&&(f.flags|=Nq.PT_INNERBEVEL),f.flags&Nq.PT_CORNER&&(_*i*i<1||n===Mq.BEVEL||n===Mq.ROUND)&&(f.flags|=Nq.PT_BEVEL),0!=(f.flags&(Nq.PT_BEVEL|Nq.PT_INNERBEVEL))&&c.bevel++,h=f,f=l[p+1]}}},_flattenPaths:function(t){for(var e=t.paths,n=t.pathOffset,i=t.pathLength;n<i;n++){var r=e[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new GX(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(t,e,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==t?(a=r+e.dy*i,s=o-e.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(t,e,n,i,r){var o=t.x-e*r,a=t.y-n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(t,e,n,i,r){var o=t.x+e*r,a=t.y+n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(t,e,n,i,r){for(var o=t.x,a=t.y,s=n,c=-e,l=0;l<r;l++){var u=l/(r-1)*SZ,h=wZ(u)*i,f=AZ(u)*i;this._vSet(o-s*h-e*f,a-c*h-n*f,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(t,e,n,i,r){var o=t.x,a=t.y,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*SZ,h=wZ(u)*i,f=AZ(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+e*f,a-c*h+n*f,1)}},_roundJoin:function(t,e,n,i,r){var o=t.dy,a=-t.dx,s=e.dy,c=-e.dx,l=e.x,u=e.y;if(0!=(e.flags&Nq.PT_LEFT)){var h=this._chooseBevel(e.flags&Nq.PT_INNERBEVEL,t,e,n),f=h[0],p=h[1],_=h[2],d=h[3],m=PZ(-a,-o),v=PZ(-c,-s);v>m&&(v-=2*SZ),this._vSet(f,p,1),this._vSet(l-o*i,e.y-a*i,-1);for(var g=NZ(EZ((m-v)/SZ)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+wZ(x)*i,b=u+AZ(x)*i;this._vSet(l,u,0),this._vSet(S,b,-1)}this._vSet(_,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var T=this._chooseBevel(e.flags&Nq.PT_INNERBEVEL,t,e,-i),E=T[0],C=T[1],w=T[2],A=T[3],P=PZ(a,o),I=PZ(c,s);I<P&&(I+=2*SZ),this._vSet(l+o*i,u+a*i,1),this._vSet(E,C,-1);for(var R=NZ(EZ((I-P)/SZ)*r,2,r),D=0;D<R;D++){var O=P+D/(R-1)*(I-P),M=l+wZ(O)*n,N=u+AZ(O)*n;this._vSet(M,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(w,A,-1)}},_bevelJoin:function(t,e,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,f=t.dy,p=-t.dx,_=e.dy,d=-e.dx;if(e.flags&Nq.PT_LEFT){var m=this._chooseBevel(e.flags&Nq.PT_INNERBEVEL,t,e,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(e.x-f*i,e.y-p*i,-1),this._vSet(u,h,1),this._vSet(e.x-_*i,e.y-d*i,-1)}else{var v=this._chooseBevel(e.flags&Nq.PT_INNERBEVEL,t,e,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(e.x+f*n,e.y+p*n,1),this._vSet(r,o,-1),this._vSet(e.x+_*n,e.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(t,e,n){if(void 0===n&&(n=0),IZ){var i=IZ,r=8*i.vertexStart,o=i.vData;o[r++]=t,o[r++]=e,o[r++]=0,di.toArray(o,DZ,r),r+=4,o[r++]=n,i.vertexStart++}}},BZ=t("graphicsAssembler",{getAssembler:function(){return LZ}});XX.Assembler=BZ;var FZ=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},zZ=new Wi,UZ=null,kZ=null,GZ=[],HZ=[],VZ=[],jZ=[],WZ=new Vi,qZ=new Vi,XZ=new Bi,YZ=null,KZ=0,QZ=0,ZZ=0,JZ=0,$Z=0,tJ=1,eJ=null,nJ="",iJ=0,rJ=0,oJ=0,aJ=0,sJ=0,cJ=0,lJ=0,uJ=!1,hJ=0,fJ=0,pJ=0,_J={updateRenderData:function(t){t.renderData&&UZ!==t&&(t.renderData.vertDirty&&(kZ=(UZ=t).node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),UZ.actualFontSize=iJ,kZ.setContentSize(qZ),this.updateUVs(t),UZ.renderData.vertDirty=!1,UZ.markForUpdateRenderData(!1),UZ=null,this._resetProperties()),t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame))},updateUVs:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.vertexCount,r=e.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){tJ=iJ/rJ},_updateFontFamily:function(t){var e=t.font;eJ=e.spriteFrame,YZ=e.fntConfig,Rj.fontAtlas=e.fontDefDictionary,gV.packToDynamicAtlas(t,eJ)},_updateLabelInfo:function(){Rj.hash="",Rj.margin=0},_updateProperties:function(t){nJ=t.string.toString(),iJ=t.fontSize,rJ=YZ?YZ.fontSize:t.fontSize,oJ=t.horizontalAlign,aJ=t.verticalAlign,sJ=t.spacingX,lJ=t.overflow,cJ=t._lineHeight;var e=kZ.contentSize;qZ.width=e.width,qZ.height=e.height,lJ===Iq.NONE?(uJ=!1,qZ.width+=2*Rj.margin,qZ.height+=2*Rj.margin):lJ===Iq.RESIZE_HEIGHT?(uJ=!0,qZ.height+=2*Rj.margin):uJ=t.enableWrapText,Rj.lineHeight=cJ,Rj.fontSize=iJ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){YZ=null,eJ=null,Rj.hash="",Rj.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var t=nJ,e=t.length,n=YZ.kerningDict,i=GZ,r=-1,o=0;o<e;++o){var a=t.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<e-1?s:0,r=a}},_multilineTextWrap:function(t){for(var e=nJ.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<e;){var h=nJ.charAt(u);if("\n"!==h){for(var f=t(nJ,u,e),p=s,_=c,d=a,m=i,v=!1,g=0;g<f;++g){var y=u+g;if("\r"!==(h=nJ.charAt(y)))if(l=Rj.fontAtlas.getLetterDefinitionForChar(h,Rj)){var x=m+l.offsetX*tJ-Rj.margin;if(uJ&&pJ>0&&i>0&&x+l.w*tJ>pJ&&!rj(h)){VZ.push(a),a=0,n++,i=0,r-=cJ*this._getFontScale()+0,v=!0;break}XZ.x=x,XZ.y=r-l.offsetY*tJ,this._recordLetterInfo(XZ,h,y,n),y+1<GZ.length&&y<e-1&&(m+=GZ[y+1]),m+=l.xAdvance*tJ+sJ,d=XZ.x+l.w*tJ,p<XZ.y&&(p=XZ.y),_>XZ.y-l.h*tJ&&(_=XZ.y-l.h*tJ)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+YZ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<p&&(s=p),c>_&&(c=_),o<(a=d)&&(o=a),u+=f)}else VZ.push(a),a=0,n++,i=0,r-=cJ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return VZ.push(a),QZ=(KZ=n+1)*cJ*this._getFontScale(),KZ>1&&(QZ+=0*(KZ-1)),qZ.width=hJ,qZ.height=fJ,hJ<=0&&(qZ.width=parseFloat(o.toFixed(2))+2*Rj.margin),fJ<=0&&(qZ.height=parseFloat(QZ.toFixed(2))+2*Rj.margin),JZ=qZ.height,$Z=0,s>0&&(JZ=qZ.height+s),c<-QZ&&($Z=QZ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return lJ===Iq.SHRINK?tJ:1},_getFirstWordLen:function(t,e,n){var i=t.charAt(e);if(ij(i)||"\n"===i||rj(i))return 1;var r=1,o=Rj.fontAtlas.getLetterDefinitionForChar(i,Rj);if(!o)return r;for(var a=o.xAdvance*tJ+sJ,s=e+1;s<n&&(i=t.charAt(s),o=Rj.fontAtlas.getLetterDefinitionForChar(i,Rj));++s){if(a+o.offsetX*tJ+o.w*tJ>pJ&&!rj(i)&&pJ>0)return r;if(a+=o.xAdvance*tJ+sJ,"\n"===i||rj(i)||ij(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(t,e){if(t>=HZ.length){var n=new FZ;HZ.push(n)}HZ[t].char=e,HZ[t].hash=""+e.charCodeAt(0)+Rj.hash,HZ[t].valid=!1},_recordLetterInfo:function(t,e,n,i){if(n>=HZ.length){var r=new FZ;HZ.push(r)}var o=""+e.charCodeAt(0)+Rj.hash;HZ[n].line=i,HZ[n].char=e,HZ[n].hash=o,HZ[n].valid=Rj.fontAtlas.getLetter(o).valid,HZ[n].x=t.x,HZ[n].y=t.y},_alignText:function(){QZ=0,VZ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),lJ===Iq.SHRINK&&iJ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||lJ===Iq.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(t){var e=!0;t||(t=.1,e=!1),iJ=t,e&&this._updateContent()},_shrinkLabelToContentSize:function(t){for(var e=0,n=0|iJ,i=0;e<n;){var r=i=e+n+1>>1;if(r<=0)break;tJ=r/rJ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:function(){return QZ>qZ.height},_isHorizontalClamp:function(){for(var t=!1,e=0,n=nJ.length;e<n;++e){var i=HZ[e];if(i.valid){var r=Rj.fontAtlas.getLetterDefinitionForChar(i.char,Rj);if(!r)continue;var o=i.x+r.w*tJ,a=i.line;if(hJ>0)if(uJ){if(VZ[a]>qZ.width&&(o>qZ.width||o<0)){t=!0;break}}else if(o>qZ.width){t=!0;break}}}return t},_isHorizontalClamped:function(t,e){var n=VZ[e],i=t>qZ.width||t<0;return uJ?n>qZ.width&&i:i},_updateQuads:function(){if(!UZ)return!1;var t=eJ?eJ.texture:Rj.fontAtlas.getTexture(),e=UZ.renderData;e.dataLength=0,e.resize(0,0);for(var n=kZ.anchorPoint,i=qZ,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=nJ.length;s<c;++s){var l=HZ[s];if(l.valid){var u=Rj.fontAtlas.getLetter(l.hash);if(u){zZ.height=u.h,zZ.width=u.w,zZ.x=u.u,zZ.y=u.v;var h=l.y+ZZ;if(fJ>0){if(h>JZ){var f=h-JZ;zZ.y+=f,zZ.height-=f,h-=f}h-u.h*tJ<$Z&&lJ===Iq.CLAMP&&(zZ.height=h<$Z?0:(h-$Z)/tJ)}var p=l.line,_=l.x+u.w/2*tJ+jZ[p];if(hJ>0&&this._isHorizontalClamped(_,p))if(lJ===Iq.CLAMP)zZ.width=0;else if(lJ===Iq.SHRINK){if(qZ.width>u.w){a=!1;break}zZ.width=0}if(zZ.height>0&&zZ.width>0){var d=this._determineRect(),m=l.x+jZ[l.line];this.appendQuad(UZ,t,zZ,d,m-r,h-o,tJ)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var t=eJ.isRotated(),e=eJ.getOriginalSize(),n=eJ.getRect(),i=eJ.getOffset(),r=i.x+(e.width-n.width)/2,o=i.y-(e.height-n.height)/2;if(t){var a=zZ.x;zZ.x=n.x+n.height-zZ.y-zZ.height-o,zZ.y=a+n.y-r,zZ.y<0&&(zZ.height+=o)}else zZ.x+=n.x-r,zZ.y+=n.y+o;return t},_computeAlignmentOffset:function(){switch(jZ.length=0,oJ){case Aq.LEFT:for(var t=0;t<KZ;++t)jZ.push(0);break;case Aq.CENTER:for(var e=0,n=VZ.length;e<n;e++)jZ.push((qZ.width-VZ[e])/2);break;case Aq.RIGHT:for(var i=0,r=VZ.length;i<r;i++)jZ.push(qZ.width-VZ[i])}if(ZZ=qZ.height,aJ!==Pq.TOP){var o=qZ.height-QZ+cJ*this._getFontScale()-rJ*tJ;aJ===Pq.BOTTOM?ZZ-=o:ZZ-=o/2}},_setupBMFontOverflowMetrics:function(){var t=qZ.width,e=qZ.height;lJ===Iq.RESIZE_HEIGHT&&(e=0),lJ===Iq.NONE&&(t=0,e=0),hJ=t,fJ=e,WZ.width=t,WZ.height=e,pJ=t}},dJ=new di(255,255,255,255),mJ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){var e=t.node;dJ.set(t.color),dJ.a=255*e._uiProps.opacity,hV(e,0,t.renderData,dJ)},appendQuad:function(t,e,n,i,r,o,a){var s=t.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=e.width,h=e.height,f=n.width,p=n.height,_=0,d=0,m=0,v=0;i?(_=n.x/u,v=(n.x+p)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=_,l[c].v=m,l[c+1].u=_,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(_=n.x/u,v=(n.x+f)/u,d=(n.y+p)/h,m=n.y/h,l[c].u=_,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=_,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-p*a,l[c+1].x=r+f*a,l[c+1].y=o-p*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+f*a,l[c+3].y=o}},updateColor:function(){}};bt(mJ,_J);var vJ=null,gJ=Tt(_J,{getAssemblerData:function(){return vJ||(vJ=new Ij(1024,1024)),vJ.getTexture()},_updateFontFamily:function(t){Rj.fontAtlas=vJ,Rj.fontFamily=this._getFontFamily(t);var e=t.getComponent(cK);e&&e.enabled?(Rj.isOutlined=!0,Rj.margin=e.width,Rj.out=e.color.clone(),Rj.out.a=e.color.a*t.color.a/255):(Rj.isOutlined=!1,Rj.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){Rj.fontDesc=this._getFontDesc(),Rj.color=t.color,Rj.hash=function(t){var e=t.color.toHEX(),n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}(Rj)},_getFontDesc:function(){return Rj.fontSize.toString()+"px "+Rj.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),yJ=new di(255,255,255,255),xJ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){if(t.renderData){var e=t.node;yJ.a=255*e._uiProps.opacity,hV(e,0,t.renderData,yJ)}},updateColor:function(){},appendQuad:mJ.appendQuad};bt(xJ,gJ);var SJ=Lq.Overflow,bJ=(1/255).toFixed(3),TJ=null,EJ=null,CJ=null,wJ="",AJ="",PJ=0,IJ=0,RJ=[],DJ=new Vi,OJ=0,MJ=0,NJ=0,LJ=new di,BJ="",FJ=SJ.NONE,zJ=!1,UJ=null,kJ=di.BLACK.clone(),GJ=null,HJ=di.BLACK.clone(),VJ=new Wi,jJ=Vi.ZERO.clone(),WJ=Vi.ZERO.clone(),qJ=Bi.ZERO.clone(),XJ=Bi.ZERO.clone(),YJ=0,KJ=0,QJ=!1,ZJ=!1,JJ=!1,$J=["left","center","right"],t$={getAssemblerData:function(){return Lq._canvasPool.get()},resetAssemblerData:function(t){t&&Lq._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=PJ,e.setContentSize(DJ),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),TJ=null,EJ=null,CJ=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){BJ=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties:function(t,e){var n=t.assemblerData;n&&(TJ=n.context,EJ=n.canvas,CJ=t.spriteFrame,AJ=t.string.toString(),PJ=t.fontSize,IJ=PJ,FJ=t.overflow,WJ.width=DJ.width=e.width,WJ.height=DJ.height=e.height,KJ=t.underlineHeight,OJ=t.lineHeight,MJ=t.horizontalAlign,NJ=t.verticalAlign,LJ=t.color,t.node._uiProps.opacity,QJ=t.isBold,ZJ=t.isItalic,JJ=t.isUnderline,zJ=FJ!==SJ.NONE&&(FJ===SJ.RESIZE_HEIGHT||t.enableWrapText),(UJ=(UJ=cK&&t.getComponent(cK))&&UJ.enabled&&UJ.width>0?UJ:null)&&kJ.set(UJ.color),(GJ=(GJ=ZQ&&t.getComponent(ZQ))&&GJ.enabled?GJ:null)&&HJ.set(GJ.color),this._updatePaddingRect())},_updatePaddingRect:function(){var t=0,e=0,n=0,i=0,r=0;if(jJ.width=jJ.height=0,UJ&&(t=e=n=i=r=UJ.width,jJ.width=jJ.height=2*r),GJ){var o=GJ.blur+r,a=GJ.offset.x,s=GJ.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),t=Math.max(t,s+o),e=Math.max(e,-s+o)}if(ZJ){var c=IJ*Math.tan(.20943951);i+=c,jJ.width+=c}VJ.x=n,VJ.y=t,VJ.width=n+i,VJ.height=t+e},_calculateFillTextStartPosition:function(){var t=0;MJ===Aq.RIGHT?t=DJ.width-VJ.width:MJ===Aq.CENTER&&(t=(DJ.width-VJ.width)/2);var e=this._getLineHeight()*(RJ.length-1),n=PJ*(1-XV/2);if(NJ!==Pq.TOP){var i=e+VJ.height+PJ-DJ.height;NJ===Pq.BOTTOM?n-=i+=XV/2*PJ:n-=i/2}n+=0*PJ,qJ.set(t+VJ.x,n+VJ.y)},_updateTexture:function(t){if(TJ&&EJ){TJ.clearRect(0,0,EJ.width,EJ.height),TJ.font=wJ,this._calculateFillTextStartPosition();var e=this._getLineHeight();TJ.lineJoin="round",UJ?(TJ.fillStyle="rgba("+kJ.r+", "+kJ.g+", "+kJ.b+", "+bJ+")",TJ.fillRect(0,0,EJ.width,EJ.height)):t._srcBlendFactor===Ur.SRC_ALPHA&&(TJ.fillStyle="rgba("+LJ.r+", "+LJ.g+", "+LJ.b+", "+bJ+")",TJ.fillRect(0,0,EJ.width,EJ.height)),TJ.fillStyle="rgb("+LJ.r+", "+LJ.g+", "+LJ.b+")";var n=qJ.x,i=0;this._drawTextEffect(qJ,e);for(var r=0;r<RJ.length;++r)i=qJ.y+r*e,UJ&&TJ.strokeText(RJ[r],n,i),TJ.fillText(RJ[r],n,i);GJ&&(TJ.shadowColor="transparent"),this._uploadTexture(t)}},_uploadTexture:function(t){if(t.cacheMode===Lq.CacheMode.BITMAP){var e=t.ttfSpriteFrame;gV.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}var n;CJ&&EJ&&(n=CJ instanceof EV?CJ.texture:CJ,0!==EJ.width&&0!==EJ.height&&(n.reset({width:EJ.width,height:EJ.height,mipmapLevel:1}),n.uploadData(EJ),CJ instanceof EV&&(CJ.rect=new Wi(0,0,EJ.width,EJ.height),CJ._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(t){if(t.cacheMode===Lq.CacheMode.BITMAP){var e=t.ttfSpriteFrame;gV.packToDynamicAtlas(t,e)}},_setupOutline:function(){TJ.strokeStyle="rgba("+kJ.r+", "+kJ.g+", "+kJ.b+", "+kJ.a/255+")",TJ.lineWidth=2*UJ.width},_setupShadow:function(){TJ.shadowColor="rgba("+HJ.r+", "+HJ.g+", "+HJ.b+", "+HJ.a/255+")",TJ.shadowBlur=GJ.blur,TJ.shadowOffsetX=GJ.offset.x,TJ.shadowOffsetY=-GJ.offset.y},_drawTextEffect:function(t,e){if(GJ||UJ||JJ){var n=RJ.length>1&&GJ,i=this._measureText(TJ,wJ),r=0,o=0;GJ&&this._setupShadow(),UJ&&this._setupOutline();for(var a=0;a<RJ.length;++a)r=t.x,o=t.y+a*e,n&&(UJ&&TJ.strokeText(RJ[a],r,o),TJ.fillText(RJ[a],r,o)),JJ&&(YJ=i(RJ[a]),MJ===Aq.RIGHT?XJ.x=t.x-YJ:MJ===Aq.CENTER?XJ.x=t.x-YJ/2:XJ.x=t.x,XJ.y=o+IJ/8,TJ.fillRect(XJ.x,XJ.y,YJ,KJ));n&&(TJ.shadowColor="transparent")}},_updateLabelDimensions:function(){DJ.width=Math.min(DJ.width,2048),DJ.height=Math.min(DJ.height,2048);var t=!1;EJ.width!==DJ.width&&(EJ.width=DJ.width,t=!0),EJ.height!==DJ.height&&(EJ.height=DJ.height,t=!0),t&&(TJ.font=wJ),TJ.textAlign=$J[MJ],TJ.textBaseline="alphabetic"},_getFontDesc:function(){var t=PJ.toString()+"px ";return t+=BJ,QJ&&(t="bold "+t),ZJ&&(t="italic "+t),t},_getLineHeight:function(){return 0|(0===OJ?PJ:OJ*PJ/IJ)},_calculateParagraphLength:function(t,e){for(var n,i=[],r=W(t);!(n=r()).done;){var o=oj(e,n.value,wJ);i.push(o)}return i},_measureText:function(t,e){return function(n){return oj(t,n,e)}},_calculateShrinkFont:function(t){if(TJ){var e=this._calculateParagraphLength(t,TJ),n=0,i=0,r=0;if(zJ){var o=WJ.width,a=WJ.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|PJ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){b(4003);break}PJ=l,wJ=this._getFontDesc(),TJ.font=wJ;var u=this._getLineHeight();for(i=0,n=0;n<t.length;++n){var h=oj(TJ,t[n],wJ);i+=sj(t[n],h,o,this._measureText(TJ,wJ)).length*u}i>a?c=l-1:s=l}0===s?b(4003):(PJ=s,wJ=this._getFontDesc(),TJ.font=wJ)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)r<e[n]&&(r=e[n]);var f=(DJ.width-VJ.width)/r,p=DJ.height/i;PJ=IJ*Math.min(1,f,p)|0,wJ=this._getFontDesc(),TJ.font=wJ}}},_calculateWrapText:function(t){if(zJ&&TJ){RJ=[];for(var e=WJ.width,n=0;n<t.length;++n){var i=oj(TJ,t[n],wJ),r=sj(t[n],i,e,this._measureText(TJ,wJ));RJ=RJ.concat(r)}}},_calculateLabelFont:function(){if(TJ){var t=AJ.split("\n");switch(RJ=t,wJ=this._getFontDesc(),TJ.font=wJ,FJ){case SJ.NONE:for(var e=0,n=0,i=0;i<t.length;++i){var r=oj(TJ,t[i],wJ);e=e>r?e:r}n=(RJ.length+XV)*this._getLineHeight();var o=parseFloat(e.toFixed(2)),a=parseFloat(n.toFixed(2));DJ.width=o+VJ.width,DJ.height=a+VJ.height,WJ.width=o+jJ.width,WJ.height=a+jJ.height;break;case SJ.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case SJ.CLAMP:this._calculateWrapText(t);break;case SJ.RESIZE_HEIGHT:this._calculateWrapText(t);var s=(RJ.length+XV)*this._getLineHeight();DJ.height=s+VJ.height,WJ.height=s+jJ.height}}}},e$=di.WHITE.clone(),n$={createData:function(t){var e=t.requestRenderData();e.dataLength=2,e.resize(4,6);var n=e.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)di.toArray(n,e$,i),i+=9;return e},fillBuffers:function(t){var e=t.renderData.chunk,n=t.renderData.data,i=t.node,r=e.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,f=o.y*l.y,p=a.y*l.y,_=c.x,d=c.y,m=c.z,v=c.w,g=_*d,y=m*v,x=_*_-d*d,S=v*v-m*m,b=S+x,T=2*(g-y),E=S-x,C=2*(g+y),w=s.x,A=s.y;r[0]=b*u+T*f+w,r[1]=E*f+C*u+A,r[9]=b*h+T*f+w,r[10]=E*f+C*h+A,r[18]=b*u+T*p+w,r[19]=E*p+C*u+A,r[27]=b*h+T*p+w,r[28]=E*p+C*h+A;var P=e.bufferId,I=e.vertexOffset,R=e.vertexAccessor.getMeshBuffer(e.bufferId),D=e.vertexAccessor.getIndexBuffer(P),O=R.indexOffset;D[O++]=I,D[O++]=I+1,D[O++]=I+2,D[O++]=I+2,D[O++]=I+1,D[O++]=I+3,R.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var n=e.chunk.vb,i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};bt(n$,t$);var i$=t("labelAssembler",{getAssembler:function(t){var e=n$;return t.font instanceof WV?e=mJ:t.cacheMode===Lq.CacheMode.CHAR&&(e=xJ),e}});Lq.Assembler=i$;var r$=rQ.FillType,o$=new Oi,a$=new vi,s$={updateRenderData:function(t){var e=t.spriteFrame;gV.packToDynamicAtlas(t,e);var n=t.renderData;if(n&&e){if(n.updateRenderData(t,e),!n.vertDirty)return;var i=t.fillStart,r=t.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(t,i,o),this.updateVertexData(t,i,o)}},updateUVs:function(t,e,n){var i=t.spriteFrame,r=t.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,f=0,p=0,_=0,d=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=f=c,_=m=(s.x+s.height)/o,p=v=l,h=d=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=_=c,f=m=(s.x+s.width)/o,h=p=l,d=v=s.y/a),t.fillType){case r$.HORIZONTAL:r[3]=u+(f-u)*e,r[4]=h+(p-h)*e,r[12]=u+(f-u)*n,r[13]=h+(p-h)*n,r[21]=_+(m-_)*e,r[22]=d+(v-d)*e,r[30]=_+(m-_)*n,r[31]=d+(v-d)*n;break;case r$.VERTICAL:r[3]=u+(_-u)*e,r[4]=h+(d-h)*e,r[12]=f+(m-f)*e,r[13]=p+(v-p)*e,r[21]=u+(_-u)*n,r[22]=h+(d-h)*n,r[30]=f+(m-f)*n,r[31]=p+(v-p)*n;break;default:w(2626)}},updateVertexData:function(t,e,n){var i=t.renderData.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,f=a-c,p=0;switch(t.fillType){case r$.HORIZONTAL:p=l+(h-l)*n,l+=(h-l)*e,h=p;break;case r$.VERTICAL:p=u+(f-u)*n,u+=(f-u)*e,f=p;break;default:w(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=f,i[3].x=h,i[3].y=f},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6);for(var n,i=W(e.data);!(n=i()).done;)n.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(o$);for(var n=t.renderData.floatStride,i=t.renderData.data,r=e.vb,o=0,a=0;a<4;a++){var s=i[a];vi.transformMat4(a$,s,o$),r[o=a*n]=a$.x,r[o+1]=a$.y,r[o+2]=a$.z}},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},c$=2*Math.PI,l$=1e-6,u$=new Oi,h$=new vi,f$=[new Bi,new Bi,new Bi,new Bi],p$=new Array(4),_$=new Array(8),d$=[new Bi,new Bi,new Bi,new Bi],m$=[new Bi,new Bi,new Bi,new Bi],v$=new Bi,g$=[new Bi,new Bi,new Bi,new Bi];function y$(t,e,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>l$?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>l$?c:0)){if(l=s/c,(t-r.x)*c>0){var h=r.y+l*(t-r.x);a[0].x=t,a[0].y=h}if((e-r.x)*c>0){var f=r.y+l*(e-r.x);a[2].x=e,a[2].y=f}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var p=r.x+u*(i-r.y);a[3].x=p,a[3].y=i}if((n-r.y)*s>0){var _=r.x+u*(n-r.y);a[1].x=_,a[1].y=n}}}function x$(t,e){var n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function S$(t,e,n,i,r){var o=p$,a=o[0],s=o[1],c=o[2],l=o[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=r.x,t[e+2].y=r.y,b$((n.x-a)/(c-a),(n.y-s)/(l-s),t,e),b$((i.x-a)/(c-a),(i.y-s)/(l-s),t,e+1),b$((r.x-a)/(c-a),(r.y-s)/(l-s),t,e+2)}function b$(t,e,n,i){var r=_$,o=r[0]+(r[2]-r[0])*t,a=r[4]+(r[6]-r[4])*t,s=r[1]+(r[3]-r[1])*t,c=r[5]+(r[7]-r[5])*t,l=n[i];l.u=o+(a-o)*e,l.v=s+(c-s)*e}for(var T$={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;gV.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;if(n&&e){if(!n.vertDirty)return;var i=n.data,r=t.fillStart,o=t.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=c$)+(o*=c$);!function(t){var e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,r=e.anchorX*n,o=e.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=p$;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=t.fillCenter,f=v$.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,p=v$.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;f$[0].x=f$[3].x=a,f$[1].x=f$[2].x=c,f$[0].y=f$[1].y=s,f$[2].y=f$[3].y=l;for(var _,d=W(g$);!(_=d()).done;){var m=_.value;Bi.set(m,0,0)}f!==u[0]&&Bi.set(g$[0],3,0),f!==u[2]&&Bi.set(g$[2],1,2),p!==u[1]&&Bi.set(g$[1],0,1),p!==u[3]&&Bi.set(g$[3],2,3)}(t),function(t){var e=t.width,n=t.height,i=t.getRect(),r=0,o=0,a=0,s=0,c=_$;t.isRotated()?(r=i.x/e,o=(i.x+i.height)/e,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/e,o=(i.x+i.width)/e,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(e),y$(p$[0],p$[2],p$[1],p$[3],v$,r,d$),y$(p$[0],p$[2],p$[1],p$[3],v$,r+o,m$);for(var s=0,c=0;c<4;++c){var l=g$[c];if(l)if(o>=c$)n.dataLength=s+3,S$(i,s,v$,f$[l.x],f$[l.y]),s+=3;else{var u=x$(v$,f$[l.x]),h=x$(v$,f$[l.y]);h<u&&(h+=c$),u-=c$,h-=c$;for(var f=0;f<3;++f)u>=a||(u>=r?(n.dataLength=s+3,S$(i,s,v$,f$[l.x],h>=a?m$[c]:f$[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,S$(i,s,v$,d$[c],f$[l.y]),s+=3):(n.dataLength=s+3,S$(i,s,v$,d$[c],m$[c]),s+=3))),u+=c$,h+=c$}}n.resize(s,s),n.updateRenderData(t,e)}},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(u$);for(var n=t.renderData,i=n.floatStride,r=t.renderData.data,o=e.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];vi.set(h$,l.x,l.y,0),vi.transformMat4(h$,h$,u$),o[s+0]=h$.x,o[s+1]=h$.y,o[s+2]=h$.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},E$=[],C$=0;C$<4;C$++)E$.push(new vi);for(var w$={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){var e=t.spriteFrame;gV.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateWorldVerts:function(t,e){var n=t.renderData,i=e.vb,r=n.data,o=t.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,f=c.m05,p=1===l&&0===u&&0===h&&1===f,_=c.m12,d=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(p){var x=m+_,S=v+_,b=g+d,T=y+d;i[0]=x,i[1]=b,i[9]=S,i[10]=b,i[18]=x,i[19]=T,i[27]=S,i[28]=T}else{var E=l*m,C=l*v,w=u*m,A=u*v,P=h*g+_,I=h*y+_,R=f*g+d,D=f*y+d;i[0]=E+P,i[1]=w+R,i[9]=C+P,i[10]=A+R,i[18]=E+I,i[19]=w+D,i[27]=C+I,i[28]=A+D}},fillBuffers:function(t){if(null!==t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=e.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(t.trim)c=-a,l=-s,u=r-a,h=o-s;else{var f=t.spriteFrame,p=f.getOriginalSize(),_=f.getRect(),d=p.width,m=p.height,v=_.width,g=_.height,y=f.getOffset(),x=r/d,S=o/m,b=y.x+(d-v)/2,T=y.x-(d-v)/2;c=b*x-a,l=(y.y+(m-g)/2)*S-s,u=r+T*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,n=t.spriteFrame.uv;e[3]=n[0],e[4]=n[1],e[12]=n[2],e[13]=n[3],e[21]=n[4],e[22]=n[5],e[30]=n[6],e[31]=n[7]}},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=5,r=t.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=e.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},A$=new vi,P$=new Oi,I$={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(t){var e=t.spriteFrame;gV.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData.data,n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,f=i-c-l,p=r-u-h,_=i/(c+l),d=r/(u+h);_=Number.isNaN(_)||_>1?1:_,d=Number.isNaN(d)||d>1?1:d,f=f<0?0:f,p=p<0?0:p,e[0].x=-o,e[0].y=-a,e[1].x=c*_-o,e[1].y=h*d-a,e[2].x=e[1].x+f,e[2].y=e[1].y+p,e[3].x=i-o,e[3].y=r-a},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(P$);for(var n=t.renderData,i=n.floatStride,r=n.data,o=e.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];vi.set(A$,u.x,c.y,0),vi.transformMat4(A$,A$,P$),a=(4*s+l)*i,o[a++]=A$.x,o[a++]=A$.y,o[a++]=A$.z}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=t.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},R$=[],D$=0;D$<4;D$++)R$.push(new vi);var O$=new Oi,M$={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,n=t.spriteFrame;if(n&&e&&(e.updateRenderData(t,n),e.vertDirty)){var i=t.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,f=a.height-u-h,p=r-s-c,_=o-u-h;p=p>0?p:0,_=_>0?_:0;var d=0===l?p:p/l,m=0===f?_:_/f,v=Math.ceil(m+2),g=Math.ceil(d+2);e.dataLength=Math.max(8,v+1,g+1),this.updateVerts(t,p,_,v,g),e.resize(v*g*4,v*g*6)}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(t,e){var n=t.node;n.getWorldMatrix(O$);var i=t.renderData,r=i.floatStride,o=i.data,a=e.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=t.spriteFrame,h=u.rotated,f=u.uv,p=u.uvSliced,_=u.rect,d=u.insetLeft,m=u.insetRight,v=_.width-d-m,g=u.insetTop,y=u.insetBottom,x=_.height-g-y,S=c-d-m,b=l-g-y;S=S>0?S:0,b=b>0?b:0;for(var T=0===v?S:S/v,E=0===x?b:b/x,C=Math.ceil(E+2),w=Math.ceil(T+2),A=0,P=0,I=0,R=0,D=0,O=0,M=C;O<M;++O){R=o[O].y,D=o[O+1].y;for(var N=0,L=w;N<L;++N){P=o[N].x,I=o[N+1].x,vi.set(R$[0],P,R,0),vi.set(R$[1],I,R,0),vi.set(R$[2],P,D,0),vi.set(R$[3],I,D,0);for(var B=0;B<4;B++){var F=R$[B];vi.transformMat4(F,F,O$);var z=B*r;a[A+z]=F.x,a[A+z+1]=F.y,a[A+z+2]=F.z}A+=4*r}}A=0;for(var U=r,k=2*r,G=3*r,H=4*r,V=0,j=0,W=[],q=[],X=0,Y=C;X<Y;++X){j=b>x?b>=X*x?1:E%1:E;for(var K=0,Q=w;K<Q;++K){V=S>v?S>=K*v?1:T%1:T;var Z=A+3,J=Z+1;h?(0===X?(W[0]=p[0].u,W[1]=p[0].u,W[2]=p[4].u+(p[8].u-p[4].u)*j):X<C-1?(W[0]=p[4].u,W[1]=p[4].u,W[2]=p[4].u+(p[8].u-p[4].u)*j):X===C-1&&(W[0]=p[8].u,W[1]=p[8].u,W[2]=p[12].u),0===K?(q[0]=p[0].v,q[1]=p[1].v+(p[2].v-p[1].v)*V,q[2]=p[0].v):K<w-1?(q[0]=p[1].v,q[1]=p[1].v+(p[2].v-p[1].v)*V,q[2]=p[1].v):K===w-1&&(q[0]=p[2].v,q[1]=p[3].v,q[2]=p[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=p[0].u,W[1]=p[1].u+(p[2].u-p[1].u)*V,W[2]=f[0]):K<w-1?(W[0]=p[1].u,W[1]=p[1].u+(p[2].u-p[1].u)*V,W[2]=p[1].u):K===w-1&&(W[0]=p[2].u,W[1]=p[3].u,W[2]=p[2].u),0===X?(q[0]=p[0].v,q[1]=p[0].v,q[2]=p[4].v+(p[8].v-p[4].v)*j):X<C-1?(q[0]=p[4].v,q[1]=p[4].v,q[2]=p[4].v+(p[8].v-p[4].v)*j):X===C-1&&(q[0]=p[8].v,q[1]=p[8].v,q[2]=p[12].v),W[3]=W[1],q[3]=q[2]),a[Z]=W[0],a[J]=q[0],a[Z+U]=W[1],a[J+U]=q[1],a[Z+k]=W[2],a[J+k]=q[2],a[Z+G]=W[3],a[J+G]=q[3],A+=H}}},updateVerts:function(t,e,n,i,r){var o,a,s=t.node._uiProps.uiTransformComp,c=t.renderData.data,l=t.spriteFrame,u=l.rect,h=Math.abs(s.width),f=Math.abs(s.height),p=s.anchorX*h,_=s.anchorY*f,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(d+m)>1?1:s.width/(d+m),b=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*e)/1e3%v==0?v:e%v:e,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var T=0;T<=r;T++)0===T?c[T].x=-p:T>0&&T<r?c[T].x=1===T?d*S+Math.min(v,e)-p:v>0?T===r-1?d+o+v*(T-2)-p:d+Math.min(v,e)+v*(T-2)-p:d+e-p:T===r&&(c[T].x=Math.min(d+e+m,h)-p);for(var E=0;E<=i;E++)0===E?c[E].y=-_:E>0&&E<i?c[E].y=1===E?y*b+Math.min(x,n)-_:x>0?E===i-1?y+a+(E-2)*x-_:y+Math.min(x,n)+(E-2)*x-_:y+n-_:E===i&&(c[E].y=Math.min(y+n+g,f)-_)},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},N$=rQ.Type,L$=rQ.FillType,B$=t("spriteAssembler",{getAssembler:function(t){var e=w$,n=t;switch(n.type){case N$.SLICED:e=I$;break;case N$.TILED:e=M$;break;case N$.FILLED:e=n.fillType===L$.RADIAL?T$:s$}return e}});rQ.Assembler=B$;var F$=_W.sharedManager,z$={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){t.type===kX.IMAGE_STENCIL&&(w$.updateRenderData(t),w$.updateColor(t))},fillBuffers:function(t,e){(t.type!==kX.IMAGE_STENCIL||t.spriteFrame)&&(F$.pushMask(t),e.finishMergeBatches(),function(t,e){F$.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(F$.enterLevel(t),t.type===kX.IMAGE_STENCIL){w$.fillBuffers(t,e);var n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),F$.enableMask())}},U$={fillBuffers:function(){F$.exitMask()}},k$={getAssembler:function(){return z$}},G$={getAssembler:function(){return U$}};JX.Assembler=k$,JX.PostAssembler=G$;var H$=t("MeshBuffer",function(){function t(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var e=t.prototype;return e.initialize=function(e,n){this._initVDataCount=1024*$t.BATCHER2D_MEM_INCREMENT/Float32Array.BYTES_PER_ELEMENT,this._initVDataCount,R(9005),this._initIDataCount=this._initVDataCount*t.IB_SCALE,this._attributes=n,this._floatsPerVertex=sV(n),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},e.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},e.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var t=0;t<this._iaPool.length;++t){var e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0},e.setDirty=function(){this._dirty=!0},e.request=function(){return E(9002),!1},e.requireFreeIA=function(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia},e.recycleIA=function(t){for(var e=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(t===e[n].ia){var i=e[n];return e[n]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=i)}},e.checkCapacity=function(t,e){var n=this.vertexOffset+t,i=this.indexOffset+e;return!(n>this._initVDataCount||i>this._initIDataCount)},e.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var t=ph.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,n=this.indexOffset,i=0;i<t;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,e>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];e>s.size&&s.resize(e),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},e.createNewIA=function(t){var e,n,i;if(ph.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=t.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,r,r));i=t.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,o,o)),n=[a],this._iaInfo=new jo(this._attributes,n,i),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:n,indexBuffer:i}},L(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}());H$.IB_SCALE=4;var V$=[yD.EventType.MOUSE_DOWN,yD.EventType.MOUSE_MOVE,yD.EventType.MOUSE_UP,yD.EventType.MOUSE_WHEEL],j$=[yD.EventType.TOUCH_START,yD.EventType.TOUCH_MOVE,yD.EventType.TOUCH_END,yD.EventType.TOUCH_CANCEL],W$=(new(function(){function t(){this.priority=lD.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],xD._registerEventDispatcher(this),FR.callbacksInvoker.on(Zw.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),FR.callbacksInvoker.on(Zw.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),FR.callbacksInvoker.on(Zw.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return j$.includes(e)?this.dispatchEventTouch(t):!V$.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?(this._pointerEventProcessorList.push(t),this._isListDirty=!0):(Gt.array.remove(this._processorListToRemove,t),this._processorListToAdd.push(t))},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(Gt.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):(Gt.array.remove(this._processorListToAdd,t),this._processorListToRemove.push(t))},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=!0,r=0;r<n;++r){var o=e[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(t)){if(i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=t.touch,r=!0,o=0;o<n;++o){var a=e[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(t.type===Kw.TOUCH_START){if(a._handleEventTouch(t)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(t),t.type!==Kw.TOUCH_END&&t.type!==Kw.TOUCH_CANCEL||Gt.array.removeAt(a.claimedTouchIdList,s),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,n=0;n<e;++n)this.addPointerEventProcessor(t[n]);t.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,n=0;n<e;++n){var i=t[n],r=i.node._uiProps.uiTransformComp;i.cachedCameraPriority=r.cameraPriority}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var n=t.node,i=e.node;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,f;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(f=h.parent)||void 0===f?void 0:f.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var p=r?r.getSiblingIndex():0,_=o?o.getSiblingIndex():0;return a?p-_:_-p},e._markListDirty=function(){this._isListDirty=!0},t}()),function(){function t(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=sV(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var e=t.prototype;return e.initialize=function(){},e.reset=function(){},e.request=function(){},e.appendBuffers=function(){},e.uploadBuffers=function(){},e.destroy=function(){this._attributes.length=0},L(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),t}()),q$=new jt((function(){return{offset:0,length:0}}),32),X$=function(t,e,n,i){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=n,this.vb=i},Y$=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this)._freeLists=[],i._allocateBuffer(),i}F(e,t);var n=e.prototype;return n.destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var n=this._freeLists[e],i=0;i<n.length;++i)q$.free(n[i])}this._buffers.length=0,this._freeLists.length=0,t.prototype.destroy.call(this)},n.reset=function(){for(var t=0;t<this._buffers.length;++t){var e=this._buffers[t];e.indexOffset=0,e.reset()}},n.getVertexBuffer=function(t){return this._buffers[t].vData},n.getIndexBuffer=function(t){return this._buffers[t].iData},n.getMeshBuffer=function(t){return this._buffers[t]},n.uploadBuffers=function(){for(var t=0;t<this._buffers.length;++t){var e=this._freeLists[t][0],n=this._buffers[t];(!e||e.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(){},n.allocateChunk=function(t,e){for(var n,i=t*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(t,e)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new X$(this,o,u,h,e)}return E(9004,i),null},n.recycleChunk=function(t){var e=this._freeLists[t.bufferId],n=this._buffers[t.bufferId],i=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=e[a];c&&c.offset<i;)s=c,c=e[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,e.splice(a,1),q$.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=q$.alloc();l.offset=i,l.length=r,e.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=q$.alloc();u.offset=i,u.length=r,e.push(u)}}},n._allocateChunkFromEntry=function(t,e,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[t];a.byteOffset<o&&(a.byteOffset=o),I(r>=0,9004,t,n.offset,n.length),0===r?(this._freeLists[t].splice(e,1),q$.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){I(this._buffers.length===this._freeLists.length,9003);var t=new H$;t.initialize(this._device,this._attributes),this._buffers.push(t);var e=q$.alloc();e.offset=0,e.length=t.vData.byteLength;var n=[e];return this._freeLists.push(n),this._buffers.length-1},e}(W$),K$=new ea(null),Q$=new Oi,Z$=t("UI",function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._meshBufferUseCount=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Og,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new $$,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new qt(64),this._drawBatchPool=new jt((function(){return new KQ}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(t){t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),_W.sharedManager.destroy()},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,n=0;n<e.length;n++){var i=e[n];if(i.visibility&t.layer)return i}return null},e.update=function(){for(var t=this._screens,e=0,n=0;n<t.length;++n){var i=t[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent);var o=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var a=this._batches.array[e];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(t){t.uploadBuffers()})),this._bufferAccessors.forEach((function(t){t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((function(t){t.reset()})),this._meshDataArray.forEach((function(t){t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._meshBufferUseCount.clear(),this._batches.clear(),_W.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=oV);var e=t===oV?36:cV(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var n=this._bufferAccessors.get(e);n||(n=new Y$(this.device,t),this._bufferAccessors.set(e,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},e.updateBuffer=function(t,e){var n=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=n.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,n,i,r){var o,a=0,s=-1;if(e&&e.chunk){if(!e.isValid())return;a=e.dataHash,o=e.material,s=e.chunk.bufferId}t.stencilStage=_W.sharedManager.stage;var c=t.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,s),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(t,this)},e.commitModel=function(t,e,n){var r;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);var o=0;n&&(t.stencilStage!==bj.ENABLED&&t.stencilStage!==bj.DISABLED||(t.stencilStage=_W.sharedManager.stage),r=_W.sharedManager.getStencilStage(t.stencilStage,n),o=_W.sharedManager.getStencilHash(t.stencilStage));var a=i.director.getTotalFrames();e&&(e.updateTransform(a),e.updateUBOs(a));for(var s=0;s<e.subModels.length;s++){var c=this._drawBatchPool.alloc(),l=e.subModels[s];c.visFlags=t.node.layer,c.model=e,c.texture=null,c.sampler=null,c.useLocalData=null,r||(r=null),c.fillPasses(n,r,o,null,0,l.patches,this),c.inputAssembler=l.inputAssembler,c.model.visFlags=c.visFlags,c.descriptorSet=l.descriptorSet,this._batches.push(c)}this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currLayer=0},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){var e=this._currMaterial;if(e){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;t&&(c=-1===t.blendHash?null:t.getBlendState(),h=t.blendHash,l=null!==t.customMaterial?_W.sharedManager.getStencilStage(t.stencilStage,e):_W.sharedManager.getStencilStage(t.stencilStage),u=_W.sharedManager.getStencilHash(t.stencilStage));var f=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();f.visFlags=this._currLayer,f.texture=this._currTexture,f.sampler=this._currSampler,f.inputAssembler=n,f.useLocalData=this._currTransform,f.textureHash=this._currTextureHash,f.samplerHash=this._currSamplerHash,f.fillPasses(e,l,u,c,h,null,this),this._batches.push(f)}}},e.forceMergeBatches=function(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},e.finishMergeBatches=function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var n=t.children,i=t._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0&&function(t,e){t.vertexFormat;for(var n=t.chunk.vb,i=t.floatStride,r=i-1;r<n.length;r+=i)n[r]=e}(r.renderData,a),n.length>0&&!t._static)for(var c=0;c<n.length;++c){var l=n[c];this.walk(l,e)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},L(t,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}()),J$=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=i.director.root.device;this._localData=new Float32Array(md.COUNT),this._localBuffer=t.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,md.SIZE,md.SIZE))}var e=t.prototype;return e.initialize=function(t){var e=i.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,K$.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(K$),this._descriptorSet.bindBuffer(md.BINDING,this._localBuffer);var n=Y_.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var e=t.worldMatrix;Oi.toArray(this._localData,e,md.MAT_WORLD_OFFSET),Oi.inverseTranspose(Q$,e);var n=Oi.determinant(Q$),i=1/Math.sqrt(n);Oi.multiplyScalar(Q$,Q$,i),Oi.toArray(this._localData,Q$,md.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},L(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),$$=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new jt((function(){return new J$}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e,n=i.director.root;if(t.useLocalData){for(var r=this._localDescriptorSetCache,o=0,a=r.length;o<a;o++){var s=r[o];if(s.equals(t.useLocalData,t.textureHash,t.samplerHash))return s.descriptorSet}var c=this._localCachePool.alloc();return c.initialize(t),this._localDescriptorSetCache.push(c),c.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);K$.layout=t.passes[0].localSetLayout;var l=n.device.createDescriptorSet(K$),u=Y_.SAMPLER_SPRITE;return l.bindTexture(u,t.texture),l.bindSampler(u,t.sampler),l.update(),this._descriptorSetCache.set(e,l),this._dsCacheHashByTexture.set(t.textureHash,e),l},e.update=function(){var t=this._localDescriptorSetCache,e=[];t.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=t.indexOf(n);e.push(i)}}));for(var n=e.length-1;n>=0;n--)t.splice(e[n],1)},e.reset=function(){var t=this;this._localDescriptorSetCache.forEach((function(e){t._localCachePool.free(e)})),this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){this._descriptorSetCache.forEach((function(t){t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();i.internal.Batcher2D=Z$,zn(H$.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(t){return{name:t,suggest:"please use meshBuffer.accessor."+t+" instead"}}))),Bn(H$.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),Fn(H$.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),Bn(Z$.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),Fn(Nj.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),Bn(Nj.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]);var t0,e0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,f0,p0,_0,d0,m0,v0,g0,y0,x0,S0,b0,T0,E0,C0,w0,A0,P0,I0,R0,D0,O0,M0,N0,L0,B0,F0,z0,U0,k0,G0,H0,V0,j0,W0,q0,X0,Y0,K0,Q0,Z0=null,J0=-1,$0="BES bswy:->@123",t1=Object.create(null),e1=[],n1=3e3;function i1(){for(var t=!0,e=Date.now(),n=e1.length-1;n>=0;n--){var i=e1[n],r=i.fontFamilyName;if(e-i.startTime>n1)E(4933,r),i.onComplete(null,r),e1.splice(n,1);else{var o=i.refWidth,a="40px "+r;Z0.font=a,o!==oj(Z0,$0,a)?(e1.splice(n,1),i.onComplete(null,r)):t=!1}}t&&(clearInterval(J0),J0=-1)}function r1(t,e,n){var i=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var n,i=t.lastIndexOf("/");return-1!==(n=-1===i?t.substring(0,e)+"_LABEL":t.substring(i+1,e)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(t);if(t1[i])n(null,i);else{if(!Z0){var r=document.createElement("canvas");r.width=100,r.height=100,Z0=r.getContext("2d")}var o=oj(Z0,$0,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+t+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===t0)if("FontFace"in window){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);t0=t?parseInt(t[1],10)>42:!e}else t0=!1;return t0}())!function(t,e,n){var i=new Promise((function(n,i){!function r(){Date.now()-t>=n1?i():document.fonts.load("40px "+e).then((function(t){t.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(t,e){r=setTimeout(e,n1)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,e)}),(function(){E(4933,e),n(null,e)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};e1.push(u),-1===J0&&(J0=setInterval(i1,100))}t1[i]=a}}function o1(t,e,n,i){var r=new GV;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}VN.register({".font":r1,".eot":r1,".ttf":r1,".woff":r1,".svg":r1,".ttc":r1}),QN.register({".font":o1,".eot":o1,".ttf":o1,".woff":o1,".svg":o1,".ttc":o1}),i.UI={MeshBuffer:H$,spriteAssembler:B$,graphicsAssembler:BZ,labelAssembler:i$,RenderData:Mj,MeshRenderData:Nj,QuadRenderData:Lj};var a1,s1,c1,l1=new di;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(a1||(a1={})),Zt(a1),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(s1||(s1={})),function(t){t.CLICK="click"}(c1||(c1={}));var u1,h1,f1,p1=function(e){return t({Button:e,ButtonComponent:e}),e}((e0=ol("cc.Button"),n0=Sl(),i0=sl(110),r0=vl(),o0=al(Xj),a0=kl($C),s0=Ol(),c0=wl(),l0=Ol(),u0=wl(),h0=kl(a1),f0=Ol(),p0=wl(),_0=wl(),d0=wl(),m0=wl(),v0=wl(),g0=Pl(),y0=Il(),x0=wl(),S0=wl(),b0=kl(EV),T0=wl(),E0=kl(EV),C0=wl(),w0=kl(EV),A0=wl(),P0=kl(EV),I0=wl(),R0=kl([YB]),D0=Ol(),O0=wl(),e0(M0=n0(M0=i0(M0=r0(M0=o0(M0=ml((Q0=K0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"clickEvents",L0,V(e)),q(e,"_interactable",B0,V(e)),q(e,"_transition",F0,V(e)),q(e,"_normalColor",z0,V(e)),q(e,"_hoverColor",U0,V(e)),q(e,"_pressedColor",k0,V(e)),q(e,"_disabledColor",G0,V(e)),q(e,"_normalSprite",H0,V(e)),q(e,"_hoverSprite",V0,V(e)),q(e,"_pressedSprite",j0,V(e)),q(e,"_disabledSprite",W0,V(e)),q(e,"_duration",q0,V(e)),q(e,"_zoomScale",X0,V(e)),q(e,"_target",Y0,V(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new di,e._toColor=new di,e._time=0,e._transitionFinished=!0,e._fromScale=new vi,e._toScale=new vi,e._originalScale=null,e._sprite=null,e._targetScale=new vi,e}F(e,t);var n=e.prototype;return n.__preload=function(){this.target||(this.target=this.node);var t=this.node.getComponent(rQ);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(t){var e=this.target;if(!this._transitionFinished&&e&&(this._transition===a1.COLOR||this._transition===a1.SCALE)){this._time+=t;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===a1.COLOR){var i=e._uiProps.uiComp;di.lerp(l1,this._fromColor,this._toColor,n),i&&(i.color=l1)}else this.transition===a1.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=Jn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=Jn(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var t=this.target;if(t){var e=this._transition;if(e===a1.COLOR&&this._interactable){var n=t.getComponent(Dq);n&&(n.color=this._normalColor)}else e===a1.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(ZT.TOUCH_START,this._onTouchBegan,this),this.node.on(ZT.TOUCH_MOVE,this._onTouchMove,this),this.node.on(ZT.TOUCH_END,this._onTouchEnded,this),this.node.on(ZT.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(ZT.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(ZT.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(t){t.on(ZT.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(ZT.TOUCH_START,this._onTouchBegan,this),this.node.off(ZT.TOUCH_MOVE,this._onTouchMove,this),this.node.off(ZT.TOUCH_END,this._onTouchEnded,this),this.node.off(ZT.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(ZT.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(ZT.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(t){t.off(ZT.TRANSFORM_CHANGED)},n._getTargetSprite=function(t){var e=null;return t&&(e=t.getComponent(rQ)),e},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new vi),vi.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(t){this._transition===a1.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)},n._setCurrentStateSpriteFrame=function(t){if(t)switch(this._getButtonState()){case s1.NORMAL:this._normalSprite=t;break;case s1.HOVER:this._hoverSprite=t;break;case s1.PRESSED:this._pressedSprite=t;break;case s1.DISABLED:this._disabledSprite=t}},n._onTargetColorChanged=function(t){this._transition===a1.COLOR&&this._setCurrentStateColor(t)},n._setCurrentStateColor=function(t){switch(this._getButtonState()){case s1.NORMAL:this._normalColor=t;break;case s1.HOVER:this._hoverColor=t;break;case s1.PRESSED:this._pressedColor=t;break;case s1.DISABLED:this._disabledColor=t}},n._onTargetTransformChanged=function(t){t&eg.SCALE&&this._originalScale&&this._transition===a1.SCALE&&this._transitionFinished&&vi.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchMove=function(t){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&t){var e=t.touch;if(e){var n,i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());this._transition===a1.SCALE&&this.target&&this._originalScale?i?(vi.copy(this._fromScale,this._originalScale),vi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?s1.PRESSED:s1.NORMAL,this._applyTransition(n)),t&&(t.propagationStopped=!0)}}},n._onTouchEnded=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(YB.emitEvents(this.clickEvents,t),this.node.emit(c1.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==a1.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var t=this._getButtonState();this._applyTransition(t)},n._getButtonState=function(){var t=s1.NORMAL;return this._interactable?this._pressed?t=s1.PRESSED:this._hovered&&(t=s1.HOVER):t=s1.DISABLED,t.toString()},n._updateColorTransition=function(t){var e,n=this[t+"Color"],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(Dq);i&&(t===s1.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(t){var e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},n._updateScaleTransition=function(t){this._interactable&&(t===s1.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(vi.copy(this._fromScale,this._originalScale),vi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(vi.copy(this._fromScale,this.target.getScale()),vi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(t){var e=this._transition;e===a1.COLOR?this._updateColorTransition(t):e===a1.SPRITE?this._updateSpriteTransition(t):e===a1.SCALE&&this._updateScaleTransition(t)},L(e,[{key:"target",get:function(){return this._target||this.node},set:function(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(t){this._transition!==t&&(this._transition===a1.COLOR?this._updateColorTransition(s1.NORMAL):this._transition===a1.SPRITE&&this._updateSpriteTransition(s1.NORMAL),this._transition=t,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(t){this._pressedColor!==t&&this._pressedColor.set(t)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(t){this._hoverColor!==t&&this._hoverColor.set(t)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(t){this._duration!==t&&(this._duration=t)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(t){this._zoomScale!==t&&(this._zoomScale=t)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(t){if(this._normalSprite!==t){this._normalSprite=t;var e=this.node.getComponent(rQ);e&&(e.spriteFrame=t),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}}]),e}(ih),K0.Transition=a1,K0.EventType=c1,X((N0=Q0).prototype,"target",[a0,s0,c0],Object.getOwnPropertyDescriptor(N0.prototype,"target"),N0.prototype),X(N0.prototype,"interactable",[l0,u0],Object.getOwnPropertyDescriptor(N0.prototype,"interactable"),N0.prototype),X(N0.prototype,"transition",[h0,f0,p0],Object.getOwnPropertyDescriptor(N0.prototype,"transition"),N0.prototype),X(N0.prototype,"normalColor",[_0],Object.getOwnPropertyDescriptor(N0.prototype,"normalColor"),N0.prototype),X(N0.prototype,"pressedColor",[d0],Object.getOwnPropertyDescriptor(N0.prototype,"pressedColor"),N0.prototype),X(N0.prototype,"hoverColor",[m0],Object.getOwnPropertyDescriptor(N0.prototype,"hoverColor"),N0.prototype),X(N0.prototype,"disabledColor",[v0],Object.getOwnPropertyDescriptor(N0.prototype,"disabledColor"),N0.prototype),X(N0.prototype,"duration",[g0,y0,x0],Object.getOwnPropertyDescriptor(N0.prototype,"duration"),N0.prototype),X(N0.prototype,"zoomScale",[S0],Object.getOwnPropertyDescriptor(N0.prototype,"zoomScale"),N0.prototype),X(N0.prototype,"normalSprite",[b0,T0],Object.getOwnPropertyDescriptor(N0.prototype,"normalSprite"),N0.prototype),X(N0.prototype,"pressedSprite",[E0,C0],Object.getOwnPropertyDescriptor(N0.prototype,"pressedSprite"),N0.prototype),X(N0.prototype,"hoverSprite",[w0,A0],Object.getOwnPropertyDescriptor(N0.prototype,"hoverSprite"),N0.prototype),X(N0.prototype,"disabledSprite",[P0,I0],Object.getOwnPropertyDescriptor(N0.prototype,"disabledSprite"),N0.prototype),L0=X(N0.prototype,"clickEvents",[R0,hl,D0,O0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),B0=X(N0.prototype,"_interactable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),F0=X(N0.prototype,"_transition",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a1.NONE}}),z0=X(N0.prototype,"_normalColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),U0=X(N0.prototype,"_hoverColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(211,211,211,255)}}),k0=X(N0.prototype,"_pressedColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),G0=X(N0.prototype,"_disabledColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(124,124,124,255)}}),H0=X(N0.prototype,"_normalSprite",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V0=X(N0.prototype,"_hoverSprite",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j0=X(N0.prototype,"_pressedSprite",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W0=X(N0.prototype,"_disabledSprite",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),q0=X(N0.prototype,"_duration",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),X0=X(N0.prototype,"_zoomScale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Y0=X(N0.prototype,"_target",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M0=N0))||M0)||M0)||M0)||M0)||M0)||M0)),_1=function(){function t(){}return t.add=function(t){var e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)},t.remove=function(t){var e=this._tabIndexList,n=e.indexOf(t);-1!==n&&e.splice(n,1)},t.resort=function(){this._tabIndexList.sort((function(t,e){return t._delegate.tabIndex-e._delegate.tabIndex}))},t.next=function(t){var e=this._tabIndexList,n=e.indexOf(t);if(t.setFocus(!1),-1!==n){var i=e[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},t}();_1._tabIndexList=[],function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"}(u1||(u1={})),Yt(u1),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(h1||(h1={})),Yt(h1),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(f1||(f1={})),Yt(f1);var d1,m1,v1,g1,y1,x1,S1,b1,T1,E1,C1,w1,A1,P1,I1,R1,D1,O1,M1,N1,L1,B1,F1,z1,U1,k1,G1,H1,V1,j1,W1,q1,X1,Y1,K1,Q1,Z1,J1,$1,t2,e2,n2,i2,r2,o2,a2,s2,c2,l2,u2,h2,f2,p2,_2,d2,m2,v2,g2,y2,x2,S2,b2=function(){function t(){this._editing=!1,this._delegate=null}var e=t.prototype;return e.init=function(){},e.onEnable=function(){},e.update=function(){},e.onDisable=function(){this._editing&&this.endEditing()},e.clear=function(){this._delegate=null},e.setTabIndex=function(){},e.setSize=function(){},e.setFocus=function(t){t?this.beginEditing():this.endEditing()},e.isFocused=function(){return this._editing},e.beginEditing=function(){},e.endEditing=function(){},t}(),T2=new Oi,E2=new Oi,C2=new vi,w2=null,A2=0,P2=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++A2,e}F(e,t);var n=e.prototype;return n.init=function(t){t&&(this._delegate=t,t.inputMode===h1.ANY?this._createTextArea():this._createInput(),_1.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),_1.remove(this),w2===this&&(w2=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(t){this._edTxt.tabIndex=t,_1.resort()},n.setSize=function(t,e){var n=this._edTxt;n&&(n.style.width=t+"px",n.style.height=e+"px")},n.beginEditing=function(){w2&&w2!==this&&w2.setFocus(!1),this._editing=!0,w2=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){i.GAME_VIEW&&this._edTxt?(i.gameView.container.appendChild(this._edTxt),i.gameView.head.appendChild(this._placeholderStyleSheet)):ZM.container&&this._edTxt&&(ZM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(i.GAME_VIEW?se(i.gameView.container,this._edTxt):se(ZM.container,this._edTxt))&&this._edTxt&&(i.GAME_VIEW?i.gameView.container.removeChild(this._edTxt):ZM.container.removeChild(this._edTxt)),(i.GAME_VIEW?se(i.gameView.head,this._placeholderStyleSheet):se(document.head,this._placeholderStyleSheet))&&(i.GAME_VIEW?i.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),ph.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),ph.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){ph.os!==ln.ANDROID&&ph.os!==ln.OHOS||(uh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){ph.os!==ln.ANDROID&&ph.os!==ln.OHOS||(uh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var t=this;setTimeout((function(){window.scrollY<40&&t._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){ph.browserType!==an.WECHAT||ph.os!==ln.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var t=this._delegate.node,e=lN.getScaleX(),n=lN.getScaleY(),r=1,o=1;i.GAME_VIEW&&(r=i.gameView.canvas.width/i.game.canvas.width,o=i.gameView.canvas.height/i.game.canvas.height),e*=r,n*=o;var a=lN.getViewportRect(),s=uh.devicePixelRatio;t.getWorldMatrix(T2);var c=t._uiProps.uiTransformComp;if(c&&vi.set(C2,-c.anchorX*c.width,-c.anchorY*c.height,C2.z),Oi.transform(T2,T2,C2),t._uiProps.uiTransformComp){var l=$M.root.batcher2D.getFirstRenderCamera(t);if(l){l.node.getWorldRT(E2);var u=E2.m12,h=E2.m13,f=nN.center;E2.m12=f.x-(E2.m00*u+E2.m04*h),E2.m13=f.y-(E2.m01*u+E2.m05*h),Oi.multiply(E2,E2,T2),e/=s,n/=s;var p=i.GAME_VIEW?i.gameView.container:ZM.container,_=E2.m00*e,d=T2.m01,m=T2.m04,v=E2.m05*n,g=parseInt(p&&p.style.paddingLeft||"0");g+=a.x*r/s;var y=parseInt(p&&p.style.paddingBottom||"0");y+=a.y/s;var x="matrix("+_+","+-d+","+-m+","+v+","+(E2.m12*e+g)+","+-(E2.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var t=this._delegate,e=t.inputMode,n=t.inputFlag,i=t.returnType,r=this._edTxt;if(this._inputMode!==e||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=e,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===f1.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===f1.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===f1.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;e===h1.EMAIL_ADDR?a="email":e===h1.NUMERIC||e===h1.DECIMAL?a="number":e===h1.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):e===h1.URL?a="url":(a="text",i===u1.SEARCH&&(a="search")),r.type=a;var s="none";n===f1.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===f1.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t},n._initStyleSheet=function(){if(this._edTxt){var t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):((t=t).type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,e.placeholder=t.placeholder,this._updateTextLabel(t.textLabel),this._updatePlaceholderLabel(t.placeholderLabel))},n._updateTextLabel=function(t){if(t){var e=t.font;e=!e||e instanceof WV?t.fontFamily:e._fontFamily;var n=t.fontSize*t.node.scale.y;if((this._textLabelFont!==e||this._textLabelFontSize!==n||this._textLabelFontColor!==t.fontColor||this._textLabelAlign!==t.horizontalAlign)&&(this._textLabelFont=e,this._textLabelFontSize=n,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=t.color.toCSS(),i.style.fontFamily=e,t.horizontalAlign){case Lq.HorizontalAlign.LEFT:i.style.textAlign="left";break;case Lq.HorizontalAlign.CENTER:i.style.textAlign="center";break;case Lq.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(t){if(t){var e=t.font;e=!e||e instanceof WV?t.fontFamily:t.font._fontFamily;var n=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont!==e||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==t.fontColor||this._placeholderLabelAlign!==t.horizontalAlign||this._placeholderLineHeight!==t.fontSize){this._placeholderLabelFont=e,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;var i=this._placeholderStyleSheet,r=t.color.toCSS(),o=t.fontSize,a="";switch(t.horizontalAlign){case Lq.HorizontalAlign.LEFT:a="left";break;case Lq.HorizontalAlign.CENTER:a="center";break;case Lq.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",ph.browserType===an.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var t=this;if(this._edTxt){var e=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,t._delegate._editBoxTextChanged(e.value)},i.onInput=function(){if(!n){var i=t._delegate,r=i.maxLength;r>=0&&(e.value=e.value.slice(0,r)),i._editBoxTextChanged(e.value)}},i.onClick=function(){t._editing&&ph.isMobile&&t._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===rD.ENTER?(n.propagationStopped=!0,t._delegate._editBoxEditingReturn(),t._isTextArea||e.blur()):n.keyCode===rD.TAB&&(n.propagationStopped=!0,n.preventDefault(),_1.next(t))},i.onBlur=function(){ph.isMobile&&n&&i.compositionEnd(),t._editing=!1,w2=null,t._hideDom(),t._delegate._editBoxEditingDidEnded()},e.addEventListener("compositionstart",i.compositionStart),e.addEventListener("compositionend",i.compositionEnd),e.addEventListener("input",i.onInput),e.addEventListener("keydown",i.onKeydown),e.addEventListener("blur",i.onBlur),e.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}},e}(b2);!function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(S2||(S2={}));var I2,R2,D2,O2,M2,N2,L2,B2,F2,z2,U2,k2,G2,H2,V2,j2,W2,q2,X2,Y2,K2,Q2,Z2,J2,$2,t4,e4,n4,i4,r4,o4,a4,s4,c4,l4,u4,h4,f4,p4,_4,d4,m4,v4,g4,y4,x4,S4,b4,T4,E4,C4,w4,A4,P4,I4,R4,D4,O4,M4,N4,L4=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((d1=ol("cc.EditBox"),m1=Sl(),v1=sl(110),g1=vl(),y1=al(Xj),x1=Ol(),S1=wl(),b1=Ol(),T1=wl(),E1=kl(Lq),C1=Ol(),w1=wl(),A1=kl(Lq),P1=Ol(),I1=wl(),R1=kl(EV),D1=Ol(),O1=wl(),M1=kl(f1),N1=Ol(),L1=wl(),B1=kl(h1),F1=Ol(),z1=wl(),U1=kl(u1),k1=Ol(),G1=wl(),H1=Ol(),V1=wl(),j1=Ol(),W1=wl(),q1=kl([YB]),X1=Ol(),Y1=wl(),K1=kl([YB]),Q1=Ol(),Z1=wl(),J1=kl([YB]),$1=Ol(),t2=wl(),e2=kl([YB]),n2=Ol(),i2=wl(),d1(r2=m1(r2=v1(r2=g1(r2=y1(r2=ml((x2=y2=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"editingDidBegan",a2,V(e)),q(e,"textChanged",s2,V(e)),q(e,"editingDidEnded",c2,V(e)),q(e,"editingReturn",l2,V(e)),e._impl=null,e._background=null,q(e,"_textLabel",u2,V(e)),q(e,"_placeholderLabel",h2,V(e)),q(e,"_returnType",f2,V(e)),q(e,"_string",p2,V(e)),q(e,"_tabIndex",_2,V(e)),q(e,"_backgroundImage",d2,V(e)),q(e,"_inputFlag",m2,V(e)),q(e,"_inputMode",v2,V(e)),q(e,"_maxLength",g2,V(e)),e._isLabelVisible=!1,e}F(e,t);var n=e.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){YB.emitEvents(this.editingDidBegan,this),this.node.emit(S2.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){YB.emitEvents(this.editingDidEnded,this),this.node.emit(S2.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(t){t=this._updateLabelStringStyle(t,!0),this.string=t,YB.emitEvents(this.textChanged,t,this),this.node.emit(S2.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){YB.emitEvents(this.editingReturn,this),this.node.emit(S2.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(t){t.propagationStopped=!0},n._onTouchCancel=function(t){t.propagationStopped=!0},n._onTouchEnded=function(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(ZT.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var t=this.node.getComponent(rQ);t||(t=this.node.addComponent(rQ)),t!==this._background&&(t.type=rQ.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var t=this._textLabel;if(!t){var e=this.node.getChildByName("TEXT_LABEL");e||((e=new $C("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(Lq))||(t=e.addComponent(Lq)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=Lq.Overflow.CLAMP,this._inputMode===h1.ANY?(t.verticalAlign=Pq.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var t=this._placeholderLabel;if(!t){var e=this.node.getChildByName("PLACEHOLDER_LABEL");e||((e=new $C("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(Lq))||(t=e.addComponent(Lq)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=Lq.Overflow.CLAMP,this._inputMode===h1.ANY?(t.verticalAlign=Pq.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},n._syncSize=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)},n._updateLabels=function(){if(this._isLabelVisible){var t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}},n._updateString=function(t){var e=this._textLabel;if(e){var n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(t,e){void 0===e&&(e=!1);var n,i=this._inputFlag;if(e||i!==f1.PASSWORD)i===f1.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===f1.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(function(t){return t.toUpperCase()})):i===f1.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=t.length,a=0;a<o;++a)r+="";t=r}return t},n._registerEvent=function(){this.node.on(ZT.TOUCH_START,this._onTouchBegan,this),this.node.on(ZT.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(ZT.TOUCH_START,this._onTouchBegan,this),this.node.off(ZT.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.on(rQ.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.off(rQ.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(n+2,i+t.height,o.node.position.z),this._inputMode===h1.ANY&&(o.verticalAlign=Pq.TOP),o.enableWrapText=this._inputMode===h1.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.lineHeight=t.height,r.node.setPosition(n+2,i+t.height,r.node.position.z),this._inputMode===h1.ANY&&(r.verticalAlign=Pq.TOP),r.enableWrapText=this._inputMode===h1.ANY)},n._resizeChildNodes=function(){var t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize)},L(e,[{key:"string",get:function(){return this._string},set:function(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}},{key:"textLabel",get:function(){return this._textLabel},set:function(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(t){this._inputFlag=t,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(t){this._returnType=t}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}}]),e}(ih),y2._EditBoxImpl=b2,y2.KeyboardReturnType=u1,y2.InputFlag=f1,y2.InputMode=h1,y2.EventType=S2,X((o2=x2).prototype,"string",[x1,S1],Object.getOwnPropertyDescriptor(o2.prototype,"string"),o2.prototype),X(o2.prototype,"placeholder",[b1,T1],Object.getOwnPropertyDescriptor(o2.prototype,"placeholder"),o2.prototype),X(o2.prototype,"textLabel",[E1,C1,w1],Object.getOwnPropertyDescriptor(o2.prototype,"textLabel"),o2.prototype),X(o2.prototype,"placeholderLabel",[A1,P1,I1],Object.getOwnPropertyDescriptor(o2.prototype,"placeholderLabel"),o2.prototype),X(o2.prototype,"backgroundImage",[R1,D1,O1],Object.getOwnPropertyDescriptor(o2.prototype,"backgroundImage"),o2.prototype),X(o2.prototype,"inputFlag",[M1,N1,L1],Object.getOwnPropertyDescriptor(o2.prototype,"inputFlag"),o2.prototype),X(o2.prototype,"inputMode",[B1,F1,z1],Object.getOwnPropertyDescriptor(o2.prototype,"inputMode"),o2.prototype),X(o2.prototype,"returnType",[U1,k1,G1],Object.getOwnPropertyDescriptor(o2.prototype,"returnType"),o2.prototype),X(o2.prototype,"maxLength",[H1,V1],Object.getOwnPropertyDescriptor(o2.prototype,"maxLength"),o2.prototype),X(o2.prototype,"tabIndex",[j1,W1],Object.getOwnPropertyDescriptor(o2.prototype,"tabIndex"),o2.prototype),a2=X(o2.prototype,"editingDidBegan",[q1,hl,X1,Y1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),s2=X(o2.prototype,"textChanged",[K1,hl,Q1,Z1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c2=X(o2.prototype,"editingDidEnded",[J1,hl,$1,t2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),l2=X(o2.prototype,"editingReturn",[e2,hl,n2,i2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u2=X(o2.prototype,"_textLabel",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h2=X(o2.prototype,"_placeholderLabel",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f2=X(o2.prototype,"_returnType",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return u1.DEFAULT}}),p2=X(o2.prototype,"_string",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_2=X(o2.prototype,"_tabIndex",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d2=X(o2.prototype,"_backgroundImage",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),m2=X(o2.prototype,"_inputFlag",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f1.DEFAULT}}),v2=X(o2.prototype,"_inputMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return h1.ANY}}),g2=X(o2.prototype,"_maxLength",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),r2=o2))||r2)||r2)||r2)||r2)||r2)||r2));"object"==typeof window&&"object"==typeof document&&(L4._EditBoxImpl=P2),i.internal.EditBox=L4,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(I4||(I4={})),Zt(I4),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(R4||(R4={})),Zt(R4),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(D4||(D4={})),Zt(D4),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(O4||(O4={})),Zt(O4),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(M4||(M4={})),Zt(M4),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(N4||(N4={})),Zt(N4);var B4,F4,z4,U4,k4,G4,H4,V4,j4,W4,q4,X4,Y4,K4,Q4,Z4,J4,$4,t3,e3,n3,i3,r3,o3=new vi,a3=function(e){return t({Layout:e,LayoutComponent:e}),e}((I2=ol("cc.Layout"),R2=Sl(),D2=sl(110),O2=vl(),M2=al(Xj),N2=Tl(),L2=wl(),B2=Tl(),F2=wl(),z2=kl(I4),U2=wl(),k2=kl(R4),G2=Tl(),H2=wl(),V2=Tl(),j2=wl(),W2=kl(D4),q2=wl(),X2=wl(),Y2=wl(),K2=wl(),Q2=wl(),Z2=wl(),J2=wl(),$2=kl(O4),t4=wl(),e4=kl(M4),n4=wl(),i4=kl(N4),r4=Tl(),o4=wl(),a4=Tl(),s4=wl(),c4=wl(),I2(l4=R2(l4=D2(l4=O2(l4=M2(l4=ml((P4=A4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_resizeMode",h4,V(e)),q(e,"_layoutType",f4,V(e)),q(e,"_cellSize",p4,V(e)),q(e,"_startAxis",_4,V(e)),q(e,"_paddingLeft",d4,V(e)),q(e,"_paddingRight",m4,V(e)),q(e,"_paddingTop",v4,V(e)),q(e,"_paddingBottom",g4,V(e)),q(e,"_spacingX",y4,V(e)),q(e,"_spacingY",x4,V(e)),q(e,"_verticalDirection",S4,V(e)),q(e,"_horizontalDirection",b4,V(e)),q(e,"_constraint",T4,V(e)),q(e,"_constraintNum",E4,V(e)),q(e,"_affectedByScale",C4,V(e)),q(e,"_isAlign",w4,V(e)),e._layoutSize=new Vi(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}F(e,t);var n=e.prototype;return n.updateLayout=function(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var t=this.node._uiProps.uiTransformComp;t.contentSize.equals(Vi.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){$M.on(JM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(ZT.SIZE_CHANGED,this._resized,this),this.node.on(ZT.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(ZT.CHILD_ADDED,this._childAdded,this),this.node.on(ZT.CHILD_REMOVED,this._childRemoved,this),this.node.on(ZT.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){$M.off(JM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(ZT.SIZE_CHANGED,this._resized,this),this.node.off(ZT.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(ZT.CHILD_ADDED,this._childAdded,this),this.node.off(ZT.CHILD_REMOVED,this._childRemoved,this),this.node.off(ZT.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.on(ZT.SIZE_CHANGED,this._doLayoutDirty,this),n.on(ZT.TRANSFORM_CHANGED,this._transformDirty,this),n.on(ZT.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(ZT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.off(ZT.SIZE_CHANGED,this._doLayoutDirty,this),n.off(ZT.TRANSFORM_CHANGED,this._transformDirty,this),n.off(ZT.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(ZT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(t){t.on(ZT.SIZE_CHANGED,this._doLayoutDirty,this),t.on(ZT.TRANSFORM_CHANGED,this._transformDirty,this),t.on(ZT.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(ZT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(t){t.off(ZT.SIZE_CHANGED,this._doLayoutDirty,this),t.off(ZT.TRANSFORM_CHANGED,this._transformDirty,this),t.off(ZT.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(ZT.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===M4.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*t+a*s,l=c-a*this._spacingX,u=0,h=0,f=0,p=0,_=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==I4.GRID&&this._resizeMode===R4.CHILDREN&&(m=(t-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,b=S.scale,T=this._getUsedScaleValue(b.x),E=this._getUsedScaleValue(b.y);this._resizeMode===R4.CHILDREN&&(x.width=m/T,this._layoutType===I4.GRID&&(x.height=this._cellSize.height/E));var C=Math.abs(this._horizontalDirection-x.anchorX),w=x.width*T,A=x.height*E;A>f&&(p=Math.max(f,p),h=f||A,f=A),l+=a*(C*w+this._spacingX);var P=a*(1-C)*w;if(e){if(o>0)(_=y/o>0&&y%o==0)&&(h=f>A?f:h);else if(w>t-v)l>c+a*C*w&&(_=!0);else{var I=(1-this._horizontalDirection-r.x)*t,R=l+P+a*(a>0?this._paddingRight:this._paddingLeft);_=Math.abs(R)>Math.abs(I)}_&&(l=c+a*C*w,A!==f&&(h=f),u+=h+this._spacingY,h=f=A)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=P}return h=Math.max(h,f),Math.max(p,u+h)+this._getPaddingV()},n._doLayoutVertically=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===O4.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*t+a*s,l=c-a*this._spacingY,u=0,h=0,f=0,p=0,_=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==I4.GRID&&this._resizeMode===R4.CHILDREN&&(m=(t-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,b=S.scale,T=this._getUsedScaleValue(b.x),E=this._getUsedScaleValue(b.y);this._resizeMode===R4.CHILDREN&&(x.height=m/E,this._layoutType===I4.GRID&&(x.width=this._cellSize.width/T));var C=Math.abs(this._verticalDirection-x.anchorY),w=x.width*T,A=x.height*E;w>u&&(h=Math.max(u,h),f=u||w,u=w),l+=a*(C*A+this._spacingY);var P=a*(1-C)*A;if(e){if(o>0)(_=y/o>0&&y%o==0)&&(f=u>A?u:f);else if(A>t-v)l>c+a*C*A&&(_=!0);else{var I=(1-this._verticalDirection-r.y)*t,R=l+P+a*(a>0?this._paddingTop:this._paddingBottom);_=Math.abs(R)>Math.abs(I)}_&&(l=c+a*C*A,w!==u&&(f=u),p+=f+this._spacingX,f=u=w)}var D=n(S,x,p);i&&(S.getPosition(o3),S.setPosition(D,l,o3.z)),l+=P}return f=Math.max(f,u),Math.max(h,p+f)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(t,e){var n=this,i=e.width,r=1,o=-t.y*e.height,a=this._paddingBottom;this._verticalDirection===O4.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*e.height,a=this._paddingTop);var s=function(t,e,i){return o+r*(i+(1-e.anchorY)*e.height*n._getUsedScaleValue(t.scale.y)+a)},c=0;this._resizeMode===R4.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-t.y*c,this._verticalDirection===O4.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===R4.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(t,e){var n=this,i=e.height,r=1,o=-t.x*e.width,a=this._paddingLeft;this._horizontalDirection===M4.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*e.width,a=this._paddingRight);var s=function(t,e,i){return o+r*(i+(1-e.anchorX)*e.width*n._getUsedScaleValue(t.scale.x)+a)},c=0;this._resizeMode===R4.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-t.x*c,this._horizontalDirection===M4.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===R4.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===D4.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===D4.VERTICAL&&this._doLayoutGridAxisVertical(e,n)},n._getHorizontalBaseWidth=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===R4.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.width*this._getUsedScaleValue(o.x)}e+=(n-1)*this._spacingX+this._getPaddingH()}else e=this.node._uiProps.uiTransformComp.width;return e},n._getVerticalBaseHeight=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===R4.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.height*this._getUsedScaleValue(o.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e},n._doLayout=function(){var t=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===I4.HORIZONTAL){var e=this._getHorizontalBaseWidth();this._doLayoutHorizontally(e,!1,(function(e){return(t._isAlign?vi.ZERO:e.position).y}),!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===I4.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(e){return(t._isAlign?vi.ZERO:e.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===I4.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(t){return this._affectedByScale?Math.abs(t):1},n._transformDirty=function(t){t&eg.SCALE&&t&eg.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==I4.GRID||this._constraint===N4.NONE||this._constraintNum<=0)return 0;var t=this._constraint===N4.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===D4.VERTICAL&&(t=this._constraint===N4.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t},L(e,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(t){this._layoutType===I4.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(t){this._layoutType===I4.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(t){this._layoutType=t,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(t){this._layoutType!==I4.NONE&&(this._resizeMode=t,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(t){this._layoutType!==I4.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(t){this._constraint!==N4.NONE&&this._constraintNum!==t&&(t<=0&&_("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(t){this._affectedByScale=t,this._doLayoutDirty()}}]),e}(ih),A4.Type=I4,A4.VerticalDirection=O4,A4.HorizontalDirection=M4,A4.ResizeMode=R4,A4.AxisDirection=D4,A4.Constraint=N4,X((u4=P4).prototype,"alignHorizontal",[N2,L2],Object.getOwnPropertyDescriptor(u4.prototype,"alignHorizontal"),u4.prototype),X(u4.prototype,"alignVertical",[B2,F2],Object.getOwnPropertyDescriptor(u4.prototype,"alignVertical"),u4.prototype),X(u4.prototype,"type",[z2,U2],Object.getOwnPropertyDescriptor(u4.prototype,"type"),u4.prototype),X(u4.prototype,"resizeMode",[k2,G2,H2],Object.getOwnPropertyDescriptor(u4.prototype,"resizeMode"),u4.prototype),X(u4.prototype,"cellSize",[V2,j2],Object.getOwnPropertyDescriptor(u4.prototype,"cellSize"),u4.prototype),X(u4.prototype,"startAxis",[W2,q2],Object.getOwnPropertyDescriptor(u4.prototype,"startAxis"),u4.prototype),X(u4.prototype,"paddingLeft",[X2],Object.getOwnPropertyDescriptor(u4.prototype,"paddingLeft"),u4.prototype),X(u4.prototype,"paddingRight",[Y2],Object.getOwnPropertyDescriptor(u4.prototype,"paddingRight"),u4.prototype),X(u4.prototype,"paddingTop",[K2],Object.getOwnPropertyDescriptor(u4.prototype,"paddingTop"),u4.prototype),X(u4.prototype,"paddingBottom",[Q2],Object.getOwnPropertyDescriptor(u4.prototype,"paddingBottom"),u4.prototype),X(u4.prototype,"spacingX",[Z2],Object.getOwnPropertyDescriptor(u4.prototype,"spacingX"),u4.prototype),X(u4.prototype,"spacingY",[J2],Object.getOwnPropertyDescriptor(u4.prototype,"spacingY"),u4.prototype),X(u4.prototype,"verticalDirection",[$2,t4],Object.getOwnPropertyDescriptor(u4.prototype,"verticalDirection"),u4.prototype),X(u4.prototype,"horizontalDirection",[e4,n4],Object.getOwnPropertyDescriptor(u4.prototype,"horizontalDirection"),u4.prototype),X(u4.prototype,"constraint",[i4,r4,o4],Object.getOwnPropertyDescriptor(u4.prototype,"constraint"),u4.prototype),X(u4.prototype,"constraintNum",[a4,s4],Object.getOwnPropertyDescriptor(u4.prototype,"constraintNum"),u4.prototype),X(u4.prototype,"affectedByScale",[c4],Object.getOwnPropertyDescriptor(u4.prototype,"affectedByScale"),u4.prototype),h4=X(u4.prototype,"_resizeMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return R4.NONE}}),f4=X(u4.prototype,"_layoutType",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return I4.NONE}}),p4=X(u4.prototype,"_cellSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi(40,40)}}),_4=X(u4.prototype,"_startAxis",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D4.HORIZONTAL}}),d4=X(u4.prototype,"_paddingLeft",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m4=X(u4.prototype,"_paddingRight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v4=X(u4.prototype,"_paddingTop",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g4=X(u4.prototype,"_paddingBottom",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y4=X(u4.prototype,"_spacingX",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x4=X(u4.prototype,"_spacingY",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S4=X(u4.prototype,"_verticalDirection",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O4.TOP_TO_BOTTOM}}),b4=X(u4.prototype,"_horizontalDirection",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M4.LEFT_TO_RIGHT}}),T4=X(u4.prototype,"_constraint",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N4.NONE}}),E4=X(u4.prototype,"_constraintNum",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),C4=X(u4.prototype,"_affectedByScale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w4=X(u4.prototype,"_isAlign",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l4=u4))||l4)||l4)||l4)||l4)||l4)||l4));!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(r3||(r3={})),Yt(r3);var s3,c3,l3,u3,h3,f3,p3,_3,d3,m3,v3,g3,y3,x3,S3,b3,T3,E3,C3,w3,A3,P3,I3,R3,D3,O3=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((B4=ol("cc.ProgressBar"),F4=Sl(),z4=sl(110),U4=vl(),k4=al(Xj),G4=kl(rQ),H4=wl(),V4=kl(r3),j4=wl(),W4=wl(),q4=Al(),X4=wl(),Y4=wl(),B4(K4=F4(K4=z4(K4=U4(K4=k4((i3=n3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_barSprite",Z4,V(e)),q(e,"_mode",J4,V(e)),q(e,"_totalLength",$4,V(e)),q(e,"_progress",t3,V(e)),q(e,"_reverse",e3,V(e)),e}F(e,t);var n=e.prototype;return n._initBarSprite=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===rQ.FillType.RADIAL&&(this._mode=r3.FILLED),this._mode===r3.HORIZONTAL?this.totalLength=r.width:this._mode===r3.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){var o=-n.width*i.x;t.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,r=t.getPosition(),o=new Bi(0,.5),a=Zn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case r3.HORIZONTAL:this._reverse&&(o=new Bi(1,.5)),c=new Vi(s,i.height),l=this._totalLength,u=i.height;break;case r3.VERTICAL:o=this._reverse?new Bi(.5,1):new Bi(.5,0),c=new Vi(i.width,s),l=i.width,u=this._totalLength}if(this._mode===r3.FILLED)this._barSprite.type!==rQ.Type.FILLED?_("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==rQ.Type.FILLED){var h=o.x-n.x,f=o.y-n.y,p=new vi(l*h,u*f,0);t.setPosition(r.x+p.x,r.y+p.y,r.z),e.setAnchorPoint(o),e.setContentSize(c)}else _("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},L(e,[{key:"barSprite",get:function(){return this._barSprite},set:function(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){var e=this._barSprite.node;if(!e)return;var n=e._uiProps.uiTransformComp.contentSize;this._mode===r3.HORIZONTAL?this.totalLength=n.width:this._mode===r3.VERTICAL?this.totalLength=n.height:this._mode===r3.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(t){this._mode===r3.FILLED&&(t=Zn(t)),this._totalLength=t,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),e}(ih),n3.Mode=r3,X((Q4=i3).prototype,"barSprite",[G4,H4],Object.getOwnPropertyDescriptor(Q4.prototype,"barSprite"),Q4.prototype),X(Q4.prototype,"mode",[V4,j4],Object.getOwnPropertyDescriptor(Q4.prototype,"mode"),Q4.prototype),X(Q4.prototype,"totalLength",[W4],Object.getOwnPropertyDescriptor(Q4.prototype,"totalLength"),Q4.prototype),X(Q4.prototype,"progress",[q4,Dl,X4],Object.getOwnPropertyDescriptor(Q4.prototype,"progress"),Q4.prototype),X(Q4.prototype,"reverse",[Y4],Object.getOwnPropertyDescriptor(Q4.prototype,"reverse"),Q4.prototype),Z4=X(Q4.prototype,"_barSprite",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J4=X(Q4.prototype,"_mode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r3.HORIZONTAL}}),$4=X(Q4.prototype,"_totalLength",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),t3=X(Q4.prototype,"_progress",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),e3=X(Q4.prototype,"_reverse",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K4=Q4))||K4)||K4)||K4)||K4)||K4)),M3=new vi,N3=new vi,L3=new vi,B3=new Bi,F3=new di,z3=new Bi;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(D3||(D3={})),Zt(D3);var U3,k3,G3,H3,V3,j3,W3,q3,X3,Y3,K3,Q3,Z3,J3,$3,t5,e5,n5,i5,r5,o5,a5,s5,c5,l5,u5,h5,f5,p5,_5,d5,m5,v5,g5,y5,x5,S5,b5,T5,E5,C5,w5,A5,P5,I5,R5,D5,O5,M5,N5=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((s3=ol("cc.ScrollBar"),c3=Sl(),l3=sl(110),u3=vl(),h3=al(Xj),f3=kl(rQ),p3=Ol(),_3=wl(),d3=kl(D3),m3=Ol(),v3=wl(),g3=Ol(),y3=wl(),x3=Ol(),S3=wl(),s3(b3=c3(b3=l3(b3=u3(b3=h3((R3=I3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_scrollView",E3,V(e)),q(e,"_handle",C3,V(e)),q(e,"_direction",w3,V(e)),q(e,"_enableAutoHide",A3,V(e)),q(e,"_autoHideTime",P3,V(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}F(e,t);var n=e.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(t){if(this._scrollView){var e=this._scrollView.content;if(e){var n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=z3;u.set(0,0),this._direction===D3.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=t.x,this._convertToScrollViewSpace(u,e),c=-u.x):this._direction===D3.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=t.y,this._convertToScrollViewSpace(u,e),c=-u.y);var h=this._calculateLength(o,a,l,s),f=z3;this._calculatePosition(f,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(f)}}}},n.setScrollView=function(t){this._scrollView=t},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var t=this._scrollView.content;if(t){var e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var t=this.node.getComponent(rQ);t&&(this._opacity=t.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(t){this._processAutoHide(t)},n._convertToScrollViewSpace=function(t,e){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(n&&i){M3.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(M3,N3);var r=n.convertToNodeSpaceAR(N3);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,t.set(r.x,r.y)}else t.set(Bi.ZERO)},n._setOpacity=function(t){if(this._handle){var e=this.node.getComponent(rQ);e&&(F3.set(e.color),F3.a=t,e.color=F3),(e=this._handle.getComponent(rQ))&&(F3.set(e.color),F3.a=t,e.color=F3)}},n._updateHandlerPosition=function(t){if(this._handle){var e=L3;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}},n._fixupHandlerPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;vi.set(M3,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(M3,N3),s=t;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===D3.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===D3.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(t,e){return t.width<=e.width&&this._direction===D3.HORIZONTAL||t.height<=e.height&&this._direction===D3.VERTICAL},n._calculateLength=function(t,e,n,i){var r=t;return i&&(r+=20*(i>0?i:-i)),n*(e/r)},n._calculatePosition=function(t,e,n,i,r,o,a){var s=e-n;o&&(s+=Math.abs(o));var c=0;s&&(c=Zn(c=r/s));var l=(i-a)*c;this._direction===D3.VERTICAL?t.set(0,l):t.set(l,0)},n._updateLength=function(t){if(this._handle){var e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===B3.x&&i.y===B3.y||e.setAnchorPoint(B3),this._direction===D3.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}},n._processAutoHide=function(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}},L(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t,this.onScroll(Bi.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this.onScroll(Bi.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(t){this._autoHideTime!==t&&(this._autoHideTime=t)}}]),e}(ih),I3.Direction=D3,X((T3=R3).prototype,"handle",[f3,p3,_3],Object.getOwnPropertyDescriptor(T3.prototype,"handle"),T3.prototype),X(T3.prototype,"direction",[d3,m3,v3],Object.getOwnPropertyDescriptor(T3.prototype,"direction"),T3.prototype),X(T3.prototype,"enableAutoHide",[g3,y3],Object.getOwnPropertyDescriptor(T3.prototype,"enableAutoHide"),T3.prototype),X(T3.prototype,"autoHideTime",[x3,S3],Object.getOwnPropertyDescriptor(T3.prototype,"autoHideTime"),T3.prototype),E3=X(T3.prototype,"_scrollView",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C3=X(T3.prototype,"_handle",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w3=X(T3.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D3.HORIZONTAL}}),A3=X(T3.prototype,"_enableAutoHide",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P3=X(T3.prototype,"_autoHideTime",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b3=T3))||b3)||b3)||b3)||b3)||b3)),L5=t("ViewGroup",ol("cc.ViewGroup")(U3=sl(110)(U3=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(ih))||U3)||U3);i.ViewGroup=L5;var B5,F5=1e-4,z5=new vi,U5=new vi,k5=new Bi,G5=new Bi,H5=function(){return(new Date).getMilliseconds()},V5={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(B5||(B5={}));var j5,W5,q5,X5,Y5,K5,Q5,Z5,J5,$5,t6,e6,n6,i6,r6,o6,a6,s6,c6,l6,u6,h6,f6=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((k3=ol("cc.ScrollView"),G3=Sl(),H3=sl(110),V3=vl(),j3=al(Xj),W3=Al(),q3=Ol(),X3=wl(),Y3=Al(),K3=Ol(),Q3=wl(),Z3=Ol(),J3=wl(),$3=Ol(),t5=wl(),e5=kl($C),n5=Ol(),i5=wl(),r5=Ol(),o5=wl(),a5=kl(N5),s5=Ol(),c5=wl(),l5=Ol(),u5=wl(),h5=kl(N5),f5=Ol(),p5=wl(),_5=Ol(),d5=wl(),m5=kl([YB]),v5=Ol(),g5=wl(),k3(y5=G3(y5=H3(y5=V3(y5=j3((M5=O5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"bounceDuration",S5,V(e)),q(e,"brake",b5,V(e)),q(e,"elastic",T5,V(e)),q(e,"inertia",E5,V(e)),q(e,"horizontal",C5,V(e)),q(e,"vertical",w5,V(e)),q(e,"cancelInnerEvents",A5,V(e)),q(e,"scrollEvents",P5,V(e)),e._autoScrolling=!1,e._scrolling=!1,q(e,"_content",I5,V(e)),q(e,"_horizontalScrollBar",R5,V(e)),q(e,"_verticalScrollBar",D5,V(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new vi,e._autoScrollTargetDelta=new vi,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new vi,e._outOfBoundaryAmount=new vi,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new vi,e._deltaPos=new vi,e}F(e,t);var n=e.prototype;return n.scrollToBottom=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)},n.scrollToTop=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Bi(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToOffset=function(t,e,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Bi(0,0);0===i.x?r.x=0:r.x=t.x/i.x,0===i.y?r.y=1:r.y=(i.y-t.y)/i.y,this.scrollTo(r,e,n)},n.getScrollOffset=function(){var t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Bi(e,t)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Bi.ZERO;var t=this._content._uiProps.uiTransformComp.contentSize,e=t.width-this.view.width,n=t.height-this.view.height;return new Bi(e=e>=0?e:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Bi(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)},n.scrollTo=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Bi(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.scrollToPercentVertical=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Bi(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(t){this._setContentPosition(t)},n._setContentPosition=function(t){if(this._content){var e=this._getContentPosition();Math.abs(t.x-e.x)<F5&&Math.abs(t.y-e.y)<F5||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):vi.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return F5},n.start=function(){this._calculateBoundary(),this._content&&$M.once(JM.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(ZT.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(ZT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(ZT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(ZT.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(t){this._autoScrolling&&this._processAutoScrolling(t)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(ZT.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(ZT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(ZT.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(ZT.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(ZT.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(ZT.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(ZT.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(ZT.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(ZT.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(ZT.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(ZT.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(ZT.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(ZT.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(ZT.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(t,e){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(t,e)){var n=new vi,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}},n._onTouchBegan=function(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))},n._onTouchMoved=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){var n=t.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(k5);if(i.subtract(n.getUIStartLocation(G5)),i.length()>7&&!this._touchMoved&&t.target!==this.node){var r=new iD(t.getTouches(),t.bubbles,Yw.TOUCH_CANCEL);r.touch=t.touch,r.simulate=!0,t.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}}},n._onTouchEnded=function(t,e){if(this.enabledInHierarchy&&this._content&&t&&!this._hasNestedViewGroup(t,e)){this._dispatchEvent(B5.TOUCH_UP);var n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}},n._onTouchCancelled=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){var n=t.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(t)}},n._calculateBoundary=function(){if(this._content&&this.view){var t=this._content.getComponent(a3);t&&t.enabledInHierarchy&&t.updateLayout();var e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}},n._hasNestedViewGroup=function(t,e){if(!t||t.eventPhase!==JR.CAPTURING_PHASE)return!1;if(e)for(var n,i=W(e);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!t.target||!t.target.getComponent(L5));if(r.getComponent(L5))return!0}return!1},n._startInertiaScroll=function(t){var e=new vi(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)},n._calculateAttenuatedFactor=function(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))},n._startAttenuatingAutoScroll=function(t,e){var n=t.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=t.length(),u=n.length()/l;if(n.add(t),this.brake>0&&u>7){u=Math.sqrt(u);var h=t.clone();h.multiplyScalar(u),n.set(h),n.add(t)}var f=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&u>3&&(f*=u=3),0===this.brake&&u>1&&(f*=u),this._startAutoScroll(n,f,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(t){return Math.sqrt(Math.sqrt(t/5))},n._startAutoScroll=function(t,e,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,vi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(vi.ZERO,F5)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var t=new vi,e=0;if((e=this._touchMoveTimeDeltas.reduce((function(t,e){return t+e}),e))<=0||e>=.5)t.set(vi.ZERO);else{var n=new vi;n=this._touchMoveDisplacements.reduce((function(t,e){return t.add(e),t}),n),t.set(n.x*(1-this.brake)/e,n.y*(1-this.brake)/e,n.z)}return t},n._flattenVectorByDirection=function(t){var e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},n._moveContent=function(t,e){var n=this._flattenVectorByDirection(t);z5.set(this._getContentPosition()),z5.add(n),z5.set(Math.round(1e4*z5.x)*F5,Math.round(1e4*z5.y)*F5,z5.z),this._setContentPosition(z5);var i=this._getHowMuchOutOfBoundary();k5.set(i.x,i.y),this._updateScrollBar(k5),this.elastic&&e&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height},n._getHowMuchOutOfBoundary=function(t){if((t=t||new vi).equals(vi.ZERO,F5)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var e=new vi,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+t.x>this._leftBoundary?e.x=this._leftBoundary-(n+t.x):i+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(i+t.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):o+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(o+t.y)),t.equals(vi.ZERO,F5)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e},n._updateScrollBar=function(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(t){if(t===B5.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===B5.SCROLL_TO_TOP||t===B5.SCROLL_TO_BOTTOM||t===B5.SCROLL_TO_LEFT||t===B5.SCROLL_TO_RIGHT){var e=1<<V5[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}YB.emitEvents(this.scrollEvents,this,V5[t]),this.node.emit(t,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var t=this._getHowMuchOutOfBoundary();z5.set(this._getContentPosition()),z5.add(t),this._content.setPosition(z5),this._updateScrollBar(Bi.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(t){t.eventPhase===JR.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)},n._processDeltaMove=function(t){this._scrollChildren(t),this._gatherTouchMove(t)},n._handleMoveLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(B5.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(t,e){var n=this.node._uiProps.uiTransformComp,i=new vi;n&&(e.getUILocation(k5),e.getUIPreviousLocation(G5),z5.set(k5.x,k5.y,0),U5.set(G5.x,G5.y,0),n.convertToNodeSpaceAR(z5,z5),n.convertToNodeSpaceAR(U5,U5),vi.subtract(i,z5,U5)),t.set(i)},n._scrollChildren=function(t){this._clampDelta(t);var e,n=t;this.elastic&&(e=this._getHowMuchOutOfBoundary(),n.x*=0===e.x?1:.5,n.y*=0===e.y?1:.5),this.elastic||(e=this._getHowMuchOutOfBoundary(n),n.add(e));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||vi.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=B5.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=B5.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=B5.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=B5.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(B5.SCROLL_BEGAN)),this._dispatchEvent(B5.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(B5.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=H5(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(t){if(this._content&&this.view){var e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}},n._gatherTouchMove=function(t){var e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var n=H5();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(vi.ZERO,F5))return!1;var e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(B5.BOUNCE_TOP),t.y<0&&this._dispatchEvent(B5.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(B5.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(B5.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var t=this._calculateTouchMoveVelocity();!t.equals(z5,F5)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(vi.ZERO,F5)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(t){var e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=F5;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(B5.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),e&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(vi.ZERO,F5)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(B5.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(B5.SCROLL_ENDED))},n._checkMouseWheel=function(t){if(!this._getHowMuchOutOfBoundary().equals(vi.ZERO,F5))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(B5.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(B5.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(t){var e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(Bi.ZERO,Bi.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new vi;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*e.x),i&&(s=c.height-l.height,a.y=r-s*e.y)}return a},n._moveContentToTopLeft=function(t){var e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;var n=new vi,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(i=o.height-t.height,n.y=e-i),o.width<t.width&&(i=o.width-t.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(t){t===eg.SCALE&&this._calculateBoundary()},L(e,[{key:"content",get:function(){return this._content},set:function(t){if(this._content!==t){var e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):b(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Bi.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Bi.ZERO)))}},{key:"view",get:function(){var t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}}]),e}(L5),O5.EventType=B5,S5=X((x5=M5).prototype,"bounceDuration",[hl,W3,q3,X3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b5=X(x5.prototype,"brake",[hl,Y3,K3,Q3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),T5=X(x5.prototype,"elastic",[hl,Z3,J3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),E5=X(x5.prototype,"inertia",[hl,$3,t5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(x5.prototype,"content",[e5,n5,i5],Object.getOwnPropertyDescriptor(x5.prototype,"content"),x5.prototype),C5=X(x5.prototype,"horizontal",[hl,r5,o5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(x5.prototype,"horizontalScrollBar",[a5,s5,c5],Object.getOwnPropertyDescriptor(x5.prototype,"horizontalScrollBar"),x5.prototype),w5=X(x5.prototype,"vertical",[hl,l5,u5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(x5.prototype,"verticalScrollBar",[h5,f5,p5],Object.getOwnPropertyDescriptor(x5.prototype,"verticalScrollBar"),x5.prototype),A5=X(x5.prototype,"cancelInnerEvents",[hl,_5,d5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),P5=X(x5.prototype,"scrollEvents",[m5,hl,v5,g5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),I5=X(x5.prototype,"_content",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R5=X(x5.prototype,"_horizontalScrollBar",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D5=X(x5.prototype,"_verticalScrollBar",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y5=x5))||y5)||y5)||y5)||y5)||y5)),p6=new vi;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(h6||(h6={})),Zt(h6);var _6,d6,m6,v6,g6,y6,x6,S6,b6,T6,E6,C6,w6,A6,P6,I6,R6,D6,O6,M6,N6=function(e){return t({Slider:e,SliderComponent:e}),e}((j5=ol("cc.Slider"),W5=Sl(),q5=sl(110),X5=vl(),Y5=al(Xj),K5=kl(rQ),Q5=wl(),Z5=kl(h6),J5=wl(),$5=Al(),t6=wl(),e6=kl([YB]),n6=wl(),j5(i6=W5(i6=q5(i6=X5(i6=Y5((u6=l6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"slideEvents",o6,V(e)),q(e,"_handle",a6,V(e)),q(e,"_direction",s6,V(e)),q(e,"_progress",c6,V(e)),e._offset=new vi,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new vi,e._touchPos=new vi,e}F(e,t);var n=e.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(ZT.TOUCH_START,this._onTouchBegan,this),this.node.on(ZT.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(ZT.TOUCH_END,this._onTouchEnded,this),this.node.on(ZT.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(ZT.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(ZT.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(ZT.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(ZT.TOUCH_START,this._onTouchBegan,this),this.node.off(ZT.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(ZT.TOUCH_END,this._onTouchEnded,this),this.node.off(ZT.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(ZT.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(ZT.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(ZT.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(t){if(t&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var e=t.touch.getUILocation();vi.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}},n._onTouchBegan=function(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchMoved=function(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchEnded=function(t){this._dragging=!1,this._touchHandle=!1,this._offset=new vi,t&&(t.propagationStopped=!0)},n._onTouchCancelled=function(t){this._dragging=!1,t&&(t.propagationStopped=!0)},n._handleSliderLogic=function(t){this._updateProgress(t),this._emitSlideEvent()},n._emitSlideEvent=function(){YB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(t){if(this._handle&&t){var e=t.getUILocation();vi.set(this._touchPos,e.x,e.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,p6);this.direction===h6.Horizontal?this.progress=Zn(.5+(i.x-this._offset.x)/n.width):this.progress=Zn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var t=this.node._uiProps.uiTransformComp;this._direction===h6.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){var n=this._handle.node.position;this._direction===h6.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},L(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}}]),e}(ih),l6.Direction=h6,X((r6=u6).prototype,"handle",[K5,Q5],Object.getOwnPropertyDescriptor(r6.prototype,"handle"),r6.prototype),X(r6.prototype,"direction",[Z5,J5],Object.getOwnPropertyDescriptor(r6.prototype,"direction"),r6.prototype),X(r6.prototype,"progress",[Dl,$5,t6],Object.getOwnPropertyDescriptor(r6.prototype,"progress"),r6.prototype),o6=X(r6.prototype,"slideEvents",[e6,hl,n6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a6=X(r6.prototype,"_handle",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),s6=X(r6.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return h6.Horizontal}}),c6=X(r6.prototype,"_progress",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),i6=r6))||i6)||i6)||i6)||i6)||i6));function L6(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(e))}!function(t){t.TOGGLE="toggle"}(M6||(M6={}));var B6,F6,z6,U6,k6,G6,H6,V6,j6,W6,q6,X6,Y6,K6,Q6,Z6,J6,$6,t8,e8,n8,i8,r8,o8,a8,s8,c8,l8,u8,h8,f8,p8,_8,d8,m8,v8,g8,y8,x8,S8,b8,T8,E8,C8,w8,A8,P8,I8,R8,D8,O8,M8,N8,L8,B8,F8,z8,U8,k8,G8=function(e){return t({Toggle:e,ToggleComponent:e}),e}((_6=ol("cc.Toggle"),d6=Sl(),m6=sl(110),v6=vl(),g6=al(Xj),y6=Ol(),x6=wl(),S6=kl(rQ),b6=Ol(),T6=wl(),E6=kl([YB]),C6=wl(),_6(w6=d6(w6=m6(w6=v6(w6=g6((O6=D6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"checkEvents",P6,V(e)),q(e,"_isChecked",I6,V(e)),q(e,"_checkMark",R6,V(e)),e}F(e,t);var n=e.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(t,e){if(void 0===e&&(e=!0),this._isChecked!=t){this._isChecked=t;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(t){this._set(t,!1)},n.onEnable=function(){t.prototype.onEnable.call(this),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(e.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var t=this._toggleContainer;t&&t.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&YB.emitEvents(this.checkEvents,this)},L(e,[{key:"isChecked",get:function(){return this._isChecked},set:function(t){this._set(t)}},{key:"checkMark",get:function(){return this._checkMark},set:function(t){this._checkMark!==t&&(this._checkMark=t)}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var t=this.node.parent;return i.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}}]),e}(p1),D6.EventType=L6(M6,c1),X((A6=O6).prototype,"isChecked",[y6,x6],Object.getOwnPropertyDescriptor(A6.prototype,"isChecked"),A6.prototype),X(A6.prototype,"checkMark",[S6,b6,T6],Object.getOwnPropertyDescriptor(A6.prototype,"checkMark"),A6.prototype),P6=X(A6.prototype,"checkEvents",[E6,hl,C6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),I6=X(A6.prototype,"_isChecked",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R6=X(A6.prototype,"_checkMark",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w6=A6))||w6)||w6)||w6)||w6)||w6)),H8=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((B6=ol("cc.ToggleContainer"),F6=Sl(),z6=sl(110),U6=vl(),k6=wl(),G6=kl([YB]),H6=wl(),B6(V6=F6(V6=z6(V6=U6(V6=ml((X6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_allowSwitchOff",W6,V(e)),q(e,"checkEvents",q6,V(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(ZT.CHILD_ADDED,this.ensureValidState,this),this.node.on(ZT.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(ZT.CHILD_ADDED,this.ensureValidState,this),this.node.off(ZT.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(t){return t.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(t){return t.isChecked}))},n.notifyToggleCheck=function(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var r=this.toggleItems[n];r!==t&&(e?r.isChecked=!1:r.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,t)}},n.ensureValidState=function(){var t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){var e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},L(e,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(t){this._allowSwitchOff=t}},{key:"toggleItems",get:function(){return this.node.children.map((function(t){var e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}}]),e}(ih),W6=X((j6=X6).prototype,"_allowSwitchOff",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(j6.prototype,"allowSwitchOff",[k6],Object.getOwnPropertyDescriptor(j6.prototype,"allowSwitchOff"),j6.prototype),q6=X(j6.prototype,"checkEvents",[G6,hl,H6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),V6=j6))||V6)||V6)||V6)||V6)||V6)),V8=new Bi;function j8(t){return t instanceof DD?nN:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:Vi.ZERO}function W8(t,e,n,i){t.parent?V8.set(t.parent.getScale().x,t.parent.getScale().y):V8.set(0,0);for(var r=V8.x,o=V8.y,a=0,s=0,c=t.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===e)break;c?V8.set(c.getScale().x,c.getScale().y):V8.set(0,0);var u=V8.x,h=V8.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(U8||(U8={})),Zt(U8),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(k8||(k8={}));var q8,X8,Y8,K8,Q8,Z8,J8,$8,t7,e7,n7,i7,r7,o7,a7,s7,c7,l7,u7,h7=k8.TOP|k8.BOT,f7=k8.LEFT|k8.RIGHT,p7=function(e){return t({Widget:e,WidgetComponent:e}),e}((Y6=ol("cc.Widget"),K6=Sl(),Q6=sl(110),Z6=vl(),J6=al(Xj),$6=kl($C),t8=wl(),e8=wl(),n8=wl(),i8=wl(),r8=wl(),o8=wl(),a8=wl(),s8=Tl(),c8=Tl(),l8=wl(),u8=wl(),h8=wl(),f8=wl(),p8=wl(),_8=wl(),d8=kl(U8),m8=wl(),Y6(v8=K6(v8=Q6(v8=Z6(v8=J6(v8=ml((z8=F8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastPos=new vi,e._lastSize=new Vi,e._dirty=!0,e._hadAlignOnce=!1,q(e,"_alignFlags",y8,V(e)),q(e,"_target",x8,V(e)),q(e,"_left",S8,V(e)),q(e,"_right",b8,V(e)),q(e,"_top",T8,V(e)),q(e,"_bottom",E8,V(e)),q(e,"_horizontalCenter",C8,V(e)),q(e,"_verticalCenter",w8,V(e)),q(e,"_isAbsLeft",A8,V(e)),q(e,"_isAbsRight",P8,V(e)),q(e,"_isAbsTop",I8,V(e)),q(e,"_isAbsBottom",R8,V(e)),q(e,"_isAbsHorizontalCenter",D8,V(e)),q(e,"_isAbsVerticalCenter",O8,V(e)),q(e,"_originalWidth",M8,V(e)),q(e,"_originalHeight",N8,V(e)),q(e,"_alignMode",L8,V(e)),q(e,"_lockFlags",B8,V(e)),e}F(e,t);var n=e.prototype;return n.updateAlignment=function(){i._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(ZT.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(ZT.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(ZT.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(ZT.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(ZT.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(ZT.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(ZT.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(ZT.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(t,e){if((this._alignFlags&t)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:nN;this.isAlignLeft&&t===k8.LEFT?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&t===k8.RIGHT?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&t===k8.CENTER?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&t===k8.TOP?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&t===k8.BOT?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&t===k8.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var t=this._target||this.node.parent;t&&t.getComponent(Xj)&&(t.on(ZT.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(ZT.SIZE_CHANGED,this._setDirtyByMode,this),t.on(ZT.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var t=this._target||this.node.parent;t&&(t.off(ZT.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(ZT.SIZE_CHANGED,this._setDirtyByMode,this),t.off(ZT.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(t){var e=this._target||t;e&&(e.off(ZT.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(ZT.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===U8.ALWAYS&&this._recursiveDirty()},n._setAlign=function(t,e){if(e!==(this._alignFlags&t)>0){var n=(t&f7)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},L(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&k8.TOP)>0},set:function(t){this._setAlign(k8.TOP,t),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&k8.BOT)>0},set:function(t){this._setAlign(k8.BOT,t),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&k8.LEFT)>0},set:function(t){this._setAlign(k8.LEFT,t),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&k8.RIGHT)>0},set:function(t){this._setAlign(k8.RIGHT,t),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&k8.MID)>0},set:function(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=k8.MID):this._alignFlags&=~k8.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&k8.CENTER)>0},set:function(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=k8.CENTER):this._alignFlags&=~k8.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&f7)===f7}},{key:"isStretchHeight",get:function(){return(this._alignFlags&h7)===h7}},{key:"top",get:function(){return this._top},set:function(t){this._top=t,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom=t,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(t){this._left=t,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(t){this._right=t,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(t){this._horizontalCenter=t,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(t){this._verticalCenter=t,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(k8.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(k8.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(k8.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(k8.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(k8.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(k8.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(t){this._alignMode=t,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}}]),e}(ih),F8.AlignMode=U8,X((g8=z8).prototype,"target",[$6,t8],Object.getOwnPropertyDescriptor(g8.prototype,"target"),g8.prototype),X(g8.prototype,"isAlignTop",[e8],Object.getOwnPropertyDescriptor(g8.prototype,"isAlignTop"),g8.prototype),X(g8.prototype,"isAlignBottom",[n8],Object.getOwnPropertyDescriptor(g8.prototype,"isAlignBottom"),g8.prototype),X(g8.prototype,"isAlignLeft",[i8],Object.getOwnPropertyDescriptor(g8.prototype,"isAlignLeft"),g8.prototype),X(g8.prototype,"isAlignRight",[r8],Object.getOwnPropertyDescriptor(g8.prototype,"isAlignRight"),g8.prototype),X(g8.prototype,"isAlignVerticalCenter",[o8],Object.getOwnPropertyDescriptor(g8.prototype,"isAlignVerticalCenter"),g8.prototype),X(g8.prototype,"isAlignHorizontalCenter",[a8],Object.getOwnPropertyDescriptor(g8.prototype,"isAlignHorizontalCenter"),g8.prototype),X(g8.prototype,"isStretchWidth",[s8],Object.getOwnPropertyDescriptor(g8.prototype,"isStretchWidth"),g8.prototype),X(g8.prototype,"isStretchHeight",[c8],Object.getOwnPropertyDescriptor(g8.prototype,"isStretchHeight"),g8.prototype),X(g8.prototype,"top",[l8],Object.getOwnPropertyDescriptor(g8.prototype,"top"),g8.prototype),X(g8.prototype,"editorTop",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"editorTop"),g8.prototype),X(g8.prototype,"bottom",[u8],Object.getOwnPropertyDescriptor(g8.prototype,"bottom"),g8.prototype),X(g8.prototype,"editorBottom",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"editorBottom"),g8.prototype),X(g8.prototype,"left",[h8],Object.getOwnPropertyDescriptor(g8.prototype,"left"),g8.prototype),X(g8.prototype,"editorLeft",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"editorLeft"),g8.prototype),X(g8.prototype,"right",[f8],Object.getOwnPropertyDescriptor(g8.prototype,"right"),g8.prototype),X(g8.prototype,"editorRight",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"editorRight"),g8.prototype),X(g8.prototype,"horizontalCenter",[p8],Object.getOwnPropertyDescriptor(g8.prototype,"horizontalCenter"),g8.prototype),X(g8.prototype,"editorHorizontalCenter",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"editorHorizontalCenter"),g8.prototype),X(g8.prototype,"verticalCenter",[_8],Object.getOwnPropertyDescriptor(g8.prototype,"verticalCenter"),g8.prototype),X(g8.prototype,"editorVerticalCenter",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"editorVerticalCenter"),g8.prototype),X(g8.prototype,"isAbsoluteTop",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"isAbsoluteTop"),g8.prototype),X(g8.prototype,"isAbsoluteBottom",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"isAbsoluteBottom"),g8.prototype),X(g8.prototype,"isAbsoluteLeft",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"isAbsoluteLeft"),g8.prototype),X(g8.prototype,"isAbsoluteRight",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"isAbsoluteRight"),g8.prototype),X(g8.prototype,"isAbsoluteHorizontalCenter",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"isAbsoluteHorizontalCenter"),g8.prototype),X(g8.prototype,"isAbsoluteVerticalCenter",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"isAbsoluteVerticalCenter"),g8.prototype),X(g8.prototype,"alignMode",[d8,m8],Object.getOwnPropertyDescriptor(g8.prototype,"alignMode"),g8.prototype),X(g8.prototype,"alignFlags",[bl],Object.getOwnPropertyDescriptor(g8.prototype,"alignFlags"),g8.prototype),y8=X(g8.prototype,"_alignFlags",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x8=X(g8.prototype,"_target",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S8=X(g8.prototype,"_left",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b8=X(g8.prototype,"_right",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T8=X(g8.prototype,"_top",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E8=X(g8.prototype,"_bottom",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C8=X(g8.prototype,"_horizontalCenter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w8=X(g8.prototype,"_verticalCenter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A8=X(g8.prototype,"_isAbsLeft",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),P8=X(g8.prototype,"_isAbsRight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I8=X(g8.prototype,"_isAbsTop",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R8=X(g8.prototype,"_isAbsBottom",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),D8=X(g8.prototype,"_isAbsHorizontalCenter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),O8=X(g8.prototype,"_isAbsVerticalCenter",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),M8=X(g8.prototype,"_originalWidth",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),N8=X(g8.prototype,"_originalHeight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L8=X(g8.prototype,"_alignMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U8.ON_WINDOW_RESIZE}}),B8=X(g8.prototype,"_lockFlags",[hl,pl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v8=g8))||v8)||v8)||v8)||v8)||v8)||v8));i.internal.computeInverseTransForTarget=W8,i.internal.getReadonlyNodeSize=j8;var _7,d7=new di;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(_7||(_7={})),Zt(_7);var m7,v7,g7,y7,x7,S7,b7,T7,E7,C7,w7,A7,P7,I7,R7,D7,O7,M7,N7,L7,B7,F7,z7,U7,k7,G7,H7,V7,j7,W7,q7,X7,Y7,K7,Q7,Z7,J7,$7,t9,e9,n9,i9,r9,o9,a9,s9,c9=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((q8=ol("cc.PageViewIndicator"),X8=Sl(),Y8=sl(110),K8=vl(),Q8=kl(EV),Z8=wl(),J8=kl(_7),$8=wl(),t7=kl(Vi),e7=wl(),n7=wl(),q8(i7=X8(i7=Y8(i7=K8((u7=l7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"spacing",o7,V(e)),q(e,"_spriteFrame",a7,V(e)),q(e,"_direction",s7,V(e)),q(e,"_cellSize",c7,V(e)),e._layout=null,e._pageView=null,e._indicators=[],e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(t){this._pageView=t,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(a3),this._layout||(this._layout=this.addComponent(a3));var t=this._layout;this.direction===_7.HORIZONTAL?(t.type=a3.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===_7.VERTICAL&&(t.type=a3.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=a3.ResizeMode.CONTAINER},n._createIndicator=function(){var t=new $C;t.layer=this.node.layer;var e=t.addComponent(rQ);return e.spriteFrame=this.spriteFrame,e.sizeMode=rQ.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t},n._changedState=function(){var t=this._indicators;if(0!==t.length&&this._pageView){var e=this._pageView.curPageIdx;if(!(e>=t.length)){for(var n=0;n<t.length;++n){var i=t[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;d7.set(r.color),d7.a=127.5,r.color=d7}}if(t[e]._uiProps.uiComp){var o=t[e]._uiProps.uiComp;d7.set(o.color),d7.a=255,o.color=d7}}}},n._refresh=function(){if(this._pageView){var t=this._indicators,e=this._pageView.getPages();if(e.length!==t.length){var n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){var i=t[n-1];this.node.removeChild(i),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},L(e,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._spriteFrame!==t&&(this._spriteFrame=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t)}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize=t)}}]),e}(ih),l7.Direction=_7,X((r7=u7).prototype,"spriteFrame",[Q8,Z8],Object.getOwnPropertyDescriptor(r7.prototype,"spriteFrame"),r7.prototype),X(r7.prototype,"direction",[J8,$8],Object.getOwnPropertyDescriptor(r7.prototype,"direction"),r7.prototype),X(r7.prototype,"cellSize",[t7,e7],Object.getOwnPropertyDescriptor(r7.prototype,"cellSize"),r7.prototype),o7=X(r7.prototype,"spacing",[hl,n7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a7=X(r7.prototype,"_spriteFrame",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),s7=X(r7.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _7.HORIZONTAL}}),c7=X(r7.prototype,"_cellSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi(20,20)}}),i7=r7))||i7)||i7)||i7)||i7)),l9=new Bi;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(o9||(o9={})),Zt(o9),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(a9||(a9={})),Zt(a9),function(t){t.PAGE_TURNING="page-turning"}(s9||(s9={}));var u9=function(e){return t({PageView:e,PageViewComponent:e}),e}((m7=ol("cc.PageView"),v7=Sl(),g7=sl(110),y7=vl(),x7=kl(o9),S7=wl(),b7=kl(a9),T7=wl(),E7=Al(),C7=wl(),w7=Al(),A7=wl(),P7=kl(c9),I7=wl(),R7=wl(),D7=kl(N5),O7=Tl(),M7=kl(N5),N7=Tl(),L7=Tl(),B7=Tl(),F7=Tl(),z7=kl([YB]),U7=Tl(),k7=wl(),G7=kl([YB]),H7=wl(),m7(V7=v7(V7=g7(V7=y7((r9=i9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"autoPageTurningThreshold",W7,V(e)),q(e,"horizontal",q7,V(e)),q(e,"vertical",X7,V(e)),q(e,"cancelInnerEvents",Y7,V(e)),q(e,"scrollEvents",K7,V(e)),q(e,"pageTurningSpeed",Q7,V(e)),q(e,"pageEvents",Z7,V(e)),q(e,"_sizeMode",J7,V(e)),q(e,"_direction",$7,V(e)),q(e,"_scrollThreshold",t9,V(e)),q(e,"_pageTurningEventTiming",e9,V(e)),q(e,"_indicator",n9,V(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new vi,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new Bi,e._touchEndPosition=new Bi,e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.node.on(ZT.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(ZT.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(t){this.scrollToPage(t,1)},n.getPages=function(){return this._pages},n.addPage=function(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):b(4301))},n.insertPage=function(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void b(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}},n.removePage=function(t){if(t&&this.content){var e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):E(4300,t.name)}},n.removePageAtIndex=function(t){var e=this._pages;if(!(t<0||t>=e.length)){var n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var t=this._pages,e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var t=this.content.getComponent(a3);t&&t.enabled&&t.updateLayout();var e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<e;++i){var r=this._pages[i].position;this.direction===a9.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var t=this.view;if(this.content&&t&&this._sizeMode===o9.Unified)for(var e=this._pages,n=t.contentSize,i=0,r=e.length;i<r;i++)e[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))},n._onTouchBegan=function(e,n){e.touch.getUILocation(l9),Bi.set(this._touchBeganPosition,l9.x,l9.y),t.prototype._onTouchBegan.call(this,e,n)},n._onTouchMoved=function(e,n){t.prototype._onTouchMoved.call(this,e,n)},n._onTouchEnded=function(e,n){e.touch.getUILocation(l9),Bi.set(this._touchEndPosition,l9.x,l9.y),t.prototype._onTouchEnded.call(this,e,n)},n._onTouchCancelled=function(e,n){e.touch.getUILocation(l9),Bi.set(this._touchEndPosition,l9.x,l9.y),t.prototype._onTouchCancelled.call(this,e,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===a9.Horizontal,this.vertical=this.direction===a9.Vertical},n._syncSizeMode=function(){var t=this.view;if(this.content&&t){var e=this.content.getComponent(a3);if(e){if(this._sizeMode===o9.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===a9.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===a9.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var t=this.content.children,e=0;e<t.length;++e){var n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,YB.emitEvents(this.pageEvents,this,s9.PAGE_TURNING),this.node.emit(s9.PAGE_TURNING,this))},n._isQuicklyScrollable=function(t){if(this.direction===a9.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===a9.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(t){var e=new Bi;if(this._sizeMode===o9.Free)this.direction===a9.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===a9.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{var n=this.view;if(!n)return e;this.direction===a9.Horizontal?e.x=t*n.width:this.direction===a9.Vertical&&(e.y=t*n.height)}return e},n._getDragDirection=function(t){return this._direction===a9.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1},n._isScrollable=function(t,e,n){if(this._sizeMode===o9.Free){var i=0,r=0;if(this.direction===a9.Horizontal)return i=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===a9.Vertical)return i=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===a9.Horizontal)return Math.abs(t.x)>=o.width*this.scrollThreshold;if(this.direction===a9.Vertical)return Math.abs(t.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new Bi;Bi.subtract(e,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(e),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(e,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},L(e,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}},{key:"indicator",get:function(){return this._indicator},set:function(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return t.prototype.verticalScrollBar},set:function(t){this.verticalScrollBar=t}},{key:"horizontalScrollBar",get:function(){return t.prototype.horizontalScrollBar},set:function(t){this.horizontalScrollBar=t}}]),e}(f6),i9.SizeMode=o9,i9.Direction=a9,i9.EventType=L6(s9,B5),X((j7=r9).prototype,"sizeMode",[x7,S7],Object.getOwnPropertyDescriptor(j7.prototype,"sizeMode"),j7.prototype),X(j7.prototype,"direction",[b7,T7],Object.getOwnPropertyDescriptor(j7.prototype,"direction"),j7.prototype),X(j7.prototype,"scrollThreshold",[Dl,E7,C7],Object.getOwnPropertyDescriptor(j7.prototype,"scrollThreshold"),j7.prototype),X(j7.prototype,"pageTurningEventTiming",[Dl,w7,A7],Object.getOwnPropertyDescriptor(j7.prototype,"pageTurningEventTiming"),j7.prototype),X(j7.prototype,"indicator",[P7,I7],Object.getOwnPropertyDescriptor(j7.prototype,"indicator"),j7.prototype),W7=X(j7.prototype,"autoPageTurningThreshold",[hl,R7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),X(j7.prototype,"verticalScrollBar",[D7,Ql,O7],Object.getOwnPropertyDescriptor(j7.prototype,"verticalScrollBar"),j7.prototype),X(j7.prototype,"horizontalScrollBar",[M7,Ql,N7],Object.getOwnPropertyDescriptor(j7.prototype,"horizontalScrollBar"),j7.prototype),q7=X(j7.prototype,"horizontal",[Ql,hl,L7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X7=X(j7.prototype,"vertical",[Ql,hl,B7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y7=X(j7.prototype,"cancelInnerEvents",[Ql,hl,F7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),K7=X(j7.prototype,"scrollEvents",[z7,hl,Ql,U7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Q7=X(j7.prototype,"pageTurningSpeed",[hl,bl,k7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Z7=X(j7.prototype,"pageEvents",[G7,hl,H7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),J7=X(j7.prototype,"_sizeMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o9.Unified}}),$7=X(j7.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a9.Horizontal}}),t9=X(j7.prototype,"_scrollThreshold",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),e9=X(j7.prototype,"_pageTurningEventTiming",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),n9=X(j7.prototype,"_indicator",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V7=j7))||V7)||V7)||V7)||V7)),h9=new vi,f9=new Bi,p9=new Bi,_9=new Bi(1,1),d9=new Bi,m9=new Bi;function v9(t,e){if(!e._hadAlignOnce){e.alignMode===U8.ONCE&&(e._hadAlignOnce=!0);var n,i=e.target,r=p9,o=_9;i?W8(t,n=i,r,o):n=t.parent;var a=j8(n),s=n instanceof DD||!n.getComponent(Xj),c=s?f9:n.getComponent(Xj).anchorPoint,l=s;t.getPosition(h9);var u=t._uiProps.uiTransformComp,h=h9.x,f=h9.y,p=u.anchorPoint,_=t.getScale();if(e.alignFlags&k8.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=nN.left.x,m=nN.right.x):m=(d=-c.x*v)+v,d+=e.isAbsoluteLeft?e.left:e.left*v,m-=e.isAbsoluteRight?e.right:e.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=p.x,x=_.x;if(x<0&&(y=1-y,x=-x),e.isStretchWidth)g=m-d,0!==x&&(u.width=g/x),h=d+y*g;else if(g=u.width*x,e.isAlignHorizontalCenter){var S=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*v,b=(.5-c.x)*a.width;i&&(S*=o.x,b+=r.x,b*=o.x),h=b+(y-.5)*g+S}else h=e.isAlignLeft?d+y*g:m+(y-1)*g;e._lastSize.width=g}if(e.alignFlags&k8.VERTICAL){var T=0,E=0,C=a.height;l?(E=nN.bottom.y,T=nN.top.y):T=(E=-c.y*C)+C,E+=e.isAbsoluteBottom?e.bottom:e.bottom*C,T-=e.isAbsoluteTop?e.top:e.top*C,i&&(E+=r.y,E*=o.y,T+=r.y,T*=o.y);var w=0,A=p.y,P=_.y;if(P<0&&(A=1-A,P=-P),e.isStretchHeight)w=T-E,0!==P&&(u.height=w/P),f=E+A*w;else if(w=u.height*P,e.isAlignVerticalCenter){var I=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*C,R=(.5-c.y)*a.height;i&&(I*=o.y,R+=r.y,R*=o.y),f=R+(A-.5)*w+I}else f=e.isAlignBottom?E+A*w:T+(A-1)*w;e._lastSize.height=w}t.setPosition(h,f,h9.z),vi.set(e._lastPos,h,f,h9.z)}}function g9(t){var e=t.getComponent(p7);if(e&&e.enabled){if(!i.isValid(t,!0))return;S9.push(e)}for(var n,r=W(t.children);!(n=r()).done;){var o=n.value;o.active&&g9(o)}}function y9(){var t=$M.getScene();if(t){b9.isAligning=!0,b9._nodesOrderDirty&&(S9.length=0,g9(t),b9._nodesOrderDirty=!1);var e=null,n=b9._activeWidgetsIterator;for(n.i=0;n.i<S9.length;++n.i)(e=S9[n.i])._dirty&&(v9(e.node,e),e._dirty=!1);b9.isAligning=!1}}var x9,S9=[],b9=t("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new kt.MutableForwardIterator(S9),animationState:null,init:function(){$M.on(JM.EVENT_AFTER_SCENE_LAUNCH,y9),$M.on(JM.EVENT_AFTER_UPDATE,y9),oN.instance.on("design-resolution-changed",this.onResized,this);var t=this.onResized.bind(this);oN.instance.on("canvas-resize",t),uh.on("orientation-change",t)},add:function(){this._nodesOrderDirty=!0},remove:function(t){this._activeWidgetsIterator.remove(t)},onResized:function(){var t=$M.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized:function(t){var e=$C.isNode(t)&&t.getComponent(p7);e&&e.enabled&&(e.alignMode===U8.ON_WINDOW_RESIZE||e.alignMode===U8.ALWAYS)&&e.setDirty();for(var n,i=W(t.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}var i=t.node,r=i.parent;if(r){var o=d9;o.set(0,0);var a=m9;if(a.set(1,1),t.target&&W8(i,r=t.target,o,a),!e)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:f9,l=i._uiProps.uiTransformComp,u=j8(r),h=l.anchorPoint,f=i.getPosition(),p=k8,_=i.getScale(),d=0;if(e&p.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=f.x-h.x*l.width*_.x-m,t.isAbsoluteLeft||(d/=u.width),d/=a.x,t.left=n(t.left,d)}if(e&p.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(f.x+(1-h.x)*l.width*_.x),t.isAbsoluteRight||(d/=u.width),d/=a.x,t.right=n(t.right,d)}if(e&p.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(f.y+(1-h.y)*l.height*_.y),t.isAbsoluteTop||(d/=u.height),d/=a.y,t.top=n(t.top,d)}if(e&p.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=f.y-h.y*l.height*_.y-y,t.isAbsoluteBottom||(d/=u.height),d/=a.y,t.bottom=n(t.bottom,d)}}},updateAlignment:function t(e){var n=e.parent;n&&$C.isNode(n)&&t(n);var i=e.getComponent(p7);i&&n&&v9(e,i)},AlignMode:U8,AlignFlags:k8});$M.on(JM.EVENT_INIT,(function(){b9.init()}));var T9,E9,C9,w9,A9,P9,I9,R9,D9,O9,M9,N9,L9,B9,F9,z9,U9,k9,G9,H9,V9=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(ol("cc.SafeArea")(x9=Sl()(x9=sl(110)(x9=ml(x9=vl()(x9=al(p7)(x9=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.onEnable=function(){this.updateArea(),uh.on("window-resize",this.updateArea,this),uh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){uh.off("window-resize",this.updateArea,this),uh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var t=this.node.getComponent(p7),e=this.node.getComponent(Xj);if(t&&e){t.updateAlignment();var n=this.node.position.clone(),i=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;var r=lN.getVisibleSize(),o=r.width,a=r.height,s=ph.getSafeAreaRect();t.top=a-s.y-s.height,t.bottom=s.y,t.left=s.x,t.right=o-s.x-s.width,t.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/e.width,u=i.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,u),b9.add(t)}},e}(ih))||x9)||x9)||x9)||x9)||x9)||x9),j9=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((T9=ol("cc.UICoordinateTracker"),E9=Sl(),C9=vl(),w9=sl(110),A9=kl($C),P9=wl(),I9=kl(pF),R9=wl(),D9=wl(),O9=wl(),M9=kl([YB]),N9=wl(),T9(L9=E9(L9=C9(L9=w9((X((B9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"syncEvents",F9,V(e)),q(e,"_target",z9,V(e)),q(e,"_camera",U9,V(e)),q(e,"_useScale",k9,V(e)),q(e,"_distance",G9,V(e)),e._transformPos=new vi,e._viewPos=new vi,e._canMove=!0,e._lastWPos=new vi,e._lastCameraPos=new vi,e}F(e,t);var n=e.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&vi.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);YB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},L(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._target=t,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(t){this._useScale!==t&&(this._useScale=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t)}}]),e}(ih)).prototype,"target",[A9,P9],Object.getOwnPropertyDescriptor(B9.prototype,"target"),B9.prototype),X(B9.prototype,"camera",[I9,R9],Object.getOwnPropertyDescriptor(B9.prototype,"camera"),B9.prototype),X(B9.prototype,"useScale",[D9],Object.getOwnPropertyDescriptor(B9.prototype,"useScale"),B9.prototype),X(B9.prototype,"distance",[O9],Object.getOwnPropertyDescriptor(B9.prototype,"distance"),B9.prototype),F9=X(B9.prototype,"syncEvents",[M9,hl,N9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z9=X(B9.prototype,"_target",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U9=X(B9.prototype,"_camera",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k9=X(B9.prototype,"_useScale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G9=X(B9.prototype,"_distance",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),L9=B9))||L9)||L9)||L9)||L9)),W9=[ZT.TOUCH_START,ZT.TOUCH_END,ZT.TOUCH_MOVE,ZT.MOUSE_DOWN,ZT.MOUSE_MOVE,ZT.MOUSE_UP,ZT.MOUSE_ENTER,ZT.MOUSE_LEAVE,ZT.MOUSE_WHEEL];function q9(t){t.propagationStopped=!0}var X9,Y9,K9,Q9,Z9,J9,$9,ttt,ett,ntt,itt,rtt,ott=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(ol("cc.BlockInputEvents")(H9=Sl()(H9=vl()(H9=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.onEnable=function(){for(var t=0;t<W9.length;t++)this.node.on(W9[t],q9,this)},n.onDisable=function(){for(var t=0;t<W9.length;t++)this.node.off(W9[t],q9,this)},e}(ih))||H9)||H9)||H9),att={},stt=t("SubContextView",(X9=ol("cc.SubContextView"),Y9=Sl(),K9=sl(110),Q9=al(Xj),Z9=vl(),J9=wl(),$9=wl(),X9(ttt=Y9(ttt=K9(ttt=Q9(ttt=Z9((X((ett=function(t){function e(){var e;return q(e=t.call(this)||this,"_fps",ntt,V(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,q(e,"_designResolutionSize",itt,V(e)),e._content=new $C("content"),e._content.hideFlags|=Ye.Flags.DontSave|Ye.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new Fm,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new cv,e}F(e,t);var n=e.prototype;return n.onLoad=function(){att.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=att.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(rQ),this._sprite||(this._sprite=this._content.addComponent(rQ)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new EV;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var t=this.node.getComponent(Xj),e=this._content.getComponent(Xj),n=t.width/e.width,i=t.height/e.height,r=n>i?i:n;e.width*=r,e.height*=r;var o=lN.getViewportRect(),a=e.getBoundingBoxToWorld(),s=lN.getVisibleSize(),c=uh.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,f=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:f})}},n._updateSubContextTexture=function(){var t=this._imageAsset;if(t&&this._openDataContext&&!(t.width<=0||t.height<=0)){var e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}},n._registerNodeEvent=function(){this.node.on(ZT.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(ZT.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(ZT.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(ZT.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(ZT.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(ZT.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(t){void 0===t?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},L(e,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}}]),e}(ih)).prototype,"designResolutionSize",[J9],Object.getOwnPropertyDescriptor(ett.prototype,"designResolutionSize"),ett.prototype),X(ett.prototype,"fps",[$9],Object.getOwnPropertyDescriptor(ett.prototype,"fps"),ett.prototype),ntt=X(ett.prototype,"_fps",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),itt=X(ett.prototype,"_designResolutionSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi(640,960)}}),ttt=ett))||ttt)||ttt)||ttt)||ttt)||ttt));i.SubContextView=stt;var ctt,ltt=t("UIReorderComponent",ol("cc.UIReorderComponent")(rtt=function(){E(1408,"UIReorderComponent")})||rtt);i.UIReorderComponent=ltt,i.ButtonComponent=p1,Gt.setClassAlias(p1,"cc.ButtonComponent"),i.EditBoxComponent=L4,Gt.setClassAlias(L4,"cc.EditBoxComponent"),i.LayoutComponent=a3,Gt.setClassAlias(a3,"cc.LayoutComponent"),i.ProgressBarComponent=O3,Gt.setClassAlias(O3,"cc.ProgressBarComponent"),i.ScrollViewComponent=f6,Gt.setClassAlias(f6,"cc.ScrollViewComponent"),i.ScrollBarComponent=N5,Gt.setClassAlias(N5,"cc.ScrollBarComponent"),i.SliderComponent=N6,Gt.setClassAlias(N6,"cc.SliderComponent"),i.ToggleComponent=G8,Gt.setClassAlias(G8,"cc.ToggleComponent"),i.ToggleContainerComponent=H8,Gt.setClassAlias(H8,"cc.ToggleContainerComponent"),i.WidgetComponent=p7,Gt.setClassAlias(p7,"cc.WidgetComponent"),i.PageViewComponent=u9,Gt.setClassAlias(u9,"cc.PageViewComponent"),i.PageViewIndicatorComponent=c9,Gt.setClassAlias(c9,"cc.PageViewIndicatorComponent"),i.SafeAreaComponent=V9,Gt.setClassAlias(V9,"cc.SafeAreaComponent"),Gt.setClassAlias(j9,"cc.UICoordinateTrackerComponent"),i.BlockInputEventsComponent=ott,Gt.setClassAlias(ott,"cc.BlockInputEventsComponent"),function(t){t[t.positions=co.ATTR_POSITION]="positions",t[t.normals=co.ATTR_NORMAL]="normals",t[t.uvs=co.ATTR_TEX_COORD]="uvs",t[t.colors=co.ATTR_COLOR]="colors"}(ctt||(ctt={}));var utt,htt,ftt,ptt,_tt,dtt=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;this._arrayBufferOrPaddings.push(n),this._length+=n}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n),e),e+=n.byteLength)})),t.buffer},t}(),mtt=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>wd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new gtt(this._mesh,i,this._mesh.struct.morph,e):this._subMeshRenderings[i]=new vtt(this._mesh,i,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,n=new Array(e),i=0;i<e;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var i;null===(i=n[t])||void 0===i||i.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var i=t._mesh.struct.morph.subMeshMorphs[e],r=n[e];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(co.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(co.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(co.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(t,e){var i;null===(i=n[t])||void 0===i||i.adaptPipelineState(e)},destroy:function(){for(var t,e=W(n);!(t=e()).done;){var i=t.value;null==i||i.destroy()}}}},t}(),vtt=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[e];this._subMeshMorph=r,btt(t,e,i);var o=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=Stt(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(e,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(e,i){for(var r=e.displacements[n],s=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=W(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new xtt(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=W(t._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case co.ATTR_POSITION:a=Dd;break;case co.ATTR_NORMAL:a=Nd;break;case co.ATTR_TANGENT:a=Fd;break;default:_("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(wd.BINDING,e.buffer),n.update()},destroy:function(){}}},t}(),gtt=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[e];btt(t,e,i),this._attributes=r.attributes.map((function(e,n){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}}))}}))}return t.prototype.createInstance=function(){return new ytt(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},L(t,[{key:"data",get:function(){return this._attributes}}]),t}(),ytt=function(){function t(t,e,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new xtt(n,0);var i=Stt(n,e);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=i.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var n=this._attributes[e],i=n.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=t[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,n=W(this._attributes);!(e=n()).done;){var i=e.value,r=void 0;switch(i.attributeName){case co.ATTR_POSITION:r=Dd;break;case co.ATTR_NORMAL:r=Nd;break;case co.ATTR_TANGENT:r=Fd;break;default:_("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,i.morphTexture.sampler),t.bindTexture(r,i.morphTexture.texture))}t.bindBuffer(wd.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),xtt=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(wd.SIZE)),this._remoteBuffer=t.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,wd.SIZE,wd.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32(wd.OFFSET_OF_WEIGHTS+4*e,t[e],i.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,i.sys.isLittleEndian),this._localBuffer.setFloat32(wd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,i.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32(wd.OFFSET_OF_VERTICES_COUNT,t,i.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},L(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function Stt(t,e){var n,i,r,o;t.hasFeature(br.TEXTURE_FLOAT)?(n=e,r=16,i=cv.PixelFormat.RGBA32F,o=Float32Array):(n=4*e,r=4,i=cv.PixelFormat.RGBA8888,o=Uint8Array);var a=function(t){t<5&&(t=5);var e=Dn(Mn(t)),n=e>>1;return{width:1<<(1&e?n+1:n),height:1<<n}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var e=new ArrayBuffer(s*c*r),n=new Float32Array(e),a=o===Float32Array?n:new o(e),l=new Fm({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new cv;u.setFilters(cv.Filter.NEAREST,cv.Filter.NEAREST),u.setMipFilter(cv.Filter.NONE),u.setWrapMode(cv.WrapMode.CLAMP_TO_EDGE,cv.WrapMode.CLAMP_TO_EDGE,cv.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||_("Unexpected: failed to create morph texture?");var h=t.getSampler(u.getSamplerInfo());return{get texture(){return u.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}function btt(t,e,n){t.renderingSubMeshes[e].enableVertexIdChannel(n)}function Ttt(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var Ett=new vi,Ctt=new vi,wtt=new Uint8Array,Att=ol("cc.Mesh")((_tt=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,q(e,"_struct",ftt,V(e)),q(e,"_hash",ptt,V(e)),e._data=wtt,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}F(e,t);var n=e.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var t=this._data.buffer,e=i.director.root.device,n=this._createVertexBuffers(e,t),r=[],o=0;o<this._struct.primitives.length;o++){var a=this._struct.primitives[o];if(0!==a.vertexBundelIndices.length){var s=null,c=null;if(a.indexView){var l=a.indexView,u=l.stride,h=l.length;if(4===u&&!e.hasFeature(br.ELEMENT_INDEX_UINT)){var f=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(f>=65536){E(10001,f,65536);continue}u>>=1,h>>=1}s=e.createBuffer(new Co(wr.INDEX,Ir.DEVICE,h,u)),c=new(Ttt(l.stride))(t,l.offset,l.count),l.stride!==u&&(c=Ttt(u).from(c)),s.update(c)}var p=a.vertexBundelIndices.map((function(t){return n[t]})),_=[];if(a.vertexBundelIndices.length>0)for(var d=a.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];_[v]=new Ho(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new Qw(p,_,a.primitiveMode,s);y.mesh=this,y.subMeshIdx=o,r.push(y)}}this._renderingSubMeshes=r,this._struct.morph&&(this.morphRendering=function(t,e){return new mtt(t,e)}(this,e))}},n.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(t,e){this.reset({struct:t,data:e})},n.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},n.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var n=[],i=t.bindposes,r=0;r<i.length;r++)e.push(new Bc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,co.ATTR_JOINTS),c=this.readAttribute(a,co.ATTR_WEIGHTS),l=this.readAttribute(a,co.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){vi.set(Ett,l[3*h+0],l[3*h+1],l[3*h+2]);for(var f=0;f<4;++f){var p=4*h+f,_=s[p];if(!(0===c[p]||_>=i.length)){vi.transformMat4(Ctt,Ett,i[_]),n[_]=!0;var d=e[_];vi.min(d.center,d.center,Ctt),vi.max(d.halfExtents,d.halfExtents,Ctt)}}}}for(var m=0;m<i.length;m++){var v=e[m];n[m]?Bc.fromPoints(v,v.center,v.halfExtents):e[m]=null}return e},n.merge=function(t,e,n){if(n&&!this.validateMergingMesh(t))return!1;var i=new vi,r=e&&new Ei,o=e&&new Bc;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),s=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(vi.add(o.center,a.maxPosition,a.minPosition),vi.multiplyScalar(o.center,o.center,.5),vi.subtract(o.halfExtents,a.maxPosition,a.minPosition),vi.multiplyScalar(o.halfExtents,o.halfExtents,.5),Bc.transform(o,o,e),vi.add(a.maxPosition,o.center,o.halfExtents),vi.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===co.ATTR_POSITION||l.attributes[u].name===co.ATTR_NORMAL){var h=l.attributes[u].format,f=new DataView(s.buffer,l.view.offset+Ptt(l.attributes,u)),p=Dtt(f,h),_=Ott(f,h);if(!p||!_)continue;for(var d=l.view.count,m=l.view.stride,v=Rtt(h),g=0;g<d;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(p(y),p(x),p(S)),l.attributes[u].name){case co.ATTR_POSITION:i.transformMat4(e);break;case co.ATTR_NORMAL:vi.transformQuat(i,i,r)}_(y,i.x),_(x,i.y),_(S,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var b,T,E,C,w,A=new dtt,P=0,I=0,R=0,D=0,O=0,M=0,N=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],k=t._struct.vertexBundles[z];R=U.view.offset,D=k.view.offset,I=U.view.stride,P=U.view.count+k.view.count,b=new ArrayBuffer(P*I),T=new Uint8Array(b),R+=(E=this._data.subarray(R,R+U.view.length)).length,D+=(C=t._data.subarray(D,D+k.view.length)).length,T.set(E),O=0;for(var G,H=W(U.attributes);!(G=H()).done;){var V=G.value;N=0,B=!1;for(var j,q=W(k.attributes);!(j=q()).done;){var X=j.value;if(V.name===X.name&&V.format===X.format){B=!0;break}N+=fa[X.format].size}if(B){L=fa[V.format].size,M=U.view.length+O;for(var Y=0;Y<k.view.count;++Y){if(w=C.subarray(N,N+L),T.set(w,M),(V.name===co.ATTR_POSITION||V.name===co.ATTR_NORMAL)&&e){var K=new Float32Array(T.buffer,M,3);switch(i.set(K[0],K[1],K[2]),V.name){case co.ATTR_POSITION:i.transformMat4(e);break;case co.ATTR_NORMAL:vi.transformQuat(i,i,r)}K[0]=i.x,K[1]=i.y,K[2]=i.z}M+=U.view.stride,N+=k.view.stride}}O+=fa[V.format].size}F[z]={attributes:U.attributes,view:{offset:A.getLength(),length:b.byteLength,count:P,stride:I}},A.addBuffer(b)}for(var Q,Z,J,$=0,tt=2,et=0,nt=new Array(this._struct.primitives.length),it=0;it<this._struct.primitives.length;++it){var rt=this._struct.primitives[it],ot=t._struct.primitives[it];nt[it]={primitiveMode:rt.primitiveMode,vertexBundelIndices:rt.vertexBundelIndices};for(var at,st=W(rt.vertexBundelIndices);!(at=st()).done;){var ct=at.value;et=Math.max(et,this._struct.vertexBundles[ct].view.count)}if(rt.indexView&&ot.indexView){$=rt.indexView.count,$+=ot.indexView.count,R=rt.indexView.offset,D=ot.indexView.offset,tt=$<256?1:$<65536?2:4;var lt=new ArrayBuffer($*tt);if(Q=2===tt?new Uint16Array(lt):1===tt?new Uint8Array(lt):new Uint32Array(lt),Z=2===rt.indexView.stride?new Uint16Array(this._data.buffer,R,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(this._data.buffer,R,rt.indexView.count):new Uint32Array(this._data.buffer,R,rt.indexView.count),tt===rt.indexView.stride)Q.set(Z);else for(var ut=0;ut<rt.indexView.count;++ut)Q[ut]=Z[ut];R+=rt.indexView.length,J=2===ot.indexView.stride?new Uint16Array(t._data.buffer,D,ot.indexView.count):1===ot.indexView.stride?new Uint8Array(t._data.buffer,D,ot.indexView.count):new Uint32Array(t._data.buffer,D,ot.indexView.count);for(var ht=0;ht<ot.indexView.count;++ht)Q[rt.indexView.count+ht]=et+J[ht];D+=ot.indexView.length,nt[it].indexView={offset:A.getLength(),length:lt.byteLength,count:$,stride:tt},A.setNextAlignment(tt),A.addBuffer(lt)}}var ft={vertexBundles:F,primitives:nt,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ft.minPosition&&t._struct.minPosition&&ft.maxPosition&&t._struct.maxPosition&&(e?(vi.add(o.center,t._struct.maxPosition,t._struct.minPosition),vi.multiplyScalar(o.center,o.center,.5),vi.subtract(o.halfExtents,t._struct.maxPosition,t._struct.minPosition),vi.multiplyScalar(o.halfExtents,o.halfExtents,.5),Bc.transform(o,o,e),vi.add(i,o.center,o.halfExtents),vi.max(ft.maxPosition,ft.maxPosition,i),vi.subtract(i,o.center,o.halfExtents),vi.min(ft.minPosition,ft.minPosition,i)):(vi.min(ft.minPosition,ft.minPosition,t._struct.minPosition),vi.max(ft.maxPosition,ft.maxPosition,t._struct.maxPosition))),this.reset({struct:ft,data:new Uint8Array(A.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var n=this._struct.vertexBundles[e],i=t._struct.vertexBundles[e];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=t._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(t,e){var n=this,i=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,o=t.attributes[e].format,a=ba(fa[o]);if(0!==r){var s=new DataView(n._data.buffer,t.view.offset+Ptt(t.attributes,e)),c=fa[o],l=Dtt(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),f=t.view.stride,p=0;p<r;++p)for(var _=0;_<u;++_)h[u*p+_]=l(f*p+h.BYTES_PER_ELEMENT*_);i=h}}})),i},n.copyAttribute=function(t,e,n,i,r){var o=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var s=t.view.count;if(0!==s){var c=t.attributes[e].format,l=new DataView(o._data.buffer,t.view.offset+Ptt(t.attributes,e)),u=new DataView(n,r),h=fa[c],f=Dtt(l,c),p=Ott(u,c);if(f&&p){for(var _=h.count,d=t.view.stride,m=Rtt(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<_;++x)p(v*y+g*x,f(d*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var n=e.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},n.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var n=this._struct.primitives[t];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?Tr.R8UI:2===n.indexView.stride?Tr.R16UI:Tr.R32UI,o=Dtt(new DataView(this._data.buffer),r),a=0;a<i;++a)e[a]=o(n.indexView.offset+fa[r].size*a);return!0},n._accessAttribute=function(t,e,n){if(!(t>=this._struct.primitives.length))for(var i,r=W(this._struct.primitives[t].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(t){return t.name===e}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(n){var i=t.createBuffer(new Co(wr.VERTEX,Ir.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(e,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:wtt})},L(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=Da(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),e}(Bu),ftt=X((htt=_tt).prototype,"_struct",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),ptt=X(htt.prototype,"_hash",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),utt=htt))||utt;function Ptt(t,e){for(var n=0,i=0;i<e;++i){var r=t[i];n+=fa[r.format].size}return n}i.Mesh=Att;var Itt=ph.isLittleEndian;function Rtt(t){var e=fa[t];return e.size/e.count}function Dtt(t,e){var n=fa[e],i=n.size/n.count;switch(n.type){case Er.UNORM:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Itt)};case 4:return function(e){return t.getUint32(e,Itt)}}break;case Er.SNORM:case Er.INT:switch(i){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Itt)};case 4:return function(e){return t.getInt32(e,Itt)}}break;case Er.UINT:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Itt)};case 4:return function(e){return t.getUint32(e,Itt)}}break;case Er.FLOAT:return function(e){return t.getFloat32(e,Itt)}}return null}function Ott(t,e){var n=fa[e],i=n.size/n.count;switch(n.type){case Er.UNORM:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,Itt)};case 4:return function(e,n){return t.setUint32(e,n,Itt)}}break;case Er.SNORM:case Er.INT:switch(i){case 1:return function(e,n){return t.setInt8(e,n)};case 2:return function(e,n){return t.setInt16(e,n,Itt)};case 4:return function(e,n){return t.setInt32(e,n,Itt)}}break;case Er.UINT:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,Itt)};case 4:return function(e,n){return t.setUint32(e,n,Itt)}}break;case Er.FLOAT:return function(e,n){return t.setFloat32(e,n,Itt)}}return null}var Mtt=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_NORMAL,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RG32F),new Ho(co.ATTR_TANGENT,Tr.RGBA32F),new Ho(co.ATTR_COLOR,Tr.RGBA32F)],Ntt=new vi;function Ltt(t,e,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=t.positions.slice();if(c.length>0){if(i=null,t.attributes)for(var l,u=W(t.attributes);!(l=u()).done;){var h=l.value;if(h.name===co.ATTR_POSITION){i=h;break}}i||(i=Mtt[0]),r.push(i);var f=fa[i.format];s=Math.max(s,Math.floor(c.length/f.count)),a.push({offset:o,data:c,attribute:i}),o+=f.size}if(t.normals&&t.normals.length>0){if(i=null,t.attributes)for(var p,_=W(t.attributes);!(p=_()).done;){var d=p.value;if(d.name===co.ATTR_NORMAL){i=d;break}}i||(i=Mtt[1]);var m=fa[i.format];r.push(i),s=Math.max(s,Math.floor(t.normals.length/m.count)),a.push({offset:o,data:t.normals,attribute:i}),o+=m.size}if(t.uvs&&t.uvs.length>0){if(i=null,t.attributes)for(var v,g=W(t.attributes);!(v=g()).done;){var y=v.value;if(y.name===co.ATTR_TEX_COORD){i=y;break}}i||(i=Mtt[2]);var x=fa[i.format];r.push(i),s=Math.max(s,Math.floor(t.uvs.length/x.count)),a.push({offset:o,data:t.uvs,attribute:i}),o+=x.size}if(t.tangents&&t.tangents.length>0){if(i=null,t.attributes)for(var S,b=W(t.attributes);!(S=b()).done;){var T=S.value;if(T.name===co.ATTR_TANGENT){i=T;break}}i||(i=Mtt[3]);var E=fa[i.format];r.push(i),s=Math.max(s,Math.floor(t.tangents.length/E.count)),a.push({offset:o,data:t.tangents,attribute:i}),o+=E.size}if(t.colors&&t.colors.length>0){if(i=null,t.attributes)for(var C,w=W(t.attributes);!(C=w()).done;){var A=C.value;if(A.name===co.ATTR_COLOR){i=A;break}}i||(i=Mtt[4]);var P=fa[i.format];r.push(i),s=Math.max(s,Math.floor(t.colors.length/P.count)),a.push({offset:o,data:t.colors,attribute:i}),o+=P.size}if(t.customAttributes)for(var I,R=W(t.customAttributes);!(I=R()).done;){var D=I.value,O=fa[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/O.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=O.size}for(var M=new dtt,N=new ArrayBuffer(s*o),L=new DataView(N),B=0,F=a;B<F.length;B++){var z=F[B];Ww(L,z.data,z.attribute.format,z.offset,o)}M.setNextAlignment(0);var U={attributes:r,view:{offset:M.getLength(),length:N.byteLength,count:s,stride:o}};M.addBuffer(N);var k=null,G=0;if(t.indices){var H=t.indices;G=H.length,k=new ArrayBuffer(2*G),Ww(new DataView(k),H,Tr.R16UI)}var V={primitiveMode:t.primitiveMode||Yr.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(M.setNextAlignment(2),V.indexView={offset:M.getLength(),length:k.byteLength,count:G,stride:2},M.addBuffer(k));var j=t.minPos;if(!j&&n.calculateBounds){j=vi.set(new vi,1/0,1/0,1/0);for(var q=0;q<s;++q)vi.set(Ntt,c[3*q+0],c[3*q+1],c[3*q+2]),vi.min(j,j,Ntt)}var X=t.maxPos;if(!X&&n.calculateBounds){X=vi.set(new vi,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)vi.set(Ntt,c[3*Y+0],c[3*Y+1],c[3*Y+2]),vi.max(X,X,Ntt)}var K={vertexBundles:[U],primitives:[V]};return j&&(K.minPosition=new vi(j.x,j.y,j.z)),X&&(K.maxPosition=new vi(X.x,X.y,X.z)),e||(e=new Att),e.reset({struct:K,data:new Uint8Array(M.getCombined())}),e}var Btt,Ftt,ztt,Utt,ktt,Gtt,Htt,Vtt,jtt,Wtt,qtt,Xtt,Ytt,Ktt,Qtt,Ztt,Jtt,$tt,tet,eet,net,iet,ret,oet,aet,set,cet,uet,het,fet,pet,_et,det,met,vet,get,yet,xet,bet,Tet,Eet,Cet,wet,Aet,Pet,Iet,Ret,Det,Oet=Object.freeze({__proto__:null,find:OD,toPPM:function(t,e,n){return"P3 "+e+" "+n+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:function(t,e){void 0===e&&(e=0);for(var n,i={positions:[]},r=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),o=t.struct,a=o.primitives[e],s=W(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,f=u.view,p=f.length,_=f.stride,d=W(u.attributes);!(c=d()).done;){var m=c.value,v=ctt[m.name];v&&(i[v]=(i[v]||[]).concat(qw(r,m.format,h,p,_))),h+=fa[m.format].size}var g=a.indexView;return i.indices=qw(r,Tr["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:Ltt,readBuffer:qw,writeBuffer:Ww,mapBuffer:Xw}),Met=function(e){return t({Billboard:e,BillboardComponent:e}),e}((Btt=ol("cc.Billboard"),Ftt=Sl(),ztt=vl(),Utt=kl(cv),ktt=kl(cv),Gtt=wl(),Htt=wl(),Vtt=wl(),jtt=wl(),Btt(Wtt=Ftt(Wtt=ztt(Wtt=ml((Ztt=function(t){function e(){var e;return q(e=t.call(this)||this,"_texture",Xtt,V(e)),q(e,"_height",Ytt,V(e)),q(e,"_width",Ktt,V(e)),q(e,"_rotation",Qtt,V(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new ki(1,1,0,0),e}F(e,t);var n=e.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=Ltt({primitiveMode:Yr.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[di.WHITE.r,di.WHITE.g,di.WHITE.b,di.WHITE.a,di.WHITE.r,di.WHITE.g,di.WHITE.b,di.WHITE.a,di.WHITE.r,di.WHITE.g,di.WHITE.b,di.WHITE.a,di.WHITE.r,di.WHITE.g,di.WHITE.b,di.WHITE.a],attributes:[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RG32F),new Ho(co.ATTR_COLOR,Tr.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=i.director.root.createModel(rg,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new Og,this._material.copy(Gv.get("default-billboard-material"))),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},L(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*ti(this._rotation))/100},set:function(t){this._rotation=$n(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),e}(ih),Xtt=X((qtt=Ztt).prototype,"_texture",[Utt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(qtt.prototype,"texture",[ktt,Gtt],Object.getOwnPropertyDescriptor(qtt.prototype,"texture"),qtt.prototype),Ytt=X(qtt.prototype,"_height",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(qtt.prototype,"height",[Htt],Object.getOwnPropertyDescriptor(qtt.prototype,"height"),qtt.prototype),Ktt=X(qtt.prototype,"_width",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(qtt.prototype,"width",[Vtt],Object.getOwnPropertyDescriptor(qtt.prototype,"width"),qtt.prototype),Qtt=X(qtt.prototype,"_rotation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(qtt.prototype,"rotation",[jtt],Object.getOwnPropertyDescriptor(qtt.prototype,"rotation"),qtt.prototype),Wtt=qtt))||Wtt)||Wtt)||Wtt)||Wtt)),Net=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RGBA32F),new Ho(co.ATTR_TEX_COORD1,Tr.RGB32F),new Ho(co.ATTR_COLOR,Tr.RGBA8,!0)],Let=new vi,Bet=new vi,Fet=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=Kv.LINE,e._capacity=100,e._iaInfo=new Io([new Ao]),e._iaInfoBuffer=e._device.createBuffer(new Co(wr.INDIRECT,Ir.DEVICE,ma,ma)),e}F(e,t);var n=e.prototype;return n.setCapacity=function(t){this._capacity=t,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var t,e=W(Net);!(t=e()).done;){var n=t.value;n.offset=this._vertSize,this._vertSize+=fa[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Qw([t],Net,Yr.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},n.addLineVertexData=function(t,e,n){if(t.length>1){var i=0;vi.subtract(Let,t[1],t[0]),this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=e.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=Let.x,this._vdataF32[i++]=Let.y,this._vdataF32[i++]=Let.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=e.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=Let.x,this._vdataF32[i++]=Let.y,this._vdataF32[i++]=Let.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<t.length-1;r++){vi.subtract(Let,t[r-1],t[r]),vi.subtract(Bet,t[r+1],t[r]),vi.subtract(Bet,Bet,Let);var o=r/t.length;this._vdataF32[i++]=t[r].x,this._vdataF32[i++]=t[r].y,this._vdataF32[i++]=t[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=e.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=Bet.x,this._vdataF32[i++]=Bet.y,this._vdataF32[i++]=Bet.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=t[r].x,this._vdataF32[i++]=t[r].y,this._vdataF32[i++]=t[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=e.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=Bet.x,this._vdataF32[i++]=Bet.y,this._vdataF32[i++]=Bet.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}vi.subtract(Let,t[t.length-1],t[t.length-2]),this._vdataF32[i++]=t[t.length-1].x,this._vdataF32[i++]=t[t.length-1].y,this._vdataF32[i++]=t[t.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=e.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=Let.x,this._vdataF32[i++]=Let.y,this._vdataF32[i++]=Let.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=t[t.length-1].x,this._vdataF32[i++]=t[t.length-1].y,this._vdataF32[i++]=t[t.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=e.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=Let.x,this._vdataF32[i++]=Let.y,this._vdataF32[i++]=Let.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},n.updateIA=function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(rg),zet=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],Uet=Yt({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),ket=t("CurveRange",(Jtt=ol("cc.CurveRange"),$tt=kl(Uet),tet=kl(yp),eet=kl(yp),net=kl(yp),Jtt((det=_et=function(){function t(){q(this,"mode",oet,this),q(this,"spline",aet,this),q(this,"splineMin",set,this),q(this,"splineMax",cet,this),q(this,"constant",uet,this),q(this,"constantMin",het,this),q(this,"constantMax",fet,this),q(this,"multiplier",pet,this),this._curve=new T_(this.spline),this._curveMin=new T_(this.splineMin),this._curveMax=new T_(this.splineMax)}var e=t.prototype;return e.evaluate=function(t,e){switch(this.mode){default:case Uet.Constant:return this.constant;case Uet.Curve:return this.spline.evaluate(t)*this.multiplier;case Uet.TwoCurves:return Jn(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case Uet.TwoConstants:return Jn(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this.mode){default:case Uet.Constant:return this.constant;case Uet.Curve:return this.multiplier;case Uet.TwoConstants:return this.constantMax;case Uet.TwoCurves:return this.multiplier}},e._onBeforeSerialize=function(){return zet[this.mode]},L(t,[{key:"curve",get:function(){return this._curve},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}(),_et.Mode=Uet,oet=X((ret=det).prototype,"mode",[$tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uet.Constant}}),aet=X(ret.prototype,"spline",[tet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w_()}}),set=X(ret.prototype,"splineMin",[eet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w_()}}),cet=X(ret.prototype,"splineMax",[net],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w_()}}),uet=X(ret.prototype,"constant",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),het=X(ret.prototype,"constantMin",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fet=X(ret.prototype,"constantMax",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pet=X(ret.prototype,"multiplier",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iet=ret))||iet));function Get(t,e,n){switch(t.mode){case Uet.Constant:return t.constant;case Uet.Curve:return t.spline.evaluate(e)*t.multiplier;case Uet.TwoCurves:return 0===n?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case Uet.TwoConstants:return 0===n?t.constantMin:t.constantMax;default:return 0}}function Het(t){switch(t.mode){case Uet.TwoConstants:case Uet.TwoCurves:return 2;default:return 1}}function Vet(t,e,n){var i=new Fm({width:e,height:n,_data:t,_compressed:!1,format:sm.RGBA32F}),r=new cv;return r.setFilters(lm.NEAREST,lm.NEAREST),r.setMipFilter(lm.NONE),r.setWrapMode(cm.CLAMP_TO_EDGE,cm.CLAMP_TO_EDGE,cm.CLAMP_TO_EDGE),r.image=i,r}function jet(t,e,n,i,r){for(var o=Math.max(Het(e),Het(n),Het(i)),a=new Float32Array(t*o*4),s=[e,n,i],c=1/(t-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],f=0,p=0,_=0;_<t;_++){var d=Get(h,c*_,l);p=r?d:(f+=d)/(_+1),a[4*_+u]=p}return Vet(a,t,o)}var Wet,qet,Xet,Yet,Ket,Qet,Zet,Jet,$et,tnt,ent,nnt,int,rnt,ont,ant,snt,cnt,lnt,unt,hnt,fnt,pnt,_nt,dnt,mnt,vnt,gnt,ynt,xnt,Snt,bnt,Tnt,Ent,Cnt,wnt,Ant,Pnt,Int,Rnt,Dnt,Ont,Mnt,Nnt,Lnt,Bnt,Fnt,znt,Unt,knt,Gnt,Hnt,Vnt,jnt,Wnt,qnt=Yt({Blend:0,Fixed:1}),Xnt=(t("ColorKey",ol("cc.ColorKey")((get=X((vet=function(){q(this,"color",get,this),q(this,"time",yet,this)}).prototype,"color",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),yet=X(vet.prototype,"time",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),met=vet))||met),t("AlphaKey",ol("cc.AlphaKey")((Tet=X((bet=function(){q(this,"alpha",Tet,this),q(this,"time",Eet,this)}).prototype,"alpha",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Eet=X(bet.prototype,"time",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xet=bet))||xet),t("Gradient",ol("cc.Gradient")((Det=Ret=function(){function t(){q(this,"colorKeys",Aet,this),q(this,"alphaKeys",Pet,this),q(this,"mode",Iet,this),this._color=void 0,this._color=di.WHITE.clone()}var e=t.prototype;return e.setKeys=function(t,e){this.colorKeys=t,this.alphaKeys=e},e.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(t,e){return t.time-e.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(t,e){return t.time-e.time}))},e.evaluate=function(t){return this.getRGB(t),this._color._set_a_unsafe(this.getAlpha(t)),this._color},e.randomColor=function(){var t=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],e=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(t.color),this._color._set_a_unsafe(e.alpha),this._color},e.getRGB=function(t){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(di.WHITE),this._color);t=ci(t,1);for(var e=1;e<this.colorKeys.length;++e){var n=this.colorKeys[e-1].time,i=this.colorKeys[e].time;if(t>=n&&t<i){if(this.mode===qnt.Fixed)return this.colorKeys[e].color;var r=(t-n)/(i-n);return di.lerp(this._color,this.colorKeys[e-1].color,this.colorKeys[e].color,r),this._color}}var o=this.colorKeys.length-1;t<this.colorKeys[0].time?di.lerp(this._color,di.BLACK,this.colorKeys[0].color,t/this.colorKeys[0].time):t>this.colorKeys[o].time&&di.lerp(this._color,this.colorKeys[o].color,di.BLACK,(t-this.colorKeys[o].time)/(1-this.colorKeys[o].time))},e.getAlpha=function(t){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;t=ci(t,1);for(var e=1;e<this.alphaKeys.length;++e){var n=this.alphaKeys[e-1].time,i=this.alphaKeys[e].time;if(t>=n&&t<i){if(this.mode===qnt.Fixed)return this.alphaKeys[e].alpha;var r=(t-n)/(i-n);return Jn(this.alphaKeys[e-1].alpha,this.alphaKeys[e].alpha,r)}}var o=this.alphaKeys.length-1;return t<this.alphaKeys[0].time?Jn(0,this.alphaKeys[0].alpha,t/this.alphaKeys[0].time):t>this.alphaKeys[o].time?Jn(this.alphaKeys[o].alpha,0,(t-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):void 0},t}(),Ret.Mode=qnt,Aet=X((wet=Det).prototype,"colorKeys",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Pet=X(wet.prototype,"alphaKeys",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Iet=X(wet.prototype,"mode",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qnt.Blend}}),Cet=wet))||Cet)),Ynt=Yt({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Knt=t("GradientRange",(Wet=ol("cc.GradientRange"),qet=kl(Ynt),Xet=kl(Xnt),Yet=kl(Xnt),Ket=kl(Xnt),Qet=kl(Ynt),Wet((snt=ant=function(){function t(){q(this,"color",$et,this),q(this,"colorMin",tnt,this),q(this,"colorMax",ent,this),q(this,"gradient",nnt,this),q(this,"gradientMin",int,this),q(this,"gradientMax",rnt,this),q(this,"_mode",ont,this),this._color=di.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case Ynt.Color:return this.color;case Ynt.TwoColors:return di.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case Ynt.RandomColor:return this.gradient.randomColor();case Ynt.Gradient:return this.gradient.evaluate(t);case Ynt.TwoGradients:return di.lerp(this._color,this.gradientMin.evaluate(t),this.gradientMax.evaluate(t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return(!1)[this._mode]},L(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),ant.Mode=Ynt,X((Jet=snt).prototype,"mode",[qet],Object.getOwnPropertyDescriptor(Jet.prototype,"mode"),Jet.prototype),$et=X(Jet.prototype,"color",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),tnt=X(Jet.prototype,"colorMin",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),ent=X(Jet.prototype,"colorMax",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),nnt=X(Jet.prototype,"gradient",[Xet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xnt}}),int=X(Jet.prototype,"gradientMin",[Yet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xnt}}),rnt=X(Jet.prototype,"gradientMax",[Ket],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xnt}}),ont=X(Jet.prototype,"_mode",[Qet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ynt.Color}}),Zet=Jet))||Zet));function Qnt(t,e,n){switch(t.mode){case Ynt.Color:return t.color;case Ynt.TwoColors:return 0===n?t.colorMin:t.colorMax;case Ynt.RandomColor:return t.gradient.randomColor();case Ynt.Gradient:return t.gradient.evaluate(e);case Ynt.TwoGradients:return 0===n?t.gradientMin.evaluate(e):t.gradientMax.evaluate(e);default:return t.color}}var Znt={parent:null,owner:null,subModelIdx:0},Jnt={CC_USE_WORLD_SPACE:!1},$nt=function(e){return t({Line:e,LineComponent:e}),e}((cnt=ol("cc.Line"),lnt=Sl(),unt=vl(),hnt=kl(cv),fnt=kl(cv),pnt=Ol(),_nt=wl(),dnt=Ol(),mnt=wl(),vnt=kl([vi]),gnt=kl([vi]),ynt=Ol(),xnt=wl(),Snt=kl(ket),bnt=kl(ket),Tnt=Al(),Ent=Ol(),Cnt=wl(),wnt=kl(Bi),Ant=Ol(),Pnt=wl(),Int=kl(Bi),Rnt=Ol(),Dnt=wl(),Ont=kl(Knt),Mnt=kl(Knt),Nnt=Ol(),Lnt=wl(),cnt(Bnt=lnt(Bnt=unt(Bnt=ml((Wnt=function(t){function e(){var e;return q(e=t.call(this)||this,"_texture",znt,V(e)),e._material=null,e._materialInstance=null,q(e,"_worldSpace",Unt,V(e)),q(e,"_positions",knt,V(e)),q(e,"_width",Gnt,V(e)),q(e,"_tile",Hnt,V(e)),q(e,"_offset",Vnt,V(e)),q(e,"_color",jnt,V(e)),e._model=null,e._tile_offset=new ki,e}F(e,t);var n=e.prototype;return n.onLoad=function(){var t=this._model=i.director.root.createModel(Fet);t.node=t.transform=this.node,null===this._material&&(this._material=new Og,this._material.copy(Gv.get("default-trail-material")),Jnt.CC_USE_WORLD_SPACE=this.worldSpace,Znt.parent=this._material,Znt.subModelIdx=0,this._materialInstance=new Yg(Znt),Znt.parent=null,Znt.subModelIdx=0,this._materialInstance.recompileShaders(Jnt)),t.updateMaterial(this._materialInstance),t.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},L(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._materialInstance&&this._materialInstance.setProperty("mainTexture",t)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t,this._materialInstance&&(Jnt.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(Jnt),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),e}(ih),znt=X((Fnt=Wnt).prototype,"_texture",[hnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Fnt.prototype,"texture",[fnt,pnt,_nt],Object.getOwnPropertyDescriptor(Fnt.prototype,"texture"),Fnt.prototype),Unt=X(Fnt.prototype,"_worldSpace",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Fnt.prototype,"worldSpace",[dnt,mnt],Object.getOwnPropertyDescriptor(Fnt.prototype,"worldSpace"),Fnt.prototype),knt=X(Fnt.prototype,"_positions",[vnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(Fnt.prototype,"positions",[gnt,ynt,xnt],Object.getOwnPropertyDescriptor(Fnt.prototype,"positions"),Fnt.prototype),Gnt=X(Fnt.prototype,"_width",[Snt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),X(Fnt.prototype,"width",[bnt,Tnt,Ent,Cnt],Object.getOwnPropertyDescriptor(Fnt.prototype,"width"),Fnt.prototype),Hnt=X(Fnt.prototype,"_tile",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(1,1)}}),X(Fnt.prototype,"tile",[wnt,Ant,Pnt],Object.getOwnPropertyDescriptor(Fnt.prototype,"tile"),Fnt.prototype),Vnt=X(Fnt.prototype,"_offset",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(0,0)}}),X(Fnt.prototype,"offset",[Int,Rnt,Dnt],Object.getOwnPropertyDescriptor(Fnt.prototype,"offset"),Fnt.prototype),jnt=X(Fnt.prototype,"_color",[Ont],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Knt}}),X(Fnt.prototype,"color",[Mnt,Nnt,Lnt],Object.getOwnPropertyDescriptor(Fnt.prototype,"color"),Fnt.prototype),Bnt=Fnt))||Bnt)||Bnt)||Bnt)||Bnt)),tit=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new vi(0,0,0),this.velocity=new vi(0,0,0),this.animatedVelocity=new vi(0,0,0),this.ultimateVelocity=new vi(0,0,0),this.angularVelocity=new vi(0,0,0),this.axisOfRotation=new vi(0,0,0),this.rotation=new vi(0,0,0),this.startEuler=new vi(0,0,0),this.startRotation=new Ei,this.startRotated=!1,this.deltaQuat=new Ei,this.deltaMat=new Oi,this.localMat=new Oi,this.startSize=new vi(0,0,0),this.size=new vi(0,0,0),this.startColor=di.WHITE.clone(),this.color=di.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();tit.INDENTIFY_NEG_QUAT=10,tit.R2D=180/Math.PI;var eit,nit,iit,rit,oit,ait,sit,cit,lit,uit,hit,fit,pit,_it,dit,mit,vit,git,yit,xit,Sit,bit,Tit,Eit,Cit,wit,Ait,Pit,Iit,Rit,Dit,Oit,Mit,Nit,Lit="colorModule",Bit="rotationModule",Fit="sizeModule",zit="textureModule",Uit=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],kit=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],Git=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),Hit=Yt({World:0,Local:1,Custom:2}),Vit=Yt({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),jit=Yt({World:0,Local:1,View:2}),Wit=Yt({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),qit=Yt({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Xit=Yt({Base:0,Edge:1,Shell:2,Volume:3}),Yit=Yt({Random:0,Loop:1,PingPong:2}),Kit=Yt({Particles:0}),Qit=Yt({Stretch:0}),Zit=(eit=ol("cc.ColorOvertimeModule"),nit=Ol(),iit=kl(Knt),rit=Ol(),eit((lit=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_enable",sit,V(e)),q(e,"color",cit,V(e)),e.name=Lit,e}return F(e,t),e.prototype.animate=function(t){t.color.set(t.startColor),t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,ri(t.randomSeed+91041)))},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Git),sit=X((ait=lit).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(ait.prototype,"enable",[nit],Object.getOwnPropertyDescriptor(ait.prototype,"enable"),ait.prototype),cit=X(ait.prototype,"color",[iit,hl,rit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Knt}}),oit=ait))||oit),Jit=new vi(0,0,-1);function $it(t,e,n,i){return e!==t?(t===Hit.World||Oi.invert(n,n),Oi.getRotation(i,n),!0):(Ei.set(i,0,0,0,1),!1)}function trt(t,e){Bi.set(t,Math.cos(e),Math.sin(e))}function ert(t){var e=ni(-1,1),n=ni(0,2*Math.PI),i=Math.sqrt(1-e*e),r=i*Math.cos(n),o=i*Math.sin(n);vi.set(t,r,o,e)}function nrt(t,e,n){ert(t),vi.multiplyScalar(t,t,e+(n-e)*ei())}function irt(t,e,n,i){trt(t,i),t.z=0,vi.multiplyScalar(t,t,e+(n-e)*ei())}function rrt(t){for(var e=0;e<t.length;e++){var n=e+ii(0,t.length-e),i=t[n];t[n]=t[e],t[e]=i}}function ort(){var t=ni(-1,1);return 0===t&&t++,Rn(t)}var art,srt,crt,lrt,urt,hrt,frt,prt,_rt,drt,mrt,vrt,grt,yrt,xrt,Srt,brt,Trt,Ert,Crt,wrt,Art,Prt,Irt,Rrt,Drt,Ort,Mrt,Nrt,Lrt,Brt,Frt,zrt,Urt,krt,Grt,Hrt,Vrt,jrt,Wrt,qrt,Xrt,Yrt,Krt,Qrt,Zrt,Jrt,$rt,tot,eot,not,iot,rot,oot,aot,sot,cot,lot,uot,hot,fot=212165,pot=new vi,_ot=(uit=ol("cc.ForceOvertimeModule"),hit=Ol(),fit=kl(ket),pit=Al(),_it=Ol(),dit=wl(),mit=kl(ket),vit=Al(),git=Ol(),yit=wl(),xit=kl(ket),Sit=Al(),bit=Ol(),Tit=wl(),Eit=kl(Hit),Cit=Ol(),wit=wl(),uit((Nit=function(t){function e(){var e;return q(e=t.call(this)||this,"_enable",Iit,V(e)),q(e,"x",Rit,V(e)),q(e,"y",Dit,V(e)),q(e,"z",Oit,V(e)),q(e,"space",Mit,V(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new Ei,e.needTransform=!1,e.needUpdate=!0,e}F(e,t);var n=e.prototype;return n.update=function(t,e){this.needTransform=$it(t,this.space,e,this.rotation)},n.animate=function(t,e){var n=1-t.remainingLifetime/t.startLifetime,i=vi.set(pot,this.x.evaluate(n,ri(t.randomSeed+fot)),this.y.evaluate(n,ri(t.randomSeed+fot)),this.z.evaluate(n,ri(t.randomSeed+fot)));this.needTransform&&vi.transformQuat(i,i,this.rotation),vi.scaleAndAdd(t.velocity,t.velocity,i,e),vi.copy(t.ultimateVelocity,t.velocity)},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Git),Iit=X((Pit=Nit).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Pit.prototype,"enable",[hit],Object.getOwnPropertyDescriptor(Pit.prototype,"enable"),Pit.prototype),Rit=X(Pit.prototype,"x",[fit,hl,pit,_it,dit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Dit=X(Pit.prototype,"y",[mit,hl,vit,git,yit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Oit=X(Pit.prototype,"z",[xit,hl,Sit,bit,Tit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Mit=X(Pit.prototype,"space",[Eit,hl,Cit,wit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hit.Local}}),Ait=Pit))||Ait),dot=23541,mot=new vi,vot=new vi,got=(art=ol("cc.LimitVelocityOvertimeModule"),srt=Ol(),crt=kl(ket),lrt=Al(),urt=Ol(),hrt=wl(),frt=kl(ket),prt=Al(),_rt=Ol(),drt=wl(),mrt=kl(ket),vrt=Al(),grt=Ol(),yrt=wl(),xrt=kl(ket),Srt=Al(),brt=Ol(),Trt=wl(),Ert=Ol(),Crt=wl(),wrt=Ol(),Art=wl(),Prt=kl(Hit),Irt=Ol(),Rrt=wl(),art((Grt=function(t){function e(){var e;return q(e=t.call(this)||this,"_enable",Mrt,V(e)),q(e,"limitX",Nrt,V(e)),q(e,"limitY",Lrt,V(e)),q(e,"limitZ",Brt,V(e)),q(e,"limit",Frt,V(e)),q(e,"dampen",zrt,V(e)),q(e,"separateAxes",Urt,V(e)),q(e,"space",krt,V(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new Ei,e.needTransform=!1,e.needUpdate=!0,e}F(e,t);var n=e.prototype;return n.update=function(t,e){this.needTransform=$it(t,this.space,e,this.rotation)},n.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,n=mot;this.separateAxes?(vi.set(vot,this.limitX.evaluate(e,ri(t.randomSeed+dot)),this.limitY.evaluate(e,ri(t.randomSeed+dot)),this.limitZ.evaluate(e,ri(t.randomSeed+dot))),this.needTransform&&vi.transformQuat(vot,vot,this.rotation),vi.set(n,yot(t.ultimateVelocity.x,vot.x,this.dampen),yot(t.ultimateVelocity.y,vot.y,this.dampen),yot(t.ultimateVelocity.z,vot.z,this.dampen))):(vi.normalize(n,t.ultimateVelocity),vi.multiplyScalar(n,n,yot(t.ultimateVelocity.length(),this.limit.evaluate(e,ri(t.randomSeed+dot)),this.dampen))),vi.copy(t.ultimateVelocity,n)},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Git),Mrt=X((Ort=Grt).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Ort.prototype,"enable",[srt],Object.getOwnPropertyDescriptor(Ort.prototype,"enable"),Ort.prototype),Nrt=X(Ort.prototype,"limitX",[crt,hl,lrt,urt,hrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Lrt=X(Ort.prototype,"limitY",[frt,hl,prt,_rt,drt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Brt=X(Ort.prototype,"limitZ",[mrt,hl,vrt,grt,yrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Frt=X(Ort.prototype,"limit",[xrt,hl,Srt,brt,Trt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),zrt=X(Ort.prototype,"dampen",[hl,Ert,Crt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),Urt=X(Ort.prototype,"separateAxes",[hl,wrt,Art],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),krt=X(Ort.prototype,"space",[Prt,hl,Irt,Rrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hit.Local}}),Drt=Ort))||Drt);function yot(t,e,n){var i=Math.sign(t),r=Math.abs(t);return r>e&&(r=Jn(r,e,n)),r*i}var xot,Sot,bot,Tot,Eot,Cot,wot,Aot,Pot,Iot,Rot,Dot,Oot,Mot,Not,Lot,Bot,Fot,zot,Uot,kot,Got,Hot,Vot,jot,Wot,qot,Xot,Yot,Kot,Qot,Zot,Jot,$ot,tat,eat,nat,iat,rat,oat,aat,sat,cat,lat,uat,hat,fat,pat,_at,dat,mat,vat,gat,yat,xat,Sat,bat,Tat,Eat,Cat,wat,Aat,Pat,Iat,Rat,Dat,Oat,Mat,Nat,Lat,Bat,Fat,zat,Uat,kat,Gat,Hat,Vat,jat,Wat,qat,Xat,Yat,Kat,Qat,Zat,Jat,$at,tst,est,nst,ist,rst,ost,ast,sst,cst,lst,ust,hst,fst,pst,_st,dst,mst,vst,gst,yst,xst,Sst,bst,Tst,Est,Cst,wst,Ast,Pst,Ist,Rst,Dst,Ost,Mst,Nst,Lst,Bst,Fst,zst,Ust,kst,Gst,Hst,Vst,jst,Wst,qst,Xst,Yst,Kst,Qst,Zst,Jst,$st,tct,ect,nct,ict,rct,oct,act,sct,cct,lct,uct,hct,fct,pct,_ct,dct,mct,vct,gct,yct,xct,Sct,bct,Tct,Ect,Cct,wct,Act,Pct,Ict,Rct,Dct,Oct,Mct,Nct,Lct,Bct,Fct,zct,Uct,kct=(Hrt=ol("cc.RotationOvertimeModule"),Vrt=Ol(),jrt=Ol(),Wrt=wl(),qrt=kl(ket),Xrt=Al(),Yrt=Ol(),Krt=wl(),Qrt=kl(ket),Zrt=Al(),Jrt=Ol(),$rt=wl(),tot=kl(ket),eot=Al(),not=Ol(),iot=wl(),Hrt((hot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_enable",aot,V(e)),q(e,"_separateAxes",sot,V(e)),q(e,"x",cot,V(e)),q(e,"y",lot,V(e)),q(e,"z",uot,V(e)),e.name=Bit,e._startMat=new Oi,e._matRot=new Oi,e._quatRot=new Ei,e._otherEuler=new vi,e}F(e,t);var n=e.prototype;return n._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==Wit.Mesh&&e===Wit.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Ei.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=tit.INDENTIFY_NEG_QUAT)},n.animate=function(t,e){var n=1-t.remainingLifetime/t.startLifetime,i=ri(t.randomSeed+125292),r=t.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==Wit.VerticalBillboard&&r!==Wit.HorizontalBillboard?Ei.fromEuler(t.deltaQuat,this.x.evaluate(n,i)*e*tit.R2D,this.y.evaluate(n,i)*e*tit.R2D,this.z.evaluate(n,i)*e*tit.R2D):Ei.fromEuler(t.deltaQuat,0,0,this.z.evaluate(n,i)*e*tit.R2D),t.deltaMat=Oi.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==Wit.Mesh&&(r===Wit.StrecthedBillboard?t.startEuler.set(0,0,0):r!==Wit.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),Ei.fromEuler(t.startRotation,t.startEuler.x*tit.R2D,t.startEuler.y*tit.R2D,t.startEuler.z*tit.R2D),t.startRotated=!0),this._startMat=Oi.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),Oi.getRotation(this._quatRot,this._matRot),this._processRotation(t,tit.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(Git),aot=X((oot=hot).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(oot.prototype,"enable",[Vrt],Object.getOwnPropertyDescriptor(oot.prototype,"enable"),oot.prototype),sot=X(oot.prototype,"_separateAxes",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(oot.prototype,"separateAxes",[jrt,Wrt],Object.getOwnPropertyDescriptor(oot.prototype,"separateAxes"),oot.prototype),cot=X(oot.prototype,"x",[qrt,hl,Xrt,Ml,Yrt,Krt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),lot=X(oot.prototype,"y",[Qrt,hl,Zrt,Ml,Jrt,$rt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),uot=X(oot.prototype,"z",[tot,hl,eot,Ml,not,iot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),rot=oot))||rot),Gct=(xot=ol("cc.SizeOvertimeModule"),Sot=Ol(),bot=Ol(),Tot=wl(),Eot=kl(ket),Cot=Al(),wot=Ol(),Aot=wl(),Pot=kl(ket),Iot=Al(),Rot=Ol(),Dot=wl(),Oot=kl(ket),Mot=Al(),Not=Ol(),Lot=wl(),Bot=kl(ket),Fot=Al(),zot=Ol(),Uot=wl(),xot((Yot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_enable",Hot,V(e)),q(e,"separateAxes",Vot,V(e)),q(e,"size",jot,V(e)),q(e,"x",Wot,V(e)),q(e,"y",qot,V(e)),q(e,"z",Xot,V(e)),e.name=Fit,e}return F(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,n=ri(t.randomSeed+39825);t.size.x=t.startSize.x*this.x.evaluate(e,n),t.size.y=t.startSize.y*this.y.evaluate(e,n),t.size.z=t.startSize.z*this.z.evaluate(e,n)}else vi.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,ri(t.randomSeed+39825)))},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Git),Hot=X((Got=Yot).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Got.prototype,"enable",[Sot],Object.getOwnPropertyDescriptor(Got.prototype,"enable"),Got.prototype),Vot=X(Got.prototype,"separateAxes",[hl,bot,Tot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jot=X(Got.prototype,"size",[Eot,hl,Cot,wot,Aot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Wot=X(Got.prototype,"x",[Pot,hl,Iot,Rot,Dot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),qot=X(Got.prototype,"y",[Oot,hl,Mot,Not,Lot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Xot=X(Got.prototype,"z",[Bot,hl,Fot,zot,Uot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),kot=Got))||kot),Hct=90794,Vct=Yt({Grid:0}),jct=Yt({WholeSheet:0,SingleRow:1}),Wct=(Kot=ol("cc.TextureAnimationModule"),Qot=fl("numTilesX"),Zot=fl("numTilesY"),Jot=Ol(),$ot=kl(Vct),tat=kl(Vct),eat=Ol(),nat=wl(),iat=Ol(),rat=wl(),oat=Ol(),aat=wl(),sat=kl(jct),cat=Ol(),lat=wl(),uat=kl(ket),hat=Al(),fat=Ol(),pat=wl(),_at=kl(ket),dat=Al(),mat=Ol(),vat=wl(),gat=Ol(),yat=wl(),xat=Ol(),Sat=wl(),bat=Ol(),Tat=wl(),Kot((Uat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_enable",wat,V(e)),q(e,"_numTilesX",Aat,V(e)),q(e,"_numTilesY",Pat,V(e)),q(e,"_mode",Iat,V(e)),q(e,"animation",Rat,V(e)),q(e,"frameOverTime",Dat,V(e)),q(e,"startFrame",Oat,V(e)),q(e,"cycleCount",Mat,V(e)),q(e,"_flipU",Nat,V(e)),q(e,"_flipV",Lat,V(e)),q(e,"_uvChannelMask",Bat,V(e)),q(e,"randomRow",Fat,V(e)),q(e,"rowIndex",zat,V(e)),e.name=zit,e}F(e,t);var n=e.prototype;return n.init=function(t){t.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,n=this.startFrame.evaluate(e,ri(t.randomSeed+Hct))/(this.numTilesX*this.numTilesY);if(this.animation===jct.WholeSheet)t.frameIndex=ci(this.cycleCount*(this.frameOverTime.evaluate(e,ri(t.randomSeed+Hct))+n),1);else if(this.animation===jct.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=ci(this.cycleCount*(this.frameOverTime.evaluate(e,ri(t.randomSeed+Hct))+n),1),o=t.startRow*i,a=o+i;t.frameIndex=Jn(o,a,r)}else{var s=this.rowIndex*i,c=s+i;t.frameIndex=Jn(s,c,ci(this.cycleCount*(this.frameOverTime.evaluate(e,ri(t.randomSeed+Hct))+n),1))}}},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==Vct.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(Git),wat=X((Cat=Uat).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Aat=X(Cat.prototype,"_numTilesX",[Qot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pat=X(Cat.prototype,"_numTilesY",[Zot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Cat.prototype,"enable",[Jot],Object.getOwnPropertyDescriptor(Cat.prototype,"enable"),Cat.prototype),Iat=X(Cat.prototype,"_mode",[$ot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vct.Grid}}),X(Cat.prototype,"mode",[tat,eat,nat],Object.getOwnPropertyDescriptor(Cat.prototype,"mode"),Cat.prototype),X(Cat.prototype,"numTilesX",[iat,rat],Object.getOwnPropertyDescriptor(Cat.prototype,"numTilesX"),Cat.prototype),X(Cat.prototype,"numTilesY",[oat,aat],Object.getOwnPropertyDescriptor(Cat.prototype,"numTilesY"),Cat.prototype),Rat=X(Cat.prototype,"animation",[sat,hl,cat,lat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jct.WholeSheet}}),Dat=X(Cat.prototype,"frameOverTime",[uat,hl,hat,fat,pat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Oat=X(Cat.prototype,"startFrame",[_at,hl,dat,mat,vat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Mat=X(Cat.prototype,"cycleCount",[hl,gat,yat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nat=X(Cat.prototype,"_flipU",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lat=X(Cat.prototype,"_flipV",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bat=X(Cat.prototype,"_uvChannelMask",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Fat=X(Cat.prototype,"randomRow",[hl,xat,Sat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zat=X(Cat.prototype,"rowIndex",[hl,bat,Tat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eat=Cat))||Eat),qct=197866,Xct=new vi,Yct=(kat=ol("cc.VelocityOvertimeModule"),Gat=Ol(),Hat=kl(ket),Vat=Al(),jat=Ol(),Wat=wl(),qat=kl(ket),Xat=Al(),Yat=Ol(),Kat=wl(),Qat=kl(ket),Zat=Al(),Jat=Ol(),$at=wl(),tst=kl(ket),est=Al(),nst=Ol(),ist=wl(),rst=kl(Hit),ost=Ol(),ast=wl(),kat((dst=function(t){function e(){var e;return q(e=t.call(this)||this,"_enable",lst,V(e)),q(e,"x",ust,V(e)),q(e,"y",hst,V(e)),q(e,"z",fst,V(e)),q(e,"speedModifier",pst,V(e)),q(e,"space",_st,V(e)),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new Ei,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}F(e,t);var n=e.prototype;return n.update=function(t,e){this.needTransform=$it(t,this.space,e,this.rotation)},n.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,n=vi.set(Xct,this.x.evaluate(e,ri(t.randomSeed^qct)),this.y.evaluate(e,ri(156497^t.randomSeed)),this.z.evaluate(e,ri(984136^t.randomSeed)));this.needTransform&&vi.transformQuat(n,n,this.rotation),vi.add(t.animatedVelocity,t.animatedVelocity,n),vi.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),vi.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,ri(t.randomSeed+qct)))},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Git),lst=X((cst=dst).prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(cst.prototype,"enable",[Gat],Object.getOwnPropertyDescriptor(cst.prototype,"enable"),cst.prototype),ust=X(cst.prototype,"x",[Hat,hl,Vat,jat,Wat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),hst=X(cst.prototype,"y",[qat,hl,Xat,Yat,Kat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),fst=X(cst.prototype,"z",[Qat,hl,Zat,Jat,$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),pst=X(cst.prototype,"speedModifier",[tst,hl,est,nst,ist],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),_st=X(cst.prototype,"space",[rst,hl,ost,ast],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hit.Local}}),sst=cst))||sst),Kct=t("Burst",(mst=ol("cc.Burst"),vst=kl(ket),gst=Al(),mst((Cst=function(){function t(){q(this,"_time",Sst,this),q(this,"_repeatCount",bst,this),q(this,"repeatInterval",Tst,this),q(this,"count",Est,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=ci(t._time-t.startDelay.evaluate(0,1),t.duration)-e;n=n>0?n:0;var i=ci(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=n&&this._curTime<i&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},L(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),Sst=X((xst=Cst).prototype,"_time",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(xst.prototype,"time",[bl],Object.getOwnPropertyDescriptor(xst.prototype,"time"),xst.prototype),bst=X(xst.prototype,"_repeatCount",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(xst.prototype,"repeatCount",[bl],Object.getOwnPropertyDescriptor(xst.prototype,"repeatCount"),xst.prototype),Tst=X(xst.prototype,"repeatInterval",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Est=X(xst.prototype,"count",[vst,hl,gst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),yst=xst))||yst)),Qct=new vi(0,0,0),Zct=[],Jct=new vi(.5,.5,.5),$ct=(wst=ol("cc.ShapeModule"),Ast=Ol(),Pst=wl(),Ist=Ol(),Rst=wl(),Dst=Ol(),Ost=wl(),Mst=Ol(),Nst=wl(),Lst=Ol(),Bst=wl(),Fst=Ol(),zst=kl(qit),Ust=fl("shapeType"),kst=Ol(),Gst=kl(qit),Hst=wl(),Vst=kl(Xit),jst=Ol(),Wst=wl(),qst=Ol(),Xst=wl(),Yst=Ol(),Kst=wl(),Qst=Ol(),Zst=wl(),Jst=Ol(),$st=wl(),tct=Ol(),ect=wl(),nct=Ol(),ict=wl(),rct=kl(Yit),oct=Ol(),act=wl(),sct=Tl(),cct=Ol(),lct=wl(),uct=kl(ket),hct=Tl(),fct=Al(),pct=Ol(),_ct=wl(),dct=Ol(),mct=wl(),vct=Ol(),gct=wl(),wst((X((xct=function(){function t(){q(this,"_enable",Sct,this),q(this,"_shapeType",bct,this),q(this,"emitFrom",Tct,this),q(this,"alignToDirection",Ect,this),q(this,"randomDirectionAmount",Cct,this),q(this,"sphericalDirectionAmount",wct,this),q(this,"randomPositionAmount",Act,this),q(this,"radius",Pct,this),q(this,"radiusThickness",Ict,this),q(this,"arcMode",Rct,this),q(this,"arcSpread",Dct,this),q(this,"arcSpeed",Oct,this),q(this,"length",Mct,this),q(this,"boxThickness",Nct,this),q(this,"_position",Lct,this),q(this,"_rotation",Bct,this),q(this,"_scale",Fct,this),q(this,"_arc",zct,this),q(this,"_angle",Uct,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Oi,this.quat=new Ei,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case qit.Box:!function(t,e,n,i){switch(t){case Xit.Volume:r=n,o=Jct,vi.set(r,ni(-o.x,o.x),ni(-o.y,o.y),ni(-o.z,o.z));break;case Xit.Shell:Zct.splice(0,Zct.length),Zct.push(ni(-.5,.5)),Zct.push(ni(-.5,.5)),Zct.push(.5*ort()),rrt(Zct),tlt(Zct,e),vi.set(n,Zct[0],Zct[1],Zct[2]);break;case Xit.Edge:Zct.splice(0,Zct.length),Zct.push(ni(-.5,.5)),Zct.push(.5*ort()),Zct.push(.5*ort()),rrt(Zct),tlt(Zct,e),vi.set(n,Zct[0],Zct[1],Zct[2]);break;default:console.warn(t+" is not supported for box emitter.")}var r,o;vi.copy(i,Jit)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case qit.Circle:!function(t,e,n,i,r){irt(i,t*(1-e),t,n),vi.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case qit.Cone:!function(t,e,n,i,r,o,a,s){switch(t){case Xit.Base:irt(a,e*(1-n),e,i),Bi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*e,vi.normalize(s,s),a.z=0;break;case Xit.Shell:trt(a,i),Bi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),vi.normalize(s,s),Bi.multiplyScalar(a,a,e),a.z=0;break;case Xit.Volume:irt(a,e*(1-n),e,i),Bi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*e,vi.normalize(s,s),a.z=0,vi.add(a,a,vi.multiplyScalar(Qct,s,o*ei()/-s.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case qit.Sphere:!function(t,e,n,i,r){switch(t){case Xit.Volume:nrt(i,e*(1-n),e),vi.normalize(r,i);break;case Xit.Shell:ert(i),vi.multiplyScalar(i,i,e),vi.normalize(r,i);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case qit.Hemisphere:!function(t,e,n,i,r){switch(t){case Xit.Volume:nrt(i,e*(1-n),e),i.z>0&&(i.z*=-1),vi.normalize(r,i);break;case Xit.Shell:ert(i),vi.multiplyScalar(i,i,e),i.z>0&&(i.z*=-1),vi.normalize(r,i);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(t.position.x+=ni(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=ni(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=ni(-this.randomPositionAmount,this.randomPositionAmount)),vi.transformQuat(t.velocity,t.velocity,this.quat),vi.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var e=vi.normalize(Qct,t.position);vi.lerp(t.velocity,t.velocity,e,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){Ei.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Oi.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===Yit.Random)return ni(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case Yit.Loop:return ci(t,this._arc);case Yit.PingPong:return li(t,this._arc);default:return ci(t,this._arc)}},L(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return ti(this._arc)},set:function(t){this._arc=$n(t)}},{key:"angle",get:function(){return Math.round(100*ti(this._angle))/100},set:function(t){this._angle=$n(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case qit.Box:this.emitFrom===Xit.Base&&(this.emitFrom=Xit.Volume);break;case qit.Cone:this.emitFrom===Xit.Edge&&(this.emitFrom=Xit.Base);break;case qit.Sphere:case qit.Hemisphere:this.emitFrom!==Xit.Base&&this.emitFrom!==Xit.Edge||(this.emitFrom=Xit.Volume)}}}]),t}()).prototype,"position",[Ast,Pst],Object.getOwnPropertyDescriptor(xct.prototype,"position"),xct.prototype),X(xct.prototype,"rotation",[Ist,Rst],Object.getOwnPropertyDescriptor(xct.prototype,"rotation"),xct.prototype),X(xct.prototype,"scale",[Dst,Ost],Object.getOwnPropertyDescriptor(xct.prototype,"scale"),xct.prototype),X(xct.prototype,"arc",[Mst,Nst],Object.getOwnPropertyDescriptor(xct.prototype,"arc"),xct.prototype),X(xct.prototype,"angle",[Lst,Bst],Object.getOwnPropertyDescriptor(xct.prototype,"angle"),xct.prototype),Sct=X(xct.prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(xct.prototype,"enable",[Fst],Object.getOwnPropertyDescriptor(xct.prototype,"enable"),xct.prototype),bct=X(xct.prototype,"_shapeType",[zst,Ust,kst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qit.Cone}}),X(xct.prototype,"shapeType",[Gst,Hst],Object.getOwnPropertyDescriptor(xct.prototype,"shapeType"),xct.prototype),Tct=X(xct.prototype,"emitFrom",[Vst,hl,jst,Wst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xit.Volume}}),Ect=X(xct.prototype,"alignToDirection",[hl,qst,Xst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cct=X(xct.prototype,"randomDirectionAmount",[hl,Yst,Kst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wct=X(xct.prototype,"sphericalDirectionAmount",[hl,Qst,Zst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Act=X(xct.prototype,"randomPositionAmount",[hl,Jst,$st],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pct=X(xct.prototype,"radius",[hl,tct,ect],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ict=X(xct.prototype,"radiusThickness",[hl,nct,ict],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Rct=X(xct.prototype,"arcMode",[rct,hl,oct,act],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yit.Random}}),Dct=X(xct.prototype,"arcSpread",[sct,hl,cct,lct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oct=X(xct.prototype,"arcSpeed",[uct,hct,fct,hl,pct,_ct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),Mct=X(xct.prototype,"length",[hl,dct,mct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Nct=X(xct.prototype,"boxThickness",[hl,vct,gct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,0,0)}}),Lct=X(xct.prototype,"_position",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,0,0)}}),Bct=X(xct.prototype,"_rotation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,0,0)}}),Fct=X(xct.prototype,"_scale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(1,1,1)}}),zct=X(xct.prototype,"_arc",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $n(360)}}),Uct=X(xct.prototype,"_angle",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $n(25)}}),yct=xct))||yct);function tlt(t,e){e.x>0&&(t[0]+=.5*ni(-e.x,e.x),t[0]=Qn(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*ni(-e.y,e.y),t[1]=Qn(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*ni(-e.z,e.z),t[2]=Qn(t[2],-.5,.5))}var elt,nlt,ilt,rlt,olt,alt,slt,clt,llt,ult,hlt,flt,plt,_lt,dlt,mlt,vlt,glt,ylt,xlt,Slt,blt,Tlt,Elt,Clt,wlt,Alt,Plt,Ilt,Rlt,Dlt,Olt,Mlt,Nlt,Llt,Blt,Flt,zlt,Ult,klt,Glt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}F(e,t);var n=e.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):t.prototype.getMacroPatches.call(this,e)},n.initSubModel=function(e,n,i){return t.prototype.initSubModel.call(this,e,n,this._launderMaterial(i))},n.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(e,n){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(n))},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)},n._launderMaterial=function(t){return t},n.setMorphRendering=function(t){this._morphRenderingInstance=t},e}(rg),Hlt=Yt({OFF:0,ON:1}),Vlt=Yt({OFF:0,ON:1}),jlt=(elt=ol("cc.ModelLightmapSettings"),nlt=fl("_recieveShadow"),elt((hlt=function(){function t(){q(this,"texture",olt,this),q(this,"uvParam",alt,this),q(this,"_bakeable",slt,this),q(this,"_castShadow",clt,this),q(this,"_receiveShadow",llt,this),q(this,"_lightmapSize",ult,this)}return L(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),olt=X((rlt=hlt).prototype,"texture",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),alt=X(rlt.prototype,"uvParam",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki}}),slt=X(rlt.prototype,"_bakeable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),clt=X(rlt.prototype,"_castShadow",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),llt=X(rlt.prototype,"_receiveShadow",[nlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ult=X(rlt.prototype,"_lightmapSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),X(rlt.prototype,"bakeable",[bl],Object.getOwnPropertyDescriptor(rlt.prototype,"bakeable"),rlt.prototype),X(rlt.prototype,"castShadow",[bl],Object.getOwnPropertyDescriptor(rlt.prototype,"castShadow"),rlt.prototype),X(rlt.prototype,"receiveShadow",[bl],Object.getOwnPropertyDescriptor(rlt.prototype,"receiveShadow"),rlt.prototype),X(rlt.prototype,"lightmapSize",[bl],Object.getOwnPropertyDescriptor(rlt.prototype,"lightmapSize"),rlt.prototype),ilt=rlt))||ilt),Wlt=(flt=ol("cc.MeshRenderer"),plt=Sl(),_lt=sl(100),dlt=vl(),mlt=kl(Hlt),vlt=wl(),glt=kl(Vlt),ylt=wl(),xlt=kl(Att),Slt=wl(),blt=Tl(),flt(Tlt=plt(Tlt=_lt(Tlt=dlt(Tlt=ml((Dlt=Rlt=function(t){function e(){var e;return q(e=t.call(this)||this,"lightmapSettings",Clt,V(e)),q(e,"_mesh",wlt,V(e)),q(e,"_shadowCastingMode",Alt,V(e)),q(e,"_shadowReceivingMode",Plt,V(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,q(e,"_enableMorph",Ilt,V(e)),e._modelType=rg,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(t,e){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[t];return n.length,n[e]},n.setWeights=function(t,e){var n=this._subMeshShapesWeights;e>=n.length||n[e].length===t.length&&(n[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},n.setWeight=function(t,e,n){var i=this._subMeshShapesWeights;if(!(e>=i.length)){var r=i[e];n>=r.length||(r[n]=t,this._uploadSubMeshShapesWeights(e))}},n.setInstancedAttribute=function(t,e){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===t){r[o].set(e);break}},n._updateLightmap=function(t,e,n,i,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var t=this._morphInstance&&this._modelType===rg?Glt:this._modelType,e=this._model=i.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof Glt&&e.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=eg.POSITION,this._model.transform.hasChangedFlags|=eg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var n=0;n<t;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=e[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},n._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},n._getBuiltinMaterial=function(){return Gv.get("missing-material")},n._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===Hlt.OFF?this._model.castShadow=!1:(this._shadowCastingMode,Hlt.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===Vlt.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var n=0;n<e.passes.length;++n)if(e.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof Glt&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var n=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):n?(n.length,t.targets.length,n.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var n=t.struct.morph;return n.subMeshMorphs.length===e.length&&e.every((function(t,e){var i,r,o=t.length;return(null!==(i=null===(r=n.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},L(e,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,n=this._mesh=t;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(TF),Rlt.ShadowCastingMode=Hlt,Rlt.ShadowReceivingMode=Vlt,Clt=X((Elt=Dlt).prototype,"lightmapSettings",[hl,bl,Ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jlt}}),wlt=X(Elt.prototype,"_mesh",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Alt=X(Elt.prototype,"_shadowCastingMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hlt.OFF}}),Plt=X(Elt.prototype,"_shadowReceivingMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vlt.ON}}),X(Elt.prototype,"shadowCastingMode",[mlt,vlt,Ll],Object.getOwnPropertyDescriptor(Elt.prototype,"shadowCastingMode"),Elt.prototype),X(Elt.prototype,"receiveShadow",[glt,ylt,Ll],Object.getOwnPropertyDescriptor(Elt.prototype,"receiveShadow"),Elt.prototype),X(Elt.prototype,"mesh",[xlt,Slt],Object.getOwnPropertyDescriptor(Elt.prototype,"mesh"),Elt.prototype),X(Elt.prototype,"enableMorph",[blt,Ll],Object.getOwnPropertyDescriptor(Elt.prototype,"enableMorph"),Elt.prototype),Ilt=X(Elt.prototype,"_enableMorph",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Tlt=Elt))||Tlt)||Tlt)||Tlt)||Tlt)||Tlt);Bn(Att.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),Fn(Att.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var qlt,Xlt,Ylt,Klt,Qlt,Zlt,Jlt,$lt,tut,eut,nut,iut,rut,out,aut,sut,cut,lut,uut,hut,fut,put=(Olt=ol("cc.Skeleton"),Mlt=kl([Ee]),Nlt=kl([Oi]),Olt((klt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_joints",Flt,V(e)),q(e,"_bindposes",zlt,V(e)),q(e,"_hash",Ult,V(e)),e._invBindposes=null,e}F(e,t);var n=e.prototype;return n.destroy=function(){var e,n;return null===(e=null===(n=i.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===e||e.releaseSkeleton(this),t.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},L(e,[{key:"joints",get:function(){return this._joints},set:function(t){this._joints=t}},{key:"bindposes",get:function(){return this._bindposes},set:function(t){this._bindposes=t}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var t=0;t<this._bindposes.length;t++){var e=new Oi;Oi.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var t="",e=0;e<this._bindposes.length;e++){var n=this._bindposes[e];t+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=Da(t,666)}return this._hash}}]),e}(Bu),Flt=X((Blt=klt).prototype,"_joints",[Mlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zlt=X(Blt.prototype,"_bindposes",[Nlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ult=X(Blt.prototype,"_hash",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Llt=Blt))||Llt);i.Skeleton=put,Fn(Wlt.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),i.ModelComponent=Wlt,Gt.setClassAlias(Wlt,"cc.ModelComponent");var _ut,dut,mut,vut,gut,yut,xut,Sut,but,Tut,Eut,Cut,wut,Aut,Put,Iut,Rut,Dut,Out,Mut,Nut,Lut,But,Fut,zut,Uut,kut,Gut,Hut,Vut,jut,Wut,qut,Xut,Yut,Kut,Qut,Zut,Jut,$ut,tht,eht,nht,iht,rht,oht,aht,sht,cht,lht=Yt({LUMINOUS_FLUX:0,LUMINANCE:1}),uht=new vi,hht=ol("cc.StaticLightSettings")((Jlt=function(){function t(){q(this,"_baked",Ylt,this),q(this,"_editorOnly",Klt,this),q(this,"_bakeable",Qlt,this),q(this,"_castShadow",Zlt,this)}return L(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),Ylt=X((Xlt=Jlt).prototype,"_baked",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Klt=X(Xlt.prototype,"_editorOnly",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qlt=X(Xlt.prototype,"_bakeable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zlt=X(Xlt.prototype,"_castShadow",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Xlt.prototype,"editorOnly",[bl],Object.getOwnPropertyDescriptor(Xlt.prototype,"editorOnly"),Xlt.prototype),X(Xlt.prototype,"bakeable",[bl],Object.getOwnPropertyDescriptor(Xlt.prototype,"bakeable"),Xlt.prototype),X(Xlt.prototype,"castShadow",[bl],Object.getOwnPropertyDescriptor(Xlt.prototype,"castShadow"),Xlt.prototype),qlt=Xlt))||qlt,fht=($lt=ol("cc.Light"),tut=wl(),eut=wl(),nut=Al(),iut=wl(),rut=kl(hht),$lt((fut=hut=function(t){function e(){var e;return q(e=t.call(this)||this,"_color",sut,V(e)),q(e,"_useColorTemperature",cut,V(e)),q(e,"_colorTemperature",lut,V(e)),q(e,"_staticSettings",uut,V(e)),e._type=Ug.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=Vg,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=i.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(i.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case Ug.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case Ug.SPHERE:t.addSphereLight(this._light);break;case Ug.SPOT:t.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case Ug.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case Ug.SPHERE:t.removeSphereLight(this._light);break;case Ug.SPOT:t.removeSpotLight(this._light)}}},L(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(uht.x=t.r/255,uht.y=t.g/255,uht.z=t.b/255,this._light.color=uht)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}(ih),hut.Type=Ug,hut.PhotometricTerm=lht,sut=X((aut=fut).prototype,"_color",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return di.WHITE.clone()}}),cut=X(aut.prototype,"_useColorTemperature",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lut=X(aut.prototype,"_colorTemperature",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),uut=X(aut.prototype,"_staticSettings",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hht}}),X(aut.prototype,"color",[tut],Object.getOwnPropertyDescriptor(aut.prototype,"color"),aut.prototype),X(aut.prototype,"useColorTemperature",[eut],Object.getOwnPropertyDescriptor(aut.prototype,"useColorTemperature"),aut.prototype),X(aut.prototype,"colorTemperature",[Dl,nut,iut],Object.getOwnPropertyDescriptor(aut.prototype,"colorTemperature"),aut.prototype),X(aut.prototype,"staticSettings",[rut],Object.getOwnPropertyDescriptor(aut.prototype,"staticSettings"),aut.prototype),out=aut))||out),pht=(_ut=ol("cc.DirectionalLight"),dut=Sl(),mut=vl(),vut=fl("_illuminance"),gut=wl(),_ut(yut=dut(yut=mut(yut=ml((Tut=function(t){function e(){var e;return q(e=t.call(this)||this,"_illuminanceHDR",Sut,V(e)),q(e,"_illuminanceLDR",but,V(e)),e._type=Ug.DIRECTIONAL,e._light=null,e._lightType=qg,e}return F(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*bm.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},L(e,[{key:"illuminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),e}(fht),Sut=X((xut=Tut).prototype,"_illuminanceHDR",[ll,vut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),but=X(xut.prototype,"_illuminanceLDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(xut.prototype,"illuminance",[gut],Object.getOwnPropertyDescriptor(xut.prototype,"illuminance"),xut.prototype),yut=xut))||yut)||yut)||yut)||yut),_ht=(Eut=ol("cc.SphereLight"),Cut=Sl(),wut=vl(),Aut=fl("_luminance"),Put=wl(),Iut=wl(),Rut=kl(lht),Dut=wl(),Out=wl(),Mut=wl(),Eut(Nut=Cut(Nut=wut(Nut=ml((Gut=function(t){function e(){var e;return q(e=t.call(this)||this,"_size",But,V(e)),q(e,"_luminanceHDR",Fut,V(e)),q(e,"_luminanceLDR",zut,V(e)),q(e,"_term",Uut,V(e)),q(e,"_range",kut,V(e)),e._type=Ug.SPHERE,e._light=null,e._lightType=ty,e}return F(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*bm.standardExposureValue*bm.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/bm.standardExposureValue/bm.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},L(e,[{key:"luminousFlux",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Hg(this._size):this._luminanceLDR},set:function(t){var e=0;i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/Hg(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(fht),But=X((Lut=Gut).prototype,"_size",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),Fut=X(Lut.prototype,"_luminanceHDR",[hl,Aut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Hg(.15)}}),zut=X(Lut.prototype,"_luminanceLDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uut=X(Lut.prototype,"_term",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lht.LUMINOUS_FLUX}}),kut=X(Lut.prototype,"_range",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(Lut.prototype,"luminousFlux",[Put],Object.getOwnPropertyDescriptor(Lut.prototype,"luminousFlux"),Lut.prototype),X(Lut.prototype,"luminance",[Iut],Object.getOwnPropertyDescriptor(Lut.prototype,"luminance"),Lut.prototype),X(Lut.prototype,"term",[Rut,Dut],Object.getOwnPropertyDescriptor(Lut.prototype,"term"),Lut.prototype),X(Lut.prototype,"size",[Out],Object.getOwnPropertyDescriptor(Lut.prototype,"size"),Lut.prototype),X(Lut.prototype,"range",[Mut],Object.getOwnPropertyDescriptor(Lut.prototype,"range"),Lut.prototype),Nut=Lut))||Nut)||Nut)||Nut)||Nut),dht=(Hut=ol("cc.SpotLight"),Vut=Sl(),jut=vl(),Wut=fl("_luminance"),qut=wl(),Xut=wl(),Yut=kl(lht),Kut=wl(),Qut=wl(),Zut=wl(),Jut=Al(),$ut=wl(),Hut(tht=Vut(tht=jut(tht=ml((cht=function(t){function e(){var e;return q(e=t.call(this)||this,"_size",nht,V(e)),q(e,"_luminanceHDR",iht,V(e)),q(e,"_luminanceLDR",rht,V(e)),q(e,"_term",oht,V(e)),q(e,"_range",aht,V(e)),q(e,"_spotAngle",sht,V(e)),e._type=Ug.SPOT,e._light=null,e._lightType=sy,e}return F(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*bm.standardExposureValue*bm.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/bm.standardExposureValue/bm.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},L(e,[{key:"luminousFlux",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Hg(this._size):this._luminanceLDR},set:function(t){var e=0;i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/Hg(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=$n(t))}}]),e}(fht),nht=X((eht=cht).prototype,"_size",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),iht=X(eht.prototype,"_luminanceHDR",[hl,Wut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Hg(.15)}}),rht=X(eht.prototype,"_luminanceLDR",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oht=X(eht.prototype,"_term",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lht.LUMINOUS_FLUX}}),aht=X(eht.prototype,"_range",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sht=X(eht.prototype,"_spotAngle",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),X(eht.prototype,"luminousFlux",[qut],Object.getOwnPropertyDescriptor(eht.prototype,"luminousFlux"),eht.prototype),X(eht.prototype,"luminance",[Xut],Object.getOwnPropertyDescriptor(eht.prototype,"luminance"),eht.prototype),X(eht.prototype,"term",[Yut,Kut],Object.getOwnPropertyDescriptor(eht.prototype,"term"),eht.prototype),X(eht.prototype,"size",[Qut],Object.getOwnPropertyDescriptor(eht.prototype,"size"),eht.prototype),X(eht.prototype,"range",[Zut],Object.getOwnPropertyDescriptor(eht.prototype,"range"),eht.prototype),X(eht.prototype,"spotAngle",[Dl,Jut,$ut],Object.getOwnPropertyDescriptor(eht.prototype,"spotAngle"),eht.prototype),tht=eht))||tht)||tht)||tht)||tht);i.LightComponent=fht,Gt.setClassAlias(fht,"cc.LightComponent"),i.DirectionalLightComponent=pht,Gt.setClassAlias(pht,"cc.DirectionalLightComponent"),i.SphereLightComponent=_ht,Gt.setClassAlias(_ht,"cc.SphereLightComponent"),i.SpotLightComponent=dht,Gt.setClassAlias(dht,"cc.SpotLightComponent"),Bn(dht.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),Bn(_ht.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),Bn(fht.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var mht=function(t,e,n){t[e+0]=n.m00,t[e+1]=n.m01,t[e+2]=n.m02,t[e+3]=n.m12,t[e+4]=n.m04,t[e+5]=n.m05,t[e+6]=n.m06,t[e+7]=n.m13,t[e+8]=n.m08,t[e+9]=n.m09,t[e+10]=n.m10,t[e+11]=n.m14};function vht(t,e){var n=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*n,t)/12)}new Ei,new Ei,new vi,new Ei,new vi;var ght=new Oo(Lr.POINT,Lr.POINT,Lr.NONE,Br.CLAMP,Br.CLAMP,Br.CLAMP),yht=new vi,xht=new vi,Sht=new vi,bht=new vi,Tht=new Oi,Eht=new Oi,Cht=new Bc,wht=Number.MAX_SAFE_INTEGER,Aht=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(br.TEXTURE_FLOAT)?Tr.RGBA32F:Tr.RGBA8}(this._device);this._formatSize=fa[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new hy(t),this._pool.initialize({format:e,roundUpFn:vht}),this._customPool=new hy(t),this._customPool.initialize({format:e,roundUpFn:vht})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var n=t[e],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},e.getDefaultPoseTexture=function(t,e,n){var i=0^t.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var o=t.joints,a=t.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),f=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!f)return r;r={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:f},s=new Float32Array(u),c=!0}vi.set(Sht,wht,wht,wht),vi.set(bht,-wht,-wht,-wht);for(var p=e.getBoneSpaceBounds(t),_=0,d=0;_<l;_++,d+=12){var m=n.getChildByPath(o[_]),v=m?KG(m,n,Tht):t.inverseBindposes[_],g=p[_];g&&(Bc.transform(Cht,g,v),Cht.getBoundary(yht,xht),vi.min(Sht,Sht,yht),vi.max(bht,bht,xht)),c&&(m&&Oi.multiply(v,v,a[_]),mht(s,d,m?v:Oi.IDENTITY))}var y=[new Bc];return r.bounds.set(e.hash,y),Bc.fromPoints(y[0],Sht,bht),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},e.getSequencePoseTexture=function(t,e,n,i){var r=t.hash^e.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=t.joints,s=t.bindposes,c=dU.getOrExtract(e).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var f=12*h*c,p=this._chunkIdxMap.get(r),_=void 0!==p?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,p):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!_)return null;var d=this._createAnimInfos(t,e,i);o={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:_,animInfos:d},l=new Float32Array(f),u=!0}var m=n.getBoneSpaceBounds(t),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new Bc(wht,wht,wht,-wht,-wht,-wht));for(var y=0,x=0;y<c;y++){for(var S=v[y],b=0;b<h;b++,x+=12){var T=o.animInfos[b],E=T.curveData,C=T.downstream,w=T.bindposeIdx,A=T.bindposeCorrection,P=void 0,I=!0;E&&C?P=Oi.multiply(Tht,E[y],C):E?P=E[y]:C?P=C:(P=t.inverseBindposes[w],I=!1);var R=m[b];if(R){var D=A?Oi.multiply(Eht,P,A):P;Bc.transform(Cht,R,D),Cht.getBoundary(yht,xht),vi.min(S.center,S.center,yht),vi.max(S.halfExtents,S.halfExtents,xht)}u&&(I&&Oi.multiply(Tht,P,s[w]),mht(l,x,I?Tht:Oi.IDENTITY))}Bc.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),n=e.next();!n.done;){var i=n.value;i.skeletonHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),n=e.next();!n.done;){var i=n.value;i.clipHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}},e._createAnimInfos=function(t,e,n){for(var i=[],r=t.joints,o=t.bindposes,a=r.length,s=dU.getOrExtract(e),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),f=void 0,p=void 0;!u;){var _=l.lastIndexOf("/");if(l=l.substring(0,_),u=s.joints[l],h?(f||(f=new Oi),Oi.fromRTS(Tht,h.rotation,h.position,h.scale),Oi.multiply(f,Tht,f),h=h.parent):p=l,_<0)break}var d=c,m=void 0;if(void 0!==p&&u){d=c-1;for(var v=0;v<a;v++)if(r[v]===p){d=v,m=new Oi,Oi.multiply(m,o[v],t.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:f,bindposeIdx:d,bindposeCorrection:m})}return i},L(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),Pht=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var n=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,Td.SIZE,Td.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1};return this._setAnimInfoDirty(r,!1),this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e._setAnimInfoDirty=function(t,e){t.dirty=e},e.switchClip=function(t){return t.data[0]=0,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t},e.clear=function(){for(var t,e=W(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),Iht=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new Aht(t),this.jointAnimationInfo=new Pht(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();i.internal.DataPoolManager=Iht;var Rht=[{name:"CC_USE_SKINNING",value:!0}];function Dht(t,e,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(e.push(r),t.push(a))}}var Oht,Mht,Nht,Lht,Bht,Fht,zht,Uht,kht,Ght,Hht,Vht,jht,Wht,qht,Xht,Yht,Kht,Qht,Zht,Jht,$ht,tft,eft,nft,ift,rft,oft,aft,sft,cft,lft,uft,hft,fft,pft,_ft,dft,mft,vft,gft,yft,xft,Sft,bft,Tft=new vi,Eft=new vi,Cft=new vi,wft=new vi,Aft=new Oi,Pft=new Bc,Ift=function(t){function e(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=Kv.SKINNING,e}F(e,t);var n=e.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,n){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)HG(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&n){this.transform=e;var r=n.getBoneSpaceBounds(t),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<t.joints.length;a++){var s=r[a],c=e.getChildByPath(t.joints[a]);if(s&&c){var l=GG(c,e),u=t.bindposes[a],h=[],f=[];o?Dht(h,f,o,a):(h.push(a),f.push(0)),this._joints.push({indices:h,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),vi.set(Tft,1/0,1/0,1/0),vi.set(Eft,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=kG(i.transform,t);Bc.transform(Pft,r,o),Pft.getBoundary(Cft,wft),vi.min(Tft,Tft,Cft),vi.max(Eft,Eft,wft)}var a=this._worldBounds;this._modelBounds&&a&&(Bc.fromPoints(this._modelBounds,Tft,Eft),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Oi.multiply(Aft,a.world,s);for(var c=0;c<o.length;c++)mht(this._dataArray[o[c]],12*r[c],Aft)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(e,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,t.prototype.initSubModel.call(this,e,n,i),o.vertexBuffers=r},n.getMacroPatches=function(e){var n=t.prototype.getMacroPatches.call(this,e);return n?Rht.concat(n):Rht},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n);var i=this._buffers[this._bufferIndices[e]];i&&n.bindBuffer(Cd.BINDING,i)},n._updateInstancedAttributes=function(e,n){n.batchingScheme!==zv.NONE&&E(3936,this.node.name),t.prototype._updateInstancedAttributes.call(this,e,n)},n._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,Cd.SIZE,Cd.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(Cd.COUNT))},e}(Glt),Rft=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],Dft=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=Kv.BAKED_SKINNING,e._dataPoolManager=i.director.root.dataPoolManager;var n=new Float32Array(4),r=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:r,texture:null,boundsInfo:null},e}F(e,t);var n=e.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,n){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),this._skeleton=t,this._mesh=n,t&&e&&n){this.transform=e;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new Co(wr.UNIFORM|wr.TRANSFER_DST,Ir.DEVICE,bd.SIZE,bd.SIZE)))}},n.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(t){this._modelBounds=t},n.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,n=null;t?(n=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=t.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Pd,o)}},n.getMacroPatches=function(e){var n=t.prototype.getMacroPatches.call(this,e);return n?n.concat(Rft):Rft},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(bd.BINDING,r),n.bindBuffer(Td.BINDING,a.buffer),o){var s=this._device.getSampler(ght);n.bindTexture(Pd,o.handle.texture),n.bindSampler(Pd,s)}},n._setInstAnimInfoIdx=function(t){this._instAnimInfoIdx=t},n._updateInstancedAttributes=function(e,n){t.prototype._updateInstancedAttributes.call(this,e,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(Ed)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,n=t.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=e[1],r[2]=e[2]}},e}(Glt),Oft=(Oht=ol("cc.SkinnedMeshRenderer"),Mht=Sl(),Nht=sl(100),Lht=vl(),Bht=kl(put),Fht=kl($C),zht=kl(put),Uht=kl($C),kht=wl(),Oht(Ght=Mht(Ght=Nht(Ght=ml(Ght=Lht((Wht=function(t){function e(){var e;return q(e=t.call(this)||this,"_skeleton",Vht,V(e)),q(e,"_skinningRoot",jht,V(e)),e._clip=null,e._animation=null,e._modelType=Dft,e}F(e,t);var n=e.prototype;return n.onDestroy=function(){this._animation&&(this._animation.removeUser(this),this._animation=null),t.prototype.onDestroy.call(this)},n.__preload=function(){this._tryBindAnimation()},n.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},n.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var n=t?Dft:Ift;(e||this._modelType!==n)&&(this._modelType=n,this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(e,n){t.prototype.setMaterial.call(this,e,n),this._modelType===Ift&&this.getMaterialInstance(n)},n.notifyAnimationUsable=function(t){this._animation&&(this._animation.removeUser(this),this._animation=null),t.addUser(this),this._animation=t},n.notifyAnimationUnusable=function(){this._animation=null},n._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var t=this._skinningRoot;if(t){var e=t.getComponent("cc.SkeletalAnimation");e?e.addUser(this):this.setUseBakedAnimation(!1)}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},L(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._tryBindAnimation(),this._update())}},{key:"model",get:function(){return this._model}}]),e}(Wlt),Vht=X((Hht=Wht).prototype,"_skeleton",[Bht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jht=X(Hht.prototype,"_skinningRoot",[Fht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Hht.prototype,"skeleton",[zht],Object.getOwnPropertyDescriptor(Hht.prototype,"skeleton"),Hht.prototype),X(Hht.prototype,"skinningRoot",[Uht,kht],Object.getOwnPropertyDescriptor(Hht.prototype,"skinningRoot"),Hht.prototype),Ght=Hht))||Ght)||Ght)||Ght)||Ght)||Ght),Mft=new Ho(co.ATTR_BATCH_ID,Tr.R32F),Nft=new Ho(co.ATTR_BATCH_UV,Tr.RG32F),Lft=fa[Mft.format].size+fa[Nft.format].size,Bft=(qht=ol("cc.SkinnedMeshUnit"),Xht=kl(Att),Yht=kl(put),Kht=kl(Og),Qht=kl(Oft),qht((oft=function(){function t(){q(this,"mesh",$ht,this),q(this,"skeleton",tft,this),q(this,"material",eft,this),q(this,"_localTransform",nft,this),q(this,"_offset",ift,this),q(this,"_size",rft,this)}return L(t,[{key:"offset",get:function(){return this._offset},set:function(t){Bi.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){Bi.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&KG(t.node,t.skinningRoot,this._localTransform))}}]),t}(),$ht=X((Jht=oft).prototype,"mesh",[Xht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tft=X(Jht.prototype,"skeleton",[Yht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eft=X(Jht.prototype,"material",[Kht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nft=X(Jht.prototype,"_localTransform",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Oi}}),ift=X(Jht.prototype,"_offset",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(0,0)}}),rft=X(Jht.prototype,"_size",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi(1,1)}}),X(Jht.prototype,"offset",[bl],Object.getOwnPropertyDescriptor(Jht.prototype,"offset"),Jht.prototype),X(Jht.prototype,"size",[bl],Object.getOwnPropertyDescriptor(Jht.prototype,"size"),Jht.prototype),X(Jht.prototype,"copyFrom",[Qht],Object.getOwnPropertyDescriptor(Jht.prototype,"copyFrom"),Jht.prototype),Zht=Jht))||Zht),Fft=new Oi,zft=(new Oi,new vi),Uft=(aft=ol("cc.SkinnedMeshBatchRenderer"),sft=Sl(),cft=sl(100),lft=vl(),uft=wl(),hft=kl([Ee]),fft=wl(),pft=kl([Bft]),_ft=wl(),dft=Tl(),mft=Tl(),aft(vft=sft(vft=cft(vft=ml(vft=lft((bft=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"atlasSize",yft,V(e)),q(e,"batchableTextureNames",xft,V(e)),q(e,"units",Sft,V(e)),e._textures={},e._batchMaterial=null,e}F(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},n._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var n=e.effectAsset.techniques[e.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=Cr.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===n}))?((o=t._textures[n])||(o=t.createTexture(n)),t.cookTextures(o,n,i)):t.units.some((function(t){return o=t.material&&t.material.getProperty(n,i)})),o&&e.setProperty(n,o,i)}else{for(var a=[],s=0;s<t.units.length;s++){var c=t.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}e.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Oi.invert(Fft,i._localTransform);for(var o=function(n){var i=r.joints[n];if(t.findIndex((function(t){return t===i}))>=0)return"continue";t.push(i),e.push(Oi.multiply(new Oi,r.bindposes[n]||Oi.IDENTITY,Fft))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(t.length).keys()).sort((function(e,n){return t[e]>t[n]?1:t[e]<t[n]?-1:0})),c=new put;c.joints=t.map((function(t,e,n){return n[s[e]]})),c.bindposes=e.map((function(t,e,n){return n[s[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var t=this,e=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Att;for(var i=0,r=Tr.UNKNOWN,o=0,a=Tr.UNKNOWN,s=0,c=Tr.UNKNOWN,l=0,u=Tr.UNKNOWN,h=0,f=Tr.UNKNOWN,p=new Array(this.units.length),_=this.units.length,d=0;d<_;d++){var m=this.units[d];m&&m.skeleton&&(p[d]=m.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var v=function(e){var n=t.units[e];if(!n||!n.mesh||!n.mesh.data)return"continue";var _=t._createUnitMesh(e,n.mesh),d=new DataView(_.data.buffer);Oi.inverseTranspose(Fft,n._localTransform);for(var m=n.offset,v=n.size,g=function(t){var g=_.struct.vertexBundles[t];i=g.view.offset,r=Tr.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===co.ATTR_POSITION){r=x.format;break}i+=fa[x.format].size}if(r){for(var S=qw(d,r,i,g.view.length,g.view.stride),b=0;b<S.length;b+=3)vi.fromArray(zft,S,b),vi.transformMat4(zft,zft,n._localTransform),vi.toArray(S,zft,b);Ww(d,S,r,i,g.view.stride)}o=g.view.offset,a=Tr.UNKNOWN;for(var T=0;T<g.attributes.length;T++){var E=g.attributes[T];if(E.name===co.ATTR_NORMAL){a=E.format;break}o+=fa[E.format].size}if(a){for(var C=qw(d,a,o,g.view.length,g.view.stride),w=0;w<C.length;w+=3)vi.fromArray(zft,C,w),vi.transformMat4Normal(zft,zft,Fft),vi.toArray(C,zft,w);Ww(d,C,a,o,g.view.stride)}s=g.view.offset,c=Tr.UNKNOWN;for(var A=0;A<g.attributes.length;A++){var P=g.attributes[A];if(P.name===co.ATTR_TANGENT){c=P.format;break}s+=fa[P.format].size}if(c){for(var I=qw(d,c,s,g.view.length,g.view.stride),R=0;R<I.length;R+=3)vi.fromArray(zft,I,R),vi.transformMat4Normal(zft,zft,Fft),vi.toArray(I,zft,R);Ww(d,I,c,s,g.view.stride)}l=g.view.offset,u=Tr.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var O=g.attributes[D];if(O.name===co.ATTR_BATCH_UV){u=O.format;break}l+=fa[O.format].size}u&&Xw(d,(function(t,e){var n,i=0===e?"x":"y";return(t=(n=t)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,d);var M=p[e];if(!M)return"continue";h=g.view.offset,f=Tr.UNKNOWN;for(var N=0;N<g.attributes.length;N++){var L=g.attributes[N];if(L.name===co.ATTR_JOINTS){f=L.format;break}h+=fa[L.format].size}f&&Xw(d,(function(t){return M[t]}),f,h,g.view.length,g.view.stride,d)},y=0;y<_.struct.vertexBundles.length;y++)g(y);t._mesh.merge(_)},g=0;g<_;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(t,e,n){for(var r=[],o=[],a=[],s=[],c=0;c<this.units.length;c++){var l=this.units[c];if(l.material){var u=l.material.getProperty(e,n);if(u&&u.image&&u.image.data){var h=new yo;h.texOffset.x=l.offset.x*this.atlasSize,h.texOffset.y=l.offset.y*this.atlasSize,h.texExtent.width=l.size.x*this.atlasSize,h.texExtent.height=l.size.y*this.atlasSize;var f=u.image.data;ArrayBuffer.isView(f)?(a.push(f),s.push(h)):(r.push(f),o.push(h))}}}var p=t.getGFXTexture(),_=i.director.root.device;a.length>0&&_.copyBuffersToTexture(a,p,s),r.length>0&&_.copyTexImagesToTexture(r,p,o)},n.createTexture=function(t){var e=new cv;return e.setFilters(lm.LINEAR,lm.LINEAR),e.setMipFilter(lm.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:sm.RGBA8888}),this._textures[t]=e,e},n.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:sm.RGBA8888})},n._createUnitMesh=function(t,e){for(var n=JSON.parse(JSON.stringify(e.struct)),r={},o=0;o<e.struct.primitives.length;o++){for(var a=e.struct.primitives[o],s=0,c=Tr.UNKNOWN,l=0;l<a.vertexBundelIndices.length;l++){var u=e.struct.vertexBundles[a.vertexBundelIndices[l]];s=u.view.offset,c=Tr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var f=u.attributes[h];if(f.name===co.ATTR_TEX_COORD){c=f.format;break}s+=fa[f.format].size}if(c)break}if(void 0===r[l]){r[l]=[c,s];var p=n.vertexBundles[l];p.attributes.push(Mft),p.attributes.push(Nft),p.view.offset=0,p.view.length+=p.view.count*Lft,p.view.stride+=Lft}}for(var _=0,d=0;d<n.vertexBundles.length;d++)_+=n.vertexBundles[d].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=_,_+=v.indexView.length)}var g=new Uint8Array(_),y=e.data,x=new DataView(g.buffer),S=new DataView(y.buffer),b=i.sys.isLittleEndian;for(var T in r)for(var E=n.vertexBundles[T],C=e.struct.vertexBundles[T],w=r[T],A=qw(S,w[0],w[1],C.view.length,C.view.stride),P=C.view,I=E.view,R=P.stride,D=I.stride,O=P.offset,M=I.offset,N=0;N<I.count;N++){var L=y.subarray(O,O+R);g.set(L,M),x.setFloat32(M+R,t),x.setFloat32(M+R+4,A[2*N],b),x.setFloat32(M+R+8,A[2*N+1],b),M+=D,O+=R}for(var B=0;B<n.primitives.length;B++){var F=e.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,k=z.indexView.stride,G=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var j=y.subarray(G,G+U);g.set(j,H),H+=k,G+=U}}var W=new Att;return W.reset({struct:n,data:g}),W},L(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(Oft),yft=X((gft=bft).prototype,"atlasSize",[hl,uft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),xft=X(gft.prototype,"batchableTextureNames",[hft,hl,fft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sft=X(gft.prototype,"units",[pft,hl,_ft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(gft.prototype,"mesh",[Ql,dft],Object.getOwnPropertyDescriptor(gft.prototype,"mesh"),gft.prototype),X(gft.prototype,"skeleton",[Ql,mft],Object.getOwnPropertyDescriptor(gft.prototype,"skeleton"),gft.prototype),vft=gft))||vft)||vft)||vft)||vft)||vft);i.SkinningModelComponent=Oft,Gt.setClassAlias(Oft,"cc.SkinningModelComponent"),i.SkinningModelUnit=Bft,Gt.setClassAlias(Bft,"cc.SkinningModelUnit"),i.BatchedSkinningModelComponent=Uft,Gt.setClassAlias(Uft,"cc.BatchedSkinningModelComponent");var kft,Gft,Hft,Vft,jft,Wft,qft,Xft,Yft,Kft,Qft,Zft,Jft,$ft,tpt,ept,npt,ipt,rpt,opt,apt=new Oi,spt=new Oi,cpt=function(t){function e(e,n){var r;return void 0===n&&(n=""),(r=t.call(this,e,n)||this)._frames=1,r._bakedDuration=0,r._animInfo=null,r._sockets=[],r._animInfoMgr=void 0,r._parent=null,r._curvesInited=!1,r._animInfoMgr=i.director.root.dataPoolManager.jointAnimationInfo,r}F(e,t);var n=e.prototype;return n.initialize=function(e){if(!this._curveLoaded){this._parent=e.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,t.prototype.initialize.call(this,e),this._curvesInited=!n;var i=dU.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/o}},n.onPlay=function(){var e=this;t.prototype.onPlay.call(this),this._parent.useBakedAnimation?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip),this._parent.getUsers().forEach((function(t){t.uploadAnimation(e.clip)}))):(this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,n=0;n<t.length;++n){var i=t[n],r=e.getChildByPath(i.path);if(i.target){for(var o=dU.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Oi.identity(spt)),Oi.fromRTS(apt,c.rotation,c.position,c.scale),Oi.multiply(l,apt,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,f=o.frames,p=[],_=0;_<f;_++){var d;d=h&&l?Oi.multiply(apt,h[_],l):h?h[_]:l||new Oi;var m={pos:new vi,rot:new Ei,scale:new vi};Oi.toRTS(d,m.rot,m.pos,m.scale),p.push(m)}this._sockets.push({target:i.target,frames:p})}}},n._setAnimInfoDirty=function(t,e){t.dirty=e},n._sampleCurvesBaked=function(t){var e=t/this.duration,n=this._animInfo,i=e*this._frames+.5|0;if(i!==n.data[0]){n.data[0]=i,this._setAnimInfoDirty(n,!0);for(var r=0;r<this._sockets.length;++r){var o=this._sockets[r],a=o.target,s=o.frames[i],c=s.pos,l=s.rot,u=s.scale;a.setRTS(l,c,u)}}},e}(cG),lpt=(kft=ol("cc.SkeletalAnimation.Socket"),Gft=kl($C),kft((jft=X((Vft=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),q(this,"path",jft,this),q(this,"target",Wft,this),this.path=t,this.target=e}).prototype,"path",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wft=X(Vft.prototype,"target",[Gft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hft=Vft))||Hft);Gt.setClassAlias(lpt,"cc.SkeletalAnimationComponent.Socket");var upt=new Oi,hpt=new Oi;function fpt(t,e,n){void 0===e&&(e=""),void 0===n&&(n=[]);for(var i=0;i<t.children.length;i++){var r=t.children[i];if(r){var o=e?e+"/"+r.name:r.name;n.push(o),fpt(r,o,n)}}return n}var ppt=(qft=ol("cc.SkeletalAnimation"),Xft=Sl(),Yft=sl(99),Kft=vl(),Qft=kl([lpt]),Zft=wl(),Jft=wl(),$ft=kl([lpt]),qft(tpt=Xft(tpt=Yft(tpt=ml(tpt=Kft((opt=rpt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_useBakedAnimation",npt,V(e)),q(e,"_sockets",ipt,V(e)),e._users=new Set,e._currentBakedState=null,e}F(e,t);var n=e.prototype;return n.onDestroy=function(){t.prototype.onDestroy.call(this),i.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),i.director.getAnimationManager().removeSockets(this.node,this._sockets)},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},n.pause=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.pause():t.prototype.pause.call(this)},n.resume=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.resume():t.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):t.prototype.stop.call(this)},n.querySockets=function(){var t=this._defaultClip&&Object.keys(dU.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],n=0;n<t.length;n++){var i=t[n],r=this.node.getChildByPath(i);r&&(e.push(i),fpt(r,i,e))}return e},n.rebuildSocketAnimations=function(){for(var t,e=W(this._sockets);!(t=e()).done;){var n=t.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,KG(i,this.node,upt),Oi.fromRTS(hpt,r.rotation,r.position,r.scale),Oi.equals(hpt,upt)||(r.matrix=upt))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var n=new $C;return n.parent=this.node,this._sockets.push(new lpt(t,n)),this.rebuildSocketAnimations(),n},n.addUser=function(t){this._users.add(t);var e=this._useBakedAnimation;if(t.setUseBakedAnimation(e,!0),e){var n=this._currentBakedState;n&&t.uploadAnimation(n.clip)}},n.removeUser=function(t){t.setUseBakedAnimation(!1),t.notifyAnimationUnusable(),this._users.delete(t)},n.getUsers=function(){return this._users},n._createState=function(t,e){return new cpt(t,e)},n._doCreateState=function(e,n){var i=t.prototype._doCreateState.call(this,e,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(e,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=e;this._currentBakedState=i,i.play()}else t.prototype.doPlayOrCrossFade.call(this,e,n)},n._removeAllUsers=function(){var t=this;Array.from(this._users).forEach((function(e){t.removeUser(e)}))},L(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=i.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){this._useBakedAnimation=t,this._removeAllUsers();for(var e=this.node.getComponentsInChildren(Oft),n=0;n<e.length;++n){var r=e[n];r.skinningRoot===this.node&&r.notifyAnimationUsable(this)}this._useBakedAnimation?i.director.getAnimationManager().removeSockets(this.node,this._sockets):(i.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),e}(AG),rpt.Socket=lpt,X((ept=opt).prototype,"sockets",[Qft,Zft],Object.getOwnPropertyDescriptor(ept.prototype,"sockets"),ept.prototype),X(ept.prototype,"useBakedAnimation",[Jft],Object.getOwnPropertyDescriptor(ept.prototype,"useBakedAnimation"),ept.prototype),npt=X(ept.prototype,"_useBakedAnimation",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ipt=X(ept.prototype,"_sockets",[$ft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tpt=ept))||tpt)||tpt)||tpt)||tpt)||tpt);i.SkeletalAnimationComponent=ppt,Gt.setClassAlias(ppt,"cc.SkeletalAnimationComponent"),i.utils=Oet;var _pt,dpt,mpt,vpt,gpt,ypt,xpt,Spt,bpt,Tpt,Ept,Cpt,wpt,Apt,Ppt,Ipt,Rpt,Dpt,Opt,Mpt,Npt,Lpt,Bpt,Fpt,zpt,Upt,kpt,Gpt,Hpt,Vpt,jpt,Wpt,qpt,Xpt,Ypt=[0,0,1,0,0,1,1,1],Kpt=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e.type=Kv.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=new Io([new Ao]),e._iaInfoBuffer=e._device.createBuffer(new Co(wr.INDIRECT,Ir.HOST|Ir.DEVICE,ma,ma)),e._subMeshData=null,e._mesh=null,e}F(e,t);var n=e.prototype;return n.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._subMeshData&&e&&this.rebuild()},n.setVertexAttributes=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertSize=0;for(var n,i=W(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=fa[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var n=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===co.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,co.ATTR_TEX_COORD,e,this._vertSize,n);var i=this._vertAttrs.findIndex((function(t){return t.name===co.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,co.ATTR_POSITION,e,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,co.ATTR_NORMAL,e,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,co.ATTR_COLOR,e,this._vertSize,n))for(var r=new Uint32Array(e),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=di.WHITE._val;for(var a=new Float32Array(e),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}t.update(e);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var p=4*f;c[h++]=p,c[h++]=p+1,c[h++]=p+2,c[h++]=p+3,c[h++]=p+2,c[h++]=p+1}var _=this._device.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return _.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new Co(wr.INDIRECT,Ir.HOST|Ir.DEVICE,ma,ma))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Qw([t],this._vertAttrs,Yr.TRIANGLE_LIST,_,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},n.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},n.addParticleVertexData=function(t,e){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(t*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,i+=2,this._vdataF32[i++]=e[1].z,this._vdataF32[i++]=e[2].x,this._vdataF32[i++]=e[2].y,this._vdataF32[i++]=e[2].z,this._vdataF32[i++]=e[3].x,this._vdataF32[i++]=e[3].y,this._vdataF32[i++]=e[3].z,this._vdataUint32[i++]=e[4]}else{var r=t*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=e[1].x,this._vdataF32[r++]=e[1].y,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4],e[5]&&(this._vdataF32[r++]=e[5].x,this._vdataF32[r++]=e[5].y,this._vdataF32[r++]=e[5].z)}},n.addGPUParticleVertexData=function(t,e,n){for(var i=e*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=t.position.x,this._vdataF32[o++]=t.position.y,this._vdataF32[o++]=t.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=t.startSize.x,this._vdataF32[o++]=t.startSize.y,this._vdataF32[o++]=t.startSize.z,this._vdataF32[o++]=Ypt[2*r],this._vdataF32[o++]=t.rotation.x,this._vdataF32[o++]=t.rotation.y,this._vdataF32[o++]=t.rotation.z,this._vdataF32[o++]=Ypt[2*r+1],this._vdataF32[o++]=t.startColor.r/255,this._vdataF32[o++]=t.startColor.g/255,this._vdataF32[o++]=t.startColor.b/255,this._vdataF32[o++]=t.startColor.a/255,this._vdataF32[o++]=t.velocity.x,this._vdataF32[o++]=t.velocity.y,this._vdataF32[o++]=t.velocity.z,this._vdataF32[o++]=t.startLifetime,this._vdataF32[o++]=t.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(t,e,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<t;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-o)<n&&(a=--t*i,this._vdataF32.copyWithin(r,a,a+i),s--);return t},n.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},n.updateIA=function(t){t<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo))},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){t.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},e}(rg),Qpt=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=t}var e=t.prototype;return e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(i.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===Wit.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){this._model||(this._model=i.director.root.createModel(Kpt),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},t}(),Zpt=new vi,Jpt=new Oi,$pt=new Ei,t_t=(new vi,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),e_t=[0,0,1,0,0,1,1,1],n_t=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD1,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD2,Tr.RGB32F),new Ho(co.ATTR_COLOR,Tr.RGBA8,!0)],i_t=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD1,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD2,Tr.RGB32F),new Ho(co.ATTR_COLOR,Tr.RGBA8,!0),new Ho(co.ATTR_COLOR1,Tr.RGB32F)],r_t=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD1,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD2,Tr.RGB32F),new Ho(co.ATTR_COLOR,Tr.RGBA8,!0),new Ho(co.ATTR_TEX_COORD3,Tr.RGB32F),new Ho(co.ATTR_NORMAL,Tr.RGB32F),new Ho(co.ATTR_COLOR1,Tr.RGBA8,!0)],o_t={parent:null,owner:null,subModelIdx:0},a_t=function(t){function e(e){var n;return(n=t.call(this,e)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=jit.View,n._inited=!1,n._localMat=new Oi,n._gravity=new ki,n._model=null,n._frameTile_velLenScale=new ki(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new ki,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}F(e,t);var n=e.prototype;return n.onInit=function(e){var n=this;t.prototype.onInit.call(this,e),this._particles=new Wt((function(){return new tit(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var t=this;t_t.forEach((function(e){var n=t._particleSystem[e];n&&n.enable&&(n.needUpdate&&(t._updateList[n.name]=n),n.needAnimate&&(t._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var e=0,n=Uit.length;e<n;e++){var i=this._animateList[Uit[e]];i&&this._runAnimateList.push(i)}},n.enableModule=function(t,e,n){e?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var i=0,r=Uit.length;i<r;i++){var o=this._animateList[Uit[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(t){this._alignSpace=t},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(t){t&&this.doUpdateRotation(t)},n.doUpdateRotation=function(t){if(this._renderInfo.renderMode===Wit.Mesh||this._alignSpace!==jit.View){if(this._alignSpace===jit.Local)this._particleSystem.node.getRotation($pt);else if(this._alignSpace===jit.World)this._particleSystem.node.getWorldRotation($pt);else if(this._alignSpace===jit.View){var e;$pt.set(0,0,0,1);var n=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Ei.fromViewUp($pt,r.forward);break}}}else $pt.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,$pt)}},n.updateScale=function(t){t&&this.doUpdateScale(t)},n.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case Hit.Local:this._particleSystem.node.getScale(this._node_scale);break;case Hit.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(t){var e=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(Jpt);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(t){t.update(n._simulationSpace,Jpt)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===Hit.Local){var a=n.node.getRotation();Oi.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=e._particles.data[i];if(a.remainingLifetime-=t,vi.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),e._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===Hit.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,ri(a.randomSeed))*t;e._gravity.x=0,e._gravity.y=s,e._gravity.z=0,e._gravity.w=1,e._gravity=e._gravity.transformMat4(e._localMat),a.velocity.x+=e._gravity.x,a.velocity.y+=e._gravity.y,a.velocity.z+=e._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,ri(a.randomSeed))*t;vi.copy(a.ultimateVelocity,a.velocity),e._runAnimateList.forEach((function(e){e.animate(a,t)})),vi.scaleAndAdd(a.position,a.position,a.ultimateVelocity,t),o&&r.animate(a,t),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var n=this._particles.data[e],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),t=4*e,this._fillDataFunc(n,t,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===t&&n._trailModel.setSubModelMaterial(0,e)},n._setFillFunc=function(){this._renderInfo.renderMode===Wit.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===Wit.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(t,e,n){var i=e/4;this._attrs[0]=t.position,Zpt.z=n,this._attrs[1]=Zpt,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(t,e,n){for(var i=0;i<4;++i)this._attrs[0]=t.position,Zpt.x=e_t[2*i],Zpt.y=e_t[2*i+1],Zpt.z=n,this._attrs[1]=Zpt,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(e++,this._attrs)},n._fillNormalData=function(t,e,n){for(var i=0;i<4;++i)this._attrs[0]=t.position,Zpt.x=e_t[2*i],Zpt.y=e_t[2*i+1],Zpt.z=n,this._attrs[1]=Zpt,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(e++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case Wit.StrecthedBillboard:this._vertAttrs=i_t.slice();break;case Wit.Mesh:this._vertAttrs=r_t.slice();break;default:this._vertAttrs=n_t.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!=e){var n=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||t.setMaterial(null,0)}null==t.sharedMaterial&&null==this._defaultMat&&(o_t.parent=Gv.get("default-particle-material"),o_t.owner=this._particleSystem,o_t.subModelIdx=0,this._defaultMat=new Yg(o_t),o_t.parent=null,o_t.owner=null,o_t.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===Hit.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===Wit.Billboard?this._defines.CC_RENDER_MODE=0:o===Wit.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===Wit.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===Wit.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===Wit.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=t._textureAnimationModule;s&&s.enable?(ki.copy(this._tmp_velLenScale,a),Bi.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===Hit.World||e.space===Hit.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=t.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(o_t.parent=Gv.get("default-trail-material"),o_t.owner=this._particleSystem,o_t.subModelIdx=1,this._defaultTrailMat=new Yg(o_t),o_t.parent=null,o_t.owner=null,o_t.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},e}(Qpt),s_t=new Oi,c_t=new ki,l_t=new Ei,u_t=new Ei,h_t=(new vi,32),f_t="a_position_starttime",p_t="a_size_uv",__t="a_rotation_uv",d_t="a_color",m_t="a_dir_life",v_t="a_rndSeed",g_t=[new Ho(f_t,Tr.RGBA32F),new Ho(p_t,Tr.RGBA32F),new Ho(__t,Tr.RGBA32F),new Ho(d_t,Tr.RGBA32F),new Ho(m_t,Tr.RGBA32F),new Ho(v_t,Tr.R32F)],y_t=[new Ho(f_t,Tr.RGBA32F),new Ho(p_t,Tr.RGBA32F),new Ho(__t,Tr.RGBA32F),new Ho(d_t,Tr.RGBA32F),new Ho(m_t,Tr.RGBA32F),new Ho(v_t,Tr.R32F),new Ho(co.ATTR_TEX_COORD,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD3,Tr.RGB32F),new Ho(co.ATTR_NORMAL,Tr.RGB32F),new Ho(co.ATTR_COLOR1,Tr.RGBA8,!0)],x_t={parent:null,owner:null,subModelIdx:0},S_t=function(t){function e(e){var n;return(n=t.call(this,e)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=jit.View,n._inited=!1,n._frameTile_velLenScale=new ki(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new ki,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new tit(null),n._particleNum=0,n}F(e,t);var n=e.prototype;return n.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,t))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(t){t&&this.doUpdateRotation(t)},n.doUpdateRotation=function(t){if(this._renderInfo.renderMode===Wit.Mesh||this._alignSpace!==jit.View){if(this._alignSpace===jit.Local)this._particleSystem.node.getRotation(u_t);else if(this._alignSpace===jit.World)this._particleSystem.node.getWorldRotation(u_t);else if(this._alignSpace===jit.View){var e;u_t.set(0,0,0,1);var n=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Ei.fromViewUp(u_t,r.forward);break}}}else u_t.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,u_t)}},n.updateScale=function(t){t&&this.doUpdateScale(t)},n.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case Hit.Local:this._particleSystem.node.getScale(this._node_scale);break;case Hit.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(t.getHandle("scale"),this._node_scale)},n.updateParticles=function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(t){this._alignSpace=t},n.updateShaderUniform=function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var n=e.passes[0];c_t.x=this._particleSystem._time,c_t.y=t,n.setUniform(this._uTimeHandle,c_t),this._particleSystem.node.getWorldRotation(l_t),n.setUniform(this._uRotHandle,l_t),this.doUpdateRotation(n)}},n.initShaderUniform=function(t){var e=t.passes[0];this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),this._uNodeRotHandle=e.getHandle("nodeRotation"),this.doUpdateScale(e),e.setUniform(e.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),c_t.x=h_t,c_t.y=.03125,e.setUniform(e.getHandle("u_sampleInfo"),c_t);var n=!1,r=this._particleSystem._forceOvertimeModule;if(n=r&&r.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=jet(h_t,r.x,r.y,r.z);var o=e.getHandle("force_over_time_tex0"),a=Yv.getBindingFromHandle(o);e.bindSampler(a,this._forceTexture.getGFXSampler()),e.bindTexture(a,this._forceTexture.getGFXTexture());var s=e.getHandle("u_force_space");e.setUniform(s,r.space);var c=e.getHandle("u_force_mode");e.setUniform(c,this._forceTexture.height)}var l=this._particleSystem._velocityOvertimeModule;if(n=l&&l.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(t,e,n,i,r){for(var o=Math.max(Het(e),Het(n),Het(i),Het(r)),a=new Float32Array(t*o*4),s=[e,n,i,r],c=1/(t-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],f=0,p=0,_=0;_<t;_++){var d=Get(h,c*_,l);p=(f+=d)/(_+1),a[4*_+u]=p}return Vet(a,t,o)}(h_t,l.x,l.y,l.z,l.speedModifier);var u=e.getHandle("velocity_over_time_tex0"),h=Yv.getBindingFromHandle(u);e.bindSampler(h,this._velocityTexture.getGFXSampler()),e.bindTexture(h,this._velocityTexture.getGFXTexture());var f=e.getHandle("u_velocity_space");e.setUniform(f,l.space);var p=e.getHandle("u_velocity_mode");e.setUniform(p,this._velocityTexture.height)}var _=this._particleSystem._colorOverLifetimeModule;if(n=_&&_.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(t,e){for(var n=function(t){switch(t.mode){case Ynt.TwoColors:case Ynt.TwoGradients:return 2;default:return 1}}(e),i=new Uint8Array(t*n*4),r=1/(t-1),o=0,a=0;a<n;a++)for(var s=0;s<t;s++){var c=Qnt(e,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new cv;return l.create(t,n,sm.RGBA8888),l.setFilters(lm.LINEAR,lm.LINEAR),l.setWrapMode(cm.CLAMP_TO_EDGE,cm.CLAMP_TO_EDGE),l.uploadData(i),l}(h_t,_.color);var d=e.getHandle("color_over_time_tex0"),m=Yv.getBindingFromHandle(d);e.bindSampler(m,this._colorTexture.getGFXSampler()),e.bindTexture(m,this._colorTexture.getGFXTexture());var v=e.getHandle("u_color_mode");e.setUniform(v,this._colorTexture.height)}var g=this._particleSystem._rotationOvertimeModule;if(n=g&&g.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),g.separateAxes?this._rotationTexture=jet(h_t,g.x,g.y,g.z):this._rotationTexture=function(t,e){for(var n=Het(e),i=new Float32Array(t*n*4),r=1/(t-1),o=0,a=0;a<n;a++)for(var s=0;s<t;s++){var c=Get(e,r*s,a);i[o+2]=c,o+=4}return Vet(i,t,n)}(h_t,g.z);var y=e.getHandle("rotation_over_time_tex0"),x=Yv.getBindingFromHandle(y);e.bindSampler(x,this._rotationTexture.getGFXSampler()),e.bindTexture(x,this._rotationTexture.getGFXTexture());var S=e.getHandle("u_rotation_mode");e.setUniform(S,this._rotationTexture.height)}var b=this._particleSystem._sizeOvertimeModule;if(n=b&&b.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),b.separateAxes?this._sizeTexture=jet(h_t,b.x,b.y,b.z,!0):this._sizeTexture=function(t,e){for(var n=Het(e),i=new Float32Array(t*n*4),r=1/(t-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<t;c++){var l=Get(e,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return Vet(i,t,n)}(h_t,b.size);var T=e.getHandle("size_over_time_tex0"),E=Yv.getBindingFromHandle(T);e.bindSampler(E,this._sizeTexture.getGFXSampler()),e.bindTexture(E,this._sizeTexture.getGFXTexture());var C=e.getHandle("u_size_mode");e.setUniform(C,this._sizeTexture.height)}var w=this._particleSystem._textureAnimationModule;if(n=w&&w.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(t,e,n){for(var i=Math.max(Het(e),Het(n)),r=new Float32Array(t*i*4),o=[e,n],a=1/(t-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,f=0;f<t;f++){var p=Get(l,a*f,s);h=(u+=p)/(f+1),r[4*f+c]=h}return Vet(r,t,i)}(h_t,w.startFrame,w.frameOverTime);var A=e.getHandle("texture_animation_tex0"),P=Yv.getBindingFromHandle(A);e.bindSampler(P,this._animTexture.getGFXSampler()),e.bindTexture(P,this._animTexture.getGFXTexture());var I=e.getHandle("u_anim_info");c_t.x=this._animTexture.height,c_t.y=w.numTilesX*w.numTilesY,c_t.z=w.cycleCount,e.setUniform(I,c_t)}this._defines.USE_VK_SHADER=i.game._gfxDevice.gfxAPI===xr.VULKAN},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case Wit.StrecthedBillboard:this._vertAttrs=g_t.slice();break;case Wit.Mesh:this._vertAttrs=y_t.slice();break;default:this._vertAttrs=g_t.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!==e){var n=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==t.sharedMaterial&&null==this._defaultMat&&(x_t.parent=Gv.get("default-particle-gpu-material"),x_t.owner=t,x_t.subModelIdx=0,this._defaultMat=new Yg(x_t),x_t.parent=null,x_t.owner=null,x_t.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(s_t),t._simulationSpace===Hit.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===Wit.Billboard?this._defines.CC_RENDER_MODE=0:r===Wit.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===Wit.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===Wit.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===Wit.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=t._textureAnimationModule;o&&o.enable?(Bi.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),ki.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,ki.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},e}(Qpt);function b_t(){var t=$M.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.hasFeature(br.TEXTURE_FLOAT))||(i.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var T_t,E_t,C_t,w_t,A_t,P_t,I_t,R_t,D_t,O_t,M_t,N_t,L_t,B_t,F_t,z_t,U_t,k_t,G_t,H_t,V_t,j_t,W_t,q_t,X_t,Y_t,K_t,Q_t,Z_t,J_t,$_t,tdt,edt,ndt,idt,rdt,odt,adt,sdt,cdt,ldt,udt,hdt,fdt,pdt,_dt,ddt,mdt,vdt,gdt,ydt,xdt,Sdt,bdt,Tdt,Edt,Cdt,wdt,Adt,Pdt,Idt,Rdt,Ddt,Odt,Mdt,Ndt,Ldt,Bdt,Fdt,zdt,Udt,kdt,Gdt,Hdt,Vdt,jdt,Wdt,qdt,Xdt,Ydt,Kdt,Qdt,Zdt,Jdt,$dt,tmt,emt,nmt,imt,rmt,omt,amt,smt,cmt,lmt,umt,hmt,fmt,pmt,_mt,dmt,mmt,vmt,gmt,ymt,xmt,Smt,bmt,Tmt,Emt,Cmt,wmt,Amt,Pmt,Imt,Rmt,Dmt,Omt,Mmt,Nmt,Lmt,Bmt,Fmt,zmt,Umt,kmt,Gmt,Hmt,Vmt,jmt,Wmt,qmt,Xmt,Ymt,Kmt,Qmt,Zmt,Jmt,$mt,tvt,evt,nvt,ivt,rvt,ovt,avt,svt,cvt,lvt,uvt,hvt,fvt,pvt,_vt,dvt,mvt,vvt,gvt,yvt,xvt,Svt,bvt,Tvt,Evt,Cvt,wvt,Avt,Pvt,Ivt,Rvt,Dvt,Ovt,Mvt,Nvt,Lvt,Bvt,Fvt,zvt,Uvt,kvt,Gvt,Hvt,Vvt,jvt,Wvt,qvt,Xvt,Yvt,Kvt,Qvt,Zvt,Jvt,$vt,tgt,egt,ngt,igt,rgt,ogt,agt,sgt,cgt,lgt,ugt,hgt,fgt,pgt,_gt,dgt,mgt,vgt,ggt,ygt,xgt,Sgt,bgt,Tgt,Egt,Cgt,wgt,Agt,Pgt,Igt,Rgt,Dgt,Ogt,Mgt,Ngt,Lgt,Bgt,Fgt,zgt,Ugt,kgt,Ggt=(_pt=ol("cc.ParticleSystemRenderer"),dpt=kl(Wit),mpt=Ol(),vpt=wl(),gpt=Ol(),ypt=wl(),xpt=Ol(),Spt=wl(),bpt=kl(Wit),Tpt=kl(Att),Ept=Ol(),Cpt=wl(),wpt=kl(Og),Apt=Ol(),Ppt=wl(),Ipt=kl(Og),Rpt=Ol(),Dpt=wl(),Opt=Ol(),Mpt=wl(),Npt=kl(jit),Lpt=Ol(),Bpt=wl(),_pt((Xpt=qpt=function(){function t(){q(this,"_renderMode",Upt,this),q(this,"_velocityScale",kpt,this),q(this,"_lengthScale",Gpt,this),q(this,"_mesh",Hpt,this),q(this,"_mainTexture",Vpt,this),q(this,"_useGPU",jpt,this),q(this,"_alignSpace",Wpt,this),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&w(6033)},e.onInit=function(t){if(this.create(t),this._particleSystem.processor)w(6034);else{var e=this._useGPU&&b_t();this._particleSystem.processor=e?new S_t(this):new a_t(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)}},e._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new S_t(this):new a_t(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},L(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(b_t()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}(),qpt.AlignmentSpace=jit,X((zpt=Xpt).prototype,"renderMode",[dpt,mpt,vpt],Object.getOwnPropertyDescriptor(zpt.prototype,"renderMode"),zpt.prototype),X(zpt.prototype,"velocityScale",[gpt,ypt],Object.getOwnPropertyDescriptor(zpt.prototype,"velocityScale"),zpt.prototype),X(zpt.prototype,"lengthScale",[xpt,Spt],Object.getOwnPropertyDescriptor(zpt.prototype,"lengthScale"),zpt.prototype),Upt=X(zpt.prototype,"_renderMode",[bpt,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wit.Billboard}}),kpt=X(zpt.prototype,"_velocityScale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gpt=X(zpt.prototype,"_lengthScale",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hpt=X(zpt.prototype,"_mesh",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(zpt.prototype,"mesh",[Tpt,Ept,Cpt],Object.getOwnPropertyDescriptor(zpt.prototype,"mesh"),zpt.prototype),X(zpt.prototype,"particleMaterial",[wpt,Apt,Ppt],Object.getOwnPropertyDescriptor(zpt.prototype,"particleMaterial"),zpt.prototype),X(zpt.prototype,"trailMaterial",[Ipt,Rpt,Dpt],Object.getOwnPropertyDescriptor(zpt.prototype,"trailMaterial"),zpt.prototype),Vpt=X(zpt.prototype,"_mainTexture",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jpt=X(zpt.prototype,"_useGPU",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(zpt.prototype,"useGPU",[Opt,Mpt],Object.getOwnPropertyDescriptor(zpt.prototype,"useGPU"),zpt.prototype),X(zpt.prototype,"alignSpace",[Npt,Lpt,Bpt],Object.getOwnPropertyDescriptor(zpt.prototype,"alignSpace"),zpt.prototype),Wpt=X(zpt.prototype,"_alignSpace",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jit.View}}),Fpt=zpt))||Fpt),Hgt=Math.cos($n(100)),Vgt={position:new vi,velocity:new vi},jgt=new Ei,Wgt=new Oi,qgt=new vi,Xgt=new vi,Ygt=new di,Kgt=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new vi,lifetime:0,width:0,velocity:new vi,direction:0,color:new di})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new vi,lifetime:0,width:0,velocity:new vi,direction:0,color:new di}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)e(t,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),Qgt=(T_t=ol("cc.TrailModule"),E_t=Ol(),C_t=kl(Kit),w_t=Ol(),A_t=wl(),P_t=kl(ket),I_t=Al(),R_t=Ol(),D_t=wl(),O_t=Ol(),M_t=wl(),N_t=kl(Hit),L_t=Ol(),B_t=wl(),F_t=kl(Qit),z_t=Ol(),U_t=wl(),k_t=Ol(),G_t=wl(),H_t=kl(ket),V_t=Al(),j_t=Ol(),W_t=wl(),q_t=Ol(),X_t=wl(),Y_t=kl(Knt),K_t=Ol(),Q_t=wl(),Z_t=kl(Knt),J_t=Ol(),$_t=wl(),tdt=kl(Hit),T_t((X((ndt=function(){function t(){q(this,"_enable",idt,this),q(this,"mode",rdt,this),q(this,"lifeTime",odt,this),q(this,"_minParticleDistance",adt,this),q(this,"existWithParticles",sdt,this),q(this,"textureMode",cdt,this),q(this,"widthFromParticle",ldt,this),q(this,"widthRatio",udt,this),q(this,"colorFromParticle",hdt,this),q(this,"colorOverTrail",fdt,this),q(this,"colorOvertime",pdt,this),q(this,"_space",_dt,this),q(this,"_particleSystem",ddt,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new Io([new Ao]),this._vertAttrs=[new Ho(co.ATTR_POSITION,Tr.RGB32F),new Ho(co.ATTR_TEX_COORD,Tr.RGBA32F),new Ho(co.ATTR_TEX_COORD1,Tr.RGB32F),new Ho(co.ATTR_COLOR,Tr.RGBA8,!0)],this._vertSize=0;for(var t,e=W(this._vertAttrs);!(t=e()).done;){var n=t.value;this._vertSize+=fa[n.format].size}this._particleTrail=new Map}var e=t.prototype;return e.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,n=t.startLifetime.getMax(),i=t.rateOverTime.getMax(),r=t.duration,o=0,a=t.bursts.length;o<a;o++)e+=t.bursts[o].getMaxCount(t)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+e)),this._trailSegments=new jt((function(){return new Kgt(10)}),Math.ceil(i*r),(function(t){return t.trailElements.length=0})),this._enable&&(this.enable=this._enable)},e.onEnable=function(){this._attachToScene()},e.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},e._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},e._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},e.destroy=function(){this.destroySubMeshData(),this._trailModel&&($M.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},e.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},e.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},e.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},e.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Hit.World&&this._particleSystem._simulationSpace===Hit.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Wgt),this._particleSystem.node.getWorldRotation(jgt)):this._needTransform=!1},e.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var n=this._particleTrail.get(t);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(t,n);var i=n.getElement(n.end-1);if(this._needTransform?vi.transformMat4(qgt,t.position,Wgt):vi.copy(qgt,t.position),!(i&&(n.iterateElement(this,this._updateTrailElement,t,e),vi.squaredDistance(i.position,qgt)<this._minSquaredDistance))&&(i=n.addElement())){vi.copy(i.position,qgt),i.lifetime=0,this.widthFromParticle?i.width=t.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);vi.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);vi.subtract(qgt,s.position,a.position),vi.subtract(Xgt,i.position,a.position),vi.subtract(a.velocity,Xgt,qgt),vi.equals(vi.ZERO,a.velocity)&&vi.copy(a.velocity,qgt),vi.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(t.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},e.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},e.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=W(this._particleTrail.keys());!(t=e()).done;){var n=t.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?vi.transformMat4(Vgt.position,n.position,Wgt):vi.copy(Vgt.position,n.position);var f=this._trailModel;if(f&&f.node.invalidateChildren(eg.POSITION),1===a||2===a){var p=i.getElement(i.end-1);vi.subtract(p.velocity,Vgt.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,vi.subtract(Vgt.velocity,Vgt.position,p.position),this._checkDirectionReverse(Vgt,p)}else if(a>2){var _=i.getElement(i.end-1),d=i.getElement(i.end-2);vi.subtract(qgt,d.position,_.position),vi.subtract(Xgt,Vgt.position,_.position),vi.normalize(qgt,qgt),vi.normalize(Xgt,Xgt),vi.subtract(_.velocity,Xgt,qgt),vi.normalize(_.velocity,_.velocity),this._checkDirectionReverse(_,d),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(_,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),vi.subtract(Vgt.velocity,Vgt.position,_.position),vi.normalize(Vgt.velocity,Vgt.velocity),this._checkDirectionReverse(Vgt,_)}this.widthFromParticle?Vgt.width=n.size.x*this.widthRatio.evaluate(0,1):Vgt.width=this.widthRatio.evaluate(0,1),Vgt.color=n.color,vi.equals(Vgt.velocity,vi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Vgt,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},e.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var n=e[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=t,this._iaInfoBuffer.update(this._iaInfo)}},e.beforeRender=function(){this.updateIA(this.ibOffset)},e._createModel=function(){this._trailModel||(this._trailModel=i.director.root.createModel(rg))},e.rebuild=function(){var t=$M.root.device,e=t.createBuffer(new Co(wr.VERTEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),e.update(n);var i=t.createBuffer(new Co(wr.INDEX|wr.TRANSFER_DST,Ir.HOST|Ir.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=t.createBuffer(new Co(wr.INDIRECT,Ir.HOST|Ir.DEVICE,ma,ma)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Qw([e],this._vertAttrs,Yr.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},e._updateTrailElement=function(t,e,n,i){return e.lifetime+=i,t.colorFromParticle?(e.color.set(n.color),e.color.multiply(t.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),t.widthFromParticle?e.width=n.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},e._fillVertexBuffer=function(t,e,n,i,r,o){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,Ygt.set(t.color),Ygt.multiply(e),this._vbUint32[this.vbOffset++]=Ygt._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=Ygt._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},e._checkDirectionReverse=function(t,e){vi.dot(t.velocity,e.velocity)<Hgt?t.direction=1-e.direction:t.direction=e.direction},e.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},L(t,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}}]),t}()).prototype,"enable",[E_t],Object.getOwnPropertyDescriptor(ndt.prototype,"enable"),ndt.prototype),idt=X(ndt.prototype,"_enable",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rdt=X(ndt.prototype,"mode",[C_t,hl,w_t,A_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kit.Particles}}),odt=X(ndt.prototype,"lifeTime",[P_t,hl,I_t,R_t,D_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),adt=X(ndt.prototype,"_minParticleDistance",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),X(ndt.prototype,"minParticleDistance",[O_t,M_t],Object.getOwnPropertyDescriptor(ndt.prototype,"minParticleDistance"),ndt.prototype),X(ndt.prototype,"space",[N_t,L_t,B_t],Object.getOwnPropertyDescriptor(ndt.prototype,"space"),ndt.prototype),sdt=X(ndt.prototype,"existWithParticles",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cdt=X(ndt.prototype,"textureMode",[F_t,hl,z_t,U_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qit.Stretch}}),ldt=X(ndt.prototype,"widthFromParticle",[hl,k_t,G_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),udt=X(ndt.prototype,"widthRatio",[H_t,hl,V_t,j_t,W_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),hdt=X(ndt.prototype,"colorFromParticle",[hl,q_t,X_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fdt=X(ndt.prototype,"colorOverTrail",[Y_t,hl,K_t,Q_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Knt}}),pdt=X(ndt.prototype,"colorOvertime",[Z_t,hl,J_t,$_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Knt}}),_dt=X(ndt.prototype,"_space",[tdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hit.World}}),ddt=X(ndt.prototype,"_particleSystem",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),edt=ndt))||edt),Zgt=new Oi,Jgt=new Ei,$gt=new vi,tyt=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],eyt=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Oi,this._gravity=new ki,this.minPos=new vi,this.maxPos=new vi,this._nodePos=new vi,this._nodeSize=new vi,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,n){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;tyt.forEach((function(e){var n=t._particleSystem[e];n&&n.enable&&(n.needUpdate&&(t._updateList[n.name]=n),n.needAnimate&&(t._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var e=0,n=Uit.length;e<n;e++){var i=this._animateList[Uit[e]];i&&this._runAnimateList.push(i)}},e._emit=function(t,e,n){var i=this._particleSystem,r=this._node,o=i.time%i.duration/i.duration;r.invalidateChildren(eg.POSITION),i.simulationSpace===Hit.World&&(r.getWorldMatrix(Zgt),r.getWorldRotation(Jgt));for(var a=0;a<t;++a){var s=new tit(i);s.particleSystem=i,s.reset();var c=ri(ii(0,In));i._shapeModule&&i._shapeModule.enable?i._shapeModule.emit(s):(vi.set(s.position,0,0,0),vi.copy(s.velocity,Jit)),i._textureAnimationModule&&i._textureAnimationModule.enable&&i._textureAnimationModule.init(s);var l=i.startSpeed.evaluate(o,c);vi.multiplyScalar(s.velocity,s.velocity,l),i.simulationSpace===Hit.World&&(vi.transformMat4(s.position,s.position,Zgt),vi.transformQuat(s.velocity,s.velocity,Jgt)),vi.copy(s.ultimateVelocity,s.velocity),vi.set(s.rotation,0,0,0),i.startSize3D?vi.set(s.startSize,i.startSizeX.evaluate(o,c),i.startSizeY.evaluate(o,c),i.startSizeZ.evaluate(o,c)):(vi.set(s.startSize,i.startSizeX.evaluate(o,c),1,1),s.startSize.y=s.startSize.x),vi.copy(s.size,s.startSize),s.startLifetime=i.startLifetime.evaluate(o,c)+e,s.remainingLifetime=s.startLifetime,n.push(s)}},e._updateParticles=function(t,e){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix(Zgt),i.scaleSpace){case Hit.Local:i.node.getScale($gt);break;case Hit.World:i.node.getWorldScale($gt)}if(this._updateList.forEach((function(t){t.update(i.simulationSpace,Zgt)})),i.simulationSpace===Hit.Local){var r=i.node.getRotation();Oi.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=e[r];if(o.remainingLifetime-=t,vi.set(o.animatedVelocity,0,0,0),i.simulationSpace===Hit.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,ri(o.randomSeed))*t;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,ri(o.randomSeed))*t;vi.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(e){e.animate(o,t)})),vi.scaleAndAdd(o.position,o.position,o.ultimateVelocity,t)},a=0;a<e.length;++a)o(a)},e._calculateBounding=function(t){var e=new vi,n=new vi,i=new vi,r=new vi,o=new vi(1,1,1);if(this._processor.getInfo().renderMode===Wit.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new Bc;Bc.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];vi.multiply(e,$gt,u.size),vi.multiply(e,e,o),n.set(u.position),this._particleSystem.simulationSpace!==Hit.World&&vi.transformMat4(n,n,this._particleSystem.node._mat),t&&0===l?(vi.subtract(this.minPos,n,e),vi.add(this.maxPos,n,e)):(vi.subtract(i,n,e),vi.add(r,n,e),vi.min(this.minPos,this.minPos,i),vi.max(this.maxPos,this.maxPos,r))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=ri(ii(0,In));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),nyt=new Oi,iyt=new Ei,ryt=Object.getOwnPropertyDescriptor(TF.prototype,"sharedMaterials"),oyt=function(e){return t({ParticleSystem:e,ParticleSystemComponent:e}),e}((mdt=ol("cc.ParticleSystem"),vdt=Sl(),gdt=vl(),ydt=sl(99),xdt=Al(),Sdt=Ol(),bdt=wl(),Tdt=kl(Knt),Edt=Ol(),Cdt=wl(),wdt=kl(Hit),Adt=Ol(),Pdt=wl(),Idt=Ol(),Rdt=wl(),Ddt=fl("startSize"),Odt=Al(),Mdt=kl(ket),Ndt=Ol(),Ldt=wl(),Bdt=kl(ket),Fdt=Al(),zdt=Ol(),Udt=wl(),kdt=kl(ket),Gdt=Al(),Hdt=Ol(),Vdt=wl(),jdt=kl(ket),Wdt=Al(),qdt=Ol(),Xdt=wl(),Ydt=Ol(),Kdt=wl(),Qdt=kl(ket),Zdt=Al(),Jdt=Ol(),$dt=wl(),tmt=kl(ket),emt=Al(),nmt=Ol(),imt=wl(),rmt=kl(ket),omt=fl("startRotation"),amt=Al(),smt=Ol(),cmt=wl(),lmt=kl(ket),umt=Al(),hmt=Ol(),fmt=wl(),pmt=kl(ket),_mt=Al(),dmt=Ol(),mmt=wl(),vmt=Ol(),gmt=wl(),ymt=Ol(),xmt=wl(),Smt=Ol(),bmt=wl(),Tmt=kl(Hit),Emt=Ol(),Cmt=wl(),wmt=Ol(),Amt=wl(),Pmt=Ol(),Imt=wl(),Rmt=kl(ket),Dmt=Al(),Omt=Ol(),Mmt=wl(),Nmt=kl(ket),Lmt=Al(),Bmt=Ol(),Fmt=wl(),zmt=kl(ket),Umt=Al(),kmt=Ol(),Gmt=wl(),Hmt=kl([Kct]),Vmt=Ol(),jmt=wl(),Wmt=kl(Boolean),qmt=Ol(),Xmt=wl(),Ymt=kl(Vit),Kmt=Ol(),Qmt=wl(),Zmt=kl(Number),Jmt=Ol(),$mt=wl(),tvt=kl(Number),evt=Ol(),nvt=wl(),ivt=kl(Number),rvt=Ol(),ovt=wl(),avt=Ol(),svt=wl(),cvt=fl("enableCulling"),lvt=Tl(),uvt=kl(Og),hvt=Cl(),fvt=kl(Zit),pvt=kl(Zit),_vt=Ol(),dvt=wl(),mvt=kl($ct),vvt=kl($ct),gvt=Ol(),yvt=wl(),xvt=kl(Gct),Svt=kl(Gct),bvt=Ol(),Tvt=wl(),Evt=kl(Yct),Cvt=kl(Yct),wvt=Ol(),Avt=wl(),Pvt=kl(_ot),Ivt=kl(_ot),Rvt=Ol(),Dvt=wl(),Ovt=kl(got),Mvt=kl(got),Nvt=Ol(),Lvt=wl(),Bvt=kl(kct),Fvt=kl(kct),zvt=Ol(),Uvt=wl(),kvt=kl(Wct),Gvt=kl(Wct),Hvt=Ol(),Vvt=wl(),jvt=kl(Qgt),Wvt=kl(Qgt),qvt=Ol(),Xvt=wl(),Yvt=kl(Ggt),Kvt=Ol(),Qvt=wl(),mdt(Zvt=vdt(Zvt=gdt(Zvt=ydt(Zvt=ml((kgt=Ugt=function(t){function e(){var e;return q(e=t.call(this)||this,"startColor",$vt,V(e)),q(e,"scaleSpace",tgt,V(e)),q(e,"startSize3D",egt,V(e)),q(e,"startSizeX",ngt,V(e)),q(e,"startSizeY",igt,V(e)),q(e,"startSizeZ",rgt,V(e)),q(e,"startSpeed",ogt,V(e)),q(e,"startRotation3D",agt,V(e)),q(e,"startRotationX",sgt,V(e)),q(e,"startRotationY",cgt,V(e)),q(e,"startRotationZ",lgt,V(e)),q(e,"startDelay",ugt,V(e)),q(e,"startLifetime",hgt,V(e)),q(e,"duration",fgt,V(e)),q(e,"loop",pgt,V(e)),q(e,"simulationSpeed",_gt,V(e)),q(e,"playOnAwake",dgt,V(e)),q(e,"gravityModifier",mgt,V(e)),q(e,"rateOverTime",vgt,V(e)),q(e,"rateOverDistance",ggt,V(e)),q(e,"bursts",ygt,V(e)),q(e,"_renderCulling",xgt,V(e)),q(e,"_cullingMode",Sgt,V(e)),q(e,"_aabbHalfX",bgt,V(e)),q(e,"_aabbHalfY",Tgt,V(e)),q(e,"_aabbHalfZ",Egt,V(e)),q(e,"_dataCulling",Cgt,V(e)),q(e,"_colorOverLifetimeModule",wgt,V(e)),q(e,"_shapeModule",Agt,V(e)),q(e,"_sizeOvertimeModule",Pgt,V(e)),q(e,"_velocityOvertimeModule",Igt,V(e)),q(e,"_forceOvertimeModule",Rgt,V(e)),q(e,"_limitVelocityOvertimeModule",Dgt,V(e)),q(e,"_rotationOvertimeModule",Ogt,V(e)),q(e,"_textureAnimationModule",Mgt,V(e)),q(e,"_trailModule",Ngt,V(e)),q(e,"renderer",Lgt,V(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,q(e,"_prewarm",Bgt,V(e)),q(e,"_capacity",Fgt,V(e)),q(e,"_simulationSpace",zgt,V(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needRefresh=!0,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new vi,e._curWPos=new vi,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new Bi,e._customData2=new Bi,e._subEmitters=[],e}F(e,t);var n=e.prototype;return n.onFocusInEditor=function(){this.renderer.create(this)},n.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},n._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},n._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},n._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},n._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},n._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},n.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}},n.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},n.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var t,e=W(this.bursts);!(t=e()).done;)t.value.reset()},n.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},n.getParticleCount=function(){return this.processor.getParticleCount()},n.setCustomData1=function(t,e){Bi.set(this._customData1,t,e)},n.setCustomData2=function(t,e){Bi.set(this._customData2,t,e)},n.onDestroy=function(){i.director.off(i.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.onEnable=function(){i.director.on(i.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},n.onDisable=function(){i.director.off(i.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n._calculateBounding=function(t){this._boundingBox&&(this._culler||(this._culler=new eyt(this)),this._culler.calculatePositions(),Bc.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},n.update=function(t){var e=t*this.simulationSpeed;if(this.renderCulling){var n;if(this._boundingBox||(this._boundingBox=new Bc,this._calculateBounding(!1)),this._curPos||(this._curPos=new vi),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new vi,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var i=this._curPos.x-this._oldPos.x,r=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,a=this._boundingBox.center;a.x+=i,a.y+=r,a.z+=o,this._culler.setBoundingBoxCenter(a.x,a.y,a.z),this._oldPos.set(this._curPos)}var s=null===(n=this.node.scene.renderScene)||void 0===n?void 0:n.cameras,c=!0;if(void 0!==s&&this._boundingBox)for(var l=0;l<s.length;++l){var u=s[l];if((u.visibility&this.node.layer)===this.node.layer&&nc.aabbFrustum(this._boundingBox,u.frustum)){c=!1;break}}if(c){if(this._cullingMode!==Vit.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===Vit.PauseAndCatchup&&(this._time+=e),this._cullingMode!==Vit.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop();else{var h=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(h),this.processor.updateScale(h)}this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},n.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},n._onVisibilityChange=function(t){this.processor._model&&(this.processor._model.visFlags=t)},n.emit=function(t,e){var n=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(eg.POSITION),this._needRefresh=!1),this._simulationSpace===Hit.World&&(this.node.getWorldMatrix(nyt),this.node.getWorldRotation(iyt));for(var i=0;i<t;++i){var r=this.processor.getFreeParticle();if(null===r)return;r.particleSystem=this,r.reset();var o=ri(ii(0,In));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(vi.set(r.position,0,0,0),vi.copy(r.velocity,Jit)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r);var a=this.startSpeed.evaluate(n,o);vi.multiplyScalar(r.velocity,r.velocity,a),this._simulationSpace===Hit.World&&(vi.transformMat4(r.position,r.position,nyt),vi.transformQuat(r.velocity,r.velocity,iyt)),vi.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?r.startEuler.set(this.startRotationX.evaluate(n,o),this.startRotationY.evaluate(n,o),this.startRotationZ.evaluate(n,o)):r.startEuler.set(0,0,this.startRotationZ.evaluate(n,o)),r.rotation.set(r.startEuler),this.startSize3D?vi.set(r.startSize,this.startSizeX.evaluate(n,o),this.startSizeY.evaluate(n,o),this.startSizeZ.evaluate(n,o)):(vi.set(r.startSize,this.startSizeX.evaluate(n,o),1,1),r.startSize.y=r.startSize.x),vi.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(n,o)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(n,o)+e,r.remainingLifetime=r.startLifetime,r.randomSeed=ii(0,233280),r.loopCount++,this.processor.setNewParticle(r)}},n._prewarmSystem=function(){this.startDelay.mode=Uet.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},n._emit=function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,t)}this.node.getWorldPosition(this._curWPos);var i=vi.distance(this._curWPos,this._oldWPos);if(vi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,t)}for(var o,a=W(this.bursts);!(o=a()).done;)o.value.update(this,t)}},n._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),vi.copy(this._curWPos,this._oldWPos)},n.addSubEmitter=function(t){this._subEmitters.push(t)},n.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},n.addBurst=function(t){this.bursts.push(t)},n.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},n.getBoundingX=function(){return this._aabbHalfX},n.getBoundingY=function(){return this._aabbHalfY},n.getBoundingZ=function(){return this._aabbHalfZ},n.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},n.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},n.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},n._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!kit.includes(t)||e[t]&&e[t].enable})):t},L(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new Bc,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return ryt.get.call(this)},set:function(t){ryt.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(TF),Ugt.CullingMode=Vit,X((Jvt=kgt).prototype,"capacity",[xdt,Sdt,bdt],Object.getOwnPropertyDescriptor(Jvt.prototype,"capacity"),Jvt.prototype),$vt=X(Jvt.prototype,"startColor",[Tdt,hl,Edt,Cdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Knt}}),tgt=X(Jvt.prototype,"scaleSpace",[wdt,hl,Adt,Pdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hit.Local}}),egt=X(Jvt.prototype,"startSize3D",[hl,Idt,Rdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ngt=X(Jvt.prototype,"startSizeX",[Ddt,Odt,Mdt,Ndt,Ldt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),igt=X(Jvt.prototype,"startSizeY",[Bdt,hl,Fdt,zdt,Udt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),rgt=X(Jvt.prototype,"startSizeZ",[kdt,hl,Gdt,Hdt,Vdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),ogt=X(Jvt.prototype,"startSpeed",[jdt,hl,Wdt,qdt,Xdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),agt=X(Jvt.prototype,"startRotation3D",[hl,Ydt,Kdt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sgt=X(Jvt.prototype,"startRotationX",[Qdt,hl,Zdt,Ml,Jdt,$dt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),cgt=X(Jvt.prototype,"startRotationY",[tmt,hl,emt,Ml,nmt,imt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),lgt=X(Jvt.prototype,"startRotationZ",[rmt,omt,amt,Ml,smt,cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),ugt=X(Jvt.prototype,"startDelay",[lmt,hl,umt,hmt,fmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),hgt=X(Jvt.prototype,"startLifetime",[pmt,hl,_mt,dmt,mmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),fgt=X(Jvt.prototype,"duration",[hl,vmt,gmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),pgt=X(Jvt.prototype,"loop",[hl,ymt,xmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(Jvt.prototype,"prewarm",[Smt,bmt],Object.getOwnPropertyDescriptor(Jvt.prototype,"prewarm"),Jvt.prototype),X(Jvt.prototype,"simulationSpace",[Tmt,hl,Emt,Cmt],Object.getOwnPropertyDescriptor(Jvt.prototype,"simulationSpace"),Jvt.prototype),_gt=X(Jvt.prototype,"simulationSpeed",[hl,wmt,Amt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dgt=X(Jvt.prototype,"playOnAwake",[hl,Pmt,Imt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mgt=X(Jvt.prototype,"gravityModifier",[Rmt,hl,Dmt,Omt,Mmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),vgt=X(Jvt.prototype,"rateOverTime",[Nmt,hl,Lmt,Bmt,Fmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),ggt=X(Jvt.prototype,"rateOverDistance",[zmt,hl,Umt,kmt,Gmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ket}}),ygt=X(Jvt.prototype,"bursts",[Hmt,hl,Vmt,jmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(Jvt.prototype,"renderCulling",[Wmt,qmt,Xmt],Object.getOwnPropertyDescriptor(Jvt.prototype,"renderCulling"),Jvt.prototype),xgt=X(Jvt.prototype,"_renderCulling",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Jvt.prototype,"cullingMode",[Ymt,Kmt,Qmt],Object.getOwnPropertyDescriptor(Jvt.prototype,"cullingMode"),Jvt.prototype),Sgt=X(Jvt.prototype,"_cullingMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vit.Pause}}),X(Jvt.prototype,"aabbHalfX",[Zmt,Jmt,$mt],Object.getOwnPropertyDescriptor(Jvt.prototype,"aabbHalfX"),Jvt.prototype),bgt=X(Jvt.prototype,"_aabbHalfX",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Jvt.prototype,"aabbHalfY",[tvt,evt,nvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"aabbHalfY"),Jvt.prototype),Tgt=X(Jvt.prototype,"_aabbHalfY",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Jvt.prototype,"aabbHalfZ",[ivt,rvt,ovt],Object.getOwnPropertyDescriptor(Jvt.prototype,"aabbHalfZ"),Jvt.prototype),Egt=X(Jvt.prototype,"_aabbHalfZ",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Jvt.prototype,"dataCulling",[avt,svt],Object.getOwnPropertyDescriptor(Jvt.prototype,"dataCulling"),Jvt.prototype),Cgt=X(Jvt.prototype,"_dataCulling",[hl,cvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Jvt.prototype,"sharedMaterials",[Ql,lvt,uvt,hl,hvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"sharedMaterials"),Jvt.prototype),wgt=X(Jvt.prototype,"_colorOverLifetimeModule",[fvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"colorOverLifetimeModule",[pvt,_vt,dvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"colorOverLifetimeModule"),Jvt.prototype),Agt=X(Jvt.prototype,"_shapeModule",[mvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"shapeModule",[vvt,gvt,yvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"shapeModule"),Jvt.prototype),Pgt=X(Jvt.prototype,"_sizeOvertimeModule",[xvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"sizeOvertimeModule",[Svt,bvt,Tvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"sizeOvertimeModule"),Jvt.prototype),Igt=X(Jvt.prototype,"_velocityOvertimeModule",[Evt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"velocityOvertimeModule",[Cvt,wvt,Avt],Object.getOwnPropertyDescriptor(Jvt.prototype,"velocityOvertimeModule"),Jvt.prototype),Rgt=X(Jvt.prototype,"_forceOvertimeModule",[Pvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"forceOvertimeModule",[Ivt,Rvt,Dvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"forceOvertimeModule"),Jvt.prototype),Dgt=X(Jvt.prototype,"_limitVelocityOvertimeModule",[Ovt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"limitVelocityOvertimeModule",[Mvt,Nvt,Lvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"limitVelocityOvertimeModule"),Jvt.prototype),Ogt=X(Jvt.prototype,"_rotationOvertimeModule",[Bvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"rotationOvertimeModule",[Fvt,zvt,Uvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"rotationOvertimeModule"),Jvt.prototype),Mgt=X(Jvt.prototype,"_textureAnimationModule",[kvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"textureAnimationModule",[Gvt,Hvt,Vvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"textureAnimationModule"),Jvt.prototype),Ngt=X(Jvt.prototype,"_trailModule",[jvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Jvt.prototype,"trailModule",[Wvt,qvt,Xvt],Object.getOwnPropertyDescriptor(Jvt.prototype,"trailModule"),Jvt.prototype),Lgt=X(Jvt.prototype,"renderer",[Yvt,hl,Kvt,Qvt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ggt}}),Bgt=X(Jvt.prototype,"_prewarm",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fgt=X(Jvt.prototype,"_capacity",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),zgt=X(Jvt.prototype,"_simulationSpace",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hit.Local}}),Zvt=Jvt))||Zvt)||Zvt)||Zvt)||Zvt)||Zvt)),ayt=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||($M.on(JM.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new jt((function(){return rf(t)||new $C}),1,(function(t){return t.destroy()}))),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,n=W(t.getComponentsInChildren(oyt));!(e=n()).done;)e.value.play()},t.stop=function(t){for(var e,n=W(t.getComponentsInChildren(oyt));!(e=n()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());function syt(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}ayt.particleSystemPool=new Map,ayt.registeredSceneEvent=!1,Fn(Kct.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),Bn(oyt.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),i.ParticleSystemComponent=oyt,Gt.setClassAlias(oyt,"cc.ParticleSystemComponent"),i.BillboardComponent=Met,Gt.setClassAlias(Met,"cc.BillboardComponent"),i.LineComponent=$nt,Gt.setClassAlias($nt,"cc.LineComponent"),i.ParticleUtils=ayt;var cyt,lyt,uyt,hyt,fyt,pyt,_yt,dyt=function(t,e){return function(t){t.exports=function t(e,n,i){function r(a,s){if(!n[a]){if(!e[a]){if(!s&&syt)return syt();if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=n[a]={exports:{}};e[a][0].call(c.exports,(function(t){return r(e[a][1][t]||t)}),c,c.exports,t,e,n,i)}return n[a].exports}for(var o=syt,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(t,e){e.exports={name:"@cocos/cannon",version:"1.2.8",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m",postpublish:"cnpm sync @cocos/cannon"},main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Transform:t("./math/Transform"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World"),Octree:t("./utils/Octree")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Octree":51,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(t,e){var n=t("../math/Vec3");function i(t){t=t||{},this.lowerBound=new n,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new n,t.upperBound&&this.upperBound.copy(t.upperBound)}t("../utils/Utils"),e.exports=i;var r=new n;i.prototype.setFromPoints=function(t,e,n,i){var o=this.lowerBound,a=this.upperBound,s=n;o.copy(t[0]),s&&s.vmult(o,o),a.copy(o);for(var c=1;c<t.length;c++){var l=t[c];s&&(s.vmult(l,r),l=r),l.x>a.x&&(a.x=l.x),l.x<o.x&&(o.x=l.x),l.y>a.y&&(a.y=l.y),l.y<o.y&&(o.y=l.y),l.z>a.z&&(a.z=l.z),l.z<o.z&&(o.z=l.z)}return e&&(e.vadd(o,o),e.vadd(a,a)),i&&(o.x-=i,o.y-=i,o.z-=i,a.x+=i,a.y+=i,a.z+=i),this},i.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(t){this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,t.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,t.upperBound.z)},i.prototype.overlaps=function(t){var e=this.lowerBound,n=this.upperBound,i=t.lowerBound,r=t.upperBound,o=i.x<=n.x&&n.x<=r.x||e.x<=r.x&&r.x<=n.x,a=i.y<=n.y&&n.y<=r.y||e.y<=r.y&&r.y<=n.y,s=i.z<=n.z&&n.z<=r.z||e.z<=r.z&&r.z<=n.z;return o&&a&&s},i.prototype.volume=function(){var t=this.lowerBound,e=this.upperBound;return(e.x-t.x)*(e.y-t.y)*(e.z-t.z)},i.prototype.contains=function(t){var e=this.lowerBound,n=this.upperBound,i=t.lowerBound,r=t.upperBound;return e.x<=i.x&&n.x>=r.x&&e.y<=i.y&&n.y>=r.y&&e.z<=i.z&&n.z>=r.z},i.prototype.getCorners=function(t,e,n,i,r,o,a,s){var c=this.lowerBound,l=this.upperBound;t.copy(c),e.set(l.x,c.y,c.z),n.set(l.x,l.y,c.z),i.set(c.x,l.y,l.z),r.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),a.set(c.x,c.y,l.z),s.copy(l)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];i.prototype.toLocalFrame=function(t,e){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var p=n[f];t.pointToLocal(p,p)}return e.setFromPoints(n)},i.prototype.toWorldFrame=function(t,e){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var p=n[f];t.pointToWorld(p,p)}return e.setFromPoints(n)},i.prototype.overlapsRay=function(t){var e=1/t._direction.x,n=1/t._direction.y,i=1/t._direction.z,r=(this.lowerBound.x-t.from.x)*e,o=(this.upperBound.x-t.from.x)*e,a=(this.lowerBound.y-t.from.y)*n,s=(this.upperBound.y-t.from.y)*n,c=(this.lowerBound.z-t.from.z)*i,l=(this.upperBound.z-t.from.z)*i,u=Math.max(Math.max(Math.min(r,o),Math.min(a,s)),Math.min(c,l)),h=Math.min(Math.min(Math.max(r,o),Math.max(a,s)),Math.max(c,l));return!(h<0||u>h)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(t,e){function n(){this.matrix=[]}e.exports=n,n.prototype.get=function(t,e){if(t=t.index,(e=e.index)>t){var n=e;e=t,t=n}return this.matrix[(t*(t+1)>>1)+e-1]},n.prototype.set=function(t,e,n){if(t=t.index,(e=e.index)>t){var i=e;e=t,t=i}this.matrix[(t*(t+1)>>1)+e-1]=n?1:0},n.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},n.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e){var n=t("../objects/Body"),i=t("../math/Vec3"),r=t("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}t("../shapes/Shape"),t("../shapes/Plane"),e.exports=o,o.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(t,e){if(0==(t.collisionFilterGroup&e.collisionFilterMask)||0==(e.collisionFilterGroup&t.collisionFilterMask))return!1;var i=0!=(t.type&n.STATIC),r=0!=(e.type&n.STATIC);return!(i&&r||!t.hasTrigger&&!e.hasTrigger&&t.sleepState===n.SLEEPING&&e.sleepState===n.SLEEPING)},o.prototype.intersectionTest=function(t,e,n,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,n,i):this.doBoundingSphereBroadphase(t,e,n,i)};var a=new i;new i,new r,new i,o.prototype.doBoundingSphereBroadphase=function(t,e,n,i){var r=a;e.position.vsub(t.position,r);var o=Math.pow(t.boundingRadius+e.boundingRadius,2);r.norm2()<o&&(n.push(t),i.push(e))},o.prototype.doBoundingBoxBroadphase=function(t,e,n,i){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(n.push(t),i.push(e))};var s={keys:[]},c=[],l=[];o.prototype.makePairsUnique=function(t,e){for(var n=s,i=c,r=l,o=t.length,a=0;a!==o;a++)i[a]=t[a],r[a]=e[a];for(t.length=0,e.length=0,a=0;a!==o;a++){var u=i[a].id,h=r[a].id;n[f=u<h?u+","+h:h+","+u]=a,n.keys.push(f)}for(a=0;a!==n.keys.length;a++){var f=n.keys.pop(),p=n[f];t.push(i[p]),e.push(r[p]),delete n[f]}},o.prototype.setWorld=function(){};var u=new i;o.boundingSphereCheck=function(t,e){var n=u;return t.position.vsub(e.position,n),Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>n.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(t,e){e.exports=o;var n=t("./Broadphase"),i=t("../math/Vec3"),r=t("../shapes/Shape");function o(t,e,r,o,a){n.apply(this),this.nx=r||10,this.ny=o||10,this.nz=a||10,this.aabbMin=t||new i(100,100,100),this.aabbMax=e||new i(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var c=0;c<s;c++)this.bins[c]=[],this.binLengths[c]=0}o.prototype=new n,o.prototype.constructor=o;var a=new i;new i,o.prototype.collisionPairs=function(t,e,n){for(var i=t.numObjects(),o=t.bodies,s=this.aabbMax,c=this.aabbMin,l=this.nx,u=this.ny,h=this.nz,f=u*h,p=h,_=1,d=s.x,m=s.y,v=s.z,g=c.x,y=c.y,x=c.z,S=l/(d-g),b=u/(m-y),T=h/(v-x),E=(d-g)/l,C=(m-y)/u,w=(v-x)/h,A=.5*Math.sqrt(E*E+C*C+w*w),P=r.types,I=P.SPHERE,R=P.PLANE,D=(P.BOX,P.COMPOUND,P.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,M=this.bins.length,N=0;N!==M;N++)O[N]=0;var L=Math.ceil;function B(t,e,n,i,r,o,a){var s=(t-g)*S|0,c=(e-y)*b|0,d=(n-x)*T|0,m=L((i-g)*S),v=L((r-y)*b),E=L((o-x)*T);s<0?s=0:s>=l&&(s=l-1),c<0?c=0:c>=u&&(c=u-1),d<0?d=0:d>=h&&(d=h-1),m<0?m=0:m>=l&&(m=l-1),v<0?v=0:v>=u&&(v=u-1),E<0?E=0:E>=h&&(E=h-1),c*=p,d*=_,m*=f,v*=p,E*=_;for(var C=s*=f;C<=m;C+=f)for(var w=c;w<=v;w+=p)for(var A=d;A<=E;A+=_){var P=C+w+A;D[P][O[P]++]=a}}for(c=Math.min,s=Math.max,N=0;N!==i;N++){var F=(nt=o[N]).shape;switch(F.type){case I:var z=nt.position.x,U=nt.position.y,k=nt.position.z,G=F.radius;B(z-G,U-G,k-G,z+G,U+G,k+G,nt);break;case R:F.worldNormalNeedsUpdate&&F.computeWorldNormal(nt.quaternion);var H=F.worldNormal,V=g+.5*E-nt.position.x,j=y+.5*C-nt.position.y,W=x+.5*w-nt.position.z,q=a;q.set(V,j,W);for(var X=0,Y=0;X!==l;X++,Y+=f,q.y=j,q.x+=E)for(var K=0,Q=0;K!==u;K++,Q+=p,q.z=W,q.y+=C)for(var Z=0,J=0;Z!==h;Z++,J+=_,q.z+=w)if(q.dot(H)<A){var $=Y+Q+J;D[$][O[$]++]=nt}break;default:nt.aabbNeedsUpdate&&nt.computeAABB(),B(nt.aabb.lowerBound.x,nt.aabb.lowerBound.y,nt.aabb.lowerBound.z,nt.aabb.upperBound.x,nt.aabb.upperBound.y,nt.aabb.upperBound.z,nt)}}for(N=0;N!==M;N++){var tt=O[N];if(tt>1){var et=D[N];for(X=0;X!==tt;X++){var nt=et[X];for(K=0;K!==X;K++){var it=et[K];this.needBroadphaseCollision(nt,it)&&this.intersectionTest(nt,it,e,n)}}}}this.makePairsUnique(e,n)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(t,e){e.exports=r;var n=t("./Broadphase"),i=t("./AABB");function r(){n.apply(this)}r.prototype=new n,r.prototype.constructor=r,r.prototype.collisionPairs=function(t,e,n){var i,r,o,a,s=t.bodies,c=s.length;for(i=0;i!==c;i++)for(r=0;r!==i;r++)o=s[i],a=s[r],this.needBroadphaseCollision(o,a)&&this.intersectionTest(o,a,e,n)},new i,r.prototype.aabbQuery=function(t,e,n){n=n||[];for(var i=0;i<t.bodies.length;i++){var r=t.bodies[i];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(e)&&n.push(r)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e){function n(){this.matrix={}}e.exports=n,n.prototype.get=function(t,e){if(t=t.id,(e=e.id)>t){var n=e;e=t,t=n}return t+"-"+e in this.matrix},n.prototype.set=function(t,e,n){if(t=t.id,(e=e.id)>t){var i=e;e=t,t=i}n?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(){}},{}],9:[function(t,e){function n(){this.current=[],this.previous=[]}function i(t,e){t.push((4294901760&e)>>16,65535&e)}e.exports=n,n.prototype.getKey=function(t,e){if(e<t){var n=e;e=t,t=n}return t<<16|e},n.prototype.set=function(t,e){for(var n=this.getKey(t,e),i=this.current,r=0;n>i[r];)r++;if(n!==i[r]){for(e=i.length-1;e>=r;e--)i[e+1]=i[e];i[r]=n}},n.prototype.tick=function(){var t=this.current;this.current=this.previous,this.previous=t,this.current.length=0},n.prototype.getDiff=function(t,e){for(var n=this.current,r=this.previous,o=n.length,a=r.length,s=0,c=0;c<o;c++){for(var l=n[c];l>r[s];)s++;l===r[s]||i(t,l)}for(s=0,c=0;c<a;c++){for(var u=r[c];u>n[s];)s++;n[s]===u||i(e,u)}}},{}],10:[function(t,e){e.exports=c;var n=t("../math/Vec3"),i=t("../math/Quaternion"),r=t("../math/Transform"),o=(t("../shapes/ConvexPolyhedron"),t("../shapes/Box"),t("../collision/RaycastResult")),a=t("../shapes/Shape"),s=t("../collision/AABB");function c(t,e){this.from=t?t.clone():new n,this.to=e?e.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new o,this.hasHit=!1,this.callback=function(){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var l=new s,u=[];c.prototype.intersectWorld=function(t,e){return this.mode=e.mode||c.ANY,this.result=e.result||new o,this.skipBackfaces=!!e.skipBackfaces,this.checkCollisionResponse=!!e.checkCollisionResponse,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(l),u.length=0,t.broadphase.aabbQuery(t,l,u),this.intersectBodies(u),this.hasHit};var h=new n,f=new n;function p(t,e,n,i){i.vsub(e,B),n.vsub(e,h),t.vsub(e,f);var r,o,a=B.dot(B),s=B.dot(h),c=B.dot(f),l=h.dot(h),u=h.dot(f);return(r=l*c-s*u)>=0&&(o=a*u-s*c)>=0&&r+o<a*l-s*s}c.pointInTriangle=p;var _=new n,d=new i;c.prototype.intersectBody=function(t,e){if(e&&(this.result=e,this._updateDirection()),(!this.checkCollisionResponse||t.collisionResponse)&&c.perBodyFilter(this,t))for(var n=_,i=d,r=0,o=t.shapes.length;r<o;r++){var a=t.shapes[r];if(c.perShapeFilter(this,a)&&(t.quaternion.mult(t.shapeOrientations[r],i),t.quaternion.vmult(t.shapeOffsets[r],n),n.vadd(t.position,n),this.intersectShape(a,i,n,t),this.result._shouldStop))break}},c.prototype.intersectBodies=function(t,e){e&&(this.result=e,this._updateDirection());for(var n=0,i=t.length;!this.result._shouldStop&&n<i;n++)this.intersectBody(t[n])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(t,e,n,i){if(!(z(this.from,this._direction,n)>t.boundingSphereRadius)){var r=this[t.type];r&&r.call(this,t,e,n,i,t)}},new n,new n;var m=new n,v=new n,g=new n,y=new n;new n,new o,c.prototype.intersectBox=function(t,e,n,i,r){return this.intersectConvex(t.convexPolyhedronRepresentation,e,n,i,r)},c.prototype[a.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(t,e,i,r,o){var a=this.from,s=this.to,c=this._direction,l=new n(0,0,1);e.vmult(l,l);var u=new n;a.vsub(i,u);var h=u.dot(l);if(s.vsub(i,u),!(h*u.dot(l)>0||a.distanceTo(s)<h)){var f=l.dot(c);if(!(Math.abs(f)<this.precision)){var p=new n,_=new n,d=new n;a.vsub(i,p);var m=-l.dot(p)/f;c.scale(m,_),a.vadd(_,d),this.reportIntersection(l,d,o,r,-1)}}},c.prototype[a.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(t){var e=this.to,n=this.from;t.lowerBound.x=Math.min(e.x,n.x),t.lowerBound.y=Math.min(e.y,n.y),t.lowerBound.z=Math.min(e.z,n.z),t.upperBound.x=Math.max(e.x,n.x),t.upperBound.y=Math.max(e.y,n.y),t.upperBound.z=Math.max(e.z,n.z)};var x={faceList:[0]},S=new n,b=new c,T=[];c.prototype.intersectHeightfield=function(t,e,n,i,o){t.data,t.elementSize;var a=b;a.from.copy(this.from),a.to.copy(this.to),r.pointToLocalFrame(n,e,a.from,a.from),r.pointToLocalFrame(n,e,a.to,a.to),a._updateDirection();var c,l,u,h,f=T;c=l=0,u=h=t.data.length-1;var p=new s;a.getAABB(p),t.getIndexOfPosition(p.lowerBound.x,p.lowerBound.y,f,!0),c=Math.max(c,f[0]),l=Math.max(l,f[1]),t.getIndexOfPosition(p.upperBound.x,p.upperBound.y,f,!0),u=Math.min(u,f[0]+1),h=Math.min(h,f[1]+1);for(var _=c;_<u;_++)for(var d=l;d<h;d++){if(this.result._shouldStop)return;if(t.getAabbAtIndex(_,d,p),p.overlapsRay(a)){if(t.getConvexTrianglePillar(_,d,!1),r.pointToWorldFrame(n,e,t.pillarOffset,S),this.intersectConvex(t.pillarConvex,e,S,i,o,x),this.result._shouldStop)return;t.getConvexTrianglePillar(_,d,!0),r.pointToWorldFrame(n,e,t.pillarOffset,S),this.intersectConvex(t.pillarConvex,e,S,i,o,x)}}},c.prototype[a.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var E=new n,C=new n;c.prototype.intersectSphere=function(t,e,n,i,r){var o=this.from,a=this.to,s=t.radius,c=Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2)+Math.pow(a.z-o.z,2),l=2*((a.x-o.x)*(o.x-n.x)+(a.y-o.y)*(o.y-n.y)+(a.z-o.z)*(o.z-n.z)),u=Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2)+Math.pow(o.z-n.z,2)-Math.pow(s,2),h=Math.pow(l,2)-4*c*u,f=E,p=C;if(!(h<0))if(0===h)o.lerp(a,h,f),f.vsub(n,p),p.normalize(),this.reportIntersection(p,f,r,i,-1);else{var _=(-l-Math.sqrt(h))/(2*c),d=(-l+Math.sqrt(h))/(2*c);if(_>=0&&_<=1&&(o.lerp(a,_,f),f.vsub(n,p),p.normalize(),this.reportIntersection(p,f,r,i,-1)),this.result._shouldStop)return;d>=0&&d<=1&&(o.lerp(a,d,f),f.vsub(n,p),p.normalize(),this.reportIntersection(p,f,r,i,-1))}},c.prototype[a.types.SPHERE]=c.prototype.intersectSphere;var w=new n,A=(new n,new n,new n);c.prototype.intersectConvex=function(t,e,n,i,r,o){for(var a=w,s=A,c=o&&o.faceList||null,l=t.faces,u=t.vertices,h=t.faceNormals,f=this._direction,_=this.from,d=this.to,x=_.distanceTo(d),S=c?c.length:l.length,b=this.result,T=0;!b._shouldStop&&T<S;T++){var E=c?c[T]:T,C=l[E],P=h[E],I=e,R=n;s.copy(u[C[0]]),I.vmult(s,s),s.vadd(R,s),s.vsub(_,s),I.vmult(P,a);var D=f.dot(a);if(!(Math.abs(D)<this.precision)){var O=a.dot(s)/D;if(!(O<0)){f.mult(O,m),m.vadd(_,m),v.copy(u[C[0]]),I.vmult(v,v),R.vadd(v,v);for(var M=1;!b._shouldStop&&M<C.length-1;M++){g.copy(u[C[M]]),y.copy(u[C[M+1]]),I.vmult(g,g),I.vmult(y,y),R.vadd(g,g),R.vadd(y,y);var N=m.distanceTo(_);!p(m,v,g,y)&&!p(m,g,v,y)||N>x||this.reportIntersection(a,m,r,i,E)}}}}},c.prototype[a.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var P=new n,I=new n,R=new n,D=new n,O=new n,M=new n,N=(new s,[]),L=new r;c.prototype.intersectTrimesh=function(t,e,n,i,o,a){var s=P,c=N,l=L,u=A,h=I,f=R,_=D,d=M,x=O,S=(a&&a.faceList,t.indices),b=(t.vertices,t.faceNormals,this.from),T=this.to,E=this._direction;l.position.copy(n),l.quaternion.copy(e),r.vectorToLocalFrame(n,e,E,h),r.pointToLocalFrame(n,e,b,f),r.pointToLocalFrame(n,e,T,_),_.x*=t.scale.x,_.y*=t.scale.y,_.z*=t.scale.z,f.x*=t.scale.x,f.y*=t.scale.y,f.z*=t.scale.z,_.vsub(f,h),h.normalize();var C=f.distanceSquared(_);t.tree.rayQuery(this,l,c);for(var w=0,B=c.length;!this.result._shouldStop&&w!==B;w++){var F=c[w];t.getNormal(F,s),t.getVertex(S[3*F],v),v.vsub(f,u);var z=h.dot(s),U=s.dot(u)/z;if(!(U<0)){h.scale(U,m),m.vadd(f,m),t.getVertex(S[3*F+1],g),t.getVertex(S[3*F+2],y);var k=m.distanceSquared(f);!p(m,g,v,y)&&!p(m,v,g,y)||k>C||(r.vectorToWorldFrame(e,s,x),r.pointToWorldFrame(n,e,m,d),this.reportIntersection(x,d,o,i,F))}}c.length=0},c.prototype[a.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(t,e,n,i,r){var o=this.from,a=this.to,s=o.distanceTo(e),l=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(o,a,t,e,n,i,s),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(o,a,t,e,n,i,s));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(o,a,t,e,n,i,s),l._shouldStop=!0}};var B=new n,F=new n;function z(t,e,n){n.vsub(t,B);var i=B.dot(e);return e.mult(i,F),F.vadd(t,F),n.distanceTo(F)}c.perBodyFilter=function(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)},c.perShapeFilter=function(t,e){return!(t.checkCollisionResponse&&!e.collisionResponse)}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(t,e){var n=t("../math/Vec3");function i(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.exports=i,i.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(t,e,n,i,r,o,a){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(i),this.shape=r,this.body=o,this.distance=a}},{"../math/Vec3":31}],12:[function(t,e){t("../shapes/Shape");var n=t("../collision/Broadphase");function i(t){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var n=e.indexOf(t.body);-1!==n&&e.splice(n,1)},t&&this.setWorld(t)}e.exports=i,i.prototype=new n,i.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},i.insertionSortX=function(t){for(var e=1,n=t.length;e<n;e++){for(var i=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.x<=i.aabb.lowerBound.x);r--)t[r+1]=t[r];t[r+1]=i}return t},i.insertionSortY=function(t){for(var e=1,n=t.length;e<n;e++){for(var i=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.y<=i.aabb.lowerBound.y);r--)t[r+1]=t[r];t[r+1]=i}return t},i.insertionSortZ=function(t){for(var e=1,n=t.length;e<n;e++){for(var i=t[e],r=e-1;r>=0&&!(t[r].aabb.lowerBound.z<=i.aabb.lowerBound.z);r--)t[r+1]=t[r];t[r+1]=i}return t},i.prototype.collisionPairs=function(t,e,n){var r,o,a=this.axisList,s=a.length,c=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==s;r++){var l=a[r];for(o=r+1;o<s;o++){var u=a[o];if(this.needBroadphaseCollision(l,u)){if(!i.checkBounds(l,u,c))break;this.intersectionTest(l,u,e,n)}}}},i.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,n=t.length,r=0;r!==n;r++){var o=t[r];o.aabbNeedsUpdate&&o.computeAABB()}0===e?i.insertionSortX(t):1===e?i.insertionSortY(t):2===e&&i.insertionSortZ(t)},i.checkBounds=function(t,e,n){var i,r;0===n?(i=t.position.x,r=e.position.x):1===n?(i=t.position.y,r=e.position.y):2===n&&(i=t.position.z,r=e.position.z);var o=t.boundingRadius;return r-e.boundingRadius<i+o},i.prototype.autoDetectAxis=function(){for(var t=0,e=0,n=0,i=0,r=0,o=0,a=this.axisList,s=a.length,c=1/s,l=0;l!==s;l++){var u=a[l],h=u.position.x;t+=h,e+=h*h;var f=u.position.y;n+=f,i+=f*f;var p=u.position.z;r+=p,o+=p*p}var _=e-t*t*c,d=i-n*n*c,m=o-r*r*c;this.axisIndex=_>d?_>m?0:2:d>m?1:2},i.prototype.aabbQuery=function(t,e,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,r="x";1===i&&(r="y"),2===i&&(r="z");for(var o=this.axisList,a=(e.lowerBound[r],e.upperBound[r],0);a<o.length;a++){var s=o[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(e)&&n.push(s)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(t,e){e.exports=a,t("./Constraint");var n=t("./PointToPointConstraint"),i=t("../equations/ConeEquation"),r=t("../equations/RotationalEquation"),o=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,e,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;this.axisA=a.axisA?a.axisA.clone():new o,this.axisB=a.axisB?a.axisB.clone():new o,n.call(this,t,c,e,l,s),this.collideConnected=!!a.collideConnected,this.angle=void 0!==a.angle?a.angle:0;var u=this.coneEquation=new i(t,e,a),h=this.twistEquation=new r(t,e,a);this.twistAngle=void 0!==a.twistAngle?a.twistAngle:0,u.maxForce=0,u.minForce=-s,h.maxForce=0,h.minForce=-s,this.equations.push(u,h)}a.prototype=new n,a.constructor=a,new o,new o,a.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),t.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),e.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(t,e){e.exports=i;var n=t("../utils/Utils");function i(t,e,r){r=n.defaults(r,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=i.idCounter++,this.collideConnected=r.collideConnected,r.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},i.prototype.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},i.prototype.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1},i.idCounter=0},{"../utils/Utils":54}],15:[function(t,e){e.exports=r;var n=t("./Constraint"),i=t("../equations/ContactEquation");function r(t,e,r,o){n.call(this,t,e),void 0===r&&(r=t.position.distanceTo(e.position)),void 0===o&&(o=1e6),this.distance=r;var a=this.distanceEquation=new i(t,e);this.equations.push(a),a.minForce=-o,a.maxForce=o}r.prototype=new n,r.prototype.update=function(){var t=this.bodyA,e=this.bodyB,n=this.distanceEquation,i=.5*this.distance,r=n.ni;e.position.vsub(t.position,r),r.normalize(),r.mult(i,n.ri),r.mult(-i,n.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(t,e){e.exports=a,t("./Constraint");var n=t("./PointToPointConstraint"),i=t("../equations/RotationalEquation"),r=t("../equations/RotationalMotorEquation"),o=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,e,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;n.call(this,t,c,e,l,s),(this.axisA=a.axisA?a.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=a.axisB?a.axisB.clone():new o(1,0,0)).normalize();var u=this.rotationalEquation1=new i(t,e,a),h=this.rotationalEquation2=new i(t,e,a),f=this.motorEquation=new r(t,e,s);f.enabled=!1,this.equations.push(u,h,f)}a.prototype=new n,a.constructor=a,a.prototype.enableMotor=function(){this.motorEquation.enabled=!0},a.prototype.disableMotor=function(){this.motorEquation.enabled=!1},a.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},a.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var s=new o,c=new o;a.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,o=this.rotationalEquation2,a=s,l=c,u=this.axisA,h=this.axisB;n.prototype.update.call(this),t.quaternion.vmult(u,a),e.quaternion.vmult(h,l),a.tangents(r.axisA,o.axisA),r.axisB.copy(l),o.axisB.copy(l),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(t,e){e.exports=o,t("./Constraint");var n=t("./PointToPointConstraint"),i=t("../equations/RotationalEquation"),r=(t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation"),t("../math/Vec3"));function o(t,e,o){var a=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,s=new r,c=new r,l=new r;t.position.vadd(e.position,l),l.scale(.5,l),e.pointToLocalFrame(l,c),t.pointToLocalFrame(l,s),n.call(this,t,s,e,c,a),this.xA=t.vectorToLocalFrame(r.UNIT_X),this.xB=e.vectorToLocalFrame(r.UNIT_X),this.yA=t.vectorToLocalFrame(r.UNIT_Y),this.yB=e.vectorToLocalFrame(r.UNIT_Y),this.zA=t.vectorToLocalFrame(r.UNIT_Z),this.zB=e.vectorToLocalFrame(r.UNIT_Z);var u=this.rotationalEquation1=new i(t,e,o),h=this.rotationalEquation2=new i(t,e,o),f=this.rotationalEquation3=new i(t,e,o);this.equations.push(u,h,f)}o.prototype=new n,o.constructor=o,new r,new r,o.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,o=this.rotationalEquation3;n.prototype.update.call(this),t.vectorToWorldFrame(this.xA,i.axisA),e.vectorToWorldFrame(this.yB,i.axisB),t.vectorToWorldFrame(this.yA,r.axisA),e.vectorToWorldFrame(this.zB,r.axisB),t.vectorToWorldFrame(this.zA,o.axisA),e.vectorToWorldFrame(this.xB,o.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(t,e){e.exports=o;var n=t("./Constraint"),i=t("../equations/ContactEquation"),r=t("../math/Vec3");function o(t,e,o,a,s){n.call(this,t,o),s=void 0!==s?s:1e6,this.pivotA=e?e.clone():new r,this.pivotB=a?a.clone():new r;var c=this.equationX=new i(t,o),l=this.equationY=new i(t,o),u=this.equationZ=new i(t,o);this.equations.push(c,l,u),c.minForce=l.minForce=u.minForce=-s,c.maxForce=l.maxForce=u.maxForce=s,c.ni.set(1,0,0),l.ni.set(0,1,0),u.ni.set(0,0,1)}o.prototype=new n,o.prototype.update=function(){var t=this.bodyA,e=this.bodyB,n=this.equationX,i=this.equationY,r=this.equationZ;t.quaternion.vmult(this.pivotA,n.ri),e.quaternion.vmult(this.pivotB,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),r.ri.copy(n.ri),r.rj.copy(n.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=(t("../math/Mat3"),t("./Equation"));function r(t,e,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,t,e,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.angle=void 0!==r.angle?r.angle:0}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(t){var e=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.angle)-i.dot(r))*e-this.computeGW()*n-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(t,e){e.exports=r;var n=t("./Equation"),i=t("../math/Vec3");function r(t,e,r){r=void 0!==r?r:1e6,n.call(this,t,e,0,r),this.si=null,this.sj=null,this.restitution=0,this.ri=new i,this.rj=new i,this.ni=new i}t("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i,s=new i;r.prototype.computeB=function(t){var e=this.a,n=this.b,i=this.bi,r=this.bj,c=this.ri,l=this.rj,u=o,h=a,f=i.velocity,p=i.angularVelocity,_=(i.force,i.torque,r.velocity),d=r.angularVelocity,m=(r.force,r.torque,s),v=this.jacobianElementA,g=this.jacobianElementB,y=this.ni;c.cross(y,u),l.cross(y,h),y.negate(v.spatial),u.negate(v.rotational),g.spatial.copy(y),g.rotational.copy(h),m.copy(r.position),m.vadd(l,m),m.vsub(i.position,m),m.vsub(c,m);var x=y.dot(m),S=this.restitution+1;return-x*e-(S*_.dot(y)-S*f.dot(y)+d.dot(h)-p.dot(u))*n-t*this.computeGiMf()};var c=new i,l=new i,u=new i,h=new i,f=new i;r.prototype.getImpactVelocityAlongNormal=function(){var t=c,e=l,n=u,i=h,r=f;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(n,t),this.bj.getVelocityAtWorldPoint(i,e),t.vsub(e,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(t,e){e.exports=r;var n=t("../math/JacobianElement"),i=t("../math/Vec3");function r(t,e,i,o){this.id=r.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===o?1e6:o,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(t,e,n){var i=e,r=t,o=n;this.a=4/(o*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(o*o*r*(1+4*i))},r.prototype.computeB=function(t,e,n){var i=this.computeGW();return-this.computeGq()*t-i*e-this.computeGiMf()*n},r.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.position,o=i.position;return t.spatial.dot(r)+e.spatial.dot(o)},new i,r.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.velocity,o=i.velocity,a=n.angularVelocity,s=i.angularVelocity;return t.multiplyVectors(r,a)+e.multiplyVectors(o,s)},r.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.vlambda,o=i.vlambda,a=n.wlambda,s=i.wlambda;return t.multiplyVectors(r,a)+e.multiplyVectors(o,s)};var o=new i,a=new i,s=new i,c=new i;r.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.force,l=n.torque,u=i.force,h=i.torque,f=n.invMassSolve,p=i.invMassSolve;return r.scale(f,o),u.scale(p,a),n.invInertiaWorldSolve.vmult(l,s),i.invInertiaWorldSolve.vmult(h,c),t.multiplyVectors(o,s)+e.multiplyVectors(a,c)};var l=new i;r.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,n=this.bi,i=this.bj,r=n.invMassSolve,o=i.invMassSolve,a=n.invInertiaWorldSolve,s=i.invInertiaWorldSolve,c=r+o;return a.vmult(t.rotational,l),c+=l.dot(t.rotational),s.vmult(e.rotational,l),c+l.dot(e.rotational)};var u=new i;new i,new i,new i,new i,new i,r.prototype.addToWlambda=function(t){var e=this.jacobianElementA,n=this.jacobianElementB,i=this.bi,r=this.bj,o=u;i.vlambda.addScaledVector(i.invMassSolve*t,e.spatial,i.vlambda),r.vlambda.addScaledVector(r.invMassSolve*t,n.spatial,r.vlambda),i.invInertiaWorldSolve.vmult(e.rotational,o),i.wlambda.addScaledVector(t,o,i.wlambda),r.invInertiaWorldSolve.vmult(n.rotational,o),r.wlambda.addScaledVector(t,o,r.wlambda)},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(t,e){e.exports=r;var n=t("./Equation"),i=t("../math/Vec3");function r(t,e,r){n.call(this,t,e,-r,r),this.ri=new i,this.rj=new i,this.t=new i}t("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i;r.prototype.computeB=function(t){this.a;var e=this.b,n=(this.bi,this.bj,this.ri),i=this.rj,r=o,s=a,c=this.t;n.cross(c,r),i.cross(c,s);var l=this.jacobianElementA,u=this.jacobianElementB;return c.negate(l.spatial),r.negate(l.rotational),u.spatial.copy(c),u.rotational.copy(s),-this.computeGW()*e-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=(t("../math/Mat3"),t("./Equation"));function r(t,e,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,t,e,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(t){var e=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.maxAngle)-i.dot(r))*e-this.computeGW()*n-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=(t("../math/Mat3"),t("./Equation"));function r(t,e,r){r=void 0!==r?r:1e6,i.call(this,t,e,-r,r),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}r.prototype=new i,r.prototype.constructor=r,r.prototype.computeB=function(t){this.a;var e=this.b,n=(this.bi,this.bj,this.axisA),i=this.axisB,r=this.jacobianElementA,o=this.jacobianElementB;return r.rotational.copy(n),i.negate(o.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(t,e){var n=t("../utils/Utils");function i(t,e,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=i.idCounter++,this.materials=[t,e],this.friction=r.friction,this.restitution=r.restitution,this.contactEquationStiffness=r.contactEquationStiffness,this.contactEquationRelaxation=r.contactEquationRelaxation,this.frictionEquationStiffness=r.frictionEquationStiffness,this.frictionEquationRelaxation=r.frictionEquationRelaxation}e.exports=i,i.idCounter=0},{"../utils/Utils":54}],26:[function(t,e){function n(t){var e="";"string"==typeof(t=t||{})?(e=t,t={}):"object"==typeof t&&(e=""),this.name=e,this.id=n.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1,this.correctInelastic=0}e.exports=n,n.idCounter=0},{}],27:[function(t,e){e.exports=i;var n=t("./Vec3");function i(){this.spatial=new n,this.rotational=new n}i.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":31}],28:[function(t,e){e.exports=i;var n=t("./Vec3");function i(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}i.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},i.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},i.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},i.prototype.getTrace=function(t){t=t||new n;var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},i.prototype.vmult=function(t,e){e=e||new n;var i=this.elements,r=t.x,o=t.y,a=t.z;return e.x=i[0]*r+i[1]*o+i[2]*a,e.y=i[3]*r+i[4]*o+i[5]*a,e.z=i[6]*r+i[7]*o+i[8]*a,e},i.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},i.prototype.mmult=function(t,e){for(var n=e||new i,r=0;r<3;r++)for(var o=0;o<3;o++){for(var a=0,s=0;s<3;s++)a+=t.elements[r+3*s]*this.elements[s+3*o];n.elements[r+3*o]=a}return n},i.prototype.scale=function(t,e){e=e||new i;for(var n=this.elements,r=e.elements,o=0;3!==o;o++)r[3*o+0]=t.x*n[3*o+0],r[3*o+1]=t.y*n[3*o+1],r[3*o+2]=t.z*n[3*o+2];return e},i.prototype.solve=function(t,e){e=e||new n;for(var i,r=3,o=4,a=[],s=0;s<r*o;s++)a.push(0);for(s=0;s<3;s++)for(i=0;i<3;i++)a[s+o*i]=this.elements[s+3*i];a[3]=t.x,a[7]=t.y,a[11]=t.z;var c,l,u=3,h=u,f=4;do{if(0===a[(s=h-u)+o*s])for(i=s+1;i<h;i++)if(0!==a[s+o*i]){c=f;do{a[(l=f-c)+o*s]+=a[l+o*i]}while(--c);break}if(0!==a[s+o*s])for(i=s+1;i<h;i++){var p=a[s+o*i]/a[s+o*s];c=f;do{a[(l=f-c)+o*i]=l<=s?0:a[l+o*i]-a[l+o*s]*p}while(--c)}}while(--u);if(e.z=a[2*o+3]/a[2*o+2],e.y=(a[1*o+3]-a[1*o+2]*e.z)/a[1*o+1],e.x=(a[0*o+3]-a[0*o+2]*e.z-a[0*o+1]*e.y)/a[0*o+0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e},i.prototype.e=function(t,e,n){if(void 0===n)return this.elements[e+3*t];this.elements[e+3*t]=n},i.prototype.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},i.prototype.toString=function(){for(var t="",e=",",n=0;n<9;n++)t+=this.elements[n]+e;return t},i.prototype.reverse=function(t){t=t||new i;for(var e,n=3,r=6,o=[],a=0;a<n*r;a++)o.push(0);for(a=0;a<3;a++)for(e=0;e<3;e++)o[a+r*e]=this.elements[a+3*e];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,c,l=3,u=l,h=r;do{if(0===o[(a=u-l)+r*a])for(e=a+1;e<u;e++)if(0!==o[a+r*e]){s=h;do{o[(c=h-s)+r*a]+=o[c+r*e]}while(--s);break}if(0!==o[a+r*a])for(e=a+1;e<u;e++){var f=o[a+r*e]/o[a+r*a];s=h;do{o[(c=h-s)+r*e]=c<=a?0:o[c+r*e]-o[c+r*a]*f}while(--s)}}while(--l);a=2;do{e=a-1;do{f=o[a+r*e]/o[a+r*a],s=r;do{o[(c=r-s)+r*e]=o[c+r*e]-o[c+r*a]*f}while(--s)}while(e--)}while(--a);a=2;do{f=1/o[a+r*a],s=r;do{o[(c=r-s)+r*a]=o[c+r*a]*f}while(--s)}while(a--);a=2;do{e=2;do{if(c=o[n+e+r*a],isNaN(c)||c===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(a,e,c)}while(e--)}while(a--);return t},i.prototype.setRotationFromQuaternion=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=e*a,u=e*s,h=n*a,f=n*s,p=i*s,_=r*o,d=r*a,m=r*s,v=this.elements;return v[0]=1-(h+p),v[1]=l-m,v[2]=u+d,v[3]=l+m,v[4]=1-(c+p),v[5]=f-_,v[6]=u-d,v[7]=f+_,v[8]=1-(c+h),this},i.prototype.transpose=function(t){for(var e=(t=t||new i).elements,n=this.elements,r=0;3!==r;r++)for(var o=0;3!==o;o++)e[3*r+o]=n[3*o+r];return t}},{"./Vec3":31}],29:[function(t,e){e.exports=i;var n=t("./Vec3");function i(t,e,n,i){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==n?n:0,this.w=void 0!==i?i:1}i.prototype.set=function(t,e,n,i){return this.x=t,this.y=e,this.z=n,this.w=i,this},i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},i.prototype.setFromAxisAngle=function(t,e){var n=Math.sin(.5*e);return this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=Math.cos(.5*e),this},i.prototype.toAxisAngle=function(t){t=t||new n,this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]};var r=new n,o=new n;i.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var n=r,i=o;t.tangents(n,i),this.setFromAxisAngle(n,Math.PI)}else{var a=t.cross(e);this.x=a.x,this.y=a.y,this.z=a.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()}return this},new n,new n,new n,i.prototype.mult=function(t,e){e=e||new i;var n=this.x,r=this.y,o=this.z,a=this.w,s=t.x,c=t.y,l=t.z,u=t.w;return e.x=n*u+a*s+r*l-o*c,e.y=r*u+a*c+o*s-n*l,e.z=o*u+a*l+n*c-r*s,e.w=a*u-n*s-r*c-o*l,e},i.prototype.inverse=function(t){var e=this.x,n=this.y,r=this.z,o=this.w;t=t||new i,this.conjugate(t);var a=1/(e*e+n*n+r*r+o*o);return t.x*=a,t.y*=a,t.z*=a,t.w*=a,t},i.prototype.conjugate=function(t){return(t=t||new i).x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},i.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},i.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},i.prototype.vmult=function(t,e){e=e||new n;var i=t.x,r=t.y,o=t.z,a=this.x,s=this.y,c=this.z,l=this.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,p=-a*i-s*r-c*o;return e.x=u*l+p*-a+h*-c-f*-s,e.y=h*l+p*-s+f*-a-u*-c,e.z=f*l+p*-c+u*-s-h*-a,e},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},i.prototype.toEuler=function(t,e){var n,i,r;e=e||"YZX";var o=this.x,a=this.y,s=this.z,c=this.w;switch(e){case"YZX":var l=o*a+s*c;if(l>.499&&(n=2*Math.atan2(o,c),i=Math.PI/2,r=0),l<-.499&&(n=-2*Math.atan2(o,c),i=-Math.PI/2,r=0),isNaN(n)){var u=o*o,h=a*a,f=s*s;n=Math.atan2(2*a*c-2*o*s,1-2*h-2*f),i=Math.asin(2*l),r=Math.atan2(2*o*c-2*a*s,1-2*u-2*f)}break;default:throw new Error("Euler order "+e+" not supported yet.")}t.y=n,t.z=i,t.x=r},i.prototype.setFromEuler=function(t,e,n,i){i=i||"XYZ";var r=Math.cos(t/2),o=Math.cos(e/2),a=Math.cos(n/2),s=Math.sin(t/2),c=Math.sin(e/2),l=Math.sin(n/2);return"XYZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"YXZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"ZXY"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"ZYX"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"YZX"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a-s*c*l):"XZY"===i&&(this.x=s*o*a-r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a+s*c*l),this},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)},i.prototype.slerp=function(t,e,n){n=n||new i;var r,o,a,s,c,l=this.x,u=this.y,h=this.z,f=this.w,p=t.x,_=t.y,d=t.z,m=t.w;return(o=l*p+u*_+h*d+f*m)<0&&(o=-o,p=-p,_=-_,d=-d,m=-m),1-o>1e-6?(r=Math.acos(o),a=Math.sin(r),s=Math.sin((1-e)*r)/a,c=Math.sin(e*r)/a):(s=1-e,c=e),n.x=s*l+c*p,n.y=s*u+c*_,n.z=s*h+c*d,n.w=s*f+c*m,n},i.prototype.integrate=function(t,e,n,r){r=r||new i;var o=t.x*n.x,a=t.y*n.y,s=t.z*n.z,c=this.x,l=this.y,u=this.z,h=this.w,f=.5*e;return r.x+=f*(o*h+a*u-s*l),r.y+=f*(a*h+s*c-o*u),r.z+=f*(s*h+o*l-a*c),r.w+=f*(-o*c-a*l-s*u),r},i.prototype.euqals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}},{"./Vec3":31}],30:[function(t,e){var n=t("./Vec3"),i=t("./Quaternion");function r(t){t=t||{},this.position=new n,t.position&&this.position.copy(t.position),this.quaternion=new i,t.quaternion&&this.quaternion.copy(t.quaternion)}e.exports=r;var o=new i;r.pointToLocalFrame=function(t,e,i,r){return r=r||new n,i.vsub(t,r),e.conjugate(o),o.vmult(r,r),r},r.prototype.pointToLocal=function(t,e){return r.pointToLocalFrame(this.position,this.quaternion,t,e)},r.pointToWorldFrame=function(t,e,i,r){return r=r||new n,e.vmult(i,r),r.vadd(t,r),r},r.prototype.pointToWorld=function(t,e){return r.pointToWorldFrame(this.position,this.quaternion,t,e)},r.prototype.vectorToWorldFrame=function(t,e){return e=e||new n,this.quaternion.vmult(t,e),e},r.vectorToWorldFrame=function(t,e,n){return t.vmult(e,n),n},r.vectorToLocalFrame=function(t,e,i,r){return r=r||new n,e.w*=-1,e.vmult(i,r),e.w*=-1,r}},{"./Quaternion":29,"./Vec3":31}],31:[function(t,e){e.exports=i;var n=t("./Mat3");function i(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0}i.ZERO=new i(0,0,0),i.UNIT_X=new i(1,0,0),i.UNIT_Y=new i(0,1,0),i.UNIT_Z=new i(0,0,1),i.prototype.cross=function(t,e){var n=t.x,r=t.y,o=t.z,a=this.x,s=this.y,c=this.z;return(e=e||new i).x=s*o-c*r,e.y=c*n-a*o,e.z=a*r-s*n,e},i.prototype.set=function(t,e,n){return this.x=t,this.y=e,this.z=n,this},i.prototype.setZero=function(){this.x=this.y=this.z=0},i.prototype.vadd=function(t,e){if(!e)return new i(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z},i.prototype.vsub=function(t,e){if(!e)return new i(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z},i.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.prototype.normalize=function(){var t=this.x,e=this.y,n=this.z,i=Math.sqrt(t*t+e*e+n*n);if(i>0){var r=1/i;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return i},i.prototype.unit=function(t){t=t||new i;var e=this.x,n=this.y,r=this.z,o=Math.sqrt(e*e+n*n+r*r);return o>0?(o=1/o,t.x=e*o,t.y=n*o,t.z=r*o):(t.x=1,t.y=0,t.z=0),t},i.prototype.norm=function(){var t=this.x,e=this.y,n=this.z;return Math.sqrt(t*t+e*e+n*n)},i.prototype.length=i.prototype.norm,i.prototype.norm2=function(){return this.dot(this)},i.prototype.lengthSquared=i.prototype.norm2,i.prototype.distanceTo=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return Math.sqrt((r-e)*(r-e)+(o-n)*(o-n)+(a-i)*(a-i))},i.prototype.distanceSquared=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return(r-e)*(r-e)+(o-n)*(o-n)+(a-i)*(a-i)},i.prototype.mult=function(t,e){e=e||new i;var n=this.x,r=this.y,o=this.z;return e.x=t*n,e.y=t*r,e.z=t*o,e},i.prototype.vmul=function(t,e){return(e=e||new i).x=t.x*this.x,e.y=t.y*this.y,e.z=t.z*this.z,e},i.prototype.scale=i.prototype.mult,i.prototype.addScaledVector=function(t,e,n){return(n=n||new i).x=this.x+t*e.x,n.y=this.y+t*e.y,n.z=this.z+t*e.z,n},i.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.prototype.negate=function(t){return(t=t||new i).x=-this.x,t.y=-this.y,t.z=-this.z,t};var r=new i,o=new i;i.prototype.tangents=function(t,e){var n=this.norm();if(n>0){var i=r,a=1/n;i.set(this.x*a,this.y*a,this.z*a);var s=o;Math.abs(i.x)<.9?(s.set(1,0,0),i.cross(s,t)):(s.set(0,1,0),i.cross(s,t)),i.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},i.prototype.toString=function(){return this.x+","+this.y+","+this.z},i.prototype.toArray=function(){return[this.x,this.y,this.z]},i.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},i.prototype.lerp=function(t,e,n){var i=this.x,r=this.y,o=this.z;n.x=i+(t.x-i)*e,n.y=r+(t.y-r)*e,n.z=o+(t.z-o)*e},i.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},i.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)};var a=new i;i.prototype.isAntiparallelTo=function(t,e){return this.negate(a),a.almostEquals(t,e)},i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(t,e){e.exports=h;var n=t("../utils/EventTarget"),i=t("../shapes/Shape"),r=t("../math/Vec3"),o=t("../math/Mat3"),a=t("../math/Quaternion"),s=(t("../material/Material"),t("../collision/AABB")),c=t("../shapes/Box"),l=t("../collision/RaycastResult"),u=t("../world/World");function h(t){t=t||{},n.apply(this),this.id=h.idCounter++,this.world=null,this.preStep=null,this.ccdSpeedThreshold=void 0!==t.ccdSpeedThreshold?t.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==t.ccdIterations?t.ccdIterations:5,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new r,this.previousPosition=new r,this.interpolatedPosition=new r,this.initPosition=new r,t.position&&(this.position.copy(t.position),this.previousPosition.copy(t.position),this.interpolatedPosition.copy(t.position),this.initPosition.copy(t.position)),this.velocity=new r,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new r,this.force=new r;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=e<=0?h.STATIC:h.DYNAMIC,typeof t.type==typeof h.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new a,this.initQuaternion=new a,this.previousQuaternion=new a,this.interpolatedQuaternion=new a,t.quaternion&&(this.quaternion.copy(t.quaternion),this.initQuaternion.copy(t.quaternion),this.previousQuaternion.copy(t.quaternion),this.interpolatedQuaternion.copy(t.quaternion)),this.angularVelocity=new r,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new o,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new o,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.linearFactor=new r(1,1,1),t.linearFactor&&this.linearFactor.copy(t.linearFactor),this.angularFactor=new r(1,1,1),t.angularFactor&&this.angularFactor.copy(t.angularFactor),this.aabb=new s,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new r,t.shape&&this.addShape(t.shape),this.hasTrigger=!0,this.updateMassProperties()}h.prototype=new n,h.prototype.constructor=h,h.COLLIDE_EVENT_NAME="collide",h.DYNAMIC=1,h.STATIC=2,h.KINEMATIC=4,h.AWAKE=0,h.SLEEPY=1,h.SLEEPING=2,h.idCounter=0,h.wakeupEvent={type:"wakeup"},h.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,t===h.SLEEPING&&this.dispatchEvent(h.wakeupEvent)},h.prototype.sleep=function(){this.sleepState=h.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},h.sleepyEvent={type:"sleepy"},h.sleepEvent={type:"sleep"},h.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);e===h.AWAKE&&n<i?(this.sleepState=h.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(h.sleepyEvent)):e===h.SLEEPY&&n>i?this.wakeUp():e===h.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(h.sleepEvent))}},h.prototype.updateSolveMassProperties=function(){this.sleepState===h.SLEEPING||this.type===h.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},h.prototype.pointToLocalFrame=function(t,e){return e=e||new r,t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},h.prototype.vectorToLocalFrame=function(t,e){return e=e||new r,this.quaternion.conjugate().vmult(t,e),e},h.prototype.pointToWorldFrame=function(t,e){return e=e||new r,this.quaternion.vmult(t,e),e.vadd(this.position,e),e},h.prototype.vectorToWorldFrame=function(t,e){return e=e||new r,this.quaternion.vmult(t,e),e};var f=new r,p=new a;h.prototype.addShape=function(t,e,n){var i=new r,o=new a;return e&&i.copy(e),n&&o.copy(n),this.shapes.push(t),this.shapeOffsets.push(i),this.shapeOrientations.push(o),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),u.idToShapeMap[t.id]=t,t.body=this,this},h.prototype.removeShape=function(t){var e=this.shapes.indexOf(t);-1!==e&&(this.shapes.splice(e,1),this.shapeOffsets.splice(e,1),this.shapeOrientations.splice(e,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},h.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,n=t.length,i=0,r=0;r!==n;r++){var o=t[r];o.updateBoundingSphereRadius();var a=e[r].norm(),s=o.boundingSphereRadius;a+s>i&&(i=a+s)}this.boundingRadius=i};var _=new s;h.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,n=this.shapeOrientations,i=t.length,r=f,o=p,a=this.quaternion,s=this.aabb,c=_,l=0;l!==i;l++){var u=t[l];a.vmult(e[l],r),r.vadd(this.position,r),n[l].mult(a,o),u.calculateWorldAABB(r,o,c.lowerBound,c.upperBound),0===l?s.copy(c):s.extend(c)}this.aabbNeedsUpdate=!1};var d=new o,m=new o;new o,h.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var n=d,i=m;n.setRotationFromQuaternion(this.quaternion),n.transpose(i),n.scale(e,n),n.mmult(i,this.invInertiaWorld)}},new r;var v=new r;h.prototype.applyForce=function(t,e){if(this.type===h.DYNAMIC){var n=v;e.cross(t,n),this.force.vadd(t,this.force),this.torque.vadd(n,this.torque)}};var g=new r,y=new r;h.prototype.applyLocalForce=function(t,e){if(this.type===h.DYNAMIC){var n=g,i=y;this.vectorToWorldFrame(t,n),this.vectorToWorldFrame(e,i),this.applyForce(n,i)}},new r;var x=new r,S=new r;h.prototype.applyImpulse=function(t,e){if(this.type===h.DYNAMIC){var n=e,i=x;i.copy(t),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity);var r=S;n.cross(t,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var b=new r,T=new r;h.prototype.applyLocalImpulse=function(t,e){if(this.type===h.DYNAMIC){var n=b,i=T;this.vectorToWorldFrame(t,n),this.vectorToWorldFrame(e,i),this.applyImpulse(n,i)}};var E=new r;h.prototype.updateMassProperties=function(){var t=E;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,n=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!n?1/e.x:0,e.y>0&&!n?1/e.y:0,e.z>0&&!n?1/e.z:0),this.updateInertiaWorld(!0)},h.prototype.getVelocityAtWorldPoint=function(t,e){var n=new r;return t.vsub(this.position,n),this.angularVelocity.cross(n,e),this.velocity.vadd(e,e),e},new r,new r;var C=new r,w=(new a,new a);h.prototype.integrate=function(t,e,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===h.DYNAMIC||u.integrateKinematic&&this.type===h.KINEMATIC)&&this.sleepState!==h.SLEEPING){var i=this.velocity,r=this.angularVelocity,o=this.position,a=this.force,s=this.torque,c=this.quaternion,l=this.invMass,f=this.invInertiaWorld,p=this.linearFactor,_=l*t;i.x+=a.x*_*p.x,i.y+=a.y*_*p.y,i.z+=a.z*_*p.z;var d=f.elements,m=this.angularFactor,v=s.x*m.x,g=s.y*m.y,y=s.z*m.z;r.x+=t*(d[0]*v+d[1]*g+d[2]*y),r.y+=t*(d[3]*v+d[4]*g+d[5]*y),r.z+=t*(d[6]*v+d[7]*g+d[8]*y),c.integrate(this.angularVelocity,t,this.angularFactor,c),e&&(n?c.normalizeFast():c.normalize()),this.type===h.DYNAMIC&&this.ccdSpeedThreshold>0&&this.velocity.length()>=Math.pow(this.ccdSpeedThreshold,2)&&this.integrateToTimeOfImpact(t)||(i.mult(t,C),o.vadd(C,o)),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},h.prototype.updateKinematic=function(t){if(this.type===h.KINEMATIC&&0!==t){this.velocity.setZero(),this.angularVelocity.setZero();var e=1/t;this.previousPosition.almostEquals(this.position)||(this.position.vsub(this.previousPosition,this.velocity),this.velocity.mult(e,this.velocity),this.aabbNeedsUpdate=!0),this.previousQuaternion.euqals(this.quaternion)||(this.previousQuaternion.conjugate(w),w.mult(this.quaternion,w),w.toEuler(this.angularVelocity),this.angularVelocity.mult(e,this.angularVelocity),this.aabbNeedsUpdate=!0)}},h.prototype.applyGravity=function(t){if(this.type===h.DYNAMIC){if(1==this.linearDamping)this.force.setZero();else if(this.useGravity){var e=t.x,n=t.y,i=t.z,r=this.force,o=this.mass;r.x+=o*e,r.y+=o*n,r.z+=o*i}1==this.angularDamping&&this.torque.setZero()}};var A=new r,P=new r,I=new r,R=new r,D=new r,O=new r,M=new l,N=new l,L=new l,B=new r,F=new r,z=new r,U=new o;h.prototype.integrateToTimeOfImpact=function(t){A.copy(this.velocity),A.normalize(),this.velocity.mult(t,I),I.vadd(this.position,P),P.vsub(this.position,D);var e,n=D.length(),r=this.collisionFilterGroup;this.collisionFilterGroup=0;for(var o=1,a=0;a<this.shapes.length;a++){var s=this.shapes[a],c={collisionFilterMask:s.collisionFilterMask,collisionFilterGroup:s.collisionFilterGroup,skipBackfaces:!0};if(B.copy(this.position),B.vadd(D,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,M),e=M.body,s.type===i.types.SPHERE&&(o=s.radius,u.ccdSphereAdvance)){if(z.copy(this.velocity),z.y=0,z.normalize(),B.copy(z),U.identity(),U.elements[0]=B.x,U.elements[1]=-B.z,U.elements[3]=B.z,U.elements[4]=B.x,R.set(0,s.radius,0),U.vmult(R,R),R.z=R.y,R.y=0,R.vadd(this.position,B),I.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,N),R.negate(R),R.vadd(this.position,B),I.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,L),N.hasHit){N.hitPointWorld.vsub(this.position,B);var l=A.dot(B);(!M.hasHit||M.distance>l)&&(M.hasHit=!0,M.distance=l,e=N.body,A.mult(l,B),B.vadd(this.position,M.hitPointWorld))}L.hasHit&&(L.hitPointWorld.vsub(this.position,B),l=A.dot(B),(!M.hasHit||M.distance>l)&&(M.hasHit=!0,M.distance=l,e=L.body,A.mult(l,B),B.vadd(this.position,M.hitPointWorld)))}if(e)break}if(this.collisionFilterGroup=r,!e)return!1;M.hasHit&&h.DrawSphere(M.hitPointWorld,.05),N.hasHit&&h.DrawSphere(N.hitPointWorld,.05),L.hasHit&&h.DrawSphere(L.hitPointWorld,.05);var f=1;(P=M.hitPointWorld).vsub(this.position,D),f=M.distance/n,O.copy(this.position);for(var p=0,_=0,d=f,m=1;m>=_&&p<this.ccdIterations;){p++,d=(m+_)/2,D.mult(d,C),O.vadd(C,this.position),this.computeAABB(),h.DrawSphere(this.position,o);var v=this.aabb.overlaps(e.aabb);if(v){var g=[];this.world.narrowphase.getContacts([this],[e],this.world,g,[],[],[]),v=g.length>0}v?m=d:_=d}return f=m,this.position.copy(O),D.mult(f,C),this.position.vadd(C,this.position),!0},h.DrawSphere=h.DrawLine=function(){},h.prototype.isSleeping=function(){return this.sleepState===h.SLEEPING},h.prototype.isSleepy=function(){return this.sleepState===h.SLEEPY},h.prototype.isAwake=function(){return this.sleepState===h.AWAKE},h.prototype.updateHasTrigger=function(){for(var t=this.shapes.length;t--&&(this.hasTrigger=!this.shapes[t].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(t,e){t("./Body");var n=t("../math/Vec3"),i=t("../math/Quaternion"),r=(t("../collision/RaycastResult"),t("../collision/Ray")),o=t("../objects/WheelInfo");function a(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2}e.exports=a,new n,new n,new n;var s=new n,c=new n,l=new n;new r,a.prototype.addWheel=function(t){var e=new o(t=t||{}),n=this.wheelInfos.length;return this.wheelInfos.push(e),n},a.prototype.setSteeringValue=function(t,e){this.wheelInfos[e].steering=t},new n,a.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},a.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t},a.prototype.addToWorld=function(t){this.constraints,t.addBody(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},a.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},a.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,r=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var a=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),o=0;o<i;o++)this.castRay(e[o]);this.updateSuspension(t);var s=new n,c=new n;for(o=0;o<i;o++){var l=(p=e[o]).suspensionForce;l>p.maxSuspensionForce&&(l=p.maxSuspensionForce),p.raycastResult.hitNormalWorld.scale(l*t,s),p.raycastResult.hitPointWorld.vsub(r.position,c),r.applyImpulse(s,c)}this.updateFriction(t);var u=new n,h=new n,f=new n;for(o=0;o<i;o++){var p=e[o];r.getVelocityAtWorldPoint(p.chassisConnectionPointWorld,f);var _=1;switch(this.indexUpAxis){case 1:_=-1}if(p.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var d=h.dot(p.raycastResult.hitNormalWorld);p.raycastResult.hitNormalWorld.scale(d,u),h.vsub(u,h);var m=h.dot(f);p.deltaRotation=_*m*t/p.radius}!p.sliding&&p.isInContact||0===p.engineForce||!p.useCustomSlidingRotationalSpeed||(p.deltaRotation=(p.engineForce>0?1:-1)*p.customSlidingRotationalSpeed*t),Math.abs(p.brake)>Math.abs(p.engineForce)&&(p.deltaRotation=0),p.rotation+=p.deltaRotation,p.deltaRotation*=.99}},a.prototype.updateSuspension=function(){for(var t=this.chassisBody.mass,e=this.wheelInfos,n=e.length,i=0;i<n;i++){var r=e[i];if(r.isInContact){var o,a=r.suspensionRestLength-r.suspensionLength;o=r.suspensionStiffness*a*r.clippedInvContactDotSuspension;var s=r.suspensionRelativeVelocity;o-=(s<0?r.dampingCompression:r.dampingRelaxation)*s,r.suspensionForce=o*t,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}},a.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new n,h=new n;a.prototype.castRay=function(t){var e=u,i=h;this.updateWheelTransformWorld(t);var r=this.chassisBody,o=-1,a=t.suspensionRestLength+t.radius;t.directionWorld.scale(a,e);var s=t.chassisConnectionPointWorld;s.vadd(e,i);var c=t.raycastResult;c.reset();var l=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(s,i,c),r.collisionResponse=l;var f=c.body;if(t.raycastResult.groundObject=0,f){o=c.distance,t.raycastResult.hitNormalWorld=c.hitNormalWorld,t.isInContact=!0;var p=c.distance;t.suspensionLength=p-t.radius;var _=t.suspensionRestLength-t.maxSuspensionTravel,d=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<_&&(t.suspensionLength=_),t.suspensionLength>d&&(t.suspensionLength=d,t.raycastResult.reset());var m=t.raycastResult.hitNormalWorld.dot(t.directionWorld),v=new n;r.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,v);var g=t.raycastResult.hitNormalWorld.dot(v);if(m>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var y=-1/m;t.suspensionRelativeVelocity=g*y,t.clippedInvContactDotSuspension=y}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return o},a.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},a.prototype.updateWheelTransform=function(t){var e=s,n=c,r=l,o=this.wheelInfos[t];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,e),n.copy(o.axleLocal),e.cross(n,r),r.normalize(),n.normalize();var a=o.steering,u=new i;u.setFromAxisAngle(e,a);var h=new i;h.setFromAxisAngle(n,o.rotation);var f=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(u,f),f.mult(h,f),f.normalize();var p=o.worldTransform.position;p.copy(o.directionWorld),p.scale(o.suspensionLength,p),p.vadd(o.chassisConnectionPointWorld,p)};var f=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];a.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var p=new n,_=[],d=[],m=1;a.prototype.updateFriction=function(t){for(var e=p,i=this.wheelInfos,r=i.length,o=this.chassisBody,a=d,s=_,c=0;c<r;c++){var l=(D=i[c]).raycastResult.body;D.sideImpulse=0,D.forwardImpulse=0,a[c]||(a[c]=new n),s[c]||(s[c]=new n)}for(c=0;c<r;c++)if(l=(D=i[c]).raycastResult.body){var u=s[c];this.getWheelTransformWorld(c).vectorToWorldFrame(f[this.indexRightAxis],u);var h=D.raycastResult.hitNormalWorld,v=u.dot(h);h.scale(v,e),u.vsub(e,u),u.normalize(),h.cross(u,a[c]),a[c].normalize(),D.sideImpulse=I(o,D.raycastResult.hitPointWorld,l,D.raycastResult.hitPointWorld,u),D.sideImpulse*=m}var g=1,y=.5;for(this.sliding=!1,c=0;c<r;c++){l=(D=i[c]).raycastResult.body;var S=0;if(D.slipInfo=1,l){var b=0,T=D.brake?D.brake:b;S=x(o,l,D.raycastResult.hitPointWorld,a[c],T);var E=T/(S+=D.engineForce*t);D.slipInfo*=E}if(D.forwardImpulse=0,D.skidInfo=1,l){D.skidInfo=1;var C=D.suspensionForce*t*D.frictionSlip,w=C*C;D.forwardImpulse=S;var A=D.forwardImpulse*y,P=D.sideImpulse*g,R=A*A+P*P;D.sliding=!1,R>w&&(this.sliding=!0,D.sliding=!0,E=C/Math.sqrt(R),D.skidInfo*=E)}}if(this.sliding)for(c=0;c<r;c++)0!==(D=i[c]).sideImpulse&&D.skidInfo<1&&(D.forwardImpulse*=D.skidInfo,D.sideImpulse*=D.skidInfo);for(c=0;c<r;c++){var D=i[c],O=new n;if(D.raycastResult.hitPointWorld.vsub(o.position,O),0!==D.forwardImpulse){var M=new n;a[c].scale(D.forwardImpulse,M),o.applyImpulse(M,O)}if(0!==D.sideImpulse){l=D.raycastResult.body;var N=new n;D.raycastResult.hitPointWorld.vsub(l.position,N);var L=new n;s[c].scale(D.sideImpulse,L),o.vectorToLocalFrame(O,O),O["xyz"[this.indexUpAxis]]*=D.rollInfluence,o.vectorToWorldFrame(O,O),o.applyImpulse(L,O),L.scale(-1,L),l.applyImpulse(L,N)}}};var v=new n,g=new n,y=new n;function x(t,e,n,i,r){var o=0,a=n,s=v,c=g,l=y;return t.getVelocityAtWorldPoint(a,s),e.getVelocityAtWorldPoint(a,c),s.vsub(c,l),r<(o=-i.dot(l)*(1/(C(t,n,i)+C(e,n,i))))&&(o=r),o<-r&&(o=-r),o}var S=new n,b=new n,T=new n,E=new n;function C(t,e,n){var i=S,r=b,o=T,a=E;return e.vsub(t.position,i),i.cross(n,r),t.invInertiaWorld.vmult(r,a),a.cross(i,o),t.invMass+n.dot(o)}var w=new n,A=new n,P=new n;function I(t,e,n,i,r){if(r.norm2()>1.1)return 0;var o=w,a=A,s=P;return t.getVelocityAtWorldPoint(e,o),n.getVelocityAtWorldPoint(i,a),o.vsub(a,s),-.2*r.dot(s)*(1/(t.invMass+n.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(t,e){var n=t("./Body"),i=t("../shapes/Sphere"),r=t("../shapes/Box"),o=t("../math/Vec3"),a=t("../constraints/HingeConstraint");function s(t){if(this.wheelBodies=[],this.coordinateSystem=void 0===t.coordinateSystem?new o(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var e=new r(new o(5,2,.5));this.chassisBody=new n(1,e)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}e.exports=s,s.prototype.addWheel=function(t){var e=(t=t||{}).body;e||(e=new n(1,new i(1.2))),this.wheelBodies.push(e),this.wheelForces.push(0),new o;var r=void 0!==t.position?t.position.clone():new o,s=new o;this.chassisBody.pointToWorldFrame(r,s),e.position.set(s.x,s.y,s.z);var c=void 0!==t.axis?t.axis.clone():new o(0,1,0);this.wheelAxes.push(c);var l=new a(this.chassisBody,e,{pivotA:r,axisA:c,pivotB:o.ZERO,axisB:c,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},s.prototype.setSteeringValue=function(t,e){var n=this.wheelAxes[e],i=Math.cos(t),r=Math.sin(t),o=n.x,a=n.y;this.constraints[e].axisA.set(i*o-r*a,r*o+i*a,0)},s.prototype.setMotorSpeed=function(t,e){var n=this.constraints[e];n.enableMotor(),n.motorTargetVelocity=t},s.prototype.disableMotor=function(t){this.constraints[t].disableMotor()};var c=new o;s.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},s.prototype.applyWheelForce=function(t,e){var n=this.wheelAxes[e],i=this.wheelBodies[e],r=i.torque;n.scale(t,c),i.vectorToWorldFrame(c,c),r.vadd(c,r)},s.prototype.addToWorld=function(t){for(var e=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)t.addBody(n[i]);for(i=0;i<e.length;i++)t.addConstraint(e[i]);t.addEventListener("preStep",this._update.bind(this))},s.prototype._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)},s.prototype.removeFromWorld=function(t){for(var e=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)t.remove(n[i]);for(i=0;i<e.length;i++)t.removeConstraint(e[i])};var l=new o;s.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],n=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(e,l),n.dot(l)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(t,e){e.exports=i,t("../shapes/Shape");var n=t("../math/Vec3");function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),i.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new n;i.prototype.getNeighbors=function(t,e){for(var n=this.particles.length,i=t.id,o=this.smoothingRadius*this.smoothingRadius,a=r,s=0;s!==n;s++){var c=this.particles[s];c.position.vsub(t.position,a),i!==c.id&&a.norm2()<o&&e.push(c)}};var o=new n,a=new n,s=new n,c=new n,l=new n,u=new n;i.prototype.update=function(){for(var t=this.particles.length,e=o,n=this.speedOfSound,i=this.eps,r=0;r!==t;r++){var h=this.particles[r];(E=this.neighbors[r]).length=0,this.getNeighbors(h,E),E.push(this.particles[r]);for(var f=E.length,p=0,_=0;_!==f;_++){h.position.vsub(E[_].position,e);var d=e.norm(),m=this.w(d);p+=E[_].mass*m}this.densities[r]=p,this.pressures[r]=n*n*(this.densities[r]-this.density)}var v=a,g=s,y=c,x=l,S=u;for(r=0;r!==t;r++){var b,T,E,C=this.particles[r];for(v.set(0,0,0),g.set(0,0,0),f=(E=this.neighbors[r]).length,_=0;_!==f;_++){var w=E[_];C.position.vsub(w.position,x);var A=x.norm();b=-w.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[_]/(this.densities[_]*this.densities[_]+i)),this.gradw(x,y),y.mult(b,y),v.vadd(y,v),w.velocity.vsub(C.velocity,S),S.mult(1/(1e-4+this.densities[r]*this.densities[_])*this.viscosity*w.mass,S),T=this.nablaw(A),S.mult(T,S),g.vadd(S,g)}g.mult(C.mass,g),v.mult(C.mass,v),C.force.vadd(g,C.force),C.force.vadd(v,C.force)}},i.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},i.prototype.gradw=function(t,e){var n=t.norm(),i=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-n*n,2),e)},i.prototype.nablaw=function(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(t,e){var n=t("../math/Vec3");function i(t,e,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}e.exports=i,i.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},i.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},i.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},i.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var r=new n,o=new n,a=new n,s=new n,c=new n,l=new n,u=new n,h=new n,f=new n,p=new n,_=new n;i.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,n=this.restLength,i=this.bodyA,d=this.bodyB,m=r,v=o,g=a,y=s,x=_,S=c,b=l,T=u,E=h,C=f,w=p;this.getWorldAnchorA(S),this.getWorldAnchorB(b),S.vsub(i.position,T),b.vsub(d.position,E),b.vsub(S,m);var A=m.norm();v.copy(m),v.normalize(),d.velocity.vsub(i.velocity,g),d.angularVelocity.cross(E,x),g.vadd(x,g),i.angularVelocity.cross(T,x),g.vsub(x,g),v.mult(-t*(A-n)-e*g.dot(v),y),i.force.vsub(y,i.force),d.force.vadd(y,d.force),T.cross(y,C),E.cross(y,w),i.torque.vsub(C,i.torque),d.torque.vadd(w,d.torque)}},{"../math/Vec3":31}],37:[function(t,e){var n=t("../math/Vec3"),i=t("../math/Transform"),r=t("../collision/RaycastResult"),o=t("../utils/Utils");function a(t){t=o.defaults(t,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new i,this.isInContact=!1}e.exports=a;var s=new n,c=new n;s=new n,a.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var n=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,c),t.getVelocityAtWorldPoint(c,s);var i=e.hitNormalWorld.dot(s);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/n;this.suspensionRelativeVelocity=i*r,this.clippedInvContactDotSuspension=r}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(t,e){e.exports=o;var n=t("./Shape"),i=t("../math/Vec3"),r=t("./ConvexPolyhedron");function o(t){n.call(this,{type:n.types.BOX}),this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,n=this.halfExtents.z,o=i,a=[new o(-t,-e,-n),new o(t,-e,-n),new o(t,e,-n),new o(-t,e,-n),new o(-t,-e,n),new o(t,-e,n),new o(t,e,n),new o(-t,e,n)],s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],c=(new o(0,0,1),new o(0,1,0),new o(1,0,0),new r(a,s));this.convexPolyhedronRepresentation=c,c.material=this.material},o.prototype.calculateLocalInertia=function(t,e){return e=e||new i,o.calculateInertia(this.halfExtents,t,e),e},o.calculateInertia=function(t,e,n){var i=t;i.isZero()?(n.x=2/12*e,n.y=2/12*e,n.z=2/12*e):(n.x=1/12*e*(4*i.y*i.y+4*i.z*i.z),n.y=1/12*e*(4*i.x*i.x+4*i.z*i.z),n.z=1/12*e*(4*i.y*i.y+4*i.x*i.x))},o.prototype.getSideNormals=function(t,e){var n=t,i=this.halfExtents;if(n[0].set(i.x,0,0),n[1].set(0,i.y,0),n[2].set(0,0,i.z),n[3].set(-i.x,0,0),n[4].set(0,-i.y,0),n[5].set(0,0,-i.z),void 0!==e)for(var r=0;r!==n.length;r++)e.vmult(n[r],n[r]);return n},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new i;new i,o.prototype.forEachWorldCorner=function(t,e,n){for(var i=this.halfExtents,r=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],o=0;o<r.length;o++)a.set(r[o][0],r[o][1],r[o][2]),e.vmult(a,a),t.vadd(a,a),n(a.x,a.y,a.z)};var s=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.calculateWorldAABB=function(t,e,n,i){var r=this.halfExtents;s[0].set(r.x,r.y,r.z),s[1].set(-r.x,r.y,r.z),s[2].set(-r.x,-r.y,r.z),s[3].set(-r.x,-r.y,-r.z),s[4].set(r.x,-r.y,-r.z),s[5].set(r.x,r.y,-r.z),s[6].set(-r.x,r.y,-r.z),s[7].set(r.x,-r.y,r.z);var o=s[0];e.vmult(o,o),t.vadd(o,o),i.copy(o),n.copy(o);for(var a=1;a<8;a++){o=s[a],e.vmult(o,o),t.vadd(o,o);var c=o.x,l=o.y,u=o.z;c>i.x&&(i.x=c),l>i.y&&(i.y=l),u>i.z&&(i.z=u),c<n.x&&(n.x=c),l<n.y&&(n.y=l),u<n.z&&(n.z=u)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(t,e){e.exports=o;var n=t("./Shape"),i=t("../math/Vec3"),r=(t("../math/Quaternion"),t("../math/Transform"));function o(t,e,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=e||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o;var a=new i;o.prototype.computeEdges=function(){var t=this.faces,e=this.vertices,n=(e.length,this.uniqueEdges);n.length=0;for(var i=a,r=0;r!==t.length;r++)for(var o=t[r],s=o.length,c=0;c!==s;c++){var l=(c+1)%s;e[o[c]].vsub(e[o[l]],i),i.normalize();for(var u=!1,h=0;h!==n.length;h++)if(n[h].almostEquals(i)||n[h].almostEquals(i)){u=!0;break}u||n.push(i.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var n=this.faceNormals[t]||new i;this.getFaceNormal(t,n),n.negate(n),this.faceNormals[t]=n}};var s=new i,c=new i;o.computeNormal=function(t,e,n,i){e.vsub(t,c),n.vsub(e,s),s.cross(c,i),i.isZero()||i.normalize()},o.prototype.getFaceNormal=function(t,e){var n=this.faces[t],i=this.vertices[n[0]],r=this.vertices[n[1]],a=this.vertices[n[2]];return o.computeNormal(i,r,a,e)};var l=new i;o.prototype.clipAgainstHull=function(t,e,n,r,o,a,s,c,u){for(var h=l,f=-1,p=-Number.MAX_VALUE,_=0;_<n.faces.length;_++){h.copy(n.faceNormals[_]),o.vmult(h,h);var d=h.dot(a);d>p&&(p=d,f=_)}for(var m=[],v=n.faces[f],g=v.length,y=0;y<g;y++){var x=n.vertices[v[y]],S=new i;S.copy(x),o.vmult(S,S),r.vadd(S,S),m.push(S)}f>=0&&this.clipFaceAgainstHull(a,t,e,m,s,c,u)};var u=new i,h=new i,f=new i,p=new i,_=new i,d=new i;o.prototype.findSeparatingAxis=function(t,e,n,i,r,o,a,s){var c=u,l=h,m=f,v=p,g=_,y=d,x=Number.MAX_VALUE,S=this;if(S.uniqueAxes)for(T=0;T!==S.uniqueAxes.length;T++){if(n.vmult(S.uniqueAxes[T],c),!1===(w=S.testSepAxis(c,t,e,n,i,r)))return!1;w<x&&(x=w,o.copy(c))}else for(var b=a?a.length:S.faces.length,T=0;T<b;T++){var E=a?a[T]:T;if(c.copy(S.faceNormals[E]),n.vmult(c,c),!1===(w=S.testSepAxis(c,t,e,n,i,r)))return!1;w<x&&(x=w,o.copy(c))}if(t.uniqueAxes)for(T=0;T!==t.uniqueAxes.length;T++){if(r.vmult(t.uniqueAxes[T],l),!1===(w=S.testSepAxis(l,t,e,n,i,r)))return!1;w<x&&(x=w,o.copy(l))}else{var C=s?s.length:t.faces.length;for(T=0;T<C;T++){var w;if(E=s?s[T]:T,l.copy(t.faceNormals[E]),r.vmult(l,l),!1===(w=S.testSepAxis(l,t,e,n,i,r)))return!1;w<x&&(x=w,o.copy(l))}}for(var A=0;A!==S.uniqueEdges.length;A++){n.vmult(S.uniqueEdges[A],v);for(var P=0;P!==t.uniqueEdges.length;P++)if(r.vmult(t.uniqueEdges[P],g),v.cross(g,y),!y.almostZero()){y.normalize();var I=S.testSepAxis(y,t,e,n,i,r);if(!1===I)return!1;I<x&&(x=I,o.copy(y))}}return i.vsub(e,m),m.dot(o)>0&&o.negate(o),!0};var m=[],v=[];o.prototype.testSepAxis=function(t,e,n,i,r,a){var s=this;o.project(s,t,n,i,m),o.project(e,t,r,a,v);var c=m[0],l=m[1],u=v[0],h=v[1];if(c<h||u<l)return!1;var f=c-h,p=u-l;return f<p?f:p};var g=new i,y=new i;o.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(g,y);var n=y.x-g.x,i=y.y-g.y,r=y.z-g.z;e.x=1/12*t*(4*i*i+4*r*r),e.y=1/12*t*(4*n*n+4*r*r),e.z=1/12*t*(4*i*i+4*n*n)},o.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],n=this.faceNormals[t],i=this.vertices[e[0]];return-n.dot(i)};var x=new i,S=new i,b=new i,T=new i,E=new i,C=new i,w=new i,A=new i;o.prototype.clipFaceAgainstHull=function(t,e,n,i,r,o,a){for(var s=x,c=S,l=b,u=T,h=E,f=C,p=w,_=A,d=this,m=i,v=[],g=-1,y=Number.MAX_VALUE,P=0;P<d.faces.length;P++){s.copy(d.faceNormals[P]),n.vmult(s,s);var I=s.dot(t);I<y&&(y=I,g=P)}if(!(g<0)){var R=d.faces[g];R.connectedFaces=[];for(var D=0;D<d.faces.length;D++)for(var O=0;O<d.faces[D].length;O++)-1!==R.indexOf(d.faces[D][O])&&D!==g&&-1===R.connectedFaces.indexOf(D)&&R.connectedFaces.push(D);m.length;for(var M=R.length,N=0;N<M;N++){var L=d.vertices[R[N]],B=d.vertices[R[(N+1)%M]];L.vsub(B,c),l.copy(c),n.vmult(l,l),e.vadd(l,l),u.copy(this.faceNormals[g]),n.vmult(u,u),e.vadd(u,u),l.cross(u,h),h.negate(h),f.copy(L),n.vmult(f,f),e.vadd(f,f),f.dot(h);var F=R.connectedFaces[N];p.copy(this.faceNormals[F]);var z=this.getPlaneConstantOfFace(F);_.copy(p),n.vmult(_,_);var U=z-_.dot(e);for(this.clipFaceAgainstPlane(m,v,_,U);m.length;)m.shift();for(;v.length;)m.push(v.shift())}for(p.copy(this.faceNormals[g]),z=this.getPlaneConstantOfFace(g),_.copy(p),n.vmult(_,_),U=z-_.dot(e),D=0;D<m.length;D++){var k=_.dot(m[D])+U;if(k<=r&&(k=r),k<=o){var G=m[D];if(k<=0){var H={point:G,normal:_,depth:k};a.push(H)}}}}},o.prototype.clipFaceAgainstPlane=function(t,e,n,r){var o,a,s=t.length;if(s<2)return e;var c=t[t.length-1],l=t[0];o=n.dot(c)+r;for(var u=0;u<s;u++){if(l=t[u],a=n.dot(l)+r,o<0)if(a<0)(h=new i).copy(l),e.push(h);else{var h=new i;c.lerp(l,o/(o-a),h),e.push(h)}else a<0&&(h=new i,c.lerp(l,o/(o-a),h),e.push(h),e.push(l));c=l,o=a}return e},o.prototype.computeWorldVertices=function(t,e){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new i);for(var r=this.vertices,o=this.worldVertices,a=0;a!==n;a++)e.vmult(r[a],o[a]),t.vadd(o[a],o[a]);this.worldVerticesNeedsUpdate=!1},new i,o.prototype.computeLocalAABB=function(t,e){var n=this.vertices.length,i=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<n;r++){var o=i[r];o.x<t.x?t.x=o.x:o.x>e.x&&(e.x=o.x),o.y<t.y?t.y=o.y:o.y>e.y&&(e.y=o.y),o.z<t.z?t.z=o.z:o.z>e.z&&(e.z=o.z)}},o.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new i);for(var n=this.faceNormals,r=this.worldFaceNormals,o=0;o!==e;o++)t.vmult(n[o],r[o]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,n=0,i=e.length;n!==i;n++){var r=e[n].norm2();r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t)};var P=new i;o.prototype.calculateWorldAABB=function(t,e,n,i){for(var r,o,a,s,c,l,u=this.vertices.length,h=this.vertices,f=0;f<u;f++){P.copy(h[f]),e.vmult(P,P),t.vadd(P,P);var p=P;(p.x<r||void 0===r)&&(r=p.x),(p.x>s||void 0===s)&&(s=p.x),(p.y<o||void 0===o)&&(o=p.y),(p.y>c||void 0===c)&&(c=p.y),(p.z<a||void 0===a)&&(a=p.z),(p.z>l||void 0===l)&&(l=p.z)}n.set(r,o,a),i.set(s,c,l)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(t){t=t||new i;for(var e=this.vertices.length,n=this.vertices,r=0;r<e;r++)t.vadd(n[r],t);return t.mult(1/e,t),t},o.prototype.transformAllPoints=function(t,e){var n=this.vertices.length,i=this.vertices;if(e){for(var r=0;r<n;r++){var o=i[r];e.vmult(o,o)}for(r=0;r<this.faceNormals.length;r++)o=this.faceNormals[r],e.vmult(o,o)}if(t)for(r=0;r<n;r++)(o=i[r]).vadd(t,o)};var I=new i,R=new i,D=new i;o.prototype.pointIsInside=function(t){var e=this.vertices.length,n=this.vertices,i=this.faces,r=this.faceNormals,o=this.faces.length,a=I;this.getAveragePointLocal(a);for(var s=0;s<o;s++){this.faces[s].length,e=r[s];var c=n[i[s][0]],l=R;t.vsub(c,l);var u=e.dot(l),h=D;a.vsub(c,h);var f=e.dot(h);if(u<0&&f>0||u>0&&f<0)return!1}return-1},new i;var O=new i,M=new i;o.project=function(t,e,n,i,o){var a=t.vertices.length,s=O,c=0,l=0,u=M,h=t.vertices;u.setZero(),r.vectorToLocalFrame(n,i,e,s),r.pointToLocalFrame(n,i,u,u);var f=u.dot(s);l=c=h[0].dot(s);for(var p=1;p<a;p++){var _=h[p].dot(s);_>c&&(c=_),_<l&&(l=_)}if((l-=f)>(c-=f)){var d=l;l=c,c=d}o[0]=c,o[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(t,e){e.exports=r,t("./Shape");var n=t("../math/Vec3"),i=(t("../math/Quaternion"),t("./ConvexPolyhedron"));function r(t,e,r,o,a){if(a){for(var s=o,c=Math.cos,l=Math.sin,u=r/2,h=[],f=[],p=[0],_=[1],d=[],m=2*Math.PI/s,v=0;v<s;v++)h.push(new n(t*c(m*v),u,t*l(m*v))),h.push(new n(t*c(m*v),-u,t*l(m*v))),v<s-1?(f.push([2*v+2,2*v+3,2*v+1,2*v]),p.push(2*v+2),_.push(2*v+3)):f.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&d.push(new n(c(m*(v+.5)),0,l(m*(v+.5))));f.push(_);var g=[];for(v=0;v<p.length;v++)g.push(p[p.length-v-1]);return f.push(g),d.push(new n(0,1,0)),void i.call(this,h,f,d)}s=o;var y=[],x=(d=[],[]),S=[],b=[];for(c=Math.cos,l=Math.sin,y.push(new n(e*c(0),e*l(0),.5*-r)),S.push(0),y.push(new n(t*c(0),t*l(0),.5*r)),b.push(1),v=0;v<s;v++){m=2*Math.PI/s*(v+1);var T=2*Math.PI/s*(v+.5);v<s-1?(y.push(new n(e*c(m),e*l(m),.5*-r)),S.push(2*v+2),y.push(new n(t*c(m),t*l(m),.5*r)),b.push(2*v+3),x.push([2*v+2,2*v+3,2*v+1,2*v])):x.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&d.push(new n(c(T),l(T),0))}for(x.push(b),d.push(new n(0,0,1)),g=[],v=0;v<S.length;v++)g.push(S[S.length-v-1]);x.push(g),i.call(this,y,x,d)}r.prototype=new i},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(t,e){var n=t("./Shape"),i=t("./ConvexPolyhedron"),r=t("../math/Vec3"),o=t("../utils/Utils");function a(t,e){e=o.defaults(e,{maxValue:null,minValue:null,elementSize:1}),this.data=t,this.maxValue=e.maxValue,this.minValue=e.minValue,this.elementSize=e.elementSize,null===e.minValue&&this.updateMinValue(),null===e.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new i,this.pillarOffset=new r,this.updateBoundingSphereRadius(),this._cachedPillars={}}e.exports=a,a.prototype=new n,a.prototype.update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var t=this.data,e=t[0][0],n=0;n!==t.length;n++)for(var i=0;i!==t[n].length;i++){var r=t[n][i];r<e&&(e=r)}this.minValue=e},a.prototype.updateMaxValue=function(){for(var t=this.data,e=t[0][0],n=0;n!==t.length;n++)for(var i=0;i!==t[n].length;i++){var r=t[n][i];r>e&&(e=r)}this.maxValue=e},a.prototype.setHeightValueAtIndex=function(t,e,n){this.data[t][e]=n,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},a.prototype.getRectMinMax=function(t,e,n,i,r){r=r||[];for(var o=this.data,a=this.minValue,s=t;s<=n;s++)for(var c=e;c<=i;c++){var l=o[s][c];l>a&&(a=l)}r[0]=this.minValue,r[1]=a},a.prototype.getIndexOfPosition=function(t,e,n,i){var r=this.elementSize,o=this.data,a=Math.floor(t/r),s=Math.floor(e/r);return n[0]=a,n[1]=s,i&&(a<0&&(a=0),s<0&&(s=0),a>=o.length-1&&(a=o.length-1),s>=o[0].length-1&&(s=o[0].length-1)),!(a<0||s<0||a>=o.length-1||s>=o[0].length-1)};var s=[],c=new r,l=new r,u=new r,h=new r;a.prototype.getTriangleAt=function(t,e,n,i,r,o){var a=s;this.getIndexOfPosition(t,e,a,n);var c=a[0],l=a[1],u=this.data;n&&(c=Math.min(u.length-2,Math.max(0,c)),l=Math.min(u[0].length-2,Math.max(0,l)));var h=this.elementSize,f=Math.pow(t/h-c,2)+Math.pow(e/h-l,2)>Math.pow(t/h-(c+1),2)+Math.pow(e/h-(l+1),2);return this.getTriangle(c,l,f,i,r,o),f};var f=new r,p=new r,_=new r,d=new r,m=new r;function v(t,e,n,i,r,o,a,s,c){c.x=((o-s)*(t-a)+(a-r)*(e-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.y=((s-i)*(t-a)+(n-a)*(e-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.z=1-c.x-c.y}a.prototype.getNormalAt=function(t,e,n,i){var r=f,o=p,a=_,s=d,c=m;this.getTriangleAt(t,e,n,r,o,a),o.vsub(r,s),a.vsub(r,c),s.cross(c,i),i.normalize()},a.prototype.getAabbAtIndex=function(t,e,n){var i=this.data,r=this.elementSize;n.lowerBound.set(t*r,e*r,i[t][e]),n.upperBound.set((t+1)*r,(e+1)*r,i[t+1][e+1])},a.prototype.getHeightAt=function(t,e,n){var i=this.data,r=l,o=u,a=h,f=s;this.getIndexOfPosition(t,e,f,n);var p=f[0],_=f[1];n&&(p=Math.min(i.length-2,Math.max(0,p)),_=Math.min(i[0].length-2,Math.max(0,_)));var d=this.getTriangleAt(t,e,n,r,o,a);v(t,e,r.x,r.y,o.x,o.y,a.x,a.y,c);var m=c;return d?i[p+1][_+1]*m.x+i[p][_+1]*m.y+i[p+1][_]*m.z:i[p][_]*m.x+i[p+1][_]*m.y+i[p][_+1]*m.z},a.prototype.getCacheConvexTrianglePillarKey=function(t,e,n){return t+"_"+e+"_"+(n?1:0)},a.prototype.getCachedConvexTrianglePillar=function(t,e,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,n)]},a.prototype.setCachedConvexTrianglePillar=function(t,e,n,i,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,n)]={convex:i,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(t,e,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,n)]},a.prototype.getTriangle=function(t,e,n,i,r,o){var a=this.data,s=this.elementSize;n?(i.set((t+1)*s,(e+1)*s,a[t+1][e+1]),r.set(t*s,(e+1)*s,a[t][e+1]),o.set((t+1)*s,e*s,a[t+1][e])):(i.set(t*s,e*s,a[t][e]),r.set((t+1)*s,e*s,a[t+1][e]),o.set(t*s,(e+1)*s,a[t][e+1]))},a.prototype.getConvexTrianglePillar=function(t,e,n){var o=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(t,e,n))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);o=new i,a=new r,this.pillarConvex=o,this.pillarOffset=a}var s=this.data,c=this.elementSize,l=o.faces;o.vertices.length=6;for(var u=0;u<6;u++)o.vertices[u]||(o.vertices[u]=new r);for(l.length=5,u=0;u<5;u++)l[u]||(l[u]=[]);var h=o.vertices,f=(Math.min(s[t][e],s[t+1][e],s[t][e+1],s[t+1][e+1])-this.minValue)/2+this.minValue;n?(a.set((t+.75)*c,(e+.75)*c,f),h[0].set(.25*c,.25*c,s[t+1][e+1]-f),h[1].set(-.75*c,.25*c,s[t][e+1]-f),h[2].set(.25*c,-.75*c,s[t+1][e]-f),h[3].set(.25*c,.25*c,-f-1),h[4].set(-.75*c,.25*c,-f-1),h[5].set(.25*c,-.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(a.set((t+.25)*c,(e+.25)*c,f),h[0].set(-.25*c,-.25*c,s[t][e]-f),h[1].set(.75*c,-.25*c,s[t+1][e]-f),h[2].set(-.25*c,.75*c,s[t][e+1]-f),h[3].set(-.25*c,-.25*c,-f-1),h[4].set(.75*c,-.25*c,-f-1),h[5].set(-.25*c,.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,n,o,a)},a.prototype.calculateLocalInertia=function(t,e){return(e=e||new r).set(0,0,0),e},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(t,e,n,i){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new r(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(t,e){var n=document.createElement("canvas");n.width=t.width,n.height=t.height;var i=n.getContext("2d");i.drawImage(t,0,0);var r=i.getImageData(0,0,t.width,t.height),o=this.data;o.length=0,this.elementSize=Math.abs(e.x)/r.width;for(var a=0;a<r.height;a++){for(var s=[],c=0;c<r.width;c++){var l=(r.data[4*(a*r.height+c)]+r.data[4*(a*r.height+c)+1]+r.data[4*(a*r.height+c)+2])/4/255*e.z;e.x<0?s.push(l):s.unshift(l)}e.y<0?o.unshift(s):o.push(s)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(t,e){e.exports=r;var n=t("./Shape"),i=t("../math/Vec3");function r(){n.call(this,{type:n.types.PARTICLE})}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(t,e){return(e=e||new i).set(0,0,0),e},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(t,e,n,i){n.copy(t),i.copy(t)}},{"../math/Vec3":31,"./Shape":44}],43:[function(t,e){e.exports=r;var n=t("./Shape"),i=t("../math/Vec3");function r(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new i,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new n,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(t,e){return e||new i},r.prototype.volume=function(){return Number.MAX_VALUE};var o=new i;r.prototype.calculateWorldAABB=function(t,e,n,i){o.set(0,0,1),e.vmult(o,o);var r=Number.MAX_VALUE;n.set(-r,-r,-r),i.set(r,r,r),1===o.x&&(i.x=t.x),1===o.y&&(i.y=t.y),1===o.z&&(i.z=t.z),-1===o.x&&(n.x=t.x),-1===o.y&&(n.y=t.y),-1===o.z&&(n.z=t.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(t,e){e.exports=i;var n=t("../utils/EventTarget"),i=t("./Shape");function i(t){t=t||{},n.apply(this),this.id=i.idCounter++,this.type=t.type||0,this.boundingSphereRadius=0,this.collisionResponse=!t.collisionResponse||t.collisionResponse,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.material=t.material?t.material:null,this.body=null}t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),i.prototype=new n,i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(t,e){e.exports=r;var n=t("./Shape"),i=t("../math/Vec3");function r(t){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==t?t:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(t,e){e=e||new i;var n=2*t*this.radius*this.radius/5;return e.x=n,e.y=n,e.z=n,e},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(t,e,n,i){for(var r=this.radius,o=["x","y","z"],a=0;a<o.length;a++){var s=o[a];n[s]=t[s]-r,i[s]=t[s]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(t,e){e.exports=s;var n=t("./Shape"),i=t("../math/Vec3"),r=(t("../math/Quaternion"),t("../math/Transform")),o=t("../collision/AABB"),a=t("../utils/Octree");function s(t,e){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new o,this.edges=null,this.scale=new i(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}s.prototype=new n,s.prototype.constructor=s;var c=new i;s.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var n=new o,r=new i,a=new i,s=new i,c=[r,a,s],l=0;l<this.indices.length/3;l++){var u=3*l;this._getUnscaledVertex(this.indices[u],r),this._getUnscaledVertex(this.indices[u+1],a),this._getUnscaledVertex(this.indices[u+2],s),n.setFromPoints(c),t.insert(n,l)}t.removeEmptyNodes()};var l=new o;s.prototype.getTrianglesInAABB=function(t,e){l.copy(t);var n=this.scale,i=n.x,r=n.y,o=n.z,a=l.lowerBound,s=l.upperBound;return a.x/=i,a.y/=r,a.z/=o,s.x/=i,s.y/=r,s.z/=o,this.tree.aabbQuery(l,e)},s.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,n=t.x===t.y===t.z;e&&n||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},s.prototype.updateNormals=function(){for(var t=c,e=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1],a=this.indices[i+2];this.getVertex(r,_),this.getVertex(o,d),this.getVertex(a,m),s.computeNormal(d,_,m,t),e[i]=t.x,e[i+1]=t.y,e[i+2]=t.z}},s.prototype.updateEdges=function(){for(var t={},e=function(){t[r<o?r+"_"+o:o+"_"+r]=!0},n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1];this.indices[i+2],e(),e(),e()}var a=Object.keys(t);for(this.edges=new Int16Array(2*a.length),n=0;n<a.length;n++){var s=a[n].split("_");this.edges[2*n]=parseInt(s[0],10),this.edges[2*n+1]=parseInt(s[1],10)}},s.prototype.getEdgeVertex=function(t,e,n){var i=this.edges[2*t+(e?1:0)];this.getVertex(i,n)};var u=new i,h=new i;s.prototype.getEdgeVector=function(t,e){var n=u,i=h;this.getEdgeVertex(t,0,n),this.getEdgeVertex(t,1,i),i.vsub(n,e)};var f=new i,p=new i;s.computeNormal=function(t,e,n,i){e.vsub(t,p),n.vsub(e,f),f.cross(p,i),i.isZero()||i.normalize()};var _=new i,d=new i,m=new i;s.prototype.getVertex=function(t,e){var n=this.scale;return this._getUnscaledVertex(t,e),e.x*=n.x,e.y*=n.y,e.z*=n.z,e},s.prototype._getUnscaledVertex=function(t,e){var n=3*t,i=this.vertices;return e.set(i[n],i[n+1],i[n+2])},s.prototype.getWorldVertex=function(t,e,n,i){return this.getVertex(t,i),r.pointToWorldFrame(e,n,i,i),i},s.prototype.getTriangleVertices=function(t,e,n,i){var r=3*t;this.getVertex(this.indices[r],e),this.getVertex(this.indices[r+1],n),this.getVertex(this.indices[r+2],i)},s.prototype.getNormal=function(t,e){var n=3*t;return e.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var v=new o;s.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(v);var n=v.upperBound.x-v.lowerBound.x,i=v.upperBound.y-v.lowerBound.y,r=v.upperBound.z-v.lowerBound.z;return e.set(1/12*t*(4*i*i+4*r*r),1/12*t*(4*n*n+4*r*r),1/12*t*(4*i*i+4*n*n))};var g=new i;s.prototype.computeLocalAABB=function(t){var e=t.lowerBound,n=t.upperBound,i=this.vertices.length/3,r=g;if(0!==i){this.getVertex(0,r),e.copy(r),n.copy(r);for(var o=0;o!==i;o++)this.getVertex(o,r),r.x<e.x?e.x=r.x:r.x>n.x&&(n.x=r.x),r.y<e.y?e.y=r.y:r.y>n.y&&(n.y=r.y),r.z<e.z?e.z=r.z:r.z>n.z&&(n.z=r.z)}},s.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},s.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,n=new i,r=0,o=e.length/3;r!==o;r++){this.getVertex(r,n);var a=n.norm2();a>t&&(t=a)}this.boundingSphereRadius=Math.sqrt(t)},new i;var y=new r,x=new o;s.prototype.calculateWorldAABB=function(t,e,n,i){var r=y,o=x;r.position=t,r.quaternion=e,this.aabb.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)},s.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},s.createTorus=function(t,e,n,i,r){t=t||1,e=e||.5,n=n||8,i=i||6,r=r||2*Math.PI;for(var o=[],a=[],c=0;c<=n;c++)for(var l=0;l<=i;l++){var u=l/i*r,h=c/n*Math.PI*2,f=(t+e*Math.cos(h))*Math.cos(u),p=(t+e*Math.cos(h))*Math.sin(u),_=e*Math.sin(h);o.push(f,p,_)}for(c=1;c<=n;c++)for(l=1;l<=i;l++){var d=(i+1)*c+l-1,m=(i+1)*(c-1)+l-1,v=(i+1)*(c-1)+l,g=(i+1)*c+l;a.push(d,m,g),a.push(m,v,g)}return new s(o,a)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(t,e){e.exports=i,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver");function i(){n.call(this),this.iterations=10,this.tolerance=1e-7}i.prototype=new n;var r=[],o=[],a=[];i.prototype.solve=function(t,e){var n,i,s,c,l,u=0,h=this.iterations,f=this.tolerance*this.tolerance,p=this.equations,_=p.length,d=e.bodies,m=d.length,v=t;if(0!==_)for(var g=0;g!==m;g++)d[g].updateSolveMassProperties();var y=o,x=a,S=r;for(y.length=_,x.length=_,S.length=_,g=0;g!==_;g++){var b=p[g];S[g]=0,x[g]=b.computeB(v),y[g]=1/b.computeC()}if(0!==_){for(g=0;g!==m;g++){var T=(w=d[g]).vlambda,E=w.wlambda;T.set(0,0,0),E.set(0,0,0)}for(u=0;u!==h;u++){c=0;for(var C=0;C!==_;C++)b=p[C],n=x[C],i=y[C],(l=S[C])+(s=i*(n-b.computeGWlambda()-b.eps*l))<b.minForce?s=b.minForce-l:l+s>b.maxForce&&(s=b.maxForce-l),S[C]+=s,c+=s>0?s:-s,b.addToWlambda(s);if(c*c<f)break}for(g=0;g!==m;g++){var w,A=(w=d[g]).velocity,P=w.angularVelocity;w.vlambda.vmul(w.linearFactor,w.vlambda),A.vadd(w.vlambda,A),w.wlambda.vmul(w.angularFactor,w.wlambda),P.vadd(w.wlambda,P)}for(var I=p.length,R=1/v;I--;)p[I].multiplier=S[I]*R}return u}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(t,e){function n(){this.equations=[]}e.exports=n,n.prototype.solve=function(){return 0},n.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},n.prototype.removeEquation=function(t){var e=this.equations,n=e.indexOf(t);-1!==n&&e.splice(n,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(t,e){e.exports=r,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver"),i=t("../objects/Body");function r(t){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new n;var o=[],a=[],s={bodies:[]},c=i.STATIC;function l(t){for(var e=t.length,n=0;n!==e;n++){var i=t[n];if(!(i.visited||i.body.type&c))return i}return!1}var u=[];function h(t,e,n,i){for(u.push(t),t.visited=!0,e(t,n,i);u.length;)for(var r,o=u.pop();r=l(o.children);)r.visited=!0,e(r,n,i),u.push(r)}function f(t,e,n){e.push(t.body);for(var i=t.eqs.length,r=0;r!==i;r++){var o=t.eqs[r];-1===n.indexOf(o)&&n.push(o)}}function p(t,e){return e.id-t.id}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(t,e){for(var n=o,i=this.nodePool,r=e.bodies,c=this.equations,u=c.length,_=r.length,d=this.subsolver;i.length<_;)i.push(this.createNode());n.length=_;for(var m=0;m<_;m++)n[m]=i[m];for(m=0;m!==_;m++){var v=n[m];v.body=r[m],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var g=0;g!==u;g++){var y=c[g],x=(m=r.indexOf(y.bi),r.indexOf(y.bj)),S=n[m],b=n[x];S.children.push(b),S.eqs.push(y),b.children.push(S),b.eqs.push(y)}var T,E=0,C=a;d.tolerance=this.tolerance,d.iterations=this.iterations;for(var w=s;T=l(n);){C.length=0,w.bodies.length=0,h(T,f,w.bodies,C);var A=C.length;for(C=C.sort(p),m=0;m!==A;m++)d.addEquation(C[m]);d.solve(t,w),d.removeAllEquations(),E++}return E}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(t,e){var n=function(){};e.exports=n,n.prototype={constructor:n,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[t]&&(n[t]=[]),-1===n[t].indexOf(e)&&n[t].push(e),this},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[t]&&-1!==n[t].indexOf(e)},hasAnyEventListener:function(t){return void 0!==this._listeners&&void 0!==this._listeners[t]},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[t])return this;var i=n[t].indexOf(e);return-1!==i&&n[t].splice(i,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var n=0,i=e.length;n<i;n++)e[n].call(this,t)}return this}}},{}],51:[function(t,e){var n=t("../collision/AABB"),i=t("../math/Vec3");function r(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new n,this.data=[],this.children=[]}function o(t,e){(e=e||{}).root=null,e.aabb=t,r.call(this,e),this.maxDepth=void 0!==e.maxDepth?e.maxDepth:8}e.exports=o,o.prototype=new r,r.prototype.reset=function(){this.children.length=this.data.length=0},r.prototype.insert=function(t,e,n){var i=this.data;if(n=n||0,!this.aabb.contains(t))return!1;var r=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var o=!1;r.length||(this.subdivide(),o=!0);for(var a=0;8!==a;a++)if(r[a].insert(t,e,n+1))return!0;o&&(r.length=0)}return i.push(e),!0};var a=new i;r.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,o=t.upperBound,s=this.children;s.push(new r({aabb:new n({lowerBound:new i(0,0,0)})}),new r({aabb:new n({lowerBound:new i(1,0,0)})}),new r({aabb:new n({lowerBound:new i(1,1,0)})}),new r({aabb:new n({lowerBound:new i(1,1,1)})}),new r({aabb:new n({lowerBound:new i(0,1,1)})}),new r({aabb:new n({lowerBound:new i(0,0,1)})}),new r({aabb:new n({lowerBound:new i(1,0,1)})}),new r({aabb:new n({lowerBound:new i(0,1,0)})})),o.vsub(e,a),a.scale(.5,a);for(var c=this.root||this,l=0;8!==l;l++){var u=s[l];u.root=c;var h=u.aabb.lowerBound;h.x*=a.x,h.y*=a.y,h.z*=a.z,h.vadd(e,h),h.vadd(a,u.aabb.upperBound)}},r.prototype.aabbQuery=function(t,e){this.data,this.children;for(var n=[this];n.length;){var i=n.pop();i.aabb.overlaps(t)&&Array.prototype.push.apply(e,i.data),Array.prototype.push.apply(n,i.children)}return e};var s=new n;r.prototype.rayQuery=function(t,e,n){return t.getAABB(s),s.toLocalFrame(e,s),this.aabbQuery(s,n),n},r.prototype.removeEmptyNodes=function(){for(var t=this.children.length-1;t>=0;t--)this.children[t].removeEmptyNodes(),this.children[t].children.length||this.children[t].data.length||this.children.splice(t,1)}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(t,e){function n(){this.objects=[],this.type=Object}e.exports=n,n.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.constructObject());return this}},{}],53:[function(t,e){function n(){this.data={keys:[]}}e.exports=n,n.prototype.get=function(t,e){if(t>e){var n=e;e=t,t=n}return this.data[t+"-"+e]},n.prototype.set=function(t,e,n){if(t>e){var i=e;e=t,t=i}var r=t+"-"+e;return this.get(t,e)||this.data.keys.push(r),this.data[r]=n,this.data[r]},n.prototype.del=function(t,e){if(t>e){var n=e;e=t,t=n}var i=t+"-"+e,r=this.data.keys.indexOf(i);return r>=0&&(this.data.keys.splice(r,1),delete this.data[i],!0)},n.prototype.reset=function(){this.data={keys:[]}},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(t){return this.data.keys[t]},n.prototype.getDataByKey=function(t){return this.data[t]}},{}],54:[function(t,e){function n(){}e.exports=n,n.defaults=function(t,e){for(var n in t=t||{},e)n in t||(t[n]=e[n]);return t}},{}],55:[function(t,e){e.exports=r;var n=t("../math/Vec3"),i=t("./Pool");function r(){i.call(this),this.type=n}r.prototype=new i,r.prototype.constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(t,e){e.exports=h;var n=t("../collision/AABB"),i=(t("../objects/Body"),t("../shapes/Shape")),r=t("../collision/Ray"),o=t("../math/Vec3"),a=t("../math/Transform"),s=(t("../shapes/ConvexPolyhedron"),t("../math/Quaternion")),c=(t("../solver/Solver"),t("../utils/Vec3Pool")),l=t("../equations/ContactEquation"),u=t("../equations/FrictionEquation");function h(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}h.prototype.createContactEquation=function(t,e,n,i,r,o){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=t,a.bj=e):a=new l(t,e),a.enabled=t.collisionResponse&&e.collisionResponse&&n.collisionResponse&&i.collisionResponse;var s=this.currentContactMaterial,c=s.contactEquationRelaxation;a.restitution=s.restitution;var u=n.material||t.material,h=i.material||e.material;if(u&&h){u.restitution>=0&&h.restitution>=0&&(a.restitution=u.restitution*h.restitution);var f=u.correctInelastic||h.correctInelastic;f&&(c*=f)}return a.setSpookParams(s.contactEquationStiffness,c,this.world.dt),a.si=r||n,a.sj=o||i,a},h.prototype.createFrictionEquationsFromContact=function(t,e){var n=t.bi,i=t.bj,r=t.si,o=t.sj,a=this.world,s=this.currentContactMaterial,c=s.friction,l=r.material||n.material,h=o.material||i.material;if(l&&h&&l.friction>=0&&h.friction>=0&&(c=l.friction*h.friction),c>0){var f=c*a.gravity.length(),p=n.invMass+i.invMass;p>0&&(p=1/p);var _=this.frictionEquationPool,d=_.length?_.pop():new u(n,i,f*p),m=_.length?_.pop():new u(n,i,f*p);return d.bi=m.bi=n,d.bj=m.bj=i,d.minForce=m.minForce=-f*p,d.maxForce=m.maxForce=f*p,d.ri.copy(t.ri),d.rj.copy(t.rj),m.ri.copy(t.ri),m.rj.copy(t.rj),t.ni.tangents(d.t,m.t),d.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),d.enabled=m.enabled=t.enabled,e.push(d,m),!0}return!1};var f=new o,p=new o,_=new o;h.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var n=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];f.setZero(),p.setZero(),_.setZero();for(var r=e.bi,o=(e.bj,0);o!==t;o++)(e=this.result[this.result.length-1-o]).bodyA!==r?(f.vadd(e.ni,f),p.vadd(e.ri,p),_.vadd(e.rj,_)):(f.vsub(e.ni,f),p.vadd(e.rj,p),_.vadd(e.ri,_));var a=1/t;p.scale(a,n.ri),_.scale(a,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),f.normalize(),f.tangents(n.t,i.t)}};var d=new o,m=new o,v=new s,g=new s;h.prototype.getContacts=function(t,e,n,i,r,o,a){this.contactPointPool=r,this.frictionEquationPool=a,this.result=i,this.frictionResult=o;for(var s=v,c=g,l=d,u=m,h=0,f=t.length;h!==f;h++){var p=t[h],_=e[h],y=null;p.material&&_.material&&(y=n.getContactMaterial(p.material,_.material)||null);for(var x=0==p.collisionResponse||0==_.collisionResponse,S=0;S<p.shapes.length;S++){p.quaternion.mult(p.shapeOrientations[S],s),p.quaternion.vmult(p.shapeOffsets[S],l),l.vadd(p.position,l);for(var b=p.shapes[S],T=0;T<_.shapes.length;T++){_.quaternion.mult(_.shapeOrientations[T],c),_.quaternion.vmult(_.shapeOffsets[T],u),u.vadd(_.position,u);var E=_.shapes[T];if(b.collisionFilterMask&E.collisionFilterGroup&&E.collisionFilterMask&b.collisionFilterGroup&&!(l.distanceTo(u)>b.boundingSphereRadius+E.boundingSphereRadius)){x|=0==b.collisionResponse||0==E.collisionResponse;var C=null;b.material&&E.material&&(C=n.getContactMaterial(b.material,E.material)||null),this.currentContactMaterial=C||y||n.defaultContactMaterial;var w=this[b.type|E.type];if(w&&(b.type<E.type?w.call(this,b,E,l,u,s,c,p,_,b,E,x):w.call(this,E,b,u,l,c,s,_,p,b,E,x))&&x){n.shapeOverlapKeeper.set(b.id,E.id),n.bodyOverlapKeeper.set(p.id,_.id);var A={si:b,sj:E};n.triggerDic.set(b.id,E.id,A),n.oldTriggerDic.set(b.id,E.id,A)}}}}}},h.prototype[i.types.BOX|i.types.BOX]=h.prototype.boxBox=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,n,i,r,o,a,s,t,e,u)},h.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=h.prototype.boxConvex=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,n,i,r,o,a,s,t,e,u)},h.prototype[i.types.BOX|i.types.PARTICLE]=h.prototype.boxParticle=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,n,i,r,o,a,s,t,e,u)},h.prototype[i.types.SPHERE]=h.prototype.sphereSphere=function(t,e,n,i,r,o,a,s,c,l,u){if(u)return n.distanceSquared(i)<Math.pow(t.radius+e.radius,2);var h=this.createContactEquation(a,s,t,e,c,l);i.vsub(n,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(t.radius,h.ri),h.rj.mult(-e.radius,h.rj),h.ri.vadd(n,h.ri),h.ri.vsub(a.position,h.ri),h.rj.vadd(i,h.rj),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var y=new o,x=new o,S=new o;h.prototype[i.types.PLANE|i.types.TRIMESH]=h.prototype.planeTrimesh=function(t,e,n,i,r,s,c,l,u,h,f){var p=new o,_=y;_.set(0,0,1),r.vmult(_,_);for(var d=0;d<e.vertices.length/3;d++){e.getVertex(d,p);var m=new o;m.copy(p),a.pointToWorldFrame(i,s,m,p);var v=x;if(p.vsub(n,v),_.dot(v)<=0){if(f)return!0;var g=this.createContactEquation(c,l,t,e,u,h);g.ni.copy(_);var b=S;_.scale(v.dot(_),b),p.vsub(b,b),g.ri.copy(b),g.ri.vsub(c.position,g.ri),g.rj.copy(p),g.rj.vsub(l.position,g.rj),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}}};var b=new o,T=new o,E=(new o,new o),C=new o,w=new o,A=new o,P=new o,I=new o,R=new o,D=new o,O=new o,M=new o,N=new o,L=new n,B=[];h.prototype[i.types.SPHERE|i.types.TRIMESH]=h.prototype.sphereTrimesh=function(t,e,n,i,o,s,c,l,u,h,f){var p=w,_=A,d=P,m=I,v=R,g=D,y=L,x=C,S=T,F=B;a.pointToLocalFrame(i,s,n,v);var z=t.radius;y.lowerBound.set(v.x-z,v.y-z,v.z-z),y.upperBound.set(v.x+z,v.y+z,v.z+z),e.getTrianglesInAABB(y,F);for(var U=E,k=t.radius*t.radius,G=0;G<F.length;G++)for(var H=0;H<3;H++)if(e.getVertex(e.indices[3*F[G]+H],U),U.vsub(v,S),S.norm2()<=k){if(x.copy(U),a.pointToWorldFrame(i,s,x,U),U.vsub(n,S),f)return!0;(W=this.createContactEquation(c,l,t,e,u,h)).ni.copy(S),W.ni.normalize(),W.ri.copy(W.ni),W.ri.scale(t.radius,W.ri),W.ri.vadd(n,W.ri),W.ri.vsub(c.position,W.ri),W.rj.copy(U),W.rj.vsub(l.position,W.rj),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}for(G=0;G<F.length;G++)for(H=0;H<3;H++){e.getVertex(e.indices[3*F[G]+H],p),e.getVertex(e.indices[3*F[G]+(H+1)%3],_),_.vsub(p,d),v.vsub(_,g);var V=g.dot(d);v.vsub(p,g);var j=g.dot(d);if(j>0&&V<0&&(v.vsub(p,g),m.copy(d),m.normalize(),j=g.dot(m),m.scale(j,g),g.vadd(p,g),(Z=g.distanceTo(v))<t.radius)){if(f)return!0;var W=this.createContactEquation(c,l,t,e,u,h);g.vsub(v,W.ni),W.ni.normalize(),W.ni.scale(t.radius,W.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,W.rj),a.vectorToWorldFrame(s,W.ni,W.ni),a.vectorToWorldFrame(s,W.ri,W.ri),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}}for(var q=O,X=M,Y=N,K=b,Q=(G=0,F.length);G!==Q;G++){e.getTriangleVertices(F[G],q,X,Y),e.getNormal(F[G],K),v.vsub(q,g);var Z=g.dot(K);if(K.scale(Z,g),v.vsub(g,g),Z=g.distanceTo(v),r.pointInTriangle(g,q,X,Y)&&Z<t.radius){if(f)return!0;W=this.createContactEquation(c,l,t,e,u,h),g.vsub(v,W.ni),W.ni.normalize(),W.ni.scale(t.radius,W.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,W.rj),a.vectorToWorldFrame(s,W.ni,W.ni),a.vectorToWorldFrame(s,W.ri,W.ri),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}}F.length=0};var F=new o,z=new o,U=new o,k=new o,G=new o;h.prototype[i.types.SPHERE|i.types.PLANE]=h.prototype.spherePlane=function(t,e,n,i,r,o,a,s,c,l,u){if(U.set(0,0,1),o.vmult(U,U),U.negate(U),U.normalize(),U.mult(t.radius,k),n.vsub(i,F),U.mult(U.dot(F),z),F.vsub(z,G),-F.dot(U)<=t.radius){if(u)return!0;var h=this.createContactEquation(a,s,t,e,c,l);h.ni.copy(U),h.ri.copy(k),h.rj.copy(G);var f=h.ri,p=h.rj;f.vadd(n,f),f.vsub(a.position,f),p.vadd(i,p),p.vsub(s.position,p),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}return!1};var H=new o,V=new o,j=new o;function W(t,e,n){for(var i=null,r=t.length,o=0;o!==r;o++){var a=t[o],s=H;t[(o+1)%r].vsub(a,s);var c=V;s.cross(e,c);var l=j;n.vsub(a,l);var u=c.dot(l);if(!(null===i||u>0&&!0===i||u<=0&&!1===i))return!1;null===i&&(i=u>0)}return!0}var q=new o,X=new o,Y=new o,K=new o,Q=[new o,new o,new o,new o,new o,new o],Z=new o,J=new o,$=new o,tt=new o;h.prototype[i.types.SPHERE|i.types.BOX]=h.prototype.sphereBox=function(t,e,n,i,r,o,a,s,c,l,u){var h=this.v3pool,f=Q;n.vsub(i,q),e.getSideNormals(f,o);for(var p=t.radius,_=!1,d=J,m=$,v=tt,g=null,y=0,x=0,S=0,b=null,T=0,E=f.length;T!==E&&!1===_;T++){var C=X;C.copy(f[T]);var w=C.norm();C.normalize();var A=q.dot(C);if(A<w+p&&A>0){var P=Y,I=K;P.copy(f[(T+1)%3]),I.copy(f[(T+2)%3]);var R=P.norm(),D=I.norm();P.normalize(),I.normalize();var O=q.dot(P),M=q.dot(I);if(O<R&&O>-R&&M<D&&M>-D){var N=Math.abs(A-w-p);if((null===b||N<b)&&(b=N,x=O,S=M,g=w,d.copy(C),m.copy(P),v.copy(I),y++,u))return!0}}}if(y){_=!0;var L=this.createContactEquation(a,s,t,e,c,l);d.mult(-p,L.ri),L.ni.copy(d),L.ni.negate(L.ni),d.mult(g,d),m.mult(x,m),d.vadd(m,d),v.mult(S,v),d.vadd(v,L.rj),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var B=h.get(),F=Z,z=0;2!==z&&!_;z++)for(var U=0;2!==U&&!_;U++)for(var k=0;2!==k&&!_;k++)if(B.set(0,0,0),z?B.vadd(f[0],B):B.vsub(f[0],B),U?B.vadd(f[1],B):B.vsub(f[1],B),k?B.vadd(f[2],B):B.vsub(f[2],B),i.vadd(B,F),F.vsub(n,F),F.norm2()<p*p){if(u)return!0;_=!0,(L=this.createContactEquation(a,s,t,e,c,l)).ri.copy(F),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(p,L.ri),L.rj.copy(B),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}h.release(B),B=null;var G=h.get(),H=h.get(),V=(L=h.get(),h.get()),j=(N=h.get(),f.length);for(z=0;z!==j&&!_;z++)for(U=0;U!==j&&!_;U++)if(z%3!=U%3){f[U].cross(f[z],G),G.normalize(),f[z].vadd(f[U],H),L.copy(n),L.vsub(H,L),L.vsub(i,L);var W=L.dot(G);for(G.mult(W,V),k=0;k===z%3||k===U%3;)k++;N.copy(n),N.vsub(V,N),N.vsub(H,N),N.vsub(i,N);var et=Math.abs(W),nt=N.norm();if(et<f[k].norm()&&nt<p){if(u)return!0;_=!0;var it=this.createContactEquation(a,s,t,e,c,l);H.vadd(V,it.rj),it.rj.copy(it.rj),N.negate(it.ni),it.ni.normalize(),it.ri.copy(it.rj),it.ri.vadd(i,it.ri),it.ri.vsub(n,it.ri),it.ri.normalize(),it.ri.mult(p,it.ri),it.ri.vadd(n,it.ri),it.ri.vsub(a.position,it.ri),it.rj.vadd(i,it.rj),it.rj.vsub(s.position,it.rj),this.result.push(it),this.createFrictionEquationsFromContact(it,this.frictionResult)}}h.release(G,H,L,V,N)};var et=new o,nt=new o,it=new o,rt=new o,ot=new o,at=new o,st=new o,ct=new o,lt=new o,ut=new o;h.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=h.prototype.sphereConvex=function(t,e,n,i,r,o,a,s,c,l,u){var h=this.v3pool;n.vsub(i,et);for(var f=e.faceNormals,p=e.faces,_=e.vertices,d=t.radius,m=0;m!==_.length;m++){var v=_[m],g=ot;o.vmult(v,g),i.vadd(g,g);var y=rt;if(g.vsub(n,y),y.norm2()<d*d)return!!u||(x=!0,(N=this.createContactEquation(a,s,t,e,c,l)).ri.copy(y),N.ri.normalize(),N.ni.copy(N.ri),N.ri.mult(d,N.ri),g.vsub(i,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),this.result.push(N),void this.createFrictionEquationsFromContact(N,this.frictionResult))}for(var x=!1,S=(m=0,p.length);m!==S&&!1===x;m++){var b=f[m],T=p[m],E=at;o.vmult(b,E);var C=st;o.vmult(_[T[0]],C),C.vadd(i,C);var w=ct;E.mult(-d,w),n.vadd(w,w);var A=lt;w.vsub(C,A);var P=A.dot(E),I=ut;if(n.vsub(C,I),P<0&&I.dot(E)>0){for(var R=[],D=0,O=T.length;D!==O;D++){var M=h.get();o.vmult(_[T[D]],M),i.vadd(M,M),R.push(M)}if(W(R,E,n)){if(u)return!0;x=!0;var N=this.createContactEquation(a,s,t,e,c,l);E.mult(-d,N.ri),E.negate(N.ni);var L=h.get();E.mult(-P,L);var B=h.get();E.mult(-d,B),n.vsub(i,N.rj),N.rj.vadd(B,N.rj),N.rj.vadd(L,N.rj),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),h.release(L),h.release(B),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),D=0;for(var F=R.length;D!==F;D++)h.release(R[D]);return}for(D=0;D!==T.length;D++){var z=h.get(),U=h.get();o.vmult(_[T[(D+1)%T.length]],z),o.vmult(_[T[(D+2)%T.length]],U),i.vadd(z,z),i.vadd(U,U);var k=nt;U.vsub(z,k);var G=it;k.unit(G);var H=h.get(),V=h.get();n.vsub(z,V);var j=V.dot(G);G.mult(j,H),H.vadd(z,H);var q=h.get();if(H.vsub(n,q),j>0&&j*j<k.norm2()&&q.norm2()<d*d){if(u)return!0;for(N=this.createContactEquation(a,s,t,e,c,l),H.vsub(i,N.rj),H.vsub(n,N.ni),N.ni.normalize(),N.ni.mult(d,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),D=0,F=R.length;D!==F;D++)h.release(R[D]);return h.release(z),h.release(U),h.release(H),h.release(q),void h.release(V)}h.release(z),h.release(U),h.release(H),h.release(q),h.release(V)}for(D=0,F=R.length;D!==F;D++)h.release(R[D])}}},new o,new o,h.prototype[i.types.PLANE|i.types.BOX]=h.prototype.planeBox=function(t,e,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,e.convexPolyhedronRepresentation.id=e.id,this.planeConvex(t,e.convexPolyhedronRepresentation,n,i,r,o,a,s,t,e,u)};var ht=new o,ft=new o,pt=new o,_t=new o;h.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=h.prototype.planeConvex=function(t,e,n,i,r,o,a,s,c,l,u){var h=ht,f=ft;f.set(0,0,1),r.vmult(f,f);for(var p=0,_=pt,d=0;d!==e.vertices.length;d++)if(h.copy(e.vertices[d]),o.vmult(h,h),i.vadd(h,h),h.vsub(n,_),f.dot(_)<=0){if(u)return!0;var m=this.createContactEquation(a,s,t,e,c,l),v=_t;f.mult(f.dot(_),v),h.vsub(v,v),v.vsub(n,m.ri),m.ni.copy(f),h.vsub(i,m.rj),m.ri.vadd(n,m.ri),m.ri.vsub(a.position,m.ri),m.rj.vadd(i,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),p++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&p&&this.createFrictionFromAverage(p)};var dt=new o,mt=new o;h.prototype[i.types.CONVEXPOLYHEDRON]=h.prototype.convexConvex=function(t,e,n,i,r,o,a,s,c,l,u,h,f){var p=dt;if(!(n.distanceTo(i)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,n,r,i,o,p,h,f)){var _=[],d=mt;t.clipAgainstHull(n,r,e,i,o,p,-100,100,_);for(var m=0,v=0;v!==_.length;v++){if(u)return!0;var g=this.createContactEquation(a,s,t,e,c,l),y=g.ri,x=g.rj;p.negate(g.ni),_[v].normal.negate(d),d.mult(_[v].depth,d),_[v].point.vadd(d,y),x.copy(_[v].point),y.vsub(n,y),x.vsub(i,x),y.vadd(n,y),y.vsub(a.position,y),x.vadd(i,x),x.vsub(s.position,x),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var vt=new o,gt=new o,yt=new o;h.prototype[i.types.PLANE|i.types.PARTICLE]=h.prototype.planeParticle=function(t,e,n,i,r,o,a,s,c,l,u){var h=vt;h.set(0,0,1),a.quaternion.vmult(h,h);var f=gt;if(i.vsub(a.position,f),h.dot(f)<=0){if(u)return!0;var p=this.createContactEquation(s,a,e,t,c,l);p.ni.copy(h),p.ni.negate(p.ni),p.ri.set(0,0,0);var _=yt;h.mult(h.dot(i),_),i.vsub(_,_),p.rj.copy(_),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}};var xt=new o;h.prototype[i.types.PARTICLE|i.types.SPHERE]=h.prototype.sphereParticle=function(t,e,n,i,r,o,a,s,c,l,u){var h=xt;if(h.set(0,0,1),i.vsub(n,h),h.norm2()<=t.radius*t.radius){if(u)return!0;var f=this.createContactEquation(s,a,e,t,c,l);h.normalize(),f.rj.copy(h),f.rj.mult(t.radius,f.rj),f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var St=new s,bt=new o,Tt=(new o,new o),Et=new o,Ct=new o;h.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=h.prototype.convexParticle=function(t,e,n,i,r,o,a,s,c,l,u){var h=-1,f=Tt,p=Ct,_=null,d=bt;if(d.copy(i),d.vsub(n,d),r.conjugate(St),St.vmult(d,d),t.pointIsInside(d)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(n,r),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(r);for(var m=0,v=t.faces.length;m!==v;m++){var g=[t.worldVertices[t.faces[m][0]]],y=t.worldFaceNormals[m];i.vsub(g[0],Et);var x=-y.dot(Et);if(null===_||Math.abs(x)<Math.abs(_)){if(u)return!0;_=x,h=m,f.copy(y)}}if(-1!==h){var S=this.createContactEquation(s,a,e,t,c,l);f.mult(_,p),p.vadd(i,p),p.vsub(n,p),S.rj.copy(p),f.negate(S.ni),S.ri.set(0,0,0);var b=S.ri,T=S.rj;b.vadd(i,b),b.vsub(s.position,b),T.vadd(n,T),T.vsub(a.position,T),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},h.prototype[i.types.BOX|i.types.HEIGHTFIELD]=h.prototype.boxHeightfield=function(t,e,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,n,i,r,o,a,s,t,e,u)};var wt=new o,At=new o,Pt=[0];h.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=h.prototype.convexHeightfield=function(t,e,n,i,r,o,s,c,l,u,h){var f=e.data,p=e.elementSize,_=t.boundingSphereRadius,d=At,m=Pt,v=wt;a.pointToLocalFrame(i,o,n,v);var g=Math.floor((v.x-_)/p)-1,y=Math.ceil((v.x+_)/p)+1,x=Math.floor((v.y-_)/p)-1,S=Math.ceil((v.y+_)/p)+1;if(!(y<0||S<0||g>f.length||x>f[0].length)){g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),S<0&&(S=0),g>=f.length&&(g=f.length-1),y>=f.length&&(y=f.length-1),S>=f[0].length&&(S=f[0].length-1),x>=f[0].length&&(x=f[0].length-1);var b=[];e.getRectMinMax(g,x,y,S,b);var T=b[0],E=b[1];if(!(v.z-_>E||v.z+_<T))for(var C=g;C<y;C++)for(var w=x;w<S;w++){var A=!1;if(e.getConvexTrianglePillar(C,w,!1),a.pointToWorldFrame(i,o,e.pillarOffset,d),n.distanceTo(d)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(A=this.convexConvex(t,e.pillarConvex,n,d,r,o,s,c,l,u,h,m,null)),h&&A)return!0;if(e.getConvexTrianglePillar(C,w,!0),a.pointToWorldFrame(i,o,e.pillarOffset,d),n.distanceTo(d)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(A=this.convexConvex(t,e.pillarConvex,n,d,r,o,s,c,l,u,h,m,null)),h&&A)return!0}}};var It=new o,Rt=new o;h.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=h.prototype.sphereHeightfield=function(t,e,n,i,r,o,s,c,l,u,h){var f=e.data,p=t.radius,_=e.elementSize,d=Rt,m=It;a.pointToLocalFrame(i,o,n,m);var v=Math.floor((m.x-p)/_)-1,g=Math.ceil((m.x+p)/_)+1,y=Math.floor((m.y-p)/_)-1,x=Math.ceil((m.y+p)/_)+1;if(!(g<0||x<0||v>f.length||y>f[0].length)){v<0&&(v=0),g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),v>=f.length&&(v=f.length-1),g>=f.length&&(g=f.length-1),x>=f[0].length&&(x=f[0].length-1),y>=f[0].length&&(y=f[0].length-1);var S=[];e.getRectMinMax(v,y,g,x,S);var b=S[0],T=S[1];if(!(m.z-p>T||m.z+p<b))for(var E=this.result,C=v;C<g;C++)for(var w=y;w<x;w++){var A=E.length,P=!1;if(e.getConvexTrianglePillar(C,w,!1),a.pointToWorldFrame(i,o,e.pillarOffset,d),n.distanceTo(d)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(P=this.sphereConvex(t,e.pillarConvex,n,d,r,o,s,c,t,e,h)),h&&P)return!0;if(e.getConvexTrianglePillar(C,w,!0),a.pointToWorldFrame(i,o,e.pillarOffset,d),n.distanceTo(d)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&(P=this.sphereConvex(t,e.pillarConvex,n,d,r,o,s,c,t,e,h)),h&&P)return!0;if(E.length-A>2)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(t,e){e.exports=g,t("../shapes/Shape");var n=t("../math/Vec3"),i=t("../math/Quaternion"),r=t("../solver/GSSolver"),o=(t("../equations/ContactEquation"),t("../equations/FrictionEquation"),t("./Narrowphase")),a=t("../utils/EventTarget"),s=t("../collision/ArrayCollisionMatrix"),c=t("../collision/ObjectCollisionMatrix"),l=t("../collision/OverlapKeeper"),u=t("../material/Material"),h=t("../material/ContactMaterial"),f=t("../objects/Body"),p=t("../utils/TupleDictionary"),_=t("../collision/RaycastResult"),d=t("../collision/AABB"),m=t("../collision/Ray"),v=t("../collision/NaiveBroadphase");function g(t){t=t||{},a.apply(this),this.dt=-1,this.allowSleep=!!t.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==t.quatNormalizeSkip?t.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==t.quatNormalizeFast&&t.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new n,t.gravity&&this.gravity.copy(t.gravity),this.broadphase=void 0!==t.broadphase?t.broadphase:new v,this.bodies=[],this.solver=void 0!==t.solver?t.solver:new r,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new s,this.collisionMatrixPrevious=new s,this.bodyOverlapKeeper=new l,this.shapeOverlapKeeper=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new p,this.defaultMaterial=new u("default"),this.defaultContactMaterial=new h(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new c,this.tm=new c,this.triggerDic=new p,this.oldTriggerDic=new p,this.contactsDic=new p,this.oldContactsDic=new p}g.idToBodyMap={},g.idToShapeMap={},g.integrateKinematic=!1,g.ccdSphereAdvance=!1,g.prototype=new a,new d;var y=new m;if(g.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},g.prototype.numObjects=function(){return this.bodies.length},g.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},g.prototype.add=g.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof f&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.cm.setNumObjects(this.bodies.length),g.idToBodyMap[t.id]=t,this.dispatchEvent(this.addBodyEvent))},g.prototype.addConstraint=function(t){this.constraints.push(t)},g.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},g.prototype.rayTest=function(t,e,n){n instanceof _?this.raycastClosest(t,e,{skipBackfaces:!0},n):this.raycastAll(t,e,{skipBackfaces:!0},n)},g.prototype.raycastAll=function(t,e,n,i){return n.mode=m.ALL,n.from=t,n.to=e,n.callback=i,y.intersectWorld(this,n)},g.prototype.raycastAny=function(t,e,n,i){return n.mode=m.ANY,n.from=t,n.to=e,n.result=i,y.intersectWorld(this,n)},g.prototype.raycastClosest=function(t,e,n,i){return n.mode=m.CLOSEST,n.from=t,n.to=e,n.result=i,y.intersectWorld(this,n)},g.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,n=this.bodies,i=n.indexOf(t);if(-1!==i){n.splice(i,1);for(var r=0;r!==n.length;r++)n[r].index=r;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,delete g.idToBodyMap[t.id],this.cm.setNumObjects(e),this.dispatchEvent(this.removeBodyEvent)}},g.prototype.removeBody=g.prototype.remove,g.prototype.getBodyById=function(t){return g.idToBodyMap[t]},g.prototype.getShapeById=function(t){return g.idToShapeMap[t]},g.prototype.addMaterial=function(t){this.materials.push(t)},g.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var x=Date.now();performance.timing&&performance.timing.navigationStart&&(x=performance.timing.navigationStart),performance.now=function(){return Date.now()-x}}g.prototype.saveKinematicAndApplyGravity=function(t){for(var e=this.bodies,n=this.bodies.length,i=0;i!==n;i++){var r=e[i];r.type===f.DYNAMIC?r.applyGravity(this.gravity):r.type===f.KINEMATIC&&r.updateKinematic(t)}},g.prototype.step=function(t,e,n){if(n=n||10,0===(e=e||0))this.saveKinematicAndApplyGravity(t),this.internalStep(t),this.time+=t,this.substeps=1;else{for(this.saveKinematicAndApplyGravity(e),this.accumulator+=e,this.substeps=0;this.accumulator>=t&&this.substeps<n;)this.internalStep(t),this.accumulator-=t,this.substeps++;for(var i=this.accumulator%t/t,r=0;r!==this.bodies.length;r++){var o=this.bodies[r];o.previousPosition.lerp(o.position,i,o.interpolatedPosition),o.previousQuaternion.slerp(o.quaternion,i,o.interpolatedQuaternion),o.previousQuaternion.normalize()}this.time+=e}this.clearForces()};var S,b,T,E,C,w,A={type:"postStep"},P={type:"preStep"},I={type:"collide",body:null,contact:null},R=[],D=[],O=[],M=[];new n,new n,new n,new n,new n,new n,new n,new n,new n,new i,new i,new i,new n,g.prototype.internalStep=function(t){this.dt=t;var e,n=this.contacts,i=O,r=M,o=this.numObjects(),a=this.bodies,s=this.solver,c=this.doProfiling,l=this.profile,u=f.DYNAMIC,h=this.constraints,p=D,_=0;c&&(e=performance.now()),_=0;for(var d=this.subsystems.length;_!==d;_++)this.subsystems[_].update();c&&(e=performance.now()),i.length=0,r.length=0,this.broadphase.collisionPairs(this,i,r),c&&(l.broadphase=performance.now()-e);var m=h.length;for(_=0;_!==m;_++)if(!(N=h[_]).collideConnected)for(var v=i.length-1;v>=0;v-=1)(N.bodyA===i[v]&&N.bodyB===r[v]||N.bodyB===i[v]&&N.bodyA===r[v])&&(i.splice(v,1),r.splice(v,1));this.collisionMatrixTick(),c&&(e=performance.now());var g=R,y=n.length;for(_=0;_!==y;_++)g.push(n[_]);n.length=0;var x=this.frictionEquations.length;for(_=0;_!==x;_++)p.push(this.frictionEquations[_]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,r,this,n,g,this.frictionEquations,p),c&&(l.narrowphase=performance.now()-e),c&&(e=performance.now()),_=0;_<this.frictionEquations.length;_++)s.addEquation(this.frictionEquations[_]);for(var S=n.length,b=0;b!==S;b++){var T=(N=n[b]).bi,E=N.bj,C=N.si,w=N.sj;C.material&&w.material?C.material.restitution>=0&&w.material.restitution>=0&&(N.restitution=C.material.restitution*w.material.restitution):T.material&&E.material&&T.material.restitution>=0&&E.material.restitution>=0&&(N.restitution=T.material.restitution*E.material.restitution),s.addEquation(N),T.allowSleep&&T.type===f.DYNAMIC&&T.sleepState===f.SLEEPING&&E.sleepState===f.AWAKE&&E.type!==f.STATIC&&E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(T._wakeUpAfterNarrowphase=!0),E.allowSleep&&E.type===f.DYNAMIC&&E.sleepState===f.SLEEPING&&T.sleepState===f.AWAKE&&T.type!==f.STATIC&&T.velocity.norm2()+T.angularVelocity.norm2()>=2*Math.pow(T.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(T,E,!0),this.collisionMatrixPrevious.get(T,E)||(I.body=E,I.contact=N,T.dispatchEvent(I),I.body=T,E.dispatchEvent(I)),this.bodyOverlapKeeper.set(T.id,E.id),this.shapeOverlapKeeper.set(C.id,w.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=performance.now()-e,e=performance.now()),_=0;_!==o;_++)(T=a[_])._wakeUpAfterNarrowphase&&(T.wakeUp(),T._wakeUpAfterNarrowphase=!1);for(m=h.length,_=0;_!==m;_++){var N;(N=h[_]).update(),v=0;for(var L=N.equations.length;v!==L;v++){var B=N.equations[v];s.addEquation(B)}}for(s.solve(t,this),c&&(l.solve=performance.now()-e),s.removeAllEquations(),this.dispatchEvent(P),_=0;_!==o;_++)(T=a[_]).preStep&&T.preStep.call(T);c&&(e=performance.now());var F=this.stepnumber%(this.quatNormalizeSkip+1)==0,z=this.quatNormalizeFast;for(_=0;_!==o;_++)a[_].integrate(t,F,z);var U=Math.pow;for(_=0;_!==o;_++)if((T=a[_]).type&u){var k=U(1-T.linearDamping,t),G=T.velocity;G.mult(k,G);var H=T.angularVelocity;if(H){var V=U(1-T.angularDamping,t);H.mult(V,H)}}for(this.broadphase.dirty=!0,c&&(l.integrate=performance.now()-e),this.time+=t,this.stepnumber+=1,this.dispatchEvent(A),_=0;_!==o;_++){var j=(T=a[_]).postStep;j&&j.call(T)}if(this.allowSleep)for(_=0;_!==o;_++)a[_].sleepTick(this.time)},g.prototype.emitContactEvents=(S=[],b=[],T={type:"beginContact",bodyA:null,bodyB:null},E={type:"endContact",bodyA:null,bodyB:null},C={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},w={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var t=this.hasAnyEventListener("beginContact"),e=this.hasAnyEventListener("endContact");if((t||e)&&this.bodyOverlapKeeper.getDiff(S,b),t){for(var n=0,i=S.length;n<i;n+=2)T.bodyA=this.getBodyById(S[n]),T.bodyB=this.getBodyById(S[n+1]),this.dispatchEvent(T);T.bodyA=T.bodyB=null}if(e){for(n=0,i=b.length;n<i;n+=2)E.bodyA=this.getBodyById(b[n]),E.bodyB=this.getBodyById(b[n+1]),this.dispatchEvent(E);E.bodyA=E.bodyB=null}S.length=b.length=0;var r=this.hasAnyEventListener("beginShapeContact"),o=this.hasAnyEventListener("endShapeContact");if((r||o)&&this.shapeOverlapKeeper.getDiff(S,b),r){for(n=0,i=S.length;n<i;n+=2){var a=this.getShapeById(S[n]),s=this.getShapeById(S[n+1]);C.shapeA=a,C.shapeB=s,C.bodyA=a.body,C.bodyB=s.body,this.dispatchEvent(C)}C.bodyA=C.bodyB=C.shapeA=C.shapeB=null}if(o){for(n=0,i=b.length;n<i;n+=2)a=this.getShapeById(b[n]),s=this.getShapeById(b[n+1]),w.shapeA=a,w.shapeB=s,w.bodyA=a.body,w.bodyB=s.body,this.dispatchEvent(w);w.bodyA=w.bodyB=w.shapeA=w.shapeB=null}}),g.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,n=0;n!==e;n++){var i=t[n];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}};var N={type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null},L={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},B=[];g.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var t,e,n=this.triggerDic.getLength();n--;)if(t=this.triggerDic.getKeyByIndex(n),null!=(e=this.triggerDic.getDataByKey(t))){var i=e.si,r=e.sj;this.tm.get(i,r)?N.event="onTriggerStay":(this.tm.set(i,r,!0),N.event="onTriggerEnter"),N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N)}for(n=this.oldTriggerDic.getLength();n>0;)n--,t=this.oldTriggerDic.getKeyByIndex(n),null==this.triggerDic.getDataByKey(t)&&null!=(e=this.oldTriggerDic.getDataByKey(t))&&(i=e.si,r=e.sj,this.tm.set(i,r,!1),this.oldTriggerDic.del(i.id,r.id)&&n--,N.event="onTriggerExit",N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N));this.triggerDic.reset()}},g.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var t,e,n=this.contacts,i=this.contacts.length;i--;){var r=(u=n[i]).si,o=u.sj,a=this.contactsDic.get(r.id,o.id);null==a&&(a=this.contactsDic.set(r.id,o.id,[])),a.push(u)}for(i=this.contactsDic.getLength();i--;)if(t=this.contactsDic.getKeyByIndex(i),null!=(e=this.contactsDic.getDataByKey(t))){r=e[0].si,o=e[0].sj;var s=r.body,c=o.body;this.cm.get(s,c)?L.event="onCollisionStay":(this.cm.set(s,c,!0),L.event="onCollisionEnter"),L.bi=s,L.contact=e[0],L.contacts=e,L.body=c,L.selfShape=r,L.otherShape=o,s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L)}var l=B;for(i=l.length;i--;){var u;r=(u=l[i]).si,o=u.sj,null==this.oldContactsDic.get(r.id,o.id)&&this.oldContactsDic.set(r.id,o.id,u)}for(i=this.oldContactsDic.getLength();i--;)t=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(t)&&(r=(e=this.oldContactsDic.getDataByKey(t)).si,o=e.sj,s=r.body,c=o.body,this.cm.get(s,c)&&(s.isSleeping()&&c.isSleeping()||(this.cm.set(s,c,!1),L.bi=s,L.contact=e,L.event="onCollisionExit",L.body=c,L.selfShape=r,L.otherShape=o,L.contacts.length=0,L.contacts.push(e),s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L))));this.contactsDic.reset(),this.oldContactsDic.reset(),R=B,B=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}(e={exports:{}}),e.exports}();function myt(t){i._global.CC_PHYSICS_BUILTIN="builtin"===t,i._global.CC_PHYSICS_CANNON="cannon.js"===t,i._global.CC_PHYSICS_AMMO="ammo.js"===t}!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(cyt||(cyt=t("ERigidBodyType",{}))),Yt(cyt),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(lyt||(lyt=t("EAxisDirection",{}))),Yt(lyt),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(uyt||(uyt={})),Yt(uyt),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(hyt||(hyt={})),Yt(hyt),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(fyt||(fyt={})),Yt(fyt),function(t){t[t.DEFAULT=1]="DEFAULT"}(pyt||(pyt={})),Yt(pyt);var vyt,gyt={id:"",switchTo:function(t){if(gyt.runInEditor){var e=gyt;if(gyt.physicsWorld&&t!==gyt.id&&null!=gyt.backend[t]?(gyt.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+gyt.id+" to "+t+"."),myt(t),e.id=t,e.wrapper=gyt.backend[t],e.physicsWorld=byt()):(console.info("[PHYSICS]: using "+t+"."),e.physicsWorld=byt()),_yt){var n=e.physicsWorld;n.setGravity(_yt.gravity),n.setAllowSleep(_yt.allowSleep),n.setDefaultMaterial(_yt.defaultMaterial)}}},register:function(t,e){if(console.info("[PHYSICS]: register "+t+"."),gyt.backend[t]=e,!gyt.physicsWorld||gyt.id===t){myt(t);var n=gyt;n.id=t,n.wrapper=e}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},yyt=function(){return 0},xyt={impl:null,setGravity:yyt,setAllowSleep:yyt,setDefaultMaterial:yyt,step:yyt,syncAfterEvents:yyt,syncSceneToPhysics:yyt,raycast:yyt,raycastClosest:yyt,emitEvents:yyt,destroy:yyt};function Syt(t,e){return null==t&&(gyt.id?_(gyt.id+" physics does not support "+vyt[e]):w(9600),!0)}function byt(){return Syt(gyt.wrapper.PhysicsWorld,vyt.World)?xyt:new gyt.wrapper.PhysicsWorld}!function(t){t[t.World=0]="World",t[t.RigidBody=1]="RigidBody",t[t.BoxCollider=2]="BoxCollider",t[t.SphereCollider=3]="SphereCollider",t[t.CapsuleCollider=4]="CapsuleCollider",t[t.MeshCollider=5]="MeshCollider",t[t.CylinderCollider=6]="CylinderCollider",t[t.ConeCollider=7]="ConeCollider",t[t.TerrainCollider=8]="TerrainCollider",t[t.SimplexCollider=9]="SimplexCollider",t[t.PlaneCollider=10]="PlaneCollider",t[t.PointToPointConstraint=11]="PointToPointConstraint",t[t.HingeConstraint=12]="HingeConstraint",t[t.ConeTwistConstraint=13]="ConeTwistConstraint"}(vyt||(vyt={}));var Tyt={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:yyt,onEnable:yyt,onDisable:yyt,onDestroy:yyt,setType:yyt,setMass:yyt,setLinearDamping:yyt,setAngularDamping:yyt,useGravity:yyt,setLinearFactor:yyt,setAngularFactor:yyt,setAllowSleep:yyt,wakeUp:yyt,sleep:yyt,clearState:yyt,clearForces:yyt,clearVelocity:yyt,setSleepThreshold:yyt,getSleepThreshold:yyt,getLinearVelocity:yyt,setLinearVelocity:yyt,getAngularVelocity:yyt,setAngularVelocity:yyt,applyForce:yyt,applyLocalForce:yyt,applyImpulse:yyt,applyLocalImpulse:yyt,applyTorque:yyt,applyLocalTorque:yyt,setGroup:yyt,getGroup:yyt,addGroup:yyt,removeGroup:yyt,setMask:yyt,getMask:yyt,addMask:yyt,removeMask:yyt,isUsingCCD:yyt,useCCD:yyt},Eyt={INITED:!1},Cyt={impl:null,collider:null,attachedRigidBody:null,initialize:yyt,onLoad:yyt,onEnable:yyt,onDisable:yyt,onDestroy:yyt,setGroup:yyt,getGroup:yyt,addGroup:yyt,removeGroup:yyt,setMask:yyt,getMask:yyt,addMask:yyt,removeMask:yyt,setMaterial:yyt,setAsTrigger:yyt,setCenter:yyt,getAABB:yyt,getBoundingSphere:yyt,updateSize:yyt,updateRadius:yyt,setRadius:yyt,setCylinderHeight:yyt,setDirection:yyt,setHeight:yyt,setShapeType:yyt,setVertices:yyt,setMesh:yyt,setTerrain:yyt,setNormal:yyt,setConstant:yyt,updateEventListener:yyt};var wyt,Ayt,Pyt,Iyt,Ryt,Dyt,Oyt,Myt,Nyt={INITED:!1},Lyt={impl:null,initialize:yyt,onLoad:yyt,onEnable:yyt,onDisable:yyt,onDestroy:yyt,setEnableCollision:yyt,setConnectedBody:yyt,setPivotA:yyt,setPivotB:yyt,setAxis:yyt};var Byt=function(e){return t({PhysicsMaterial:e,PhysicMaterial:e}),e}(ol("cc.PhysicsMaterial")((Myt=Oyt=function(t){function e(){var n;return(n=t.call(this)||this).id=void 0,q(n,"_friction",Pyt,V(n)),q(n,"_rollingFriction",Iyt,V(n)),q(n,"_spinningFriction",Ryt,V(n)),q(n,"_restitution",Dyt,V(n)),e.allMaterials.push(V(n)),n.id=e._idCounter++,n._uuid||(n._uuid="pm_"+n.id),n}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._friction=this._friction,t._restitution=this._restitution,t._rollingFriction=this._rollingFriction,t._spinningFriction=this._spinningFriction,t},n.destroy=function(){if(t.prototype.destroy.call(this)){var n=e.allMaterials.indexOf(this);return n>=0&&e.allMaterials.splice(n,1),!0}return!1},n.setValues=function(t,n,i,r){var o=this._friction!==t||this._rollingFriction!==n||this._spinningFriction!==i||this._restitution!==r;this._friction=t,this._rollingFriction=n,this._spinningFriction=i,this._restitution=r,o&&this.emit(e.EVENT_UPDATE)},L(e,[{key:"friction",get:function(){return this._friction},set:function(t){Yn(this._friction,t)||(this._friction=t,this.emit(e.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(t){Yn(this._rollingFriction,t)||(this._rollingFriction=t,this.emit(e.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(t){Yn(this._spinningFriction,t)||(this._spinningFriction=t,this.emit(e.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(t){Yn(this._restitution,t)||(this._restitution=t,this.emit(e.EVENT_UPDATE))}}]),e}(Bu),Oyt.allMaterials=[],Oyt.EVENT_UPDATE="event_update",Oyt._idCounter=0,X((Ayt=Myt).prototype,"friction",[bl],Object.getOwnPropertyDescriptor(Ayt.prototype,"friction"),Ayt.prototype),X(Ayt.prototype,"rollingFriction",[bl],Object.getOwnPropertyDescriptor(Ayt.prototype,"rollingFriction"),Ayt.prototype),X(Ayt.prototype,"spinningFriction",[bl],Object.getOwnPropertyDescriptor(Ayt.prototype,"spinningFriction"),Ayt.prototype),X(Ayt.prototype,"restitution",[bl],Object.getOwnPropertyDescriptor(Ayt.prototype,"restitution"),Ayt.prototype),Pyt=X(Ayt.prototype,"_friction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),Iyt=X(Ayt.prototype,"_rollingFriction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ryt=X(Ayt.prototype,"_spinningFriction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dyt=X(Ayt.prototype,"_restitution",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wyt=Ayt))||wyt),Fyt=t("PhysicsRayResult",function(){function t(){this._hitPoint=new vi,this._hitNormal=new vi,this._distance=0,this._collider=null}var e=t.prototype;return e._assign=function(t,e,n,i){vi.copy(this._hitPoint,t),vi.copy(this._hitNormal,i),this._distance=e,this._collider=n},e.clone=function(){var e=new t;return vi.copy(e._hitPoint,this._hitPoint),vi.copy(e._hitNormal,this._hitNormal),e._distance=this._distance,e._collider=this._collider,e},L(t,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),t}()),zyt=function(t){if(1===t){for(var e=this,n=function(t){var n="_"+(1<<t);e[n]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})},i=0;i<32;i++)n(i);this._1=pyt.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=pyt.DEFAULT}};i.internal.PhysicsGroup=pyt;var Uyt,kyt,Gyt,Hyt,Vyt,jyt,Wyt,qyt,Xyt,Yyt,Kyt,Qyt,Zyt,Jyt,$yt,txt,ext,nxt,ixt,rxt,oxt,axt,sxt,cxt,lxt,uxt,hxt,fxt,pxt,_xt,dxt,mxt,vxt,gxt,yxt,xxt,Sxt,bxt,Txt,Ext,Cxt,wxt,Axt,Pxt,Ixt=t("PhysicsSystem",function(t){function e(){var e;return(e=t.call(this)||this).raycastClosestResult=new Fyt,e.raycastResults=[],e.collisionMatrix=new zyt(1),e.minVolumeSize=1e-5,e.useNodeChains=!1,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._subStepCount=0,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._sleepThreshold=.1,e._gravity=new vi(0,-10,0),e._material=new Byt,e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},e.raycastResultPool=new Wt((function(){return new Fyt}),1),e._material.on(Byt.EVENT_UPDATE,e._updateMaterial,V(e)),e}F(e,t);var n=e.prototype;return n.postUpdate=function(t){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=t,$M.emit(JM.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}$M.emit(JM.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},n.resetConfiguration=function(t){var e=t||(ZM.config?ZM.config.physics:null);if(e){if("boolean"==typeof e.allowSleep&&(this._allowSleep=e.allowSleep),"number"==typeof e.fixedTimeStep&&(this._fixedTimeStep=e.fixedTimeStep),"number"==typeof e.maxSubSteps&&(this._maxSubSteps=e.maxSubSteps),"number"==typeof e.sleepThreshold&&(this._sleepThreshold=e.sleepThreshold),"boolean"==typeof e.autoSimulation&&(this.autoSimulation=e.autoSimulation),e.gravity&&vi.copy(this._gravity,e.gravity),e.defaultMaterial&&this._material.setValues(e.defaultMaterial.friction,e.defaultMaterial.rollingFriction,e.defaultMaterial.spinningFriction,e.defaultMaterial.restitution),e.collisionMatrix)for(var n in e.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(n))]=e.collisionMatrix[n];if(e.collisionGroups){var i=e.collisionGroups;i instanceof Array&&(i.forEach((function(t){pyt[t.name]=1<<t.index})),Yt.update(pyt))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},n.resetAccumulator=function(t){void 0===t&&(t=0),this._accumulator=t},n.step=function(t,e,n){this.physicsWorld&&this.physicsWorld.step(t,e,n)},n.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},n.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},n.raycast=function(t,e,n,i){return void 0===e&&(e=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=e>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycast(t,this.raycastOptions,this.raycastResultPool,this.raycastResults))},n.raycastClosest=function(t,e,n,i){return void 0===e&&(e=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastOptions.mask=e>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycastClosest(t,this.raycastOptions,this.raycastClosestResult))},n._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},e.constructAndRegister=function(){if(!e._instance){var t=new e;t.resetConfiguration(),function(t){if(_yt||(_yt=t),gyt.runInEditor&&!gyt.physicsWorld){console.info("[PHYSICS]: using "+gyt.id+".");var e=gyt.physicsWorld=byt();e.setGravity(_yt.gravity),e.setAllowSleep(_yt.allowSleep),e.setDefaultMaterial(_yt.defaultMaterial)}}(t),e._instance=t,$M.registerSystem(e.ID,t,t.priority)}},L(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this.physicsWorld&&this.physicsWorld.setAllowSleep(t)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(t){this._maxSubSteps=t}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},{key:"gravity",get:function(){return this._gravity},set:function(t){this._gravity.set(t),this.physicsWorld&&this.physicsWorld.setGravity(t)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(t){this._sleepThreshold=t}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(t){this._autoSimulation=t}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return gyt.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!gyt.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===gyt.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===gyt.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===gyt.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===gyt.id}},{key:"PhysicsGroup",get:function(){return pyt}},{key:"instance",get:function(){return e._instance}}]),e}(UM));Ixt.ID="PHYSICS",Ixt._instance=null,$M.once(JM.EVENT_INIT,(function(){Ixt.constructAndRegister()}));var Rxt,Dxt,Oxt,Mxt,Nxt,Lxt,Bxt,Fxt,zxt,Uxt,kxt,Gxt,Hxt,Vxt,jxt,Wxt,qxt,Xxt,Yxt,Kxt,Qxt,Zxt,Jxt=function(e){return t({RigidBody:e,RigidBodyComponent:e}),e}((Uyt=ol("cc.RigidBody"),kyt=Sl(),Gyt=vl(),Hyt=sl(-1),Vyt=kl(Ixt.PhysicsGroup),jyt=Ol(),Wyt=wl(),qyt=kl(cyt),Xyt=Ol(),Yyt=wl(),Kyt=Tl(),Qyt=Ol(),Zyt=wl(),Jyt=Tl(),$yt=Ol(),txt=wl(),ext=Tl(),nxt=Ol(),ixt=wl(),rxt=Tl(),oxt=Ol(),axt=wl(),sxt=Tl(),cxt=Ol(),lxt=wl(),uxt=Tl(),hxt=Ol(),fxt=wl(),pxt=Tl(),_xt=Ol(),dxt=wl(),Uyt(mxt=kyt(mxt=Gyt(mxt=ml(mxt=cl(mxt=Hyt((Pxt=Axt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._body=null,q(e,"_group",gxt,V(e)),q(e,"_type",yxt,V(e)),q(e,"_mass",xxt,V(e)),q(e,"_allowSleep",Sxt,V(e)),q(e,"_linearDamping",bxt,V(e)),q(e,"_angularDamping",Txt,V(e)),q(e,"_useGravity",Ext,V(e)),q(e,"_linearFactor",Cxt,V(e)),q(e,"_angularFactor",wxt,V(e)),e}F(e,t);var n=e.prototype;return n.onLoad=function(){gyt.runInEditor&&(this._body=Syt(gyt.wrapper.RigidBody,vyt.RigidBody)?Tyt:new gyt.wrapper.RigidBody,this._body.initialize(this))},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},n.applyForce=function(t,e){this._isInitialized&&this._body.applyForce(t,e)},n.applyLocalForce=function(t,e){this._isInitialized&&this._body.applyLocalForce(t,e)},n.applyImpulse=function(t,e){this._isInitialized&&this._body.applyImpulse(t,e)},n.applyLocalImpulse=function(t,e){this._isInitialized&&this._body.applyLocalImpulse(t,e)},n.applyTorque=function(t){this._isInitialized&&this._body.applyTorque(t)},n.applyLocalTorque=function(t){this._isInitialized&&this._body.applyLocalTorque(t)},n.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},n.sleep=function(){this._isInitialized&&this._body.sleep()},n.clearState=function(){this._isInitialized&&this._body.clearState()},n.clearForces=function(){this._isInitialized&&this._body.clearForces()},n.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},n.getLinearVelocity=function(t){this._isInitialized&&this._body.getLinearVelocity(t)},n.setLinearVelocity=function(t){this._isInitialized&&this._body.setLinearVelocity(t)},n.getAngularVelocity=function(t){this._isInitialized&&this._body.getAngularVelocity(t)},n.setAngularVelocity=function(t){this._isInitialized&&this._body.setAngularVelocity(t)},n.getGroup=function(){return this._isInitialized?this._body.getGroup():0},n.setGroup=function(t){this._isInitialized&&this._body.setGroup(t)},n.addGroup=function(t){this._isInitialized&&this._body.addGroup(t)},n.removeGroup=function(t){this._isInitialized&&this._body.removeGroup(t)},n.getMask=function(){return this._isInitialized?this._body.getMask():0},n.setMask=function(t){this._isInitialized&&this._body.setMask(t)},n.addMask=function(t){this._isInitialized&&this._body.addMask(t)},n.removeMask=function(t){this._isInitialized&&this._body.removeMask(t)},L(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t,this._body&&this._body.getGroup()!==t&&this._body.setGroup(t)}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._body&&this._body.setType(t))}},{key:"mass",get:function(){return this._mass},set:function(t){this._mass!==t&&(t=t<=0?1e-4:t,this._mass=t,this._body&&this._body.setMass(t))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}},{key:"useGravity",get:function(){return this._useGravity},set:function(t){this._useGravity=t,this._body&&this._body.useGravity(t)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(t){vi.copy(this._linearFactor,t),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(t){vi.copy(this._angularFactor,t),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(t){this._isInitialized&&this._body.setSleepThreshold(t)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(t){this._isInitialized&&this._body.useCCD(t)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===cyt.STATIC},set:function(t){t&&this.isStatic||!t&&!this.isStatic||(this.type=t?cyt.STATIC:cyt.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===cyt.DYNAMIC},set:function(t){t&&this.isDynamic||!t&&!this.isDynamic||(this.type=t?cyt.DYNAMIC:cyt.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===cyt.KINEMATIC},set:function(t){t&&this.isKinematic||!t&&!this.isKinematic||(this.type=t?cyt.KINEMATIC:cyt.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var t=null===this._body;return t&&d("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!t}}]),e}(ih),Axt.Type=cyt,X((vxt=Pxt).prototype,"group",[Vyt,jyt,Wyt],Object.getOwnPropertyDescriptor(vxt.prototype,"group"),vxt.prototype),X(vxt.prototype,"type",[qyt,Xyt,Yyt],Object.getOwnPropertyDescriptor(vxt.prototype,"type"),vxt.prototype),X(vxt.prototype,"mass",[Kyt,Qyt,Zyt],Object.getOwnPropertyDescriptor(vxt.prototype,"mass"),vxt.prototype),X(vxt.prototype,"allowSleep",[Jyt,$yt,txt],Object.getOwnPropertyDescriptor(vxt.prototype,"allowSleep"),vxt.prototype),X(vxt.prototype,"linearDamping",[ext,nxt,ixt],Object.getOwnPropertyDescriptor(vxt.prototype,"linearDamping"),vxt.prototype),X(vxt.prototype,"angularDamping",[rxt,oxt,axt],Object.getOwnPropertyDescriptor(vxt.prototype,"angularDamping"),vxt.prototype),X(vxt.prototype,"useGravity",[sxt,cxt,lxt],Object.getOwnPropertyDescriptor(vxt.prototype,"useGravity"),vxt.prototype),X(vxt.prototype,"linearFactor",[uxt,hxt,fxt],Object.getOwnPropertyDescriptor(vxt.prototype,"linearFactor"),vxt.prototype),X(vxt.prototype,"angularFactor",[pxt,_xt,dxt],Object.getOwnPropertyDescriptor(vxt.prototype,"angularFactor"),vxt.prototype),gxt=X(vxt.prototype,"_group",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ixt.PhysicsGroup.DEFAULT}}),yxt=X(vxt.prototype,"_type",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cyt.DYNAMIC}}),xxt=X(vxt.prototype,"_mass",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Sxt=X(vxt.prototype,"_allowSleep",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bxt=X(vxt.prototype,"_linearDamping",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Txt=X(vxt.prototype,"_angularDamping",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Ext=X(vxt.prototype,"_useGravity",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cxt=X(vxt.prototype,"_linearFactor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(1,1,1)}}),wxt=X(vxt.prototype,"_angularFactor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(1,1,1)}}),mxt=vxt))||mxt)||mxt)||mxt)||mxt)||mxt)||mxt));Jxt||(Jxt=function(e){return t({RigidBody:e,RigidBodyComponent:e}),e}({}));var $xt=function(e){return t({Collider:e,ColliderComponent:e}),e}((Rxt=ol("cc.Collider"),Dxt=kl(Jxt),Oxt=Cl(),Mxt=Ol(),Nxt=wl(),Lxt=kl(Byt),Bxt=Cl(),Fxt=Ol(),zxt=wl(),Uxt=Ol(),kxt=wl(),Gxt=kl(vi),Hxt=Ol(),Vxt=wl(),jxt=kl(Byt),Rxt((Zxt=Qxt=function(t){function e(e){var n;return(n=t.call(this)||this).type=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,q(n,"_material",Xxt,V(n)),q(n,"_isTrigger",Yxt,V(n)),q(n,"_center",Kxt,V(n)),n.type=e,n}F(e,t);var n=e.prototype;return n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return this._updateNeedEvent(e),o},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),this._updateNeedEvent()},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return this._updateNeedEvent(e),r},n.removeAll=function(e){t.prototype.removeAll.call(this,e),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(t){this._isInitialized&&this._shape.setGroup(t)},n.addGroup=function(t){this._isInitialized&&this._shape.addGroup(t)},n.removeGroup=function(t){this._isInitialized&&this._shape.removeGroup(t)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(t){this._isInitialized&&this._shape.setMask(t)},n.addMask=function(t){this._isInitialized&&this._shape.addMask(t)},n.removeMask=function(t){this._isInitialized&&this._shape.removeMask(t)},n.onLoad=function(){gyt.runInEditor&&(this.sharedMaterial=null==this._material?Ixt.instance.defaultMaterial:this._material,this._shape=function(t){return Eyt.INITED||(Eyt.INITED=!0,Eyt[hyt.BOX]=function(){return Syt(gyt.wrapper.BoxShape,vyt.BoxCollider)?Cyt:new gyt.wrapper.BoxShape},Eyt[hyt.SPHERE]=function(){return Syt(gyt.wrapper.SphereShape,vyt.SphereCollider)?Cyt:new gyt.wrapper.SphereShape},Eyt[hyt.CAPSULE]=function(){return Syt(gyt.wrapper.CapsuleShape,vyt.CapsuleCollider)?Cyt:new gyt.wrapper.CapsuleShape},Eyt[hyt.CYLINDER]=function(){return Syt(gyt.wrapper.CylinderShape,vyt.CylinderCollider)?Cyt:new gyt.wrapper.CylinderShape},Eyt[hyt.CONE]=function(){return Syt(gyt.wrapper.ConeShape,vyt.ConeCollider)?Cyt:new gyt.wrapper.ConeShape},Eyt[hyt.MESH]=function(){return Syt(gyt.wrapper.TrimeshShape,vyt.MeshCollider)?Cyt:new gyt.wrapper.TrimeshShape},Eyt[hyt.TERRAIN]=function(){return Syt(gyt.wrapper.TerrainShape,vyt.TerrainCollider)?Cyt:new gyt.wrapper.TerrainShape},Eyt[hyt.SIMPLEX]=function(){return Syt(gyt.wrapper.SimplexShape,vyt.SimplexCollider)?Cyt:new gyt.wrapper.SimplexShape},Eyt[hyt.PLANE]=function(){return Syt(gyt.wrapper.PlaneShape,vyt.PlaneCollider)?Cyt:new gyt.wrapper.PlaneShape}),Eyt[t]()}(this.type),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(Byt.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(t){this.isValid&&(void 0!==t?("onCollisionEnter"!==t&&"onCollisionStay"!==t&&"onCollisionExit"!==t||(this._needCollisionEvent=!0),"onTriggerEnter"!==t&&"onTriggerStay"!==t&&"onTriggerExit"!==t||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},L(e,[{key:"attachedRigidBody",get:function(){return t=this.node,(e=t.getComponent(Jxt))&&e.isValid?e:null;var t,e}},{key:"sharedMaterial",get:function(){return this._material},set:function(t){this.material=t}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off(Byt.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(Byt.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(t){this._shape?(t&&this._material?this._material.id!==t.id&&(this._material.off(Byt.EVENT_UPDATE,this._updateMaterial,this),t.on(Byt.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=t):t&&!this._material?(t.on(Byt.EVENT_UPDATE,this._updateMaterial,this),this._material=t):!t&&this._material&&(this._material.off(Byt.EVENT_UPDATE,this._updateMaterial,this),this._material=t),this._updateMaterial()):this._material=t}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger=t,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(t){vi.copy(this._center,t),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new Bc),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new oo),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var t=null===this._shape;return t&&d("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!t}}]),e}(on(ih)),Qxt.Type=hyt,Qxt.Axis=lyt,X((qxt=Zxt).prototype,"attachedRigidBody",[Dxt,El,Oxt,Mxt,Nxt],Object.getOwnPropertyDescriptor(qxt.prototype,"attachedRigidBody"),qxt.prototype),X(qxt.prototype,"sharedMaterial",[Lxt,Bxt,Fxt,zxt],Object.getOwnPropertyDescriptor(qxt.prototype,"sharedMaterial"),qxt.prototype),X(qxt.prototype,"isTrigger",[Uxt,kxt],Object.getOwnPropertyDescriptor(qxt.prototype,"isTrigger"),qxt.prototype),X(qxt.prototype,"center",[Gxt,Hxt,Vxt],Object.getOwnPropertyDescriptor(qxt.prototype,"center"),qxt.prototype),Xxt=X(qxt.prototype,"_material",[jxt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yxt=X(qxt.prototype,"_isTrigger",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Kxt=X(qxt.prototype,"_center",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),Wxt=qxt))||Wxt));$xt||($xt=function(e){return t({Collider:e,ColliderComponent:e}),e}({})),new vi,new vi,new vi,new vi,new vi,new vi,new vi,new vi,new vi,new vi,new vi,new vi;var tSt=new vi(0,0,0),eSt=new vi(0,0,0);function nSt(t,e){t.__cc_wrapper__=e}function iSt(t){return t.__cc_wrapper__}new vi(0,0,0),new vi(0,0,0),new vi(0,0,0),new vi(0,0,0),new vi(0,0,0),new vi(0,0,0),new vi(0,0,0),new vi(0,0,0),new vi(0,0,0);var rSt=new vi;function oSt(t){return t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z),t}var aSt,sSt,cSt,lSt,uSt,hSt,fSt,pSt,_St,dSt,mSt,vSt,gSt,ySt,xSt,SSt,bSt,TSt,ESt,CSt,wSt,ASt,PSt,ISt,RSt,DSt,OSt,MSt,NSt,LSt,BSt,FSt,zSt,USt,kSt,GSt,HSt,VSt,jSt,WSt,qSt,XSt,YSt,KSt,QSt,ZSt,JSt,$St,tbt,ebt,nbt,ibt,rbt,obt,abt,sbt,cbt,lbt,ubt,hbt,fbt,pbt,_bt,dbt,mbt,vbt,gbt,ybt,xbt,Sbt,bbt,Tbt,Ebt,Cbt,wbt,Abt,Pbt,Ibt,Rbt,Dbt,Obt,Mbt,Nbt,Lbt,Bbt,Fbt,zbt,Ubt,kbt,Gbt,Hbt,Vbt,jbt,Wbt,qbt,Xbt,Ybt,Kbt,Qbt,Zbt,Jbt,$bt,tTt,eTt,nTt,iTt,rTt,oTt,aTt,sTt,cTt,lTt,uTt,hTt,fTt,pTt,_Tt,dTt,mTt,vTt,gTt,yTt,xTt,STt,bTt,TTt,ETt,CTt,wTt=Object.freeze({__proto__:null,setWrap:nSt,getWrap:iSt,maxComponent:function(t){return Math.max(t.x,Math.max(t.y,t.z))},VEC3_0:rSt,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(t){var e=[];if(t.length>=3){e[0]=t[0],e[1]=t[1],e[2]=t[2];for(var n=t.length,i=3;i<n;i+=3){for(var r=t[i],o=t[i+1],a=t[i+2],s=e.length,c=!0,l=0;l<s;l+=3)if(Yn(r,e[l])&&Yn(o,e[l+1])&&Yn(a,e[l+2])){c=!1;break}c&&(e.push(r),e.push(o),e.push(a))}}return e},absolute:oSt,cylinder:function(t,e,n,i){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(t>0&&l++,e>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var f=new Array(h),p=new Array(3*u),_=new Array(3*u),d=new Array(2*u),m=Math.max(t,e),v=new vi(-m,-r,-m),g=new vi(m,r,m),y=Math.sqrt(m*m+r*r),x=0,S=0;return function(){for(var i=[],s=t-e,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+e,g=0;g<=o;++g){var y=g/o,b=y*c,T=Math.sin(b),E=Math.cos(b);p[3*x]=v*T,p[3*x+1]=m*n-r,p[3*x+2]=v*E,vi.normalize(tSt,vi.set(eSt,T,-l,E)),_[3*x]=tSt.x,_[3*x+1]=tSt.y,_[3*x+2]=tSt.z,d[2*x]=2*(1-y)%1,d[2*x+1]=m,h.push(x),++x}i.push(h)}for(var C=0;C<a;++C)for(var w=0;w<o;++w){var A=i[C][w],P=i[C+1][w],I=i[C+1][w+1],R=i[C][w+1];f[S]=A,++S,f[S]=R,++S,f[S]=P,++S,f[S]=R,++S,f[S]=I,++S,f[S]=P,++S}}(),s&&(e>0&&b(!1),t>0&&b(!0)),{positions:p,normals:_,uvs:d,indices:f,minPos:v,maxPos:g,boundingRadius:y};function b(n){for(var i=n?t:e,a=n?1:-1,s=x,l=1;l<=o;++l)p[3*x]=0,p[3*x+1]=r*a,p[3*x+2]=0,_[3*x]=0,_[3*x+1]=a,_[3*x+2]=0,d[2*x]=.5,d[2*x+1]=.5,++x;for(var u=x,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);p[3*x]=i*g,p[3*x+1]=r*a,p[3*x+2]=i*v,_[3*x]=0,_[3*x+1]=a,_[3*x+2]=0,d[2*x]=.5-.5*g*a,d[2*x+1]=.5+.5*v,++x}for(var y=0;y<o;++y){var b=s+y,T=u+y;n?(f[S]=T+1,++S,f[S]=b,++S,f[S]=T,++S):(f[S]=b,++S,f[S]=T+1,++S,f[S]=T,++S)}}}}),ATt=function(e){return t({BoxCollider:e,BoxColliderComponent:e}),e}((aSt=ol("cc.BoxCollider"),sSt=Sl(),cSt=vl(),lSt=kl(vi),uSt=wl(),aSt(hSt=sSt(hSt=cSt(hSt=ml((X((fSt=function(t){function e(){var e;return q(e=t.call(this,hyt.BOX)||this,"_size",pSt,V(e)),e}return F(e,t),L(e,[{key:"size",get:function(){return this._size},set:function(t){vi.strictEquals(this._size,t)||(vi.copy(this._size,t),oSt(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"size",[lSt,uSt],Object.getOwnPropertyDescriptor(fSt.prototype,"size"),fSt.prototype),pSt=X(fSt.prototype,"_size",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(1,1,1)}}),hSt=fSt))||hSt)||hSt)||hSt)||hSt)),PTt=function(e){return t({SphereCollider:e,SphereColliderComponent:e}),e}((_St=ol("cc.SphereCollider"),dSt=Sl(),mSt=vl(),vSt=wl(),_St(gSt=dSt(gSt=mSt(gSt=ml((X((ySt=function(t){function e(){var e;return q(e=t.call(this,hyt.SPHERE)||this,"_radius",xSt,V(e)),e}return F(e,t),L(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"radius",[vSt],Object.getOwnPropertyDescriptor(ySt.prototype,"radius"),ySt.prototype),xSt=X(ySt.prototype,"_radius",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),gSt=ySt))||gSt)||gSt)||gSt)||gSt)),ITt=function(e){return t({CapsuleCollider:e,CapsuleColliderComponent:e}),e}((SSt=ol("cc.CapsuleCollider"),bSt=Sl(),TSt=vl(),ESt=wl(),CSt=wl(),wSt=kl(lyt),ASt=wl(),SSt(PSt=bSt(PSt=TSt(PSt=ml((X((ISt=function(t){function e(){var e;return q(e=t.call(this,hyt.CAPSULE)||this,"_radius",RSt,V(e)),q(e,"_cylinderHeight",DSt,V(e)),q(e,"_direction",OSt,V(e)),e}F(e,t);var n=e.prototype;return n._getRadiusScale=function(){if(null==this.node)return 1;var t=this.node.worldScale;return this._direction===lyt.Y_AXIS?Math.abs(fi(t.x,t.z)):this._direction===lyt.X_AXIS?Math.abs(fi(t.y,t.z)):Math.abs(fi(t.x,t.y))},n._getHeightScale=function(){if(null==this.node)return 1;var t=this.node.worldScale;return this._direction===lyt.Y_AXIS?Math.abs(t.y):this._direction===lyt.X_AXIS?Math.abs(t.x):Math.abs(t.z)},L(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(t){this._cylinderHeight!==t&&(this._cylinderHeight=Math.abs(t),this._shape&&this.shape.setCylinderHeight(t))}},{key:"direction",get:function(){return this._direction},set:function(t){(t=Math.floor(t))<lyt.X_AXIS||t>lyt.Z_AXIS||this._direction!==t&&(this._direction=t,this._shape&&this.shape.setDirection(t))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(t){var e=t-2*this._radius;e<0&&(e=0),this.cylinderHeight=e}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"radius",[ESt],Object.getOwnPropertyDescriptor(ISt.prototype,"radius"),ISt.prototype),X(ISt.prototype,"cylinderHeight",[CSt],Object.getOwnPropertyDescriptor(ISt.prototype,"cylinderHeight"),ISt.prototype),X(ISt.prototype,"direction",[wSt,ASt],Object.getOwnPropertyDescriptor(ISt.prototype,"direction"),ISt.prototype),RSt=X(ISt.prototype,"_radius",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),DSt=X(ISt.prototype,"_cylinderHeight",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),OSt=X(ISt.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lyt.Y_AXIS}}),PSt=ISt))||PSt)||PSt)||PSt)||PSt)),RTt=function(e){return t({CylinderCollider:e,CylinderColliderComponent:e}),e}((MSt=ol("cc.CylinderCollider"),NSt=Sl(),LSt=vl(),BSt=wl(),FSt=wl(),zSt=kl(lyt),USt=wl(),MSt(kSt=NSt(kSt=LSt(kSt=ml((X((GSt=function(t){function e(){var e;return q(e=t.call(this,hyt.CYLINDER)||this,"_radius",HSt,V(e)),q(e,"_height",VSt,V(e)),q(e,"_direction",jSt,V(e)),e}return F(e,t),L(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(this._height=Math.abs(t),this._shape&&this.shape.setHeight(t))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(t<lyt.X_AXIS||t>lyt.Z_AXIS||(this._direction=t,this._shape&&this.shape.setDirection(t)))}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"radius",[BSt],Object.getOwnPropertyDescriptor(GSt.prototype,"radius"),GSt.prototype),X(GSt.prototype,"height",[FSt],Object.getOwnPropertyDescriptor(GSt.prototype,"height"),GSt.prototype),X(GSt.prototype,"direction",[zSt,USt],Object.getOwnPropertyDescriptor(GSt.prototype,"direction"),GSt.prototype),HSt=X(GSt.prototype,"_radius",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),VSt=X(GSt.prototype,"_height",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),jSt=X(GSt.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lyt.Y_AXIS}}),kSt=GSt))||kSt)||kSt)||kSt)||kSt)),DTt=t("ConeCollider",(WSt=ol("cc.ConeCollider"),qSt=Sl(),XSt=vl(),YSt=wl(),KSt=wl(),QSt=kl(lyt),ZSt=wl(),WSt(JSt=qSt(JSt=XSt(JSt=ml((X(($St=function(t){function e(){var e;return q(e=t.call(this,hyt.CONE)||this,"_radius",tbt,V(e)),q(e,"_height",ebt,V(e)),q(e,"_direction",nbt,V(e)),e}return F(e,t),L(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius!==t&&(this._radius=Math.abs(t),this._shape&&this.shape.setRadius(t))}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(t<0&&(t=0),this._height=t,this._shape&&this.shape.setHeight(t))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(t<lyt.X_AXIS||t>lyt.Z_AXIS||(this._direction=t,this._shape&&this.shape.setDirection(t)))}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"radius",[YSt],Object.getOwnPropertyDescriptor($St.prototype,"radius"),$St.prototype),X($St.prototype,"height",[KSt],Object.getOwnPropertyDescriptor($St.prototype,"height"),$St.prototype),X($St.prototype,"direction",[QSt,ZSt],Object.getOwnPropertyDescriptor($St.prototype,"direction"),$St.prototype),tbt=X($St.prototype,"_radius",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),ebt=X($St.prototype,"_height",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nbt=X($St.prototype,"_direction",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lyt.Y_AXIS}}),JSt=$St))||JSt)||JSt)||JSt)||JSt)),OTt=function(e){return t({MeshCollider:e,MeshColliderComponent:e}),e}((ibt=ol("cc.MeshCollider"),rbt=Sl(),obt=vl(),abt=kl(Att),sbt=wl(),cbt=wl(),ibt(lbt=rbt(lbt=obt(lbt=ml((X((ubt=function(t){function e(){var e;return q(e=t.call(this,hyt.MESH)||this,"_mesh",hbt,V(e)),q(e,"_convex",fbt,V(e)),e}return F(e,t),L(e,[{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh!==t&&(this._mesh=t,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(t){this._convex!==t&&(this._convex=t)}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"mesh",[abt,sbt],Object.getOwnPropertyDescriptor(ubt.prototype,"mesh"),ubt.prototype),X(ubt.prototype,"convex",[bl,cbt],Object.getOwnPropertyDescriptor(ubt.prototype,"convex"),ubt.prototype),hbt=X(ubt.prototype,"_mesh",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fbt=X(ubt.prototype,"_convex",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lbt=ubt))||lbt)||lbt)||lbt)||lbt)),MTt=t("ConstantForce",(pbt=ol("cc.ConstantForce"),_bt=Sl(),dbt=al(Jxt),mbt=vl(),vbt=Ol(),gbt=wl(),ybt=Ol(),xbt=wl(),Sbt=Ol(),bbt=wl(),Tbt=Ol(),Ebt=wl(),pbt(Cbt=_bt(Cbt=dbt(Cbt=mbt(Cbt=cl(Cbt=ml((Dbt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._rigidBody=null,q(e,"_force",Abt,V(e)),q(e,"_localForce",Pbt,V(e)),q(e,"_torque",Ibt,V(e)),q(e,"_localTorque",Rbt,V(e)),e._mask=0,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._rigidBody=this.node.getComponent(Jxt),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},n.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},n._maskUpdate=function(t,e){t.strictEquals(vi.ZERO)?this._mask&=~e:this._mask|=e},L(e,[{key:"force",get:function(){return this._force},set:function(t){vi.copy(this._force,t),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(t){vi.copy(this._localForce,t),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(t){vi.copy(this._torque,t),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(t){vi.copy(this._localTorque,t),this._maskUpdate(this._localTorque,8)}}]),e}(ih),Abt=X((wbt=Dbt).prototype,"_force",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),Pbt=X(wbt.prototype,"_localForce",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),Ibt=X(wbt.prototype,"_torque",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),Rbt=X(wbt.prototype,"_localTorque",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),X(wbt.prototype,"force",[vbt,gbt],Object.getOwnPropertyDescriptor(wbt.prototype,"force"),wbt.prototype),X(wbt.prototype,"localForce",[ybt,xbt],Object.getOwnPropertyDescriptor(wbt.prototype,"localForce"),wbt.prototype),X(wbt.prototype,"torque",[Sbt,bbt],Object.getOwnPropertyDescriptor(wbt.prototype,"torque"),wbt.prototype),X(wbt.prototype,"localTorque",[Tbt,Ebt],Object.getOwnPropertyDescriptor(wbt.prototype,"localTorque"),wbt.prototype),Cbt=wbt))||Cbt)||Cbt)||Cbt)||Cbt)||Cbt)||Cbt)),NTt=16842754,LTt=16842755,BTt=16842756,FTt=16842757,zTt=16843025,UTt=function(){function t(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}var e=t.prototype;return e.reserve=function(t){if(!(this.buffer.byteLength>t)){for(var e=this.buffer.byteLength;e<t;)e+=e;for(var n=new Uint8Array(e),i=0;i<this.length;++i)n[i]=this.buffer[i];this.buffer=n,this._buffView=new DataView(this.buffer.buffer)}},e.assign=function(t){this.buffer=t,this.length=t.length,this._seekPos=t.byteOffset,this._buffView=new DataView(t.buffer)},e.writeInt8=function(t){this.reserve(this.length+1),this._buffView.setInt8(this.length,t),this.length+=1},e.writeInt16=function(t){this.reserve(this.length+2),this._buffView.setInt16(this.length,t,!0),this.length+=2},e.writeInt32=function(t){this.reserve(this.length+4),this._buffView.setInt32(this.length,t,!0),this.length+=4},e.writeIntArray=function(t){this.reserve(this.length+4*t.length);for(var e=0;e<t.length;++e)this._buffView.setInt32(this.length+4*e,t[e],!0);this.length+=4*t.length},e.writeFloat=function(t){this.reserve(this.length+4),this._buffView.setFloat32(this.length,t,!0),this.length+=4},e.writeFloatArray=function(t){this.reserve(this.length+4*t.length);for(var e=0;e<t.length;++e)this._buffView.setFloat32(this.length+4*e,t[e],!0);this.length+=4*t.length},e.writeString=function(t){this.reserve(this.length+t.length+4),this._buffView.setInt32(this.length,t.length,!0);for(var e=0;e<t.length;++e)this._buffView.setInt8(this.length+4+e,t.charCodeAt(e));this.length+=t.length+4},e.readInt8=function(){var t=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,t},e.readInt16=function(){var t=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,t},e.readInt=function(){var t=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,t},e.readIntArray=function(t){for(var e=0;e<t.length;++e)t[e]=this._buffView.getInt32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t},e.readFloat=function(){var t=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,t},e.readFloatArray=function(t){for(var e=0;e<t.length;++e)t[e]=this._buffView.getFloat32(this._seekPos+4*e,!0);return this._seekPos+=4*t.length,t},e.readString=function(){for(var t=this.readInt(),e="",n=0;n<t;++n)e+=String.fromCharCode(this.readInt8());return e},t}(),kTt=(ol("cc.TerrainLayerInfo")((Mbt=X((Obt=function(){q(this,"slot",Mbt,this),q(this,"tileSize",Nbt,this),q(this,"detailMap",Lbt,this),q(this,"normalMap",Bbt,this),q(this,"roughness",Fbt,this),q(this,"metallic",zbt,this)}).prototype,"slot",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nbt=X(Obt.prototype,"tileSize",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Lbt=X(Obt.prototype,"detailMap",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bbt=X(Obt.prototype,"normalMap",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fbt=X(Obt.prototype,"roughness",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zbt=X(Obt.prototype,"metallic",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Obt)),ol("cc.TerrainLayerBinaryInfo")(Ubt=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||Ubt),GTt=ol("cc.TerrainAsset")((Vbt=function(t){function e(){var e;return(e=t.call(this)||this)._version=0,e._data=null,e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._layerBuffer=[-1,-1,-1,-1],e._layerBinaryInfos=[],q(e,"_layerInfos",Hbt,V(e)),e}F(e,t);var n=e.prototype;return n.getLayer=function(t,e,n){var i=4*(e*this.blockCount[0]+t)+n;return t<this.blockCount[0]&&e<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},n.getHeight=function(t,e){var n=32*this._blockCount[0]+1;return.001953125*(this._heights[e*n+t]-32768)},n.getVertexCountI=function(){return this._blockCount.length<1?0:32*this._blockCount[0]+1},n.getVertexCountJ=function(){return this._blockCount.length<2?0:32*this._blockCount[1]+1},n._setNativeData=function(t){this._data=t},n._loadNativeData=function(t){if(!t||0===t.length)return!1;var e=new UTt;if(e.assign(t),this._version=e.readInt(),this._version===zTt)return!0;if(16842753!==this._version&&this._version!==NTt&&this._version!==LTt&&this._version!==BTt&&this._version!==FTt)return!1;this.tileSize=e.readFloat(),e.readIntArray(this._blockCount),this.weightMapSize=e.readInt16(),this.lightMapSize=e.readInt16();var n=e.readInt();this.heights=new Uint16Array(n);for(var i=0;i<this.heights.length;++i)this.heights[i]=e.readInt16();var r=e.readInt();this.weights=new Uint8Array(r);for(var o=0;o<this.weights.length;++o)this.weights[o]=e.readInt8();if(this._version>=NTt){var a=e.readInt();this.layerBuffer=new Array(a);for(var s=0;s<this.layerBuffer.length;++s)this.layerBuffer[s]=e.readInt16()}if(this._version>=LTt){var c=e.readInt();this._layerBinaryInfos=new Array(c);for(var l=0;l<this._layerBinaryInfos.length;++l)this._layerBinaryInfos[l]=new kTt,this._layerBinaryInfos[l].slot=e.readInt(),this._layerBinaryInfos[l].tileSize=e.readFloat(),this._layerBinaryInfos[l].detailMapId=e.readString(),this._version>=BTt&&(this._layerBinaryInfos[l].normalMapId=e.readString(),this._layerBinaryInfos[l].roughness=e.readFloat(),this._layerBinaryInfos[l].metallic=e.readFloat())}return!0},n._exportNativeData=function(){var t=new UTt;t.writeInt32(FTt),t.writeFloat(this.tileSize),t.writeIntArray(this._blockCount),t.writeInt16(this.weightMapSize),t.writeInt16(this.lightMapSize),t.writeInt32(this.heights.length);for(var e=0;e<this.heights.length;++e)t.writeInt16(this.heights[e]);t.writeInt32(this.weights.length);for(var n=0;n<this.weights.length;++n)t.writeInt8(this.weights[n]);t.writeInt32(this.layerBuffer.length);for(var i=0;i<this.layerBuffer.length;++i)t.writeInt16(this.layerBuffer[i]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new kTt;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}t.writeInt32(r.length);for(var c=0;c<r.length;++c)t.writeInt32(r[c].slot),t.writeFloat(r[c].tileSize),t.writeString(r[c].detailMapId),t.writeString(r[c].normalMapId),t.writeFloat(r[c].roughness),t.writeFloat(r[c].metallic);return t.buffer},n._exportDefaultNativeData=function(){var t=new UTt;return t.writeInt32(zTt),t.buffer},L(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data&&this._data.byteLength===t.byteLength?this._data.set(new Uint8Array(t)):this._data=new Uint8Array(t),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(t){this._tileSize=t}},{key:"blockCount",get:function(){return this._blockCount},set:function(t){this._blockCount=t}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(t){this._lightMapSize=t}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(t){this._weightMapSize=t}},{key:"heights",get:function(){return this._heights},set:function(t){this._heights=t}},{key:"weights",get:function(){return this._weights},set:function(t){this._weights=t}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(t){this._layerBuffer=t}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(t){this._layerInfos=t}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),e}(Bu),Hbt=X((Gbt=Vbt).prototype,"_layerInfos",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kbt=Gbt))||kbt,HTt=t("TerrainCollider",(jbt=ol("cc.TerrainCollider"),Wbt=Sl(),qbt=vl(),Xbt=kl(GTt),Ybt=wl(),jbt(Kbt=Wbt(Kbt=qbt(Kbt=ml((X((Qbt=function(t){function e(){var e;return q(e=t.call(this,hyt.TERRAIN)||this,"_terrain",Zbt,V(e)),e}return F(e,t),L(e,[{key:"terrain",get:function(){return this._terrain},set:function(t){this._terrain=t,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"terrain",[Xbt,Ybt],Object.getOwnPropertyDescriptor(Qbt.prototype,"terrain"),Qbt.prototype),Zbt=X(Qbt.prototype,"_terrain",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kbt=Qbt))||Kbt)||Kbt)||Kbt)||Kbt)),VTt=t("SimplexCollider",(Jbt=ol("cc.SimplexCollider"),$bt=Sl(),tTt=vl(),eTt=kl(uyt),nTt=wl(),iTt=wl(),rTt=Tl(),oTt=wl(),aTt=Tl(),sTt=wl(),cTt=Tl(),lTt=wl(),Jbt(uTt=$bt(uTt=tTt(uTt=ml((dTt=_Tt=function(t){function e(){var e;return q(e=t.call(this,hyt.SIMPLEX)||this,"_shapeType",fTt,V(e)),q(e,"_vertices",pTt,V(e)),e}return F(e,t),e.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},L(e,[{key:"shapeType",get:function(){return this._shapeType},set:function(t){this._shapeType=t,this._shape&&this.shape.setShapeType(t)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(t){vi.copy(this._vertices[0],t),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(t){vi.copy(this._vertices[1],t),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(t){vi.copy(this._vertices[2],t),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(t){vi.copy(this._vertices[3],t),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),e}($xt),_Tt.ESimplexType=uyt,X((hTt=dTt).prototype,"shapeType",[eTt,nTt],Object.getOwnPropertyDescriptor(hTt.prototype,"shapeType"),hTt.prototype),X(hTt.prototype,"vertex0",[bl,iTt],Object.getOwnPropertyDescriptor(hTt.prototype,"vertex0"),hTt.prototype),X(hTt.prototype,"vertex1",[rTt,oTt],Object.getOwnPropertyDescriptor(hTt.prototype,"vertex1"),hTt.prototype),X(hTt.prototype,"vertex2",[aTt,sTt],Object.getOwnPropertyDescriptor(hTt.prototype,"vertex2"),hTt.prototype),X(hTt.prototype,"vertex3",[cTt,lTt],Object.getOwnPropertyDescriptor(hTt.prototype,"vertex3"),hTt.prototype),fTt=X(hTt.prototype,"_shapeType",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uyt.TETRAHEDRON}}),pTt=X(hTt.prototype,"_vertices",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new vi(0,0,0),new vi(0,0,1),new vi(1,0,0),new vi(0,1,0)]}}),uTt=hTt))||uTt)||uTt)||uTt)||uTt));VTt||(VTt=t("SimplexCollider",{}));var jTt,WTt,qTt,XTt,YTt,KTt,QTt,ZTt,JTt,$Tt,tEt,eEt,nEt,iEt,rEt,oEt,aEt,sEt,cEt,lEt,uEt,hEt,fEt,pEt,_Et,dEt,mEt,vEt,gEt=t("PlaneCollider",(mTt=ol("cc.PlaneCollider"),vTt=Sl(),gTt=vl(),yTt=kl(vi),xTt=wl(),STt=wl(),mTt(bTt=vTt(bTt=gTt(bTt=ml((X((TTt=function(t){function e(){var e;return q(e=t.call(this,hyt.PLANE)||this,"_normal",ETt,V(e)),q(e,"_constant",CTt,V(e)),e}return F(e,t),L(e,[{key:"normal",get:function(){return this._normal},set:function(t){vi.strictEquals(this._normal,t)||(vi.copy(this._normal,t),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(t){this._constant!==t&&(this._constant=t,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),e}($xt)).prototype,"normal",[yTt,xTt],Object.getOwnPropertyDescriptor(TTt.prototype,"normal"),TTt.prototype),X(TTt.prototype,"constant",[bl,STt],Object.getOwnPropertyDescriptor(TTt.prototype,"constant"),TTt.prototype),ETt=X(TTt.prototype,"_normal",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,1,0)}}),CTt=X(TTt.prototype,"_constant",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bTt=TTt))||bTt)||bTt)||bTt)||bTt)),yEt=t("Constraint",(jTt=ol("cc.Constraint"),WTt=al(Jxt),qTt=kl(Jxt),XTt=Ol(),YTt=kl(Jxt),KTt=Ol(),QTt=Ol(),ZTt=kl(Jxt),jTt(JTt=WTt((iEt=nEt=function(t){function e(e){var n;return(n=t.call(this)||this).TYPE=void 0,q(n,"_enableCollision",tEt,V(n)),q(n,"_connectedBody",eEt,V(n)),n._constraint=null,n.TYPE=e,n}F(e,t);var n=e.prototype;return n.onLoad=function(){gyt.runInEditor&&(this._constraint=function(t){return Nyt.INITED||(Nyt.INITED=!0,Nyt[fyt.POINT_TO_POINT]=function(){return Syt(gyt.wrapper.PointToPointConstraint,vyt.PointToPointConstraint)?Lyt:new gyt.wrapper.PointToPointConstraint},Nyt[fyt.HINGE]=function(){return Syt(gyt.wrapper.HingeConstraint,vyt.HingeConstraint)?Lyt:new gyt.wrapper.HingeConstraint},Nyt[fyt.CONE_TWIST]=function(){return Syt(gyt.wrapper.ConeTwistConstraint,vyt.ConeTwistConstraint)?Lyt:new gyt.wrapper.ConeTwistConstraint}),Nyt[t]()}(this.TYPE),this._constraint.initialize(this))},n.onEnable=function(){this._constraint&&this._constraint.onEnable()},n.onDisable=function(){this._constraint&&this._constraint.onDisable()},n.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},L(e,[{key:"attachedBody",get:function(){return this.getComponent(Jxt)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(t){this._connectedBody=t,this._constraint&&this._constraint.setConnectedBody(t)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(t){this._enableCollision=t,this._constraint&&this._constraint.setEnableCollision(t)}}]),e}(on(ih)),nEt.Type=fyt,X(($Tt=iEt).prototype,"attachedBody",[qTt,El,XTt],Object.getOwnPropertyDescriptor($Tt.prototype,"attachedBody"),$Tt.prototype),X($Tt.prototype,"connectedBody",[YTt,KTt],Object.getOwnPropertyDescriptor($Tt.prototype,"connectedBody"),$Tt.prototype),X($Tt.prototype,"enableCollision",[QTt],Object.getOwnPropertyDescriptor($Tt.prototype,"enableCollision"),$Tt.prototype),tEt=X($Tt.prototype,"_enableCollision",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eEt=X($Tt.prototype,"_connectedBody",[ZTt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JTt=$Tt))||JTt)||JTt));yEt||(yEt=t("Constraint",{}));var xEt,SEt,bEt,TEt,EEt,CEt,wEt,AEt,PEt,IEt=t("HingeConstraint",(rEt=ol("cc.HingeConstraint"),oEt=Sl(),aEt=vl(),sEt=kl(vi),cEt=kl(vi),lEt=kl(vi),uEt=fl("axisA"),hEt=fl("pivotA"),fEt=fl("pivotB"),rEt(pEt=oEt(pEt=aEt((X((_Et=function(t){function e(){var e;return q(e=t.call(this,fyt.HINGE)||this,"_axis",dEt,V(e)),q(e,"_pivotA",mEt,V(e)),q(e,"_pivotB",vEt,V(e)),e}return F(e,t),L(e,[{key:"pivotA",get:function(){return this._pivotA},set:function(t){vi.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(t){vi.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(t){vi.copy(this._axis,t),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),e}(yEt)).prototype,"pivotA",[sEt],Object.getOwnPropertyDescriptor(_Et.prototype,"pivotA"),_Et.prototype),X(_Et.prototype,"pivotB",[cEt],Object.getOwnPropertyDescriptor(_Et.prototype,"pivotB"),_Et.prototype),X(_Et.prototype,"axis",[lEt],Object.getOwnPropertyDescriptor(_Et.prototype,"axis"),_Et.prototype),dEt=X(_Et.prototype,"_axis",[hl,uEt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),mEt=X(_Et.prototype,"_pivotA",[hl,hEt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),vEt=X(_Et.prototype,"_pivotB",[hl,fEt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),pEt=_Et))||pEt)||pEt)||pEt)),REt=t("PointToPointConstraint",(xEt=ol("cc.PointToPointConstraint"),SEt=Sl(),bEt=vl(),TEt=kl(vi),EEt=kl(vi),xEt(CEt=SEt(CEt=bEt((X((wEt=function(t){function e(){var e;return q(e=t.call(this,fyt.POINT_TO_POINT)||this,"_pivotA",AEt,V(e)),q(e,"_pivotB",PEt,V(e)),e}return F(e,t),L(e,[{key:"pivotA",get:function(){return this._pivotA},set:function(t){vi.copy(this._pivotA,t),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(t){vi.copy(this._pivotB,t),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),e}(yEt)).prototype,"pivotA",[TEt],Object.getOwnPropertyDescriptor(wEt.prototype,"pivotA"),wEt.prototype),X(wEt.prototype,"pivotB",[EEt],Object.getOwnPropertyDescriptor(wEt.prototype,"pivotB"),wEt.prototype),AEt=X(wEt.prototype,"_pivotA",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),PEt=X(wEt.prototype,"_pivotB",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi}}),CEt=wEt))||CEt)||CEt)||CEt));i.PhysicsSystem=Ixt,i.PhysicsMaterial=Byt,i.PhysicsRayResult=Fyt,i.ConstantForce=MTt;var DEt=Object.freeze({__proto__:null,PhysicsSystem:Ixt,PhysicsRayResult:Fyt,get Collider(){return $xt},BoxCollider:ATt,SphereCollider:PTt,CapsuleCollider:ITt,MeshCollider:OTt,CylinderCollider:RTt,ConeCollider:DTt,TerrainCollider:HTt,get SimplexCollider(){return VTt},PlaneCollider:gEt,get Constraint(){return yEt},HingeConstraint:IEt,PointToPointConstraint:REt,get RigidBody(){return Jxt},PhysicsMaterial:Byt,ConstantForce:MTt,selector:gyt,utils:wTt,get ERigidBodyType(){return cyt},get EAxisDirection(){return lyt},get ESimplexType(){return uyt},get EColliderType(){return hyt},get EConstraintType(){return fyt},get PhysicsGroup(){return pyt}});t("physics",DEt);var OEt=new dyt.Vec3,MEt=new dyt.Vec3,NEt=function(){function t(){this._isEnabled=!1}var e=t.prototype;return e.setAllowSleep=function(t){this.impl.type===dyt.Body.DYNAMIC&&(this.impl.allowSleep=t,this._wakeUpIfSleep())},e.setMass=function(t){this.impl.type===dyt.Body.DYNAMIC&&(this.impl.mass=t,this.impl.updateMassProperties(),this._wakeUpIfSleep())},e.setType=function(t){switch(t){case cyt.DYNAMIC:this.impl.type=dyt.Body.DYNAMIC,this.impl.allowSleep=this._rigidBody.allowSleep,this.setMass(this._rigidBody.mass);break;case cyt.KINEMATIC:this.impl.type=dyt.Body.KINEMATIC,this.impl.mass=0,this.impl.allowSleep=!1,this.impl.sleepState=dyt.Body.AWAKE,this.impl.updateMassProperties();break;case cyt.STATIC:default:this.impl.type=dyt.Body.STATIC,this.impl.mass=0,this.impl.allowSleep=!0,this.impl.updateMassProperties(),this.clearState()}},e.setLinearDamping=function(t){this.impl.linearDamping=t},e.setAngularDamping=function(t){this.impl.angularDamping=t},e.useGravity=function(t){this.impl.useGravity=t,this._wakeUpIfSleep()},e.useCCD=function(t){this.impl.ccdSpeedThreshold=t?.01:-1},e.isUsingCCD=function(){return-1!==this.impl.ccdSpeedThreshold},e.setLinearFactor=function(t){vi.copy(this.impl.linearFactor,t),this._wakeUpIfSleep()},e.setAngularFactor=function(t){vi.copy(this.impl.angularFactor,t);var e=vi.equals(this.impl.angularFactor,vi.ZERO);e!==this.impl.fixedRotation&&(this.impl.fixedRotation=e,this.impl.updateMassProperties()),this._wakeUpIfSleep()},e.initialize=function(t){this._rigidBody=t,this._sharedBody=Ixt.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this},e.onLoad=function(){},e.onEnable=function(){this._isEnabled=!0,this.setType(this._rigidBody.type),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0},e.onDisable=function(){this._isEnabled=!1,this._sharedBody.enabled=!1},e.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},e.clearVelocity=function(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()},e.clearForces=function(){this.impl.force.setZero(),this.impl.torque.setZero()},e.clearState=function(){this.clearVelocity(),this.clearForces()},e.wakeUp=function(){return this.impl.wakeUp()},e.sleep=function(){return this.impl.sleep()},e.setSleepThreshold=function(t){this.impl.sleepSpeedLimit=t,this._wakeUpIfSleep()},e.getSleepThreshold=function(){return this.impl.sleepSpeedLimit},e.getLinearVelocity=function(t){return vi.copy(t,this.impl.velocity),t},e.setLinearVelocity=function(t){this._wakeUpIfSleep(),vi.copy(this.impl.velocity,t)},e.getAngularVelocity=function(t){return vi.copy(t,this.impl.angularVelocity),t},e.setAngularVelocity=function(t){this._wakeUpIfSleep(),vi.copy(this.impl.angularVelocity,t)},e.applyForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=vi.ZERO),this.impl.applyForce(vi.copy(OEt,t),vi.copy(MEt,e))},e.applyImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=vi.ZERO),this.impl.applyImpulse(vi.copy(OEt,t),vi.copy(MEt,e))},e.applyLocalForce=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=vi.ZERO),this.impl.applyLocalForce(vi.copy(OEt,t),vi.copy(MEt,e))},e.applyLocalImpulse=function(t,e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==e&&(e=vi.ZERO),this.impl.applyLocalImpulse(vi.copy(OEt,t),vi.copy(MEt,e))},e.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),vi.add(this.impl.torque,this.impl.torque,t)},e.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),vi.copy(OEt,t),this.impl.vectorToWorldFrame(OEt,OEt),vi.add(this.impl.torque,this.impl.torque,OEt)},e.getGroup=function(){return this.impl.collisionFilterGroup},e.setGroup=function(t){this.impl.collisionFilterGroup=t,this._wakeUpIfSleep()},e.addGroup=function(t){this.impl.collisionFilterGroup|=t,this._wakeUpIfSleep()},e.removeGroup=function(t){this.impl.collisionFilterGroup&=~t,this._wakeUpIfSleep()},e.getMask=function(){return this.impl.collisionFilterMask},e.setMask=function(t){this.impl.collisionFilterMask=t,this._wakeUpIfSleep()},e.addMask=function(t){this.impl.collisionFilterMask|=t,this._wakeUpIfSleep()},e.removeMask=function(t){this.impl.collisionFilterMask&=~t,this._wakeUpIfSleep()},e._wakeUpIfSleep=function(){this.impl.isAwake()||this.impl.wakeUp()},L(t,[{key:"isAwake",get:function(){return this.impl.isAwake()}},{key:"isSleepy",get:function(){return this.impl.isSleepy()}},{key:"isSleeping",get:function(){return this.impl.isSleeping()}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),t}();function LEt(t,e){t.checkCollisionResponse=!e.queryTrigger,t.collisionFilterGroup=-1,t.collisionFilterMask=e.mask}function BEt(t,e){t._assign(e.hitPointWorld,e.distance,iSt(e.shape).collider,e.hitNormalWorld)}function FEt(t){t.aabbNeedsUpdate=!0,t.updateMassProperties(),t.updateBoundingRadius()}var zEt={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},UEt=new dyt.Quaternion,kEt=new dyt.Vec3,GEt=new dyt.Vec3,HEt=function(){function t(){this._offset=new dyt.Vec3,this._orient=new dyt.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}var e=t.prototype;return e.updateEventListener=function(){},e.setMaterial=function(e){if(null==e)this._shape.material=null;else{null==t.idToMaterial[e.id]&&(t.idToMaterial[e.id]=new dyt.Material(e.id)),this._shape.material=t.idToMaterial[e.id];var n=this._shape.material;n.friction=e.friction,n.restitution=e.restitution;var i=dyt.CC_CONFIG.correctInelastic;n.correctInelastic=0===n.restitution?i:0}},e.setAsTrigger=function(t){this._shape.collisionResponse=!t,this._index>=0&&this._body.updateHasTrigger()},e.setCenter=function(t){this._setCenter(t),this._index>=0&&FEt(this._body)},e.setAttachedBody=function(t){if(t){if(this._sharedBody){if(this._sharedBody.wrappedBody===t.body)return;this._sharedBody.reference=!1}this._sharedBody=Ixt.instance.physicsWorld.getSharedBody(t.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=Ixt.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},e.getAABB=function(t){Ei.copy(UEt,this._collider.node.worldRotation),this._shape.calculateWorldAABB(dyt.Vec3.ZERO,UEt,kEt,GEt),vi.subtract(t.halfExtents,GEt,kEt),vi.multiplyScalar(t.halfExtents,t.halfExtents,.5),vi.add(t.center,this._collider.node.worldPosition,this._collider.center)},e.getBoundingSphere=function(t){t.radius=this._shape.boundingSphereRadius,vi.add(t.center,this._collider.node.worldPosition,this._collider.center)},e.initialize=function(t){this._collider=t,this._isBinding=!0,this._sharedBody=Ixt.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),nSt(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener)},e.onComponentSet=function(){},e.onLoad=function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},e.onEnable=function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0},e.onDisable=function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1},e.onDestroy=function(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete dyt.World.idToShapeMap[this._shape.id],this._sharedBody=null,nSt(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null},e.getGroup=function(){return this._body.collisionFilterGroup},e.setGroup=function(t){this._body.collisionFilterGroup=t,this._body.isAwake()||this._body.wakeUp()},e.addGroup=function(t){this._body.collisionFilterGroup|=t,this._body.isAwake()||this._body.wakeUp()},e.removeGroup=function(t){this._body.collisionFilterGroup&=~t,this._body.isAwake()||this._body.wakeUp()},e.getMask=function(){return this._body.collisionFilterMask},e.setMask=function(t){this._body.collisionFilterMask=t,this._body.isAwake()||this._body.wakeUp()},e.addMask=function(t){this._body.collisionFilterMask|=t,this._body.isAwake()||this._body.wakeUp()},e.removeMask=function(t){this._body.collisionFilterMask&=~t,this._body.isAwake()||this._body.wakeUp()},e.setScale=function(){this._setCenter(this._collider.center)},e.setIndex=function(t){this._index=t},e.setOffsetAndOrient=function(t,e){vi.copy(t,this._offset),Ei.copy(e,this._orient),this._offset=t,this._orient=e},e._setCenter=function(t){var e=this._offset;vi.subtract(e,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),vi.add(e,e,t),vi.multiply(e,e,this._collider.node.worldScale)},e._onTrigger=function(t){zEt.type=t.event;var e=iSt(t.selfShape),n=iSt(t.otherShape);e&&e.collider.needTriggerEvent&&(zEt.selfCollider=e.collider,zEt.otherCollider=n?n.collider:null,zEt.impl=t,this._collider.emit(zEt.type,zEt))},L(t,[{key:"impl",get:function(){return this._shape}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_body",get:function(){return this._sharedBody.body}}]),t}();HEt.idToMaterial={},Bn(Ixt,"PhysicsSystem",[{name:"ins",newName:"instance"},{name:"PHYSICS_AMMO",newName:"PHYSICS_BULLET"}]),Bn(Ixt.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),Fn(Ixt.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),Bn($xt.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),Bn($xt,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),Bn(yEt,"Constraint",[{name:"EConstraintType",newName:"Type"}]),Bn(ATt.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),Bn(PTt.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),Bn(ITt.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),Bn(Jxt.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),Bn(Jxt,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),Fn(Jxt.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),i.RigidBodyComponent=Jxt,Gt.setClassAlias(Jxt,"cc.RigidBodyComponent"),i.ColliderComponent=$xt,Gt.setClassAlias($xt,"cc.ColliderComponent"),i.BoxColliderComponent=ATt,Gt.setClassAlias(ATt,"cc.BoxColliderComponent"),i.SphereColliderComponent=PTt,Gt.setClassAlias(PTt,"cc.SphereColliderComponent"),Gt.setClassAlias(ITt,"cc.CapsuleColliderComponent"),Gt.setClassAlias(OTt,"cc.MeshColliderComponent"),Gt.setClassAlias(RTt,"cc.CylinderColliderComponent"),i.PhysicMaterial=Byt,Gt.setClassAlias(Byt,"cc.PhysicMaterial"),i.physics=DEt;var VEt=new Ei,jEt=function(){function t(t){this.impl=null,this.event=void 0,this.event=t}var e=t.prototype;return e.getLocalPointOnA=function(t){this.impl&&vi.copy(t,this.impl.rj)},e.getLocalPointOnB=function(t){this.impl&&vi.copy(t,this.impl.ri)},e.getWorldPointOnA=function(t){this.impl&&vi.add(t,this.impl.rj,this.impl.bj.position)},e.getWorldPointOnB=function(t){this.impl&&vi.add(t,this.impl.ri,this.impl.bi.position)},e.getLocalNormalOnA=function(t){this.impl&&(this.getWorldNormalOnA(t),Ei.conjugate(VEt,this.impl.bi.quaternion),vi.transformQuat(t,t,VEt))},e.getLocalNormalOnB=function(t){this.impl&&(Ei.conjugate(VEt,this.impl.bj.quaternion),vi.transformQuat(t,this.impl.ni,VEt))},e.getWorldNormalOnA=function(t){this.impl&&(this.getWorldNormalOnB(t),this.isBodyA||vi.negate(t,t))},e.getWorldNormalOnB=function(t){this.impl&&vi.copy(t,this.impl.ni)},L(t,[{key:"isBodyA",get:function(){if(this.impl){var t=this.event.selfCollider.shape.impl,e=this.impl.bj;return t.body.id===e.id}return!1}}]),t}(),WEt=new vi,qEt=new Ei,XEt=[],YEt={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},KEt=function(){function t(t,e){this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=e,this.node=t,this.body=new dyt.Body,nSt(this.body,this),this.body.collisionFilterGroup=Ixt.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=Ixt.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}t.getSharedBody=function(e,n,i){var r,o=e.uuid;if(t.sharedBodesMap.has(o))r=t.sharedBodesMap.get(o);else{r=new t(e,n);var a=pyt.DEFAULT,s=Ixt.instance.collisionMatrix[a];r.body.collisionFilterGroup=a,r.body.collisionFilterMask=s,t.sharedBodesMap.set(e.uuid,r)}if(i){r.wrappedBody=i;var c=i.rigidBody.group,l=Ixt.instance.collisionMatrix[c];r.body.collisionFilterGroup=c,r.body.collisionFilterMask=l}return r};var e=t.prototype;return e.addShape=function(t){if(this.wrappedShapes.indexOf(t)<0){var e=this.body.shapes.length;this.body.addShape(t.impl),this.wrappedShapes.push(t),t.setIndex(e);var n=this.body.shapeOffsets[e],i=this.body.shapeOrientations[e];t.setOffsetAndOrient(n,i),this.body.isSleeping()&&this.body.wakeUp()}},e.removeShape=function(t){var e=this.wrappedShapes.indexOf(t);e>=0&&(Q(this.wrappedShapes,e),this.body.removeShape(t.impl),t.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())},e.addJoint=function(t,e){e?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},e.removeJoint=function(t,e){if(e){var n=this.wrappedJoints1.indexOf(t);n>=0&&Q(this.wrappedJoints1,n)}else{var i=this.wrappedJoints0.indexOf(t);i>=0&&Q(this.wrappedJoints0,i)}},e.syncSceneToPhysics=function(){var t=this.node,e=this.body;t.hasChangedFlags&&(e.isSleeping()&&e.wakeUp(),vi.copy(e.position,t.worldPosition),Ei.copy(e.quaternion,t.worldRotation),e.aabbNeedsUpdate=!0,t.hasChangedFlags&eg.SCALE&&this.syncScale())},e.syncPhysicsToScene=function(){var t=this.node,e=this.body;e.type===cyt.DYNAMIC&&(e.isSleeping()||(vi.copy(WEt,e.position),Ei.copy(qEt,e.quaternion),t.worldPosition=WEt,t.worldRotation=qEt))},e.syncInitial=function(){var t=this.node,e=this.body;vi.copy(e.position,t.worldPosition),Ei.copy(e.quaternion,t.worldRotation),vi.copy(e.previousPosition,t.worldPosition),Ei.copy(e.previousQuaternion,t.worldRotation),e.aabbNeedsUpdate=!0,this.syncScale(),e.isSleeping()&&e.wakeUp()},e.syncScale=function(){for(var t=0;t<this.wrappedShapes.length;t++)this.wrappedShapes[t].setScale(this.node.worldScale);for(var e=0;e<this.wrappedJoints0.length;e++)this.wrappedJoints0[e].updateScale0();for(var n=0;n<this.wrappedJoints1.length;n++)this.wrappedJoints1[n].updateScale1();FEt(this.body)},e.destroy=function(){nSt(this.body,null),this.body.removeEventListener("cc-collide",this.onCollidedListener),t.sharedBodesMap.delete(this.node.uuid),delete dyt.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.wrappedShapes=null,this.wrappedJoints0=null,this.wrappedJoints1=null,this.onCollidedListener=null},e.onCollided=function(t){YEt.type=t.event;var e=iSt(t.selfShape),n=iSt(t.otherShape);if(e&&e.collider.needCollisionEvent){XEt.push.apply(XEt,YEt.contacts),YEt.contacts.length=0,YEt.impl=t,YEt.selfCollider=e.collider,YEt.otherCollider=n?n.collider:null;var i=0;if("onCollisionExit"!==YEt.type)for(i=0;i<t.contacts.length;i++){var r=t.contacts[i];if(XEt.length>0){var o=XEt.pop();o.impl=r,YEt.contacts.push(o)}else{var a=new jEt(YEt);a.impl=r,YEt.contacts.push(a)}}for(i=0;i<this.wrappedShapes.length;i++)this.wrappedShapes[i].collider.emit(YEt.type,YEt)}},L(t,[{key:"enabled",set:function(t){t?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):this.index>=0&&(0===this.wrappedShapes.length&&null==this.wrappedBody||0===this.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();KEt.sharedBodesMap=new Map;var QEt=function(){var t=e.prototype;function e(){this.bodies=[],this.constraints=[],this._world=void 0,this._world=new dyt.World,this._world.broadphase=new dyt.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}return t.setDefaultMaterial=function(t){this._world.defaultMaterial.friction=t.friction,this._world.defaultMaterial.restitution=t.restitution,null!=HEt.idToMaterial[t.id]&&(HEt.idToMaterial[t.id]=this._world.defaultMaterial)},t.setAllowSleep=function(t){this._world.allowSleep=t},t.setGravity=function(t){vi.copy(this._world.gravity,t)},t.destroy=function(){(this.constraints.length||this.bodies.length)&&d("You should destroy all physics component first."),this._world.broadphase=null,this._world=null},t.emitEvents=function(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()},t.syncSceneToPhysics=function(){for(var t=0;t<this.bodies.length;t++)this.bodies[t].syncSceneToPhysics()},t.syncAfterEvents=function(){this.syncSceneToPhysics()},t.step=function(t,e,n){if(0!==this.bodies.length){this._world.step(t,e,n);for(var i=0;i<this.bodies.length;i++)this.bodies[i].syncPhysicsToScene()}},t.raycastClosest=function(t,n,i){$Et(t,n.maxDistance),LEt(tCt,n);var r=this._world.raycastClosest(ZEt,JEt,tCt,e.rayResult);return r&&BEt(i,e.rayResult),r},t.raycast=function(t,e,n,i){return $Et(t,e.maxDistance),LEt(tCt,e),this._world.raycastAll(ZEt,JEt,tCt,(function(t){var e=n.add();BEt(e,t),i.push(e)}))},t.getSharedBody=function(t,e){return KEt.getSharedBody(t,this,e)},t.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),this._world.addBody(t.body))},t.removeSharedBody=function(t){var e=this.bodies.indexOf(t);e>=0&&(Q(this.bodies,e),this._world.remove(t.body))},t.addConstraint=function(t){this.constraints.indexOf(t)<0&&(this.constraints.push(t),this._world.addConstraint(t.impl))},t.removeConstraint=function(t){var e=this.constraints.indexOf(t);e>=0&&(Q(this.constraints,e),this._world.removeConstraint(t.impl))},L(e,[{key:"impl",get:function(){return this._world}}]),e}();QEt.rayResult=new dyt.RaycastResult;var ZEt=new dyt.Vec3,JEt=new dyt.Vec3;function $Et(t,e){vi.copy(ZEt,t.o),t.computeHit(JEt,e)}var tCt={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackfaces:!0},eCt=function(t){function e(){var e;return(e=t.call(this)||this).halfExtent=void 0,e.halfExtent=new dyt.Vec3(.5,.5,.5),e._shape=new dyt.Box(e.halfExtent.clone()),e}F(e,t);var n=e.prototype;return n.updateSize=function(){vi.multiplyScalar(this.halfExtent,this.collider.size,.5);var t=oSt(rSt.set(this.collider.node.worldScale)),e=this.halfExtent.x*t.x,n=this.halfExtent.y*t.y,i=this.halfExtent.z*t.z,r=Ixt.instance.minVolumeSize;this.impl.halfExtents.x=Qn(e,r,Number.MAX_VALUE),this.impl.halfExtents.y=Qn(n,r,Number.MAX_VALUE),this.impl.halfExtents.z=Qn(i,r,Number.MAX_VALUE),this.impl.updateConvexPolyhedronRepresentation(),-1!==this._index&&FEt(this._body)},n.onLoad=function(){t.prototype.onLoad.call(this),this.updateSize()},n.setScale=function(e){t.prototype.setScale.call(this,e),this.updateSize()},L(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(HEt),nCt=function(t){F(n,t);var e=n.prototype;function n(e){var n;return void 0===e&&(e=.5),(n=t.call(this)||this)._shape=new dyt.Sphere(e),n}return e.updateRadius=function(){var t=Math.abs(hi(this.collider.node.worldScale));this.impl.radius=Qn(this.collider.radius*Math.abs(t),Ixt.instance.minVolumeSize,Number.MAX_VALUE),this.impl.updateBoundingSphereRadius(),-1!==this._index&&FEt(this._body)},e.onLoad=function(){t.prototype.onLoad.call(this),this.updateRadius()},e.setScale=function(e){t.prototype.setScale.call(this,e),this.updateRadius()},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(HEt),iCt=new dyt.Vec3,rCt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setMesh=function(t){if(this._isBinding){var e=t;if(null!=this._shape)if(e&&e.renderingSubMeshes.length>0){var n=e.renderingSubMeshes[0].geometricInfo.positions,i=e.renderingSubMeshes[0].geometricInfo.indices;this.updateProperties(n,i)}else this.updateProperties(new Float32Array,new Uint16Array);else if(e&&e.renderingSubMeshes.length>0){var r=e.renderingSubMeshes[0].geometricInfo.positions,o=e.renderingSubMeshes[0].geometricInfo.indices;this._shape=new dyt.Trimesh(r,o)}else this._shape=new dyt.Trimesh(new Float32Array,new Uint16Array)}},n.onComponentSet=function(){this.setMesh(this.collider.mesh)},n.onLoad=function(){t.prototype.onLoad.call(this),this.setMesh(this.collider.mesh)},n.setScale=function(e){t.prototype.setScale.call(this,e),vi.copy(iCt,e),this.impl.setScale(iCt)},n.updateProperties=function(t,e){this.impl.vertices=new Float32Array(t),this.impl.indices=new Int16Array(e),this.impl.normals=new Float32Array(e.length),this.impl.aabb=new dyt.AABB,this.impl.edges=[],this.impl.tree=new dyt.Octree(new dyt.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),this._index>=0&&FEt(this._body)},L(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(HEt),oCt=function(t){F(n,t);var e=n.prototype;function n(e,n,i){var r;return void 0===e&&(e=.5),void 0===n&&(n=2),void 0===i&&(i=lyt.Y_AXIS),(r=t.call(this)||this)._shape=new dyt.Cylinder(e,e,n,dyt.CC_CONFIG.numSegmentsCylinder,i===lyt.Y_AXIS),r}return e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,dyt.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&FEt(this._body)},e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,dyt.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&FEt(this._body)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,dyt.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&FEt(this._body)},e.onLoad=function(){t.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},e.setScale=function(e){t.prototype.setScale.call(this,e),this.setRadius(this.collider.radius)},e.updateProperties=function(t,e,n,i,r){var o=e,a=t,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*e,a=u(l(r.x),l(r.z))*t):2===i?(o=l(r.z)*e,a=u(l(r.x),l(r.y))*t):(o=l(r.x)*e,a=u(l(r.y),l(r.z))*t);var h=n,f=o/2,p=[],_=[],d=[],m=2*Math.PI/h;if(1===i){for(var v=[1],g=[0],y=0;y<h;y++){var x=a*s(m*y),S=a*c(m*y);p.push(new dyt.Vec3(x,f,S)),p.push(new dyt.Vec3(x,-f,S)),y<h-1?(_.push([2*y+2,2*y+3,2*y+1,2*y]),g.push(2*y+2),v.push(2*y+3)):_.push([0,1,2*y+1,2*y]),(h%2==1||y<h/2)&&d.push(new dyt.Vec3(s(m*(y+.5)),0,c(m*(y+.5))))}_.push(v);for(var b=[],T=0;T<g.length;T++)b.push(g[g.length-T-1]);_.push(b),d.push(new dyt.Vec3(0,1,0))}else if(2===i){for(var E=[0],C=[1],w=0;w<h;w++){var A=a*s(m*w),P=a*c(m*w);p.push(new dyt.Vec3(A,P,f)),p.push(new dyt.Vec3(A,P,-f)),w<h-1?(_.push([2*w,2*w+1,2*w+3,2*w+2]),E.push(2*w+2),C.push(2*w+3)):_.push([2*w,2*w+1,0,1]),(h%2==1||w<h/2)&&d.push(new dyt.Vec3(s(m*(w+.5)),c(m*(w+.5)),0))}_.push(E);for(var I=[],R=0;R<C.length;R++)I.push(C[C.length-R-1]);_.push(I),d.push(new dyt.Vec3(0,0,1))}else{for(var D=[0],O=[1],M=0;M<h;M++){var N=a*s(m*M),L=a*c(m*M);p.push(new dyt.Vec3(f,N,L)),p.push(new dyt.Vec3(-f,N,L)),M<h-1?(_.push([2*M,2*M+1,2*M+3,2*M+2]),D.push(2*M+2),O.push(2*M+3)):_.push([2*M,2*M+1,0,1]),(h%2==1||M<h/2)&&d.push(new dyt.Vec3(0,s(m*(M+.5)),c(m*(M+.5))))}_.push(D);for(var B=[],F=0;F<O.length;F++)B.push(O[O.length-F-1]);_.push(B),d.push(new dyt.Vec3(1,0,0))}this.impl.vertices=p,this.impl.faces=_,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(HEt),aCt=new vi,sCt=new vi,cCt=function(t){F(n,t);var e=n.prototype;function n(e,n,i){var r;return void 0===e&&(e=.5),void 0===n&&(n=1),void 0===i&&(i=lyt.Y_AXIS),(r=t.call(this)||this)._shape=new dyt.Cylinder(0,e,n,dyt.CC_CONFIG.numSegmentsCone,i===lyt.Y_AXIS),r}return e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,dyt.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&FEt(this._body)},e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,dyt.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&FEt(this._body)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,dyt.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&FEt(this._body)},e.onLoad=function(){t.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},e.setScale=function(e){t.prototype.setScale.call(this,e),this.setRadius(this.collider.radius)},e.updateProperties=function(t,e,n,i,r){var o=e,a=t,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*e,a=u(l(r.x),l(r.z))*t):2===i?(o=l(r.z)*e,a=u(l(r.x),l(r.y))*t):(o=l(r.x)*e,a=u(l(r.y),l(r.z))*t);var h=n,f=o/2,p=[],_=[],d=[],m=2*Math.PI/h;if(1===i){var v=[];_.push(v),p.push(new dyt.Vec3(0,f,0));for(var g=0;g<h;g++){var y=a*s(m*g),x=a*c(m*g);p.push(new dyt.Vec3(y,-f,x))}for(var S=0;S<h;S++){0!==S&&v.push(S);var b;b=S<h-1?[0,S+2,S+1]:[0,1,S+1],_.push(b),vi.subtract(aCt,p[0],p[b[1]]),vi.subtract(sCt,p[b[2]],p[b[1]]),vi.cross(aCt,sCt,aCt),aCt.normalize(),d.push(new dyt.Vec3(aCt.x,aCt.y,aCt.z))}d.push(new dyt.Vec3(0,-1,0))}else if(2===i){var T=[];_.push(T),p.push(new dyt.Vec3(0,0,f));for(var E=0;E<h;E++){var C=a*s(m*E),w=a*c(m*E);p.push(new dyt.Vec3(C,w,-f))}for(var A=0;A<h;A++){0!==A&&T.push(h-A);var P;P=A<h-1?[0,A+1,A+2]:[0,A+1,1],_.push(P),vi.subtract(aCt,p[0],p[P[1]]),vi.subtract(sCt,p[P[2]],p[P[1]]),vi.cross(aCt,aCt,sCt),aCt.normalize(),d.push(new dyt.Vec3(aCt.x,aCt.y,aCt.z))}d.push(new dyt.Vec3(0,0,-1))}else{var I=[];_.push(I),p.push(new dyt.Vec3(f,0,0));for(var R=0;R<h;R++){var D=a*s(m*R),O=a*c(m*R);p.push(new dyt.Vec3(-f,D,O))}for(var M=0;M<h;M++){0!==M&&I.push(h-M);var N;N=M<h-1?[0,M+1,M+2]:[0,M+1,1],_.push(N),vi.subtract(aCt,p[0],p[N[1]]),vi.subtract(sCt,p[N[2]],p[N[1]]),vi.cross(aCt,aCt,sCt),aCt.normalize(),d.push(new dyt.Vec3(aCt.x,aCt.y,aCt.z))}d.push(new dyt.Vec3(-1,0,0))}this.impl.vertices=p,this.impl.faces=_,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(HEt),lCt=new dyt.AABB,uCt=new dyt.AABB,hCt=new dyt.Transform;dyt.Heightfield.prototype.calculateWorldAABB=function(t,e,n,i){var r=hCt,o=uCt;vi.copy(r.position,t),Ei.copy(r.quaternion,e);var a=this.elementSize,s=this.data;lCt.lowerBound.set(0,0,this.minValue),lCt.upperBound.set((s.length-1)*a,(s[0].length-1)*a,this.maxValue),lCt.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)};var fCt,pCt=function(t){F(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this).data=void 0,e.options=void 0,e._terrainID=void 0,e.data=[[]],e.options={elementSize:0},e._terrainID="",e}return e.setTerrain=function(t){if(t){if(this._terrainID!==t._uuid){var e=t,n=e.getVertexCountI(),i=e.getVertexCountJ();this._terrainID=e._uuid,this.data.length=n-1;for(var r=0;r<n;r++){null==this.data[r]&&(this.data[r]=[]),this.data[r].length=i-1;for(var o=0;o<i;o++)this.data[r][o]=e.getHeight(r,i-1-o)}this.options.elementSize=e.tileSize,this.updateProperties(this.data,this.options.elementSize)}}else""!==this._terrainID&&(this._terrainID="",this.data.length=1,this.data[0]=this.data[0]||[],this.data[0].length=0,this.options.elementSize=0,this.updateProperties(this.data,this.options.elementSize))},e.onComponentSet=function(){var t=this.collider.terrain;if(t){for(var e=t.getVertexCountI(),n=t.getVertexCountJ(),i=0;i<e;i++){null==this.data[i]&&(this.data[i]=[]);for(var r=0;r<n;r++)this.data[i][r]=t.getHeight(i,n-1-r)}this.options.elementSize=t.tileSize,this._terrainID=t._uuid}this._shape=new dyt.Heightfield(this.data,this.options)},e.onLoad=function(){t.prototype.onLoad.call(this),this.setTerrain(this.collider.terrain)},e.updateProperties=function(t,e){var n=this.impl;n.data=t,n.elementSize=e,n.updateMinValue(),n.updateMaxValue(),n.updateBoundingSphereRadius(),n.update(),this._index>=0&&FEt(this._body)},e._setCenter=function(t){var e=this.collider.terrain;if(e){Ei.fromEuler(this._orient,-90,0,0);var n=this._offset;vi.set(n,0,0,(e.getVertexCountJ()-1)*e.tileSize),vi.add(n,n,t)}},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(HEt),_Ct=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).vertices=[],e}F(e,t);var n=e.prototype;return n.setShapeType=function(){this._isBinding},n.setVertices=function(t){var e=this.vertices.length;if(4===e){for(var n=this._collider.node.worldScale,i=0;i<e;i++)vi.multiply(this.vertices[i],n,t[i]);var r=this.impl;r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius()}-1!==this._index&&FEt(this._body)},n.onComponentSet=function(){if(this.collider.shapeType===VTt.ESimplexType.TETRAHEDRON){for(var t=0;t<4;t++)this.vertices[t]=new dyt.Vec3(0,0,0);this._shape=dCt(this.vertices)}else VTt.ESimplexType.VERTEX,this._shape=new dyt.Particle},n.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},n.setScale=function(e){t.prototype.setScale.call(this,e),this.collider.updateVertices()},L(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(HEt),dCt=(fCt=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]],function(t){return new dyt.ConvexPolyhedron(t,fCt)}),mCt=function(t){function e(){var e;return(e=t.call(this)||this)._shape=new dyt.Plane,e}F(e,t);var n=e.prototype;return n.setNormal=function(t){Ei.rotationTo(this._orient,vi.UNIT_Z,t),-1!==this._index&&FEt(this._body)},n.setConstant=function(t){vi.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,t)},n.onLoad=function(){t.prototype.onLoad.call(this),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)},n._setCenter=function(e){t.prototype._setCenter.call(this,e),this.setConstant(this.collider.constant)},L(e,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),e}(HEt);dyt.World.staticBody=new dyt.Body,dyt.World.idToConstraintMap={};var vCt=function(){function t(){}var e=t.prototype;return e.setConnectedBody=function(t){var e=iSt(this.impl.bodyB);e&&e.removeJoint(this,1),t?(this._impl.bodyB=t.body.impl,t.body.sharedBody.addJoint(this,1)):this._impl.bodyB=dyt.World.staticBody;var n=this._impl.bodyB;this._impl.equations.forEach((function(t){t.bj=n}))},e.setEnableCollision=function(t){this._impl.collideConnected=t},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this.onComponentSet(),this.setEnableCollision(t.enableCollision),dyt.World.idToConstraintMap[this._impl.id]=this._impl},e.onComponentSet=function(){},e.updateScale0=function(){},e.updateScale1=function(){},e.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var e=this.constraint.connectedBody;e&&e.body.sharedBody.addJoint(this,1)},e.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var e=this.constraint.connectedBody;e&&e.body.sharedBody.removeJoint(this,1)},e.onDestroy=function(){delete dyt.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null},L(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),gCt=new vi,yCt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setPivotA=function(){var t=this.constraint;vi.multiply(this.impl.pivotA,t.node.worldScale,t.pivotA),t.connectedBody||this.setPivotB(t.pivotB)},n.setPivotB=function(){var t=this.constraint,e=t.connectedBody;if(e)vi.multiply(this.impl.pivotB,e.node.worldScale,t.pivotB);else{var n=t.node;vi.multiply(gCt,n.worldScale,t.pivotA),vi.add(gCt,gCt,n.worldPosition),vi.add(gCt,gCt,t.pivotB),vi.copy(this.impl.pivotB,gCt)}},n.onComponentSet=function(){var t=this._rigidBody.body.impl,e=this.constraint.connectedBody,n=dyt.World.staticBody;e&&(n=e.body.impl),this._impl=new dyt.PointToPointConstraint(t,null,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},L(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(vCt),xCt=new vi,SCt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setPivotA=function(){var t=this.constraint;vi.multiply(this.impl.pivotA,this.constraint.node.worldScale,t.pivotA),t.connectedBody||this.setPivotB(t.pivotB)},n.setPivotB=function(){var t=this.constraint,e=t.connectedBody;if(e)vi.multiply(this.impl.pivotB,e.node.worldScale,t.pivotB);else{var n=this.constraint.node;vi.multiply(xCt,n.worldScale,t.pivotA),vi.add(xCt,xCt,n.worldPosition),vi.add(xCt,xCt,t.pivotB),vi.copy(this.impl.pivotB,xCt)}},n.setAxis=function(t){vi.copy(this.impl.axisA,t),vi.copy(this.impl.equations[3].axisA,t),vi.copy(this.impl.equations[4].axisA,t),vi.copy(this.impl.equations[5].axisA,t),this.constraint.connectedBody?(vi.copy(this.impl.axisB,t),vi.copy(this.impl.equations[3].axisB,t),vi.copy(this.impl.equations[4].axisB,t),vi.copy(this.impl.equations[5].axisB,t)):(vi.transformQuat(this.impl.axisB,t,this.constraint.node.worldRotation),vi.copy(this.impl.equations[3].axisB,this.impl.axisB),vi.copy(this.impl.equations[4].axisB,this.impl.axisB),vi.copy(this.impl.equations[5].axisB,this.impl.axisB))},n.onComponentSet=function(){var t=this._rigidBody.body.impl,e=this.constraint.connectedBody,n=dyt.World.staticBody;e&&(n=e.body.impl),this._impl=new dyt.HingeConstraint(t,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxis(this.constraint.axis)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},L(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(vCt);ZM.once(QM.EVENT_ENGINE_INITED,(function(){gyt.register("cannon.js",{PhysicsWorld:QEt,RigidBody:NEt,BoxShape:eCt,SphereShape:nCt,TrimeshShape:rCt,CylinderShape:oCt,ConeShape:cCt,TerrainShape:pCt,SimplexShape:_Ct,PlaneShape:mCt,PointToPointConstraint:yCt,HingeConstraint:SCt})})),window&&(window.CANNON=dyt),dyt.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0,correctInelastic:3},dyt.ArrayCollisionMatrix.prototype.reset=function(){for(var t in this.matrix)delete this.matrix[t]},dyt.Ray.perBodyFilter=function(t,e){return 0!=(t.collisionFilterMask&e.collisionFilterGroup)};var bCt,TCt,ECt,CCt,wCt=Yt({GRAVITY:0,RADIUS:1}),ACt=Yt({FREE:0,RELATIVE:1,GROUPED:2}),PCt=new Bi(0,0),ICt=new Bi,RCt=new Bi,DCt=new Bi,OCt=new Bi,MCt=sV(oV),NCt=function(){this.pos=new Bi(0,0),this.startPos=new Bi(0,0),this.color=new di(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new Bi(0,0),this.aspectRatio=1,this.dir=new Bi(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0},LCt=new(function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.get=function(){return this._get()||new NCt},e}(Ut))((function(t){t.pos.set(PCt),t.startPos.set(PCt),t.color._val=4278190080,t.deltaColor.r=t.deltaColor.g=t.deltaColor.b=0,t.deltaColor.a=255,t.size=0,t.deltaSize=0,t.rotation=0,t.deltaRotation=0,t.timeToLive=0,t.drawPos.set(PCt),t.aspectRatio=1,t.dir.set(PCt),t.radialAccel=0,t.tangentialAccel=0,t.angle=0,t.degreesPerSecond=0,t.radius=0,t.deltaRadius=0}),1024),BCt=function(){function t(t){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}var e=t.prototype;return e.stop=function(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0},e.reset=function(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;for(var t=this.particles,e=0;e<t.length;++e)LCt.put(t[e]);t.length=0},e.emitParticle=function(t){var e=this.sys,n=LCt.get();this.particles.push(n),n.timeToLive=e.life+e.lifeVar*(Math.random()-.5)*2;var i=n.timeToLive=Math.max(0,n.timeToLive);n.pos.x=e.sourcePos.x+e.posVar.x*(Math.random()-.5)*2,n.pos.y=e.sourcePos.y+e.posVar.y*(Math.random()-.5)*2;var r,o,a,s,c=e.startColor,l=e.startColorVar,u=e.endColor,h=e.endColorVar;n.color.r=r=he(c.r+l.r*(Math.random()-.5)*2,0,255),n.color.g=o=he(c.g+l.g*(Math.random()-.5)*2,0,255),n.color.b=a=he(c.b+l.b*(Math.random()-.5)*2,0,255),n.color.a=s=he(c.a+l.a*(Math.random()-.5)*2,0,255),n.deltaColor.r=(he(u.r+h.r*(Math.random()-.5)*2,0,255)-r)/i,n.deltaColor.g=(he(u.g+h.g*(Math.random()-.5)*2,0,255)-o)/i,n.deltaColor.b=(he(u.b+h.b*(Math.random()-.5)*2,0,255)-a)/i,n.deltaColor.a=(he(u.a+h.a*(Math.random()-.5)*2,0,255)-s)/i;var f=e.startSize+e.startSizeVar*(Math.random()-.5)*2;if(f=Math.max(0,f),n.size=f,-1===e.endSize)n.deltaSize=0;else{var p=e.endSize+e.endSizeVar*(Math.random()-.5)*2;p=Math.max(0,p),n.deltaSize=(p-f)/i}var _=e.startSpin+e.startSpinVar*(Math.random()-.5)*2,d=e.endSpin+e.endSpinVar*(Math.random()-.5)*2;n.rotation=_,n.deltaRotation=(d-_)/i,n.startPos.x=t.x,n.startPos.y=t.y,n.aspectRatio=e.aspectRatio||1;var m=fe(e.angle+this._worldRotation+e.angleVar*(Math.random()-.5)*2);if(e.emitterMode===wCt.GRAVITY){var v=e.speed+e.speedVar*(Math.random()-.5)*2;n.dir.x=Math.cos(m),n.dir.y=Math.sin(m),n.dir.multiplyScalar(v),n.radialAccel=e.radialAccel+e.radialAccelVar*(Math.random()-.5)*2,n.tangentialAccel=e.tangentialAccel+e.tangentialAccelVar*(Math.random()-.5)*2,e.rotationIsDir&&(n.rotation=-pe(Math.atan2(n.dir.y,n.dir.x)))}else{var g=e.startRadius+e.startRadiusVar*(Math.random()-.5)*2,y=e.endRadius+e.endRadiusVar*(Math.random()-.5)*2;n.radius=g,n.deltaRadius=-1===e.endRadius?0:(y-g)/i,n.angle=m,n.degreesPerSecond=fe(e.rotatePerS+e.rotatePerSVar*(Math.random()-.5)*2)}},e.updateUVs=function(t){var e=this.renderData;if(e&&this.sys._renderSpriteFrame){for(var n=e.vData,i=this.sys._renderSpriteFrame.uv,r=t?0:this.uvFilled,o=this.particles.length,a=r;a<o;a++){var s=a*MCt*4;n[s+3]=i[0],n[s+4]=i[1],n[s+12]=i[2],n[s+13]=i[3],n[s+21]=i[4],n[s+22]=i[5],n[s+30]=i[6],n[s+31]=i[7]}this.uvFilled=o}},e.updateParticleBuffer=function(t,e,n,i){var r=n.vData,o=e.x,a=e.y,s=t.size,c=s,l=t.aspectRatio;l>1?c=s/l:s=c*l;var u=s/2,h=c/2;if(t.rotation){var f=-u,p=-h,_=u,d=h,m=-fe(t.rotation),v=Math.cos(m),g=Math.sin(m);r[i]=f*v-p*g+o,r[i+1]=f*g+p*v+a,r[i+2]=0,r[i+9]=_*v-p*g+o,r[i+10]=_*g+p*v+a,r[i+11]=0,r[i+18]=f*v-d*g+o,r[i+19]=f*g+d*v+a,r[i+20]=0,r[i+27]=_*v-d*g+o,r[i+28]=_*g+d*v+a,r[i+29]=0}else r[i]=o-u,r[i+1]=a-h,r[i+2]=0,r[i+9]=o+u,r[i+10]=a-h,r[i+11]=0,r[i+18]=o-u,r[i+19]=a+h,r[i+20]=0,r[i+27]=o+u,r[i+28]=a+h,r[i+29]=0;di.toArray(r,t.color,i+5),di.toArray(r,t.color,i+14),di.toArray(r,t.color,i+23),di.toArray(r,t.color,i+32)},e.step=function(t){var e=this.sys.assembler,n=this.sys,i=n.node,r=this.particles;if(t=t>e.maxParticleDeltaTime?e.maxParticleDeltaTime:t,i.updateWorldTransform(),n.positionType===ACt.FREE){this._worldRotation=function(t){for(var e=0,n=t;n;)e+=n.eulerAngles.z,n=n.parent;return e}(i);var o=i.worldMatrix;ICt.x=o.m12,ICt.y=o.m13}else n.positionType===ACt.RELATIVE?(this._worldRotation=i.eulerAngles.z,ICt.x=i.position.x,ICt.y=i.position.y):this._worldRotation=0;if(this.active&&n.emissionRate){var a=1/n.emissionRate;for(r.length<n.totalParticles&&(this.emitCounter+=t);r.length<n.totalParticles&&this.emitCounter>a;)this.emitParticle(ICt),this.emitCounter-=a;this.elapsed+=t,-1!==n.duration&&n.duration<this.elapsed&&n.stopSystem()}var s=this.renderData,c=r.length;s.reset(),this.requestData(4*c,6*c),c>this.uvFilled&&this.updateUVs();for(var l=0;l<r.length;){RCt.x=RCt.y=DCt.x=DCt.y=OCt.x=OCt.y=0;var u=r[l];if(u.timeToLive-=t,u.timeToLive>0){if(n.emitterMode===wCt.GRAVITY){var h=OCt,f=RCt,p=DCt;(u.pos.x||u.pos.y)&&(f.set(u.pos),f.normalize()),p.set(f),f.multiplyScalar(u.radialAccel);var _=p.x;p.x=-p.y,p.y=_,p.multiplyScalar(u.tangentialAccel),h.set(f),h.add(p),h.add(n.gravity),h.multiplyScalar(t),u.dir.add(h),h.set(u.dir),h.multiplyScalar(t),u.pos.add(h)}else u.angle+=u.degreesPerSecond*t,u.radius+=u.deltaRadius*t,u.pos.x=-Math.cos(u.angle)*u.radius,u.pos.y=-Math.sin(u.angle)*u.radius;u.color.r+=u.deltaColor.r*t,u.color.g+=u.deltaColor.g*t,u.color.b+=u.deltaColor.b*t,u.color.a+=u.deltaColor.a*t,u.size+=u.deltaSize*t,u.size<0&&(u.size=0),u.rotation+=u.deltaRotation*t;var d=RCt;d.set(u.pos),n.positionType!==ACt.GROUPED&&d.add(u.startPos);var m=MCt*l*4;this.updateParticleBuffer(u,d,s,m),++l}else{var v=r[l];l!==r.length-1&&(r[l]=r[r.length-1]),LCt.put(v),r.length--,s.resize(s.vertexCount-4,s.indexCount-6)}}0!==r.length||this.active||this.readyToPlay||(this.finished=!0,n._finishedSimulation())},e.requestData=function(t,e){var n=this.renderData.indexCount;this.renderData.request(t,e);for(var i=this.renderData.indexCount/6,r=this.renderData.iData,o=n;o<i;o++){var a=4*o;r[n++]=a,r[n++]=a+1,r[n++]=a+2,r[n++]=a+1,r[n++]=a+3,r[n++]=a+2}},t}(),FCt=t("ParticleAsset",ol("cc.ParticleAsset")((CCt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"spriteFrame",ECt,V(e)),e}return F(e,t),e}(Bu),ECt=X((TCt=CCt).prototype,"spriteFrame",[hl,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bCt=TCt))||bCt);i.ParticleAsset=FCt;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var zCt={};(function(){function t(t){throw t}var e=void 0,n=!0,i=this;function r(t,n){var r,o=t.split("."),a=i;!(o[0]in a)&&a.execScript&&a.execScript("var "+o[0]);for(;o.length&&(r=o.shift());)o.length||n===e?a=a[r]?a[r]:a[r]={}:a[r]=n}var o="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function a(t){if("string"==typeof t){var e,n,i=t.split("");for(e=0,n=i.length;e<n;e++)i[e]=(255&i[e].charCodeAt(0))>>>0;t=i}for(var r,o=1,a=0,s=t.length,c=0;0<s;){s-=r=1024<s?1024:s;do{a+=o+=t[c++]}while(--r);o%=65521,a%=65521}return(a<<16|o)>>>0}function s(e,n){this.index="number"==typeof n?n:0,this.i=0,this.buffer=e instanceof(o?Uint8Array:Array)?e:new(o?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}s.prototype.f=function(){var t,e=this.buffer,n=e.length,i=new(o?Uint8Array:Array)(n<<1);if(o)i.set(e);else for(t=0;t<n;++t)i[t]=e[t];return this.buffer=i},s.prototype.d=function(t,e,n){var i,r=this.buffer,o=this.index,a=this.i,s=r[o];if(n&&1<e&&(t=8<e?(p[255&t]<<24|p[t>>>8&255]<<16|p[t>>>16&255]<<8|p[t>>>24&255])>>32-e:p[t]>>8-e),8>e+a)s=s<<e|t,a+=e;else for(i=0;i<e;++i)s=s<<1|t>>e-i-1&1,8==++a&&(a=0,r[o++]=p[s],s=0,o===r.length&&(r=this.f()));r[o]=s,this.buffer=r,this.i=a,this.index=o},s.prototype.finish=function(){var t,e=this.buffer,n=this.index;return 0<this.i&&(e[n]<<=8-this.i,e[n]=p[e[n]],n++),o?t=e.subarray(0,n):(e.length=n,t=e),t};var c,l=new(o?Uint8Array:Array)(256);for(c=0;256>c;++c){for(var u=f=c,h=7,f=f>>>1;f;f>>>=1)u<<=1,u|=1&f,--h;l[c]=(u<<h&255)>>>0}var p=l;function _(t){this.buffer=new(o?Uint16Array:Array)(2*t),this.length=0}function d(t){var e,n,i,r,a,s,c,l,u,h=t.length,f=0,p=Number.POSITIVE_INFINITY;for(l=0;l<h;++l)t[l]>f&&(f=t[l]),t[l]<p&&(p=t[l]);for(e=1<<f,n=new(o?Uint32Array:Array)(e),i=1,r=0,a=2;i<=f;){for(l=0;l<h;++l)if(t[l]===i){for(s=0,c=r,u=0;u<i;++u)s=s<<1|1&c,c>>=1;for(u=s;u<e;u+=a)n[u]=i<<16|l;++r}++i,r<<=1,a<<=1}return[n,f,p]}function m(t,e){this.h=g,this.w=0,this.input=t,this.b=0,e&&(e.lazy&&(this.w=e.lazy),"number"==typeof e.compressionType&&(this.h=e.compressionType),e.outputBuffer&&(this.a=o&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.b=e.outputIndex)),this.a||(this.a=new(o?Uint8Array:Array)(32768))}_.prototype.getParent=function(t){return 2*((t-2)/4|0)},_.prototype.push=function(t,e){var n,i,r,o=this.buffer;for(n=this.length,o[this.length++]=e,o[this.length++]=t;0<n&&(i=this.getParent(n),o[n]>o[i]);)r=o[n],o[n]=o[i],o[i]=r,r=o[n+1],o[n+1]=o[i+1],o[i+1]=r,n=i;return this.length},_.prototype.pop=function(){var t,e,n,i,r,o=this.buffer;for(e=o[0],t=o[1],this.length-=2,o[0]=o[this.length],o[1]=o[this.length+1],r=0;!((i=2*r+2)>=this.length)&&(i+2<this.length&&o[i+2]>o[i]&&(i+=2),o[i]>o[r]);)n=o[r],o[r]=o[i],o[i]=n,n=o[r+1],o[r+1]=o[i+1],o[i+1]=n,r=i;return{index:t,value:e,length:this.length}};var v,g=2,y={NONE:0,r:1,j:g,N:3},x=[];for(v=0;288>v;v++)switch(n){case 143>=v:x.push([v+48,8]);break;case 255>=v:x.push([v-144+400,9]);break;case 279>=v:x.push([v-256+0,7]);break;case 287>=v:x.push([v-280+192,8]);break;default:t("invalid literal: "+v)}function S(t,e){this.length=t,this.G=e}function b(){var e=T;switch(n){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:t("invalid length: "+e)}}m.prototype.n=function(){var i,r,a,c,l=this.input;switch(this.h){case 0:for(a=0,c=l.length;a<c;){var u,h,f,p=r=o?l.subarray(a,a+65535):l.slice(a,a+65535),_=(a+=r.length)===c,d=e,m=e,v=this.a,y=this.b;if(o){for(v=new Uint8Array(this.a.buffer);v.length<=y+p.length+5;)v=new Uint8Array(v.length<<1);v.set(this.a)}if(u=_?1:0,v[y++]=0|u,f=65536+~(h=p.length)&65535,v[y++]=255&h,v[y++]=h>>>8&255,v[y++]=255&f,v[y++]=f>>>8&255,o)v.set(p,y),y+=p.length,v=v.subarray(0,y);else{for(d=0,m=p.length;d<m;++d)v[y++]=p[d];v.length=y}this.b=y,this.a=v}break;case 1:var S=new s(new Uint8Array(this.a.buffer),this.b);S.d(1,1,n),S.d(1,2,n);var b,T,E,C=A(this,l);for(b=0,T=C.length;b<T;b++)if(E=C[b],s.prototype.d.apply(S,x[E]),256<E)S.d(C[++b],C[++b],n),S.d(C[++b],5),S.d(C[++b],C[++b],n);else if(256===E)break;this.a=S.finish(),this.b=this.a.length;break;case g:var w,R,D,O,M,N,L,B,F,z,U,k,G,H,V,j=new s(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(w=g,j.d(1,1,n),j.d(w,2,n),R=A(this,l),L=I(N=P(this.L,15)),F=I(B=P(this.K,7)),D=286;257<D&&0===N[D-1];D--);for(O=30;1<O&&0===B[O-1];O--);var X,Y,K,Q,Z,J,$=D,tt=O,et=new(o?Uint32Array:Array)($+tt),nt=new(o?Uint32Array:Array)(316),it=new(o?Uint8Array:Array)(19);for(X=Y=0;X<$;X++)et[Y++]=N[X];for(X=0;X<tt;X++)et[Y++]=B[X];if(!o)for(X=0,Q=it.length;X<Q;++X)it[X]=0;for(X=Z=0,Q=et.length;X<Q;X+=Y){for(Y=1;X+Y<Q&&et[X+Y]===et[X];++Y);if(K=Y,0===et[X])if(3>K)for(;0<K--;)nt[Z++]=0,it[0]++;else for(;0<K;)(J=138>K?K:138)>K-3&&J<K&&(J=K-3),10>=J?(nt[Z++]=17,nt[Z++]=J-3,it[17]++):(nt[Z++]=18,nt[Z++]=J-11,it[18]++),K-=J;else if(nt[Z++]=et[X],it[et[X]]++,3>--K)for(;0<K--;)nt[Z++]=et[X],it[et[X]]++;else for(;0<K;)(J=6>K?K:6)>K-3&&J<K&&(J=K-3),nt[Z++]=16,nt[Z++]=J-3,it[16]++,K-=J}for(i=o?nt.subarray(0,Z):nt.slice(0,Z),z=P(it,7),H=0;19>H;H++)q[H]=z[W[H]];for(M=19;4<M&&0===q[M-1];M--);for(U=I(z),j.d(D-257,5,n),j.d(O-1,5,n),j.d(M-4,4,n),H=0;H<M;H++)j.d(q[H],3,n);for(H=0,V=i.length;H<V;H++)if(k=i[H],j.d(U[k],z[k],n),16<=k){switch(H++,k){case 16:G=2;break;case 17:G=3;break;case 18:G=7;break;default:t("invalid code: "+k)}j.d(i[H],G,n)}var rt,ot,at,st,ct,lt,ut,ht,ft=[L,N],pt=[F,B];for(ct=ft[0],lt=ft[1],ut=pt[0],ht=pt[1],rt=0,ot=R.length;rt<ot;++rt)if(at=R[rt],j.d(ct[at],lt[at],n),256<at)j.d(R[++rt],R[++rt],n),st=R[++rt],j.d(ut[st],ht[st],n),j.d(R[++rt],R[++rt],n);else if(256===at)break;this.a=j.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var T,E,C=[];for(T=3;258>=T;T++)E=b(),C[T]=E[2]<<24|E[1]<<16|E[0];var w=o?new Uint32Array(C):C;function A(i,r){function a(e,i){var r,o,a,s,c=e.G,l=[],u=0;switch(r=w[e.length],l[u++]=65535&r,l[u++]=r>>16&255,l[u++]=r>>24,n){case 1===c:o=[0,c-1,0];break;case 2===c:o=[1,c-2,0];break;case 3===c:o=[2,c-3,0];break;case 4===c:o=[3,c-4,0];break;case 6>=c:o=[4,c-5,1];break;case 8>=c:o=[5,c-7,1];break;case 12>=c:o=[6,c-9,2];break;case 16>=c:o=[7,c-13,2];break;case 24>=c:o=[8,c-17,3];break;case 32>=c:o=[9,c-25,3];break;case 48>=c:o=[10,c-33,4];break;case 64>=c:o=[11,c-49,4];break;case 96>=c:o=[12,c-65,5];break;case 128>=c:o=[13,c-97,5];break;case 192>=c:o=[14,c-129,6];break;case 256>=c:o=[15,c-193,6];break;case 384>=c:o=[16,c-257,7];break;case 512>=c:o=[17,c-385,7];break;case 768>=c:o=[18,c-513,8];break;case 1024>=c:o=[19,c-769,8];break;case 1536>=c:o=[20,c-1025,9];break;case 2048>=c:o=[21,c-1537,9];break;case 3072>=c:o=[22,c-2049,10];break;case 4096>=c:o=[23,c-3073,10];break;case 6144>=c:o=[24,c-4097,11];break;case 8192>=c:o=[25,c-6145,11];break;case 12288>=c:o=[26,c-8193,12];break;case 16384>=c:o=[27,c-12289,12];break;case 24576>=c:o=[28,c-16385,13];break;case 32768>=c:o=[29,c-24577,13];break;default:t("invalid distance")}for(r=o,l[u++]=r[0],l[u++]=r[1],l[u++]=r[2],a=0,s=l.length;a<s;++a)v[g++]=l[a];x[l[0]]++,b[l[3]]++,y=e.length+i-1,_=null}var s,c,l,u,h,f,p,_,d,m={},v=o?new Uint16Array(2*r.length):[],g=0,y=0,x=new(o?Uint32Array:Array)(286),b=new(o?Uint32Array:Array)(30),T=i.w;if(!o){for(l=0;285>=l;)x[l++]=0;for(l=0;29>=l;)b[l++]=0}for(x[256]=1,s=0,c=r.length;s<c;++s){for(l=h=0,u=3;l<u&&s+l!==c;++l)h=h<<8|r[s+l];if(m[h]===e&&(m[h]=[]),f=m[h],!(0<y--)){for(;0<f.length&&32768<s-f[0];)f.shift();if(s+3>=c){for(_&&a(_,-1),l=0,u=c-s;l<u;++l)d=r[s+l],v[g++]=d,++x[d];break}if(0<f.length){var E=e,C=e,A=0,P=e,I=e,R=e,D=r.length,O=(I=0,f.length);t:for(;I<O;I++){if(E=f[O-I-1],P=3,3<A){for(R=A;3<R;R--)if(r[E+R-1]!==r[s+R-1])continue t;P=A}for(;258>P&&s+P<D&&r[E+P]===r[s+P];)++P;if(P>A&&(C=E,A=P),258===P)break}p=new S(A,s-C),_?_.length<p.length?(d=r[s-1],v[g++]=d,++x[d],a(p,0)):a(_,-1):p.length<T?_=p:a(p,0)}else _?a(_,-1):(d=r[s],v[g++]=d,++x[d])}f.push(s)}return v[g++]=256,x[256]++,i.L=x,i.K=b,o?v.subarray(0,g):v}function P(t,e){function n(t){var e=T[t][E[t]];e===g?(n(t+1),n(t+1)):--S[e],++E[t]}var i,r,a,s,c,l=t.length,u=new _(572),h=new(o?Uint8Array:Array)(l);if(!o)for(s=0;s<l;s++)h[s]=0;for(s=0;s<l;++s)0<t[s]&&u.push(s,t[s]);if(i=Array(u.length/2),r=new(o?Uint32Array:Array)(u.length/2),1===i.length)return h[u.pop().index]=1,h;for(s=0,c=u.length/2;s<c;++s)i[s]=u.pop(),r[s]=i[s].value;var f,p,d,m,v,g=r.length,y=new(o?Uint16Array:Array)(e),x=new(o?Uint8Array:Array)(e),S=new(o?Uint8Array:Array)(g),b=Array(e),T=Array(e),E=Array(e),C=(1<<e)-g,w=1<<e-1;for(y[e-1]=g,p=0;p<e;++p)C<w?x[p]=0:(x[p]=1,C-=w),C<<=1,y[e-2-p]=(y[e-1-p]/2|0)+g;for(y[0]=x[0],b[0]=Array(y[0]),T[0]=Array(y[0]),p=1;p<e;++p)y[p]>2*y[p-1]+x[p]&&(y[p]=2*y[p-1]+x[p]),b[p]=Array(y[p]),T[p]=Array(y[p]);for(f=0;f<g;++f)S[f]=e;for(d=0;d<y[e-1];++d)b[e-1][d]=r[d],T[e-1][d]=d;for(f=0;f<e;++f)E[f]=0;for(1===x[e-1]&&(--S[0],++E[e-1]),p=e-2;0<=p;--p){for(m=f=0,v=E[p+1],d=0;d<y[p];d++)(m=b[p+1][v]+b[p+1][v+1])>r[f]?(b[p][d]=m,T[p][d]=g,v+=2):(b[p][d]=r[f],T[p][d]=f,++f);E[p]=0,1===x[p]&&n(p)}for(a=S,s=0,c=i.length;s<c;++s)h[i[s].index]=a[s];return h}function I(e){var n,i,r,a,s=new(o?Uint16Array:Array)(e.length),c=[],l=[],u=0;for(n=0,i=e.length;n<i;n++)c[e[n]]=1+(0|c[e[n]]);for(n=1,i=16;n<=i;n++)l[n]=u,(u+=0|c[n])>1<<n&&t("overcommitted"),u<<=1;for(65536>u&&t("undercommitted"),n=0,i=e.length;n<i;n++)for(u=l[e[n]],l[e[n]]+=1,r=s[n]=0,a=e[n];r<a;r++)s[n]=s[n]<<1|1&u,u>>>=1;return s}function R(t,e){this.input=t,this.a=new(o?Uint8Array:Array)(32768),this.h=D.j;var n,i={};for(n in!e&&(e={})||"number"!=typeof e.compressionType||(this.h=e.compressionType),e)i[n]=e[n];i.outputBuffer=this.a,this.z=new m(this.input,i)}var D=y;function O(e,n){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=o?new Uint8Array(e):e,this.s=!1,this.m=N,this.B=!1,!n&&(n={})||(n.index&&(this.c=n.index),n.bufferSize&&(this.l=n.bufferSize),n.bufferType&&(this.m=n.bufferType),n.resize&&(this.B=n.resize)),this.m){case M:this.b=32768,this.a=new(o?Uint8Array:Array)(32768+this.l+258);break;case N:this.b=0,this.a=new(o?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}R.prototype.n=function(){var e,n,i,r,s,c,l,u=0;switch(l=this.a,e=ut){case ut:n=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(i=n<<4|e,l[u++]=i,e){case ut:switch(this.h){case D.NONE:s=0;break;case D.r:s=1;break;case D.j:s=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return r=s<<6|0,l[u++]=r|31-(256*i+r)%31,c=a(this.input),this.z.b=u,u=(l=this.z.n()).length,o&&((l=new Uint8Array(l.buffer)).length<=u+4&&(this.a=new Uint8Array(l.length+4),this.a.set(l),l=this.a),l=l.subarray(0,u+4)),l[u++]=c>>24&255,l[u++]=c>>16&255,l[u++]=c>>8&255,l[u++]=255&c,l},r("Zlib.Deflate",R),r("Zlib.Deflate.compress",(function(t,e){return new R(t,e).n()})),r("Zlib.Deflate.CompressionType",D),r("Zlib.Deflate.CompressionType.NONE",D.NONE),r("Zlib.Deflate.CompressionType.FIXED",D.r),r("Zlib.Deflate.CompressionType.DYNAMIC",D.j);var M=0,N=1,L={D:M,C:N};O.prototype.p=function(){for(;!this.s;){var i=tt(this,3);switch(1&i&&(this.s=n),i>>>=1){case 0:var r=this.input,a=this.c,s=this.a,c=this.b,l=e,u=e,h=e,f=s.length,p=e;switch(this.e=this.g=0,(l=r[a++])===e&&t(Error("invalid uncompressed block header: LEN (first byte)")),u=l,(l=r[a++])===e&&t(Error("invalid uncompressed block header: LEN (second byte)")),u|=l<<8,(l=r[a++])===e&&t(Error("invalid uncompressed block header: NLEN (first byte)")),h=l,(l=r[a++])===e&&t(Error("invalid uncompressed block header: NLEN (second byte)")),u===~(h|=l<<8)&&t(Error("invalid uncompressed block header: length verify")),a+u>r.length&&t(Error("input buffer is broken")),this.m){case M:for(;c+u>s.length;){if(u-=p=f-c,o)s.set(r.subarray(a,a+p),c),c+=p,a+=p;else for(;p--;)s[c++]=r[a++];this.b=c,s=this.f(),c=this.b}break;case N:for(;c+u>s.length;)s=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(o)s.set(r.subarray(a,a+u),c),c+=u,a+=u;else for(;u--;)s[c++]=r[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(Z,$);break;case 2:nt(this);break;default:t(Error("unknown BTYPE: "+i))}}return this.t()};var B,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],U=o?new Uint16Array(z):z,k=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],G=o?new Uint16Array(k):k,H=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],V=o?new Uint8Array(H):H,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=o?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=o?new Uint8Array(q):q,Y=new(o?Uint8Array:Array)(288);for(B=0,F=Y.length;B<F;++B)Y[B]=143>=B?8:255>=B?9:279>=B?7:8;var K,Q,Z=d(Y),J=new(o?Uint8Array:Array)(30);for(K=0,Q=J.length;K<Q;++K)J[K]=5;var $=d(J);function tt(n,i){for(var r,o=n.g,a=n.e,s=n.input,c=n.c;a<i;)(r=s[c++])===e&&t(Error("input buffer is broken")),o|=r<<a,a+=8;return r=o&(1<<i)-1,n.g=o>>>i,n.e=a-i,n.c=c,r}function et(n,i){for(var r,o,a,s=n.g,c=n.e,l=n.input,u=n.c,h=i[0],f=i[1];c<f;)(r=l[u++])===e&&t(Error("input buffer is broken")),s|=r<<c,c+=8;return a=(o=h[s&(1<<f)-1])>>>16,n.g=s>>a,n.e=c-a,n.c=u,65535&o}function nt(t){function e(t,e,n){var i,r,o,a;for(a=0;a<t;)switch(i=et(this,e)){case 16:for(o=3+tt(this,2);o--;)n[a++]=r;break;case 17:for(o=3+tt(this,3);o--;)n[a++]=0;r=0;break;case 18:for(o=11+tt(this,7);o--;)n[a++]=0;r=0;break;default:r=n[a++]=i}return n}var n,i,r,a,s=tt(t,5)+257,c=tt(t,5)+1,l=tt(t,4)+4,u=new(o?Uint8Array:Array)(U.length);for(a=0;a<l;++a)u[U[a]]=tt(t,3);n=d(u),i=new(o?Uint8Array:Array)(s),r=new(o?Uint8Array:Array)(c),t.o(d(e.call(t,s,n,i)),d(e.call(t,c,n,r)))}function it(e,n){var i,r;switch(this.input=e,this.c=0,!n&&(n={})||(n.index&&(this.c=n.index),n.verify&&(this.M=n.verify)),i=e[this.c++],r=e[this.c++],15&i){case ut:this.method=ut;break;default:t(Error("unsupported compression method"))}0!=((i<<8)+r)%31&&t(Error("invalid fcheck flag:"+((i<<8)+r)%31)),32&r&&t(Error("fdict flag is not supported")),this.A=new O(e,{index:this.c,bufferSize:n.bufferSize,bufferType:n.bufferType,resize:n.resize})}O.prototype.o=function(t,e){var n=this.a,i=this.b;this.u=t;for(var r,o,a,s,c=n.length-258;256!==(r=et(this,t));)if(256>r)i>=c&&(this.b=i,n=this.f(),i=this.b),n[i++]=r;else for(s=G[o=r-257],0<V[o]&&(s+=tt(this,V[o])),r=et(this,e),a=W[r],0<X[r]&&(a+=tt(this,X[r])),i>=c&&(this.b=i,n=this.f(),i=this.b);s--;)n[i]=n[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},O.prototype.I=function(t,e){var n=this.a,i=this.b;this.u=t;for(var r,o,a,s,c=n.length;256!==(r=et(this,t));)if(256>r)i>=c&&(c=(n=this.f()).length),n[i++]=r;else for(s=G[o=r-257],0<V[o]&&(s+=tt(this,V[o])),r=et(this,e),a=W[r],0<X[r]&&(a+=tt(this,X[r])),i+s>c&&(c=(n=this.f()).length);s--;)n[i]=n[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},O.prototype.f=function(){var t,e,n=new(o?Uint8Array:Array)(this.b-32768),i=this.b-32768,r=this.a;if(o)n.set(r.subarray(32768,n.length));else for(t=0,e=n.length;t<e;++t)n[t]=r[t+32768];if(this.k.push(n),this.q+=n.length,o)r.set(r.subarray(i,i+32768));else for(t=0;32768>t;++t)r[t]=r[i+t];return this.b=32768,r},O.prototype.J=function(t){var e,n,i,r=this.input.length/this.c+1|0,a=this.input,s=this.a;return t&&("number"==typeof t.v&&(r=t.v),"number"==typeof t.F&&(r+=t.F)),n=2>r?(i=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+i:s.length<<1:s.length*r,o?(e=new Uint8Array(n)).set(s):e=s,this.a=e},O.prototype.t=function(){var t,e,n,i,r,a=0,s=this.a,c=this.k,l=new(o?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return o?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(e=0,n=c.length;e<n;++e)for(i=0,r=(t=c[e]).length;i<r;++i)l[a++]=t[i];for(e=32768,n=this.b;e<n;++e)l[a++]=s[e];return this.k=[],this.buffer=l},O.prototype.H=function(){var t,e=this.b;return o?this.B?(t=new Uint8Array(e)).set(this.a.subarray(0,e)):t=this.a.subarray(0,e):(this.a.length>e&&(this.a.length=e),t=this.a),this.buffer=t},it.prototype.p=function(){var e,n=this.input;return e=this.A.p(),this.c=this.A.c,this.M&&(n[this.c++]<<24|n[this.c++]<<16|n[this.c++]<<8|n[this.c++])>>>0!==a(e)&&t(Error("invalid adler-32 checksum")),e},r("Zlib.Inflate",it),r("Zlib.Inflate.BufferType",L),L.ADAPTIVE=L.C,L.BLOCK=L.D,r("Zlib.Inflate.prototype.decompress",it.prototype.p);var rt,ot,at=new(o?Uint8Array:Array)(288);for(rt=0,ot=at.length;rt<ot;++rt)at[rt]=143>=rt?8:255>=rt?9:279>=rt?7:8;d(at);var st,ct,lt=new(o?Uint8Array:Array)(30);for(st=0,ct=lt.length;st<ct;++st)lt[st]=5;d(lt);var ut=8}).call(zCt);var UCt=zCt.Zlib;UCt.Deflate=UCt.Deflate,UCt.Deflate.compress=UCt.Deflate.compress,UCt.Inflate=UCt.Inflate,UCt.Inflate.BufferType=UCt.Inflate.BufferType,UCt.Inflate.prototype.decompress=UCt.Inflate.prototype.decompress;for(var kCt=function(){function t(t){var e,n=this;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};for(var i=0,r=0,o=0;;){o=this.readUInt32();var a=function(){var t=[];for(i=0;i<4;++i)t.push(String.fromCharCode(n.data[n.pos++]));return t}.call(this).join("");switch(a){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(o);break;case"fcTL":e&&this.animation.frames.push(e),this.pos+=4,e={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};var s=this.readUInt16(),c=this.readUInt16()||100;e.delay=1e3*s/c,e.disposeOp=this.data[this.pos++],e.blendOp=this.data[this.pos++],e.data=[];break;case"IDAT":case"fdAT":for("fdAT"===a&&(this.pos+=4,o-=4),t=(null!=e?e.data:void 0)||this.imgData,i=0;o>=0?i<o:i>o;o>=0?++i:--i)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(o);var l=255-this.transparency.indexed.length;if(l>0)for(r=0;l>=0?r<l:r>l;l>=0?++r:--r)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(o)[0];break;case 2:this.transparency.rgb=this.read(o)}break;case"tEXt":var u=this.read(o),h=u.indexOf(0),f=String.fromCharCode.apply(String,u.slice(0,h));this.text[f]=String.fromCharCode.apply(String,u.slice(h+1));break;case"IEND":e&&this.animation.frames.push(e),this.colors=function(){switch(n.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this);var p=this.colorType;this.hasAlphaChannel=4===p||6===p;var _=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*_,this.colorSpace=function(){switch(n.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=o}if(this.pos+=4,this.pos>this.data.length)throw new Error(R(6017))}}var e=t.prototype;return e.read=function(t){var e=0,n=[];for(e=0;t>=0?e<t:e>t;t>=0?++e:--e)n.push(this.data[this.pos++]);return n},e.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},e.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},e.decodePixels=function(t){if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);t=new UCt.Inflate(t,{index:0,verify:!1}).decompress();for(var e=this.pixelBitlength/8,n=e*this.width,i=new Uint8Array(n*this.height),r=t.length,o=0,a=0,s=0,c=0,l=0,u=0,h=0,f=0,p=0,_=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,b=0,T=0;a<r;){switch(t[a++]){case 0:for(u=h=0;h<n;u=h+=1)i[s++]=t[a++];break;case 1:for(u=f=0;f<n;u=f+=1)c=t[a++],m=u<e?0:i[s-e],i[s++]=(c+m)%256;break;case 2:for(u=p=0;p<n;u=p+=1)c=t[a++],l=(u-u%e)/e,b=o&&i[(o-1)*n+l*e+u%e],i[s++]=(b+c)%256;break;case 3:for(u=_=0;_<n;u=_+=1)c=t[a++],l=(u-u%e)/e,m=u<e?0:i[s-e],b=o&&i[(o-1)*n+l*e+u%e],i[s++]=(c+Math.floor((m+b)/2))%256;break;case 4:for(u=d=0;d<n;u=d+=1)c=t[a++],l=(u-u%e)/e,m=u<e?0:i[s-e],0===o?b=T=0:(b=i[(o-1)*n+l*e+u%e],T=l&&i[(o-1)*n+(l-1)*e+u%e]),v=m+b-T,g=Math.abs(v-m),x=Math.abs(v-b),S=Math.abs(v-T),y=g<=x&&g<=S?m:x<=S?b:T,i[s++]=(c+y)%256;break;default:throw new Error(R(6018,t[a-1]))}o++}return i},e.copyToImageData=function(t,e){var n,i=this.hasAlphaChannel,r=this.colors;this.palette.length&&(n=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),r=4,i=!0);var o=t.data||t,a=o.length,s=n||e,c=0,l=0,u=0,h=0;if(1===r)for(;c<a;)u=n?4*e[c/4]:l,h=s[u++],o[c++]=h,o[c++]=h,o[c++]=h,o[c++]=i?s[u++]:255,l=u;else for(;c<a;)u=n?4*e[c/4]:l,o[c++]=s[u++],o[c++]=s[u++],o[c++]=s[u++],o[c++]=i?s[u++]:255,l=u},e.decodePalette=function(){for(var t=this.palette,e=this.transparency.indexed||[],n=new Uint8Array((e.length||0)+t.length),i=0,r=0,o=0,a=0,s=0,c=t.length;s<c;a=s+=3)n[i++]=t[a],n[i++]=t[a+1],n[i++]=t[a+2],o=e[r++],n[i++]=null!=o?o:255;return n},e.render=function(t){t.width=this.width,t.height=this.height;var e=t.getContext("2d"),n=e.createImageData(this.width,this.height);return this.copyToImageData(n,this.decodePixels(null)),e.putImageData(n,0,0)},t}(),GCt=function(){function t(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}var e=t.prototype;return e.getUint8=function(t){return this._tiffData[t]},e.getUint16=function(t){return this._littleEndian?this._tiffData[t+1]<<8|this._tiffData[t]:this._tiffData[t]<<8|this._tiffData[t+1]},e.getUint32=function(t){var e=this._tiffData;return this._littleEndian?e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]:e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]},e.checkLittleEndian=function(){var t=this.getUint16(0);if(18761===t)this._littleEndian=!0;else{if(19789!==t)throw console.log(t),TypeError(R(6019));this._littleEndian=!1}return this._littleEndian},e.hasTowel=function(){if(42!==this.getUint16(2))throw RangeError(R(6020));return!0},e.getFieldTypeName=function(t){return t in VCt?VCt[t]:null},e.getFieldTagName=function(t){return t in HCt?HCt[t]:(b(6021,t),"Tag"+t)},e.getFieldTypeLength=function(t){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(t)?1:-1!==["SHORT","SSHORT"].indexOf(t)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(t)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(t)?8:0},e.getFieldValues=function(t,e,n,i){var r=[],o=this.getFieldTypeLength(e);if(o*n<=4)!1===this._littleEndian?r.push(i>>>8*(4-o)):r.push(i);else for(var a=0;a<n;a++){var s=o*a;o>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(e)?(r.push(this.getUint32(i+s)),r.push(this.getUint32(i+s+4))):b(8e3):r.push(this.getBytes(o,i+s))}return"ASCII"===e&&r.forEach((function(t,e,n){n[e]=String.fromCharCode(t)})),r},e.getBytes=function(t,e){if(t<=0)b(8001);else{if(t<=1)return this.getUint8(e);if(t<=2)return this.getUint16(e);if(t<=3)return this.getUint32(e)>>>8;if(t<=4)return this.getUint32(e);b(8002)}return 0},e.getBits=function(t,e,n){n=n||0;var i=e+Math.floor(n/8),r=n+t,o=32-t,a=0,s=0;return r<=0?b(6023):r<=8?(a=24+n,s=this.getUint8(i)):r<=16?(a=16+n,s=this.getUint16(i)):r<=32?(a=n,s=this.getUint32(i)):b(6022),{bits:s<<a>>>o,byteOffset:i+Math.floor(r/8),bitOffset:r%8}},e.parseFileDirectory=function(t){var e=this.getUint16(t),n=[],i=0,r=0;for(i=t+2,r=0;r<e;i+=12,r++){var o=this.getUint16(i),a=this.getUint16(i+2),s=this.getUint32(i+4),c=this.getUint32(i+8),l=this.getFieldTagName(o),u=this.getFieldTypeName(a),h=this.getFieldValues(l,u,s,c);n[l]={type:u,values:h}}this._fileDirectories.push(n);var f=this.getUint32(i);0!==f&&this.parseFileDirectory(f)},e.clampColorSample=function(t,e){var n=Math.pow(2,8-e);return Math.floor(t*n+(n-1))},e.parseTIFF=function(t,e){var n=this;if(e=e||document.createElement("canvas"),this._tiffData=t,this._canvas=e,this.checkLittleEndian(),this.hasTowel()){var i=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(i);var r=this._fileDirectories[0],o=r.ImageWidth.values[0],a=r.ImageLength.values[0];this._canvas.width=o,this._canvas.height=a;var s=[],c=r.Compression?r.Compression.values[0]:1,l=r.SamplesPerPixel.values[0],u=[],h=0,f=!1;r.BitsPerSample.values.forEach((function(t,e){u[e]={bitsPerSample:t,hasBytesPerSample:!1,bytesPerSample:void 0},t%8==0&&(u[e].hasBytesPerSample=!0,u[e].bytesPerSample=t/8),h+=t}),this);var p=0;h%8==0&&(f=!0,p=h/8);var _,d=r.StripOffsets.values,m=d.length;if(r.StripByteCounts)_=r.StripByteCounts.values;else{if(b(8003),1!==m)throw Error(R(6024));_=[Math.ceil(o*a*h/8)]}for(var v=1,g=1,y=0;y<m;y++){var x=d[y];s[y]=[];for(var S=_[y],T=0,E=0,C=1,w=!0,A=[],P=0,I=0,D=0;T<S;T+=C)switch(c){case 1:A=[];for(var O=0;O<l;O++){var M=u[O];if(!M.hasBytesPerSample){var N=this.getBits(M.bitsPerSample,x+T,E);throw A.push(N.bits),T=N.byteOffset-x,E=N.bitOffset,RangeError(R(6025))}var L=M.bytesPerSample*O;A.push(this.getBytes(M.bytesPerSample,x+T+L))}if(s[y].push(A),!f)throw C=0,RangeError(R(6026));C=p;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(w){w=!1;var B=this.getUint8(x+T);B>=0&&B<=127?v=B+1:B>=-127&&B<=-1?g=1-B:w=!0}else{for(var F=this.getUint8(x+T),z=0;z<g;z++){var U=u[I];if(!U.hasBytesPerSample)throw RangeError(R(6025));D=D<<8*P|F,++P===U.bytesPerSample&&(A.push(D),D=P=0,I++),I===l&&(s[y].push(A),A=[],I=0)}0==--v&&(w=!0)}C=1}}if(e.getContext){var k=this._canvas.getContext("2d");k.fillStyle="rgba(255, 255, 255, 0)";var G=r.RowsPerStrip?r.RowsPerStrip.values[0]:a,H=s.length,V=a%G,j=0===V?G:V,W=G,q=0,X=r.PhotometricInterpretation.values[0],Y=[],K=0;r.ExtraSamples&&(K=(Y=r.ExtraSamples.values).length);var Q=[],Z=0;r.ColorMap&&(Q=r.ColorMap.values,Z=Math.pow(2,u[0].bitsPerSample));for(var J=0;J<H;J++){J+1===H&&(W=j);for(var $=s[J].length,tt=q*J,et=0,nt=0;et<W&&nt<$;et++)for(var it=0;it<o;it++,nt++){var rt=s[J][nt],ot=0,at=0,st=0,ct=1;if(K>0)for(var lt=0;lt<K;lt++)if(1===Y[lt]||2===Y[lt]){ct=rt[3+lt]/256;break}!function(){switch(X){case 0:var t=0;u[0].hasBytesPerSample&&(t=Math.pow(16,2*u[0].bytesPerSample)),rt.forEach((function(e,n,i){i[n]=t-e}));case 1:ot=at=st=n.clampColorSample(rt[0],u[0].bitsPerSample);break;case 2:ot=n.clampColorSample(rt[0],u[0].bitsPerSample),at=n.clampColorSample(rt[1],u[1].bitsPerSample),st=n.clampColorSample(rt[2],u[2].bitsPerSample);break;case 3:if(void 0===Q)throw Error(R(6027));var e=rt[0];ot=n.clampColorSample(Q[e],16),at=n.clampColorSample(Q[Z+e],16),st=n.clampColorSample(Q[2*Z+e],16);break;default:throw RangeError(R(6028,X))}}(),k.fillStyle="rgba("+ot+", "+at+", "+st+", "+ct+")",k.fillRect(it,tt+et,1,1)}q=W}}return this._canvas}},t}(),HCt={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},VCt={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},jCt=new Array(123),WCt=0;WCt<123;++WCt)jCt[WCt]=64;for(var qCt=0;qCt<64;++qCt)jCt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(qCt)]=qCt;var XCt={name:"Jacob__Codec__Base64",decode:function(t){var e,n,i,r,o,a,s=[],c=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<t.length;)e=jCt[t.charCodeAt(c++)]<<2|(r=jCt[t.charCodeAt(c++)])>>4,n=(15&r)<<4|(o=jCt[t.charCodeAt(c++)])>>2,i=(3&o)<<6|(a=jCt[t.charCodeAt(c++)]),s.push(String.fromCharCode(e)),64!==o&&s.push(String.fromCharCode(n)),64!==a&&s.push(String.fromCharCode(i));return s.join("")},decodeAsArray:function(t,e){var n,i,r,o=this.decode(t),a=[];for(n=0,r=o.length/e;n<r;n++)for(a[n]=0,i=e-1;i>=0;--i)a[n]+=o.charCodeAt(n*e+i)<<8*i;return a}},YCt=function(t){this.data=t,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(YCt.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};YCt.gunzip=function(t){return t.constructor===Array||t.constructor,new YCt(t).gunzip()[0][0]},YCt.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},YCt.LITERALS=288,YCt.NAMEMAX=256,YCt.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],YCt.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],YCt.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],YCt.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],YCt.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],YCt.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],YCt.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},YCt.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},YCt.prototype.byteAlign=function(){this.bb=1},YCt.prototype.readBit=function(){var t;return this.bits++,t=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),t=1&this.bb,this.bb=this.bb>>1|128),t},YCt.prototype.readBits=function(t){for(var e=0,n=t;n--;)e=e<<1|this.readBit();return t&&(e=YCt.bitReverse[e]>>8-t),e},YCt.prototype.flushBuffer=function(){this.bIdx=0},YCt.prototype.addBuffer=function(t){this.buf32k[this.bIdx++]=t,this.outputArr.push(String.fromCharCode(t)),32768===this.bIdx&&(this.bIdx=0)},YCt.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},YCt.prototype.Rec=function(){var t,e=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(t=this.IsPat())>=0)e.b0=t;else if(e.b0=32768,this.Rec())return-1;if((t=this.IsPat())>=0)e.b1=t,e.jump=null;else if(e.b1=32768,e.jump=this.Places[this.treepos],e.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},YCt.prototype.CreateTree=function(t,e,n){var i;for(this.Places=t,this.treepos=0,this.flens=n,this.fmax=e,i=0;i<17;i++)this.fpos[i]=0;return this.len=0,this.Rec()?-1:0},YCt.prototype.DecodeValue=function(t){for(var e,n,i=0,r=t[i];;)if(this.readBit()){if(!(32768&r.b1))return r.b1;for(r=r.jump,e=t.length,n=0;n<e;n++)if(t[n]===r){i=n;break}}else{if(!(32768&r.b0))return r.b0;r=t[++i]}return-1},YCt.prototype.DeflateLoop=function(){var t,e,n;do{var i,r;if(t=this.readBit(),0===(e=this.readBits(2)))for(this.byteAlign(),i=this.readByte(),i|=this.readByte()<<8,r=this.readByte(),65535&(i^~(r|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");i--;)o=this.readByte(),this.addBuffer(o);else if(1===e)for(;;)if((a=YCt.bitReverse[this.readBits(7)]>>1)>23?(a=a<<1|this.readBit())>199?a=(a-=128)<<1|this.readBit():(a-=48)>143&&(a+=136):a+=256,a<256)this.addBuffer(a);else{if(256===a)break;for(a-=257,_=this.readBits(YCt.cplext[a])+YCt.cplens[a],a=YCt.bitReverse[this.readBits(5)]>>3,YCt.cpdext[a]>8?(d=this.readBits(8),d|=this.readBits(YCt.cpdext[a]-8)<<8):d=this.readBits(YCt.cpdext[a]),d+=YCt.cpdist[a],a=0;a<_;a++){var o=this.buf32k[this.bIdx-d&32767];this.addBuffer(o)}}else if(2===e){var a,s,c,l,u,h=new Array(320);for(c=257+this.readBits(5),l=1+this.readBits(5),u=4+this.readBits(4),a=0;a<19;a++)h[a]=0;for(a=0;a<u;a++)h[YCt.border[a]]=this.readBits(3);for(_=this.distanceTree.length,n=0;n<_;n++)this.distanceTree[n]=new YCt.HufNode;if(this.CreateTree(this.distanceTree,19,h,0))return this.flushBuffer(),1;for(s=c+l,n=0;n<s;)if((a=this.DecodeValue(this.distanceTree))<16)h[n++]=a;else if(16===a){var f;if(n+(a=3+this.readBits(2))>s)return this.flushBuffer(),1;for(f=n?h[n-1]:0;a--;)h[n++]=f}else{if(n+(a=17===a?3+this.readBits(3):11+this.readBits(7))>s)return this.flushBuffer(),1;for(;a--;)h[n++]=0}for(_=this.literalTree.length,n=0;n<_;n++)this.literalTree[n]=new YCt.HufNode;if(this.CreateTree(this.literalTree,c,h,0))return this.flushBuffer(),1;for(_=this.literalTree.length,n=0;n<_;n++)this.distanceTree[n]=new YCt.HufNode;var p=new Array;for(n=c;n<h.length;n++)p[n-c]=h[n];if(this.CreateTree(this.distanceTree,l,p,0))return this.flushBuffer(),1;for(;;)if((a=this.DecodeValue(this.literalTree))>=256){var _,d;if(0==(a-=256))break;for(a--,_=this.readBits(YCt.cplext[a])+YCt.cplens[a],a=this.DecodeValue(this.distanceTree),YCt.cpdext[a]>8?(d=this.readBits(8),d|=this.readBits(YCt.cpdext[a]-8)<<8):d=this.readBits(YCt.cpdext[a]),d+=YCt.cpdist[a];_--;)o=this.buf32k[this.bIdx-d&32767],this.addBuffer(o)}else this.addBuffer(a)}}while(!t);return this.flushBuffer(),this.byteAlign(),0},YCt.prototype.unzipFile=function(t){var e;for(this.gunzip(),e=0;e<this.unzipped.length;e++)if(this.unzipped[e][1]===t)return this.unzipped[e][0]},YCt.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var t=[];if(t[0]=this.readByte(),t[1]=this.readByte(),120===t[0]&&218===t[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===t[0]&&139===t[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===t[0]&&75===t[1]&&(this.modeZIP=!0,t[2]=this.readByte(),t[3]=this.readByte(),3===t[2]&&4===t[3])){t[0]=this.readByte(),t[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte();e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var n=this.readByte();n|=this.readByte()<<8;var i=this.readByte();for(i|=this.readByte()<<8,o=0,this.nameBuf=[];n--;){var r=this.readByte();"/"===r|":"===r?o=0:o<YCt.NAMEMAX-1&&(this.nameBuf[o++]=String.fromCharCode(r))}this.fileout||(this.fileout=this.nameBuf);for(var o=0;o<i;)r=this.readByte(),o++;8===e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},YCt.prototype.skipdir=function(){var t,e,n=[];if(8&this.gpflags&&(n[0]=this.readByte(),n[1]=this.readByte(),n[2]=this.readByte(),n[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),n[0]=this.readByte(),8!==n[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(n[0]=this.readByte(),n[2]=this.readByte(),this.len=n[0]+256*n[1],t=0;t<this.len;t++)this.readByte();if(8&this.gpflags)for(t=0,this.nameBuf=[];e=this.readByte();)"7"!==e&&":"!==e||(t=0),t<YCt.NAMEMAX-1&&(this.nameBuf[t++]=e);if(16&this.gpflags)for(;e=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var KCt,QCt,ZCt,JCt,$Ct,twt,ewt,nwt,iwt,rwt,owt,awt,swt,cwt,lwt,uwt,hwt,fwt,pwt,_wt,dwt,mwt,vwt,gwt,ywt,xwt,Swt,bwt,Twt,Ewt,Cwt,wwt,Awt,Pwt,Iwt,Rwt,Dwt,Owt,Mwt,Nwt,Lwt,Bwt,Fwt,zwt,Uwt,kwt,Gwt,Hwt,Vwt,jwt,Wwt,qwt,Xwt,Ywt,Kwt,Qwt,Zwt,Jwt,$wt,tAt,eAt,nAt,iAt,rAt,oAt,aAt,sAt,cAt,lAt,uAt,hAt,fAt,pAt,_At,dAt,mAt,vAt,gAt,yAt,xAt,SAt,bAt,TAt,EAt,CAt,wAt,AAt,PAt,IAt,RAt,DAt,OAt,MAt,NAt,LAt,BAt,FAt,zAt,UAt={name:"Jacob__Codec"};function kAt(t){var e=t.parent,n=t.getComponent(ePt);return e&&n?kAt(e):t.getComponentsInChildren(ePt)}UAt.Base64=XCt,UAt.GZip=YCt,UAt.unzip=function(){return UAt.GZip.gunzip.apply(UAt.GZip,arguments)},UAt.unzipBase64=function(){var t=UAt.Base64.decode.apply(UAt.Base64,arguments);try{return UAt.GZip.gunzip.call(UAt.GZip,t)}catch(e){return t.slice(7)}},UAt.unzipBase64AsArray=function(t,e){e=e||1;var n,i,r,o=this.unzipBase64(t),a=[];for(n=0,r=o.length/e;n<r;n++)for(a[n]=0,i=e-1;i>=0;--i)a[n]+=o.charCodeAt(n*e+i)<<8*i;return a},UAt.unzipAsArray=function(t,e){e=e||1;var n,i,r,o=this.unzip(t),a=[];for(n=0,r=o.length/e;n<r;n++)for(a[n]=0,i=e-1;i>=0;--i)a[n]+=o.charCodeAt(n*e+i)<<8*i;return a},function(t){t[t.JPG=0]="JPG",t[t.PNG=1]="PNG",t[t.TIFF=2]="TIFF",t[t.WEBP=3]="WEBP",t[t.PVR=4]="PVR",t[t.ETC=5]="ETC",t[t.S3TC=6]="S3TC",t[t.ATITC=7]="ATITC",t[t.TGA=8]="TGA",t[t.RAWDATA=9]="RAWDATA",t[t.UNKNOWN=10]="UNKNOWN"}(zAt||(zAt={}));var GAt,HAt,VAt,jAt,WAt,qAt,XAt,YAt,KAt,QAt,ZAt,JAt,$At,tPt,ePt=t("ParticleSystem2D",(KCt=ol("cc.ParticleSystem2D"),QCt=vl(),ZCt=wl(),JCt=kl(FCt),$Ct=wl(),twt=kl(EV),ewt=wl(),nwt=wl(),iwt=wl(),rwt=wl(),owt=wl(),awt=wl(),swt=wl(),cwt=wl(),lwt=Tl(),uwt=wl(),hwt=wl(),fwt=wl(),pwt=wl(),_wt=wl(),dwt=wl(),mwt=wl(),vwt=wl(),gwt=wl(),ywt=wl(),xwt=wl(),Swt=wl(),bwt=wl(),Twt=kl(ACt),Ewt=wl(),Cwt=wl(),wwt=kl(wCt),Awt=wl(),Pwt=wl(),Iwt=wl(),Rwt=wl(),Dwt=wl(),Owt=wl(),Mwt=wl(),Nwt=wl(),Lwt=wl(),Bwt=wl(),Fwt=wl(),zwt=wl(),Uwt=wl(),kwt=wl(),Gwt=wl(),Hwt=wl(),Vwt=wl(),jwt=fl("preview"),KCt(Wwt=QCt(Wwt=gl(Wwt=ml((FAt=BAt=function(t){function e(){var e;return q(e=t.call(this)||this,"duration",Xwt,V(e)),q(e,"emissionRate",Ywt,V(e)),q(e,"life",Kwt,V(e)),q(e,"lifeVar",Qwt,V(e)),q(e,"angle",Zwt,V(e)),q(e,"angleVar",Jwt,V(e)),q(e,"startSize",$wt,V(e)),q(e,"startSizeVar",tAt,V(e)),q(e,"endSize",eAt,V(e)),q(e,"endSizeVar",nAt,V(e)),q(e,"startSpin",iAt,V(e)),q(e,"startSpinVar",rAt,V(e)),q(e,"endSpin",oAt,V(e)),q(e,"endSpinVar",aAt,V(e)),q(e,"sourcePos",sAt,V(e)),q(e,"posVar",cAt,V(e)),q(e,"emitterMode",lAt,V(e)),q(e,"gravity",uAt,V(e)),q(e,"speed",hAt,V(e)),q(e,"speedVar",fAt,V(e)),q(e,"tangentialAccel",pAt,V(e)),q(e,"tangentialAccelVar",_At,V(e)),q(e,"radialAccel",dAt,V(e)),q(e,"radialAccelVar",mAt,V(e)),q(e,"rotationIsDir",vAt,V(e)),q(e,"startRadius",gAt,V(e)),q(e,"startRadiusVar",yAt,V(e)),q(e,"endRadius",xAt,V(e)),q(e,"endRadiusVar",SAt,V(e)),q(e,"rotatePerS",bAt,V(e)),q(e,"rotatePerSVar",TAt,V(e)),e.aspectRatio=1,q(e,"playOnLoad",EAt,V(e)),q(e,"autoRemoveOnFinish",CAt,V(e)),q(e,"_preview",wAt,V(e)),q(e,"_custom",AAt,V(e)),q(e,"_file",PAt,V(e)),q(e,"_spriteFrame",IAt,V(e)),q(e,"_totalParticles",RAt,V(e)),q(e,"_startColor",DAt,V(e)),q(e,"_startColorVar",OAt,V(e)),q(e,"_endColor",MAt,V(e)),q(e,"_endColorVar",NAt,V(e)),q(e,"_positionType",LAt,V(e)),e._stopped=!0,e.initProperties(),e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMaterial()},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)},n.initProperties=function(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new BCt(this)},n.onFocusInEditor=function(){this._focused=!0;for(var t=kAt(this.node),e=0;e<t.length;++e)t[e]._startPreview()},n.onLostFocusInEditor=function(){this._focused=!1;for(var t=kAt(this.node),e=0;e<t.length;++e)t[e]._stopPreview()},n._startPreview=function(){this._preview&&this.resetSystem()},n._stopPreview=function(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)},n.__preload=function(){t.prototype.__preload.call(this),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))},n.lateUpdate=function(t){this._simulator.finished||this._simulator.step(t)},n.addParticle=function(){},n.stopSystem=function(){this._stopped=!0,this._simulator.stop()},n.resetSystem=function(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()},n.isFull=function(){return this.particleCount>=this.totalParticles},n._applyFile=function(){var t=this._file;if(t){if(!t)return void w(6029);if(!this.isValid)return;this._plistFile=t.nativeUrl,this._custom||(this._spriteFrame!==t.spriteFrame&&(this.spriteFrame=t.spriteFrame),this._initWithDictionary(t._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():t.spriteFrame?this.spriteFrame=t.spriteFrame:this._custom&&this._initTextureWithDictionary(t._nativeAsset)}},n._initTextureWithDictionary=function(t){var e,n=this;if(t.spriteFrameUuid){var i=t.spriteFrameUuid;hL.loadAny(i,(function(e,i){e?(t.spriteFrameUuid=void 0,n._initTextureWithDictionary(t),d(e)):n.spriteFrame=i}))}else{var r=Tn(this._plistFile,t.textureFileName||"");if(t.textureFileName)hL.loadRemote(r,(function(e,i){e?(t.textureFileName=void 0,n._initTextureWithDictionary(t),d(e)):n.spriteFrame=i?EV.createWithImage(i):EV.createWithImage(Gv.get("white-texture"))}));else if(t.textureImageData){var o=t.textureImageData;if(!(o&&o.length>0))return!1;var a=hL.assets.get(r);if(!a){var s=UAt.unzipBase64AsArray(o,1);if(!s)return E(6030,this._file.name),!1;var c=(e=s).length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?zAt.PNG:e.length>2&&(73===e[0]&&73===e[1]||77===e[0]&&77===e[1]||255===e[0]&&216===e[1])?zAt.TIFF:zAt.UNKNOWN;if(c!==zAt.TIFF&&c!==zAt.PNG)return E(6031,this._file.name),!1;var l=document.createElement("canvas");c===zAt.PNG?new kCt(s).render(l):(this._tiffReader||(this._tiffReader=new GCt),this._tiffReader.parseTIFF(s,l)),a=new Fm(l),hL.assets.add(r,a)}a||E(6032,this._file.name),this.spriteFrame=a?EV.createWithImage(a):EV.createWithImage(Gv.get("white-texture"))}}return!0},n._initWithDictionary=function(t){this.totalParticles=parseInt(t.maxParticles||0),this.life=parseFloat(t.particleLifespan||0),this.lifeVar=parseFloat(t.particleLifespanVariance||0);var e=t.emissionRate;this.emissionRate=e||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(t.duration||0),this._srcBlendFactor=parseInt(t.blendFuncSource||Ur.SRC_ALPHA),this._dstBlendFactor=parseInt(t.blendFuncDestination||Ur.ONE_MINUS_SRC_ALPHA);var n=this._startColor;n.r=255*parseFloat(t.startColorRed||0),n.g=255*parseFloat(t.startColorGreen||0),n.b=255*parseFloat(t.startColorBlue||0),n.a=255*parseFloat(t.startColorAlpha||0);var i=this._startColorVar;i.r=255*parseFloat(t.startColorVarianceRed||0),i.g=255*parseFloat(t.startColorVarianceGreen||0),i.b=255*parseFloat(t.startColorVarianceBlue||0),i.a=255*parseFloat(t.startColorVarianceAlpha||0);var r=this._endColor;r.r=255*parseFloat(t.finishColorRed||0),r.g=255*parseFloat(t.finishColorGreen||0),r.b=255*parseFloat(t.finishColorBlue||0),r.a=255*parseFloat(t.finishColorAlpha||0);var o=this._endColorVar;if(o.r=255*parseFloat(t.finishColorVarianceRed||0),o.g=255*parseFloat(t.finishColorVarianceGreen||0),o.b=255*parseFloat(t.finishColorVarianceBlue||0),o.a=255*parseFloat(t.finishColorVarianceAlpha||0),this.startSize=parseFloat(t.startParticleSize||0),this.startSizeVar=parseFloat(t.startParticleSizeVariance||0),this.endSize=parseFloat(t.finishParticleSize||0),this.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==t.positionType?t.positionType:ACt.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(t.sourcePositionVariancex||0),parseFloat(t.sourcePositionVariancey||0)),this.angle=parseFloat(t.angle||0),this.angleVar=parseFloat(t.angleVariance||0),this.startSpin=parseFloat(t.rotationStart||0),this.startSpinVar=parseFloat(t.rotationStartVariance||0),this.endSpin=parseFloat(t.rotationEnd||0),this.endSpinVar=parseFloat(t.rotationEndVariance||0),this.emitterMode=parseInt(t.emitterType||wCt.GRAVITY),this.emitterMode===wCt.GRAVITY){this.gravity.set(parseFloat(t.gravityx||0),parseFloat(t.gravityy||0)),this.speed=parseFloat(t.speed||0),this.speedVar=parseFloat(t.speedVariance||0),this.radialAccel=parseFloat(t.radialAcceleration||0),this.radialAccelVar=parseFloat(t.radialAccelVariance||0),this.tangentialAccel=parseFloat(t.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);var a=t.rotationIsDir||"";null!==a?(a=a.toString().toLowerCase(),this.rotationIsDir="true"===a||"1"===a):this.rotationIsDir=!1}else{if(this.emitterMode!==wCt.RADIUS)return E(6009),!1;this.startRadius=parseFloat(t.maxRadius||0),this.startRadiusVar=parseFloat(t.maxRadiusVariance||0),this.endRadius=parseFloat(t.minRadius||0),this.endRadiusVar=parseFloat(t.minRadiusVariance||0),this.rotatePerS=parseFloat(t.rotatePerSecond||0),this.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(t),!0},n._syncAspect=function(){if(this._renderSpriteFrame){var t=this._renderSpriteFrame.rect;this.aspectRatio=t.width/t.height}},n._applySpriteFrame=function(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()},n._getTexture=function(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture},n._updateMaterial=function(){var t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==ACt.FREE})},n._finishedSimulation=function(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()},n._canRender=function(){return t.prototype._canRender.call(this)&&!this._stopped&&null!==this._renderSpriteFrame},n._render=function(t){this._positionType===ACt.RELATIVE?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===ACt.GROUPED?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)},L(e,[{key:"custom",get:function(){return this._custom},set:function(t){this._custom!==t&&(this._custom=t,this._applyFile())}},{key:"file",get:function(){return this._file},set:function(t){this._file!==t&&(this._file=t,t?this._applyFile():this.custom=!0)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._renderSpriteFrame!==t&&(this._renderSpriteFrame=t,t&&!t._uuid||(this._spriteFrame=t),this._applySpriteFrame())}},{key:"particleCount",get:function(){return this._simulator.particles.length}},{key:"totalParticles",get:function(){return this._totalParticles},set:function(t){this._totalParticles!==t&&(this._totalParticles=t)}},{key:"startColor",get:function(){return this._startColor},set:function(t){this._startColor.r=t.r,this._startColor.g=t.g,this._startColor.b=t.b,this._startColor.a=t.a}},{key:"startColorVar",get:function(){return this._startColorVar},set:function(t){this._startColorVar.r=t.r,this._startColorVar.g=t.g,this._startColorVar.b=t.b,this._startColorVar.a=t.a}},{key:"color",get:function(){return this._color},set:function(){}},{key:"endColor",get:function(){return this._endColor},set:function(t){this._endColor.r=t.r,this._endColor.g=t.g,this._endColor.b=t.b,this._endColor.a=t.a}},{key:"endColorVar",get:function(){return this._endColorVar},set:function(t){this._endColorVar.r=t.r,this._endColorVar.g=t.g,this._endColorVar.b=t.b,this._endColorVar.a=t.a}},{key:"positionType",get:function(){return this._positionType},set:function(t){this._positionType=t,this._updateMaterial()}},{key:"preview",get:function(){return this._preview},set:function(t){t?this._startPreview():this._stopPreview(),this._preview=t}},{key:"stopped",get:function(){return this._stopped}},{key:"active",get:function(){return this._simulator.active}},{key:"assembler",get:function(){return this._assembler}}]),e}(Dq),BAt.EmitterMode=wCt,BAt.PositionType=ACt,BAt.DURATION_INFINITY=-1,BAt.START_SIZE_EQUAL_TO_END_SIZE=-1,BAt.START_RADIUS_EQUAL_TO_END_RADIUS=-1,X((qwt=FAt).prototype,"custom",[bl,ZCt],Object.getOwnPropertyDescriptor(qwt.prototype,"custom"),qwt.prototype),X(qwt.prototype,"file",[JCt,$Ct],Object.getOwnPropertyDescriptor(qwt.prototype,"file"),qwt.prototype),X(qwt.prototype,"spriteFrame",[twt,ewt],Object.getOwnPropertyDescriptor(qwt.prototype,"spriteFrame"),qwt.prototype),X(qwt.prototype,"totalParticles",[bl,nwt],Object.getOwnPropertyDescriptor(qwt.prototype,"totalParticles"),qwt.prototype),Xwt=X(qwt.prototype,"duration",[hl,bl,iwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ywt=X(qwt.prototype,"emissionRate",[hl,bl,rwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Kwt=X(qwt.prototype,"life",[hl,bl,owt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Qwt=X(qwt.prototype,"lifeVar",[hl,bl,awt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(qwt.prototype,"startColor",[bl,swt],Object.getOwnPropertyDescriptor(qwt.prototype,"startColor"),qwt.prototype),X(qwt.prototype,"startColorVar",[bl,cwt],Object.getOwnPropertyDescriptor(qwt.prototype,"startColorVar"),qwt.prototype),X(qwt.prototype,"color",[lwt],Object.getOwnPropertyDescriptor(qwt.prototype,"color"),qwt.prototype),X(qwt.prototype,"endColor",[bl,uwt],Object.getOwnPropertyDescriptor(qwt.prototype,"endColor"),qwt.prototype),X(qwt.prototype,"endColorVar",[bl,hwt],Object.getOwnPropertyDescriptor(qwt.prototype,"endColorVar"),qwt.prototype),Zwt=X(qwt.prototype,"angle",[hl,bl,fwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),Jwt=X(qwt.prototype,"angleVar",[hl,bl,pwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),$wt=X(qwt.prototype,"startSize",[hl,bl,_wt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),tAt=X(qwt.prototype,"startSizeVar",[hl,bl,dwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eAt=X(qwt.prototype,"endSize",[hl,bl,mwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nAt=X(qwt.prototype,"endSizeVar",[hl,bl,vwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iAt=X(qwt.prototype,"startSpin",[hl,bl,gwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rAt=X(qwt.prototype,"startSpinVar",[hl,bl,ywt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oAt=X(qwt.prototype,"endSpin",[hl,bl,xwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aAt=X(qwt.prototype,"endSpinVar",[hl,bl,Swt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sAt=X(qwt.prototype,"sourcePos",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.ZERO.clone()}}),cAt=X(qwt.prototype,"posVar",[hl,bl,bwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.ZERO.clone()}}),X(qwt.prototype,"positionType",[Twt,Ewt],Object.getOwnPropertyDescriptor(qwt.prototype,"positionType"),qwt.prototype),X(qwt.prototype,"preview",[bl,Cwt],Object.getOwnPropertyDescriptor(qwt.prototype,"preview"),qwt.prototype),lAt=X(qwt.prototype,"emitterMode",[hl,bl,wwt,Awt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wCt.GRAVITY}}),uAt=X(qwt.prototype,"gravity",[hl,bl,Pwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.ZERO.clone()}}),hAt=X(qwt.prototype,"speed",[hl,bl,Iwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),fAt=X(qwt.prototype,"speedVar",[hl,bl,Rwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),pAt=X(qwt.prototype,"tangentialAccel",[hl,bl,Dwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),_At=X(qwt.prototype,"tangentialAccelVar",[hl,bl,Owt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dAt=X(qwt.prototype,"radialAccel",[hl,bl,Mwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mAt=X(qwt.prototype,"radialAccelVar",[hl,bl,Nwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vAt=X(qwt.prototype,"rotationIsDir",[hl,bl,Lwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gAt=X(qwt.prototype,"startRadius",[hl,bl,Bwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yAt=X(qwt.prototype,"startRadiusVar",[hl,bl,Fwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xAt=X(qwt.prototype,"endRadius",[hl,bl,zwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SAt=X(qwt.prototype,"endRadiusVar",[hl,bl,Uwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bAt=X(qwt.prototype,"rotatePerS",[hl,bl,kwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TAt=X(qwt.prototype,"rotatePerSVar",[hl,bl,Gwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EAt=X(qwt.prototype,"playOnLoad",[hl,bl,Hwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CAt=X(qwt.prototype,"autoRemoveOnFinish",[hl,bl,Vwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wAt=X(qwt.prototype,"_preview",[jwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AAt=X(qwt.prototype,"_custom",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PAt=X(qwt.prototype,"_file",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IAt=X(qwt.prototype,"_spriteFrame",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RAt=X(qwt.prototype,"_totalParticles",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),DAt=X(qwt.prototype,"_startColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(255,255,255,255)}}),OAt=X(qwt.prototype,"_startColorVar",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(0,0,0,0)}}),MAt=X(qwt.prototype,"_endColor",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(255,255,255,0)}}),NAt=X(qwt.prototype,"_endColorVar",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new di(0,0,0,0)}}),LAt=X(qwt.prototype,"_positionType",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ACt.FREE}}),Wwt=qwt))||Wwt)||Wwt)||Wwt)||Wwt)),nPt=function(){function t(t,e){this.point=new Bi,this.dir=new Bi,this.distance=0,this.time=0,t&&this.point.set(t),e&&this.dir.set(e)}var e=t.prototype;return e.setPoint=function(t,e){this.point.x=t,this.point.y=e},e.setDir=function(t,e){this.dir.x=t,this.dir.y=e},t}(),iPt=t("MotionStreak",(GAt=ol("cc.MotionStreak"),HAt=vl(),VAt=Sl(),jAt=kl(cv),GAt(WAt=ml(WAt=gl(WAt=HAt(WAt=VAt((tPt=$At=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_preview",XAt,V(e)),q(e,"_fadeTime",YAt,V(e)),q(e,"_minSeg",KAt,V(e)),q(e,"_stroke",QAt,V(e)),q(e,"_texture",ZAt,V(e)),q(e,"_fastMode",JAt,V(e)),e._points=[],e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.reset()},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n.onFocusInEditor=function(){this._preview&&this.reset()},n.onLostFocusInEditor=function(){this._preview&&this.reset()},n.reset=function(){this._points.length=0,this._renderData&&this._renderData.clear()},n.lateUpdate=function(t){this._assembler&&this._assembler.update(this,t)},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},L(e,[{key:"preview",get:function(){return this._preview},set:function(t){this._preview=t,this.reset()}},{key:"fadeTime",get:function(){return this._fadeTime},set:function(t){this._fadeTime=t,this.reset()}},{key:"minSeg",get:function(){return this._minSeg},set:function(t){this._minSeg=t}},{key:"stroke",get:function(){return this._stroke},set:function(t){this._stroke=t}},{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t)}},{key:"fastMode",get:function(){return this._fastMode},set:function(t){this._fastMode=t}},{key:"points",get:function(){return this._points}}]),e}(Dq),$At.Point=nPt,X((qAt=tPt).prototype,"preview",[bl],Object.getOwnPropertyDescriptor(qAt.prototype,"preview"),qAt.prototype),X(qAt.prototype,"fadeTime",[bl],Object.getOwnPropertyDescriptor(qAt.prototype,"fadeTime"),qAt.prototype),X(qAt.prototype,"minSeg",[bl],Object.getOwnPropertyDescriptor(qAt.prototype,"minSeg"),qAt.prototype),X(qAt.prototype,"stroke",[bl],Object.getOwnPropertyDescriptor(qAt.prototype,"stroke"),qAt.prototype),X(qAt.prototype,"texture",[jAt],Object.getOwnPropertyDescriptor(qAt.prototype,"texture"),qAt.prototype),X(qAt.prototype,"fastMode",[bl],Object.getOwnPropertyDescriptor(qAt.prototype,"fastMode"),qAt.prototype),XAt=X(qAt.prototype,"_preview",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),YAt=X(qAt.prototype,"_fadeTime",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),KAt=X(qAt.prototype,"_minSeg",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QAt=X(qAt.prototype,"_stroke",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),ZAt=X(qAt.prototype,"_texture",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JAt=X(qAt.prototype,"_fastMode",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WAt=qAt))||WAt)||WAt)||WAt)||WAt)||WAt)),rPt=(new Bi,new Bi),oPt=new Bi;function aPt(t,e){return t.x=-e.y,t.y=e.x,t}var sPt={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,42),e},update:function(t,e){var n,i=t.stroke/2,r=t.node.worldMatrix,o=r.m12,a=r.m13,s=t.points;if(s.length>1){var c=s[0],l=c.point.x-o,u=c.point.y-a;l*l+u*u<t.minSeg&&(n=c)}n||(n=new iPt.Point,s.unshift(n)),n.setPoint(o,a),n.time=t.fadeTime+e;var h,f=0;if(!(s.length<2)){var p=t.renderData;this.updateRenderDataCache(t,p);var _=t.color,d=_.r,m=_.g,v=_.b,g=_.a,y=s[1];y.distance=Bi.subtract(oPt,n.point,y.point).length(),oPt.normalize(),y.setDir(oPt.x,oPt.y),n.setDir(oPt.x,oPt.y),p.dataLength=2*s.length;for(var x=p.data,S=t.fadeTime,b=!1,T=s.length-1;T>=0;T--){var E=s[T],C=E.point,w=E.dir;if(E.time-=e,E.time<0)s.splice(T,1);else{var A=E.time/S,P=s[T-1];if(!b){if(!P){s.splice(T,1);continue}C.x=P.point.x-w.x*A,C.y=P.point.y-w.y*A}b=!0,aPt(rPt,w);var I=(A*g<<24>>>0)+(v<<16)+(m<<8)+d,R=f;x[R].x=C.x+rPt.x*i,x[R].y=C.y+rPt.y*i,x[R].u=1,x[R].v=A,x[R].color._val=I,x[R+=1].x=C.x-rPt.x*i,x[R].y=C.y-rPt.y*i,x[R].u=0,x[R].v=A,x[R].color._val=I,f+=2}}h=f<=2?0:3*(f-2),p.resize(f,h)}},updateRenderDataCache:function(t,e){e.passDirty&&e.updatePass(t),e.nodeDirty&&e.updateNode(t),e.textureDirty&&t.texture&&(e.updateTexture(t.texture),e.material=t.getRenderMaterial(0)),e.hashDirty&&e.updateHash()},updateRenderData:function(){},fillBuffers:function(t){for(var e=t.renderData,n=e.chunk,i=e.data,r=e.vertexCount,o=e.indexCount,a=n.vb,s=0,c=0;c<r;c++){var l=i[c];a[s++]=l.x,a[s++]=l.y,a[s++]=l.z,a[s++]=l.u,a[s++]=l.v,di.toArray(a,l.color,s),s+=4}for(var u=n.bufferId,h=n.vertexOffset,f=n.vertexAccessor.getMeshBuffer(n.bufferId),p=n.vertexAccessor.getIndexBuffer(u),_=f.indexOffset,d=0,m=o;d<m;d+=2){var v=h+d;p[_++]=v,p[_++]=v+2,p[_++]=v+1,p[_++]=v+1,p[_++]=v+2,p[_++]=v+3}f.indexOffset+=e.indexCount,f.setDirty()}},cPt=t("MotionStreakAssemblerManager",{getAssembler:function(){return sPt}});iPt.Assembler=cPt;var lPt,uPt,hPt,fPt={maxParticleDeltaTime:0,createData:function(){return Nj.add()},removeData:function(t){Nj.remove(t)},updateRenderData:function(){},fillBuffers:function(){}},pPt=t("ParticleSystem2DAssembler",{getAssembler:function(){return fPt.maxParticleDeltaTime||(fPt.maxParticleDeltaTime=i.game.frameTime/1e3*2),fPt}});ePt.Assembler=pPt,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(lPt||(lPt={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(uPt||(uPt={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(hPt||(hPt={}));var _Pt,dPt=0;function mPt(t,e){var n;e.invoking||(e.invoking=!0,(n=e.func).call.apply(n,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());var n=t._operationQueue[0];n&&mPt(t,n)})).catch((function(){})))}function vPt(t,e,n){var i=n.value;n.value=function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new Promise((function(e){var r=dPt++,o=t;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),e),mPt(o,o._operationQueue[0])}))}}function gPt(t){return new Promise((function(e){var n=t.play();return void 0===n?e():(n.then(e).catch((function(){var n=function(){t.play().catch((function(){})),e()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var yPt,xPt,SPt=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var e=t.prototype;return e.play=function(){var t=this;gPt(this._domAudio).then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t)})).catch((function(){}))},e.stop=function(){this._domAudio.pause()},L(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),bPt=(X((_Pt=function(){function t(t){var e=this;this._domAudio=void 0,this._state=hPt.INIT,this._onEnded=void 0,this._eventTarget=new fn,this._operationQueue=[],this._domAudio=t,pn.on("hide",this._onHide,this),pn.on("show",this._onShow,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=hPt.INIT,e._eventTarget.emit(lPt.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var e=t.prototype;return e.destroy=function(){pn.off("hide",this._onHide,this),pn.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(e){n(new t(e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=document.createElement("audio"),r="canplaythrough";pn.os===ln.IOS?r="loadedmetadata":pn.browserType===an.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),e(i)},c=function(){a(),n("load audio failure - "+t)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=t}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var e=new SPt(t,n);i(e)})).catch(r)}))},e._onHide=function(){var t=this;this._state===hPt.PLAYING&&this.pause().then((function(){t._state=hPt.INTERRUPTED,t._eventTarget.emit(lPt.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===hPt.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(lPt.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){return t=Qn(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},e.play=function(){var t=this;return new Promise((function(e){gPt(t._domAudio).then((function(){t._state=hPt.PLAYING,e()})).catch((function(){}))}))},e.pause=function(){return this._domAudio.pause(),this._state=hPt.PAUSED,Promise.resolve()},e.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=hPt.STOPPED,e()}))},e.onInterruptionBegin=function(t){this._eventTarget.on(lPt.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(lPt.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(lPt.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(lPt.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(lPt.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(lPt.ENDED,t)},L(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return uPt.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=Zn(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),t}()).prototype,"seek",[vPt],Object.getOwnPropertyDescriptor(_Pt.prototype,"seek"),_Pt.prototype),X(_Pt.prototype,"play",[vPt],Object.getOwnPropertyDescriptor(_Pt.prototype,"play"),_Pt.prototype),X(_Pt.prototype,"pause",[vPt],Object.getOwnPropertyDescriptor(_Pt.prototype,"pause"),_Pt.prototype),X(_Pt.prototype,"stop",[vPt],Object.getOwnPropertyDescriptor(_Pt.prototype,"stop"),_Pt.prototype),_Pt),TPt=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var e=t.prototype;return e.destroy=function(){this._nativeAudio=void 0},e._now=function(){return performance.now()/1e3},e._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},e.start=function(){this._isPaused=!1,this._startTime=this._now()},e.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},e.stop=function(){this._isPaused=!0,this._startOffset=0},e.seek=function(t){this._startTime=this._now(),this._startOffset=Qn(t,0,this.duration)},L(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),EPt=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?console.warn("Audio buffer "+t+" has been cached"):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:console.warn("Audio buffer cache "+t+" has not been added.")},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:console.warn("Audio buffer cache "+t+" has not been added.")},t}()),CPt=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,wPt=function(){function t(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var e=t.prototype;return e.decodeAudioData=function(t){var e=this;return new Promise((function(n){var i=e._context.decodeAudioData(t,(function(t){n(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==i||i.catch((function(){}))}))},e.runContext=function(){var t=this;return new Promise((function(e){var n=t._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(e).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else e();else e()}))},e.createBufferSource=function(t,e){var n=this._context.createBufferSource();return void 0!==t&&(n.buffer=t),void 0!==e&&(n.loop=e),n},e.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},e.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(n){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},e.connectContext=function(t){this._context&&t.connect(this._context.destination)},L(t,[{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();wPt.support=!!CPt,wPt.support&&(xPt=new wPt);var APt,PPt,IPt,RPt,DPt,OPt=function(){function t(t,e,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=n,this._bufferSourceNode=xPt.createBufferSource(t,!1);var i=xPt.createGain(e);this._bufferSourceNode.connect(i),xPt.connectContext(i)}var e=t.prototype;return e.play=function(){var t=this;this._bufferSourceNode.start(),xPt.runContext().then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t),t._currentTimer=window.setTimeout((function(){var e;EPt.tryReleasingCache(t._url),null===(e=t.onEnd)||void 0===e||e.call(t)}),1e3*t._duration)})).catch((function(){}))},e.stop=function(){clearTimeout(this._currentTimer),EPt.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},L(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),MPt=(X((yPt=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=hPt.INIT,this._audioTimer=void 0,this._eventTarget=new fn,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new TPt(t),this._gainNode=xPt.createGain(),xPt.connectContext(this._gainNode),this._src=e,pn.on("hide",this._onHide,this),pn.on("show",this._onShow,this)}var e=t.prototype;return e.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),EPt.tryReleasingCache(this._src),pn.off("hide",this._onHide,this),pn.off("show",this._onShow,this)},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(i){n(new t(i,e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=EPt.getCache(t);if(i)return EPt.retainCache(t),void e(i);var r=new XMLHttpRequest,o="load audio failed: "+t+", status: ";r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?xPt.decodeAudioData(r.response).then((function(n){EPt.addCache(t,n),e(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var r=new OPt(t,n,e);i(r)})).catch(r)}))},e._onHide=function(){var t=this;this._state===hPt.PLAYING&&this.pause().then((function(){t._state=hPt.INTERRUPTED,t._eventTarget.emit(lPt.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===hPt.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(lPt.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){var e=this;return new Promise((function(n){e._audioTimer.seek(t),e._state===hPt.PLAYING?e._doPlay().then(n).catch((function(){})):n()}))},e.play=function(){return this._doPlay()},e._doPlay=function(){var t=this;return new Promise((function(e){t._stopSourceNode(),t._sourceNode=xPt.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),xPt.runContext().then((function(){t._state=hPt.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(lPt.ENDED),t._state=hPt.INIT)}),1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()})).catch((function(){}))}))},e._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(t){}},e.pause=function(){return this._state===hPt.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=hPt.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=hPt.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.onInterruptionBegin=function(t){this._eventTarget.on(lPt.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(lPt.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(lPt.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(lPt.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(lPt.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(lPt.ENDED,t)},L(t,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return uPt.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=Zn(t),this._volume=t,xPt.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}()).prototype,"seek",[vPt],Object.getOwnPropertyDescriptor(yPt.prototype,"seek"),yPt.prototype),X(yPt.prototype,"play",[vPt],Object.getOwnPropertyDescriptor(yPt.prototype,"play"),yPt.prototype),X(yPt.prototype,"pause",[vPt],Object.getOwnPropertyDescriptor(yPt.prototype,"pause"),yPt.prototype),X(yPt.prototype,"stop",[vPt],Object.getOwnPropertyDescriptor(yPt.prototype,"stop"),yPt.prototype),yPt),NPt=function(){function t(t){this._audio=void 0,this._audio=t}var e=t.prototype;return e.play=function(){this._audio.play()},e.stop=function(){this._audio.stop()},L(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),LPt=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==uPt.DOM_AUDIO&&wPt.support?MPt.load(e).then((function(e){i(new t(e))})).catch((function(){})):(wPt.support||E(5201),bPt.load(e).then((function(e){i(new t(e))})).catch((function(){})))}))};var e=t.prototype;return e.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==uPt.DOM_AUDIO&&wPt.support?MPt.loadNative(t):(wPt.support||E(5201),bPt.loadNative(t))},t.loadOneShotAudio=function(t,e,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==uPt.DOM_AUDIO&&wPt.support?MPt.loadOneShotAudio(t,e).then((function(t){i(new NPt(t))})).catch(r):(wPt.support||E(5201),bPt.loadOneShotAudio(t,e).then((function(t){i(new NPt(t))})).catch(r))}))},e.seek=function(t){return this._player.seek(t)},e.play=function(){return this._player.play()},e.pause=function(){return this._player.pause()},e.stop=function(){return this._player.stop()},e.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},e.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},e.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},e.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},e.onEnded=function(t){this._player.onEnded(t)},e.offEnded=function(t){this._player.offEnded(t)},L(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),t}();LPt.maxAudioChannel=24;var BPt=t("AudioClip",ol("cc.AudioClip")((DPt=RPt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_duration",IPt,V(e)),e._loadMode=uPt.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}F(e,t);var n=e.prototype;return n.destroy=function(){var e,n=t.prototype.destroy.call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((function(){}))},n.setVolume=function(t){this._player&&(this._player.volume=t)},n.setLoop=function(t){this._player&&(this._player.loop=t)},n.play=function(){var t;null===(t=this._player)||void 0===t||t.play().catch((function(){}))},n.pause=function(){var t;null===(t=this._player)||void 0===t||t.pause().catch((function(){}))},n.stop=function(){var t;null===(t=this._player)||void 0===t||t.stop().catch((function(){}))},n.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&LPt.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},L(e,[{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=uPt.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:hPt.INIT}}]),e}(Bu),RPt.AudioType=uPt,IPt=X((PPt=DPt).prototype,"_duration",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(PPt.prototype,"_nativeDep",[Ql],Object.getOwnPropertyDescriptor(PPt.prototype,"_nativeDep"),PPt.prototype),APt=PPt))||APt);function FPt(t,e,n){LPt.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var i={player:e,url:t,duration:e.duration,type:e.type};n(null,i)})).catch((function(t){n(t)}))}function zPt(t,e,n,i){var r=new BPt;r._nativeUrl=t,r._nativeAsset=e,r._duration=e.duration,i(null,r)}i.AudioClip=BPt,VN.register({".mp3":FPt,".ogg":FPt,".wav":FPt,".m4a":FPt}),QN.register({".mp3":zPt,".ogg":zPt,".wav":zPt,".m4a":zPt});var UPt,kPt,GPt,HPt,VPt,jPt,WPt,qPt,XPt,YPt,KPt,QPt,ZPt,JPt,$Pt,tIt,eIt,nIt,iIt,rIt=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var n=this._findIndex(t,e);return n>-1?(t[n].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)},e.addPlaying=function(t){if(t instanceof LPt){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var n=this._findIndex(t,e);return-1!==n&&(Q(t,n),!0)},e.removePlaying=function(t){if(t instanceof LPt){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<LPt.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},t}());!function(t){t.STARTED="started",t.ENDED="ended"}(iIt||(iIt={}));var oIt=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((UPt=ol("cc.AudioSource"),kPt=Sl(),GPt=vl(),HPt=kl(BPt),VPt=kl(BPt),jPt=wl(),WPt=wl(),qPt=wl(),XPt=Al(),YPt=wl(),UPt(KPt=kPt(KPt=GPt((nIt=eIt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_clip",ZPt,V(e)),e._player=null,q(e,"_loop",JPt,V(e)),q(e,"_playOnAwake",$Pt,V(e)),q(e,"_volume",tIt,V(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}F(e,t);var n=e.prototype;return n._syncPlayer=function(){var t=this,e=this._clip;this._isLoaded=!1,this._lastSetClip!==e&&(e?e._nativeAsset?(this._lastSetClip=e,LPt.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(n){t._lastSetClip===e?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),t._player=n,n.onEnded((function(){rIt.removePlaying(n),t.node.emit(iIt.ENDED,t)})),n.onInterruptionBegin((function(){rIt.removePlaying(n)})),n.onInterruptionEnd((function(){rIt.addPlaying(n)})),t._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()},n.onDestroy=function(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null},n._getRootNode=function(){for(var t,e,n=this.node,i=null===(t=n)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var t,e,n=this;this._isLoaded?(rIt.discardOnePlayingIfNeeded(),this.state===hPt.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((function(){}))),null===(t=this._player)||void 0===t||t.play().then((function(){rIt.addPlaying(n._player),n.node.emit(iIt.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((function(){rIt.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((function(){rIt.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(t,e){void 0===e&&(e=1),t._nativeAsset?LPt.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){rIt.discardOnePlayingIfNeeded(),t.onPlay=function(){rIt.addPlaying(t)},t.onEnd=function(){rIt.removePlaying(t)},t.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach((function(e){var n;null===(n=t[e])||void 0===n||n.call(t)})),t._operationsBeforeLoading.length=0)})).catch((function(){}))},L(e,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=Qn(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=Qn(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:hPt.INIT}},{key:"playing",get:function(){return this.state===e.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return LPt.maxAudioChannel}}]),e}(ih),eIt.AudioState=hPt,eIt.EventType=iIt,ZPt=X((QPt=nIt).prototype,"_clip",[HPt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JPt=X(QPt.prototype,"_loop",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$Pt=X(QPt.prototype,"_playOnAwake",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tIt=X(QPt.prototype,"_volume",[hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(QPt.prototype,"clip",[VPt,jPt],Object.getOwnPropertyDescriptor(QPt.prototype,"clip"),QPt.prototype),X(QPt.prototype,"loop",[WPt],Object.getOwnPropertyDescriptor(QPt.prototype,"loop"),QPt.prototype),X(QPt.prototype,"playOnAwake",[qPt],Object.getOwnPropertyDescriptor(QPt.prototype,"playOnAwake"),QPt.prototype),X(QPt.prototype,"volume",[XPt,YPt],Object.getOwnPropertyDescriptor(QPt.prototype,"volume"),QPt.prototype),KPt=QPt))||KPt)||KPt)||KPt));Bn(BPt,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:oIt,targetName:"AudioSource"}]),zn(BPt.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(t){return{name:t,suggest:"please use AudioSource.prototype."+t+" instead"}}))),i.AudioSourceComponent=oIt,Gt.setClassAlias(oIt,"cc.AudioSourceComponent");var aIt=function(){function t(){this.originalTarget=null,this.target=null,this.tag=t.TAG_INVALID}var e=t.prototype;return e.clone=function(){var e=new t;return e.originalTarget=null,e.target=null,e.tag=this.tag,e},e.isDone=function(){return!0},e.startWithTarget=function(t){this.originalTarget=t,this.target=t},e.stop=function(){this.target=null},e.step=function(){b(1006)},e.update=function(){b(1007)},e.getTarget=function(){return this.target},e.setTarget=function(t){this.target=t},e.getOriginalTarget=function(){return this.originalTarget},e.setOriginalTarget=function(t){this.originalTarget=t},e.getTag=function(){return this.tag},e.setTag=function(t){this.tag=t},e.reverse=function(){return b(1008),null},e.retain=function(){},e.release=function(){},t}();aIt.TAG_INVALID=-1;var sIt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._duration=0,e._timesForRepeat=1,e}F(e,t);var n=e.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(t){this._duration=t},n.clone=function(){return new e},e}(aIt),cIt=(function(t){function e(e,n){var i;return void 0===n&&(n=1),(i=t.call(this)||this)._speed=0,i._innerAction=null,e&&i.initWithAction(e,n),i}F(e,t);var n=e.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(t){this._speed=t},n.initWithAction=function(t,e){return t?(this._innerAction=t,this._speed=e,!0):(w(1021),!1)},n.clone=function(){var t=new e;return t.initWithAction(this._innerAction.clone(),this._speed),t},n.startWithTarget=function(t){aIt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),aIt.prototype.stop.call(this)},n.step=function(t){this._innerAction.step(t*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new e(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction}}(aIt),0),lIt=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},uIt=function(){function t(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var e=t.prototype;return e._searchElementByTarget=function(t,e){for(var n=0;n<t.length;n++)if(e===t[n].target)return t[n];return null},e._getElement=function(t,e){var n=this._elementPool.pop();return n||(n=new lIt),n.target=t,n.paused=!!e,n},e._putElement=function(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)},e.addAction=function(t,e,n){if(t&&e){null==e.uuid&&(e.uuid="_TWEEN_UUID_"+cIt++);var i=this._hashTargets.get(e);i?i.actions||(i.actions=[]):(i=this._getElement(e,n),this._hashTargets.set(e,i),this._arrayTargets.push(i)),i.target=e,i.actions.push(t),t.startWithTarget(e)}else w(1e3)},e.removeAllActions=function(){for(var t=this._arrayTargets,e=0;e<t.length;e++){var n=t[e];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},e.removeAllActionsFromTarget=function(t){if(null!=t){var e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}},e.removeAction=function(t){if(null!=t){var e=t.getOriginalTarget(),n=this._hashTargets.get(e);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===t){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},e._removeActionByTag=function(t,e,n){for(var i=0,r=e.actions.length;i<r;++i){var o=e.actions[i];if(o&&o.getTag()===t){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e);break}}},e._removeAllActionsByTag=function(t,e,n){for(var i=e.actions.length-1;i>=0;--i){var r=e.actions[i];if(r&&r.getTag()===t){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e)}}},e.removeActionByTag=function(t,e){var n=this;t===aIt.TAG_INVALID&&b(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeActionByTag(t,r,e)}else i.forEach((function(e){n._removeActionByTag(t,e)}))},e.removeAllActionsByTag=function(t,e){var n=this;t===aIt.TAG_INVALID&&b(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeAllActionsByTag(t,r,e)}else i.forEach((function(e){n._removeAllActionsByTag(t,e)}))},e.getActionByTag=function(t,e){t===aIt.TAG_INVALID&&b(1004);var n=this._hashTargets.get(e);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===t)return r}b(1005,t)}return null},e.getNumberOfRunningActionsInTarget=function(t){var e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0},e.pauseTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!0)},e.resumeTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!1)},e.pauseAllRunningActions=function(){for(var t=[],e=this._arrayTargets,n=0;n<e.length;n++){var i=e[n];i&&!i.paused&&(i.paused=!0,t.push(i.target))}return t},e.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])},e.pauseTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])},e.purgeSharedManager=function(){i.director.getScheduler().unscheduleUpdate(this)},e._removeActionAtIndex=function(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)},e._deleteHashElement=function(t){var e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}this._putElement(t),e=!0}return e},e.update=function(t){for(var e,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(e=this._currentTarget).target;if(r instanceof Ye&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!e.paused&&e.actions){for(e.lock=!0,e.actionIndex=0;e.actionIndex<e.actions.length;e.actionIndex++)if(e.currentAction=e.actions[e.actionIndex],e.currentAction){if(e.currentAction.step(t*(e.currentAction._speedMethod?e.currentAction._speed:1)),e.currentAction&&e.currentAction.isDone()){e.currentAction.stop();var o=e.currentAction;e.currentAction=null,this.removeAction(o)}e.currentAction=null}e.lock=!1}0===e.actions.length&&this._deleteHashElement(e)&&i--}}},t}(),hIt=t("TweenSystem",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).actionMgr=new uIt,e}return F(e,t),e.prototype.update=function(t){this.actionMgr.update(t)},L(e,[{key:"ActionManager",get:function(){return this.actionMgr}}]),e}(UM));hIt.ID="TWEEN",hIt.instance=void 0,$M.on(JM.EVENT_INIT,(function(){var t=new hIt;hIt.instance=t,$M.registerSystem(hIt.ID,t,UM.Priority.MEDIUM)}));var fIt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new e},e}(sIt),pIt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(TF),e=0;e<t.length;++e)t[e].enabled=!0},n.reverse=function(){return new _It},n.clone=function(){return new e},e}(fIt),_It=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(TF),e=0;e<t.length;++e)t[e].enabled=!1},n.reverse=function(){return new pIt},n.clone=function(){return new e},e}(fIt);!function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;n.update=function(){for(var t=this.target.getComponentsInChildren(TF),e=0;e<t.length;++e){var n=t[e];n.enabled=!n.enabled}},n.reverse=function(){return new e},n.clone=function(){return new e}}(fIt);var dIt=function(t){function e(e){var n;return(n=t.call(this)||this)._isNeedCleanUp=!0,void 0!==e&&n.init(e),n}F(e,t);var n=e.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(t){return this._isNeedCleanUp=t,!0},n.reverse=function(){return new e(this._isNeedCleanUp)},n.clone=function(){return new e(this._isNeedCleanUp)},e}(fIt),mIt=function(t){function e(e,n,i){var r;return(r=t.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(e,n,i),r}F(e,t);var n=e.prototype;return n.initWithFunction=function(t,e,n){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)},n.clone=function(){var t=new e;return t.initWithFunction(this._function,this._selectorTarget,this._data),t},e}(fIt),vIt=function(t){function e(e){var n;return(n=t.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===e||isNaN(e)||n.initWithDuration(e),n}F(e,t);var n=e.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(t){return this._duration=0===t?$t.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod},n._reverseEaseList=function(t){if(this._easeList){t._easeList=[];for(var e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}},n.clone=function(){var t=new e(this._duration);return this._cloneDecoration(t),t},n.easing=function(t){this._easeList?this._easeList.length=0:this._easeList=[];for(var e=0;e<arguments.length;e++)this._easeList.push(arguments[e]);return this},n._computeEaseTime=function(t){return t},n.step=function(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;var e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(t){aIt.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return b(1010),this},n.setAmplitudeRate=function(){b(1011)},n.getAmplitudeRate=function(){return b(1012),0},n.speed=function(t){return t<=0?(b(1013),this):(this._speedMethod=!0,this._speed*=t,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(t){return this._speed=t,this},n.repeat=function(t){return t=Math.round(t),isNaN(t)||t<1?(b(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},e}(sIt),gIt=function(t){function e(n){var i;(i=t.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return w(1019),V(i);var o=r.length-1;if(o>=0&&null==r[o]&&b(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}F(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return w(1025),!1;var n=t._duration,i=e._duration,r=(n*=t._repeatMethod?t._timesForRepeat:1)+(i*=e._repeatMethod?e._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=t,this._actions[1]=e,!0},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t},n.startWithTarget=function(t){vIt.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),aIt.prototype.stop.call(this)},n.update=function(t){var e,n,i=0,r=this._split,o=this._actions,a=this._last;(t=this._computeEaseTime(t))<r?(e=0!==r?t/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,e=1===r?1:(t-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),e*=n._timesForRepeat,n.update(e>1?e%1:e),this._last=i)},n.reverse=function(){var t=e._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t},e}(vIt);function yIt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return w(1019),null;var n=e.length-1;n>=0&&null==e[n]&&b(1015);var i=null;if(n>=0){i=e[0];for(var r=1;r<=n;r++)e[r]&&(i=gIt._actionOneTwo(i,e[r]))}return i}gIt._actionOneTwo=function(t,e){var n=new gIt;return n.initWithTwoActions(t,e),n};var xIt=function(t){function e(e,n){var i;return(i=t.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(e,n),i}F(e,t);var n=e.prototype;return n.initWithAction=function(t,e){var n=t._duration*e;return!!this.initWithDuration(n)&&(this._times=e,this._innerAction=t,t instanceof fIt&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t},n.startWithTarget=function(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,vIt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),aIt.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t);var e=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(t>=r){for(;t>r&&this._total<i;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),r+=e._duration/n,this._nextDt=r>1?1:r;t>=1&&this._total<i&&(e.update(1),this._total++),this._actionInstant||(this._total===i?e.stop():e.update(t-(r-e._duration/n)))}else e.update(t*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var t=new e(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(vIt),SIt=function(t){function e(e){var n;return(n=t.call(this)||this)._innerAction=null,e&&n.initWithAction(e),n}F(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?(this._innerAction=t,!0):(w(1026),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t},n.startWithTarget=function(t){vIt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.step=function(t){var e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))},n.isDone=function(){return!1},n.reverse=function(){var t=new e(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(vIt),bIt=function(t){function e(n){var i;(i=t.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return w(1020),V(i);var o=r.length-1;if(o>=0&&null==r[o]&&b(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}F(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return w(1027),!1;var n=!1,i=t._duration,r=e._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=t,this._two=e,i>r?this._two=gIt._actionOneTwo(e,CIt(i-r)):i<r&&(this._one=gIt._actionOneTwo(t,CIt(r-i))),n=!0),n},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t},n.startWithTarget=function(t){vIt.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)},n.stop=function(){this._one.stop(),this._two.stop(),aIt.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)},n.reverse=function(){var t=e._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},e}(vIt);function TIt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return w(1020),null;e.length>0&&null==e[e.length-1]&&b(1015);for(var n=e[0],i=1;i<e.length;i++)null!=e[i]&&(n=bIt._actionOneTwo(n,e[i]));return n}bIt._actionOneTwo=function(t,e){var n=new bIt;return n.initWithTwoActions(t,e),n};var EIt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.update=function(){},n.reverse=function(){var t=new e(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithDuration(this._duration),t},e}(vIt);function CIt(t){return new EIt(t)}var wIt=function(t){function e(e){var n;return(n=t.call(this)||this)._other=null,e&&n.initWithAction(e),n}F(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?t===this._other?(w(1029),!1):!!vIt.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(w(1028),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t},n.startWithTarget=function(t){vIt.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)},n.update=function(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),aIt.prototype.stop.call(this)},e}(vIt),AIt=t("TweenAction",function(t){function e(e,n,i){var o;if((o=t.call(this)||this)._opts=void 0,o._props=void 0,o._originProps=void 0,null==i)i=Object.create(null);else if(function(t){var e=" [Tween:] ",n=" option is not support in v + "+r,i=t;i.delay&&_(e+"delay"+n),i.repeat&&_(e+"repeat"+n),i.repeatDelay&&_(e+"repeatDelay"+n),i.interpolation&&_(e+"interpolation"+n),i.onStop&&_(e+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){var e=t.charAt(0);if(/[A-Z]/.test(e)){var n=(t=t.replace(e,e.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)t="linear";else{var r=n[1];switch(i){case"quadratic":t="quad"+r;break;case"quartic":t="quart"+r;break;case"quintic":t="quint"+r;break;case"sinusoidal":t="sine"+r;break;case"exponential":t="expo"+r;break;case"circular":t="circ"+r;break;default:t=i+r}}}}return t}(i.easing)),i.progress||(i.progress=o.progress),i.easing&&"string"==typeof i.easing){var a=i.easing;i.easing=op[a],i.easing||E(1031,a)}for(var s in o._opts=i,o._props=Object.create(null),n)if(n.hasOwnProperty(s)){var c=n[s];if("function"==typeof c&&(c=c()),null!=c&&"string"!=typeof c){var l=void 0,u=void 0;void 0!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?(l=op[c.easing])||E(1031,c.easing):l=c.easing,u=c.progress,c=c.value);var h=Object.create(null);h.value=c,h.easing=l,h.progress=u,o._props[s]=h}}return o._originProps=n,o.initWithDuration(e),o}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t},n.startWithTarget=function(t){vIt.prototype.startWithTarget.call(this,t);var e=!!this._opts.relative,n=this._props;for(var i in n){var r=t[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=e?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=e?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(t){var e=this.target;if(e){var n=this._props,i=this._opts,r=t;i.easing&&(r=i.easing(t));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(t):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var f in u)s.current[f]=l(u[f],h[f],s.current[f],c);e[a]=s.current}i.onUpdate&&i.onUpdate(this.target,t),1===t&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(t,e,n,i){return t+(e-t)*i},e}(vIt)),PIt=function(t){function e(e){var n;return(n=t.call(this)||this)._props=void 0,n._props={},void 0!==e&&n.init(e),n}F(e,t);var n=e.prototype;return n.init=function(t){for(var e in t)this._props[e]=t[e];return!0},n.update=function(){var t=this._props,e=this.target;for(var n in t)e[n]=t[n]},n.clone=function(){var t=new e;return t.init(this._props),t},e}(fIt),IIt=t("Tween",function(){function t(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=aIt.TAG_INVALID,this._target=void 0===t?null:t}var e=t.prototype;return e.tag=function(t){return this._tag=t,this},e.then=function(t){return t instanceof aIt?this._actions.push(t.clone()):this._actions.push(t._union()),this},e.target=function(t){return this._target=t,this},e.start=function(){return this._target?(this._finalAction&&hIt.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),hIt.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(_("Please set target to tween first"),this)},e.stop=function(){return this._finalAction&&hIt.instance.ActionManager.removeAction(this._finalAction),this},e.clone=function(t){var e=this._union();return RIt(t).then(e.clone())},e.union=function(){var t=this._union();return this._actions.length=0,this._actions.push(t),this},e.to=function(t,e,n){(n=n||Object.create(null)).relative=!1;var i=new AIt(t,e,n);return this._actions.push(i),this},e.by=function(t,e,n){(n=n||Object.create(null)).relative=!0;var i=new AIt(t,e,n);return this._actions.push(i),this},e.set=function(t){var e=new PIt(t);return this._actions.push(e),this},e.delay=function(t){var e=CIt(t);return this._actions.push(e),this},e.call=function(t){var e=function(t){return new mIt(t,void 0,void 0)}(t);return this._actions.push(e),this},e.sequence=function(){var e=t._wrappedSequence.apply(t,arguments);return this._actions.push(e),this},e.parallel=function(){var e=t._wrappedParallel.apply(t,arguments);return this._actions.push(e),this},e.repeat=function(e,n){if(e===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof t?n._union():r.pop(),r.push(function(t,e){return new xIt(t,e)}(i,e)),this},e.repeatForever=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new SIt(t)}(n)),this},e.reverseTime=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new wIt(t)}(n)),this},e.hide=function(){var t=new _It;return this._actions.push(t),this},e.show=function(){var t=new pIt;return this._actions.push(t),this},e.removeSelf=function(){var t=new dIt(!1);return this._actions.push(t),this},t.stopAll=function(){hIt.instance.ActionManager.removeAllActions()},t.stopAllByTag=function(t,e){hIt.instance.ActionManager.removeAllActionsByTag(t,e)},t.stopAllByTarget=function(t){hIt.instance.ActionManager.removeAllActionsFromTarget(t)},e._union=function(){var t=this._actions;return 1===t.length?t[0]:yIt(t)},e._destroy=function(){this.stop()},t._wrappedSequence=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return yIt.apply(yIt,e)},t._wrappedParallel=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return TIt.apply(TIt,e)},t}());function RIt(t){return new IIt(t)}function DIt(t){return _("tweenUtil' is deprecated, please use 'tween' instead "),new IIt(t)}IIt._tmp_args=[],i.Tween=IIt,i.tween=RIt,i.tweenUtil=DIt}}}));
