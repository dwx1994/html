System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:re,CCClass:Ze,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:oe,Eventify:tu,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Ew,WorldNode3DToWorldNodeUI:Pw,absMax:bi,absMaxComponent:Si,approx:oi,assert:C,assertID:L,bezier:Of,bezierByTime:Qf,ccenum:ce,clamp:ai,clamp01:si,color:wi,computeRatioByType:lV,createDefaultPipeline:wO,debug:A,deserialize:Lh,earcut:yJ,enumerableProps:Ci,equals:ri,error:b,errorID:O,find:bD,fragmentText:WG,getBaselineOffset:function(){return 0},getError:F,getPathFromRoot:function(t,e){for(var i=t,n="";null!==i&&i!==e;)n=i.name+"/"+n,i=i.parent;return n.slice(0,-1)},getSerializationMetadata:function(t){return t[yc]},getWorldTransformUntilRoot:VU,instantiate:$h,inverseLerp:xi,isCustomTargetModifier:qU,isDisplayStats:z,isElementModifier:WU,isPropertyModifier:jU,isUnicodeCJK:UG,isUnicodeSpace:GG,isValid:ml,lerp:ci,log:x,logID:I,markAsWarning:void 0,mat4:Wi,murmurhash2_32_gc:go,nextPow2:vi,pingPong:yi,pseudoRandom:pi,pseudoRandomRange:di,pseudoRandomRangeInt:mi,quat:ki,randomRange:_i,randomRangeInt:fi,rect:nn,removeProperty:void 0,repeat:gi,replaceProperty:void 0,safeMeasureText:HG,sampleAnimationCurve:cV,setDefaultLogTimes:function(t){t>0&&(X=t)},setDisplayStats:V,size:tn,toDegree:ui,toRadian:li,tween:Lgt,tweenUtil:Fgt,v2:Ki,v3:Ri,v4:Qi,warn:S,warnID:D});var i=2147483647;function n(t){return(t>0)-(t<0)}function r(t){var e,i;return e=(t>65535)<<4,e|=i=((t>>>=e)>255)<<3,e|=i=((t>>>=i)>15)<<2,(e|=i=((t>>>=i)>3)<<1)|(t>>>=i)>>1}function o(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function a(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}var s=new Array(256);!function(t){for(var e=0;e<256;++e){var i=e,n=e,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;t[e]=n<<r&255}}(s);var c=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:i,INT_MIN:-2147483648,sign:n,abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:r,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:o,nextPow2:a,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return s[255&t]<<24|s[t>>>8&255]<<16|s[t>>>16&255]<<8|s[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,i){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>o(t)+1}});t("bits",c);var l="undefined"==typeof window?global:window,u=t("cclegacy",{_global:l});u.internal={},l.CC_BUILD=!0,l.CC_TEST=!1,l.CC_EDITOR=false,l.CC_PREVIEW=!1,l.CC_DEV=!1,l.CC_DEBUG=!1,l.CC_JSB=!1,l.CC_BYTEDANCE=!1,l.CC_WECHAT=!1,l.CC_ALIPAY=!1,l.CC_XIAOMI=!1,l.CC_BAIDU=!1,l.CC_COCOSPLAY=!1,l.CC_HUAWEI=!1,l.CC_OPPO=!1,l.CC_VIVO=!1,l.CC_MINIGAME=!1,l.CC_RUNTIME_BASED=!1,l.CC_SUPPORT_JIT=!0;var h=t("VERSION","3.4.2");l.CocosEngine=u.ENGINE_VERSION=h,l.cc=u;var _="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",f=null,p=console.log.bind(console),d=p,m=p,v=function(t,e){if(!t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+y.apply(void 0,[e].concat(n)))}},g=p;function y(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return u.js.formatStr.apply(null,[t].concat(i))}function x(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return p.apply(void 0,[t].concat(i))}function S(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return d.apply(void 0,[t].concat(i))}function b(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return m.apply(void 0,[t].concat(i))}function C(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return v.apply(void 0,[t,e].concat(n))}function A(){return g.apply(void 0,arguments)}function T(t){if(p=d=m=v=g=function(){},t!==B.NONE){if(t>B.ERROR){var e=function(t){if(u.game.canvas){if(!f){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",u.game.canvas.height);var i=e.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(f=document.createElement("textarea")).setAttribute("rows","20"),f.setAttribute("cols","30"),f.setAttribute("disabled","true");var n=f.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",e.appendChild(f),u.game.canvas.parentNode.appendChild(e)}f.value=f.value+t+"\r\n",f.scrollTop=f.scrollHeight}};m=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];e("ERROR :  "+y.apply(void 0,[t].concat(n)))},v=function(t,i){if(!t){for(var n=arguments.length,r=new Array(n>2?n-2:0),o=2;o<n;o++)r[o-2]=arguments[o];e("ASSERT: "+y.apply(void 0,[i].concat(r)))}},t!==B.ERROR_FOR_WEB_PAGE&&(d=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];e("WARN :  "+y.apply(void 0,[t].concat(n)))}),t===B.INFO_FOR_WEB_PAGE&&(p=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];e(y.apply(void 0,[t].concat(n)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),m=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return console.error.apply(console,[t].concat(i))},v=function(t,e){if(!t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var o=y.apply(void 0,[e].concat(n));throw new Error(o)}});if(t!==B.ERROR&&(d=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return console.warn.apply(console,[t].concat(i))}),t<=B.INFO&&(p=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return console.log.apply(console,[t].concat(i))}),t<=B.VERBOSE&&"function"==typeof console.debug){var i=console.debug.bind(console);g=function(){return i.apply(void 0,arguments)}}}}function w(t){b(t.stack||t)}function E(t){return function(e){for(var i=t+" "+e+", please go to "+_+"#"+e+" to see details.",n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return 0===r.length?i:i+" Arguments: "+r.join(", ")}}var P=E("Log");function I(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];x(P.apply(void 0,[t].concat(i)))}var R=E("Warning");function D(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];S(R.apply(void 0,[t].concat(i)))}var M=E("Error");function O(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];b(M.apply(void 0,[t].concat(i)))}var B,N=E("Assert");function L(t,e){if(!t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];C(!1,N.apply(void 0,[e].concat(n)))}}function F(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return M.apply(void 0,[t].concat(i))}function z(){return!!u.profiler&&u.profiler.isShowingStats()}function V(t){u.profiler&&(t?u.profiler.showStats():u.profiler.hideStats(),u.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(B||(B=t("DebugMode",{})));var k,U,G,H,j,W,q=Object.freeze({__proto__:null,log:x,warn:S,error:b,assert:C,debug:A,_resetDebugSetting:T,_throw:w,logID:I,warnID:D,errorID:O,assertID:L,get DebugMode(){return B},getError:F,isDisplayStats:z,setDisplayStats:V}),X=10,Y=0,K=new Map;function J(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function Q(t,e,i){return e&&J(t.prototype,e),i&&J(t,i),t}function Z(){return(Z=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t}).apply(this,arguments)}function $(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,et(t,e)}function tt(t){return(tt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function et(t,e){return(et=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function it(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function nt(t,e,i){return(nt=it()?Reflect.construct:function(t,e,i){var n=[null];n.push.apply(n,e);var r=new(Function.bind.apply(t,n));return i&&et(r,i.prototype),r}).apply(null,arguments)}function rt(t){var e="function"==typeof Map?new Map:void 0;return(rt=function(t){if(null===t||(i=t,-1===Function.toString.call(i).indexOf("[native code]")))return t;var i;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return nt(t,arguments,tt(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),et(n,t)})(t)}function ot(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function at(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function st(t,e){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return at(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?at(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(i=t[Symbol.iterator]()).next.bind(i)}function ct(t,e,i,n){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function lt(t,e,i,n,r){var o={};return Object.keys(n).forEach((function(t){o[t]=n[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(t,e,i)||i}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}H=function(t,e,i,n,r,o,a){var s=K.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,i+"."+n),s.count++)},k=t("replaceProperty",(function(t,e,i){null!=t&&i.forEach((function(i){var n=Y++;K.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:X});var r=null!=i.target?i.target:t,o=null!=i.newName?i.newName:i.name,a=null!=i.targetName?i.targetName:e,s=r===t,c=i.suggest?"("+i.suggest+")":"";if(null!=i.customFunction)t[i.name]=function(){var t;return H(e,i.name,a,o,S,n,c),(t=i.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=i.customSetter||null!=i.customGetter){var l=null!=i.customSetter,u=null!=i.customGetter;l&&u?Object.defineProperty(t,i.name,{get:function(){return H(e,i.name,a,o,S,n,c),i.customGetter.call(this)},set:function(t){H(e,i.name,a,o,S,n,c),i.customSetter.call(this,t)},enumerable:!1}):l?Object.defineProperty(t,i.name,{set:function(t){H(e,i.name,a,o,S,n,c),i.customSetter.call(this,t)},enumerable:!1}):u&&Object.defineProperty(t,i.name,{get:function(){return H(e,i.name,a,o,S,n,c),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,i.name,{get:function(){return H(e,i.name,a,o,S,n,c),s?this[o]:r[o]},set:function(t){H(e,i.name,a,o,S,n,c),s?this[o]=t:r[o]=t},enumerable:!1})}))})),W=function(t,e,i,n,r){var o=K.get(n);o&&o.logTimes>o.count&&(i("'%s' has been removed. "+r,t+"."+e),o.count++)},U=t("removeProperty",(function(t,e,i){null!=t&&i.forEach((function(i){var n=Y++;K.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:X});var r=i.suggest?"("+i.suggest+")":"";Object.defineProperty(t,i.name,{get:function(){return W(e,i.name,b,n,r)},set:function(){W(e,i.name,b,n,r)},enumerable:!1})}))})),j=function(t,e,i,n,r){var o=K.get(n);o&&o.logTimes>o.count&&(i("'%s' is deprecated. "+r,t+"."+e),o.count++)},G=t("markAsWarning",(function(t,e,i){null!=t&&i.forEach((function(i){var n=i.name,r=Object.getOwnPropertyDescriptor(t,n);if(r&&r.configurable){var o=Y++;K.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:X});var a=i.suggest?"("+i.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;t[n]=function(){return j(e,n,S,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(t,n,{configurable:!0,get:function(){return j(e,n,S,o,a),c}}),r.writable&&Object.defineProperty(t,n,{set:function(t){j(e,n,S,o,a),c=t}})}else!function(e,i,n,r,o,a){if(e.get){var s=e.get;e.get=function(){return j(i,n,r,o,a),s.call(this)}}if(e.set){var c=e.set;e.set=function(t){j(i,n,r,o,a),c.call(this,t)}}Object.defineProperty(t,n,e)}(r,e,n,S,o,a);Object.defineProperty(t,n,{enumerable:!1})}}))}));var ut=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},Q(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function ht(t,e){t.splice(e,1)}function _t(t,e){var i=t.length;e<0||e>=i||(t[e]=t[i-1],t.length=i-1)}function ft(t,e){var i=t.indexOf(e);return i>=0&&(ht(t,i),!0)}function pt(t,e){return t.indexOf(e)>=0}var dt=Object.freeze({__proto__:null,removeAt:ht,fastRemoveAt:_t,remove:ft,fastRemove:function(t,e){var i=t.indexOf(e);i>=0&&(t[i]=t[t.length-1],--t.length)},removeIf:function(t,e){var i=t.findIndex(e);if(i>=0){var n=t[i];return ht(t,i),n}},verifyType:function(t,e){if(t&&t.length>0)for(var i,n=st(t);!(i=n()).done;)if(!(i.value instanceof e))return I(1300),!1;return!0},removeArray:function(t,e){for(var i=0,n=e.length;i<n;i++)ft(t,e[i])},appendObjectsAt:function(t,e,i){return t.splice.apply(t,[i,0].concat(e)),t},contains:pt,copy:function(t){for(var e=t.length,i=new Array(e),n=0;n<e;n+=1)i[n]=t[n];return i},MutableForwardIterator:ut}),mt=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();mt.global=new mt("global");var vt=new mt("TmpCId."),gt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),yt="__cid__";function xt(t){return"number"==typeof t||t instanceof Number}function St(t){return"string"==typeof t||t instanceof String}function bt(t){for(var e in t)return!1;return!0}var Ct,At=(Ct={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,i,n,r){Ct.value=i,Ct.writable=n,Ct.enumerable=r,Object.defineProperty(t,e,Ct),Ct.value=void 0}),Tt=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,i,n,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),t.get=n,t.set=r,t.enumerable=o,t.configurable=a,Object.defineProperty(e,i,t),t.get=void 0,t.set=void 0}}(),wt=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,i,n,r,o){t.get=n,t.enumerable=r,t.configurable=o,Object.defineProperty(e,i,t),t.get=void 0}}(),Et=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,i,n,r,o){t.set=n,t.enumerable=r,t.configurable=o,Object.defineProperty(e,i,t),t.set=void 0}}();function Pt(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function It(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var i="";if(t.name&&(i=t.name),t.toString){var n,r=t.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}return t&&t.constructor?It(t.constructor):""}function Rt(t,e,i,n){var r=/([^.]+)$/,o=r.exec(e)[0],a=r.exec(i)[0];function s(){return this[a]}n?Tt(t,o,s,(function(t){this[a]=t})):wt(t,o,s)}function Dt(t,e,i,n){for(var r in i)Rt(t,e+"."+r,i[r],n)}var Mt=/(%d)|(%s)/,Ot=/%s/;function Bt(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+t;var r="string"==typeof t&&Mt.test(t);if(r)for(var o,a=st(i);!(o=a()).done;){var s=o.value,c="number"==typeof s?Mt:Ot;if(c.test(t)){var l=""+s;t=t.replace(c,l)}else t+=" "+s}else for(var u,h=st(i);!(u=h()).done;){var _=u.value;t+=" "+_}return t}function Nt(){for(var t=arguments.length-1,e=new Array(t),i=0;i<t;++i)e[i]=arguments[i+1];return e}function Lt(t,e){for(;t;){var i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}return null}function Ft(t,e,i){var n=Lt(e,t);n&&Object.defineProperty(i,t,n)}function zt(t){t=t||{};for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];for(var r=0,o=i;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){O(5402,a);continue}for(var s in a)s in t||Ft(s,a,t)}}return t}function Vt(t){t=t||{};for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];for(var r=0,o=i;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){O(5403,a);continue}for(var s in a)Ft(s,a,t)}}return t}function kt(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Ut(t){var e=t.prototype,i=e&&Object.getPrototypeOf(e);return i&&i.constructor}function Gt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Ut(t)))return!1;if(t===e)return!0}}return!1}function Ht(t){for(var e=0,i=Object.keys(t);e<i.length;e++)delete t[i[e]]}var jt=Pt(!0),Wt=Pt(!0);function qt(t,e){return function(i,n){if(n.prototype.hasOwnProperty(t)&&delete e[n.prototype[t]],At(n.prototype,t,i),i){var r=e[i];r&&r!==n?b("A Class already exists with the same "+t+' : "'+i+'".'):e[i]=n}}}var Xt=qt("__cid__",jt),Yt=qt("__classname__",Wt);function Kt(t,e){if(Yt(t,e),!e.prototype.hasOwnProperty(yt)){var i=t||vt.getNewId();i&&Xt(i,e)}}function Jt(t,e){var i=Wt[e],n=jt[e],r=!0;if(i&&i!==t&&(b('"'+e+'" has already been set as name or alias of another class.'),r=!1),n&&n!==t&&(b('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var o=t[gt];o||(o=[],t[gt]=o),o.push(e),Wt[e]=t,jt[e]=t}}function Qt(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];for(var n=0,r=e;n<r.length;n++){var o=r[n],a=o.prototype,s=a.__cid__;s&&delete jt[s];var c=a.__classname__;c&&delete Wt[c];var l=a[gt];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Wt[h],delete jt[h]}}}function Zt(t){return jt[t]}function $t(t){return Wt[t]}function te(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(yt))return t.prototype.__cid__;if(t&&t.constructor){var i=t.constructor.prototype;if(i&&i.hasOwnProperty(yt))return t.__cid__}return""}var ee=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var i=void 0===e?t:e,n=void 0===e?null:t;this.count=0,this._pool=new Array(i),this._cleanup=n}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),ie=dt,ne={IDGenerator:mt,Pool:ee,array:dt,isNumber:xt,isString:St,isEmptyObject:bt,getPropertyDescriptor:Lt,addon:zt,mixin:Vt,extend:kt,getSuper:Ut,isChildClassOf:Gt,clear:Ht,value:At,getset:Tt,get:wt,set:Et,unregisterClass:Qt,getClassName:It,setClassName:Kt,setClassAlias:Jt,getClassByName:$t,get _registeredClassNames(){return Z({},Wt)},set _registeredClassNames(t){Ht(Wt),Object.assign(Wt,t)},get _registeredClassIds(){return Z({},jt)},set _registeredClassIds(t){Ht(jt),Object.assign(jt,t)},_getClassId:te,_setClassId:Xt,_getClassById:Zt,obsolete:Rt,obsoletes:Dt,formatStr:Bt,shiftArguments:Nt,createMap:Pt};function re(t){if("__bitmask__"in t)return t;At(t,"__bitmask__",null,!0);for(var e=-1,i=Object.keys(t),n=0;n<i.length;n++){var r=i[n],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&At(t,a,r)}return t}function oe(t){return"__enums__"in t?t:(At(t,"__enums__",null,!0),oe.update(t))}function ae(t){t.hasOwnProperty("__enums__")}function se(t){ae(t);var e=t.__enums__||[];for(var i in e.length=0,t){var n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function ce(t){"__enums__"in t||At(t,"__enums__",null,!0)}u.js=ne,t("js",Object.freeze({__proto__:null,array:ie,js:ne,IDGenerator:mt,Pool:ee,isNumber:xt,isString:St,isEmptyObject:bt,value:At,getset:Tt,get:wt,set:Et,createMap:Pt,getClassName:It,obsolete:Rt,obsoletes:Dt,formatStr:Bt,shiftArguments:Nt,getPropertyDescriptor:Lt,addon:zt,mixin:Vt,extend:kt,getSuper:Ut,isChildClassOf:Gt,clear:Ht,_idToClass:jt,_nameToClass:Wt,_setClassId:Xt,setClassName:Kt,setClassAlias:Jt,unregisterClass:Qt,_getClassById:Zt,getClassByName:$t,_getClassId:te})),re.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},re.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var i in t){var n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort((function(t,e){return t.value-e.value})),e},u.BitMask=re,oe.update=function(t){for(var e=-1,i=Object.keys(t),n=0;n<i.length;n++){var r=i[n],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&At(t,a,r)}return Array.isArray(t.__enums__)&&se(t),t},oe||(oe=t("Enum",{})),oe.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},oe.getList=function(t){return ae(t),t.__enums__?t.__enums__:se(t)},u.Enum=oe;var le=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return O(100,It(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){O(100,It(this)+".set")},e.toString=function(){return""+{}},t}());Kt("cc.ValueType",le),u.ValueType=le;var ue=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});u.macro=ue;for(var he=/^(?:cc|dragonBones|sp|ccsg)\..+/,_e=new Array(123),fe=0;fe<123;++fe)_e[fe]=64;for(var pe=0;pe<64;++pe)_e["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(pe)]=pe;var de=_e;function me(t,e,i){function n(t,e,i,n){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[i]=r.get),r.set&&n&&(t[n]=r.set);else{var o=t[i];Tt(t,e,o,t[n])}}for(var r,o=t.prototype,a=0;a<e.length;a++){var s=(r=e[a])[0].toUpperCase()+r.slice(1);n(o,r,"get"+s,"set"+s)}for(r in i){var c=i[r];n(o,r,c[0],c[1])}}function ve(t,e,i,n){var r=t[e];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):t[e]=n?[i,r]:[r,i]:t[e]=i}function ge(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var i=e.parentNode;if(i)do{if(i===t)return!0;i=i.parentNode}while(null!==i);return!1}function ye(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function xe(t,e,i){t&&setTimeout((function(){t(e,i)}),0)}function Se(t){return!(!t||t.constructor!==Object)&&bt(t)}function be(t,e,i){if(e>i){var n=e;e=i,i=n}return t<e?e:t<i?t:i}function Ce(t){return t*ue.RAD}function Ae(t){return t*ue.DEG}u.misc={BUILTIN_CLASSID_RE:he,BASE64_VALUES:de,propertyDefine:me,pushToMap:ve,contains:ge,isDomNode:ye,callInNextTick:xe,isPlainEmptyObj_DEV:Se,clampf:be,degreesToRadians:Ce,radiansToDegrees:Ae},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:he,BASE64_VALUES:de,propertyDefine:me,pushToMap:ve,contains:ge,isDomNode:ye,callInNextTick:xe,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:Se,clampf:be,degreesToRadians:Ce,radiansToDegrees:Ae}));var Te="$_$";function we(t,e){var i=e?Object.create(e):{};return At(t,"__attrs__",i),i}function Ee(t){if("function"!=typeof t)return we(t,Ie(t.constructor));for(var e,i=u.Class.getInheritanceChain(t),n=i.length-1;n>=0;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||we(r,(e=i[n+1])&&e.__attrs__)}return we(t,(e=i[0])&&e.__attrs__),t.__attrs__}function Pe(t,e){var i=Ie(t),n=e+Te,r={};for(var o in i)o.startsWith(n)&&(r[o.slice(n.length)]=i[o]);return r}function Ie(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||Ee(t)}function Re(t,e,i,n){Ie(t)[e+Te+i]=n}var De=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),Me=t("CCInteger",new De("Integer",0));u.Integer=Me,u.CCInteger=Me;var Oe=t("CCFloat",new De("Float",0));u.Float=Oe,u.CCFloat=Oe;var Be=t("CCBoolean",new De("Boolean",!1));u.Boolean=Be,u.CCBoolean=Be;var Ne=t("CCString",new De("String",""));function Le(t,e){return function(i,n){var r='"'+It(i)+"."+n+'"',o=Pe(i,n),a=o.type;if(a===Me||a===Oe?a="Number":a!==Ne&&a!==Be||(a=""+a),a===t){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!Se(s)){var c=typeof s,l=t.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;D(3605,r,It(o.ctor))}else"Number"!==t&&D(3606,e,r,t);else{if("function"===c)return;t===Ne.default&&null==s?D(3607,r):D(3611,e,r,c)}delete o.type}}}else D(3604,r)}}u.String=Ne,u.CCString=Ne;var Fe=Object.freeze({__proto__:null,DELIMETER:Te,createAttrsSingle:we,createAttrs:Ee,attr:Pe,getClassAttrs:Ie,setClassAttr:Re,PrimitiveType:De,CCInteger:Me,CCFloat:Oe,CCBoolean:Be,CCString:Ne,getTypeChecker_ET:Le,getObjTypeChecker_ET:function(t){return function(e,i){Le("Object","type")(e,i);var n=Ie(e)[i+Te+"default"],r=u.Class.getDefault(n);if(!Array.isArray(r)&&Gt(t,u.ValueType)){var o=It(t),a=Bt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',It(e),i,o);n?x(a):D(3612,a,o,It(e),i,o)}}}}),ze={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ve(t,e,i,n){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,i.call(this,e)};var o={};for(var a in n[r]=o,ze){var s=ze[a];t.hasOwnProperty(a)&&(o[a]=t[a],s.canUsedInGet||delete t[a])}}}function ke(t,e,i,n){if(Array.isArray(e)){if(!(e.length>0))return O(5508,i,n);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=u.String:e===Boolean?t.type=u.Boolean:e===Number&&(t.type=u.Float))}function Ue(t,e,i){var n=t?{_short:!0}:{_short:!0,default:e};return i&&(n.type=i),n}function Ge(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Ue(e,[],t);if("function"==typeof t){var i=t;return Ue(e,Gt(i,u.ValueType)?new i:null,i)}return Ue(e,t instanceof De?t.default:t)}return null}var He=[];function je(){return He[He.length-1]}u._RF={push:function(t,e,i,n){void 0===i&&(i=e,e=""),He.push({uuid:e,script:i,module:t,exports:t.exports,beh:null,importMeta:n})},pop:function(){var t=He.pop(),e=t.module,i=e.exports;if(i===t.exports){for(var n in i)return;e.exports=i=t.cls}},peek:je};var We=Te,qe={datas:null,push:function(t){if(this.datas)this.datas.push(t);else{this.datas=[t];var e=this;setTimeout((function(){e.init()}),0)}},init:function(){var t=this.datas;if(t){for(var e=0;e<t.length;++e){var i=t[e],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var o=It(n);r?Qe(n,o,r,n.$super,i.mixins):O(3633,o)}this.datas=null}}};function Xe(t,e,i,n){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,i),ti(t,n,e,i)}function Ye(t,e,i,n){var r=n.get;n.set,r&&(ti(t,n,e,i),Re(t,i,"serializable",!1))}function Ke(t){return"function"==typeof t?t():t}function Je(t,e,i){for(var n in e)t.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(t,n,Lt(e,n))}function Qe(t,e,i,n,r){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter((function(e){return t.__props__.indexOf(e)<0}))))}if(i)for(var s in function(t,e){for(var i in t){var n=t[i],r=Ge(n,!1);if(r&&(n=t[i]=r),n){var o=n.notify;o&&Ve(n,i,o,t),"type"in n&&ke(n,n.type,e,i)}}}(i,e),i){var c=i[s];c.get||c.set?Ye(t,e,s,c):Xe(t,e,s,c)}var l=Ie(t);t.__values__=t.__props__.filter((function(t){return!1!==l[t+We+"serializable"]}))}function Ze(t){var e=t.name,i=t.extends,n=t.mixins,r=function(t,e,i,n){var r=u.Component,o=je();if(o&&Gt(e,r)){if(Gt(o.cls,r))return O(3615),null;t=t||o.script}var a=function(t,e,i,n){var r=n.ctor,o=[r],a=r;At(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(e&&(a.$super=e),i){for(var c=i.length-1;c>=0;c--){var l=i[c];Je(s,l.prototype),Ze._isCCClass(l)&&Je(Ie(a),Ie(l))}s.constructor=a}return Kt(t,a),a}(t,e,i,n);if(o)if(Gt(e,r)){var s=o.uuid;s&&Xt(s,a),o.cls=a}else Gt(o.cls,r)||(o.cls=a);return a}(e,i,n,t);e||(e=u.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);var o=t.properties;"function"==typeof o||i&&null===i.__props__||n&&n.some((function(t){return null===t.__props__}))?(qe.push({cls:r,props:o,mixins:n}),r.__props__=r.__values__=null):Qe(r,e,o,i,t.mixins);var a=t.editor;return a&&Gt(i,u.Component)&&u.Component._registerEditorProps(r,a),r}Ze._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Ze.fastDefine=function(t,e,i){Kt(t,e);for(var n=e.__props__=e.__values__=Object.keys(i),r=Ie(e),o=0;o<n.length;o++){var a=n[o];r[a+We+"visible"]=!1,r[a+We+"default"]=i[a]}},Ze.Attr=Fe,Ze.attr=Pe,Ze.getInheritanceChain=function(t){for(var e=[];t=Ut(t);)t!==Object&&e.push(t);return e};var $e={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function ti(t,e,i,n){var r=null,o="";function a(){return o=n+We,r=Ie(t)}"type"in e&&void 0===e.type&&D(3660,n,i);var s=e.type;s&&($e[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?oe.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=oe.getList(s)):re.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=re.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in e&&((r||a())[o+"default"]=e.default);var c,l=function(t,i){if(t in e){var n=e[t];typeof n===i&&((r||a())[o+t]=n)}};e.editorOnly&&((r||a())[o+"editorOnly"]=!0),e.__noImplicit?(r||a())[o+"serializable"]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=e.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Ze.isArray=function(t){return t=Ke(t),Array.isArray(t)},Ze.getDefault=Ke,Ze.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Ze.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Ze.getNewValueTypeCode=function(t){for(var e=It(t),i=t.constructor,n="new "+e+"(",r=0;r<i.__props__.length;r++)n+=t[i.__props__[r]],r<i.__props__.length-1&&(n+=",");return n+")"},u.Class=Ze;var ei=Math.PI/180,ii=180/Math.PI,ni=t("EPSILON",1e-6);function ri(t,e){return Math.abs(t-e)<=ni*Math.max(1,Math.abs(t),Math.abs(e))}function oi(t,e,i){return i=i||ni,Math.abs(t-e)<=i}function ai(t,e,i){if(e>i){var n=e;e=i,i=n}return t<e?e:t>i?i:t}function si(t){return t<0?0:t>1?1:t}function ci(t,e,i){return t+(e-t)*i}function li(t){return t*ei}function ui(t){return t*ii}var hi=t("random",Math.random);function _i(t,e){return Math.random()*(e-t)+t}function fi(t,e){return Math.floor(_i(t,e))}function pi(t){return(t=(9301*t+49297)%233280)/233280}function di(t,e,i){return pi(t)*(i-e)+e}function mi(t,e,i){return Math.floor(di(t,e,i))}function vi(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function gi(t,e){return t-Math.floor(t/e)*e}function yi(t,e){return t=gi(t,2*e),e-Math.abs(t-e)}function xi(t,e,i){return(i-t)/(e-t)}function Si(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function bi(t,e){return Math.abs(t)>Math.abs(e)?t:e}function Ci(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var Ai=1/255,Ti=t("Color",function(t){function e(e,i,n,r){var o;return(o=t.call(this)||this)._val=0,"string"==typeof e?o.fromHEX(e):void 0!==i?o.set(e,i,n,r):o.set(e),o}$(e,t),e.clone=function(t){var i=new e;return t._val?i._val=t._val:i._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,i},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,i,n,r){return t.r=e,t.g=i,t.b=n,t.a=r,t},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var i=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(i)?255:i,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,i){return t.r=e.r+i.r,t.g=e.g+i.g,t.b=e.b+i.b,t.a=e.a+i.a,t},e.subtract=function(t,e,i){return t.r=e.r-i.r,t.g=e.g-i.g,t.b=e.b-i.b,t.a=e.a-i.a,t},e.multiply=function(t,e,i){return t.r=e.r*i.r,t.g=e.g*i.g,t.b=e.b*i.b,t.a=e.a*i.a,t},e.divide=function(t,e,i){return t.r=e.r/i.r,t.g=e.g/i.g,t.b=e.b/i.b,t.a=e.a/i.a,t},e.scale=function(t,e,i){return t.r=e.r*i,t.g=e.g*i,t.b=e.b*i,t.a=e.a*i,t},e.lerp=function(t,e,i,n){var r=e.r,o=e.g,a=e.b,s=e.a;return r+=(i.r-r)*n,o+=(i.g-o)*n,a+=(i.b-a)*n,s+=(i.a-s)*n,t._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),t},e.toArray=function(t,i,n){void 0===n&&(n=0);var r=i instanceof e||i.a>1?1/255:1;return t[n+0]=i.r*r,t[n+1]=i.g*r,t[n+2]=i.b*r,t[n+3]=i.a*r,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),e.r=255*t[i+0],e.g=255*t[i+1],e.b=255*t[i+2],e.a=255*t[i+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,i){return void 0===i&&(i=ni),Math.abs(t.r-e.r)<=i*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=i*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=i*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=i*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var i=e.prototype;return i.clone=function(){var t=new e;return t._val=this._val,t},i.equals=function(t){return t&&this._val===t._val},i.lerp=function(t,e){var i=this.r,n=this.g,r=this.b,o=this.a;return i+=(t.r-i)*e,n+=(t.g-n)*e,r+=(t.b-r)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(r<<16)+(n<<8)+i),this},i.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},i.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Ai).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},i.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(n<<16)+(i<<8)+(0|e),this},i.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",i=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===t&&i.push((this.a<16?e:"")+this.a.toString(16)),i.join("")},i.toRGBValue=function(){return 16777215&this._val},i.fromHSV=function(t,e,i){var n=0,r=0,o=0;if(0===e)n=r=o=i;else if(0===i)n=r=o=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),s=t-a,c=i*(1-e),l=i*(1-e*s),u=i*(1-e*(1-s));switch(a){case 0:n=i,r=u,o=c;break;case 1:n=l,r=i,o=c;break;case 2:n=c,r=i,o=u;break;case 3:n=c,r=l,o=i;break;case 4:n=u,r=c,o=i;break;case 5:n=i,r=c,o=l}}return n*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|n),this},i.toHSV=function(){var t=this.r*Ai,e=this.g*Ai,i=this.b*Ai,n={h:0,s:0,v:0},r=Math.max(t,e,i),o=Math.min(t,e,i),a=0;return n.v=r,n.s=r?(r-o)/r:0,n.s?(a=r-o,n.h=t===r?(e-i)/a:e===r?2+(i-t)/a:4+(t-e)/a,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n},i.set=function(t,e,i,n){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,i=t.b||0,n="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)),this},i.multiply=function(t){var e=(255&this._val)*t.r>>8,i=(65280&this._val)*t.g>>8,n=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&n|65280&i|255&e,this},i._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},i._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},i._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},i._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},Q(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~ai(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~ai(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~ai(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~ai(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*Ai},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*Ai},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*Ai},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*Ai},set:function(t){this.a=255*t}}]),e}(le));function wi(t,e,i,n){return new Ti(t,e,i,n)}Ti.WHITE=Object.freeze(new Ti(255,255,255,255)),Ti.GRAY=Object.freeze(new Ti(127,127,127,255)),Ti.BLACK=Object.freeze(new Ti(0,0,0,255)),Ti.TRANSPARENT=Object.freeze(new Ti(0,0,0,0)),Ti.RED=Object.freeze(new Ti(255,0,0,255)),Ti.GREEN=Object.freeze(new Ti(0,255,0,255)),Ti.BLUE=Object.freeze(new Ti(0,0,255,255)),Ti.CYAN=Object.freeze(new Ti(0,255,255,255)),Ti.MAGENTA=Object.freeze(new Ti(255,0,255,255)),Ti.YELLOW=Object.freeze(new Ti(255,255,0,255)),Ze.fastDefine("cc.Color",Ti,{r:0,g:0,b:0,a:255}),u.Color=Ti,u.color=wi;var Ei=t("Vec3",function(t){function e(e,i,n){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=i||0,r.z=n||0),r}$(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,i,n){return t.x=e,t.y=i,t.z=n,t},e.add=function(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t},e.subtract=function(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t},e.multiply=function(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t},e.divide=function(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t},e.max=function(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t},e.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z;return Math.sqrt(i*i+n*n+r*r)},e.squaredDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z;return i*i+n*n+r*r},e.len=function(t){var e=t.x,i=t.y,n=t.z;return Math.sqrt(e*e+i*i+n*n)},e.lengthSqr=function(t){var e=t.x,i=t.y,n=t.z;return e*e+i*i+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var i=e.x,n=e.y,r=e.z;return Math.abs(i)<ni?t.x=0:t.x=1/i,Math.abs(n)<ni?t.y=0:t.y=1/n,Math.abs(r)<ni?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var i=e.x,n=e.y,r=e.z,o=i*i+n*n+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=i*o,t.y=n*o,t.z=r*o),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=i.x,s=i.y,c=i.z;return t.x=r*c-o*s,t.y=o*a-n*c,t.z=n*s-r*a,t},e.lerp=function(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t},e.random=function(t,e){e=e||1;var i=2*hi()*Math.PI,n=2*hi()-1,r=Math.sqrt(1-n*n);return t.x=r*Math.cos(i)*e,t.y=r*Math.sin(i)*e,t.z=n*e,t},e.transformMat4=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=i.m03*n+i.m07*r+i.m11*o+i.m15;return a=a?Math.abs(1/a):1,t.x=(i.m00*n+i.m04*r+i.m08*o+i.m12)*a,t.y=(i.m01*n+i.m05*r+i.m09*o+i.m13)*a,t.z=(i.m02*n+i.m06*r+i.m10*o+i.m14)*a,t},e.transformMat4Normal=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=i.m03*n+i.m07*r+i.m11*o;return a=a?Math.abs(1/a):1,t.x=(i.m00*n+i.m04*r+i.m08*o)*a,t.y=(i.m01*n+i.m05*r+i.m09*o)*a,t.z=(i.m02*n+i.m06*r+i.m10*o)*a,t},e.transformMat3=function(t,e,i){var n=e.x,r=e.y,o=e.z;return t.x=n*i.m00+r*i.m03+o*i.m06,t.y=n*i.m01+r*i.m04+o*i.m07,t.z=n*i.m02+r*i.m05+o*i.m08,t},e.transformAffine=function(t,e,i){var n=e.x,r=e.y,o=e.z;return t.x=i.m00*n+i.m04*r+i.m08*o+i.m12,t.y=i.m01*n+i.m05*r+i.m09*o+i.m13,t.x=i.m02*n+i.m06*r+i.m10*o+i.m14,t},e.transformQuat=function(t,e,i){var n=i.w*e.x+i.y*e.z-i.z*e.y,r=i.w*e.y+i.z*e.x-i.x*e.z,o=i.w*e.z+i.x*e.y-i.y*e.x,a=-i.x*e.x-i.y*e.y-i.z*e.z;return t.x=n*i.w+a*-i.x+r*-i.z-o*-i.y,t.y=r*i.w+a*-i.y+o*-i.x-n*-i.z,t.z=o*i.w+a*-i.z+n*-i.y-r*-i.x,t},e.transformRTS=function(t,e,i,n,r){var o=e.x*r.x,a=e.y*r.y,s=e.z*r.z,c=i.w*o+i.y*s-i.z*a,l=i.w*a+i.z*o-i.x*s,u=i.w*s+i.x*a-i.y*o,h=-i.x*o-i.y*a-i.z*s;return t.x=c*i.w+h*-i.x+l*-i.z-u*-i.y+n.x,t.y=l*i.w+h*-i.y+u*-i.x-c*-i.z+n.y,t.z=u*i.w+h*-i.z+c*-i.y-l*-i.x+n.z,t},e.transformInverseRTS=function(t,e,i,n,r){var o=e.x-n.x,a=e.y-n.y,s=e.z-n.z,c=i.w*o-i.y*s+i.z*a,l=i.w*a-i.z*o+i.x*s,u=i.w*s-i.x*a+i.y*o,h=i.x*o+i.y*a+i.z*s;return t.x=(c*i.w+h*i.x+l*i.z-u*i.y)/r.x,t.y=(l*i.w+h*i.y+u*i.x-c*i.z)/r.y,t.z=(u*i.w+h*i.z+c*i.y-l*i.x)/r.z,t},e.rotateX=function(t,e,i,n){var r=e.x-i.x,o=e.y-i.y,a=e.z-i.z,s=Math.cos(n),c=Math.sin(n),l=r,u=o*s-a*c,h=o*c+a*s;return t.x=l+i.x,t.y=u+i.y,t.z=h+i.z,t},e.rotateY=function(t,e,i,n){var r=e.x-i.x,o=e.y-i.y,a=e.z-i.z,s=Math.cos(n),c=Math.sin(n),l=a*c+r*s,u=o,h=a*s-r*c;return t.x=l+i.x,t.y=u+i.y,t.z=h+i.z,t},e.rotateZ=function(t,e,i,n){var r=e.x-i.x,o=e.y-i.y,a=e.z-i.z,s=Math.cos(n),c=Math.sin(n),l=r*s-o*c,u=r*c+o*s,h=a;return t.x=l+i.x,t.y=u+i.y,t.z=h+i.z,t},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,i){void 0===i&&(i=ni);var n=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return Math.abs(n-a)<=i*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-s)<=i*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=i*Math.max(1,Math.abs(o),Math.abs(c))},e.angle=function(t,i){e.normalize(Pi,t),e.normalize(Ii,i);var n=e.dot(Pi,Ii);return n>1?0:n<-1?Math.PI:Math.acos(n)},e.projectOnPlane=function(t,i,n){return e.subtract(t,i,e.project(t,i,n))},e.project=function(t,i,n){var r=e.lengthSqr(n);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,n,e.dot(i,n)/r)};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.z)},i.set=function(t,e,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=i||0),this},i.equals=function(t,e){return void 0===e&&(e=ni),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},i.equals3f=function(t,e,i,n){return void 0===n&&(n=ni),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))},i.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},i.strictEquals3f=function(t,e,i){return this.x===t&&this.y===e&&this.z===i},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},i.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},i.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},i.add3f=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},i.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},i.subtract3f=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},i.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},i.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},i.multiply3f=function(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this},i.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},i.divide3f=function(t,e,i){return this.x/=t,this.y/=e,this.z/=i,this},i.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},i.clampf=function(t,e){return this.x=ai(this.x,t.x,e.x),this.y=ai(this.y,t.y,e.y),this.z=ai(this.z,t.z,e.z),this},i.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.cross=function(t){var e=this.x,i=this.y,n=this.z,r=t.x,o=t.y,a=t.z;return this.x=i*a-n*o,this.y=n*r-e*a,this.z=e*o-i*r,this},i.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},i.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},i.normalize=function(){var t=this.x,e=this.y,i=this.z,n=t*t+e*e+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=t*n,this.y=e*n,this.z=i*n),this},i.transformMat4=function(t){var e=this.x,i=this.y,n=this.z,r=t.m03*e+t.m07*i+t.m11*n+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*i+t.m08*n+t.m12)*r,this.y=(t.m01*e+t.m05*i+t.m09*n+t.m13)*r,this.z=(t.m02*e+t.m06*i+t.m10*n+t.m14)*r,this},e}(le));Ei.UNIT_X=Object.freeze(new Ei(1,0,0)),Ei.UNIT_Y=Object.freeze(new Ei(0,1,0)),Ei.UNIT_Z=Object.freeze(new Ei(0,0,1)),Ei.RIGHT=Object.freeze(new Ei(1,0,0)),Ei.UP=Object.freeze(new Ei(0,1,0)),Ei.FORWARD=Object.freeze(new Ei(0,0,-1)),Ei.ZERO=Object.freeze(new Ei(0,0,0)),Ei.ONE=Object.freeze(new Ei(1,1,1)),Ei.NEG_ONE=Object.freeze(new Ei(-1,-1,-1));var Pi=new Ei,Ii=new Ei;function Ri(t,e,i){return new Ei(t,e,i)}Ze.fastDefine("cc.Vec3",Ei,{x:0,y:0,z:0}),u.Vec3=Ei,u.v3=Ri;var Di=t("Mat3",function(t){function e(e,i,n,r,o,a,s,c,l){var u;return void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=t.call(this)||this,"object"==typeof e?(u.m00=e.m00,u.m01=e.m01,u.m02=e.m02,u.m03=e.m03,u.m04=e.m04,u.m05=e.m05,u.m06=e.m06,u.m07=e.m07,u.m08=e.m08):(u.m00=e,u.m01=i,u.m02=n,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}$(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,i,n,r,o,a,s,c,l){return t.m00=e,t.m01=i,t.m02=n,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var i=e.m01,n=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=i,t.m05=e.m07,t.m06=n,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var i=e.m00,n=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,p=i*h+n*_+r*f;return 0===p?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(p=1/p,t.m00=h*p,t.m01=(-u*n+r*l)*p,t.m02=(s*n-r*a)*p,t.m03=_*p,t.m04=(u*i-r*c)*p,t.m05=(-s*i+r*o)*p,t.m06=f*p,t.m07=(-l*i+n*c)*p,t.m08=(a*i-n*o)*p,t)},e.determinant=function(t){var e=t.m00,i=t.m01,n=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08;return e*(l*o-a*c)+i*(-l*r+a*s)+n*(c*r-o*s)},e.multiply=function(t,e,i){var n=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=i.m00,f=i.m01,p=i.m02,d=i.m03,m=i.m04,v=i.m05,g=i.m06,y=i.m07,x=i.m08;return t.m00=_*n+f*a+p*l,t.m01=_*r+f*s+p*u,t.m02=_*o+f*c+p*h,t.m03=d*n+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*n+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.multiplyMat4=function(t,e,i){var n=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=i.m00,f=i.m01,p=i.m02,d=i.m04,m=i.m05,v=i.m06,g=i.m08,y=i.m09,x=i.m10;return t.m00=_*n+f*a+p*l,t.m01=_*r+f*s+p*u,t.m02=_*o+f*c+p*h,t.m03=d*n+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*n+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.transform=function(t,e,i){var n=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=i.x,f=i.y;return t.m00=n,t.m01=r,t.m02=o,t.m03=a,t.m04=s,t.m05=c,t.m06=_*n+f*a+l,t.m07=_*r+f*s+u,t.m08=_*o+f*c+h,t},e.scale=function(t,e,i){var n=i.x,r=i.y;return t.m00=n*e.m00,t.m01=n*e.m01,t.m02=n*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,i){var n=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=Math.sin(i),f=Math.cos(i);return t.m00=f*n+_*a,t.m01=f*r+_*s,t.m02=f*o+_*c,t.m03=f*a-_*n,t.m04=f*s-_*r,t.m05=f*c-_*o,t.m06=l,t.m07=u,t.m08=h,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,i,n){return Ei.lengthSqr(i)<ni*ni?(e.identity(t),t):(n=n||Ei.UNIT_Y,Ei.normalize(Mi,Ei.cross(Mi,n,i)),Ei.lengthSqr(Mi)<ni*ni?(e.identity(t),t):(Ei.cross(Oi,i,Mi),e.set(t,Mi.x,Mi.y,Mi.z,Oi.x,Oi.y,Oi.z,i.x,i.y,i.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=-i,t.m04=n,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var i=e.x,n=e.y,r=e.z,o=e.w,a=i+i,s=n+n,c=r+r,l=i*a,u=n*a,h=n*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-p,t.m03=u-v,t.m06=_+m,t.m01=u+v,t.m04=1-l-p,t.m07=f-d,t.m02=_-m,t.m05=f+d,t.m08=1-l-h,t},e.inverseTransposeMat4=function(t,e){var i=e.m00,n=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=i*s-n*a,y=i*c-r*a,x=i*l-o*a,S=n*c-r*s,b=n*l-o*s,C=r*l-o*c,A=u*d-h*p,T=u*m-_*p,w=u*v-f*p,E=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*E+S*w-b*T+C*A;return R?(R=1/R,t.m00=(s*I-c*P+l*E)*R,t.m01=(c*w-a*I-l*T)*R,t.m02=(a*P-s*w+l*A)*R,t.m03=(r*P-n*I-o*E)*R,t.m04=(i*I-r*w+o*T)*R,t.m05=(n*w-i*P-o*A)*R,t.m06=(d*C-m*b+v*S)*R,t.m07=(m*x-p*C-v*y)*R,t.m08=(p*b-d*x+v*g)*R,t):null},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t},e.add=function(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t},e.subtract=function(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t},e.multiplyScalar=function(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t},e.multiplyScalarAndAdd=function(t,e,i,n){return t.m00=i.m00*n+e.m00,t.m01=i.m01*n+e.m01,t.m02=i.m02*n+e.m02,t.m03=i.m03*n+e.m03,t.m04=i.m04*n+e.m04,t.m05=i.m05*n+e.m05,t.m06=i.m06*n+e.m06,t.m07=i.m07*n+e.m07,t.m08=i.m08*n+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,i){return void 0===i&&(i=ni),Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var i=e.prototype;return i.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},i.set=function(t,e,i,n,r,o,a,s,c){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=i,this.m03=n,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},i.equals=function(t,e){return void 0===e&&(e=ni),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},i.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},i.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},i.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},i.transpose=function(){var t=this.m01,e=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=i,this},i.invert=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*n+o*a,h=s*n-r*a,_=t*l+e*u+i*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*e+i*s)*_,this.m02=(o*e-i*r)*_,this.m03=u*_,this.m04=(c*t-i*a)*_,this.m05=(-o*t+i*n)*_,this.m06=h*_,this.m07=(-s*t+e*a)*_,this.m08=(r*t-e*n)*_,this)},i.determinant=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return t*(c*r-o*s)+e*(-c*n+o*a)+i*(s*n-r*a)},i.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},i.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},i.multiply=function(t){var e=this.m00,i=this.m01,n=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=t.m00,h=t.m01,_=t.m02,f=t.m03,p=t.m04,d=t.m05,m=t.m06,v=t.m07,g=t.m08;return this.m00=u*e+h*r+_*s,this.m01=u*i+h*o+_*c,this.m02=u*n+h*a+_*l,this.m03=f*e+p*r+d*s,this.m04=f*i+p*o+d*c,this.m05=f*n+p*a+d*l,this.m06=m*e+v*r+g*s,this.m07=m*i+v*o+g*c,this.m08=m*n+v*a+g*l,this},i.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},i.scale=function(t){var e=t.x,i=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},i.rotate=function(t){var e=this.m00,i=this.m01,n=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(t),h=Math.cos(t);return this.m00=h*e+u*r,this.m01=h*i+u*o,this.m02=h*n+u*a,this.m03=h*r-u*e,this.m04=h*o-u*i,this.m05=h*a-u*n,this.m06=s,this.m07=c,this.m08=l,this},i.fromQuat=function(t){var e=t.x,i=t.y,n=t.z,r=t.w,o=e+e,a=i+i,s=n+n,c=e*o,l=i*o,u=i*a,h=n*o,_=n*a,f=n*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-f,this.m07=_-p,this.m02=h-d,this.m05=_+p,this.m08=1-c-u,this},e}(le));Di.IDENTITY=Object.freeze(new Di);var Mi=new Ei,Oi=new Ei;Ze.fastDefine("cc.Mat3",Di,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),u.Mat3=Di;var Bi=t("Quat",function(t){function e(e,i,n,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=i||0,o.z=n||0,o.w=null!=r?r:1),o}$(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,i,n,r){return t.x=e,t.y=i,t.z=n,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,i,n){var r=Ei.dot(i,n);return r<-.999999?(Ei.cross(Fi,Ei.UNIT_X,i),Fi.length()<1e-6&&Ei.cross(Fi,Ei.UNIT_Y,i),Ei.normalize(Fi,Fi),e.fromAxisAngle(t,Fi,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(Ei.cross(Fi,i,n),t.x=Fi.x,t.y=Fi.y,t.z=Fi.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var i=2*Math.acos(e.w),n=Math.sin(i/2);return 0!==n?(t.x=e.x/n,t.y=e.y/n,t.z=e.z/n):(t.x=1,t.y=0,t.z=0),i},e.multiply=function(t,e,i){var n=e.x*i.w+e.w*i.x+e.y*i.z-e.z*i.y,r=e.y*i.w+e.w*i.y+e.z*i.x-e.x*i.z,o=e.z*i.w+e.w*i.z+e.x*i.y-e.y*i.x,a=e.w*i.w-e.x*i.x-e.y*i.y-e.z*i.z;return t.x=n,t.y=r,t.z=o,t.w=a,t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t},e.rotateX=function(t,e,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+c*n,t.y=a*r+s*n,t.z=s*r-a*n,t.w=c*r-o*n,t},e.rotateY=function(t,e,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r-s*n,t.y=a*r+c*n,t.z=s*r+o*n,t.w=c*r-a*n,t},e.rotateZ=function(t,e,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+a*n,t.y=a*r-o*n,t.z=s*r+c*n,t.w=c*r-s*n,t},e.rotateAround=function(t,i,n,r){return e.invert(Ni,i),Ei.transformQuat(Fi,n,Ni),e.fromAxisAngle(Ni,Fi,r),e.multiply(t,i,Ni),t},e.rotateAroundLocal=function(t,i,n,r){return e.fromAxisAngle(Ni,n,r),e.multiply(t,i,Ni),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t},e.slerp=function(t,e,i,n){var r=0,o=0,a=i.x,s=i.y,c=i.z,l=i.w,u=e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-n)*h)/_,o=Math.sin(n*h)/_}else r=1-n,o=n;return t.x=r*e.x+o*a,t.y=r*e.y+o*s,t.z=r*e.z+o*c,t.w=r*e.w+o*l,t},e.sqlerp=function(t,i,n,r,o,a){return e.slerp(Ni,i,o,a),e.slerp(Li,n,r,a),e.slerp(t,Ni,Li,2*a*(1-a)),t},e.invert=function(t,e){var i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,n=i?1/i:0;return t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return i>0&&(i=1/Math.sqrt(i),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i),t},e.fromAxes=function(t,i,n,r){return Di.set(zi,i.x,i.y,i.z,n.x,n.y,n.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,zi))},e.fromViewUp=function(t,i,n){return Di.fromViewUp(zi,i,n),e.normalize(t,e.fromMat3(t,zi))},e.fromAxisAngle=function(t,e,i){i*=.5;var n=Math.sin(i);return t.x=n*e.x,t.y=n*e.y,t.z=n*e.z,t.w=Math.cos(i),t},e.fromMat3=function(t,e){var i=e.m00,n=e.m03,r=e.m06,o=e.m01,a=e.m04,s=e.m07,c=e.m02,l=e.m05,u=e.m08,h=i+a+u;if(h>0){var _=.5/Math.sqrt(h+1);t.w=.25/_,t.x=(l-s)*_,t.y=(r-c)*_,t.z=(o-n)*_}else if(i>a&&i>u){var f=2*Math.sqrt(1+i-a-u);t.w=(l-s)/f,t.x=.25*f,t.y=(n+o)/f,t.z=(r+c)/f}else if(a>u){var p=2*Math.sqrt(1+a-i-u);t.w=(r-c)/p,t.x=(n+o)/p,t.y=.25*p,t.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-i-a);t.w=(o-n)/d,t.x=(r+c)/d,t.y=(s+l)/d,t.z=.25*d}return t},e.fromEuler=function(t,e,i,n){e*=Vi,i*=Vi,n*=Vi;var r=Math.sin(e),o=Math.cos(e),a=Math.sin(i),s=Math.cos(i),c=Math.sin(n),l=Math.cos(n);return t.x=r*s*l+o*a*c,t.y=o*a*l+r*s*c,t.z=o*s*c-r*a*l,t.w=o*s*l-r*a*c,t},e.fromAngleZ=function(t,e){return e*=Vi,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var i=2*e.y,n=2*e.z;return t.x=1-i*e.y-n*e.z,t.y=i*e.x+n*e.w,t.z=n*e.x+i*e.w,t},e.toAxisY=function(t,e){var i=2*e.x,n=2*e.y,r=2*e.z;return t.x=n*e.x-r*e.w,t.y=1-i*e.x-r*e.z,t.z=r*e.y+i*e.w,t},e.toAxisZ=function(t,e){var i=2*e.x,n=2*e.y,r=2*e.z;return t.x=r*e.x-n*e.w,t.y=r*e.y-i*e.w,t.z=1-i*e.x-n*e.y,t},e.toEuler=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=e.w,s=0,c=0,l=0,u=n*r+o*a;if(u>.499999)s=0,c=ui(2*Math.atan2(n,a)),l=90;else if(u<-.499999)s=0,c=-ui(2*Math.atan2(n,a)),l=-90;else{var h=n*n,_=r*r,f=o*o;s=ui(Math.atan2(2*n*a-2*r*o,1-2*h-2*f)),c=ui(Math.atan2(2*r*a-2*n*o,1-2*_-2*f)),l=ui(Math.asin(2*u)),i&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=s,t.y=c,t.z=l,t},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,i){return void 0===i&&(i=ni),Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.z,this.w)},i.set=function(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=null!=n?n:1),this},i.equals=function(t,e){return void 0===e&&(e=ni),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},i.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},i.getEulerAngles=function(t){return e.toEuler(t,this)},i.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},i.slerp=function(t,i){return e.slerp(this,this,t,i)},i.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},i.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(le));Bi.IDENTITY=Object.freeze(new Bi);var Ni=new Bi,Li=new Bi,Fi=new Ei,zi=new Di,Vi=.5*Math.PI/180;function ki(t,e,i,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),new Bi(t,e,i,n)}Ze.fastDefine("cc.Quat",Bi,{x:0,y:0,z:0,w:1}),u.Quat=Bi,u.quat=ki;var Ui=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Gi=t("Mat4",function(t){function e(e,i,n,r,o,a,s,c,l,u,h,_,f,p,d,m){var v;return void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=t.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof e?(v.m00=e.m00,v.m01=e.m01,v.m02=e.m02,v.m03=e.m03,v.m04=e.m04,v.m05=e.m05,v.m06=e.m06,v.m07=e.m07,v.m08=e.m08,v.m09=e.m09,v.m10=e.m10,v.m11=e.m11,v.m12=e.m12,v.m13=e.m13,v.m14=e.m14,v.m15=e.m15):(v.m00=e,v.m01=i,v.m02=n,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=p,v.m14=d,v.m15=m),v}$(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d,m){return t.m00=e,t.m01=i,t.m02=n,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t.m09=u,t.m10=h,t.m11=_,t.m12=f,t.m13=p,t.m14=d,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var i=e.m01,n=e.m02,r=e.m03,o=e.m06,a=e.m07,s=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=i,t.m06=e.m09,t.m07=e.m13,t.m08=n,t.m09=o,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=s}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var i=e.m00,n=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=i*s-n*a,y=i*c-r*a,x=i*l-o*a,S=n*c-r*s,b=n*l-o*s,C=r*l-o*c,A=u*d-h*p,T=u*m-_*p,w=u*v-f*p,E=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*E+S*w-b*T+C*A;return 0===R?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(R=1/R,t.m00=(s*I-c*P+l*E)*R,t.m01=(r*P-n*I-o*E)*R,t.m02=(d*C-m*b+v*S)*R,t.m03=(_*b-h*C-f*S)*R,t.m04=(c*w-a*I-l*T)*R,t.m05=(i*I-r*w+o*T)*R,t.m06=(m*x-p*C-v*y)*R,t.m07=(u*C-_*x+f*y)*R,t.m08=(a*P-s*w+l*A)*R,t.m09=(n*w-i*P-o*A)*R,t.m10=(p*b-d*x+v*g)*R,t.m11=(h*x-u*b-f*g)*R,t.m12=(s*T-a*E-c*A)*R,t.m13=(i*E-n*T+r*A)*R,t.m14=(d*y-p*S-m*g)*R,t.m15=(u*S-h*y+_*g)*R,t)},e.determinant=function(t){var e=t.m00,i=t.m01,n=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11,f=t.m12,p=t.m13,d=t.m14,m=t.m15;return(e*a-i*o)*(h*m-_*d)-(e*s-n*o)*(u*m-_*p)+(e*c-r*o)*(u*d-h*p)+(i*s-n*a)*(l*m-_*f)-(i*c-r*a)*(l*d-h*f)+(n*c-r*s)*(l*p-u*f)},e.multiply=function(t,e,i){var n=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=e.m09,f=e.m10,p=e.m11,d=e.m12,m=e.m13,v=e.m14,g=e.m15,y=i.m00,x=i.m01,S=i.m02,b=i.m03;return t.m00=y*n+x*s+S*h+b*d,t.m01=y*r+x*c+S*_+b*m,t.m02=y*o+x*l+S*f+b*v,t.m03=y*a+x*u+S*p+b*g,y=i.m04,x=i.m05,S=i.m06,b=i.m07,t.m04=y*n+x*s+S*h+b*d,t.m05=y*r+x*c+S*_+b*m,t.m06=y*o+x*l+S*f+b*v,t.m07=y*a+x*u+S*p+b*g,y=i.m08,x=i.m09,S=i.m10,b=i.m11,t.m08=y*n+x*s+S*h+b*d,t.m09=y*r+x*c+S*_+b*m,t.m10=y*o+x*l+S*f+b*v,t.m11=y*a+x*u+S*p+b*g,y=i.m12,x=i.m13,S=i.m14,b=i.m15,t.m12=y*n+x*s+S*h+b*d,t.m13=y*r+x*c+S*_+b*m,t.m14=y*o+x*l+S*f+b*v,t.m15=y*a+x*u+S*p+b*g,t},e.transform=function(t,e,i){var n=i.x,r=i.y,o=i.z;if(e===t)t.m12=e.m00*n+e.m04*r+e.m08*o+e.m12,t.m13=e.m01*n+e.m05*r+e.m09*o+e.m13,t.m14=e.m02*n+e.m06*r+e.m10*o+e.m14,t.m15=e.m03*n+e.m07*r+e.m11*o+e.m15;else{var a=e.m00,s=e.m01,c=e.m02,l=e.m03,u=e.m04,h=e.m05,_=e.m06,f=e.m07,p=e.m08,d=e.m09,m=e.m10,v=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=s,t.m02=c,t.m03=l,t.m04=u,t.m05=h,t.m06=_,t.m07=f,t.m08=p,t.m09=d,t.m10=m,t.m11=v,t.m12=a*n+u*r+p*o+e.m12,t.m13=s*n+h*r+d*o+e.m13,t.m14=c*n+_*r+m*o+e.m14,t.m15=l*n+f*r+v*o+e.m15}return t},e.translate=function(t,e,i){return console.warn("function changed"),e===t?(t.m12+=i.x,t.m13+=i.y,t.m14+=i.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=i.x,t.m13+=i.y,t.m14+=i.z,t.m15=e.m15),t},e.scale=function(t,e,i){var n=i.x,r=i.y,o=i.z;return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,i,n){var r=n.x,o=n.y,a=n.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<ni)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(i),l=Math.cos(i),u=1-l,h=e.m00,_=e.m01,f=e.m02,p=e.m03,d=e.m04,m=e.m05,v=e.m06,g=e.m07,y=e.m08,x=e.m09,S=e.m10,b=e.m11,C=r*r*u+l,A=o*r*u+a*c,T=a*r*u-o*c,w=r*o*u-a*c,E=o*o*u+l,P=a*o*u+r*c,I=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return t.m00=h*C+d*A+y*T,t.m01=_*C+m*A+x*T,t.m02=f*C+v*A+S*T,t.m03=p*C+g*A+b*T,t.m04=h*w+d*E+y*P,t.m05=_*w+m*E+x*P,t.m06=f*w+v*E+S*P,t.m07=p*w+g*E+b*P,t.m08=h*I+d*R+y*D,t.m09=_*I+m*R+x*D,t.m10=f*I+v*R+S*D,t.m11=p*I+g*R+b*D,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*r+l*n,t.m05=a*r+u*n,t.m06=s*r+h*n,t.m07=c*r+_*n,t.m08=l*r-o*n,t.m09=u*r-a*n,t.m10=h*r-s*n,t.m11=_*r-c*n,t},e.rotateY=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r-l*n,t.m01=a*r-u*n,t.m02=s*r-h*n,t.m03=c*r-_*n,t.m08=o*n+l*r,t.m09=a*n+u*r,t.m10=s*n+h*r,t.m11=c*n+_*r,t},e.rotateZ=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m04,u=e.m05,h=e.m06,_=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r+l*n,t.m01=a*r+u*n,t.m02=s*r+h*n,t.m03=c*r+_*n,t.m04=l*r-o*n,t.m05=u*r-a*n,t.m06=h*r-s*n,t.m07=_*r-c*n,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,i){var n=i.x,r=i.y,o=i.z,a=Math.sqrt(n*n+r*r+o*o);if(Math.abs(a)<ni)return null;n*=a=1/a,r*=a,o*=a;var s=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=n*n*l+c,t.m01=r*n*l+o*s,t.m02=o*n*l-r*s,t.m03=0,t.m04=n*r*l-o*s,t.m05=r*r*l+c,t.m06=o*r*l+n*s,t.m07=0,t.m08=n*o*l+r*s,t.m09=r*o*l-n*s,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=n,t.m06=i,t.m07=0,t.m08=0,t.m09=-i,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=0,t.m02=-i,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=i,t.m09=0,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=0,t.m04=-i,t.m05=n,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=e.w,s=n+n,c=r+r,l=o+o,u=n*s,h=n*c,_=n*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return t.m00=1-(f+d),t.m01=h+g,t.m02=_-v,t.m03=0,t.m04=h-g,t.m05=1-(u+d),t.m06=p+m,t.m07=0,t.m08=_+v,t.m09=p-m,t.m10=1-(u+f),t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var i=ji.m00=e.m00,n=ji.m01=e.m01,r=ji.m02=e.m02,o=ji.m03=e.m04,a=ji.m04=e.m05,s=ji.m05=e.m06,c=ji.m06=e.m08,l=ji.m07=e.m09,u=ji.m08=e.m10;return t.x=Math.sqrt(i*i+n*n+r*r),t.y=Math.sqrt(o*o+a*a+s*s),t.z=Math.sqrt(c*c+l*l+u*u),Di.determinant(ji)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var i=e.m00+e.m05+e.m10,n=0;return i>0?(n=2*Math.sqrt(i+1),t.w=.25*n,t.x=(e.m06-e.m09)/n,t.y=(e.m08-e.m02)/n,t.z=(e.m01-e.m04)/n):e.m00>e.m05&&e.m00>e.m10?(n=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/n,t.x=.25*n,t.y=(e.m01+e.m04)/n,t.z=(e.m08+e.m02)/n):e.m05>e.m10?(n=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/n,t.x=(e.m01+e.m04)/n,t.y=.25*n,t.z=(e.m06+e.m09)/n):(n=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/n,t.x=(e.m08+e.m02)/n,t.y=(e.m06+e.m09)/n,t.z=.25*n),t},e.toRTS=function(t,e,i,n){n.x=Ei.set(Hi,t.m00,t.m01,t.m02).length(),ji.m00=t.m00/n.x,ji.m01=t.m01/n.x,ji.m02=t.m02/n.x,n.y=Ei.set(Hi,t.m04,t.m05,t.m06).length(),ji.m03=t.m04/n.y,ji.m04=t.m05/n.y,ji.m05=t.m06/n.y,n.z=Ei.set(Hi,t.m08,t.m09,t.m10).length(),ji.m06=t.m08/n.z,ji.m07=t.m09/n.z,ji.m08=t.m10/n.z,Di.determinant(ji)<0&&(n.x*=-1,ji.m00*=-1,ji.m01*=-1,ji.m02*=-1),Bi.fromMat3(e,ji),Ei.set(i,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,i,n){var r=e.x,o=e.y,a=e.z,s=e.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=n.x,S=n.y,b=n.z;return t.m00=(1-(p+m))*x,t.m01=(_+y)*x,t.m02=(f-g)*x,t.m03=0,t.m04=(_-y)*S,t.m05=(1-(h+m))*S,t.m06=(d+v)*S,t.m07=0,t.m08=(f+g)*b,t.m09=(d-v)*b,t.m10=(1-(h+p))*b,t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,i,n,r){var o=e.x,a=e.y,s=e.z,c=e.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=n.x,b=n.y,C=n.z,A=r.x,T=r.y,w=r.z;return t.m00=(1-(d+v))*S,t.m01=(f+x)*S,t.m02=(p-y)*S,t.m03=0,t.m04=(f-x)*b,t.m05=(1-(_+v))*b,t.m06=(m+g)*b,t.m07=0,t.m08=(p+y)*C,t.m09=(m-g)*C,t.m10=(1-(_+d))*C,t.m11=0,t.m12=i.x+A-(t.m00*A+t.m04*T+t.m08*w),t.m13=i.y+T-(t.m01*A+t.m05*T+t.m09*w),t.m14=i.z+w-(t.m02*A+t.m06*T+t.m10*w),t.m15=1,t},e.fromQuat=function(t,e){var i=e.x,n=e.y,r=e.z,o=e.w,a=i+i,s=n+n,c=r+r,l=i*a,u=n*a,h=n*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-p,t.m01=u+v,t.m02=_-m,t.m03=0,t.m04=u-v,t.m05=1-l-p,t.m06=f+d,t.m07=0,t.m08=_+m,t.m09=f-d,t.m10=1-l-h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,i,n,r,o,a){var s=1/(i-e),c=1/(r-n),l=1/(o-a);return t.m00=2*o*s,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(i+e)*s,t.m09=(r+n)*c,t.m10=(a+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*o*2*l,t.m15=0,t},e.perspective=function(t,e,i,n,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(e/2),u=1/(n-r),h=o?l/i:l,_=(o?l:l*i)*s,f=Ui[c];return t.m00=h*f[0],t.m01=h*f[1],t.m02=0,t.m03=0,t.m04=_*f[2],t.m05=_*f[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*n)*u,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*n*u*(1-a),t.m15=0,t},e.ortho=function(t,e,i,n,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(e-i),h=1/(n-r)*c,_=1/(o-a),f=-2*u,p=-2*h,d=(e+i)*u,m=(r+n)*h,v=Ui[l];return t.m00=f*v[0],t.m01=f*v[1],t.m02=0,t.m03=0,t.m04=p*v[2],t.m05=p*v[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=_*(1-s),t.m11=0,t.m12=d*v[0]+m*v[2],t.m13=d*v[1]+m*v[3],t.m14=(o-s*a)*_,t.m15=1,t},e.lookAt=function(t,e,i,n){var r=e.x,o=e.y,a=e.z,s=n.x,c=n.y,l=n.z,u=r-i.x,h=o-i.y,_=a-i.z,f=1/Math.sqrt(u*u+h*h+_*_),p=c*(_*=f)-l*(h*=f),d=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(p*p+d*d+m*m))-_*(d*=f),g=_*(p*=f)-u*m,y=u*d-h*p;return t.m00=p,t.m01=v,t.m02=u,t.m03=0,t.m04=d,t.m05=g,t.m06=h,t.m07=0,t.m08=m,t.m09=y,t.m10=_,t.m11=0,t.m12=-(p*r+d*o+m*a),t.m13=-(v*r+g*o+y*a),t.m14=-(u*r+h*o+_*a),t.m15=1,t},e.inverseTranspose=function(t,e){var i=e.m00,n=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=i*s-n*a,y=i*c-r*a,x=i*l-o*a,S=n*c-r*s,b=n*l-o*s,C=r*l-o*c,A=u*d-h*p,T=u*m-_*p,w=u*v-f*p,E=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*E+S*w-b*T+C*A;return R?(R=1/R,t.m00=(s*I-c*P+l*E)*R,t.m01=(c*w-a*I-l*T)*R,t.m02=(a*P-s*w+l*A)*R,t.m03=0,t.m04=(r*P-n*I-o*E)*R,t.m05=(i*I-r*w+o*T)*R,t.m06=(n*w-i*P-o*A)*R,t.m07=0,t.m08=(d*C-m*b+v*S)*R,t.m09=(m*x-p*C-v*y)*R,t.m10=(p*b-d*x+v*g)*R,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t[i+9]=e.m09,t[i+10]=e.m10,t[i+11]=e.m11,t[i+12]=e.m12,t[i+13]=e.m13,t[i+14]=e.m14,t[i+15]=e.m15,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t.m09=e[i+9],t.m10=e[i+10],t.m11=e[i+11],t.m12=e[i+12],t.m13=e[i+13],t.m14=e[i+14],t.m15=e[i+15],t},e.add=function(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t.m09=e.m09+i.m09,t.m10=e.m10+i.m10,t.m11=e.m11+i.m11,t.m12=e.m12+i.m12,t.m13=e.m13+i.m13,t.m14=e.m14+i.m14,t.m15=e.m15+i.m15,t},e.subtract=function(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t.m09=e.m09-i.m09,t.m10=e.m10-i.m10,t.m11=e.m11-i.m11,t.m12=e.m12-i.m12,t.m13=e.m13-i.m13,t.m14=e.m14-i.m14,t.m15=e.m15-i.m15,t},e.multiplyScalar=function(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t.m09=e.m09*i,t.m10=e.m10*i,t.m11=e.m11*i,t.m12=e.m12*i,t.m13=e.m13*i,t.m14=e.m14*i,t.m15=e.m15*i,t},e.multiplyScalarAndAdd=function(t,e,i,n){return t.m00=e.m00+i.m00*n,t.m01=e.m01+i.m01*n,t.m02=e.m02+i.m02*n,t.m03=e.m03+i.m03*n,t.m04=e.m04+i.m04*n,t.m05=e.m05+i.m05*n,t.m06=e.m06+i.m06*n,t.m07=e.m07+i.m07*n,t.m08=e.m08+i.m08*n,t.m09=e.m09+i.m09*n,t.m10=e.m10+i.m10*n,t.m11=e.m11+i.m11*n,t.m12=e.m12+i.m12*n,t.m13=e.m13+i.m13*n,t.m14=e.m14+i.m14*n,t.m15=e.m15+i.m15*n,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,i){return void 0===i&&(i=ni),Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=i*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=i*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=i*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=i*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=i*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=i*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=i*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var i=e.prototype;return i.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},i.set=function(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=i,this.m03=n,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=p,this.m15=d,this.m00=t),this},i.equals=function(t,e){return void 0===e&&(e=ni),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},i.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},i.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},i.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},i.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},i.transpose=function(){var t=this.m01,e=this.m02,i=this.m03,n=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=o,this},i.invert=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15,m=t*o-e*r,v=t*a-i*r,g=t*s-n*r,y=e*a-i*o,x=e*s-n*o,S=i*s-n*a,b=c*f-l*_,C=c*p-u*_,A=c*d-h*_,T=l*p-u*f,w=l*d-h*f,E=u*d-h*p,P=m*E-v*w+g*T+y*A-x*C+S*b;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(o*E-a*w+s*T)*P,this.m01=(i*w-e*E-n*T)*P,this.m02=(f*S-p*x+d*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*A-r*E-s*C)*P,this.m05=(t*E-i*A+n*C)*P,this.m06=(p*g-_*S-d*v)*P,this.m07=(c*S-u*g+h*v)*P,this.m08=(r*w-o*A+s*b)*P,this.m09=(e*A-t*w-n*b)*P,this.m10=(_*x-f*g+d*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(o*C-r*T-a*b)*P,this.m13=(t*T-e*C+i*b)*P,this.m14=(f*v-_*y-p*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},i.determinant=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15;return(t*o-e*r)*(u*d-h*p)-(t*a-i*r)*(l*d-h*f)+(t*s-n*r)*(l*p-u*f)+(e*a-i*o)*(c*d-h*_)-(e*s-n*o)*(c*p-u*_)+(i*s-n*a)*(c*f-l*_)},i.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},i.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},i.multiply=function(t){var e=this.m00,i=this.m01,n=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,p=this.m13,d=this.m14,m=this.m15,v=t.m00,g=t.m01,y=t.m02,x=t.m03;return this.m00=v*e+g*o+y*l+x*f,this.m01=v*i+g*a+y*u+x*p,this.m02=v*n+g*s+y*h+x*d,this.m03=v*r+g*c+y*_+x*m,v=t.m04,g=t.m05,y=t.m06,x=t.m07,this.m04=v*e+g*o+y*l+x*f,this.m05=v*i+g*a+y*u+x*p,this.m06=v*n+g*s+y*h+x*d,this.m07=v*r+g*c+y*_+x*m,v=t.m08,g=t.m09,y=t.m10,x=t.m11,this.m08=v*e+g*o+y*l+x*f,this.m09=v*i+g*a+y*u+x*p,this.m10=v*n+g*s+y*h+x*d,this.m11=v*r+g*c+y*_+x*m,v=t.m12,g=t.m13,y=t.m14,x=t.m15,this.m12=v*e+g*o+y*l+x*f,this.m13=v*i+g*a+y*u+x*p,this.m14=v*n+g*s+y*h+x*d,this.m15=v*r+g*c+y*_+x*m,this},i.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},i.translate=function(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},i.scale=function(t){var e=t.x,i=t.y,n=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=i,this.m05*=i,this.m06*=i,this.m07*=i,this.m08*=n,this.m09*=n,this.m10*=n,this.m11*=n,this},i.rotate=function(t,e){var i=e.x,n=e.y,r=e.z,o=Math.sqrt(i*i+n*n+r*r);if(Math.abs(o)<ni)return null;i*=o=1/o,n*=o,r*=o;var a=Math.sin(t),s=Math.cos(t),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=i*i*c+s,b=n*i*c+r*a,C=r*i*c-n*a,A=i*n*c-r*a,T=n*n*c+s,w=r*n*c+i*a,E=i*r*c+n*a,P=n*r*c-i*a,I=r*r*c+s;return this.m00=l*S+f*b+v*C,this.m01=u*S+p*b+g*C,this.m02=h*S+d*b+y*C,this.m03=_*S+m*b+x*C,this.m04=l*A+f*T+v*w,this.m05=u*A+p*T+g*w,this.m06=h*A+d*T+y*w,this.m07=_*A+m*T+x*w,this.m08=l*E+f*P+v*I,this.m09=u*E+p*P+g*I,this.m10=h*E+d*P+y*I,this.m11=_*E+m*P+x*I,this},i.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},i.getScale=function(t){var e=ji.m00=this.m00,i=ji.m01=this.m01,n=ji.m02=this.m02,r=ji.m03=this.m04,o=ji.m04=this.m05,a=ji.m05=this.m06,s=ji.m06=this.m08,c=ji.m07=this.m09,l=ji.m08=this.m10;return t.x=Math.sqrt(e*e+i*i+n*n),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(s*s+c*c+l*l),Di.determinant(ji)<0&&(t.x*=-1),t},i.getRotation=function(t){var e=this.m00+this.m05+this.m10,i=0;return e>0?(i=2*Math.sqrt(e+1),t.w=.25*i,t.x=(this.m06-this.m09)/i,t.y=(this.m08-this.m02)/i,t.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/i,t.x=.25*i,t.y=(this.m01+this.m04)/i,t.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/i,t.x=(this.m01+this.m04)/i,t.y=.25*i,t.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/i,t.x=(this.m08+this.m02)/i,t.y=(this.m06+this.m09)/i,t.z=.25*i),t},i.fromRTS=function(t,e,i){var n=t.x,r=t.y,o=t.z,a=t.w,s=n+n,c=r+r,l=o+o,u=n*s,h=n*c,_=n*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=i.x,x=i.y,S=i.z;return this.m00=(1-(f+d))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+d))*x,this.m06=(p+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(p-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},i.fromQuat=function(t){var e=t.x,i=t.y,n=t.z,r=t.w,o=e+e,a=i+i,s=n+n,c=e*o,l=i*o,u=i*a,h=n*o,_=n*a,f=n*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+p,this.m07=0,this.m08=h+d,this.m09=_-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(le));Gi.IDENTITY=Object.freeze(new Gi);var Hi=new Ei,ji=new Di;function Wi(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d){return new Gi(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d)}Ze.fastDefine("cc.Mat4",Gi,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),u.Mat4=Gi,u.mat4=Wi;var qi=t("Vec2",function(t){function e(e,i){var n;return n=t.call(this)||this,e&&"object"==typeof e?(n.x=e.x,n.y=e.y):(n.x=e||0,n.y=i||0),n}$(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,i){return t.x=e,t.y=i,t},e.add=function(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t},e.subtract=function(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t},e.multiply=function(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t},e.divide=function(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t},e.max=function(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t},e.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},e.squaredDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},e.len=function(t){var e=t.x,i=t.y;return Math.sqrt(e*e+i*i)},e.lengthSqr=function(t){var e=t.x,i=t.y;return e*e+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var i=e.x,n=e.y;return Math.abs(i)<ni?t.x=0:t.x=1/i,Math.abs(n)<ni?t.y=0:t.y=1/n,t},e.normalize=function(t,e){var i=e.x,n=e.y,r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r),t.x=i*r,t.y=n*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,i){return t instanceof Ei?(t.x=t.y=0,t.z=e.x*i.y-e.y*i.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,i,n){var r=e.x,o=e.y;return t.x=r+n*(i.x-r),t.y=o+n*(i.y-o),t},e.random=function(t,e){e=e||1;var i=2*hi()*Math.PI;return t.x=Math.cos(i)*e,t.y=Math.sin(i)*e,t},e.transformMat3=function(t,e,i){var n=e.x,r=e.y;return t.x=i.m00*n+i.m03*r+i.m06,t.y=i.m01*n+i.m04*r+i.m07,t},e.transformMat4=function(t,e,i){var n=e.x,r=e.y;return t.x=i.m00*n+i.m04*r+i.m12,t.y=i.m01*n+i.m05*r+i.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,i){return void 0===i&&(i=ni),Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,i){e.normalize(Xi,t),e.normalize(Yi,i);var n=e.dot(Xi,Yi);return n>1?0:n<-1?Math.PI:Math.acos(n)};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y)},i.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},i.equals=function(t,e){return void 0===e&&(e=ni),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},i.equals2f=function(t,e,i){return void 0===i&&(i=ni),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))},i.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},i.strictEquals2f=function(t,e){return this.x===t&&this.y===e},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},i.lerp=function(t,e){var i=this.x,n=this.y;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this},i.clampf=function(t,e){return this.x=ai(this.x,t.x,e.x),this.y=ai(this.y,t.y,e.y),this},i.add=function(t){return this.x+=t.x,this.y+=t.y,this},i.add2f=function(t,e){return this.x+=t,this.y+=e,this},i.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},i.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},i.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},i.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},i.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},i.divide=function(t){return this.x/=t.x,this.y/=t.y,this},i.divide2f=function(t,e){return this.x/=t,this.y/=e,this},i.negative=function(){return this.x=-this.x,this.y=-this.y,this},i.dot=function(t){return this.x*t.x+this.y*t.y},i.cross=function(t){return this.x*t.y-this.y*t.x},i.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.lengthSqr=function(){return this.x*this.x+this.y*this.y},i.normalize=function(){var t=this.x,e=this.y,i=t*t+e*e;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this},i.angle=function(t){var e=this.lengthSqr(),i=t.lengthSqr();if(0===e||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(t)/Math.sqrt(e*i);return n=ai(n,-1,1),Math.acos(n)},i.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},i.rotate=function(t){var e=this.x,i=this.y,n=Math.sin(t),r=Math.cos(t);return this.x=r*e-n*i,this.y=n*e+r*i,this},i.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},i.transformMat4=function(t){var e=this.x,i=this.y;return this.x=t.m00*e+t.m04*i+t.m12,this.y=t.m01*e+t.m05*i+t.m13,this},e}(le));qi.ZERO=Object.freeze(new qi(0,0)),qi.ONE=Object.freeze(new qi(1,1)),qi.NEG_ONE=Object.freeze(new qi(-1,-1)),qi.UNIT_X=Object.freeze(new qi(1,0)),qi.UNIT_Y=Object.freeze(new qi(0,1));var Xi=new qi,Yi=new qi;function Ki(t,e){return new qi(t,e)}Ze.fastDefine("cc.Vec2",qi,{x:0,y:0}),u.Vec2=qi,u.v2=Ki;var Ji=t("Vec4",function(t){function e(e,i,n,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=i||0,o.z=n||0,o.w=r||0),o}$(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,i,n,r){return t.x=e,t.y=i,t.z=n,t.w=r,t},e.add=function(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t.w=e.w+i.w,t},e.subtract=function(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t.w=e.w-i.w,t},e.multiply=function(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t.w=e.w*i.w,t},e.divide=function(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t.w=e.w/i.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t.w=Math.min(e.w,i.w),t},e.max=function(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t.w=Math.max(e.w,i.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t},e.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return Math.sqrt(i*i+n*n+r*r+o*o)},e.squaredDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return i*i+n*n+r*r+o*o},e.len=function(t){var e=t.x,i=t.y,n=t.z,r=t.w;return Math.sqrt(e*e+i*i+n*n+r*r)},e.lengthSqr=function(t){var e=t.x,i=t.y,n=t.z,r=t.w;return e*e+i*i+n*n+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var i=e.x,n=e.y,r=e.z,o=e.w;return Math.abs(i)<ni?t.x=0:t.x=1/i,Math.abs(n)<ni?t.y=0:t.y=1/n,Math.abs(r)<ni?t.z=0:t.z=1/r,Math.abs(o)<ni?t.w=0:t.w=1/o,t},e.normalize=function(t,e){var i=e.x,n=e.y,r=e.z,o=e.w,a=i*i+n*n+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),t.x=i*a,t.y=n*a,t.z=r*a,t.w=o*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t},e.random=function(t,e){e=e||1;var i=2*hi()*Math.PI,n=2*hi()-1,r=Math.sqrt(1-n*n);return t.x=r*Math.cos(i)*e,t.y=r*Math.sin(i)*e,t.z=n*e,t.w=0,t},e.transformMat4=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=e.w;return t.x=i.m00*n+i.m04*r+i.m08*o+i.m12*a,t.y=i.m01*n+i.m05*r+i.m09*o+i.m13*a,t.z=i.m02*n+i.m06*r+i.m10*o+i.m14*a,t.w=i.m03*n+i.m07*r+i.m11*o+i.m15*a,t},e.transformAffine=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=e.w;return t.x=i.m00*n+i.m01*r+i.m02*o+i.m03*a,t.y=i.m04*n+i.m05*r+i.m06*o+i.m07*a,t.x=i.m08*n+i.m09*r+i.m10*o+i.m11*a,t.w=e.w,t},e.transformQuat=function(t,e,i){var n=e.x,r=e.y,o=e.z,a=i.x,s=i.y,c=i.z,l=i.w,u=l*n+s*o-c*r,h=l*r+c*n-a*o,_=l*o+a*r-s*n,f=-a*n-s*r-c*o;return t.x=u*l+f*-a+h*-c-_*-s,t.y=h*l+f*-s+_*-a-u*-c,t.z=_*l+f*-c+u*-s-h*-a,t.w=e.w,t},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,i){return void 0===i&&(i=ni),Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.z,this.w)},i.set=function(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0),this},i.equals=function(t,e){return void 0===e&&(e=ni),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},i.equals4f=function(t,e,i,n,r){return void 0===r&&(r=ni),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))},i.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},i.strictEquals4f=function(t,e,i,n){return this.x===t&&this.y===e&&this.z===i&&this.w===n},i.lerp=function(t,e){var i=this.x,n=this.y,r=this.z,o=this.w;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this.z=r+e*(t.z-r),this.w=o+e*(t.w-o),this},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},i.clampf=function(t,e){return this.x=ai(this.x,t.x,e.x),this.y=ai(this.y,t.y,e.y),this.z=ai(this.z,t.z,e.z),this.w=ai(this.w,t.w,e.w),this},i.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},i.add4f=function(t,e,i,n){return this.x+=t,this.y+=e,this.z+=i,this.w+=n,this},i.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},i.subtract4f=function(t,e,i,n){return this.x-=t,this.y-=e,this.z-=i,this.w-=n,this},i.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},i.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},i.multiply4f=function(t,e,i,n){return this.x*=t,this.y*=e,this.z*=i,this.w*=n,this},i.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},i.divide4f=function(t,e,i,n){return this.x/=t,this.y/=e,this.z/=i,this.w/=n,this},i.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},i.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},i.cross=function(t){var e=this.x,i=this.y,n=this.z,r=t.x,o=t.y,a=t.z;return this.x=i*a-n*o,this.y=n*r-e*a,this.z=e*o-i*r,this},i.length=function(){var t=this.x,e=this.y,i=this.z,n=this.w;return Math.sqrt(t*t+e*e+i*i+n*n)},i.lengthSqr=function(){var t=this.x,e=this.y,i=this.z,n=this.w;return t*t+e*e+i*i+n*n},i.normalize=function(){var t=this.x,e=this.y,i=this.z,n=this.w,r=t*t+e*e+i*i+n*n;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=i*r,this.w=n*r),this},i.transformMat4=function(t){var e=this.x,i=this.y,n=this.z,r=this.w;return this.x=t.m00*e+t.m04*i+t.m08*n+t.m12*r,this.y=t.m01*e+t.m05*i+t.m09*n+t.m13*r,this.z=t.m02*e+t.m06*i+t.m10*n+t.m14*r,this.w=t.m03*e+t.m07*i+t.m11*n+t.m15*r,this},e}(le));function Qi(t,e,i,n){return new Ji(t,e,i,n)}Ji.ZERO=Object.freeze(new Ji(0,0,0,0)),Ji.ONE=Object.freeze(new Ji(1,1,1,1)),Ji.NEG_ONE=Object.freeze(new Ji(-1,-1,-1,-1)),Ze.fastDefine("cc.Vec4",Ji,{x:0,y:0,z:0,w:0}),u.Vec4=Ji,u.v4=Qi,k(qi,"Vec2",[{name:"sub",newName:"subtract",target:qi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:qi,targetName:"Vec2"},{name:"div",newName:"divide",target:qi,targetName:"Vec2"},{name:"dist",newName:"distance",target:qi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:qi,targetName:"Vec2"},{name:"mag",newName:"len",target:qi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:qi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:qi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:qi,targetName:"Vec2"}]),k(qi.prototype,"Vec2",[{name:"mag",newName:"length",target:qi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:qi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:qi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:qi.prototype,targetName:"Vec2"}]),k(Ei,"Vec3",[{name:"sub",newName:"subtract",target:Ei,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Ei,targetName:"Vec3"},{name:"div",newName:"divide",target:Ei,targetName:"Vec3"},{name:"dist",newName:"distance",target:Ei,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Ei,targetName:"Vec3"},{name:"mag",newName:"len",target:Ei,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Ei,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ei,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ei,targetName:"Vec3"}]),k(Ei.prototype,"Vec3",[{name:"mag",newName:"length",target:Ei.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Ei.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ei.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ei.prototype,targetName:"Vec3"}]),k(Ji,"Vec4",[{name:"sub",newName:"subtract",target:Ji,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Ji,targetName:"Vec4"},{name:"div",newName:"divide",target:Ji,targetName:"Vec4"},{name:"dist",newName:"distance",target:Ji,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Ji,targetName:"Vec4"},{name:"mag",newName:"len",target:Ji,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Ji,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Ji,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Ji,targetName:"Vec4"}]),k(Ji.prototype,"Vec4",[{name:"mag",newName:"length",target:Ji.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Ji.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Ji.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Ji.prototype,targetName:"Vec4"}]),k(Bi,"Quat",[{name:"mag",newName:"len",target:Bi,targetName:"Quat"},{name:"mul",newName:"multiply",target:Bi,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Bi,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Bi,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Bi,targetName:"Quat"}]),k(Bi.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Bi.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Bi.prototype,targetName:"Quat"}]),k(Ti,"Color",[{name:"sub",newName:"subtract",target:Ti,targetName:"Color"},{name:"mul",newName:"multiply",target:Ti,targetName:"Color"},{name:"div",newName:"divide",target:Ti,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Ti,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=e[1].toString(16);return u.Color.fromHEX(e[0],n)}}]),k(Di,"Mat3",[{name:"sub",newName:"subtract",target:Di,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Di,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Di,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Di,targetName:"Mat3"}]),k(Di.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Di.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Di.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Di.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Di.prototype,targetName:"Mat3"}]),k(Gi,"Mat4",[{name:"sub",newName:"subtract",target:Gi,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Gi,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Gi,targetName:"Mat4"}]),k(Gi.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Gi.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Gi.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Gi.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Gi.prototype,targetName:"Mat4"}]);var Zi=t("AffineTransform",function(){function t(t,e,i,n,r,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=i,this.d=n,this.tx=r,this.ty=o}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,i){var n=e.a,r=e.b,o=e.c,a=e.d,s=e.tx,c=e.ty;t.a=n*i.a+r*i.c,t.b=n*i.b+r*i.d,t.c=o*i.a+a*i.c,t.d=o*i.b+a*i.d,t.tx=s*i.a+c*i.c+i.tx,t.ty=s*i.b+c*i.d+i.ty},t.invert=function(t,e){var i=1/(e.a*e.d-e.b*e.c);t.a=i*e.d,t.b=-i*e.b,t.c=-i*e.c,t.d=i*e.a,t.tx=i*(e.c*e.ty-e.d*e.tx),t.ty=i*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,i,n){var r,o;void 0===n?(n=i,r=e.x,o=e.y):(r=e,o=i),t.x=n.a*r+n.c*o+n.tx,t.y=n.b*r+n.d*o+n.ty},t.transformSize=function(t,e,i){t.width=i.a*e.width+i.c*e.height,t.height=i.b*e.width+i.d*e.height},t.transformRect=function(t,e,i){var n=e.x+e.width,r=e.y+e.height,o=i.a*e.x+i.c*e.y+i.tx,a=i.b*e.x+i.d*e.y+i.ty,s=i.a*n+i.c*e.y+i.tx,c=i.b*n+i.d*e.y+i.ty,l=i.a*e.x+i.c*r+i.tx,u=i.b*e.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,_=i.b*n+i.d*r+i.ty,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);t.x=f,t.y=d,t.width=p-f,t.height=m-d},t.transformObb=function(t,e,i,n,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;e.x=a,e.y=s,i.x=c+a,i.y=l+s,t.x=u+a,t.y=h+s,n.x=c+u+a,n.y=l+h+s},t}());u.AffineTransform=Zi;var $i=t("Size",function(t){function e(e,i){var n;return n=t.call(this)||this,e&&"object"==typeof e?(n.width=e.width,n.height=e.height):(n.width=e||0,n.height=i||0),n}$(e,t),e.lerp=function(t,e,i,n){return t.width=e.width+(i.width-e.width)*n,t.height=e.height+(i.height-e.height)*n,t};var i=e.prototype;return i.clone=function(){return new e(this.width,this.height)},i.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},i.equals=function(t){return this.width===t.width&&this.height===t.height},i.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},i.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},Q(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(le));function tn(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new $i(t,e)}$i.ZERO=Object.freeze(new $i(0,0)),$i.ONE=Object.freeze(new $i(1,1)),Ze.fastDefine("cc.Size",$i,{width:0,height:0}),u.size=tn,u.Size=$i;var en=t("Rect",function(t){function e(e,i,n,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=i||0,o.width=n||0,o.height=r||0),o}$(e,t),e.fromMinMax=function(t,e,i){var n=Math.min(e.x,i.x),r=Math.min(e.y,i.y),o=Math.max(e.x,i.x),a=Math.max(e.y,i.y);return t.x=n,t.y=r,t.width=o-n,t.height=a-r,t},e.lerp=function(t,e,i,n){var r=e.x,o=e.y,a=e.width,s=e.height;return t.x=r+(i.x-r)*n,t.y=o+(i.y-o)*n,t.width=a+(i.width-a)*n,t.height=s+(i.height-s)*n,t},e.intersection=function(t,e,i){var n=e.x,r=e.y,o=e.x+e.width,a=e.y+e.height,s=i.x,c=i.y,l=i.x+i.width,u=i.y+i.height;return t.x=Math.max(n,s),t.y=Math.max(r,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(a,u)-t.y,t},e.union=function(t,e,i){var n=e.x,r=e.y,o=e.width,a=e.height,s=i.x,c=i.y,l=i.width,u=i.height;return t.x=Math.min(n,s),t.y=Math.min(r,c),t.width=Math.max(n+o,s+l)-t.x,t.height=Math.max(r+a,c+u)-t.y,t};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.width,this.height)},i.set=function(t,e,i,n){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0),this},i.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},i.lerp=function(t,e){var i=this.x,n=this.y,r=this.width,o=this.height;return this.x=i+(t.x-i)*e,this.y=n+(t.y-n)*e,this.width=r+(t.width-r)*e,this.height=o+(t.height-o)*e,this},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},i.intersects=function(t){var e=this.x+this.width,i=this.y+this.height,n=t.x+t.width,r=t.y+t.height;return!(e<t.x||n<this.x||i<t.y||r<this.y)},i.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},i.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},i.transformMat4=function(t){var e=this.x,i=this.y,n=e+this.width,r=i+this.height,o=t.m00*e+t.m04*i+t.m12,a=t.m01*e+t.m05*i+t.m13,s=t.m00*n+t.m04*i+t.m12,c=t.m01*n+t.m05*i+t.m13,l=t.m00*e+t.m04*r+t.m12,u=t.m01*e+t.m05*r+t.m13,h=t.m00*n+t.m04*r+t.m12,_=t.m01*n+t.m05*r+t.m13,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=d,this.width=p-f,this.height=m-d,this},i.transformMat4ToPoints=function(t,e,i,n,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*s+t.m04*a+t.m12,r.y=t.m01*s+t.m05*a+t.m13,i.x=t.m00*o+t.m04*c+t.m12,i.y=t.m01*o+t.m05*c+t.m13,n.x=t.m00*s+t.m04*c+t.m12,n.y=t.m01*s+t.m05*c+t.m13},Q(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new qi(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new qi(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new $i(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(le));function nn(t,e,i,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),new en(t,e,i,n)}Ze.fastDefine("cc.Rect",en,{x:0,y:0,width:0,height:0}),u.Rect=en,u.rect=nn;var rn=t("MATH_FLOAT_ARRAY",Float64Array),on=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.createFloatArray=function(t){return new rn(t)},Q(e,[{key:"array",get:function(){return this._array}}]),e}(le)),an=Object.freeze({__proto__:null,bits:c,Vec2:qi,v2:Ki,Vec3:Ei,v3:Ri,Vec4:Ji,v4:Qi,Quat:Bi,quat:ki,Mat3:Di,Mat4:Gi,mat4:Wi,AffineTransform:Zi,Size:$i,size:tn,Rect:en,rect:nn,Color:Ti,color:wi,EPSILON:ni,equals:ri,approx:oi,clamp:ai,clamp01:si,lerp:ci,toRadian:li,toDegree:ui,random:hi,randomRange:_i,randomRangeInt:fi,pseudoRandom:pi,pseudoRandomRange:di,pseudoRandomRangeInt:mi,nextPow2:vi,repeat:gi,pingPong:yi,inverseLerp:xi,absMaxComponent:Si,absMax:bi,enumerableProps:Ci,MATH_FLOAT_ARRAY:rn,MathBase:on});t("math",an);var sn,cn,ln,un,hn,_n,fn,pn,dn,mn,vn,gn,yn,xn,Sn,bn,Cn,An,Tn,wn,En,Pn,In,Rn,Dn,Mn,On,Bn,Nn,Ln,Fn,zn,Vn,kn,Un,Gn,Hn,jn,Wn,qn,Xn,Yn=function(t,e,i){for(var n=0;n<e.length;++n)t.length<=n&&t.push(new i),t[n].copy(e[n]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(sn||(sn={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(cn||(cn={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(ln||(ln={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(un||(un={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=20]="COUNT"}(hn||(hn={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(_n||(_n={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(fn||(fn={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(pn||(pn={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(dn||(dn={})),function(t){t[t.NONE=0]="NONE"}(mn||(mn={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(vn||(vn={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(gn||(gn={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(yn||(yn={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(xn||(xn={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Sn||(Sn={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(bn||(bn={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(Cn||(Cn={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(An||(An={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Tn||(Tn={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(wn||(wn={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(En||(En={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Pn||(Pn={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(In||(In={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Rn||(Rn={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Dn||(Dn={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Mn||(Mn={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(On||(On={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Bn||(Bn={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Nn||(Nn={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(Ln||(Ln={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Fn||(Fn={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(zn||(zn={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(Vn||(Vn={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(kn||(kn={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Un||(Un={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Gn||(Gn={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Hn||(Hn={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(jn||(jn={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(Wn||(Wn={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(qn||(qn={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Xn||(Xn={}));var Kn,Jn=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Qn=function(){function t(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new Jn),void 0===v&&(v=new Jn),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),Zn=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),$n=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),tr=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.width=t,this.height=e,this.depth=i}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),er=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=i}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),ir=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=i,this.layerCount=n}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),nr=function(){function t(t,e,i,n,r){void 0===t&&(t=new er),void 0===e&&(e=new Zn),void 0===i&&(i=new er),void 0===n&&(n=new Zn),void 0===r&&(r=new tr),this.srcSubres=t,this.srcOffset=e,this.dstSubres=i,this.dstOffset=n,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),rr=function(){function t(t,e,i,n,r,o){void 0===t&&(t=new er),void 0===e&&(e=new Zn),void 0===i&&(i=new tr),void 0===n&&(n=new er),void 0===r&&(r=new Zn),void 0===o&&(o=new tr),this.srcSubres=t,this.srcOffset=e,this.srcExtent=i,this.dstSubres=n,this.dstOffset=r,this.dstExtent=o}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),or=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=new Zn),void 0===n&&(n=new tr),void 0===r&&(r=new er),this.buffStride=t,this.buffTexHeight=e,this.texOffset=i,this.texExtent=n,this.texSubres=r}return t.prototype.copy=function(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),ar=function(){function t(t,e,i,n,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=t,this.top=e,this.width=i,this.height=n,this.minDepth=r,this.maxDepth=o}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),sr=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=i,this.w=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),cr=function(){function t(t,e,i){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=0),this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=i}return t.prototype.copy=function(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this},t}(),lr=function(){function t(t,e,i,n){void 0===t&&(t=null),void 0===e&&(e=Cn.ON),void 0===i&&(i=0),void 0===n&&(n=0),this.windowHandle=t,this.vsyncMode=e,this.width=i,this.height=n}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),ur=function(){function t(t){void 0===t&&(t=new cr),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),hr=function(){function t(t,e,i,n,r){void 0===t&&(t=dn.NONE),void 0===e&&(e=gn.NONE),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=mn.NONE),this.usage=t,this.memUsage=e,this.size=i,this.stride=n,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),_r=function(){function t(t,e,i){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),this.buffer=t,this.offset=e,this.range=i}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),fr=function(){function t(t,e,i,n,r,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=i,this.firstIndex=n,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),pr=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),dr=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return Yn(this.drawInfos,t.drawInfos,fr),this},t}(),mr=function(){function t(t,e,i,n,r,o,a,s,c,l,u){void 0===t&&(t=yn.TEX2D),void 0===e&&(e=xn.NONE),void 0===i&&(i=_n.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=Sn.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=bn.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=t,this.usage=e,this.format=i,this.width=n,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),vr=function(){function t(t,e,i,n,r,o,a){void 0===t&&(t=null),void 0===e&&(e=yn.TEX2D),void 0===i&&(i=_n.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=i,this.baseLevel=n,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),gr=function(){function t(t,e,i,n,r,o,a,s){void 0===t&&(t=An.LINEAR),void 0===e&&(e=An.LINEAR),void 0===i&&(i=An.NONE),void 0===n&&(n=Tn.WRAP),void 0===r&&(r=Tn.WRAP),void 0===o&&(o=Tn.WRAP),void 0===a&&(a=0),void 0===s&&(s=wn.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=i,this.addressU=n,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),yr=function(){function t(t,e,i){void 0===t&&(t=""),void 0===e&&(e=pn.UNKNOWN),void 0===i&&(i=0),this.name=t,this.type=e,this.count=i}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),xr=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.members=n,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,Yn(this.members,t.members,yr),this.count=t.count,this},t}(),Sr=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=pn.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.type=n,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),br=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.count=n}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Cr=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=pn.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.type=n,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Ar=function(){function t(t,e,i,n,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=pn.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=vn.READ_WRITE),this.set=t,this.binding=e,this.name=i,this.type=n,this.count=r,this.memoryAccess=o}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Tr=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=0),void 0===r&&(r=vn.READ_WRITE),this.set=t,this.binding=e,this.name=i,this.count=n,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),wr=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.count=n}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Er=function(){function t(t,e){void 0===t&&(t=Dn.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Pr=function(){function t(t,e,i,n,r,o){void 0===t&&(t=""),void 0===e&&(e=_n.UNKNOWN),void 0===i&&(i=!1),void 0===n&&(n=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=t,this.format=e,this.isNormalized=i,this.stream=n,this.isInstanced=r,this.location=o}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),Ir=function(){function t(t,e,i,n,r,o,a,s,c,l){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=t,this.stages=e,this.attributes=i,this.blocks=n,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return t.prototype.copy=function(t){return this.name=t.name,Yn(this.stages,t.stages,Er),Yn(this.attributes,t.attributes,Pr),Yn(this.blocks,t.blocks,xr),Yn(this.buffers,t.buffers,Tr),Yn(this.samplerTextures,t.samplerTextures,Sr),Yn(this.samplers,t.samplers,br),Yn(this.textures,t.textures,Cr),Yn(this.images,t.images,Ar),Yn(this.subpassInputs,t.subpassInputs,wr),this},t}(),Rr=function(){function t(t,e,i,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=null),void 0===n&&(n=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=i,this.indirectBuffer=n}return t.prototype.copy=function(t){return Yn(this.attributes,t.attributes,Pr),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),Dr=function(){function t(t,e,i,n,r,o,a){void 0===t&&(t=_n.UNKNOWN),void 0===e&&(e=bn.ONE),void 0===i&&(i=Mn.CLEAR),void 0===n&&(n=On.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Bn.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=t,this.sampleCount=e,this.loadOp=i,this.storeOp=n,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Mr=function(){function t(t,e,i,n,r,o,a,s,c){void 0===t&&(t=_n.UNKNOWN),void 0===e&&(e=bn.ONE),void 0===i&&(i=Mn.CLEAR),void 0===n&&(n=On.STORE),void 0===r&&(r=Mn.CLEAR),void 0===o&&(o=On.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Bn.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Or=function(){function t(t,e,i,n,r,o,a,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Nn.NONE),void 0===s&&(s=Nn.NONE),this.inputs=t,this.colors=e,this.resolves=i,this.preserves=n,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),Br=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=[]),void 0===n&&(n=[]),this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=i,this.dstAccesses=n}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this},t}(),Nr=function(){function t(t,e,i,n){void 0===t&&(t=[]),void 0===e&&(e=new Mr),void 0===i&&(i=[]),void 0===n&&(n=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=i,this.dependencies=n}return t.prototype.copy=function(t){return Yn(this.colorAttachments,t.colorAttachments,Dr),this.depthStencilAttachment.copy(t.depthStencilAttachment),Yn(this.subpasses,t.subpasses,Or),Yn(this.dependencies,t.dependencies,Br),this},t}(),Lr=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.prevAccesses=t,this.nextAccesses=e}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this},t}(),Fr=function(){function t(t,e,i,n,r){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=!1),void 0===n&&(n=null),void 0===r&&(r=null),this.prevAccesses=t,this.nextAccesses=e,this.discardContents=i,this.srcQueue=n,this.dstQueue=r}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),zr=function(){function t(t,e,i){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===i&&(i=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=i}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),Vr=function(){function t(t,e,i,n,r){void 0===t&&(t=-1),void 0===e&&(e=Hn.UNKNOWN),void 0===i&&(i=0),void 0===n&&(n=Dn.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=i,this.stageFlags=n,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),kr=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return Yn(this.bindings,t.bindings,Vr),this},t}(),Ur=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),Gr=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),Hr=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return Yn(this.attributes,t.attributes,Pr),this},t}(),jr=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=qn.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),Wr=function(){function t(t){void 0===t&&(t=jn.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),qr=function(){function t(t,e,i){void 0===t&&(t=Wn.OCCLUSION),void 0===e&&(e=65536),void 0===i&&(i=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=i}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),Xr=function(t,e,i,n,r,o,a,s){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=fn.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=t,this.size=e,this.count=i,this.type=n,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Yr=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),Kr=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.writeMask=t,this.compareMask=e,this.reference=i}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),Jr=function(){function t(t,e,i,n,r,o,a,s,c,l,u){void 0===t&&(t=new ar),void 0===e&&(e=new $n),void 0===i&&(i=new sr),void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new Kr),void 0===u&&(u=new Kr),this.viewport=t,this.scissor=e,this.blendConstant=i,this.lineWidth=n,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),Qr=function(){function t(e){this._objectType=sn.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=t._idTable[sn.UNKNOWN]++,this._typedID=t._idTable[e]++}return Q(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}();Qr._idTable=Array(sn.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Kn||(Kn={}));var Zr=Object.freeze([new Xr("UNKNOWN",0,0,fn.NONE,!1,!1,!1,!1),new Xr("A8",1,1,fn.UNORM,!0,!1,!1,!1),new Xr("L8",1,1,fn.UNORM,!1,!1,!1,!1),new Xr("LA8",1,2,fn.UNORM,!0,!1,!1,!1),new Xr("R8",1,1,fn.UNORM,!1,!1,!1,!1),new Xr("R8SN",1,1,fn.SNORM,!1,!1,!1,!1),new Xr("R8UI",1,1,fn.UINT,!1,!1,!1,!1),new Xr("R8I",1,1,fn.INT,!1,!1,!1,!1),new Xr("R16F",2,1,fn.FLOAT,!1,!1,!1,!1),new Xr("R16UI",2,1,fn.UINT,!1,!1,!1,!1),new Xr("R16I",2,1,fn.INT,!1,!1,!1,!1),new Xr("R32F",4,1,fn.FLOAT,!1,!1,!1,!1),new Xr("R32UI",4,1,fn.UINT,!1,!1,!1,!1),new Xr("R32I",4,1,fn.INT,!1,!1,!1,!1),new Xr("RG8",2,2,fn.UNORM,!1,!1,!1,!1),new Xr("RG8SN",2,2,fn.SNORM,!1,!1,!1,!1),new Xr("RG8UI",2,2,fn.UINT,!1,!1,!1,!1),new Xr("RG8I",2,2,fn.INT,!1,!1,!1,!1),new Xr("RG16F",4,2,fn.FLOAT,!1,!1,!1,!1),new Xr("RG16UI",4,2,fn.UINT,!1,!1,!1,!1),new Xr("RG16I",4,2,fn.INT,!1,!1,!1,!1),new Xr("RG32F",8,2,fn.FLOAT,!1,!1,!1,!1),new Xr("RG32UI",8,2,fn.UINT,!1,!1,!1,!1),new Xr("RG32I",8,2,fn.INT,!1,!1,!1,!1),new Xr("RGB8",3,3,fn.UNORM,!1,!1,!1,!1),new Xr("SRGB8",3,3,fn.UNORM,!1,!1,!1,!1),new Xr("RGB8SN",3,3,fn.SNORM,!1,!1,!1,!1),new Xr("RGB8UI",3,3,fn.UINT,!1,!1,!1,!1),new Xr("RGB8I",3,3,fn.INT,!1,!1,!1,!1),new Xr("RGB16F",6,3,fn.FLOAT,!1,!1,!1,!1),new Xr("RGB16UI",6,3,fn.UINT,!1,!1,!1,!1),new Xr("RGB16I",6,3,fn.INT,!1,!1,!1,!1),new Xr("RGB32F",12,3,fn.FLOAT,!1,!1,!1,!1),new Xr("RGB32UI",12,3,fn.UINT,!1,!1,!1,!1),new Xr("RGB32I",12,3,fn.INT,!1,!1,!1,!1),new Xr("RGBA8",4,4,fn.UNORM,!0,!1,!1,!1),new Xr("BGRA8",4,4,fn.UNORM,!0,!1,!1,!1),new Xr("SRGB8_A8",4,4,fn.UNORM,!0,!1,!1,!1),new Xr("RGBA8SN",4,4,fn.SNORM,!0,!1,!1,!1),new Xr("RGBA8UI",4,4,fn.UINT,!0,!1,!1,!1),new Xr("RGBA8I",4,4,fn.INT,!0,!1,!1,!1),new Xr("RGBA16F",8,4,fn.FLOAT,!0,!1,!1,!1),new Xr("RGBA16UI",8,4,fn.UINT,!0,!1,!1,!1),new Xr("RGBA16I",8,4,fn.INT,!0,!1,!1,!1),new Xr("RGBA32F",16,4,fn.FLOAT,!0,!1,!1,!1),new Xr("RGBA32UI",16,4,fn.UINT,!0,!1,!1,!1),new Xr("RGBA32I",16,4,fn.INT,!0,!1,!1,!1),new Xr("R5G6B5",2,3,fn.UNORM,!1,!1,!1,!1),new Xr("R11G11B10F",4,3,fn.FLOAT,!1,!1,!1,!1),new Xr("RGB5A1",2,4,fn.UNORM,!0,!1,!1,!1),new Xr("RGBA4",2,4,fn.UNORM,!0,!1,!1,!1),new Xr("RGB10A2",2,4,fn.UNORM,!0,!1,!1,!1),new Xr("RGB10A2UI",2,4,fn.UINT,!0,!1,!1,!1),new Xr("RGB9E5",2,4,fn.FLOAT,!0,!1,!1,!1),new Xr("DEPTH",4,1,fn.FLOAT,!1,!0,!1,!1),new Xr("DEPTH_STENCIL",5,2,fn.FLOAT,!1,!0,!0,!1),new Xr("BC1",1,3,fn.UNORM,!1,!1,!1,!0),new Xr("BC1_ALPHA",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC1_SRGB",1,3,fn.UNORM,!1,!1,!1,!0),new Xr("BC1_SRGB_ALPHA",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC2",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC2_SRGB",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC3",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC3_SRGB",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC4",1,1,fn.UNORM,!1,!1,!1,!0),new Xr("BC4_SNORM",1,1,fn.SNORM,!1,!1,!1,!0),new Xr("BC5",1,2,fn.UNORM,!1,!1,!1,!0),new Xr("BC5_SNORM",1,2,fn.SNORM,!1,!1,!1,!0),new Xr("BC6H_UF16",1,3,fn.UFLOAT,!1,!1,!1,!0),new Xr("BC6H_SF16",1,3,fn.FLOAT,!1,!1,!1,!0),new Xr("BC7",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("BC7_SRGB",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ETC_RGB8",1,3,fn.UNORM,!1,!1,!1,!0),new Xr("ETC2_RGB8",1,3,fn.UNORM,!1,!1,!1,!0),new Xr("ETC2_SRGB8",1,3,fn.UNORM,!1,!1,!1,!0),new Xr("ETC2_RGB8_A1",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ETC2_SRGB8_A1",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ETC2_RGBA8",2,4,fn.UNORM,!0,!1,!1,!0),new Xr("ETC2_SRGB8_A8",2,4,fn.UNORM,!0,!1,!1,!0),new Xr("EAC_R11",1,1,fn.UNORM,!1,!1,!1,!0),new Xr("EAC_R11SN",1,1,fn.SNORM,!1,!1,!1,!0),new Xr("EAC_RG11",2,2,fn.UNORM,!1,!1,!1,!0),new Xr("EAC_RG11SN",2,2,fn.SNORM,!1,!1,!1,!0),new Xr("PVRTC_RGB2",2,3,fn.UNORM,!1,!1,!1,!0),new Xr("PVRTC_RGBA2",2,4,fn.UNORM,!0,!1,!1,!0),new Xr("PVRTC_RGB4",2,3,fn.UNORM,!1,!1,!1,!0),new Xr("PVRTC_RGBA4",2,4,fn.UNORM,!0,!1,!1,!0),new Xr("PVRTC2_2BPP",2,4,fn.UNORM,!0,!1,!1,!0),new Xr("PVRTC2_4BPP",2,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_4x4",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_5x4",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_5x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_6x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_6x6",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x6",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_8x8",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x6",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x8",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_10x10",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_12x10",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_RGBA_12x12",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_4x4",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_5x4",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_5x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_6x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_6x6",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x6",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_8x8",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x5",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x6",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x8",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_10x10",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_12x10",1,4,fn.UNORM,!0,!1,!1,!0),new Xr("ASTC_SRGBA_12x12",1,4,fn.UNORM,!0,!1,!1,!0)]),$r=Hn.UNIFORM_BUFFER|Hn.DYNAMIC_UNIFORM_BUFFER|Hn.STORAGE_BUFFER|Hn.DYNAMIC_STORAGE_BUFFER,to=Hn.SAMPLER_TEXTURE|Hn.SAMPLER|Hn.TEXTURE|Hn.STORAGE_IMAGE|Hn.INPUT_ATTACHMENT,eo=Hn.DYNAMIC_STORAGE_BUFFER|Hn.DYNAMIC_UNIFORM_BUFFER,io=28;function no(t){return t>0&&0==(t&t-1)}function ro(t,e,i,n){if(!Zr[t].isCompressed)return e*i*n*Zr[t].size;switch(t){case _n.BC1:case _n.BC1_ALPHA:case _n.BC1_SRGB:case _n.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case _n.BC2:case _n.BC2_SRGB:case _n.BC3:case _n.BC3_SRGB:case _n.BC4:case _n.BC4_SNORM:case _n.BC6H_SF16:case _n.BC6H_UF16:case _n.BC7:case _n.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case _n.BC5:case _n.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(i/4)*32*n;case _n.ETC_RGB8:case _n.ETC2_RGB8:case _n.ETC2_SRGB8:case _n.ETC2_RGB8_A1:case _n.EAC_R11:case _n.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case _n.ETC2_RGBA8:case _n.ETC2_SRGB8_A1:case _n.EAC_RG11:case _n.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case _n.PVRTC_RGB2:case _n.PVRTC_RGBA2:case _n.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(i,8)/4)*n;case _n.PVRTC_RGB4:case _n.PVRTC_RGBA4:case _n.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(i,8)/2)*n;case _n.ASTC_RGBA_4X4:case _n.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case _n.ASTC_RGBA_5X4:case _n.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(i/4)*16*n;case _n.ASTC_RGBA_5X5:case _n.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(i/5)*16*n;case _n.ASTC_RGBA_6X5:case _n.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(i/5)*16*n;case _n.ASTC_RGBA_6X6:case _n.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(i/6)*16*n;case _n.ASTC_RGBA_8X5:case _n.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(i/5)*16*n;case _n.ASTC_RGBA_8X6:case _n.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(i/6)*16*n;case _n.ASTC_RGBA_8X8:case _n.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(i/8)*16*n;case _n.ASTC_RGBA_10X5:case _n.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(i/5)*16*n;case _n.ASTC_RGBA_10X6:case _n.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(i/6)*16*n;case _n.ASTC_RGBA_10X8:case _n.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(i/8)*16*n;case _n.ASTC_RGBA_10X10:case _n.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(i/10)*16*n;case _n.ASTC_RGBA_12X10:case _n.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(i/10)*16*n;case _n.ASTC_RGBA_12X12:case _n.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(i/12)*16*n;default:return 0}}function oo(t,e,i,n,r){for(var o=0,a=0;a<r;++a)o+=ro(t,e,i,n),e=Math.max(e>>1,1),i=Math.max(i>>1,1);return o}var ao=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function so(t){return ao[t]||0}function co(t){var e=t.size/t.count;switch(t.type){case fn.UNORM:case fn.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case fn.SNORM:case fn.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case fn.FLOAT:return Float32Array}return Float32Array}var lo=Object.freeze({__proto__:null,get ObjectType(){return sn},get Status(){return cn},get API(){return ln},get SurfaceTransform(){return un},get Feature(){return hn},get Format(){return _n},get FormatType(){return fn},get Type(){return pn},get BufferUsageBit(){return dn},get BufferFlagBit(){return mn},get MemoryAccessBit(){return vn},get MemoryUsageBit(){return gn},get TextureType(){return yn},get TextureUsageBit(){return xn},get TextureFlagBit(){return Sn},get SampleCount(){return bn},get VsyncMode(){return Cn},get Filter(){return An},get Address(){return Tn},get ComparisonFunc(){return wn},get StencilOp(){return En},get BlendFactor(){return Pn},get BlendOp(){return In},get ColorMask(){return Rn},get ShaderStageFlagBit(){return Dn},get LoadOp(){return Mn},get StoreOp(){return On},get AccessType(){return Bn},get ResolveMode(){return Nn},get PipelineBindPoint(){return Ln},get PrimitiveMode(){return Fn},get PolygonMode(){return zn},get ShadeModel(){return Vn},get CullMode(){return kn},get DynamicStateFlagBit(){return Un},get StencilFace(){return Gn},get DescriptorType(){return Hn},get QueueType(){return jn},get QueryType(){return Wn},get CommandBufferType(){return qn},get ClearFlagBit(){return Xn},Size:Jn,DeviceCaps:Qn,Offset:Zn,Rect:$n,Extent:tr,TextureSubresLayers:er,TextureSubresRange:ir,TextureCopy:nr,TextureBlit:rr,BufferTextureCopy:or,Viewport:ar,Color:sr,BindingMappingInfo:cr,SwapchainInfo:lr,DeviceInfo:ur,BufferInfo:hr,BufferViewInfo:_r,DrawInfo:fr,DispatchInfo:pr,IndirectBuffer:dr,TextureInfo:mr,TextureViewInfo:vr,SamplerInfo:gr,Uniform:yr,UniformBlock:xr,UniformSamplerTexture:Sr,UniformSampler:br,UniformTexture:Cr,UniformStorageImage:Ar,UniformStorageBuffer:Tr,UniformInputAttachment:wr,ShaderStage:Er,Attribute:Pr,ShaderInfo:Ir,InputAssemblerInfo:Rr,ColorAttachment:Dr,DepthStencilAttachment:Mr,SubpassInfo:Or,SubpassDependency:Br,RenderPassInfo:Nr,GlobalBarrierInfo:Lr,TextureBarrierInfo:Fr,FramebufferInfo:zr,DescriptorSetLayoutBinding:Vr,DescriptorSetLayoutInfo:kr,DescriptorSetInfo:Ur,PipelineLayoutInfo:Gr,InputState:Hr,CommandBufferInfo:jr,QueueInfo:Wr,QueryPoolInfo:qr,FormatInfo:Xr,MemoryStatus:Yr,DynamicStencilStates:Kr,DynamicStates:Jr,GFXObject:Qr,get AttributeName(){return Kn},FormatInfos:Zr,DESCRIPTOR_BUFFER_TYPE:$r,DESCRIPTOR_SAMPLER_TYPE:to,DESCRIPTOR_DYNAMIC_TYPE:eo,DRAW_INFO_SIZE:io,IsPowerOf2:no,FormatSize:ro,FormatSurfaceSize:oo,GetTypeSize:so,getTypedArrayConstructor:co}),uo=function(t){function e(){var e;return(e=t.call(this,sn.BUFFER)||this)._usage=dn.NONE,e._memUsage=gn.NONE,e._size=0,e._stride=1,e._count=0,e._flags=mn.NONE,e._isBufferView=!1,e}return $(e,t),Q(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(Qr),ho=function(t){function e(){var e;return(e=t.call(this,sn.COMMAND_BUFFER)||this)._queue=null,e._type=qn.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return $(e,t),Q(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(Qr),_o=function(){function t(){this._gfxAPI=ln.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(hn.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Yr,this._caps=new Qn,this._bindingMappingInfo=new cr,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return t.prototype.hasFeature=function(t){return this._features[t]},Q(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();_o.canvas=void 0;var fo=function(t){function e(){var e;return(e=t.call(this,sn.SWAPCHAIN)||this)._transform=un.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return $(e,t),Q(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(Qr),po=function(t){function e(){var e;return(e=t.call(this,sn.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return $(e,t),Q(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(Qr),mo=String.prototype.charCodeAt;function vo(t){return this[t]}function go(t,e){for(var i=t.length,n=e^i,r=0,o="string"==typeof t?mo:vo;i>=4;){var a=255&o.call(t,r)|(255&o.call(t,++r))<<8|(255&o.call(t,++r))<<16|(255&o.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&o.call(t,r+2))<<16;case 2:n^=(255&o.call(t,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&o.call(t,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}var yo=function(t){function e(){var e;return(e=t.call(this,sn.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new fr,e}$(e,t);var i=e.prototype;return i.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},i.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var i=this.attributes[e];t+=","+i.name+","+i.format+","+i.isNormalized+","+i.stream+","+i.isInstanced}return go(t,666)},Q(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo}}]),e}(Qr),xo=function(t){function e(){var e;return(e=t.call(this,sn.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}$(e,t);var i=e.prototype;return i.bindBuffer=function(t,e,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[t],r=this._layout.bindings[n];if(r&&r.descriptorType&$r){var o=this._layout.descriptorIndices[t];this._buffers[o+i]!==e&&(this._buffers[o+i]=e,this._isDirty=!0)}},i.bindSampler=function(t,e,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[t],r=this._layout.bindings[n];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[t];this._samplers[o+i]!==e&&(this._samplers[o+i]=e,this._isDirty=!0)}},i.bindTexture=function(t,e,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[t],r=this._layout.bindings[n];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[t];this._textures[o+i]!==e&&(this._textures[o+i]=e,this._isDirty=!0)}},i.getBuffer=function(t,e){void 0===e&&(e=0);var i=this._layout.descriptorIndices[t];return this._buffers[i+e]},i.getSampler=function(t,e){void 0===e&&(e=0);var i=this._layout.descriptorIndices[t];return this._samplers[i+e]},i.getTexture=function(t,e){void 0===e&&(e=0);var i=this._layout.descriptorIndices[t];return this._textures[i+e]},Q(e,[{key:"layout",get:function(){return this._layout}}]),e}(Qr),So=function(t){function e(){var e;return(e=t.call(this,sn.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return $(e,t),Q(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(Qr),bo=function(t){function e(){var e;return(e=t.call(this,sn.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return $(e,t),Q(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(Qr),Co=function(){function t(t,e,i,n,r,o,a,s,c,l,u,h){void 0===t&&(t=!1),void 0===e&&(e=zn.FILL),void 0===i&&(i=Vn.GOURAND),void 0===n&&(n=kn.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=zn.FILL,this.shadeModel=Vn.GOURAND,this.cullMode=kn.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},Q(t,[{key:"native",get:function(){return this}}]),t}(),Ao=function(){function t(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===i&&(i=wn.LESS),void 0===n&&(n=!1),void 0===r&&(r=wn.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=En.KEEP),void 0===c&&(c=En.KEEP),void 0===l&&(l=En.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=wn.ALWAYS),void 0===f&&(f=65535),void 0===p&&(p=65535),void 0===d&&(d=En.KEEP),void 0===m&&(m=En.KEEP),void 0===v&&(v=En.KEEP),void 0===g&&(g=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=wn.LESS,this.stencilTestFront=!1,this.stencilFuncFront=wn.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=En.KEEP,this.stencilZFailOpFront=En.KEEP,this.stencilPassOpFront=En.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=wn.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=En.KEEP,this.stencilZFailOpBack=En.KEEP,this.stencilPassOpBack=En.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},Q(t,[{key:"native",get:function(){return this}}]),t}(),To=function(){function t(t,e,i,n,r,o,a,s){void 0===t&&(t=!1),void 0===e&&(e=Pn.ONE),void 0===i&&(i=Pn.ZERO),void 0===n&&(n=In.ADD),void 0===r&&(r=Pn.ONE),void 0===o&&(o=Pn.ZERO),void 0===a&&(a=In.ADD),void 0===s&&(s=Rn.ALL),this.blend=t,this.blendSrc=e,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=Pn.ONE,this.blendDst=Pn.ZERO,this.blendEq=In.ADD,this.blendSrcAlpha=Pn.ONE,this.blendDstAlpha=Pn.ZERO,this.blendAlphaEq=In.ADD,this.blendColorMask=Rn.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),wo=function(){function t(t,e,i,n){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=new sr),void 0===n&&(n=[new To]),this.isA2C=t,this.isIndepend=e,this.blendColor=i,this.targets=n}var e=t.prototype;return e.setTarget=function(t,e){var i=this.targets[t];i||(i=this.targets[t]=new To),Object.assign(i,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},Q(t,[{key:"native",get:function(){return this}}]),t}(),Eo=function(t,e,i,n,r,o,a,s,c,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),void 0===n&&(n=new Hr),void 0===r&&(r=new Co),void 0===o&&(o=new Ao),void 0===a&&(a=new wo),void 0===s&&(s=Fn.TRIANGLE_LIST),void 0===c&&(c=Un.NONE),void 0===l&&(l=Ln.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=i,this.inputState=n,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Po=function(t){function e(){var e;return(e=t.call(this,sn.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=Fn.TRIANGLE_LIST,e._is=null,e._rs=new Co,e._dss=new Ao,e._bs=new wo,e._dynamicStates=Un.NONE,e._renderPass=null,e}return $(e,t),Q(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(Qr),Io=function(t){function e(){var e;return(e=t.call(this,sn.QUEUE)||this)._type=jn.GRAPHICS,e}return $(e,t),Q(e,[{key:"type",get:function(){return this._type}}]),e}(Qr),Ro=function(t){function e(){var e;return(e=t.call(this,sn.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return $(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var i=this._subpasses[e];if(i.inputs.length){t+="ia";for(var n=0;n<i.inputs.length;++n){var r=this._colorInfos[i.inputs[n]];t+=","+r.format+","+r.sampleCount}}if(i.colors.length){t+="ca";for(var o=0;o<i.inputs.length;++o){var a=this._colorInfos[i.inputs[o]];t+=","+a.format+","+a.sampleCount}}if(i.depthStencil>=0){var s=this._colorInfos[i.depthStencil];t+="ds,"+s.format+","+s.sampleCount}}else{t+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];t+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(t+="ds,"+u.format+","+u.sampleCount)}return go(t,666)},Q(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),Do=function(t){function e(e,i){var n;return(n=t.call(this,sn.SAMPLER)||this)._info=new gr,n._hash=0,n._info.copy(e),n._hash=i,n}return $(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new gr;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},Q(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),Mo=function(t){function e(){var e;return(e=t.call(this,sn.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return $(e,t),Q(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(Qr),Oo=function(t){function e(){var e;return(e=t.call(this,sn.TEXTURE)||this)._type=yn.TEX2D,e._usage=xn.NONE,e._format=_n.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=bn.ONE,e._flags=Sn.NONE,e._isPowerOf2=!1,e._size=0,e}return $(e,t),Q(e,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),e}(Qr),Bo=function(t){function e(e,i){var n;return(n=t.call(this,sn.GLOBAL_BARRIER)||this)._info=new Lr,n._hash=0,n._info.copy(e),n._hash=i,n}return $(e,t),e.computeHash=function(t){for(var e="prev:",i=0;i<t.prevAccesses.length;++i)e+=" "+t.prevAccesses[i];e+="next:";for(var n=0;n<t.nextAccesses.length;++n)e+=" "+t.nextAccesses[n];return go(e,666)},Q(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),No=function(t){function e(e,i){var n;return(n=t.call(this,sn.TEXTURE_BARRIER)||this)._info=new Fr,n._hash=0,n._info.copy(e),n._hash=i,n}return $(e,t),e.computeHash=function(t){for(var e="prev:",i=0;i<t.prevAccesses.length;++i)e+=" "+t.prevAccesses[i];e+="next:";for(var n=0;n<t.nextAccesses.length;++n)e+=" "+t.nextAccesses[n];return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,go(e+=t.dstQueue?t.dstQueue.type:0,666)},Q(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Qr),Lo={Device:_o,Swapchain:fo,Buffer:uo,Texture:Oo,Sampler:Do,Shader:Mo,InputAssembler:yo,RenderPass:Ro,Framebuffer:po,DescriptorSet:xo,DescriptorSetLayout:So,PipelineLayout:bo,PipelineState:Po,CommandBuffer:ho,Queue:Io,GlobalBarrier:Bo,TextureBarrier:No,RasterizerState:Co,BlendState:wo,BlendTarget:To,DepthStencilState:Ao,PipelineStateInfo:Eo};Object.assign(Lo,lo),u.gfx=Lo;var Fo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var zo in u.gfx)if("__esModule"!==zo){var Vo=Fo[zo];""===Vo?Vo=zo:void 0===Vo&&(Vo="GFX"+zo),k(u,"cc",[{name:Vo,newName:zo,target:u.gfx,targetName:"cc.gfx"}])}t("gfx",Object.freeze({__proto__:null,DescriptorSet:xo,Buffer:uo,CommandBuffer:ho,get ObjectType(){return sn},get Status(){return cn},get API(){return ln},get SurfaceTransform(){return un},get Feature(){return hn},get Format(){return _n},get FormatType(){return fn},get Type(){return pn},get BufferUsageBit(){return dn},get BufferFlagBit(){return mn},get MemoryAccessBit(){return vn},get MemoryUsageBit(){return gn},get TextureType(){return yn},get TextureUsageBit(){return xn},get TextureFlagBit(){return Sn},get SampleCount(){return bn},get VsyncMode(){return Cn},get Filter(){return An},get Address(){return Tn},get ComparisonFunc(){return wn},get StencilOp(){return En},get BlendFactor(){return Pn},get BlendOp(){return In},get ColorMask(){return Rn},get ShaderStageFlagBit(){return Dn},get LoadOp(){return Mn},get StoreOp(){return On},get AccessType(){return Bn},get ResolveMode(){return Nn},get PipelineBindPoint(){return Ln},get PrimitiveMode(){return Fn},get PolygonMode(){return zn},get ShadeModel(){return Vn},get CullMode(){return kn},get DynamicStateFlagBit(){return Un},get StencilFace(){return Gn},get DescriptorType(){return Hn},get QueueType(){return jn},get QueryType(){return Wn},get CommandBufferType(){return qn},get ClearFlagBit(){return Xn},Size:Jn,DeviceCaps:Qn,Offset:Zn,Rect:$n,Extent:tr,TextureSubresLayers:er,TextureSubresRange:ir,TextureCopy:nr,TextureBlit:rr,BufferTextureCopy:or,Viewport:ar,Color:sr,BindingMappingInfo:cr,SwapchainInfo:lr,DeviceInfo:ur,BufferInfo:hr,BufferViewInfo:_r,DrawInfo:fr,DispatchInfo:pr,IndirectBuffer:dr,TextureInfo:mr,TextureViewInfo:vr,SamplerInfo:gr,Uniform:yr,UniformBlock:xr,UniformSamplerTexture:Sr,UniformSampler:br,UniformTexture:Cr,UniformStorageImage:Ar,UniformStorageBuffer:Tr,UniformInputAttachment:wr,ShaderStage:Er,Attribute:Pr,ShaderInfo:Ir,InputAssemblerInfo:Rr,ColorAttachment:Dr,DepthStencilAttachment:Mr,SubpassInfo:Or,SubpassDependency:Br,RenderPassInfo:Nr,GlobalBarrierInfo:Lr,TextureBarrierInfo:Fr,FramebufferInfo:zr,DescriptorSetLayoutBinding:Vr,DescriptorSetLayoutInfo:kr,DescriptorSetInfo:Ur,PipelineLayoutInfo:Gr,InputState:Hr,CommandBufferInfo:jr,QueueInfo:Wr,QueryPoolInfo:qr,FormatInfo:Xr,MemoryStatus:Yr,DynamicStencilStates:Kr,DynamicStates:Jr,GFXObject:Qr,get AttributeName(){return Kn},FormatInfos:Zr,DESCRIPTOR_BUFFER_TYPE:$r,DESCRIPTOR_SAMPLER_TYPE:to,DESCRIPTOR_DYNAMIC_TYPE:eo,DRAW_INFO_SIZE:io,IsPowerOf2:no,FormatSize:ro,FormatSurfaceSize:oo,GetTypeSize:so,getTypedArrayConstructor:co,Device:_o,Swapchain:fo,Framebuffer:po,InputAssembler:yo,DescriptorSetLayout:So,PipelineLayout:bo,RasterizerState:Co,DepthStencilState:Ao,BlendTarget:To,BlendState:wo,PipelineStateInfo:Eo,PipelineState:Po,Queue:Io,RenderPass:Ro,Sampler:Do,Shader:Mo,Texture:Oo,GlobalBarrier:Bo,TextureBarrier:No}));var ko=new Ei,Uo=new Ei,Go=new Ei,Ho=new Ei,jo=new Ei,Wo=new Ei,qo=new Array(3),Xo=new Array(3);function Yo(t,e){return Ei.dot(e.n,t)-e.d}function Ko(t,e,i){return Ei.copy(t,e),Ei.subtract(jo,i.center,i.halfExtents),Ei.add(Wo,i.center,i.halfExtents),t.x=t.x<jo.x?jo.x:t.x,t.y=t.y<jo.y?jo.y:t.y,t.z=t.z<jo.z?jo.z:t.z,t.x=t.x>Wo.x?Wo.x:t.x,t.y=t.y>Wo.y?Wo.y:t.y,t.z=t.z>Wo.z?Wo.z:t.z,t}function Jo(t,e,i){Ei.set(ko,i.orientation.m00,i.orientation.m01,i.orientation.m02),Ei.set(Uo,i.orientation.m03,i.orientation.m04,i.orientation.m05),Ei.set(Go,i.orientation.m06,i.orientation.m07,i.orientation.m08),qo[0]=ko,qo[1]=Uo,qo[2]=Go,Xo[0]=i.halfExtents.x,Xo[1]=i.halfExtents.y,Xo[2]=i.halfExtents.z,Ei.subtract(Ho,e,i.center),Ei.set(t,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Ei.dot(Ho,qo[n]);r>Xo[n]&&(r=Xo[n]),r<-Xo[n]&&(r=-Xo[n]),t.x+=r*qo[n].x,t.y+=r*qo[n].y,t.z+=r*qo[n].z}return t}var Qo=Object.freeze({__proto__:null,point_plane:Yo,pt_point_plane:function(t,e,i){var n=Yo(e,i);return Ei.subtract(t,e,Ei.multiplyScalar(t,i.n,n))},pt_point_aabb:Ko,pt_point_obb:Jo,pt_point_line:function(t,e,i,n){Ei.subtract(ko,i,n);var r=ko,o=Ei.lengthSqr(r);if(0==o)Ei.copy(t,i);else{Ei.subtract(ko,e,i);var a=Ei.dot(ko,r)/o;a<0?Ei.copy(t,i):a>1?Ei.copy(t,n):Ei.scaleAndAdd(t,i,r,a)}}}),Zo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},$o=function(){function t(t,e,i,n,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Zo.SHAPE_LINE,this.s=new Ei(t,e,i),this.e=new Ei(n,r,o)}return t.create=function(e,i,n,r,o,a){return new t(e,i,n,r,o,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return Ei.copy(t.s,e.s),Ei.copy(t.e,e.e),t},t.fromPoints=function(t,e,i){return Ei.copy(t.s,e),Ei.copy(t.e,i),t},t.set=function(t,e,i,n,r,o,a){return t.s.x=e,t.s.y=i,t.s.z=n,t.e.x=r,t.e.y=o,t.e.z=a,t},t.len=function(t){return Ei.distance(t.s,t.e)},t.prototype.length=function(){return Ei.distance(this.s,this.e)},Q(t,[{key:"type",get:function(){return this._type}}]),t}(),ta=function(){function t(t,e,i,n,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Zo.SHAPE_RAY,this.o=new Ei(t,e,i),this.d=new Ei(n,r,o)}return t.create=function(e,i,n,r,o,a){return void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new t(e,i,n,r,o,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return Ei.copy(t.o,e.o),Ei.copy(t.d,e.d),t},t.fromPoints=function(t,e,i){return Ei.copy(t.o,e),Ei.normalize(t.d,Ei.subtract(t.d,i,e)),t},t.set=function(t,e,i,n,r,o,a){return t.o.x=e,t.o.y=i,t.o.z=n,t.d.x=r,t.d.y=o,t.d.z=a,t},t.prototype.computeHit=function(t,e){Ei.normalize(t,this.d),Ei.scaleAndAdd(t,this.o,t,e)},Q(t,[{key:"type",get:function(){return this._type}}]),t}(),ea=new Ei,ia=new Ei,na=new Ei,ra=new Ei;function oa(t){return Math.max(Math.max(t.x,t.y),t.z)}var aa,sa=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this._center=new Ei(0,0,0),this._radius=0,this._type=void 0,this._type=Zo.SHAPE_SPHERE,this._center=new Ei(t,e,i),this._radius=n}t.create=function(e,i,n,r){return new t(e,i,n,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return Ei.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,i){return Ei.multiplyScalar(t.center,Ei.add(ea,e,i),.5),t.radius=.5*Ei.subtract(ea,i,e).length(),t},t.set=function(t,e,i,n,r){return t.center.x=e,t.center.y=i,t.center.z=n,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){Ei.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Ei.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,i,n,r){Ei.transformMat4(r.center,this.center,t),r.radius=this.radius*oa(n)},e.translateAndRotate=function(t,e,i){Ei.transformMat4(i.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*oa(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),Ei.subtract(ia,t,this.center);var e=ia.length();if(e>this.radius){var i=.5*(e-this.radius);this.radius+=i,Ei.multiplyScalar(ia,ia,i/e),Ei.add(this.center,this.center,ia)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var i=0;i<e;i++)this.mergePoint(t[i])}},e.mergeAABB=function(t){t.getBoundary(na,ra),this.mergePoint(na),this.mergePoint(ra)},Q(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),ca=function(){function t(t,e,i,n,r,o,a,s,c){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Zo.SHAPE_TRIANGLE,this.a=new Ei(t,e,i),this.b=new Ei(n,r,o),this.c=new Ei(a,s,c)}return t.create=function(e,i,n,r,o,a,s,c,l){return void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new t(e,i,n,r,o,a,s,c,l)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return Ei.copy(t.a,e.a),Ei.copy(t.b,e.b),Ei.copy(t.c,e.c),t},t.fromPoints=function(t,e,i,n){return Ei.copy(t.a,e),Ei.copy(t.b,i),Ei.copy(t.c,n),t},t.set=function(t,e,i,n,r,o,a,s,c,l){return t.a.x=e,t.a.y=i,t.a.z=n,t.b.x=r,t.b.y=o,t.b.z=a,t.c.x=s,t.c.y=c,t.c.z=l,t},Q(t,[{key:"type",get:function(){return this._type}}]),t}();!function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(aa||(aa={}));var la,ua,ha,_a,fa,pa,da,ma,va=(la=new Ei(0,0,0),function(t,e){var i=Ei.dot(t.d,e.n);if(Math.abs(i)<Number.EPSILON)return 0;Ei.multiplyScalar(la,e.n,e.d);var n=Ei.dot(Ei.subtract(la,la,t.o),e.n)/i;return n<0?0:n}),ga=(ua=new Ei(0,0,0),ha=new Ei(0,0,0),_a=new Ei(0,0,0),fa=new Ei(0,0,0),pa=new Ei(0,0,0),function(t,e,i){Ei.subtract(ua,e.b,e.a),Ei.subtract(ha,e.c,e.a),Ei.cross(_a,t.d,ha);var n=Ei.dot(ua,_a);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Ei.subtract(fa,t.o,e.a);var o=Ei.dot(fa,_a)*r;if(o<0||o>1)return 0;Ei.cross(pa,fa,ua);var a=Ei.dot(t.d,pa)*r;if(a<0||o+a>1)return 0;var s=Ei.dot(ha,pa)*r;return s<0?0:s}),ya=function(){var t=new Ei(0,0,0);return function(e,i){var n=i.radius,r=i.center,o=e.o,a=e.d,s=n*n;Ei.subtract(t,r,o);var c=t.lengthSqr(),l=Ei.dot(t,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),xa=(da=new Ei,ma=new Ei,function(t,e){return Ei.subtract(da,e.center,e.halfExtents),Ei.add(ma,e.center,e.halfExtents),Sa(t,da,ma)});function Sa(t,e,i){var n=t.o,r=t.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(e.x-n.x)*o,l=(i.x-n.x)*o,u=(e.y-n.y)*a,h=(i.y-n.y)*a,_=(e.z-n.z)*s,f=(i.z-n.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return d<0||p>d?0:p>0?p:d}var ba,Ca,Aa,Ta,wa=function(){var t=new Ei,e=new Ei,i=new Ei,n=new Ei,r=new Ei,o=new Ei,a=new Ei,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,t=_.center,e=h.o,i=h.d,Ei.set(n,_.orientation.m00,_.orientation.m01,_.orientation.m02),Ei.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),Ei.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),Ei.subtract(a,t,e),c[0]=Ei.dot(n,i),c[1]=Ei.dot(r,i),c[2]=Ei.dot(o,i),l[0]=Ei.dot(n,a),l[1]=Ei.dot(r,a),l[2]=Ei.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),Ea=function(){var t=new Ei,e=new Ei,i=new Ei,n=new Ei,r=new Ei,o=new Ei,a=new Ei,s=new sa;return function(c,l){var u=l.radius*l.radius,h=Ei.normalize(t,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,p=Ei.subtract(e,f,_);if(p.equals(Ei.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),hs.raySphere(c,s);var d=c.o,m=Ei.subtract(i,d,_),v=Ei.cross(n,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Ei.subtract(r,f,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),hs.raySphere(c,s)}var x=Ei.cross(r,m,p),S=p.lengthSqr(),b=2*Ei.dot(v,x),C=b*b-4*g*(x.lengthSqr()-u*S);if(C<0)return 0;var A=(-b-Math.sqrt(C))/(2*g);if(A<0){s.radius=l.radius;var T=Ei.subtract(o,f,d);return m.lengthSqr()<T.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),hs.raySphere(c,s)}var w=Ei.scaleAndAdd(o,c.o,h,A),E=Ei.subtract(a,w,_),P=Ei.dot(E,p)/S;return P>=0&&P<=1?A:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),hs.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),hs.raySphere(c,s)):0}}(),Pa=(ba=ca.create(),Ca={distance:1/0,doubleSided:!1,mode:aa.ANY},Aa=0,Ta=function(t,e,i,n,r,o){t===aa.CLOSEST?(Aa>e||0===Aa)&&(Aa=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=i/3,o[0].vertexIndex1=n/3,o[0].vertexIndex2=r/3))):(Aa=e,o&&o.push({distance:e,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}))},function(t,e,i){if(Aa=0,0===e.geometricInfo.positions.length)return Aa;var n=void 0===i?Ca:i;if(Sa(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,o=e.geometricInfo;!function(t,e,i,n,r){if(i===Fn.TRIANGLE_LIST)for(var o=e.length,a=0;a<o;a+=3){var s=3*e[a],c=3*e[a+1],l=3*e[a+2];Ei.set(ba.a,t[s],t[s+1],t[s+2]),Ei.set(ba.b,t[c],t[c+1],t[c+2]),Ei.set(ba.c,t[l],t[l+1],t[l+2]);var u=hs.rayTriangle(n,ba,r.doubleSided);if(!(0===u||u>r.distance)&&(Ta(r.mode,u,s,c,l,r.result),r.mode===aa.ANY))return u}else if(i===Fn.TRIANGLE_STRIP)for(var h=e.length-2,_=0,f=0;f<h;f+=1){var p=3*e[f-_],d=3*e[f+_+1],m=3*e[f+2];Ei.set(ba.a,t[p],t[p+1],t[p+2]),Ei.set(ba.b,t[d],t[d+1],t[d+2]),Ei.set(ba.c,t[m],t[m+1],t[m+2]),_=~_;var v=hs.rayTriangle(n,ba,r.doubleSided);if(!(0===v||v>r.distance)&&(Ta(r.mode,v,p,d,m,r.result),r.mode===aa.ANY))return v}else if(i===Fn.TRIANGLE_FAN){var g=e.length-1,y=3*e[0];Ei.set(ba.a,t[y],t[y+1],t[y+2]);for(var x=1;x<g;x+=1){var S=3*e[x],b=3*e[x+1];Ei.set(ba.b,t[S],t[S+1],t[S+2]),Ei.set(ba.c,t[b],t[b+1],t[b+2]);var C=hs.rayTriangle(n,ba,r.doubleSided);if(!(0===C||C>r.distance)&&(Ta(r.mode,C,y,S,b,r.result),r.mode===aa.ANY))return C}}}(o.positions,o.indices,r,t,n)}return Aa}),Ia=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:aa.ANY};return function(i,n,r){t=0;var o=void 0===r?e:r,a=n.renderingSubMeshes.length,s=n.struct.minPosition,c=n.struct.maxPosition;if(s&&c&&!Sa(i,s,c))return t;for(var l=0;l<a;l++){var u=n.renderingSubMeshes[l],h=Pa(i,u,o);if(h)if(o.mode===aa.CLOSEST)(0===t||t>h)&&(t=h,o.subIndices&&(o.subIndices[0]=l));else if(t=h,o.subIndices&&o.subIndices.push(l),o.mode===aa.ANY)return h}return t&&o.mode===aa.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),Ra=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:aa.ANY},i=new ta,n=new Gi;return function(r,o,a){t=0;var s=void 0===a?e:a,c=o.worldBounds;if(c&&!xa(r,c))return t;ta.copy(i,r),o.node&&(Gi.invert(n,o.node.getWorldMatrix(n)),Ei.transformMat4(i.o,r.o,n),Ei.transformMat4Normal(i.d,r.d,n));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Pa(i,h,s);if(_)if(s.mode===aa.CLOSEST)(0===t||t>_)&&(t=_,s.subIndices&&(s.subIndices[0]=u));else if(t=_,s.subIndices&&s.subIndices.push(u),s.mode===aa.ANY)return _}return t&&s.mode===aa.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),Da=function(){var t=new Ei(0,0,0);return function(e,i){Ei.subtract(t,e.e,e.s);var n=(i.d-Ei.dot(e.s,i.n))/Ei.dot(t,i.n);return n<0||n>1?0:n}}(),Ma=function(){var t=new Ei(0,0,0),e=new Ei(0,0,0),i=new Ei(0,0,0),n=new Ei(0,0,0),r=new Ei(0,0,0),o=new Ei(0,0,0);return function(a,s,c){Ei.subtract(t,s.b,s.a),Ei.subtract(e,s.c,s.a),Ei.subtract(i,a.s,a.e),Ei.cross(r,t,e);var l=Ei.dot(i,r);if(l<=0)return 0;Ei.subtract(n,a.s,s.a);var u=Ei.dot(n,r);if(u<0||u>l)return 0;Ei.cross(o,i,n);var h=Ei.dot(e,o);if(h<0||h>l)return 0;var _=-Ei.dot(t,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,p=1-(h*=f)-(_*=f);Ei.set(c,s.a.x*p+s.b.x*h+s.c.x*_,s.a.y*p+s.b.y*h+s.c.y*_,s.a.z*p+s.b.z*h+s.c.z*_)}return 1}}(),Oa=new ta;function Ba(t,e){Oa.o.set(t.s),Ei.subtract(Oa.d,t.e,t.s),Oa.d.normalize();var i=xa(Oa,e);return i<=t.length()?i:0}function Na(t,e){Oa.o.set(t.s),Ei.subtract(Oa.d,t.e,t.s),Oa.d.normalize();var i=wa(Oa,e);return i<=t.length()?i:0}function La(t,e){Oa.o.set(t.s),Ei.subtract(Oa.d,t.e,t.s),Oa.d.normalize();var i=ya(Oa,e);return i<=t.length()?i:0}var Fa,za,Va,ka,Ua=(Fa=new Ei,za=new Ei,Va=new Ei,ka=new Ei,function(t,e){return Ei.subtract(Fa,t.center,t.halfExtents),Ei.add(za,t.center,t.halfExtents),Ei.subtract(Va,e.center,e.halfExtents),Ei.add(ka,e.center,e.halfExtents),Fa.x<=ka.x&&za.x>=Va.x&&Fa.y<=ka.y&&za.y>=Va.y&&Fa.z<=ka.z&&za.z>=Va.z});function Ga(t,e,i,n,r,o){Ei.set(o[0],t.x+i.x*e.x+n.x*e.y+r.x*e.z,t.y+i.y*e.x+n.y*e.y+r.y*e.z,t.z+i.z*e.x+n.z*e.y+r.z*e.z),Ei.set(o[1],t.x-i.x*e.x+n.x*e.y+r.x*e.z,t.y-i.y*e.x+n.y*e.y+r.y*e.z,t.z-i.z*e.x+n.z*e.y+r.z*e.z),Ei.set(o[2],t.x+i.x*e.x-n.x*e.y+r.x*e.z,t.y+i.y*e.x-n.y*e.y+r.y*e.z,t.z+i.z*e.x-n.z*e.y+r.z*e.z),Ei.set(o[3],t.x+i.x*e.x+n.x*e.y-r.x*e.z,t.y+i.y*e.x+n.y*e.y-r.y*e.z,t.z+i.z*e.x+n.z*e.y-r.z*e.z),Ei.set(o[4],t.x-i.x*e.x-n.x*e.y-r.x*e.z,t.y-i.y*e.x-n.y*e.y-r.y*e.z,t.z-i.z*e.x-n.z*e.y-r.z*e.z),Ei.set(o[5],t.x+i.x*e.x-n.x*e.y-r.x*e.z,t.y+i.y*e.x-n.y*e.y-r.y*e.z,t.z+i.z*e.x-n.z*e.y-r.z*e.z),Ei.set(o[6],t.x-i.x*e.x+n.x*e.y-r.x*e.z,t.y-i.y*e.x+n.y*e.y-r.y*e.z,t.z-i.z*e.x+n.z*e.y-r.z*e.z),Ei.set(o[7],t.x-i.x*e.x-n.x*e.y+r.x*e.z,t.y-i.y*e.x-n.y*e.y+r.y*e.z,t.z-i.z*e.x-n.z*e.y+r.z*e.z)}function Ha(t,e){for(var i=Ei.dot(e,t[0]),n=i,r=1;r<8;++r){var o=Ei.dot(e,t[r]);i=o<i?o:i,n=o>n?o:n}return[i,n]}var ja,Wa,qa,Xa=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new Ei(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new Ei(0,0,0),n[r]=new Ei(0,0,0);var o=new Ei,a=new Ei;return function(e,r){Ei.set(t[0],1,0,0),Ei.set(t[1],0,1,0),Ei.set(t[2],0,0,1),Ei.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Ei.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Ei.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Ei.cross(t[6+3*s],t[s],t[3]),Ei.cross(t[7+3*s],t[s],t[4]),Ei.cross(t[7+3*s],t[s],t[5]);Ei.subtract(o,e.center,e.halfExtents),Ei.add(a,e.center,e.halfExtents),function(t,e,i){Ei.set(i[0],t.x,e.y,e.z),Ei.set(i[1],t.x,e.y,t.z),Ei.set(i[2],t.x,t.y,e.z),Ei.set(i[3],t.x,t.y,t.z),Ei.set(i[4],e.x,e.y,e.z),Ei.set(i[5],e.x,e.y,t.z),Ei.set(i[6],e.x,t.y,e.z),Ei.set(i[7],e.x,t.y,t.z)}(o,a,i),Ga(r.center,r.halfExtents,t[3],t[4],t[5],n);for(var c=0;c<15;++c){var l=Ha(i,t[c]),u=Ha(n,t[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Ya=function(t,e){var i=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),n=Ei.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1},Ka=function(t,e){for(var i=0;i<e.planes.length;i++)if(-1===Ya(t,e.planes[i]))return 0;return 1},Ja=function(){for(var t=new Array(8),e=0,i=0,n=0;n<t.length;n++)t[n]=new Ei(0,0,0);return function(n,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Ya(n,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)Ei.subtract(t[c],r.vertices[c],n.center);e=0,i=0;for(var l=0;l<r.vertices.length;l++)t[l].x>n.halfExtents.x?e++:t[l].x<-n.halfExtents.x&&i++;if(e===r.vertices.length||i===r.vertices.length)return 0;e=0,i=0;for(var u=0;u<r.vertices.length;u++)t[u].y>n.halfExtents.y?e++:t[u].y<-n.halfExtents.y&&i++;if(e===r.vertices.length||i===r.vertices.length)return 0;e=0,i=0;for(var h=0;h<r.vertices.length;h++)t[h].z>n.halfExtents.z?e++:t[h].z<-n.halfExtents.z&&i++;return e===r.vertices.length||i===r.vertices.length?0:1}}(),Qa=(ja=new Ei(0,0,0),Wa=new Di,function(t,e){return Ei.subtract(ja,e,t.center),Ei.transformMat3(ja,ja,Di.transpose(Wa,t.orientation)),i=ja,n=t.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),Za=(qa=function(t,e,i,n){return Math.abs(t.x*e+t.y*i+t.z*n)},function(t,e){var i=t.halfExtents.x*qa(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*qa(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*qa(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),n=Ei.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1}),$a=function(t,e){for(var i=0;i<e.planes.length;i++)if(-1===Za(t,e.planes[i]))return 0;return 1},ts=function(){for(var t=new Array(8),e=0,i=0,n=0,r=0;r<t.length;r++)t[r]=new Ei(0,0,0);var o=function(t,e,i,n){return t.x*e+t.y*i+t.z*n};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Za(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)Ei.subtract(t[u],a.vertices[u],r.center);i=0,n=0;for(var h=0;h<a.vertices.length;h++)(e=o(t[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?i++:e<-r.halfExtents.x&&n++;if(i===a.vertices.length||n===a.vertices.length)return 0;i=0,n=0;for(var _=0;_<a.vertices.length;_++)(e=o(t[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?i++:e<-r.halfExtents.y&&n++;if(i===a.vertices.length||n===a.vertices.length)return 0;i=0,n=0;for(var f=0;f<a.vertices.length;f++)(e=o(t[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?i++:e<-r.halfExtents.z&&n++;return i===a.vertices.length||n===a.vertices.length?0:1}}(),es=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new Ei(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new Ei(0,0,0),n[r]=new Ei(0,0,0);return function(e,r){Ei.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Ei.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Ei.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Ei.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Ei.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Ei.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)Ei.cross(t[6+3*o],t[o],t[3]),Ei.cross(t[7+3*o],t[o],t[4]),Ei.cross(t[8+3*o],t[o],t[5]);Ga(e.center,e.halfExtents,t[0],t[1],t[2],i),Ga(r.center,r.halfExtents,t[3],t[4],t[5],n);for(var a=0;a<15;++a){var s=Ha(i,t[a]),c=Ha(n,t[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),is=function(){for(var t=new sa,e=new Ei,i=new Ei,n=new Ei,r=new Array(8),o=0;o<8;o++)r[o]=new Ei;for(var a=new Array(8),s=0;s<8;s++)a[s]=new Ei;return function(o,s){if(0===Ei.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return t.radius=s.radius,t.center.set(s.ellipseCenter0),hs.sphereOBB(t,o);e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,i.x=o.orientation.m03,i.y=o.orientation.m04,i.z=o.orientation.m05,n.x=o.orientation.m06,n.y=o.orientation.m07,n.z=o.orientation.m08,Ga(o.center,o.halfExtents,e,i,n,r);var c=a,l=Ei.copy(c[0],e),u=Ei.copy(c[1],i),h=Ei.copy(c[2],n);Ei.subtract(c[3],s.center,o.center).normalize();var _=Ei.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),Ei.cross(c[5],l,_),Ei.cross(c[6],u,_),Ei.cross(c[7],h,_);for(var f=0;f<8;++f){var p=Ha(r,c[f]),d=Ei.dot(c[f],s.ellipseCenter0),m=Ei.dot(c[f],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),ns=function(t,e){var i=Ei.dot(e.n,t.center),n=t.radius*e.n.length();return i+n<e.d?-1:i-n>e.d?0:1},rs=function(t,e){for(var i=0;i<e.planes.length;i++)if(-1===ns(t,e.planes[i]))return 0;return 1},os=function(){var t=new Ei(0,0,0),e=[1,-1,1,-1,1,-1];return function(i,n){for(var r=0;r<6;r++){var o=n.planes[r],a=i.radius,s=i.center,c=o.n,l=o.d,u=Ei.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){Ei.add(t,s,Ei.multiplyScalar(t,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+e[r]){var _=n.planes[h];if(Ei.dot(_.n,t)<_.d)return 0}}}return 1}}(),as=function(t,e){var i=t.radius+e.radius;return Ei.squaredDistance(t.center,e.center)<i*i},ss=function(){var t=new Ei;return function(e,i){return Ko(t,e.center,i),Ei.squaredDistance(e.center,t)<e.radius*e.radius}}(),cs=function(){var t=new Ei;return function(e,i){return Jo(t,e.center,i),Ei.squaredDistance(e.center,t)<e.radius*e.radius}}(),ls=function(){var t=new Ei,e=new Ei;return function(i,n){var r=i.radius+n.radius,o=r*r,a=Ei.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===a)return Ei.squaredDistance(i.center,n.center)<o;Ei.subtract(t,i.center,n.ellipseCenter0),Ei.subtract(e,n.ellipseCenter1,n.ellipseCenter0);var s=Ei.dot(t,e)/a;return s<0?Ei.squaredDistance(i.center,n.ellipseCenter0)<o:s>1?Ei.squaredDistance(i.center,n.ellipseCenter1)<o:(Ei.scaleAndAdd(t,n.ellipseCenter0,e,s),Ei.squaredDistance(i.center,t)<o)}}(),us=function(){var t=new Ei,e=new Ei,i=new Ei,n=new Ei,r=new Ei,o=new Ei;return function(a,s){var c,l,u=Ei.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=Ei.subtract(e,s.ellipseCenter1,s.ellipseCenter0),_=Ei.subtract(i,a.ellipseCenter0,s.ellipseCenter0),f=Ei.dot(u,u),p=Ei.dot(u,h),d=Ei.dot(h,h),m=Ei.dot(u,_),v=Ei.dot(h,_),g=f*d-p*p,y=g,x=g;g<ni?(c=0,y=1,l=v,x=d):(l=f*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,x=d):c>y&&(c=y,l=v+p,x=d)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+p<0?c=0:-m+p>f?c=y:(c=-m+p,y=f));var S=Math.abs(c)<ni?0:c/y,b=Math.abs(l)<ni?0:l/x,C=n;C.set(_),C.add(Ei.multiplyScalar(r,u,S)),C.subtract(Ei.multiplyScalar(o,h,b));var A=a.radius+s.radius;return C.lengthSqr()<A*A}}(),hs={raySphere:ya,rayAABB:xa,rayOBB:wa,rayPlane:va,rayTriangle:ga,rayCapsule:Ea,raySubMesh:Pa,rayMesh:Ia,rayModel:Ra,lineSphere:La,lineAABB:Ba,lineOBB:Na,linePlane:Da,lineTriangle:Ma,sphereWithSphere:as,sphereAABB:ss,sphereOBB:cs,spherePlane:ns,sphereFrustum:rs,sphereFrustumAccurate:os,sphereCapsule:ls,aabbWithAABB:Ua,aabbWithOBB:Xa,aabbPlane:Ya,aabbFrustum:Ka,aabbFrustumAccurate:Ja,obbWithOBB:es,obbPlane:Za,obbFrustum:$a,obbFrustumAccurate:ts,obbPoint:Qa,obbCapsule:is,capsuleWithCapsule:us,resolve:function(t,e,i){void 0===i&&(i=null);var n=t._type,r=e._type,o=this[n|r];return n<r?o(t,e,i):o(e,t,i)}};hs[Zo.SHAPE_RAY|Zo.SHAPE_SPHERE]=ya,hs[Zo.SHAPE_RAY|Zo.SHAPE_AABB]=xa,hs[Zo.SHAPE_RAY|Zo.SHAPE_OBB]=wa,hs[Zo.SHAPE_RAY|Zo.SHAPE_PLANE]=va,hs[Zo.SHAPE_RAY|Zo.SHAPE_TRIANGLE]=ga,hs[Zo.SHAPE_RAY|Zo.SHAPE_CAPSULE]=Ea,hs[Zo.SHAPE_LINE|Zo.SHAPE_SPHERE]=La,hs[Zo.SHAPE_LINE|Zo.SHAPE_AABB]=Ba,hs[Zo.SHAPE_LINE|Zo.SHAPE_OBB]=Na,hs[Zo.SHAPE_LINE|Zo.SHAPE_PLANE]=Da,hs[Zo.SHAPE_LINE|Zo.SHAPE_TRIANGLE]=Ma,hs[Zo.SHAPE_SPHERE]=as,hs[Zo.SHAPE_SPHERE|Zo.SHAPE_AABB]=ss,hs[Zo.SHAPE_SPHERE|Zo.SHAPE_OBB]=cs,hs[Zo.SHAPE_SPHERE|Zo.SHAPE_PLANE]=ns,hs[Zo.SHAPE_SPHERE|Zo.SHAPE_FRUSTUM]=rs,hs[Zo.SHAPE_SPHERE|Zo.SHAPE_FRUSTUM_ACCURATE]=os,hs[Zo.SHAPE_SPHERE|Zo.SHAPE_CAPSULE]=ls,hs[Zo.SHAPE_AABB]=Ua,hs[Zo.SHAPE_AABB|Zo.SHAPE_OBB]=Xa,hs[Zo.SHAPE_AABB|Zo.SHAPE_PLANE]=Ya,hs[Zo.SHAPE_AABB|Zo.SHAPE_FRUSTUM]=Ka,hs[Zo.SHAPE_AABB|Zo.SHAPE_FRUSTUM_ACCURATE]=Ja,hs[Zo.SHAPE_OBB]=es,hs[Zo.SHAPE_OBB|Zo.SHAPE_PLANE]=Za,hs[Zo.SHAPE_OBB|Zo.SHAPE_FRUSTUM]=$a,hs[Zo.SHAPE_OBB|Zo.SHAPE_FRUSTUM_ACCURATE]=ts,hs[Zo.SHAPE_OBB|Zo.SHAPE_CAPSULE]=is,hs[Zo.SHAPE_CAPSULE]=us,k($o.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),U(hs,"intersect",[{name:"line_quad"}]);var _s,fs,ps,ds,ms,vs,gs,ys=new Ei(0,0,0),xs=new Ei(0,0,0),Ss=u.mat4(),bs=u.v4(),Cs=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Zo.SHAPE_PLANE,this.n=new Ei(t,e,i),this.d=n}return t.create=function(e,i,n,r){return new t(e,i,n,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return Ei.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,i,n){return Ei.subtract(ys,i,e),Ei.subtract(xs,n,e),Ei.normalize(t.n,Ei.cross(t.n,ys,xs)),t.d=Ei.dot(t.n,e),t},t.set=function(t,e,i,n,r){return t.n.x=e,t.n.y=i,t.n.z=n,t.d=r,t},t.fromNormalAndPoint=function(t,e,i){return Ei.copy(t.n,e),t.d=Ei.dot(e,i),t},t.normalize=function(t,e){var i=e.n.length();return Ei.normalize(t.n,e.n),i>0&&(t.d=e.d/i),t},t.prototype.transform=function(t){Gi.invert(Ss,t),Gi.transpose(Ss,Ss),Ji.set(bs,this.n.x,this.n.y,this.n.z,this.d),Ji.transformMat4(bs,bs,Ss),Ei.set(this.n,bs.x,bs.y,bs.z),this.d=bs.w},Q(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),As=function(){function t(t,e,i){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(gs||(gs={}));var Ts,ws,Es=function(){function t(t,e,i,n,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new As(t,r,this._stride);var o=gs.NEVER,a=!1,s=!1;for(var c in e){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=e[c],a||o!==gs.FLOAT32?s||o!==gs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var i=e[e.length-1];return e.length--,(t<<this._entryBits)+i+this._poolFlag}}for(var n=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(n,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(n,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(n),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][i]},e.getTypedArray=function(t,e){var i=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t,r=e,o=(this._dataType[e]===gs.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n],a=this._dataMembers[e];return o.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][i].fill(0),this._freeLists[e].push(i)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(Ts||(Ts={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(ws||(ws={}));var Ps,Is=((_s={})[ws.DIRTY_FLAG]=gs.UINT32,_s[ws.LAYER]=gs.UINT32,_s[ws.WORLD_SCALE]=gs.FLOAT32,_s[ws.WORLD_POSITION]=gs.FLOAT32,_s[ws.WORLD_ROTATION]=gs.FLOAT32,_s[ws.WORLD_MATRIX]=gs.FLOAT32,_s[ws.LOCAL_SCALE]=gs.FLOAT32,_s[ws.LOCAL_POSITION]=gs.FLOAT32,_s[ws.LOCAL_ROTATION]=gs.FLOAT32,_s[ws.COUNT]=gs.NEVER,_s),Rs=((fs={})[ws.DIRTY_FLAG]=ws.LAYER-ws.DIRTY_FLAG,fs[ws.LAYER]=ws.WORLD_SCALE-ws.LAYER,fs[ws.WORLD_SCALE]=ws.WORLD_POSITION-ws.WORLD_SCALE,fs[ws.WORLD_POSITION]=ws.WORLD_ROTATION-ws.WORLD_POSITION,fs[ws.WORLD_ROTATION]=ws.WORLD_MATRIX-ws.WORLD_ROTATION,fs[ws.WORLD_MATRIX]=ws.LOCAL_SCALE-ws.WORLD_MATRIX,fs[ws.LOCAL_SCALE]=ws.LOCAL_POSITION-ws.LOCAL_SCALE,fs[ws.LOCAL_POSITION]=ws.LOCAL_ROTATION-ws.LOCAL_POSITION,fs[ws.LOCAL_ROTATION]=ws.COUNT-ws.LOCAL_ROTATION,fs[ws.COUNT]=1,fs),Ds=new Es(Ts.NODE,Is,Rs,ws);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(Ps||(Ps={}));var Ms,Os=((ps={})[Ps.PRIORITY]=gs.UINT32,ps[Ps.STAGE]=gs.UINT32,ps[Ps.PHASE]=gs.UINT32,ps[Ps.PRIMITIVE]=gs.UINT32,ps[Ps.BATCHING_SCHEME]=gs.UINT32,ps[Ps.DYNAMIC_STATE]=gs.UINT32,ps[Ps.HASH]=gs.UINT32,ps[Ps.COUNT]=gs.NEVER,ps),Bs=((ds={})[Ps.PRIORITY]=Ps.STAGE-Ps.PRIORITY,ds[Ps.STAGE]=Ps.PHASE-Ps.STAGE,ds[Ps.PHASE]=Ps.PRIMITIVE-Ps.PHASE,ds[Ps.PRIMITIVE]=Ps.BATCHING_SCHEME-Ps.PRIMITIVE,ds[Ps.BATCHING_SCHEME]=Ps.DYNAMIC_STATE-Ps.BATCHING_SCHEME,ds[Ps.DYNAMIC_STATE]=Ps.HASH-Ps.DYNAMIC_STATE,ds[Ps.HASH]=Ps.COUNT-Ps.HASH,ds[Ps.COUNT]=1,ds),Ns=new Es(Ts.PASS,Os,Bs,Ps);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(Ms||(Ms={}));var Ls=((ms={})[Ms.CENTER]=gs.FLOAT32,ms[Ms.HALFEXTENTS]=gs.FLOAT32,ms[Ms.COUNT]=gs.NEVER,ms),Fs=((vs={})[Ms.CENTER]=Ms.HALFEXTENTS-Ms.CENTER,vs[Ms.HALFEXTENTS]=Ms.COUNT-Ms.HALFEXTENTS,vs[Ms.COUNT]=1,vs),zs=new Es(Ts.AABB,Ls,Fs,Ms),Vs=new Ei,ks=new Ei,Us=new Ei,Gs=new Ei,Hs=new Di,js=function(t,e,i){Hs.m00=Math.abs(i.m00),Hs.m01=Math.abs(i.m01),Hs.m02=Math.abs(i.m02),Hs.m03=Math.abs(i.m04),Hs.m04=Math.abs(i.m05),Hs.m05=Math.abs(i.m06),Hs.m06=Math.abs(i.m08),Hs.m07=Math.abs(i.m09),Hs.m08=Math.abs(i.m10),Ei.transformMat3(t,e,Hs)},Ws=function(){function t(t,e,i,n,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=Zo.SHAPE_AABB,this.center=new Ei(t,e,i),this.halfExtents=new Ei(n,r,o)}t.create=function(e,i,n,r,o,a){return new t(e,i,n,r,o,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return Ei.copy(t.center,e.center),Ei.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,i){return Ei.add(Vs,i,e),Ei.subtract(ks,i,e),Ei.multiplyScalar(t.center,Vs,.5),Ei.multiplyScalar(t.halfExtents,ks,.5),t},t.set=function(t,e,i,n,r,o,a){return t.center.set(e,i,n),t.halfExtents.set(r,o,a),t},t.merge=function(e,i,n){return Ei.subtract(Vs,i.center,i.halfExtents),Ei.subtract(ks,n.center,n.halfExtents),Ei.add(Us,i.center,i.halfExtents),Ei.add(Gs,n.center,n.halfExtents),Ei.max(Gs,Us,Gs),Ei.min(Us,Vs,ks),t.fromPoints(e,Us,Gs)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,i){return Ei.transformMat4(t.center,e.center,i),js(t.halfExtents,e.halfExtents,i),t};var e=t.prototype;return e.getBoundary=function(t,e){Ei.subtract(t,this.center,this.halfExtents),Ei.add(e,this.center,this.halfExtents)},e.transform=function(t,e,i,n,r){Ei.transformMat4(r.center,this.center,t),js(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary(Vs,ks),t.x<Vs.x&&(Vs.x=t.x),t.y<Vs.y&&(Vs.y=t.y),t.z<Vs.z&&(Vs.z=t.z),t.x>ks.x&&(ks.x=t.x),t.y>ks.y&&(ks.y=t.y),t.z>ks.z&&(ks.z=t.z),Ei.add(Us,Vs,ks),this.center.set(Ei.multiplyScalar(Us,Us,.5)),this.halfExtents.set(ks.x-Us.x,ks.y-Us.y,ks.z-Us.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},Q(t,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),t}(),qs=new Ei,Xs=new Ei,Ys=new Di,Ks=function(){function t(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Zo.SHAPE_OBB,this.center=new Ei(t,e,i),this.halfExtents=new Ei(n,r,o),this.orientation=new Di(a,s,c,l,u,h,_,f,p)}t.create=function(e,i,n,r,o,a,s,c,l,u,h,_,f,p,d){return new t(e,i,n,r,o,a,s,c,l,u,h,_,f,p,d)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return Ei.copy(t.center,e.center),Ei.copy(t.halfExtents,e.halfExtents),Di.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,i){return Ei.multiplyScalar(t.center,Ei.add(qs,e,i),.5),Ei.multiplyScalar(t.halfExtents,Ei.subtract(Xs,i,e),.5),Di.identity(t.orientation),t},t.set=function(t,e,i,n,r,o,a,s,c,l,u,h,_,f,p,d){return Ei.set(t.center,e,i,n),Ei.set(t.halfExtents,r,o,a),Di.set(t.orientation,s,c,l,u,h,_,f,p,d),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,i){Ys.m00=Math.abs(i.m00),Ys.m01=Math.abs(i.m01),Ys.m02=Math.abs(i.m02),Ys.m03=Math.abs(i.m03),Ys.m04=Math.abs(i.m04),Ys.m05=Math.abs(i.m05),Ys.m06=Math.abs(i.m06),Ys.m07=Math.abs(i.m07),Ys.m08=Math.abs(i.m08),Ei.transformMat3(t,e,Ys)}(qs,this.halfExtents,this.orientation),Ei.subtract(t,this.center,qs),Ei.add(e,this.center,qs)},e.transform=function(t,e,i,n,r){Ei.transformMat4(r.center,this.center,t),Di.fromQuat(r.orientation,i),Ei.multiply(r.halfExtents,this.halfExtents,n)},e.translateAndRotate=function(t,e,i){Ei.transformMat4(i.center,this.center,t),Di.fromQuat(i.orientation,e)},e.setScale=function(t,e){Ei.multiply(e.halfExtents,this.halfExtents,t)},Q(t,[{key:"type",get:function(){return this._type}}]),t}(),Js=function(){function t(t,e,i){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Zo.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=i,this.center=new Ei,this.rotation=new Bi,this.ellipseCenter0=new Ei(0,e,0),this.ellipseCenter1=new Ei(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,i,n,r){var o=n,a=Si(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Ei.transformMat4(r.center,this.center,t),Bi.multiply(r.rotation,this.rotation,i),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),Ei.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Ei.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},Q(t,[{key:"type",get:function(){return this._type}}]),t}(),Qs=new Array(8);Qs[0]=new Ei(1,1,1),Qs[1]=new Ei(-1,1,1),Qs[2]=new Ei(-1,-1,1),Qs[3]=new Ei(1,-1,1),Qs[4]=new Ei(1,1,-1),Qs[5]=new Ei(-1,1,-1),Qs[6]=new Ei(-1,-1,-1),Qs[7]=new Ei(1,-1,-1);var Zs,$s,tc=new Ei,ec=new Ei,ic=new Ei,nc=function(){function t(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Zo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=Cs.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new Ei}t.createFromAABB=function(t,e){var i=new Ei,n=new Ei;return Ei.subtract(i,e.center,e.halfExtents),Ei.add(n,e.center,e.halfExtents),t.vertices[0].set(i.x,n.y,i.z),t.vertices[1].set(n.x,n.y,i.z),t.vertices[2].set(n.x,i.y,i.z),t.vertices[3].set(i.x,i.y,i.z),t.vertices[4].set(i.x,n.y,n.z),t.vertices[5].set(n.x,n.y,n.z),t.vertices[6].set(n.x,i.y,n.z),t.vertices[7].set(i.x,i.y,n.z),t._type!==Zo.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,i,n,r){var o=Math.tan(.5*e.fov),a=o*e.aspect;tc.set(n*a,n*o,n),ec.set(r*a,r*o,r);var s=t.vertices;return ic.set(tc.x,tc.y,tc.z),Ei.transformMat4(s[0],ic,i),ic.set(-tc.x,tc.y,tc.z),Ei.transformMat4(s[1],ic,i),ic.set(-tc.x,-tc.y,tc.z),Ei.transformMat4(s[2],ic,i),ic.set(tc.x,-tc.y,tc.z),Ei.transformMat4(s[3],ic,i),ic.set(ec.x,ec.y,ec.z),Ei.transformMat4(s[4],ic,i),ic.set(-ec.x,ec.y,ec.z),Ei.transformMat4(s[5],ic,i),ic.set(-ec.x,-ec.y,ec.z),Ei.transformMat4(s[6],ic,i),ic.set(ec.x,-ec.y,ec.z),Ei.transformMat4(s[7],ic,i),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e._type;for(var i=0;i<6;++i)Cs.copy(t.planes[i],e.planes[i]);for(var n=0;n<8;++n)Ei.copy(t.vertices[n],e.vertices[n]);return t};var e=t.prototype;return e.update=function(t,e){if(Ei.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),Ei.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),Ei.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),Ei.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),Ei.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),Ei.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Zo.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();Ei.multiplyScalar(n.n,n.n,r),n.d*=r}for(var o=0;o<8;o++)Ei.transformMat4(this.vertices[o],Qs[o],e)}},e.transform=function(t){if(this._type===Zo.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)Ei.transformMat4(this.vertices[e],this.vertices[e],t);Cs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Cs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Cs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Cs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Cs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Cs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},e.updatePlanes=function(){Cs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Cs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Cs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Cs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Cs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Cs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},Q(t,[{key:"accurate",set:function(t){this._type=t?Zo.SHAPE_FRUSTUM_ACCURATE:Zo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();nc.createOrtho=function(t,e,i,n,r,o){var a=e/2,s=i/2;Ei.set(ic,a,s,-n),Ei.transformMat4(t.vertices[0],ic,o),Ei.set(ic,-a,s,-n),Ei.transformMat4(t.vertices[1],ic,o),Ei.set(ic,-a,-s,-n),Ei.transformMat4(t.vertices[2],ic,o),Ei.set(ic,a,-s,-n),Ei.transformMat4(t.vertices[3],ic,o),Ei.set(ic,a,s,-r),Ei.transformMat4(t.vertices[4],ic,o),Ei.set(ic,-a,s,-r),Ei.transformMat4(t.vertices[5],ic,o),Ei.set(ic,-a,-s,-r),Ei.transformMat4(t.vertices[6],ic,o),Ei.set(ic,a,-s,-r),Ei.transformMat4(t.vertices[7],ic,o),Cs.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),Cs.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),Cs.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),Cs.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),Cs.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),Cs.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Zs||(Zs={})),function(t){t[t.Default=Zs.Default]="Default",t[t.Normal=Zs.Normal]="Normal",t[t.Reverse=Zs.Reverse]="Reverse",t[t.Loop=Zs.Loop]="Loop",t[t.LoopReverse=Zs.Loop|Zs.Reverse]="LoopReverse",t[t.PingPong=Zs.PingPong]="PingPong",t[t.PingPongReverse=Zs.PingPong|Zs.Reverse]="PingPongReverse"}($s||($s={})),ce($s);var rc=function(){function t(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return t.prototype.set=function(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex},t}();function oc(t,e,i){void 0===i&&(i=1e-6);for(var n=0,r=t.length-1,o=r>>>1;n<=r;o=n+r>>>1){var a=t[o];if(a>e+i)r=o-1;else{if(!(a<e-i))return o;n=o+1}}return~n}var ac=function(){},sc=function(){return ac},cc=lc((function(){}));function lc(t){return function(e){return"function"==typeof e?t(e):function(i){return t(i,e)}}}function uc(t){return function(e){return function(i){!function(t,e,i){var n=_c(t);if(n){var r=fc(n,"proto");fc(r,"editor")[e]=i}}(i,t,e)}}}var hc="__ccclassCache__";function _c(t){return fc(t,hc)}function fc(t,e){return t[e]||(t[e]={})}var pc=lc((function(t,e){var i=ne.getSuper(t);i===Object&&(i=null);var n={name:e,extends:i,ctor:t},r=t[hc];if(r){var o=r.proto;o&&ne.mixin(n,o),t[hc]=void 0}return Ze(n)})),dc=uc("requireComponent"),mc=uc("executionOrder"),vc=cc;function gc(t,e,i){var n=null;function r(t,e,i){var r=_c(t.constructor);if(r){var o=fc(r,"proto"),a=fc(o,"properties");!function(t,e,i,n,r,o){var a,s=r&&(r.get||r.set);n&&(a=Ge(n,s));var c=e[i],l=ne.mixin(c||{},a||n||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(r.initializer));else{var u=o.default||(o.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(t));u.hasOwnProperty(i)&&(l.default=u[i])}e[i]=l}(t.constructor,a,e,n,i,r)}}return void 0===t?gc({type:void 0}):void 0===e?(n=t,r):void r(t,e,i)}var yc=Symbol("cc:SerializationMetadata"),xc=function(t,e,i){return gc(Cc({}))(t,e,i)};function Sc(t){return gc(Cc({formerlySerializedAs:t}))}var bc=function(t,e,i){return gc({editorOnly:!0})(t,e,i)};function Cc(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}var Ac=ac,Tc=cc,wc=sc,Ec=cc,Pc=sc,Ic=sc,Rc=sc,Dc=ac,Mc=sc,Oc=ac,Bc=sc,Nc=sc,Lc=sc,Fc=sc,zc=sc,Vc=sc,kc=ac,Uc=sc,Gc=ac,Hc=ac,jc=ac,Wc=Kc(Me),qc=Kc(Oe),Xc=Kc(Be),Yc=Kc(Ne);function Kc(t){return gc({type:t})}var Jc,Qc,Zc,$c,tl,el,il,nl,rl,ol=function(t,e,i){return gc({__noImplicit:!0,override:!0})(t,e,i)},al=pc("cc.KeyframeCurve")((Jc=Symbol.iterator,el=function(){function t(){ct(this,"_times",$c,this),ct(this,"_values",tl,this)}var e=t.prototype;return e[Jc]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var i=[t._times[e],t._values[e]];return++e,{done:!1,value:i}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return oc(this._times,t)},e.updateTime=function(t,e){var i=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,i)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var i=Array.from(t);this.setKeyframes(i.map((function(t){return t[0]})),i.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return oc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,i){return 0===e||t>i[e-1]||oi(t,i[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var i=this._times,n=this._values,r=i.length,o=oc(i,t);if(o>=0)return o;var a=~o;return 0===a?(i.unshift(t),n.unshift(e)):a===r?(i.push(t),n.push(e)):(i.splice(a-1,0,t),n.splice(a-1,0,e)),a},Q(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}(),$c=lt((Zc=el).prototype,"_times",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tl=lt(Zc.prototype,"_values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qc=Zc))||Qc;function sl(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(il||(il=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(nl||(nl=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(rl||(rl=t("TangentWeightMode",{})));var cl,ll=t("editorExtrasTag","__editorExtras__"),ul=function(){},hl=Object.freeze({__proto__:null,uniquelyReferenced:Ac,ccclass:pc,property:gc,requireComponent:dc,executionOrder:mc,disallowMultiple:vc,allowReplicated:function(t){Ze.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:Tc,menu:wc,playOnFocus:Ec,inspector:Pc,icon:Ic,help:Rc,type:Kc,integer:Wc,float:qc,boolean:Xc,string:Yc});t("_decorator",hl);var _l=1<<22,fl=[],pl=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=fl.length,e=0;e<t;++e){var i=fl[e];1&i._objFlags||i._destroyImmediate()}t===fl.length?fl.length=0:fl.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(D(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,fl.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var i,n=t instanceof u._BaseNode||t instanceof u.Component,r=n?"_id":null,o={};for(i in t)if(t.hasOwnProperty(i)){if(i===r)continue;switch(typeof t[i]){case"string":o[i]="";break;case"object":case"function":o[i]=null}}if(Ze._isCCClass(e))for(var a=u.Class.Attr.getClassAttrs(e),s=e.__props__,c=0;c<s.length;c++){var l=(i=s[c])+u.Class.Attr.DELIMETER+"default";if(l in a){if(n&&"_id"===i)continue;switch(typeof a[l]){case"string":o[i]="";break;case"object":case"function":o[i]=null;break;case"undefined":o[i]=void 0}}}var h="";for(i in o){var _;_=Ze.IDENTIFIER_RE.test(i)?"o."+i+"=":"o["+Ze.escapeForJS(i)+"]=";var f=o[i];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,t),At(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?O(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},Q(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var i=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|i}},{key:"replicated",get:function(){return!!(this._objFlags&_l)},set:function(t){t?this._objFlags|=_l:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),dl=pl.prototype;function ml(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}dl._deserialize=null,dl._onPreDestroy=null,Ze.fastDefine("cc.Object",pl,((cl={_name:"",_objFlags:0})[ll]={},cl)),Ze.Attr.setClassAttr(pl,ll,"editorOnly",!0),Ze.Attr.setClassAttr(pl,"replicated","visible",!1),At(pl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),u.isValid=ml,u.Object=pl;var vl=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=ne.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=ne.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},Q(t,[{key:"count",get:function(){return this._count}}]),t}(),gl=function(){function t(e,i){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var n=0,r=i.length;n<r;n++)this.pipes.push(i[n])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(D(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var i=0,n=e.length;i<n;){var r=(0,e[i])(t);if(r)return t.isFinish=!0,r;++i!==n&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var i=this;(0,this.pipes[t])(e,(function(n){n?(e.isFinish=!0,e.dispatch("complete",n)):++t<i.pipes.length?(e.input=e.output,e.output=null,i._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",n,e.output))}))},t}();gl._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=ne.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var i=this.get(e);i&&t(i,e)}},e.find=function(t){for(var e in this._weakMap){var i=this.get(e);if(i&&t(i,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},Q(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var yl,xl=new vl,Sl=new vl,bl=new vl,Cl=new vl,Al=new gl("normal load",[]),Tl=new gl("fetch",[]),wl=new gl("transform url",[]);!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(yl||(yl={}));var El,Pl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(El||(El={}));var Il=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var i;return 0!==t._deadPool.length?(i=t._deadPool.pop()).set(e):i=new t(e),i};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,i,n,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,i);break;case"progress":this.onProgress&&this.onProgress(e,i,n,r);break;case"error":this.onError&&this.onError(e,i,n,r);break;default:var o="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[o]&&this[o](e,i,n,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();Il.MAX_DEAD_NUM=500,Il._taskId=0,Il._deadPool=[];var Rl="0123456789abcdef".split(""),Dl=["","","",""],Ml=Dl.concat(Dl,"-",Dl,"-",Dl,"-",Dl,"-",Dl,Dl,Dl),Ol=Ml.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function Bl(t){var e=t.split("@")[0];if(22!==e.length)return t;Ml[0]=t[0],Ml[1]=t[1];for(var i=2,n=2;i<22;i+=2){var r=de[t.charCodeAt(i)],o=de[t.charCodeAt(i+1)];Ml[Ol[n++]]=Rl[r>>2],Ml[Ol[n++]]=Rl[(3&r)<<2|o>>4],Ml[Ol[n++]]=Rl[15&o]}return t.replace(e,Ml.join(""))}var Nl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Ll(t){var e=Nl.exec(t);return e?e[1]:""}function Fl(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var i=Cl.find((function(e){return!!e.getAssetInfo(t)}));return i&&(e.bundle=i.name),kl(t,e)}function zl(t){return!!t&&(t instanceof u.SceneAsset||t instanceof u.Scene)}function Vl(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function kl(t,e){var i=Il.create({input:t,options:e}),n=[];try{for(var r,o=st(wl.sync(i));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),n.push(s)}}catch(t){for(var c,l=st(i.output);!(c=l()).done;)c.value.recycle();b(t.message,t.stack)}return i.recycle(),n.length>1?n:n[0]}var Ul=Object.freeze({__proto__:null,getUuidFromURL:Ll,getUrlWithUuid:Fl,isScene:zl,normalize:Vl,transform:kl,decodeUuid:Bl}),Gl=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,ne.array.fastRemoveAt(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),Hl=function(){function t(){this._poolHandle=-1,Gl.addContainer(this)}return t.prototype.destroy=function(){Gl.removeContainer(this)},t}(),jl=t("Pool",function(t){function e(e,i,n){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=n||null,r._elementsPerBatch=Math.max(i,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(e());return r}$(e,t);var i=e.prototype;return i.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},i.free=function(t){this._freepool[++this._nextAvail]=t},i.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},i.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},i.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&D(14100);var i=e||this._dtor;if(i)for(var n=0;n<=this._nextAvail;n++)i(this._freepool[n]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(Hl)),Wl=t("RecyclePool",function(t){function e(e,i,n){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=n||null,r._data=new Array(i),r._initSize=i;for(var o=0;o<i;++o)r._data[o]=e();return r}$(e,t);var i=e.prototype;return i.reset=function(){this._count=0},i.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},i.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},i.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},i.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},i.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,i=this._data[t];this._data[t]=this._data[e],this._data[e]=i,this._count-=1}},Q(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(Hl)),ql=t("CachedArray",function(t){function e(e,i){var n;return(n=t.call(this)||this).array=void 0,n.length=0,n._compareFn=void 0,n._initSize=0,n.array=new Array(e),n._initSize=e,n.length=0,n._compareFn=void 0!==i?i:function(t,e){return t-e},n}$(e,t);var i=e.prototype;return i.push=function(t){this.array[this.length++]=t},i.pop=function(){return this.array[--this.length]},i.get=function(t){return this.array[t]},i.clear=function(){this.length=0},i.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},i.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},i.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},i.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},i.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},i.indexOf=function(t){for(var e=0,i=this.length;e<i;++e)if(this.array[e]===t)return e;return-1},e}(Hl));t("memop",Object.freeze({__proto__:null,Pool:jl,RecyclePool:Wl,CachedArray:ql}));var Xl=ie.fastRemoveAt;function Yl(){}var Kl=function(){function t(){this.callback=Yl,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,i){this.callback=t||Yl,this.target=e,this.once=!!i},e.reset=function(){this.target=void 0,this.callback=Yl,this.once=!1},e.check=function(){return!(this.target instanceof pl&&!ml(this.target,!0))},t}(),Jl=new jl((function(){return new Kl}),32),Ql=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var i=this.callbackInfos[e];i&&i.callback===t&&(i.reset(),Jl.free(i),Xl(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var i=this.callbackInfos[e];i&&i.target===t&&(i.reset(),Jl.free(i),Xl(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Xl(this.callbackInfos,t),Jl.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),Jl.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Xl(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),Zl=new jl((function(){return new Ql}),16),$l=function(){function t(){this._callbackTable=Pt(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,i,n){if(!this.hasEventListener(t,e,i)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=Zl.alloc());var o=Jl.alloc();o.set(e,i,n),r.callbackInfos.push(o)}return e},e.hasEventListener=function(t,e,i){var n=this._callbackTable&&this._callbackTable[t];if(!n)return!1;var r=n.callbackInfos;if(!e){if(n.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===e&&s.target===i)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var i=this._callbackTable&&this._callbackTable[t];i&&(i.isInvoking?i.cancelAll():(i.clear(),Zl.free(i),delete this._callbackTable[t]))}else if(t)for(var n in this._callbackTable){var r=this._callbackTable[n];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,i){var n,r=this._callbackTable&&this._callbackTable[t];if(r){var o=r.callbackInfos;if(e)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===e&&s.target===i){r.cancel(a);break}}else this.removeAll(t)}null===(n=this._offCallback)||void 0===n||n.call(this)},e.emit=function(t,e,i,n,r,o){var a=this._callbackTable&&this._callbackTable[t];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(t,_,f),h.check()?f?_.call(f,e,i,n,r,o):_(e,i,n,r,o):this.off(t,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),Zl.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function tu(t){for(var e=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._callbackTable=Pt(!0),e}$(e,t);var i=e.prototype;return i.once=function(t,e,i){return this.on(t,e,i,!0)},i.targetOff=function(t){this.removeAll(t)},e}(t),i=$l.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i)),r=0;r<n.length;++r){var o=n[r];if(!(o in e.prototype)){var a=Object.getOwnPropertyDescriptor(i,o);a&&Object.defineProperty(e.prototype,o,a)}}return e}var eu=t("EventTarget",tu((function(){})));u.EventTarget=eu;var iu,nu,ru,ou,au,su,cu,lu=new(function(){function t(){this._finalizationRegistry=null}var e=t.prototype;return e.registerGCObject=function(t){return t},e.unregisterGCObject=function(){},e.init=function(){},e.finalizationRegistryCallback=function(t){t.isValid&&t.destroy()},e.destroy=function(){},t}()),uu=pc("cc.GCObject")(iu=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,lu.registerGCObject(ot(e))||ot(e)}$(e,t);var i=e.prototype;return i.equals=function(t){return!!t&&t===this},i.destroy=function(){return lu.unregisterGCObject(this),t.prototype.destroy.call(this)},e}(pl))||iu;!function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(nu||(nu={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(ru||(ru={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(ou||(ou={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(au||(au={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(su||(su={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(cu||(cu={}));var hu,_u,fu,pu,du=new(function(t){function e(){var e,i,n;(n=t.call(this)||this).networkType=void 0,n.isNative=void 0,n.isBrowser=void 0,n.isMobile=void 0,n.isLittleEndian=void 0,n.platform=void 0,n.language=void 0,n.nativeLanguage=void 0,n.os=void 0,n.osVersion=void 0,n.osMainVersion=void 0,n.browserType=void 0,n.browserVersion=void 0,n._battery=void 0,n._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(t){n._battery=t})),n.networkType=ou.LAN,n.isNative=!1,n.isBrowser=!0,n.isMobile=/mobile|android|iphone|ipad/.test(a),n.platform=n.isMobile?su.MOBILE_BROWSER:su.DESKTOP_BROWSER,n.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;n.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:ru.ENGLISH,n.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=au.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=au.WINDOWS:l?f=au.IOS:-1!==o.appVersion.indexOf("Mac")?f=au.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=au.LINUX:c?f=au.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=au.LINUX),n.os=f,n.osVersion=u,n.osMainVersion=h,n.browserType=nu.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=p?p[0].toLowerCase():au.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=nu.ANDROID);var m={micromessenger:nu.WECHAT,wechat:nu.WECHAT,weixin:nu.WECHAT,trident:nu.IE,edge:nu.EDGE,"360 aphone":nu.BROWSER_360,mxbrowser:nu.MAXTHON,"opr/":nu.OPERA,ubrowser:nu.UC,huaweibrowser:nu.HUAWEI};n.browserType=m[d]||d,n.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),n.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(t){x=!0,null==t||t.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,b=void 0!==document.documentElement.onmouseup;return n._featureMap=((i={})[cu.WEBP]=g,i[cu.IMAGE_BITMAP]=x,i[cu.WEB_VIEW]=!0,i[cu.VIDEO_PLAYER]=!0,i[cu.SAFE_AREA]=!1,i[cu.INPUT_TOUCH]=S,i[cu.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,i[cu.EVENT_MOUSE]=b,i[cu.EVENT_TOUCH]=S||b,i[cu.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,i),n._registerEvent(),n}$(e,t);var i=e.prototype;return i._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var i=!1,n=function(){i||(i=!0,e.emit("hide"))},r=function(t,n,r,o,a){i&&(i=!1,e.emit("show",t,n,r,o,a))};if(t)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(e){var i=document[t];(i=i||e.hidden)?n():r()}));else window.addEventListener("blur",n),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",n),window.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r))},i.hasFeature=function(t){return this._featureMap[t]},i.getBatteryLevel=function(){return this._battery?this._battery.level:1},i.triggerGC=function(){},i.openURL=function(t){window.open(t)},i.now=function(){return Date.now?Date.now():+new Date},i.restartJSVM=function(){},i.close=function(){this.emit("close"),window.close()},e}(eu)),mu=/(\.[^\.\/\?\\]*)(\?.*)?$/,vu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,gu=/[^\.\/]+\/\.\.\//;function yu(){for(var t="",e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];for(var r=0,o=i;r<o.length;r++){var a=o[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function xu(t){var e=mu.exec(t);return e?e[1]:""}function Su(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function bu(t,e){var i=t.indexOf("?");i>0&&(t=t.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!n)return t;var r=n[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function Cu(t){var e=vu.exec(t);return e?e[2]:""}function Au(t,e){e=e||"";var i=t.indexOf("?"),n="";return i>0&&(n=t.substring(i),t=t.substring(0,i)),(i=t.lastIndexOf("."))<0?t+e+n:t.substring(0,i)+e+n}function Tu(t,e,i){if(0===e.indexOf("."))return Au(t,e);var n=t.indexOf("?"),r="",o=i?xu(t):"";return n>0&&(r=t.substring(n),t=t.substring(0,n)),n=(n=t.lastIndexOf("/"))<=0?0:n+1,t.substring(0,n)+e+o+r}function wu(t){var e=t=String(t);do{e=t,t=t.replace(gu,"")}while(e.length!==t.length);return t}function Eu(t){return t.replace(/[\/\\]$/,"")}function Pu(){return du.os===au.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:yu,extname:xu,mainFileName:Su,basename:bu,dirname:Cu,changeExtname:Au,changeBasename:Tu,_normalize:wu,stripSep:Eu,getSeperator:Pu}));var Iu,Ru,Du,Mu=t("Asset",pc("cc.Asset")((pu=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).loaded=!0,ct(e,"_native",fu,ot(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(ot(e),"_uuid",{value:"",writable:!0}),e}$(e,t),e.deserialize=function(t){return u.deserialize(t)};var i=e.prototype;return i.toString=function(){return this.nativeUrl},i.serialize=function(){},i._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},i.addRef=function(){return this._ref++,this},i.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&u.assetManager._releaseManager.tryRelease(this),this},i.onLoaded=function(){},i.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},i.validate=function(){return!0},i.destroy=function(){return A(F(12101,this._uuid)),t.prototype.destroy.call(this)},Q(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Fl(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Fl(this._uuid,{__nativeName__:t,nativeExt:xu(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(tu(uu)),fu=lt((_u=pu).prototype,"_native",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),lt(_u.prototype,"_nativeAsset",[gc],Object.getOwnPropertyDescriptor(_u.prototype,"_nativeAsset"),_u.prototype),hu=_u))||hu);Mu.prototype.createNode=null,u.Asset=Mu;var Ou=t("Script",pc("cc.Script")(Iu=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Mu))||Iu);u._Script=Ou;var Bu=t("JavaScript",pc("cc.JavaScript")(Ru=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Ou))||Ru);u._JavaScript=Bu;var Nu,Lu,Fu,zu,Vu,ku,Uu,Gu,Hu,ju,Wu,qu=t("TypeScript",pc("cc.TypeScript")(Du=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Ou))||Du);u._TypeScript=qu;var Xu,Yu,Ku,Ju,Qu=new mt("Comp"),Zu=pl.Flags.IsOnLoadCalled,$u=t("Component",(Nu=pc("cc.Component"),Lu=Bc(),Fu=Kc(Ou),zu=Nc(),Nu((Wu=ju=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"node",Uu,ot(e)),ct(e,"_enabled",Gu,ot(e)),ct(e,"__prefab",Hu,ot(e)),e._sceneGetter=null,e._id=Qu.getNewId(),e}$(e,t);var i=e.prototype;return i._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},i.addComponent=function(t){return this.node.addComponent(t)},i.getComponent=function(t){return this.node.getComponent(t)},i.getComponents=function(t){return this.node.getComponents(t)},i.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},i.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},i.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&u.director._compScheduler.disableComp(this),!0)},i._onPreDestroy=function(){this.unscheduleAllCallbacks(),u.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},i._instantiate=function(t){return t||(t=u.instantiate._clone(this,this)),t&&(t.node=null),t},i.schedule=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=u.macro.REPEAT_FOREVER),void 0===n&&(n=0),L(t,1619),L((e=e||0)>=0,1620),i=Number.isNaN(i)?u.macro.REPEAT_FOREVER:i,n=n||0;var r=u.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,i,n,o)},i.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},i.unschedule=function(t){t&&u.director.getScheduler().unschedule(t,this)},i.unscheduleAllCallbacks=function(){u.director.getScheduler().unscheduleAllForTarget(this)},Q(e,[{key:"name",get:function(){if(this._name)return this._name;var t=It(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=u.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Zu}}]),e}(pl),ju.system=null,lt((ku=Wu).prototype,"__scriptAsset",[Lu,Fu,zu,jc],Object.getOwnPropertyDescriptor(ku.prototype,"__scriptAsset"),ku.prototype),Uu=lt(ku.prototype,"node",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gu=lt(ku.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hu=lt(ku.prototype,"__prefab",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vu=ku))||Vu)),th=$u.prototype;th.update=null,th.lateUpdate=null,th.__preload=null,th.onLoad=null,th.start=null,th.onEnable=null,th.onDisable=null,th.onDestroy=null,th.onFocusInEditor=null,th.onLostFocusInEditor=null,th.resetInEditor=null,th._getLocalBounds=null,th.onRestore=null,$u._requireComponent=null,$u._executionOrder=0,At($u,"_registerEditorProps",(function(t,e){var i=e.requireComponent;i&&(Array.isArray(i)&&(i=i.filter(Boolean)),t._requireComponent=i);var n=e.executionOrder;n&&"number"==typeof n&&(t._executionOrder=n)})),u.Component=$u;var eh,ih=t("MissingScript",pc("cc.MissingScript")(Xu=Pc()((Ju=function(t){function e(){var e;return ct(e=t.call(this)||this,"_$erialized",Ku,ot(e)),e}return $(e,t),e.safeFindClass=function(t){var e=Zt(t);if(e)return e;u.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){D(4600,this.node.name)},e}($u),Ku=lt((Yu=Ju).prototype,"_$erialized",[xc,bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xu=Yu))||Xu)||Xu);u._MissingScript=ih;try{var nh=ih.__values__;0!==nh.length&&"_$erialized"===nh[nh.length-1]||(b("The '_$erialized' prop in MissingScript is missing. Please contact jare."),b("    Error props: ['"+nh+"']"))}catch(Xo){b("Error when checking MissingScript 5, "+Xo)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(eh||(eh={}));var rh,oh={auto:eh.AUTO,landscape:eh.LANDSCAPE,portrait:eh.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(rh||(rh={}));var ah=new(function(t){function e(){var e,i,n,r,o,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new $i(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=eh.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(i=e._gameCanvas)||void 0===i||null===(n=i.parentNode)||void 0===n||n.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var s=e._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)e._fn[s[0][l]]=a[l];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}$(e,t);var i=e.prototype;return i.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=oh[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},i.requestFullScreen=function(){var t=this;return new Promise((function(e,i){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var n=t._getFullscreenTarget();n?n.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(i)}),{once:!0,capture:!0}):i(new Error("Cannot access fullscreen target"))})))}))},i.exitFullScreen=function(){var t=this;return new Promise((function(e,i){var n=document[t._fn.exitFullscreen]();window.Promise&&n instanceof Promise?n.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(i):(t.windowSize=t._cachedFrameSize,e())}))},i._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var i,n,r=window.devicePixelRatio;null===(i=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===i||null===(n=i.addEventListener)||void 0===n||n.call(i,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},i._convertToSizeInCssPixels=function(t){var e=t.clone(),i=this.devicePixelRatio;return e.width/=i,e.height/=i,e},i._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===rh.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,i=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=i+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=i+"px")}this._updateContainer()}},i._getFullscreenTarget=function(){var t=this._windowType;return t===rh.Fullscreen?document[this._fn.fullscreenElement]:t===rh.SubFrame?this._gameFrame:document.body},i._doRequestFullScreen=function(){var t=this;return new Promise((function(e,i){if(t._supportFullScreen){var n=t._getFullscreenTarget();if(n){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=n[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(i):(t._onFullscreenChange=e,t._onFullscreenError=i)}else i(new Error("Cannot access fullscreen target"))}else i(new Error("fullscreen is not supported"))}))},i._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=du.isMobile&&(e&&t===eh.PORTRAIT||!e&&t===eh.LANDSCAPE)},i._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void D(9201);var t,e,i=u.view.getDesignResolutionSize(),n=this._gameFrame,r=n.clientWidth,o=n.clientHeight,a=i.width,s=i.height,c=r/a,l=o/s,h=this._gameContainer.style;c<l?(t=r,e=s*c):(t=a*l,e=o),h.width=t+"px",h.height=e+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else D(9201)},Q(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===rh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):D(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new $i(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new $i(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(D(9201),new $i(0,0));var t,e,i;switch(this._windowType){case rh.SubFrame:return this._gameFrame?new $i(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(D(9201),new $i(0,0));case rh.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,i=this.isFrameRotated?t.clientWidth:t.clientHeight,new $i(e,i);case rh.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,i=this.isFrameRotated?window.innerWidth:window.innerHeight,new $i(e,i);case rh.Unknown:default:return new $i(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?rh.Fullscreen:this._gameFrame?this._exactFitScreen?rh.BrowserWindow:rh.SubFrame:(D(9201),rh.Unknown)}}]),e}(eu)),sh=function(){function t(){}var e=t.prototype;return e._init=function(t){ah.init(t,(function(){var t,e=u.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=ah.resolutionScale:D(1220)}))},e.fullScreen=function(){return ah.isFullScreen},e.requestFullScreen=function(t,e,i){return arguments.length>0&&D(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),ah.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==i||i()}))},e.exitFullScreen=function(){return ah.exitFullScreen()},e.autoFullScreen=function(t,e){var i;null===(i=this.requestFullScreen(t,e))||void 0===i||i.catch((function(){}))},e.disableAutoFullScreen=function(){},Q(t,[{key:"devicePixelRatio",get:function(){return ah.devicePixelRatio}},{key:"windowSize",get:function(){return ah.windowSize},set:function(t){ah.windowSize=t}},{key:"resolution",get:function(){return ah.resolution}},{key:"supportsFullScreen",get:function(){return ah.supportFullScreen}}]),t}(),ch=t("screen",new sh);u.screen=ch;var lh=t("sys",{Feature:cu,hasFeature:function(t){return du.hasFeature(t)},NetworkType:ou,Language:ru,OS:au,Platform:su,BrowserType:nu,isNative:du.isNative,isBrowser:du.isBrowser,isMobile:du.isMobile,isLittleEndian:du.isLittleEndian,platform:du.platform,language:du.language,languageCode:du.nativeLanguage,os:du.os,osVersion:du.osVersion,osMainVersion:du.osMainVersion,browserType:du.browserType,browserVersion:du.browserVersion,windowPixelResolution:ch.windowSize,capabilities:{canvas:!0,opengl:!0,webp:du.hasFeature(cu.WEBP),imageBitmap:du.hasFeature(cu.IMAGE_BITMAP),touches:du.hasFeature(cu.INPUT_TOUCH),mouse:du.hasFeature(cu.EVENT_MOUSE),keyboard:du.hasFeature(cu.EVENT_KEYBOARD),accelerometer:du.hasFeature(cu.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return du.networkType},getBatteryLevel:function(){return du.getBatteryLevel()},garbageCollect:function(){du.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",x(t+="Using "+(u.game.renderType===u.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){du.openURL(t)},now:function(){return du.now()},restartVM:function(){du.restartJSVM()},getSafeAreaRect:function(){var t=u.view,e=ah.safeAreaEdge,i=ah.windowSize,n=new qi(e.left,e.bottom),r=new qi(i.width-e.right,i.height-e.top);t._convertToUISpace(n),t._convertToUISpace(r);var o=n.x,a=n.y,s=r.x-n.x,c=r.y-n.y;return new en(o,a,s,c)}});!function(){try{var t=lh.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){D(5200)};lh.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}lh.__isWebIOS14OrIPadOS14Env=(lh.os===au.IOS||lh.os===au.OSX)&&du.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),u.sys=lh;var uh=t("serializeTag",Symbol("[[Serialize]]")),hh=t("deserializeTag",Symbol("[[Deserialize]]")),_h=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return Q(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function fh(t){var e=t;return{chunks:e.chunks,document:e.document}}function ph(t){if(t.length<16)throw new dh(F(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new dh(F(13100));var i=e.getUint32(4,!0);if(1!==i)throw new dh(F(13101,i));if(e.getUint32(8,!0)!==e.byteLength)throw new dh(F(13102));var n=12,r=e.getUint32(n,!0);n+=4;var o=new Uint8Array(e.buffer,n+e.byteOffset,r);n+=r;var a,s=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(F(13104))}(o);try{a=JSON.parse(s)}catch(t){throw new dh(t)}for(var c=[];n<e.byteLength;){n%8!=0&&(n+=8-n%8);var l=e.getUint32(n,!0);n+=4,c.push(new Uint8Array(e.buffer,n+e.byteOffset,l)),n+=l}if(n!==e.byteLength)throw new dh(F(13102));return new _h(a,c)}var dh=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(rt(Error));function mh(t,e,i,n,r){if(e instanceof u.ValueType){r||t.push("if(prop){");var o=It(e);t.push("s._deserializeFastDefinedObject(o"+i+",prop,"+o+");"),r||t.push("}else o"+i+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+n+");\n} else {\n    o"+i+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var i=t-e;return this._viewOrPaddings.push(i),this._length+=i,i}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(i){"number"==typeof i?e+=i:(t.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength),e),e+=i.byteLength)})),t},Q(t,[{key:"byteLength",get:function(){return this._length}}])}(),u.internal.parseCCONJson=fh,u.internal.decodeCCONBinary=ph,u.internal.CCON=_h;var vh="$_$default",gh="$_$formerlySerializedAs",yh=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return $(e,t),e.prototype.get=function(t,e,i,n,r){var o=this._get();return o?(o.reset(t,e,i,n,r),o):new xh(t,e,i,n,r)},e}(ee),xh=function(){function t(t,e,i,n){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,i,n){this.result=t,this.customEnv=n,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,i=!1;t instanceof _h?(i=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:i};var n=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(n,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,i,n){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,i,n):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,i=t.length,n=t.ctor;return new globalThis[n](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,i)},e._deserializeArray=function(t){for(var e,i=new Array(t.length),n=0;n<t.length;n++)"object"==typeof(e=t[n])&&e?this._deserializeAndAssignField(i,e,""+n)&&(i[n]=null):i[n]=e;return i},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,i,n){var r=this,o=t.__type__,a=this._classFinder(o,t,i,n);if(!a)return this._classFinder===Zt&&this._reportMissingClass(o),null;var s=function(t){var i=new t;return e>=0&&(r.deserializedList[e]=i),i}(a);return this._deserializeInto(t,s,a),s},e._deserializeInto=function(t,e,i,n){void 0===n&&(n=!1),n||!e[hh]?e._deserialize?e._deserialize(t.content,this):u.Class._isCCClass(i)?this._deserializeFireClass(e,t,i):this._deserializeFastDefinedObject(e,t,i):this._runCustomizedDeserialize(t,e,i)},e._runCustomizedDeserialize=function(t,e,i){var n=this,r={readProperty:function(e){var i=t[e];return"object"==typeof i&&i?n._deserializeObjectField(i):i},readThis:function(){n._deserializeInto(t,e,i,!0)},readSuper:function(){var r=Ut(i);r&&n._deserializeInto(t,e,r)}};e[hh](r,this._context)},e._deserializeFireClass=function(t,e,i){var n;if(i.hasOwnProperty("__deserialize__"))n=i.__deserialize__;else{n=function(t,e){for(var i=Ie(e),n=e.__values__,r=["var prop;"],o=he.test(te(e)),a=0;a<n.length;a++){var s=n[a],c=void 0,l=void 0;Ze.IDENTIFIER_RE.test(s)?(l='"'+s+'"',c="."+s):c="["+(l=Ze.escapeForJS(s))+"]";var h=c;if(i[s+gh]){var _=i[s+gh];h=Ze.IDENTIFIER_RE.test(_)?"."+_:"["+Ze.escapeForJS(_)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var f=Ze.getDefault(i[s+vh]);if(o){var p=void 0,d=i[s+"$_$type"];if(void 0===f&&d)p=d instanceof De;else{var m=typeof f;p="string"===m||"number"===m||"boolean"===m}p?r.push("o"+c+"=prop;"):mh(r,f,c,l,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),mh(r,f,c,l,!1),r.push("}");r.push("}")}return(u.js.isChildClassOf(e,u._BaseNode)||u.js.isChildClassOf(e,u.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===n[n.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,i);try{if(i===ih){var r=i.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(b("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),b("    Error props: ['"+r+"']. Please contact jare."));var o=n;n=function(t,e,i,n){try{JSON.parse(JSON.stringify(i._$erialized))||b("Unable to load previously serialized data. "+JSON.stringify(i))}catch(t){b("Error when checking MissingScript 7, "+t)}o(t,e,i,n)}}}catch(t){b("Error when checking MissingScript 6, "+t)}At(i,"__deserialize__",n,!0)}n(this,t,e,i)},e._deserializeAndAssignField=function(t,e,i){var n=e.__id__;if("number"==typeof n){var r=this.deserializedList[n];if(r)t[i]=r;else{var o,a=this._serializedData[n];t[i]=this._deserializeObject(a,n,void 0,i),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,n,t,i)}}else{var s=e.__uuid__;if(s){var c=e.__expectedType__;this.result.push(t,i,s,c)}else t[i]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var i=this.deserializedList[e];if(i)return i;var n=this._serializedData[e];return this._deserializeObject(n,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];"object"!=typeof n?"__type__"!==i&&(t[i]=n):n?this._deserializeAndAssignField(t,n,i)&&(t[i]=null):t[i]=null}},e._deserializeFastDefinedObject=function(t,e,i){if(i===u.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(i===u.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(i!==u.Color){if(i===u.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var n=Ie(i),r=i.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];void 0!==s||e.hasOwnProperty(a)||(s=Ze.getDefault(n[a+vh])),"object"!=typeof s?t[a]=s:s?this._deserializeAndAssignField(t,s,a):t[a]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var c=e.a;t.a=void 0===c?255:c}},t}();xh.pool=new yh;var Sh=[qi,Ei,Ji,Bi,Ti,$i,en,Gi];function bh(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var Ch=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},bh,bh,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){Gi.fromArray(t,e,1)}],Ah=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,i,n){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(i),this.uuidTypeList.push(n||"")},t}());function Th(t,e){for(var i=t[4][e[0]],n=i[0],r=new(0,n[0]),o=n[1],a=n[2],s=i[i.length-1],c=1;c<s;++c)r[o[i[c]]]=e[c];for(;c<e.length;++c){var l=o[i[c]],u=n[i[c]+a];(0,Dh[u])(t,r,l,e[c])}return r}function wh(t,e,i){var n=new e;return n._deserialize?n._deserialize(i,t[0]):O(5303,It(e)),n}function Eh(t,e,i,n){n>=0?e[i]=t[5][n]:t[7][3*~n]=e}function Ph(t){return function(e,i,n,r){i[n]=r;for(var o=0;o<r.length;++o)t(e,r,o,r[o])}}function Ih(t,e,i,n){e[i]=null,t[8][n]=e}function Rh(t,e,i,n){e[i]=Th(t,n)}Ah.pool=new ee((function(t){t.reset()}),5),Ah.pool.get=function(){return this._get()||new Ah};var Dh=new Array(13);function Mh(t,e,i){return t||i(e),Object}function Oh(t,e,i,n,r,o,a){var s=t(e);if(!s){if(r)return void(i[n]=function(e,i,n){return function(){var r=t(n)||Mh(o,n,a);return e[i]=r,new r}}(i,n,e));s=Mh(o,e,a)}i[n]=s}function Bh(t,e,i,n){for(var r=i||Zt,o=t[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Oh(r,s[0],s,0,e,i,n):Oh(r,s,o,a,e,i,n)}}function Nh(t){var e=t[4];if(e)for(var i=t[3],n=0;n<e.length;++n){var r=e[n];r[0]=i[r[0]]}}function Lh(t,e,i){"string"==typeof t&&(t=JSON.parse(t));var n,r=!e;if(e=e||Ah.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Fh}return!1}(t)){e.init(t),i=i||{};var o,a=t[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(F(5304,a));i._version=a,i.result=e,t[0]=i,s||(Bh(t,!1,i.classFinder,null!==(o=i.reportMissingClass)&&void 0!==o?o:Lh.reportMissingClass),Nh(t)),u.game._isCloning=!0;var c=t[5],l=function(t){var e=t[5],i=t[6],n=0===i?0:i.length,r=e[e.length-1],o=e.length-n;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)e[a]=Th(t,e[a]);for(var s=t[3],c=0;c<n;++c,++a){var l=i[c],u=e[a];if(l>=0){var h=s[l];e[a]=wh(t,h,u)}else(0,Dh[l=~l])(t,e,a,u)}return r}(t);u.game._isCloning=!1,t[7]&&function(t,e,i){for(var n=t.length-1,r=0,o=3*t[n];r<o;r+=3){var a=t[r],s=e[t[r+2]],c=t[r+1];c>=0?a[i[c]]=s:a[~c]=s}for(;r<n;r+=3){var l=e[t[r]],u=e[t[r+2]],h=t[r+1];h>=0?l[i[h]]=u:l[~h]=u}}(t[7],c,t[2]),function(t){for(var e=t[5],i=t[2],n=t[1],r=t[8],o=t[9],a=t[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=e[c]);var l=o[s];"number"==typeof l&&(l=l>=0?i[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=n[u])}}(t),n=c[l]}else n=function(t,e,i){var n,r=(i=i||{}).classFinder||Zt,o=i.createAssetRefs||lh.platform===su.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly,c=null!==(n=i.reportMissingClass)&&void 0!==n?n:u.deserialize.reportMissingClass;e.init();var l=xh.pool.get(e,r,c,a,s);u.game._isCloning=!0;var h=l.deserialize(t);return u.game._isCloning=!1,xh.pool.put(l),o&&e.assignAssetsBy(EditorExtends.serialize.asAsset),h}(t,e,i);return r&&Ah.pool.put(e),n}Dh[0]=function(t,e,i,n){e[i]=n},Dh[1]=Eh,Dh[2]=Ph(Eh),Dh[3]=Ph(Ih),Dh[4]=Rh,Dh[5]=function(t,e,i,n){Ch[n[0]](e[i],n)},Dh[6]=Ih,Dh[7]=function(t,e,i,n){e[i].set(n)},Dh[8]=function(t,e,i,n){var r=new Sh[n[0]];Ch[n[0]](r,n),e[i]=r},Dh[9]=Ph(Rh),Dh[10]=function(t,e,i,n){var r=t[3][n[0]];e[i]=wh(t,r,n[1])},Dh[11]=function(t,e,i,n){var r=n[0];e[i]=r;for(var o=1;o<n.length;o+=3){var a=n[o],s=n[o+1],c=n[o+2];(0,Dh[s])(t,r,a,c)}},Dh[12]=function(t,e,i,n){var r=n[0];e[i]=r;for(var o=0;o<r.length;++o){var a=r[o],s=n[o+1];0!==s&&(0,Dh[s])(t,r,o,a)}},Lh.Details=Ah,Lh.reportMissingClass=function(t){O(5302,t)};var Fh=function(t){this.preprocessed=!0,this.version=t};function zh(t,e,i){return[1,0,0,[t],0,i?[e,-1]:[e],[0],0,[],[],[]]}u.deserialize=Lh;var Vh,kh,Uh,Gh,Hh,jh,Wh,qh,Xh,Yh,Kh,Jh=pl.Flags.Destroyed,Qh=pl.Flags.PersistentMask,Zh=[];function $h(t){var e;if(t instanceof pl){if(t._instantiate)return u.game._isCloning=!0,e=t._instantiate(null,!0),u.game._isCloning=!1,e;if(t instanceof u.Asset)throw new TypeError(F(6903))}return u.game._isCloning=!0,e=t_(t),u.game._isCloning=!1,e}function t_(t,e){var i;e_(t,i=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var n=0,r=Zh.length;n<r;++n)Zh[n]._iN$t=null;return Zh.length=0,i}function e_(t,e,i){ne.value(t,"_iN$t",e,!0),Zh.push(t);var n=t.constructor;if(u.Class._isCCClass(n))!function(t,e,i,n){for(var r=t.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];if("object"==typeof s&&s){var c=i[a];c instanceof le&&c.constructor===s.constructor?c.set(s):i[a]=s._iN$t||i_(s,n)}else i[a]=s}}(n,t,e,i);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=t[r];if("object"==typeof o&&o){if(o===e)continue;e[r]=o._iN$t||i_(o,i)}else e[r]=o}t instanceof pl&&(e._objFlags&=Qh)}function i_(t,e){if(t instanceof le)return t.clone();if(t instanceof u.Asset)return t;var i;if(ArrayBuffer.isView(t)){var n=t.length;i=new t.constructor(n),t._iN$t=i,Zh.push(t);for(var r=0;r<n;++r)i[r]=t[r];return i}if(Array.isArray(t)){var o=t.length;i=new Array(o),t._iN$t=i,Zh.push(t);for(var a=0;a<o;++a){var s=t[a];i[a]="object"==typeof s&&s?s._iN$t||i_(s,e):s}return i}if(t._objFlags&Jh)return null;var c=t.constructor;if(u.Class._isCCClass(c)){if(e)if(e instanceof u.Component){if(t instanceof u._BaseNode||t instanceof u.Component)return t}else if(e instanceof u._BaseNode)if(t instanceof u._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof u.Component&&t.node&&!t.node.isChildOf(e))return t;i=new c}else if(c===Object)i={};else{if(c)return t;i=Object.create(null)}return e_(t,i,e),i}function n_(t,e){return(e<<3)+t}function r_(t){return a_[t]}function o_(t){switch(t){case Yh.Uint8:return Uint8Array;case Yh.Uint16:return Uint16Array;case Yh.Uint32:return Uint32Array;case Yh.Int8:return Int8Array;case Yh.Int16:return Int16Array;case Yh.Int32:return Int32Array;case Yh.Float32:return Float32Array;case Yh.Float64:return Float64Array}}$h._clone=t_,u.instantiate=$h,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(Yh||(Yh={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(Kh||(Kh={})),t("CompactValueTypeArray",pc("cc.CompactValueTypeArray")((qh=Wh=function(){function t(){ct(this,"_byteOffset",Uh,this),ct(this,"_unitCount",Gh,this),ct(this,"_unitElement",Hh,this),ct(this,"_length",jh,this)}return t.lengthFor=function(t,e,i){return r_(e).requiredUnits*t.length*o_(i).BYTES_PER_ELEMENT},t.compress=function(e,i,n,r,o,a){for(var s=r_(i),c=o_(n),l=s.requiredUnits*e.length,u=new c(r,o,l),h=0;h<e.length;++h)s.compress(u,h,e[h]);var _=new t;return _._unitElement=n_(n,i),_._byteOffset=a,_._unitCount=l,_._length=e.length,_},t.prototype.decompress=function(t){for(var e,i={storageUnit:7&(e=this._unitElement),elementType:e>>3},n=i.storageUnit,r=r_(i.elementType),o=new(o_(n))(t,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},t}(),Wh.StorageUnit=Yh,Wh.ElementType=Kh,Uh=lt((kh=qh).prototype,"_byteOffset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gh=lt(kh.prototype,"_unitCount",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hh=lt(kh.prototype,"_unitElement",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return n_(Yh.Uint8,Kh.Scalar)}}),jh=lt(kh.prototype,"_length",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vh=kh))||Vh);var a_=((Xh={})[Kh.Scalar]={requiredUnits:1,compress:function(t,e,i){t[e]=i},decompress:function(t,e){return t[e]}},Xh[Kh.Vec2]={requiredUnits:2,compress:function(t,e,i){t[2*e]=i.x,t[2*e+1]=i.y},decompress:function(t,e){return new Ei(t[2*e],t[2*e+1])}},Xh[Kh.Vec3]={requiredUnits:3,compress:function(t,e,i){t[3*e]=i.x,t[3*e+1]=i.y,t[3*e+2]=i.z},decompress:function(t,e){return new Ei(t[3*e],t[3*e+1],t[3*e+2])}},Xh[Kh.Vec4]={requiredUnits:4,compress:function(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:function(t,e){return new Ji(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Xh[Kh.Quat]={requiredUnits:4,compress:function(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:function(t,e){return new Bi(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Xh[Kh.Mat4]={requiredUnits:16,compress:function(t,e,i){Gi.toArray(t,i,16*e)},decompress:function(t,e){return Gi.fromArray(new Gi,t,16*e)}},Xh);function s_(){return 0}function c_(t){return t}function l_(t){return t*t}function u_(t){return t*(2-t)}function h_(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function __(t){return t*t*t}function f_(t){return--t*t*t+1}function p_(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function d_(t){return t*t*t*t}function m_(t){return 1- --t*t*t*t}function v_(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function g_(t){return t*t*t*t*t}function y_(t){return--t*t*t*t*t+1}function x_(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function S_(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function b_(t){return Math.sin(t*Math.PI/2)}function C_(t){return.5*(1-Math.cos(Math.PI*t))}function A_(t){return 0===t?0:Math.pow(1024,t-1)}function T_(t){return 1===t?1:1-Math.pow(2,-10*t)}function w_(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function E_(t){return 1-Math.sqrt(1-t*t)}function P_(t){return Math.sqrt(1- --t*t)}function I_(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function R_(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function D_(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function M_(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function O_(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function B_(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function N_(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function L_(t){return 1-F_(1-t)}function F_(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function z_(t){return t<.5?.5*L_(2*t):.5*F_(2*t-1)+.5}function V_(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function k_(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}u._decorator=hl;var U_=Q_(l_,u_),G_=Q_(__,f_),H_=Q_(d_,m_),j_=Q_(g_,y_),W_=Q_(S_,b_),q_=Q_(A_,T_),X_=Q_(E_,P_),Y_=Q_(R_,D_),K_=Q_(O_,B_),J_=Q_(L_,F_);function Q_(t,e){return function(i){return i<.5?e(2*i)/2:t(2*i-1)/2+.5}}var Z_,$_,tf=Object.freeze({__proto__:null,constant:s_,linear:c_,quadIn:l_,quadOut:u_,quadInOut:h_,cubicIn:__,cubicOut:f_,cubicInOut:p_,quartIn:d_,quartOut:m_,quartInOut:v_,quintIn:g_,quintOut:y_,quintInOut:x_,sineIn:S_,sineOut:b_,sineInOut:C_,expoIn:A_,expoOut:T_,expoInOut:w_,circIn:E_,circOut:P_,circInOut:I_,elasticIn:R_,elasticOut:D_,elasticInOut:M_,backIn:O_,backOut:B_,backInOut:N_,bounceIn:L_,bounceOut:F_,bounceInOut:z_,smooth:V_,fade:k_,quadOutIn:U_,cubicOutIn:G_,quartOutIn:H_,quintOutIn:j_,sineOutIn:W_,expoOutIn:q_,circOutIn:X_,elasticOutIn:Y_,backOutIn:K_,bounceOutIn:J_});t("easing",tf),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}($_||($_={}));var ef,nf,rf,of,af,sf=((Z_={})[$_.CONSTANT]=s_,Z_[$_.LINEAR]=c_,Z_[$_.QUAD_IN]=l_,Z_[$_.QUAD_OUT]=u_,Z_[$_.QUAD_IN_OUT]=h_,Z_[$_.QUAD_OUT_IN]=U_,Z_[$_.CUBIC_IN]=__,Z_[$_.CUBIC_OUT]=f_,Z_[$_.CUBIC_IN_OUT]=p_,Z_[$_.CUBIC_OUT_IN]=G_,Z_[$_.QUART_IN]=d_,Z_[$_.QUART_OUT]=m_,Z_[$_.QUART_IN_OUT]=v_,Z_[$_.QUART_OUT_IN]=H_,Z_[$_.QUINT_IN]=g_,Z_[$_.QUINT_OUT]=y_,Z_[$_.QUINT_IN_OUT]=x_,Z_[$_.QUINT_OUT_IN]=j_,Z_[$_.SINE_IN]=S_,Z_[$_.SINE_OUT]=b_,Z_[$_.SINE_IN_OUT]=C_,Z_[$_.SINE_OUT_IN]=W_,Z_[$_.EXPO_IN]=A_,Z_[$_.EXPO_OUT]=T_,Z_[$_.EXPO_IN_OUT]=w_,Z_[$_.EXPO_OUT_IN]=q_,Z_[$_.CIRC_IN]=E_,Z_[$_.CIRC_OUT]=P_,Z_[$_.CIRC_IN_OUT]=I_,Z_[$_.CIRC_OUT_IN]=X_,Z_[$_.ELASTIC_IN]=R_,Z_[$_.ELASTIC_OUT]=D_,Z_[$_.ELASTIC_IN_OUT]=M_,Z_[$_.ELASTIC_OUT_IN]=Y_,Z_[$_.BACK_IN]=O_,Z_[$_.BACK_OUT]=B_,Z_[$_.BACK_IN_OUT]=N_,Z_[$_.BACK_OUT_IN]=K_,Z_[$_.BOUNCE_IN]=L_,Z_[$_.BOUNCE_OUT]=F_,Z_[$_.BOUNCE_IN_OUT]=z_,Z_[$_.BOUNCE_OUT_IN]=J_,Z_[$_.SMOOTH]=V_,Z_[$_.FADE]=k_,Z_);function cf(t){return sf[t]}var lf,uf,hf,_f=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).interpolationMode=il.LINEAR,e.tangentWeightMode=rl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=$_.LINEAR,e}return $(e,t),e}(ul);function ff(t){var e=new _f;if("number"==typeof t)e.value=t;else{var i=t.interpolationMode,n=t.tangentWeightMode,r=t.value,o=t.rightTangent,a=t.rightTangentWeight,s=t.leftTangent,c=t.leftTangentWeight,l=t.easingMethod,u=t[ll];e.value=null!=r?r:e.value,e.rightTangent=null!=o?o:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=s?s:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=i?i:e.interpolationMode,e.tangentWeightMode=null!=n?n:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,u&&(e[ll]=u)}return e}Ze.fastDefine("cc.RealKeyframeValue",_f,{interpolationMode:il.LINEAR,tangentWeightMode:rl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:$_.LINEAR}),Ze.Attr.setClassAttr(_f,ll,"editorOnly",!0),(lf=_f,null!==(hf=(uf=lf)[yc])&&void 0!==hf?hf:uf[yc]={}).uniquelyReferenced=!0;var pf,df=t("RealCurve",pc("cc.RealCurve")((af=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"preExtrapolation",rf,ot(e)),ct(e,"postExtrapolation",of,ot(e)),e}$(e,t);var i=e.prototype;return i.evaluate=function(t){var e=this._times,i=this._values,n=e.length;if(0===n)return 0;var r=e[0],o=e[n-1];if(t<r){var a=this.preExtrapolation,s=i[0];if(a===nl.CLAMP||n<2)return s.value;switch(a){case nl.LINEAR:return Df(r,i[0].value,e[1],i[1].value,t);case nl.LOOP:t=If(t,r,o);break;case nl.PING_PONG:t=Rf(t,r,o);break;default:return s.value}}else if(t>o){var c=this.postExtrapolation,l=i[n-1];if(c===nl.CLAMP||n<2)return l.value;switch(c){case nl.LINEAR:return Df(o,l.value,e[n-2],i[n-2].value,t);case nl.LOOP:t=If(t,r,o);break;case nl.PING_PONG:t=Rf(t,r,o);break;default:return l.value}}var u=oc(e,t);if(u>=0)return i[u].value;var h=~u,_=h-1,f=e[_],p=i[_],d=e[h];return function(t,e,i,n,r){var o=i-t;switch(e.interpolationMode){default:case il.CONSTANT:return e.value;case il.LINEAR:var a=e.easingMethod===$_.LINEAR?r:cf(e.easingMethod)(r);return ci(e.value,n.value,a);case il.CUBIC:var s=1/3,c=e.rightTangent,l=e.rightTangentWeight,u=0!=(e.tangentWeightMode&rl.RIGHT),h=n.leftTangent,_=n.leftTangentWeight,f=0!=(n.tangentWeightMode&rl.LEFT);if(u||f){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+t,y=Math.sin(v)*p+e.value,x=0;if(f)x=_;else{var S=o,b=o*h;x=Math.sqrt(S*S+b*b)*s}var C=Math.atan(h),A=(g-t)/o,T=(-Math.cos(C)*x+i-t)/o,w=y,E=-Math.sin(C)*x+n.value,P=[0,0,0],I=function(t,e,i,n,r){var o=i/n,a=e/n,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+t/n),u=c*c*c,h=l*l+u,_=0;if(sl(h)){if(sl(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*A,3*T-6*A,3*(A-T)+1,P),R=function(t,e,i){var n=i;if(1===e)n=t[0];else{n=-1/0;for(var r=0;r<e;++r){var o=t[r];o>=0&&o<=1&&o>n&&(n=o)}n===-1/0&&(n=0)}return n}(P,I,r);return Mf(e.value,w,E,n.value,R)}var D=e.value+s*c*o,M=n.value-s*h*o;return Mf(e.value,D,M,n.value,r)}}(f,p,d,i[h],(t-f)/(d-f))},i.addKeyFrame=function(e,i){return t.prototype.addKeyFrame.call(this,e,ff(i))},i.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return ff(t)})));else{var i=Array.from(t);this.setKeyframes(i.map((function(t){return t[0]})),i.map((function(t){return ff(t[1])})))}},i.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(i){return oi(i.value,e,t)}))},i[uh]=function(t,e){if(e.toCCON){var i=this._times,n=this._values,r=i.length,o=new DataView(new ArrayBuffer(0+mf+mf+vf+gf*r+wf*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=mf,o.setUint8(a,this.postExtrapolation),a+=mf,o.setUint32(a,r,!0),a+=vf,i.forEach((function(t,e){return o.setFloat32(a+gf*e,t,!0)})),a+=gf*r;for(var s,c=st(n);!(s=c()).done;){var l=s.value;a=Ef(o,l,a)}var u=new Uint8Array(o.buffer,0,a);t.writeProperty("bytes",u);var h=n.map((function(t){return t[ll]}));h.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",h)}else t.writeThis()},i[hh]=function(t,e){if(e.fromCCON){var i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength),r=0;this.preExtrapolation=n.getUint8(r),r+=mf,this.postExtrapolation=n.getUint8(r),r+=mf;var o=n.getUint32(r,!0);r+=vf;var a=Array.from({length:o},(function(t,e){return n.getFloat32(r+gf*e,!0)}));r+=gf*o;for(var s=new Array(o),c=0;c<o;++c){var l=ff({});r=Pf(n,l,r),s[c]=l}i.byteLength;var u=t.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(t,e){return s[e][ll]=t}))),this._times=a,this._values=s}else t.readThis()},e}(al),rf=lt((nf=af).prototype,"preExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nl.CLAMP}}),of=lt(nf.prototype,"postExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nl.CLAMP}}),ef=nf))||ef);!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(pf||(pf={}));var mf=1,vf=4,gf=4,yf=ff({}),xf=yf.interpolationMode,Sf=yf.tangentWeightMode,bf=yf.leftTangent,Cf=yf.leftTangentWeight,Af=yf.rightTangent,Tf=yf.rightTangentWeight,wf=26;function Ef(t,e,i){var n=0,r=i,o=r;r+=4;var a=e.value,s=e.interpolationMode,c=e.tangentWeightMode,l=e.rightTangent,u=e.rightTangentWeight,h=e.leftTangent,_=e.leftTangentWeight,f=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,s!==xf&&(n|=pf.INTERPOLATION_MODE,t.setUint8(r,s),r+=1),c!==Sf&&(n|=pf.TANGENT_WEIGHT_MODE,t.setUint8(r,c),r+=1),h!==bf&&(n|=pf.LEFT_TANGENT,t.setFloat32(r,h,!0),r+=4),_!==Cf&&(n|=pf.LEFT_TANGENT_WEIGHT,t.setFloat32(r,_,!0),r+=4),l!==Af&&(n|=pf.RIGHT_TANGENT,t.setFloat32(r,l,!0),r+=4),u!==Tf&&(n|=pf.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,u,!0),r+=4),n|=f<<8,t.setUint32(o,n,!0),r}function Pf(t,e,i){var n=i,r=t.getUint32(n,!0);n+=4,e.value=t.getFloat32(n,!0),n+=4,r&pf.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(n),n+=1),r&pf.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(n),n+=1),r&pf.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(n,!0),n+=4),r&pf.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(n,!0),n+=4),r&pf.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(n,!0),n+=4),r&pf.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(n,!0),n+=4);var o=(65280&r)>>8;return e.easingMethod=o,n}function If(t,e,i){return e+gi(t-e,i-e)}function Rf(t,e,i){return e+yi(t-e,i-e)}function Df(t,e,i,n,r){return e+(n-e)/(i-t)*(r-t)}function Mf(t,e,i,n,r){var o=1-r;return o*o*o*t+3*o*o*r*e+3*o*r*r*i+r*r*r*n}function Of(t,e,i,n,r){var o=1-r;return o*(o*(t+(3*e-t)*r)+3*i*r*r)+n*r*r*r}u.bezier=Of;var Bf,Nf,Lf,Ff,zf,Vf,kf,Uf,Gf,Hf,jf,Wf=Math.cos,qf=Math.acos,Xf=Math.max,Yf=2*Math.PI,Kf=Math.sqrt;function Jf(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Qf(t,e){var i=function(t,e){var i,n,r,o,a=e-0,s=e-t[0],c=3*a,l=3*s,u=3*(e-t[2]),h=1/(-a+l-u+(e-1)),_=1/3,f=(c-6*s+u)*h,p=f*_,d=(-c+l)*h,m=(3*d-f*f)*_,v=m*_,g=(2*f*f*f-9*f*d+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,b=Kf(S*S*S),C=-g/(2*b),A=qf(C<-1?-1:C>1?1:C),T=2*Jf(b);return n=T*Wf(A*_)-p,r=T*Wf((A+Yf)*_)-p,o=T*Wf((A+2*Yf)*_)-p,n>=0&&n<=1?r>=0&&r<=1?o>=0&&o<=1?Xf(n,r,o):Xf(n,r):o>=0&&o<=1?Xf(n,o):n:r>=0&&r<=1?o>=0&&o<=1?Xf(r,o):r:o}if(0===x)return r=-(i=y<0?Jf(-y):-Jf(y))-p,(n=2*i-p)>=0&&n<=1?r>=0&&r<=1?Xf(n,r):n:r;var w=Kf(x);return(i=Jf(-y+w))-Jf(y+w)-p}(t,e),n=t[1];return((1-i)*(n+(t[3]-n)*i)*3+i*i)*i}u.bezierByTime=Qf,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(jf||(jf=t("QuatInterpolationMode",{})));var Zf=pc("cc.QuatKeyframeValue")(Bf=Ac((Lf=lt((Nf=function(t){var e=void 0===t?{}:t,i=e.value,n=e.interpolationMode,r=e.easingMethod;ct(this,"interpolationMode",Lf,this),ct(this,"value",Ff,this),ct(this,"easingMethod",zf,this),this.value=i?Bi.clone(i):this.value,this.interpolationMode=null!=n?n:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jf.SLERP}}),Ff=lt(Nf.prototype,"value",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.clone(Bi.IDENTITY)}}),zf=lt(Nf.prototype,"easingMethod",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $_.LINEAR}}),Bf=Nf))||Bf)||Bf;function $f(t){return new Zf(t)}var tp,ep=t("QuatCurve",pc("cc.QuatCurve")((Hf=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"preExtrapolation",Uf,ot(e)),ct(e,"postExtrapolation",Gf,ot(e)),e}$(e,t);var i=e.prototype;return i.evaluate=function(t,e){var i;null!==(i=e)&&void 0!==i||(e=new Bi);var n=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=n.length;if(0===s)return e;var c=n[0],l=n[s-1];if(t<c){var u=r[0];switch(a){case nl.LOOP:t=c+gi(t-c,l-c);break;case nl.PING_PONG:t=c+yi(t-c,l-c);break;case nl.CLAMP:default:return Bi.copy(e,u.value)}}else if(t>l){var h=r[s-1];switch(o){case nl.LOOP:t=c+gi(t-c,l-c);break;case nl.PING_PONG:t=c+yi(t-c,l-c);break;case nl.CLAMP:default:return Bi.copy(e,h.value)}}var _=oc(n,t);if(_>=0)return Bi.copy(e,r[_].value);var f=~_,p=f-1,d=n[p],m=r[p],v=n[f],g=r[f],y=(t-d)/(v-d);switch(m.interpolationMode){default:case jf.CONSTANT:return Bi.copy(e,m.value);case jf.SLERP:var x=m.easingMethod,S=x===$_.LINEAR?y:Array.isArray(x)?Qf(x,y):cf(x)(y);return Bi.slerp(e,m.value,g.value,S)}},i.addKeyFrame=function(e,i){var n=new Zf(i);return t.prototype.addKeyFrame.call(this,e,n)},i.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return $f(t)})));else{var i=Array.from(t);this.setKeyframes(i.map((function(t){return t[0]})),i.map((function(t){return $f(t[1])})))}},i[uh]=function(t,e){if(e.toCCON){var i=this._times,n=this._values,r=!0;n.forEach((function(t,e,i){var n=i[0];r&&t.interpolationMode!==n.interpolationMode&&(r=!1)}));var o=i.length,a=_p*(r?1:o),s=n.reduce((function(t,e){var i=e.easingMethod;return t+(Array.isArray(i)?fp+4*dp:fp)}),0),c=0,l=new DataView(new ArrayBuffer(c+=cp+lp+up*o+4*hp*o+s+a+0)),u=0,h=0;r&&(h|=tp.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=cp,l.setUint32(u,o,!0),u+=lp,i.forEach((function(t,e){return l.setFloat32(u+up*e,t,!0)})),u+=up*o,n.forEach((function(t,e){var i=t.value,n=i.x,r=i.y,o=i.z,a=i.w,s=u+4*hp*e;l.setFloat32(s+0*hp,n,!0),l.setFloat32(s+1*hp,r,!0),l.setFloat32(s+2*hp,o,!0),l.setFloat32(s+3*hp,a,!0)})),u+=4*hp*o,n.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(l.setUint8(u,pp),++u,l.setFloat32(u+0*dp,e[0],!0),l.setFloat32(u+1*dp,e[1],!0),l.setFloat32(u+2*dp,e[2],!0),l.setFloat32(u+3*dp,e[3],!0),u+=4*dp):(l.setUint8(u,e),++u)}));var _=u;u+=a;var f=_;n.forEach((function(t){var e=t.interpolationMode;l.setUint8(f,e),r||(f+=_p)}));var p=new Uint8Array(l.buffer);t.writeProperty("bytes",p)}else t.writeThis()},i[hh]=function(t,e){if(e.fromCCON){var i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength),r=0,o=n.getUint32(r,!0);r+=cp;var a=o&tp.INTERPOLATION_MODE,s=n.getUint32(r,!0);r+=lp;var c=Array.from({length:s},(function(t,e){return n.getFloat32(r+up*e,!0)})),l=r+=up*s;r+=4*hp*s;var u=Array.from({length:s},(function(t,e){var i=l+4*hp*e,o=n.getFloat32(i+0*hp,!0),a=n.getFloat32(i+1*hp,!0),s=n.getFloat32(i+2*hp,!0),c=n.getFloat32(i+3*hp,!0),u=n.getUint8(r);++r;var h=$f({value:{x:o,y:a,z:s,w:c}});return u!==pp?h.easingMethod=u:(h.easingMethod=[n.getFloat32(r+0*dp,!0),n.getFloat32(r+1*dp,!0),n.getFloat32(r+2*dp,!0),n.getFloat32(r+3*dp,!0)],r+=4*dp),h}));if(a){var h=n.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var p=n.getUint8(r+f);u[f].interpolationMode=p}r+=s}this._times=c,this._values=u}else t.readThis()},e}(al),Uf=lt((kf=Hf).prototype,"preExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nl.CLAMP}}),Gf=lt(kf.prototype,"postExtrapolation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nl.CLAMP}}),Vf=kf))||Vf);!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(tp||(tp={}));var ip,np,rp,op,ap,sp,cp=1,lp=4,up=4,hp=4,_p=1,fp=1,pp=255,dp=4,mp=t("ObjectCurve",pc("cc.ObjectCurve")(ip=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var i=ai(~e-1,0,this._values.length-1);return this._values[i]},e}(al))||ip),vp=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Ze.fastDefine("cc.Keyframe",vp,{time:0,value:0,inTangent:0,outTangent:0});var gp=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,i=this.coefficient,e*(e*(e*i[0]+i[1])+i[2])+i[3];var e,i},t}(),yp=pc("cc.AnimationCurve")((sp=ap=function(){function t(t){if(void 0===t&&(t=null),ct(this,"_curve",op,this),this.cachedKey=void 0,t instanceof df)this._curve=t;else{var e=new df;this._curve=e,e.preExtrapolation=nl.LOOP,e.postExtrapolation=nl.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:il.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:il.CUBIC,value:1}],[1,{interpolationMode:il.CUBIC,value:1}]])}this.cachedKey=new gp}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:il.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,i=this._curve,n=i.keyFramesCount-1,r=t,o=t<0?i.preExtrapolation:i.postExtrapolation,a=i.getKeyframeTime(0),s=i.getKeyframeTime(n);switch(o){case nl.LOOP:r=gi(t-a,s-a)+a;break;case nl.PING_PONG:r=yi(t-a,s-a)+a;break;case nl.CLAMP:default:r=ai(t,a,s)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var c=this.findIndex(e,r),l=Math.min(c+1,n);return this.calcOptimizedKey(e,c,l),e.evaluate(r)},e.calcOptimizedKey=function(t,e,i){var n=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(i),o=this._curve.getKeyframeValue(e),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(i),l=c.value,u=c.rightTangent;t.index=e,t.time=n,t.endTime=r;var h=r-n,_=l-a,f=1/(h*h),p=s*h,d=u*h;t.coefficient[0]=(p+d-_-_)*f/h,t.coefficient[1]=(_+_+_-p-p-d)*f,t.coefficient[2]=s,t.coefficient[3]=a},e.findIndex=function(t,e){var i=this._curve,n=i.keyFramesCount,r=t.index;if(-1!==r)if(e>i.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<n&&i.getKeyframeTime(a+1)>e)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&i.getKeyframeTime(c-1)<=e)return c-1}for(var l,u=0,h=n;h-u>1;)l=Math.floor((u+h)/2),i.getKeyframeTime(l)>=e?h=l:u=l;return u},Q(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],i=t[1],n=new vp;return n.time=e,n.value=i.value,n.inTangent=i.leftTangent,n.outTangent=i.rightTangent,n}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:il.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return Sp(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=xp(t)}},{key:"postWrapMode",get:function(){return Sp(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=xp(t)}}]),t}(),ap.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],op=lt((rp=sp).prototype,"_curve",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),np=rp))||np;function xp(t){switch(t){default:case Zs.Default:case Zs.Normal:case Zs.Clamp:return nl.CLAMP;case Zs.PingPong:return nl.PING_PONG;case Zs.Loop:return nl.LOOP}}function Sp(t){switch(t){default:case nl.LINEAR:case nl.CLAMP:return Zs.Clamp;case nl.PING_PONG:return Zs.PingPong;case nl.LOOP:return Zs.Loop}}function bp(){var t=new df;return t.assignSorted([[0,{interpolationMode:il.CUBIC,value:1}],[1,{interpolationMode:il.CUBIC,value:1}]]),t}function Cp(t,e){console.warn(t+" is deprecated, please use "+e+" instead.")}k(hs,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Ap=function(t){function e(){var e;return e=t.call(this)||this,Cp("line","Line"),e}return $(e,t),e}($o),Tp=function(t){function e(){var e;return e=t.call(this)||this,Cp("plane","Plane"),e}return $(e,t),e}(Cs),wp=function(t){function e(){var e;return e=t.call(this)||this,Cp("ray","Ray"),e}return $(e,t),e}(ta),Ep=function(t){function e(){var e;return e=t.call(this)||this,Cp("triangle","Triangle"),e}return $(e,t),e}(ca),Pp=function(t){function e(){var e;return e=t.call(this)||this,Cp("sphere","Sphere"),e}return $(e,t),e}(sa),Ip=function(t){function e(){var e;return e=t.call(this)||this,Cp("aabb","AABB"),e}return $(e,t),e}(Ws),Rp=function(t){function e(){var e;return e=t.call(this)||this,Cp("obb","OBB"),e}return $(e,t),e}(Ks),Dp=function(t){function e(){var e;return e=t.call(this)||this,Cp("capsule","Capsule"),e}return $(e,t),e}(Js),Mp=function(t){function e(){var e;return e=t.call(this)||this,Cp("frustum","Frustum"),e}return $(e,t),e}(nc),Op=Object.freeze({__proto__:null,distance:Qo,enums:Zo,intersect:hs,Line:$o,Plane:Cs,Ray:ta,Triangle:ca,Sphere:sa,AABB:Ws,OBB:Ks,Capsule:Js,Frustum:nc,Keyframe:vp,AnimationCurve:yp,get ERaycastMode(){return aa},line:Ap,plane:Tp,ray:wp,triangle:Ep,sphere:Pp,aabb:Ip,obb:Rp,capsule:Dp,frustum:Mp});t("geometry",Op);var Bp={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Np=t("Layers",function(){function t(){}return t.makeMaskInclude=function(t){for(var e,i=0,n=st(t);!(e=n()).done;)i|=e.value;return i},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,i){if(void 0!==i)if(i>19||i<0)console.warn("maximum layers reached.");else{var n=1<<i;t.Enum[e],F(2104,e),t.Enum[e]=n,ne.value(t.Enum,String(n),e),t.BitMask[e]=n,ne.value(t.BitMask,String(n),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var i=1<<e;delete t.Enum[t.Enum[i]],delete t.Enum[i],delete t.BitMask[t.BitMask[i]],delete t.BitMask[i]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):r(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());Np.Enum=oe(Bp),Np.BitMask=re(Z({},Bp)),u.Layers=Np;var Lp,Fp,zp="MainFlow",Vp="ForwardFlow",kp="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Lp||(Lp={})),u.RenderPassStage=Lp,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Fp||(Fp={}));var Up,Gp={bindings:[],layouts:{}},Hp={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(Up||(Up={}));var jp,Wp=Up.SAMPLER_SHADOWMAP,qp=Up.COUNT-Wp;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(jp||(jp={}));var Xp,Yp=jp.SAMPLER_JOINTS,Kp=jp.COUNT-Yp;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(Xp||(Xp={}));var Jp=new cr;Jp.bufferOffsets=[0,Wp+Yp,Wp],Jp.samplerOffsets=[-Wp,qp+Kp,qp-Yp],Jp.flexibleSet=1;var Qp=function(){};Qp.SIZE=4*(Qp.COUNT=4+(Qp.SCREEN_SIZE_OFFSET=4+(Qp.NATIVE_SIZE_OFFSET=4+(Qp.TIME_OFFSET=0)))),Qp.NAME="CCGlobal",Qp.BINDING=Up.UBO_GLOBAL,Qp.DESCRIPTOR=new Vr(Qp.BINDING,Hn.UNIFORM_BUFFER,1,Dn.ALL),Qp.LAYOUT=new xr(Xp.GLOBAL,Qp.BINDING,Qp.NAME,[new yr("cc_time",pn.FLOAT4,1),new yr("cc_screenSize",pn.FLOAT4,1),new yr("cc_nativeSize",pn.FLOAT4,1)],1),Gp.layouts[Qp.NAME]=Qp.LAYOUT,Gp.bindings[Qp.BINDING]=Qp.DESCRIPTOR;var Zp=function(){};Zp.SIZE=4*(Zp.COUNT=4+(Zp.VIEW_PORT_OFFSET=4+(Zp.NEAR_FAR_OFFSET=4+(Zp.GLOBAL_FOG_ADD_OFFSET=4+(Zp.GLOBAL_FOG_BASE_OFFSET=4+(Zp.GLOBAL_FOG_COLOR_OFFSET=4+(Zp.AMBIENT_GROUND_OFFSET=4+(Zp.AMBIENT_SKY_OFFSET=4+(Zp.MAIN_LIT_COLOR_OFFSET=4+(Zp.MAIN_LIT_DIR_OFFSET=4+(Zp.EXPOSURE_OFFSET=4+(Zp.SCREEN_SCALE_OFFSET=4+(Zp.CAMERA_POS_OFFSET=16+(Zp.MAT_VIEW_PROJ_INV_OFFSET=16+(Zp.MAT_VIEW_PROJ_OFFSET=16+(Zp.MAT_PROJ_INV_OFFSET=16+(Zp.MAT_PROJ_OFFSET=16+(Zp.MAT_VIEW_INV_OFFSET=16+(Zp.MAT_VIEW_OFFSET=0))))))))))))))))))),Zp.NAME="CCCamera",Zp.BINDING=Up.UBO_CAMERA,Zp.DESCRIPTOR=new Vr(Zp.BINDING,Hn.UNIFORM_BUFFER,1,Dn.ALL),Zp.LAYOUT=new xr(Xp.GLOBAL,Zp.BINDING,Zp.NAME,[new yr("cc_matView",pn.MAT4,1),new yr("cc_matViewInv",pn.MAT4,1),new yr("cc_matProj",pn.MAT4,1),new yr("cc_matProjInv",pn.MAT4,1),new yr("cc_matViewProj",pn.MAT4,1),new yr("cc_matViewProjInv",pn.MAT4,1),new yr("cc_cameraPos",pn.FLOAT4,1),new yr("cc_screenScale",pn.FLOAT4,1),new yr("cc_exposure",pn.FLOAT4,1),new yr("cc_mainLitDir",pn.FLOAT4,1),new yr("cc_mainLitColor",pn.FLOAT4,1),new yr("cc_ambientSky",pn.FLOAT4,1),new yr("cc_ambientGround",pn.FLOAT4,1),new yr("cc_fogColor",pn.FLOAT4,1),new yr("cc_fogBase",pn.FLOAT4,1),new yr("cc_fogAdd",pn.FLOAT4,1),new yr("cc_nearFar",pn.FLOAT4,1),new yr("cc_viewPort",pn.FLOAT4,1)],1),Gp.layouts[Zp.NAME]=Zp.LAYOUT,Gp.bindings[Zp.BINDING]=Zp.DESCRIPTOR;var $p=function(){};$p.SIZE=4*($p.COUNT=4+($p.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+($p.SHADOW_COLOR_OFFSET=4+($p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+($p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+($p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+($p.SHADOW_PROJ_INFO_OFFSET=4+($p.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+($p.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+($p.MAT_LIGHT_VIEW_PROJ_OFFSET=16+($p.MAT_LIGHT_VIEW_OFFSET=16+($p.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),$p.NAME="CCShadow",$p.BINDING=Up.UBO_SHADOW,$p.DESCRIPTOR=new Vr($p.BINDING,Hn.UNIFORM_BUFFER,1,Dn.ALL),$p.LAYOUT=new xr(Xp.GLOBAL,$p.BINDING,$p.NAME,[new yr("cc_matLightPlaneProj",pn.MAT4,1),new yr("cc_matLightView",pn.MAT4,1),new yr("cc_matLightViewProj",pn.MAT4,1),new yr("cc_shadowInvProjDepthInfo",pn.FLOAT4,1),new yr("cc_shadowProjDepthInfo",pn.FLOAT4,1),new yr("cc_shadowProjInfo",pn.FLOAT4,1),new yr("cc_shadowNFLSInfo",pn.FLOAT4,1),new yr("cc_shadowWHPBInfo",pn.FLOAT4,1),new yr("cc_shadowLPNNInfo",pn.FLOAT4,1),new yr("cc_shadowColor",pn.FLOAT4,1),new yr("cc_planarNDInfo",pn.FLOAT4,1)],1),Gp.layouts[$p.NAME]=$p.LAYOUT,Gp.bindings[$p.BINDING]=$p.DESCRIPTOR;var td=Up.SAMPLER_SHADOWMAP,ed=new Vr(td,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),id=new Sr(Xp.GLOBAL,td,"cc_shadowMap",pn.SAMPLER2D,1);Gp.layouts.cc_shadowMap=id,Gp.bindings[td]=ed;var nd=Up.SAMPLER_ENVIRONMENT,rd=new Vr(nd,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),od=new Sr(Xp.GLOBAL,nd,"cc_environment",pn.SAMPLER_CUBE,1);Gp.layouts.cc_environment=od,Gp.bindings[nd]=rd;var ad=Up.SAMPLER_DIFFUSEMAP,sd=new Vr(ad,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),cd=new Sr(Xp.GLOBAL,ad,"cc_diffuseMap",pn.SAMPLER_CUBE,1);Gp.layouts.cc_diffuseMap=cd,Gp.bindings[ad]=sd;var ld=Up.SAMPLER_SPOT_LIGHTING_MAP,ud=new Vr(ld,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),hd=new Sr(Xp.GLOBAL,ld,"cc_spotLightingMap",pn.SAMPLER2D,1);Gp.layouts.cc_spotLightingMap=hd,Gp.bindings[ld]=ud;var _d=function(){};_d.SIZE=4*(_d.COUNT=4+(_d.LIGHTINGMAP_UVPARAM=16+(_d.MAT_WORLD_IT_OFFSET=16+(_d.MAT_WORLD_OFFSET=0)))),_d.NAME="CCLocal",_d.BINDING=jp.UBO_LOCAL,_d.DESCRIPTOR=new Vr(_d.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX|Dn.COMPUTE),_d.LAYOUT=new xr(Xp.LOCAL,_d.BINDING,_d.NAME,[new yr("cc_matWorld",pn.MAT4,1),new yr("cc_matWorldIT",pn.MAT4,1),new yr("cc_lightingMapUVParam",pn.FLOAT4,1)],1),Hp.layouts[_d.NAME]=_d.LAYOUT,Hp.bindings[_d.BINDING]=_d.DESCRIPTOR;var fd=function(){};fd.SIZE=4*(fd.COUNT=4+(fd.WORLD_BOUND_HALF_EXTENTS=4+(fd.WORLD_BOUND_CENTER=0))),fd.NAME="CCWorldBound",fd.BINDING=jp.UBO_LOCAL,fd.DESCRIPTOR=new Vr(fd.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX|Dn.COMPUTE),fd.LAYOUT=new xr(Xp.LOCAL,fd.BINDING,fd.NAME,[new yr("cc_worldBoundCenter",pn.FLOAT4,1),new yr("cc_worldBoundHalfExtents",pn.FLOAT4,1)],1),Hp.layouts[fd.NAME]=fd.LAYOUT,Hp.bindings[fd.BINDING]=fd.DESCRIPTOR;var pd="a_matWorld0",dd=function(){};dd.BATCHING_COUNT=10,dd.MAT_WORLDS_OFFSET=0,dd.SIZE=4*(dd.COUNT=16*dd.BATCHING_COUNT),dd.NAME="CCLocalBatched",dd.BINDING=jp.UBO_LOCAL,dd.DESCRIPTOR=new Vr(dd.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX|Dn.COMPUTE),dd.LAYOUT=new xr(Xp.LOCAL,dd.BINDING,dd.NAME,[new yr("cc_matWorlds",pn.MAT4,dd.BATCHING_COUNT)],1),Hp.layouts[dd.NAME]=dd.LAYOUT,Hp.bindings[dd.BINDING]=dd.DESCRIPTOR;var md=function(){};md.LIGHTS_PER_PASS=1,md.SIZE=4*(md.COUNT=(md.LIGHT_DIR_OFFSET=(md.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(md.LIGHT_COLOR_OFFSET=(md.LIGHT_POS_OFFSET=0)+4*md.LIGHTS_PER_PASS)+4*md.LIGHTS_PER_PASS)+4*md.LIGHTS_PER_PASS)+4*md.LIGHTS_PER_PASS),md.NAME="CCForwardLight",md.BINDING=jp.UBO_FORWARD_LIGHTS,md.DESCRIPTOR=new Vr(md.BINDING,Hn.DYNAMIC_UNIFORM_BUFFER,1,Dn.FRAGMENT),md.LAYOUT=new xr(Xp.LOCAL,md.BINDING,md.NAME,[new yr("cc_lightPos",pn.FLOAT4,md.LIGHTS_PER_PASS),new yr("cc_lightColor",pn.FLOAT4,md.LIGHTS_PER_PASS),new yr("cc_lightSizeRangeAngle",pn.FLOAT4,md.LIGHTS_PER_PASS),new yr("cc_lightDir",pn.FLOAT4,md.LIGHTS_PER_PASS)],1),Hp.layouts[md.NAME]=md.LAYOUT,Hp.bindings[md.BINDING]=md.DESCRIPTOR;var vd=function(){};vd.LIGHTS_PER_PASS=10;var gd=function(){};gd.SIZE=4*(gd.COUNT=4+(gd.JOINTS_TEXTURE_INFO_OFFSET=0)),gd.NAME="CCSkinningTexture",gd.BINDING=jp.UBO_SKINNING_TEXTURE,gd.DESCRIPTOR=new Vr(gd.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX),gd.LAYOUT=new xr(Xp.LOCAL,gd.BINDING,gd.NAME,[new yr("cc_jointTextureInfo",pn.FLOAT4,1)],1),Hp.layouts[gd.NAME]=gd.LAYOUT,Hp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd=function(){};yd.SIZE=4*(yd.COUNT=4+(yd.JOINTS_ANIM_INFO_OFFSET=0)),yd.NAME="CCSkinningAnimation",yd.BINDING=jp.UBO_SKINNING_ANIMATION,yd.DESCRIPTOR=new Vr(yd.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX),yd.LAYOUT=new xr(Xp.LOCAL,yd.BINDING,yd.NAME,[new yr("cc_jointAnimInfo",pn.FLOAT4,1)],1),Hp.layouts[yd.NAME]=yd.LAYOUT,Hp.bindings[yd.BINDING]=yd.DESCRIPTOR;var xd="a_jointAnimInfo",Sd=function(){};Sd.SIZE=4*(Sd.COUNT=360+(Sd.JOINTS_OFFSET=0)),Sd.NAME="CCSkinning",Sd.BINDING=jp.UBO_SKINNING_TEXTURE,Sd.DESCRIPTOR=new Vr(Sd.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX),Sd.LAYOUT=new xr(Xp.LOCAL,Sd.BINDING,Sd.NAME,[new yr("cc_joints",pn.FLOAT4,90)],1),Hp.layouts[Sd.NAME]=Sd.LAYOUT,Hp.bindings[Sd.BINDING]=Sd.DESCRIPTOR;var bd=function(){};bd.MAX_MORPH_TARGET_COUNT=60,bd.OFFSET_OF_WEIGHTS=0,bd.OFFSET_OF_VERTICES_COUNT=4+(bd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(bd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*bd.MAX_MORPH_TARGET_COUNT)),bd.COUNT_BASE_4_BYTES=4*Math.ceil(bd.MAX_MORPH_TARGET_COUNT/4)+4,bd.SIZE=4*bd.COUNT_BASE_4_BYTES,bd.NAME="CCMorph",bd.BINDING=jp.UBO_MORPH,bd.DESCRIPTOR=new Vr(bd.BINDING,Hn.UNIFORM_BUFFER,1,Dn.VERTEX),bd.LAYOUT=new xr(Xp.LOCAL,bd.BINDING,bd.NAME,[new yr("cc_displacementWeights",pn.FLOAT4,bd.MAX_MORPH_TARGET_COUNT/4),new yr("cc_displacementTextureInfo",pn.FLOAT4,1)],1),Hp.layouts[bd.NAME]=bd.LAYOUT,Hp.bindings[bd.BINDING]=bd.DESCRIPTOR;var Cd=function(){};Cd.NAME="CCUILocal",Cd.BINDING=jp.UBO_UI_LOCAL,Cd.DESCRIPTOR=new Vr(Cd.BINDING,Hn.DYNAMIC_UNIFORM_BUFFER,1,Dn.VERTEX),Cd.LAYOUT=new xr(Xp.LOCAL,Cd.BINDING,Cd.NAME,[new yr("cc_local_data",pn.FLOAT4,1)],1),Hp.layouts[Cd.NAME]=Cd.LAYOUT,Hp.bindings[Cd.BINDING]=Cd.DESCRIPTOR;var Ad=jp.SAMPLER_JOINTS,Td=new Vr(Ad,Hn.SAMPLER_TEXTURE,1,Dn.VERTEX),wd=new Sr(Xp.LOCAL,Ad,"cc_jointTexture",pn.SAMPLER2D,1);Hp.layouts.cc_jointTexture=wd,Hp.bindings[Ad]=Td;var Ed=jp.SAMPLER_MORPH_POSITION,Pd=new Vr(Ed,Hn.SAMPLER_TEXTURE,1,Dn.VERTEX),Id=new Sr(Xp.LOCAL,Ed,"cc_PositionDisplacements",pn.SAMPLER2D,1);Hp.layouts.cc_PositionDisplacements=Id,Hp.bindings[Ed]=Pd;var Rd=jp.SAMPLER_MORPH_NORMAL,Dd=new Vr(Rd,Hn.SAMPLER_TEXTURE,1,Dn.VERTEX),Md=new Sr(Xp.LOCAL,Rd,"cc_NormalDisplacements",pn.SAMPLER2D,1);Hp.layouts.cc_NormalDisplacements=Md,Hp.bindings[Rd]=Dd;var Od=jp.SAMPLER_MORPH_TANGENT,Bd=new Vr(Od,Hn.SAMPLER_TEXTURE,1,Dn.VERTEX),Nd=new Sr(Xp.LOCAL,Od,"cc_TangentDisplacements",pn.SAMPLER2D,1);Hp.layouts.cc_TangentDisplacements=Nd,Hp.bindings[Od]=Bd;var Ld=jp.SAMPLER_LIGHTMAP,Fd=new Vr(Ld,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),zd=new Sr(Xp.LOCAL,Ld,"cc_lightingMap",pn.SAMPLER2D,1);Hp.layouts.cc_lightingMap=zd,Hp.bindings[Ld]=Fd;var Vd=jp.SAMPLER_SPRITE,kd=new Vr(Vd,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),Ud=new Sr(Xp.LOCAL,Vd,"cc_spriteTexture",pn.SAMPLER2D,1);Hp.layouts.cc_spriteTexture=Ud,Hp.bindings[Vd]=kd;var Gd=jp.SAMPLER_REFLECTION,Hd=new Vr(Gd,Hn.SAMPLER_TEXTURE,1,Dn.FRAGMENT),jd=new Sr(Xp.LOCAL,Gd,"cc_reflectionTexture",pn.SAMPLER2D,1);Hp.layouts.cc_reflectionTexture=jd,Hp.bindings[Gd]=Hd;var Wd=jp.STORAGE_REFLECTION,qd=new Vr(Wd,Hn.STORAGE_IMAGE,1,Dn.COMPUTE),Xd=new Ar(Xp.LOCAL,Wd,"cc_reflectionStorage",pn.IMAGE2D,1);Hp.layouts.cc_reflectionStorage=Xd,Hp.bindings[Wd]=qd;var Yd,Kd,Jd=Np.makeMaskExclude([Np.BitMask.UI_2D,Np.BitMask.GIZMOS,Np.BitMask.EDITOR,Np.BitMask.SCENE_GIZMO,Np.BitMask.PROFILER]),Qd=Np.makeMaskExclude([Np.BitMask.UI_2D,Np.BitMask.PROFILER]),Zd=Np.Enum.ALL;function $d(t){return t.hasFeature(hn.COLOR_FLOAT)&&t.hasFeature(hn.TEXTURE_FLOAT)&&!(t.gfxAPI===ln.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:zp,PIPELINE_FLOW_FORWARD:Vp,PIPELINE_FLOW_SHADOW:kp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Lp},get RenderPriority(){return Fp},globalDescriptorSetLayout:Gp,localDescriptorSetLayout:Hp,get PipelineGlobalBindings(){return Up},get ModelLocalBindings(){return jp},get SetIndex(){return Xp},bindingMappingInfo:Jp,UBOGlobal:Qp,UBOCamera:Zp,UBOShadow:$p,UNIFORM_SHADOWMAP_BINDING:td,UNIFORM_ENVIRONMENT_BINDING:nd,UNIFORM_DIFFUSEMAP_BINDING:ad,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:ld,UBOLocal:_d,UBOWorldBound:fd,INST_MAT_WORLD:pd,UBOLocalBatched:dd,UBOForwardLight:md,UBODeferredLight:vd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:gd,UBOSkinningAnimation:yd,INST_JOINT_ANIM_INFO:xd,UBOSkinning:Sd,UBOMorph:bd,UBOUILocal:Cd,UNIFORM_JOINT_TEXTURE_BINDING:Ad,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Ed,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Rd,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Od,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Ld,UNIFORM_SPRITE_TEXTURE_BINDING:Vd,UNIFORM_REFLECTION_TEXTURE_BINDING:Gd,UNIFORM_REFLECTION_STORAGE_BINDING:Wd,CAMERA_DEFAULT_MASK:Jd,CAMERA_EDITOR_MASK:Qd,MODEL_ALWAYS_MASK:Zd,supportsHalfFloatTexture:function(t){return t.hasFeature(hn.COLOR_HALF_FLOAT)&&t.hasFeature(hn.TEXTURE_HALF_FLOAT)&&!(t.gfxAPI===ln.WEBGL)},supportsFloatTexture:$d}));var tm=4227858432,em=66060288,im=1044480,nm=function(t,e,i,n){return void 0===n&&(n=0),e<<26&tm|t<<20&em|i<<12&im|4095&n},rm=function(t){return(t&tm)>>>26},om=function(t){return(t&em)>>>20},am=function(t){return(t&im)>>>12},sm=function(t){return 4095&t},cm=function(t,e){return 67108863&t|e<<26&tm},lm=((Yd={})[pn.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Yd[pn.INT]=function(t,e,i){return void 0===i&&(i=0),t[i]},Yd[pn.INT2]=function(t,e,i){return void 0===i&&(i=0),qi.fromArray(e,t,i)},Yd[pn.INT3]=function(t,e,i){return void 0===i&&(i=0),Ei.fromArray(e,t,i)},Yd[pn.INT4]=function(t,e,i){return void 0===i&&(i=0),Ji.fromArray(e,t,i)},Yd[pn.FLOAT]=function(t,e,i){return void 0===i&&(i=0),t[i]},Yd[pn.FLOAT2]=function(t,e,i){return void 0===i&&(i=0),qi.fromArray(e,t,i)},Yd[pn.FLOAT3]=function(t,e,i){return void 0===i&&(i=0),Ei.fromArray(e,t,i)},Yd[pn.FLOAT4]=function(t,e,i){return void 0===i&&(i=0),Ji.fromArray(e,t,i)},Yd[pn.MAT3]=function(t,e,i){return void 0===i&&(i=0),Di.fromArray(e,t,i)},Yd[pn.MAT4]=function(t,e,i){return void 0===i&&(i=0),Gi.fromArray(e,t,i)},Yd),um=((Kd={})[pn.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Kd[pn.INT]=function(t,e,i){return void 0===i&&(i=0),t[i]=e},Kd[pn.INT2]=function(t,e,i){return void 0===i&&(i=0),qi.toArray(t,e,i)},Kd[pn.INT3]=function(t,e,i){return void 0===i&&(i=0),Ei.toArray(t,e,i)},Kd[pn.INT4]=function(t,e,i){return void 0===i&&(i=0),Ji.toArray(t,e,i)},Kd[pn.FLOAT]=function(t,e,i){return void 0===i&&(i=0),t[i]=e},Kd[pn.FLOAT2]=function(t,e,i){return void 0===i&&(i=0),qi.toArray(t,e,i)},Kd[pn.FLOAT3]=function(t,e,i){return void 0===i&&(i=0),Ei.toArray(t,e,i)},Kd[pn.FLOAT4]=function(t,e,i){return void 0===i&&(i=0),Ji.toArray(t,e,i)},Kd[pn.MAT3]=function(t,e,i){return void 0===i&&(i=0),Di.toArray(t,e,i)},Kd[pn.MAT4]=function(t,e,i){return void 0===i&&(i=0),Gi.toArray(t,e,i)},Kd),hm=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function _m(t){switch(t){case pn.BOOL:case pn.INT:case pn.UINT:case pn.FLOAT:return hm[0];case pn.BOOL2:case pn.INT2:case pn.UINT2:case pn.FLOAT2:return hm[1];case pn.BOOL4:case pn.INT4:case pn.UINT4:case pn.FLOAT4:return hm[2];case pn.MAT4:return hm[3];case pn.SAMPLER2D:return"default-texture";case pn.SAMPLER_CUBE:return"default-cube-texture"}return hm[0]}function fm(t,e){for(var i=Object.entries(e),n=!1,r=0;r<i.length;r++)t[i[r][0]]!==i[r][1]&&(t[i[r][0]]=i[r][1],n=!0);return n}var pm=new kr;function dm(t){return Math.ceil(Math.log2(Math.max(t,2)))}function mm(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function vm(t,e,i,n,r){for(var o=t.builtins[n],a=[],s=function(t){var e=o.blocks[t],n=i.layouts[e.name],s=n&&i.bindings.find((function(t){return t.binding===n.binding}));if(!(n&&s&&s.descriptorType&$r))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(n),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var l=[],u=function(t){var e=o.samplerTextures[t],n=i.layouts[e.name],a=n&&i.bindings.find((function(t){return t.binding===n.binding}));if(!(n&&a&&a.descriptorType&to))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";l.push(n),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,l),r&&r.sort((function(t,e){return t.binding-e.binding}))}function gm(t){return t.members.reduce((function(t,e){return t+so(e.type)*e.count}),0)}function ym(t,e){for(var i=0;i<t.length;i++){var n=t[i];if("!"===n[0]){if(e[n.slice(1)])return!1}else if(!e[n])return!1}return!0}function xm(t){switch(t.gfxAPI){case ln.GLES2:case ln.WEBGL:return"glsl1";case ln.GLES3:case ln.WEBGL2:return"glsl3";default:return"glsl4"}}var Sm,bm,Cm,Am,Tm,wm,Em,Pm,Im=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var i=0;i<t.techniques.length;i++)for(var n=t.techniques[i],r=0;r<n.passes.length;r++){var o=n.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=n.passes[o.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var i=Z({},t),n=0,r=function(t){var e=i.defines[t],r=1;if("number"===e.type){var o=e.range;r=dm(o[1]-o[0]+1),e._map=function(t){return t-o[0]}}else"string"===e.type?(r=dm(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=n,n+=r},o=0;o<i.defines.length;o++)r(o);for(var a in n>31&&(i.uber=!0),i.constantMacros="",i.builtins.statistics)i.constantMacros+="#define "+a+" "+i.builtins.statistics[a]+"\n";if(this._templates[t.name]=i,!this._templateInfos[i.hash]){var s={};s.samplerStartBinding=i.blocks.length,s.shaderInfo=new Ir,s.blockSizes=[],s.bindings=[];for(var c=0;c<i.blocks.length;c++){var l=i.blocks[c];s.blockSizes.push(gm(l)),s.bindings.push(new Vr(l.binding,Hn.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new xr(Xp.MATERIAL,l.binding,l.name,l.members.map((function(t){return new yr(t.name,t.type,t.count)})),1))}for(var u=0;u<i.samplerTextures.length;u++){var h=i.samplerTextures[u];s.bindings.push(new Vr(h.binding,Hn.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Sr(Xp.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<i.samplers.length;_++){var f=i.samplers[_];s.bindings.push(new Vr(f.binding,Hn.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new br(Xp.MATERIAL,f.binding,f.name,f.count))}for(var p=0;p<i.textures.length;p++){var d=i.textures[p];s.bindings.push(new Vr(d.binding,Hn.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new Cr(Xp.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<i.buffers.length;m++){var v=i.buffers[m];s.bindings.push(new Vr(v.binding,Hn.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Tr(Xp.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<i.images.length;g++){var y=i.images[g];s.bindings.push(new Vr(y.binding,Hn.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Ar(Xp.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<i.subpassInputs.length;x++){var S=i.subpassInputs[x];s.bindings.push(new Vr(S.binding,Hn.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new wr(Xp.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var b=0;b<i.attributes.length;b++){var C=i.attributes[b];s.gfxAttributes.push(new Pr(C.name,C.format,C.isNormalized,0,C.isInstanced,C.location))}vm(i,s,Hp,"locals"),s.shaderInfo.stages.push(new Er(Dn.VERTEX,"")),s.shaderInfo.stages.push(new Er(Dn.FRAGMENT,"")),s.handleMap=function(t){for(var e={},i=0;i<t.blocks.length;i++)for(var n=t.blocks[i],r=n.members,o=0,a=0;a<r.length;a++){var s=r[a];e[s.name]=nm(n.binding,s.type,s.count,o),o+=(so(s.type)>>2)*s.count}for(var c=0;c<t.samplerTextures.length;c++){var l=t.samplerTextures[c];e[l.name]=nm(l.binding,l.type,l.count)}return e}(i),s.setLayouts=[],this._templateInfos[i.hash]=s}return i},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,i){void 0===i&&(i=!1);var n=this._templates[e],r=this._templateInfos[n.hash];return r.setLayouts.length||(pm.bindings=r.bindings,r.setLayouts[Xp.MATERIAL]=t.createDescriptorSetLayout(pm),pm.bindings=Hp.bindings,r.setLayouts[Xp.LOCAL]=t.createDescriptorSetLayout(pm)),r.setLayouts[i?Xp.LOCAL:Xp.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var i=this._templates[t],n=i.defines;if(i.uber){for(var r="",o=0;o<n.length;o++){var a=n[o],s=e[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+i.hash}for(var l=0,u=0;u<n.length;u++){var h=n[u],_=e[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+i.hash},e.destroyShaderByDefines=function(t){var e=this,i=Object.keys(t);if(i.length)for(var n=i.map((function(e){var i=t[e];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(""+e+i)})),r=Object.keys(this._cache).filter((function(t){return n.every((function(i){return i.test(e._cache[t].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];A("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,i,n,r){Object.assign(i,n.macros),r||(r=this.getKey(e,i));var o=this._cache[r];if(o)return o;var a=this._templates[e],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(t,e),vm(a,s,Gp,"globals"),s.setLayouts[Xp.GLOBAL]=n.descriptorSetLayout,s.pipelineLayout=t.createPipelineLayout(new Gr(s.setLayouts)));var c=function(t,e){for(var i=[],n=0;n<e.length;n++){var r=e[n],o=r.name,a=t[o],s=mm(r,a),c=!a||"0"===a;i.push({name:o,value:s,isDefault:c})}return i}(i,a.defines),l=n.constantMacros+a.constantMacros+c.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),u=a.glsl3,h=xm(t);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(t,e,i){for(var n=[],r=t.attributes,o=e.gfxAttributes,a=0;a<r.length;a++)ym(r[a].defines,i)&&n.push(o[a]);return n}(a,s,i),s.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,c),this._cache[r]=t.createShader(s.shaderInfo)},t}());u.programLib=Im;var Rm=t("EffectAsset",pc("cc.EffectAsset")((Pm=Em=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"techniques",Cm,ot(e)),ct(e,"shaders",Am,ot(e)),ct(e,"combinations",Tm,ot(e)),ct(e,"hideInEditor",wm,ot(e)),e}$(e,t),e.register=function(t){e._effects[t.name]=t},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var i in e._effects)if(e._effects[i]._uuid===t)return void delete e._effects[i]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var i in e._effects)if(e._effects[i]._uuid===t)return e._effects[i];return null},e.getAll=function(){return e._effects};var i=e.prototype;return i.onLoaded=function(){Im.register(this),e.register(this),u.game.once(u.Game.EVENT_ENGINE_INITED,this._precompile,this)},i._precompile=function(){for(var t=this,e=u.director.root,i=function(i){var n=t.shaders[i],r=t.combinations[i];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,i){for(var n=r[e],o=0;o<n.length;++o){var a=Z({},i);a[e]=n[o],t.push(a)}return t}),[])}),[{}]).forEach((function(t){return Im.getGFXShader(e.device,n.name,t,e.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)},i.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},i.initDefault=function(i){t.prototype.initDefault.call(this,i);var n=e.get("unlit");this.name="unlit",this.shaders=n.shaders,this.combinations=n.combinations,this.techniques=n.techniques},i.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Mu),Em._effects={},Cm=lt((bm=Pm).prototype,"techniques",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Am=lt(bm.prototype,"shaders",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tm=lt(bm.prototype,"combinations",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wm=lt(bm.prototype,"hideInEditor",[xc,bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sm=bm))||Sm);u.EffectAsset=Rm;var Dm,Mm,Om,Bm,Nm,Lm,Fm,zm,Vm,km,Um,Gm,Hm,jm,Wm,qm=1024;!function(t){t[t.RGB565=_n.R5G6B5]="RGB565",t[t.RGB5A1=_n.RGB5A1]="RGB5A1",t[t.RGBA4444=_n.RGBA4]="RGBA4444",t[t.RGB888=_n.RGB8]="RGB888",t[t.RGB32F=_n.RGB32F]="RGB32F",t[t.RGBA8888=_n.RGBA8]="RGBA8888",t[t.RGBA32F=_n.RGBA32F]="RGBA32F",t[t.A8=_n.A8]="A8",t[t.I8=_n.L8]="I8",t[t.AI8=_n.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=_n.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=_n.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=qm++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=_n.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=_n.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=qm++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=_n.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=qm++]="RGBA_ETC1",t[t.RGB_ETC2=_n.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=_n.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=_n.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=_n.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=_n.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=_n.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=_n.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=_n.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=_n.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=_n.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=_n.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=_n.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=_n.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=_n.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=_n.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=_n.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Dm||(Dm={})),function(t){t[t.REPEAT=Tn.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Tn.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Tn.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Tn.BORDER]="CLAMP_TO_BORDER"}(Mm||(Mm={})),function(t){t[t.NONE=An.NONE]="NONE",t[t.LINEAR=An.LINEAR]="LINEAR",t[t.NEAREST=An.POINT]="NEAREST"}(Om||(Om={})),ce(_n);var Xm,Ym,Km,Jm,Qm=new mt("Tex"),Zm=pc("cc.TextureBase")((Wm=jm=function(t){function e(){var e;return ct(e=t.call(this)||this,"_format",Lm,ot(e)),ct(e,"_minFilter",Fm,ot(e)),ct(e,"_magFilter",zm,ot(e)),ct(e,"_mipFilter",Vm,ot(e)),ct(e,"_wrapS",km,ot(e)),ct(e,"_wrapT",Um,ot(e)),ct(e,"_wrapR",Gm,ot(e)),ct(e,"_anisotropy",Hm,ot(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new gr,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=Qm.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=go(e._id,666),e}$(e,t);var i=e.prototype;return i.getId=function(){return this._id},i.getPixelFormat=function(){return this._format},i.getAnisotropy=function(){return this._anisotropy},i.setWrapMode=function(t,e,i){void 0===i&&(i=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.destroy=function(){var e,i=t.prototype.destroy.call(this);return i&&(null===(e=u.director.root)||void 0===e?void 0:e.batcher2D)&&u.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),i},i.getHash=function(){return this._textureHash},i.getGFXTexture=function(){return null},i.getSamplerInfo=function(){return this._samplerInfo},i.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):O(9302)),this._gfxSampler},i._serialize=function(){return""},i._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},i._getGFXDevice=function(){return u.director.root?u.director.root.device:null},i._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},i._setGFXFormat=function(t){this._format=void 0===t?Dm.RGBA8888:t},i._getGFXPixelFormat=function(t){return t===Dm.RGBA_ETC1?t=Dm.RGB_ETC1:t===Dm.RGB_A_PVRTC_4BPPV1?t=Dm.RGB_PVRTC_4BPPV1:t===Dm.RGB_A_PVRTC_2BPPV1&&(t=Dm.RGB_PVRTC_2BPPV1),t},Q(e,[{key:"isCompressed",get:function(){return this._format>=Dm.RGB_ETC1&&this._format<=Dm.RGBA_ASTC_12x12||this._format>=Dm.RGB_A_PVRTC_2BPPV1&&this._format<=Dm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Mu),jm.PixelFormat=Dm,jm.WrapMode=Mm,jm.Filter=Om,Lm=lt((Nm=Wm).prototype,"_format",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dm.RGBA8888}}),Fm=lt(Nm.prototype,"_minFilter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Om.LINEAR}}),zm=lt(Nm.prototype,"_magFilter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Om.LINEAR}}),Vm=lt(Nm.prototype,"_mipFilter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Om.NONE}}),km=lt(Nm.prototype,"_wrapS",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mm.REPEAT}}),Um=lt(Nm.prototype,"_wrapT",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mm.REPEAT}}),Gm=lt(Nm.prototype,"_wrapR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mm.REPEAT}}),Hm=lt(Nm.prototype,"_anisotropy",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bm=Nm))||Bm;function $m(t){return!!(u.sys.hasFeature(u.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}u.TextureBase=Zm;var tv=t("ImageAsset",pc("cc.ImageAsset")((Jm=Km=function(t){function e(e){var i;return(i=t.call(this)||this)._nativeData=void 0,i._exportedExts=void 0,i._format=Dm.RGBA8888,i._width=0,i._height=0,i._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&i.reset(e),i}$(e,t);var i=e.prototype;return i.reset=function(t){$m(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},i.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):$m(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},i._serialize=function(){},i._deserialize=function(t){var i="";"string"==typeof t?i=t:(this._width=t.w,this._height=t.h,i=t.fmt);for(var n,r=u.director.root?u.director.root.device:null,o=i.split("_"),a=Number.MAX_VALUE,s=this._format,c="",l=u.macro.SUPPORT_TEXTURE_FORMATS,h=st(o);!(n=h()).done;){var _=n.value.split("@"),f=parseInt(_[0],void 0),p=e.extnames[f]||_[0],d=l.indexOf(p);if(-1!==d&&d<a){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==p||r&&r.hasFeature(hn.FORMAT_ASTC)))continue;if(!(".pvr"!==p||r&&r.hasFeature(hn.FORMAT_PVRTC)))continue;if(!(m!==Dm.RGB_ETC1&&m!==Dm.RGBA_ETC1||r&&r.hasFeature(hn.FORMAT_ETC1)))continue;if(!(m!==Dm.RGB_ETC2&&m!==Dm.RGBA_ETC2||r&&r.hasFeature(hn.FORMAT_ETC2)))continue;if(".webp"===p&&!u.sys.hasFeature(u.sys.Feature.WEBP))continue;a=d,c=p,s=m}}c?(this._setRawAsset(c),this._format=s):D(3121)},i.initDefault=function(i){if(t.prototype.initDefault.call(this,i),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var n=document.createElement("canvas"),r=n.getContext("2d"),o=n.width=n.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(n),e._sharedPlaceHolderCanvas=n}},i.validate=function(){return!!this.data},Q(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||$m(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||$m(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Dm.RGB_ETC1&&this._format<=Dm.RGBA_ASTC_12x12||this._format>=Dm.RGB_A_PVRTC_2BPPV1&&this._format<=Dm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Mu),Km.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Km._sharedPlaceHolderCanvas=null,lt((Ym=Jm).prototype,"_nativeAsset",[ol],Object.getOwnPropertyDescriptor(Ym.prototype,"_nativeAsset"),Ym.prototype),Xm=Ym))||Xm);u.ImageAsset=tv;var ev=new WeakMap,iv=new WeakSet,nv=new WeakSet;function rv(t,e){var i;i=ih.safeFindClass;var n,r=Ah.pool.get();try{n=Lh(t,r,{classFinder:i,customEnv:e})}catch(t){throw b(t),Ah.pool.put(r),t}n._uuid=e.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Bl(h),owner:a[u],prop:s[u],type:ne._getClassById(c[u])}}return ev.set(n,l),n._native&&iv.add(n),Ah.pool.put(r),n}var ov,av=new(function(){function t(){this._depends=new vl}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?Z({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),i=[];return this._descend(t,e,i),i},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var i,n,r=null;if(Array.isArray(e)||e.__type__||e instanceof _h){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(n=(i=e[5])[i.length-1])&&n<0)try{var o=rv(e,{__uuid__:t});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=t),bl.add(t+"@import",o)}catch(e){Sl.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},i=ev.get(t),n=0,r=i.length;n<r;n++)e.deps.push(i[n].uuid);return iv.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return i=(e=t)[1],e[10].map((function(t){return i[t]}));var e,i}(t);return e.forEach((function(t,i){return e[i]=Bl(t)})),e},e._descend=function(t,e,i){for(var n=this.getDeps(t),r=0;r<n.length;r++){var o=n[r];e[o]||(e[o]=!0,i.push(o),this._descend(o,e,i))}},t}()),sv=[new or];function cv(t){return t&&0==(t&t-1)}var lv,uv,hv,_v,fv,pv,dv=pc("cc.SimpleTexture")(ov=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}$(e,t);var i=e.prototype;return i.getGFXTexture=function(){return this._gfxTexture},i.destroy=function(){return this._tryDestroyTexture(),t.prototype.destroy.call(this)},i.updateImage=function(){this.updateMipmaps(0)},i.updateMipmaps=function(){},i.uploadData=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var n=this._getGFXDevice();if(n){var r=sv[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(t)?n.copyBuffersToTexture([t],this._gfxTexture,sv):n.copyTexImagesToTexture([t],this._gfxTexture,sv)}}},i._assignImage=function(t,e,i){var n=t.data;if(n&&(this.uploadData(n,e,i),this._checkTextureLoaded(),ue.CLEANUP_IMAGE_CACHE)){var r=av.getDeps(this._uuid),o=r.indexOf(t._uuid);-1!==o&&(_t(r,o),t.decRef())}},i._checkTextureLoaded=function(){this._textureReady()},i._textureReady=function(){this.loaded=!0,this.emit("load")},i._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},i._getGfxTextureCreateInfo=function(){return null},i._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&this._createTexture(t)}},i._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=Sn.NONE;this._mipFilter!==Om.NONE&&function(t,e,i){return!(t.gfxAPI===ln.WEBGL)||cv(e)&&cv(i)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var i=Math.max(t,e),n=0;i;)i>>=1,n++;return n}(this._width,this._height),e=Sn.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:xn.SAMPLED|xn.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(i){var n=t.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}}},i._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},Q(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Zm))||ov;u.SimpleTexture=dv;var mv,vv,gv,yv,xv,Sv,bv,Cv=t("Texture2D",(lv=pc("cc.Texture2D"),uv=Kc([tv]),lv((pv=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_mipmaps",fv,ot(e)),e}$(e,t);var i=e.prototype;return i.initialize=function(){this.mipmaps=this._mipmaps},i.onLoaded=function(){this.initialize()},i.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},i.create=function(t,e,i,n){void 0===i&&(i=Dm.RGBA8888),void 0===n&&(n=1),this.reset({width:t,height:e,format:i,mipmapLevel:n})},i.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},i.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),n=0;n<i;++n){var r=t+n;this._assignImage(this._mipmaps[r],r)}},i.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},i.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},i.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},i.releaseTexture=function(){this.destroy()},i._serialize=function(){return null},i._deserialize=function(e,i){var n=e;t.prototype._deserialize.call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new tv,n.mipmaps[r]){var o=n.mipmaps[r];i.result.push(this._mipmaps,""+r,o,ne._getClassId(tv))}},i._getGfxTextureCreateInfo=function(t){var e=new mr(yn.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)},i.initDefault=function(e){t.prototype.initDefault.call(this,e);var i=new tv;i.initDefault(),this.image=i},i.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},Q(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,i){e._assignImage(t,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(dv),fv=lt((_v=pv).prototype,"_mipmaps",[uv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hv=_v))||hv));u.Texture2D=Cv,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(bv||(bv={}));var Av=t("TextureCube",pc("cc.TextureCube")((Sv=xv=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"isRGBE",gv,ot(e)),ct(e,"_mipmaps",yv,ot(e)),e}$(e,t),e.fromTexture2DArray=function(t,i){for(var n=[],r=t.length/6,o=0;o<r;o++){var a=6*o;n.push({front:t[a+bv.front].image,back:t[a+bv.back].image,left:t[a+bv.left].image,right:t[a+bv.right].image,top:t[a+bv.top].image,bottom:t[a+bv.bottom].image})}return(i=i||new e).mipmaps=n,i};var i=e.prototype;return i.onLoaded=function(){this.mipmaps=this._mipmaps},i.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},i.updateMipmaps=function(t,e){var i=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var n=t+e;Tv(i._mipmaps[n],(function(t,e){i._assignImage(t,n,e)}))},o=0;o<n;++o)r(o)},i.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},i.releaseTexture=function(){this.mipmaps=[]},i._serialize=function(){return null},i._deserialize=function(e,i){var n=e;t.prototype._deserialize.call(this,n.base,i),this.isRGBE=n.rgbe,this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r){this._mipmaps[r]={front:new tv,back:new tv,left:new tv,right:new tv,top:new tv,bottom:new tv};var o=n.mipmaps[r],a=ne._getClassId(tv);i.result.push(this._mipmaps[r],"front",o.front,a),i.result.push(this._mipmaps[r],"back",o.back,a),i.result.push(this._mipmaps[r],"left",o.left,a),i.result.push(this._mipmaps[r],"right",o.right,a),i.result.push(this._mipmaps[r],"top",o.top,a),i.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},i._getGfxTextureCreateInfo=function(t){var e=new mr(yn.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},i.initDefault=function(e){t.prototype.initDefault.call(this,e);var i=new tv;i.initDefault(),this.mipmaps=[{front:i,back:i,top:i,bottom:i,left:i,right:i}]},i.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},Q(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,i){Tv(t,(function(t,n){e._assignImage(t,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(dv),xv.FaceIndex=bv,gv=lt((vv=Sv).prototype,"isRGBE",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yv=lt(vv.prototype,"_mipmaps",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mv=vv))||mv);function Tv(t,e){e(t.front,bv.front),e(t.back,bv.back),e(t.left,bv.left),e(t.right,bv.right),e(t.top,bv.top),e(t.bottom,bv.bottom)}u.TextureCube=Av;var wv,Ev,Pv,Iv=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Rv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Dv=function(){function t(){this._device=null,this._resources={}}var e=t.prototype;return e.initBuiltinRes=function(t){var e=this;this._device=t;for(var i=this._resources,n=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)n[c]=0,n[c+1]=0,n[c+2]=0,n[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var h=new Uint8Array(1024);c=0;for(var _=0;_<256;_++)h[c]=221,h[c+1]=221,h[c+2]=221,h[c+3]=255,c+=4;c=0;for(var f=0;f<8;f++){for(var p=0;p<8;p++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}c+=32;for(var d=0;d<8;d++){for(var m=0;m<8;m++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}var v={width:2,height:2,_data:n,_compressed:!1,format:Cv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:Cv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:Cv.PixelFormat.RGBA8888},x={width:2,height:2,_data:a,_compressed:!1,format:Cv.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:Cv.PixelFormat.RGBA8888},b={width:16,height:16,_data:h,_compressed:!1,format:Cv.PixelFormat.RGBA8888},C=new tv(v),A=new Cv;A._uuid="black-texture",A.image=C,i[A._uuid]=A;var T=new tv(g),w=new Cv;w._uuid="empty-texture",w.image=T,i[w._uuid]=w;var E=new Av;E._uuid="black-cube-texture",E.setMipFilter(Av.Filter.NEAREST),E.image={front:new tv(v),back:new tv(v),left:new tv(v),right:new tv(v),top:new tv(v),bottom:new tv(v)},i[E._uuid]=E;var P=new tv(y),I=new Cv;I._uuid="grey-texture",I.image=P,i[I._uuid]=I;var R=new tv(x),D=new Cv;D._uuid="white-texture",D.image=R,i[D._uuid]=D;var M=new Av;M._uuid="white-cube-texture",M.setMipFilter(Av.Filter.NEAREST),M.image={front:new tv(x),back:new tv(x),left:new tv(x),right:new tv(x),top:new tv(x),bottom:new tv(x)},i[M._uuid]=M;var O=new tv(S),B=new Cv;B._uuid="normal-texture",B.image=O,i[B._uuid]=B;var N=new tv(b),L=new Cv;L._uuid="default-texture",L.image=N,i[L._uuid]=L;var F=new Av;if(F.setMipFilter(Av.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new tv(b),back:new tv(b),left:new tv(b),right:new tv(b),top:new tv(b),bottom:new tv(b)},i[F._uuid]=F,u.SpriteFrame){var z=new u.SpriteFrame,V=C,k=new Cv;k.image=V,z.texture=k,z._uuid="default-spriteframe",i[z._uuid]=z}var U=xm(t);if(!U)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var G=Rv[U];return G?Promise.resolve().then((function(){Iv.forEach((function(t,e){var i=Object.assign(new u.EffectAsset,t);i.shaders.forEach((function(t,i){var n=G[e][i];n&&(t[U]=n)})),i.hideInEditor=!0,i.onLoaded()})),e._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+U+" but shaders of that version are not assembled in this build."))},e.get=function(t){return this._resources[t]},e._initMaterials=function(){var t=this._resources,e=[],i=new u.Material;i._uuid="standard-material",i.initialize({effectName:"standard"}),t[i._uuid]=i,e.push(i);var n=new u.Material;n._uuid="missing-effect-material",n.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),n.setProperty("mainColor",u.color("#ffff00")),t[n._uuid]=n,e.push(n);var r=new u.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",u.color("#ff00ff")),t[r._uuid]=r,e.push(r);var o=new u.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);var a=new u.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);var s=new u.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[s._uuid]=s,e.push(s);var c=new u.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);var l=new u.Material;l._uuid="ui-sprite-gray-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[l._uuid]=l,e.push(l);var h=new u.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[h._uuid]=h,e.push(h);var _=new u.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[_._uuid]=_,e.push(_);var f=new u.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),t[f._uuid]=f,e.push(f);var p=new u.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),t[p._uuid]=p,e.push(p);var d=new u.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),t[d._uuid]=d,e.push(d);var m=new u.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);var v=new u.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),t[v._uuid]=v,e.push(v);var g=new u.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),u.game.on(u.Game.EVENT_GAME_INITED,(function(){for(var t=0;t<e.length;++t)for(var i=e[t],n=0;n<i.passes.length;++n)i.passes[n].tryCompile()}))},t}(),Mv=t("builtinResMgr",u.builtinResMgr=new Dv),Ov=t("getPhaseID",(wv=new Map,Ev=0,function(t){return"number"==typeof t?t:(wv.has(t)||(wv.set(t,1<<Ev),Ev++),wv.get(t))})),Bv=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,i,n){void 0===n&&(n=null);var r=e.buffer.length;if(r){var o=t.inputAssembler,a=t.descriptorSet.getTexture(Ld),s=n;s||(s=t.shaders[i]);for(var c=t.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(e.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<e.attributes.length;g++){var y=e.attributes[g],x=new Pr(y.name,y.format,y.isNormalized,d.length,!0);m.push(x)}p.set(e.buffer),d.push(f);var S=new Rr(m,d,v),b=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:p,ia:b,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var i=this.instances[e];i.count&&(i.ia.instanceCount=i.count,t.updateBuffer(i.vb,i.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),Nv=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],i=0;i<e.vbs.length;++i)e.vbs[i].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,i){var n=t.subMesh.flatBuffers;if(0!==n.length){for(var r=0,o=0,a=n[0].count,s=t.passes[e],c=t.shaders[e],l=t.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===n.length&&_.mergeCount<dd.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==n[f].stride){u=!1;break}if(u){for(var p=0;p<_.vbs.length;++p){var d=n[p],m=_.vbs[p],v=_.vbDatas[p];(r=(a+_.vbCount)*d.stride)>m.size&&(m.resize(r),_.vbDatas[p]=new Uint8Array(r),_.vbDatas[p].set(v)),_.vbDatas[p].set(d.buffer,_.vbCount*d.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var b=y;b<x;b++)g[b]=S+.1;return Gi.toArray(_.uboData,i.transform.worldMatrix,dd.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(dd.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var C=[],A=[],T=[],w=0;w<n.length;++w){var E=n[w],P=this._device.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,E.count*E.stride,E.stride));P.update(E.buffer.buffer),C.push(P),A.push(new Uint8Array(P.size)),T.push(P)}var I=this._device.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),I.update(R),T.push(I);for(var D=t.inputAssembler.attributes,M=new Array(D.length+1),O=0;O<D.length;++O)M[O]=D[O];M[D.length]=new Pr("a_dyn_batch_id",_n.R32F,!1,n.length);var B=new Rr(M,T),N=this._device.createInputAssembler(B),L=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,dd.SIZE,dd.SIZE));l.bindBuffer(dd.BINDING,L),l.update();var F=new Float32Array(dd.COUNT);Gi.toArray(F,i.transform.worldMatrix,dd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:C,vbDatas:A,vbIdx:I,vbIdxData:R,vbCount:a,ia:N,ubo:L,uboData:F,pass:s,shader:c,descriptorSet:l})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),Lv=new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.DEVICE),Fv=new _r(null),zv=new Ur(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(Pv||(Pv={}));var Vv=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new wo,this._dss=new Ao,this._rs=new Co,this._priority=Fp.DEFAULT,this._stage=Lp.DEFAULT,this._phase=Ov("default"),this._primitive=Fn.TRIANGLE_LIST,this._batchingScheme=Pv.NONE,this._dynamicStates=Un.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(Ov(e.phase));var i=t._bs;if(e.blendState){var n=e.blendState,r=n.targets;r&&r.forEach((function(t,e){i.setTarget(e,t)})),void 0!==n.isA2C&&(i.isA2C=n.isA2C),void 0!==n.isIndepend&&(i.isIndepend=n.isIndepend),void 0!==n.blendColor&&(i.blendColor=n.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,i=Im.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return i+=function(t){for(var e,i=",bs,"+t.isA2C,n=st(t.targets);!(e=n()).done;){var r=e.value;i+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,i+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return i}(t._bs),i+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),go(i+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=pn.UNKNOWN);var n=this._propertyHandleMap[t];return n?(i?n=cm(n,i):e&&(n=cm(n,rm(n)-e)),n+e):0},e.getBinding=function(e){var i=this.getHandle(e);return i?t.getBindingFromHandle(i):-1},e.setUniform=function(e,i){var n=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,n);um[r](a,i,o),this._setRootBufferDirty(!0)},e.getUniform=function(e,i){var n=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,n);return lm[r](a,i,o)},e.setUniformArray=function(e,i){for(var n=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=so(r)>>2,a=this._getBlockView(r,n),s=t.getOffsetFromHandle(e),c=0;c<i.length;c++,s+=o)null!==i[c]&&um[r](a,i[c],s);this._setRootBufferDirty(!0)},e.bindTexture=function(t,e,i){this._descriptorSet.bindTexture(t,e,i||0)},e.bindSampler=function(t,e,i){this._descriptorSet.bindSampler(t,e,i||0)},e.setDynamicState=function(t,e){var i=this._dynamics[t];i&&i.value===e||(i.value=e,i.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):O(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new Bv(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new Nv(this))},e._initNative=function(){},e._destroy=function(){},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var i in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[i].destroy();for(var n in this._batchedBuffers)this._batchedBuffers[n].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},e.resetUniform=function(e){var i=this.getHandle(e);if(i){for(var n=t.getTypeFromHandle(i),r=t.getBindingFromHandle(i),o=t.getOffsetFromHandle(i),a=t.getCountFromHandle(i),s=this._getBlockView(n,r),c=this._properties[e],l=c&&c.value||_m(n),u=(so(n)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},e.resetTexture=function(e,i){var n=this.getHandle(e);if(n){var r=t.getTypeFromHandle(n),o=t.getBindingFromHandle(n),a=this._properties[e],s=a&&a.value,c=s?s+"-texture":_m(r),l=Mv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Do.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,i),this._descriptorSet.bindTexture(o,u,i)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],i=0,n=0;n<e.members.length;n++){for(var r=e.members[n],o=this._getBlockView(r.type,e.binding),a=this._properties[r.name],s=a&&a.value||_m(r.type),c=(so(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,i+l);i+=c}this._setRootBufferDirty(!0)},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],i=0;i<e.count;i++)this.resetTexture(e.name,i)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var i=Im.getGFXShader(this._device,this._programName,this._defines,e);return i?(this._shader=i,this._setPipelineLayout(Im.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,i=0;i<t.length;i++){var n=t[i];this._defines[n.name]=n.value}for(var r=Im.getGFXShader(this._device,this._programName,this._defines,e),o=0;o<t.length;o++){var a=t[o];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._setPriority=function(t){this._priority=t},e._setStage=function(t){this._stage=t},e._setPhase=function(t){this._phase=t},e._setPrimitive=function(t){this._primitive=t},e._setState=function(t,e,i,n){this._bs=t,this._dss=e,this._rs=i,this._descriptorSet=n},e._doInit=function(e,i){void 0===i&&(i=!1),this._initNative(),this._setPriority(Fp.DEFAULT),this._setStage(Lp.DEFAULT),this._setPhase(Ov("default")),this._setPrimitive(Fn.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=i?Z({},e.defines):e.defines,this._shaderInfo=Im.getTemplate(e.program),this._properties=e.properties||this._properties;var n=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),zv.layout=Im.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(zv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Im.getTemplateInfo(e.program),a=o.blockSizes,s=o.handleMap,c=n.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var p=l[l.length-1]+u;p&&(Lv.size=16*Math.ceil(p/16),this._rootBuffer=n.createBuffer(Lv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Fv.buffer=this._rootBuffer,Fv.offset=l[m++],Fv.range=16*Math.ceil(g/16);var y=this._buffers[v]=n.createBuffer(Fv);this._blocks[v]=new Float32Array(this._rootBlock,Fv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var b in this._properties){var C=this._properties[b];C.handleInfo&&(S[b]=this.getHandle.apply(this,C.handleInfo))}Object.assign(x,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(hn.INSTANCED_ARRAYS)?this._setBatchingScheme(Pv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Pv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Pv.VB_MERGING):this._setBatchingScheme(Pv.NONE)},e._setBatchingScheme=function(t){this._batchingScheme=t},e._setDynamicState=function(t){this._dynamicStates=t},e._setHash=function(t){this._hash=t},e._getBlockView=function(t,e){return t<pn.FLOAT?this._blocksInt[e]:this._blocks[e]},e._setPipelineLayout=function(t){this._pipelineLayout=t},e._initPassFromTarget=function(t,e,i,n){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(i,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(Im.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^n)},Q(t,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Im.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();Vv.getTypeFromHandle=rm,Vv.getBindingFromHandle=om,Vv.getCountFromHandle=am,Vv.getOffsetFromHandle=sm;var kv=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,i,n,r){var o=e.hash^n.hash^r.attributesHash^i.typedID,a=this._PSOHashMap.get(o);if(!a){var s=e.pipelineLayout,c=new Hr(r.attributes),l=new Eo(i,s,n,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},t}());kv._PSOHashMap=new Map;var Uv=new ar,Gv=new $n;function Hv(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var jv,Wv,qv,Xv,Yv,Kv,Jv,Qv,Zv,$v,tg=null;function eg(t,e,i,n,r){if(n&&n.enabled&&r===tg){var o=n.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Uv.width=Gv.width=r.window.width,Uv.height=Gv.height=r.window.height;var u=kv.getOrCreatePipelineState(t,s[0],c[0],e,a);i.setViewport(Uv),i.setScissor(Gv),i.bindPipelineState(u),i.bindDescriptorSet(Xp.MATERIAL,s[0].descriptorSet),i.bindDescriptorSet(Xp.LOCAL,l),i.bindInputAssembler(a),i.draw(a)}}var ig,ng,rg,og,ag,sg=new Ji,cg=t("Material",(jv=pc("cc.Material"),Wv=Kc(Rm),jv(($v=function(t){function e(){var e;return ct(e=t.call(this)||this,"_effectAsset",Yv,ot(e)),ct(e,"_techIdx",Kv,ot(e)),ct(e,"_defines",Jv,ot(e)),ct(e,"_states",Qv,ot(e)),ct(e,"_props",Zv,ot(e)),e._passes=[],e._hash=0,e}$(e,t),e.getHash=function(t){for(var e,i=0,n=st(t.passes);!(e=n()).done;)i^=e.value.hash;return i};var i=e.prototype;return i.initialize=function(t){this._passes.length?D(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},i.reset=function(t){this.initialize(t)},i.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},i.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},i.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},i.onLoaded=function(){this._update()},i.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var i,n=st(this._passes);!(i=n()).done;){var r=i.value;r.resetUBOs(),r.resetTextures()}},i.setProperty=function(t,e,i){var n=!1;if(void 0===i)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: "+i+".");var c=this._passes[i];this._uploadProperty(c,t,e)&&(this._props[c.propertyIndex][t]=e,n=!0)}n||console.warn("illegal property name: "+t+".")},i.getProperty=function(t,e){if(void 0===e)for(var i=this._props,n=i.length,r=0;r<n;r++){var o=i[r];if(t in o)return o[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},i.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var i=0;i<t._props.length;i++)this._props[i]=Z({},t._props[i]);this._defines.length=t._defines.length;for(var n=0;n<t._defines.length;n++)this._defines[n]=Z({},t._defines[n]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=Z({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},i._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Rm.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},i._prepareInfo=function(t,e){var i=t;if(!Array.isArray(i)){var n=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(n).fill(i)}for(var r=0;r<i.length;++r)Object.assign(e[r]||(e[r]={}),i[r])},i._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,i=[],n=0;n<e;++n){var r=t.passes[n],o=r.passIndex=n,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new Vv(u.director.root);s.initialize(r),i.push(s)}}return i},i._update=function(t){var i=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var n=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=n,t)this._passes.forEach((function(t,e){var n=i._props[e];for(var r in n||(n=i._props[e]={}),void 0!==t.propertyIndex&&Object.assign(n,i._props[t.propertyIndex]),n)i._uploadProperty(t,r,n[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},i._uploadProperty=function(t,e,i){var n=t.getHandle(e);if(!n)return!1;if(Vv.getTypeFromHandle(n)<pn.SAMPLER1D)if(Array.isArray(i))t.setUniformArray(n,i);else if(null!==i){var r;if(null===(r=t.properties[e])||void 0===r?void 0:r.linear){var o=i;Hv(sg,o),sg.w=o.w,i=sg}t.setUniform(n,i)}else t.resetUniform(e);else if(Array.isArray(i))for(var a=0;a<i.length;a++)this._bindTexture(t,n,i[a],a);else i?this._bindTexture(t,n,i):t.resetTexture(e);return!0},i._bindTexture=function(t,e,i,n){var r=Vv.getBindingFromHandle(e);if(i instanceof Oo)t.bindTexture(r,i,n);else if(i instanceof Zm){var o=i.getGFXTexture();if(!o||!o.width||!o.height)return;t.bindTexture(r,o,n),t.bindSampler(r,i.getGFXSampler(),n)}},i._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=st(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Ti("#ff00ff"))},i.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},Q(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Mu),Yv=lt((Xv=$v).prototype,"_effectAsset",[Wv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kv=lt(Xv.prototype,"_techIdx",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jv=lt(Xv.prototype,"_defines",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qv=lt(Xv.prototype,"_states",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zv=lt(Xv.prototype,"_props",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qv=Xv))||qv));u.Material=cg,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(ig||(ig={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(ng||(ng={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(rg||(rg={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(og||(og={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(ag||(ag={}));var lg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],ug=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],hg=[100,200,400,800],_g=new Ei,fg=new Ei,pg=new Gi,dg=Xn.STENCIL<<1,mg=[],vg=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=ig.VERTICAL,this._fov=li(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new sr(.2,.2,.2,1),this._viewport=new en(0,0,1,1),this._orientedViewport=new en(0,0,1,1),this._curTransform=un.IDENTITY,this._isProjDirty=!0,this._matView=new Gi,this._matProj=new Gi,this._matProjInv=new Gi,this._matViewProj=new Gi,this._matViewProjInv=new Gi,this._frustum=new nc,this._forward=new Ei,this._position=new Ei,this._priority=0,this._aperture=rg.F16_0,this._apertureValue=void 0,this._shutter=ag.D125,this._shutterValue=0,this._iso=og.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Xn.NONE,this._clearDepth=1,this._visibility=Jd,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=lg[this._aperture],this._shutterValue=ug[this._shutter],this._isoValue=hg[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!mg.length){var e=t.capabilities.clipSpaceSignY;mg[un.IDENTITY]=new Gi(1,0,0,0,0,e),mg[un.ROTATE_90]=new Gi(0,1,0,0,-e,0),mg[un.ROTATE_180]=new Gi(-1,0,0,0,0,-e),mg[un.ROTATE_270]=new Gi(0,-1,0,0,e,0)}}var e=t.prototype;return e._setWidth=function(t){this._width=t},e._setHeight=function(t){this._height=t},e._setScene=function(t){this._scene=t},e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||un.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e._init=function(){},e.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Xn.NONE,this.clearDepth=1,this.visibility=Jd,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e._destroy=function(){},e.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},e.attachToScene=function(t){this._enabled=!0,this._setScene(t)},e.detachFromScene=function(){this._enabled=!1,this._setScene(null)},e.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},e.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var i=!1;(this._node.hasChangedFlags||t)&&(Gi.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),i=!0);var n=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=n&&n.surfaceTransform||un.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===ng.PERSPECTIVE)Gi.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===ig.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Gi.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Gi.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(Gi.multiply(this._matViewProj,this._matProj,this._matView),Gi.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,i=t.x,n=t.width,r=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||un.IDENTITY){case un.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=i,this._viewport.width=r,this._viewport.height=n;break;case un.ROTATE_180:this._viewport.x=1-i-n,this._viewport.y=1-o-r,this._viewport.width=n,this._viewport.height=r;break;case un.ROTATE_270:this._viewport.x=o,this._viewport.y=1-i-n,this._viewport.width=r,this._viewport.height=n;break;case un.IDENTITY:this._viewport.x=i,this._viewport.y=o,this._viewport.width=n,this._viewport.height=r}this._orientedViewport.x=i,this._orientedViewport.y=o,this._orientedViewport.width=n,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||u.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var i=e.swapchain;(i&&i.surfaceTransform||un.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,i){if(!this._node)return null;var n=this.width,r=this.height,o=this._orientedViewport.x*n,a=this._orientedViewport.y*r,s=this._orientedViewport.width*n,c=this._orientedViewport.height*r,l=this._proj===ng.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Ui[this._curTransform];Ei.set(_g,(e-o)/s*2-1,(i-a)/c*2-1,l?1:-1);var _=_g.x,f=_g.y;return _g.x=_*h[0]+f*h[2]*u,_g.y=_*h[1]+f*h[3]*u,Ei.transformMat4(l?_g:t.o,_g,this._matViewProjInv),l?(this._node.getWorldPosition(fg),ta.fromPoints(t,fg,_g)):Ei.transformQuat(t.d,Ei.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var i=this.width,n=this.height,r=this._orientedViewport.x*i,o=this._orientedViewport.y*n,a=this._orientedViewport.width*i,s=this._orientedViewport.height*n,c=this._device.capabilities.clipSpaceSignY,l=Ui[this._curTransform];if(this._proj===ng.PERSPECTIVE){Ei.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,1);var u=t.x,h=t.y;t.x=u*l[0]+h*l[2]*c,t.y=u*l[1]+h*l[3]*c,Ei.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(_g),Ei.lerp(t,_g,t,ci(this._nearClip/this._farClip,1,e.z))}else{Ei.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,2*e.z-1);var _=t.x,f=t.y;t.x=_*l[0]+f*l[2]*c,t.y=_*l[1]+f*l[3]*c,Ei.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var i=this._device.capabilities.clipSpaceSignY,n=Ui[this._curTransform];Ei.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*n[0]+o*n[2]*i,t.y=r*n[1]+o*n[3]*i;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return t.x=c+.5*(t.x+1)*u,t.y=l+.5*(t.y+1)*h,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,i,n){Gi.multiply(t,this._matViewProj,e),Gi.multiply(t,mg[this._curTransform],t);var r=i/2,o=n/2;return Gi.identity(pg),Gi.transform(pg,pg,Ei.set(_g,r,o,0)),Gi.scale(pg,pg,Ei.set(_g,r,o,1)),Gi.multiply(t,pg,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},Q(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){D(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=lg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=ug[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=hg[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}(),gg=oe({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),yg=oe({Planar:0,ShadowMap:1}),xg=oe({HARD:0,SOFT:1,SOFT_2X:2}),Sg=yg.ShadowMap+1,bg=function(){function t(){this.fixedSphere=new sa(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Gi,this.matShadowProj=new Gi,this.matShadowViewProj=new Gi,this._normal=new Ei(0,1,0),this._shadowColor=new Ti(0,0,0,76),this._matLight=new Gi,this._material=null,this._instancingMaterial=null,this._size=new qi(512,512),this._enabled=!1,this._distance=0,this._type=Sg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var e=t.prototype;return e.getPlanarShader=function(t){return this._material||(this._material=new cg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(t)},e.getPlanarInstanceShader=function(t){return this._instancingMaterial||(this._instancingMaterial=new cg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(t)},e._setEnable=function(t){this._enabled=t},e._setType=function(t){this._type=this.enabled?t:Sg},e.initialize=function(t){this.near=t.near,this.far=t.far,this.invisibleOcclusionRange=t.invisibleOcclusionRange,this.shadowDistance=t.shadowDistance,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.fixedArea=t.fixedArea,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation},e.activate=function(){this.enabled&&this.type===yg.Planar&&this._updatePlanarInfo()},e._updatePlanarInfo=function(){this._material||(this._material=new cg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new cg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},e._destroy=function(){},e.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){Ei.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=t}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.activate()}},{key:"near",get:function(){return this._near},set:function(t){this._near=t}},{key:"far",get:function(){return this._far},set:function(t){this._far=t}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t}},{key:"saturation",get:function(){return this._saturation},set:function(t){this._saturation=t}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),t}();bg.MAX_FAR=2e3,bg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),u.Shadows=bg;var Cg=new Ei,Ag=(new Ei,new Ei,new Ei),Tg=new Gi,wg=new Ws,Eg=new Ws,Pg=!1,Ig=sa.create(0,0,0,1),Rg=new sa,Dg=new nc;Dg.accurate=!0;var Mg=new nc;Mg.accurate=!0;var Og=new nc,Bg=new Gi,Ng=new Gi,Lg=new Gi,Fg=new Gi,zg=new Gi,Vg=new Gi,kg=new Gi,Ug=new Ei,Gg=new qi,Hg=new Ei,jg=new Ei,Wg=new Ei(0,0,0),qg=(new Ws,new jl((function(){return{model:null,depth:0}}),128)),Xg=new jl((function(){return{model:null,depth:0}}),128),Yg=new jl((function(){return{model:null,depth:0}}),128);function Kg(t,e){var i=0;t.node&&(Ei.subtract(Cg,t.node.worldPosition,e.position),i=Ei.dot(Cg,e.forward));var n=qg.alloc();return n.model=t,n.depth=i,n}function Jg(t,e){var i=0;t.node&&(Ei.subtract(Cg,t.node.worldPosition,e.position),i=Ei.dot(Cg,e.forward));var n=Xg.alloc();return n.model=t,n.depth=i,n}function Qg(t,e){var i=0;t.node&&(Ei.subtract(Cg,t.node.worldPosition,e.position),i=Ei.dot(Cg,e.forward));var n=Yg.alloc();return n.model=t,n.depth=i,n}function Zg(t,e,i){var n=e.direction,r=t.normal,o=t.distance+.001,a=1/Ei.dot(r,n),s=n.x*a,c=n.y*a,l=n.z*a,u=r.x,h=r.y,_=r.z,f=t.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Gi.toArray(i,f,$p.MAT_LIGHT_PLANE_PROJ_OFFSET)}function $g(t,e){Ei.normalize(Cg,t.normal),e[$p.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Cg.x,e[$p.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Cg.y,e[$p.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Cg.z,e[$p.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}function ty(t,e){var i=t.pipelineSceneData.validPunctualLights;i.length=0;for(var n=e.scene.spotLights,r=0;r<n.length;r++){var o=n[r];o.baked||(sa.set(Ig,o.position.x,o.position.y,o.position.z,o.range),hs.sphereFrustum(Ig,e.frustum)&&i.push(o))}for(var a=e.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(sa.set(Ig,c.position.x,c.position.y,c.position.z,c.range),hs.sphereFrustum(Ig,e.frustum)&&i.push(c))}}function ey(t,e){var i=e.scene,n=i.mainLight,r=t.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;qg.freeArray(s),s.length=0;var c=r.castShadowObjects;Yg.freeArray(c),c.length=0,Pg=!1;var l=null;if(o.enabled&&(t.pipelineUBO.updateShadowUBORange($p.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===yg.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,Xg.freeArray(l),l.length=0,n&&n.node)!function(t,e,i,n,r){var o=e.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Gi.fromRT(Bg,i.node.getWorldRotation(),i.node.getWorldPosition()),Gi.invert(Ng,Bg),Gi.ortho(Fg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Gi.multiply(zg,Fg,Ng),Gi.invert(Lg,Ng),r.matShadowView=Ng,r.matShadowProj=Fg,r.matShadowViewProj=zg,nc.createOrtho(t,2*a,2*s,c,l,Lg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(t,e){if(e.node){var i=e.node,n=i.getWorldPosition(),r=i.getWorldRotation();Gi.fromRT(t,r,n),t.m08*=-1,t.m09*=-1,t.m10*=-1}}(Tg,n),nc.split(Dg,n,Tg,.1,r.shadowDistance),Mg=nc.clone(Dg),Gi.fromRT(Bg,i.node.rotation,Wg),Gi.invert(Ng,Bg),Gi.invert(Lg,Ng);var _=Ng.clone();Mg.transform(Ng),Ws.fromPoints(wg,new Ei(1e7,1e7,1e7),new Ei(-1e7,-1e7,-1e7)),wg.mergeFrustum(Mg);var f=2*wg.halfExtents.z;Ag.set(wg.center.x,wg.center.y,wg.center.z+wg.halfExtents.z+u),Ei.transformMat4(Ag,Ag,Lg),Gi.fromRT(Bg,i.node.rotation,Ag),Gi.invert(Ng,Bg),Gi.invert(Lg,Ng);var p=Ei.distance(Dg.vertices[0],Dg.vertices[6]);Rg.center.set(0,0,0),Rg.radius=-1,Rg.mergePoints(Dg.vertices);var d=.8*p+.4*Rg.radius;r.shadowCameraFar=f+u;var m=.5*d;if(Gi.ortho(Fg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Gi.multiply(Vg,Fg,_),Ei.transformMat4(Ug,Ag,Vg);var v=2/h;Gg.set(v,v);var g=Ug.x%Gg.x,y=Ug.y%Gg.y;Hg.set(Ug.x-g,Ug.y-y,Ug.z),Gi.invert(kg,Vg),Ei.transformMat4(jg,Hg,kg),Gi.fromRT(Bg,i.node.rotation,jg),Gi.invert(Ng,Bg),Gi.invert(Lg,Ng),nc.createOrtho(t,d,d,.1,r.shadowCameraFar,Lg)}else{for(var x=0;x<8;x++)t.vertices[x].set(0,0,0);t.updatePlanes()}Gi.multiply(zg,Fg,Ng),r.matShadowView=Ng,r.matShadowProj=Fg,r.matShadowViewProj=zg}}(Og,t,n,e,o);else{for(var u=0;u<8;u++)Og.vertices[u].set(0,0,0);Og.updatePlanes()}n&&o.type===yg.Planar&&function(t,e){var i=t.pipelineSceneData.shadows,n=e.direction,r=i.normal,o=i.distance+.001,a=1/Ei.dot(r,n),s=n.x*a,c=n.y*a,l=n.z*a,u=r.x,h=r.y,_=r.z,f=i.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,t.pipelineUBO.updateShadowUBORange($p.MAT_LIGHT_PLANE_PROJ_OFFSET,i.matLight)}(t,n),a.enabled&&a.model&&e.clearFlag&dg&&s.push(Kg(a.model,e));for(var h=i.models,_=e.visibility,f=0;f<h.length;f++){var p=h[f];if(p.enabled&&(p.castShadow&&c.push(Qg(p,e)),o.firstSetCSM&&p.worldBounds&&(Pg||(Eg.copy(p.worldBounds),Pg=!0),Ws.merge(Eg,Eg,p.worldBounds)),p.node&&(_&p.node.layer)===p.node.layer||_&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&hs.aabbFrustum(p.worldBounds,Og)&&l.push(Jg(p,e)),p.worldBounds&&!hs.aabbFrustum(p.worldBounds,e.frustum))continue;s.push(Kg(p,e))}}o.firstSetCSM&&(o.shadowDistance=2*Eg.halfExtents.length(),o.firstSetCSM=!1)}var iy,ny,ry,oy=new gr(An.LINEAR,An.LINEAR,An.NONE,Tn.CLAMP,Tn.CLAMP,Tn.CLAMP),ay=new gr(An.POINT,An.POINT,An.NONE,Tn.CLAMP,Tn.CLAMP,Tn.CLAMP),sy=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(oy),this._pointSampler=this._device.getSampler(ay);var e=new kr(Gp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Ur(this._descriptorSetLayout))}var e=t.prototype;return e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindBuffer(t,e),n=i.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindSampler(t,e),n=i.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindTexture(t,e),n=i.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var i=this._globalDescriptorSet,n=e.createDescriptorSet(new Ur(this._descriptorSetLayout));this._descriptorSetMap.set(t,n);for(var r=Up.UBO_GLOBAL;r<Up.COUNT;r++)n.bindBuffer(r,i.getBuffer(r)),n.bindSampler(r,i.getSampler(r)),n.bindTexture(r,i.getTexture(r));var o=e.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,$p.SIZE,$p.SIZE));n.bindBuffer($p.BINDING,o),n.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},Q(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}();function cy(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var i=e*e,n=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),r=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),o=2*n-8*r+4,a=3*n/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(iy||(iy={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(ny||(ny={})),u.internal.TransformBit=ny,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(ry||(ry={}));var ly,uy,hy,_y,fy,py,dy,my,vy,gy,yy=function(t){return 4*Math.PI*Math.PI*t*t},xy=function(){function t(){this._baked=!1,this._color=new Ei(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Ei(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=ry.UNKNOWN}var e=t.prototype;return e._init=function(){},e._destroy=function(){},e.initialize=function(){this._init(),this.color=new Ei(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null,this._destroy()},e.update=function(){},Q(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,cy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=ny.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Sy=new Gi,by=new Gi,Cy=new Gi,Ay=new Ji,Ty=new Ji(0,0,1,0),wy=function(){function t(){this._globalUBO=new Float32Array(Qp.COUNT),this._cameraUBO=new Float32Array(Zp.COUNT),this._shadowUBO=new Float32Array($p.COUNT)}t.updateGlobalUBOView=function(t,e){var i=u.director.root,n=e,r=Math.floor(t.width),o=Math.floor(t.height);n[Qp.TIME_OFFSET]=i.cumulativeTime,n[Qp.TIME_OFFSET+1]=i.frameTime,n[Qp.TIME_OFFSET+2]=u.director.getTotalFrames(),n[Qp.SCREEN_SIZE_OFFSET]=r,n[Qp.SCREEN_SIZE_OFFSET+1]=o,n[Qp.SCREEN_SIZE_OFFSET+2]=1/r,n[Qp.SCREEN_SIZE_OFFSET+3]=1/o,n[Qp.NATIVE_SIZE_OFFSET]=r,n[Qp.NATIVE_SIZE_OFFSET+1]=o,n[Qp.NATIVE_SIZE_OFFSET+2]=1/n[Qp.NATIVE_SIZE_OFFSET],n[Qp.NATIVE_SIZE_OFFSET+3]=1/n[Qp.NATIVE_SIZE_OFFSET+1]},t.updateCameraUBOView=function(t,e,i){var n=(i.scene?i.scene:u.director.getScene().renderScene).mainLight,r=t.pipelineSceneData,o=r.ambient,a=r.fog,s=r.shadows,c=e,l=i.exposure,h=r.isHDR;if(c[Zp.SCREEN_SCALE_OFFSET]=r.shadingScale,c[Zp.SCREEN_SCALE_OFFSET+1]=r.shadingScale,c[Zp.SCREEN_SCALE_OFFSET+2]=1/c[Zp.SCREEN_SCALE_OFFSET],c[Zp.SCREEN_SCALE_OFFSET+3]=1/c[Zp.SCREEN_SCALE_OFFSET+1],c[Zp.EXPOSURE_OFFSET]=l,c[Zp.EXPOSURE_OFFSET+1]=1/l,c[Zp.EXPOSURE_OFFSET+2]=h?1:0,c[Zp.EXPOSURE_OFFSET+3]=0,n){var _=s.enabled&&s.type===yg.ShadowMap?1:0,f=n.direction;if(Ty.set(f.x,f.y,f.z,_),Ji.toArray(c,Ty,Zp.MAIN_LIT_DIR_OFFSET),Ei.toArray(c,n.color,Zp.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var p=n.colorTemperatureRGB;c[Zp.MAIN_LIT_COLOR_OFFSET]*=p.x,c[Zp.MAIN_LIT_COLOR_OFFSET+1]*=p.y,c[Zp.MAIN_LIT_COLOR_OFFSET+2]*=p.z}c[Zp.MAIN_LIT_COLOR_OFFSET+3]=h?n.illuminance*l:n.illuminance}else Ty.set(0,0,1,0),Ji.toArray(c,Ty,Zp.MAIN_LIT_DIR_OFFSET),Ji.toArray(c,Ji.ZERO,Zp.MAIN_LIT_COLOR_OFFSET);var d=o.skyColor;d.w=h?o.skyIllum*l:o.skyIllum,c[Zp.AMBIENT_SKY_OFFSET+0]=d.x,c[Zp.AMBIENT_SKY_OFFSET+1]=d.y,c[Zp.AMBIENT_SKY_OFFSET+2]=d.z,c[Zp.AMBIENT_SKY_OFFSET+3]=d.w,c[Zp.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,c[Zp.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,c[Zp.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,c[Zp.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,Gi.toArray(c,i.matView,Zp.MAT_VIEW_OFFSET),Gi.toArray(c,i.node.worldMatrix,Zp.MAT_VIEW_INV_OFFSET),Ei.toArray(c,i.position,Zp.CAMERA_POS_OFFSET),Gi.toArray(c,i.matProj,Zp.MAT_PROJ_OFFSET),Gi.toArray(c,i.matProjInv,Zp.MAT_PROJ_INV_OFFSET),Gi.toArray(c,i.matViewProj,Zp.MAT_VIEW_PROJ_OFFSET),Gi.toArray(c,i.matViewProjInv,Zp.MAT_VIEW_PROJ_INV_OFFSET),c[Zp.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=a.colorArray;c[Zp.GLOBAL_FOG_COLOR_OFFSET]=m.x,c[Zp.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,c[Zp.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,c[Zp.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,c[Zp.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,c[Zp.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,c[Zp.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,c[Zp.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,c[Zp.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,c[Zp.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten,c[Zp.NEAR_FAR_OFFSET]=i.nearClip,c[Zp.NEAR_FAR_OFFSET+1]=i.farClip,c[Zp.VIEW_PORT_OFFSET]=r.shadingScale*i.window.width*i.viewport.x,c[Zp.VIEW_PORT_OFFSET+1]=r.shadingScale*i.window.height*i.viewport.y,c[Zp.VIEW_PORT_OFFSET+2]=r.shadingScale*i.window.width*i.viewport.z,c[Zp.VIEW_PORT_OFFSET+3]=r.shadingScale*i.window.height*i.viewport.w},t.updateShadowUBOView=function(t,e,i){var n=t.device,r=i.scene.mainLight,o=t.pipelineSceneData.shadows,a=e;if(o.enabled){if(r&&o.type===yg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Gi.toArray(e,l,$p.MAT_LIGHT_VIEW_OFFSET),a[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[$p.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[$p.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[$p.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[$p.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Gi.toArray(e,h,$p.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=$d(n)?0:1;a[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===yg.Planar&&(Zg(o,r,a),$g(o,a));Ti.toArray(a,o.shadowColor,$p.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,i){var n=t.device,r=t.pipelineSceneData.shadows,o=e,a=$d(n)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(i.type){case ry.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Gi.toArray(e,l,$p.MAT_LIGHT_VIEW_OFFSET),o[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[$p.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[$p.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[$p.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[$p.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Gi.toArray(e,h,$p.MAT_LIGHT_VIEW_PROJ_OFFSET),Ay.set(s,c,0,1-r.saturation),Ji.toArray(o,Ay,$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ay.set(0,a,r.normalBias,0),Ji.toArray(o,Ay,$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case ry.SPOT:Gi.invert(Sy,i.node.getWorldMatrix()),Gi.toArray(o,Sy,$p.MAT_LIGHT_VIEW_OFFSET),Gi.perspective(by,i.angle,i.aspect,.001,i.range),Gi.multiply(Cy,by,Sy),Gi.toArray(o,Cy,$p.MAT_LIGHT_VIEW_PROJ_OFFSET),Ay.set(.01,i.range,0,1-r.saturation),Ji.toArray(o,Ay,$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ay.set(1,a,r.normalBias,0),Ji.toArray(o,Ay,$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Ay.set(r.size.x,r.size.y,r.pcf,r.bias),Ji.toArray(o,Ay,$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Ti.toArray(o,r.shadowColor,$p.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var i=this._pipeline.descriptorSet;this._initCombineSignY();var n=t.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,Qp.SIZE,Qp.SIZE));i.bindBuffer(Qp.BINDING,n);var r=t.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,Zp.SIZE,Zp.SIZE));i.bindBuffer(Zp.BINDING,r);var o=t.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,$p.SIZE,$p.SIZE));i.bindBuffer($p.BINDING,o)},e.updateGlobalUBO=function(e){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;n.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(n.getBuffer(Qp.BINDING),this._globalUBO),i.bindBuffer(Qp.BINDING,n.getBuffer(Qp.BINDING)),i.update()},e.updateCameraUBO=function(e){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(n.getBuffer(Zp.BINDING),this._cameraUBO),i.bindBuffer(Zp.BINDING,n.getBuffer(Zp.BINDING)),i.update()},e.updateShadowUBO=function(e){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=i.shadowFrameBufferMap,a=e.scene.mainLight;a&&o.has(a)&&n.bindTexture(td,o.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,e),n.update(),r[0].updateBuffer(n.getBuffer($p.BINDING),this._shadowUBO)}},e.updateShadowUBOLight=function(e,i){t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i),e.bindTexture(td,Mv.get("default-texture").getGFXTexture()),e.bindTexture(ld,Mv.get("default-texture").getGFXTexture()),e.update(),e.getBuffer($p.BINDING).update(this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof Gi?Gi.toArray(this._shadowUBO,e,t):e instanceof Ti&&Ti.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();wy._combineSignY=0;var Ey,Py,Iy,Ry,Dy,My,Oy,By,Ny,Ly,Fy,zy,Vy,ky=t("RenderStage",(ly=pc("RenderStage"),uy=Uc(),hy=Uc(),_y=Uc(),ly((gy=function(){function t(){ct(this,"_name",dy,this),ct(this,"_priority",my,this),this._enabled=!0,ct(this,"_tag",vy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},Q(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),dy=lt((py=gy).prototype,"_name",[uy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),my=lt(py.prototype,"_priority",[hy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vy=lt(py.prototype,"_tag",[_y,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fy=py))||fy));u.RenderStage=ky;var Uy,Gy=t("RenderFlow",(Ey=pc("RenderFlow"),Py=Uc(),Iy=Uc(),Ry=Uc(),Dy=Uc(),My=Kc([ky]),Ey((Vy=function(){function t(){ct(this,"_name",Ny,this),ct(this,"_priority",Ly,this),ct(this,"_tag",Fy,this),ct(this,"_stages",zy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,i=this._stages.length;e<i;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,i=this._stages.length;e<i;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},Q(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),Ny=lt((By=Vy).prototype,"_name",[Py,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ly=lt(By.prototype,"_priority",[Iy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fy=lt(By.prototype,"_tag",[Ry,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zy=lt(By.prototype,"_stages",[Dy,My,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oy=By))||Oy));u.RenderFlow=Gy,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Uy||(Uy=t("PipelineEventType",{})));var Hy,jy,Wy,qy,Xy,Yy,Ky,Jy,Qy,Zy,$y,tx,ex,ix,nx,rx=t("PipelineEventProcessor",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}$(e,t);var i=e.prototype;return i.on=function(t,e,i,n){return this.eventTargetOn(t,e,i,n)},i.once=function(t,e,i){return this.eventTargetOnce(t,e,i)},e}(eu)),ox=new $n,ax=new ar,sx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},cx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},lx=t("RenderPipeline",(Hy=pc("cc.RenderPipeline"),jy=Uc(),Wy=Uc(),qy=Kc([Gy]),Hy((Qy=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_tag",Ky,ot(e)),ct(e,"_flows",Jy,ot(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new rx,e._commandBuffers=[],e._pipelineUBO=new wy,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new $n,e._clusterEnabled=!1,e._bloomEnabled=!1,e}$(e,t);var i=e.prototype;return i.getPipelineRenderData=function(){return this._pipelineRenderData},i.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},i.createRenderPass=function(t,e,i){var n=this._device,r=new Dr,o=new Mr;r.format=e,o.format=i,o.stencilStoreOp=On.DISCARD,o.depthStoreOp=On.DISCARD,t&Xn.COLOR||(t&dg?r.loadOp=Mn.DISCARD:(r.loadOp=Mn.LOAD,r.beginAccesses=[Bn.COLOR_ATTACHMENT_WRITE])),(t&Xn.DEPTH_STENCIL)!==Xn.DEPTH_STENCIL&&(t&Xn.DEPTH||(o.depthLoadOp=Mn.LOAD),t&Xn.STENCIL||(o.stencilLoadOp=Mn.LOAD)),o.beginAccesses=[Bn.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Nr([r],o);return n.createRenderPass(a)},i.getRenderPass=function(t,e){var i=this._renderPasses.get(t);return i||(i=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,i),i)},i.applyFramebufferRatio=function(t){for(var e=this.pipelineSceneData,i=this._width*e.shadingScale,n=this._height*e.shadingScale,r=t.colorTextures,o=0;o<r.length;o++)r[o].resize(i,n);t.depthStencilTexture&&t.depthStencilTexture.resize(i,n),t.destroy(),t.initialize(new zr(t.renderPass,r,t.depthStencilTexture))},i.generateRenderArea=function(t,e){var i=t.viewport,n=t.window.width,r=t.window.height;e.x=i.x*n,e.y=i.y*r,e.width=i.width*n,e.height=i.height*r},i.generateViewport=function(t,e){this.generateRenderArea(t,ox),e||(e=ax);var i=this.pipelineSceneData.shadingScale;return e.left=ox.x*i,e.top=ox.y*i,e.width=ox.width*i,e.height=ox.height*i,e},i.generateScissor=function(t,e){e||(e=ox),this.generateRenderArea(t,e);var i=this.pipelineSceneData.shadingScale;return e.x*=i,e.y*=i,e.width*=i,e.height*=i,e},i.activate=function(){var t=u.director.root;this._device=t.device,this._generateConstantMacros(),this._globalDSManager=new sy(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},i._ensureEnoughSize=function(){},i.render=function(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(Uy.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var i=t[e];if(i.window.swapchain)return void(tg=i)}tg=null}(t);for(var e=0;e<t.length;e++){var i=t[e];if(i.scene){this.emit(Uy.RENDER_CAMERA_BEGIN,i),ty(this,i),ey(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i);this.emit(Uy.RENDER_CAMERA_END,i)}}this.emit(Uy.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},i._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},i._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var i=0;i<e.downsampleTexs.length;++i)e.downsampleTexs[i].destroy(),e.downsampleFramebuffers[i].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var n=0;n<e.upsampleTexs.length;++n)e.upsampleTexs[n].destroy(),e.upsampleFramebuffers[n].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},i._genQuadVertexData=function(t,e){var i=new Float32Array(16),n=e.x/this._width,r=(e.x+e.width)/this._width,o=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(t){case un.IDENTITY:c=0,i[c++]=-1,i[c++]=-1,i[c++]=n,i[c++]=a,i[c++]=1,i[c++]=-1,i[c++]=r,i[c++]=a,i[c++]=-1,i[c++]=1,i[c++]=n,i[c++]=o,i[c++]=1,i[c++]=1,i[c++]=r,i[c++]=o;break;case un.ROTATE_90:c=0,i[c++]=-1,i[c++]=-1,i[c++]=r,i[c++]=a,i[c++]=1,i[c++]=-1,i[c++]=r,i[c++]=o,i[c++]=-1,i[c++]=1,i[c++]=n,i[c++]=a,i[c++]=1,i[c++]=1,i[c++]=n,i[c++]=o;break;case un.ROTATE_180:c=0,i[c++]=-1,i[c++]=-1,i[c++]=n,i[c++]=o,i[c++]=1,i[c++]=-1,i[c++]=r,i[c++]=o,i[c++]=-1,i[c++]=1,i[c++]=n,i[c++]=a,i[c++]=1,i[c++]=1,i[c++]=r,i[c++]=a;break;case un.ROTATE_270:c=0,i[c++]=-1,i[c++]=-1,i[c++]=n,i[c++]=o,i[c++]=1,i[c++]=-1,i[c++]=n,i[c++]=a,i[c++]=-1,i[c++]=1,i[c++]=r,i[c++]=o,i[c++]=1,i[c++]=1,i[c++]=r,i[c++]=a}return i},i._createQuadInputAssembler=function(){var t=new cx,e=4*Float32Array.BYTES_PER_ELEMENT,i=4*e,n=this._device.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE|gn.HOST,i,e));if(!n)return t;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,o,r));if(!a)return t;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Pr("a_position",_n.RG32F),c[1]=new Pr("a_texCoord",_n.RG32F);var l=this._device.createInputAssembler(new Rr(c,[n],a));return t.quadIB=a,t.quadVB=n,t.quadIA=l,t},i.updateQuadVertexData=function(t,e){var i=this._lastUsedRenderArea;if(i.x!==t.x||i.y!==t.y||i.width!==t.width||i.height!==t.height){var n=this._genQuadVertexData(un.IDENTITY,t);this._quadVBOffscreen.update(n);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||un.IDENTITY,t);this._quadVBOnscreen.update(r),i.copy(t)}},i.destroy=function(){for(var e,i,n=0;n<this._flows.length;n++)this._flows[n].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),t.prototype.destroy.call(this)},i._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(hn.TEXTURE_FLOAT)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(hn.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(du.os===au.ANDROID&&du.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ue.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=t},i.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new sx,e=this.device,i=new Dr;i.format=_n.RGBA8,i.loadOp=Mn.CLEAR,i.storeOp=On.STORE,i.endAccesses=[Bn.COLOR_ATTACHMENT_WRITE],t.renderPass=e.createRenderPass(new Nr([i]));var n=this._width,r=this._height;t.prefiterTex=e.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,_n.RGBA8,n>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new zr(t.renderPass,[t.prefiterTex])),n>>=1,r>>=1;for(var o=0;o<6;++o)t.downsampleTexs.push(e.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,_n.RGBA8,n>>1,r>>1))),t.downsampleFramebuffers[o]=e.createFramebuffer(new zr(t.renderPass,[t.downsampleTexs[o]])),t.upsampleTexs.push(e.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,_n.RGBA8,n,r))),t.upsampleFramebuffers[o]=e.createFramebuffer(new zr(t.renderPass,[t.upsampleTexs[o]])),n>>=1,r>>=1;t.combineTex=e.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,_n.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new zr(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},i.on=function(t,e,i,n){return this._eventProcessor.on(t,e,i,n)},i.once=function(t,e,i){return this._eventProcessor.once(t,e,i)},i.off=function(t,e,i){this._eventProcessor.off(t,e,i)},i.emit=function(t,e,i,n,r,o){this._eventProcessor.emit(t,e,i,n,r,o)},i.targetOff=function(t){this._eventProcessor.targetOff(t)},i.removeAll=function(t){this._eventProcessor.removeAll(t)},i.hasEventListener=function(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)},Q(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}}]),e}(Mu),Ky=lt((Yy=Qy).prototype,"_tag",[jy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jy=lt(Yy.prototype,"_flows",[Wy,qy,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xy=Yy))||Xy));u.RenderPipeline=lx,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(Zy||(Zy={})),function(t){t[t.FORWARD=10]="FORWARD"}($y||($y={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(tx||(tx={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(ex||(ex={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(ix||(ix={}));var ux=new Dr;ux.format=_n.RGBA8,ux.beginAccesses=[Bn.FRAGMENT_SHADER_READ_TEXTURE],ux.endAccesses=[Bn.FRAGMENT_SHADER_READ_TEXTURE];var hx=new Mr;hx.format=_n.DEPTH_STENCIL;var _x,fx,px,dx,mx,vx,gx,yx,xx,Sx,bx,Cx,Ax,Tx,wx,Ex,Px,Ix,Rx,Dx,Mx,Ox,Bx,Nx,Lx,Fx,zx,Vx,kx,Ux,Gx,Hx,jx,Wx,qx,Xx,Yx,Kx,Jx,Qx,Zx,$x,tS,eS,iS,nS,rS,oS,aS,sS,cS,lS,uS,hS,_S,fS,pS,dS,mS,vS,gS,yS,xS,SS,bS,CS,AS,TS,wS,ES,PS,IS,RS,DS,MS,OS,BS,NS,LS,FS=new Nr([ux],hx),zS={width:1,height:1,renderPassInfo:FS},VS=t("RenderTexture",pc("cc.RenderTexture")(nx=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._window=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},i.reset=function(t){this.initialize(t)},i.destroy=function(){if(this._window){var e=u.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},i.resize=function(t,e){this._width=Math.floor(ai(t,1,2048)),this._height=Math.floor(ai(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},i._serialize=function(){return{}},i._deserialize=function(e,i){var n=e;this._width=n.w,this._height=n.h,this._name=n.n,t.prototype._deserialize.call(this,n.base,i)},i.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},i.onLoaded=function(){this._initWindow()},i._initWindow=function(t){var e=u.director.root;zS.title=this._name,zS.width=this._width,zS.height=this._height,zS.renderPassInfo=t&&t.passInfo?t.passInfo:FS,this._window?(this._window.destroy(),this._window.initialize(e.device,zS)):this._window=e.createWindow(zS)},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},i.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},i.readPixels=function(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),i=i||this.width,n=n||this.height;var o=this.getGFXTexture();if(!o)return O(7606),null;var a=4*i*n;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return O(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new or;return u.texOffset.x=t,u.texOffset.y=e,u.texExtent.width=i,u.texExtent.height=n,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},Q(e,[{key:"window",get:function(){return this._window}}]),e}(Zm))||nx);u.RenderTexture=VS,ce(yn),ce(xn),ce(On),ce(Mn),ce(Bn),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(LS||(LS={})),ce(LS),_x=pc("RenderTextureDesc"),fx=Kc(yn),px=Kc(xn),dx=Kc(_n),_x((vx=lt((mx=function(){ct(this,"name",vx,this),ct(this,"type",gx,this),ct(this,"usage",yx,this),ct(this,"format",xx,this),ct(this,"width",Sx,this),ct(this,"height",bx,this)}).prototype,"name",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gx=lt(mx.prototype,"type",[fx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yn.TEX2D}}),yx=lt(mx.prototype,"usage",[px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xn.COLOR_ATTACHMENT}}),xx=lt(mx.prototype,"format",[dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _n.UNKNOWN}}),Sx=lt(mx.prototype,"width",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),bx=lt(mx.prototype,"height",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),mx));var kS,US=(Cx=pc("RenderTextureConfig"),Ax=Kc(VS),Cx((Ex=lt((wx=function(){ct(this,"name",Ex,this),ct(this,"texture",Px,this)}).prototype,"name",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Px=lt(wx.prototype,"texture",[Ax],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tx=wx))||Tx),GS=(Ix=pc("MaterialConfig"),Rx=Kc(cg),Ix((Mx=lt((Dx=function(){ct(this,"name",Mx,this),ct(this,"material",Ox,this)}).prototype,"name",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ox=lt(Dx.prototype,"material",[Rx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dx)),Bx=pc("FrameBufferDesc"),Nx=Kc([Ne]),Lx=Kc(VS),Bx((zx=lt((Fx=function(){ct(this,"name",zx,this),ct(this,"renderPass",Vx,this),ct(this,"colorTextures",kx,this),ct(this,"depthStencilTexture",Ux,this),ct(this,"texture",Gx,this)}).prototype,"name",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Vx=lt(Fx.prototype,"renderPass",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kx=lt(Fx.prototype,"colorTextures",[Nx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ux=lt(Fx.prototype,"depthStencilTexture",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gx=lt(Fx.prototype,"texture",[Lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fx)),Hx=pc("ColorDesc"),jx=Kc(_n),Wx=Kc(Mn),qx=Kc(On),Xx=Kc([Bn]),Yx=Kc([Bn]),Hx((Qx=lt((Jx=function(){ct(this,"format",Qx,this),ct(this,"loadOp",Zx,this),ct(this,"storeOp",$x,this),ct(this,"sampleCount",tS,this),ct(this,"beginAccesses",eS,this),ct(this,"endAccesses",iS,this)}).prototype,"format",[jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _n.UNKNOWN}}),Zx=lt(Jx.prototype,"loadOp",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.CLEAR}}),$x=lt(Jx.prototype,"storeOp",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.STORE}}),tS=lt(Jx.prototype,"sampleCount",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eS=lt(Jx.prototype,"beginAccesses",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iS=lt(Jx.prototype,"endAccesses",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Bn.COLOR_ATTACHMENT_WRITE]}}),Kx=Jx))||Kx),HS=(nS=pc("DepthStencilDesc"),rS=Kc(_n),oS=Kc(Mn),aS=Kc(On),sS=Kc(Mn),cS=Kc(On),lS=Kc([Bn]),uS=Kc([Bn]),nS((fS=lt((_S=function(){ct(this,"format",fS,this),ct(this,"depthLoadOp",pS,this),ct(this,"depthStoreOp",dS,this),ct(this,"stencilLoadOp",mS,this),ct(this,"stencilStoreOp",vS,this),ct(this,"sampleCount",gS,this),ct(this,"beginAccesses",yS,this),ct(this,"endAccesses",xS,this)}).prototype,"format",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _n.UNKNOWN}}),pS=lt(_S.prototype,"depthLoadOp",[oS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.CLEAR}}),dS=lt(_S.prototype,"depthStoreOp",[aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.STORE}}),mS=lt(_S.prototype,"stencilLoadOp",[sS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.CLEAR}}),vS=lt(_S.prototype,"stencilStoreOp",[cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return On.STORE}}),gS=lt(_S.prototype,"sampleCount",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yS=lt(_S.prototype,"beginAccesses",[lS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xS=lt(_S.prototype,"endAccesses",[uS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Bn.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),hS=_S))||hS);SS=pc("RenderPassDesc"),bS=Kc([GS]),CS=Kc(HS),SS((TS=lt((AS=function(){ct(this,"index",TS,this),ct(this,"colorAttachments",wS,this),ct(this,"depthStencilAttachment",ES,this)}).prototype,"index",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),wS=lt(AS.prototype,"colorAttachments",[bS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ES=lt(AS.prototype,"depthStencilAttachment",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HS}}),AS)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(kS||(kS={})),ce(kS);var jS=(PS=pc("RenderQueueDesc"),IS=Kc(kS),RS=Kc([Ne]),PS((OS=lt((MS=function(){ct(this,"isTransparent",OS,this),ct(this,"sortMode",BS,this),ct(this,"stages",NS,this)}).prototype,"isTransparent",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BS=lt(MS.prototype,"sortMode",[IS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kS.FRONT_TO_BACK}}),NS=lt(MS.prototype,"stages",[RS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DS=MS))||DS);function WS(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function qS(t,e){return t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var XS=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new Wl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new ql(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,i){var n=t.model.subModels[e],r=n.passes[i],o=n.shaders[i];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|n.priority<<8|i,s=this._passPool.add();return s.hash=a,s.depth=t.depth||0,s.shaderId=o.typedID,s.subModel=n,s.passIdx=i,this.queue.push(s),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=kv.getOrCreatePipelineState(t,c,l,e,s);i.bindPipelineState(u),i.bindDescriptorSet(Xp.MATERIAL,c.descriptorSet),i.bindDescriptorSet(Xp.LOCAL,o.descriptorSet),i.bindInputAssembler(s),i.draw(s)}},t}();function YS(t){for(var e=0,i=0;i<t.stages.length;i++)e|=Ov(t.stages[i]);var n=WS;switch(t.sortMode){case kS.BACK_TO_FRONT:n=qS;break;case kS.FRONT_TO_BACK:n=WS}return new XS({isTransparent:t.isTransparent,phases:e,sortFunc:n})}function KS(t){t.clear()}function JS(t){t.sort()}var QS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),i=e.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}i=e.next()}},e.recordCommandBuffer=function(t,e,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=kv.getOrCreatePipelineState(t,s.pass,c,e,s.ia);i.bindPipelineState(l),i.bindDescriptorSet(Xp.MATERIAL,s.pass.descriptorSet),o=!0}i.bindDescriptorSet(Xp.LOCAL,s.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(s.ia),i.draw(s.ia)}}r=n.next()}},t}(),ZS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),i=e.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(t),i=e.next()},e.recordCommandBuffer=function(t,e,i){for(var n=this.queue.values(),r=n.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){i.bindDescriptorSet(Xp.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=kv.getOrCreatePipelineState(t,s,h,e,u.ia);c!==_&&(i.bindPipelineState(_),c=_),i.bindDescriptorSet(Xp.LOCAL,u.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(u.ia),i.draw(u.ia)}}}r=n.next()}},t}(),$S=function(){function t(){this._groundAlbedoHDR=new Ji(.2,.2,.2,1),this._skyColorHDR=new Ji(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Ji(.2,.2,.2,1),this._skyColorLDR=new Ji(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var e=t.prototype;return e.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},e._destroy=function(){},e.destroy=function(){this._destroy()},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(t){this._mipmapCount=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();$S.SUN_ILLUM=65e3,$S.SKY_ILLUM=2e4,u.Ambient=$S;var tb,eb=function(){function t(){this._enabled=!1,this._minPos=new Ei(0,0,0),this._maxPos=new Ei(0,0,0),this._depth=0}var e=t.prototype;return e.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e._destroy=function(){},e.destroy=function(){this._destroy()},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),ib=new Ur(null),nb=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Fp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var e=t.prototype;return e._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},e._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},e._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},e._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},e._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},e._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},e._setSubMesh=function(t){this._subMesh=t},e._init=function(){},e.initialize=function(t,e,i){void 0===i&&(i=null);var n=u.director.root;this._device=n.device,ib.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(ib);var r=u.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Ur(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(t),this._patches=i,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===Pv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Fp.DEFAULT,e[0].phase===Ov("reflection")){var a=n.mainWindow.width,s=n.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new mr(yn.TEX2D,xn.STORAGE|xn.TRANSFER_SRC|xn.SAMPLED,_n.RGBA8,a,s)),this.descriptorSet.bindTexture(Gd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new gr(An.LINEAR,An.LINEAR,An.NONE,Tn.CLAMP,Tn.CLAMP,Tn.CLAMP)),this.descriptorSet.bindSampler(Gd,this._reflectionSampler),this.descriptorSet.bindTexture(Wd,this._reflectionTex)}},e._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowShader=function(){var t=u.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},e._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=u.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},e._destroy=function(){},e.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Fp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var i=0;i<e.length;i++){var n=e[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,i=t.length;e<i;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},Q(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?O(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===Pv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),ib.layout=t[0].localSetLayout,this._createDescriptorSet(ib)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===Pv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}(),rb=new Gi,ob=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(tb||(tb={}));var ab=new gr(An.LINEAR,An.LINEAR,An.NONE,Tn.CLAMP,Tn.CLAMP,Tn.CLAMP),sb=new gr(An.LINEAR,An.LINEAR,An.LINEAR,Tn.CLAMP,Tn.CLAMP,Tn.CLAMP),cb=function(){function t(){this.type=tb.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(_d.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Ji,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Np.Enum.NONE,this._device=u.director.root.device}var e=t.prototype;return e._setReceiveShadow=function(t){this._receiveShadow=t},e._init=function(){},e.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Np.Enum.NONE,this._inited=!0)},e._destroySubmodel=function(t){t.destroy()},e._destroy=function(){},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var i=this._subModels[e];this._destroySubmodel(i)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e._applyLocalData=function(){},e._applyLocalBuffer=function(){},e._applyWorldBoundBuffer=function(){},e.updateUBOs=function(t){for(var e=this._subModels,i=0;i<e.length;i++)e[i].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var n=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(t,e,i,n){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,i[0]=t.m04,i[1]=t.m05,i[2]=t.m06,i[3]=t.m13,n[0]=t.m08,n[1]=t.m09,n[2]=t.m10,n[3]=t.m14}(n,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Gi.toArray(this._localData,n,_d.MAT_WORLD_OFFSET),Gi.inverseTranspose(rb,n);var a=Math.abs(Gi.determinant(rb)),s=1/Math.sqrt(a);Gi.multiplyScalar(rb,rb,s),Gi.toArray(this._localData,rb,_d.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},e._updateNativeBounds=function(){},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=Ws.fromPoints(Ws.create(),t,e),this._worldBounds=Ws.clone(this._modelBounds),this._updateNativeBounds())},e._createSubModel=function(){return new nb},e.initSubModel=function(t,e,i){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){Ji.toArray(this._localData,e,_d.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Mv.get("empty-texture"));var i=t.getGFXTexture();if(i)for(var n=this._device.getSampler(t.mipmaps.length>1?sb:ab),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Ld,i),a.bindSampler(Ld,n),a.update()}},e.getMacroPatches=function(){return this.receiveShadow?ob:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var i=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(i.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,i=0;i<e.length;i++)if(e[i].name===t)return i;return-1},e._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(hn.INSTANCED_ARRAYS)){for(var i=0,n=0;n<t.length;n++){var r=t[n];r.isInstanced&&(i+=Zr[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(i),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<t.length;s++){var c=t[s];if(c.isInstanced){var l=new Pr;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=Zr[c.format],h=new(co(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}e.batchingScheme===Pv.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(pd)),this._localDataUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.DEVICE,_d.SIZE,_d.SIZE)),this._applyLocalBuffer())},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.DEVICE,fd.SIZE,fd.SIZE)),this._applyWorldBoundBuffer())},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(_d.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(fd.BINDING,this._worldBoundBuffer)},Q(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),lb=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.activate=function(){},e.update=function(t){var e=this._mainLight;e&&e.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(t),c.updateUBOs(t))}},e._destroy=function(){},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=st(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=ny.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=st(this._models);!(t=e()).done;){var i=t.value;i.detachFromScene(),i.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=st(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},e._createNativeObject=function(){},Q(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}();U(lb.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),U(lb.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var ub={};U(ub,"CameraVisFlags",[{name:"GENERAL"}]),k(ub,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Np.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Np.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Np.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Np.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Np.BitMask,targetName:"UI_2D"}]),u.CameraVisFlags=ub;var hb={};U(hb,"VisibilityFlags",[{name:"GENERAL"}]),k(hb,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Np.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Np.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Np.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Np.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Np.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Np.Enum,targetName:"UI_2D"}]),u.VisibilityFlags=hb,k(Vv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),U(vg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),U(bg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]);var _b=new Ei(0,0,-1),fb=new Ei,pb=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new Ei(1,-1,-1),e._illuminanceHDR=$S.SUN_ILLUM,e._illuminanceLDR=1,e._type=ry.DIRECTIONAL,e}$(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this.illuminance=$S.SUN_ILLUM,this.direction=new Ei(1,-1,-1)},i.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Ei.transformQuat(fb,_b,this._node.worldRotation))},Q(e,[{key:"direction",get:function(){return this._dir},set:function(t){Ei.normalize(this._dir,t)}},{key:"illuminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),e}(xy),db=function(t){function e(e,i){var n;(n=t.call(this,e.root)||this)._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=e,n._owner=i,n._doInit(n._parent,!0);for(var r=0;r<n._shaderInfo.blocks.length;r++){var o=n._shaderInfo.blocks[r],a=n._blocks[o.binding],s=n._parent.blocks[o.binding];a.set(s)}n._setRootBufferDirty(!0);for(var c=n._parent,l=0;l<n._shaderInfo.samplerTextures.length;l++)for(var u=n._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);n._descriptorSet.bindSampler(u.binding,_,h),n._descriptorSet.bindTexture(u.binding,f,h)}return t.prototype.tryCompile.call(ot(n)),n}$(e,t);var i=e.prototype;return i.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Vv.fillPipelineInfo(this,t),Vv.fillPipelineInfo(this,e),this._onStateChange()},i.tryCompile=function(e){if(e&&!fm(this._defines,e))return!1;var i=t.prototype.tryCompile.call(this);return this._onStateChange(),i},i.beginChangeStatesSilently=function(){this._dontNotify=!0},i.endChangeStatesSilently=function(){this._dontNotify=!1},i._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Pv.NONE)},i._onStateChange=function(){this._setHash(Vv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},Q(e,[{key:"parent",get:function(){return this._parent}}]),e}(Vv),mb=function(t){function e(e){var i;return(i=t.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=e.parent,i._owner=e.owner||null,i._subModelIdx=e.subModelIdx||0,i.copy(i._parent),i}$(e,t);var i=e.prototype;return i.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var i,n=st(this._passes);!(i=n()).done;)i.value.tryCompile(t);else this._passes[e].tryCompile(t)},i.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],o=this._states[n]||(this._states[n]={});for(var a in t)o[a]=t[a];r.overridePipelineStates(i[r.passIndex],o)}else{var s=this._states[e]||(this._states[e]={});for(var c in t)s[c]=t[c];this._passes[e].overridePipelineStates(i[e],s)}}},i.destroy=function(){return this._doDestroy(),!0},i.onPassStateChange=function(t){this._hash=cg.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},i._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var i=0;i<e.length;++i)t.push(new db(e[i],this));return t},Q(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}(cg),vb=null,gb=null,yb=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var e=t.prototype;return e._setEnabled=function(t){this._enabled=t},e._setUseIBL=function(t){this._useIBL=t},e._setUseHDR=function(t){this._useHDR=t},e._setUseDiffuseMap=function(t){this._useDiffuseMap=t},e.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var i=u.director.root;i.pipeline.pipelineSceneData.isHDR?t&&(i.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel):e&&(i.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=u.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=Mv.get("default-cube-texture"),this._model||(this._model=u.director.root.createModel(u.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!gb){var i=new cg;i.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),gb=new mb({parent:i})}this.enabled&&(vb||(vb=u.utils.createMesh(u.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,vb.renderingSubMeshes[0],gb)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},e._updatePipeline=function(){var t=u.director.root,e=t.pipeline,i=this.useIBL?this.isRGBE?2:1:0,n=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;e.macros.CC_USE_IBL===i&&e.macros.CC_USE_DIFFUSEMAP===n&&e.macros.CC_USE_HDR===r||(e.macros.CC_USE_IBL=i,e.macros.CC_USE_DIFFUSEMAP=n,e.macros.CC_USE_HDR=r,t.onGlobalPipelineStateChanged()),this.enabled&&gb&&gb.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,gb)},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=u.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var i=e.getGFXTexture(),n=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(nd,n),this._globalDSManager.bindTexture(nd,i)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=t.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(ad,a),this._globalDSManager.bindTexture(ad,o)}this._globalDSManager.update()}},e._destroy=function(){},e.destroy=function(){this._destroy()},Q(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}();u.Skybox=yb;var xb=function(t){$(i,t);var e=i.prototype;function i(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=Ws.create(),e._pos=new Ei,e._type=ry.SPHERE,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/yy(.15),this.luminanceLDR=1},e.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;Ws.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},Q(i,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),i}(xy),Sb=new Ei(0,0,-1),bb=new Bi,Cb=new Gi,Ab=new Gi,Tb=new Gi,wb=new Gi,Eb=function(t){$(i,t);var e=i.prototype;function i(){var e;return(e=t.call(this)||this)._dir=new Ei(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=Ws.create(),e._frustum=nc.create(),e._pos=new Ei,e._type=ry.SPOT,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e._setDirection=function(t){this._dir.set(t)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/yy(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new Ei(1,-1,-1))},e.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Ei.transformQuat(this._dir,Sb,this._node.getWorldRotation(bb)),Ei.normalize(this._dir,this._dir),Ws.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Cb),Gi.invert(Cb,Cb),Gi.perspective(Ab,this._angle,1,.001,this._range),Gi.multiply(Tb,Ab,Cb),this._frustum.update(Tb,wb),this._needUpdate=!1)},Q(i,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),i}(xy),Pb=Object.freeze({__proto__:null,Ambient:$S,Octree:eb,get CameraFOVAxis(){return ig},get CameraProjection(){return ng},get CameraAperture(){return rg},get CameraISO(){return og},get CameraShutter(){return ag},SKYBOX_FLAG:dg,Camera:vg,CameraVisFlags:ub,VisibilityFlags:hb,DirectionalLight:pb,ColorTemperatureToRGB:cy,get LightType(){return ry},nt2lm:yy,Light:xy,get ModelType(){return tb},Model:cb,ShadowSize:gg,ShadowType:yg,PCFType:xg,Shadows:bg,RenderScene:lb,Skybox:yb,SphereLight:xb,SpotLight:Eb,SubModel:nb,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),Ib=new jl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Rb=new Float32Array(4),Db=[],Mb=[],Ob=new Gi,Bb=new Gi;function Nb(t,e){return!(!e.worldBounds||hs.aabbWithAABB(e.worldBounds,t.aabb))}function Lb(t,e){return!(!e.worldBounds||hs.aabbWithAABB(e.worldBounds,t.aabb)&&hs.aabbFrustum(e.worldBounds,t.frustum))}var Fb=Ov("forward-add"),zb=[];function Vb(t,e){e.length=0;for(var i=!1,n=0;n<t.length;n++){for(var r=t[n].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===Fb){o=a,i=!0;break}e.push(o)}return i}var kb,Ub,Gb,Hb,jb,Wb,qb,Xb,Yb,Kb,Jb,Qb=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array($p.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new ZS,this._batchedQueue=new QS;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(md.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new _r(this._lightBuffer,0,md.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}Ib.freeArray(this._lightPasses),this._lightPasses.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,i=0;i<e.length;i++){var n=e[i],r=t.get(n);r&&(r.getBuffer($p.BINDING).destroy(),r.getTexture(td).destroy(),r.getTexture(ld).destroy(),r.destroy()),t.delete(n)}},e.gatherLightPasses=function(t,e){this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var n=this._pipeline.pipelineSceneData.renderObjects,r=0;r<n.length;r++){var o=n[r].model,a=o.subModels;if(Vb(a,zb)&&(Mb.length=0,this._lightCulling(o,i),Mb.length))for(var s=0;s<a.length;s++){var c=zb[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(md.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,i){this._instancedQueue.recordCommandBuffer(t,e,i),this._batchedQueue.recordCommandBuffer(t,e,i);for(var n=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=kv.getOrCreatePipelineState(t,u,h,e,_),p=u.descriptorSet,d=a.descriptorSet;i.bindPipelineState(f),i.bindDescriptorSet(Xp.MATERIAL,p),i.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=n.getOrCreateDescriptorSet(v);Db[0]=c[m],i.bindDescriptorSet(Xp.GLOBAL,g),i.bindDescriptorSet(Xp.LOCAL,d,Db),i.draw(_)}}},e._lightCulling=function(t,e){for(var i=0;i<e.length;i++){var n=e[i],r=!1;switch(n.type){case ry.SPHERE:r=Nb(n,t);break;case ry.SPOT:r=Lb(n,t)}r||Mb.push(i)}},e._addRenderQueue=function(t,e,i,n){var r=t.batchingScheme;if(r===Pv.INSTANCING)for(var o=0;o<Mb.length;o++){var a=Mb[o],s=t.getInstancedBuffer(a);s.merge(e,i.instancedAttributes,n),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Pv.VB_MERGING)for(var c=0;c<Mb.length;c++){var l=Mb[c],u=t.getBatchedBuffer(l);u.merge(e,n,i),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=Ib.alloc();h.subModel=e,h.passIdx=n;for(var _=0;_<Mb.length;_++){var f=Mb[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},e._updateLightDescriptorSet=function(t,e){for(var i=this._pipeline.device,n=this._pipeline.pipelineSceneData,r=n.shadows,o=n.shadowFrameBufferMap,a=t.scene.mainLight,s=$d(i)?0:1,c=this._pipeline.globalDSManager,l=n.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,p=void 0;switch(h.type){case ry.SPHERE:a&&(Zg(r,a,this._shadowUBO),$g(r,this._shadowUBO)),this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Ti.toArray(this._shadowUBO,r.shadowColor,$p.SHADOW_COLOR_OFFSET);break;case ry.SPOT:if(a&&(Zg(r,a,this._shadowUBO),$g(r,this._shadowUBO)),Gi.invert(Ob,h.node.getWorldMatrix()),Gi.perspective(Bb,h.angle,h.aspect,.001,h.range),f=Bb.clone(),p=Bb.clone().invert(),Gi.multiply(Bb,Bb,Ob),Gi.toArray(this._shadowUBO,Ob,$p.MAT_LIGHT_VIEW_OFFSET),Gi.toArray(this._shadowUBO,Bb,$p.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[$p.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[$p.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[$p.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[$p.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[$p.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[$p.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[$p.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[$p.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[$p.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[$p.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[$p.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[$p.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Ti.toArray(this._shadowUBO,r.shadowColor,$p.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&_.bindTexture(ld,m)}}_.update(),e.updateBuffer(_.getBuffer($p.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var i=t.exposure,n=this._pipeline.pipelineSceneData,r=n.isHDR,o=n.shadows,a=n.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=vi(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new _r(this._lightBuffer,0,md.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case ry.SPHERE:if(Ei.toArray(Rb,l.position),Rb[3]=0,this._lightBufferData.set(Rb,c+md.LIGHT_POS_OFFSET),Rb[0]=l.size,Rb[1]=l.range,Rb[2]=0,Rb[3]=o.enabled&&o.type===yg.ShadowMap?1:0,this._lightBufferData.set(Rb,c+md.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Ei.toArray(Rb,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;Rb[0]*=u.x,Rb[1]*=u.y,Rb[2]*=u.z}Rb[3]=r?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(Rb,c+md.LIGHT_COLOR_OFFSET);break;case ry.SPOT:if(Ei.toArray(Rb,l.position),Rb[3]=1,this._lightBufferData.set(Rb,c+md.LIGHT_POS_OFFSET),Rb[0]=l.size,Rb[1]=l.range,Rb[2]=l.spotAngle,Rb[3]=o.enabled&&o.type===yg.ShadowMap?1:0,this._lightBufferData.set(Rb,c+md.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Ei.toArray(Rb,l.direction),this._lightBufferData.set(Rb,c+md.LIGHT_DIR_OFFSET),Ei.toArray(Rb,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;Rb[0]*=h.x,Rb[1]*=h.y,Rb[2]*=h.z}Rb[3]=r?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(Rb,c+md.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),Zb=new Ws,$b=function(){function t(t){this._pendingModels=[],this._castModels=[],this._instancedQueue=new ZS,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var i=this._pipeline.pipelineSceneData,n=(this._pipeline.pipelineUBO,i.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,n.enabled&&n.type===yg.Planar&&!(n.normal.length()<1e-6)){var r=t.scene,o=t.frustum,a=0!=(t.visibility&Np.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=n.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Ws.transform(Zb,_.worldBounds,n.matLight),hs.aabbFrustum(Zb,o)))if(_.isInstancingEnabled)for(var f=_.subModels,p=0;p<f.length;p++){var d=f[p];u.merge(d,_.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,i){var n=this._pipeline.pipelineSceneData.shadows;if(n.enabled&&n.type===yg.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,i),this._pendingModels.length)){var r=n.material.passes[0],o=r.descriptorSet;i.bindDescriptorSet(Xp.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=kv.getOrCreatePipelineState(t,r,h,e,_);i.bindPipelineState(f),i.bindDescriptorSet(Xp.LOCAL,u.descriptorSet),i.bindInputAssembler(_),i.draw(_)}}},t}(),tC=function(){function t(){this._phaseID=Ov("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],o=t.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(t.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,p=kv.getOrCreatePipelineState(n,h,_,e,f);r.bindPipelineState(p),r.bindDescriptorSet(Xp.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(Xp.LOCAL,d),r.bindInputAssembler(f),r.draw(f)}}}},t}(),eC=[new sr(0,0,0,1)],iC=t("ForwardStage",(kb=pc("ForwardStage"),Ub=Kc([jS]),Gb=Uc(),kb((Xb=qb=function(t){function e(){var e;return ct(e=t.call(this)||this,"renderQueues",Wb,ot(e)),e._renderQueues=[],e._renderArea=new $n,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Ov("default"),e._clearFlag=4294967295,e._batchedQueue=new QS,e._instancedQueue=new ZS,e._uiPhase=new tC,e}$(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=YS(this.renderQueues[n]);this._additiveLightQueue=new Qb(this._pipeline),this._planarQueue=new $b(this._pipeline),this._uiPhase.activate(e)},i.destroy=function(){},i.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,i=e.device;this._renderQueues.forEach(KS);for(var n=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<n.length;++s){var c=n[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Pv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===Pv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(JS);var m=e.commandBuffers[0];e.pipelineUBO.updateShadowUBO(t),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(t,m),this._planarQueue.gatherShadowPasses(t,m),t.clearFlag&Xn.COLOR&&(eC[0].x=t.clearColor.x,eC[0].y=t.clearColor.y,eC[0].z=t.clearColor.z,eC[0].w=t.clearColor.w),e.generateRenderArea(t,this._renderArea);var v=t.window.framebuffer,g=e.getRenderPass(t.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,eC,t.clearDepth,t.clearStencil),m.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,g,m),this._instancedQueue.recordCommandBuffer(i,g,m),this._batchedQueue.recordCommandBuffer(i,g,m),this._additiveLightQueue.recordCommandBuffer(i,g,m),m.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet),this._planarQueue.recordCommandBuffer(i,g,m),this._renderQueues[1].recordCommandBuffer(i,g,m),this._uiPhase.render(t,g),eg(i,g,m,e.profiler,t),m.endRenderPass()},e}(ky),qb.initInfo={name:"ForwardStage",priority:$y.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:kS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:kS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},Wb=lt((jb=Xb).prototype,"renderQueues",[Ub,xc,Gb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hb=jb))||Hb)),nC=t("ForwardFlow",pc("ForwardFlow")((Jb=Kb=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var i=new iC;i.initialize(iC.initInfo),this._stages.push(i)}return!0},i.activate=function(e){t.prototype.activate.call(this,e)},i.render=function(e){t.prototype.render.call(this,e)},i.destroy=function(){t.prototype.destroy.call(this)},e}(Gy),Kb.initInfo={name:Vp,priority:tx.FORWARD,stages:[]},Yb=Jb))||Yb),rC=new Gi,oC=new Gi,aC=new Gi,sC=new Ws,cC=Ov("shadow-caster"),lC=[];function uC(t,e){e.length=0;for(var i=!1,n=0;n<t.length;n++){for(var r=t[n].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===cC){o=a,i=!0;break}e.push(o)}return i}var hC,_C,fC,pC,dC,mC,vC=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new ZS,this._batchedQueue=new QS}var e=t.prototype;return e.gatherLightPasses=function(t,e,i,n){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(i&&o.enabled&&o.type===yg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(i.type){case ry.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;uC(l.subModels,lC)&&this.add(l,lC)}break;case ry.SPOT:Gi.invert(rC,i.node.getWorldMatrix()),Gi.perspective(oC,i.angle,i.aspect,.001,i.range),Gi.multiply(aC,oC,rC);for(var u=0;u<s.length;u++){var h=s[u].model;uC(h.subModels,lC)&&(h.worldBounds&&(Ws.transform(sC,h.worldBounds,aC),!hs.aabbFrustum(sC,e.frustum))||this.add(h,lC))}}this._instancedQueue.uploadBuffers(n),this._batchedQueue.uploadBuffers(n)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t,e){for(var i=t.subModels,n=0;n<i.length;n++){var r=i[n],o=e[n],a=r.passes[o];if(a.batchingScheme===Pv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,t.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===Pv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,t),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},e.recordCommandBuffer=function(t,e,i){this._instancedQueue.recordCommandBuffer(t,e,i),this._batchedQueue.recordCommandBuffer(t,e,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],o=this._shaderArray[n],a=this._passArray[n],s=r.inputAssembler,c=kv.getOrCreatePipelineState(t,a,o,e,s),l=a.descriptorSet;i.bindPipelineState(c),i.bindDescriptorSet(Xp.MATERIAL,l),i.bindDescriptorSet(Xp.LOCAL,r.descriptorSet),i.bindInputAssembler(s),i.draw(s)}},t}(),gC=[new sr(1,1,1,1)],yC=t("ShadowStage",pc("ShadowStage")((fC=_C=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._shadowFrameBuffer=null,e._renderArea=new $n,e._light=null,e._globalDS=null,e}$(e,t);var i=e.prototype;return i.setUsage=function(t,e,i){this._globalDS=t,this._light=e,this._shadowFrameBuffer=i},i.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},i.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){gC[0].w=t.clearColor.w;var e=this._pipeline.commandBuffers[0],i=this._shadowFrameBuffer.renderPass;e.beginRenderPass(i,this._shadowFrameBuffer,this._renderArea,gC,t.clearDepth,t.clearStencil),e.endRenderPass()}},i.render=function(t){var e=this._pipeline,i=e.pipelineSceneData,n=i.shadows,r=i.shadingScale,o=this._globalDS,a=e.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,t,this._light,a);var s=t.viewport,c=n.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=e.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,gC,t.clearDepth,t.clearStencil),a.bindDescriptorSet(Xp.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._additiveShadowQueue=new vC(e)},e}(ky),_C.initInfo={name:"ShadowStage",priority:$y.FORWARD,tag:0},hC=fC))||hC),xC=[],SC=t("ShadowFlow",pc("ShadowFlow")((mC=dC=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._shadowRenderPass=null,e}$(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var i=new yC;i.initialize(yC.initInfo),this._stages.push(i)}return!0},i.render=function(t){var e=this._pipeline,i=e.pipelineSceneData.shadows,n=e.pipelineSceneData.shadowFrameBufferMap,r=e.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===yg.ShadowMap){for(var a=0,s=0;a<i.maxReceived&&s<o.length;){var c=o[s];c.type===ry.SPOT&&(xC.push(c),a++),s++}if(0!==r.length){i.shadowMapDirty&&this.resizeShadowMap();var l=t.scene.mainLight;if(l){var u=e.descriptorSet;n.has(l)||this._initShadowFrameBuffer(e,l,t.window.swapchain);for(var h=n.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(t)}}for(var p=0;p<xC.length;p++){var d=xC[p],m=e.globalDSManager.getOrCreateDescriptorSet(p);n.has(d)||this._initShadowFrameBuffer(e,d,t.window.swapchain);for(var v=n.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(t)}}xC.length=0}else this.clearShadowMap(xC,t)}},i.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(e.values()),n=0;n<i.length;n++){var r=i[n];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[n];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(t,e){var i=t.device,n=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,o=$d(i)?_n.R32F:_n.RGBA8;if(!this._shadowRenderPass){var a=new Dr;a.format=o,a.loadOp=Mn.CLEAR,a.storeOp=On.STORE,a.sampleCount=1;var s=new Mr;s.format=_n.DEPTH_STENCIL,s.depthLoadOp=Mn.CLEAR,s.depthStoreOp=On.DISCARD,s.stencilLoadOp=Mn.CLEAR,s.stencilStoreOp=On.DISCARD,s.sampleCount=1;var c=new Nr([a],s);this._shadowRenderPass=i.createRenderPass(c)}var l=[];l.push(i.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,o,n.x,n.y)));var u=i.createTexture(new mr(yn.TEX2D,xn.DEPTH_STENCIL_ATTACHMENT,_n.DEPTH_STENCIL,n.x,n.y)),h=i.createFramebuffer(new zr(this._shadowRenderPass,l,u));r.set(e,h)},i.clearShadowMap=function(t,e){var i=this._pipeline,n=i.pipelineSceneData,r=e.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;n.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=n.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(e)}}for(var l=0;l<t.length;l++){var u=t[l],h=n.shadowFrameBufferMap.get(u),_=i.globalDSManager.getOrCreateDescriptorSet(l);if(n.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(_,u,h),p.clearFramebuffer(e)}}},i.resizeShadowMap=function(){for(var t=this._pipeline.pipelineSceneData.shadows,e=t.size,i=this._pipeline,n=i.device,r=i.pipelineSceneData.shadowFrameBufferMap,o=$d(n)?_n.R32F:_n.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(i.device.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,o,e.x,e.y)));var u=c.depthStencilTexture;u&&u.resize(e.x,e.y);var h=c.renderPass;c.destroy(),c.initialize(new zr(h,l,u)),s=a.next()}else s=a.next()}t.shadowMapDirty=!1},e}(Gy),dC.initInfo={name:kp,priority:tx.SHADOW,tag:LS.SCENE,stages:[]},pC=mC))||pC),bC=new Ji,CC=oe({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),AC=CC.LAYERED+1,TC=function(){function t(){this._fogColor=new Ti("#C8C8C8"),this._colorArray=new Ji(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var e=t.prototype;return e._setType=function(t){this._type=this.enabled?t:AC},e._setEnable=function(t){this._enabled=t},e._setAccurate=function(t){this._accurate=t},e.initialize=function(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline()},e._updatePipeline=function(){var t=u.director.root,e=this.enabled?this.type:AC,i=this.accurate?1:0,n=t.pipeline;n.macros.CC_USE_FOG===e&&n.macros.CC_USE_ACCURATE_FOG===i||(n.macros.CC_USE_FOG=e,n.macros.CC_USE_ACCURATE_FOG=i,t.onGlobalPipelineStateChanged())},e._destroy=function(){},e.destroy=function(){this._destroy()},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),t?this.activate():(this._type=AC,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._setAccurate(t),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),bC.set(t.x,t.y,t.z,t.w),Hv(this._colorArray,bC)}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),t}();function wC(t,e){for(var i,n=st(e);!(i=n()).done;){var r=i.value;Array.isArray(r)?wC(t,r):t.push(r)}}function EC(t){var e=[];return wC(e,t),e.join("")}u.Fog=TC;var PC=pl.Flags.Destroyed,IC=pl.Flags.PersistentMask,RC=Ze.IDENTIFIER_RE,DC="var ",MC="o",OC={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},BC=Ze.escapeForJS,NC=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return DC+this.varName+"="+this.expression+";"},t}();function LC(t,e){return e instanceof NC?new NC(e.varName,t+e.expression):t+e}function FC(t,e,i){Array.isArray(i)?(i[0]=LC(e,i[0]),t.push(i)):t.push(LC(e,i)+";")}var zC=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];FC(t,e+VC(n[0])+"=",n[1])}},t}();function VC(t){return RC.test(t)?"."+t:"["+BC(t)+"]"}zC.pool=void 0,zC.pool=new ee((function(t){t._exps.length=0,t._targetExp=null}),1),zC.pool.get=function(t){var e=this._get()||new zC;return e._targetExp=t,e};var kC=function(){function t(t,e){var i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Pt(),Vt(this.funcModuleCache,OC),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i=DC+this.globalVariables.join(",")+";");var n=EC(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var i=It(t);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=t===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(t){}}}var o=this.funcs.indexOf(t);o<0&&(o=this.funcs.length,this.funcs.push(t));var a="F["+o+"]";return e&&(a="("+a+")"),this.funcModuleCache[i]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,i,n){var r=zC.pool.get(n),o=e.constructor.__props__;o||(o=Object.keys(e));for(var a=0;a<o.length;a++){var s=o[a],c=i[s];if(e[s]!==c){var l=this.enumerateField(i,s,c);r.append(s,l)}}r.writeCode(t),zC.pool.put(r)},e.enumerateCCClass=function(t,e,i){for(var n=i.__values__,r=Ie(i),o=0;o<n.length;o++){var a=n[o],s=e[a],c=r[a+"$_$default"];if(!UC(c,s))if("object"==typeof s&&s instanceof u.ValueType&&(c=Ze.getDefault(c))&&c.constructor===s.constructor){var l=MC+VC(a);this.setValueType(t,c,s,l)}else this.setObjProp(t,e,a,s)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,i=[new NC(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var n=0;n<t.length;++n)FC(i,e+"["+n+"]=",this.enumerateField(t,n,t[n]));return i},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var i="a"+ ++this.localVariableId,n=[new NC(i,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&FC(n,i+"["+r+"]=",t[r]);return n},e.enumerateField=function(t,e,i){if("object"==typeof i&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=n.source[0];n.source[0]=LC(r+"=",o)}return r}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?BC(i):("_objFlags"===e&&t instanceof pl&&(i&=IC),i)},e.setObjProp=function(t,e,i,n){FC(t,MC+VC(i)+"=",this.enumerateField(e,i,n))},e.enumerateObject=function(t,e){var i=e.constructor;if(u.Class._isCCClass(i))this.enumerateCCClass(t,e,i);else for(var n in e)if(e.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=e[n];"object"==typeof r&&r&&r===e._iN$t||this.setObjProp(t,e,n,r)}},e.instantiateObj=function(t){if(t instanceof u.ValueType)return Ze.getNewValueTypeCode(t);if(t instanceof u.Asset)return this.getObjRef(t);if(t._objFlags&PC)return null;var e,i=t.constructor;if(u.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof u.Component){if(t instanceof u._BaseNode||t instanceof u.Component)return this.getObjRef(t)}else if(this.parent instanceof u._BaseNode)if(t instanceof u._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof u.Component){var n;if(!(null===(n=t.node)||void 0===n?void 0:n.isChildOf(this.parent)))return this.getObjRef(t)}e=new NC(MC,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)e=new NC(MC,"{}");else{if(i)return this.getObjRef(t);e=new NC(MC,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function UC(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof u.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return bt(t)&&bt(e)}return!1}var GC,HC,jC,WC,qC,XC,YC,KC,JC,QC,ZC=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},Q(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?D(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();pl.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(GC||(GC={}));var $C=pl.Flags.Destroying,tA=pl.Flags.DontDestroy,eA=pl.Flags.Deactivating,iA=new mt("Node");function nA(t){return t?"string"==typeof t?$t(t):t:(O(3804),null)}var rA,oA,aA,sA,cA,lA,uA,hA,_A,fA,pA,dA=t("BaseNode",pc("cc.BaseNode")((QC=JC=function(t){$(i,t),i._setScene=function(t){t._updateScene()},i._findComponent=function(t,e){var i=e,n=t._components;if(i._sealed)for(var r=0;r<n.length;++r){var o=n[r];if(o.constructor===e)return o}else for(var a=0;a<n.length;++a){var s=n[a];if(s instanceof e)return s}return null},i._findComponents=function(t,e,i){var n=e,r=t._components;if(n._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===e&&i.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof e&&i.push(c)}},i._findChildComponent=function(t,e){for(var n=0;n<t.length;++n){var r=t[n],o=i._findComponent(r,e);if(o)return o;if(r._children.length>0&&(o=i._findChildComponent(r._children,e)))return o}return null},i._findChildComponents=function(t,e,n){for(var r=0;r<t.length;++r){var o=t[r];i._findComponents(o,e,n),o._children.length>0&&i._findChildComponents(o._children,e,n)}};var e=i.prototype;function i(e){var i;return ct(i=t.call(this,e)||this,"_parent",WC,ot(i)),ct(i,"_children",qC,ot(i)),ct(i,"_active",XC,ot(i)),ct(i,"_components",YC,ot(i)),ct(i,"_prefab",KC,ot(i)),i._scene=null,i._activeInHierarchy=!1,i._id=iA.getNewId(),i._name=void 0,i._eventProcessor=new u.NodeEventProcessor(ot(i)),i._eventMask=0,i._siblingIndex=0,i._originalSceneId="",i._registerIfAttached=void 0,i._name=void 0!==e?e:"New Node",i}return e._updateScene=function(){null==this._parent?b("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){Vt(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var i=this._parent,n=t;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit(GC.PARENT_CHANGED,i),i&&!(i._objFlags&$C)){var r=i._children.indexOf(this);i._children.splice(r,1),i._updateSiblingIndex(),i.emit&&i.emit(GC.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(GC.CHILD_ADDED,this)),this._onHierarchyChanged(i)}},e.getChildByUuid=function(t){if(!t)return x("Invalid uuid"),null;for(var e=this._children,i=0,n=e.length;i<n;i++)if(e[i]._id===t)return e[i];return null},e.getChildByName=function(t){if(!t)return x("Invalid name"),null;for(var e=this._children,i=0,n=e.length;i<n;i++)if(e[i]._name===t)return e[i];return null},e.getChildByPath=function(t){for(var e=t.split("/"),i=this,n=function(t){var n=e[t];if(0===n.length)return"continue";var r=i.children.find((function(t){return t.name===n}));if(!r)return{v:null};i=r},r=0;r<e.length;++r){var o=n(r);if("continue"!==o&&"object"==typeof o)return o.v}return i},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&eA)O(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var n=1,r=null,o=null,a=0,s=i._stacks[i._stackId];s||(s=[],i._stacks.push(s)),i._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;n;)if(o=s[--n])if(!l&&t?t(o):l&&e&&e(o),s[n]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[n]=r[a],n++;else if(c&&(s[n]=c,n++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[n]=r[a],n++):(s[n]=o,n++,l=!0);s.length=0,i._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var i=t[e];i&&(i.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=nA(t);return e?i._findComponent(this,e):null},e.getComponents=function(t){var e=nA(t),n=[];return e&&i._findComponents(this,e,n),n},e.getComponentInChildren=function(t){var e=nA(t);return e?i._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=nA(t),n=[];return e&&(i._findComponents(this,e,n),i._findChildComponents(this._children,e,n)),n},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=$t(t)))throw u._RF.peek()&&O(3808,t),TypeError(F(3807,t))}else{if(!t)throw TypeError(F(3804));e=t}if("function"!=typeof e)throw TypeError(F(3809));if(!Gt(e,u.Component))throw TypeError(F(3810));var i=e._requireComponent;if(i)if(Array.isArray(i))for(var n=0;n<i.length;n++){var r=i[n];this.getComponent(r)||this.addComponent(r)}else{var o=i;this.getComponent(o)||this.addComponent(o)}var a=new e;return a.node=this,this._components.push(a),this._activeInHierarchy&&u.director._nodeActivator.activateComp(a),a},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof $u?t:this.getComponent(t))&&e.destroy()}else O(3813)},e.on=function(t,e,i,n){switch(void 0===n&&(n=!1),t){case GC.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,i,n)},e.off=function(t,e,i,n){if(void 0===n&&(n=!1),this._eventProcessor.off(t,e,i,n),!this._eventProcessor.hasEventListener(t))switch(t){case GC.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,i,n){this._eventProcessor.once(t,e,i,n)},e.emit=function(t,e,i,n,r,o){this._eventProcessor.emit(t,e,i,n,r,o)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(GC.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&$C)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&O(3815)}}else O(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(GC.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(i._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=u.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof u.Scene||u.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&u.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=$C;var t=this._parent,e=!!t&&0!=(t._objFlags&$C);if(this._persistNode&&u.game.removePersistRootNode(this),!e&&t){this.emit(GC.PARENT_CHANGED,this);var i=t._children.indexOf(this);t._children.splice(i,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(GC.CHILD_REMOVED,this)}this.emit(GC.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return e},Q(i,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&tA)>0},set:function(t){t?this._objFlags|=tA:this._objFlags&=~tA}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&u.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),i}(pl),JC.idGenerator=iA,JC._stacks=[[]],JC._stackId=0,lt((jC=QC).prototype,"_persistNode",[gc],Object.getOwnPropertyDescriptor(jC.prototype,"_persistNode"),jC.prototype),lt(jC.prototype,"name",[Dc],Object.getOwnPropertyDescriptor(jC.prototype,"name"),jC.prototype),lt(jC.prototype,"children",[Dc],Object.getOwnPropertyDescriptor(jC.prototype,"children"),jC.prototype),lt(jC.prototype,"active",[Dc],Object.getOwnPropertyDescriptor(jC.prototype,"active"),jC.prototype),lt(jC.prototype,"activeInHierarchy",[Dc],Object.getOwnPropertyDescriptor(jC.prototype,"activeInHierarchy"),jC.prototype),lt(jC.prototype,"parent",[Dc],Object.getOwnPropertyDescriptor(jC.prototype,"parent"),jC.prototype),WC=lt(jC.prototype,"_parent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qC=lt(jC.prototype,"_children",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),XC=lt(jC.prototype,"_active",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),YC=lt(jC.prototype,"_components",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KC=lt(jC.prototype,"_prefab",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HC=jC))||HC);u._BaseNode=dA;var mA=new Ei,vA=new Bi,gA=new Bi,yA=new Bi,xA=new Di,SA=new Di,bA=new Gi,CA=[],AA=[],TA=[],wA=function(){function t(){this._chunks=[],this._freelists=[],this._createChunk()}var e=t.prototype;return e.alloc=function(){for(var t=this._freelists.length,e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)},e.free=function(t,e){for(var i=this._freelists.length,n=0;n<i;++n)if(this._chunks[n]===t)return void this._freelists[n].push(e)},e.clear=function(){for(var t=this._chunks.length,e=0;e<t;++e)this._chunks[e].fill(0)},e._createChunk=function(){this._chunks.push(new Uint32Array(t.CAPACITY_PER_CHUNK));for(var e=[],i=t.CAPACITY_PER_CHUNK-1;i>=0;i--)e.push(i);this._freelists.push(e)},e._createView=function(t){return TA[0]=this._chunks[t],TA[1]=this._freelists[t].pop(),TA},t}();wA.CAPACITY_PER_CHUNK=256;var EA,PA,IA,RA,DA,MA,OA,BA,NA,LA,FA,zA,VA,kA,UA,GA,HA,jA,WA,qA,XA,YA,KA,JA,QA,ZA,$A,tT,eT,iT,nT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,pT,dT,mT,vT,gT,yT,xT,ST,bT,CT,AT,TT,wT,ET,PT,IT,RT,DT,MT,OT,BT,NT,LT,FT,zT,VT,kT,UT,GT=new wA,HT=Symbol("ReserveContentsForAllSyncablePrefab"),jT=t("Node",(rA=pc("cc.Node"),oA=Kc(Ei),rA((pA=fA=function(t){$(i,t);var e=i.prototype;function i(e){var i;return(i=t.call(this,e)||this)._uiProps=new ZC(ot(i)),i._static=!1,ct(i,"_lpos",cA,ot(i)),ct(i,"_lrot",lA,ot(i)),ct(i,"_lscale",uA,ot(i)),ct(i,"_layer",hA,ot(i)),ct(i,"_euler",_A,ot(i)),i._dirtyFlagsPri=ny.NONE,i._eulerDirty=!1,i._nodeHandle=0,i._init(),i}return e._init=function(){var t=GT.alloc(),e=t[0],i=t[1];this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=i;var n=new Uint32Array(e.buffer,e.byteOffset+4*i,1);this._hasChangedFlags=n,this._pos=new Ei,this._rot=new Bi,this._scale=new Ei(1,1,1),this._mat=new Gi},i.isNode=function(t){return t instanceof i&&(t.constructor===i||!(t instanceof u.Scene))},e._onPreDestroy=function(){var t=this._onPreDestroyBase();return GT.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t},e[uh]=function(t){t.writeThis()},e.setParent=function(e,i){void 0===i&&(i=!1),i&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,i)},e._onSetParent=function(e,i){if(t.prototype._onSetParent.call(this,e,i),i){var n=this._parent;n?(n.updateWorldTransform(),Gi.multiply(bA,Gi.invert(bA,n._mat),this._mat),Gi.toRTS(bA,this._lrot,this._lpos,this._lscale)):(Ei.copy(this._lpos,this._pos),Bi.copy(this._lrot,this._rot),Ei.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(ny.TRS)},e._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},e._onBatchCreated=function(t){this.hasChangedFlags=ny.TRS,this._dirtyFlags|=ny.TRS;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},e._onBeforeSerialize=function(){this.eulerAngles},e._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(ny.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},e.translate=function(t,e){var i=e||iy.LOCAL;if(i===iy.LOCAL)Ei.transformQuat(mA,t,this._lrot),this._lpos.x+=mA.x,this._lpos.y+=mA.y,this._lpos.z+=mA.z;else if(i===iy.WORLD)if(this._parent){Bi.invert(vA,this._parent.worldRotation),Ei.transformQuat(mA,t,vA);var n=this.worldScale;this._lpos.x+=mA.x/n.x,this._lpos.y+=mA.y/n.y,this._lpos.z+=mA.z/n.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(ny.POSITION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.POSITION)},e.rotate=function(t,e){var i=e||iy.LOCAL;if(Bi.normalize(vA,t),i===iy.LOCAL)Bi.multiply(this._lrot,this._lrot,vA);else if(i===iy.WORLD){var n=this.worldRotation;Bi.multiply(gA,vA,n),Bi.invert(vA,n),Bi.multiply(gA,vA,gA),Bi.multiply(this._lrot,this._lrot,gA)}this._eulerDirty=!0,this.invalidateChildren(ny.ROTATION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.ROTATION)},e.lookAt=function(t,e){this.getWorldPosition(mA),Ei.subtract(mA,mA,t),Ei.normalize(mA,mA),Bi.fromViewUp(vA,mA,e),this.setWorldRotation(vA)},e._setDirtyNode=function(t,e){CA[t]=e},e.invalidateChildren=function(t){var e,i,n,r=0,o=0,a=0,s=0,c=0,l=t|ny.POSITION;for(CA[0]=this;r>=0;){if(c=(e=CA[r--])._hasChangedFlags[0],s=e._dirtyFlagsPri,e.isValid&&(s&c&t)!==t)for(s|=t,e._dirtyFlagsPri=s,e._hasChangedFlags[0]=c|t,a=(n=e._children).length,o=0;o<a;o++)i=n[o],CA[++r]=i;t=l}},e.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,i=0;e&&e._dirtyFlags;)this._setDirtyNode(i++,e),e=e._parent;for(var n=0;i;)n|=(t=CA[--i])._dirtyFlags,e?(n&ny.POSITION&&(Ei.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&ny.RS&&(Gi.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Gi.multiply(t._mat,e._mat,t._mat),n&ny.ROTATION&&Bi.multiply(t._rot,e._rot,t._lrot),Di.fromQuat(xA,Bi.conjugate(yA,t._rot)),Di.multiplyMat4(xA,xA,t._mat),t._scale.x=xA.m00,t._scale.y=xA.m04,t._scale.z=xA.m08)):(n&ny.POSITION&&(Ei.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&ny.RS&&(n&ny.ROTATION&&Bi.copy(t._rot,t._lrot),n&ny.SCALE&&(Ei.copy(t._scale,t._lscale),Gi.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=ny.NONE,e=t}},e.setPosition=function(t,e,i){void 0===e&&void 0===i?Ei.copy(this._lpos,t):void 0===i?Ei.set(this._lpos,t,e,this._lpos.z):Ei.set(this._lpos,t,e,i),this.invalidateChildren(ny.POSITION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.POSITION)},e.getPosition=function(t){return t?Ei.set(t,this._lpos.x,this._lpos.y,this._lpos.z):Ei.copy(new Ei,this._lpos)},e.setRotation=function(t,e,i,n){void 0===e||void 0===i||void 0===n?Bi.copy(this._lrot,t):Bi.set(this._lrot,t,e,i,n),this._eulerDirty=!0,this.invalidateChildren(ny.ROTATION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.ROTATION)},e.setRotationFromEuler=function(t,e,i){var n=void 0===i?this._euler.z:i;void 0===e?(Ei.copy(this._euler,t),Bi.fromEuler(this._lrot,t.x,t.y,t.z)):(Ei.set(this._euler,t,e,n),Bi.fromEuler(this._lrot,t,e,n)),this._eulerDirty=!1,this.invalidateChildren(ny.ROTATION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.ROTATION)},e.getRotation=function(t){return t?Bi.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Bi.copy(new Bi,this._lrot)},e.setScale=function(t,e,i){void 0===e&&void 0===i?Ei.copy(this._lscale,t):void 0===i?Ei.set(this._lscale,t,e,this._lscale.z):Ei.set(this._lscale,t,e,i),this.invalidateChildren(ny.SCALE),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.SCALE)},e.getScale=function(t){return t?Ei.set(t,this._lscale.x,this._lscale.y,this._lscale.z):Ei.copy(new Ei,this._lscale)},e.inverseTransformPoint=function(t,e){Ei.copy(t,e);for(var i=this,n=0;i._parent;)this._setDirtyNode(n++,i),i=i._parent;for(;n>=0;)Ei.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=CA[--n];return t},e.setWorldPosition=function(t,e,i){void 0===e||void 0===i?Ei.copy(this._pos,t):Ei.set(this._pos,t,e,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),Ei.transformMat4(r,this._pos,Gi.invert(bA,n._mat))):Ei.copy(r,this._pos),this.invalidateChildren(ny.POSITION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.POSITION)},e.getWorldPosition=function(t){return this.updateWorldTransform(),t?Ei.copy(t,this._pos):Ei.copy(new Ei,this._pos)},e.setWorldRotation=function(t,e,i,n){void 0===e||void 0===i||void 0===n?Bi.copy(this._rot,t):Bi.set(this._rot,t,e,i,n),this._parent?(this._parent.updateWorldTransform(),Bi.multiply(this._lrot,Bi.conjugate(this._lrot,this._parent._rot),this._rot)):Bi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ny.ROTATION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.ROTATION)},e.setWorldRotationFromEuler=function(t,e,i){Bi.fromEuler(this._rot,t,e,i),this._parent?(this._parent.updateWorldTransform(),Bi.multiply(this._lrot,Bi.conjugate(this._lrot,this._parent._rot),this._rot)):Bi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ny.ROTATION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.ROTATION)},e.getWorldRotation=function(t){return this.updateWorldTransform(),t?Bi.copy(t,this._rot):Bi.copy(new Bi,this._rot)},e.setWorldScale=function(t,e,i){void 0===e||void 0===i?Ei.copy(this._scale,t):Ei.set(this._scale,t,e,i);var n=this._parent;n?(n.updateWorldTransform(),Di.fromQuat(xA,Bi.conjugate(yA,n._rot)),Di.multiplyMat4(xA,xA,n._mat),SA.m00=this._scale.x,SA.m04=this._scale.y,SA.m08=this._scale.z,Di.multiply(xA,SA,Di.invert(xA,xA)),this._lscale.x=Ei.set(mA,xA.m00,xA.m01,xA.m02).length(),this._lscale.y=Ei.set(mA,xA.m03,xA.m04,xA.m05).length(),this._lscale.z=Ei.set(mA,xA.m06,xA.m07,xA.m08).length()):Ei.copy(this._lscale,this._scale),this.invalidateChildren(ny.SCALE),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.SCALE)},e.getWorldScale=function(t){return this.updateWorldTransform(),t?Ei.copy(t,this._scale):Ei.copy(new Ei,this._scale)},e.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new Gi;return Gi.copy(e,this._mat)},e.getWorldRS=function(t){this.updateWorldTransform();var e=t||new Gi;return Gi.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},e.getWorldRT=function(t){this.updateWorldTransform();var e=t||new Gi;return Gi.fromRT(e,this._rot,this._pos)},e.setRTS=function(t,e,i){var n=0;t&&(n|=ny.ROTATION,void 0!==t.w?(Bi.copy(this._lrot,t),this._eulerDirty=!0):(Ei.copy(this._euler,t),Bi.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(Ei.copy(this._lpos,e),n|=ny.POSITION),i&&(Ei.copy(this._lscale,i),n|=ny.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,n))},e.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},e.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},i.resetHasChangedFlags=function(){GT.clear()},i.clearNodeArray=function(){i.ClearFrame<i.ClearRound?i.ClearFrame++:(i.ClearFrame=0,CA.length=0,AA.length=0)},Q(i,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(t){this._dirtyFlagsPri=t}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Bi.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){Ei.set(this._euler,0,0,t),Bi.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(ny.ROTATION),1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){Gi.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(ny.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(GC.TRANSFORM_CHANGED,ny.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Ei.transformQuat(new Ei,Ei.FORWARD,this.worldRotation)},set:function(t){var e=t.length();Ei.multiplyScalar(mA,t,-1/e),Bi.fromViewUp(vA,mA),this.setWorldRotation(vA)}},{key:"up",get:function(){return Ei.transformQuat(new Ei,Ei.UP,this.worldRotation)}},{key:"right",get:function(){return Ei.transformQuat(new Ei,Ei.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(GC.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}}]),i}(dA),fA.EventType=GC,fA.NodeSpace=iy,fA.TransformDirtyBit=ny,fA.TransformBit=ny,fA.reserveContentsForAllSyncablePrefabTag=HT,fA.ClearFrame=0,fA.ClearRound=1e3,cA=lt((sA=pA).prototype,"_lpos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei}}),lA=lt(sA.prototype,"_lrot",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bi}}),uA=lt(sA.prototype,"_lscale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(1,1,1)}}),hA=lt(sA.prototype,"_layer",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Np.Enum.DEFAULT}}),_A=lt(sA.prototype,"_euler",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei}}),lt(sA.prototype,"eulerAngles",[oA],Object.getOwnPropertyDescriptor(sA.prototype,"eulerAngles"),sA.prototype),lt(sA.prototype,"angle",[Dc],Object.getOwnPropertyDescriptor(sA.prototype,"angle"),sA.prototype),lt(sA.prototype,"layer",[Dc],Object.getOwnPropertyDescriptor(sA.prototype,"layer"),sA.prototype),aA=sA))||aA));u.Node=jT;var WT=pc("cc.TargetInfo")((IA=lt((PA=function(){ct(this,"localID",IA,this)}).prototype,"localID",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EA=PA))||EA,qT=(RA=pc("cc.TargetOverrideInfo"),DA=Kc(pl),MA=Kc(WT),OA=Kc(jT),BA=Kc(WT),RA((FA=lt((LA=function(){ct(this,"source",FA,this),ct(this,"sourceInfo",zA,this),ct(this,"propertyPath",VA,this),ct(this,"target",kA,this),ct(this,"targetInfo",UA,this)}).prototype,"source",[xc,DA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zA=lt(LA.prototype,"sourceInfo",[xc,MA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VA=lt(LA.prototype,"propertyPath",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kA=lt(LA.prototype,"target",[xc,OA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UA=lt(LA.prototype,"targetInfo",[xc,BA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NA=LA))||NA),XT=pc("cc.CompPrefabInfo")((jA=lt((HA=function(){ct(this,"fileId",jA,this)}).prototype,"fileId",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),GA=HA))||GA,YT=(WA=pc("CCPropertyOverrideInfo"),qA=Kc(WT),WA((ZA=function(){function t(){ct(this,"targetInfo",KA,this),ct(this,"propertyPath",JA,this),ct(this,"value",QA,this)}return t.prototype.isTarget=function(){},t}(),KA=lt((YA=ZA).prototype,"targetInfo",[xc,qA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JA=lt(YA.prototype,"propertyPath",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QA=lt(YA.prototype,"value",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XA=YA))||XA),KT=($A=pc("cc.MountedChildrenInfo"),tT=Kc(WT),eT=Kc([jT]),$A((aT=function(){function t(){ct(this,"targetInfo",rT,this),ct(this,"nodes",oT,this)}return t.prototype.isTarget=function(){},t}(),rT=lt((nT=aT).prototype,"targetInfo",[xc,tT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oT=lt(nT.prototype,"nodes",[xc,eT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iT=nT))||iT),JT=(sT=pc("cc.MountedComponentsInfo"),cT=Kc(WT),lT=Kc([$u]),sT((pT=function(){function t(){ct(this,"targetInfo",_T,this),ct(this,"components",fT,this)}return t.prototype.isTarget=function(){},t}(),_T=lt((hT=pT).prototype,"targetInfo",[xc,cT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fT=lt(hT.prototype,"components",[xc,lT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uT=hT))||uT),QT=(dT=pc("cc.PrefabInstance"),mT=Kc(jT),vT=Kc([KT]),gT=Kc([JT]),yT=Kc([YT]),xT=Kc([WT]),dT((IT=function(){function t(){ct(this,"fileId",CT,this),ct(this,"prefabRootNode",AT,this),ct(this,"mountedChildren",TT,this),ct(this,"mountedComponents",wT,this),ct(this,"propertyOverrides",ET,this),ct(this,"removedComponents",PT,this),this.targetMap={}}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),CT=lt((bT=IT).prototype,"fileId",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AT=lt(bT.prototype,"prefabRootNode",[xc,mT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),TT=lt(bT.prototype,"mountedChildren",[xc,vT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wT=lt(bT.prototype,"mountedComponents",[xc,gT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ET=lt(bT.prototype,"propertyOverrides",[xc,yT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PT=lt(bT.prototype,"removedComponents",[xc,xT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ST=bT))||ST),ZT=(RT=pc("cc.PrefabInfo"),DT=Kc(jT),MT=Kc(QT),OT=Kc([qT]),RT((LT=lt((NT=function(){ct(this,"root",LT,this),ct(this,"asset",FT,this),ct(this,"fileId",zT,this),ct(this,"instance",VT,this),ct(this,"targetOverrides",kT,this),ct(this,"nestedPrefabInstanceRoots",UT,this)}).prototype,"root",[xc,DT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),FT=lt(NT.prototype,"asset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zT=lt(NT.prototype,"fileId",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VT=lt(NT.prototype,"instance",[xc,MT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kT=lt(NT.prototype,"targetOverrides",[xc,OT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UT=lt(NT.prototype,"nestedPrefabInstanceRoots",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BT=NT))||BT);function $T(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return O(3701,t.name),void(e.instance=void 0);var i=t._objFlags,n=t._parent,r=t._id,o=t._prefab;t[ll],u.game._isCloning=!0,e.asset._doInstantiate(t),u.game._isCloning=!1,t._objFlags=i,t._parent=n,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}}function tw(t,e,i){var n;if(e&&t){var r=e,o=null===(n=t._prefab)||void 0===n?void 0:n.instance;!i&&o&&(e[o.fileId]={},r=e[o.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var s=t.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<t.children.length;u++)tw(t.children[u],r,!1)}}function ew(t,e){if(!t)return null;for(var i=e,n=0;n<t.length;n++){if(!i)return null;i=i[t[n]]}return i}function iw(t,e,i){if(e)for(var n=0;n<e.length;n++){var r=e[n];if(r&&r.targetInfo){var o=ew(r.targetInfo.localID,i);if(!o)continue;var a=i,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,tw(u,a,!1),u._siblingIndex=o._children.length-1,sw(u,!0))}}}}function nw(t,e,i){if(e)for(var n=0;n<e.length;n++){var r=e[n];if(r&&r.targetInfo){var o=ew(r.targetInfo.localID,i);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function rw(t,e,i){if(e)for(var n=0;n<e.length;n++){var r=e[n];if(r){var o=ew(r.localID,i);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function ow(t,e,i){if(!(e.length<=0))for(var n=null,r=0;r<e.length;r++){var o=e[r];if(o&&o.targetInfo){if(!(n=ew(o.targetInfo.localID,i)))continue;var a=n,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof le?a[c].set(o.value):a[c]=o.value}}}}function aw(t){var e,i=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(i)for(var n=0;n<i.length;n++){var r,o,a=i[n],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=ew(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(_=ew(f.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=_}}}}}}function sw(t,e){void 0===e&&(e=!1);var i=t._prefab,n=null==i?void 0:i.instance;if(n){$T(t);var r={};n.targetMap=r,tw(t,r,!0),iw(0,n.mountedChildren,r),rw(0,n.removedComponents,r),nw(0,n.mountedComponents,r),ow(0,n.propertyOverrides,r)}e&&t&&t.children&&t.children.forEach((function(t){sw(t,!0)}))}function cw(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){sw(t)}))}u._PrefabInfo=ZT;var lw,uw,hw,_w,fw,pw,dw,mw,vw,gw,yw,xw,Sw,bw,Cw=Object.freeze({__proto__:null,TargetInfo:WT,TargetOverrideInfo:qT,CompPrefabInfo:XT,PropertyOverrideInfo:YT,MountedChildrenInfo:KT,MountedComponentsInfo:JT,PrefabInstance:QT,PrefabInfo:ZT,createNodeWithPrefab:$T,generateTargetMap:tw,getTarget:ew,applyMountedChildren:iw,applyMountedComponents:nw,applyRemovedComponents:rw,applyPropertyOverrides:ow,applyTargetOverrides:aw,expandPrefabInstanceNode:sw,expandNestedPrefabInstanceNode:cw}),Aw=oe({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Tw=t("Prefab",pc("cc.Prefab")((dw=pw=function(t){function e(){var e;return ct(e=t.call(this)||this,"data",hw,ot(e)),ct(e,"optimizationPolicy",_w,ot(e)),ct(e,"persistent",fw,ot(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}$(e,t);var i=e.prototype;return i.createNode=function(t){var e=u.instantiate(this);e.name=this.name,t(null,e)},i.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof u._BaseNode&&t,new kC(t,e).result)},i._doInstantiate=function(t){return this.data._prefab||D(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},i._instantiate=function(){var t;return this.optimizationPolicy!==Aw.SINGLE_INSTANCE&&(this.optimizationPolicy===Aw.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new jT,this.data.name="(Missing Node)";var i=new u._PrefabInfo;i.asset=this,i.root=this.data,this.data._prefab=i},i.validate=function(){return!!this.data},i.onLoaded=function(){var t=this.data;cw(t),aw(t)},e}(Mu),pw.OptimizationPolicy=Aw,pw.OptimizationPolicyThreshold=3,hw=lt((uw=dw).prototype,"data",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_w=lt(uw.prototype,"optimizationPolicy",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aw.AUTO}}),fw=lt(uw.prototype,"persistent",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lw=uw))||lw);ne.value(Tw,"_utils",Cw),u.Prefab=Tw,Rt(u,"cc._Prefab","Prefab"),t("PrefabLink",(mw=pc("cc.PrefabLink"),vw=Kc(Tw),gw=Mc(),mw((bw=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"prefab",Sw,ot(e)),e}return $(e,t),e}($u),Sw=lt((xw=bw).prototype,"prefab",[vw,xc,gw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yw=xw))||yw));var ww=new Ei;function Ew(t,e,i,n){n||(n=new Ei),t.convertToUINode(e,i,n);var r=i.position;return n.add(r),n}function Pw(t,e,i){return i||(i=new Ei),t.worldToScreen(e,i),i.x/=u.view.getScaleX(),i.y/=u.view.getScaleY(),i}var Iw,Rw,Dw=t("convertUtils",{WorldNode3DToLocalNodeUI:Ew,WorldNode3DToWorldNodeUI:Pw});u.pipelineUtils=Dw,k(u.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=e[0],r=e[3]||ww;return n.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]),U(Zm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),k(VS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Mw,Ow=t("BufferAsset",pc("cc.BufferAsset")((lt((Rw=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._buffer=null,e}$(e,t);var i=e.prototype;return i.buffer=function(){return this._buffer},i.validate=function(){return!!this.buffer},Q(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Mu)).prototype,"_nativeAsset",[ol],Object.getOwnPropertyDescriptor(Rw.prototype,"_nativeAsset"),Rw.prototype),Iw=Rw))||Iw);u.BufferAsset=Ow;var Bw=((Mw={})[fn.UNORM]="Uint",Mw[fn.SNORM]="Int",Mw[fn.UINT]="Uint",Mw[fn.INT]="Int",Mw[fn.UFLOAT]="Float",Mw[fn.FLOAT]="Float",Mw.default="Uint",Mw);function Nw(t){return""+(Bw[t.type]||Bw.default)+t.size/t.count*8}function Lw(t,e,i,n,r){void 0===i&&(i=_n.R32F),void 0===n&&(n=0),void 0===r&&(r=0);var o=Zr[i];r||(r=o.size);for(var a="set"+Nw(o),s=o.size/o.count,c=Math.floor(e.length/o.count),l=lh.isLittleEndian,u=0;u<c;++u)for(var h=n+r*u,_=0;_<o.count;++_){var f=h+s*_;t[a](f,e[o.count*u+_],l)}}function Fw(t,e,i,n,r,o){void 0===e&&(e=_n.R32F),void 0===i&&(i=0),void 0===n&&(n=t.byteLength-i),void 0===r&&(r=0),void 0===o&&(o=[]);var a=Zr[e];r||(r=a.size);for(var s="get"+Nw(a),c=a.size/a.count,l=Math.floor(n/r),u=lh.isLittleEndian,h=0;h<l;++h)for(var _=i+r*h,f=0;f<a.count;++f){var p=_+c*f;o[a.count*h+f]=t[s](p,u)}return o}function zw(t,e,i,n,r,o,a){void 0===i&&(i=_n.R32F),void 0===n&&(n=0),void 0===r&&(r=t.byteLength-n),void 0===o&&(o=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var s=Zr[i];o||(o=s.size);for(var c="set"+Nw(s),l="get"+Nw(s),u=s.size/s.count,h=Math.floor(r/o),_=lh.isLittleEndian,f=0;f<h;++f)for(var p=n+o*f,d=0;d<s.count;++d){var m=p+u*d,v=t[l](m,_);a[c](m,e(v,d,t),_)}return a}var Vw,kw,Uw=t("RenderingSubMesh",function(){var t=e.prototype;function e(t,e,i,n,r){void 0===n&&(n=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=n,this._indirectBuffer=r,this._primitiveMode=i,this._iaInfo=new Rr(e,t,n,r),this._init()}return t._init=function(){},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,i=t.struct.primitives[this.subMeshIdx];i.indexView&&(e=i.indexView.count);for(var n=0;n<i.vertexBundelIndices.length;n++){var r=i.vertexBundelIndices[n],o=t.struct.vertexBundles[r],a=i.indexView?i.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(i.indexView?c:o.view.length);if(i.indexView){for(var h=t.readIndices(this.subMeshIdx),_=0;_<e;++_)for(var f=_*s,p=h[_]*s,d=0;d<s;++d)u[f+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},t.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(t);this._vertexBuffers.push(n),this._attributes.push(new Pr("a_vertexId",_n.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:i}}},t._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(e),n=0;n<e;++n)i[n]=n+.5;var r=t.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return r.update(i),r},Q(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ei.ZERO,max:Ei.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ei.ZERO,max:Ei.ZERO}};var t=this.mesh,e=this.subMeshIdx,i=t.readAttribute(e,Kn.ATTR_POSITION),n=t.readIndices(e),r=new Ei,o=new Ei,a=this.attributes.find((function(t){return t.name===Kn.ATTR_POSITION}));if(a){var s=Zr[a.format].count;2===s?(r.set(i[0],i[1],0),o.set(i[0],i[1],0)):(r.set(i[0],i[1],i[2]),o.set(i[0],i[1],i[2]));for(var c=0;c<i.length;c+=s)2===s?(r.x=i[c]>r.x?i[c]:r.x,r.y=i[c+1]>r.y?i[c+1]:r.y,o.x=i[c]<o.x?i[c]:o.x,o.y=i[c+1]<o.y?i[c+1]:o.y):(r.x=i[c]>r.x?i[c]:r.x,r.y=i[c+1]>r.y?i[c+1]:r.y,r.z=i[c+2]>r.z?i[c+2]:r.z,o.x=i[c]<o.x?i[c]:o.x,o.y=i[c+1]<o.y?i[c+1]:o.y,o.z=i[c+2]<o.z?i[c+2]:o.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var n,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=u.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var l=o.vertexBundles[a.vertexBundelIndices[c]];r=0,n=_n.UNKNOWN;for(var h=0;h<l.attributes.length;h++){var _=l.attributes[h];if(_.name===Kn.ATTR_JOINTS){n=_.format;break}r+=Zr[_.format].size}n?function(){var u=new Uint8Array(t.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(u.slice().buffer),_=o.jointMaps[a.jointMapIndex];zw(h,(function(t){return _.indexOf(t)}),n,r,l.view.length,l.view.stride,h);var f=s.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,l.view.length,l.view.stride));f.update(h.buffer),e.push(f),i.push(c)}():e.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(s)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}());!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Vw||(Vw=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(kw||(kw={})),u.SystemEventType=Vw;var Gw,Hw=new Array(16),jw=null,Ww=new qi,qw=[GC.TOUCH_START,GC.TOUCH_MOVE,GC.TOUCH_END,GC.TOUCH_CANCEL],Xw=[GC.MOUSE_DOWN,GC.MOUSE_ENTER,GC.MOUSE_MOVE,GC.MOUSE_LEAVE,GC.MOUSE_UP,GC.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(Gw||(Gw={}));var Yw,Kw,Jw,Qw,Zw,$w,tE,eE,iE,nE,rE,oE,aE,sE,cE,lE,uE,hE,_E,fE,pE,dE,mE,vE,gE,yE,xE,SE,bE,CE,AE,TE,wE,EE,PE,IE,RE,DE,ME,OE,BE,NE,LE,FE,zE,VE,kE,UE,GE,HE,jE,WE,qE,XE,YE,KE,JE,QE,ZE,$E,tP,eP,iP,nP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,pP,dP,mP,vP,gP,yP,xP,SP,bP,CP,AP,TP,wP,EP,PP,IP,RP,DP,MP,OP,BP,NP,LP,FP,zP,VP,kP,UP,GP,HP,jP,WP,qP,XP,YP,KP,JP,QP,ZP,$P,tI,eI,iI,nI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,pI,dI,mI,vI,gI,yI,xI,SI,bI,CI,AI,TI,wI,EI,PI,II,RI,DI,MI,OI,BI,NI,LI,FI,zI,VI,kI,UI,GI,HI,jI,WI,qI,XI,YI,KI,JI,QI,ZI,$I,tR,eR,iR,nR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,pR,dR,mR,vR,gR,yR,xR,SR,bR,CR,AR,TR,wR,ER=function(){var t=e.prototype;function e(t){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return t.setEnabled=function(t,i){if(void 0===i&&(i=!1),this._isEnabled!==t){this._isEnabled=t;var n=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(Gw.MARK_LIST_DIRTY),i&&n.length>0)for(var r=0;r<n.length;++r)n[r]._eventProcessor.setEnabled(t,!0)}},t._searchComponentsInParent=function(t){var e=this.node;if(t){for(var i=0,n=[],r=e;r&&jT.isNode(r);r=r.parent,++i){var o=r.getComponent(t);if(o){var a={index:i,comp:o};n?n.push(a):n=[a]}}return n.length>0?n:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t.reattach=function(){var t,i=this;this.node.walk((function(n){t||(t=i._searchComponentsInParent(e._maskComp)),n.eventProcessor.maskList=t}))},t.destroy=function(){jw===this._node&&(jw=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(Gw.REMOVE_POINTER_EVENT_PROCESSOR,this)},t._isTouchEvent=function(t){return-1!==qw.indexOf(t)},t._isMouseEvent=function(t){return-1!==Xw.indexOf(t)},t._hasTouchListeners=function(){for(var t=0;t<qw.length;++t){var e=qw[t];if(this.hasEventListener(e))return!0}return!1},t._hasMouseListeners=function(){for(var t=0;t<Xw.length;++t){var e=Xw[t];if(this.hasEventListener(e))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var i=this._isTouchEvent(t),n=this._isMouseEvent(t);i?this.shouldHandleEventTouch=!0:n&&(this.shouldHandleEventMouse=!0),!i&&!n||this._hasPointerListeners()||e.callbacksInvoker.emit(Gw.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,i=new $l;return i._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(Gw.REMOVE_POINTER_EVENT_PROCESSOR,t)})),i},t.on=function(t,e,i,n){var r,o;return this._tryEmittingAddEvent(t),((n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,i),e},t.once=function(t,e,i,n){var r,o;return this._tryEmittingAddEvent(t),((n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,i,!0),e},t.off=function(t,e,i,n){var r;null===(r=(n=!!n)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,i)},t.targetOff=function(t){var i,n;null===(i=this.capturingTarget)||void 0===i||i.removeAll(t),null===(n=this.bubblingTarget)||void 0===n||n.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(Gw.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(t,e,i,n,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,i,n,r,o)},t.dispatchEvent=function(t){var e,i=this.node,n=0;for(t.target=i,Hw.length=0,this.getCapturingTargets(t.type,Hw),t.eventPhase=1,n=Hw.length-1;n>=0;--n)if((e=Hw[n]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,Hw),t.propagationStopped))return void(Hw.length=0);if(Hw.length=0,t.eventPhase=2,t.currentTarget=i,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,Hw),t.eventPhase=3,n=0;n<Hw.length;++n)if((e=Hw[n]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(Hw.length=0);Hw.length=0},t.hasEventListener=function(t,e,i){var n=!1;return this.bubblingTarget&&(n=this.bubblingTarget.hasEventListener(t,e,i)),!n&&this.capturingTarget&&(n=this.capturingTarget.hasEventListener(t,e,i)),n},t.getCapturingTargets=function(t,e){for(var i=this._node.parent;i;){var n;(null===(n=i.eventProcessor.capturingTarget)||void 0===n?void 0:n.hasEventListener(t))&&e.push(i),i=i.parent}},t.getBubblingTargets=function(t,e){for(var i=this._node.parent;i;){var n;(null===(n=i.eventProcessor.bubblingTarget)||void 0===n?void 0:n.hasEventListener(t))&&e.push(i),i=i.parent}},t._handleEventMouse=function(t){switch(t.type){case kw.MOUSE_DOWN:return this._handleMouseDown(t);case kw.MOUSE_MOVE:return this._handleMouseMove(t);case kw.MOUSE_UP:return this._handleMouseUp(t);case kw.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},t._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(Ww=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(Ww)||(t.type=GC.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(Ww=t.getUILocation(),e._uiProps.uiTransformComp.isHit(Ww)?(this.previousMouseIn||(jw&&jw!==e&&(t.type=GC.MOUSE_LEAVE,jw.dispatchEvent(t),jw.eventProcessor.previousMouseIn=!1),jw=e,t.type=GC.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=GC.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=GC.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,jw=null),1)))},t._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(Ww=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(Ww)||(t.type=GC.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(Ww=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(Ww)||(t.type=GC.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleEventTouch=function(t){switch(t.type){case kw.TOUCH_START:return this._handleTouchStart(t);case kw.TOUCH_MOVE:return this._handleTouchMove(t);case kw.TOUCH_END:return this._handleTouchEnd(t);case kw.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},t._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getUILocation(Ww),!e._uiProps.uiTransformComp.isHit(Ww)||(t.type=GC.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))},t._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=GC.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))},t._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getUILocation(Ww),e._uiProps.uiTransformComp.isHit(Ww)?t.type=GC.TOUCH_END:t.type=GC.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},t._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=GC.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},Q(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();ER._maskComp=null,ER.callbacksInvoker=new $l,u.NodeEventProcessor=ER;var PR=new Ei(0,1,0),IR=new Ei,RR=new Ji,DR=new Ti,MR=new Bi,OR=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},BR=(Yw=pc("cc.AmbientInfo"),Kw=Rc(),Jw=Sc("_skyColor"),Qw=Sc("_skyIllum"),Zw=Sc("_groundAlbedo"),$w=Mc(),tE=Nc(),eE=Kc(Oe),iE=Nc(),nE=Mc(),rE=Nc(),Yw(oE=Kw((fE=function(){function t(){ct(this,"_skyColorHDR",sE,this),ct(this,"_skyIllumHDR",cE,this),ct(this,"_groundAlbedoHDR",lE,this),ct(this,"_skyColorLDR",uE,this),ct(this,"_skyIllumLDR",hE,this),ct(this,"_groundAlbedoLDR",_E,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},Q(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=u.director.root.pipeline.pipelineSceneData.isHDR;return RR.set(t?this._skyColorHDR:this._skyColorLDR),OR(RR),DR.set(255*RR.x,255*RR.y,255*RR.z,255)},set:function(t){RR.set(t.x,t.y,t.z,t.w),u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(RR):this._skyColorLDR.set(RR),this._resource&&this._resource.skyColor.set(RR)}},{key:"skyColor",set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=u.director.root.pipeline.pipelineSceneData.isHDR;return RR.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),OR(RR),DR.set(255*RR.x,255*RR.y,255*RR.z,255)},set:function(t){RR.set(t.x,t.y,t.z,t.w),u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(RR):this._groundAlbedoLDR.set(RR),this._resource&&this._resource.groundAlbedo.set(RR)}},{key:"groundAlbedo",set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}(),sE=lt((aE=fE).prototype,"_skyColorHDR",[xc,Jw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ji(.2,.5,.8,1)}}),cE=lt(aE.prototype,"_skyIllumHDR",[xc,Qw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $S.SKY_ILLUM}}),lE=lt(aE.prototype,"_groundAlbedoHDR",[xc,Zw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ji(.2,.2,.2,1)}}),uE=lt(aE.prototype,"_skyColorLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ji(.2,.5,.8,1)}}),hE=lt(aE.prototype,"_skyIllumLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $S.SKY_ILLUM}}),_E=lt(aE.prototype,"_groundAlbedoLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ji(.2,.2,.2,1)}}),lt(aE.prototype,"skyLightingColor",[$w,Dc,tE],Object.getOwnPropertyDescriptor(aE.prototype,"skyLightingColor"),aE.prototype),lt(aE.prototype,"skyIllum",[Dc,eE,iE],Object.getOwnPropertyDescriptor(aE.prototype,"skyIllum"),aE.prototype),lt(aE.prototype,"groundLightingColor",[nE,Dc,rE],Object.getOwnPropertyDescriptor(aE.prototype,"groundLightingColor"),aE.prototype),oE=aE))||oE)||oE);u.AmbientInfo=BR;var NR=(pE=pc("cc.SkyboxInfo"),dE=Rc(),mE=Kc(Av),vE=Sc("_envmap"),gE=Kc(Av),yE=Kc(Av),xE=Kc(Av),SE=Mc(),bE=Nc(),CE=Uc(),AE=Nc(),TE=Nc(),wE=Nc(),EE=Kc(Av),PE=Nc(),IE=Mc(),RE=Kc(Av),DE=Uc(),pE(ME=dE((GE=function(){function t(){ct(this,"_applyDiffuseMap",BE,this),ct(this,"_envmapHDR",NE,this),ct(this,"_envmapLDR",LE,this),ct(this,"_diffuseMapHDR",FE,this),ct(this,"_diffuseMapLDR",zE,this),ct(this,"_enabled",VE,this),ct(this,"_useIBL",kE,this),ct(this,"_useHDR",UE,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},Q(t,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(t){this._applyDiffuseMap=t,this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=t:this._envmapLDR=t,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=t)}},{key:"diffuseMap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),t}(),BE=lt((OE=GE).prototype,"_applyDiffuseMap",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NE=lt(OE.prototype,"_envmapHDR",[xc,mE,vE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LE=lt(OE.prototype,"_envmapLDR",[xc,gE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FE=lt(OE.prototype,"_diffuseMapHDR",[xc,yE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zE=lt(OE.prototype,"_diffuseMapLDR",[xc,xE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VE=lt(OE.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kE=lt(OE.prototype,"_useIBL",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UE=lt(OE.prototype,"_useHDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(OE.prototype,"applyDiffuseMap",[SE,Dc,bE,CE],Object.getOwnPropertyDescriptor(OE.prototype,"applyDiffuseMap"),OE.prototype),lt(OE.prototype,"enabled",[Dc,AE],Object.getOwnPropertyDescriptor(OE.prototype,"enabled"),OE.prototype),lt(OE.prototype,"useIBL",[Dc,TE],Object.getOwnPropertyDescriptor(OE.prototype,"useIBL"),OE.prototype),lt(OE.prototype,"useHDR",[Dc,wE],Object.getOwnPropertyDescriptor(OE.prototype,"useHDR"),OE.prototype),lt(OE.prototype,"envmap",[Dc,EE,PE],Object.getOwnPropertyDescriptor(OE.prototype,"envmap"),OE.prototype),lt(OE.prototype,"diffuseMap",[IE,Dc,Oc,RE,DE],Object.getOwnPropertyDescriptor(OE.prototype,"diffuseMap"),OE.prototype),ME=OE))||ME)||ME);u.SkyboxInfo=NR;var LR=(HE=pc("cc.FogInfo"),jE=Rc(),WE=Nc(),qE=Uc(),XE=Nc(),YE=Uc(),KE=Nc(),JE=Kc(CC),QE=Uc(),ZE=Nc(),$E=Mc(),tP=Kc(Oe),eP=Lc(),iP=Vc(),nP=Nc(),rP=Mc(),oP=Kc(Oe),aP=Vc(),sP=Nc(),cP=Mc(),lP=Kc(Oe),uP=Vc(),hP=Nc(),_P=Mc(),fP=Kc(Oe),pP=Fc(),dP=Vc(),mP=Nc(),vP=Mc(),gP=Kc(Oe),yP=Vc(),xP=Nc(),SP=Mc(),bP=Kc(Oe),CP=Vc(),AP=Nc(),HE(TP=jE((zP=FP=function(){function t(){ct(this,"_type",EP,this),ct(this,"_fogColor",PP,this),ct(this,"_enabled",IP,this),ct(this,"_fogDensity",RP,this),ct(this,"_fogStart",DP,this),ct(this,"_fogEnd",MP,this),ct(this,"_fogAtten",OP,this),ct(this,"_fogTop",BP,this),ct(this,"_fogRange",NP,this),ct(this,"_accurate",LP,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),FP.FogType=CC,EP=lt((wP=zP).prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CC.LINEAR}}),PP=lt(wP.prototype,"_fogColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti("#C8C8C8")}}),IP=lt(wP.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RP=lt(wP.prototype,"_fogDensity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),DP=lt(wP.prototype,"_fogStart",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),MP=lt(wP.prototype,"_fogEnd",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),OP=lt(wP.prototype,"_fogAtten",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),BP=lt(wP.prototype,"_fogTop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),NP=lt(wP.prototype,"_fogRange",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),LP=lt(wP.prototype,"_accurate",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(wP.prototype,"enabled",[Dc,WE,qE],Object.getOwnPropertyDescriptor(wP.prototype,"enabled"),wP.prototype),lt(wP.prototype,"accurate",[Dc,XE,YE],Object.getOwnPropertyDescriptor(wP.prototype,"accurate"),wP.prototype),lt(wP.prototype,"fogColor",[Dc,KE],Object.getOwnPropertyDescriptor(wP.prototype,"fogColor"),wP.prototype),lt(wP.prototype,"type",[Dc,JE,QE,ZE],Object.getOwnPropertyDescriptor(wP.prototype,"type"),wP.prototype),lt(wP.prototype,"fogDensity",[$E,tP,eP,iP,kc,nP],Object.getOwnPropertyDescriptor(wP.prototype,"fogDensity"),wP.prototype),lt(wP.prototype,"fogStart",[rP,oP,aP,sP],Object.getOwnPropertyDescriptor(wP.prototype,"fogStart"),wP.prototype),lt(wP.prototype,"fogEnd",[cP,lP,uP,hP],Object.getOwnPropertyDescriptor(wP.prototype,"fogEnd"),wP.prototype),lt(wP.prototype,"fogAtten",[_P,fP,pP,dP,mP],Object.getOwnPropertyDescriptor(wP.prototype,"fogAtten"),wP.prototype),lt(wP.prototype,"fogTop",[vP,gP,yP,xP],Object.getOwnPropertyDescriptor(wP.prototype,"fogTop"),wP.prototype),lt(wP.prototype,"fogRange",[SP,bP,CP,AP],Object.getOwnPropertyDescriptor(wP.prototype,"fogRange"),wP.prototype),TP=wP))||TP)||TP),FR=(VP=pc("cc.ShadowsInfo"),kP=Rc(),UP=Nc(),GP=Kc(yg),HP=Mc(),jP=Mc(),WP=Nc(),qP=Kc(Oe),XP=Nc(),YP=Mc(),KP=Lc(),JP=Kc(Oe),QP=Nc(),ZP=Mc(),$P=Kc(xg),tI=Nc(),eI=Mc(),iI=Kc(Me),nI=Mc(),rI=Kc(Oe),oI=Nc(),aI=Mc(),sI=Kc(Oe),cI=Nc(),lI=Mc(),uI=Kc(gg),hI=Nc(),_I=Mc(),fI=Kc(Be),pI=Nc(),dI=Mc(),mI=Kc(Oe),vI=Nc(),gI=Mc(),yI=Kc(Oe),xI=Nc(),SI=Mc(),bI=Lc(),CI=Kc(Oe),AI=Nc(),TI=Mc(),wI=Lc(),EI=Kc(Oe),PI=Nc(),II=Mc(),RI=Kc(Oe),DI=Nc(),MI=Mc(),VP(OI=kP(($I=function(){function t(){ct(this,"_type",NI,this),ct(this,"_enabled",LI,this),ct(this,"_normal",FI,this),ct(this,"_distance",zI,this),ct(this,"_shadowColor",VI,this),ct(this,"_firstSetCSM",kI,this),ct(this,"_fixedArea",UI,this),ct(this,"_pcf",GI,this),ct(this,"_bias",HI,this),ct(this,"_normalBias",jI,this),ct(this,"_near",WI,this),ct(this,"_far",qI,this),ct(this,"_shadowDistance",XI,this),ct(this,"_invisibleOcclusionRange",YI,this),ct(this,"_orthoSize",KI,this),ct(this,"_maxReceived",JI,this),ct(this,"_size",QI,this),ct(this,"_saturation",ZI,this),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(MR),this.normal=Ei.transformQuat(IR,PR,MR),t.getWorldPosition(IR),this.distance=Ei.dot(this._normal,IR)},e.activate=function(t){this.pcf=Math.min(this._pcf,xg.SOFT_2X),this._resource=t,this._resource.initialize(this),this._resource.activate()},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"normal",get:function(){return this._normal},set:function(t){Ei.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"saturation",get:function(){return this._saturation},set:function(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t,this._resource&&(this._resource.bias=t)}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t,this._resource&&(this._resource.fixedArea=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._resource&&(this._resource.near=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=Math.min(t,bg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=Math.min(t,bg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,bg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}}]),t}(),NI=lt((BI=$I).prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yg.Planar}}),LI=lt(BI.prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FI=lt(BI.prototype,"_normal",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(0,1,0)}}),zI=lt(BI.prototype,"_distance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VI=lt(BI.prototype,"_shadowColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(0,0,0,76)}}),kI=lt(BI.prototype,"_firstSetCSM",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UI=lt(BI.prototype,"_fixedArea",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GI=lt(BI.prototype,"_pcf",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xg.HARD}}),HI=lt(BI.prototype,"_bias",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),jI=lt(BI.prototype,"_normalBias",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WI=lt(BI.prototype,"_near",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),qI=lt(BI.prototype,"_far",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),XI=lt(BI.prototype,"_shadowDistance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),YI=lt(BI.prototype,"_invisibleOcclusionRange",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),KI=lt(BI.prototype,"_orthoSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),JI=lt(BI.prototype,"_maxReceived",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),QI=lt(BI.prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(512,512)}}),ZI=lt(BI.prototype,"_saturation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),lt(BI.prototype,"enabled",[Dc,UP],Object.getOwnPropertyDescriptor(BI.prototype,"enabled"),BI.prototype),lt(BI.prototype,"type",[Dc,GP],Object.getOwnPropertyDescriptor(BI.prototype,"type"),BI.prototype),lt(BI.prototype,"shadowColor",[HP],Object.getOwnPropertyDescriptor(BI.prototype,"shadowColor"),BI.prototype),lt(BI.prototype,"normal",[jP,WP],Object.getOwnPropertyDescriptor(BI.prototype,"normal"),BI.prototype),lt(BI.prototype,"distance",[qP,XP,YP],Object.getOwnPropertyDescriptor(BI.prototype,"distance"),BI.prototype),lt(BI.prototype,"saturation",[Dc,KP,kc,JP,QP,ZP],Object.getOwnPropertyDescriptor(BI.prototype,"saturation"),BI.prototype),lt(BI.prototype,"pcf",[$P,tI,eI],Object.getOwnPropertyDescriptor(BI.prototype,"pcf"),BI.prototype),lt(BI.prototype,"maxReceived",[iI,nI],Object.getOwnPropertyDescriptor(BI.prototype,"maxReceived"),BI.prototype),lt(BI.prototype,"bias",[rI,oI,aI],Object.getOwnPropertyDescriptor(BI.prototype,"bias"),BI.prototype),lt(BI.prototype,"normalBias",[sI,cI,lI],Object.getOwnPropertyDescriptor(BI.prototype,"normalBias"),BI.prototype),lt(BI.prototype,"shadowMapSize",[uI,hI,_I],Object.getOwnPropertyDescriptor(BI.prototype,"shadowMapSize"),BI.prototype),lt(BI.prototype,"fixedArea",[fI,pI,dI],Object.getOwnPropertyDescriptor(BI.prototype,"fixedArea"),BI.prototype),lt(BI.prototype,"near",[mI,vI,gI],Object.getOwnPropertyDescriptor(BI.prototype,"near"),BI.prototype),lt(BI.prototype,"far",[yI,xI,SI],Object.getOwnPropertyDescriptor(BI.prototype,"far"),BI.prototype),lt(BI.prototype,"invisibleOcclusionRange",[Dc,bI,kc,CI,AI,TI],Object.getOwnPropertyDescriptor(BI.prototype,"invisibleOcclusionRange"),BI.prototype),lt(BI.prototype,"shadowDistance",[Dc,wI,kc,EI,PI,II],Object.getOwnPropertyDescriptor(BI.prototype,"shadowDistance"),BI.prototype),lt(BI.prototype,"orthoSize",[RI,DI,MI],Object.getOwnPropertyDescriptor(BI.prototype,"orthoSize"),BI.prototype),OI=BI))||OI)||OI);u.ShadowsInfo=FR;var zR=new Ei(-1024,-1024,-1024),VR=new Ei(1024,1024,1024),kR=(tR=pc("cc.OctreeInfo"),eR=Rc(),iR=Nc(),nR=Nc(),rR=Bc(),oR=Nc(),aR=Bc(),sR=Lc(),cR=Kc(Me),lR=Nc(),tR(uR=eR((mR=function(){function t(){ct(this,"_enabled",_R,this),ct(this,"_minPos",fR,this),ct(this,"_maxPos",pR,this),ct(this,"_depth",dR,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}(),_R=lt((hR=mR).prototype,"_enabled",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fR=lt(hR.prototype,"_minPos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(zR)}}),pR=lt(hR.prototype,"_maxPos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(VR)}}),dR=lt(hR.prototype,"_depth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),lt(hR.prototype,"enabled",[Dc,iR],Object.getOwnPropertyDescriptor(hR.prototype,"enabled"),hR.prototype),lt(hR.prototype,"minPos",[Dc,nR,rR],Object.getOwnPropertyDescriptor(hR.prototype,"minPos"),hR.prototype),lt(hR.prototype,"maxPos",[Dc,oR,aR],Object.getOwnPropertyDescriptor(hR.prototype,"maxPos"),hR.prototype),lt(hR.prototype,"depth",[Dc,sR,cR,lR],Object.getOwnPropertyDescriptor(hR.prototype,"depth"),hR.prototype),uR=hR))||uR)||uR),UR=(vR=pc("cc.SceneGlobals"),gR=Kc(NR),vR((wR=function(){function t(){ct(this,"ambient",SR,this),ct(this,"shadows",bR,this),ct(this,"_skybox",CR,this),ct(this,"fog",AR,this),ct(this,"octree",TR,this)}return t.prototype.activate=function(){var t=u.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)},Q(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),SR=lt((xR=wR).prototype,"ambient",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BR}}),bR=lt(xR.prototype,"shadows",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FR}}),CR=lt(xR.prototype,"_skybox",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NR}}),AR=lt(xR.prototype,"fog",[Dc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LR}}),lt(xR.prototype,"skybox",[Dc,gR],Object.getOwnPropertyDescriptor(xR.prototype,"skybox"),xR.prototype),TR=lt(xR.prototype,"octree",[Dc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kR}}),yR=xR))||yR);u.SceneGlobals=UR;var GR=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());GR.NO_TYPE="no_type",GR.TOUCH="touch",GR.MOUSE="mouse",GR.KEYBOARD="keyboard",GR.ACCELERATION="acceleration",GR.NONE=0,GR.CAPTURING_PHASE=1,GR.AT_TARGET=2,GR.BUBBLING_PHASE=3,u.Event=GR;var HR=t("EventAcceleration",function(t){function e(e,i){var n;return(n=t.call(this,Vw.DEVICEMOTION,i)||this).acc=void 0,n.acc=e,n}return $(e,t),e}(GR));GR.EventAcceleration=HR;var jR=t("EventKeyboard",function(t){function e(e,i,n){var r;return"boolean"==typeof i&&(i=i?Vw.KEY_DOWN:Vw.KEY_UP),(r=t.call(this,i,n)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=i!==Vw.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return $(e,t),Q(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(GR));GR.EventKeyboard=jR;var WR=t("EventMouse",function(t){function e(i,n,r){var o;return(o=t.call(this,i,n)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=e.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=i,r&&(o._prevX=r.x,o._prevY=r.y),o}$(e,t);var i=e.prototype;return i.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},i.getScrollX=function(){return this._scrollX},i.getScrollY=function(){return this._scrollY},i.setLocation=function(t,e){this._x=t,this._y=e},i.getLocation=function(t){return t||(t=new qi),qi.set(t,this._x,this._y),t},i.getLocationInView=function(t){return t||(t=new qi),qi.set(t,this._x,u.view._designResolutionSize.height-this._y),t},i.getUILocation=function(t){return t||(t=new qi),qi.set(t,this._x,this._y),u.view._convertToUISpace(t),t},i.getPreviousLocation=function(t){return t||(t=new qi),qi.set(t,this._prevX,this._prevY),t},i.getUIPreviousLocation=function(t){return t||(t=new qi),qi.set(t,this._prevX,this._prevY),u.view._convertToUISpace(t),t},i.getDelta=function(t){return t||(t=new qi),qi.set(t,this._x-this._prevX,this._y-this._prevY),t},i.getDeltaX=function(){return this._x-this._prevX},i.getDeltaY=function(){return this._y-this._prevY},i.getUIDelta=function(t){return t||(t=new qi),qi.set(t,(this._x-this._prevX)/u.view.getScaleX(),(this._y-this._prevY)/u.view.getScaleY()),t},i.getUIDeltaX=function(){return(this._x-this._prevX)/u.view.getScaleX()},i.getUIDeltaY=function(){return(this._y-this._prevY)/u.view.getScaleY()},i.setButton=function(t){this._button=t},i.getButton=function(){return this._button},i.getLocationX=function(){return this._x},i.getLocationY=function(){return this._y},i.getUILocationX=function(){var t=u.view.getViewportRect();return(this._x-t.x)/u.view.getScaleX()},i.getUILocationY=function(){var t=u.view.getViewportRect();return(this._y-t.y)/u.view.getScaleY()},Q(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(GR));WR.BUTTON_MISSING=-1,WR.BUTTON_LEFT=0,WR.BUTTON_RIGHT=2,WR.BUTTON_MIDDLE=1,WR.BUTTON_4=3,WR.BUTTON_5=4,WR.BUTTON_6=5,WR.BUTTON_7=6,WR.BUTTON_8=7,GR.EventMouse=WR;var qR=new qi,XR=t("EventTouch",function(t){function e(e,i,n,r){var o;return void 0===r&&(r=[]),(o=t.call(this,n,i)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=n,o._touches=e||[],o._allTouches=r,o}$(e,t);var i=e.prototype;return i.getEventCode=function(){return this._eventCode},i.getTouches=function(){return this._touches},i.getAllTouches=function(){return this._allTouches},i.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},i.getLocation=function(t){return this.touch?this.touch.getLocation(t):new qi},i.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new qi},i.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new qi},i.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new qi},i.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new qi},i.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new qi},i.getID=function(){return this.touch?this.touch.getID():null},i.getDelta=function(t){return this.touch?this.touch.getDelta(t):new qi},i.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new qi},i.getDeltaX=function(){return this.touch?this.touch.getDelta(qR).x:0},i.getDeltaY=function(){return this.touch?this.touch.getDelta(qR).y:0},i.getLocationX=function(){return this.touch?this.touch.getLocationX():0},i.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(GR));XR.MAX_TOUCHES=5,GR.EventTouch=XR;var YR,KR=t("Acceleration",(function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=i,this.timestamp=n}));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(YR||(YR=t("KeyCode",{})));var JR=new qi,QR=t("Touch",function(){function t(t,e,i){void 0===i&&(i=0),this._point=new qi,this._prevPoint=new qi,this._lastModified=0,this._id=0,this._startPoint=new qi,this._startPointCaptured=!1,this.setTouchInfo(i,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new qi),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new qi),t.set(this._point.x,this._point.y),u.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=u.view.getViewportRect();return(this._point.x-t.x)/u.view.getScaleX()},e.getUILocationY=function(){var t=u.view.getViewportRect();return(this._point.y-t.y)/u.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new qi),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new qi),t.set(this._prevPoint.x,this._prevPoint.y),u.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new qi),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new qi),t.set(this._startPoint.x,this._startPoint.y),u.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new qi),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new qi),JR.set(this._point),JR.subtract(this._prevPoint),t.set(u.view.getScaleX(),u.view.getScaleY()),qi.divide(t,JR,t),t},e.getLocationInView=function(t){return t||(t=new qi),t.set(this._point.x,u.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new qi),t.set(this._prevPoint.x,u.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new qi),t.set(this._startPoint.x,u.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,i){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new qi(e||0,i||0),this._id=t,this._startPointCaptured||(this._startPoint=new qi(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=u.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new qi(t.x,t.y):new qi(t||0,e||0),this._lastModified=u.game.frameStartTime},Q(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());u.Touch=QR;var ZR,$R,tD=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new eu,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,du.browserType===nu.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var i=0,n=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=t.accelerationIncludingGravity;i=.1*((null==o?void 0:o.x)||0),n=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=t;i=(a.gamma||0)/90*.981,n=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(ah.isFrameRotated){var s=i;i=-n,n=s}var c=i;90===window.orientation?(i=-n,n=c):-90===window.orientation?(i=n,n=-c):180===window.orientation&&(i=-i,n=-n),du.os===au.ANDROID&&du.browserType!==nu.MOBILE_QQ&&(i=-i,n=-n);var l=performance.now(),u=new KR(i,n,r,l),h=new HR(u);this._eventTarget.emit(kw.DEVICEMOTION,h)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},t}(),eD={Backspace:YR.BACKSPACE,Tab:YR.TAB,Enter:YR.ENTER,ShiftLeft:YR.SHIFT_LEFT,ControlLeft:YR.CTRL_LEFT,AltLeft:YR.ALT_LEFT,ShiftRight:YR.SHIFT_RIGHT,ControlRight:YR.CTRL_RIGHT,AltRight:YR.ALT_RIGHT,Pause:YR.PAUSE,CapsLock:YR.CAPS_LOCK,Escape:YR.ESCAPE,Space:YR.SPACE,PageUp:YR.PAGE_UP,PageDown:YR.PAGE_DOWN,End:YR.END,Home:YR.HOME,ArrowLeft:YR.ARROW_LEFT,ArrowUp:YR.ARROW_UP,ArrowRight:YR.ARROW_RIGHT,ArrowDown:YR.ARROW_DOWN,Insert:YR.INSERT,Delete:YR.DELETE,Digit0:YR.DIGIT_0,Digit1:YR.DIGIT_1,Digit2:YR.DIGIT_2,Digit3:YR.DIGIT_3,Digit4:YR.DIGIT_4,Digit5:YR.DIGIT_5,Digit6:YR.DIGIT_6,Digit7:YR.DIGIT_7,Digit8:YR.DIGIT_8,Digit9:YR.DIGIT_9,KeyA:YR.KEY_A,KeyB:YR.KEY_B,KeyC:YR.KEY_C,KeyD:YR.KEY_D,KeyE:YR.KEY_E,KeyF:YR.KEY_F,KeyG:YR.KEY_G,KeyH:YR.KEY_H,KeyI:YR.KEY_I,KeyJ:YR.KEY_J,KeyK:YR.KEY_K,KeyL:YR.KEY_L,KeyM:YR.KEY_M,KeyN:YR.KEY_N,KeyO:YR.KEY_O,KeyP:YR.KEY_P,KeyQ:YR.KEY_Q,KeyR:YR.KEY_R,KeyS:YR.KEY_S,KeyT:YR.KEY_T,KeyU:YR.KEY_U,KeyV:YR.KEY_V,KeyW:YR.KEY_W,KeyX:YR.KEY_X,KeyY:YR.KEY_Y,KeyZ:YR.KEY_Z,Numpad0:YR.NUM_0,Numpad1:YR.NUM_1,Numpad2:YR.NUM_2,Numpad3:YR.NUM_3,Numpad4:YR.NUM_4,Numpad5:YR.NUM_5,Numpad6:YR.NUM_6,Numpad7:YR.NUM_7,Numpad8:YR.NUM_8,Numpad9:YR.NUM_9,NumpadMultiply:YR.NUM_MULTIPLY,NumpadAdd:YR.NUM_PLUS,NumpadSubtract:YR.NUM_SUBTRACT,NumpadDecimal:YR.NUM_DECIMAL,NumpadDivide:YR.NUM_DIVIDE,NumpadEnter:YR.NUM_ENTER,F1:YR.F1,F2:YR.F2,F3:YR.F3,F4:YR.F4,F5:YR.F5,F6:YR.F6,F7:YR.F7,F8:YR.F8,F9:YR.F9,F10:YR.F10,F11:YR.F11,F12:YR.F12,NumLock:YR.NUM_LOCK,ScrollLock:YR.SCROLL_LOCK,Semicolon:YR.SEMICOLON,Equal:YR.EQUAL,Comma:YR.COMMA,Minus:YR.DASH,Period:YR.PERIOD,Slash:YR.SLASH,Backquote:YR.BACK_QUOTE,BracketLeft:YR.BRACKET_LEFT,Backslash:YR.BACKSLASH,BracketRight:YR.BRACKET_RIGHT,Quote:YR.QUOTE},iD=function(){function t(){this._eventTarget=new eu,this._registerEvent()}var e=t.prototype;return e._registerEvent=function(){var t=this,e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",(function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var i=t._getInputEvent(e,kw.KEY_PRESSING);t._eventTarget.emit(kw.KEY_PRESSING,i)}else{var n=t._getInputEvent(e,kw.KEY_DOWN);t._eventTarget.emit(kw.KEY_DOWN,n)}})),null==e||e.addEventListener("keyup",(function(e){var i=t._getInputEvent(e,kw.KEY_UP);e.stopPropagation(),e.preventDefault(),t._eventTarget.emit(kw.KEY_UP,i)}))},e._getInputEvent=function(t,e){var i,n=(i=t.code,eD[i]||YR.NONE);return new jR(n,e)},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},t}(),nD=function(){function t(){this._canvas=void 0,this._eventTarget=new eu,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new qi,du.hasFeature(cu.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new en(e.x,e.y,e.width,e.height):new en(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),i=ah.devicePixelRatio,n=this._pointLocked?this._preMousePos.x/i+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/i-t.movementY:e.y+e.height-t.clientY;return new qi(n*=i,r*=i)},e._registerEvent=function(){var t,e,i,n,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._createCallback(kw.MOUSE_DOWN)),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._createCallback(kw.MOUSE_MOVE));var o=this._createCallback(kw.MOUSE_UP);window.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(i){var n,r=e._getLocation(i),o=i.button;switch(t){case kw.MOUSE_DOWN:null===(n=e._canvas)||void 0===n||n.focus(),e._isPressed=!0;break;case kw.MOUSE_UP:e._isPressed=!1;break;case kw.MOUSE_MOVE:e._isPressed||(o=WR.BUTTON_MISSING)}var a=new WR(t,!1,e._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=i.movementX,a.movementY=i.movementY,e._preMousePos.set(r.x,r.y),i.stopPropagation(),i.target===e._canvas&&i.preventDefault(),e._eventTarget.emit(t,a)}},e._handleMouseWheel=function(t){var e=kw.MOUSE_WHEEL,i=this._getLocation(t),n=t.button,r=new WR(e,!1,this._preMousePos);r.setLocation(i.x,i.y),r.setButton(n),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(i.x,i.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},t}(),rD=new qi,oD=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation(rD);var i=new QR(rD.x,rD.y,e);return t.getLocation(rD),i.setPoint(rD.x,rD.y),t.getPreviousLocation(rD),i.setPrevPoint(rD),i},e._createTouch=function(t,e,i){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var n=new QR(e,i,t);return this._touchMap.set(t,n),this._updateTouch(n,e,i),this._cloneTouch(n)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,i){var n=this._touchMap.get(t);return n?this._updateTouch(n,e,i):n=this._createTouch(t,e,i),n?this._cloneTouch(n):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(i){if(i){var n=t._cloneTouch(i);e.push(n)}})),e},e._updateTouch=function(t,e,i){t.getLocation(rD),t.setPrevPoint(rD),t.setPoint(e,i)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var i=ue.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<i)return!1;var n=performance.now();return this._touchMap.forEach((function(t){n-t.lastModified>ue.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),i>=this._touchMap.size},t}()),aD=function(){function t(){this._canvas=void 0,this._eventTarget=new eu,du.hasFeature(cu.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,i,n;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(kw.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(kw.TOUCH_MOVE)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchend",this._createCallback(kw.TOUCH_END)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchcancel",this._createCallback(kw.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(i){for(var n,r=e._getCanvasRect(),o=[],a=i.changedTouches.length,s=0;s<a;++s){var c=i.changedTouches[s],l=c.identifier;if(null!==l){var u=e._getLocation(c,r),h=oD.getTouch(l,u.x,u.y);h&&(t!==kw.TOUCH_END&&t!==kw.TOUCH_CANCEL||oD.releaseTouch(l),o.push(h))}}if(i.stopPropagation(),i.target===e._canvas&&i.preventDefault(),t===kw.TOUCH_START&&(null===(n=e._canvas)||void 0===n||n.focus()),o.length>0){var _=new XR(o,!1,t,ue.ENABLE_MULTI_TOUCH?oD.getAllTouches():o);e._eventTarget.emit(t,_)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new en(e.x,e.y,e.width,e.height):new en(0,0,0,0)},e._getLocation=function(t,e){var i=t.clientX-e.x,n=e.y+e.height-t.clientY;if(ah.isFrameRotated){var r=i;i=e.height-n,n=r}var o=ah.devicePixelRatio;return new qi(i*=o,n*=o)},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}($R||($R={}));var sD=function(){function t(t){this.priority=$R.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),cD=((ZR={})[kw.MOUSE_DOWN]=kw.TOUCH_START,ZR[kw.MOUSE_MOVE]=kw.TOUCH_MOVE,ZR[kw.MOUSE_UP]=kw.TOUCH_END,ZR),lD=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new eu,this._touchInput=new aD,this._mouseInput=new nD,this._keyboardInput=new iD,this._accelerometerInput=new tD,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new sD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var e=t.prototype;return e.on=function(t,e,i){return this._eventTarget.on(t,e,i),e},e.once=function(t,e,i){return this._eventTarget.once(t,e,i),e},e.off=function(t,e,i){this._eventTarget.off(t,e,i)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=cD[t.type],i=oD.getTouch(0,t.getLocationX(),t.getLocationY());if(i){var n=[i],r=new XR(n,!1,e,n);e===kw.TOUCH_END&&oD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,i=0;i<e&&this._eventDispatcherList[i].dispatchEvent(t);++i);},e._registerEvent=function(){var t=this;if(lh.hasFeature(lh.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(kw.TOUCH_START,(function(i){t._dispatchOrPushEventTouch(i,e)})),this._touchInput.on(kw.TOUCH_MOVE,(function(i){t._dispatchOrPushEventTouch(i,e)})),this._touchInput.on(kw.TOUCH_END,(function(i){t._dispatchOrPushEventTouch(i,e)})),this._touchInput.on(kw.TOUCH_CANCEL,(function(i){t._dispatchOrPushEventTouch(i,e)}))}if(lh.hasFeature(lh.Feature.EVENT_MOUSE)){var i=this._eventMouseList;this._mouseInput.on(kw.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,i)})),this._mouseInput.on(kw.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,i)})),this._mouseInput.on(kw.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,i)})),this._mouseInput.on(kw.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,i)}))}if(lh.hasFeature(lh.Feature.EVENT_KEYBOARD)){var n=this._eventKeyboardList;this._keyboardInput.on(kw.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,n)})),this._keyboardInput.on(kw.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,n)})),this._keyboardInput.on(kw.KEY_UP,(function(e){t._dispatchOrPushEvent(e,n)}))}if(lh.hasFeature(lh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(kw.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var i=t.getTouches(),n=i.length,r=0;r<n;++r)t.touch=i[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,i=t.length;e<i;++e){var n=t[e];this._emitEvent(n)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var p=h[_];this._emitEvent(p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._emitEvent(g)}this._clearEvents()},t}());lD.EventType=kw;var uD=t("input",new lD),hD=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,uD.on(kw.MOUSE_DOWN,(function(t){e.emit(Vw.MOUSE_DOWN,t)})),uD.on(kw.MOUSE_MOVE,(function(t){e.emit(Vw.MOUSE_MOVE,t)})),uD.on(kw.MOUSE_UP,(function(t){e.emit(Vw.MOUSE_UP,t)})),uD.on(kw.MOUSE_WHEEL,(function(t){e.emit(Vw.MOUSE_WHEEL,t)})),uD.on(kw.TOUCH_START,(function(t){e.emit(Vw.TOUCH_START,t.touch,t)})),uD.on(kw.TOUCH_MOVE,(function(t){e.emit(Vw.TOUCH_MOVE,t.touch,t)})),uD.on(kw.TOUCH_END,(function(t){e.emit(Vw.TOUCH_END,t.touch,t)})),uD.on(kw.TOUCH_CANCEL,(function(t){e.emit(Vw.TOUCH_CANCEL,t.touch,t)})),uD.on(kw.KEY_DOWN,(function(t){e.emit(Vw.KEY_DOWN,t)})),uD.on(kw.KEY_PRESSING,(function(t){e.emit(Vw.KEY_DOWN,t)})),uD.on(kw.KEY_UP,(function(t){e.emit(Vw.KEY_UP,t)})),uD.on(kw.DEVICEMOTION,(function(t){e.emit(Vw.DEVICEMOTION,t)})),e}$(e,t);var i=e.prototype;return i.setAccelerometerEnabled=function(t){uD.setAccelerometerEnabled(t)},i.setAccelerometerInterval=function(t){uD.setAccelerometerInterval(t)},i.on=function(e,i,n,r){return t.prototype.on.call(this,e,i,n,r),i},i.off=function(e,i,n){t.prototype.off.call(this,e,i,n)},e}(eu));hD.EventType=Vw,u.SystemEvent=hD;var _D,fD=t("systemEvent",new hD);u.systemEvent=fD,k(Vw,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),k(GR,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:hD.EventType,targetName:"SystemEvent.EventType"}]),G(GR,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),k(WR,"EventMouse",["DOWN","UP","MOVE"].map((function(t){return{name:t,newName:"MOUSE_"+t,target:hD.EventType,targetName:"SystemEvent.EventType"}}))),k(WR,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:hD.EventType,targetName:"SystemEvent.EventType"}]),G(WR.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),k(XR,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:hD.EventType,targetName:"SystemEvent.EventType"}]),k(XR,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:hD.EventType,targetName:"SystemEvent.EventType"}]),k(XR,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:hD.EventType,targetName:"SystemEvent.EventType"}]),k(XR,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:hD.EventType,targetName:"SystemEvent.EventType"}]),G(XR.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),k(XR.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:XR,targetName:"EventTouch"}]),G(ue.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(t){return{name:t}}))),G(ue.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),G(ue.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),G(ue.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),G(ue,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),k(dA.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),k(jT.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new qi),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new $i),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),U(UR.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),U(jT.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),k(ZC.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),U(Np,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),k(Np,"Layers",[{name:"Default",newName:"DEFAULT",target:Np.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Np.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Np.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Np.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Np.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Np.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Np.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Np.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Np,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Np,targetName:"Layers"}]),U(Np.Enum,"Layers.Enum",[{name:"ALWAYS"}]),U(Np.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var pD,dD,mD,vD,gD=pl.Flags.HideInHierarchy,yD=pl.Flags.DontSave,xD=t("PrivateNode",pc("cc.PrivateNode")(_D=function(t){function e(e){var i;return D(12003,(i=t.call(this,e)||this).name),i.hideFlags|=yD|gD,i}return $(e,t),e}(jT))||_D);k(Vw,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(t){return{name:t,target:jT.EventType,targetName:"Node.EventType"}}))),k(jT.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:hD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:hD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:hD.EventType,targetName:"SystemEvent.EventType"}]),u.PrivateNode=xD;var SD=t("Scene",pc("cc.Scene")((lt((dD=function(t){$(i,t);var e=i.prototype;function i(e){var i;return ct(i=t.call(this,e)||this,"autoReleaseAssets",mD,ot(i)),ct(i,"_globals",vD,ot(i)),i.dependAssets=null,i._renderScene=null,i._inited=void 0,i._prefabSyncedInLiveReload=!1,i._pos=Ei.ZERO,i._rot=Bi.IDENTITY,i._scale=Ei.ONE,i._mat=Gi.IDENTITY,i._dirtyFlags=0,i._lpos=Ei.ZERO,i._lrot=Bi.IDENTITY,i._lscale=Ei.ONE,i._activeInHierarchy=!1,u.director&&u.director.root&&(i._renderScene=u.director.root.createScene({})),i._inited=!u.game||!u.game._isCloning,i._init(),i}return e._updateScene=function(){this._scene=this},e._init=function(){},e.destroy=function(){var t=pl.prototype.destroy.call(this);if(t)for(var e=this._children,i=0;i<e.length;++i)e[i].active=!1;return this._renderScene&&u.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(F(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var i=this._children.length,n=0;n<i;++n)this.children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},e.getPosition=function(t){return Ei.copy(t||new Ei,Ei.ZERO)},e.getRotation=function(t){return Bi.copy(t||new Bi,Bi.IDENTITY)},e.getScale=function(t){return Ei.copy(t||new Ei,Ei.ONE)},e.getWorldPosition=function(t){return Ei.copy(t||new Ei,Ei.ZERO)},e.getWorldRotation=function(t){return Bi.copy(t||new Bi,Bi.IDENTITY)},e.getWorldScale=function(t){return Ei.copy(t||new Ei,Ei.ONE)},e.getWorldMatrix=function(t){return Gi.copy(t||new Gi,Gi.IDENTITY)},e.getWorldRS=function(t){return Gi.copy(t||new Gi,Gi.IDENTITY)},e.getWorldRT=function(t){return Gi.copy(t||new Gi,Gi.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(cw(this),aw(this),this._onBatchCreated(false),this._inited=!0),this.walk(dA._setScene)},e._activate=function(t){t=!1!==t,u.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()},Q(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Ei.ZERO}},{key:"worldPosition",get:function(){return Ei.ZERO}},{key:"rotation",get:function(){return Bi.IDENTITY}},{key:"worldRotation",get:function(){return Bi.IDENTITY}},{key:"scale",get:function(){return Ei.ONE}},{key:"worldScale",get:function(){return Ei.ONE}},{key:"eulerAngles",get:function(){return Ei.ZERO}},{key:"worldMatrix",get:function(){return Gi.IDENTITY}}]),i}(dA)).prototype,"globals",[Dc],Object.getOwnPropertyDescriptor(dD.prototype,"globals"),dD.prototype),mD=lt(dD.prototype,"autoReleaseAssets",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vD=lt(dD.prototype,"_globals",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UR}}),pD=dD))||pD);function bD(t,e){if(!e){var i=u.director.getScene();if(!i)return null;e=i}return e.getChildByPath(t)}u.Scene=SD,u.find=bD;var CD=ie.fastRemoveAt,AD=pl.Flags.IsStartCalled,TD=pl.Flags.IsOnEnableCalled;function wD(t,e){for(var i=e.constructor._executionOrder,n=e._id,r=0,o=t.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=t[a],c=s.constructor._executionOrder;if(c>i)o=a-1;else if(c<i)r=a+1;else{var l=s._id;if(l>n)o=a-1;else{if(!(l<n))return a;r=a+1}}}return~r}function ED(t,e){for(var i=t.array,n=t.i+1;n<i.length;){var r=i[n];r.node._activeInHierarchy?++n:(t.removeAt(n),e&&(r._objFlags&=~e))}}pl.Flags.IsEditorOnEnableCalled;var PD=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=ut;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function ID(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}PD.stableRemoveInactive=ED;var RD=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},i.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},i.cancelInactive=function(t){ED(this._zero,t),ED(this._neg,t),ED(this._pos,t)},i.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(ID),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(ID),this._invoke(e),e.array.length=0)},e}(PD),DD=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var i=e<0?this._neg.array:this._pos.array,n=wD(i,t);n<0&&i.splice(~n,0,t)}},i.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var i=e<0?this._neg:this._pos,n=wD(i.array,t);n>=0&&i.removeAt(n)}},i.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(PD);function MD(t,e,i){var n="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",r=e?Function("it","dt",n):Function("it",n);return function(t,e,i){return function(n,r){try{e(n,r)}catch(e){u._throw(e);var o=n.array;for(i&&(o[n.i]._objFlags|=i),++n.i;n.i<o.length;++n.i)try{t(o[n.i],r)}catch(t){u._throw(t),i&&(o[n.i]._objFlags|=i)}}}}(Function("c","dt",t),r,i)}var OD=MD("c.start();c._objFlags|="+AD,!1,AD),BD=MD("c.update(dt)",!0),ND=MD("c.lateUpdate(dt)",!0),LD=function(t){var e=u.director._compScheduler,i=t.array;for(t.i=0;t.i<i.length;++t.i){var n=i[t.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||e._onEnabled(n))}},FD=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new RD(OD),this.updateInvoker=new DD(BD),this.lateUpdateInvoker=new DD(ND),this._updating=!1},e._onEnabled=function(t){u.director.getScheduler().resumeTarget(t),t._objFlags|=TD,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){u.director.getScheduler().pauseTarget(t),t._objFlags&=~TD;var e=this._deferredComps.indexOf(t);e>=0?CD(this._deferredComps,e):(!t.start||t._objFlags&AD||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&TD)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&TD&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&AD||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,i=t.length;e<i;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),zD=pl.Flags.IsPreloadStarted,VD=pl.Flags.IsOnLoadStarted,kD=pl.Flags.IsOnLoadCalled,UD=pl.Flags.Deactivating,GD=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.add=function(t){this._zero.array.push(t)},i.remove=function(t){this._zero.fastRemove(t)},i.cancelInactive=function(t){PD.stableRemoveInactive(this._zero,t)},i.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(PD),HD=MD("c.__preload();"),jD=MD("c.onLoad();c._objFlags|="+kD,!1,kD),WD=new ee(4);function qD(t,e,i){O(3817,t.name,i),console.log("Corrupted component value:",e),e?t._removeComponent(e):ie.removeAt(t._components,i)}WD.get=function(){var t=this._get()||{preload:new GD(HD),onLoad:new RD(jD),onEnable:new RD(LD)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var XD,YD,KD,JD,QD,ZD,$D,tM,eM=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var i=WD.get();this._activatingStack.push(i),this._activateNodeRecursively(t,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),WD.put(i)}else{this._deactivateNodeRecursively(t);for(var n,r=st(this._activatingStack);!(n=r()).done;){var o=n.value;o.preload.cancelInactive(zD),o.onLoad.cancelInactive(VD),o.onEnable.cancelInactive()}}t.emit(GC.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,i,n){if(ml(t,!0)&&(t._objFlags&zD||(t._objFlags|=zD,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&VD||(t._objFlags|=VD,t.onLoad?i?i.add(t):(t.onLoad(),t._objFlags|=kD):t._objFlags|=kD),t._enabled)){if(!t.node._activeInHierarchy)return;u.director._compScheduler.enableComp(t,n)}},e.destroyComp=function(t){u.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&kD&&t.onDestroy()},e._activateNodeRecursively=function(t,e,i,n){if(t._objFlags&UD)O(3816,t.name);else{t._activeInHierarchy=!0;for(var r=t._components.length,o=0;o<r;++o){var a=t._components[o];a instanceof u.Component?this.activateComp(a,e,i,n):(qD(t,a,o),--o,--r)}for(var s=0,c=t._children.length;s<c;++s){var l=t._children[s];l._active&&this._activateNodeRecursively(l,e,i,n)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=UD,t._activeInHierarchy=!1;for(var e=t._components.length,i=0;i<e;++i){var n=t._components[i];if(n._enabled&&(u.director._compScheduler.disableComp(n),t._activeInHierarchy))return void(t._objFlags&=~UD)}for(var r=0,o=t._children.length;r<o;++r){var a=t._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),t._activeInHierarchy))return void(t._objFlags&=~UD)}t._onPostActivated(!1),t._objFlags&=~UD},t}()),iM=t("SceneAsset",pc("cc.SceneAsset")((JD=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"scene",KD,ot(e)),e}$(e,t);var i=e.prototype;return i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new SD("New Scene")},i.validate=function(){return!!this.scene},e}(Mu),KD=lt((YD=JD).prototype,"scene",[Dc,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XD=YD))||XD);u.SceneAsset=iM;var nM,rM,oM,aM,sM=t("TextAsset",pc("cc.TextAsset")((tM=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"text",$D,ot(e)),e}return $(e,t),e.prototype.toString=function(){return this.text},e}(Mu),$D=lt((ZD=tM).prototype,"text",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QD=ZD))||QD);u.TextAsset=sM;var cM=t("JsonAsset",pc("cc.JsonAsset")((aM=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"json",oM,ot(e)),e}return $(e,t),e}(Mu),oM=lt((rM=aM).prototype,"json",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nM=rM))||nM);u.JsonAsset=cM;var lM,uM,hM,_M,fM,pM,dM,mM,vM,gM,yM,xM,SM,bM,CM,AM,TM,wM,EM,PM,IM,RM,DM,MM,OM,BM,NM,LM,FM,zM,VM,kM,UM,GM,HM,jM,WM,qM,XM=function(){var t=e.prototype;function e(){this.fog=new TC,this.ambient=new $S,this.skybox=new yb,this.shadows=new bg,this.octree=new eb,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return t._init=function(){},t.activate=function(t,e){return this._device=t,this._pipeline=e,this.initOcclusionQuery(),!0},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new cg;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant()}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},t.onGlobalPipelineStateChanged=function(){},t.destroy=function(){var t,e,i;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,n=8*i;this._occlusionQueryVertexBuffer=t.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,n,i)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=t.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Pr("a_position",_n.RGB32F)],c=new Rr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)},Q(e,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale!==t&&(this._shadingScale=t,this._pipeline.emit(Uy.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(),YM=t("ForwardPipeline",(lM=pc("ForwardPipeline"),uM=Kc([US]),hM=Uc(),lM((dM=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"renderTextures",pM,ot(e)),e._postRenderPass=null,e}$(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var i=new SC;i.initialize(SC.initInfo),this._flows.push(i);var n=new nC;n.initialize(nC.initInfo),this._flows.push(n)}return!0},i.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new XM,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(O(2402),1))},i._ensureEnoughSize=function(t){for(var e=this._width,i=this._height,n=0;n<t.length;++n){var r=t[n].window;e=Math.max(r.width,e),i=Math.max(r.height,i)}e===this._width&&i===this._height||(this._width=e,this._height=i)},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),i=e.next();!i.done;)i.value.destroy(),i=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},i._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(td,e),this._descriptorSet.bindTexture(td,Mv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ld,e),this._descriptorSet.bindTexture(ld,Mv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Qp.BINDING).destroy(),this._descriptorSet.getBuffer($p.BINDING).destroy(),this._descriptorSet.getBuffer(Zp.BINDING).destroy(),this._descriptorSet.getTexture(td).destroy(),this._descriptorSet.getTexture(ld).destroy())},Q(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(lx),pM=lt((fM=dM).prototype,"renderTextures",[uM,xc,hM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_M=fM))||_M)),KM=[new sr(0,0,0,0),new sr(0,0,0,0),new sr(0,0,0,0)],JM=t("GbufferStage",(mM=pc("GbufferStage"),vM=Kc([jS]),gM=Uc(),mM((CM=bM=function(t){function e(){var e;return ct(e=t.call(this)||this,"renderQueues",SM,ot(e)),e._renderQueues=[],e._renderArea=new $n,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Ov("default"),e._batchedQueue=new QS,e._instancedQueue=new ZS,e}$(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=YS(this.renderQueues[n])},i.destroy=function(){},i.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,i=e.device;this._renderQueues.forEach(KS),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var n=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<n.length;++s){var c=n[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Pv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===Pv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(JS);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&Xn.COLOR&&(e.pipelineSceneData.isHDR?Hv(KM[0],t.clearColor):(KM[0].x=t.clearColor.x,KM[0].y=t.clearColor.y,KM[0].z=t.clearColor.z)),KM[0].w=t.clearColor.w;var v=e.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,KM,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(i,g,m);this._instancedQueue.recordCommandBuffer(i,g,m),this._batchedQueue.recordCommandBuffer(i,g,m),m.endRenderPass()},e}(ky),bM.initInfo={name:"GbufferStage",priority:ex.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:kS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:kS.BACK_TO_FRONT,stages:["default"]}]},SM=lt((xM=CM).prototype,"renderQueues",[vM,xc,gM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yM=xM))||yM)),QM=[new sr(0,0,0,1)],ZM=t("LightingStage",(AM=pc("LightingStage"),TM=Kc(cg),wM=Uc(),EM=Kc([jS]),PM=Uc(),AM((BM=OM=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=vd.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new $n,e._uiPhase=void 0,ct(e,"_deferredMaterial",DM,ot(e)),ct(e,"renderQueues",MM,ot(e)),e._phaseID=Ov("default"),e._renderQueues=[],e._uiPhase=new tC,e}$(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),!0},i.gatherLights=function(t){for(var e=this._pipeline,i=e.commandBuffers[0],n=t.scene.sphereLights,r=t.scene.spotLights,o=sa.create(0,0,0,1),a=new Float32Array(4),s=t.exposure,c=0,l=Ji.length,u=l*this._maxDeferredLights,h=0;h<n.length&&c<this._maxDeferredLights;h++,++c){var _=n[h];if(sa.set(o,_.position.x,_.position.y,_.position.z,_.range),hs.sphereFrustum(o,t.frustum)){if(Ei.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),Ei.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}e.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(sa.set(o,d.position.x,d.position.y,d.position.z,d.range),hs.sphereFrustum(o,t.frustum)){if(Ei.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),Ei.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),Ei.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),i.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._uiPhase.activate(e);for(var n=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=YS(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/n.capabilities.uboOffsetAlignment)*n.capabilities.uboOffsetAlignment,this._deferredLitsBufs=n.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,o,n.capabilities.uboOffsetAlignment));var a=n.createBuffer(new _r(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new kr(Hp.bindings);this._descriptorSetLayout=n.createDescriptorSetLayout(s),this._descriptorSet=n.createDescriptorSet(new Ur(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(md.BINDING,a),this._planarQueue=new $b(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},i.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},i.render=function(t){var e=this._pipeline,i=e.device,n=e.commandBuffers[0],r=e.pipelineSceneData,o=r.renderObjects;this.gatherLights(t),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(t,n),n.bindDescriptorSet(Xp.LOCAL,this._descriptorSet,[0]),e.generateRenderArea(t,this._renderArea),t.clearFlag&Xn.COLOR&&(QM[0].x=t.clearColor.x,QM[0].y=t.clearColor.y,QM[0].z=t.clearColor.z),QM[0].w=0;var a=e.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;e.pipelineUBO.updateShadowUBO(t),n.beginRenderPass(c,s,this._renderArea,QM,t.clearDepth,t.clearStencil),n.setScissor(e.generateScissor(t)),n.setViewport(e.generateViewport(t)),n.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),n.bindDescriptorSet(Xp.MATERIAL,l.descriptorSet);var _=e.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=kv.getOrCreatePipelineState(i,l,u,c,_)),null!=f&&(n.bindPipelineState(f),n.bindInputAssembler(_),n.draw(_)),this._renderQueues.forEach(KS);for(var p=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(p=0;p<y.length;++p){var x=y[p].passes;for(d=0;d<x.length;++d)if(x[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(o.length>0){this._renderQueues.forEach(JS);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(i,c,n);this._planarQueue.recordCommandBuffer(i,c,n)}this._uiPhase.render(t,c),n.endRenderPass()},e}(ky),OM.initInfo={name:"LightingStage",priority:ex.LIGHTING,tag:0},DM=lt((RM=BM).prototype,"_deferredMaterial",[TM,xc,wM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MM=lt(RM.prototype,"renderQueues",[EM,xc,PM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IM=RM))||IM)),$M=[new sr(0,0,0,1)],tO=t("PostProcessStage",(NM=pc("PostProcessStage"),LM=Kc(cg),FM=Uc(),zM=Kc([jS]),VM=Uc(),NM((WM=jM=function(t){function e(){var e;return ct(e=t.call(this)||this,"_postProcessMaterial",GM,ot(e)),ct(e,"renderQueues",HM,ot(e)),e._renderArea=new $n,e._uiPhase=new tC,e}$(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},i.destroy=function(){},i.render=function(t){var e=this._pipeline,i=e.device,n=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var o=t.viewport;this._renderArea.x=o.x*t.window.width,this._renderArea.y=o.y*t.window.height,this._renderArea.width=o.width*t.window.width,this._renderArea.height=o.height*t.window.height;var a=e.getPipelineRenderData(),s=t.window.framebuffer,c=e.getRenderPass(t.clearFlag,s);t.clearFlag&Xn.COLOR&&($M[0].x=t.clearColor.x,$M[0].y=t.clearColor.y,$M[0].z=t.clearColor.z),$M[0].w=t.clearColor.w,r.beginRenderPass(c,s,this._renderArea,$M,t.clearDepth,t.clearStencil),r.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet);var l=n.postprocessMaterial.passes[0],u=l.getShaderVariant();e.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(Xp.MATERIAL,l.descriptorSet);var h=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=kv.getOrCreatePipelineState(i,l,u,c,h));var f=e.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(t,c),eg(i,c,r,e.profiler,t),r.endRenderPass()},e}(ky),jM.initInfo={name:"PostProcessStage",priority:Zy.POST_PROCESS,tag:0},GM=lt((UM=WM).prototype,"_postProcessMaterial",[LM,xc,FM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HM=lt(UM.prototype,"renderQueues",[zM,xc,VM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kM=UM))||kM));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(qM||(qM={}));var eO,iO,nO,rO,oO,aO,sO,cO,lO=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._antiAliasing=qM.NONE,e}$(e,t);var i=e.prototype;return i.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=[],i=[],n=0;n<6;++n){var r=this._bloomMaterial.passes[1+n];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+n];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),e.push(r.native),i.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var t=new cg;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var i=new cg;i._uuid="builtin-bloom-material",i.initialize({effectName:"bloom"});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._bloomMaterial=i;var r=new cg;r._uuid="builtin-post-process-material",ue.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=qM.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(e,i){return t.prototype.activate.call(this,e,i),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},Q(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var i=new cg;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}(XM),uO=[new sr(0,0,0,1)],hO=function(){};hO.SIZE=4*(hO.COUNT=4+(hO.TEXTURE_SIZE_OFFSET=0));var _O,fO,pO,dO,mO,vO,gO,yO,xO,SO,bO=t("BloomStage",(eO=pc("BloomStage"),iO=Kc(cg),nO=Uc(),eO((cO=sO=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,ct(e,"_bloomMaterial",aO,ot(e)),e._renderArea=new $n,e._bloomUBO=[],e}$(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},i.destroy=function(){},i.render=function(t){var e,i=this._pipeline;if(i.generateBloomRenderData(),((null===(e=t.window)||void 0===e?void 0:e.swapchain)||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var n=0;n<14;++n)this._bloomUBO[n]=i.device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,hO.SIZE,hO.SIZE));t.clearFlag&Xn.COLOR&&(uO[0].x=t.clearColor.x,uO[0].y=t.clearColor.y,uO[0].z=t.clearColor.z),uO[0].w=t.clearColor.w,this._prefilterPass(t,i),this._downsamplePass(t,i),this._upsamplePass(t,i),this._combinePass(t,i)}},i._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=e.commandBuffers[0],n=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(hO.COUNT);a[hO.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],a),i.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,uO,0,0),i.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet),n.descriptorSet.bindBuffer(0,this._bloomUBO[0]),n.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),n.descriptorSet.bindSampler(1,o.sampler),n.descriptorSet.update(),i.bindDescriptorSet(Xp.MATERIAL,n.descriptorSet);var s=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null,l=n.getShaderVariant();null!=n&&null!=l&&null!=s&&(c=kv.getOrCreatePipelineState(e.device,n,l,o.renderPass,s)),null!=c&&(i.bindPipelineState(c),i.bindInputAssembler(s),i.draw(s)),i.endRenderPass()},i._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=e.commandBuffers[0],n=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,o=new Float32Array(hO.COUNT),a=0;a<this.iterations;++a){o[hO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[hO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,uO,0,0);var s=n.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),i.bindDescriptorSet(Xp.MATERIAL,s.descriptorSet);var l=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=kv.getOrCreatePipelineState(e.device,s,c,r.renderPass,l)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(l),i.draw(l)),i.endRenderPass()}},i._upsamplePass=function(t,e){var i=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var n=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,o=new Float32Array(hO.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[hO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[hO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,n.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-a],this._renderArea,uO,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,i.sampler),c.descriptorSet.update(),n.bindDescriptorSet(Xp.MATERIAL,c.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=kv.getOrCreatePipelineState(e.device,c,l,i.renderPass,u)),null!=h&&(n.bindPipelineState(h),n.bindInputAssembler(u),n.draw(u)),n.endRenderPass()}},i._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var i=e.commandBuffers[0],n=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(hO.COUNT);a[hO.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],a),i.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,uO,0,0),i.bindDescriptorSet(Xp.GLOBAL,e.descriptorSet);var s=n.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),i.bindDescriptorSet(Xp.MATERIAL,s.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=kv.getOrCreatePipelineState(e.device,s,u,o.renderPass,c)),null!=l&&(i.bindPipelineState(l),i.bindInputAssembler(c),i.draw(c)),i.endRenderPass()},e}(ky),sO.initInfo={name:"BloomStage",priority:Zy.BLOOM,tag:0},aO=lt((oO=cO).prototype,"_bloomMaterial",[iO,xc,nO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rO=oO))||rO)),CO=t("MainFlow",pc("MainFlow")((pO=fO=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var i=new JM;i.initialize(JM.initInfo),this._stages.push(i);var n=new ZM;n.initialize(ZM.initInfo),this._stages.push(n);var r=new bO;r.initialize(bO.initInfo),this._stages.push(r);var o=new tO;o.initialize(tO.initInfo),this._stages.push(o)}return!0},i.activate=function(e){t.prototype.activate.call(this,e)},i.render=function(e){t.prototype.render.call(this,e)},i.destroy=function(){t.prototype.destroy.call(this)},e}(Gy),fO.initInfo={name:zp,priority:ix.MAIN,stages:[]},_O=pO))||_O),AO=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return $(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),TO=t("DeferredPipeline",(dO=pc("DeferredPipeline"),mO=Kc([US]),vO=Uc(),dO((SO=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,ct(e,"renderTextures",xO,ot(e)),e}$(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var i=new SC;i.initialize(SC.initInfo),this._flows.push(i);var n=new CO;n.initialize(CO.initInfo),this._flows.push(n)}return!0},i.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new lO,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(O(2402),1))},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),i=e.next();!i.done;)i.value.destroy(),i=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},i.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},i._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(td,i),this._descriptorSet.bindTexture(td,Mv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ld,i),this._descriptorSet.bindTexture(ld,Mv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var n=new cx;if(!(n=this._createQuadInputAssembler()).quadIB||!n.quadVB||!n.quadIA)return!1;this._quadIB=n.quadIB,this._quadVBOffscreen=n.quadVB,this._quadIAOffscreen=n.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Dr;o.format=_n.RGBA16F,o.loadOp=Mn.CLEAR,o.storeOp=On.STORE;var a=new Dr;a.format=_n.RGBA16F,a.loadOp=Mn.CLEAR,a.storeOp=On.STORE;var s=new Dr;s.format=_n.RGBA16F,s.loadOp=Mn.CLEAR,s.storeOp=On.STORE;var c=new Mr;c.format=_n.DEPTH_STENCIL,c.depthLoadOp=Mn.CLEAR,c.depthStoreOp=On.STORE,c.stencilLoadOp=Mn.CLEAR,c.stencilStoreOp=On.STORE;var l=new Nr([o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Dr;u.format=_n.RGBA8,u.loadOp=Mn.CLEAR,u.storeOp=On.STORE,u.endAccesses=[Bn.COLOR_ATTACHMENT_WRITE];var h=new Mr;h.format=_n.DEPTH_STENCIL,h.depthLoadOp=Mn.LOAD,h.depthStoreOp=On.DISCARD,h.stencilLoadOp=Mn.LOAD,h.stencilStoreOp=On.DISCARD,h.beginAccesses=[Bn.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Bn.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Nr([u],h);this._lightingRenderPass=e.createRenderPass(_)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Qp.BINDING).destroy(),this._descriptorSet.getBuffer($p.BINDING).destroy(),this._descriptorSet.getBuffer(Zp.BINDING).destroy(),this._descriptorSet.getTexture(td).destroy(),this._descriptorSet.getTexture(ld).destroy())},i._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var i=0;i<t.outputRenderTargets.length;i++)t.outputRenderTargets[i].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},i._ensureEnoughSize=function(t){for(var e=this._width,i=this._height,n=0;n<t.length;++n){var r=t[n].window;e=Math.max(r.width,e),i=Math.max(r.height,i)}e===this._width&&i===this._height||(this._width=e,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},i._generateDeferredRenderData=function(){for(var t=this,e=this.device,i=this._pipelineRenderData=new AO,n=this.pipelineSceneData,r=0;r<3;++r)i.gbufferRenderTargets.push(e.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,_n.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale)));i.outputDepth=e.createTexture(new mr(yn.TEX2D,xn.DEPTH_STENCIL_ATTACHMENT|xn.SAMPLED,_n.DEPTH_STENCIL,this._width*n.shadingScale,this._height*n.shadingScale)),i.gbufferFrameBuffer=e.createFramebuffer(new zr(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(e.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED,_n.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale))),i.outputFrameBuffer=e.createFramebuffer(new zr(this._lightingRenderPass,i.outputRenderTargets,null)),this.on(Uy.ATTACHMENT_SCALE_CAHNGED,(function(e){i.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(i.gbufferFrameBuffer),t.applyFramebufferRatio(i.outputFrameBuffer)})),i.sampler=this.globalDSManager.linearSampler},e}(lx),xO=lt((yO=SO).prototype,"renderTextures",[mO,xc,vO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gO=yO))||gO));function wO(){var t=new YM;return t.initialize({flows:[]}),t}var EO=new qi,PO=function(){var t=e.prototype;function e(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return t.pauseRendering=function(){this.isPause=!0},t.resumeRendering=function(){this.isPause=!1},t.main=function(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){var e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new sr(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new sr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{u.view.resizeWithBrowserSize(!0);var i=window._CCSettings.designResolution;i?u.view.setDesignResolutionSize(i.width,i.height,i.policy):u.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,u.game.once(u.Game.EVENT_GAME_INITED,(function(){u.director._lateUpdate=performance.now()}),u.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else b("RENDER ROOT IS NULL.")},t.setOnFinish=function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t},t._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),u.game.resume())},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new sr(t.x,t.y,t.z,t.w)];var e=this.device,i=this.swapchain;this.renderArea=new $n(0,0,i.width,i.height),this.cmdBuff=e.commandBuffer;var n=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=e.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,o,r)),this.vertexBuffers.update(n);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=e.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Pr("a_position",_n.RG32F),new Pr("a_texCoord",_n.RG32F)],u=new Rr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(u),this.projection=new Gi,Gi.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,i.surfaceTransform)},t.init=function(){var t=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),u.game.pause(),this.handle=requestAnimationFrame((function e(i){if(!t.cancelAnimate){var n=t.settings,r=t.device,o=t.swapchain;Gi.ortho(t.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;t.startTime<0&&(t.startTime=i);var l=i-t.startTime,u=f_(si(l/n.totalTime));"NONE"===n.effect&&(u=1);var h=t.logoTexture.width,_=t.logoTexture.height,f=c*n.displayRatio,p=f*h/_,d=f;if(o.surfaceTransform!==un.ROTATE_90&&o.surfaceTransform!==un.ROTATE_270||(p=f*a/s,d=f*_/h*s/a),t.logoMat.setProperty("resolution",EO.set(a,s),0),t.logoMat.setProperty("scale",EO.set(p,d),0),t.logoMat.setProperty("translate",EO.set(.5*a,.5*s),0),t.logoMat.setProperty("percent",u),t.logoMat.setProperty("u_projection",t.projection),t.logoMat.passes[0].update(),n.displayWatermark&&t.watermarkMat){var m=.5*c,v=t.watermarkTexture.width,g=m,y=m*t.watermarkTexture.height/v;o.surfaceTransform!==un.ROTATE_90&&o.surfaceTransform!==un.ROTATE_270||(g=.5*m,y=m*a/s*.5),t.watermarkMat.setProperty("resolution",EO.set(a,s),0),t.watermarkMat.setProperty("scale",EO.set(g,y),0),t.watermarkMat.setProperty("translate",EO.set(.5*a,.1*s),0),t.watermarkMat.setProperty("percent",u),t.watermarkMat.setProperty("u_projection",t.projection),t.watermarkMat.passes[0].update()}t.isPause||(t.frame(),l>n.totalTime&&(t.splashFinish=!0)),requestAnimationFrame(e)}}))},t.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},t.initLogo=function(){var t=this.device;this.logoMat=new cg,this.logoMat.initialize({effectName:"splash-screen"});var e=new gr;e.addressU=Tn.CLAMP,e.addressV=Tn.CLAMP,e.addressW=Tn.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new mr(yn.TEX2D,xn.SAMPLED|xn.TRANSFER_DST,_n.RGBA8,this.logoImage.width,this.logoImage.height));var i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=i.getShaderVariant();var r=i.descriptorSet;r.bindSampler(n,this.sampler),r.update();var o=new or;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var i="Powered by Cocos Creator",n=e.measureText(i);e.fillText(i,(330-n.width)/2,6);var r=new or;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new mr(yn.TEX2D,xn.SAMPLED|xn.TRANSFER_DST,_n.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new cg,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;t.acquire([e]);var i=this.cmdBuff,n=this.framebuffer,r=this.renderArea;r.width=e.width,r.height=e.height,i.begin(),i.beginRenderPass(n.renderPass,n,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=kv.getOrCreatePipelineState(t,o,this.shader,n.renderPass,this.quadAssmebler);if(i.bindPipelineState(a),i.bindDescriptorSet(Xp.MATERIAL,o.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=kv.getOrCreatePipelineState(t,s,this.shader,n.renderPass,this.quadAssmebler);i.bindPipelineState(c),i.bindDescriptorSet(Xp.MATERIAL,s.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler)}i.endRenderPass(),i.end(),t.flushCommands([i]),t.queue.submit([i]),t.present()},t.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0},Q(e,[{key:"splashFinish",set:function(t){this._splashFinish=t,this._tryToStart()}},{key:"loadFinish",set:function(t){this._loadFinish=t,this._tryToStart()}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();PO._ins=void 0,u.internal.SplashScreen=PO;var IO=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},Q(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());IO.Priority=oe({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var RO=new mt("Scheduler"),DO=function(t,e,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=i,this.markedForDeletion=n};DO.get=function(t,e,i,n){var r=DO._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=i,r.markedForDeletion=n):r=new DO(t,e,i,n),r},DO.put=function(t){DO._listEntries.length<20&&(t.target=null,DO._listEntries.push(t))},DO._listEntries=[];var MO=function(t,e,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=i,this.callback=n};MO.get=function(t,e,i,n){var r=MO._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=i,r.callback=n):r=new MO(t,e,i,n),r},MO.put=function(t){MO._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,MO._hashUpdateEntries.push(t))},MO._hashUpdateEntries=[];var OO=function(t,e,i,n,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=r,this.paused=o};OO.get=function(t,e,i,n,r,o){var a=OO._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=i,a.currentTimer=n,a.currentTimerSalvaged=r,a.paused=o):a=new OO(t,e,i,n,r,o),a},OO.put=function(t){OO._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,OO._hashTimerEntries.push(t))},OO._hashTimerEntries=[];var BO=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,i,n,r,o){return this._lock=!1,this._scheduler=t,this._target=i,this._callback=e,this._elapsed=-1,this._interval=n,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===u.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();BO._timers=[],BO.get=function(){return BO._timers.pop()||new BO},BO.put=function(t){BO._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,BO._timers.push(t))};var NO,LO=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=Pt(!0),e._hashForTimers=Pt(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}$(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?D(1513):t.id=RO.getNewId())};var i=e.prototype;return i.setTimeScale=function(t){this._timeScale=t},i.getTimeScale=function(){return this._timeScale},i.update=function(t){var e,i,n,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,n=(i=this._updatesNegList).length;e<n;e++)(r=i[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,n=(i=this._updates0List).length;e<n;e++)(r=i[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,n=(i=this._updatesPosList).length;e<n;e++)(r=i[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(o=a[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,i=this._updatesNegList;e<i.length;)(r=i[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,i=this._updates0List;e<i.length;)(r=i[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,i=this._updatesPosList;e<i.length;)(r=i[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},i.schedule=function(t,e,i,n,r,o){if("function"!=typeof t){var a=t;t=e,e=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!n,n=u.macro.REPEAT_FOREVER,r=0),L(e,1502);var s=e.uuid||e.id;if(s){var c,l,h=this._hashForTimers[s];if(h?h.paused!==o&&D(1511):(h=OO.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if((c=h.timers[l])&&t===c._callback)return I(1507,c.getInterval(),i),void(c._interval=i);(c=BO.get()).initWithCallback(this,t,e,i,n,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else O(1510)},i.scheduleUpdate=function(t,e,i){var n=t.uuid||t.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return I(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(t)}var o,a=DO.get(t,e,i,!1);0===e?(o=this._updates0List,this._appendIn(o,a)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,e)),this._hashForUpdates[n]=MO.get(o,a,t,null)}else O(1510)},i.unschedule=function(t,e){if(e&&t){var i=e.uuid||e.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(t===s._callback)return s!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(o,1),BO.put(s),n.timerIndex>=o&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else O(1510)}},i.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var i=this._hashForUpdates[e];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else O(1510)}},i.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var i=this._hashForTimers[e];if(i){var n=i.timers;n.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,o=n.length;r<o;r++)BO.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(t)}else O(1510)}},i.unscheduleAll=function(){this.unscheduleAllWithMinPriority(IO.Priority.SCHEDULER)},i.unscheduleAllWithMinPriority=function(t){var e,i,n,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)i=r[e],this.unscheduleAllForTarget(i.target);var o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,(n=this._updatesNegList[e])&&n.priority>=t&&this.unscheduleUpdate(n.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,(n=this._updates0List[e])&&this.unscheduleUpdate(n.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,(n=this._updatesPosList[e])&&n.priority>=t&&this.unscheduleUpdate(n.target),o===this._updatesPosList.length&&e++},i.isScheduled=function(t,e){L(t,1508),L(e,1509);var i=e.uuid||e.id;if(!i)return O(1510),!1;var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,o=0;o<r.length;++o)if(t===r[o]._callback)return!0;return!1},i.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(IO.Priority.SCHEDULER)},i.pauseAllTargetsWithMinPriority=function(t){var e,i,n,r,o=[],a=this._arrayForTimers;for(i=0,n=a.length;i<n;i++)(e=a[i])&&(e.paused=!0,o.push(e.target));if(t<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=t&&(r.paused=!0,o.push(r.target));if(t<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,o.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=t&&(r.paused=!0,o.push(r.target));return o},i.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},i.pauseTarget=function(t){L(t,1503);var e=t.uuid||t.id;if(e){var i=this._hashForTimers[e];i&&(i.paused=!0);var n=this._hashForUpdates[e];n&&(n.entry.paused=!0)}else O(1510)},i.resumeTarget=function(t){L(t,1504);var e=t.uuid||t.id;if(e){var i=this._hashForTimers[e];i&&(i.paused=!1);var n=this._hashForUpdates[e];n&&(n.entry.paused=!1)}else O(1510)},i.isTargetPaused=function(t){L(t,1505);var e=t.uuid||t.id;if(!e)return O(1510),!1;var i=this._hashForTimers[e];if(i)return i.paused;var n=this._hashForUpdates[e];return!!n&&n.entry.paused},i._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===t){i.splice(n,1);break}OO.put(t)},i._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,i=this._hashForUpdates[e];if(i){for(var n=i.list,r=i.entry,o=0,a=n.length;o<a;o++)if(n[o]===r){n.splice(o,1);break}delete this._hashForUpdates[e],DO.put(r),MO.put(i)}},i._priorityIn=function(t,e,i){for(var n=0;n<t.length;n++)if(i<t[n].priority)return void t.splice(n,0,e);t.push(e)},i._appendIn=function(t,e){t.push(e)},e}(IO));LO.ID="scheduler",u.Scheduler=LO;var FO=((NO={})[eh.PORTRAIT]=un.IDENTITY,NO[eh.LANDSCAPE_RIGHT]=un.ROTATE_90,NO[eh.PORTRAIT_UPSIDE_DOWN]=un.ROTATE_180,NO[eh.LANDSCAPE_LEFT]=un.ROTATE_270,NO),zO=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var i=0;i<e.renderPassInfo.colorAttachments.length;i++)this._colorTextures.push(t.createTexture(new mr(yn.TEX2D,xn.COLOR_ATTACHMENT|xn.SAMPLED|xn.TRANSFER_SRC,e.renderPassInfo.colorAttachments[i].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==_n.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new mr(yn.TEX2D,xn.DEPTH_STENCIL_ATTACHMENT|xn.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new zr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,FO[ah.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new zr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var n,r=st(this._cameras);!(n=r()).done;)n.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var i=this._cameras[e];i.enabled&&(i.update(),t.push(i))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},e._init=function(){},e._destroy=function(){},e._setSwapchain=function(t){this._swapchain=t},e._setFrameBuffer=function(t){this._framebuffer=t},Q(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),t}(),VO=function(){var t=e.prototype;function e(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=u.internal.DataPoolManager&&new u.internal.DataPoolManager(t),lb.registerCreateFunc(this),zO.registerCreateFunc(this),this._cameraPool=new jl((function(){return new vg(e._device)}),4,(function(t){return t.destroy()}))}return t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(t){this._cumulativeTime+=t},t._setFrameTime=function(t){this._frameTime=t},t.initialize=function(){this._init();var t=u.game._swapchain,e=new Dr;e.format=t.colorTexture.format;var i=new Mr;i.format=t.depthStencilTexture.format,i.depthStoreOp=On.DISCARD,i.stencilStoreOp=On.DISCARD;var n=new Nr([e],i);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:n,swapchain:t}),this._curWindow=this._mainWindow,Promise.resolve(Mv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(t,e){for(var i,n=st(this._windows);!(i=n()).done;){var r=i.value;r.swapchain&&r.resize(t,e)}},t.setRenderPipeline=function(t){t instanceof TO&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=wO(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature(hn.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;var i=u.director.getScene();return i&&i.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&u.internal.Batcher2D&&(this._batcher=new u.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(t){this._curWindow=t},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var i=this._windows,n=[],r=0;r<i.length;r++)i[r].extractRenderCameras(n);if(this._pipeline&&n.length>0){this._device.acquire([u.game._swapchain]);var o=this._scenes,a=u.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);u.director.emit(u.Director.EVENT_BEFORE_COMMIT),n.sort((function(t,e){return t.priority-e.priority})),this._pipeline.render(n),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},t.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},t.destroyWindows=function(){for(var t,e=st(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},t.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},t.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},t.destroyScenes=function(){for(var t,e=st(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},t.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new jl((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var i=e.alloc();return i.initialize(),i},t.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):D(1300,t.constructor.name),t.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new jl((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var i=e.alloc();return i.initialize(),i},t.destroyLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case ry.SPHERE:t.scene.removeSphereLight(t);break;case ry.SPOT:t.scene.removeSpotLight(t)}t.destroy()},Q(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();u.Root=VO;var kO=t("Game",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}$(e,t);var i=e.prototype;return i.setFrameRate=function(t){this.frameRate=t},i.getFrameRate=function(){return this.frameRate},i.step=function(){u.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(uD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var t=this;return new Promise((function(t){return u.director.once(u.Director.EVENT_END_FRAME,(function(){return t()}))})).then((function(){for(var i in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[i]);return u.director.getScene().destroy(),u.Object._deferredDestroy(),u.director.reset(),u.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then((function(){t.resume(),t._safeEmit(e.EVENT_RESTART)}))}))},i.end=function(){du.close()},i.on=function(t,i,n,r){return(this._engineInited&&t===e.EVENT_ENGINE_INITED||this._inited&&t===e.EVENT_GAME_INITED||this._rendererInitialized&&t===e.EVENT_RENDERER_INITED)&&i.call(n),this.eventTargetOn(t,i,n,r)},i.once=function(t,i,n){return this._engineInited&&t===e.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(t,i,n)},i.init=function(t){var e=this;if(this._initConfig(t),ch._init({configOrientation:t.orientation||"auto",exactFitScreen:t.exactFitScreen}),this.config.assetOptions&&u.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,n=0;n<i.length;n++){var o=i[n],a=r(o.value);Np.addLayer(o.name,a)}return this._initEngine().then((function(){return e._initEvents(),u.director.root&&u.director.root.dataPoolManager&&u.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),e._engineInited}))},i.run=function(t,e){var i,n=this;return"function"!=typeof t&&t?(i=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,lu.init(),Promise.resolve(i).then((function(){return n._setRenderPipelineNShowSplash()})).then((function(){}))},i.addPersistRootNode=function(t){if(u.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var i=u.director._scene;if(u.isValid(i))if(t.parent){if(!(t.parent instanceof u.Scene))return void D(3801);if(t.parent!==i)return void D(3802);t._originalSceneId=i.uuid}else t.parent=i;this._persistRootNodes[e]=t,t._persistNode=!0,u.assetManager._releaseManager._addPersistNodeRef(t)}}else D(3800)},i.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",u.assetManager._releaseManager._removePersistNodeRef(t))},i.isPersistRootNode=function(t){return!!t._persistNode},i.onEngineInitedAsync=function(t){this._onEngineInitedCallback.push(t)},i._initEngine=function(){var t=this;this._initDevice();var i=u.director;return Promise.resolve(i._init()).then((function(){u.view.init(),x("Cocos Creator v"+h),t.emit(e.EVENT_ENGINE_INITED),t._engineInited=!0,u.internal.dynamicAtlasManager&&(u.internal.dynamicAtlasManager.enabled=!ue.CLEANUP_IMAGE_CACHE)})).then((function(){var e=t._onEngineInitedCallback.map((function(t){return t()})).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)}))},i._setAnimFrame=function(){var t=this._frameRate,e=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==t&&30!==t?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=e||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(t){var e=performance.now(),i=Math.max(0,e-this._startTime),n=Math.max(0,this.frameTime-i);return window.setTimeout(t,n)},i._ctTime=function(t){window.clearTimeout(t)},i._calculateDT=function(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>e.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},i._updateCallback=function(){var t,e=this,i=u.director;if(30===this._frameRate){var n=!0;t=function(t){e._intervalId=window.rAF(e._frameCB),(n=!n)||i.tick(e._calculateDT(t))}}else t=function(t){i.tick(e._calculateDT(t)),e._intervalId=window.rAF(e._frameCB)};this._frameCB=t},i._runMainLoop=function(){if(this._inited){var t=this.config,e=u.director;V(!!t.showFPS),e.startAnimation(),this.resume()}},i._initConfig=function(t){"number"!=typeof t.debugMode&&(t.debugMode=B.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);var e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,T(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate},i._determineRenderType=function(){var t=this.config,i=parseInt(t.renderMode,10);this.renderType=e.RENDER_TYPE_CANVAS;var n=!1;if(1===i?(this.renderType=e.RENDER_TYPE_CANVAS,n=!0):0===i||2===i?(this.renderType=e.RENDER_TYPE_WEBGL,n=!0):3===i&&(this.renderType=e.RENDER_TYPE_HEADLESS,n=!0),!n)throw new Error(F(3820,i))},i._initDevice=function(){if(!this._rendererInitialized){var t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===e.RENDER_TYPE_WEBGL){var i=new ur(Jp),n=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||lh.browserType===nu.UC)&&(n=!1);var o=[];n&&u.WebGL2Device&&o.push(u.WebGL2Device),u.WebGLDevice&&o.push(u.WebGLDevice),u.EmptyDevice&&o.push(u.EmptyDevice),_o.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(i));a++);}else this.renderType===e.RENDER_TYPE_HEADLESS&&u.EmptyDevice&&(this._gfxDevice=new u.EmptyDevice,this._gfxDevice.initialize(new ur(Jp)));if(!this._gfxDevice)return b("can not support canvas rendering in 3D"),void(this.renderType=e.RENDER_TYPE_CANVAS);var s=new lr(this.canvas),c=ch.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){du.on("show",this._onShow,this),du.on("hide",this._onHide,this)},i._onHide=function(){this.emit(e.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(e.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var t=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(t._showSplashScreen()).then((function(){t._inited=!0,t._initTime=performance.now(),t._runMainLoop(),t._safeEmit(e.EVENT_GAME_INITED),t.onStart&&t.onStart()}))}))},i._setupRenderPipeline=function(){var t=this,e=this.config.renderPipeline;return e?new Promise((function(t,i){u.assetManager.loadAny(e,(function(e,n){return!e&&n instanceof lx?t(n):i(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(i){S(i),S("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(u.internal.SplashScreen){var t=u.internal.SplashScreen.instance;return t.main(u.director.root),new Promise((function(e){t.setOnFinish((function(){return e()})),t.loadFinish=!0}))}return null},i._setRenderPipeline=function(t){u.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(e.EVENT_RENDERER_INITED)},i._safeEmit=function(t){this.emit(t)},Q(e,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),e}(eu));kO.EVENT_HIDE="game_on_hide",kO.EVENT_SHOW="game_on_show",kO.EVENT_LOW_MEMORY="game_on_low_memory",kO.EVENT_GAME_INITED="game_inited",kO.EVENT_ENGINE_INITED="engine_inited",kO.EVENT_RENDERER_INITED="renderer_inited",kO.EVENT_RESTART="game_on_restart",kO.RENDER_TYPE_CANVAS=0,kO.RENDER_TYPE_WEBGL=1,kO.RENDER_TYPE_OPENGL=2,kO.RENDER_TYPE_HEADLESS=3,kO.DEBUG_DT_THRESHOLD=1,u.Game=kO;var UO=t("game",u.game=new kO),GO=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new LO,e._compScheduler=new FD,e._nodeActivator=new eM,e._systems=[],UO.once(kO.EVENT_RENDERER_INITED,e._initOnRendererInitialized,ot(e)),e}$(e,t);var i=e.prototype;return i.calculateDeltaTime=function(){},i.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},i.pause=function(){this._paused||(this._paused=!0)},i.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),u.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),u.assetManager.releaseAll()},i.reset=function(){this.purgeDirector(),this.emit(e.EVENT_RESET),this.startAnimation()},i.runSceneImmediate=function(t,e,i){t instanceof iM&&(t=t.scene),L(t instanceof SD,1216),t._load();for(var n=Object.keys(UO._persistRootNodes).map((function(t){return UO._persistRootNodes[t]})),r=0;r<n.length;r++){var o=n[r];o.emit(u.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var a=t.uuid===o._originalSceneId&&t.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),t.insertChild(o,s)}else o.parent=t}var c=this._scene;u.isValid(c)&&c.destroy(),u.assetManager._releaseManager._autoRelease(c,t,UO._persistRootNodes),this._scene=null,pl._deferredDestroy(),e&&e(),this.emit(u.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,t),this.emit(u.Director.EVENT_AFTER_SCENE_LAUNCH,t)},i.runScene=function(t,e,i){var n=this;t instanceof iM&&(t=t.scene),L(t,1205),L(t instanceof SD,1216),t._load(),this.once(u.Director.EVENT_END_FRAME,(function(){n.runSceneImmediate(t,e,i)}))},i.loadScene=function(t,e,i){var n=this;if(this._loadingScene)return D(1208,t,this._loadingScene),!1;var r=u.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return r?(this.emit(u.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),r.loadScene(t,(function(r,o){console.timeEnd("LoadScene "+t),n._loadingScene="",r?(b(r),e&&e(r)):n.runSceneImmediate(o,i,e)})),!0):(O(1209,t),!1)},i.preloadScene=function(t,e,i){var n=u.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(n)n.preloadScene(t,null,e,i);else{var r='Can not preload the scene "'+t+'" because it is not in the build settings.';i&&i(new Error(r)),b("preloadScene: "+r)}},i.resume=function(){this._paused&&(this._paused=!1)},i.getScene=function(){return this._scene},i.getDeltaTime=function(){return UO.deltaTime},i.getTotalTime=function(){return UO.totalTime},i.getCurrentTime=function(){return UO.frameStartTime},i.getTotalFrames=function(){return this._totalFrames},i.isPaused=function(){return this._paused},i.getScheduler=function(){return this._scheduler},i.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(LO.ID,t,200))},i.registerSystem=function(t,e,i){e.id=t,e.priority=i,e.init(),this._systems.push(e),this._systems.sort(IO.sortByPriority)},i.unregisterSystem=function(t){ie.fastRemove(this._systems,t),this._systems.sort(IO.sortByPriority)},i.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},i.getAnimationManager=function(){return this.getSystem(u.AnimationManager.ID)},i.startAnimation=function(){this._invalid=!1},i.stopAnimation=function(){this._invalid=!0},i.mainLoop=function(t){var e;e=UO._calculateDT(t),this.tick(e)},i.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),uD._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),pl._deferredDestroy();for(var n=0;n<this._systems.length;++n)this._systems[n].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),jT.resetHasChangedFlags(),jT.clearNodeArray(),Gl.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},i._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(LO.ID,this._scheduler,200),this.emit(e.EVENT_INIT)},i._init=function(){return this._root=new VO(UO._gfxDevice),this._root.initialize({}).catch((function(t){return O(1217),Promise.reject(t)}))},Q(e,[{key:"root",get:function(){return this._root}}]),e}(eu));GO.EVENT_INIT="director_init",GO.EVENT_RESET="director_reset",GO.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",GO.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",GO.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",GO.EVENT_BEFORE_UPDATE="director_before_update",GO.EVENT_AFTER_UPDATE="director_after_update",GO.EVENT_BEFORE_DRAW="director_before_draw",GO.EVENT_AFTER_DRAW="director_after_draw",GO.EVENT_BEFORE_COMMIT="director_before_commit",GO.EVENT_BEFORE_PHYSICS="director_before_physics",GO.EVENT_AFTER_PHYSICS="director_after_physics",GO.EVENT_BEGIN_FRAME="director_begin_frame",GO.EVENT_END_FRAME="director_end_frame",GO.instance=void 0,u.Director=GO;var HO=t("director",GO.instance=u.director=new GO),jO={};k(jO,"vmath",[{name:"vec2",newName:"Vec2",target:an,targetName:"math"},{name:"vec3",newName:"Vec3",target:an,targetName:"math"},{name:"vec4",newName:"Vec4",target:an,targetName:"math"},{name:"quat",newName:"Quat",target:an,targetName:"math"},{name:"mat3",newName:"Mat3",target:an,targetName:"math"},{name:"mat4",newName:"Mat4",target:an,targetName:"math"},{name:"color4",newName:"Color",target:an,targetName:"math"},{name:"rect",newName:"Rect",target:an,targetName:"math"},{name:"approx",newName:"approx",target:an,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:an,targetName:"math"},{name:"equals",newName:"equals",target:an,targetName:"math"},{name:"clamp",newName:"clamp",target:an,targetName:"math"},{name:"clamp01",newName:"clamp01",target:an,targetName:"math"},{name:"lerp",newName:"lerp",target:an,targetName:"math"},{name:"toRadian",newName:"toRadian",target:an,targetName:"math"},{name:"toDegree",newName:"toDegree",target:an,targetName:"math"},{name:"random",newName:"random",target:an,targetName:"math"},{name:"randomRange",newName:"randomRange",target:an,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:an,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:an,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:an,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:an,targetName:"math"},{name:"repeat",newName:"repeat",target:an,targetName:"math"},{name:"pingPong",newName:"pingPong",target:an,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:an,targetName:"math"}]),u.vmath=jO,k(LO.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:LO,targetName:"Scheduler"}]),k(LO,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return IO.Priority.SCHEDULER}}]),U(LO,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),k(nb.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),U(nb.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),k(VO.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),G(UO,"game",[{name:"collisionMatrix"},{name:"groupList"}]),G(GO.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),U(GO.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var WO,qO={topLeft:u.v2(0,0),topRight:u.v2(0,0),top:u.v2(0,0),bottomLeft:u.v2(0,0),bottomRight:u.v2(0,0),bottom:u.v2(0,0),center:u.v2(0,0),left:u.v2(0,0),right:u.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,i=this.height=t.height,n=t.x,r=t.y,o=r+i,a=n+e;this.topLeft.x=n,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=n+e/2,this.top.y=o,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+e/2,this.bottom.y=r,this.center.x=n+e/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}};u.visibleRect=qO;var XO=new $i,YO=((WO={})[ue.ORIENTATION_AUTO]=eh.AUTO,WO[ue.ORIENTATION_LANDSCAPE]=eh.LANDSCAPE,WO[ue.ORIENTATION_PORTRAIT]=eh.PORTRAIT,WO),KO=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var i=JO,n=QO;return e._designResolutionSize=new $i(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new en(0,0,0,0),e._visibleRect=new en(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new ZO(i.EQUAL_TO_FRAME,n.EXACT_FIT),e._rpShowAll=new ZO(i.EQUAL_TO_FRAME,n.SHOW_ALL),e._rpNoBorder=new ZO(i.EQUAL_TO_FRAME,n.NO_BORDER),e._rpFixedHeight=new ZO(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),e._rpFixedWidth=new ZO(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}$(e,t);var i=e.prototype;return i.init=function(){var t=ch.windowSize,e=t.width,i=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=i,this._viewportRect.width=e,this._viewportRect.height=i,this._visibleRect.width=e,this._visibleRect.height=i,XO.width=this._visibleRect.width,XO.height=this._visibleRect.height,qO&&qO.init(this._visibleRect),ah.on("window-resize",this._updateAdaptResult,this),ah.on("orientation-change",this._updateAdaptResult,this),ah.on("fullscreen-change",this._updateAdaptResult,this)},i.resizeWithBrowserSize=function(t){ah.handleResizeEvent=t},i.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},i.setOrientation=function(t){ah.orientation=YO[t]},i.adjustViewportMeta=function(){},i.enableRetina=function(t){this._retinaEnabled=!!t},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&ch.requestFullScreen().catch((function(){})))},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(t,e){ah.resolutionScale=1;var i=ah.devicePixelRatio,n=new $i(t*i,e*i);ch.windowSize=n},i.getCanvasSize=function(){return ch.windowSize},i.getFrameSize=function(){var t=ah.devicePixelRatio,e=ch.windowSize;return e.width/=t,e.height/=t,e},i.setFrameSize=function(t,e){var i=ah.devicePixelRatio;ch.windowSize=new $i(t*i,e*i)},i.getVisibleSize=function(){return new $i(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new $i(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new qi(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new qi(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i._updateResolutionPolicy=function(t){if(t instanceof ZO)this._resolutionPolicy=t;else{var e=ZO;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},i.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=$O.getDesignResolutionSize();$O.setDesignResolutionSize(e.width,e.height,t)},i.setDesignResolutionSize=function(t,e,i){if(t>0&&e>0){this._updateResolutionPolicy(i);var n=this._resolutionPolicy;n&&n.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}n.postApply(this),XO.width=this._visibleRect.width,XO.height=this._visibleRect.height,qO&&qO.init(this._visibleRect),this.emit("design-resolution-changed")}else O(2200)},i.getDesignResolutionSize=function(){return new $i(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(t,e,i){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return ah.devicePixelRatio},i.convertToLocationInView=function(t,e,i,n){void 0===n&&(n=new qi);var r=ah.devicePixelRatio*(t-i.left),o=ah.devicePixelRatio*(i.top+i.height-e);return ah.isFrameRotated?(n.x=ch.windowSize.width-o,n.y=r):(n.x=r,n.y=o),n},i._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},i._updateAdaptResult=function(){var t;u.director.root.resize(ch.windowSize.width,ch.windowSize.height);var e=this._designResolutionSize.width,i=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,i,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}(eu));KO.instance=void 0;var JO=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=UO.canvas;if(t){var e=ch.windowSize;t.width=e.width,t.height=e.height}},t}();JO.EQUAL_TO_FRAME=void 0,JO.PROPORTION_TO_FRAME=void 0;var QO=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,i,n,r,o){Math.abs(t-i)<2&&(i=t),Math.abs(e-n)<2&&(n=e);var a=new en(Math.round((t-i)/2),Math.round((e-n)/2),i,n);return this._result.scale=[r,o],this._result.viewport=a,this._result},t}();QO.EXACT_FIT=void 0,QO.SHOW_ALL=void 0,QO.NO_BORDER=void 0,QO.FIXED_HEIGHT=void 0,QO.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="EqualToFrame",e}return $(e,t),e.prototype.apply=function(){ah.isProportionalToFrame=!1,this._setupCanvas()},e}(JO),e=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="ProportionalToFrame",e}return $(e,t),e.prototype.apply=function(){ah.isProportionalToFrame=!0,this._setupCanvas()},e}(JO);JO.EQUAL_TO_FRAME=new t,JO.PROPORTION_TO_FRAME=new e;var i=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="ExactFit",e}return $(e,t),e.prototype.apply=function(t,e){var i=ch.windowSize,n=i.width,r=i.height,o=n/e.width,a=r/e.height;return this._buildResult(n,r,n,r,o,a)},e}(QO),n=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="ShowAll",e}return $(e,t),e.prototype.apply=function(t,e){var i,n,r=ch.windowSize,o=r.width,a=r.height,s=e.width,c=e.height,l=o/s,u=a/c,h=0;return l<u?(i=o,n=c*(h=l)):(i=s*(h=u),n=a),this._buildResult(o,a,i,n,h,h)},e}(QO),r=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="NoBorder",e}return $(e,t),e.prototype.apply=function(t,e){var i,n,r,o=ch.windowSize,a=o.width,s=o.height,c=e.width,l=e.height,u=a/c,h=s/l;return u<h?(n=c*(i=h),r=s):(n=a,r=l*(i=u)),this._buildResult(a,s,n,r,i,i)},e}(QO),o=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="FixedHeight",e}return $(e,t),e.prototype.apply=function(t,e){var i=ch.windowSize,n=i.width,r=i.height,o=r/e.height,a=n,s=r;return this._buildResult(n,r,a,s,o,o)},e}(QO),a=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="FixedWidth",e}return $(e,t),e.prototype.apply=function(t,e){var i=ch.windowSize,n=i.width,r=i.height,o=n/e.width,a=n,s=r;return this._buildResult(n,r,a,s,o,o)},e}(QO);QO.EXACT_FIT=new i,QO.SHOW_ALL=new n,QO.NO_BORDER=new r,QO.FIXED_HEIGHT=new o,QO.FIXED_WIDTH=new a}();var ZO=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof JO&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof QO&&(this._contentStrategy=t)},Q(t,[{key:"canvasSize",get:function(){return ch.windowSize}}]),t}());ZO.EXACT_FIT=0,ZO.NO_BORDER=1,ZO.SHOW_ALL=2,ZO.FIXED_HEIGHT=3,ZO.FIXED_WIDTH=4,ZO.UNKNOWN=5,ZO.ContainerStrategy=JO,ZO.ContentStrategy=QO,u.ResolutionPolicy=ZO;var $O=t("view",KO.instance=u.view=new KO);u.winSize=XO,U(KO.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),G(KO.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),G(u,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),G(lh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),k(lh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(t){return{name:"LANGUAGE_"+t,newName:t,target:lh.Language,targetName:"sys.Language"}}))),k(lh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(t){return{name:"OS_"+t,newName:t,target:lh.OS,targetName:"sys.OS"}}))),k(lh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(t){return{name:"BROWSER_TYPE_"+t,newName:t,target:lh.BrowserType,targetName:"sys.BrowserType"}}))),k(lh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:lh.BrowserType,targetName:"sys.BrowserType"}]),k(lh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(t){return{name:t,target:lh.Platform,targetName:"sys.Platform"}}))),k(lh,"sys",[{name:"IPHONE",newName:"IOS",target:lh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:lh.Platform,targetName:"sys.Platform"}]),U(lh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(t){return{name:t}}))),k(lh,"sys",[{name:"windowPixelResolution",target:ch,targetName:"screen",newName:"windowSize"}]),G(ch,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var tB=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new vl,this.scenes=new vl,this.paths=new vl}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,i=t.paths,n=t.types,r=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,s=e.length;a<s;a++)e[a]=Bl(e[a]);for(var c in i){var l=i[c],u=l[1];l[1]=n[u]}}else{for(var h=Object.create(null),_=0,f=e.length;_<f;_++){var p=e[_];e[_]=h[p]=Bl(p)}e=h}for(var d in i){var m=i[d];o[e[d]]=m}var v=t.scenes;for(var g in v){var y=v[g];v[g]=e[y]}var x=t.packs;for(var S in x)for(var b=x[S],C=0;C<b.length;++C)b[C]=e[b[C]];var A=t.versions;if(A)for(var T in A)for(var w=A[T],E=0;E<w.length;E+=2){var P=w[E];w[E]=e[P]||P}var I=t.redirect;if(I)for(var R=0;R<I.length;R+=2)I[R]=e[I[R]],I[R+1]=r[I[R+1]];if(t.extensionMap){var D=function(i){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,i))return"continue";t.extensionMap[i].forEach((function(n,r){t.extensionMap[i][r]=e[n]||n}))};for(var M in t.extensionMap)D(M)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var i=function(i){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,i))return"continue";t.extensionMap[i].forEach((function(t){var n=e.assetInfos.get(t);n&&(n.extension=i)}))};for(var n in t.extensionMap)i(n)},e.getInfoWithPath=function(t,e){if(!t)return null;t=Vl(t);var i=this.paths.get(t);if(i){if(!e)return i[0];for(var n=0,r=i.length;n<r;n++){var o=i[n];if(ne.isChildClassOf(o.ctor,e))return o}}return null},e.getDirWithPath=function(t,e,i){"/"===(t=Vl(t))[t.length-1]&&(t=t.slice(0,-1));var n=i||[];return this.paths.forEach((function(i,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var o=0,a=i.length;o<a;o++){var s=i[o];e&&!ne.isChildClassOf(s.ctor,e)||n.push(s)}})),n},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,i){return i.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,i=t.length;e<i;e++){var n=t[e];this.assetInfos.add(n,{uuid:n})}}},e._initPath=function(t){if(t){var e=this.paths;for(var i in e.clear(),t){var n=t[i],r=n[0],o=n[1],a=3===n.length,s=this.assetInfos.get(i);s.path=r,s.ctor=ne._getClassById(o),e.has(r)?a?e.get(r).push(s):e.get(r).unshift(s):e.add(r,[s])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var i=this.assetInfos;for(var n in t){var r=t[n],o=i.get(r);o.url=n,e.add(n,o)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var i in t){var n=t[i],r={uuid:i,packedUuids:n,ext:".json"};e.add(i,r);for(var o=0,a=n.length;o<a;o++){var s=n[o],c=e.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,i=t.import;if(i)for(var n=0,r=i.length;n<r;n+=2){var o=i[n];e.get(o).ver=i[n+1]}if(i=t.native)for(var a=0,s=i.length;a<s;a+=2){var c=i[a];e.get(c).nativeVer=i[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,i=0,n=t.length;i<n;i+=2){var r=t[i];e.get(r).redirect=t[i+1]}},t}();function eB(t,e){t._uuid&&e.push(t._uuid)}function iB(t,e){for(var i=Object.getOwnPropertyNames(t),n=0;n<i.length;n++){var r=i[n];if("node"!==r&&"__eventTargets"!==r){var o=t[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Mu&&eB(s,e)}else if(o.constructor&&o.constructor!==Object)o instanceof Mu&&eB(o,e);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Mu&&eB(u,e)}}}}function nB(t,e){for(var i=0;i<t._components.length;i++)iB(t._components[i],e);for(var n=0;n<t._children.length;n++)nB(t._children[n],e)}function rB(t,e,i,n){i.push(t._uuid);for(var r=av.getDeps(t._uuid),o=0,a=r.length;o<a;o++){var s=xl.get(r[o]);if(s){var c=s._uuid;c in e?e[c]+=n:e[c]=s.refCount+n,i.includes(c)||rB(s,e,i,n)}}}var oB=[],aB=new(function(){function t(){this._persistNodeDeps=new vl,this._toDelete=new vl,this._eventListener=!1}var e=t.prototype;return e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];nB(t,e);for(var i=0,n=e.length;i<n;i++){var r=xl.get(e[i]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),i=0,n=e.length;i<n;i++){var r=xl.get(e[i]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,i){if(t){for(var n=av.getDeps(t.uuid),r=0,o=n.length;r<o;r++){var a=xl.get(n[r]);a&&a.decRef(t.autoReleaseAssets)}var s=av._depends.get(t.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=xl.get(c[l]);h&&h.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&av.remove(t.uuid)}var _=av._depends.get(e.uuid);for(var f in _&&(_.persistDeps=[]),i){for(var p,d,m=i[f],v=this._persistNodeDeps.get(m.uuid),g=st(v);!(d=g()).done;){var y=d.value,x=xl.get(y);x&&x.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Mu&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,xe(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var i=t._uuid;if(this._toDelete.remove(i),ml(t,!0)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,rB(t,e,oB,-1),oB.length=0,0!==e[t._uuid])return e[t._uuid];for(var i in e)0!==e[i]&&rB(xl.get(i),e,oB,1);return oB.length=0,e[t._uuid]}(t)>0)){xl.remove(i);for(var n=av.getDeps(i),r=0,o=n.length;r<o;r++){var a=xl.get(n[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),av.remove(i)}},t}()),sB=null;function cB(t,e){for(var i=0,n=t.input.length;i<n;i++){var r=t.input[i];e&&!r.isNative&&r.content instanceof Mu&&r.content.decRef(!1),r.recycle()}t.input=null}function lB(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function uB(t,e,i,n,r){void 0===r&&(r=0),t(r,(function(o,a){r++,!o||r>e?n&&n(o,a):setTimeout((function(){uB(t,e,i,n,r)}),i)}))}function hB(t,e,i,n,r){try{for(var o=av.parse(t,e),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in i||(i[c]=!0,n.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),n.push(Z({},o.nativeDep)))}catch(t){b(t.message,t.stack)}}function _B(t,e,i){e&&(i=void 0!==i?i:u.assetManager.cacheAsset,zl(e)||!i||e.isDefault||xl.add(t,e))}function fB(t,e,i){var n=0,r=[],o=t.length;0===o&&i&&i(r);for(var a=function(t){t&&r.push(t),++n===o&&i&&i(r)},s=0;s<o;s++)e(t[s],a)}function pB(t,e,i){var n=t,r=e,o=i;if(void 0===i){var a="function"==typeof t;e?(o=e,a||(r=null)):void 0===e&&a&&(o=t,n=null,r=null),void 0!==e&&a&&(r=t,n=null)}return{options:n||Object.create(null),onProgress:r,onComplete:o}}function dB(t,e,i){var n=t,r=e,o=i;if(void 0===i){var a=ne.isChildClassOf(t,Mu);e?(o=e,a&&(r=null)):void 0!==e||a||(o=t,r=null,n=null),void 0===e||a||(r=t,n=null)}return{type:n,onProgress:r||sB,onComplete:o}}function mB(t,e,i,n){if(void 0===n&&(n={}),!i[e]||n[e])return!1;n[e]=!0;var r=!1,o=av.getDeps(e);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===t||mB(t,c,i,n)){r=!0;break}}return r}function vB(t){return function(e,i){if(t){var n=[];Array.isArray(i)?i.forEach((function(t){return t instanceof Mu&&n.push(t.addRef())})):i instanceof Mu&&n.push(i.addRef()),xe((function(){n.forEach((function(t){return t.decRef(!1)})),t(e,i)}))}}}var gB=function(){function t(){this._config=new tB}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,i){return this._config.getDirWithPath(t,e,i)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),Cl.add(t.name,this)},e.load=function(t,e,i,n){var r=dB(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:yl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(t)};u.assetManager.loadAny(t,c,a,s)},e.preload=function(t,e,i,n){var r=dB(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.preloadAny(t,{__requestType__:yl.PATH,type:o,bundle:this.name},a,s)},e.loadDir=function(t,e,i,n){var r=dB(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.loadAny(t,{__requestType__:yl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},e.preloadDir=function(t,e,i,n){var r=dB(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.preloadAny(t,{__requestType__:yl.DIR,type:o,bundle:this.name},a,s)},e.loadScene=function(t,e,i,n){var r=pB(e,i,n),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,u.assetManager.loadAny({scene:t},o,a,(function(t,e){if(t)b(t.message,t.stack);else if(e instanceof iM&&e.scene){var i=e.scene;i._id=e._uuid,i.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");s&&s(t,e)}))},e.preloadScene=function(t,e,i,n){var r=pB(e,i,n),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,u.assetManager.preloadAny({scene:t},o,a,(function(e){e&&O(1210,t,e.message),s&&s(e)}))},e.get=function(t,e){var i=this.getInfoWithPath(t,e);return i&&xl.get(i.uuid)||null},e.release=function(t,e){var i=this.get(t,e);i&&aB.tryRelease(i,!0)},e.releaseUnusedAssets=function(){var t=this;xl.forEach((function(e){var i=t.getAssetInfo(e._uuid);i&&!i.redirect&&aB.tryRelease(e)}))},e.releaseAll=function(){var t=this;xl.forEach((function(e){var i=t.getAssetInfo(e._uuid);i&&!i.redirect&&aB.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},Q(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),yB=t("resources",new gB);function xB(t,e,i){var n=new Image;function r(){n.removeEventListener("load",r),n.removeEventListener("error",o),i&&i(null,n)}function o(){n.removeEventListener("load",r),n.removeEventListener("error",o),i&&i(new Error(F(4930,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",r),n.addEventListener("error",o),n.src=t,n}function SB(t,e,i,n){var r=new XMLHttpRequest,o="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?n&&n(null,r.response):n&&n(new Error(""+o+r.status+"(no response)"))},i&&(r.onprogress=function(t){t.lengthComputable&&i(t.loaded,t.total)}),r.onerror=function(){n&&n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n&&n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n&&n(new Error(""+o+r.status+"(abort)"))},r.send(null),r}u.resources=yB;var bB={};function CB(t,e,i){if(bB[t])return i&&i(null),null;var n=document.createElement("script");function r(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",o,!1),bB[t]=!0,i&&i(null)}function o(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",o,!1),i&&i(new Error(F(4928,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=e.scriptAsyncLoading||!1,n.src=t,n.addEventListener("load",r,!1),n.addEventListener("error",o,!1),document.body.appendChild(n),n}var AB=/^(?:\w+:\/\/|\.+\/).+/,TB=function(t,e,i){(lh.hasFeature(lh.Feature.IMAGE_BITMAP)&&u.assetManager.allowImageBitmap?wB:xB)(t,e,i)},wB=function(t,e,i){e.xhrResponseType="blob",SB(t,e,e.onFileProgress,i)},EB=function(t,e,i){e.xhrResponseType="json",SB(t,e,e.onFileProgress,i)},PB=function(t,e,i){e.xhrResponseType="arraybuffer",SB(t,e,e.onFileProgress,i)},IB=function(t,e,i){EB(t,e,(function(e,n){if(e)i(e);else{var r=fh(n);Promise.all(r.chunks.map((function(i){return new Promise((function(n,r){PB(""+Su(t)+i,{},(function(t,i){e?r(e):n(new Uint8Array(i))}))}))}))).then((function(t){var e=new _h(r.document,t);i(null,e)})).catch((function(t){i(t)}))}}))},RB=function(t,e,i){PB(t,e,(function(t,e){if(t)i(t);else try{var n=ph(new Uint8Array(e));i(null,n)}catch(t){i(t)}}))},DB=function(t,e,i){e.xhrResponseType="text",SB(t,e,e.onFileProgress,i)},MB=function(t,e,i){var n=bu(t),r=t;AB.test(r)||(r=-1!==OB.remoteBundles.indexOf(n)?OB.remoteServerAddress+"remote/"+n:"assets/"+n);var o=e.version||OB.bundleVers[n],a=0,s=null,c=null;EB(r+"/config."+(o?o+".":"")+"json",e,(function(t,e){c=t,(s=e)&&(s.base=r+"/"),2==++a&&i(c,s)})),CB(r+"/index."+(o?o+".":"")+"js",e,(function(t){c=t,2==++a&&i(t,s)}))},OB=new(function(){function t(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=xB,this.downloadDomAudio=null,this.downloadFile=SB,this.downloadScript=CB,this._downloaders={".png":TB,".jpg":TB,".bmp":TB,".jpeg":TB,".gif":TB,".ico":TB,".tiff":TB,".webp":TB,".image":TB,".pvr":PB,".pkm":PB,".astc":PB,".txt":DB,".xml":DB,".vsh":DB,".fsh":DB,".atlas":DB,".tmx":DB,".tsx":DB,".json":EB,".ExportJson":EB,".plist":DB,".ccon":IB,".cconb":RB,".fnt":DB,".binary":PB,".bin":PB,".dbbin":PB,".skel":PB,".js":CB,bundle:MB,default:DB},this._downloading=new vl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,i){void 0===t&&(t=""),void 0===e&&(e={}),void 0===i&&(i=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=i},e.register=function(t,e){"object"==typeof t?Vt(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,i,n,r){var o=this,a=Sl.get(t);if(a)r(null,a);else{var s=this._downloading.get(t);if(s){s.push(r);var c=this._queue.find((function(e){return e.id===t}));if(!c)return;var l=n.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,h=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,_=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[i]||this._downloaders.default;uB((function(i,a){if(0===i&&o._downloading.add(t,[r]),o.limited){o._updateTime();var s=function(t,e){o._totalNum--,o._handleQueueInNextFrame(h,_),a(t,e)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(lB(e,o.appendTimeStamp),n,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:t,priority:n.priority||0,url:e,options:n,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(lB(e,o.appendTimeStamp),n,a)}),u,this.retryInterval,(function(e,i){e||Sl.add(t,i);for(var n=o._downloading.remove(t),r=0,a=n.length;r<a;r++)n[r](e,i)}))}}},e.loadSubpackage=function(t,e){u.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=u.game.deltaTime,i=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var i=this._queue.pop();if(!i)break;this._totalNum++,this._totalNumThisPeriod++,i.handler(lB(i.url,this.appendTimeStamp),i.options,i.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(xe(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},Q(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}());function BB(t,e,i,n){var r=null,o=null;try{(r=new tv)._nativeUrl=t,r._nativeAsset=e}catch(t){o=t}n(o,r)}function NB(t,e,i,n){var r=new cM;r.json=e,n(null,r)}function LB(t,e,i,n){var r=new sM;r.text=e,n(null,r)}function FB(t,e,i,n){var r=new Ow;r._nativeUrl=t,r._nativeAsset=e,n(null,r)}function zB(t,e,i,n){var r=new Mu;r._nativeUrl=t,r._nativeAsset=e,n(null,r)}function VB(t,i,n,r){var o=Cl.get(i.name);o||(o=i.name===El.RESOURCES?yB:new gB,i.base=i.base||t+"/",o.init(i)),e.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var kB=new(function(){function t(){this._creating=new vl,this._producers={".png":BB,".jpg":BB,".bmp":BB,".jpeg":BB,".gif":BB,".ico":BB,".tiff":BB,".webp":BB,".image":BB,".pvr":BB,".pkm":BB,".txt":LB,".xml":LB,".vsh":LB,".fsh":LB,".atlas":LB,".tmx":LB,".tsx":LB,".fnt":LB,".json":NB,".ExportJson":NB,".binary":FB,".bin":FB,".dbbin":FB,".skel":FB,bundle:VB,default:zB}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?ne.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,i,n,r){var o=this,a=this._producers[i]||this._producers.default,s=xl.get(t);if(n.reloadAsset||!s){var c=this._creating.get(t);c?c.push(r):(this._creating.add(t,[r]),a(t,e,n,(function(e,i){!e&&i instanceof Mu&&(i._uuid=t,_B(t,i,n.cacheAsset));for(var r=o._creating.remove(t),a=0,s=r.length;a<s;a++)r[a](e,i)})))}else r(null,s)},t}()),UB=new(function(){function t(){this._loading=new vl,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,i,n){var r=ne.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(F(5304,t[0]));Bh(t,!0,void 0,Lh.reportMissingClass),Nh(t);for(var e=new Fh(t[0]),i=t[1],n=t[2],r=t[3],o=t[4],a=t[5],s=0;s<a.length;++s)a[s].unshift(e,i,n,r,o);return a}(e)).length!==t.length&&O(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var s=ne._getClassId(Cv),c=ne._getClassId(tv);if(e.type===s&&e.data){var l=e.data;l.length!==t.length&&O(4915);for(var u=0;u<t.length;u++)r[t[u]+"@import"]=zh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(e.type===c&&e.data){var h=e.data;h.length!==t.length&&O(4915);for(var _=0;_<t.length;_++)r[t[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}n(o,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?ne.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,i,n,r){e?(0,this._unpackers[i])(t,e,n,r):r(new Error("package data is wrong!"))},e.load=function(t,e,i){var n=this;if(!t.isNative&&t.info&&t.info.packs)if(Sl.has(t.id))i(null,Sl.get(t.id));else{var r=t.info.packs,o=r.find((function(t){return n._loading.has(t.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:i,id:t.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:i,id:t.id}]);var a=kl(o.uuid,{ext:o.ext,bundle:t.config.name});OB.download(o.uuid,a,o.ext,t.options,(function(e,i){Sl.remove(o.uuid),e&&b(e.message,e.stack),n.unpack(o.packedUuids,i,o.ext,t.options,(function(t,i){if(!t)for(var r in i)Sl.add(r,i[r]);for(var a=n._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(e||t)l.onComplete(e||t);else{var u=i[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else OB.download(t.id,t.url,t.ext,t.options,i)},t}());function GB(t,e){var i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);var n=t.options,r=t.progress,o=[],a=r.total,s=n.__exclude__=n.__exclude__||Object.create(null);t.output=[],fB(t.input,(function(n,c){if(!n.isNative&&xl.has(n.uuid)){var l=xl.get(n.uuid);return n.content=l.addRef(),t.output.push(n),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n),void c()}UB.load(n,t.options,(function(l,h){l?t.isFinish||(!u.assetManager.force||i?(b(l.message,l.stack),r.canInvoke=!1,e(l)):(t.output.push(n),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n))):t.isFinish||(n.file=h,t.output.push(n),n.isNative||(s[n.uuid]=!0,hB(n.uuid,h,s,o,n.config),r.total=a+o.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n)),c()}))}),(function(){if(t.isFinish)return cB(t,!0),void t.dispatch("error");if(o.length>0){var a=Il.create({input:o,progress:r,options:n,onProgress:t.onProgress,onError:Il.prototype.recycle,onComplete:function(n){var r;n||((r=t.output).push.apply(r,a.output),a.recycle()),i&&HB(t),e(n)}});Tl.async(a)}else i&&HB(t),e()}))}function HB(t){for(var e=t.output,i=0,n=e.length;i<n;i++)e[i].content&&e[i].content.decRef(!1)}var jB=new(function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return D(5100),{};for(var i=null,n=0,r=e.childNodes.length;n<r&&1!==(i=e.childNodes[n]).nodeType;n++);return this._parseNode(i)},i._parseNode=function(t){var e=null,i=t.tagName;if("dict"===i)e=this._parseDict(t);else if("array"===i)e=this._parseArray(t);else if("string"===i)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var n=0;n<t.childNodes.length;n++)e+=t.childNodes[n].nodeValue}else"false"===i?e=!1:"true"===i?e=!0:"real"===i?e=parseFloat(t.firstChild.nodeValue):"integer"===i&&(e=parseInt(t.firstChild.nodeValue,10));return e},i._parseArray=function(t){for(var e=[],i=0,n=t.childNodes.length;i<n;i++){var r=t.childNodes[i];1===r.nodeType&&e.push(this._parseNode(r))}return e},i._parseDict=function(t){for(var e={},i="",n=0,r=t.childNodes.length;n<r;n++){var o=t.childNodes[n];1===o.nodeType&&("key"===o.tagName?i=o.firstChild.nodeValue:e[i]=this._parseNode(o))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function WB(t,e){return t[e]<<8|t[e+1]}var qB=new(function(){function t(){this._parsing=new vl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,i){t instanceof HTMLImageElement?i(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){i(null,t)}),(function(t){i(t,null)}))},e.parsePVRTex=function(t,e,i){var n=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(t){n=t}i(n,r)},e.parsePKMTex=function(t,e,i){var n=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o),s=WB(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=WB(a,12),l=WB(a,14);WB(a,8),WB(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(t){n=t}i(n,r)},e.parseASTCTex=function(t,e,i){var n=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(t,e){return 4===t?Dm.RGBA_ASTC_4x4:5===t?4===e?Dm.RGBA_ASTC_5x4:Dm.RGBA_ASTC_5x5:6===t?5===e?Dm.RGBA_ASTC_6x5:Dm.RGBA_ASTC_6x6:8===t?5===e?Dm.RGBA_ASTC_8x5:6===e?Dm.RGBA_ASTC_8x6:Dm.RGBA_ASTC_8x8:10===t?5===e?Dm.RGBA_ASTC_10x5:6===e?Dm.RGBA_ASTC_10x6:8===e?Dm.RGBA_ASTC_10x8:Dm.RGBA_ASTC_10x10:10===e?Dm.RGBA_ASTC_12x10:Dm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(t){n=t}i(n,r)},e.parsePlist=function(t,e,i){var n=null,r=jB.parse(t);r||(n=new Error("parse failed")),i(n,r)},e.parseImport=function(t,e,i){if(t){var n=null,r=null;try{n=rv(t,e)}catch(t){r=t}i(r,n)}else i(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?Vt(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,i,n,r){var o=this,a=bl.get(t);if(a)r(null,a);else{var s=this._parsing.get(t);if(s)s.push(r);else{var c=this._parsers[i];c?(this._parsing.add(t,[r]),c(e,n,(function(e,i){e?Sl.remove(t):zl(i)||bl.add(t,i);for(var n=o._parsing.remove(t),r=0,a=n.length;r<a;r++)n[r](e,i)}))):r(null,e)}}},t}());function XB(t,e){var i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);var n=t.options,r=t.progress;n.__exclude__=n.__exclude__||Object.create(null),t.output=[],fB(t.input,(function(o,a){var s=Il.create({input:o,onProgress:t.onProgress,options:n,progress:r,onComplete:function(n,c){n&&!t.isFinish&&(!u.assetManager.force||i?(b(n.message,n.stack),r.canInvoke=!1,e(n)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(c),s.recycle(),a(null)}});YB.async(s)}),(function(){if(n.__exclude__=null,t.isFinish)return cB(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var i=t.output=[],n=0,r=e.length;n<r;n++)i.push(e[n].content);else t.output=e[0].content}(t),cB(t,!0),e()}))}var YB=new gl("loadOneAsset",[function(t,e){var i=t.output=t.input,n=i.options,r=i.isNative,o=i.uuid,a=i.file,s=n.reloadAsset;a||!s&&!r&&xl.has(o)?e():UB.load(i,t.options,(function(t,n){i.file=n,e(t)}))},function(t,e){var i=t.output=t.input,n=t.progress,r=t.options.__exclude__,o=i.id,a=i.file,s=i.options;if(i.isNative)qB.parse(o,a,i.ext,s,(function(r,a){r?e(r):(i.content=a,n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),Sl.remove(o),bl.remove(o),e())}));else{var c=i.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),u||mB(c,c,r)?(h&&h.addRef(),i.content=h,e(_)):f.push({done:e,item:i})}else if(!s.reloadAsset&&xl.has(c)){var p=xl.get(c);i.content=p.addRef(),n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),e()}else s.__uuid__=c,qB.parse(o,a,"import",s,(function(i,n){i?e(i):function(t,e,i){var n=t.input,r=t.progress,o=n,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];e.addRef&&e.addRef(),hB(a,e,Object.create(null),h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=h.length,n);var _=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:i,item:n}]},f=Il.create({input:h,options:t.options,onProgress:t.onProgress,onError:Il.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){for(var i,n=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=st(n);!(i=o()).done;){var c=i.value;c&&(r[c instanceof Mu?c._uuid+"@import":a+"@native"]=c)}!function(t,e,i){var n=ev.get(e);if(n){for(var r=0,o=n.length;r<o;r++){var a=n[r],s=i[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(b("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Mu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}ev.delete(e)}iv.has(e)&&(i[t+"@native"]?e._nativeAsset=i[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),iv.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||nv.has(e)||iv.has(e)||(e.onLoaded(),nv.add(e))}catch(t){b("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}Sl.remove(s),bl.remove(s),_B(a,e,u),f.recycle()}for(var l=_.callbacks,h=0,p=l.length;h<p;h++){var d=l[h];e.addRef&&e.addRef(),d.item.content=e,d.done(t)}l.length=0}});Al.async(f)}(t,n,e)}))}}]);function KB(t,e){var i=t.options,n=Object.create(null),r=Object.create(null);for(var o in i)switch(o){case yl.PATH:case yl.UUID:case yl.DIR:case yl.SCENE:case yl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[o]=i[o];break;case"__exclude__":case"__outputAsArray__":r[o]=i[o];break;default:n[o]=i[o],r[o]=i[o]}t.options=r;var a=Il.create({input:t.input,options:n}),s=null;try{t.output=t.source=wl.sync(a)}catch(t){s=t;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),e(s)}var JB=function(){function t(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},Q(t,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),t}();JB.MAX_DEAD_NUM=500,JB._deadPool=[];var QB=[];function ZB(t){var e=t.options,i=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var n=function(n){var r,o=i[n],a=JB.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[e.__requestType__||yl.UUID]=i[n]),"object"==typeof o)for(var l in zt(o,e),o.preset&&zt(o,Pl[o.preset]),o){switch(l){case yl.UUID:if("break"===function(){var t,e=a.uuid=Bl(o.uuid);if(!o.bundle){var i=Cl.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=i&&i.name}if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getAssetInfo(e))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(e)}a.config=s,a.info=c}return a.ext=o.ext||(null===(t=c)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case yl.DIR:if(Cl.has(o.bundle)){Cl.get(o.bundle).config.getDirWithPath(o.dir,o.type,QB);for(var u,h=st(QB);!(u=h()).done;){var _=u.value;i.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}QB.length=0}a.recycle(),a=null;break;case yl.PATH:if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case yl.SCENE:if(!o.bundle){var f=Cl.find((function(t){return!!t.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case yl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||xu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<i.length;r++)n(r);return null}function $B(t){for(var e=t.output=t.input,i=0;i<e.length;i++){var n=e[i];if(!n.url){var r,o,a=n.config;o=n.isNative?a&&a.nativeBase?a.base+a.nativeBase:u.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:u.assetManager.generalImportBase;var s=n.uuid,c="";n.info&&(c=n.isNative?n.info.nativeVer?"."+n.info.nativeVer:"":n.info.ver?"."+n.info.ver:""),r=".ttf"===n.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+n.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+n.ext,n.url=r}}return null}var tN=t("AssetManager",function(){function t(){this.pipeline=Al.append(KB).append(XB),this.fetchPipeline=Tl.append(KB).append(GB),this.transformPipeline=wl.append(ZB).append($B),this.bundles=Cl,this.assets=xl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=av,this.force=!1,this.allowImageBitmap=!lh.isMobile,this.utils=Ul,this.downloader=OB,this.parser=qB,this.packManager=UB,this.cacheAsset=!0,this.cacheManager=null,this.presets=Pl,this.factory=kB,this.preprocessPipe=KB,this.fetchPipe=GB,this.loadPipe=XB,this.references=null,this._releaseManager=aB,this._files=Sl,this._parsed=bl,this._parsePipeline=null}var e=t.prototype;return e.init=function(t){void 0===t&&(t={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();var e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));var i=t.nativeBase||"";i&&i.endsWith("/")&&(i=i.substr(0,i.length-1)),this.generalImportBase=e,this.generalNativeBase=i},e.getBundle=function(t){return Cl.get(t)||null},e.removeBundle=function(t){t._destroy(),Cl.remove(t.name)},e.loadAny=function(t,e,i,n){var r=pB(e,i,n),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",t=Array.isArray(t)?t.slice():t;var c=Il.create({input:t,onProgress:a,onComplete:vB(s),options:o});Al.async(c)},e.preloadAny=function(t,e,i,n){var r=pB(e,i,n),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",t=Array.isArray(t)?t.slice():t;var c=Il.create({input:t,onProgress:a,onComplete:vB(s),options:o});Tl.async(c)},e.loadRemote=function(t,e,i){var n=pB(e,void 0,i),r=n.options,o=n.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,i){e?(b(e.message,e.stack),o&&o(e,i)):kB.create(t,i,r.ext||xu(t),r,(function(t,e){o&&o(t,e)}))}))):vB(o)(null,this.assets.get(t))},e.loadBundle=function(t,e,i){var n=pB(e,void 0,i),r=n.options,o=n.onComplete,a=bu(t);this.bundles.has(a)?vB(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,i){e?(b(e.message,e.stack),o&&o(e,i)):kB.create(t,i,"bundle",r,(function(t,e){o&&o(t,e)}))})))},e.releaseAsset=function(t){aB.tryRelease(t,!0)},e.releaseUnusedAssets=function(){xl.forEach((function(t){aB.tryRelease(t)}))},e.releaseAll=function(){xl.forEach((function(t){aB.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},Q(t,[{key:"main",get:function(){return Cl.get(El.MAIN)||null}},{key:"resources",get:function(){return Cl.get(El.RESOURCES)||null}}]),t}());tN.Pipeline=gl,tN.Task=Il,tN.Cache=vl,tN.RequestItem=JB,tN.Bundle=gB,tN.BuiltinBundleName=El;var eN=t("assetManager",u.assetManager=new tN);u.AssetManager=tN;var iN=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],nN=[".mp3",".ogg",".wav",".m4a"];function rN(){return!0}var oN={transformURL:function(t){var e=Ll(t);if(!e)return t;var i=Cl.find((function(t){return!!t.getAssetInfo(e)}));if(!i)return t;var n,r=i.getAssetInfo(e);if(!(n=t.startsWith(i.base+i.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==t.indexOf(n))return t;var o=!1;if(".ttf"===xu(t)&&(o=!0),o){var a=Cu(t),s=bu(t);t=a+"."+n+"/"+s}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(t){return t+"."+n}));return t}},aN=t("CCLoader",function(){function t(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=dB}var e=t.prototype;return e.load=function(t,e,i){void 0===i&&void 0!==e&&(i=e,e=null);for(var n=Array.isArray(t)?t:[t],r=0;r<n.length;r++){var o=n[r];"string"==typeof o?n[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];eN.loadAny(n,null,(function(t,i,n){n.content&&(iN.includes(n.ext)?a.push(n.content):nN.includes(n.ext)&&s.push(n.content)),e&&e(t,i,n)}),(function(t,e){var r=null;if(!t){e=Array.isArray(e)?e:[e];for(var o=function(t){var i=e[t];if(!(i instanceof Mu)){var r=i,o=n[t].url;a.includes(r)?kB.create(o,i,".png",{},(function(i,n){r=e[t]=n})):s.includes(r)&&kB.create(o,i,".mp3",{},(function(i,n){r=e[t]=n})),xl.add(o,r)}},c=0;c<e.length;c++)o(c);if(e.length>1){var l=Object.create(null);e.forEach((function(t){l[t._uuid]=t})),r={isCompleted:rN,_map:l}}else r=e[0]}i&&i(t,r)}))},e.getXMLHttpRequest=function(){return new XMLHttpRequest},e.getItem=function(t){return eN.assets.has(t)?{content:eN.assets.get(t)}:null},e.loadRes=function(t,e,i,n){var r=this._parseLoadResArgs(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete,c=xu(t);c&&!yB.getInfoWithPath(t,o)&&(t=t.slice(0,-c.length)),yB.load(t,o,a,s)},e.loadResArray=function(t,e,i,n){var r=this._parseLoadResArgs(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete;t.forEach((function(e,i){var n=xu(e);n&&!yB.getInfoWithPath(e,o)&&(t[i]=e.slice(0,-n.length))})),yB.load(t,o,a,s)},e.loadResDir=function(t,e,i,n){var r=this._parseLoadResArgs(e,i,n),o=r.type,a=r.onProgress,s=r.onComplete;yB.loadDir(t,o,a,(function(e,i){var n=[];e||(n=yB.getDirWithPath(t,o).map((function(t){return t.path}))),s&&s(e,i,n)}))},e.getRes=function(t,e){return xl.has(t)?xl.get(t):yB.get(t,e)},e.getResCount=function(){return xl.count},e.getDependsRecursively=function(t){if(!t)return[];var e="string"==typeof t?t:t._uuid;return av.getDepsRecursively(e).concat([e])},e.addDownloadHandlers=function(t){var e=Object.create(null),i=function(i){var n=t[i];e["."+i]=function(t,e,i){n({url:t},i)}};for(var n in t)i(n);OB.register(e)},e.addLoadHandlers=function(t){var e=Object.create(null),i=function(i){var n=t[i];e["."+i]=function(t,e,i){n({content:t},i)}};for(var n in t)i(n);qB.register(e)},e.release=function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++){var i=t[e];"string"==typeof i&&(i=xl.get(i)),eN.releaseAsset(i)}else t&&("string"==typeof t&&(t=xl.get(t)),eN.releaseAsset(t))},e.releaseAsset=function(t){eN.releaseAsset(t)},e.releaseRes=function(t,e){yB.release(t,e)},e.releaseAll=function(){eN.releaseAll(),xl.clear()},e.removeItem=function(t){return!!xl.remove(t)},e.setAutoRelease=function(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e},e.setAutoReleaseRecursively=function(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;for(var i=av.getDepsRecursively(t),n=0;n<i.length;n++)this._autoReleaseSetting[i[n]]=e},e.isAutoRelease=function(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]},Q(t,[{key:"onProgress",set:function(t){sB=t}},{key:"_cache",get:function(){if(xl instanceof vl)return xl._map;var t={};return xl.forEach((function(e,i){t[i]=e})),t}},{key:"md5Pipe",get:function(){return oN}},{key:"downloader",get:function(){return OB}},{key:"loader",get:function(){return eN.parser}}]),t}()),sN=t("loader",new aN),cN=t("AssetLibrary",{init:function(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,eN.init(t),t.rawAssets&&yB.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:El.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset:function(t,e){eN.loadAny(t,e)}}),lN=t("url",{});k(lN,"url",[{name:"normalize",target:eN.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(t){return t.startsWith("resources/")?kl({path:Au(t.substr(10)),bundle:El.RESOURCES,__isNative__:!0,ext:xu(t)}):""}}]),U(cN,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),U(sN,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),k(u,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return sN}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return cN}},{name:"Pipeline",target:tN,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return lN}}]),U(u,"cc",[{name:"LoadingItems",suggest:F(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),k(ue,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:OB,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),k(HO,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(t){var e;return eN.main?null===(e=eN.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),k(UO,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var t=[];return eN.main&&eN.main.config.scenes.forEach((function(e){t.push(e)})),t}}]);var uN,hN,_N,fN,pN,dN,mN,vN,gN,yN,xN,SN,bN,CN,AN=aB._autoRelease;aB._autoRelease=function(t,e,i){AN.call(aB,t,e,i);for(var n=sN._autoReleaseSetting,r=Object.keys(n),o=0;o<r.length;o++){var a=r[o];if(!0===n[a]){var s=xl.get(a);s&&aB.tryRelease(s)}}};var TN,wN,EN,PN,IN,RN,DN,MN,ON,BN,NN,LN,FN,zN,VN,kN,UN,GN,HN,jN,WN,qN,XN,YN,KN,JN,QN,ZN,$N,tL,eL,iL,nL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,pL,dL,mL,vL,gL,yL,xL,SL,bL,CL,AL,TL,wL,EL,PL,IL,RL,DL,ML,OL,BL,NL,LL,FL,zL=t("EventHandler",(uN=pc("cc.ClickEvent"),hN=Kc(u.Node),_N=Nc(),fN=Nc(),pN=Nc(),dN=Nc(),uN((CN=function(){function t(){ct(this,"target",gN,this),ct(this,"component",yN,this),ct(this,"_componentId",xN,this),ct(this,"handler",SN,this),ct(this,"customEventData",bN,this)}t.emitEvents=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var o=0,a=e.length;o<a;o++){var s=e[o];s instanceof t&&s.emit(n)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(u.isValid(e)){this._genCompIdIfNeeded();var i=u.js._getClassById(this._componentId),n=e.getComponent(i);if(u.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(n,t))}}},e._compName2Id=function(t){var e=u.js.getClassByName(t);return u.js._getClassId(e)},e._compId2Name=function(t){var e=u.js._getClassById(t);return u.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},Q(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),gN=lt((vN=CN).prototype,"target",[xc,hN,xc,_N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yN=lt(vN.prototype,"component",[xc,Dc,fN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xN=lt(vN.prototype,"_componentId",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SN=lt(vN.prototype,"handler",[xc,Dc,pN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bN=lt(vN.prototype,"customEventData",[xc,Dc,dN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mN=vN))||mN));u.Component.EventHandler=zL;var VL,kL,UL,GL,HL,jL,WL,qL,XL,YL,KL,JL=new Ei,QL=oe(ng),ZL=oe(ig),$L=oe(rg),tF=oe(ag),eF=oe(og),iF=oe({SKYBOX:dg|Xn.DEPTH_STENCIL,SOLID_COLOR:Xn.ALL,DEPTH_ONLY:Xn.DEPTH_STENCIL,DONT_CLEAR:Xn.NONE}),nF=(TN=pc("cc.Camera"),wN=Rc(),EN=wc(),PN=Uc(),IN=Nc(),RN=Kc(Np.BitMask),DN=Uc(),MN=Nc(),ON=Kc(iF),BN=Uc(),NN=Nc(),LN=Uc(),FN=Nc(),zN=Uc(),VN=Nc(),kN=Uc(),UN=Nc(),GN=Kc(QL),HN=Uc(),jN=Nc(),WN=Kc(ZL),qN=Uc(),XN=Nc(),YN=Uc(),KN=Nc(),JN=Uc(),QN=Nc(),ZN=Uc(),$N=Nc(),tL=Uc(),eL=Nc(),iL=Kc($L),nL=Uc(),rL=Nc(),oL=Kc(tF),aL=Uc(),sL=Nc(),cL=Kc(eF),lL=Uc(),uL=Nc(),hL=Uc(),_L=Nc(),fL=Kc(VS),pL=Uc(),dL=Nc(),VL=TN(mL=wN(mL=EN(mL=Tc((FL=LL=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_projection",gL,ot(e)),ct(e,"_priority",yL,ot(e)),ct(e,"_fov",xL,ot(e)),ct(e,"_fovAxis",SL,ot(e)),ct(e,"_orthoHeight",bL,ot(e)),ct(e,"_near",CL,ot(e)),ct(e,"_far",AL,ot(e)),ct(e,"_color",TL,ot(e)),ct(e,"_depth",wL,ot(e)),ct(e,"_stencil",EL,ot(e)),ct(e,"_clearFlags",PL,ot(e)),ct(e,"_rect",IL,ot(e)),ct(e,"_aperture",RL,ot(e)),ct(e,"_shutter",DL,ot(e)),ct(e,"_iso",ML,ot(e)),ct(e,"_screenScale",OL,ot(e)),ct(e,"_visibility",BL,ot(e)),ct(e,"_targetTexture",NL,ot(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._createCamera()},i.onEnable=function(){this.node.hasChangedFlags|=ny.POSITION,this._camera&&this._attachToScene()},i.onDisable=function(){this._camera&&this._detachFromScene()},i.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},i.screenPointToRay=function(t,e,i){return i||(i=ta.create()),this._camera&&this._camera.screenPointToRay(i,t,e),i},i.worldToScreen=function(t,e){return e||(e=new Ei),this._camera&&this._camera.worldToScreen(e,t),e},i.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},i.convertToUINode=function(t,e,i){if(i||(i=new Ei),!this._camera)return i;this.worldToScreen(t,JL);var n=e.getComponent("cc.UITransform"),r=$O.getVisibleSize(),o=JL.x-.5*this._camera.width,a=JL.y-.5*this._camera.height;return JL.x=o/u.view.getScaleX()+.5*r.width,JL.y=a/u.view.getScaleY()+.5*r.height,n&&n.convertToNodeSpaceAR(JL,i),i},i._createCamera=function(){this._camera||(this._camera=u.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?u.director.root&&u.director.root.mainWindow:u.director.root&&u.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=li(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},i._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},i._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},i._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},i._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},Q(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===ig.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=li(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var i=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(i),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?u.director.root&&u.director.root.mainWindow:u.director.root&&u.director.root.tempWindow)}}]),e}($u),LL.ProjectionType=QL,LL.FOVAxis=ZL,LL.ClearFlag=iF,LL.Aperture=$L,LL.Shutter=tF,LL.ISO=eF,LL.TARGET_TEXTURE_CHANGE="tex-change",gL=lt((vL=FL).prototype,"_projection",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QL.PERSPECTIVE}}),yL=lt(vL.prototype,"_priority",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xL=lt(vL.prototype,"_fov",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),SL=lt(vL.prototype,"_fovAxis",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ZL.VERTICAL}}),bL=lt(vL.prototype,"_orthoHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),CL=lt(vL.prototype,"_near",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AL=lt(vL.prototype,"_far",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),TL=lt(vL.prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti("#333333")}}),wL=lt(vL.prototype,"_depth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EL=lt(vL.prototype,"_stencil",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PL=lt(vL.prototype,"_clearFlags",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iF.SOLID_COLOR}}),IL=lt(vL.prototype,"_rect",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new en(0,0,1,1)}}),RL=lt(vL.prototype,"_aperture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $L.F16_0}}),DL=lt(vL.prototype,"_shutter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tF.D125}}),ML=lt(vL.prototype,"_iso",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eF.ISO100}}),OL=lt(vL.prototype,"_screenScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BL=lt(vL.prototype,"_visibility",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jd}}),NL=lt(vL.prototype,"_targetTexture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(vL.prototype,"priority",[PN,IN],Object.getOwnPropertyDescriptor(vL.prototype,"priority"),vL.prototype),lt(vL.prototype,"visibility",[RN,DN,MN],Object.getOwnPropertyDescriptor(vL.prototype,"visibility"),vL.prototype),lt(vL.prototype,"clearFlags",[ON,BN,NN],Object.getOwnPropertyDescriptor(vL.prototype,"clearFlags"),vL.prototype),lt(vL.prototype,"clearColor",[LN,FN],Object.getOwnPropertyDescriptor(vL.prototype,"clearColor"),vL.prototype),lt(vL.prototype,"clearDepth",[zN,VN],Object.getOwnPropertyDescriptor(vL.prototype,"clearDepth"),vL.prototype),lt(vL.prototype,"clearStencil",[kN,UN],Object.getOwnPropertyDescriptor(vL.prototype,"clearStencil"),vL.prototype),lt(vL.prototype,"projection",[GN,HN,jN],Object.getOwnPropertyDescriptor(vL.prototype,"projection"),vL.prototype),lt(vL.prototype,"fovAxis",[WN,qN,XN],Object.getOwnPropertyDescriptor(vL.prototype,"fovAxis"),vL.prototype),lt(vL.prototype,"fov",[YN,KN],Object.getOwnPropertyDescriptor(vL.prototype,"fov"),vL.prototype),lt(vL.prototype,"orthoHeight",[JN,QN],Object.getOwnPropertyDescriptor(vL.prototype,"orthoHeight"),vL.prototype),lt(vL.prototype,"near",[ZN,$N],Object.getOwnPropertyDescriptor(vL.prototype,"near"),vL.prototype),lt(vL.prototype,"far",[tL,eL],Object.getOwnPropertyDescriptor(vL.prototype,"far"),vL.prototype),lt(vL.prototype,"aperture",[iL,nL,rL],Object.getOwnPropertyDescriptor(vL.prototype,"aperture"),vL.prototype),lt(vL.prototype,"shutter",[oL,aL,sL],Object.getOwnPropertyDescriptor(vL.prototype,"shutter"),vL.prototype),lt(vL.prototype,"iso",[cL,lL,uL],Object.getOwnPropertyDescriptor(vL.prototype,"iso"),vL.prototype),lt(vL.prototype,"rect",[hL,_L],Object.getOwnPropertyDescriptor(vL.prototype,"rect"),vL.prototype),lt(vL.prototype,"targetTexture",[fL,pL,dL],Object.getOwnPropertyDescriptor(vL.prototype,"targetTexture"),vL.prototype),mL=vL))||mL)||mL)||mL)||mL,t({Camera:VL,CameraComponent:VL}),VL);u.Camera=nF;var rF,oF,aF,sF,cF,lF,uF,hF,_F={parent:null,owner:null,subModelIdx:0},fF=t("RenderableComponent",(kL=pc("cc.RenderableComponent"),UL=Kc([cg]),GL=Kc(cg),HL=Uc(),jL=Bc(),kL((KL=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_materials",XL,ot(e)),ct(e,"_visFlags",YL,ot(e)),e._materialInstances=[],e._models=[],e}$(e,t);var i=e.prototype;return i.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},i.setMaterial=function(t,e){t&&t instanceof mb&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var i=this._materialInstances[e];i&&(i.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},i.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){_F.parent=this._materials[t],_F.owner=this,_F.subModelIdx=t;var e=new mb(_F);_F.parent=null,_F.owner=null,_F.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},i.setMaterialInstance=function(t,e){if("number"==typeof t){D(12007);var i=t;t=e,e=i}var n=this._materialInstances[e];t&&t.parent?t!==n&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||n)&&this.setMaterial(t,e)},i.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},i._collectModels=function(){return this._models},i._attachToScene=function(){},i._detachFromScene=function(){},i._onMaterialModified=function(){},i._onRebuildPSO=function(){},i._clearMaterials=function(){},i._onVisibilityChange=function(){},Q(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var i=t.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var i=this._materials.length-e;i<this._materials.length;++i)this.setMaterialInstance(null,i);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=t[n]&&this.setMaterialInstance(t[n],n)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}}]),e}($u),XL=lt((qL=KL).prototype,"_materials",[UL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),YL=lt(qL.prototype,"_visFlags",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Np.Enum.NONE}}),lt(qL.prototype,"sharedMaterials",[GL,HL,jL],Object.getOwnPropertyDescriptor(qL.prototype,"sharedMaterials"),qL.prototype),WL=qL))||WL));function pF(t){return"string"==typeof t||"number"==typeof t}u.RenderableComponent=fF,k(nF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),k(nF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),u.CameraComponent=nF,ne.setClassAlias(nF,"cc.CameraComponent");var dF,mF,vF,gF,yF,xF,SF,bF,CF,AF,TF,wF,EF,PF,IF,RF,DF,MF,OF,BF,NF,LF,FF=pc("cc.animation.HierarchyPath")((sF=function(){function t(t){ct(this,"path",aF,this),this.path=t||""}return t.prototype.get=function(t){return t instanceof jT?t.getChildByPath(this.path)||(D(3926,t.name,this.path),null):(D(3925),null)},t}(),aF=lt((oF=sF).prototype,"path",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rF=oF))||rF,zF=pc("cc.animation.ComponentPath")((hF=function(){function t(t){ct(this,"component",uF,this),this.component=t||""}return t.prototype.get=function(t){return t instanceof jT?t.getComponent(this.component)||(D(3928,t.name,this.component),null):(D(3927),null)},t}(),uF=lt((lF=hF).prototype,"component",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cF=lF))||cF,VF=pc("cc.animation.UniformProxyFactory")((xF=function(){function t(t,e){ct(this,"passIndex",vF,this),ct(this,"uniformName",gF,this),ct(this,"channelIndex",yF,this),this.passIndex=e||0,this.uniformName=t||""}return t.prototype.forTarget=function(t){var e=t.passes[this.passIndex],i=e.getHandle(this.uniformName);if(!i)throw new Error('Material "'+t.name+'" has no uniform "'+this.uniformName+'"');if(Vv.getTypeFromHandle(i)<pn.SAMPLER1D){var n=void 0===this.channelIndex?i:e.getHandle(this.uniformName,this.channelIndex,pn.FLOAT);if(!n)throw new Error('Uniform "'+this.uniformName+" (in material "+t.name+") has no channel "+this.channelIndex+'"');return function(t,e){for(var i,n=st(t.shaderInfo.blocks);!(i=n()).done;)for(var r,o=st(i.value.members);!(r=o()).done;){var a=r.value;if(a.name===e)return a.count>1}return!1}(e,this.uniformName)?{set:function(t){e.setUniformArray(n,t)}}:{set:function(t){e.setUniform(n,t)}}}var r=Vv.getBindingFromHandle(i),o=e.properties[this.uniformName],a=o&&o.value?o.value+"-texture":_m(o.type),s=Mv.get(a);return s||(S("Illegal texture default value: "+a+"."),s=Mv.get("default-texture")),{set:function(t){t||(t=s);var i=t.getGFXTexture();i&&i.width&&i.height&&(e.bindTexture(r,i),t instanceof Zm&&e.bindSampler(r,u.game._gfxDevice.getSampler(t.getSamplerInfo())))}}},t}(),vF=lt((mF=xF).prototype,"passIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gF=lt(mF.prototype,"uniformName",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yF=lt(mF.prototype,"channelIndex",[qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),dF=mF))||dF,kF=pc("cc.animation.MorphWeightValueProxy")((TF=function(){function t(){ct(this,"subMeshIndex",CF,this),ct(this,"shapeIndex",AF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(i){t.setWeight(i,e.subMeshIndex,e.shapeIndex)}}},t}(),CF=lt((bF=TF).prototype,"subMeshIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AF=lt(bF.prototype,"shapeIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SF=bF))||SF,UF=pc("cc.animation.MorphWeightsValueProxy")((IF=function(){function t(){ct(this,"subMeshIndex",PF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(i){t.setWeights(i,e.subMeshIndex)}}},t}(),PF=lt((EF=IF).prototype,"subMeshIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wF=EF))||wF,GF=pc("cc.animation.MorphWeightsAllValueProxy")(RF=function(){function t(){}return t.prototype.forTarget=function(t){return{set:function(e){for(var i,n,r=null!==(i=null===(n=t.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0,o=0;o<r;++o)t.setWeights(e,o)}}},t}())||RF;function HF(t,e,i,n){var r,o,a,s,c,l,u=new e,h=new e,_=new e,f=pc(t)((l=function(){function t(t,i,n){ct(this,"dataPoint",a,this),ct(this,"inTangent",s,this),ct(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=i||new e,this.outTangent=n||new e}var r=t.prototype;return r.lerp=function(t,e,r){var o=this.dataPoint,a=t.dataPoint;h=i(h,this.inTangent,r),_=i(_,t.outTangent,r);var s=e*e*e,c=e*e,l=s-2*c+e,f=-2*s+3*c,p=s-c;return u=i(u,o,2*s-3*c+1),u=n(u,u,h,l),u=n(u,u,a,f),u=n(u,u,_,p)},r.getNoLerp=function(){return this.dataPoint},t}(),a=lt((o=l).prototype,"dataPoint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=lt(o.prototype,"inTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=lt(o.prototype,"outTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),r=o))||r;if(e===Bi){var p=f.prototype.lerp;f.prototype.lerp=function(t,e,i){var n=p.call(this,t,e,i);return Bi.normalize(n,n),n}}return f}var jF=t("CubicSplineVec2Value",HF("cc.CubicSplineVec2Value",qi,qi.multiplyScalar,qi.scaleAndAdd));u.CubicSplineVec2Value=jF;var WF=t("CubicSplineVec3Value",HF("cc.CubicSplineVec3Value",Ei,Ei.multiplyScalar,Ei.scaleAndAdd));u.CubicSplineVec3Value=WF;var qF=t("CubicSplineVec4Value",HF("cc.CubicSplineVec4Value",Ji,Ji.multiplyScalar,Ji.scaleAndAdd));u.CubicSplineVec4Value=qF;var XF=t("CubicSplineQuatValue",HF("cc.CubicSplineQuatValue",Bi,Bi.multiplyScalar,Bi.scaleAndAdd));u.CubicSplineQuatValue=XF;var YF=t("CubicSplineNumberValue",pc("cc.CubicSplineNumberValue")((LF=function(){function t(t,e,i){ct(this,"dataPoint",OF,this),ct(this,"inTangent",BF,this),ct(this,"outTangent",NF,this),this.dataPoint=t,this.inTangent=e,this.outTangent=i}var e=t.prototype;return e.lerp=function(t,e,i){var n=this.dataPoint,r=t.dataPoint,o=e*e*e,a=e*e;return n*(2*o-3*a+1)+this.outTangent*i*(o-2*a+e)+r*(-2*o+3*a)+t.inTangent*i*(o-a)},e.getNoLerp=function(){return this.dataPoint},t}(),OF=lt((MF=LF).prototype,"dataPoint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BF=lt(MF.prototype,"inTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NF=lt(MF.prototype,"outTangent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DF=MF))||DF);u.CubicSplineNumberValue=YF;var KF,JF,QF,ZF,$F,tz,ez,iz,nz,rz,oz,az,sz,cz,lz,uz,hz,_z,fz,pz,dz,mz,vz,gz,yz,xz,Sz,bz=Symbol("CreateEval"),Cz=Symbol("NormalizedFollow"),Az=Symbol("ConvertAsTrsPath"),Tz=Symbol("TrackBinding"),wz=pc("cc.animation.TrackPath")((ZF=function(){function t(){ct(this,"_paths",QF,this)}var e=t.prototype;return e.toProperty=function(t){return this._paths.push(t),this},e.toElement=function(t){return this._paths.push(t),this},e.toHierarchy=function(t){return this._paths.push(new FF(t)),this},e.toComponent=function(t){var e=new zF("string"==typeof t?t:ne.getClassName(t));return this._paths.push(e),this},e.toCustomized=function(t){return this._paths.push(t),this},e.append=function(){for(var t,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];var r=(t=this._paths).concat.apply(t,i.map((function(t){return t._paths})));return this._paths=r,this},e.isPropertyAt=function(t){return"string"==typeof this._paths[t]},e.parsePropertyAt=function(t){return this._paths[t]},e.isElementAt=function(t){return"number"==typeof this._paths[t]},e.parseElementAt=function(t){return this._paths[t]},e.isHierarchyAt=function(t){return this._paths[t]instanceof FF},e.parseHierarchyAt=function(t){return this.isHierarchyAt(t),this._paths[t].path},e.isComponentAt=function(t){return this._paths[t]instanceof zF},e.parseComponentAt=function(t){return this.isComponentAt(t),this._paths[t].component},e.slice=function(e,i){var n=new t;return n._paths=this._paths.slice(e,i),n},e.trace=function(t,e,i){var n,r;return null!==(n=e)&&void 0!==n||(e=0),null!==(r=i)&&void 0!==r||(i=this._paths.length),this[Cz](t,e,i)},e[Az]=function(){for(var t,e=this._paths,i=e.length,n=0,r="";n<i;++n){var o=e[n];if(!(o instanceof FF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(n===i)return null;if(n!==i-1)return null;switch(e[n]){case"position":case"scale":case"rotation":case"eulerAngles":t=e[n];break;default:return null}return{node:r,property:t}},e[Cz]=function(t,e,i){for(var n=this._paths,r=t,o=e;o<i;++o){var a=n[o];if(pF(a)){if(!(a in r))return D(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},Q(t,[{key:"length",get:function(){return this._paths.length}}]),t}(),QF=lt((JF=ZF).prototype,"_paths",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KF=JF))||KF,Ez=pc("cc.animation.TrackBinding")($F=Ac((nz=function(){function t(){ct(this,"path",ez,this),ct(this,"proxy",iz,this)}var e=t.prototype;return e.parseTrsPath=function(){return this.proxy?null:this.path[Az]()},e.createRuntimeBinding=function(t,e,i){var n=this.path,r=this.proxy,o=n.length,a=o-1;if(0===o||!n.isPropertyAt(a)&&!n.isElementAt(a)||r){if(r){var s=n[Cz](t,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(t){c.set(t)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return O(3921),null}var h,_=n.isPropertyAt(a)?n.parsePropertyAt(a):n.parseElementAt(a),f=n[Cz](t,0,o-1);return null===f?null:e&&f instanceof jT&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?e.createPoseWriter(f,_,i):{setValue:function(t){f[_]=t},getValue:function(){return f[_]}}},t}(),ez=lt((tz=nz).prototype,"path",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wz}}),iz=lt(tz.prototype,"proxy",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$F=tz))||$F)||$F,Pz=pc("cc.animation.Track")((sz=function(){function t(){ct(this,"_binding",az,this)}var e=t.prototype;return e.channels=function(){return[]},e.range=function(){for(var t,e={min:1/0,max:-1/0},i=st(this.channels());!(t=i()).done;){var n=t.value;e.min=Math.min(e.min,n.curve.rangeMin),e.max=Math.max(e.max,n.curve.rangeMax)}return e},Q(t,[{key:"path",get:function(){return this._binding.path},set:function(t){this._binding.path=t}},{key:"proxy",get:function(){return this._binding.proxy},set:function(t){this._binding.proxy=t}},{key:Tz,get:function(){return this._binding}}]),t}(),az=lt((oz=sz).prototype,"_binding",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ez}}),rz=oz))||rz,Iz=pc("cc.animation.Channel")((hz=function(){function t(t){this.name="",ct(this,"_curve",uz,this),this._curve=t}return Q(t,[{key:"curve",get:function(){return this._curve}}]),t}(),uz=lt((lz=hz).prototype,"_curve",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cz=lz))||cz,Rz=pc("cc.animation.SingleChannelTrack")((dz=function(t){function e(){var e;return ct(e=t.call(this)||this,"_channel",pz,ot(e)),e._channel=new Iz(e.createCurve()),e}$(e,t);var i=e.prototype;return i.channels=function(){return[this._channel]},i.createCurve=function(){throw new Error("Not impl")},i[bz]=function(){var t=this._channel.curve;return new Dz(t)},Q(e,[{key:"channel",get:function(){return this._channel}}]),e}(Pz),pz=lt((fz=dz).prototype,"_channel",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_z=fz))||_z,Dz=function(){function t(t){this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t)},t}(),Mz=pc("cc.animation.RealTrack")(mz=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.createCurve=function(){return new df},e}(Rz))||mz;function Oz(t){return 0===t.keyFramesCount?void 0:t}var Bz,Nz,Lz,Fz,zz,Vz,kz,Uz,Gz,Hz,jz=["X","Y","Z","W"],Wz=pc("cc.animation.VectorTrack")((Sz=function(t){function e(){var e;ct(e=t.call(this)||this,"_channels",yz,ot(e)),ct(e,"_nComponents",xz,ot(e)),e._channels=new Array(4);for(var i=0;i<e._channels.length;++i){var n=new Iz(new df);n.name=jz[i],e._channels[i]=n}return e}$(e,t);var i=e.prototype;return i.channels=function(){return this._channels},i[bz]=function(){switch(this._nComponents){default:case 2:return new qz(Oz(this._channels[0].curve),Oz(this._channels[1].curve));case 3:return new Xz(Oz(this._channels[0].curve),Oz(this._channels[1].curve),Oz(this._channels[2].curve));case 4:return new Yz(Oz(this._channels[0].curve),Oz(this._channels[1].curve),Oz(this._channels[2].curve),Oz(this._channels[3].curve))}},Q(e,[{key:"componentsCount",get:function(){return this._nComponents},set:function(t){this._nComponents=t}}]),e}(Pz),yz=lt((gz=Sz).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xz=lt(gz.prototype,"_nComponents",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),vz=gz))||vz,qz=function(){function t(t,e){this._result=new qi,this._x=t,this._y=e}return t.prototype.evaluate=function(t,e){return this._x&&this._y||!e.getValue||qi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result},t}(),Xz=function(){function t(t,e,i){this._result=new Ei,this._x=t,this._y=e,this._z=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z||!e.getValue||Ei.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result},t}(),Yz=function(){function t(t,e,i,n){this._result=new Ji,this._x=t,this._y=e,this._z=i,this._w=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Ji.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result},t}(),Kz=pc("cc.animation.QuatTrack")(Bz=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.createCurve=function(){return new ep},i[bz]=function(){return new Jz(this.channels()[0].curve)},e}(Rz))||Bz,Jz=function(){function t(t){this._result=new Bi,this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t,this._result),this._result},t}(),Qz=["Red","Green","Blue","Alpha"],Zz=pc("cc.animation.ColorTrack")((zz=function(t){function e(){var e;ct(e=t.call(this)||this,"_channels",Fz,ot(e)),e._channels=new Array(4);for(var i=0;i<e._channels.length;++i){var n=new Iz(new df);n.name=Qz[i],e._channels[i]=n}return e}$(e,t);var i=e.prototype;return i.channels=function(){return this._channels},i[bz]=function(){return new $z(Oz(this._channels[0].curve),Oz(this._channels[1].curve),Oz(this._channels[2].curve),Oz(this._channels[3].curve))},e}(Pz),Fz=lt((Lz=zz).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Nz=Lz))||Nz,$z=function(){function t(t,e,i,n){this._result=new Ti,this._x=t,this._y=e,this._z=i,this._w=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Ti.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result},t}(),tV=["Width","Height"],eV=pc("cc.animation.SizeTrack")((Gz=function(t){function e(){var e;ct(e=t.call(this)||this,"_channels",Uz,ot(e)),e._channels=new Array(2);for(var i=0;i<e._channels.length;++i){var n=new Iz(new df);n.name=tV[i],e._channels[i]=n}return e}$(e,t);var i=e.prototype;return i.channels=function(){return this._channels},i[bz]=function(){return new iV(Oz(this._channels[0].curve),Oz(this._channels[1].curve))},e}(Pz),Uz=lt((kz=Gz).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vz=kz))||Vz,iV=function(){function t(t,e){this._result=new $i,this._width=t,this._height=e}return t.prototype.evaluate=function(t,e){if((!this._width||!this._height)&&e.getValue){var i=e.getValue();this._result.x=i.x,this._result.y=i.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result},t}(),nV=pc("cc.animation.ObjectTrack")(Hz=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.createCurve=function(){return new mp},e}(Rz))||Hz;t("animation",Object.freeze({__proto__:null,UniformProxyFactory:VF,MorphWeightValueProxy:kF,MorphWeightsValueProxy:UF,MorphWeightsAllValueProxy:GF,Track:Pz,TrackPath:wz,RealTrack:Mz,VectorTrack:Wz,QuatTrack:Kz,ColorTrack:Zz,SizeTrack:eV,ObjectTrack:nV,isPropertyPath:pF,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:FF,ComponentPath:zF,CubicSplineVec2Value:jF,CubicSplineVec3Value:WF,CubicSplineVec4Value:qF,CubicSplineQuatValue:XF,CubicSplineNumberValue:YF}));var rV=Symbol("BakeNodeCurves"),oV=function(){function t(){}return t.getOrExtract=function(e){var i=t.pool.get(e);if(!i||i.samples!==e.sample){i&&u.director.root.dataPoolManager.releaseAnimationClip(e);var n=Math.ceil(e.sample*e.duration)+1,r=e.sample;i=e[rV](0,r,n),t.pool.set(e,i)}return i},t.destroy=function(e){t.pool.delete(e)},t}();oV.pool=new Map;var aV=t("RatioSampler",function(){function t(t){var e,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var n=!0,r=1,o=t.length;r<o;r++)if(e=t[r]-t[r-1],1===r)i=e;else if(Math.abs(e-i)>1e-6){n=!1;break}this._findRatio=n?uV:oc}return t.prototype.sample=function(t){return this._findRatio(this.ratios,t)},t}());u.RatioSampler=aV;var sV=t("AnimCurve",function(){function t(e,i){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=i,this._values=e.values;var n=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?t.Linear:t.Bezier(e):t.Linear};if(void 0!==e.easingMethod)this.type=n(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(n);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(e.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=n(e.easingMethods[a])}}else this.type=null;var s=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=yV(s)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}t.Bezier=function(t){return t};var e=t.prototype;return e.hasLerp=function(){return!!this._lerp},e.valueAt=function(t){if(void 0===this._array){var e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(var i=0;i<this._array.length;++i)this._array[i]=this._values[this._array.length*t+i];return this._array},e.valueBetween=function(t,e,i,n,r){if(this._lerp){var o=this.types?this.types[e]:this.type,a=r-i,s=(t-i)/a;if(o&&(s=lV(s,o)),void 0===this._array){var c=this._values[e],l=this._values[n];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*e+u],_=this._values[this._array.length*n+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*e+f];return this._array},e.empty=function(){return 0===this._values.length},e.constant=function(){return 1===this._values.length},t}());function cV(t,e,i){var n=e.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=e.ratios.length))return t.valueBetween(i,n-1,e.ratios[n-1],n,e.ratios[n]);n=e.ratios.length-1}return t.valueAt(n)}function lV(t,e){if("string"==typeof e){var i=tf[e];i?t=i(t):O(3906,e)}else Array.isArray(e)&&(t=Qf(e,t));return t}function uV(t,e){var i=t.length-1;if(0===i)return 0;var n=t[0];if(e<n)return 0;var r=t[i];if(e>r)return i;var o=(e=(e-n)/(r-n))/(1/i),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}sV.Linear=null,u.AnimCurve=sV,t("EventInfo",function(){function t(){this.events=[]}return t.prototype.add=function(t,e){this.events.push({func:t||"",params:e||[]})},t}()),u.sampleAnimationCurve=cV;var hV,_V,fV,pV,dV,mV,vV,gV,yV=function(){function t(t,e,i,n){return t.lerp(e,i,n)}return function(e){if(null!==e){if("number"==typeof e)return ci;if("object"==typeof e&&e.constructor){if(e instanceof Bi)return i=new Bi,function(t,e,n){return Bi.slerp(i,t,e,n)};if(e instanceof le)return function(t){var e=new t;return function(i,n,r){return t.lerp(e,i,n,r),e}}(e.constructor);if(e.constructor===Number)return ci;if("function"==typeof e.lerp)return t}var i}}}(),xV=pc("cc.animation.UntypedTrackChannel")((pV=function(t){function e(){var e;return ct(e=t.call(this,new df)||this,"property",fV,ot(e)),e}return $(e,t),e}(Iz),fV=lt((_V=pV).prototype,"property",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hV=_V))||hV,SV=pc("cc.animation.UntypedTrack")((gV=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_channels",vV,ot(e)),e}$(e,t);var i=e.prototype;return i.channels=function(){return this._channels},i[bz]=function(t){var e=this;if(!t.getValue)throw new Error(F(3930));var i=function(t){var i;return null===(i=e._channels.find((function(e){return e.property===t})))||void 0===i?void 0:i.curve},n=t.getValue();switch(!0){default:throw new Error(F(3931));case n instanceof qi:return new qz(i("x"),i("y"));case n instanceof Ei:return new Xz(i("x"),i("y"),i("z"));case n instanceof Ji:return new Yz(i("x"),i("y"),i("z"),i("w"));case n instanceof Ti:return new $z(i("r"),i("g"),i("b"),i("a"));case n instanceof $i:return new iV(i("width"),i("height"))}},i.addChannel=function(t){var e=new xV;return e.property=t,this._channels.push(e),e},i.upgrade=function(t){var e=this,i=function(t,i){var n=e.channels().find((function(e){return e.property===t}));n&&(i.name=n.name,i.curve.assignSorted(Array.from(n.curve.times()),Array.from(n.curve.values())))},n=t(this.path,this.proxy);switch(n){default:break;case"vec2":case"vec3":case"vec4":var r=new Wz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===n?2:"vec3"===n?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(n){case"vec4":i("w",l);case"vec3":i("z",c);default:case"vec2":i("x",a),i("y",s)}return r;case"color":var u=new Zz,h=u.channels(),_=h[0],f=h[1],p=h[2],d=h[3];return i("r",_),i("g",f),i("b",p),i("a",d),i("x",_),i("y",f),i("z",p),i("w",d),u;case"size":}return null},e}(Pz),vV=lt((mV=gV).prototype,"_channels",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dV=mV))||dV,bV=function(){function t(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}var e=t.prototype;return e.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},e.toTracks=function(){for(var t,e=[],i=this.keys,n=this.curves,r=this.commonTargets,o=function(t,e,i){for(var n,r=new wz,o=st(e);!(n=o()).done;){var a=n.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof FF?r.toHierarchy(a.path):a instanceof zF?r.toComponent(a.component):r.toCustomized(a)}t.path=r,t.proxy=i},a=r.map((function(t){var i=new SV;return o(i,t.modifiers,t.valueAdapter),e.push(i),i})),s=function(){var n,r=t.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:i[s.keys],u=c[0],h=null===(n=s.interpolate)||void 0===n||n;s._arrayLength;var _=new AV(s,l.length),f=function(t){o(t,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(t){return"number"==typeof t})))return D(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return D(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(t){return"number"==typeof t})))return void D(3934);var t;if(p)t=p;else{var i=new Mz;f(i),e.push(i),t=i.channel.curve}var n=h?il.LINEAR:il.CONSTANT;return t.assignSorted(l,c.map((function(t){return{value:t,interpolationMode:n}}))),void _.convert(t)}if("object"==typeof u)switch(!0){default:break;case CV(c,qi):case CV(c,Ei):case CV(c,Ji):var r=u instanceof qi?2:u instanceof Ei?3:4,o=new Wz;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?il.LINEAR:il.CONSTANT,y=function(t){return{value:t,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(t){return y(t.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(t){return y(t.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(t){return y(t.x)}))),_.convert(s),d.assignSorted(l,c.map((function(t){return y(t.y)}))),_.convert(d)}return void e.push(o);case CV(c,Bi):var x=new Kz;f(x);var S=h?jf.SLERP:jf.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(t){return{value:Bi.clone(t),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void e.push(x);case CV(c,Ti):var b=new Zz;f(b);var C=b.channels(),A=C[0].curve,T=C[1].curve,w=C[2].curve,E=C[3].curve,P=h?il.LINEAR:il.CONSTANT,I=function(t){return{value:t,interpolationMode:P}};return A.assignSorted(l,c.map((function(t){return I(t.r)}))),_.convert(A),T.assignSorted(l,c.map((function(t){return I(t.g)}))),_.convert(T),w.assignSorted(l,c.map((function(t){return I(t.b)}))),_.convert(w),E.assignSorted(l,c.map((function(t){return I(t.a)}))),_.convert(E),void e.push(b);case CV(c,$i):var R=new eV;f(R);var M=R.channels(),O=M[0].curve,B=M[1].curve,N=h?il.LINEAR:il.CONSTANT,L=function(t){return{value:t,interpolationMode:N}};return O.assignSorted(l,c.map((function(t){return L(t.width)}))),_.convert(O),B.assignSorted(l,c.map((function(t){return L(t.height)}))),_.convert(B),void e.push(R);case CV(c,YF):var F=new Mz;f(F);var z=h?il.CUBIC:il.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(t){return{value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:z}}))),void e.push(F);case CV(c,jF):case CV(c,WF):case CV(c,qF):var V=u instanceof jF?2:u instanceof WF?3:4,k=new Wz;f(k),k.componentsCount=V;var U=k.channels(),G=U[0],H=U[1],j=U[2],W=U[3],q=h?il.LINEAR:il.CONSTANT,X=function(t,e,i){return{value:t,leftTangent:e,rightTangent:i,interpolationMode:q}};switch(V){case 4:W.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.w,t.inTangent.w,t.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.z,t.inTangent.z,t.outTangent.z)})));default:G.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.y,t.inTangent.y,t.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.x,t.inTangent.x,t.outTangent.x)})))}return void e.push(k);case c.every((function(t){return t instanceof XF})):D(3935)}var Y=new nV;f(Y),Y.channel.curve.assignSorted(l,c),e.push(Y)}()},c=st(n);!(t=c()).done;)s();return e},e._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map((function(e){return new aV(e.map((function(e){return e/t._duration})))})),this._runtimeCurves=this._curves.map((function(e){return{curve:new sV(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}}))},Q(t,[{key:"keys",get:function(){return this._keys},set:function(t){this._keys=t}},{key:"curves",get:function(){return this._curves},set:function(t){this._curves=t,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(t){this._commonTargets=t}},{key:"data",get:function(){return this._data}}]),t}();function CV(t,e){return t.every((function(t){return t instanceof e}))}var AV=function(){function t(t,e){this._easingMethods=void 0;var i=t.easingMethods;Array.isArray(i)?0===i.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(e).fill(t.easingMethod):Array.from({length:e},(function(t,e){var n;return null!==(n=i[e])&&void 0!==n?n:null}))}var e=t.prototype;return e.convert=function(t){var e,i,n,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S,b,C=this._easingMethods;if(C){var A=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(C)&&C.length;for(var T=A-1,w=0;w<T;++w){var E=C[w];E&&(Array.isArray(E)?(e=E,i=t.getKeyframeTime(w),n=t.getKeyframeValue(w),r=t.getKeyframeTime(w+1),o=t.getKeyframeValue(w+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,b=void 0,s=e[0],c=e[1],l=e[2],u=e[3],h=n.value,_=3*(r-i),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(d=c*f)/(p=s*_),x=Math.sqrt(p*p+d*d)*g,S=v/m,b=Math.sqrt(m*m+v*v)*g,n.interpolationMode=il.CUBIC,n.tangentWeightMode=(a=n.tangentWeightMode)===rl.NONE?rl.RIGHT:a===rl.LEFT?rl.BOTH:a,n.rightTangent=y,n.rightTangentWeight=x,o.tangentWeightMode=function(t){return t===rl.NONE?rl.LEFT:t===rl.RIGHT?rl.BOTH:t}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=b):TV(E,t,w))}}}},e.convertQuatCurve=function(t){var e=this._easingMethods;if(e){var i=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(e)&&e.length;for(var n=i-1,r=0;r<n;++r){var o=e[r];o&&(Array.isArray(o)?t.getKeyframeValue(r).easingMethod=o.slice():wV(o,t,r))}}}},Q(t,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(t){return null==t}))}}]),t}();function TV(t,e,i){e.keyFramesCount;var n=e.getKeyframeValue(i),r=ik[t];r===$_.CONSTANT?n.interpolationMode=il.CONSTANT:(n.interpolationMode=il.LINEAR,n.easingMethod=r)}function wV(t,e,i){e.keyFramesCount;var n=e.getKeyframeValue(i),r=ik[t];n.easingMethod=r}var EV,PV,IV,RV,DV,MV,OV,BV,NV,LV,FV,zV,VV,kV,UV,GV,HV,jV,WV,qV,XV,YV,KV,JV,QV,ZV,$V,tk,ek,ik={constant:$_.CONSTANT,linear:$_.LINEAR,quadIn:$_.QUAD_IN,quadOut:$_.QUAD_OUT,quadInOut:$_.QUAD_IN_OUT,quadOutIn:$_.QUAD_OUT_IN,cubicIn:$_.CUBIC_IN,cubicOut:$_.CUBIC_OUT,cubicInOut:$_.CUBIC_IN_OUT,cubicOutIn:$_.CUBIC_OUT_IN,quartIn:$_.QUART_IN,quartOut:$_.QUART_OUT,quartInOut:$_.QUART_IN_OUT,quartOutIn:$_.QUART_OUT_IN,quintIn:$_.QUINT_IN,quintOut:$_.QUINT_OUT,quintInOut:$_.QUINT_IN_OUT,quintOutIn:$_.QUINT_OUT_IN,sineIn:$_.SINE_IN,sineOut:$_.SINE_OUT,sineInOut:$_.SINE_IN_OUT,sineOutIn:$_.SINE_OUT_IN,expoIn:$_.EXPO_IN,expoOut:$_.EXPO_OUT,expoInOut:$_.EXPO_IN_OUT,expoOutIn:$_.EXPO_OUT_IN,circIn:$_.CIRC_IN,circOut:$_.CIRC_OUT,circInOut:$_.CIRC_IN_OUT,circOutIn:$_.CIRC_OUT_IN,elasticIn:$_.ELASTIC_IN,elasticOut:$_.ELASTIC_OUT,elasticInOut:$_.ELASTIC_IN_OUT,elasticOutIn:$_.ELASTIC_OUT_IN,backIn:$_.BACK_IN,backOut:$_.BACK_OUT,backInOut:$_.BACK_IN_OUT,backOutIn:$_.BACK_OUT_IN,bounceIn:$_.BOUNCE_IN,bounceOut:$_.BOUNCE_OUT,bounceInOut:$_.BOUNCE_IN_OUT,bounceOutIn:$_.BOUNCE_OUT_IN,smooth:$_.SMOOTH,fade:$_.FADE};function nk(){throw new Error("split() only valid in Editor.")}pc("cc.animation.ExoticAnimation")((IV=function(){function t(){ct(this,"_nodeAnimations",PV,this)}var e=t.prototype;return e.createEvaluator=function(t){return new fk(this._nodeAnimations,t)},e.addNodeAnimation=function(t){var e=new rk(t);return this._nodeAnimations.push(e),e},e.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(t){return t.path}))))},e.split=function(){return nk()},e.toHashString=function(){return this._nodeAnimations.map((function(t){return t.toHashString()})).join("\n")},t}(),PV=lt((EV=IV).prototype,"_nodeAnimations",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EV));var rk=pc("cc.animation.ExoticNodeAnimation")((LV=function(){function t(t){ct(this,"_path",MV,this),ct(this,"_position",OV,this),ct(this,"_rotation",BV,this),ct(this,"_scale",NV,this),this._path=t}var e=t.prototype;return e.createPosition=function(t,e){this._position=new uk(t,new ck(e))},e.createRotation=function(t,e){this._rotation=new uk(t,new lk(e))},e.createScale=function(t,e){this._scale=new uk(t,new ck(e))},e.createEvaluator=function(t){return new pk(this._path,this._position,this._rotation,this._scale,t)},e.split=function(){return nk()},e.toHashString=function(){var t,e,i,n,r,o;return this._path+"\n"+(null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"")+(null!==(i=null===(n=this._scale)||void 0===n?void 0:n.toHashString())&&void 0!==i?i:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},Q(t,[{key:"path",get:function(){return this._path}}]),t}(),MV=lt((DV=LV).prototype,"_path",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OV=lt(DV.prototype,"_position",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BV=lt(DV.prototype,"_rotation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NV=lt(DV.prototype,"_scale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RV=DV))||RV;function ok(t){return t.toPrecision(2)}function ak(t){return t.map(ok).join(" ")}var sk=pc("cc.animation.ExoticVectorLikeTrackValues")((UV=function(){function t(t){ct(this,"_values",VV,this),ct(this,"_isQuantized",kV,this),this._values=t,this._isQuantized=!1}var e=t.prototype;return e.quantize=function(t){this._isQuantized,this._values=function(t,e){var i=mk[e],n=1<<i.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;t.forEach((function(t){r=Math.min(t,r),o=Math.max(t,o)}));var a=o-r,s=i.from(t,(function(t){return(t-r)/a*n}));return new Dk(vk(t),s,a,r)}(this._values,t),this._isQuantized=!0},e.toHashString=function(){var t=this._isQuantized,e=this._values;return t+" "+(t?e.toHashString():ak(e))},Q(t,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:vk(this._values)}}]),t}(),VV=lt((zV=UV).prototype,"_values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kV=lt(zV.prototype,"_isQuantized",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),FV=zV))||FV,ck=pc("cc.animation.ExoticVec3TrackValues")(GV=function(t){function e(){return t.apply(this,arguments)||this}$(e,t),e.imitate=function(t,i){var n=new e(t);return i._isQuantized&&n.quantize(i._values.quantizationType),n};var i=e.prototype;return i.get=function(t,e){var i=this._values;this._isQuantized?Bk(i,t,e):Ei.fromArray(e,i,3*t)},i.lerp=function(t,e,i,n,r,o){var a=this._values;this._isQuantized?(Bk(a,t,n),Bk(a,e,r)):(Ei.fromArray(n,a,3*t),Ei.fromArray(r,a,3*e)),Ei.lerp(o,n,r,i)},e}(sk))||GV,lk=pc("cc.animation.ExoticQuatTrackValues")(HV=function(t){function e(){return t.apply(this,arguments)||this}$(e,t),e.imitate=function(t,i){var n=new e(t);return i._isQuantized&&n.quantize(i._values.quantizationType),n};var i=e.prototype;return i.get=function(t,e){var i=this._values;this._isQuantized?Nk(i,t,e):Bi.fromArray(e,i,4*t)},i.lerp=function(t,e,i,n,r,o){var a=this._values;this._isQuantized?(Nk(a,t,n),Nk(a,e,r)):(Bi.fromArray(n,a,4*t),Bi.fromArray(r,a,4*e)),Bi.slerp(o,n,r,i)},e}(sk))||HV,uk=pc("cc.animation.ExoticTrack")((YV=function(){function t(t,e){ct(this,"times",qV,this),ct(this,"values",XV,this),this.times=t,this.values=e}return t.prototype.toHashString=function(){var t=this.times,e=this.values;return"times: "+ak(t)+"; values: "+e.toHashString()},t}(),qV=lt((WV=YV).prototype,"times",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XV=lt(WV.prototype,"values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jV=WV))||jV;function hk(t,e){t.length,t.length;var i=0,n=0,r=oc(t,e);if(r>=0)i=r;else{var o=~r,a=o-1;i=a;var s=t[o],c=t[a];n=(e-c)/(s-c)}return{index:i,ratio:n}}!function(){function t(){this._reset()}var e=t.prototype;e.transformTime=function(t){return t-this._timeOffset},e.calculate=function(t,e,i){this._reset();var n=t.length;if(n){var r=t[0],o=t[n-1],a=ai(e,r,o),s=ai(i,r,o);this._timeOffset=a;var c=function(t,e,i){var n=t.length;i>=e&&e>=t[0]&&t[n-1];var r=hk(t,e),o=r.index,a=r.ratio,s=hk(t,i);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(t,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,p=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},e._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},Q(t,[{key:"keyframesCount",get:function(){var t=this.preLerpIndex,e=this.directKeyframesBegin;return 0+(t<0?0:1)+(this.directKeyframesEnd-e)+(this.postLerpIndex<0?0:1)}}])}();var _k,fk=function(){function t(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(t){return t.createEvaluator(e)}))}return t.prototype.evaluate=function(t){this._nodeEvaluations.forEach((function(e){e.evaluate(t)}))},t}(),pk=function(){function t(t,e,i,n,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=Ok(e.times,e.values,Ei,t,"position",r)),i&&(this._rotation=Ok(i.times,i.values,Bi,t,"rotation",r)),n&&(this._scale=Ok(n.times,n.values,Ei,t,"scale",r))}return t.prototype.evaluate=function(t){if(this._position){var e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){var i=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(i)}if(this._scale){var n=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(n)}},t}(),dk=function(){function t(t,e,i){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}return t.prototype.evaluate=function(t){var e=this._times,i=this._values,n=this._resultValue;if(0===e.length)return n;var r=function(t,e,i){var n=t.length,r=t[0],o=t[n-1];if(e<r)i.just=!0,i.index=0;else if(e>o)i.just=!0,i.index=n-1;else{var a=oc(t,e);if(a>=0)i.just=!0,i.index=a;else{var s=~a,c=s-1,l=t[c],u=t[s],h=(e-t[c])/(u-l);i.just=!1,i.index=c,i.nextIndex=s,i.ratio=h}}return i}(e,t,this._inputSampleResultCache);return r.just?i.get(r.index,n):i.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,n),n},t}(),mk={uint8:Uint8Array,uint16:Uint16Array};function vk(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return _k.FLOAT_32;case 8:return _k.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(_k||(_k={}));var gk,yk,xk,Sk,bk,Ck,Ak,Tk,wk,Ek,Pk,Ik,Rk,Dk=pc("cc.animation.QuantizedFloatArray")((ek=function(){function t(t,e,i,n){void 0===n&&(n=0),ct(this,"originalPrecision",QV,this),ct(this,"min",ZV,this),ct(this,"extent",$V,this),ct(this,"values",tk,this),this.originalPrecision=t,this.values=e,this.extent=i,this.min=n}return t.prototype.toHashString=function(){var t=this.originalPrecision,e=this.min,i=this.extent,n=this.values;return t+" "+ok(e)+" "+ok(i)+" "+n.join(" ")},Q(t,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),t}(),QV=lt((JV=ek).prototype,"originalPrecision",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZV=lt(JV.prototype,"min",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$V=lt(JV.prototype,"extent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tk=lt(JV.prototype,"values",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KV=JV))||KV;function Mk(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function Ok(t,e,i,n,r,o){var a=new Ez;a.path=(new wz).toHierarchy(n).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new dk(t,e,i)}:null}function Bk(t,e,i){Ei.set(i,Mk(t,3*e+0),Mk(t,3*e+1),Mk(t,3*e+2))}function Nk(t,e,i){Bi.set(i,Mk(t,4*e+0),Mk(t,4*e+1),Mk(t,4*e+2),Mk(t,4*e+3))}var Lk=Symbol("SearchForRootBonePath"),Fk=Symbol("ExoticAnimation"),zk=t("AnimationClip",pc("cc.AnimationClip")((Rk=Ik=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"sample",xk,ot(e)),ct(e,"speed",Sk,ot(e)),ct(e,"wrapMode",bk,ot(e)),ct(e,"enableTrsBlending",Ck,ot(e)),ct(e,"_duration",Ak,ot(e)),ct(e,"_hash",Tk,ot(e)),e.frameRate=0,ct(e,"_tracks",wk,ot(e)),ct(e,"_exoticAnimation",Ek,ot(e)),e._legacyData=void 0,e._legacyDataDirty=!1,ct(e,"_events",Pk,ot(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}$(e,t),e.createWithSpriteFrames=function(t,i){var n=new e;n.sample=i||n.sample,n.duration=t.length/n.sample;var r=1/n.sample,o=new nV;return o.path=(new wz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map((function(t,e){return[r*e,t]}))),n.addTrack(o),n};var i=e.prototype;return i.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},i.range=function(){for(var t={min:1/0,max:-1/0},e=this._tracks,i=e.length,n=0;n<i;++n){var r=e[n].range();t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max)}return t},i.getTrack=function(t){return this._tracks[t]},i.addTrack=function(t){var e=this._tracks.length;return this._tracks.push(t),e},i.removeTrack=function(t){this._tracks.splice(t,1)},i.clearTracks=function(){this._tracks.length=0},i.createEventEvaluator=function(t){return new qk(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},i.createEvaluator=function(t){var e=this,i=t.target;return this._createEvalWithBinder(i,(function(n){var r=n.createRuntimeBinding(i,e.enableTrsBlending?t.pose:void 0,!1);return null!=r?r:void 0}),t.rootMotion)},i.destroy=function(){var e;return(null===(e=u.director.root)||void 0===e?void 0:e.dataPoolManager)&&u.director.root.dataPoolManager.releaseAnimationClip(this),oV.destroy(this),t.prototype.destroy.call(this)},i[rV]=function(t,e,i){for(var n=1/e,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:i},(function(){return new Gi}))};var c=r.reduce((function(t,e){return t[e]=new Uk,t}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var p=this._createEvalWithBinder(void 0,(function(t){var e=t.parseTrsPath();if(e){var i=c[e.node];if(i)return Wk(i,e.property)}}),void 0),d=0;d<i;++d){var m=t+n*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Gi.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:e,frames:i,joints:a}},i.upgradeUntypedTracks=function(t){for(var e=[],i=[],n=this._tracks,r=n.length,o=0;o<r;++o){var a=n[o];if(a instanceof SV){var s=a.upgrade(t);s&&(e.push(s),i.push(a))}}for(var c=i.length,l=0;l<c;++l)ie.remove(n,i[l]);n.push.apply(n,e)},i[Lk]=function(){return this._searchForRootBonePath()},i.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},i.updateEventDatas=function(){this.events=this._events},i.hasEvents=function(){return 0!==this.events.length},i.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},i._createEvalWithBinder=function(t,e,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var n,r=[];i&&(n=this._createRootMotionEvaluation(t,i,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(t){return 0===t.curve.keyFramesCount}))){var h=e(u[Tz]);if(h){var _=u[bz](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new Vk(a,o,n)},i._createRootMotionEvaluation=function(t,e,i){if(t instanceof jT){var n=this._searchForRootBonePath();if(n){var r=t.getChildByPath(n);if(r){for(var o=new kk,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Tz].parseTrsPath();if(h&&h.node===n){i.push(u);var _=Wk(o,h.property);if(_){var f=u[bz](_);a.push({binding:_,trackEval:f})}}}return new Hk(r,this._duration,o,a)}D(3924)}else D(3923)}else O(3920)},i._searchForRootBonePath=function(){var t=this._tracks.map((function(t){var e=t[Tz].parseTrsPath();if(e){var i=e.node;return{path:i,rank:i.split("/").length}}return{path:"",rank:0}}));t.sort((function(t,e){return t.rank-e.rank}));var e=t.findIndex((function(t){return 0!==t.rank}));if(e<0)return"";for(var i=t.length,n=t[e],r=!0,o=e+1;o<i;++o){var a=t[o];if(a.rank!==n.rank)break;if(a.path!==n.path){r=!1;break}}return r?n.path:""},i._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},i._toLegacy=function(){var t=new bV(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t},i._fromLegacy=function(t){for(var e=t.toTracks(),i=e.length,n=0;n<i;++n)this.addTrack(e[n])},i._collectAnimatedJoints=function(){for(var t=new Set,e=this._tracks,i=e.length,n=0;n<i;++n){var r=e[n][Tz].parseTrsPath();r&&t.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)t.add(o[s]);return Array.from(t)},Q(e,[{key:"duration",get:function(){return this._duration},set:function(t){this._duration=t}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var t,e;if(this._hash)return this._hash;var i="Exotic:"+(null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"");return this._hash=go(i,666)}},{key:"events",get:function(){return this._events},set:function(t){var e=this;this._events=t;for(var i=[],n=[],r=this.events.sort((function(t,e){return t.frame-e.frame})),o=r.length,a=function(t){var o=r[t],a=o.frame/e._duration,s=i.findIndex((function(t){return t===a}));s<0&&(s=i.length,i.push(a),n.push({events:[]})),n[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:i,eventGroups:n}}},{key:Fk,get:function(){return this._exoticAnimation}},{key:Fk,set:function(t){this._exoticAnimation=t}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(t){this._getLegacyData().curves=t}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),e}(Mu),Ik.WrapMode=$s,xk=lt((yk=Rk).prototype,"sample",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Sk=lt(yk.prototype,"speed",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bk=lt(yk.prototype,"wrapMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $s.Normal}}),Ck=lt(yk.prototype,"enableTrsBlending",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ak=lt(yk.prototype,"_duration",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tk=lt(yk.prototype,"_hash",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wk=lt(yk.prototype,"_tracks",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ek=lt(yk.prototype,"_exoticAnimation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pk=lt(yk.prototype,"_events",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gk=yk))||gk);u.AnimationClip=zk;var Vk=function(){function t(t,e,i){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=i}var e=t.prototype;return e.evaluate=function(t){for(var e=this._trackEvalStatues,i=this._exoticAnimationEvaluator,n=e.length,r=0;r<n;++r){var o=e[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}i&&i.evaluate(t)},e.evaluateRootMotion=function(t,e){var i=this._rootMotionEvaluation;i&&i.evaluate(t,e)},t}(),kk=function(){function t(){this.position=new Ei,this.scale=new Ei(1,1,1),this.rotation=new Bi,this.eulerAngles=new Ei}return t.prototype.getTransform=function(t){Gi.fromRTS(t,this.rotation,this.position,this.scale)},t}(),Uk=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).parent=null,e._dirty=!0,e._transform=new Gi,e}return $(e,t),e.prototype.invalidate=function(){this._dirty=!0},Q(e,[{key:"globalTransform",get:function(){var t=this._transform;return this._dirty&&(this._dirty=!1,Gi.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Gi.multiply(t,this.parent.globalTransform,t)),this._transform}}]),e}(kk),Gk=new Gi,Hk=function(){function t(t,e,i,n){this._initialTransformCache=new Gi,this._clipEndTransformCache=new Gi,this._startTransformCache=new Gi,this._endTransformCache=new Gi,this._motionTransformCache=new Gi,this._translationMotionCache=new Ei,this._rotationMotionCache=new Bi,this._scaleMotionCache=new Ei,this._rootBone=t,this._duration=e,this._boneTransform=i,this._trackEvalStatuses=n}var e=t.prototype;return e.evaluate=function(t,e){var i=this._calcMotionTransform(t,e,this._motionTransformCache),n=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Gi.toRTS(i,r,n,o),Ei.add(n,n,a.position),a.setPosition(n),Bi.multiply(r,r,a.rotation),a.setRotation(r),Ei.multiply(o,o,a.scale),a.setScale(o)},e._calcMotionTransform=function(t,e,i){var n=this._duration,r=n-t,o=this._evaluateAt(t,this._startTransformCache);if(e<r){var a=this._evaluateAt(t+e,this._endTransformCache);jk(i,o,a)}else{Gi.identity(i);var s=function(t,e){jk(Gk,t,e),Gi.multiply(i,i,Gk)},c=e-r,l=Math.floor(c/n),u=c-l*n,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(n,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),jk(Gk,h,_);for(var p=0;p<l;++p)Gi.multiply(i,i,Gk);s(h,f)}return i},e._evaluateAt=function(t,e){for(var i=this._trackEvalStatuses,n=i.length,r=0;r<n;++r){var o=i[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}return this._boneTransform.getTransform(e),e},t}();function jk(t,e,i){Gi.invert(t,e),Gi.multiply(t,i,t)}function Wk(t,e){switch(e){default:return;case"position":return{setValue:function(e){Ei.copy(t.position,e)}};case"rotation":return{setValue:function(e){Bi.copy(t.rotation,e)}};case"scale":return{setValue:function(e){Ei.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){Ei.copy(t.eulerAngles,e)}}}}var qk=function(){function t(t,e,i,n){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=i,this._wrapMode=n}var e=t.prototype;return e.setWrapMode=function(t){this._wrapMode=t},e.ignore=function(t,e){this._ignoreIndex=-1,this._sampled=!1;var i=Yk(t,this._ratios);i<0&&(i=~i-1,e<0&&(i+=1),this._ignoreIndex=i)},e.sample=function(t,e,i){var n=this._eventGroups.length,r=Yk(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=i,void(this._lastDirection=e);var o=this._wrapMode,a=Xk(i),s=Xk(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===n)this._doFire(0,!1);else if(c!==r||u){e=l;do{if(c!==r){if(-1===e&&0===c&&r>0?((o&Zs.PingPong)===Zs.PingPong?e*=-1:c=n,s++):1===e&&c===n-1&&r<n-1&&((o&Zs.PingPong)===Zs.PingPong?e*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=e,this._doFire(c,!0)}while(c!==r&&c>-1&&c<n)}this._lastFrameIndex=r,this._lastIterations=i,this._lastDirection=e},e._doFire=function(t,e){e?u.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)},e._checkAndFire=function(t){if(this._targetNode&&this._targetNode.isValid){var e=this._eventGroups;if(!(t<0||t>=e.length||this._ignoreIndex===t))for(var i=e[t],n=this._targetNode.components,r=i.events.length,o=0;o<r;++o)for(var a=i.events[o],s=a.functionName,c=n.length,l=0;l<c;++l){var u=n[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},t}();function Xk(t){return t-(0|t)==0&&(t-=1),0|t}function Yk(t,e){return oc(e,t)}var Kk,Jk=function(){function t(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var e=t.prototype;return e.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(F(3912)):(this._isPlaying=!0,this.onPlay())},e.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},e.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},e.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},e.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},e.update=function(){},e.onPlay=function(){},e.onPause=function(){},e.onResume=function(){},e.onStop=function(){},e.onError=function(){},Q(t,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),t}(),Qk=function(){function t(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0},e.createPoseWriter=function(t,e,i){var n=this._pose.createWriter(t,e,this,i);return this._blendStateWriters.push(n),n},t}();!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(Kk||(Kk={})),ce(Kk);var Zk=t("AnimationState",function(t){function e(e,i){var n;return void 0===i&&(i=""),(n=t.call(this)||this).duration=1,n.speed=1,n.time=0,n.frameRate=0,n._targetNode=null,n._curveLoaded=!1,n._clip=void 0,n._useSimpleProcess=!1,n._target=null,n._wrapMode=$s.Normal,n._repeatCount=1,n._delay=0,n._delayTime=0,n._currentFramePlayed=!1,n._name=void 0,n._lastIterations=NaN,n._lastWrapInfo=null,n._wrappedInfo=new rc,n._allowLastFrame=!1,n._blendStateWriterHost={weight:0},n._playbackDuration=0,n._invDuration=1,n._poseOutput=null,n._weight=1,n._clipEval=void 0,n._clipEventEval=void 0,n._doNotCreateEval=!1,n._clip=e,n._name=i||e&&e.name,n._playbackRange={min:0,max:e.duration},n._playbackDuration=e.duration,e.duration||A("Clip "+e.name+" has zero duration."),n}$(e,t);var i=e.prototype;return i.initialize=function(t,e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;var i=this._clip;if(this.duration=i.duration,this._invDuration=1/this.duration,this.speed=i.speed,this.wrapMode=i.wrapMode,this.frameRate=i.sample,this._playbackRange.min=0,this._playbackRange.max=i.duration,this._playbackDuration=i.duration,(this.wrapMode&Zs.Loop)===Zs.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var n,r,o,a=null!==(n=null!=e?e:null===(r=u.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==n?n:null;a&&(this._poseOutput=new Qk(a)),this._clipEval=i.createEvaluator({target:t,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=i.createEventEvaluator(this._targetNode)}},i.destroy=function(){this.isMotionless||u.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},i.emit=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];u.director.getAnimationManager().pushDelayEvent(this._emit,this,e)},i.on=function(t,e,i){return this._target&&this._target.isValid?this._target.on(t,e,i):null},i.once=function(t,e,i){return this._target&&this._target.isValid?this._target.once(t,e,i):null},i.off=function(t,e,i){this._target&&this._target.isValid&&this._target.off(t,e,i)},i.allowLastFrameEvent=function(t){this._allowLastFrame=t},i._setEventTarget=function(t){this._target=t},i.setTime=function(t){this._currentFramePlayed=!1,this.time=t||0;var e,i=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(i.ratio,i.direction)},i.update=function(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())},i.sample=function(){var t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t},i.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(Kk.PLAY,this)},i.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(Kk.STOP,this)},i.onResume=function(){this._onReplayOrResume(),this.emit(Kk.RESUME,this)},i.onPause=function(){this._onPauseOrStop(),this.emit(Kk.PAUSE,this)},i._sampleCurves=function(t){var e=this._poseOutput,i=this._clipEval;e&&(e.weight=this.weight),i&&i.evaluate(t)},i._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},i.process=function(){var t,e=this.sample();this._allowLastFrame&&(t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new rc(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(Kk.LASTFRAME,this),t.set(e)),e.stopped&&(this.stop(),this.emit(Kk.FINISHED,this))},i.simpleProcess=function(){var t=this._playbackRange.min,e=this._playbackDuration,i=this.time%e;i<0&&(i+=e);var n=(t+i)*this._invDuration;this._sampleCurves(t+i),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(Kk.LASTFRAME,this),this._lastIterations=n)},i._needReverse=function(t){var e=this.wrapMode,i=!1;return(e&Zs.PingPong)===Zs.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(i=!i)),(e&Zs.Reverse)===Zs.Reverse&&(i=!i),i},i.getWrappedInfo=function(t,e){e=e||new rc;var i=this._getPlaybackStart(),n=this._getPlaybackEnd()-i,r=!1,o=this.repeatCount,a=(t-=i)>0?t/n:-t/n;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),t=s*n*(t>0?1:-1)}if(t>n){var c=t%n;t=0===c?n:c}else t<0&&0!=(t%=n)&&(t+=n);var l=!1,u=this._wrapMode&Zs.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(t=n-t),e.time=i+t,e.ratio=e.time/this.duration,e.direction=h,e.stopped=r,e.iterations=a,e},i._getPlaybackStart=function(){return this._playbackRange.min},i._getPlaybackEnd=function(){return this._playbackRange.max},i._sampleEvents=function(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)},i._emit=function(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)},i._onReplayOrResume=function(){u.director.getAnimationManager().addAnimation(this)},i._onPauseOrStop=function(){u.director.getAnimationManager().removeAnimation(this)},Q(e,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(t){var e;this._wrapMode=t,this.time=0,t&Zs.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t;var e=this._wrapMode&Zs.ShouldWrap,i=(this.wrapMode&Zs.Reverse)===Zs.Reverse;this._useSimpleProcess=t===1/0&&!e&&!i}},{key:"delay",get:function(){return this._delay},set:function(t){this._delayTime=this._delay=t}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),e}(Jk));u.AnimationState=Zk;var $k,tU,eU,iU,nU,rU,oU,aU,sU,cU,lU,uU,hU,_U,fU,pU,dU,mU=function(t){function e(e){var i;return(i=t.call(this)||this)._managedStates=[],i._fadings=[],i._scheduled=!1,i._scheduler=null!=e?e:u.director.getAnimationManager(),i}$(e,t);var i=e.prototype;return i.update=function(t){if(!this.isMotionless){var e=this._managedStates,i=this._fadings;if(1===e.length&&1===i.length){var n=e[0].state;n&&(n.weight=1)}else this._calculateWeights(t);1===e.length&&1===i.length&&this._unscheduleThis()}},i.crossFade=function(t,e){var i;0===this._managedStates.length&&(e=0),0===e&&this.clear();var n=this._managedStates.find((function(e){return e.state===t}));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:t,reference:0},t&&t.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:n}),this.isMotionless||this._scheduleThis()},i.clear=function(){for(var t=0;t<this._managedStates.length;++t){var e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0},i.onPlay=function(){t.prototype.onPlay.call(this),this._scheduleThis()},i.onPause=function(){t.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.pause()}this._unscheduleThis()},i.onResume=function(){t.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.resume()}this._scheduleThis()},i.onStop=function(){t.prototype.onStop.call(this),this.clear()},i._calculateWeights=function(t){for(var e=this._managedStates,i=this._fadings,n=0;n<e.length;++n){var r=e[n].state;r&&(r.weight=0)}for(var o=1,a=i.length,s=0;s<i.length;++s){var c=i[s];c.easeTime+=t;var l=0===c.easeDuration?1:si(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==i.length){for(var h=a;h<i.length;++h){var _=i[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),ft(this._managedStates,_.target))}i.splice(a)}},i._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},i._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},e}(Jk),vU=function(e){return t({AnimationComponent:e,Animation:e}),e}(($k=pc("cc.Animation"),tU=Rc(),eU=mc(99),iU=wc(),nU=Kc([zk]),rU=Nc(),oU=Kc(zk),aU=Nc(),sU=Nc(),cU=Kc([zk]),$k(lU=tU(lU=eU(lU=Tc(lU=iU((dU=pU=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"playOnLoad",hU,ot(e)),e._crossFade=new mU,e._nameToState=Pt(!0),ct(e,"_clips",_U,ot(e)),ct(e,"_defaultClip",fU,ot(e)),e._hasBeenPlayed=!1,e}$(e,t);var i=e.prototype;return i.onLoad=function(){for(var t in this.clips=this._clips,this._nameToState)this._nameToState[t].initialize(this.node)},i.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},i.onEnable=function(){this._crossFade.resume()},i.onDisable=function(){this._crossFade.pause()},i.onDestroy=function(){for(var t in this._crossFade.stop(),this._nameToState)this._nameToState[t].destroy();this._nameToState=Pt(!0)},i.play=function(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)},i.crossFade=function(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;var i=this._nameToState[t];i&&this.doPlayOrCrossFade(i,e)},i.pause=function(){this._crossFade.pause()},i.resume=function(){this._crossFade.resume()},i.stop=function(){this._crossFade.stop()},i.getAnimationState=function(t){return this.getState(t)},i.getState=function(t){var e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},i.createState=function(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)},i.removeState=function(t){var e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])},i.addClip=function(t,e){return pt(this._clips,t)||this._clips.push(t),this.createState(t,e)},i.removeClip=function(t,e){var i;for(var n in this._nameToState){var r=this._nameToState[n];if(r.clip===t){i=r;break}}if(t===this._defaultClip){if(!e)return void D(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void D(3903);i.stop()}this._clips=this._clips.filter((function(e){return e!==t})),i&&delete this._nameToState[i.name]},i.on=function(e,i,n,r){var o=t.prototype.on.call(this,e,i,n,r);return e===Kk.LASTFRAME&&this._syncAllowLastFrameEvent(),o},i.once=function(e,i,n){var r=t.prototype.once.call(this,e,i,n);return e===Kk.LASTFRAME&&this._syncAllowLastFrameEvent(),r},i.off=function(e,i,n){t.prototype.off.call(this,e,i,n),e===Kk.LASTFRAME&&this._syncDisallowLastFrameEvent()},i._createState=function(t,e){return new Zk(t,e)},i._doCreateState=function(t,e){var i=this._createState(t,e);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(Kk.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i},i.doPlayOrCrossFade=function(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)},i._removeStateOfAutomaticClip=function(t){for(var e in this._nameToState){var i=this._nameToState[e];gU(t,i.clip)&&(i.stop(),delete this._nameToState[e])}},i._syncAllowLastFrameEvent=function(){if(this.hasEventListener(Kk.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)},i._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(Kk.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)},Q(e,[{key:"clips",get:function(){return this._clips},set:function(t){var e=this;this._crossFade&&this._crossFade.clear();for(var i,n=st(this._clips);!(i=n()).done;){var r=i.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=st(t);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=t.find((function(t){return gU(t,e._defaultClip)}));this._defaultClip=c||null,this._clips=t}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){this._defaultClip=t,t&&(this._clips.findIndex((function(e){return gU(e,t)}))>=0||(this._clips.push(t),this.createState(t)))}}]),e}(tu($u)),pU.EventType=Kk,lt((uU=dU).prototype,"clips",[nU,rU],Object.getOwnPropertyDescriptor(uU.prototype,"clips"),uU.prototype),lt(uU.prototype,"defaultClip",[oU,aU],Object.getOwnPropertyDescriptor(uU.prototype,"defaultClip"),uU.prototype),hU=lt(uU.prototype,"playOnLoad",[xc,sU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_U=lt(uU.prototype,"_clips",[cU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fU=lt(uU.prototype,"_defaultClip",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lU=uU))||lU)||lU)||lU)||lU)||lU));function gU(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}u.Animation=vU,k(vU.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var t=arguments.length<=0?void 0:arguments[0];return vU.prototype.removeState.call(this,t.name)}}]),u.AnimationComponent=vU,ne.setClassAlias(vU,"cc.AnimationComponent");var yU,xU,SU,bU=function(){function t(){this._nodeBlendStates=new Map}var e=t.prototype;return e.createWriter=function(t,e,i,n){var r=this.ref(t,e);return new CU(t,e,r,i,n)},e.destroyWriter=function(t){var e=t;this.deRef(e.node,e.property)},e.ref=function(t,e){var i=this._nodeBlendStates.get(t);return i||(i=new EU,this._nodeBlendStates.set(t,i)),i.refProperty(e)},e.deRef=function(t,e){var i=this._nodeBlendStates.get(t);i&&(i.deRefProperty(e),i.empty&&this._nodeBlendStates.delete(t))},e.apply=function(){this._nodeBlendStates.forEach((function(t,e){t.apply(e)}))},t}(),CU=function(){function t(t,e,i,n,r){this._node=t,this._property=e,this._propertyBlendState=i,this._host=n,this._constants=r}var e=t.prototype;return e.getValue=function(){return this._node[this._property]},e.setValue=function(t){var e=this._propertyBlendState,i=this._host.weight;e.blend(t,i)},Q(t,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),t}(),AU=function(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},TU=function(t){function e(){return t.call(this,new Ei)||this}$(e,t);var i=e.prototype;return i.blend=function(t,e){var i=this.blendedValue;1===e?Ei.copy(i,t):Ei.scaleAndAdd(i,i,t,e),this.blendedWeight+=e},i.reset=function(){this.blendedWeight=0,Ei.zero(this.blendedValue)},e}(AU),wU=function(t){function e(){return t.call(this,new Bi)||this}$(e,t);var i=e.prototype;return i.blend=function(t,e){if(0!==e){var i=this.blendedValue,n=this.blendedWeight;if(1===e)Bi.copy(i,t);else{var r=e/(n+e);Bi.slerp(i,i,t,r)}this.blendedWeight+=e}},i.reset=function(){this.blendedWeight=0,Bi.identity(this.blendedValue)},e}(AU),EU=function(){function t(){this._properties={}}var e=t.prototype;return e.refProperty=function(t){var e,i,n,r=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":n=null!==(e=r[t])&&void 0!==e?e:r[t]=new TU;break;case"rotation":n=null!==(i=r[t])&&void 0!==i?i:r[t]=new wU}return++n.refCount,n},e.deRefProperty=function(t){var e=this._properties,i=e[t];i&&(--i.refCount,i.refCount>0||delete e[t])},e.apply=function(t){var e,i,n,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(t.position,1-o.blendedWeight),e=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(t.scale,1-a.blendedWeight),i=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(t.eulerAngles,1-c.blendedWeight),n=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(t.rotation,1-s.blendedWeight),n=s.blendedValue),(n||e||i)&&t.setRTS(n,e,i),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},Q(t,[{key:"empty",get:function(){var t=this._properties;return!(t.position||t.rotation||t.eulerAngles||t.scale)}}]),t}(),PU=[],IU=new Map;function RU(t,e){for(var i=0,n=Gi.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){n=t.world,t.stamp=e;break}t.stamp=e,PU[i++]=t,t=t.parent}for(;i>0;){t=PU[--i],PU[i]=null;var r=t.node;Gi.fromRTS(t.local,r.rotation,r.position,r.scale),n=Gi.multiply(t.world,n,t.local)}return n}function DU(t,e){for(var i,n=null,r=0;t!==e;){var o=t.uuid;if(IU.has(o)){n=IU.get(o);break}n={node:t,local:new Gi,world:new Gi,stamp:-1,parent:null},IU.set(o,n),PU[r++]=n,t=t.parent,n=null}for(;r>0;)i=PU[--r],PU[r]=null,i.parent=n,n=i;return n}function MU(t){for(var e=IU.get(t.uuid)||null;e;)IU.delete(e.node.uuid),e=e.parent}var OU=t("AnimationManager",pc((SU=xU=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._anims=new ut([]),e._crossFades=new ut([]),e._delayEvents=[],e._blendStateBuffer=new bU,e._sockets=[],e}$(e,t);var i=e.prototype;return i.addCrossFade=function(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)},i.removeCrossFade=function(t){var e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):O(3907)},i.update=function(t){var e=this._delayEvents,i=this._crossFades,n=this._sockets,r=i.array;for(i.i=0;i.i<r.length;++i.i)r[i.i].update(t);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(t)}this._blendStateBuffer.apply();for(var c=u.director.getTotalFrames(),l=0,h=n.length;l<h;l++){var _=n[l],f=_.target,p=_.transform;f.matrix=RU(p,c)}for(var d=0,m=e.length;d<m;d++){var v=e[d];v.fn.apply(v.thisArg,v.args)}e.length=0},i.destruct=function(){},i.addAnimation=function(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)},i.removeAnimation=function(t){var e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):O(3907)},i.pushDelayEvent=function(t,e,i){this._delayEvents.push({fn:t,thisArg:e,args:i})},i.addSockets=function(t,e){for(var i=this,n=function(n){var r=e[n];if(i._sockets.find((function(t){return t.target===r.target})))return"continue";var o=t.getChildByPath(r.path),a=r.target&&o&&DU(o,t);a&&i._sockets.push({target:r.target,transform:a})},r=0;r<e.length;++r)n(r)},i.removeSockets=function(t,e){for(var i=0;i<e.length;++i)for(var n=e[i],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===n.target){MU(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},Q(e,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),e}(IO),xU.ID="animation",yU=SU))||yU);HO.on(GO.EVENT_INIT,(function(){var t=new OU;HO.registerSystem(OU.ID,t,IO.Priority.HIGH)})),u.AnimationManager=OU;var BU,NU,LU,FU,zU=new Gi;function VU(t,e,i){for(Gi.identity(i);t!==e;)Gi.fromRTS(zU,t.rotation,t.position,t.scale),Gi.multiply(i,zU,i),t=t.parent;return i}u.easing=tf;var kU=t("HierachyModifier",pc("cc.HierachyModifier")(BU=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(FF))||BU);u.HierachyModifier=kU;var UU=t("ComponentModifier",pc("cc.ComponentModifier")(NU=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(zF))||NU);u.ComponentModifier=UU;var GU=t("CurveValueAdapter",pc("cc.CurveValueAdapter")(LU=function(){function t(){}return t.prototype.forTarget=function(){return{set:function(){}}},t}())||LU);u.CurveValueAdapter=GU;var HU=t("UniformCurveValueAdapter",pc("cc.UniformCurveValueAdapter")(FU=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(VF))||FU);function jU(t){return"string"==typeof t}function WU(t){return"number"==typeof t}function qU(t,e){return t instanceof e}u.UniformCurveValueAdapter=HU,u.isPropertyModifier=jU,u.isElementModifier=WU,u.isCustomTargetModifier=qU,u.math=an,u.geometry=Op;var XU=new Ei,YU=new Gi;function KU(t,e,i,n){var r=i.chunk,o=i.data,a=r.vb,s=i.vertexCount;t.getWorldMatrix(YU);for(var c=0,l=0;l<s;l++){var u=o[l];Ei.set(XU,u.x,u.y,0),Ei.transformMat4(XU,XU,YU),a[c++]=XU.x,a[c++]=XU.y,a[c++]=XU.z,Ti.toArray(a,n,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),p=r.vertexAccessor.getIndexBuffer(h),d=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2}f.indexOffset+=i.indexCount,f.setDirty()}var JU=function(){function t(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var i=new QU;i.initWithSize(t,e),this._texture=i,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var e=t.prototype;return e.insertSpriteFrame=function(t){var e=t.rect,i=t.texture,n=this._innerTextureInfos[i.getId()],r=e.x,o=e.y;if(n)r+=n.x,o+=n.y;else{var a=i.width,s=i.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;u.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),c},e.deleteInnerTexture=function(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)},e.isEmpty=function(){return this._count<=0},e.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var t=this._innerSpriteFrames,e=0,i=t.length;e<i;e++){var n=t[e];n.isValid&&n._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},e.destroy=function(){this.reset(),this._texture.destroy()},t}(),QU=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.initWithSize=function(t,e,i){void 0===i&&(i=Dm.RGBA8888),this.reset({width:t,height:e,format:i})},i.drawTextureAt=function(t,e,i){var n=this.getGFXTexture();if(t&&n){var r=this._getGFXDevice();if(r){var o=new or;o.texOffset.x=e,o.texOffset.y=i,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],n,[o])}else console.warn("Unable to get device")}},e}(Cv),ZU=function(){function t(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var e=t.prototype;return e.newAtlas=function(){var t=this._atlases[++this._atlasIndex];return t||(t=new JU(this._textureSize,this._textureSize),this._atlases.push(t)),t},e.beforeSceneLoad=function(){this.reset()},e.insertSpriteFrame=function(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;var e=t.texture.getSamplerInfo();if(e.minFilter!==Om.LINEAR||e.magFilter!==Om.LINEAR||e.mipFilter!==Om.NONE)return null;var i=this._atlases[this._atlasIndex];i||(i=this.newAtlas());var n=i.insertSpriteFrame(t);return n||this._atlasIndex===this._maxAtlasCount?n:(i=this.newAtlas()).insertSpriteFrame(t)},e.reset=function(){for(var t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1},e.deleteAtlasSpriteFrame=function(t){if(t._original){for(var e,i=this._atlases.length-1;i>=0;i--)e=this._atlases[i],ne.array.fastRemove(e._innerSpriteFrames,t);var n=t._original._texture;this.deleteAtlasTexture(n)}},e.deleteAtlasTexture=function(t){if(t)for(var e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)},e.packToDynamicAtlas=function(t,e){if(e&&!e._original&&e.packable&&e.texture&&e.texture.width>0&&e.texture.height>0){var i=this.insertSpriteFrame(e);i&&e._setDynamicAtlasFrame(i)}},Q(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?(this.reset(),u.director.on(u.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),u.director.off(u.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(t){this._maxAtlasCount=t}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(t){this._textureBleeding=t}},{key:"textureSize",get:function(){return this._textureSize},set:function(t){this._textureSize=t}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(t){this._maxFrameSize=t}}]),t}();ZU.instance=void 0;var $U,tG,eG,iG=t("dynamicAtlasManager",ZU.instance=new ZU);u.internal.dynamicAtlasManager=iG;var nG,rG,oG,aG,sG=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],cG=t("SpriteFrame",pc("cc.SpriteFrame")((eG=tG=function(t){function e(){var e;return(e=t.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new en,e._offset=new qi,e._originalSize=new $i,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}$(e,t),e.createWithImage=function(t){var i=t instanceof tv?t:new tv(t),n=new Cv;n.image=i;var r=new e;return r.texture=n,r};var i=e.prototype;return i.textureLoaded=function(){return!!this.texture},i.isRotated=function(){return this._rotated},i.setRotated=function(t){this.rotated=t},i.getRect=function(t){return t?(t.set(this._rect),t):this._rect.clone()},i.setRect=function(t){this.rect=t},i.getOriginalSize=function(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()},i.setOriginalSize=function(t){this.originalSize=t},i.getOffset=function(t){return t?(t.set(this._offset),t):this._offset.clone()},i.setOffset=function(t){this.offset=t},i.getGFXTexture=function(){return this._texture.getGFXTexture()},i.getGFXSampler=function(){return this._texture.getGFXSampler()},i.getHash=function(){return this._texture.getHash()},i.getSamplerInfo=function(){return this._texture.getSamplerInfo()},i.reset=function(t,e){void 0===e&&(e=!1);var i=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()},i.checkRect=function(t){var e=this._rect,i=e.x,n=e.y;return this._rotated?(i+=e.height,n+=e.width):(i+=e.width,n+=e.height),i>t.width?(O(3300,this.name+"/"+t.name,i,t.width),!1):!(n>t.height&&(O(3301,this.name+"/"+t.name,n,t.height),1))},i.destroy=function(){return this._packable&&iG&&iG.deleteAtlasSpriteFrame(this),t.prototype.destroy.call(this)},i._calculateSlicedUV=function(){var t=this._rect,i=this.texture,n=i.width,r=i.height,o=this._capInsets[0],a=this._capInsets[2],s=t.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=t.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){sG[0].u=t.x/n,sG[1].u=(t.x+l)/n,sG[2].u=(t.x+l+u)/n,sG[3].u=(t.x+t.height)/n,sG[3].v=t.y/r,sG[2].v=(t.y+o)/r,sG[1].v=(t.y+o+s)/r,sG[0].v=(t.y+t.width)/r;for(var _=0;_<4;++_)for(var f=sG[_],p=0;p<4;++p){var d=sG[3-p];h.push({u:f.u,v:d.v})}}else{sG[0].u=t.x/n,sG[1].u=(t.x+o)/n,sG[2].u=(t.x+o+s)/n,sG[3].u=(t.x+t.width)/n,sG[3].v=t.y/r,sG[2].v=(t.y+c)/r,sG[1].v=(t.y+c+u)/r,sG[0].v=(t.y+t.height)/r;for(var m=0;m<4;++m)for(var v=sG[m],g=0;g<4;++g){var y=sG[g];h.push({u:y.u,v:v.v})}}this.emit(e.EVENT_UV_UPDATED,this)},i._calculateUV=function(){var t=this._rect,e=this.uv,i=this.unbiasUV,n=this.texture,r=n.width,o=n.height;if(this._rotated){var a=0===r?0:t.x/r,s=0===r?1:(t.x+t.height)/r,c=0===o?0:t.y/o,l=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=s,e[1]=l,e[2]=s,e[3]=c,e[4]=a,e[5]=l,e[6]=a,e[7]=c):this._isFlipUVX?(e[0]=s,e[1]=c,e[2]=s,e[3]=l,e[4]=a,e[5]=c,e[6]=a,e[7]=l):this._isFlipUVY?(e[0]=a,e[1]=l,e[2]=a,e[3]=c,e[4]=s,e[5]=l,e[6]=s,e[7]=c):(e[0]=a,e[1]=c,e[2]=a,e[3]=l,e[4]=s,e[5]=c,e[6]=s,e[7]=l);var u=0===r?0:t.x/r,h=0===r?1:(t.x+t.height)/r,_=0===o?0:t.y/o,f=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=f,i[2]=h,i[3]=_,i[4]=u,i[5]=f,i[6]=u,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=h,i[3]=f,i[4]=u,i[5]=_,i[6]=u,i[7]=f):this._isFlipUVY?(i[0]=u,i[1]=f,i[2]=u,i[3]=_,i[4]=h,i[5]=f,i[6]=h,i[7]=_):(i[0]=u,i[1]=_,i[2]=u,i[3]=f,i[4]=h,i[5]=_,i[6]=h,i[7]=f)}else{var p=0===r?0:t.x/r,d=0===r?1:(t.x+t.width)/r,m=0===o?1:(t.y+t.height)/o,v=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=d,e[1]=v,e[2]=p,e[3]=v,e[4]=d,e[5]=m,e[6]=p,e[7]=m):this._isFlipUVX?(e[0]=d,e[1]=m,e[2]=p,e[3]=m,e[4]=d,e[5]=v,e[6]=p,e[7]=v):this._isFlipUVY?(e[0]=p,e[1]=v,e[2]=d,e[3]=v,e[4]=p,e[5]=m,e[6]=d,e[7]=m):(e[0]=p,e[1]=m,e[2]=d,e[3]=m,e[4]=p,e[5]=v,e[6]=d,e[7]=v);var g=0===r?0:t.x/r,y=0===r?1:(t.x+t.width)/r,x=0===o?1:(t.y+t.height)/o,S=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(i[0]=y,i[1]=S,i[2]=g,i[3]=S,i[4]=y,i[5]=x,i[6]=g,i[7]=x):this._isFlipUVX?(i[0]=y,i[1]=x,i[2]=g,i[3]=x,i[4]=y,i[5]=S,i[6]=g,i[7]=S):this._isFlipUVY?(i[0]=g,i[1]=S,i[2]=y,i[3]=S,i[4]=g,i[5]=x,i[6]=y,i[7]=x):(i[0]=g,i[1]=x,i[2]=y,i[3]=x,i[4]=g,i[5]=S,i[6]=y,i[7]=S)}var b=this.vertices;if(b){b.nu.length=0,b.nv.length=0;for(var C=0;C<b.u.length;C++)b.nu[C]=b.u[C]/r,b.nv[C]=b.v[C]/o}this._calculateSlicedUV()},i._setDynamicAtlasFrame=function(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())},i._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},i._checkPackable=function(){var t=iG;if(t){var e=this._texture;if(e instanceof Cv&&!e.isCompressed){var i=this.width,n=this.height;!e.image||i>t.maxFrameSize||n>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},i._serialize=function(){return null},i._deserialize=function(t){var e=t,i=e.rect;i&&(this._rect=new en(i.x,i.y,i.width,i.height));var n=e.offset;e.offset&&(this._offset=new qi(n.x,n.y));var r=e.originalSize;e.originalSize&&(this._originalSize=new $i(r.width,r.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable;var o=e.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},i.clone=function(){var t,i,n,r,o,a,s,c,l=new e,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(t=u.nu)||void 0===t?void 0:t.slice(0),u:null===(i=u.u)||void 0===i?void 0:i.slice(0),nv:null===(n=u.nv)||void 0===n?void 0:n.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},i._refreshTexture=function(t){this._texture=t;var e=this._texture,i={},n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(i.rect=new en(0,0,e.width,e.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(i.originalSize=new $i(e.width,e.height),n=!0),n&&(this.reset(i),this.onLoaded()),this._checkPackable()},i.initDefault=function(e){t.prototype.initDefault.call(this,e);var i=new Cv;i.initDefault(),this._refreshTexture(i),this._calculateUV()},i.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},Q(e,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t)}},{key:"rotated",get:function(){return this._rotated},set:function(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(t){this._atlasUuid=t}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(t){this._isFlipUVX=t,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(t){this._isFlipUVY=t,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(t){this._packable=t}},{key:"original",get:function(){return this._original}}]),e}(Mu),tG.EVENT_UV_UPDATED="uv_updated",$U=eG))||$U);u.SpriteFrame=cG;var lG,uG=t("SpriteAtlas",pc("cc.SpriteAtlas")((aG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"spriteFrames",oG,ot(e)),e}$(e,t);var i=e.prototype;return i.getTexture=function(){var t=Object.keys(this.spriteFrames);if(t.length>0){var e=this.spriteFrames[t[0]];return e&&e.texture}return null},i.getSpriteFrame=function(t){var e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null},i.getSpriteFrames=function(){for(var t=[],e=this.spriteFrames,i=0,n=Object.keys(e);i<n.length;i++){var r=n[i];t.push(e[r])}return t},i._serialize=function(){},i._deserialize=function(t,e){var i=t;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=Pt();for(var r=0;r<n.length;r+=2)e.result.push(this.spriteFrames,n[r],n[r+1],te(cG))},e}(Mu),oG=lt((rG=aG).prototype,"spriteFrames",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pt()}}),nG=rG))||nG);u.SpriteAtlas=uG;var hG,_G,fG,pG,dG=t("Font",pc("cc.Font")(lG=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(Mu))||lG);u.Font=dG;var mG,vG,gG,yG,xG,SG,bG,CG,AG,TG=t("TTFFont",pc("cc.TTFFont")((pG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_fontFamily",fG,ot(e)),e}return $(e,t),e.prototype.initDefault=function(e){this._fontFamily="Arial",t.prototype.initDefault.call(this,e)},Q(e,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(t){this._fontFamily=t||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:xu(this._native),__isNative__:!0}}}]),e}(dG),fG=lt((_G=pG).prototype,"_fontFamily",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(_G.prototype,"_nativeAsset",[ol,Yc],Object.getOwnPropertyDescriptor(_G.prototype,"_nativeAsset"),_G.prototype),lt(_G.prototype,"_nativeDep",[ol],Object.getOwnPropertyDescriptor(_G.prototype,"_nativeDep"),_G.prototype),hG=_G))||hG);u.TTFFont=TG;var wG,EG=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},PG=function(){function t(t){this.letterDefinitions={},this.texture=t}var e=t.prototype;return e.addLetterDefinitions=function(t,e){this.letterDefinitions[t]=e},e.cloneLetterDefinition=function(){for(var t={},e=0,i=Object.keys(this.letterDefinitions);e<i.length;e++){var n=i[e],r=new EG;Vt(r,this.letterDefinitions[n]),t[n]=r}return t},e.getTexture=function(){return this.texture},e.getLetter=function(t){return this.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t){var e=t.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},e.clear=function(){this.letterDefinitions={}},t}(),IG=t("BitmapFont",(mG=pc("cc.BitmapFont"),vG=Kc(cG),mG((AG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"fntDataStr",xG,ot(e)),ct(e,"spriteFrame",SG,ot(e)),ct(e,"fontSize",bG,ot(e)),ct(e,"fntConfig",CG,ot(e)),e}return $(e,t),e.prototype.onLoaded=function(){var t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new PG(t.texture));var e=this.fntConfig;if(e){var i=e.fontDefDictionary;for(var n in i){var r=new EG,o=i[n].rect;r.offsetX=i[n].xOffset,r.offsetY=i[n].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=i[n].xAdvance,this.fontDefDictionary.addLetterDefinitions(n,r)}}else S("The fnt config is not exists!")},e}(dG),xG=lt((yG=AG).prototype,"fntDataStr",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SG=lt(yG.prototype,"spriteFrame",[vG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bG=lt(yG.prototype,"fontSize",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),CG=lt(yG.prototype,"fntConfig",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gG=yG))||gG));u.BitmapFont=IG;var RG=t("LabelAtlas",pc("cc.LabelAtlas")(wG=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}(IG))||wG);u.LabelAtlas=RG;var DG=t("BASELINE_RATIO",.26),MG=t("MIDDLE_RATIO",(DG+1)/2-DG);var OG=new ee(2);OG.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var BG,NG=new(function(){function t(t){this.count=0,this.limit=0,this.datas={},this.limit=t}var e=t.prototype;return e.moveToHead=function(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t},e.put=function(t,e){var i=OG.get();if(i.key=t,i.value=e,this.count>=this.limit){var n=this.tail;delete this.datas[n.key],this.count--,this.tail=n.prev,this.tail.next=null,n.prev=null,n.next=null,OG.put(n)}this.moveToHead(i)},e.remove=function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--},e.get=function(t){var e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null},e.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},e.has=function(t){return!!this.datas[t]},e.delete=function(t){var e=this.datas[t];this.remove(e)},t}())(100),LG=/([a-zA-Z0-9--]+|\S)/,FG=/^[!,.:;'}\]%\?>]/,zG=/([a-zA-Z0-9--]+|\S)$/,VG=/[a-zA-Z0-9--]+$/,kG=/^[a-zA-Z0-9--]/;function UG(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function GG(t){var e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function HG(t,e,i){var n=(i||t.font)+""+e,r=NG.get(n);if(null!==r)return r;var o=t.measureText(e),a=o&&o.width||0;return NG.put(n,a),a}function jG(t,e,i){var n=e,r=i,o=t[e];if(o>="\udc00"&&o<="\udfff"&&n--,void 0!==i)if(i-1!==e){var a=t[i-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return t.substring(n,r)}function WG(t,e,i,n){var r=[];if(0===t.length||i<0)return r.push(""),r;for(var o=t;e>i&&o.length>1;){for(var a=o.length*(i/e)|0,s=jG(o,a),c=e-n(s),l=s,u=0,h=0;c>i&&h++<10;)a*=i/c,c=e-n(s=jG(o,a|=0));for(h=0;c<=i&&h++<10;){if(s){var _=LG.exec(s);u=_?_[0].length:1,l=s}c=e-n(s=jG(o,a+=u))}0==(a-=u)?(a=1,l=jG(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=jG(o,2));var f=jG(o,0,a),p=void 0;FG.test(l||s)&&(0==(a-=(p=zG.exec(f))?p[0].length:0)&&(a=1),l=jG(o,a),f=jG(o,0,a)),kG.test(l)&&(p=VG.exec(f))&&f!==p[0]&&(l=jG(o,a-=p[0].length),f=jG(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),e=n(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var qG=t("CanvasPool",function(){function t(){this.pool=[]}t.getInstance=function(){return BG||(BG=new t),BG};var e=t.prototype;return e.get=function(){var t=this.pool.pop();if(!t){var e=document.createElement("canvas"),i=e.getContext("2d");t={canvas:e,context:i}}return t},e.put=function(t){this.pool.length>=ue.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)},t}()),XG=Ti.WHITE.clone(),YG=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},KG="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",JG=function(){function t(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}var e=t.prototype;return e.updateRenderData=function(){this._updateProperties(),this._updateTexture()},e.destroy=function(){this.image=null},e._updateProperties=function(){if(this.data=qG.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var t=HG(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+DG)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*DG/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new tv),this.image.reset(this.canvas)},e._updateTexture=function(){if(this.context&&this.canvas){var t=this.context,e=this.labelInfo,i=this.canvas.width,n=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,i,n),t.fillStyle=KG,t.fillRect(0,0,i,n),t.font=e.fontDesc;var r=e.fontSize,o=i/2,a=n/2+r*MG+0*r,s=e.color;if(t.lineJoin="round",t.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",e.isOutlined){var c=e.out||XG;t.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",t.lineWidth=2*e.margin,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}},t}(),QG=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.initWithSize=function(t,e,i){void 0===i&&(i=Dm.RGBA8888),this.reset({width:t,height:e,format:i})},i.drawTextureAt=function(t,e,i){var n=this.getGFXTexture();if(t&&n){var r=this._getGFXDevice();if(r){var o=new or;o.texOffset.x=e,o.texOffset.y=i,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],n,[o])}else console.warn("Unable to get device")}},e}(Cv),ZG=function(){function t(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var i=new QG;i.initWithSize(t,e),this.fontDefDictionary=new PG(i),this._halfBleed=1,this._width=t,this._height=e,HO.on(GO.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var e=t.prototype;return e.insertLetterTexture=function(t){var e=t.image,i=HO.root.device;if(!e||!this.fontDefDictionary||!i)return null;var n=e.width,r=e.height;if(this._x+n+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return D(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;var o=new YG;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=n+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o},e.update=function(){this._dirty&&(this._dirty=!1)},e.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},e.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},e.getTexture=function(){return this.fontDefDictionary.getTexture()},e.beforeSceneLoad=function(){this.clearAllCache()},e.clearAllCache=function(){this.destroy();var t=new QG;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t},e.getLetter=function(t){return this.fontDefDictionary.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t,e){var i=t.charCodeAt(0)+e.hash,n=this.fontDefDictionary.letterDefinitions[i];if(!n){var r=new JG(t,e);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n},Q(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(),$G={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Ti.WHITE.clone(),isOutlined:!1,out:Ti.WHITE.clone(),margin:0},tH=[new Pr(Kn.ATTR_POSITION,_n.RGB32F)],eH=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_COLOR,_n.RGBA32F)],iH=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RG32F),new Pr(Kn.ATTR_COLOR,_n.RGBA32F)],nH=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RG32F),new Pr(Kn.ATTR_COLOR,_n.RGBA32F),new Pr(Kn.ATTR_COLOR2,_n.RGBA32F)];function rH(t){for(var e=0,i=0;i<t.length;i++){var n=t[i];e+=Zr[n.format].count}return e}function oH(t){for(var e=0,i=0;i<t.length;i++){var n=t[i];e+=Zr[n.format].size}return e}u.internal.vfmtPosUvColor=iH,u.internal.vfmtPosUvTwoColor=nH,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:tH,vfmtPosColor:eH,vfmtPosUvColor:iH,vfmtPosUvTwoColor:nH,getComponentPerVertex:rH,getAttributeStride:oH}));var aH,sH,cH,lH,uH,hH,_H,fH,pH,dH,mH,vH,gH,yH,xH,SH=oH(iH)>>2,bH=new jl((function(){return{x:0,y:0,z:0,u:0,v:0,color:Ti.WHITE.clone()}}),128),CH=null,AH=t("BaseRenderData",function(){function t(t){void 0===t&&(t=iH),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=iH,this._floatStride=t===iH?SH:oH(t)>>2,this._vertexFormat=t}return t.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},Q(t,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),t}()),TH=t("RenderData",function(t){function e(e,i){var n;return void 0===e&&(e=iH),(n=t.call(this,e)||this).indices=null,n.vertDirty=!0,n.frame=void 0,n.layer=0,n.blendHash=-1,n.textureHash=0,n.nodeDirty=!0,n.passDirty=!0,n.textureDirty=!0,n.hashDirty=!0,n._data=[],n._pivotX=0,n._pivotY=0,n._width=0,n._height=0,n._accessor=null,i||(i=HO.root.batcher2D.switchBufferAccessor(n._vertexFormat)),n._accessor=i,n}$(e,t),e.add=function(t,i){void 0===t&&(t=iH),CH||(CH=new Wl((function(){return new e}),32));var n=CH.add();return n._floatStride=t===iH?SH:oH(t)>>2,n._vertexFormat=t,i||(i=HO.root.batcher2D.switchBufferAccessor(n._vertexFormat)),n._accessor=i,n},e.remove=function(t){var e=CH.data.indexOf(t);-1!==e&&(t.clear(),t._accessor=null,CH.removeAt(e))};var i=e.prototype;return i.resize=function(t,e){t===this._vc&&e===this._ic&&this.chunk||(this._vc=t,this._ic=e,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(t,e),this.updateHash())},i.resizeAndCopy=function(t,e){if(t!==this._vc||e!==this._ic||!this.chunk){this._vc=t,this._ic=e;var i=this.chunk;this.chunk=this._accessor.allocateChunk(t,e),i&&(this.chunk.vb.set(i.vb),this._accessor.recycleChunk(i)),this.updateHash()}},i.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},i.updateNode=function(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0},i.updatePass=function(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0},i.updateTexture=function(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0},i.updateHash=function(){var t=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=go(t,666),this.hashDirty=!1},i.updateRenderData=function(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var i=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==i&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},i.updateSizeNPivot=function(t,e,i,n){t===this._width&&e===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=t,this._height=e,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)},i.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},Q(e,[{key:"dataLength",get:function(){return this._data.length},set:function(t){var e=this._data;if(e.length!==t){var i=e.length,n=0;for(n=t;n<i;n++)bH.free(e[n]);for(n=i;n<t;n++)e[n]=bH.alloc();e.length=t}}},{key:"data",get:function(){return this._data}}]),e}(AH)),wH=t("MeshRenderData",function(t){function e(e){var i;return void 0===e&&(e=iH),(i=t.call(this,e)||this).isMeshBuffer=!0,i.vData=void 0,i.iData=void 0,i.vertexStart=0,i.vertexRange=0,i.indexStart=0,i.indexRange=0,i.lastFilledIndex=0,i.lastFilledVertex=0,i._byteLength=0,i._vertexBuffers=[],i._indexBuffer=null,i._iaPool=null,i._iaInfo=null,i.vData=new Float32Array(256*i.stride),i.iData=new Uint16Array(1536),i}$(e,t),e.add=function(t){void 0===t&&(t=iH);var e=EH.add();return e._floatStride=t===iH?SH:oH(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=EH.data.indexOf(t);-1!==e&&(EH.data[e].clear(),EH.removeAt(e))};var i=e.prototype;return i.request=function(t,e){var i=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=i,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},i.reserve=function(t,e){var i=this._byteLength+t*this.stride,n=this.indexCount+e;if(t+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(i>r||n>o){for(;r<i||o<n;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},i.resize=function(t,e){var i=t*this.stride;t>=0&&e>=0&&i<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=i,this.updateRange(0,t,0,e)},i.updateRange=function(t,e,i,n){e>=0&&n>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=i,this.vertexRange=e,this.indexRange=n},i.requestIA=function(t){this._initIAInfo(t);var e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},i.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),i=new Uint16Array(this.iData.buffer,0,t),n=this._vertexBuffers[0];this._byteLength>n.size&&n.resize(this._byteLength),n.update(e);var r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(i)}},i.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},i.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},i.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},i._initIAInfo=function(t){var e=this;if(!this._iaInfo){var i=this.stride,n=this._vertexBuffers;n.length||n.push(t.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,i,i)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,r,r))),this._iaInfo=new Rr(this._vertexFormat,n,this._indexBuffer),this._iaPool=new Wl((function(){return t.createInputAssembler(e._iaInfo)}),1,(function(t){t.destroy()}))}},i._reallocBuffer=function(t,e){var i=this.vData;this.vData=new Float32Array(t),i&&this.vData.set(i,0);var n=this.iData;this.iData=new Uint16Array(e),n&&this.iData.set(n,0)},Q(e,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),e}(AH)),EH=new Wl((function(){return new wH}),32),PH=new qi,IH=new qi,RH=(new Ei,new Gi),DH=new Gi,MH=new Gi,OH=new Gi(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),BH=new en,NH=function(e){return t({UITransform:e,UITransformComponent:e}),e}((aH=pc("cc.UITransform"),sH=Rc(),cH=mc(110),lH=wc(),uH=Uc(),hH=Nc(),_H=Uc(),fH=Nc(),aH(pH=sH(pH=cH(pH=lH(pH=vc(pH=Tc((yH=gH=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._priority=0,ct(e,"_contentSize",mH,ot(e)),ct(e,"_anchorPoint",vH,ot(e)),e}$(e,t);var i=e.prototype;return i.__preload=function(){this.node._uiProps.uiTransformComp=this},i.onLoad=function(){this.node.parent&&e.insertChangeMap(this.node.parent)},i.onEnable=function(){this.node.on(GC.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},i.onDisable=function(){this.node.off(GC.PARENT_CHANGED,this._parentChanged,this)},i.onDestroy=function(){this.node._uiProps.uiTransformComp=null},i.setContentSize=function(t,e){var i=this._contentSize;if(void 0===e){if((t=t).width===i.width&&t.height===i.height)return;i.width=t.width,i.height=t.height}else{if(t===i.width&&e===i.height)return;i.width=t,i.height=e}this.node.emit(GC.SIZE_CHANGED),this._markRenderDataDirty()},i.setAnchorPoint=function(t,e){var i=this._anchorPoint;if(void 0===e){if((t=t).x===i.x&&t.y===i.y)return;i.x=t.x,i.y=t.y}else{if(t===i.x&&e===i.y)return;i.x=t,i.y=e}this.node.emit(GC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},i.isHit=function(t){for(var e,i=this._contentSize.width,n=this._contentSize.height,r=PH,o=IH,a=null===(e=this.node)||void 0===e?void 0:e.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(RH);var u=RH.m12,h=RH.m13,_=qO.center;if(RH.m12=_.x-(RH.m00*u+RH.m04*h),RH.m13=_.y-(RH.m01*u+RH.m05*h),Gi.invert(RH,RH),qi.transformMat4(r,t,RH),this.node.getWorldMatrix(MH),Gi.invert(RH,MH),!Gi.strictEquals(RH,OH)){qi.transformMat4(o,r,RH),o.x+=this._anchorPoint.x*i,o.y+=this._anchorPoint.y*n;var f=!1;if(o.x>=0&&o.y>=0&&o.x<=i&&o.y<=n&&(f=!0,a&&a.maskList))for(var p=a.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){p.length=g;break}}if(f)return!0}}}return!1},i.convertToNodeSpaceAR=function(t,e){return this.node.getWorldMatrix(MH),Gi.invert(RH,MH),e||(e=new Ei),Ei.transformMat4(e,t,RH)},i.convertToWorldSpaceAR=function(t,e){return this.node.getWorldMatrix(MH),e||(e=new Ei),Ei.transformMat4(e,t,MH)},i.getBoundingBox=function(){Gi.fromRTS(DH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,e=this._contentSize.height,i=new en(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return i.transformMat4(DH),i},i.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(MH),this.getBoundingBoxTo(MH)):this.getBoundingBox()},i.getBoundingBoxTo=function(t){Gi.fromRTS(DH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var i=this._contentSize.width,n=this._contentSize.height,r=new en(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Gi.multiply(MH,t,DH),r.transformMat4(MH),!this.node.children)return r;for(var o,a=st(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(e);if(c){var l=c.getBoundingBoxTo(t);l&&en.union(r,r,l)}}}return r},i.getComputeAABB=function(t){var e=this._contentSize.width,i=this._contentSize.height;BH.set(-this._anchorPoint.x*e,-this._anchorPoint.y*i,e,i),BH.transformMat4(this.node.worldMatrix);var n=BH.x+.5*BH.width,r=BH.y+.5*BH.height,o=this.node.worldPosition.z,a=BH.width/2,s=BH.height/2;return null!=t?(Ws.set(t,n,r,o,a,s,.001),t):new Ws(n,r,o,a,s,.001)},i._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)},i._markRenderDataDirty=function(){var t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))},e.insertChangeMap=function(t){var i=t.uuid;e.priorityChangeNodeMap.has(i)||e.priorityChangeNodeMap.set(i,t)},e._sortChildrenSibling=function(t){var e=t.children;e&&e.sort((function(t,e){var i=t._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp,r=(i?i._priority:0)-(n?n._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))},e._sortSiblings=function(){e.priorityChangeNodeMap.forEach((function(t){e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()},e._cleanChangeMap=function(){e.priorityChangeNodeMap.clear()},Q(e,[{key:"contentSize",get:function(){return this._contentSize},set:function(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(GC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(GC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(GC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(GC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(GC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(GC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?D(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var t=HO.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}},{key:"cameraPriority",get:function(){var t=HO.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}}]),e}($u),gH.EventType=GC,gH.priorityChangeNodeMap=new Map,lt((dH=yH).prototype,"contentSize",[uH,hH],Object.getOwnPropertyDescriptor(dH.prototype,"contentSize"),dH.prototype),lt(dH.prototype,"anchorPoint",[_H,fH],Object.getOwnPropertyDescriptor(dH.prototype,"anchorPoint"),dH.prototype),mH=lt(dH.prototype,"_contentSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $i(100,100)}}),vH=lt(dH.prototype,"_anchorPoint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(.5,.5)}}),pH=dH))||pH)||pH)||pH)||pH)||pH)||pH));HO.on(GO.EVENT_AFTER_UPDATE,NH._sortSiblings),HO.on(GO.EVENT_BEFORE_SCENE_LAUNCH,NH._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(xH||(xH={}));var LH,FH,zH,VH,kH,UH,GH,HH,jH,WH,qH,XH,YH,KH,JH,QH,ZH,$H,tj,ej,ij=t("StencilManager",function(){function t(){this.stage=xH.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:wn.ALWAYS,stencilMask:65535,writeMask:65535,failOp:En.KEEP,zFailOp:En.KEEP,passOp:En.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var e=t.prototype;return e.pushMask=function(t){this._maskStack.push(t)},e.clear=function(t){t.stencilStage=t.inverted?xH.CLEAR_INVERTED:xH.CLEAR},e.enterLevel=function(t){t.graphics.stencilStage=t.inverted?xH.ENTER_LEVEL_INVERTED:xH.ENTER_LEVEL},e.enableMask=function(){this.stage=xH.ENABLED},e.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=xH.DISABLED:this.stage=xH.ENABLED)},e.getWriteMask=function(){return 1<<this._maskStack.length-1},e.getExitWriteMask=function(){return 1<<this._maskStack.length},e.getStencilRef=function(){for(var t=0,e=0;e<this._maskStack.length;++e)t+=1<<e;return t},e.reset=function(){this._maskStack.length=0,this.stage=xH.DISABLED},e.destroy=function(){this.stencilStateMap.forEach((function(t){t.destroy()})),this.stencilStateMap.clear()},e.getStencilStage=function(t,e){var i=0,n=!1,r=!1,o=wn.LESS,a=this.stencilStateMap;if(e&&e.passes[0]){var s=e.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),i=c|l<<1|s.depthFunc<<2|t<<6|this._maskStack.length<<9,n=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else i=t<<16|this._maskStack.length;if(a&&a.has(i))return a.get(i);this.setStateFromStage(t);var u=new Ao(n,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(i,u),u},e.getStencilHash=function(t){return t<<8|this._maskStack.length},e.setStateFromStage=function(t){var e=this._stencilPattern;t===xH.DISABLED?(e.stencilTest=!1,e.func=wn.ALWAYS,e.failOp=En.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===xH.ENABLED?(e.func=wn.EQUAL,e.failOp=En.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===xH.CLEAR?(e.func=wn.NEVER,e.failOp=En.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===xH.CLEAR_INVERTED||t===xH.ENTER_LEVEL?(e.func=wn.NEVER,e.failOp=En.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===xH.ENTER_LEVEL_INVERTED&&(e.func=wn.NEVER,e.failOp=En.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))},Q(t,[{key:"pattern",get:function(){return this._stencilPattern}}]),t}());ij.sharedManager=null,ij.sharedManager=new ij,ce(Pn),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(ej||(ej=t("InstanceMaterialType",{})));var nj,rj,oj,aj,sj,cj,lj,uj,hj,_j,fj,pj,dj,mj,vj,gj,yj,xj,Sj,bj,Cj,Aj,Tj,wj,Ej,Pj,Ij,Rj,Dj,Mj,Oj,Bj,Nj,Lj,Fj,zj,Vj,kj,Uj,Gj,Hj,jj,Wj,qj,Xj,Yj,Kj,Jj,Qj,Zj,$j,tW,eW,iW,nW,rW,oW,aW,sW,cW,lW,uW,hW,_W,fW,pW,dW,mW,vW,gW,yW=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((LH=pc("cc.Renderable2D"),FH=dc(NH),zH=Mc(),VH=Kc(cg),kH=Kc(cg),UH=Uc(),GH=Nc(),HH=Bc(),jH=Uc(),WH=Nc(),LH(qH=FH(qH=vc(qH=Tc((tj=$H=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_materials",YH,ot(e)),ct(e,"_customMaterial",KH,ot(e)),e.stencilStage=xH.DISABLED,ct(e,"_srcBlendFactor",JH,ot(e)),ct(e,"_dstBlendFactor",QH,ot(e)),ct(e,"_color",ZH,ot(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new wo,e._blendHash=0,e._lastParent=null,e}$(e,t);var i=e.prototype;return i.updateBlendHash=function(){var t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc},i.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},i.onEnable=function(){this.node.on(GC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(GC.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},i.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},i.onDisable=function(){this.node.off(GC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(GC.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},i.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var t=0;t<this._materialInstances.length;t++){var e=this._materialInstances[t];e&&e.destroy()}this._blendState&&this._blendState.destroy()},i.markForUpdateRenderData=function(t){if(void 0===t&&(t=!0),this._renderFlag=this._canRender(),t){var e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else this._renderDataFlag=t},i.requestRenderData=function(){var t=TH.add();return this._renderData=t,t},i.destroyRenderData=function(){this._renderData&&(TH.remove(this._renderData),this._renderData=null)},i.updateAssembler=function(t){this._renderDataFlag&&(this._assembler.updateRenderData(this,t),this._renderDataFlag=!1),this._renderFlag&&this._render(t)},i.postUpdateAssembler=function(t){this._postAssembler&&this._renderFlag&&this._postRender(t)},i._render=function(){},i._postRender=function(){},i._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},i._postCanRender=function(){},i.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()},i._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},i._updateBlendFunc=function(){var t=this._blendState.targets[0];t||(t=new To,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Pn.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},i.getBlendState=function(){return this._blendState},i._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var t=0;t<this.node.children.length;++t){var i=this.node.children[t].getComponent(e);i&&i.markForUpdateRenderData()}},i._onMaterialModified=function(e,i){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),t.prototype._onMaterialModified.call(this,e,i)},i._updateBuiltinMaterial=function(){var t;switch(this._instanceMaterialType){case ej.ADD_COLOR:t=Mv.get("ui-base-material");break;case ej.GRAYSCALE:t=Mv.get("ui-sprite-gray-material");break;case ej.USE_ALPHA_SEPARATED:t=Mv.get("ui-sprite-alpha-sep-material");break;case ej.USE_ALPHA_SEPARATED_AND_GRAY:t=Mv.get("ui-sprite-gray-alpha-sep-material");break;default:t=Mv.get("ui-sprite-material")}return t},i.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},i.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},Q(e,[{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var i=t.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(t.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&D(12001),this._srcBlendFactor},set:function(t){this._customMaterial?D(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&D(12001),this._dstBlendFactor},set:function(t){this._customMaterial?D(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(t){this._delegateSrc=t}},{key:"blendHash",get:function(){return this._blendHash}}]),e}(fF),$H.BlendState=Pn,$H.Assembler=null,$H.PostAssembler=null,YH=lt((XH=tj).prototype,"_materials",[ol],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(XH.prototype,"sharedMaterials",[ol,zH],Object.getOwnPropertyDescriptor(XH.prototype,"sharedMaterials"),XH.prototype),KH=lt(XH.prototype,"_customMaterial",[VH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(XH.prototype,"customMaterial",[kH,UH,GH,HH],Object.getOwnPropertyDescriptor(XH.prototype,"customMaterial"),XH.prototype),lt(XH.prototype,"color",[jH,WH],Object.getOwnPropertyDescriptor(XH.prototype,"color"),XH.prototype),JH=lt(XH.prototype,"_srcBlendFactor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.SRC_ALPHA}}),QH=lt(XH.prototype,"_dstBlendFactor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.ONE_MINUS_SRC_ALPHA}}),ZH=lt(XH.prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),qH=XH))||qH)||qH)||qH)||qH));u.internal.Renderable2D=yW,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(dW||(dW=t("HorizontalTextAlignment",{}))),ce(dW),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(mW||(mW=t("VerticalTextAlignment",{}))),ce(mW),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(vW||(vW=t("Overflow",{}))),ce(vW),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(gW||(gW=t("CacheMode",{}))),ce(gW);var xW=function(e){return t({Label:e,LabelComponent:e}),e}((nj=pc("cc.Label"),rj=Rc(),oj=mc(110),aj=wc(),sj=Uc(),cj=Nc(),lj=Kc(dW),uj=Uc(),hj=Nc(),_j=Kc(mW),fj=Uc(),pj=Nc(),dj=Uc(),mj=Nc(),vj=Uc(),gj=Mc(),yj=Nc(),xj=Uc(),Sj=Nc(),bj=Mc(),Cj=Uc(),Aj=Nc(),Tj=Kc(vW),wj=Uc(),Ej=Nc(),Pj=Uc(),Ij=Nc(),Rj=Kc(dG),Dj=Uc(),Mj=Mc(),Oj=Nc(),Bj=Uc(),Nj=Nc(),Lj=Kc(gW),Fj=Uc(),zj=Nc(),Vj=Uc(),kj=Nc(),Uj=Uc(),Gj=Nc(),Hj=Uc(),jj=Nc(),Wj=Mc(),qj=Uc(),Xj=Nc(),nj(Yj=rj(Yj=oj(Yj=aj((pW=fW=function(t){function e(){var e;return ct(e=t.call(this)||this,"_string",Jj,ot(e)),ct(e,"_horizontalAlign",Qj,ot(e)),ct(e,"_verticalAlign",Zj,ot(e)),ct(e,"_actualFontSize",$j,ot(e)),ct(e,"_fontSize",tW,ot(e)),ct(e,"_fontFamily",eW,ot(e)),ct(e,"_lineHeight",iW,ot(e)),ct(e,"_overflow",nW,ot(e)),ct(e,"_enableWrapText",rW,ot(e)),ct(e,"_font",oW,ot(e)),ct(e,"_isSystemFontUsed",aW,ot(e)),ct(e,"_spacingX",sW,ot(e)),ct(e,"_isItalic",cW,ot(e)),ct(e,"_isBold",lW,ot(e)),ct(e,"_isUnderline",uW,ot(e)),ct(e,"_underlineHeight",hW,ot(e)),ct(e,"_cacheMode",_W,ot(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}$(e,t);var i=e.prototype;return i.onEnable=function(){t.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},i.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var i=e;i.image&&i.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,t.prototype.onDestroy.call(this)},i.updateRenderData=function(t){void 0===t&&(t=!1),this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},i._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},i._updateColor=function(){t.prototype._updateColor.call(this),this.updateRenderData(!1)},i._canRender=function(){if(!t.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof IG){var i=e.spriteFrame;if(!i||!i.texture)return!1}return!0},i._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},i._applyFontTexture=function(){this.markForUpdateRenderData();var t=this._font;if(t instanceof IG){var e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===gW.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new cG,this._assemblerData=this._assembler.getAssemblerData();var i=new tv(this._assemblerData.canvas),n=new Cv;n.image=i,this._ttfSpriteFrame.texture=n}this.cacheMode!==gW.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},i.changeMaterialForDefine=function(){if(this._texture){var t=!1;if(this.cacheMode!==gW.CHAR){var e=this._texture.texture;if(e instanceof Zm){var i=e.getPixelFormat();t=i===Dm.RGBA_ETC1||i===Dm.RGB_A_PVRTC_4BPPV1||i===Dm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?ej.USE_ALPHA_SEPARATED:ej.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},Q(e,[{key:"string",get:function(){return this._string},set:function(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(t){this._actualFontSize=t}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode!==gW.BITMAP||this._font instanceof IG||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===gW.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(t){this._fontAtlas=t}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof IG?this._font.fontSize:-1}}]),e}(yW),fW.HorizontalAlign=dW,fW.VerticalAlign=mW,fW.Overflow=vW,fW.CacheMode=gW,fW._canvasPool=qG.getInstance(),lt((Kj=pW).prototype,"string",[sj,cj,Hc],Object.getOwnPropertyDescriptor(Kj.prototype,"string"),Kj.prototype),lt(Kj.prototype,"horizontalAlign",[lj,uj,hj],Object.getOwnPropertyDescriptor(Kj.prototype,"horizontalAlign"),Kj.prototype),lt(Kj.prototype,"verticalAlign",[_j,fj,pj],Object.getOwnPropertyDescriptor(Kj.prototype,"verticalAlign"),Kj.prototype),lt(Kj.prototype,"fontSize",[dj,mj],Object.getOwnPropertyDescriptor(Kj.prototype,"fontSize"),Kj.prototype),lt(Kj.prototype,"fontFamily",[vj,gj,yj],Object.getOwnPropertyDescriptor(Kj.prototype,"fontFamily"),Kj.prototype),lt(Kj.prototype,"lineHeight",[xj,Sj],Object.getOwnPropertyDescriptor(Kj.prototype,"lineHeight"),Kj.prototype),lt(Kj.prototype,"spacingX",[bj,Cj,Aj],Object.getOwnPropertyDescriptor(Kj.prototype,"spacingX"),Kj.prototype),lt(Kj.prototype,"overflow",[Tj,wj,Ej],Object.getOwnPropertyDescriptor(Kj.prototype,"overflow"),Kj.prototype),lt(Kj.prototype,"enableWrapText",[Pj,Ij],Object.getOwnPropertyDescriptor(Kj.prototype,"enableWrapText"),Kj.prototype),lt(Kj.prototype,"font",[Rj,Dj,Mj,Oj],Object.getOwnPropertyDescriptor(Kj.prototype,"font"),Kj.prototype),lt(Kj.prototype,"useSystemFont",[Bj,Nj],Object.getOwnPropertyDescriptor(Kj.prototype,"useSystemFont"),Kj.prototype),lt(Kj.prototype,"cacheMode",[Lj,Fj,zj],Object.getOwnPropertyDescriptor(Kj.prototype,"cacheMode"),Kj.prototype),lt(Kj.prototype,"isBold",[Vj,kj],Object.getOwnPropertyDescriptor(Kj.prototype,"isBold"),Kj.prototype),lt(Kj.prototype,"isItalic",[Uj,Gj],Object.getOwnPropertyDescriptor(Kj.prototype,"isItalic"),Kj.prototype),lt(Kj.prototype,"isUnderline",[Hj,jj],Object.getOwnPropertyDescriptor(Kj.prototype,"isUnderline"),Kj.prototype),lt(Kj.prototype,"underlineHeight",[Wj,Dc,qj,Xj],Object.getOwnPropertyDescriptor(Kj.prototype,"underlineHeight"),Kj.prototype),Jj=lt(Kj.prototype,"_string",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),Qj=lt(Kj.prototype,"_horizontalAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dW.CENTER}}),Zj=lt(Kj.prototype,"_verticalAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mW.CENTER}}),$j=lt(Kj.prototype,"_actualFontSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tW=lt(Kj.prototype,"_fontSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),eW=lt(Kj.prototype,"_fontFamily",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),iW=lt(Kj.prototype,"_lineHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),nW=lt(Kj.prototype,"_overflow",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vW.NONE}}),rW=lt(Kj.prototype,"_enableWrapText",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oW=lt(Kj.prototype,"_font",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aW=lt(Kj.prototype,"_isSystemFontUsed",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sW=lt(Kj.prototype,"_spacingX",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cW=lt(Kj.prototype,"_isItalic",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lW=lt(Kj.prototype,"_isBold",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uW=lt(Kj.prototype,"_isUnderline",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hW=lt(Kj.prototype,"_underlineHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),_W=lt(Kj.prototype,"_cacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gW.NONE}}),Yj=Kj))||Yj)||Yj)||Yj)||Yj));u.Label=xW;var SW,bW,CW=0,AW={};function TW(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function wW(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(SW||(SW={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(bW||(bW={}));var EW,PW,IW,RW=function(){function t(t){this._device=void 0,this._format=_n.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new or,this._region1=new or,this._region2=new or,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=Zr[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=co(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=wW(t,this._alignment);var i=-1,n=-1;if(void 0!==e&&(i=e,n=this._findAvailableSpace(t,i)),n<0)for(var r=0;r<this._chunkCount&&(i=r,!((n=this._findAvailableSpace(t,i))>=0));++r);if(n>=0){var o=this._chunks[i];o.start+=t;var a={chunkIdx:i,start:n,end:n+t,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(t/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,TW(s)),l=this._chunks[this.createChunk(c)];l.start+=t;var u={chunkIdx:this._chunkCount-1,start:0,end:t,texture:l.texture};return this._handles.push(u),u},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;A("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var i={texture:this._device.createTexture(new mr(yn.TEX2D,xn.SAMPLED|xn.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=i,this._chunkCount++},e.update=function(t,e){var i=[],n=[],r=t.start/this._formatSize,o=e.byteLength/this._formatSize,a=r%t.texture.width,s=Math.floor(r/t.texture.width),c=Math.min(t.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),n.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),n.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,t.texture,n)},e._findAvailableSpace=function(t,e){var i=this._chunks[e],n=!1,r=i.start;if(r+t<=i.size)n=!0;else{r=0;for(var o=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<o.length;a++){var s=o[a];if(r+t<=s.start){n=!0;break}r=s.end}!n&&r+t<=i.size&&(n=!0)}return n?r:-1},e._McDonaldAlloc=function(t){t=wW(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var i=this._chunks[e],n=!1,r=i.start;if(r+t<=i.end?n=!0:r>i.end?r+t<=i.size?n=!0:t<=i.end&&(i.start=r=0,n=!0):r===i.end&&(i.start=r=0,i.end=i.size,t<=i.end&&(n=!0)),n){i.start+=t;var o={chunkIdx:e,start:r,end:r+t,texture:i.texture};return this._handles.push(o),o}}var a=Math.sqrt(t/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,TW(a)),c=this._chunks[this.createChunk(s)];c.start+=t;var l={chunkIdx:this._chunkCount,start:0,end:t,texture:c.texture};return this._handles.push(l),l},t}(),DW=function(t){if(void 0===AW[t]){var e=1<<CW;AW[t]=e,CW+=1}},MW=Object.freeze({__proto__:null,addStage:DW,scene:Pb,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var i=[],n=e.positions.length/3,r=0;r<n;++r)i.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&i.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&i.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&i.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var o=[];o.push(new Pr(Kn.ATTR_POSITION,_n.RGB32F)),e.normals&&o.push(new Pr(Kn.ATTR_NORMAL,_n.RGB32F)),e.uvs&&o.push(new Pr(Kn.ATTR_TEX_COORD,_n.RG32F)),e.colors&&o.push(new Pr(Kn.ATTR_COLOR,_n.RGB32F));var a=t.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,4*i.length,4*i.length/n));a.update(new Float32Array(i));var s=null;return e.indices&&(s=t.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new Rr(o,[a],s))},get RenderQueue(){return SW},get PassStage(){return bW},genHandle:nm,getTypeFromHandle:rm,getBindingFromHandle:om,getCountFromHandle:am,getOffsetFromHandle:sm,customizeType:cm,type2reader:lm,type2writer:um,getDefaultFromType:_m,overrideMacros:fm,get BatchingSchemes(){return Pv},Pass:Vv,getDeviceShaderVersion:xm,programLib:Im,nearestPOT:TW,TextureBufferPool:RW,MaterialInstance:mb,PassInstance:db,get PoolType(){return Ts},NULL_HANDLE:0,get NodeView(){return ws},NodePool:Ds,get PassView(){return Ps},PassPool:Ns,get AABBView(){return Ms},AABBPool:zs});t("renderer",MW),function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(EW||(EW={})),ce(EW),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(PW||(PW={})),ce(PW),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(IW||(IW={})),ce(IW);var OW=Math.PI,BW=Math.min,NW=Math.max,LW=Math.cos,FW=Math.sin,zW=Math.abs,VW=Math.sign,kW=.5522847493;function UW(t,e,i,n,r){t.moveTo(e-n,i),t.bezierCurveTo(e-n,i+r*kW,e-n*kW,i+r,e,i+r),t.bezierCurveTo(e+n*kW,i+r,e+n,i+r*kW,e+n,i),t.bezierCurveTo(e+n,i-r*kW,e+n*kW,i-r,e,i-r),t.bezierCurveTo(e-n*kW,i-r,e-n,i-r*kW,e-n,i),t.close()}function GW(t,e,i,n,r,o,a,s,c,l,u){var h,_,f,p,d,m,v,g,y,x,S,b,C,A,T,w;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(e+n))+(f=.5*(n+o))),g=.5*((_=.5*(i+r))+(p=.5*(r+a))),((T=zW((n-s)*(A=c-i)-(r-c)*(C=s-e)))+(w=zW((o-s)*A-(a-c)*C)))*(T+w)<t.tessTol*(C*C+A*A)?t.addPoint(s,c,0===u?u|IW.PT_BEVEL:u):(GW(t,e,i,h,_,v,g,S=.5*(v+(y=.5*(f+d))),b=.5*(g+(x=.5*(p+m))),l+1,0),GW(t,S,b,y,x,d,m,s,c,l+1,u)))}var HW,jW,WW,qW,XW,YW,KW,JW,QW,ZW,$W,tq,eq,iq,nq,rq,oq,aq,sq,cq,lq,uq,hq,_q,fq,pq,dq,mq,vq,gq,yq,xq,Sq,bq,Cq,Aq,Tq,wq,Eq,Pq,Iq,Rq,Dq,Mq,Oq,Bq,Nq,Lq=function(t){function e(e,i){var n;return(n=t.call(this,e,i)||this).dx=0,n.dy=0,n.dmx=0,n.dmy=0,n.flags=0,n.len=0,n.reset(),n}return $(e,t),e.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},e}(qi),Fq=function(){function t(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return t.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t}(),zq=function(){function t(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Ti.WHITE.clone(),this.lineCap=EW.BUTT,this.strokeColor=Ti.BLACK.clone(),this.lineJoin=PW.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var e=t.prototype;return e.moveTo=function(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,IW.PT_CORNER),this._commandX=t,this._commandY=e},e.lineTo=function(t,e){this.addPoint(t,e,IW.PT_CORNER),this._commandX=t,this._commandY=e},e.bezierCurveTo=function(t,e,i,n,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==t||s.y!==e||i!==r||n!==o?(GW(this,s.x,s.y,t,e,i,n,r,o,0,IW.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},e.quadraticCurveTo=function(t,e,i,n){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(t-r),o+2/3*(e-o),i+2/3*(t-i),n+2/3*(e-n),i,n)},e.arc=function(t,e,i,n,r,o){!function(t,e,i,n,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,b=0;if(u=o-r,a=a||!1)if(zW(u)>=2*OW)u=2*OW;else for(;u<0;)u+=2*OW;else if(zW(u)>=2*OW)u=2*-OW;else for(;u>0;)u-=2*OW;for(c=0|NW(1,BW(zW(u)/(.5*OW)+.5,5)),h=zW(4/3*(1-LW(s=u/c/2))/FW(s)),a||(h=-h),b=0;b<=c;b++)p=e+(_=LW(l=r+u*(b/c)))*n,d=i+(f=FW(l))*n,m=-f*n*h,v=_*n*h,0===b?t.moveTo(p,d):t.bezierCurveTo(g+x,y+S,p-m,d-v,p,d),g=p,y=d,x=m,S=v}(this,t,e,i,n,r,o)},e.ellipse=function(t,e,i,n){UW(this,t,e,i,n),this._curPath.complex=!1},e.circle=function(t,e,i){UW(this,t,e,i,i),this._curPath.complex=!1},e.rect=function(t,e,i,n){this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+n),this.lineTo(t,e+n),this.close(),this._curPath.complex=!1},e.roundRect=function(t,e,i,n,r){!function(t,e,i,n,r,o){if(o<.1)t.rect(e,i,n,r);else{var a=BW(o,.5*zW(n))*VW(n),s=BW(o,.5*zW(r))*VW(r);t.moveTo(e,i+s),t.lineTo(e,i+r-s),t.bezierCurveTo(e,i+r-s*(1-kW),e+a*(1-kW),i+r,e+a,i+r),t.lineTo(e+n-a,i+r),t.bezierCurveTo(e+n-a*(1-kW),i+r,e+n,i+r-s*(1-kW),e+n,i+r-s),t.lineTo(e+n,i+s),t.bezierCurveTo(e+n,i+s*(1-kW),e+n-a*(1-kW),i,e+n-a,i),t.lineTo(e+a,i),t.bezierCurveTo(e+a*(1-kW),i,e,i+s*(1-kW),e,i+s),t.close()}}(this,t,e,i,n,r),this._curPath.complex=!1},e.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,e=0,i=t.length;e<i;e++){var n=t[e];n&&wH.remove(n)}this._renderDataList.length=0},e.close=function(){this._curPath.closed=!0},e.requestRenderData=function(){var t=wH.add();return this._renderDataList.push(t),t},e.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},e.addPoint=function(t,e,i){var n=this._curPath;if(n){var r=this._points,o=n.points,a=r[this.pointsOffset++];a?(a.x=t,a.y=e):(a=new Lq(t,e),r.push(a)),a.flags=i,o.push(a)}},e._addPath=function(){var t=this.pathLength,e=this.paths[t];return e?e.reset():(e=new Fq,this.paths.push(e)),this.pathLength++,this._curPath=e,e},t}(),Vq=eH.concat([new Pr("a_dist",_n.R32F)]),kq=rH(Vq),Uq=oH(Vq),Gq=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((HW=pc("cc.Graphics"),jW=Rc(),WW=mc(110),qW=wc(),XW=Nc(),YW=Kc(PW),KW=Nc(),JW=Kc(EW),QW=Nc(),ZW=Nc(),$W=Nc(),tq=Nc(),eq=Mc(),HW(iq=jW(iq=WW(iq=qW((hq=uq=function(t){function e(){var e;return(e=t.call(this)||this).impl=null,e.model=null,ct(e,"_lineWidth",rq,ot(e)),ct(e,"_strokeColor",oq,ot(e)),ct(e,"_lineJoin",aq,ot(e)),ct(e,"_lineCap",sq,ot(e)),ct(e,"_fillColor",cq,ot(e)),ct(e,"_miterLimit",lq,ot(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=ej.ADD_COLOR,e.impl=new zq,e}$(e,t);var i=e.prototype;return i.onRestore=function(){this.impl||this._flushAssembler()},i.onLoad=function(){this.model=HO.root.createModel(cb),this.model.node=this.model.transform=this.node,this._flushAssembler()},i.onEnable=function(){t.prototype.onEnable.call(this),this._updateMtlForGraphics()},i.onDisable=function(){t.prototype.onDisable.call(this)},i.onDestroy=function(){this._sceneGetter=null,this.model&&(HO.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var i=0;i<e;++i)this._graphicsUseSubMeshes[i].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),t.prototype.onDestroy.call(this)},i.moveTo=function(t,e){this.impl&&this.impl.moveTo(t,e)},i.lineTo=function(t,e){this.impl&&this.impl.lineTo(t,e)},i.bezierCurveTo=function(t,e,i,n,r,o){this.impl&&this.impl.bezierCurveTo(t,e,i,n,r,o)},i.quadraticCurveTo=function(t,e,i,n){this.impl&&this.impl.quadraticCurveTo(t,e,i,n)},i.arc=function(t,e,i,n,r,o){this.impl&&this.impl.arc(t,e,i,n,r,o)},i.ellipse=function(t,e,i,n){this.impl&&this.impl.ellipse(t,e,i,n)},i.circle=function(t,e,i){this.impl&&this.impl.circle(t,e,i)},i.rect=function(t,e,i,n){this.impl&&this.impl.rect(t,e,i,n)},i.roundRect=function(t,e,i,n,r){this.impl&&this.impl.roundRect(t,e,i,n,r)},i.fillRect=function(t,e,i,n){this.rect(t,e,i,n),this.fill()},i.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},i.close=function(){this.impl&&this.impl.close()},i.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},i.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},i._updateMtlForGraphics=function(){var t;this._customMaterial?t=this.getMaterialInstance(0):(t=Mv.get("ui-graphics-material"),this.setMaterial(t,0),(t=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},i.activeSubModel=function(t){if(this.model){if(this.model.subModels.length<=t){var e=u.director.root.device,i=e.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,65535*Uq,Uq)),n=e.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new Uw([i],Vq,Fn.TRIANGLE_LIST,n);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else D(4500,this.node.name)},i._uploadData=function(){var t=this.impl;if(t){var e=t&&t.getRenderDataList();if(!(e.length<=0)&&this.model){for(var i=this.model.subModels,n=0;n<e.length;n++){var r=e[n],o=i[n].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*kq);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},i._render=function(t){if(this._isNeedUploadData){if(this.impl){var e=this.impl.getRenderDataList(),i=this.model.subModels.length;if(e.length>i)for(var n=i;n<e.length;n++)this.activeSubModel(n)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))},i._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)},i._canRender=function(){return!!t.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},Q(e,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}},{key:"lineCap",get:function(){return this._lineCap},set:function(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(t){this._miterLimit=t}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),e}(yW),uq.LineJoin=PW,uq.LineCap=EW,lt((nq=hq).prototype,"lineWidth",[Dc,XW],Object.getOwnPropertyDescriptor(nq.prototype,"lineWidth"),nq.prototype),lt(nq.prototype,"lineJoin",[YW,KW],Object.getOwnPropertyDescriptor(nq.prototype,"lineJoin"),nq.prototype),lt(nq.prototype,"lineCap",[JW,QW],Object.getOwnPropertyDescriptor(nq.prototype,"lineCap"),nq.prototype),lt(nq.prototype,"strokeColor",[ZW],Object.getOwnPropertyDescriptor(nq.prototype,"strokeColor"),nq.prototype),lt(nq.prototype,"fillColor",[$W],Object.getOwnPropertyDescriptor(nq.prototype,"fillColor"),nq.prototype),lt(nq.prototype,"miterLimit",[tq],Object.getOwnPropertyDescriptor(nq.prototype,"miterLimit"),nq.prototype),lt(nq.prototype,"color",[ol,eq],Object.getOwnPropertyDescriptor(nq.prototype,"color"),nq.prototype),rq=lt(nq.prototype,"_lineWidth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oq=lt(nq.prototype,"_strokeColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.BLACK.clone()}}),aq=lt(nq.prototype,"_lineJoin",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PW.MITER}}),sq=lt(nq.prototype,"_lineCap",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EW.BUTT}}),cq=lt(nq.prototype,"_fillColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),lq=lt(nq.prototype,"_miterLimit",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),iq=nq))||iq)||iq)||iq)||iq));u.Graphics=Gq;var Hq,jq=new Gi,Wq=new qi,qq=new Gi,Xq=[];!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(Hq||(Hq={})),ce(Hq);var Yq=function(e){return t({Mask:e,MaskComponent:e}),e}((_q=pc("cc.Mask"),fq=Rc(),pq=mc(110),dq=wc(),mq=Kc(Hq),vq=Nc(),gq=Uc(),yq=Nc(),xq=Mc(),Sq=Kc(cG),bq=Mc(),Cq=Mc(),Aq=Lc(),Tq=Mc(),wq=Mc(),_q(Eq=fq(Eq=pq(Eq=dq((Nq=Bq=function(t){function e(){var e;return(e=t.call(this)||this)._clearStencilMtl=null,e._clearModel=null,ct(e,"_type",Iq,ot(e)),ct(e,"_inverted",Rq,ot(e)),ct(e,"_segments",Dq,ot(e)),ct(e,"_spriteFrame",Mq,ot(e)),ct(e,"_alphaThreshold",Oq,ot(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=ej.ADD_COLOR,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},i.onEnable=function(){t.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},i.onRestore=function(){this._createGraphics(),t.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},i.onDisable=function(){t.prototype.onDisable.call(this),this._disableGraphics()},i.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(HO.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),t.prototype.onDestroy.call(this)},i.isHit=function(t){var e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=i.width,r=i.height,o=Wq;this.node.getWorldMatrix(jq),Gi.invert(qq,jq),qi.transformMat4(o,t,qq);var a=e.anchorPoint;o.x+=a.x*n,o.y+=a.y*r;var s=!1;if(this.type===Hq.RECT||this.type===Hq.GRAPHICS_STENCIL||this.type===Hq.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=n&&o.y<=r;else if(this.type===Hq.ELLIPSE){var c=n/2,l=r/2,u=o.x-.5*n,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},i._render=function(t){t.commitComp(this,this.renderData,null,this._assembler,null)},i._postRender=function(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)},i._nodeStateChange=function(e){t.prototype._nodeStateChange.call(this,e),this._updateGraphics()},i._canRender=function(){return!!t.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==Hq.IMAGE_STENCIL||null!==this._spriteFrame)},i._flushAssembler=function(){var t=e.Assembler.getAssembler(this),i=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==i&&(this._postAssembler=i),this._useRenderData()},i._createGraphics=function(){if(!this._graphics){var t=this._graphics=new Gq;t._objFlags|=pl.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;var e=Ti.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()},i._updateGraphics=function(){if(this._graphics&&(this._type===Hq.RECT||this._type===Hq.ELLIPSE)){var t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();var i=t.contentSize,n=i.width,r=i.height,o=t.anchorPoint,a=-n*o.x,s=-r*o.y;if(this._type===Hq.RECT)e.rect(a,s,n,r);else if(this._type===Hq.ELLIPSE){for(var c=function(t,e,i){Xq.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)Xq.push(new Ei(e.x*Math.cos(n*r)+t.x,e.y*Math.sin(n*r)+t.y,0));return Xq}(new Ei(a+n/2,s+r/2,0),new Ei(n/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?e.moveTo(u.x,u.y):e.lineTo(u.x,u.y)}e.close()}e.fill()}},i._createClearModel=function(){if(!this._clearModel){var t=Mv.get("default-clear-stencil");this._clearStencilMtl=new mb({parent:t,owner:this,subModelIdx:0}),this._clearModel=HO.root.createModel(cb),this._clearModel.node=this._clearModel.transform=this.node;var e=oH(tH),i=u.director.root.device,n=i.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);n.update(r);var o=i.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new Uw([n],tH,Fn.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},i._updateMaterial=function(){if(this._graphics){var t,e=this._graphics;e.stencilStage=xH.DISABLED,this._type===Hq.IMAGE_STENCIL?(t=Mv.get("ui-alpha-test-material"),e.setMaterial(t,0),(t=e.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(t=Mv.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}},i._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},i._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},i._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},i._useRenderData=function(){this._type!==Hq.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},Q(e,[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==Hq.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(t){this._inverted=t,this.stencilStage=xH.DISABLED,this._graphics&&(this._graphics.stencilStage=xH.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(t){this._segments!==t&&(this._segments=ai(t,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this._type===Hq.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===Hq.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),e}(yW),Bq.Type=Hq,lt((Pq=Nq).prototype,"type",[mq,vq],Object.getOwnPropertyDescriptor(Pq.prototype,"type"),Pq.prototype),lt(Pq.prototype,"inverted",[gq,yq],Object.getOwnPropertyDescriptor(Pq.prototype,"inverted"),Pq.prototype),lt(Pq.prototype,"segments",[xq],Object.getOwnPropertyDescriptor(Pq.prototype,"segments"),Pq.prototype),lt(Pq.prototype,"spriteFrame",[Sq,bq],Object.getOwnPropertyDescriptor(Pq.prototype,"spriteFrame"),Pq.prototype),lt(Pq.prototype,"alphaThreshold",[Cq,Aq,kc],Object.getOwnPropertyDescriptor(Pq.prototype,"alphaThreshold"),Pq.prototype),lt(Pq.prototype,"color",[ol,Tq],Object.getOwnPropertyDescriptor(Pq.prototype,"color"),Pq.prototype),lt(Pq.prototype,"customMaterial",[ol,wq],Object.getOwnPropertyDescriptor(Pq.prototype,"customMaterial"),Pq.prototype),Iq=lt(Pq.prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hq.RECT}}),Rq=lt(Pq.prototype,"_inverted",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Dq=lt(Pq.prototype,"_segments",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Mq=lt(Pq.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oq=lt(Pq.prototype,"_alphaThreshold",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Eq=Pq))||Eq)||Eq)||Eq)||Eq));ER._maskComp=Yq,u.Mask=Yq;var Kq,Jq,Qq,Zq,$q,tX,eX,iX,nX,rX,oX,aX,sX,cX,lX,uX,hX,_X,fX,pX,dX,mX,vX,gX,yX,xX,SX,bX,CX,AX,TX,wX,EX,PX,IX,RX,DX,MX,OX,BX,NX,LX,FX,zX,VX,kX,UX,GX,HX,jX,WX,qX,XX,YX,KX,JX,QX,ZX,$X,tY,eY,iY,nY=/^(click)(\s)*=|(param)(\s)*=/,rY=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,oY=t("HtmlTextParser",function(){function t(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var e=t.prototype;return e.parse=function(t){this._resultObjectArray.length=0,this._stack.length=0;for(var e=0,i=t.length;e<i;){var n=t.indexOf(">",e),r=-1;if(n>=0&&(r=t.lastIndexOf("<",n))<e-1&&(r=t.indexOf("<",n+1),n=t.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=i;else{var o=t.substring(e,r),a=t.substring(r+1,n);""===a&&(o=t.substring(e,n+1)),this._processResult(o),-1===n?n=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(a),e=n+1}}return this._resultObjectArray},e._attributeToObject=function(t){t=t.trim();var e={},i=/^(color|size)(\s)*=/.exec(t),n="",r=0,o="";if(i){if(n=i[0],""===(t=t.substring(n.length).trim()))return e;switch(r=t.indexOf(" "),n[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(o=t.substring(r+1).trim(),e.event=this._processEventHandler(o)),e}if((i=/^(br(\s)*\/)/.exec(t))&&i[0].length>0&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;var a="";if((i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t))&&i[0].length>0&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var s;i=rY.exec(t);for(var c=!1;i;){if(n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),s=(r=(a=t.substring(n.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===n){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}e.isImage=!0,e.src=s}else if("height"===n)e.imageHeight=parseInt(s);else if("width"===n)e.imageWidth=parseInt(s);else if("align"===n){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}e.imageAlign=s.toLowerCase()}else"offset"===n?e.imageOffset=s:"click"===n&&(e.event=this._processEventHandler(n+"="+s));e.event&&"param"===n&&(e.event[n]=s.replace(/^"|"$/g,"")),i=rY.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(t)){var l={color:"#ffffff",width:1};if(t=i[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=h.exec(t);i;)n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),u=(r=(a=t.substring(n.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),"click"===n?e.event=this._processEventHandler(n+"="+u):"color"===n?l.color=u:"width"===n&&(l.width=parseInt(u)),e.event&&"param"===n&&(e.event[n]=u.replace(/^"|"$/g,"")),i=h.exec(t)}e.outline=l}if((i=/^(on|u|b|i)(\s)*/.exec(t))&&i[0].length>0){switch(n=i[0],t=t.substring(n.length).trim(),n[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e},e._processEventHandler=function(t){for(var e={},i=0,n=!1,r=nY.exec(t);r;){var o=r[0],a="";if(n=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))(i=t.indexOf('"',1))>-1&&(a=t.substring(1,i).trim(),n=!0),i++;else if("'"===t.charAt(0))(i=t.indexOf("'",1))>-1&&(a=t.substring(1,i).trim(),n=!0),i++;else{var s=/(\S)+/.exec(t);i=(a=s?s[0]:"").length}n&&(e[o=o.substring(0,o.length-1).trim()]=a),t=t.substring(i).trim(),r=nY.exec(t)}return e},e._addToStack=function(t){var e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)e[n]||(e[n]=i[n]);this._stack.push(e)}},e._processResult=function(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))},e._escapeSpecialSymbol=function(t){for(var e,i=st(this._specialSymbolArray);!(e=i()).done;){var n=e.value,r=n[0],o=n[1];t=t.replace(r,o)}return t},t}()),aY=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((Kq=pc("cc.LabelOutline"),Jq=Rc(),Qq=mc(110),Zq=wc(),$q=dc(xW),tX=Nc(),eX=Nc(),Kq(iX=Jq(iX=Qq(iX=Zq(iX=$q(iX=Tc((aX=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_color",rX,ot(e)),ct(e,"_width",oX,ot(e)),e}$(e,t);var i=e.prototype;return i.onEnable=function(){this._updateRenderData()},i.onDisable=function(){this._updateRenderData()},i._updateRenderData=function(){var t=this.node.getComponent(xW);t&&t.updateRenderData(!0)},Q(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this._updateRenderData())}}]),e}($u),rX=lt((nX=aX).prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(0,0,0,255)}}),oX=lt(nX.prototype,"_width",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),lt(nX.prototype,"color",[tX],Object.getOwnPropertyDescriptor(nX.prototype,"color"),nX.prototype),lt(nX.prototype,"width",[eX],Object.getOwnPropertyDescriptor(nX.prototype,"width"),nX.prototype),iX=nX))||iX)||iX)||iX)||iX)||iX)||iX));u.LabelOutline=aY,function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}($X||($X={})),ce($X),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(tY||(tY={})),ce(tY),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(eY||(eY={})),ce(eY),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(iY||(iY={}));var sY,cY=function(e){return t({Sprite:e,SpriteComponent:e}),e}((sX=pc("cc.Sprite"),cX=Rc(),lX=mc(110),uX=wc(),hX=Kc(uG),_X=Uc(),fX=Nc(),pX=Kc(cG),dX=Uc(),mX=Nc(),vX=Kc($X),gX=Uc(),yX=Nc(),xX=Kc(tY),SX=Uc(),bX=Nc(),CX=Uc(),AX=Nc(),TX=Lc(),wX=Uc(),EX=Nc(),PX=Lc(),IX=Uc(),RX=Nc(),DX=Mc(),MX=Uc(),OX=Nc(),BX=Uc(),NX=Nc(),LX=Kc(eY),FX=Uc(),zX=Nc(),sX(VX=cX(VX=lX(VX=uX((ZX=QX=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_spriteFrame",UX,ot(e)),ct(e,"_type",GX,ot(e)),ct(e,"_fillType",HX,ot(e)),ct(e,"_sizeMode",jX,ot(e)),ct(e,"_fillCenter",WX,ot(e)),ct(e,"_fillStart",qX,ot(e)),ct(e,"_fillRange",XX,ot(e)),ct(e,"_isTrimmedMode",YX,ot(e)),ct(e,"_useGrayscale",KX,ot(e)),ct(e,"_atlas",JX,ot(e)),e}$(e,t);var i=e.prototype;return i.__preload=function(){this.changeMaterialForDefine(),t.prototype.__preload.call(this)},i.onEnable=function(){t.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===$X.SLICED&&e.on(cG.EVENT_UV_UPDATED,this._updateUVs,this))},i.onDisable=function(){this._spriteFrame&&this._type===$X.SLICED&&this._spriteFrame.off(cG.EVENT_UV_UPDATED,this._updateUVs,this)},i.onDestroy=function(){t.prototype.onDestroy.call(this)},i.changeSpriteFrameFromAtlas=function(t){if(this._atlas){var e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}else console.warn("SpriteAtlas is null.")},i.changeMaterialForDefine=function(){var t,e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);var i=!1;if(t instanceof Zm){var n=t.getPixelFormat();i=n===Dm.RGBA_ETC1||n===Dm.RGB_A_PVRTC_4BPPV1||n===Dm.RGB_A_PVRTC_2BPPV1}i&&this.grayscale?this._instanceMaterialType=ej.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=ej.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=ej.GRAYSCALE:this._instanceMaterialType=ej.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()},i._updateBuiltinMaterial=function(){var e=t.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof VS){var i=Z({SAMPLE_FROM_RT:!0},e.passes[0].defines),n=new cg;n.initialize({effectAsset:e.effectAsset,defines:i}),e=n}return e},i._render=function(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},i._canRender=function(){if(!t.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},i._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===$X.SLICED?this._spriteFrame.on(cG.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(cG.EVENT_UV_UPDATED,this._updateUVs,this))},i._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(eY.RAW===this._sizeMode){var t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(eY.TRIMMED===this._sizeMode){var e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}},i._resized=function(){},i._activateMaterial=function(){var t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)},i._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},i._applySpriteFrame=function(t){var e=this._spriteFrame;t&&this._type===$X.SLICED&&t.off(cG.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var i=!1;e&&(t&&t.texture===e.texture||(i=!0),i&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===$X.SLICED&&e.on(cG.EVENT_UV_UPDATED,this._updateUVs,this))},Q(e,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(t){this._atlas!==t&&(this._atlas=t)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(t){this._fillType!==t&&(t===tY.RADIAL||this._fillType===tY.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===$X.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(t){this._fillStart=ai(t,0,1),this._type===$X.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(t){this._fillRange=ai(t,-1,1),this._type===$X.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===$X.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(t){this._useGrayscale!==t&&(this._useGrayscale=t,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,t!==eY.CUSTOM&&this._applySpriteSize())}}]),e}(yW),QX.FillType=tY,QX.Type=$X,QX.SizeMode=eY,QX.EventType=iY,lt((kX=ZX).prototype,"spriteAtlas",[hX,_X,fX],Object.getOwnPropertyDescriptor(kX.prototype,"spriteAtlas"),kX.prototype),lt(kX.prototype,"spriteFrame",[pX,dX,mX],Object.getOwnPropertyDescriptor(kX.prototype,"spriteFrame"),kX.prototype),lt(kX.prototype,"type",[vX,gX,yX],Object.getOwnPropertyDescriptor(kX.prototype,"type"),kX.prototype),lt(kX.prototype,"fillType",[xX,SX,bX],Object.getOwnPropertyDescriptor(kX.prototype,"fillType"),kX.prototype),lt(kX.prototype,"fillCenter",[CX,AX],Object.getOwnPropertyDescriptor(kX.prototype,"fillCenter"),kX.prototype),lt(kX.prototype,"fillStart",[TX,wX,EX],Object.getOwnPropertyDescriptor(kX.prototype,"fillStart"),kX.prototype),lt(kX.prototype,"fillRange",[PX,IX,RX],Object.getOwnPropertyDescriptor(kX.prototype,"fillRange"),kX.prototype),lt(kX.prototype,"trim",[DX,MX,OX],Object.getOwnPropertyDescriptor(kX.prototype,"trim"),kX.prototype),lt(kX.prototype,"grayscale",[Dc,BX,NX],Object.getOwnPropertyDescriptor(kX.prototype,"grayscale"),kX.prototype),lt(kX.prototype,"sizeMode",[LX,FX,zX],Object.getOwnPropertyDescriptor(kX.prototype,"sizeMode"),kX.prototype),UX=lt(kX.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GX=lt(kX.prototype,"_type",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $X.SIMPLE}}),HX=lt(kX.prototype,"_fillType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tY.HORIZONTAL}}),jX=lt(kX.prototype,"_sizeMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eY.TRIMMED}}),WX=lt(kX.prototype,"_fillCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(0,0)}}),qX=lt(kX.prototype,"_fillStart",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XX=lt(kX.prototype,"_fillRange",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YX=lt(kX.prototype,"_isTrimmedMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),KX=lt(kX.prototype,"_useGrayscale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JX=lt(kX.prototype,"_atlas",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VX=kX))||VX)||VX)||VX)||VX));u.Sprite=cY;var lY,uY,hY,_Y,fY,pY,dY,mY,vY,gY,yY,xY,SY,bY,CY,AY,TY,wY,EY,PY,IY,RY,DY,MY,OY,BY,NY,LY,FY,zY,VY,kY,UY,GY,HY,jY,WY,qY,XY,YY,KY,JY,QY,ZY,$Y,tK,eK,iK,nK,rK=t("RenderRoot2D",pc("cc.RenderRoot2D")(sY=mc(100)(sY=wc()(sY=dc(NH)(sY=vc(sY=Tc(sY=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.onEnable=function(){u.director.root.batcher2D.addScreen(this)},i.onDisable=function(){u.director.root.batcher2D.removeScreen(this)},i.onDestroy=function(){u.director.root.batcher2D.removeScreen(this)},e}($u))||sY)||sY)||sY)||sY)||sY)||sY),oK=new Ei,aK=oe({OVERLAY:0,INTERSPERSE:1}),sK=function(e){return t({Canvas:e,CanvasComponent:e}),e}((lY=pc("cc.Canvas"),uY=Rc(),hY=mc(100),_Y=wc(),fY=Kc(nF),pY=Nc(),dY=Nc(),mY=Kc(nF),lY(vY=uY(vY=hY(vY=_Y(vY=Tc(vY=vc((lt((gY=function(t){function e(){var e;return ct(e=t.call(this)||this,"_cameraComponent",yY,ot(e)),ct(e,"_alignCanvasWithScreen",xY,ot(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new Ei,e._renderMode=aK.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(ot(e)),e}$(e,t);var i=e.prototype;return i.__preload=function(){var t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(nF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(GC.TRANSFORM_CHANGED,this._thisOnCameraResized)},i.onEnable=function(){t.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(nF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},i.onDisable=function(){t.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(nF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},i.onDestroy=function(){t.prototype.onDestroy.call(this),this.node.off(GC.TRANSFORM_CHANGED,this._thisOnCameraResized)},i._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=qO.height/2;else{var t=ch.windowSize;this._cameraComponent.orthoHeight=t.height/$O.getScaleY()/2}this.node.getWorldPosition(oK),this._cameraComponent.node.setWorldPosition(oK.x,oK.y,1e3)}},i._getViewPriority=function(){if(this._cameraComponent){var t,e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return this._renderMode===aK.OVERLAY?e|1<<30:e&~(1<<30)}return 0},Q(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}}]),e}(rK)).prototype,"cameraComponent",[fY,pY],Object.getOwnPropertyDescriptor(gY.prototype,"cameraComponent"),gY.prototype),lt(gY.prototype,"alignCanvasWithScreen",[dY],Object.getOwnPropertyDescriptor(gY.prototype,"alignCanvasWithScreen"),gY.prototype),yY=lt(gY.prototype,"_cameraComponent",[mY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xY=lt(gY.prototype,"_alignCanvasWithScreen",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vY=gY))||vY)||vY)||vY)||vY)||vY)||vY));u.Canvas=sK,U(t("UIComponent",pc("cc.UIComponent")(SY=dc(NH)(SY=mc(110)(SY=vc(SY=Tc(SY=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._lastParent=null,e.stencilStage=xH.DISABLED,e}$(e,t);var i=e.prototype;return i.__preload=function(){this.node._uiProps.uiComp=this},i.onEnable=function(){},i.onDisable=function(){},i.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},i.updateAssembler=function(){},i.postUpdateAssembler=function(){},i.markForUpdateRenderData=function(){},i.setNodeDirty=function(){},i.setTextureDirty=function(){},e}($u))||SY)||SY)||SY)||SY)||SY).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),k(sK.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:Ti.BLACK},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),G(yW.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),G(NH.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),u.UITransformComponent=NH,ne.setClassAlias(NH,"cc.UITransformComponent"),ne.setClassAlias(yW,"cc.RenderComponent"),u.CanvasComponent=sK,ne.setClassAlias(sK,"cc.CanvasComponent");var cK=new oY,lK="RICHTEXT_CHILD",uK="RICHTEXT_Image_CHILD",hK=new ee((function(t){if(!u.isValid(t.node))return!1;var e=t.node.getComponent(aY);return e&&(e.width=0),!0}),20),_K=new ee((function(t){return u.isValid(t.node)}),10);function fK(t){return{node:new jT(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function pK(t,e){var i;t===lK?i=hK._get():t===uK&&(i=_K._get());var n=(i=i||fK(t)).node;return n||(n=new jT(t)),n.hideFlags|=pl.Flags.DontSave|pl.Flags.HideInHierarchy,t===uK?(i.comp=n.getComponent(cY)||n.addComponent(cY),i.comp.spriteFrame=e,i.comp.type=cY.Type.SLICED,i.comp.sizeMode=cY.SizeMode.CUSTOM):(i.comp=n.getComponent(xW)||n.addComponent(xW),i.comp.string=e,i.comp.horizontalAlign=dW.LEFT,i.comp.verticalAlign=mW.TOP),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}var dK,mK=function(e){return t({RichText:e,RichTextComponent:e}),e}((bY=pc("cc.RichText"),CY=Rc(),AY=mc(110),TY=wc(),wY=Nc(),EY=Kc(dW),PY=Nc(),IY=Nc(),RY=Nc(),DY=Kc(dG),MY=Nc(),OY=Nc(),BY=Uc(),NY=Kc(gW),LY=Nc(),FY=Nc(),zY=Nc(),VY=Kc(uG),kY=Nc(),UY=Nc(),bY(GY=CY(GY=AY(GY=TY(GY=Tc((nK=iK=function(t){function e(){var e;return ct(e=t.call(this)||this,"_lineHeight",jY,ot(e)),ct(e,"_string",WY,ot(e)),ct(e,"_horizontalAlign",qY,ot(e)),ct(e,"_fontSize",XY,ot(e)),ct(e,"_maxWidth",YY,ot(e)),ct(e,"_fontFamily",KY,ot(e)),ct(e,"_font",JY,ot(e)),ct(e,"_isSystemFontUsed",QY,ot(e)),ct(e,"_userDefinedFont",ZY,ot(e)),ct(e,"_cacheMode",$Y,ot(e)),ct(e,"_imageAtlas",tK,ot(e)),ct(e,"_handleTouchEvent",eK,ot(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this.node.on(GC.LAYER_CHANGED,this._applyLayer,this)},i.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},i.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},i.start=function(){this._onTTFLoaded(),this.node.on(GC.ANCHOR_CHANGED,this._updateRichTextPosition,this)},i.onRestore=function(){},i.onDestroy=function(){for(var t,e=st(this._segments);!(t=e()).done;){var i=t.value;i.node.removeFromParent(),i.type===lK?hK.put(i):i.type===uK&&_K.put(i)}this.node.off(GC.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(GC.LAYER_CHANGED,this._applyLayer,this)},i._addEventListeners=function(){this.node.on(GC.TOUCH_END,this._onTouchEnded,this)},i._removeEventListeners=function(){this.node.off(GC.TOUCH_END,this._onTouchEnded,this)},i._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},i._createFontLabel=function(t){return pK(lK,t)},i._createImage=function(t){return pK(uK,t)},i._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},i._measureText=function(t,e){var i=this,n=function(e){var n;return 0===i._labelSegmentsCache.length?(n=i._createFontLabel(e),i._labelSegmentsCache.push(n)):(n=i._labelSegmentsCache[0]).node.getComponent(xW).string=e,n.styleIndex=t,i._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize.width};return e?n(e):n},i._onTouchEnded=function(t){for(var e,i=this,n=this.node.getComponents($u),r=function(){var r=e.value,o=r.clickHandler,a=r.clickParam;o&&i._containsTouchLocation(r,t.touch.getUILocation())&&(n.forEach((function(e){var i=e[o];e.enabledInHierarchy&&i&&i.call(e,t,a)})),t.propagationStopped=!0)},o=st(this._segments);!(e=o()).done;)r()},i._containsTouchLocation=function(t,e){var i=t.node.getComponent(NH);return!!i&&i.getBoundingBoxToWorld().contains(e)},i._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var i=t[e];if(i.name===lK||i.name===uK){i.parent===this.node?i.parent=null:t.splice(e,1);var n=fK(i.name);n.node=i,i.name===lK?(n.comp=i.getComponent(xW),hK.put(n)):(n.comp=i.getComponent(cY),_K.put(n))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},i._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var i=this.node.children[e];i.name!==lK&&i.name!==uK||(i.active=t)}},i._addLabelSegment=function(t,e){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(t);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(xW);n&&(n.string=t)}return i.styleIndex=e,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this.node.addChild(i.node),this._applyTextAttribute(i),this._segments.push(i),i},i._updateRichTextWithMaxWidth=function(t,e,i){var n=e;if(this._lineOffsetX>0&&n+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,r,t.length),a=t.substr(r,o),s=this._measureText(i,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=t.substr(0,r);this._addLabelSegment(c,i),t=t.substr(r,t.length),n=this._measureText(i,t)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(n>this._maxWidth)for(var l=WG(t,n,this._maxWidth,this._measureText(i)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,i).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(t,i)},i._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},i._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},i._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var i=this._textArray[e],n=t[e];if(i.text!==n.text)return!0;var r=i.style,o=n.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},i._addRichTextImageElement=function(t){if(t.style){var e=t.style,i=e.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){var r=this._createImage(n);switch(r.comp,e.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(r.imageOffset=e.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=n.rect.clone(),a=1,s=o.width,c=o.height,l=e.imageWidth||0,u=e.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=e.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else D(4400)}},i._updateRichText=function(){if(this.enabledInHierarchy){var t=cK.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(i=!1,this._maxWidth>0){var l=this._measureText(n,c);this._updateRichTextWithMaxWidth(c,l,n),a.length>1&&s<a.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(c,n),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+DG)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},i._getFirstWordLen=function(t,e,i){var n=t.charAt(e);if(UG(n)||GG(n))return 1;for(var r=1,o=e+1;o<i&&!GG(n=t.charAt(o))&&!UG(n);++o)r++;return r},i._updateRichTextPosition=function(){for(var t=0,e=1,i=this._lineCount,n=this.node._uiProps.uiTransformComp,r=n.anchorX,o=n.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>e&&(t=0,e=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case dW.LEFT:break;case dW.CENTER:l-=this._linesWidth[c-1]/2;break;case dW.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(t+l,this._lineHeight*(i-c)-this._labelHeight*o,u.z),c===e&&(t+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(cY)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+DG);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(aY);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},i._convertLiteralColorValue=function(t){var e=t.toUpperCase();return Ti[e]?Ti[e]:(new Ti).fromHEX(t)},i._applyTextAttribute=function(t){var e=t.node.getComponent(xW);if(e){this._resetLabelState(e);var i,n=t.styleIndex;if(this._textArray[n]&&(i=this._textArray[n].style),i){if(e.color=this._convertLiteralColorValue(i.color||"white"),e.isBold=!!i.bold,e.isItalic=!!i.italic,e.isUnderline=!!i.underline,i.outline){var r=t.node.getComponent(aY);r||(r=t.node.addComponent(aY)),r.color=this._convertLiteralColorValue(i.outline.color),r.width=i.outline.width}e.fontSize=i.size||this._fontSize,t.clickHandler="",t.clickParam="";var o=i.event;o&&(t.clickHandler=o.click||"",t.clickParam=o.param||"")}e.cacheMode=this._cacheMode,this._font instanceof dG&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);var a=e._assembler;a&&a.updateRenderData(e)}},i._applyLayer=function(){for(var t,e=st(this._segments);!(t=e()).done;)t.value.node.layer=this.node.layer},i._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=Ti.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},Q(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}($u),iK.HorizontalAlign=dW,iK.VerticalAlign=mW,lt((HY=nK).prototype,"string",[Hc,wY],Object.getOwnPropertyDescriptor(HY.prototype,"string"),HY.prototype),lt(HY.prototype,"horizontalAlign",[EY,PY],Object.getOwnPropertyDescriptor(HY.prototype,"horizontalAlign"),HY.prototype),lt(HY.prototype,"fontSize",[IY],Object.getOwnPropertyDescriptor(HY.prototype,"fontSize"),HY.prototype),lt(HY.prototype,"fontFamily",[RY],Object.getOwnPropertyDescriptor(HY.prototype,"fontFamily"),HY.prototype),lt(HY.prototype,"font",[DY,MY],Object.getOwnPropertyDescriptor(HY.prototype,"font"),HY.prototype),lt(HY.prototype,"useSystemFont",[OY,BY],Object.getOwnPropertyDescriptor(HY.prototype,"useSystemFont"),HY.prototype),lt(HY.prototype,"cacheMode",[NY,LY],Object.getOwnPropertyDescriptor(HY.prototype,"cacheMode"),HY.prototype),lt(HY.prototype,"maxWidth",[FY],Object.getOwnPropertyDescriptor(HY.prototype,"maxWidth"),HY.prototype),lt(HY.prototype,"lineHeight",[zY],Object.getOwnPropertyDescriptor(HY.prototype,"lineHeight"),HY.prototype),lt(HY.prototype,"imageAtlas",[VY,kY],Object.getOwnPropertyDescriptor(HY.prototype,"imageAtlas"),HY.prototype),lt(HY.prototype,"handleTouchEvent",[UY],Object.getOwnPropertyDescriptor(HY.prototype,"handleTouchEvent"),HY.prototype),jY=lt(HY.prototype,"_lineHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),WY=lt(HY.prototype,"_string",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),qY=lt(HY.prototype,"_horizontalAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dW.LEFT}}),XY=lt(HY.prototype,"_fontSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),YY=lt(HY.prototype,"_maxWidth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KY=lt(HY.prototype,"_fontFamily",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),JY=lt(HY.prototype,"_font",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QY=lt(HY.prototype,"_isSystemFontUsed",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZY=lt(HY.prototype,"_userDefinedFont",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$Y=lt(HY.prototype,"_cacheMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gW.NONE}}),tK=lt(HY.prototype,"_imageAtlas",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eK=lt(HY.prototype,"_handleTouchEvent",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GY=HY))||GY)||GY)||GY)||GY)||GY));u.RichText=mK;var vK=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(pc("cc.UIMeshRenderer")(dK=Rc()(dK=mc(110)(dK=wc()(dK=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._models=null,e._modelComponent=null,e.stencilStage=xH.DISABLED,e}$(e,t);var i=e.prototype;return i.__preload=function(){this.node._uiProps.uiComp=this},i.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},i.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},i.updateAssembler=function(t){if(this._models){this._modelComponent._detachFromScene();for(var e,i=st(this._models);!(e=i()).done;){var n=e.value;t.commitModel.call(t,this,n,this._modelComponent.material)}return!0}return!1},i.postUpdateAssembler=function(){},i.update=function(){this._fitUIRenderQueue()},i._fitUIRenderQueue=function(){if(this._modelComponent)for(var t=this._modelComponent.sharedMaterials.length,e=0;e<t;e++){var i=this._modelComponent.getMaterialInstance(e);if(null!=i)for(var n=i.passes,r=n.length,o=0;o<r;o++)n[o]._priority=Fp.MAX-11,i.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},i.markForUpdateRenderData=function(){},i.setNodeDirty=function(){},i.setTextureDirty=function(){},Q(e,[{key:"modelComponent",get:function(){return this._modelComponent}}]),e}($u))||dK)||dK)||dK)||dK);u.UIMeshRenderer=vK;var gK,yK,xK,SK,bK,CK,AK,TK,wK,EK,PK,IK,RK,DK,MK,OK,BK,NK,LK,FK,zK,VK,kK,UK,GK,HK,jK,WK,qK,XK=Np.Enum.NONE|Np.Enum.UI_3D,YK=t("UIDrawBatch",function(){function t(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=XK,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.destroy=function(){this._passes=[]},e.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=XK,this.renderScene=null},e.fillPasses=function(t,e,i,n,r,o){if(t){var a=t.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new Vv(u.director.root));var l=a[c],h=this._passes[c];l.update(),e||(e=l.depthStencilState,i=0),n||(n=l.blendState,r=0),-1===r&&(r=0),s=i<<16|r,h._initPassFromTarget(l,e,n,s),this._shaders[c]=h.getShaderVariant(o)}}},Q(t,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(t){this._inputAssembler=t}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(t){this._descriptorSet=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),t}()),KK=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((gK=pc("cc.UIStaticBatch"),yK=Rc(),xK=wc(),SK=mc(110),bK=Mc(),gK(CK=yK(CK=xK(CK=SK((lt((AK=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}$(e,t);var i=e.prototype;return i.onLoad=function(){},i.onDestroy=function(){},i.updateAssembler=function(){},i.postUpdateAssembler=function(){},i.markAsDirty=function(){},i._requireDrawBatch=function(){var t=new YK;return t.isStatic=!0,this._uiDrawBatchList.push(t),t},i._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var t=this._getBatcher(),e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1},i._getBatcher=function(){return HO.root&&HO.root.batcher2D?HO.root.batcher2D:(D(9301),null)},Q(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),e}(yW)).prototype,"color",[ol,bK],Object.getOwnPropertyDescriptor(AK.prototype,"color"),AK.prototype),CK=AK))||CK)||CK)||CK)||CK)),JK=t("LabelShadow",(TK=pc("cc.LabelShadow"),wK=Rc(),EK=mc(110),PK=wc(),IK=dc(xW),RK=Nc(),DK=Nc(),MK=Nc(),TK(OK=wK(OK=EK(OK=PK(OK=IK(OK=Tc((zK=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_color",NK,ot(e)),ct(e,"_offset",LK,ot(e)),ct(e,"_blur",FK,ot(e)),e}$(e,t);var i=e.prototype;return i.onEnable=function(){this._updateRenderData()},i.onDisable=function(){this._updateRenderData()},i._updateRenderData=function(){var t=this.node.getComponent(xW);t&&t.updateRenderData(!0)},Q(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(t){this._blur=t,this._updateRenderData()}}]),e}($u),NK=lt((BK=zK).prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(0,0,0,255)}}),LK=lt(BK.prototype,"_offset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(2,2)}}),FK=lt(BK.prototype,"_blur",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),lt(BK.prototype,"color",[RK],Object.getOwnPropertyDescriptor(BK.prototype,"color"),BK.prototype),lt(BK.prototype,"offset",[DK],Object.getOwnPropertyDescriptor(BK.prototype,"offset"),BK.prototype),lt(BK.prototype,"blur",[MK],Object.getOwnPropertyDescriptor(BK.prototype,"blur"),BK.prototype),OK=BK))||OK)||OK)||OK)||OK)||OK)||OK)),QK=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}((VK=pc("cc.UIOpacity"),kK=Rc(),UK=mc(110),GK=wc(),HK=Nc(),VK(jK=kK(jK=UK(jK=GK(jK=Tc((lt((WK=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_opacity",qK,ot(e)),e}$(e,t);var i=e.prototype;return i.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},i.onDisable=function(){this.node._uiProps.localOpacity=1},Q(e,[{key:"opacity",get:function(){return this._opacity},set:function(t){this._opacity!==t&&(t=be(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}}]),e}($u)).prototype,"opacity",[Dc,HK],Object.getOwnPropertyDescriptor(WK.prototype,"opacity"),WK.prototype),qK=lt(WK.prototype,"_opacity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),jK=WK))||jK)||jK)||jK)||jK)||jK));u.MaskComponent=Yq,ne.setClassAlias(Yq,"cc.MaskComponent"),u.LabelComponent=xW,ne.setClassAlias(xW,"cc.LabelComponent"),u.LabelOutlineComponent=aY,ne.setClassAlias(aY,"cc.LabelOutlineComponent"),u.RichTextComponent=mK,ne.setClassAlias(mK,"cc.RichTextComponent"),u.SpriteComponent=cY,ne.setClassAlias(cY,"cc.SpriteComponent"),u.UIModelComponent=vK,ne.setClassAlias(vK,"cc.UIModelComponent"),u.GraphicsComponent=Gq,ne.setClassAlias(Gq,"cc.GraphicsComponent"),ne.setClassAlias(KK,"cc.UIStaticBatchComponent"),ne.setClassAlias(QK,"cc.UIOpacityComponent");var ZK=function(t,e,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=i};function $K(t,e,i,n,r){var o=0,a=null;if(r===function(t,e,i,n){for(var r=0,o=e,a=i-n;o<i;o+=n)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,i,n)>0)for(o=e;o<i;o+=n)a=vJ(o,t[o],t[o+1],a);else for(o=i-n;o>=e;o-=n)a=vJ(o,t[o],t[o+1],a);return a&&fJ(a,a.next)&&(gJ(a),a=a.next),a}function tJ(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var i=t,n=!1;do{if(n=!1,i.steiner||!fJ(i,i.next)&&0!==_J(i.prev,i,i.next))i=i.next;else{if(gJ(i),(i=e=i.prev)===i.next)return null;n=!0}}while(n||i!==e);return e}function eJ(t,e,i,n,r,o,a){if(void 0===a&&(a=0),t){!a&&o&&function(t,e,i,n){var r=t;do{null===r.z&&(r.z=cJ(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e=0,i=null,n=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(i=t,t=null,o=null,a=0;i;){for(a++,n=i,s=0,e=0;e<l&&(s++,n=n.nextZ);e++);for(c=l;s>0||c>0&&n;)0===s?(r=n,n=n.nextZ,c--):0!==c&&n?i.z<=n.z?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,c--):(r=i,i=i.nextZ,s--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=n}o.nextZ=null,l*=2}while(a>1)}(r)}(t,n,r,o);for(var s=t,c=null,l=null;t.prev!==t.next;)if(c=t.prev,l=t.next,o?nJ(t,n,r,o):iJ(t))e.push(c.i/i),e.push(t.i/i),e.push(l.i/i),gJ(t),t=l.next,s=l.next;else if((t=l)===s){a?1===a?eJ(t=rJ(t,e,i),e,i,n,r,o,2):2===a&&oJ(t,e,i,n,r,o):eJ(tJ(t),e,i,n,r,o,1);break}}}function iJ(t){var e=t.prev,i=t,n=t.next;if(_J(e,i,n)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(uJ(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)&&_J(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function nJ(t,e,i,n){var r=t.prev,o=t,a=t.next;if(_J(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=cJ(s,c,e,i,n),_=cJ(l,u,e,i,n),f=t.nextZ;f&&f.z<=_;){if(f!==t.prev&&f!==t.next&&uJ(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&_J(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=t.prevZ;f&&f.z>=h;){if(f!==t.prev&&f!==t.next&&uJ(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&_J(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function rJ(t,e,i){var n=t;do{var r=n.prev,o=n.next.next;!fJ(r,o)&&pJ(r,n,n.next,o)&&dJ(r,o)&&dJ(o,r)&&(e.push(r.i/i),e.push(n.i/i),e.push(o.i/i),gJ(n),gJ(n.next),n=t=o),n=n.next}while(n!==t);return n}function oJ(t,e,i,n,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&hJ(a,s)){var c=mJ(a,s);return a=tJ(a,a.next),c=tJ(c,c.next),eJ(a,e,i,n,r,o),void eJ(c,e,i,n,r,o)}s=s.next}a=a.next}while(a!==t)}function aJ(t,e){return t.x-e.x}function sJ(t,e){if(e=function(t,e){var i=e,n=t.x,r=t.y,o=-1/0,a=null;do{if(r<=i.y&&r>=i.next.y){var s=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&s>o){if(o=s,s===n){if(r===i.y)return i;if(r===i.next.y)return i.next}a=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!a)return null;if(n===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(i=a.next;i!==l;)n>=i.x&&i.x>=u&&uJ(r<h?n:o,r,u,h,r<h?o:n,r,i.x,i.y)&&((c=Math.abs(r-i.y)/(n-i.x))<_||c===_&&i.x>a.x)&&dJ(i,t)&&(a=i,_=c),i=i.next;return a}(t,e)){var i=mJ(e,t);tJ(i,i.next)}}function cJ(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function lJ(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function uJ(t,e,i,n,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(n-s)-(i-a)*(e-s)>=0&&(i-a)*(o-s)-(r-a)*(n-s)>=0}function hJ(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&pJ(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&dJ(t,e)&&dJ(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)}function _J(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function fJ(t,e){return t.x===e.x&&t.y===e.y}function pJ(t,e,i,n){return!!(fJ(t,e)&&fJ(i,n)||fJ(t,n)&&fJ(i,e))||_J(t,e,i)>0!=_J(t,e,n)>0&&_J(i,n,t)>0!=_J(i,n,e)>0}function dJ(t,e){return _J(t.prev,t,t.next)<0?_J(t,e,t.next)>=0&&_J(t,t.prev,e)>=0:_J(t,e,t.prev)<0||_J(t,t.next,e)<0}function mJ(t,e){var i=new ZK(t.i,t.x,t.y),n=new ZK(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function vJ(t,e,i,n){var r=new ZK(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function gJ(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function yJ(t,e,i){i=i||3;var n=e?e.length:0,r=n?e[0]*i:t.length,o=$K(t,0,r,i,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(n&&(o=function(t,e,i,n){var r,o=[],a=0,s=null;for(a=0,r=e.length;a<r;a++)(s=$K(t,e[a]*n,a<r-1?e[a+1]*n:t.length,n,!1))&&(s===s.next&&(s.steiner=!0),o.push(lJ(s)));if(o.sort(aJ),!i)return i;for(a=0;a<o.length;a++)sJ(o[a],i),i=tJ(i,i.next);return i}(t,e,o,i)),t.length>80*i){s=l=t[0],c=u=t[1];for(var p=i;p<r;p+=i)(h=t[p])<s&&(s=h),(_=t[p+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return eJ(o,a,i,s,c,f),a}for(var xJ=Math.PI,SJ=Math.min,bJ=Math.max,CJ=Math.ceil,AJ=Math.acos,TJ=Math.cos,wJ=Math.sin,EJ=Math.atan2,PJ=null,IJ=null,RJ=new Ti,DJ=[],MJ=0;MJ<4;MJ++)DJ.push(new Ei);function OJ(t,e,i){return t<e?e:t>i?i:t}var BJ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!IJ)return null;var i=IJ.getRenderDataList(),n=i[IJ.dataOffset];if(!n)return null;var r=n,o=r?r.vertexStart+e:0;return(o>65535||3*o>131070)&&(++IJ.dataOffset,IJ.dataOffset<i.length?n=i[IJ.dataOffset]:(n=IJ.requestRenderData(),i[IJ.dataOffset]=n),r=n),r&&r.vertexCount<o&&r.request(e,3*e),n},stroke:function(t){Ti.copy(RJ,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){Ti.copy(RJ,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e,i,n,r,o=.5*t.lineWidth,a=t.lineCap,s=t.lineJoin,c=t.miterLimit;if(IJ=t.impl){var l=(e=o,i=xJ,n=IJ.tessTol,r=2*AJ(e/(e+n)),bJ(2,CJ(i/r)));this._calculateJoins(IJ,o,s,c);for(var u=IJ.paths,h=0,_=IJ.pathOffset,f=IJ.pathLength;_<f;_++){var p=u[_],d=p.points.length;s===PW.ROUND?h+=2*(d+p.bevel*(l+2)+1):h+=2*(d+5*p.bevel+1),p.closed||(a===EW.ROUND?h+=2*(2*l+2):h+=12)}var m=PJ=this.getRenderData(t,h);if(m){for(var v=m.vData,g=m.iData,y=IJ.pathOffset,x=IJ.pathLength;y<x;y++){var S=u[y],b=S.points,C=b.length,A=m.vertexStart,T=void 0,w=void 0,E=0,P=0,I=S.closed;if(I?(T=b[C-1],w=b[0],E=0,P=C):(T=b[0],w=b[1],E=1,P=C-1),w=w||T,!I){var R=new Lq(w.x,w.y);R.subtract(T),R.normalize();var D=R.x,M=R.y;a===EW.BUTT?this._buttCapStart(T,D,M,o,0):a===EW.SQUARE?this._buttCapStart(T,D,M,o,o):a===EW.ROUND&&this._roundCapStart(T,D,M,o,l)}for(var O=E;O<P;++O)s===PW.ROUND?this._roundJoin(T,w,o,o,l):0!=(w.flags&(IW.PT_BEVEL|IW.PT_INNERBEVEL))?this._bevelJoin(T,w,o,o):(this._vSet(w.x+w.dmx*o,w.y+w.dmy*o,1),this._vSet(w.x-w.dmx*o,w.y-w.dmy*o,-1)),T=w,w=b[O+1];if(I){var B=8*A;this._vSet(v[B],v[B+1],1),this._vSet(v[B+8],v[B+8+1],-1)}else{var N=new Lq(w.x,w.y);N.subtract(T),N.normalize();var L=N.x,F=N.y;a===EW.BUTT?this._buttCapEnd(w,L,F,o,0):a===EW.SQUARE?this._buttCapEnd(w,L,F,o,o):a===EW.ROUND&&this._roundCapEnd(w,L,F,o,l)}for(var z=m.indexStart,V=A+2,k=m.vertexStart;V<k;V++)g[z++]=V-2,g[z++]=V-1,g[z++]=V;m.indexStart=z}PJ=null,IJ=null}}},_expandFill:function(t){if(IJ=t.impl){for(var e=IJ.paths,i=0,n=IJ.pathOffset,r=IJ.pathLength;n<r;n++)i+=e[n].points.length;var o=PJ=this.getRenderData(t,i);if(o){for(var a=o,s=a.vData,c=a.iData,l=IJ.pathOffset,u=IJ.pathLength;l<u;l++){var h=e[l],_=h.points,f=_.length;if(0!==f){for(var p=o.vertexStart,d=0;d<f;++d)this._vSet(_[d].x,_[d].y);var m=o.indexStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=yJ(v,null,3);if(!S||0===S.length)continue;for(var b=0,C=S.length;b<C;b++)c[m++]=S[b]+p}else for(var A=p,T=p+2,w=a.vertexStart;T<w;T++)c[m++]=A,c[m++]=T-1,c[m++]=T;a.indexStart=m}}PJ=null,IJ=null}}},_calculateJoins:function(t,e,i,n){var r=0;e>0&&(r=1/e);for(var o=t.paths,a=t.pathOffset,s=t.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var p,d,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(p=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/p;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=IW.PT_LEFT),p*(d=bJ(11,SJ(h.len,_.len)*r))*d<1&&(_.flags|=IW.PT_INNERBEVEL),_.flags&IW.PT_CORNER&&(p*n*n<1||i===PW.BEVEL||i===PW.ROUND)&&(_.flags|=IW.PT_BEVEL),0!=(_.flags&(IW.PT_BEVEL|IW.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(t){for(var e=t.paths,i=t.pathOffset,n=t.pathLength;i<n;i++){var r=e[i],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new Lq(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(t,e,i,n){var r=i.x,o=i.y,a=0,s=0,c=0,l=0;return 0!==t?(a=r+e.dy*n,s=o-e.dx*n,c=r+i.dy*n,l=o-i.dx*n):(a=c=r+i.dmx*n,s=l=o+i.dmy*n),[a,s,c,l]},_buttCapStart:function(t,e,i,n,r){var o=t.x-e*r,a=t.y-i*r,s=i,c=-e;this._vSet(o+s*n,a+c*n,1),this._vSet(o-s*n,a-c*n,-1)},_buttCapEnd:function(t,e,i,n,r){var o=t.x+e*r,a=t.y+i*r,s=i,c=-e;this._vSet(o+s*n,a+c*n,1),this._vSet(o-s*n,a-c*n,-1)},_roundCapStart:function(t,e,i,n,r){for(var o=t.x,a=t.y,s=i,c=-e,l=0;l<r;l++){var u=l/(r-1)*xJ,h=TJ(u)*n,_=wJ(u)*n;this._vSet(o-s*h-e*_,a-c*h-i*_,1),this._vSet(o,a,0)}this._vSet(o+s*n,a+c*n,1),this._vSet(o-s*n,a-c*n,-1)},_roundCapEnd:function(t,e,i,n,r){var o=t.x,a=t.y,s=i,c=-e;this._vSet(o+s*n,a+c*n,1),this._vSet(o-s*n,a-c*n,-1);for(var l=0;l<r;l++){var u=l/(r-1)*xJ,h=TJ(u)*n,_=wJ(u)*n;this._vSet(o,a,0),this._vSet(o-s*h+e*_,a-c*h+i*_,1)}},_roundJoin:function(t,e,i,n,r){var o=t.dy,a=-t.dx,s=e.dy,c=-e.dx,l=e.x,u=e.y;if(0!=(e.flags&IW.PT_LEFT)){var h=this._chooseBevel(e.flags&IW.PT_INNERBEVEL,t,e,i),_=h[0],f=h[1],p=h[2],d=h[3],m=EJ(-a,-o),v=EJ(-c,-s);v>m&&(v-=2*xJ),this._vSet(_,f,1),this._vSet(l-o*n,e.y-a*n,-1);for(var g=OJ(CJ((m-v)/xJ)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+TJ(x)*n,b=u+wJ(x)*n;this._vSet(l,u,0),this._vSet(S,b,-1)}this._vSet(p,d,1),this._vSet(l-s*n,u-c*n,-1)}else{var C=this._chooseBevel(e.flags&IW.PT_INNERBEVEL,t,e,-n),A=C[0],T=C[1],w=C[2],E=C[3],P=EJ(a,o),I=EJ(c,s);I<P&&(I+=2*xJ),this._vSet(l+o*n,u+a*n,1),this._vSet(A,T,-1);for(var R=OJ(CJ((I-P)/xJ)*r,2,r),D=0;D<R;D++){var M=P+D/(R-1)*(I-P),O=l+TJ(M)*i,B=u+wJ(M)*i;this._vSet(O,B,1),this._vSet(l,u,0)}this._vSet(l+s*n,u+c*n,1),this._vSet(w,E,-1)}},_bevelJoin:function(t,e,i,n){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=t.dy,f=-t.dx,p=e.dy,d=-e.dx;if(e.flags&IW.PT_LEFT){var m=this._chooseBevel(e.flags&IW.PT_INNERBEVEL,t,e,i);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(e.x-_*n,e.y-f*n,-1),this._vSet(u,h,1),this._vSet(e.x-p*n,e.y-d*n,-1)}else{var v=this._chooseBevel(e.flags&IW.PT_INNERBEVEL,t,e,-n);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(e.x+_*i,e.y+f*i,1),this._vSet(r,o,-1),this._vSet(e.x+p*i,e.y+d*i,1),this._vSet(a,s,-1)}},_vSet:function(t,e,i){if(void 0===i&&(i=0),PJ){var n=PJ,r=8*n.vertexStart,o=n.vData;o[r++]=t,o[r++]=e,o[r++]=0,Ti.toArray(o,RJ,r),r+=4,o[r++]=i,n.vertexStart++}}},NJ=t("graphicsAssembler",{getAssembler:function(){return BJ}});Gq.Assembler=NJ;var LJ=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},FJ=new en,zJ=null,VJ=null,kJ=[],UJ=[],GJ=[],HJ=[],jJ=new $i,WJ=new $i,qJ=new qi,XJ=null,YJ=0,KJ=0,JJ=0,QJ=0,ZJ=0,$J=1,tQ=null,eQ="",iQ=0,nQ=0,rQ=0,oQ=0,aQ=0,sQ=0,cQ=0,lQ=!1,uQ=0,hQ=0,_Q=0,fQ={updateRenderData:function(t){t.renderData&&zJ!==t&&(t.renderData.vertDirty&&(VJ=(zJ=t).node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),zJ.actualFontSize=iQ,VJ.setContentSize(WJ),this.updateUVs(t),zJ.renderData.vertDirty=!1,zJ.markForUpdateRenderData(!1),zJ=null,this._resetProperties()),t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame))},updateUVs:function(t){for(var e=t.renderData,i=e.chunk.vb,n=e.vertexCount,r=e.data,o=3,a=0;a<n;a++){var s=r[a];i[o]=s.u,i[o+1]=s.v,o+=9}},_updateFontScale:function(){$J=iQ/nQ},_updateFontFamily:function(t){var e=t.font;tQ=e.spriteFrame,XJ=e.fntConfig,$G.fontAtlas=e.fontDefDictionary,iG.packToDynamicAtlas(t,tQ)},_updateLabelInfo:function(){$G.hash="",$G.margin=0},_updateProperties:function(t){eQ=t.string.toString(),iQ=t.fontSize,nQ=XJ?XJ.fontSize:t.fontSize,rQ=t.horizontalAlign,oQ=t.verticalAlign,aQ=t.spacingX,cQ=t.overflow,sQ=t._lineHeight;var e=VJ.contentSize;WJ.width=e.width,WJ.height=e.height,cQ===vW.NONE?(lQ=!1,WJ.width+=2*$G.margin,WJ.height+=2*$G.margin):cQ===vW.RESIZE_HEIGHT?(lQ=!0,WJ.height+=2*$G.margin):lQ=t.enableWrapText,$G.lineHeight=sQ,$G.fontSize=iQ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){XJ=null,tQ=null,$G.hash="",$G.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var t=eQ,e=t.length,i=XJ.kerningDict,n=kJ,r=-1,o=0;o<e;++o){var a=t.charCodeAt(o),s=i[r<<16|65535&a]||0;n[o]=o<e-1?s:0,r=a}},_multilineTextWrap:function(t){for(var e=eQ.length,i=0,n=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<e;){var h=eQ.charAt(u);if("\n"!==h){for(var _=t(eQ,u,e),f=s,p=c,d=a,m=n,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=eQ.charAt(y)))if(l=$G.fontAtlas.getLetterDefinitionForChar(h,$G)){var x=m+l.offsetX*$J-$G.margin;if(lQ&&_Q>0&&n>0&&x+l.w*$J>_Q&&!GG(h)){GJ.push(a),a=0,i++,n=0,r-=sQ*this._getFontScale()+0,v=!0;break}qJ.x=x,qJ.y=r-l.offsetY*$J,this._recordLetterInfo(qJ,h,y,i),y+1<kJ.length&&y<e-1&&(m+=kJ[y+1]),m+=l.xAdvance*$J+aQ,d=qJ.x+l.w*$J,f<qJ.y&&(f=qJ.y),p>qJ.y-l.h*$J&&(p=qJ.y-l.h*$J)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+XJ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(n=m,s<f&&(s=f),c>p&&(c=p),o<(a=d)&&(o=a),u+=_)}else GJ.push(a),a=0,i++,n=0,r-=sQ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return GJ.push(a),KJ=(YJ=i+1)*sQ*this._getFontScale(),YJ>1&&(KJ+=0*(YJ-1)),WJ.width=uQ,WJ.height=hQ,uQ<=0&&(WJ.width=parseFloat(o.toFixed(2))+2*$G.margin),hQ<=0&&(WJ.height=parseFloat(KJ.toFixed(2))+2*$G.margin),QJ=WJ.height,ZJ=0,s>0&&(QJ=WJ.height+s),c<-KJ&&(ZJ=KJ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return cQ===vW.SHRINK?$J:1},_getFirstWordLen:function(t,e,i){var n=t.charAt(e);if(UG(n)||"\n"===n||GG(n))return 1;var r=1,o=$G.fontAtlas.getLetterDefinitionForChar(n,$G);if(!o)return r;for(var a=o.xAdvance*$J+aQ,s=e+1;s<i&&(n=t.charAt(s),o=$G.fontAtlas.getLetterDefinitionForChar(n,$G));++s){if(a+o.offsetX*$J+o.w*$J>_Q&&!GG(n)&&_Q>0)return r;if(a+=o.xAdvance*$J+aQ,"\n"===n||GG(n)||UG(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(t,e){if(t>=UJ.length){var i=new LJ;UJ.push(i)}UJ[t].char=e,UJ[t].hash=""+e.charCodeAt(0)+$G.hash,UJ[t].valid=!1},_recordLetterInfo:function(t,e,i,n){if(i>=UJ.length){var r=new LJ;UJ.push(r)}var o=""+e.charCodeAt(0)+$G.hash;UJ[i].line=n,UJ[i].char=e,UJ[i].hash=o,UJ[i].valid=$G.fontAtlas.getLetter(o).valid,UJ[i].x=t.x,UJ[i].y=t.y},_alignText:function(){KJ=0,GJ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),cQ===vW.SHRINK&&iQ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||cQ===vW.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(t){var e=!0;t||(t=.1,e=!1),iQ=t,e&&this._updateContent()},_shrinkLabelToContentSize:function(t){for(var e=0,i=0|iQ,n=0;e<i;){var r=n=e+i+1>>1;if(r<=0)break;$J=r/nQ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?i=n-1:e=n}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:function(){return KJ>WJ.height},_isHorizontalClamp:function(){for(var t=!1,e=0,i=eQ.length;e<i;++e){var n=UJ[e];if(n.valid){var r=$G.fontAtlas.getLetterDefinitionForChar(n.char,$G);if(!r)continue;var o=n.x+r.w*$J,a=n.line;if(uQ>0)if(lQ){if(GJ[a]>WJ.width&&(o>WJ.width||o<0)){t=!0;break}}else if(o>WJ.width){t=!0;break}}}return t},_isHorizontalClamped:function(t,e){var i=GJ[e],n=t>WJ.width||t<0;return lQ?i>WJ.width&&n:n},_updateQuads:function(){if(!zJ)return!1;var t=tQ?tQ.texture:$G.fontAtlas.getTexture(),e=zJ.renderData;e.dataLength=0,e.resize(0,0);for(var i=VJ.anchorPoint,n=WJ,r=i.x*n.width,o=i.y*n.height,a=!0,s=0,c=eQ.length;s<c;++s){var l=UJ[s];if(l.valid){var u=$G.fontAtlas.getLetter(l.hash);if(u){FJ.height=u.h,FJ.width=u.w,FJ.x=u.u,FJ.y=u.v;var h=l.y+JJ;if(hQ>0){if(h>QJ){var _=h-QJ;FJ.y+=_,FJ.height-=_,h-=_}h-u.h*$J<ZJ&&cQ===vW.CLAMP&&(FJ.height=h<ZJ?0:(h-ZJ)/$J)}var f=l.line,p=l.x+u.w/2*$J+HJ[f];if(uQ>0&&this._isHorizontalClamped(p,f))if(cQ===vW.CLAMP)FJ.width=0;else if(cQ===vW.SHRINK){if(WJ.width>u.w){a=!1;break}FJ.width=0}if(FJ.height>0&&FJ.width>0){var d=this._determineRect(),m=l.x+HJ[l.line];this.appendQuad(zJ,t,FJ,d,m-r,h-o,$J)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var t=tQ.isRotated(),e=tQ.getOriginalSize(),i=tQ.getRect(),n=tQ.getOffset(),r=n.x+(e.width-i.width)/2,o=n.y-(e.height-i.height)/2;if(t){var a=FJ.x;FJ.x=i.x+i.height-FJ.y-FJ.height-o,FJ.y=a+i.y-r,FJ.y<0&&(FJ.height+=o)}else FJ.x+=i.x-r,FJ.y+=i.y+o;return t},_computeAlignmentOffset:function(){switch(HJ.length=0,rQ){case dW.LEFT:for(var t=0;t<YJ;++t)HJ.push(0);break;case dW.CENTER:for(var e=0,i=GJ.length;e<i;e++)HJ.push((WJ.width-GJ[e])/2);break;case dW.RIGHT:for(var n=0,r=GJ.length;n<r;n++)HJ.push(WJ.width-GJ[n])}if(JJ=WJ.height,oQ!==mW.TOP){var o=WJ.height-KJ+sQ*this._getFontScale()-nQ*$J;oQ===mW.BOTTOM?JJ-=o:JJ-=o/2}},_setupBMFontOverflowMetrics:function(){var t=WJ.width,e=WJ.height;cQ===vW.RESIZE_HEIGHT&&(e=0),cQ===vW.NONE&&(t=0,e=0),uQ=t,hQ=e,jJ.width=t,jJ.height=e,_Q=t}},pQ=new Ti(255,255,255,255),dQ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){var e=t.node;pQ.set(t.color),pQ.a=255*e._uiProps.opacity,KU(e,0,t.renderData,pQ)},appendQuad:function(t,e,i,n,r,o,a){var s=t.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=e.width,h=e.height,_=i.width,f=i.height,p=0,d=0,m=0,v=0;n?(p=i.x/u,v=(i.x+f)/u,d=(i.y+_)/h,m=i.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=i.x/u,v=(i.x+_)/u,d=(i.y+f)/h,m=i.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};zt(dQ,fQ);var mQ=null,vQ=Vt(fQ,{getAssemblerData:function(){return mQ||(mQ=new ZG(1024,1024)),mQ.getTexture()},_updateFontFamily:function(t){$G.fontAtlas=mQ,$G.fontFamily=this._getFontFamily(t);var e=t.getComponent(aY);e&&e.enabled?($G.isOutlined=!0,$G.margin=e.width,$G.out=e.color.clone(),$G.out.a=e.color.a*t.color.a/255):($G.isOutlined=!1,$G.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){$G.fontDesc=this._getFontDesc(),$G.color=t.color,$G.hash=function(t){var e=t.color.toHEX(),i="";return t.isOutlined&&t.margin>0&&(i=i+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+i}($G)},_getFontDesc:function(){return $G.fontSize.toString()+"px "+$G.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),gQ=new Ti(255,255,255,255),yQ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){if(t.renderData){var e=t.node;gQ.a=255*e._uiProps.opacity,KU(e,0,t.renderData,gQ)}},updateColor:function(){},appendQuad:dQ.appendQuad};zt(yQ,vQ);var xQ=xW.Overflow,SQ=(1/255).toFixed(3),bQ=null,CQ=null,AQ=null,TQ="",wQ="",EQ=0,PQ=0,IQ=[],RQ=new $i,DQ=0,MQ=0,OQ=0,BQ=new Ti,NQ="",LQ=xQ.NONE,FQ=!1,zQ=null,VQ=Ti.BLACK.clone(),kQ=null,UQ=Ti.BLACK.clone(),GQ=new en,HQ=$i.ZERO.clone(),jQ=$i.ZERO.clone(),WQ=qi.ZERO.clone(),qQ=qi.ZERO.clone(),XQ=0,YQ=0,KQ=!1,JQ=!1,QQ=!1,ZQ=["left","center","right"],$Q={getAssemblerData:function(){return xW._canvasPool.get()},resetAssemblerData:function(t){t&&xW._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=EQ,e.setContentSize(RQ),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),bQ=null,CQ=null,AQ=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){NQ=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties:function(t,e){var i=t.assemblerData;i&&(bQ=i.context,CQ=i.canvas,AQ=t.spriteFrame,wQ=t.string.toString(),EQ=t.fontSize,PQ=EQ,LQ=t.overflow,jQ.width=RQ.width=e.width,jQ.height=RQ.height=e.height,YQ=t.underlineHeight,DQ=t.lineHeight,MQ=t.horizontalAlign,OQ=t.verticalAlign,BQ=t.color,t.node._uiProps.opacity,KQ=t.isBold,JQ=t.isItalic,QQ=t.isUnderline,FQ=LQ!==xQ.NONE&&(LQ===xQ.RESIZE_HEIGHT||t.enableWrapText),(zQ=(zQ=aY&&t.getComponent(aY))&&zQ.enabled&&zQ.width>0?zQ:null)&&VQ.set(zQ.color),(kQ=(kQ=JK&&t.getComponent(JK))&&kQ.enabled?kQ:null)&&UQ.set(kQ.color),this._updatePaddingRect())},_updatePaddingRect:function(){var t=0,e=0,i=0,n=0,r=0;if(HQ.width=HQ.height=0,zQ&&(t=e=i=n=r=zQ.width,HQ.width=HQ.height=2*r),kQ){var o=kQ.blur+r,a=kQ.offset.x,s=kQ.offset.y;i=Math.max(i,-a+o),n=Math.max(n,a+o),t=Math.max(t,s+o),e=Math.max(e,-s+o)}if(JQ){var c=PQ*Math.tan(.20943951);n+=c,HQ.width+=c}GQ.x=i,GQ.y=t,GQ.width=i+n,GQ.height=t+e},_calculateFillTextStartPosition:function(){var t=0;MQ===dW.RIGHT?t=RQ.width-GQ.width:MQ===dW.CENTER&&(t=(RQ.width-GQ.width)/2);var e=this._getLineHeight()*(IQ.length-1),i=EQ*(1-DG/2);if(OQ!==mW.TOP){var n=e+GQ.height+EQ-RQ.height;OQ===mW.BOTTOM?i-=n+=DG/2*EQ:i-=n/2}i+=0*EQ,WQ.set(t+GQ.x,i+GQ.y)},_updateTexture:function(t){if(bQ&&CQ){bQ.clearRect(0,0,CQ.width,CQ.height),bQ.font=TQ,this._calculateFillTextStartPosition();var e=this._getLineHeight();bQ.lineJoin="round",zQ?(bQ.fillStyle="rgba("+VQ.r+", "+VQ.g+", "+VQ.b+", "+SQ+")",bQ.fillRect(0,0,CQ.width,CQ.height)):t._srcBlendFactor===Pn.SRC_ALPHA&&(bQ.fillStyle="rgba("+BQ.r+", "+BQ.g+", "+BQ.b+", "+SQ+")",bQ.fillRect(0,0,CQ.width,CQ.height)),bQ.fillStyle="rgb("+BQ.r+", "+BQ.g+", "+BQ.b+")";var i=WQ.x,n=0;this._drawTextEffect(WQ,e);for(var r=0;r<IQ.length;++r)n=WQ.y+r*e,zQ&&bQ.strokeText(IQ[r],i,n),bQ.fillText(IQ[r],i,n);kQ&&(bQ.shadowColor="transparent"),this._uploadTexture(t)}},_uploadTexture:function(t){if(t.cacheMode===xW.CacheMode.BITMAP){var e=t.ttfSpriteFrame;iG.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}var i;AQ&&CQ&&(i=AQ instanceof cG?AQ.texture:AQ,0!==CQ.width&&0!==CQ.height&&(i.reset({width:CQ.width,height:CQ.height,mipmapLevel:1}),i.uploadData(CQ),AQ instanceof cG&&(AQ.rect=new en(0,0,CQ.width,CQ.height),AQ._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),u.director.root&&u.director.root.batcher2D&&u.director.root.batcher2D._releaseDescriptorSetCache(i.getHash())))},_calDynamicAtlas:function(t){if(!(t.cacheMode!==xW.CacheMode.BITMAP||!CQ||CQ.width<=0||CQ.height<=0)){var e=t.ttfSpriteFrame;iG.packToDynamicAtlas(t,e)}},_setupOutline:function(){bQ.strokeStyle="rgba("+VQ.r+", "+VQ.g+", "+VQ.b+", "+VQ.a/255+")",bQ.lineWidth=2*zQ.width},_setupShadow:function(){bQ.shadowColor="rgba("+UQ.r+", "+UQ.g+", "+UQ.b+", "+UQ.a/255+")",bQ.shadowBlur=kQ.blur,bQ.shadowOffsetX=kQ.offset.x,bQ.shadowOffsetY=-kQ.offset.y},_drawTextEffect:function(t,e){if(kQ||zQ||QQ){var i=IQ.length>1&&kQ,n=this._measureText(bQ,TQ),r=0,o=0;kQ&&this._setupShadow(),zQ&&this._setupOutline();for(var a=0;a<IQ.length;++a)r=t.x,o=t.y+a*e,i&&(zQ&&bQ.strokeText(IQ[a],r,o),bQ.fillText(IQ[a],r,o)),QQ&&(XQ=n(IQ[a]),MQ===dW.RIGHT?qQ.x=t.x-XQ:MQ===dW.CENTER?qQ.x=t.x-XQ/2:qQ.x=t.x,qQ.y=o+PQ/8,bQ.fillRect(qQ.x,qQ.y,XQ,YQ));i&&(bQ.shadowColor="transparent")}},_updateLabelDimensions:function(){RQ.width=Math.min(RQ.width,2048),RQ.height=Math.min(RQ.height,2048);var t=!1;CQ.width!==RQ.width&&(CQ.width=RQ.width,t=!0),CQ.height!==RQ.height&&(CQ.height=RQ.height,t=!0),t&&(bQ.font=TQ),bQ.textAlign=ZQ[MQ],bQ.textBaseline="alphabetic"},_getFontDesc:function(){var t=EQ.toString()+"px ";return t+=NQ,KQ&&(t="bold "+t),JQ&&(t="italic "+t),t},_getLineHeight:function(){return 0|(0===DQ?EQ:DQ*EQ/PQ)},_calculateParagraphLength:function(t,e){for(var i,n=[],r=st(t);!(i=r()).done;){var o=HG(e,i.value,TQ);n.push(o)}return n},_measureText:function(t,e){return function(i){return HG(t,i,e)}},_calculateShrinkFont:function(t){if(bQ){var e=this._calculateParagraphLength(t,bQ),i=0,n=0,r=0;if(FQ){var o=jQ.width,a=jQ.height;if(o<0||a<0)return;n=a+1;for(var s=0,c=0|EQ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){I(4003);break}EQ=l,TQ=this._getFontDesc(),bQ.font=TQ;var u=this._getLineHeight();for(n=0,i=0;i<t.length;++i){var h=HG(bQ,t[i],TQ);n+=WG(t[i],h,o,this._measureText(bQ,TQ)).length*u}n>a?c=l-1:s=l}0===s?I(4003):(EQ=s,TQ=this._getFontDesc(),bQ.font=TQ)}else{for(n=t.length*this._getLineHeight(),i=0;i<t.length;++i)r<e[i]&&(r=e[i]);var _=(RQ.width-GQ.width)/r,f=RQ.height/n;EQ=PQ*Math.min(1,_,f)|0,TQ=this._getFontDesc(),bQ.font=TQ}}},_calculateWrapText:function(t){if(FQ&&bQ){IQ=[];for(var e=jQ.width,i=0;i<t.length;++i){var n=HG(bQ,t[i],TQ),r=WG(t[i],n,e,this._measureText(bQ,TQ));IQ=IQ.concat(r)}}},_calculateLabelFont:function(){if(bQ){var t=wQ.split("\n");switch(IQ=t,TQ=this._getFontDesc(),bQ.font=TQ,LQ){case xQ.NONE:for(var e=0,i=0,n=0;n<t.length;++n){var r=HG(bQ,t[n],TQ);e=e>r?e:r}i=(IQ.length+DG)*this._getLineHeight();var o=parseFloat(e.toFixed(2)),a=parseFloat(i.toFixed(2));RQ.width=o+GQ.width,RQ.height=a+GQ.height,jQ.width=o+HQ.width,jQ.height=a+HQ.height;break;case xQ.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case xQ.CLAMP:this._calculateWrapText(t);break;case xQ.RESIZE_HEIGHT:this._calculateWrapText(t);var s=(IQ.length+DG)*this._getLineHeight();RQ.height=s+GQ.height,jQ.height=s+HQ.height}}}},tZ=Ti.WHITE.clone(),eZ={createData:function(t){var e=t.requestRenderData();e.dataLength=2,e.resize(4,6);var i=e.chunk.vb;i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)Ti.toArray(i,tZ,n),n+=9;return e},fillBuffers:function(t){var e=t.renderData.chunk,i=t.renderData.data,n=t.node,r=e.vb,o=i[0],a=i[1];n.updateWorldTransform();var s=n._pos,c=n._rot,l=n._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,p=c.x,d=c.y,m=c.z,v=c.w,g=p*d,y=m*v,x=p*p-d*d,S=v*v-m*m,b=S+x,C=2*(g-y),A=S-x,T=2*(g+y),w=s.x,E=s.y;r[0]=b*u+C*_+w,r[1]=A*_+T*u+E,r[9]=b*h+C*_+w,r[10]=A*_+T*h+E,r[18]=b*u+C*f+w,r[19]=A*f+T*u+E,r[27]=b*h+C*f+w,r[28]=A*f+T*h+E;var P=e.bufferId,I=e.vertexOffset,R=e.vertexAccessor.getMeshBuffer(e.bufferId),D=e.vertexAccessor.getIndexBuffer(P),M=R.indexOffset;D[M++]=I,D[M++]=I+1,D[M++]=I+2,D[M++]=I+2,D[M++]=I+1,D[M++]=I+3,R.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var i=t.node._uiProps.uiTransformComp,n=i.width,r=i.height,o=i.anchorX*n,a=i.anchorY*r,s=e.data;s[0].x=-o,s[0].y=-a,s[1].x=n-o,s[1].y=r-a}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var i=e.chunk.vb,n=t.ttfSpriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7]}},updateColor:function(){}};zt(eZ,$Q);var iZ=t("labelAssembler",{getAssembler:function(t){var e=eZ;return t.font instanceof IG?e=dQ:t.cacheMode===xW.CacheMode.CHAR&&(e=yQ),e}});xW.Assembler=iZ;var nZ=cY.FillType,rZ=new Gi,oZ=new Ei,aZ={updateRenderData:function(t){var e=t.spriteFrame;iG.packToDynamicAtlas(t,e);var i=t.renderData;if(i&&e){if(i.updateRenderData(t,e),!i.vertDirty)return;var n=t.fillStart,r=t.fillRange;r<0&&(n+=r,r=-r),r=(r=(r=n+r)>1?1:r)<0?0:r;var o=(n=(n=n>1?1:n)<0?0:n)+(r=(r-=n)<0?0:r);o=o>1?1:o,this.updateUVs(t,n,o),this.updateVertexData(t,n,o)}},updateUVs:function(t,e,i){var n=t.spriteFrame,r=t.renderData.chunk.vb,o=n.width,a=n.height,s=n.rect,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0;switch(n.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,p=m=(s.x+s.height)/o,f=v=l,h=d=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=p=c,_=m=(s.x+s.width)/o,h=f=l,d=v=s.y/a),t.fillType){case nZ.HORIZONTAL:r[3]=u+(_-u)*e,r[4]=h+(f-h)*e,r[12]=u+(_-u)*i,r[13]=h+(f-h)*i,r[21]=p+(m-p)*e,r[22]=d+(v-d)*e,r[30]=p+(m-p)*i,r[31]=d+(v-d)*i;break;case nZ.VERTICAL:r[3]=u+(p-u)*e,r[4]=h+(d-h)*e,r[12]=_+(m-_)*e,r[13]=f+(v-f)*e,r[21]=u+(p-u)*i,r[22]=h+(d-h)*i,r[30]=_+(m-_)*i,r[31]=f+(v-f)*i;break;default:O(2626)}},updateVertexData:function(t,e,i){var n=t.renderData.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(t.fillType){case nZ.HORIZONTAL:f=l+(h-l)*i,l+=(h-l)*e,h=f;break;case nZ.VERTICAL:f=u+(_-u)*i,u+=(_-u)*e,_=f;break;default:O(2626)}n[0].x=l,n[0].y=u,n[1].x=h,n[1].y=u,n[2].x=l,n[2].y=_,n[3].x=h,n[3].y=_},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6);for(var i,n=st(e.data);!(i=n()).done;)i.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(rZ);for(var i=t.renderData.floatStride,n=t.renderData.data,r=e.vb,o=0,a=0;a<4;a++){var s=n[a];Ei.transformMat4(oZ,s,rZ),r[o=a*i]=oZ.x,r[o+1]=oZ.y,r[o+2]=oZ.z}},fillBuffers:function(t){var e=t.renderData,i=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,i),e.vertDirty=!1);var n=i.bufferId,r=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),a=i.vertexAccessor.getIndexBuffer(n),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,i=e.chunk.vb,n=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<4;u++)i[r]=a,i[r+1]=s,i[r+2]=c,i[r+3]=l,r+=n}},sZ=2*Math.PI,cZ=1e-6,lZ=new Gi,uZ=new Ei,hZ=[new qi,new qi,new qi,new qi],_Z=new Array(4),fZ=new Array(8),pZ=[new qi,new qi,new qi,new qi],dZ=[new qi,new qi,new qi,new qi],mZ=new qi,vZ=[new qi,new qi,new qi,new qi];function gZ(t,e,i,n,r,o,a){var s=Math.sin(o);s=Math.abs(s)>cZ?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>cZ?c:0)){if(l=s/c,(t-r.x)*c>0){var h=r.y+l*(t-r.x);a[0].x=t,a[0].y=h}if((e-r.x)*c>0){var _=r.y+l*(e-r.x);a[2].x=e,a[2].y=_}}if(0!==s){if(u=c/s,(n-r.y)*s>0){var f=r.x+u*(n-r.y);a[3].x=f,a[3].y=n}if((i-r.y)*s>0){var p=r.x+u*(i-r.y);a[1].x=p,a[1].y=i}}}function yZ(t,e){var i=e.x-t.x,n=e.y-t.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function xZ(t,e,i,n,r){var o=_Z,a=o[0],s=o[1],c=o[2],l=o[3];t[e].x=i.x,t[e].y=i.y,t[e+1].x=n.x,t[e+1].y=n.y,t[e+2].x=r.x,t[e+2].y=r.y,SZ((i.x-a)/(c-a),(i.y-s)/(l-s),t,e),SZ((n.x-a)/(c-a),(n.y-s)/(l-s),t,e+1),SZ((r.x-a)/(c-a),(r.y-s)/(l-s),t,e+2)}function SZ(t,e,i,n){var r=fZ,o=r[0]+(r[2]-r[0])*t,a=r[4]+(r[6]-r[4])*t,s=r[1]+(r[3]-r[1])*t,c=r[5]+(r[7]-r[5])*t,l=i[n];l.u=o+(a-o)*e,l.v=s+(c-s)*e}for(var bZ={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;iG.packToDynamicAtlas(t,e),this.updateUVs(t);var i=t.renderData;if(i&&e){if(!i.vertDirty)return;var n=i.data,r=t.fillStart,o=t.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=sZ)+(o*=sZ);!function(t){var e=t.node._uiProps.uiTransformComp,i=e.width,n=e.height,r=e.anchorX*i,o=e.anchorY*n,a=-r,s=-o,c=i-r,l=n-o,u=_Z;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=t.fillCenter,_=mZ.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=mZ.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;hZ[0].x=hZ[3].x=a,hZ[1].x=hZ[2].x=c,hZ[0].y=hZ[1].y=s,hZ[2].y=hZ[3].y=l;for(var p,d=st(vZ);!(p=d()).done;){var m=p.value;qi.set(m,0,0)}_!==u[0]&&qi.set(vZ[0],3,0),_!==u[2]&&qi.set(vZ[2],1,2),f!==u[1]&&qi.set(vZ[1],0,1),f!==u[3]&&qi.set(vZ[3],2,3)}(t),function(t){var e=t.width,i=t.height,n=t.getRect(),r=0,o=0,a=0,s=0,c=fZ;t.isRotated()?(r=n.x/e,o=(n.x+n.height)/e,a=n.y/i,s=(n.y+n.width)/i,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=n.x/e,o=(n.x+n.width)/e,a=n.y/i,s=(n.y+n.height)/i,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(e),gZ(_Z[0],_Z[2],_Z[1],_Z[3],mZ,r,pZ),gZ(_Z[0],_Z[2],_Z[1],_Z[3],mZ,r+o,dZ);for(var s=0,c=0;c<4;++c){var l=vZ[c];if(l)if(o>=sZ)i.dataLength=s+3,xZ(n,s,mZ,hZ[l.x],hZ[l.y]),s+=3;else{var u=yZ(mZ,hZ[l.x]),h=yZ(mZ,hZ[l.y]);h<u&&(h+=sZ),u-=sZ,h-=sZ;for(var _=0;_<3;++_)u>=a||(u>=r?(i.dataLength=s+3,xZ(n,s,mZ,hZ[l.x],h>=a?dZ[c]:hZ[l.y]),s+=3):h>r&&(h<=a?(i.dataLength=s+3,xZ(n,s,mZ,pZ[c],hZ[l.y]),s+=3):(i.dataLength=s+3,xZ(n,s,mZ,pZ[c],dZ[c]),s+=3))),u+=sZ,h+=sZ}}i.resize(s,s),i.updateRenderData(t,e)}},fillBuffers:function(t){var e=t.node,i=t.renderData,n=i.chunk;(e.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexAndUVData(t,n),i.vertDirty=!1),this.updataColorLate(t);for(var r=n.bufferId,o=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),s=n.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<i.indexCount;l++)s[c+l]=o+l;a.indexOffset+=i.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(lZ);for(var i=t.renderData,n=i.floatStride,r=t.renderData.data,o=e.vb,a=i.vertexCount,s=0,c=0;c<a;c++){var l=r[c];Ei.set(uZ,l.x,l.y,0),Ei.transformMat4(uZ,uZ,lZ),o[s+0]=uZ.x,o[s+1]=uZ.y,o[s+2]=uZ.z,o[s+3]=l.u,o[s+4]=l.v,s+=n}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate:function(t){for(var e=t.renderData,i=e.chunk.vb,n=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)i[o]=s,i[o+1]=c,i[o+2]=l,i[o+3]=u,o+=n},updateColor:function(){}},CZ=[],AZ=0;AZ<4;AZ++)CZ.push(new Ei);for(var TZ={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){var e=t.spriteFrame;iG.packToDynamicAtlas(t,e),this.updateUVs(t);var i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.updateRenderData(t,e))},updateWorldVerts:function(t,e){var i=t.renderData,n=e.vb,r=i.data,o=t.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,p=c.m12,d=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+p,S=v+p,b=g+d,C=y+d;n[0]=x,n[1]=b,n[9]=S,n[10]=b,n[18]=x,n[19]=C,n[27]=S,n[28]=C}else{var A=l*m,T=l*v,w=u*m,E=u*v,P=h*g+p,I=h*y+p,R=_*g+d,D=_*y+d;n[0]=A+P,n[1]=w+R,n[9]=T+P,n[10]=E+R,n[18]=A+I,n[19]=w+D,n[27]=T+I,n[28]=E+D}},fillBuffers:function(t){if(null!==t){var e=t.renderData,i=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,i),e.vertDirty=!1);var n=i.bufferId,r=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(n),a=i.vertexAccessor.getIndexBuffer(n),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(t){var e=t.renderData;if(e){var i=t.node._uiProps.uiTransformComp,n=e.data,r=i.width,o=i.height,a=i.anchorX*r,s=i.anchorY*o,c=0,l=0,u=0,h=0;if(t.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=t.spriteFrame,f=_.getOriginalSize(),p=_.getRect(),d=f.width,m=f.height,v=p.width,g=p.height,y=_.getOffset(),x=r/d,S=o/m,b=y.x+(d-v)/2,C=y.x-(d-v)/2;c=b*x-a,l=(y.y+(m-g)/2)*S-s,u=r+C*x-a,h=o+(y.y-(m-g)/2)*S-s}n[0].x=c,n[0].y=l,n[1].x=u,n[1].y=h,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,i=t.spriteFrame.uv;e[3]=i[0],e[4]=i[1],e[12]=i[2],e[13]=i[3],e[21]=i[4],e[22]=i[5],e[30]=i[6],e[31]=i[7]}},updateColor:function(t){for(var e=t.renderData,i=e.chunk.vb,n=5,r=t.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,n+=e.floatStride)i[n]=o,i[n+1]=a,i[n+2]=s,i[n+3]=c}},wZ=new Ei,EZ=new Gi,PZ={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(t){var e=t.spriteFrame;iG.packToDynamicAtlas(t,e),this.updateUVs(t);var i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData.data,i=t.node._uiProps.uiTransformComp,n=i.width,r=i.height,o=i.anchorX*n,a=i.anchorY*r,s=t.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=n-c-l,f=r-u-h,p=n/(c+l),d=r/(u+h);p=Number.isNaN(p)||p>1?1:p,d=Number.isNaN(d)||d>1?1:d,_=_<0?0:_,f=f<0?0:f,e[0].x=-o,e[0].y=-a,e[1].x=c*p-o,e[1].y=h*d-a,e[2].x=e[1].x+_,e[2].y=e[1].y+f,e[3].x=n-o,e[3].y=r-a},fillBuffers:function(t){var e=t.renderData,i=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,i),e.vertDirty=!1);for(var n=i.bufferId,r=i.vertexOffset,o=i.vertexAccessor.getMeshBuffer(i.bufferId),a=i.vertexAccessor.getIndexBuffer(n),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(EZ);for(var i=t.renderData,n=i.floatStride,r=i.data,o=e.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];Ei.set(wZ,u.x,c.y,0),Ei.transformMat4(wZ,wZ,EZ),a=(4*s+l)*n,o[a++]=wZ.x,o[a++]=wZ.y,o[a++]=wZ.z}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,i=e.chunk.vb,n=e.floatStride,r=t.spriteFrame.uvSliced,o=3,a=0;a<16;a++)i[o]=r[a].u,i[o+1]=r[a].v,o+=n},updateColor:function(t){for(var e=t.renderData,i=e.chunk.vb,n=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<16;u++)i[r]=a,i[r+1]=s,i[r+2]=c,i[r+3]=l,r+=n}},IZ=[],RZ=0;RZ<4;RZ++)IZ.push(new Ei);var DZ=new Gi,MZ={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,i=t.spriteFrame;if(i&&e&&(e.updateRenderData(t,i),e.vertDirty)){var n=t.node._uiProps.uiTransformComp,r=Math.abs(n.width),o=Math.abs(n.height),a=i.getRect(),s=i.insetLeft,c=i.insetRight,l=a.width-s-c,u=i.insetTop,h=i.insetBottom,_=a.height-u-h,f=r-s-c,p=o-u-h;f=f>0?f:0,p=p>0?p:0;var d=0===l?f:f/l,m=0===_?p:p/_,v=Math.ceil(m+2),g=Math.ceil(d+2);e.dataLength=Math.max(8,v+1,g+1),this.updateVerts(t,f,p,v,g),e.resize(v*g*4,v*g*6)}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,i=t.renderData,n=i.chunk;(e.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexAndUVData(t,n),i.vertDirty=!1),this.updataColorLate(t);for(var r=n.bufferId,o=n.vertexOffset,a=n.vertexAccessor.getMeshBuffer(n.bufferId),s=n.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<i.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(t,e){var i=t.node;i.getWorldMatrix(DZ);var n=t.renderData,r=n.floatStride,o=n.data,a=e.vb,s=i._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=t.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,p=u.rect,d=u.insetLeft,m=u.insetRight,v=p.width-d-m,g=u.insetTop,y=u.insetBottom,x=p.height-g-y,S=c-d-m,b=l-g-y;S=S>0?S:0,b=b>0?b:0;for(var C=0===v?S:S/v,A=0===x?b:b/x,T=Math.ceil(A+2),w=Math.ceil(C+2),E=0,P=0,I=0,R=0,D=0,M=0,O=T;M<O;++M){R=o[M].y,D=o[M+1].y;for(var B=0,N=w;B<N;++B){P=o[B].x,I=o[B+1].x,Ei.set(IZ[0],P,R,0),Ei.set(IZ[1],I,R,0),Ei.set(IZ[2],P,D,0),Ei.set(IZ[3],I,D,0);for(var L=0;L<4;L++){var F=IZ[L];Ei.transformMat4(F,F,DZ);var z=L*r;a[E+z]=F.x,a[E+z+1]=F.y,a[E+z+2]=F.z}E+=4*r}}E=0;for(var V=r,k=2*r,U=3*r,G=4*r,H=0,j=0,W=[],q=[],X=0,Y=T;X<Y;++X){j=b>x?b>=X*x?1:A%1:A;for(var K=0,J=w;K<J;++K){H=S>v?S>=K*v?1:C%1:C;var Q=E+3,Z=Q+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<T-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===T-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[0].v):K<w-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[1].v):K===w-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=_[0]):K<w-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=f[1].u):K===w-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<T-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===T-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),a[Q]=W[0],a[Z]=q[0],a[Q+V]=W[1],a[Z+V]=q[1],a[Q+k]=W[2],a[Z+k]=q[2],a[Q+U]=W[3],a[Z+U]=q[3],E+=G}}},updateVerts:function(t,e,i,n,r){var o,a,s=t.node._uiProps.uiTransformComp,c=t.renderData.data,l=t.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,p=s.anchorY*_,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(d+m)>1?1:s.width/(d+m),b=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*e)/1e3%v==0?v:e%v:e,a=x>0?Math.floor(1e3*i)/1e3%x==0?x:i%x:i;for(var C=0;C<=r;C++)0===C?c[C].x=-f:C>0&&C<r?c[C].x=1===C?d*S+Math.min(v,e)-f:v>0?C===r-1?d+o+v*(C-2)-f:d+Math.min(v,e)+v*(C-2)-f:d+e-f:C===r&&(c[C].x=Math.min(d+e+m,h)-f);for(var A=0;A<=n;A++)0===A?c[A].y=-p:A>0&&A<n?c[A].y=1===A?y*b+Math.min(x,i)-p:x>0?A===n-1?y+a+(A-2)*x-p:y+Math.min(x,i)+(A-2)*x-p:y+i-p:A===n&&(c[A].y=Math.min(y+i+g,_)-p)},updataColorLate:function(t){for(var e=t.renderData,i=e.chunk.vb,n=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)i[o]=s,i[o+1]=c,i[o+2]=l,i[o+3]=u,o+=n},updateColor:function(){}},OZ=cY.Type,BZ=cY.FillType,NZ=t("spriteAssembler",{getAssembler:function(t){var e=TZ,i=t;switch(i.type){case OZ.SLICED:e=PZ;break;case OZ.TILED:e=MZ;break;case OZ.FILLED:e=i.fillType===BZ.RADIAL?bZ:aZ}return e}});cY.Assembler=NZ;var LZ=ij.sharedManager,FZ={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){t.type===Hq.IMAGE_STENCIL&&(TZ.updateRenderData(t),TZ.updateColor(t))},fillBuffers:function(t,e){(t.type!==Hq.IMAGE_STENCIL||t.spriteFrame)&&(LZ.pushMask(t),e.finishMergeBatches(),function(t,e){LZ.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(LZ.enterLevel(t),t.type===Hq.IMAGE_STENCIL){TZ.fillBuffers(t,e);var i=t.graphics.getMaterialInstance(0);e.forceMergeBatches(i,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),LZ.enableMask())}},zZ={fillBuffers:function(){LZ.exitMask()}},VZ={getAssembler:function(){return FZ}},kZ={getAssembler:function(){return zZ}};Yq.Assembler=VZ,Yq.PostAssembler=kZ;var UZ=t("MeshBuffer",function(){function t(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var e=t.prototype;return e.initialize=function(t,e,i,n){this._initVDataCount=i,this._initIDataCount=n,this._attributes=e,this._floatsPerVertex=rH(e),this._initVDataCount,this._floatsPerVertex,F(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(t))},e.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},e.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var t=0;t<this._iaPool.length;++t){var e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0},e.setDirty=function(){this._dirty=!0},e.request=function(){return D(9002),!1},e.requireFreeIA=function(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia},e.recycleIA=function(t){for(var e=this._iaPool,i=0;i<this._nextFreeIAHandle;++i)if(t===e[i].ia){var n=e[i];return e[i]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=n)}},e.checkCapacity=function(t,e){var i=this.vertexOffset+t,n=this.indexOffset+e;return!(i>this._initVDataCount||n>this._initIDataCount)},e.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var t=lh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,i=this.indexOffset,n=0;n<t;++n){var r=this._iaPool[n],o=new Float32Array(this.vData.buffer,0,e>>2),a=new Uint16Array(this.iData.buffer,0,i),s=r.vertexBuffers[0];e>s.size&&s.resize(e),s.update(o),2*i>r.indexBuffer.size&&r.indexBuffer.resize(2*i),r.indexBuffer.update(a)}this._dirty=!1}},e.createNewIA=function(t){var e,i,n;if(lh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=t.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,r,r));n=t.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,o,o)),i=[a],this._iaInfo=new Rr(this._attributes,i,n),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),i=this._iaInfo.vertexBuffers,n=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:i,indexBuffer:n}},Q(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}()),GZ=[lD.EventType.MOUSE_DOWN,lD.EventType.MOUSE_MOVE,lD.EventType.MOUSE_UP,lD.EventType.MOUSE_WHEEL],HZ=[lD.EventType.TOUCH_START,lD.EventType.TOUCH_MOVE,lD.EventType.TOUCH_END,lD.EventType.TOUCH_CANCEL],jZ=(new(function(){function t(){this.priority=$R.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],uD._registerEventDispatcher(this),ER.callbacksInvoker.on(Gw.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),ER.callbacksInvoker.on(Gw.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),ER.callbacksInvoker.on(Gw.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return HZ.includes(e)?this.dispatchEventTouch(t):!GZ.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),ne.array.remove(this._processorListToRemove,t)},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(ne.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),ne.array.remove(this._processorListToAdd,t)},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,i=e.length,n=!0,r=0;r<i;++r){var o=e[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(t)){if(n=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),n},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,i=e.length,n=t.touch,r=!0,o=0;o<i;++o){var a=e[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(t.type===kw.TOUCH_START){if(a._handleEventTouch(t)){if(a.claimedTouchIdList.push(n.getID()),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(n.getID());if(-1!==s){if(a._handleEventTouch(t),t.type!==kw.TOUCH_END&&t.type!==kw.TOUCH_CANCEL||ne.array.removeAt(a.claimedTouchIdList,s),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,i=0;i<e;++i)this.addPointerEventProcessor(t[i]);t.length=0;for(var n=this._processorListToRemove,r=n.length,o=0;o<r;++o)this.removePointerEventProcessor(n[o]);n.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,i=0;i<e;++i){var n=t[i],r=n.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;n.cachedCameraPriority=o.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var i=t.node,n=e.node;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var r=i,o=n,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&n:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&i:o&&o.parent}if(r._id===o._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var f=r?r.getSiblingIndex():0,p=o?o.getSiblingIndex():0;return a?f-p:p-f},e._markListDirty=function(){this._isListDirty=!0},t}()),function(){function t(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=rH(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var e=t.prototype;return e.initialize=function(){},e.reset=function(){},e.request=function(){},e.appendBuffers=function(){},e.uploadBuffers=function(){},e.destroy=function(){this._attributes.length=0},Q(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),t}()),WZ=new jl((function(){return{offset:0,length:0}}),32),qZ=function(t,e,i,n){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=i,this.vb=n},XZ=function(t){function e(i,n,r,o){var a;return(a=t.call(this,i,n)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*ue.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*e.IB_SCALE,a._allocateBuffer(),a}$(e,t);var i=e.prototype;return i.destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var i=this._freeLists[e],n=0;n<i.length;++n)WZ.free(i[n])}this._buffers.length=0,this._freeLists.length=0,t.prototype.destroy.call(this)},i.reset=function(){for(var t=0;t<this._buffers.length;++t){var e=this._buffers[t];e.indexOffset=0,e.reset()}},i.getVertexBuffer=function(t){return this._buffers[t].vData},i.getIndexBuffer=function(t){return this._buffers[t].iData},i.getMeshBuffer=function(t){return this._buffers[t]},i.uploadBuffers=function(){for(var t=0;t<this._buffers.length;++t){var e=this._freeLists[t][0],i=this._buffers[t];(!e||e.length<i.vData.byteLength)&&i.uploadBuffers()}},i.appendIndices=function(t,e){var i=this._buffers[t];e.length&&(i.iData.set(e,i.indexOffset),i.indexOffset+=e.length)},i.allocateChunk=function(t,e){for(var i,n=t*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],i=this._freeLists[c];for(var l=0;l<i.length;++l)if(i[l].length>=n){s=i[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(t,e)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,n>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,n),new qZ(this,o,u,h,e)}return D(9004,n),null},i.recycleChunk=function(t){var e=this._freeLists[t.bufferId],i=this._buffers[t.bufferId],n=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=e[a];c&&c.offset<n;)s=c,c=e[++a];if(s&&0==n-(s.offset+s.length)&&(s.length+=r,n=s.offset,r=s.length,c&&c.offset-(n+r)==0&&(s.length+=c.length,e.splice(a,1),WZ.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(n+r))c.offset=n,c.length+=r;else{var l=WZ.alloc();l.offset=n,l.length=r,e.splice(a,0,l)}o=!0}if(o)n+r===i.byteOffset&&(i.byteOffset=n);else{var u=WZ.alloc();u.offset=n,u.length=r,e.push(u)}}},i._allocateChunkFromEntry=function(t,e,i,n){var r=i.length-n,o=i.offset+n,a=this._buffers[t];a.byteOffset<o&&(a.byteOffset=o),L(r>=0,9004,t,i.offset,i.length),0===r?(this._freeLists[t].splice(e,1),WZ.free(i)):(i.offset+=n,i.length=r)},i._allocateBuffer=function(){L(this._buffers.length===this._freeLists.length,9003);var t=new UZ,e=this._vCount*this._floatsPerVertex;t.initialize(this._device,this._attributes,e,this._iCount),this._buffers.push(t);var i=WZ.alloc();i.offset=0,i.length=t.vData.byteLength;var n=[i];return this._freeLists.push(n),this._buffers.length-1},e}(jZ);XZ.IB_SCALE=4;var YZ=new Ur(null),KZ=new Gi,JZ=t("UI",function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new cg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new ZZ,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new ql(64),this._drawBatchPool=new jl((function(){return new YK}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(t){t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),ij.sharedManager.destroy()},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,i=0;i<e.length;i++){var n=e[i];if(n.visibility&t.layer)return n}return null},e.update=function(){for(var t=this._screens,e=0,i=0;i<t.length;++i){var n=t[i],r=n._getRenderScene();if(n.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(n.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var a=this._batches.array[e];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(t){t.uploadBuffers()})),this._bufferAccessors.forEach((function(t){t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((function(t){t.reset()})),this._meshDataArray.forEach((function(t){t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),ij.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=iH);var e=t===iH?36:oH(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var i=this._bufferAccessors.get(e);i||(i=new XZ(this.device,t),this._bufferAccessors.set(e,i)),this._staticVBBuffer=i,this._currBID=-1}return this._staticVBBuffer},e.registerBufferAccessor=function(t,e){this._bufferAccessors.set(t,e)},e.updateBuffer=function(t,e){var i=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=i.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,i,n,r){var o,a=0,s=-1;if(e&&e.chunk){if(!e.isValid())return;a=e.dataHash,o=e.material,s=e.chunk.bufferId}t.stencilStage=ij.sharedManager.stage;var c=t.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,s),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,i?(this._currTexture=i.getGFXTexture(),this._currSampler=i.getGFXSampler(),this._currTextureHash=i.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),n.fillBuffers(t,this)},e.commitIA=function(t,e,i,n,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;t&&(o=-1===t.blendHash?null:t.getBlendState(),c=t.blendHash,t.stencilStage=ij.sharedManager.stage,a=null!==t.customMaterial?ij.sharedManager.getStencilStage(t.stencilStage,n):ij.sharedManager.getStencilStage(t.stencilStage),s=ij.sharedManager.getStencilHash(t.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=t.node.layer,l.inputAssembler=e,l.useLocalData=r||null,i&&(l.texture=i.getGFXTexture(),l.sampler=i.getGFXSampler(),l.textureHash=i.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(n||null,a,s,o,c,null,this),this._batches.push(l)},e.commitModel=function(t,e,i){var n;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;i&&(t.stencilStage!==xH.ENABLED&&t.stencilStage!==xH.DISABLED||(t.stencilStage=ij.sharedManager.stage),n=ij.sharedManager.getStencilStage(t.stencilStage,i),r=ij.sharedManager.getStencilHash(t.stencilStage));var o=u.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(var a=0;a<e.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=e.subModels[a];s.visFlags=t.node.layer,s.model=e,s.texture=null,s.sampler=null,s.useLocalData=null,n||(n=null),s.fillPasses(i,n,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){var e=this._currMaterial;if(e){var i,n=this._currRenderData,r=this._staticVBBuffer;if(n&&n.isMeshBuffer)i=n.requestIA(this.device),-1===this._meshDataArray.indexOf(n)&&this._meshDataArray.push(n);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(i=a.requireFreeIA(this.device)).firstIndex=this._indexStart,i.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,i){var c,l,u=0,h=0;t&&(c=-1===t.blendHash?null:t.getBlendState(),h=t.blendHash,l=null!==t.customMaterial?ij.sharedManager.getStencilStage(t.stencilStage,e):ij.sharedManager.getStencilStage(t.stencilStage),u=ij.sharedManager.getStencilHash(t.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=i,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(e,l,u,c,h,null,this),this._batches.push(_)}}},e.forceMergeBatches=function(t,e,i){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this.autoMergeBatches(i)},e.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var i=t.children,n=t._uiProps,r=n.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*n.localOpacity,n._opacity=a,n.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(t,e){for(var i,n,r,o=t.vertexFormat,a=t.chunk.vb,s=0,c=0;c<o.length;++c){if(i=o[c],(n=Zr[i.format]).hasAlpha)if(r=t.floatStride,n.size/n.count==1)for(var l=~~ai(Math.round(255*e),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(n.size/n.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=e;s+=n.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(i.length>0&&!t._static)for(var l=0;l<i.length;++l){var u=i[l];this.walk(u,e)}n.colorDirty&&(this._opacityDirty--,n.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},Q(t,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}()),QZ=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=u.director.root.device;this._localData=new Float32Array(_d.COUNT),this._localBuffer=t.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,_d.SIZE,_d.SIZE))}var e=t.prototype;return e.initialize=function(t){var e=u.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,YZ.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(YZ),this._descriptorSet.bindBuffer(_d.BINDING,this._localBuffer);var i=jp.SAMPLER_SPRITE;this._descriptorSet.bindTexture(i,t.texture),this._descriptorSet.bindSampler(i,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(t,e,i){return this._transform===t&&this._textureHash===e&&this._samplerHash===i},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var e=t.worldMatrix;Gi.toArray(this._localData,e,_d.MAT_WORLD_OFFSET),Gi.inverseTranspose(KZ,e);var i=Gi.determinant(KZ),n=1/Math.sqrt(i);Gi.multiplyScalar(KZ,KZ,n),Gi.toArray(this._localData,KZ,_d.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},Q(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),ZZ=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new jl((function(){return new QZ}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e,i=u.director.root;if(t.useLocalData){for(var n=this._localDescriptorSetCache,r=0,o=n.length;r<o;r++){var a=n[r];if(a.equals(t.useLocalData,t.textureHash,t.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(t),this._localDescriptorSetCache.push(s),s.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);YZ.layout=t.passes[0].localSetLayout;var c=i.device.createDescriptorSet(YZ),l=jp.SAMPLER_SPRITE;return c.bindTexture(l,t.texture),c.bindSampler(l,t.sampler),c.update(),this._descriptorSetCache.set(e,c),this._dsCacheHashByTexture.set(t.textureHash,e),c},e.update=function(){var t=this._localDescriptorSetCache,e=[];t.forEach((function(i){if(i.isValid())i.uploadLocalData();else{i.reset();var n=t.indexOf(i);e.push(n)}}));for(var i=e.length-1;i>=0;i--)t.splice(e[i],1)},e.reset=function(){var t=this;this._localDescriptorSetCache.forEach((function(e){t._localCachePool.free(e)})),this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){this._descriptorSetCache.forEach((function(t){t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();u.internal.Batcher2D=JZ,G(UZ.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(t){return{name:t,suggest:"please use meshBuffer.accessor."+t+" instead"}}))),k(UZ.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),U(UZ.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),k(JZ.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),U(wH.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),k(wH.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),t("QuadRenderData",function(t){function e(e){var i;return i=t.call(this,e)||this,D(9006),i}return $(e,t),e}(wH));var $Z,t$,e$,i$,n$=null,r$=-1,o$="BES bswy:->@123",a$=Object.create(null),s$=[],c$=3e3;function l$(){for(var t=!0,e=Date.now(),i=s$.length-1;i>=0;i--){var n=s$[i],r=n.fontFamilyName;if(e-n.startTime>c$)D(4933,r),n.onComplete(null,r),s$.splice(i,1);else{var o=n.refWidth,a="40px "+r;n$.font=a,o!==HG(n$,o$,a)?(s$.splice(i,1),n.onComplete(null,r)):t=!1}}t&&(clearInterval(r$),r$=-1)}function u$(t,e,i){var n=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var i,n=t.lastIndexOf("/");return-1!==(i=-1===n?t.substring(0,e)+"_LABEL":t.substring(n+1,e)+"_LABEL").indexOf(" ")&&(i='"'+i+'"'),i}(t);if(a$[n])i(null,n);else{if(!n$){var r=document.createElement("canvas");r.width=100,r.height=100,n$=r.getContext("2d")}var o=HG(n$,o$,"40px "+n),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(n)?s+="@font-face { font-family:"+n+"; src:":s+='@font-face { font-family:"'+n+'"; src:',s+='url("'+t+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=n,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===$Z)if("FontFace"in window){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);$Z=t?parseInt(t[1],10)>42:!e}else $Z=!1;return $Z}())!function(t,e,i){var n=new Promise((function(i,n){!function r(){Date.now()-t>=c$?n():document.fonts.load("40px "+e).then((function(t){t.length>=1?i():setTimeout(r,100)}),(function(){n()}))}()})),r=null,o=new Promise((function(t,e){r=setTimeout(e,c$)}));Promise.race([o,n]).then((function(){r&&(clearTimeout(r),r=null),i(null,e)}),(function(){D(4933,e),i(null,e)}))}(Date.now(),n,i);else{var u={fontFamilyName:n,refWidth:o,onComplete:i,startTime:Date.now()};s$.push(u),-1===r$&&(r$=setInterval(l$,100))}a$[n]=a}}function h$(t,e,i,n){var r=new TG;r._nativeUrl=t,r._nativeAsset=e,n(null,r)}OB.register({".font":u$,".eot":u$,".ttf":u$,".woff":u$,".svg":u$,".ttc":u$}),kB.register({".font":h$,".eot":h$,".ttf":h$,".woff":h$,".svg":h$,".ttc":h$}),u.UI={MeshBuffer:UZ,spriteAssembler:NZ,graphicsAssembler:NJ,labelAssembler:iZ,RenderData:TH,MeshRenderData:wH},function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(t$||(t$={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(e$||(e$={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(i$||(i$={}));var _$,f$=0;function p$(t,e){var i;e.invoking||(e.invoking=!0,(i=e.func).call.apply(i,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());var i=t._operationQueue[0];i&&p$(t,i)})).catch((function(){})))}function d$(t,e,i){var n=i.value;i.value=function(){for(var t=this,e=arguments.length,i=new Array(e),r=0;r<e;r++)i[r]=arguments[r];return new Promise((function(e){var r=f$++,o=t;o._operationQueue.push({id:r,func:n,args:i,invoking:!1}),o._eventTarget.once(r.toString(),e),p$(o,o._operationQueue[0])}))}}function m$(t){return new Promise((function(e){var i=t.play();return void 0===i?e():(i.then(e).catch((function(){var i=function(){t.play().catch((function(){})),e()},n=document.getElementById("GameCanvas");null==n||n.addEventListener("touchend",i,{once:!0}),null==n||n.addEventListener("mousedown",i,{once:!0})})),null)}))}var v$,g$,y$=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var e=t.prototype;return e.play=function(){var t=this;m$(this._domAudio).then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t)})).catch((function(){}))},e.stop=function(){this._domAudio.pause()},Q(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),x$=(lt((_$=function(){function t(t){var e=this;this._domAudio=void 0,this._state=i$.INIT,this._onEnded=void 0,this._eventTarget=new eu,this._operationQueue=[],this._domAudio=t,du.on("hide",this._onHide,this),du.on("show",this._onShow,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=i$.INIT,e._eventTarget.emit(t$.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var e=t.prototype;return e.destroy=function(){du.off("hide",this._onHide,this),du.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(i){t.loadNative(e).then((function(e){i(new t(e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,i){var n=document.createElement("audio"),r="canplaythrough";du.os===au.IOS?r="loadedmetadata":du.browserType===nu.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===n.readyState?c():s()}),8e3),a=function(){clearTimeout(o),n.removeEventListener(r,s,!1),n.removeEventListener("error",c,!1)},s=function(){a(),e(n)},c=function(){a(),i("load audio failure - "+t)};n.addEventListener(r,s,!1),n.addEventListener("error",c,!1),n.src=t}))},t.loadOneShotAudio=function(e,i){return new Promise((function(n,r){t.loadNative(e).then((function(t){var e=new y$(t,i);n(e)})).catch(r)}))},e._onHide=function(){var t=this;this._state===i$.PLAYING&&this.pause().then((function(){t._state=i$.INTERRUPTED,t._eventTarget.emit(t$.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===i$.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(t$.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){return t=ai(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},e.play=function(){var t=this;return new Promise((function(e){m$(t._domAudio).then((function(){t._state=i$.PLAYING,e()})).catch((function(){}))}))},e.pause=function(){return this._domAudio.pause(),this._state=i$.PAUSED,Promise.resolve()},e.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=i$.STOPPED,e()}))},e.onInterruptionBegin=function(t){this._eventTarget.on(t$.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(t$.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(t$.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(t$.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(t$.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(t$.ENDED,t)},Q(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return e$.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=si(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),t}()).prototype,"seek",[d$],Object.getOwnPropertyDescriptor(_$.prototype,"seek"),_$.prototype),lt(_$.prototype,"play",[d$],Object.getOwnPropertyDescriptor(_$.prototype,"play"),_$.prototype),lt(_$.prototype,"pause",[d$],Object.getOwnPropertyDescriptor(_$.prototype,"pause"),_$.prototype),lt(_$.prototype,"stop",[d$],Object.getOwnPropertyDescriptor(_$.prototype,"stop"),_$.prototype),_$),S$=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var e=t.prototype;return e.destroy=function(){this._nativeAudio=void 0},e._now=function(){return performance.now()/1e3},e._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},e.start=function(){this._isPaused=!1,this._startTime=this._now()},e.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},e.stop=function(){this._isPaused=!0,this._startOffset=0},e.seek=function(t){this._startTime=this._now(),this._startOffset=ai(t,0,this.duration)},Q(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),b$=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?console.warn("Audio buffer "+t+" has been cached"):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:console.warn("Audio buffer cache "+t+" has not been added.")},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:console.warn("Audio buffer cache "+t+" has not been added.")},t}()),C$=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,A$=function(){function t(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var e=t.prototype;return e.decodeAudioData=function(t){var e=this;return new Promise((function(i){var n=e._context.decodeAudioData(t,(function(t){i(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==n||n.catch((function(){}))}))},e.runContext=function(){var t=this;return new Promise((function(e){var i=t._context;if(i.resume)if("running"!==i.state){var n=document.getElementById("GameCanvas"),r=function(){i.resume().then(e).catch((function(){}))};null==n||n.addEventListener("touchend",r,{once:!0,capture:!0}),null==n||n.addEventListener("mouseup",r,{once:!0,capture:!0})}else e();else e()}))},e.createBufferSource=function(t,e){var i=this._context.createBufferSource();return void 0!==t&&(i.buffer=t),void 0!==e&&(i.loop=e),i},e.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},e.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(i){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},e.connectContext=function(t){this._context&&t.connect(this._context.destination)},Q(t,[{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();A$.support=!!C$,A$.support&&(g$=new A$);var T$,w$,E$,P$,I$,R$=function(){function t(t,e,i){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=i,this._bufferSourceNode=g$.createBufferSource(t,!1);var n=g$.createGain(e);this._bufferSourceNode.connect(n),g$.connectContext(n)}var e=t.prototype;return e.play=function(){var t=this;this._bufferSourceNode.start(),g$.runContext().then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t),t._currentTimer=window.setTimeout((function(){var e;b$.tryReleasingCache(t._url),null===(e=t.onEnd)||void 0===e||e.call(t)}),1e3*t._duration)})).catch((function(){}))},e.stop=function(){clearTimeout(this._currentTimer),b$.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},Q(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),D$=(lt((v$=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=i$.INIT,this._audioTimer=void 0,this._eventTarget=new eu,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new S$(t),this._gainNode=g$.createGain(),g$.connectContext(this._gainNode),this._src=e,du.on("hide",this._onHide,this),du.on("show",this._onShow,this)}var e=t.prototype;return e.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),b$.tryReleasingCache(this._src),du.off("hide",this._onHide,this),du.off("show",this._onShow,this)},t.load=function(e){return new Promise((function(i){t.loadNative(e).then((function(n){i(new t(n,e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,i){var n=b$.getCache(t);if(n)return b$.retainCache(t),void e(n);var r=new XMLHttpRequest,o="load audio failed: "+t+", status: ";r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?g$.decodeAudioData(r.response).then((function(i){b$.addCache(t,i),e(i)})).catch((function(){})):i(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},t.loadOneShotAudio=function(e,i){return new Promise((function(n,r){t.loadNative(e).then((function(t){var r=new R$(t,i,e);n(r)})).catch(r)}))},e._onHide=function(){var t=this;this._state===i$.PLAYING&&this.pause().then((function(){t._state=i$.INTERRUPTED,t._eventTarget.emit(t$.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===i$.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(t$.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){var e=this;return new Promise((function(i){e._audioTimer.seek(t),e._state===i$.PLAYING?e._doPlay().then(i).catch((function(){})):i()}))},e.play=function(){return this._doPlay()},e._doPlay=function(){var t=this;return new Promise((function(e){t._stopSourceNode(),t._sourceNode=g$.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),g$.runContext().then((function(){t._state=i$.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(t$.ENDED),t._state=i$.INIT)}),1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()})).catch((function(){}))}))},e._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(t){}},e.pause=function(){return this._state===i$.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=i$.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=i$.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.onInterruptionBegin=function(t){this._eventTarget.on(t$.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(t$.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(t$.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(t$.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(t$.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(t$.ENDED,t)},Q(t,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return e$.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=si(t),this._volume=t,g$.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}()).prototype,"seek",[d$],Object.getOwnPropertyDescriptor(v$.prototype,"seek"),v$.prototype),lt(v$.prototype,"play",[d$],Object.getOwnPropertyDescriptor(v$.prototype,"play"),v$.prototype),lt(v$.prototype,"pause",[d$],Object.getOwnPropertyDescriptor(v$.prototype,"pause"),v$.prototype),lt(v$.prototype,"stop",[d$],Object.getOwnPropertyDescriptor(v$.prototype,"stop"),v$.prototype),v$),M$=function(){function t(t){this._audio=void 0,this._audio=t}var e=t.prototype;return e.play=function(){this._audio.play()},e.stop=function(){this._audio.stop()},Q(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),O$=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,i){return new Promise((function(n){(null==i?void 0:i.audioLoadMode)!==e$.DOM_AUDIO&&A$.support?D$.load(e).then((function(e){n(new t(e))})).catch((function(){})):(A$.support||D(5201),x$.load(e).then((function(e){n(new t(e))})).catch((function(){})))}))};var e=t.prototype;return e.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==e$.DOM_AUDIO&&A$.support?D$.loadNative(t):(A$.support||D(5201),x$.loadNative(t))},t.loadOneShotAudio=function(t,e,i){return new Promise((function(n,r){(null==i?void 0:i.audioLoadMode)!==e$.DOM_AUDIO&&A$.support?D$.loadOneShotAudio(t,e).then((function(t){n(new M$(t))})).catch(r):(A$.support||D(5201),x$.loadOneShotAudio(t,e).then((function(t){n(new M$(t))})).catch(r))}))},e.seek=function(t){return this._player.seek(t)},e.play=function(){return this._player.play()},e.pause=function(){return this._player.pause()},e.stop=function(){return this._player.stop()},e.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},e.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},e.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},e.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},e.onEnded=function(t){this._player.onEnded(t)},e.offEnded=function(t){this._player.offEnded(t)},Q(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),t}();O$.maxAudioChannel=24;var B$=t("AudioClip",pc("cc.AudioClip")((I$=P$=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_duration",E$,ot(e)),e._loadMode=e$.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}$(e,t);var i=e.prototype;return i.destroy=function(){var e,i=t.prototype.destroy.call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),i},i.validate=function(){return!!this._meta},i.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},i.getCurrentTime=function(){return this._player?this._player.currentTime:0},i.getVolume=function(){return this._player?this._player.volume:0},i.getLoop=function(){return!!this._player&&this._player.loop},i.setCurrentTime=function(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((function(){}))},i.setVolume=function(t){this._player&&(this._player.volume=t)},i.setLoop=function(t){this._player&&(this._player.loop=t)},i.play=function(){var t;null===(t=this._player)||void 0===t||t.play().catch((function(){}))},i.pause=function(){var t;null===(t=this._player)||void 0===t||t.pause().catch((function(){}))},i.stop=function(){var t;null===(t=this._player)||void 0===t||t.stop().catch((function(){}))},i.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&O$.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},Q(e,[{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=e$.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:i$.INIT}}]),e}(Mu),P$.AudioType=e$,E$=lt((w$=I$).prototype,"_duration",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(w$.prototype,"_nativeDep",[ol],Object.getOwnPropertyDescriptor(w$.prototype,"_nativeDep"),w$.prototype),T$=w$))||T$);function N$(t,e,i){O$.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var n={player:e,url:t,duration:e.duration,type:e.type};i(null,n)})).catch((function(t){i(t)}))}function L$(t,e,i,n){var r=new B$;r._nativeUrl=t,r._nativeAsset=e,r._duration=e.duration,n(null,r)}u.AudioClip=B$,OB.register({".mp3":N$,".ogg":N$,".wav":N$,".m4a":N$}),kB.register({".mp3":L$,".ogg":L$,".wav":L$,".m4a":L$});var F$,z$,V$,k$,U$,G$,H$,j$,W$,q$,X$,Y$,K$,J$,Q$,Z$,$$,t0,e0,i0=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var i=this._findIndex(t,e);return i>-1?(t[i].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)},e.addPlaying=function(t){if(t instanceof O$){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var i=this._findIndex(t,e);return-1!==i&&(_t(t,i),!0)},e.removePlaying=function(t){if(t instanceof O$){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<O$.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},t}());!function(t){t.STARTED="started",t.ENDED="ended"}(e0||(e0={}));var n0=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((F$=pc("cc.AudioSource"),z$=Rc(),V$=wc(),k$=Kc(B$),U$=Kc(B$),G$=Nc(),H$=Nc(),j$=Nc(),W$=Lc(),q$=Nc(),F$(X$=z$(X$=V$((t0=$$=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_clip",K$,ot(e)),e._player=null,ct(e,"_loop",J$,ot(e)),ct(e,"_playOnAwake",Q$,ot(e)),ct(e,"_volume",Z$,ot(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}$(e,t);var i=e.prototype;return i._syncPlayer=function(){var t=this,e=this._clip;this._isLoaded=!1,this._lastSetClip!==e&&(e?e._nativeAsset?(this._lastSetClip=e,O$.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(i){t._lastSetClip===e?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),t._player=i,i.onEnded((function(){i0.removePlaying(i),t.node.emit(e0.ENDED,t)})),i.onInterruptionBegin((function(){i0.removePlaying(i)})),i.onInterruptionEnd((function(){i0.addPlaying(i)})),t._syncStates()):i.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},i.onLoad=function(){this._syncPlayer()},i.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},i.onDisable=function(){var t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()},i.onDestroy=function(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null},i._getRootNode=function(){for(var t,e,i=this.node,n=null===(t=i)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;n;){var r,o,a;n=null===(o=i=null===(r=i)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return i},i.play=function(){var t,e,i=this;this._isLoaded?(i0.discardOnePlayingIfNeeded(),this.state===i$.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((function(){}))),null===(t=this._player)||void 0===t||t.play().then((function(){i0.addPlaying(i._player),i.node.emit(e0.STARTED,i)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},i.pause=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((function(){i0.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},i.stop=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((function(){i0.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},i.playOneShot=function(t,e){void 0===e&&(e=1),t._nativeAsset?O$.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){i0.discardOnePlayingIfNeeded(),t.onPlay=function(){i0.addPlaying(t)},t.onEnd=function(){i0.removePlaying(t)},t.play()})).catch((function(){})):console.error("Invalid audio clip")},i._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach((function(e){var i;null===(i=t[e])||void 0===i||i.call(t)})),t._operationsBeforeLoading.length=0)})).catch((function(){}))},Q(e,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=ai(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=ai(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:i$.INIT}},{key:"playing",get:function(){return this.state===e.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return O$.maxAudioChannel}}]),e}($u),$$.AudioState=i$,$$.EventType=e0,K$=lt((Y$=t0).prototype,"_clip",[k$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J$=lt(Y$.prototype,"_loop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q$=lt(Y$.prototype,"_playOnAwake",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Z$=lt(Y$.prototype,"_volume",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(Y$.prototype,"clip",[U$,G$],Object.getOwnPropertyDescriptor(Y$.prototype,"clip"),Y$.prototype),lt(Y$.prototype,"loop",[H$],Object.getOwnPropertyDescriptor(Y$.prototype,"loop"),Y$.prototype),lt(Y$.prototype,"playOnAwake",[j$],Object.getOwnPropertyDescriptor(Y$.prototype,"playOnAwake"),Y$.prototype),lt(Y$.prototype,"volume",[W$,q$],Object.getOwnPropertyDescriptor(Y$.prototype,"volume"),Y$.prototype),X$=Y$))||X$)||X$)||X$));k(B$,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:n0,targetName:"AudioSource"}]),G(B$.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(t){return{name:t,suggest:"please use AudioSource.prototype."+t+" instead"}}))),u.AudioSourceComponent=n0,ne.setClassAlias(n0,"cc.AudioSourceComponent"),u.log=x,u.warn=S,u.error=b,u.assert=C,u._throw=w,u.logID=I,u.warnID=D,u.errorID=O,u.assertID=L,u.debug=q,u.path={join:yu,extname:xu,mainFileName:Su,basename:bu,dirname:Cu,changeExtname:Au,changeBasename:Tu,_normalize:wu,stripSep:Eu,get sep(){return Pu()}};var r0=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=this._pool.length-1;if(n<0)return null;var r=this._pool[n];this._pool.length=n;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},t}());u.NodePool=r0,u.renderer=MW;var o0,a0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuDescriptorSet=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,i=e.bindings,n=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:n};for(var a=0;a<i.length;++a)for(var s=i[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},i.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},i.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&$r){var i=this._buffers[e];i&&(t[e].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else t[e].type&to&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},Q(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(xo);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(o0||(o0={}));var s0=function(){function t(){}return t.setInstance=function(e){t._instance=e},Q(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function c0(t,e){switch(t){case _n.R8:return e.UNSIGNED_BYTE;case _n.R8SN:return e.BYTE;case _n.R8UI:return e.UNSIGNED_BYTE;case _n.R8I:return e.BYTE;case _n.R16F:return o0.HALF_FLOAT_OES;case _n.R16UI:return e.UNSIGNED_SHORT;case _n.R16I:return e.SHORT;case _n.R32F:return e.FLOAT;case _n.R32UI:return e.UNSIGNED_INT;case _n.R32I:return e.INT;case _n.RG8:return e.UNSIGNED_BYTE;case _n.RG8SN:return e.BYTE;case _n.RG8UI:return e.UNSIGNED_BYTE;case _n.RG8I:return e.BYTE;case _n.RG16F:return o0.HALF_FLOAT_OES;case _n.RG16UI:return e.UNSIGNED_SHORT;case _n.RG16I:return e.SHORT;case _n.RG32F:return e.FLOAT;case _n.RG32UI:return e.UNSIGNED_INT;case _n.RG32I:return e.INT;case _n.RGB8:case _n.SRGB8:return e.UNSIGNED_BYTE;case _n.RGB8SN:return e.BYTE;case _n.RGB8UI:return e.UNSIGNED_BYTE;case _n.RGB8I:return e.BYTE;case _n.RGB16F:return o0.HALF_FLOAT_OES;case _n.RGB16UI:return e.UNSIGNED_SHORT;case _n.RGB16I:return e.SHORT;case _n.RGB32F:return e.FLOAT;case _n.RGB32UI:return e.UNSIGNED_INT;case _n.RGB32I:return e.INT;case _n.BGRA8:case _n.RGBA8:case _n.SRGB8_A8:return e.UNSIGNED_BYTE;case _n.RGBA8SN:return e.BYTE;case _n.RGBA8UI:return e.UNSIGNED_BYTE;case _n.RGBA8I:return e.BYTE;case _n.RGBA16F:return o0.HALF_FLOAT_OES;case _n.RGBA16UI:return e.UNSIGNED_SHORT;case _n.RGBA16I:return e.SHORT;case _n.RGBA32F:return e.FLOAT;case _n.RGBA32UI:return e.UNSIGNED_INT;case _n.RGBA32I:return e.INT;case _n.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case _n.R11G11B10F:return e.FLOAT;case _n.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case _n.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case _n.RGB10A2:return e.UNSIGNED_BYTE;case _n.RGB10A2UI:return e.UNSIGNED_INT;case _n.RGB9E5:return e.UNSIGNED_BYTE;case _n.DEPTH:return e.UNSIGNED_INT;case _n.DEPTH_STENCIL:return o0.UNSIGNED_INT_24_8_WEBGL;case _n.BC1:case _n.BC1_SRGB:case _n.BC2:case _n.BC2_SRGB:case _n.BC3:case _n.BC3_SRGB:case _n.BC4:return e.UNSIGNED_BYTE;case _n.BC4_SNORM:return e.BYTE;case _n.BC5:return e.UNSIGNED_BYTE;case _n.BC5_SNORM:return e.BYTE;case _n.BC6H_SF16:case _n.BC6H_UF16:return e.FLOAT;case _n.BC7:case _n.BC7_SRGB:case _n.ETC_RGB8:case _n.ETC2_RGB8:case _n.ETC2_SRGB8:case _n.ETC2_RGB8_A1:case _n.ETC2_SRGB8_A1:case _n.EAC_R11:return e.UNSIGNED_BYTE;case _n.EAC_R11SN:return e.BYTE;case _n.EAC_RG11:return e.UNSIGNED_BYTE;case _n.EAC_RG11SN:return e.BYTE;case _n.PVRTC_RGB2:case _n.PVRTC_RGBA2:case _n.PVRTC_RGB4:case _n.PVRTC_RGBA4:case _n.PVRTC2_2BPP:case _n.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case _n.ASTC_RGBA_4X4:case _n.ASTC_RGBA_5X4:case _n.ASTC_RGBA_5X5:case _n.ASTC_RGBA_6X5:case _n.ASTC_RGBA_6X6:case _n.ASTC_RGBA_8X5:case _n.ASTC_RGBA_8X6:case _n.ASTC_RGBA_8X8:case _n.ASTC_RGBA_10X5:case _n.ASTC_RGBA_10X6:case _n.ASTC_RGBA_10X8:case _n.ASTC_RGBA_10X10:case _n.ASTC_RGBA_12X10:case _n.ASTC_RGBA_12X12:case _n.ASTC_SRGBA_4X4:case _n.ASTC_SRGBA_5X4:case _n.ASTC_SRGBA_5X5:case _n.ASTC_SRGBA_6X5:case _n.ASTC_SRGBA_6X6:case _n.ASTC_SRGBA_8X5:case _n.ASTC_SRGBA_8X6:case _n.ASTC_SRGBA_8X8:case _n.ASTC_SRGBA_10X5:case _n.ASTC_SRGBA_10X6:case _n.ASTC_SRGBA_10X8:case _n.ASTC_SRGBA_10X10:case _n.ASTC_SRGBA_12X10:case _n.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function l0(t,e){switch(t){case pn.BOOL:return e.BOOL;case pn.BOOL2:return e.BOOL_VEC2;case pn.BOOL3:return e.BOOL_VEC3;case pn.BOOL4:return e.BOOL_VEC4;case pn.INT:return e.INT;case pn.INT2:return e.INT_VEC2;case pn.INT3:return e.INT_VEC3;case pn.INT4:return e.INT_VEC4;case pn.UINT:return e.UNSIGNED_INT;case pn.FLOAT:return e.FLOAT;case pn.FLOAT2:return e.FLOAT_VEC2;case pn.FLOAT3:return e.FLOAT_VEC3;case pn.FLOAT4:return e.FLOAT_VEC4;case pn.MAT2:return e.FLOAT_MAT2;case pn.MAT3:return e.FLOAT_MAT3;case pn.MAT4:return e.FLOAT_MAT4;case pn.SAMPLER2D:return e.SAMPLER_2D;case pn.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),pn.UNKNOWN}}function u0(t){switch(t){case pn.BOOL:case pn.BOOL2:case pn.BOOL3:case pn.BOOL4:case pn.INT:case pn.INT2:case pn.INT3:case pn.INT4:case pn.UINT:return Int32Array;case pn.FLOAT:case pn.FLOAT2:case pn.FLOAT3:case pn.FLOAT4:case pn.MAT2:case pn.MAT3:case pn.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function h0(t,e){switch(t){case e.BOOL:return pn.BOOL;case e.BOOL_VEC2:return pn.BOOL2;case e.BOOL_VEC3:return pn.BOOL3;case e.BOOL_VEC4:return pn.BOOL4;case e.INT:return pn.INT;case e.INT_VEC2:return pn.INT2;case e.INT_VEC3:return pn.INT3;case e.INT_VEC4:return pn.INT4;case e.UNSIGNED_INT:return pn.UINT;case e.FLOAT:return pn.FLOAT;case e.FLOAT_VEC2:return pn.FLOAT2;case e.FLOAT_VEC3:return pn.FLOAT3;case e.FLOAT_VEC4:return pn.FLOAT4;case e.FLOAT_MAT2:return pn.MAT2;case e.FLOAT_MAT3:return pn.MAT3;case e.FLOAT_MAT4:return pn.MAT4;case e.SAMPLER_2D:return pn.SAMPLER2D;case e.SAMPLER_CUBE:return pn.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),pn.UNKNOWN}}function _0(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function f0(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}s0._instance=null;var p0,d0=[512,513,514,515,516,517,518,519],m0=[0,7680,7681,7682,7683,5386,34055,34056],v0=[32774,32778,32779,32775,32776],g0=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(p0||(p0={}));var y0=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},x0=function(t){function e(){var e;return(e=t.call(this,p0.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new $n,e.clearFlag=Xn.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return $(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(y0),S0=function(t){function e(){var e;return(e=t.call(this,p0.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Jr,e}return $(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(y0),b0=function(t){function e(){var e;return(e=t.call(this,p0.DRAW)||this).drawInfo=new fr,e}return $(e,t),e.prototype.clear=function(){},e}(y0),C0=function(t){function e(){var e;return(e=t.call(this,p0.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return $(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(y0),A0=function(t){function e(){var e;return(e=t.call(this,p0.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return $(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(y0),T0=function(){function t(){this.cmds=new ql(1),this.beginRenderPassCmds=new ql(1),this.bindStatesCmds=new ql(1),this.drawCmds=new ql(1),this.updateBufferCmds=new ql(1),this.copyBufferToTextureCmds=new ql(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function w0(t,e,i,n,r){if(e.usage&dn.UNIFORM)ArrayBuffer.isView(i)?e.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&dn.INDIRECT){e.indirects.clearDraws();for(var o=i.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(n+a,o[a])}else{var s=i,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),E0.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),E0.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(e.glTarget,n,s):c.bufferSubData(e.glTarget,n,s.slice(0,r))}}var E0={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function P0(t,e,i,n,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(i&&e){c.glFramebuffer!==i.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer),c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(s.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(s.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height);var u=r.length;t.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=e.colorAttachments[h];if(_.format!==_n.UNKNOWN)switch(_.loadOp){case Mn.LOAD:break;case Mn.CLEAR:c.bs.targets[0].blendColorMask!==Rn.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Mn.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==_n.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Mn.LOAD:break;case Mn.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Mn.DISCARD:}if(Zr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Mn.LOAD:break;case Mn.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Mn.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Rn.ALL){var d=(p&Rn.R)!==Rn.NONE,m=(p&Rn.G)!==Rn.NONE,v=(p&Rn.B)!==Rn.NONE,g=(p&Rn.A)!==Rn.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function I0(t,e,i,n,r,o){var a,s,c,l=t.gl,u=t.stateCache,h=e&&e.gpuShader,_=!1;if(e&&E0.gpuPipelineState!==e){if(E0.gpuPipelineState=e,E0.glPrimitive=e.glPrimitive,e.gpuShader){var f=e.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var p=e.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case kn.NONE:l.disable(l.CULL_FACE);break;case kn.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case kn.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var d=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==d&&(l.frontFace(d?l.CCW:l.CW),u.rs.isFrontFaceCCW=d),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var m=e.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(d0[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,d0[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,m0[m.stencilFailOpFront],m0[m.stencilZFailOpFront],m0[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,d0[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,m0[m.stencilFailOpBack],m0[m.stencilZFailOpBack],m0[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=e.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(v0[g.blendEq],v0[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(g0[g.blendSrc],g0[g.blendDst],g0[g.blendSrcAlpha],g0[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Rn.R)!==Rn.NONE,(g.blendColorMask&Rn.G)!==Rn.NONE,(g.blendColorMask&Rn.B)!==Rn.NONE,(g.blendColorMask&Rn.A)!==Rn.NONE),y.blendColorMask=g.blendColorMask)}}if(e&&e.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,S=e.gpuPipelineLayout.dynamicOffsetIndices,C=0;C<x;C++){var A=h.glBlocks[C],T=n[A.set],w=T&&T.descriptorIndices[A.binding],E=w>=0&&T.gpuDescriptors[w],P=null,I=0;if(E&&E.gpuBuffer){var R=E.gpuBuffer,D=S[A.set],M=D&&D[A.binding];M>=0&&(I=r[M]),"vf32"in R?P=R.vf32:(I+=R.offset,P=R.gpuBuffer.vf32),I>>=2}if(P)for(var O=A.glActiveUniforms.length,B=0;B<O;B++){var N=A.glActiveUniforms[B];switch(N.glType){case l.BOOL:case l.INT:for(var L=0;L<N.array.length;++L){var F=N.offset+I+L;if(P[F]!==N.array[L]){for(var z=L,V=F;z<N.array.length;++z,++V)N.array[z]=P[V];l.uniform1iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<N.array.length;++k){var U=N.offset+I+k;if(P[U]!==N.array[k]){for(var G=k,H=U;G<N.array.length;++G,++H)N.array[G]=P[H];l.uniform2iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<N.array.length;++j){var W=N.offset+I+j;if(P[W]!==N.array[j]){for(var q=j,X=W;q<N.array.length;++q,++X)N.array[q]=P[X];l.uniform3iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<N.array.length;++Y){var K=N.offset+I+Y;if(P[K]!==N.array[Y]){for(var J=Y,Q=K;J<N.array.length;++J,++Q)N.array[J]=P[Q];l.uniform4iv(N.glLoc,N.array);break}}break;case l.FLOAT:for(var Z=0;Z<N.array.length;++Z){var $=N.offset+I+Z;if(P[$]!==N.array[Z]){for(var tt=Z,et=$;tt<N.array.length;++tt,++et)N.array[tt]=P[et];l.uniform1fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC2:for(var it=0;it<N.array.length;++it){var nt=N.offset+I+it;if(P[nt]!==N.array[it]){for(var rt=it,ot=nt;rt<N.array.length;++rt,++ot)N.array[rt]=P[ot];l.uniform2fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC3:for(var at=0;at<N.array.length;++at){var st=N.offset+I+at;if(P[st]!==N.array[at]){for(var ct=at,lt=st;ct<N.array.length;++ct,++lt)N.array[ct]=P[lt];l.uniform3fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC4:for(var ut=0;ut<N.array.length;++ut){var ht=N.offset+I+ut;if(P[ht]!==N.array[ut]){for(var _t=ut,ft=ht;_t<N.array.length;++_t,++ft)N.array[_t]=P[ft];l.uniform4fv(N.glLoc,N.array);break}}break;case l.FLOAT_MAT2:for(var pt=0;pt<N.array.length;++pt){var dt=N.offset+I+pt;if(P[dt]!==N.array[pt]){for(var mt=pt,vt=dt;mt<N.array.length;++mt,++vt)N.array[mt]=P[vt];l.uniformMatrix2fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT3:for(var gt=0;gt<N.array.length;++gt){var yt=N.offset+I+gt;if(P[yt]!==N.array[gt]){for(var xt=gt,St=yt;xt<N.array.length;++xt,++St)N.array[xt]=P[St];l.uniformMatrix3fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT4:for(var bt=0;bt<N.array.length;++bt){var Ct=N.offset+I+bt;if(P[Ct]!==N.array[bt]){for(var At=bt,Tt=Ct;At<N.array.length;++At,++Tt)N.array[At]=P[Tt];l.uniformMatrix4fv(N.glLoc,!1,N.array);break}}}}else b("Buffer binding '"+A.name+"' at set "+A.set+" binding "+A.binding+" is not bounded")}for(var wt=h.glSamplerTextures.length,Et=0;Et<wt;Et++)for(var Pt=h.glSamplerTextures[Et],It=n[Pt.set],Rt=It&&It.descriptorIndices[Pt.binding],Dt=Rt>=0&&It.gpuDescriptors[Rt],Mt=Pt.units.length,Ot=0;Ot<Mt;Ot++){var Bt=Pt.units[Ot];if(Dt&&Dt.gpuSampler){if(Dt.gpuTexture&&Dt.gpuTexture.size>0){var Nt=Dt.gpuTexture,Lt=u.glTexUnits[Bt];Lt.glTexture!==Nt.glTexture&&(u.texUnit!==Bt&&(l.activeTexture(l.TEXTURE0+Bt),u.texUnit=Bt),Nt.glTexture?l.bindTexture(Nt.glTarget,Nt.glTexture):l.bindTexture(Nt.glTarget,t.nullTex2D.gpuTexture.glTexture),Lt.glTexture=Nt.glTexture);var Ft=Dt.gpuSampler;Nt.isPowerOf2?(a=Ft.glWrapS,s=Ft.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Nt.isPowerOf2?Nt.mipLevel<=1&&(Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Ft.glMinFilter:Ft.glMinFilter===l.LINEAR||Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Nt.glWrapS!==a&&(u.texUnit!==Bt&&(l.activeTexture(l.TEXTURE0+Bt),u.texUnit=Bt),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_S,a),Nt.glWrapS=a),Nt.glWrapT!==s&&(u.texUnit!==Bt&&(l.activeTexture(l.TEXTURE0+Bt),u.texUnit=Bt),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_T,s),Nt.glWrapT=s),Nt.glMinFilter!==c&&(u.texUnit!==Bt&&(l.activeTexture(l.TEXTURE0+Bt),u.texUnit=Bt),l.texParameteri(Nt.glTarget,l.TEXTURE_MIN_FILTER,c),Nt.glMinFilter=c),Nt.glMagFilter!==Ft.glMagFilter&&(u.texUnit!==Bt&&(l.activeTexture(l.TEXTURE0+Bt),u.texUnit=Bt),l.texParameteri(Nt.glTarget,l.TEXTURE_MAG_FILTER,Ft.glMagFilter),Nt.glMagFilter=Ft.glMagFilter)}Dt=It.gpuDescriptors[++Rt]}else b("Sampler binding '"+Pt.name+"' at set "+Pt.set+" binding "+Pt.binding+" index "+Ot+" is not bounded")}}if(i&&h&&(_||E0.gpuInputAssembler!==i)){E0.gpuInputAssembler=i;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var Vt=t.extensions.OES_vertex_array_object,kt=i.glVAOs.get(h.glProgram);if(!kt){var Ut;kt=Vt.createVertexArrayOES(),i.glVAOs.set(h.glProgram,kt),Vt.bindVertexArrayOES(kt),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var Gt=h.glInputs.length,Ht=0;Ht<Gt;Ht++){var jt=h.glInputs[Ht];Ut=null;for(var Wt=i.glAttribs.length,qt=0;qt<Wt;qt++){var Xt=i.glAttribs[qt];if(Xt.name===jt.name){Ut=Xt;break}}if(Ut){u.glArrayBuffer!==Ut.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ut.glBuffer),u.glArrayBuffer=Ut.glBuffer);for(var Yt=0;Yt<Ut.componentCount;++Yt){var Kt=jt.glLoc+Yt,Jt=Ut.offset+Ut.size*Yt;l.enableVertexAttribArray(Kt),u.glCurrentAttribLocs[Kt]=!0,l.vertexAttribPointer(Kt,Ut.count,Ut.glType,Ut.isNormalized,Ut.stride,Jt),zt&&zt.vertexAttribDivisorANGLE(Kt,Ut.isInstanced?1:0)}}}var Qt=i.gpuIndexBuffer;Qt&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Qt.glBuffer),Vt.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==kt&&(Vt.bindVertexArrayOES(kt),u.glVAO=kt)}else{for(var Zt=0;Zt<t.capabilities.maxVertexAttributes;++Zt)u.glCurrentAttribLocs[Zt]=!1;for(var $t=h.glInputs.length,te=0;te<$t;te++){for(var ee=h.glInputs[te],ie=null,ne=i.glAttribs.length,re=0;re<ne;re++){var oe=i.glAttribs[re];if(oe.name===ee.name){ie=oe;break}}if(ie){u.glArrayBuffer!==ie.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ie.glBuffer),u.glArrayBuffer=ie.glBuffer);for(var ae=0;ae<ie.componentCount;++ae){var se=ee.glLoc+ae,ce=ie.offset+ie.size*ae;!u.glEnabledAttribLocs[se]&&se>=0&&(l.enableVertexAttribArray(se),u.glEnabledAttribLocs[se]=!0),u.glCurrentAttribLocs[se]=!0,l.vertexAttribPointer(se,ie.count,ie.glType,ie.isNormalized,ie.stride,ce),zt&&zt.vertexAttribDivisorANGLE(se,ie.isInstanced?1:0)}}}var le=i.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ue=0;ue<t.capabilities.maxVertexAttributes;++ue)u.glEnabledAttribLocs[ue]!==u.glCurrentAttribLocs[ue]&&(l.disableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!1)}}if(e&&e.dynamicStates.length)for(var he=e.dynamicStates.length,_e=0;_e<he;_e++)switch(e.dynamicStates[_e]){case Un.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Un.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Un.BLEND_CONSTANTS:var fe=o.blendConstant;u.bs.blendColor.x===fe.x&&u.bs.blendColor.y===fe.y&&u.bs.blendColor.z===fe.z&&u.bs.blendColor.w===fe.w||(l.blendColor(fe.x,fe.y,fe.z,fe.w),u.bs.blendColor.copy(fe));break;case Un.STENCIL_WRITE_MASK:var pe=o.stencilStatesFront,de=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==pe.writeMask&&(l.stencilMaskSeparate(l.FRONT,pe.writeMask),u.dss.stencilWriteMaskFront=pe.writeMask),u.dss.stencilWriteMaskBack!==de.writeMask&&(l.stencilMaskSeparate(l.BACK,de.writeMask),u.dss.stencilWriteMaskBack=de.writeMask);break;case Un.STENCIL_COMPARE_MASK:var me=o.stencilStatesFront,ve=o.stencilStatesBack;u.dss.stencilRefFront===me.reference&&u.dss.stencilReadMaskFront===me.compareMask||(l.stencilFuncSeparate(l.FRONT,d0[u.dss.stencilFuncFront],me.reference,me.compareMask),u.dss.stencilRefFront=me.reference,u.dss.stencilReadMaskFront=me.compareMask),u.dss.stencilRefBack===ve.reference&&u.dss.stencilReadMaskBack===ve.compareMask||(l.stencilFuncSeparate(l.BACK,d0[u.dss.stencilFuncBack],ve.reference,ve.compareMask),u.dss.stencilRefBack=ve.reference,u.dss.stencilReadMaskBack=ve.compareMask)}}function R0(t,e){var i=t.gl,n=t.extensions,r=n.ANGLE_instanced_arrays,o=n.WEBGL_multi_draw,a=E0.gpuInputAssembler,s=E0.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):i.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):i.drawArrays(s,l.offsets[_],l.counts[_])}else if(e.instanceCount&&r)if(c){if(e.indexCount>0){var f=e.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,e.indexCount,a.glIndexType,f,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(c){if(e.indexCount>0){var p=e.firstIndex*c.stride;i.drawElements(s,e.indexCount,a.glIndexType,p)}}else e.vertexCount>0&&i.drawArrays(s,e.firstVertex,e.vertexCount)}}var D0=new Array(p0.COUNT);function M0(t,e){D0.fill(0);for(var i=0;i<e.cmds.length;++i){var n=e.cmds.array[i],r=D0[n]++;switch(n){case p0.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];P0(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case p0.BIND_STATES:var a=e.bindStatesCmds.array[r];I0(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case p0.DRAW:R0(t,e.drawCmds.array[r].drawInfo);break;case p0.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];w0(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case p0.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];O0(t,c.buffers,c.gpuTexture,c.regions)}}}function O0(t,e,i,n){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);var a=0,s=1,c=1,l=0,u=Zr[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var h=0;h<n.length;h++){var _=n[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?i.glInternalFmt===o0.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,i.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,i.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,i.glFormat,i.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<n.length;p++){var d=n[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=e[a++];u?i.glInternalFmt===o0.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,i.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,i.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,i.glFormat,i.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Sn.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var B0=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=a(t);var e=new Int32Array(this._capacity),i=new Int32Array(this._capacity),n=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),i.set(this.offsets),n.set(this.instances),this.counts=e,this.offsets=i,this.instances=n}},t}(),N0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&dn.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new B0,glTarget:0,glBuffer:null},this._usage&dn.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var i=t.gl,n=t.stateCache,r=e.memUsage&gn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(e.usage&dn.VERTEX){e.glTarget=i.ARRAY_BUFFER;var o=i.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E0.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),i.bufferData(i.ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&dn.INDEX){e.glTarget=i.ELEMENT_ARRAY_BUFFER;var a=i.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E0.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&dn.UNIFORM?(e.glTarget=i.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&dn.INDIRECT||e.usage&dn.TRANSFER_DST||e.usage&dn.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(s0.instance,this._gpuBuffer),s0.instance.memoryStatus.bufferSize+=this._size},i.destroy=function(){this._gpuBuffer&&(function(t,e){var i=t.gl,n=t.stateCache;if(e.glBuffer){switch(e.glTarget){case i.ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),E0.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),E0.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}i.deleteBuffer(e.glBuffer),e.glBuffer=null}}(s0.instance,this._gpuBuffer),s0.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},i.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var i=t.gl,n=t.stateCache,r=e.memUsage&gn.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;e.usage&dn.VERTEX?(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E0.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ARRAY_BUFFER,e.buffer,r):i.bufferData(i.ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&dn.INDEX?(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),E0.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&dn.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&dn.INDIRECT||e.usage&dn.TRANSFER_DST||e.usage&dn.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(s0.instance,this._gpuBuffer),s0.instance.memoryStatus.bufferSize-=e,s0.instance.memoryStatus.bufferSize+=t)))}},i.update=function(t,e){var i;this._isBufferView?console.warn("cannot update through buffer views!"):(i=void 0!==e?e:this._usage&dn.INDIRECT?0:t.byteLength,w0(s0.instance,this._gpuBuffer,t,0,i))},Q(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(uo),L0=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new ql(e);for(var i=0;i<e;++i)this._frees[i]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,i=this._frees;this._frees=new Array(e);for(var n=e-i.length,r=0;r<n;++r)this._frees[r]=new t;for(var o=n,a=0;o<e;++o,++a)this._frees[o]=i[a];this._freeIdx+=n}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),F0=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new L0(x0,1),this.bindStatesCmdPool=new L0(S0,1),this.drawCmdPool=new L0(b0,1),this.updateBufferCmdPool=new L0(C0,1),this.copyBufferToTextureCmdPool=new L0(A0,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),z0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).cmdPackage=new T0,e._cmdAllocator=new F0,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Jr,e._isStateInvalied=!1,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=s0.instance.bindingMappingInfo.bufferOffsets.length,i=0;i<e;i++)this._curGPUDescriptorSets.push(null)},i.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},i.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},i.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},i.beginRenderPass=function(t,e,i,n,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(x0);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=i,a.clearColors.length=n.length;for(var s=0;s<n.length;++s)a.clearColors[s]=n[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(p0.BEGIN_RENDER_PASS),this._isInRenderPass=!0},i.endRenderPass=function(){this._isInRenderPass=!1},i.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},i.bindDescriptorSet=function(t,e,i){var n=e.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=n,this._isStateInvalied=!0),i){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<i.length;c++)a[s+c]=i[c];this._isStateInvalied=!0}}},i.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},i.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},i.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},i.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},i.setDepthBias=function(t,e,i){var n=this._curDynamicStates;n.depthBiasConstant===t&&n.depthBiasClamp===e&&n.depthBiasSlope===i||(n.depthBiasConstant=t,n.depthBiasClamp=e,n.depthBiasSlope=i,this._isStateInvalied=!0)},i.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},i.setDepthBound=function(t,e){var i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalied=!0)},i.setStencilWriteMask=function(t,e){var i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;t&Gn.FRONT&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0),t&Gn.BACK&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0)},i.setStencilCompareMask=function(t,e,i){var n=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Gn.FRONT&&(n.compareMask===i&&n.reference===e||(n.reference=e,n.compareMask=i,this._isStateInvalied=!0)),t&Gn.BACK&&(r.compareMask===i&&r.reference===e||(r.reference=e,r.compareMask=i,this._isStateInvalied=!0))},i.draw=function(t){if(this._type===qn.PRIMARY&&this._isInRenderPass||this._type===qn.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,i=this._cmdAllocator.drawCmdPool.alloc(b0);i.drawInfo.copy(e),this.cmdPackage.drawCmds.push(i),this.cmdPackage.cmds.push(p0.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},i.updateBuffer=function(t,e,i){if(this._type===qn.PRIMARY&&!this._isInRenderPass||this._type===qn.SECONDARY){var n=t.gpuBuffer;if(n){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(C0),a=0;t.usage&dn.INDIRECT||(a=void 0!==i?i:e.byteLength),r=e,o.gpuBuffer=n,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(p0.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},i.copyBuffersToTexture=function(t,e,i){if(this._type===qn.PRIMARY&&!this._isInRenderPass||this._type===qn.SECONDARY){var n=e.gpuTexture;if(n){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(A0);r&&(r.gpuTexture=n,r.regions=i,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(p0.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},i.execute=function(t,e){for(var i=0;i<e;++i){for(var n=t[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var o=n.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<n.cmdPackage.bindStatesCmds.length;++a){var s=n.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<n.cmdPackage.drawCmds.length;++c){var l=n.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var f=n.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}},i.pipelineBarrier=function(){},i.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(S0);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(p0.BIND_STATES),this._isStateInvalied=!1)},e}(ho),V0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuFramebuffer=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],i=0;i<t.colorTextures.length;++i){var n=t.colorTextures[i];n&&e.push(n.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var i=0;i<e.gpuColorTextures.length;++i)if(e.gpuColorTextures[i].isSwapchainTexture)return void(e.isOffscreen=!1);var n=t.gl,r=[],o=n.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,n.RENDERBUFFER,s.glRenderbuffer),r.push(n.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Zr[c.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;c.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,l,n.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=n.checkFramebufferStatus(n.FRAMEBUFFER);if(u!==n.FRAMEBUFFER_COMPLETE)switch(u){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(s0.instance,this._gpuFramebuffer)},i.destroy=function(){var t,e;this._gpuFramebuffer&&(t=s0.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},Q(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(po),k0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuInputAssembler=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var i=new Array(t.vertexBuffers.length),n=0;n<t.vertexBuffers.length;++n){var r=t.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:i,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var i=t.gl;e.glAttribs=new Array(e.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=c0(o.format,i),l=Zr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Zr[o.format].count,stride:s.stride,componentCount:f0(c,i),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:n[a]},n[a]+=l}}(s0.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},i.destroy=function(){var t=s0.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var i=e.glVAOs.values(),n=i.next(),r=t.extensions.OES_vertex_array_object,o=t.stateCache.glVAO;!n.done;)r.deleteVertexArrayOES(n.value),o===n.value&&(r.bindVertexArrayOES(null),o=null),n=i.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},Q(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(yo),U0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuDescriptorSetLayout=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,i=-1,n=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];n.push(e),e+=o.count,o.binding>i&&(i=o.binding)}this._bindingIndices=Array(i+1).fill(-1);for(var a=this._descriptorIndices=Array(i+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=n[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&eo)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},i.destroy=function(){this._bindings.length=0},Q(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(So),G0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuPipelineLayout=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],i=[],n=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=n+l)}i.push(a.gpuDescriptorSetLayout),e.push(c),r.push(n),n+=s.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:n,dynamicOffsetOffsets:r}},i.destroy=function(){this._setLayouts.length=0},Q(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(bo),H0=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],j0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuPipelineState=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var i=t.blendState,n=i.targets;n&&n.forEach((function(t,i){e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:H0[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},i.destroy=function(){this._gpuPipelineState=null},Q(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(Po),W0=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.beginRenderPass=function(t,e,i,n,r,o){P0(s0.instance,t.gpuRenderPass,e.gpuFramebuffer,i,n,r,o),this._isInRenderPass=!0},i.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;R0(s0.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},i.setViewport=function(t){var e=s0.instance,i=e.stateCache,n=e.gl;i.viewport.left===t.left&&i.viewport.top===t.top&&i.viewport.width===t.width&&i.viewport.height===t.height||(n.viewport(t.left,t.top,t.width,t.height),i.viewport.left=t.left,i.viewport.top=t.top,i.viewport.width=t.width,i.viewport.height=t.height)},i.setScissor=function(t){var e=s0.instance,i=e.stateCache,n=e.gl;i.scissorRect.x===t.x&&i.scissorRect.y===t.y&&i.scissorRect.width===t.width&&i.scissorRect.height===t.height||(n.scissor(t.x,t.y,t.width,t.height),i.scissorRect.x=t.x,i.scissorRect.y=t.y,i.scissorRect.width=t.width,i.scissorRect.height=t.height)},i.updateBuffer=function(t,e,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var n,r=t.gpuBuffer;r&&(n=void 0!==i?i:t.usage&dn.INDIRECT?0:e.byteLength,w0(s0.instance,r,e,0,n))}},i.copyBuffersToTexture=function(t,e,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var n=e.gpuTexture;n&&O0(s0.instance,t,n,i)}},i.execute=function(t,e){for(var i=0;i<e;++i){var n=t[i];M0(s0.instance,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}},i.bindStates=function(){I0(s0.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(z0),q0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._type=t.type},i.destroy=function(){},i.submit=function(t){for(var e=t.length,i=0;i<e;i++){var n=t[i];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},i.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Io),X0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuRenderPass=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},i.destroy=function(){this._gpuRenderPass=null},Q(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Ro),Y0=[10497,33648,33071,33071],K0=function(t){function e(e,i){var n;(n=t.call(this,e,i)||this)._gpuSampler=null;var r,o,a=n._info.minFilter,s=n._info.magFilter,c=n._info.mipFilter;r=a===An.LINEAR||a===An.ANISOTROPIC?c===An.LINEAR||c===An.ANISOTROPIC?9987:c===An.POINT?9985:9729:c===An.LINEAR||c===An.ANISOTROPIC?9986:c===An.POINT?9984:9728,o=s===An.LINEAR||s===An.ANISOTROPIC?9729:9728;var l=Y0[n._info.addressU],u=Y0[n._info.addressV],h=Y0[n._info.addressW];return n._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},n}return $(e,t),Q(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Do),J0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuShader=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}!function(t,e){for(var i=t.gl,n=function(t){var n=e.gpuStages[t],r=0,o="",a=1;switch(n.type){case Dn.VERTEX:o="VertexShader",r=i.VERTEX_SHADER;break;case Dn.FRAGMENT:o="FragmentShader",r=i.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=i.createShader(r);if(s&&(n.glShader=s,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",n.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(i.getShaderInfoLog(n.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(i.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=n(r);if("object"==typeof o)return o.v}var a=i.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];i.attachShader(e.glProgram,c.glShader)}if(i.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(i.detachShader(e.glProgram,u.glShader),i.deleteShader(u.glShader),u.glShader=null)}if(!i.getProgramParameter(e.glProgram,i.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(i.getProgramInfoLog(e.glProgram));A("Shader '"+e.name+"' compilation succeeded.");var h=i.getProgramParameter(e.glProgram,i.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=i.getActiveAttrib(e.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=i.getAttribLocation(e.glProgram,p),v=h0(f.type,i),g=_0(f.type,i);e.glInputs[_]={binding:m,name:p,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var y=0;y<e.blocks.length;++y){var x=e.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};e.glBlocks[y]=S;for(var b=0;b<x.members.length;++b){var C=x.members[b],T=l0(C.type,i),w=_0(T,i),E=w*C.count;S.glUniforms[b]={binding:-1,name:C.name,type:C.type,stride:w,count:C.count,size:E,offset:0,glType:T,glLoc:null,array:null}}}}for(var P=0;P<e.subpassInputs.length;++P){var I=e.subpassInputs[P];e.samplerTextures.push(new Sr(I.set,I.binding,I.name,pn.SAMPLER2D,I.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var R=0;R<e.samplerTextures.length;++R){var D=e.samplerTextures[R];e.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:l0(D.type,i),glLoc:null}}}for(var M=i.getProgramParameter(e.glProgram,i.ACTIVE_UNIFORMS),O=0;O<M;++O){var B=i.getActiveUniform(e.glProgram,O);if(B&&B.type!==i.SAMPLER_2D&&B.type!==i.SAMPLER_CUBE){var N=i.getUniformLocation(e.glProgram,B.name);if(t.extensions.isLocationActive(N)){var L,F=B.name.indexOf("[");L=-1!==F?B.name.substr(0,F):B.name;for(var z=0;z<e.glBlocks.length;z++)for(var V=e.glBlocks[z],k=0;k<V.glUniforms.length;k++){var U=V.glUniforms[k];if(U.name===L){U.glLoc=N,U.count=B.size,U.size=U.stride*U.count,U.array=new(u0(U.type))(U.size/4),V.glActiveUniforms.push(U);break}}}}}for(var G=0;G<e.glBlocks.length;G++)for(var H=e.glBlocks[G],j=0;j<H.glUniforms.length;j++){var W=H.glUniforms[j];W.offset=H.size/4,H.size+=W.size}for(var q=[],X=[],Y=t.bindingMappingInfo,K=t.stateCache.texUnitCacheMap,J=0,Q=0;Q<e.blocks.length;++Q)e.blocks[Q].set===Y.flexibleSet&&J++;for(var Z=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=i.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(q.push(e.glSamplerTextures[$]),X.push(et)),void 0===K[tt.name]){var it=tt.binding+Y.samplerOffsets[tt.set]+Z;tt.set===Y.flexibleSet&&(it-=J),K[tt.name]=it%t.capabilities.maxTextureUnits,Z+=tt.count-1}}if(q.length){for(var nt=[],rt=0;rt<q.length;++rt){var ot=q[rt],at=K[ot.name];if(void 0!==at){ot.glLoc=X[rt];for(var st=0;st<ot.count;++st){for(;nt[at];)at=(at+1)%t.capabilities.maxTextureUnits;ot.units.push(at),nt[at]=!0}}}for(var ct=0,lt=0;lt<q.length;++lt){var ut=q[lt];if(!t.extensions.isLocationActive(ut.glLoc)){ut.glLoc=X[lt];for(var ht=0;ht<ut.count;++ht){for(;nt[ct];)ct=(ct+1)%t.capabilities.maxTextureUnits;void 0===K[ut.name]&&(K[ut.name]=ct),ut.units.push(ct),nt[ct]=!0}}}t.stateCache.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(var _t=0;_t<q.length;_t++){var ft=q[_t];ft.glUnits=new Int32Array(ft.units),i.uniform1iv(ft.glLoc,ft.glUnits)}t.stateCache.glProgram!==e.glProgram&&i.useProgram(t.stateCache.glProgram)}for(var pt=0;pt<e.glBlocks.length;)e.glBlocks[pt].glActiveUniforms.length?pt++:(e.glBlocks[pt]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=q}}(s0.instance,this._gpuShader)},i.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var i=t.gl;if(!t.extensions.destroyShadersImmediately)for(var n=0;n<e.gpuStages.length;n++){var r=e.gpuStages[n];r.glShader&&(i.detachShader(e.glProgram,r.glShader),i.deleteShader(r.glShader),r.glShader=null)}i.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(s0.instance,this._gpuShader),this._gpuShader=null)},Q(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Mo),Q0=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ar,this.scissorRect=new $n(0,0,0,0),this.rs=new Co,this.dss=new Ao,this.bs=new wo,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var i=0;i<t;++i)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),Z0=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuTexture=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t,e){"texture"in t?console.log("WebGL does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=no(this._width)&&no(this._height),this._size=oo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var i=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case _n.A8:return e.ALPHA;case _n.L8:return e.LUMINANCE;case _n.LA8:return e.LUMINANCE_ALPHA;case _n.RGB8:case _n.RGB16F:case _n.RGB32F:return e.RGB;case _n.BGRA8:case _n.RGBA8:case _n.SRGB8_A8:case _n.RGBA16F:case _n.RGBA32F:return e.RGBA;case _n.R5G6B5:return e.RGB;case _n.RGB5A1:case _n.RGBA4:return e.RGBA;case _n.DEPTH:return e.DEPTH_COMPONENT;case _n.DEPTH_STENCIL:return e.DEPTH_STENCIL;case _n.BC1:return o0.COMPRESSED_RGB_S3TC_DXT1_EXT;case _n.BC1_ALPHA:return o0.COMPRESSED_RGBA_S3TC_DXT1_EXT;case _n.BC1_SRGB:return o0.COMPRESSED_SRGB_S3TC_DXT1_EXT;case _n.BC1_SRGB_ALPHA:return o0.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case _n.BC2:return o0.COMPRESSED_RGBA_S3TC_DXT3_EXT;case _n.BC2_SRGB:return o0.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case _n.BC3:return o0.COMPRESSED_RGBA_S3TC_DXT5_EXT;case _n.BC3_SRGB:return o0.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case _n.ETC_RGB8:return o0.COMPRESSED_RGB_ETC1_WEBGL;case _n.ETC2_RGB8:return o0.COMPRESSED_RGB8_ETC2;case _n.ETC2_SRGB8:return o0.COMPRESSED_SRGB8_ETC2;case _n.ETC2_RGB8_A1:return o0.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _n.ETC2_SRGB8_A1:return o0.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case _n.ETC2_RGBA8:return o0.COMPRESSED_RGBA8_ETC2_EAC;case _n.ETC2_SRGB8_A8:return o0.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case _n.EAC_R11:return o0.COMPRESSED_R11_EAC;case _n.EAC_R11SN:return o0.COMPRESSED_SIGNED_R11_EAC;case _n.EAC_RG11:return o0.COMPRESSED_RG11_EAC;case _n.EAC_RG11SN:return o0.COMPRESSED_SIGNED_RG11_EAC;case _n.PVRTC_RGB2:return o0.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case _n.PVRTC_RGBA2:return o0.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case _n.PVRTC_RGB4:return o0.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case _n.PVRTC_RGBA4:return o0.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case _n.ASTC_RGBA_4X4:return o0.COMPRESSED_RGBA_ASTC_4x4_KHR;case _n.ASTC_RGBA_5X4:return o0.COMPRESSED_RGBA_ASTC_5x4_KHR;case _n.ASTC_RGBA_5X5:return o0.COMPRESSED_RGBA_ASTC_5x5_KHR;case _n.ASTC_RGBA_6X5:return o0.COMPRESSED_RGBA_ASTC_6x5_KHR;case _n.ASTC_RGBA_6X6:return o0.COMPRESSED_RGBA_ASTC_6x6_KHR;case _n.ASTC_RGBA_8X5:return o0.COMPRESSED_RGBA_ASTC_8x5_KHR;case _n.ASTC_RGBA_8X6:return o0.COMPRESSED_RGBA_ASTC_8x6_KHR;case _n.ASTC_RGBA_8X8:return o0.COMPRESSED_RGBA_ASTC_8x8_KHR;case _n.ASTC_RGBA_10X5:return o0.COMPRESSED_RGBA_ASTC_10x5_KHR;case _n.ASTC_RGBA_10X6:return o0.COMPRESSED_RGBA_ASTC_10x6_KHR;case _n.ASTC_RGBA_10X8:return o0.COMPRESSED_RGBA_ASTC_10x8_KHR;case _n.ASTC_RGBA_10X10:return o0.COMPRESSED_RGBA_ASTC_10x10_KHR;case _n.ASTC_RGBA_12X10:return o0.COMPRESSED_RGBA_ASTC_12x10_KHR;case _n.ASTC_RGBA_12X12:return o0.COMPRESSED_RGBA_ASTC_12x12_KHR;case _n.ASTC_SRGBA_4X4:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case _n.ASTC_SRGBA_5X4:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case _n.ASTC_SRGBA_5X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case _n.ASTC_SRGBA_6X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case _n.ASTC_SRGBA_6X6:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case _n.ASTC_SRGBA_8X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case _n.ASTC_SRGBA_8X6:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case _n.ASTC_SRGBA_8X8:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case _n.ASTC_SRGBA_10X5:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case _n.ASTC_SRGBA_10X6:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case _n.ASTC_SRGBA_10X8:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case _n.ASTC_SRGBA_10X10:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case _n.ASTC_SRGBA_12X10:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case _n.ASTC_SRGBA_12X12:return o0.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,i),e.glType=c0(e.format,i);var n=e.width,r=e.height;switch(e.type){case yn.TEX2D:if(e.glTarget=i.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(n,r);if(o>t.capabilities.maxTextureSize&&O(9100,o,t.capabilities.maxTextureSize),!t.extensions.WEBGL_depth_texture&&Zr[e.format].hasDepth)e.glInternalFmt=function(t,e){switch(t){case _n.R5G6B5:return e.RGB565;case _n.RGB5A1:return e.RGB5_A1;case _n.RGBA4:return e.RGBA4;case _n.RGBA16F:return o0.RGBA16F_EXT;case _n.RGBA32F:return o0.RGBA32F_EXT;case _n.SRGB8_A8:return o0.SRGB8_ALPHA8_EXT;case _n.DEPTH:return e.DEPTH_COMPONENT16;case _n.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,i),e.glRenderbuffer=i.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,r));else if(e.glTexture=i.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ro(e.format,n,r,1),l=new Uint8Array(c);i.compressedTexImage2D(i.TEXTURE_2D,s,e.glInternalFmt,n,r,0,l),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)i.texImage2D(i.TEXTURE_2D,u,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}break;case yn.CUBE:e.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);if(h>t.capabilities.maxCubeMapTextureSize&&O(9100,h,t.capabilities.maxTextureSize),e.glTexture=i.createTexture(),e.size>0){var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var f=0;f<6;++f){n=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=ro(e.format,n,r,1),m=new Uint8Array(d);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){n=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yn.TEX2D,e.glTarget=i.TEXTURE_2D}}(s0.instance,this._gpuTexture),s0.instance.memoryStatus.textureSize+=this._size)},i.destroy=function(){this._gpuTexture&&(function(t,e){var i=t.gl;if(e.glTexture){var n=t.stateCache.glTexUnits,r=t.stateCache.texUnit;i.deleteTexture(e.glTexture);for(var o=0;o<n.length;o++)n[o].glTexture===e.glTexture&&(i.activeTexture(i.TEXTURE0+o),r=o,i.bindTexture(e.glTarget,null),n[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;i.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(s0.instance,this._gpuTexture),s0.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},i.resize=function(t,e){var i=this._size;this._width=t,this._height=e,this._size=oo(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var i=t.gl,n=e.width,r=e.height;switch(e.type){case yn.TEX2D:e.glTarget=i.TEXTURE_2D;var o=Math.max(n,r);if(o>t.capabilities.maxTextureSize&&O(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=ro(e.format,n,r,1),l=new Uint8Array(c);i.compressedTexImage2D(i.TEXTURE_2D,s,e.glInternalFmt,n,r,0,l),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)i.texImage2D(i.TEXTURE_2D,u,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case yn.CUBE:e.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);h>t.capabilities.maxCubeMapTextureSize&&O(9100,h,t.capabilities.maxTextureSize);var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Zr[e.format].isCompressed)for(var f=0;f<6;++f){n=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=ro(e.format,n,r,1),m=new Uint8Array(d);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){n=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=yn.TEX2D,e.glTarget=i.TEXTURE_2D}}}(s0.instance,this._gpuTexture),s0.instance.memoryStatus.textureSize-=i,s0.instance.memoryStatus.textureSize+=this._size)},i.initAsSwapchainTexture=function(t){var e=new mr;e.format=t.format,e.usage=Zr[t.format].hasDepth?xn.DEPTH_STENCIL_ATTACHMENT:xn.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},Q(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Oo),$0="webglcontextlost";function t1(t,e){for(var i=["","WEBKIT_","MOZ_"],n=0;n<i.length;++n){var r=t.getExtension(i[n]+e);if(r)return r}return null}function e1(t){var e={EXT_texture_filter_anisotropic:t1(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:t1(t,"EXT_blend_minmax"),EXT_frag_depth:t1(t,"EXT_frag_depth"),EXT_shader_texture_lod:t1(t,"EXT_shader_texture_lod"),EXT_sRGB:t1(t,"EXT_sRGB"),OES_vertex_array_object:t1(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:t1(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:t1(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:t1(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:t1(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:t1(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:t1(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:t1(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:t1(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:t1(t,"WEBGL_draw_buffers"),WEBGL_lose_context:t1(t,"WEBGL_lose_context"),WEBGL_depth_texture:t1(t,"WEBGL_depth_texture"),OES_texture_half_float:t1(t,"OES_texture_half_float"),OES_texture_half_float_linear:t1(t,"OES_texture_half_float_linear"),OES_texture_float:t1(t,"OES_texture_float"),OES_texture_float_linear:t1(t,"OES_texture_float_linear"),OES_standard_derivatives:t1(t,"OES_standard_derivatives"),OES_element_index_uint:t1(t,"OES_element_index_uint"),ANGLE_instanced_arrays:t1(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:t1(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return du.os===au.IOS&&14===du.osMainVersion&&du.isBrowser||(e.WEBGL_compressed_texture_astc=t1(t,"WEBGL_compressed_texture_astc")),du.os!==au.ANDROID&&du.os!==au.IOS&&(e.WEBGL_multi_draw=t1(t,"WEBGL_multi_draw")),du.browserType===nu.UC&&(e.ANGLE_instanced_arrays=null),du.os===au.IOS&&du.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var i1=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).stateCache=new Q0,e.cmdAllocator=new F0,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener($0,this._onWebGLContextLost);var e=s0.instance.gl;this.stateCache.initialize(s0.instance.capabilities.maxTextureUnits,s0.instance.capabilities.maxVertexAttributes),this._extensions=e1(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var i=_n.RGBA8,n=_n.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?n=_n.DEPTH_STENCIL:r&&(n=_n.DEPTH),this._colorTexture=new Z0,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this._depthStencilTexture=new Z0,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this.nullTex2D=s0.instance.createTexture(new mr(yn.TEX2D,xn.SAMPLED,_n.RGBA8,2,2,Sn.GEN_MIPMAP)),this.nullTexCube=s0.instance.createTexture(new mr(yn.CUBE,xn.SAMPLED,_n.RGBA8,2,2,Sn.GEN_MIPMAP,6));var a=new or;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),s0.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,s0.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},i.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener($0,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},i.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(A("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},i._onWebGLContextLost=function(t){D(11e3),S(t)},Q(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(fo),n1=t("WebGLDevice",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._swapchain=null,e._context=null,e}$(e,t);var i=e.prototype;return i.initialize=function(t){s0.setInstance(this),this._gfxAPI=ln.WEBGL,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var i={alpha:ue.ENABLE_TRANSPARENT_CANVAS,antialias:ue.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",i)}catch(t){return null}return e}(_o.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Wr(jn.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new jr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var i=e.getSupportedExtensions(),n="";if(i)for(var r,o=st(i);!(r=o()).done;)n+=r.value+" ";var a=e1(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[hn.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[hn.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[hn.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[hn.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[hn.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[hn.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[hn.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[hn.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[hn.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[hn.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[hn.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[hn.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[hn.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[hn.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[hn.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[hn.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[hn.FORMAT_ASTC]=!0,c+="astc "),A("WebGL device initialized."),A("RENDERER: "+this._renderer),A("VENDOR: "+this._vendor),A("VERSION: "+s),A("COMPRESSED_FORMAT: "+c),A("EXTENSIONS: "+n),!0},i.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},i.flushCommands=function(){},i.acquire=function(){},i.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},i.createCommandBuffer=function(t){var e=new(t.type===qn.PRIMARY?W0:z0);return e.initialize(t),e},i.createSwapchain=function(t){var e=new i1;return this._swapchain=e,e.initialize(t),e},i.createBuffer=function(t){var e=new N0;return e.initialize(t),e},i.createTexture=function(t){var e=new Z0;return e.initialize(t),e},i.createDescriptorSet=function(t){var e=new a0;return e.initialize(t),e},i.createShader=function(t){var e=new J0;return e.initialize(t),e},i.createInputAssembler=function(t){var e=new k0;return e.initialize(t),e},i.createRenderPass=function(t){var e=new X0;return e.initialize(t),e},i.createFramebuffer=function(t){var e=new V0;return e.initialize(t),e},i.createDescriptorSetLayout=function(t){var e=new U0;return e.initialize(t),e},i.createPipelineLayout=function(t){var e=new G0;return e.initialize(t),e},i.createPipelineState=function(t){var e=new j0;return e.initialize(t),e},i.createQueue=function(t){var e=new q0;return e.initialize(t),e},i.getSampler=function(t){var e=Do.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new K0(t,e)),this._samplers.get(e)},i.getGlobalBarrier=function(t){var e=Bo.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Bo(t,e)),this._globalBarriers.get(e)},i.getTextureBarrier=function(t){var e=No.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new No(t,e)),this._textureBarriers.get(e)},i.copyBuffersToTexture=function(t,e,i){O0(this,t,e.gpuTexture,i)},i.copyTextureToBuffers=function(t,e,i){!function(t,e,i,n){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<n.length;h++){var _=n[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,i[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,i)},i.copyTexImagesToTexture=function(t,e,i){!function(t,e,i,n){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture);var a=0,s=0;switch(i.glTarget){case r.TEXTURE_2D:for(var c=0;c<n.length;c++){var l=n[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,i.glFormat,i.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<n.length;u++){var h=n[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,i.glFormat,i.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Sn.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,t,e.gpuTexture,i)},Q(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(_o));function r1(t,e,i,n){var r=(n.x-i.x)*(t.y-i.y)-(n.y-i.y)*(t.x-i.x),o=(e.x-t.x)*(t.y-i.y)-(e.y-t.y)*(t.x-i.x),a=(n.y-i.y)*(e.x-t.x)-(n.x-i.x)*(e.y-t.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}u.WebGLDevice=n1;var o1=new qi,a1=new qi,s1=new qi,c1=new qi;function l1(t,e,i){for(var n=i.length,r=0;r<n;++r)if(r1(t,e,i[r],i[(r+1)%n]))return!0;return!1}function u1(t,e){for(var i=!1,n=t.x,r=t.y,o=e.length,a=0,s=o-1;a<o;s=a++){var c=e[a].x,l=e[a].y,u=e[s].x,h=e[s].y;l>r!=h>r&&n<(u-c)*(r-l)/(h-l)+c&&(i=!i)}return i}function h1(t,e,i,n){var r,o=i.x-e.x,a=i.y-e.y,s=o*o+a*a,c=((t.x-e.x)*o+(t.y-e.y)*a)/s;return r=n?s?c<0?e:c>1?i:o1.set(e.x+c*o,e.y+c*a):e:o1.set(e.x+c*o,e.y+c*a),o=t.x-r.x,a=t.y-r.y,Math.sqrt(o*o+a*a)}var _1,f1=t("Intersection2D",(function(){}));f1.lineLine=r1,f1.lineRect=function(t,e,i){var n=o1.set(i.x,i.y),r=a1.set(i.x,i.yMax),o=s1.set(i.xMax,i.yMax),a=c1.set(i.xMax,i.y);return!!(r1(t,e,n,r)||r1(t,e,r,o)||r1(t,e,o,a)||r1(t,e,a,n))},f1.linePolygon=l1,f1.rectRect=function(t,e){var i=t.x,n=t.y,r=t.x+t.width,o=t.y+t.height,a=e.x,s=e.y,c=e.x+e.width,l=e.y+e.height;return i<=c&&r>=a&&n<=l&&o>=s},f1.rectPolygon=function(t,e){var i=o1.set(t.x,t.y),n=a1.set(t.x,t.yMax),r=s1.set(t.xMax,t.yMax),o=c1.set(t.xMax,t.y);if(l1(i,n,e))return!0;if(l1(n,r,e))return!0;if(l1(r,o,e))return!0;if(l1(o,i,e))return!0;for(var a=0,s=e.length;a<s;++a)if(t.contains(e[a]))return!0;return!!(u1(i,e)||u1(n,e)||u1(r,e)||u1(o,e))},f1.rectCircle=function(t,e,i){var n=e.x,r=e.y,o=t.x,a=t.y,s=t.width,c=t.height,l=n,u=r;n<o?l=o:n>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=n-l,_=r-u;return Math.sqrt(h*h+_*_)<=i},f1.polygonPolygon=function(t,e){var i,n;for(i=0,n=t.length;i<n;++i)if(l1(t[i],t[(i+1)%n],e))return!0;for(i=0,n=e.length;i<n;++i)if(u1(e[i],t))return!0;for(i=0,n=t.length;i<n;++i)if(u1(t[i],e))return!0;return!1},f1.circleCircle=function(t,e,i,n){return qi.distance(t,i)<e+n},f1.polygonCircle=function(t,e,i){var n=e;if(u1(n,t))return!0;for(var r=0,o=t.length;r<o;r++)if(h1(n,0===r?t[t.length-1]:t[r-1],t[r],!0)<i)return!0;return!1},f1.pointInPolygon=u1,f1.pointLineDistance=h1,function(t){t[t.positions=Kn.ATTR_POSITION]="positions",t[t.normals=Kn.ATTR_NORMAL]="normals",t[t.uvs=Kn.ATTR_TEX_COORD]="uvs",t[t.colors=Kn.ATTR_COLOR]="colors"}(_1||(_1={}));var p1,d1,m1,v1,g1,y1=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var i=t-e;this._arrayBufferOrPaddings.push(i),this._length+=i}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?e+=i:(t.set(new Uint8Array(i),e),e+=i.byteLength)})),t.buffer},t}(),x1=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var n=0;n<i;++n){var r=this._mesh.struct.morph.subMeshMorphs[n];r&&(r.targets.length>bd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[n]=new b1(this._mesh,n,this._mesh.struct.morph,e):this._subMeshRenderings[n]=new S1(this._mesh,n,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,i=new Array(e),n=0;n<e;++n){var r,o;i[n]=null!==(r=null===(o=this._subMeshRenderings[n])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var n;null===(n=i[t])||void 0===n||n.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var n=t._mesh.struct.morph.subMeshMorphs[e],r=i[e];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(Kn.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(Kn.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(Kn.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(t,e){var n;null===(n=i[t])||void 0===n||n.adaptPipelineState(e)},destroy:function(){for(var t,e=st(i);!(t=e()).done;){var n=t.value;null==n||n.destroy()}}}},t}(),S1=function(){function t(t,e,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;var r=i.subMeshMorphs[e];this._subMeshMorph=r,w1(t,e,n);var o=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=T1(n,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(e,i){var n=s.create(),a=n.valueView;return r.targets.forEach((function(e,n){for(var r=e.displacements[i],s=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),c=o*n*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=st(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new A1(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(i){for(var n,r=st(t._attributes);!(n=r()).done;){var o=n.value,a=void 0;switch(o.name){case Kn.ATTR_POSITION:a=Ed;break;case Kn.ATTR_NORMAL:a=Rd;break;case Kn.ATTR_TANGENT:a=Od;break;default:S("Unexpected attribute!")}void 0!==a&&(i.bindSampler(a,o.morphTexture.sampler),i.bindTexture(a,o.morphTexture.texture))}i.bindBuffer(bd.BINDING,e.buffer),i.update()},destroy:function(){}}},t}(),b1=function(){function t(t,e,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;var r=i.subMeshMorphs[e];w1(t,e,n),this._attributes=r.attributes.map((function(e,i){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)}}))}}))}return t.prototype.createInstance=function(){return new C1(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},Q(t,[{key:"data",get:function(){return this._attributes}}]),t}(),C1=function(){function t(t,e,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new A1(i,0);var n=T1(i,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=n.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var i=this._attributes[e],n=i.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=t[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)n[4*l+0]=a[3*l+0]*s,n[4*l+1]=a[3*l+1]*s,n[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)n[4*u+0]+=a[3*u+0]*s,n[4*u+1]+=a[3*u+1]*s,n[4*u+2]+=a[3*u+2]*s}i.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,i=st(this._attributes);!(e=i()).done;){var n=e.value,r=void 0;switch(n.attributeName){case Kn.ATTR_POSITION:r=Ed;break;case Kn.ATTR_NORMAL:r=Rd;break;case Kn.ATTR_TANGENT:r=Od;break;default:S("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,n.morphTexture.sampler),t.bindTexture(r,n.morphTexture.texture))}t.bindBuffer(bd.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),A1=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(bd.SIZE)),this._remoteBuffer=t.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,bd.SIZE,bd.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32(bd.OFFSET_OF_WEIGHTS+4*e,t[e],u.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32(bd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,u.sys.isLittleEndian),this._localBuffer.setFloat32(bd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,u.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32(bd.OFFSET_OF_VERTICES_COUNT,t,u.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},Q(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function T1(t,e){var i,n,o,s;t.hasFeature(hn.TEXTURE_FLOAT)?(i=e,o=16,n=Cv.PixelFormat.RGBA32F,s=Float32Array):(i=4*e,o=4,n=Cv.PixelFormat.RGBA8888,s=Uint8Array);var c=function(t){t<5&&(t=5);var e=r(a(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}(i),l=c.width,u=c.height;return{width:l,height:u,create:function(){var e=new ArrayBuffer(l*u*o),i=new Float32Array(e),r=s===Float32Array?i:new s(e),a=new tv({width:l,height:u,_data:r,_compressed:!1,format:n}),c=new Cv;c.setFilters(Cv.Filter.NEAREST,Cv.Filter.NEAREST),c.setMipFilter(Cv.Filter.NONE),c.setWrapMode(Cv.WrapMode.CLAMP_TO_EDGE,Cv.WrapMode.CLAMP_TO_EDGE,Cv.WrapMode.CLAMP_TO_EDGE),c.image=a,c.getGFXTexture()||S("Unexpected: failed to create morph texture?");var h=t.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return i},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(r)}}}}}function w1(t,e,i){t.renderingSubMeshes[e].enableVertexIdChannel(i)}function E1(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var P1=new Ei,I1=new Ei,R1=new Uint8Array,D1=pc("cc.Mesh")((g1=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,ct(e,"_struct",m1,ot(e)),ct(e,"_hash",v1,ot(e)),e._data=R1,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}$(e,t);var i=e.prototype;return i.onLoaded=function(){this.initialize()},i.initialize=function(){if(!this._initialized){this._initialized=!0;for(var t=this._data.buffer,e=u.director.root.device,i=this._createVertexBuffers(e,t),n=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,h=c.length;if(4===l&&!e.hasFeature(hn.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(_>=65536){D(10001,_,65536);continue}l>>=1,h>>=1}a=e.createBuffer(new hr(dn.INDEX,gn.DEVICE,h,l)),s=new(E1(c.stride))(t,c.offset,c.count),c.stride!==l&&(s=E1(l).from(s)),a.update(s)}var f=o.vertexBundelIndices.map((function(t){return i[t]})),p=[];if(o.vertexBundelIndices.length>0)for(var d=o.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new Pr(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new Uw(f,p,o.primitiveMode,a);y.mesh=this,y.subMeshIdx=r,n.push(y)}}this._renderingSubMeshes=n,this._struct.morph&&(this.morphRendering=function(t,e){return new x1(t,e)}(this,e))}},i.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},i.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}},i.assign=function(t,e){this.reset({struct:t,data:e})},i.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},i.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var i=[],n=t.bindposes,r=0;r<n.length;r++)e.push(new Ws(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,Kn.ATTR_JOINTS),c=this.readAttribute(a,Kn.ATTR_WEIGHTS),l=this.readAttribute(a,Kn.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){Ei.set(P1,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,p=s[f];if(!(0===c[f]||p>=n.length)){Ei.transformMat4(I1,P1,n[p]),i[p]=!0;var d=e[p];Ei.min(d.center,d.center,I1),Ei.max(d.halfExtents,d.halfExtents,I1)}}}}for(var m=0;m<n.length;m++){var v=e[m];i[m]?Ws.fromPoints(v,v.center,v.halfExtents):e[m]=null}return e},i.merge=function(t,e,i){if(i&&!this.validateMergingMesh(t))return!1;var n=new Ei,r=e&&new Bi,o=e&&new Ws;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),s=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(Ei.add(o.center,a.maxPosition,a.minPosition),Ei.multiplyScalar(o.center,o.center,.5),Ei.subtract(o.halfExtents,a.maxPosition,a.minPosition),Ei.multiplyScalar(o.halfExtents,o.halfExtents,.5),Ws.transform(o,o,e),Ei.add(a.maxPosition,o.center,o.halfExtents),Ei.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===Kn.ATTR_POSITION||l.attributes[u].name===Kn.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+M1(l.attributes,u)),f=N1(_,h),p=L1(_,h);if(!f||!p)continue;for(var d=l.view.count,m=l.view.stride,v=B1(h),g=0;g<d;g++){var y=g*m,x=y+v,S=x+v;switch(n.set(f(y),f(x),f(S)),l.attributes[u].name){case Kn.ATTR_POSITION:n.transformMat4(e);break;case Kn.ATTR_NORMAL:Ei.transformQuat(n,n,r)}p(y,n.x),p(x,n.y),p(S,n.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var b,C,A,T,w,E=new y1,P=0,I=0,R=0,D=0,M=0,O=0,B=0,N=0,L=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var V=this._struct.vertexBundles[z],k=t._struct.vertexBundles[z];R=V.view.offset,D=k.view.offset,I=V.view.stride,P=V.view.count+k.view.count,b=new ArrayBuffer(P*I),C=new Uint8Array(b),R+=(A=this._data.subarray(R,R+V.view.length)).length,D+=(T=t._data.subarray(D,D+k.view.length)).length,C.set(A),M=0;for(var U,G=st(V.attributes);!(U=G()).done;){var H=U.value;B=0,L=!1;for(var j,W=st(k.attributes);!(j=W()).done;){var q=j.value;if(H.name===q.name&&H.format===q.format){L=!0;break}B+=Zr[q.format].size}if(L){N=Zr[H.format].size,O=V.view.length+M;for(var X=0;X<k.view.count;++X){if(w=T.subarray(B,B+N),C.set(w,O),(H.name===Kn.ATTR_POSITION||H.name===Kn.ATTR_NORMAL)&&e){var Y=new Float32Array(C.buffer,O,3);switch(n.set(Y[0],Y[1],Y[2]),H.name){case Kn.ATTR_POSITION:n.transformMat4(e);break;case Kn.ATTR_NORMAL:Ei.transformQuat(n,n,r)}Y[0]=n.x,Y[1]=n.y,Y[2]=n.z}O+=V.view.stride,B+=k.view.stride}}M+=Zr[H.format].size}F[z]={attributes:V.attributes,view:{offset:E.getLength(),length:b.byteLength,count:P,stride:I}},E.addBuffer(b)}for(var K,J,Q,Z=0,$=2,tt=0,et=new Array(this._struct.primitives.length),it=0;it<this._struct.primitives.length;++it){var nt=this._struct.primitives[it],rt=t._struct.primitives[it];et[it]={primitiveMode:nt.primitiveMode,vertexBundelIndices:nt.vertexBundelIndices};for(var ot,at=st(nt.vertexBundelIndices);!(ot=at()).done;){var ct=ot.value;tt=Math.max(tt,this._struct.vertexBundles[ct].view.count)}if(nt.indexView&&rt.indexView){Z=nt.indexView.count,Z+=rt.indexView.count,R=nt.indexView.offset,D=rt.indexView.offset,$=Z<256?1:Z<65536?2:4;var lt=new ArrayBuffer(Z*$);if(K=2===$?new Uint16Array(lt):1===$?new Uint8Array(lt):new Uint32Array(lt),J=2===nt.indexView.stride?new Uint16Array(this._data.buffer,R,nt.indexView.count):1===nt.indexView.stride?new Uint8Array(this._data.buffer,R,nt.indexView.count):new Uint32Array(this._data.buffer,R,nt.indexView.count),$===nt.indexView.stride)K.set(J);else for(var ut=0;ut<nt.indexView.count;++ut)K[ut]=J[ut];R+=nt.indexView.length,Q=2===rt.indexView.stride?new Uint16Array(t._data.buffer,D,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(t._data.buffer,D,rt.indexView.count):new Uint32Array(t._data.buffer,D,rt.indexView.count);for(var ht=0;ht<rt.indexView.count;++ht)K[nt.indexView.count+ht]=tt+Q[ht];D+=rt.indexView.length,et[it].indexView={offset:E.getLength(),length:lt.byteLength,count:Z,stride:$},E.setNextAlignment($),E.addBuffer(lt)}}var _t={vertexBundles:F,primitives:et,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _t.minPosition&&t._struct.minPosition&&_t.maxPosition&&t._struct.maxPosition&&(e?(Ei.add(o.center,t._struct.maxPosition,t._struct.minPosition),Ei.multiplyScalar(o.center,o.center,.5),Ei.subtract(o.halfExtents,t._struct.maxPosition,t._struct.minPosition),Ei.multiplyScalar(o.halfExtents,o.halfExtents,.5),Ws.transform(o,o,e),Ei.add(n,o.center,o.halfExtents),Ei.max(_t.maxPosition,_t.maxPosition,n),Ei.subtract(n,o.center,o.halfExtents),Ei.min(_t.minPosition,_t.minPosition,n)):(Ei.min(_t.minPosition,_t.minPosition,t._struct.minPosition),Ei.max(_t.maxPosition,_t.maxPosition,t._struct.maxPosition))),this.reset({struct:_t,data:new Uint8Array(E.getCombined())}),this.initialize(),!0},i.validateMergingMesh=function(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var i=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=t._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},i.readAttribute=function(t,e){var i=this,n=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,o=t.attributes[e].format,a=co(Zr[o]);if(0!==r){var s=new DataView(i._data.buffer,t.view.offset+M1(t.attributes,e)),c=Zr[o],l=N1(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=t.view.stride,f=0;f<r;++f)for(var p=0;p<u;++p)h[u*f+p]=l(_*f+h.BYTES_PER_ELEMENT*p);n=h}}})),n},i.copyAttribute=function(t,e,i,n,r){var o=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var s=t.view.count;if(0!==s){var c=t.attributes[e].format,l=new DataView(o._data.buffer,t.view.offset+M1(t.attributes,e)),u=new DataView(i,r),h=Zr[c],_=N1(l,c),f=L1(u,c);if(_&&f){for(var p=h.count,d=t.view.stride,m=B1(c),v=n,g=m,y=0;y<s;++y)for(var x=0;x<p;++x)f(v*y+g*x,_(d*y+m*x));a=!0}}else a=!0})),a},i.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var i=e.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},i.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var i=this._struct.primitives[t];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?_n.R8UI:2===i.indexView.stride?_n.R16UI:_n.R32UI,o=N1(new DataView(this._data.buffer),r),a=0;a<n;++a)e[a]=o(i.indexView.offset+Zr[r].size*a);return!0},i._accessAttribute=function(t,e,i){if(!(t>=this._struct.primitives.length))for(var n,r=st(this._struct.primitives[t].vertexBundelIndices);!(n=r()).done;){var o=n.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(t){return t.name===e}));if(!(s<0)){i(a,s);break}}},i._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(i){var n=t.createBuffer(new hr(dn.VERTEX,gn.DEVICE,i.view.length,i.view.stride)),r=new Uint8Array(e,i.view.offset,i.view.length);return n.update(r),n}))},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:R1})},Q(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=go(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),e}(Mu),m1=lt((d1=g1).prototype,"_struct",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),v1=lt(d1.prototype,"_hash",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p1=d1))||p1;function M1(t,e){for(var i=0,n=0;n<e;++n){var r=t[n];i+=Zr[r.format].size}return i}u.Mesh=D1;var O1=lh.isLittleEndian;function B1(t){var e=Zr[t];return e.size/e.count}function N1(t,e){var i=Zr[e],n=i.size/i.count;switch(i.type){case fn.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,O1)};case 4:return function(e){return t.getUint32(e,O1)}}break;case fn.SNORM:case fn.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,O1)};case 4:return function(e){return t.getInt32(e,O1)}}break;case fn.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,O1)};case 4:return function(e){return t.getUint32(e,O1)}}break;case fn.FLOAT:return function(e){return t.getFloat32(e,O1)}}return null}function L1(t,e){var i=Zr[e],n=i.size/i.count;switch(i.type){case fn.UNORM:switch(n){case 1:return function(e,i){return t.setUint8(e,i)};case 2:return function(e,i){return t.setUint16(e,i,O1)};case 4:return function(e,i){return t.setUint32(e,i,O1)}}break;case fn.SNORM:case fn.INT:switch(n){case 1:return function(e,i){return t.setInt8(e,i)};case 2:return function(e,i){return t.setInt16(e,i,O1)};case 4:return function(e,i){return t.setInt32(e,i,O1)}}break;case fn.UINT:switch(n){case 1:return function(e,i){return t.setUint8(e,i)};case 2:return function(e,i){return t.setUint16(e,i,O1)};case 4:return function(e,i){return t.setUint32(e,i,O1)}}break;case fn.FLOAT:return function(e,i){return t.setFloat32(e,i,O1)}}return null}var F1=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_NORMAL,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RG32F),new Pr(Kn.ATTR_TANGENT,_n.RGBA32F),new Pr(Kn.ATTR_COLOR,_n.RGBA32F)],z1=new Ei;function V1(t,e,i){i=i||{};var n,r=[],o=0,a=[],s=0,c=t.positions.slice();if(c.length>0){if(n=null,t.attributes)for(var l,u=st(t.attributes);!(l=u()).done;){var h=l.value;if(h.name===Kn.ATTR_POSITION){n=h;break}}n||(n=F1[0]),r.push(n);var _=Zr[n.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:n}),o+=_.size}if(t.normals&&t.normals.length>0){if(n=null,t.attributes)for(var f,p=st(t.attributes);!(f=p()).done;){var d=f.value;if(d.name===Kn.ATTR_NORMAL){n=d;break}}n||(n=F1[1]);var m=Zr[n.format];r.push(n),s=Math.max(s,Math.floor(t.normals.length/m.count)),a.push({offset:o,data:t.normals,attribute:n}),o+=m.size}if(t.uvs&&t.uvs.length>0){if(n=null,t.attributes)for(var v,g=st(t.attributes);!(v=g()).done;){var y=v.value;if(y.name===Kn.ATTR_TEX_COORD){n=y;break}}n||(n=F1[2]);var x=Zr[n.format];r.push(n),s=Math.max(s,Math.floor(t.uvs.length/x.count)),a.push({offset:o,data:t.uvs,attribute:n}),o+=x.size}if(t.tangents&&t.tangents.length>0){if(n=null,t.attributes)for(var S,b=st(t.attributes);!(S=b()).done;){var C=S.value;if(C.name===Kn.ATTR_TANGENT){n=C;break}}n||(n=F1[3]);var A=Zr[n.format];r.push(n),s=Math.max(s,Math.floor(t.tangents.length/A.count)),a.push({offset:o,data:t.tangents,attribute:n}),o+=A.size}if(t.colors&&t.colors.length>0){if(n=null,t.attributes)for(var T,w=st(t.attributes);!(T=w()).done;){var E=T.value;if(E.name===Kn.ATTR_COLOR){n=E;break}}n||(n=F1[4]);var P=Zr[n.format];r.push(n),s=Math.max(s,Math.floor(t.colors.length/P.count)),a.push({offset:o,data:t.colors,attribute:n}),o+=P.size}if(t.customAttributes)for(var I,R=st(t.customAttributes);!(I=R()).done;){var D=I.value,M=Zr[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/M.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=M.size}for(var O=new y1,B=new ArrayBuffer(s*o),N=new DataView(B),L=0,F=a;L<F.length;L++){var z=F[L];Lw(N,z.data,z.attribute.format,z.offset,o)}O.setNextAlignment(0);var V={attributes:r,view:{offset:O.getLength(),length:B.byteLength,count:s,stride:o}};O.addBuffer(B);var k=null,U=0;if(t.indices){var G=t.indices;U=G.length,k=new ArrayBuffer(2*U),Lw(new DataView(k),G,_n.R16UI)}var H={primitiveMode:t.primitiveMode||Fn.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(O.setNextAlignment(2),H.indexView={offset:O.getLength(),length:k.byteLength,count:U,stride:2},O.addBuffer(k));var j=t.minPos;if(!j&&i.calculateBounds){j=Ei.set(new Ei,1/0,1/0,1/0);for(var W=0;W<s;++W)Ei.set(z1,c[3*W+0],c[3*W+1],c[3*W+2]),Ei.min(j,j,z1)}var q=t.maxPos;if(!q&&i.calculateBounds){q=Ei.set(new Ei,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)Ei.set(z1,c[3*X+0],c[3*X+1],c[3*X+2]),Ei.max(q,q,z1)}var Y={vertexBundles:[V],primitives:[H]};return j&&(Y.minPosition=new Ei(j.x,j.y,j.z)),q&&(Y.maxPosition=new Ei(q.x,q.y,q.z)),e||(e=new D1),e.reset({struct:Y,data:new Uint8Array(O.getCombined())}),e}var k1,U1,G1,H1,j1,W1,q1,X1,Y1,K1,J1,Q1,Z1,$1,t2,e2,i2,n2,r2,o2,a2,s2,c2,l2,u2,h2,_2,f2,p2,d2,m2,v2,g2,y2,x2,S2,b2,C2,A2,T2,w2,E2,P2,I2,R2,D2,M2,O2,B2=Object.freeze({__proto__:null,find:bD,toPPM:function(t,e,i){return"P3 "+e+" "+i+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:function(t,e){void 0===e&&(e=0);for(var i,n={positions:[]},r=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),o=t.struct,a=o.primitives[e],s=st(a.vertexBundelIndices);!(i=s()).done;)for(var c,l=i.value,u=o.vertexBundles[l],h=u.view.offset,_=u.view,f=_.length,p=_.stride,d=st(u.attributes);!(c=d()).done;){var m=c.value,v=_1[m.name];v&&(n[v]=(n[v]||[]).concat(Fw(r,m.format,h,f,p))),h+=Zr[m.format].size}var g=a.indexView;return n.indices=Fw(r,_n["R"+8*g.stride+"UI"],g.offset,g.length),n},createMesh:V1,readBuffer:Fw,writeBuffer:Lw,mapBuffer:zw}),N2=function(e){return t({Billboard:e,BillboardComponent:e}),e}((k1=pc("cc.Billboard"),U1=Rc(),G1=wc(),H1=Kc(Cv),j1=Kc(Cv),W1=Nc(),q1=Nc(),X1=Nc(),Y1=Nc(),k1(K1=U1(K1=G1(K1=Tc((e2=function(t){function e(){var e;return ct(e=t.call(this)||this,"_texture",Q1,ot(e)),ct(e,"_height",Z1,ot(e)),ct(e,"_width",$1,ot(e)),ct(e,"_rotation",t2,ot(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Ji(1,1,0,0),e}$(e,t);var i=e.prototype;return i.onLoad=function(){this.createModel()},i.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},i.onDisable=function(){this.detachFromScene()},i.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},i.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i.createModel=function(){this._mesh=V1({primitiveMode:Fn.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Ti.WHITE.r,Ti.WHITE.g,Ti.WHITE.b,Ti.WHITE.a,Ti.WHITE.r,Ti.WHITE.g,Ti.WHITE.b,Ti.WHITE.a,Ti.WHITE.r,Ti.WHITE.g,Ti.WHITE.b,Ti.WHITE.a,Ti.WHITE.r,Ti.WHITE.g,Ti.WHITE.b,Ti.WHITE.a],attributes:[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RG32F),new Pr(Kn.ATTR_COLOR,_n.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=u.director.root.createModel(cb,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new cg,this._material.copy(Mv.get("default-billboard-material"))),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},Q(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*ui(this._rotation))/100},set:function(t){this._rotation=li(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),e}($u),Q1=lt((J1=e2).prototype,"_texture",[H1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(J1.prototype,"texture",[j1,W1],Object.getOwnPropertyDescriptor(J1.prototype,"texture"),J1.prototype),Z1=lt(J1.prototype,"_height",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(J1.prototype,"height",[q1],Object.getOwnPropertyDescriptor(J1.prototype,"height"),J1.prototype),$1=lt(J1.prototype,"_width",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(J1.prototype,"width",[X1],Object.getOwnPropertyDescriptor(J1.prototype,"width"),J1.prototype),t2=lt(J1.prototype,"_rotation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(J1.prototype,"rotation",[Y1],Object.getOwnPropertyDescriptor(J1.prototype,"rotation"),J1.prototype),K1=J1))||K1)||K1)||K1)||K1)),L2=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RGBA32F),new Pr(Kn.ATTR_TEX_COORD1,_n.RGB32F),new Pr(Kn.ATTR_COLOR,_n.RGBA8,!0)],F2=new Ei,z2=new Ei,V2=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=tb.LINE,e._capacity=100,e._iaInfo=new dr([new fr]),e._iaInfoBuffer=e._device.createBuffer(new hr(dn.INDIRECT,gn.DEVICE,io,io)),e}$(e,t);var i=e.prototype;return i.setCapacity=function(t){this._capacity=t,this.createBuffer()},i.createBuffer=function(){this._vertSize=0;for(var t,e=st(L2);!(t=e()).done;){var i=t.value;i.offset=this._vertSize,this._vertSize+=Zr[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},i.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var o=2*r;i[n++]=o,i[n++]=o+1,i[n++]=o+2,i[n++]=o+3,i[n++]=o+2,i[n++]=o+1}var a=this._device.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Uw([t],L2,Fn.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},i.addLineVertexData=function(t,e,i){if(t.length>1){var n=0;Ei.subtract(F2,t[1],t[0]),this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=e.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=F2.x,this._vdataF32[n++]=F2.y,this._vdataF32[n++]=F2.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=e.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=F2.x,this._vdataF32[n++]=F2.y,this._vdataF32[n++]=F2.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<t.length-1;r++){Ei.subtract(F2,t[r-1],t[r]),Ei.subtract(z2,t[r+1],t[r]),Ei.subtract(z2,z2,F2);var o=r/t.length;this._vdataF32[n++]=t[r].x,this._vdataF32[n++]=t[r].y,this._vdataF32[n++]=t[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=e.evaluate(o,1),this._vdataF32[n++]=o,this._vdataF32[n++]=0,this._vdataF32[n++]=z2.x,this._vdataF32[n++]=z2.y,this._vdataF32[n++]=z2.z,this._vdataUint32[n++]=i.evaluate(o,1)._val,this._vdataF32[n++]=t[r].x,this._vdataF32[n++]=t[r].y,this._vdataF32[n++]=t[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=e.evaluate(o,1),this._vdataF32[n++]=o,this._vdataF32[n++]=1,this._vdataF32[n++]=z2.x,this._vdataF32[n++]=z2.y,this._vdataF32[n++]=z2.z,this._vdataUint32[n++]=i.evaluate(o,1)._val}Ei.subtract(F2,t[t.length-1],t[t.length-2]),this._vdataF32[n++]=t[t.length-1].x,this._vdataF32[n++]=t[t.length-1].y,this._vdataF32[n++]=t[t.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=e.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=F2.x,this._vdataF32[n++]=F2.y,this._vdataF32[n++]=F2.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=t[t.length-1].x,this._vdataF32[n++]=t[t.length-1].y,this._vdataF32[n++]=t[t.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=e.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=F2.x,this._vdataF32[n++]=F2.y,this._vdataF32[n++]=F2.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},i.updateIA=function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(cb),k2=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],U2=oe({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),G2=t("CurveRange",(i2=pc("cc.CurveRange"),n2=Kc(U2),r2=Kc(df),o2=Kc(df),a2=Kc(df),i2((g2=v2=function(){function t(){ct(this,"mode",l2,this),ct(this,"spline",u2,this),ct(this,"splineMin",h2,this),ct(this,"splineMax",_2,this),ct(this,"constant",f2,this),ct(this,"constantMin",p2,this),ct(this,"constantMax",d2,this),ct(this,"multiplier",m2,this),this._curve=new yp(this.spline),this._curveMin=new yp(this.splineMin),this._curveMax=new yp(this.splineMax)}var e=t.prototype;return e.evaluate=function(t,e){switch(this.mode){default:case U2.Constant:return this.constant;case U2.Curve:return this.spline.evaluate(t)*this.multiplier;case U2.TwoCurves:return ci(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case U2.TwoConstants:return ci(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this.mode){default:case U2.Constant:return this.constant;case U2.Curve:return this.multiplier;case U2.TwoConstants:return this.constantMax;case U2.TwoCurves:return this.multiplier}},e._onBeforeSerialize=function(){return k2[this.mode]},Q(t,[{key:"curve",get:function(){return this._curve},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}(),v2.Mode=U2,l2=lt((c2=g2).prototype,"mode",[n2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U2.Constant}}),u2=lt(c2.prototype,"spline",[r2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bp()}}),h2=lt(c2.prototype,"splineMin",[o2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bp()}}),_2=lt(c2.prototype,"splineMax",[a2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bp()}}),f2=lt(c2.prototype,"constant",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p2=lt(c2.prototype,"constantMin",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d2=lt(c2.prototype,"constantMax",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m2=lt(c2.prototype,"multiplier",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),s2=c2))||s2));function H2(t,e,i){switch(t.mode){case U2.Constant:return t.constant;case U2.Curve:return t.spline.evaluate(e)*t.multiplier;case U2.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case U2.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function j2(t){switch(t.mode){case U2.TwoConstants:case U2.TwoCurves:return 2;default:return 1}}function W2(t,e,i){var n=new tv({width:e,height:i,_data:t,_compressed:!1,format:Dm.RGBA32F}),r=new Cv;return r.setFilters(Om.NEAREST,Om.NEAREST),r.setMipFilter(Om.NONE),r.setWrapMode(Mm.CLAMP_TO_EDGE,Mm.CLAMP_TO_EDGE,Mm.CLAMP_TO_EDGE),r.image=n,r}function q2(t,e,i,n,r){for(var o=Math.max(j2(e),j2(i),j2(n)),a=new Float32Array(t*o*4),s=[e,i,n],c=1/(t-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],_=0,f=0,p=0;p<t;p++){var d=H2(h,c*p,l);f=r?d:(_+=d)/(p+1),a[4*p+u]=f}return W2(a,t,o)}var X2,Y2,K2,J2,Q2,Z2,$2,t4,e4,i4,n4,r4,o4,a4,s4,c4,l4,u4,h4,_4,f4,p4,d4,m4,v4,g4,y4,x4,S4,b4,C4,A4,T4,w4,E4,P4,I4,R4,D4,M4,O4,B4,N4,L4,F4,z4,V4,k4,U4,G4,H4,j4,W4,q4,X4,Y4=oe({Blend:0,Fixed:1}),K4=(t("ColorKey",pc("cc.ColorKey")((S2=lt((x2=function(){ct(this,"color",S2,this),ct(this,"time",b2,this)}).prototype,"color",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),b2=lt(x2.prototype,"time",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y2=x2))||y2),t("AlphaKey",pc("cc.AlphaKey")((T2=lt((A2=function(){ct(this,"alpha",T2,this),ct(this,"time",w2,this)}).prototype,"alpha",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),w2=lt(A2.prototype,"time",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C2=A2))||C2),t("Gradient",pc("cc.Gradient")((O2=M2=function(){function t(){ct(this,"colorKeys",I2,this),ct(this,"alphaKeys",R2,this),ct(this,"mode",D2,this),this._color=void 0,this._color=Ti.WHITE.clone()}var e=t.prototype;return e.setKeys=function(t,e){this.colorKeys=t,this.alphaKeys=e},e.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(t,e){return t.time-e.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(t,e){return t.time-e.time}))},e.evaluate=function(t){return this.getRGB(t),this._color._set_a_unsafe(this.getAlpha(t)),this._color},e.randomColor=function(){var t=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],e=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(t.color),this._color._set_a_unsafe(e.alpha),this._color},e.getRGB=function(t){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(Ti.WHITE),this._color);t=gi(t,1);for(var e=1;e<this.colorKeys.length;++e){var i=this.colorKeys[e-1].time,n=this.colorKeys[e].time;if(t>=i&&t<n){if(this.mode===Y4.Fixed)return this.colorKeys[e].color;var r=(t-i)/(n-i);return Ti.lerp(this._color,this.colorKeys[e-1].color,this.colorKeys[e].color,r),this._color}}var o=this.colorKeys.length-1;t<this.colorKeys[0].time?Ti.lerp(this._color,Ti.BLACK,this.colorKeys[0].color,t/this.colorKeys[0].time):t>this.colorKeys[o].time&&Ti.lerp(this._color,this.colorKeys[o].color,Ti.BLACK,(t-this.colorKeys[o].time)/(1-this.colorKeys[o].time))},e.getAlpha=function(t){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;t=gi(t,1);for(var e=1;e<this.alphaKeys.length;++e){var i=this.alphaKeys[e-1].time,n=this.alphaKeys[e].time;if(t>=i&&t<n){if(this.mode===Y4.Fixed)return this.alphaKeys[e].alpha;var r=(t-i)/(n-i);return ci(this.alphaKeys[e-1].alpha,this.alphaKeys[e].alpha,r)}}var o=this.alphaKeys.length-1;return t<this.alphaKeys[0].time?ci(0,this.alphaKeys[0].alpha,t/this.alphaKeys[0].time):t>this.alphaKeys[o].time?ci(this.alphaKeys[o].alpha,0,(t-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):void 0},t}(),M2.Mode=Y4,I2=lt((P2=O2).prototype,"colorKeys",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),R2=lt(P2.prototype,"alphaKeys",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),D2=lt(P2.prototype,"mode",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y4.Blend}}),E2=P2))||E2)),J4=oe({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Q4=t("GradientRange",(X2=pc("cc.GradientRange"),Y2=Kc(J4),K2=Kc(K4),J2=Kc(K4),Q2=Kc(K4),Z2=Kc(J4),X2((l4=c4=function(){function t(){ct(this,"color",e4,this),ct(this,"colorMin",i4,this),ct(this,"colorMax",n4,this),ct(this,"gradient",r4,this),ct(this,"gradientMin",o4,this),ct(this,"gradientMax",a4,this),ct(this,"_mode",s4,this),this._color=Ti.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case J4.Color:return this.color;case J4.TwoColors:return Ti.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case J4.RandomColor:return this.gradient.randomColor();case J4.Gradient:return this.gradient.evaluate(t);case J4.TwoGradients:return Ti.lerp(this._color,this.gradientMin.evaluate(t),this.gradientMax.evaluate(t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return(!1)[this._mode]},Q(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),c4.Mode=J4,lt((t4=l4).prototype,"mode",[Y2],Object.getOwnPropertyDescriptor(t4.prototype,"mode"),t4.prototype),e4=lt(t4.prototype,"color",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),i4=lt(t4.prototype,"colorMin",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),n4=lt(t4.prototype,"colorMax",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),r4=lt(t4.prototype,"gradient",[K2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K4}}),o4=lt(t4.prototype,"gradientMin",[J2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K4}}),a4=lt(t4.prototype,"gradientMax",[Q2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K4}}),s4=lt(t4.prototype,"_mode",[Z2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J4.Color}}),$2=t4))||$2));function Z4(t,e,i){switch(t.mode){case J4.Color:return t.color;case J4.TwoColors:return 0===i?t.colorMin:t.colorMax;case J4.RandomColor:return t.gradient.randomColor();case J4.Gradient:return t.gradient.evaluate(e);case J4.TwoGradients:return 0===i?t.gradientMin.evaluate(e):t.gradientMax.evaluate(e);default:return t.color}}var $4={parent:null,owner:null,subModelIdx:0},t3={CC_USE_WORLD_SPACE:!1},e3=function(e){return t({Line:e,LineComponent:e}),e}((u4=pc("cc.Line"),h4=Rc(),_4=wc(),f4=Kc(Cv),p4=Kc(Cv),d4=Uc(),m4=Nc(),v4=Uc(),g4=Nc(),y4=Kc([Ei]),x4=Kc([Ei]),S4=Uc(),b4=Nc(),C4=Kc(G2),A4=Kc(G2),T4=Lc(),w4=Uc(),E4=Nc(),P4=Kc(qi),I4=Uc(),R4=Nc(),D4=Kc(qi),M4=Uc(),O4=Nc(),B4=Kc(Q4),N4=Kc(Q4),L4=Uc(),F4=Nc(),u4(z4=h4(z4=_4(z4=Tc((X4=function(t){function e(){var e;return ct(e=t.call(this)||this,"_texture",k4,ot(e)),e._material=null,e._materialInstance=null,ct(e,"_worldSpace",U4,ot(e)),ct(e,"_positions",G4,ot(e)),ct(e,"_width",H4,ot(e)),ct(e,"_tile",j4,ot(e)),ct(e,"_offset",W4,ot(e)),ct(e,"_color",q4,ot(e)),e._model=null,e._tile_offset=new Ji,e}$(e,t);var i=e.prototype;return i.onLoad=function(){var t=this._model=u.director.root.createModel(V2);t.node=t.transform=this.node,null===this._material&&(this._material=new cg,this._material.copy(Mv.get("default-trail-material")),t3.CC_USE_WORLD_SPACE=this.worldSpace,$4.parent=this._material,$4.subModelIdx=0,this._materialInstance=new mb($4),$4.parent=null,$4.subModelIdx=0,this._materialInstance.recompileShaders(t3)),t.updateMaterial(this._materialInstance),t.setCapacity(100)},i.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},i.onDisable=function(){this._model&&this._detachFromScene()},i._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},i._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},Q(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._materialInstance&&this._materialInstance.setProperty("mainTexture",t)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t,this._materialInstance&&(t3.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(t3),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),e}($u),k4=lt((V4=X4).prototype,"_texture",[f4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(V4.prototype,"texture",[p4,d4,m4],Object.getOwnPropertyDescriptor(V4.prototype,"texture"),V4.prototype),U4=lt(V4.prototype,"_worldSpace",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(V4.prototype,"worldSpace",[v4,g4],Object.getOwnPropertyDescriptor(V4.prototype,"worldSpace"),V4.prototype),G4=lt(V4.prototype,"_positions",[y4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(V4.prototype,"positions",[x4,S4,b4],Object.getOwnPropertyDescriptor(V4.prototype,"positions"),V4.prototype),H4=lt(V4.prototype,"_width",[C4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),lt(V4.prototype,"width",[A4,T4,w4,E4],Object.getOwnPropertyDescriptor(V4.prototype,"width"),V4.prototype),j4=lt(V4.prototype,"_tile",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(1,1)}}),lt(V4.prototype,"tile",[P4,I4,R4],Object.getOwnPropertyDescriptor(V4.prototype,"tile"),V4.prototype),W4=lt(V4.prototype,"_offset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(0,0)}}),lt(V4.prototype,"offset",[D4,M4,O4],Object.getOwnPropertyDescriptor(V4.prototype,"offset"),V4.prototype),q4=lt(V4.prototype,"_color",[B4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q4}}),lt(V4.prototype,"color",[N4,L4,F4],Object.getOwnPropertyDescriptor(V4.prototype,"color"),V4.prototype),z4=V4))||z4)||z4)||z4)||z4)),i3=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new Ei(0,0,0),this.velocity=new Ei(0,0,0),this.animatedVelocity=new Ei(0,0,0),this.ultimateVelocity=new Ei(0,0,0),this.angularVelocity=new Ei(0,0,0),this.axisOfRotation=new Ei(0,0,0),this.rotation=new Ei(0,0,0),this.startEuler=new Ei(0,0,0),this.startRotation=new Bi,this.startRotated=!1,this.deltaQuat=new Bi,this.deltaMat=new Gi,this.localMat=new Gi,this.startSize=new Ei(0,0,0),this.size=new Ei(0,0,0),this.startColor=Ti.WHITE.clone(),this.color=Ti.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();i3.INDENTIFY_NEG_QUAT=10,i3.R2D=180/Math.PI;var n3,r3,o3,a3,s3,c3,l3,u3,h3,_3,f3,p3,d3,m3,v3,g3,y3,x3,S3,b3,C3,A3,T3,w3,E3,P3,I3,R3,D3,M3,O3,B3,N3,L3,F3="colorModule",z3="rotationModule",V3="sizeModule",k3="textureModule",U3=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],G3=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],H3=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),j3=oe({World:0,Local:1,Custom:2}),W3=oe({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),q3=oe({World:0,Local:1,View:2}),X3=oe({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),Y3=oe({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),K3=oe({Base:0,Edge:1,Shell:2,Volume:3}),J3=oe({Random:0,Loop:1,PingPong:2}),Q3=oe({Particles:0}),Z3=oe({Stretch:0}),$3=(n3=pc("cc.ColorOvertimeModule"),r3=Uc(),o3=Kc(Q4),a3=Uc(),n3((h3=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_enable",l3,ot(e)),ct(e,"color",u3,ot(e)),e.name=F3,e}return $(e,t),e.prototype.animate=function(t){t.color.set(t.startColor),t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,pi(t.randomSeed+91041)))},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(H3),l3=lt((c3=h3).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(c3.prototype,"enable",[r3],Object.getOwnPropertyDescriptor(c3.prototype,"enable"),c3.prototype),u3=lt(c3.prototype,"color",[o3,xc,a3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q4}}),s3=c3))||s3),t5=new Ei(0,0,-1);function e5(t,e,i,n){return e!==t?(t===j3.World||Gi.invert(i,i),Gi.getRotation(n,i),!0):(Bi.set(n,0,0,0,1),!1)}function i5(t,e){qi.set(t,Math.cos(e),Math.sin(e))}function n5(t){var e=_i(-1,1),i=_i(0,2*Math.PI),n=Math.sqrt(1-e*e),r=n*Math.cos(i),o=n*Math.sin(i);Ei.set(t,r,o,e)}function r5(t,e,i){n5(t),Ei.multiplyScalar(t,t,e+(i-e)*hi())}function o5(t,e,i,n){i5(t,n),t.z=0,Ei.multiplyScalar(t,t,e+(i-e)*hi())}function a5(t){for(var e=0;e<t.length;e++){var i=e+fi(0,t.length-e),n=t[i];t[i]=t[e],t[e]=n}}function s5(){var t=_i(-1,1);return 0===t&&t++,n(t)}var c5,l5,u5,h5,_5,f5,p5,d5,m5,v5,g5,y5,x5,S5,b5,C5,A5,T5,w5,E5,P5,I5,R5,D5,M5,O5,B5,N5,L5,F5,z5,V5,k5,U5,G5,H5,j5,W5,q5,X5,Y5,K5,J5,Q5,Z5,$5,t6,e6,i6,n6,r6,o6,a6,s6,c6,l6,u6,h6,_6,f6,p6=212165,d6=new Ei,m6=(_3=pc("cc.ForceOvertimeModule"),f3=Uc(),p3=Kc(G2),d3=Lc(),m3=Uc(),v3=Nc(),g3=Kc(G2),y3=Lc(),x3=Uc(),S3=Nc(),b3=Kc(G2),C3=Lc(),A3=Uc(),T3=Nc(),w3=Kc(j3),E3=Uc(),P3=Nc(),_3((L3=function(t){function e(){var e;return ct(e=t.call(this)||this,"_enable",D3,ot(e)),ct(e,"x",M3,ot(e)),ct(e,"y",O3,ot(e)),ct(e,"z",B3,ot(e)),ct(e,"space",N3,ot(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new Bi,e.needTransform=!1,e.needUpdate=!0,e}$(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=e5(t,this.space,e,this.rotation)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,n=Ei.set(d6,this.x.evaluate(i,pi(t.randomSeed+p6)),this.y.evaluate(i,pi(t.randomSeed+p6)),this.z.evaluate(i,pi(t.randomSeed+p6)));this.needTransform&&Ei.transformQuat(n,n,this.rotation),Ei.scaleAndAdd(t.velocity,t.velocity,n,e),Ei.copy(t.ultimateVelocity,t.velocity)},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(H3),D3=lt((R3=L3).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(R3.prototype,"enable",[f3],Object.getOwnPropertyDescriptor(R3.prototype,"enable"),R3.prototype),M3=lt(R3.prototype,"x",[p3,xc,d3,m3,v3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),O3=lt(R3.prototype,"y",[g3,xc,y3,x3,S3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),B3=lt(R3.prototype,"z",[b3,xc,C3,A3,T3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),N3=lt(R3.prototype,"space",[w3,xc,E3,P3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j3.Local}}),I3=R3))||I3),v6=23541,g6=new Ei,y6=new Ei,x6=(c5=pc("cc.LimitVelocityOvertimeModule"),l5=Uc(),u5=Kc(G2),h5=Lc(),_5=Uc(),f5=Nc(),p5=Kc(G2),d5=Lc(),m5=Uc(),v5=Nc(),g5=Kc(G2),y5=Lc(),x5=Uc(),S5=Nc(),b5=Kc(G2),C5=Lc(),A5=Uc(),T5=Nc(),w5=Uc(),E5=Nc(),P5=Uc(),I5=Nc(),R5=Kc(j3),D5=Uc(),M5=Nc(),c5((H5=function(t){function e(){var e;return ct(e=t.call(this)||this,"_enable",N5,ot(e)),ct(e,"limitX",L5,ot(e)),ct(e,"limitY",F5,ot(e)),ct(e,"limitZ",z5,ot(e)),ct(e,"limit",V5,ot(e)),ct(e,"dampen",k5,ot(e)),ct(e,"separateAxes",U5,ot(e)),ct(e,"space",G5,ot(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new Bi,e.needTransform=!1,e.needUpdate=!0,e}$(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=e5(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=g6;this.separateAxes?(Ei.set(y6,this.limitX.evaluate(e,pi(t.randomSeed+v6)),this.limitY.evaluate(e,pi(t.randomSeed+v6)),this.limitZ.evaluate(e,pi(t.randomSeed+v6))),this.needTransform&&Ei.transformQuat(y6,y6,this.rotation),Ei.set(i,S6(t.ultimateVelocity.x,y6.x,this.dampen),S6(t.ultimateVelocity.y,y6.y,this.dampen),S6(t.ultimateVelocity.z,y6.z,this.dampen))):(Ei.normalize(i,t.ultimateVelocity),Ei.multiplyScalar(i,i,S6(t.ultimateVelocity.length(),this.limit.evaluate(e,pi(t.randomSeed+v6)),this.dampen))),Ei.copy(t.ultimateVelocity,i)},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(H3),N5=lt((B5=H5).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(B5.prototype,"enable",[l5],Object.getOwnPropertyDescriptor(B5.prototype,"enable"),B5.prototype),L5=lt(B5.prototype,"limitX",[u5,xc,h5,_5,f5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),F5=lt(B5.prototype,"limitY",[p5,xc,d5,m5,v5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),z5=lt(B5.prototype,"limitZ",[g5,xc,y5,x5,S5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),V5=lt(B5.prototype,"limit",[b5,xc,C5,A5,T5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),k5=lt(B5.prototype,"dampen",[xc,w5,E5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),U5=lt(B5.prototype,"separateAxes",[xc,P5,I5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G5=lt(B5.prototype,"space",[R5,xc,D5,M5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j3.Local}}),O5=B5))||O5);function S6(t,e,i){var n=Math.sign(t),r=Math.abs(t);return r>e&&(r=ci(r,e,i)),r*n}var b6,C6,A6,T6,w6,E6,P6,I6,R6,D6,M6,O6,B6,N6,L6,F6,z6,V6,k6,U6,G6,H6,j6,W6,q6,X6,Y6,K6,J6,Q6,Z6,$6,t8,e8,i8,n8,r8,o8,a8,s8,c8,l8,u8,h8,_8,f8,p8,d8,m8,v8,g8,y8,x8,S8,b8,C8,A8,T8,w8,E8,P8,I8,R8,D8,M8,O8,B8,N8,L8,F8,z8,V8,k8,U8,G8,H8,j8,W8,q8,X8,Y8,K8,J8,Q8,Z8,$8,t7,e7,i7,n7,r7,o7,a7,s7,c7,l7,u7,h7,_7,f7,p7,d7,m7,v7,g7,y7,x7,S7,b7,C7,A7,T7,w7,E7,P7,I7,R7,D7,M7,O7,B7,N7,L7,F7,z7,V7,k7,U7,G7,H7,j7,W7,q7,X7,Y7,K7,J7,Q7,Z7,$7,t9,e9,i9,n9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,p9,d9,m9,v9,g9,y9,x9,S9,b9,C9,A9,T9,w9,E9,P9,I9,R9,D9,M9,O9,B9,N9,L9,F9,z9,V9,k9,U9,G9=(j5=pc("cc.RotationOvertimeModule"),W5=Uc(),q5=Uc(),X5=Nc(),Y5=Kc(G2),K5=Lc(),J5=Uc(),Q5=Nc(),Z5=Kc(G2),$5=Lc(),t6=Uc(),e6=Nc(),i6=Kc(G2),n6=Lc(),r6=Uc(),o6=Nc(),j5((f6=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_enable",c6,ot(e)),ct(e,"_separateAxes",l6,ot(e)),ct(e,"x",u6,ot(e)),ct(e,"y",h6,ot(e)),ct(e,"z",_6,ot(e)),e.name=z3,e._startMat=new Gi,e._matRot=new Gi,e._quatRot=new Bi,e._otherEuler=new Ei,e}$(e,t);var i=e.prototype;return i._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==X3.Mesh&&e===X3.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Bi.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=i3.INDENTIFY_NEG_QUAT)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,n=pi(t.randomSeed+125292),r=t.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==X3.VerticalBillboard&&r!==X3.HorizontalBillboard?Bi.fromEuler(t.deltaQuat,this.x.evaluate(i,n)*e*i3.R2D,this.y.evaluate(i,n)*e*i3.R2D,this.z.evaluate(i,n)*e*i3.R2D):Bi.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,n)*e*i3.R2D),t.deltaMat=Gi.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==X3.Mesh&&(r===X3.StrecthedBillboard?t.startEuler.set(0,0,0):r!==X3.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),Bi.fromEuler(t.startRotation,t.startEuler.x*i3.R2D,t.startEuler.y*i3.R2D,t.startEuler.z*i3.R2D),t.startRotated=!0),this._startMat=Gi.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),Gi.getRotation(this._quatRot,this._matRot),this._processRotation(t,i3.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(H3),c6=lt((s6=f6).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(s6.prototype,"enable",[W5],Object.getOwnPropertyDescriptor(s6.prototype,"enable"),s6.prototype),l6=lt(s6.prototype,"_separateAxes",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(s6.prototype,"separateAxes",[q5,X5],Object.getOwnPropertyDescriptor(s6.prototype,"separateAxes"),s6.prototype),u6=lt(s6.prototype,"x",[Y5,xc,K5,Gc,J5,Q5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),h6=lt(s6.prototype,"y",[Z5,xc,$5,Gc,t6,e6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),_6=lt(s6.prototype,"z",[i6,xc,n6,Gc,r6,o6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),a6=s6))||a6),H9=(b6=pc("cc.SizeOvertimeModule"),C6=Uc(),A6=Uc(),T6=Nc(),w6=Kc(G2),E6=Lc(),P6=Uc(),I6=Nc(),R6=Kc(G2),D6=Lc(),M6=Uc(),O6=Nc(),B6=Kc(G2),N6=Lc(),L6=Uc(),F6=Nc(),z6=Kc(G2),V6=Lc(),k6=Uc(),U6=Nc(),b6((J6=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_enable",j6,ot(e)),ct(e,"separateAxes",W6,ot(e)),ct(e,"size",q6,ot(e)),ct(e,"x",X6,ot(e)),ct(e,"y",Y6,ot(e)),ct(e,"z",K6,ot(e)),e.name=V3,e}return $(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,i=pi(t.randomSeed+39825);t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,i),t.size.z=t.startSize.z*this.z.evaluate(e,i)}else Ei.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,pi(t.randomSeed+39825)))},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(H3),j6=lt((H6=J6).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(H6.prototype,"enable",[C6],Object.getOwnPropertyDescriptor(H6.prototype,"enable"),H6.prototype),W6=lt(H6.prototype,"separateAxes",[xc,A6,T6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q6=lt(H6.prototype,"size",[w6,xc,E6,P6,I6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),X6=lt(H6.prototype,"x",[R6,xc,D6,M6,O6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),Y6=lt(H6.prototype,"y",[B6,xc,N6,L6,F6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),K6=lt(H6.prototype,"z",[z6,xc,V6,k6,U6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),G6=H6))||G6),j9=90794,W9=oe({Grid:0}),q9=oe({WholeSheet:0,SingleRow:1}),X9=(Q6=pc("cc.TextureAnimationModule"),Z6=Sc("numTilesX"),$6=Sc("numTilesY"),t8=Uc(),e8=Kc(W9),i8=Kc(W9),n8=Uc(),r8=Nc(),o8=Uc(),a8=Nc(),s8=Uc(),c8=Nc(),l8=Kc(q9),u8=Uc(),h8=Nc(),_8=Kc(G2),f8=Lc(),p8=Uc(),d8=Nc(),m8=Kc(G2),v8=Lc(),g8=Uc(),y8=Nc(),x8=Uc(),S8=Nc(),b8=Uc(),C8=Nc(),A8=Uc(),T8=Nc(),Q6((U8=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_enable",P8,ot(e)),ct(e,"_numTilesX",I8,ot(e)),ct(e,"_numTilesY",R8,ot(e)),ct(e,"_mode",D8,ot(e)),ct(e,"animation",M8,ot(e)),ct(e,"frameOverTime",O8,ot(e)),ct(e,"startFrame",B8,ot(e)),ct(e,"cycleCount",N8,ot(e)),ct(e,"_flipU",L8,ot(e)),ct(e,"_flipV",F8,ot(e)),ct(e,"_uvChannelMask",z8,ot(e)),ct(e,"randomRow",V8,ot(e)),ct(e,"rowIndex",k8,ot(e)),e.name=k3,e}$(e,t);var i=e.prototype;return i.init=function(t){t.startRow=Math.floor(Math.random()*this.numTilesY)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=this.startFrame.evaluate(e,pi(t.randomSeed+j9))/(this.numTilesX*this.numTilesY);if(this.animation===q9.WholeSheet)t.frameIndex=gi(this.cycleCount*(this.frameOverTime.evaluate(e,pi(t.randomSeed+j9))+i),1);else if(this.animation===q9.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=gi(this.cycleCount*(this.frameOverTime.evaluate(e,pi(t.randomSeed+j9))+i),1),o=t.startRow*n,a=o+n;t.frameIndex=ci(o,a,r)}else{var s=this.rowIndex*n,c=s+n;t.frameIndex=ci(s,c,gi(this.cycleCount*(this.frameOverTime.evaluate(e,pi(t.randomSeed+j9))+i),1))}}},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==W9.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(H3),P8=lt((E8=U8).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I8=lt(E8.prototype,"_numTilesX",[Z6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),R8=lt(E8.prototype,"_numTilesY",[$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(E8.prototype,"enable",[t8],Object.getOwnPropertyDescriptor(E8.prototype,"enable"),E8.prototype),D8=lt(E8.prototype,"_mode",[e8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W9.Grid}}),lt(E8.prototype,"mode",[i8,n8,r8],Object.getOwnPropertyDescriptor(E8.prototype,"mode"),E8.prototype),lt(E8.prototype,"numTilesX",[o8,a8],Object.getOwnPropertyDescriptor(E8.prototype,"numTilesX"),E8.prototype),lt(E8.prototype,"numTilesY",[s8,c8],Object.getOwnPropertyDescriptor(E8.prototype,"numTilesY"),E8.prototype),M8=lt(E8.prototype,"animation",[l8,xc,u8,h8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q9.WholeSheet}}),O8=lt(E8.prototype,"frameOverTime",[_8,xc,f8,p8,d8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),B8=lt(E8.prototype,"startFrame",[m8,xc,v8,g8,y8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),N8=lt(E8.prototype,"cycleCount",[xc,x8,S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L8=lt(E8.prototype,"_flipU",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F8=lt(E8.prototype,"_flipV",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z8=lt(E8.prototype,"_uvChannelMask",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),V8=lt(E8.prototype,"randomRow",[xc,b8,C8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k8=lt(E8.prototype,"rowIndex",[xc,A8,T8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w8=E8))||w8),Y9=197866,K9=new Ei,J9=(G8=pc("cc.VelocityOvertimeModule"),H8=Uc(),j8=Kc(G2),W8=Lc(),q8=Uc(),X8=Nc(),Y8=Kc(G2),K8=Lc(),J8=Uc(),Q8=Nc(),Z8=Kc(G2),$8=Lc(),t7=Uc(),e7=Nc(),i7=Kc(G2),n7=Lc(),r7=Uc(),o7=Nc(),a7=Kc(j3),s7=Uc(),c7=Nc(),G8((v7=function(t){function e(){var e;return ct(e=t.call(this)||this,"_enable",h7,ot(e)),ct(e,"x",_7,ot(e)),ct(e,"y",f7,ot(e)),ct(e,"z",p7,ot(e)),ct(e,"speedModifier",d7,ot(e)),ct(e,"space",m7,ot(e)),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new Bi,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}$(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=e5(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Ei.set(K9,this.x.evaluate(e,pi(t.randomSeed^Y9)),this.y.evaluate(e,pi(156497^t.randomSeed)),this.z.evaluate(e,pi(984136^t.randomSeed)));this.needTransform&&Ei.transformQuat(i,i,this.rotation),Ei.add(t.animatedVelocity,t.animatedVelocity,i),Ei.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),Ei.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,pi(t.randomSeed+Y9)))},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(H3),h7=lt((u7=v7).prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(u7.prototype,"enable",[H8],Object.getOwnPropertyDescriptor(u7.prototype,"enable"),u7.prototype),_7=lt(u7.prototype,"x",[j8,xc,W8,q8,X8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),f7=lt(u7.prototype,"y",[Y8,xc,K8,J8,Q8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),p7=lt(u7.prototype,"z",[Z8,xc,$8,t7,e7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),d7=lt(u7.prototype,"speedModifier",[i7,xc,n7,r7,o7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),m7=lt(u7.prototype,"space",[a7,xc,s7,c7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j3.Local}}),l7=u7))||l7),Q9=t("Burst",(g7=pc("cc.Burst"),y7=Kc(G2),x7=Lc(),g7((E7=function(){function t(){ct(this,"_time",C7,this),ct(this,"_repeatCount",A7,this),ct(this,"repeatInterval",T7,this),ct(this,"count",w7,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=gi(t._time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;var n=gi(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<n&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},Q(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),C7=lt((b7=E7).prototype,"_time",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(b7.prototype,"time",[Dc],Object.getOwnPropertyDescriptor(b7.prototype,"time"),b7.prototype),A7=lt(b7.prototype,"_repeatCount",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(b7.prototype,"repeatCount",[Dc],Object.getOwnPropertyDescriptor(b7.prototype,"repeatCount"),b7.prototype),T7=lt(b7.prototype,"repeatInterval",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),w7=lt(b7.prototype,"count",[y7,xc,x7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),S7=b7))||S7)),Z9=new Ei(0,0,0),$9=[],ttt=new Ei(.5,.5,.5),ett=(P7=pc("cc.ShapeModule"),I7=Uc(),R7=Nc(),D7=Uc(),M7=Nc(),O7=Uc(),B7=Nc(),N7=Uc(),L7=Nc(),F7=Uc(),z7=Nc(),V7=Uc(),k7=Kc(Y3),U7=Sc("shapeType"),G7=Uc(),H7=Kc(Y3),j7=Nc(),W7=Kc(K3),q7=Uc(),X7=Nc(),Y7=Uc(),K7=Nc(),J7=Uc(),Q7=Nc(),Z7=Uc(),$7=Nc(),t9=Uc(),e9=Nc(),i9=Uc(),n9=Nc(),r9=Uc(),o9=Nc(),a9=Kc(J3),s9=Uc(),c9=Nc(),l9=Mc(),u9=Uc(),h9=Nc(),_9=Kc(G2),f9=Mc(),p9=Lc(),d9=Uc(),m9=Nc(),v9=Uc(),g9=Nc(),y9=Uc(),x9=Nc(),P7((lt((b9=function(){function t(){ct(this,"_enable",C9,this),ct(this,"_shapeType",A9,this),ct(this,"emitFrom",T9,this),ct(this,"alignToDirection",w9,this),ct(this,"randomDirectionAmount",E9,this),ct(this,"sphericalDirectionAmount",P9,this),ct(this,"randomPositionAmount",I9,this),ct(this,"radius",R9,this),ct(this,"radiusThickness",D9,this),ct(this,"arcMode",M9,this),ct(this,"arcSpread",O9,this),ct(this,"arcSpeed",B9,this),ct(this,"length",N9,this),ct(this,"boxThickness",L9,this),ct(this,"_position",F9,this),ct(this,"_rotation",z9,this),ct(this,"_scale",V9,this),ct(this,"_arc",k9,this),ct(this,"_angle",U9,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Gi,this.quat=new Bi,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case Y3.Box:!function(t,e,i,n){switch(t){case K3.Volume:r=i,o=ttt,Ei.set(r,_i(-o.x,o.x),_i(-o.y,o.y),_i(-o.z,o.z));break;case K3.Shell:$9.splice(0,$9.length),$9.push(_i(-.5,.5)),$9.push(_i(-.5,.5)),$9.push(.5*s5()),a5($9),itt($9,e),Ei.set(i,$9[0],$9[1],$9[2]);break;case K3.Edge:$9.splice(0,$9.length),$9.push(_i(-.5,.5)),$9.push(.5*s5()),$9.push(.5*s5()),a5($9),itt($9,e),Ei.set(i,$9[0],$9[1],$9[2]);break;default:console.warn(t+" is not supported for box emitter.")}var r,o;Ei.copy(n,t5)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case Y3.Circle:!function(t,e,i,n,r){o5(n,t*(1-e),t,i),Ei.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case Y3.Cone:!function(t,e,i,n,r,o,a,s){switch(t){case K3.Base:o5(a,e*(1-i),e,n),qi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*e,Ei.normalize(s,s),a.z=0;break;case K3.Shell:i5(a,n),qi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),Ei.normalize(s,s),qi.multiplyScalar(a,a,e),a.z=0;break;case K3.Volume:o5(a,e*(1-i),e,n),qi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*e,Ei.normalize(s,s),a.z=0,Ei.add(a,a,Ei.multiplyScalar(Z9,s,o*hi()/-s.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case Y3.Sphere:!function(t,e,i,n,r){switch(t){case K3.Volume:r5(n,e*(1-i),e),Ei.normalize(r,n);break;case K3.Shell:n5(n),Ei.multiplyScalar(n,n,e),Ei.normalize(r,n);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case Y3.Hemisphere:!function(t,e,i,n,r){switch(t){case K3.Volume:r5(n,e*(1-i),e),n.z>0&&(n.z*=-1),Ei.normalize(r,n);break;case K3.Shell:n5(n),Ei.multiplyScalar(n,n,e),n.z>0&&(n.z*=-1),Ei.normalize(r,n);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(t.position.x+=_i(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=_i(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=_i(-this.randomPositionAmount,this.randomPositionAmount)),Ei.transformQuat(t.velocity,t.velocity,this.quat),Ei.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var e=Ei.normalize(Z9,t.position);Ei.lerp(t.velocity,t.velocity,e,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){Bi.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Gi.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===J3.Random)return _i(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case J3.Loop:return gi(t,this._arc);case J3.PingPong:return yi(t,this._arc);default:return gi(t,this._arc)}},Q(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return ui(this._arc)},set:function(t){this._arc=li(t)}},{key:"angle",get:function(){return Math.round(100*ui(this._angle))/100},set:function(t){this._angle=li(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case Y3.Box:this.emitFrom===K3.Base&&(this.emitFrom=K3.Volume);break;case Y3.Cone:this.emitFrom===K3.Edge&&(this.emitFrom=K3.Base);break;case Y3.Sphere:case Y3.Hemisphere:this.emitFrom!==K3.Base&&this.emitFrom!==K3.Edge||(this.emitFrom=K3.Volume)}}}]),t}()).prototype,"position",[I7,R7],Object.getOwnPropertyDescriptor(b9.prototype,"position"),b9.prototype),lt(b9.prototype,"rotation",[D7,M7],Object.getOwnPropertyDescriptor(b9.prototype,"rotation"),b9.prototype),lt(b9.prototype,"scale",[O7,B7],Object.getOwnPropertyDescriptor(b9.prototype,"scale"),b9.prototype),lt(b9.prototype,"arc",[N7,L7],Object.getOwnPropertyDescriptor(b9.prototype,"arc"),b9.prototype),lt(b9.prototype,"angle",[F7,z7],Object.getOwnPropertyDescriptor(b9.prototype,"angle"),b9.prototype),C9=lt(b9.prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(b9.prototype,"enable",[V7],Object.getOwnPropertyDescriptor(b9.prototype,"enable"),b9.prototype),A9=lt(b9.prototype,"_shapeType",[k7,U7,G7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y3.Cone}}),lt(b9.prototype,"shapeType",[H7,j7],Object.getOwnPropertyDescriptor(b9.prototype,"shapeType"),b9.prototype),T9=lt(b9.prototype,"emitFrom",[W7,xc,q7,X7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return K3.Volume}}),w9=lt(b9.prototype,"alignToDirection",[xc,Y7,K7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),E9=lt(b9.prototype,"randomDirectionAmount",[xc,J7,Q7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),P9=lt(b9.prototype,"sphericalDirectionAmount",[xc,Z7,$7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),I9=lt(b9.prototype,"randomPositionAmount",[xc,t9,e9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),R9=lt(b9.prototype,"radius",[xc,i9,n9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),D9=lt(b9.prototype,"radiusThickness",[xc,r9,o9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),M9=lt(b9.prototype,"arcMode",[a9,xc,s9,c9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J3.Random}}),O9=lt(b9.prototype,"arcSpread",[l9,xc,u9,h9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B9=lt(b9.prototype,"arcSpeed",[_9,f9,p9,xc,d9,m9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),N9=lt(b9.prototype,"length",[xc,v9,g9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),L9=lt(b9.prototype,"boxThickness",[xc,y9,x9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(0,0,0)}}),F9=lt(b9.prototype,"_position",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(0,0,0)}}),z9=lt(b9.prototype,"_rotation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(0,0,0)}}),V9=lt(b9.prototype,"_scale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ei(1,1,1)}}),k9=lt(b9.prototype,"_arc",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return li(360)}}),U9=lt(b9.prototype,"_angle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return li(25)}}),S9=b9))||S9);function itt(t,e){e.x>0&&(t[0]+=.5*_i(-e.x,e.x),t[0]=ai(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*_i(-e.y,e.y),t[1]=ai(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*_i(-e.z,e.z),t[2]=ai(t[2],-.5,.5))}var ntt,rtt,ott,att,stt,ctt,ltt,utt,htt,_tt,ftt,ptt,dtt,mtt,vtt,gtt,ytt,xtt,Stt,btt,Ctt,Att,Ttt,wtt,Ett,Ptt,Itt,Rtt,Dtt,Mtt,Ott,Btt,Ntt,Ltt,Ftt,ztt,Vtt,ktt,Utt,Gtt,Htt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}$(e,t);var i=e.prototype;return i.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):t.prototype.getMacroPatches.call(this,e)},i.initSubModel=function(e,i,n){return t.prototype.initSubModel.call(this,e,i,this._launderMaterial(n))},i.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},i.setSubModelMaterial=function(e,i){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(i))},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,i)},i._launderMaterial=function(t){return t},i.setMorphRendering=function(t){this._morphRenderingInstance=t},e}(cb),jtt=oe({OFF:0,ON:1}),Wtt=oe({OFF:0,ON:1}),qtt=(ntt=pc("cc.ModelLightmapSettings"),rtt=Sc("_recieveShadow"),ntt((ftt=function(){function t(){ct(this,"texture",stt,this),ct(this,"uvParam",ctt,this),ct(this,"_bakeable",ltt,this),ct(this,"_castShadow",utt,this),ct(this,"_receiveShadow",htt,this),ct(this,"_lightmapSize",_tt,this)}return Q(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),stt=lt((att=ftt).prototype,"texture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ctt=lt(att.prototype,"uvParam",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ji}}),ltt=lt(att.prototype,"_bakeable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),utt=lt(att.prototype,"_castShadow",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),htt=lt(att.prototype,"_receiveShadow",[rtt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_tt=lt(att.prototype,"_lightmapSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),lt(att.prototype,"bakeable",[Dc],Object.getOwnPropertyDescriptor(att.prototype,"bakeable"),att.prototype),lt(att.prototype,"castShadow",[Dc],Object.getOwnPropertyDescriptor(att.prototype,"castShadow"),att.prototype),lt(att.prototype,"receiveShadow",[Dc],Object.getOwnPropertyDescriptor(att.prototype,"receiveShadow"),att.prototype),lt(att.prototype,"lightmapSize",[Dc],Object.getOwnPropertyDescriptor(att.prototype,"lightmapSize"),att.prototype),ott=att))||ott),Xtt=(ptt=pc("cc.MeshRenderer"),dtt=Rc(),mtt=mc(100),vtt=wc(),gtt=Kc(jtt),ytt=Nc(),xtt=Kc(Wtt),Stt=Nc(),btt=Kc(D1),Ctt=Nc(),Att=Mc(),ptt(Ttt=dtt(Ttt=mtt(Ttt=vtt(Ttt=Tc((Ott=Mtt=function(t){function e(){var e;return ct(e=t.call(this)||this,"lightmapSettings",Ett,ot(e)),ct(e,"_mesh",Ptt,ot(e)),ct(e,"_shadowCastingMode",Itt,ot(e)),ct(e,"_shadowReceivingMode",Rtt,ot(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,ct(e,"_enableMorph",Dtt,ot(e)),e._modelType=cb,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},i.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},i.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},i.onDisable=function(){this._model&&this._detachFromScene()},i.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},i.getWeight=function(t,e){this._subMeshShapesWeights.length;var i=this._subMeshShapesWeights[t];return i.length,i[e]},i.setWeights=function(t,e){var i=this._subMeshShapesWeights;e>=i.length||i[e].length===t.length&&(i[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},i.setWeight=function(t,e,i){var n=this._subMeshShapesWeights;if(!(e>=n.length)){var r=n[e];i>=r.length||(r[i]=t,this._uploadSubMeshShapesWeights(e))}},i.setInstancedAttribute=function(t,e){if(this.model)for(var i=this.model.instancedAttributes,n=i.attributes,r=i.views,o=0;o<n.length;o++)if(n[o].name===t){r[o].set(e);break}},i._updateLightmap=function(t,e,i,n,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},i._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},i._createModel=function(){var t=this._morphInstance&&this._modelType===cb?Htt:this._modelType,e=this._model=u.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof Htt&&e.setMorphRendering(this._morphInstance)},i._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},i._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=ny.POSITION,this._model.transform.hasChangedFlags|=ny.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var i=0;i<t;++i){var n=this.getRenderMaterial(i);n&&!n.isValid&&(n=null);var r=e[i];r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.enabled=!0}},i._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},i._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},i._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())},i._onMeshChanged=function(){},i._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},i._getBuiltinMaterial=function(){return Mv.get("missing-material")},i._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},i._updateCastShadow=function(){this._model&&(this._shadowCastingMode===jtt.OFF?this._model.castShadow=!1:(this._shadowCastingMode,jtt.ON,this._shadowCastingMode,this._model.castShadow=!0))},i._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===Wtt.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},i._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var i=0;i<e.passes.length;++i)if(e.passes[i].batchingScheme)return!0}return!1},i._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof Htt&&this._model.setMorphRendering(this._morphInstance)}},i._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var i=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):i?(i.length,t.targets.length,i.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},i._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var i=t.struct.morph;return i.subMeshMorphs.length===e.length&&e.every((function(t,e){var n,r,o=t.length;return(null!==(n=null===(r=i.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==n?n:0)===o}))},i._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},Q(e,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,i=this._mesh=t;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(fF),Mtt.ShadowCastingMode=jtt,Mtt.ShadowReceivingMode=Wtt,Ett=lt((wtt=Ott).prototype,"lightmapSettings",[xc,Dc,jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qtt}}),Ptt=lt(wtt.prototype,"_mesh",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Itt=lt(wtt.prototype,"_shadowCastingMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jtt.OFF}}),Rtt=lt(wtt.prototype,"_shadowReceivingMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wtt.ON}}),lt(wtt.prototype,"shadowCastingMode",[gtt,ytt,jc],Object.getOwnPropertyDescriptor(wtt.prototype,"shadowCastingMode"),wtt.prototype),lt(wtt.prototype,"receiveShadow",[xtt,Stt,jc],Object.getOwnPropertyDescriptor(wtt.prototype,"receiveShadow"),wtt.prototype),lt(wtt.prototype,"mesh",[btt,Ctt],Object.getOwnPropertyDescriptor(wtt.prototype,"mesh"),wtt.prototype),lt(wtt.prototype,"enableMorph",[Att,jc],Object.getOwnPropertyDescriptor(wtt.prototype,"enableMorph"),wtt.prototype),Dtt=lt(wtt.prototype,"_enableMorph",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ttt=wtt))||Ttt)||Ttt)||Ttt)||Ttt)||Ttt);k(D1.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),U(D1.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var Ytt,Ktt,Jtt,Qtt,Ztt,$tt,tet,eet,iet,net,ret,oet,aet,set,cet,uet,het,_et,fet,pet,det,met,vet=(Btt=pc("cc.Skeleton"),Ntt=Kc([Ne]),Ltt=Kc([Gi]),Btt((Gtt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_joints",Vtt,ot(e)),ct(e,"_bindposes",ktt,ot(e)),ct(e,"_hash",Utt,ot(e)),e._invBindposes=null,e}$(e,t);var i=e.prototype;return i.destroy=function(){var e,i;return null===(e=null===(i=u.director.root)||void 0===i?void 0:i.dataPoolManager)||void 0===e||e.releaseSkeleton(this),t.prototype.destroy.call(this)},i.validate=function(){return this.joints.length>0&&this.bindposes.length>0},Q(e,[{key:"joints",get:function(){return this._joints},set:function(t){this._joints=t}},{key:"bindposes",get:function(){return this._bindposes},set:function(t){this._bindposes=t}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var t=0;t<this._bindposes.length;t++){var e=new Gi;Gi.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var t="",e=0;e<this._bindposes.length;e++){var i=this._bindposes[e];t+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=go(t,666)}return this._hash}}]),e}(Mu),Vtt=lt((ztt=Gtt).prototype,"_joints",[Ntt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ktt=lt(ztt.prototype,"_bindposes",[Ltt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Utt=lt(ztt.prototype,"_hash",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ftt=ztt))||Ftt);u.Skeleton=vet,U(Xtt.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),u.ModelComponent=Xtt,ne.setClassAlias(Xtt,"cc.ModelComponent");var get,yet,xet,bet,Cet,Aet,Tet,wet,Eet,Pet,Iet,Ret,Det,Met,Oet,Bet,Net,Let,Fet,zet,Vet,ket,Uet,Get,Het,jet,Wet,qet,Xet,Yet,Ket,Jet,Qet,Zet,$et,tit,eit,iit,nit,rit,oit,ait,sit,cit,lit,uit,hit,_it,fit,pit,dit,mit,vit,git,yit,xit=oe({LUMINOUS_FLUX:0,LUMINANCE:1}),Sit=new Ei,bit=pc("cc.StaticLightSettings")((tet=function(){function t(){ct(this,"_baked",Jtt,this),ct(this,"_editorOnly",Qtt,this),ct(this,"_bakeable",Ztt,this),ct(this,"_castShadow",$tt,this)}return Q(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),Jtt=lt((Ktt=tet).prototype,"_baked",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qtt=lt(Ktt.prototype,"_editorOnly",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ztt=lt(Ktt.prototype,"_bakeable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$tt=lt(Ktt.prototype,"_castShadow",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(Ktt.prototype,"editorOnly",[Dc],Object.getOwnPropertyDescriptor(Ktt.prototype,"editorOnly"),Ktt.prototype),lt(Ktt.prototype,"bakeable",[Dc],Object.getOwnPropertyDescriptor(Ktt.prototype,"bakeable"),Ktt.prototype),lt(Ktt.prototype,"castShadow",[Dc],Object.getOwnPropertyDescriptor(Ktt.prototype,"castShadow"),Ktt.prototype),Ytt=Ktt))||Ytt,Cit=(eet=pc("cc.Light"),iet=Nc(),net=Nc(),ret=Lc(),oet=Nc(),aet=Kc(bit),set=Uc(),eet((met=det=function(t){function e(){var e;return ct(e=t.call(this)||this,"_color",het,ot(e)),ct(e,"_useColorTemperature",_et,ot(e)),ct(e,"_colorTemperature",fet,ot(e)),ct(e,"_staticSettings",pet,ot(e)),e._type=ry.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=xy,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=u.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},i._destroyLight=function(){this._light&&(u.director.root.destroyLight(this),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case ry.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case ry.SPHERE:t.addSphereLight(this._light);break;case ry.SPOT:t.addSpotLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case ry.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case ry.SPHERE:t.removeSphereLight(this._light);break;case ry.SPOT:t.removeSpotLight(this._light)}}},Q(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(Sit.x=t.r/255,Sit.y=t.g/255,Sit.z=t.b/255,this._light.color=Sit)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}($u),det.Type=ry,det.PhotometricTerm=xit,het=lt((uet=met).prototype,"_color",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),_et=lt(uet.prototype,"_useColorTemperature",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fet=lt(uet.prototype,"_colorTemperature",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),pet=lt(uet.prototype,"_staticSettings",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bit}}),lt(uet.prototype,"color",[iet],Object.getOwnPropertyDescriptor(uet.prototype,"color"),uet.prototype),lt(uet.prototype,"useColorTemperature",[net],Object.getOwnPropertyDescriptor(uet.prototype,"useColorTemperature"),uet.prototype),lt(uet.prototype,"colorTemperature",[kc,ret,oet],Object.getOwnPropertyDescriptor(uet.prototype,"colorTemperature"),uet.prototype),lt(uet.prototype,"staticSettings",[aet,set],Object.getOwnPropertyDescriptor(uet.prototype,"staticSettings"),uet.prototype),cet=uet))||cet),Ait=(get=pc("cc.DirectionalLight"),yet=Rc(),xet=wc(),bet=Sc("_illuminance"),Cet=Nc(),get(Aet=yet(Aet=xet(Aet=Tc((Pet=function(t){function e(){var e;return ct(e=t.call(this)||this,"_illuminanceHDR",wet,ot(e)),ct(e,"_illuminanceLDR",Eet,ot(e)),e._type=ry.DIRECTIONAL,e._light=null,e._lightType=pb,e}return $(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*vg.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},Q(e,[{key:"illuminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),e}(Cit),wet=lt((Tet=Pet).prototype,"_illuminanceHDR",[gc,bet],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),Eet=lt(Tet.prototype,"_illuminanceLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(Tet.prototype,"illuminance",[Cet],Object.getOwnPropertyDescriptor(Tet.prototype,"illuminance"),Tet.prototype),Aet=Tet))||Aet)||Aet)||Aet)||Aet),Tit=(Iet=pc("cc.SphereLight"),Ret=Rc(),Det=wc(),Met=Sc("_luminance"),Oet=Uc(),Bet=Nc(),Net=Uc(),Let=Nc(),Fet=Kc(xit),zet=Uc(),Vet=Nc(),ket=Nc(),Uet=Nc(),Iet(Get=Ret(Get=Det(Get=Tc((Ket=function(t){function e(){var e;return ct(e=t.call(this)||this,"_size",jet,ot(e)),ct(e,"_luminanceHDR",Wet,ot(e)),ct(e,"_luminanceLDR",qet,ot(e)),ct(e,"_term",Xet,ot(e)),ct(e,"_range",Yet,ot(e)),e._type=ry.SPHERE,e._light=null,e._lightType=xb,e}return $(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*vg.standardExposureValue*vg.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/vg.standardExposureValue/vg.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Q(e,[{key:"luminousFlux",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*yy(this._size):this._luminanceLDR},set:function(t){var e=0;u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/yy(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(Cit),jet=lt((Het=Ket).prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),Wet=lt(Het.prototype,"_luminanceHDR",[xc,Met],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/yy(.15)}}),qet=lt(Het.prototype,"_luminanceLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xet=lt(Het.prototype,"_term",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xit.LUMINOUS_FLUX}}),Yet=lt(Het.prototype,"_range",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(Het.prototype,"luminousFlux",[Oet,Bet],Object.getOwnPropertyDescriptor(Het.prototype,"luminousFlux"),Het.prototype),lt(Het.prototype,"luminance",[Net,Let],Object.getOwnPropertyDescriptor(Het.prototype,"luminance"),Het.prototype),lt(Het.prototype,"term",[Fet,zet,Vet],Object.getOwnPropertyDescriptor(Het.prototype,"term"),Het.prototype),lt(Het.prototype,"size",[ket],Object.getOwnPropertyDescriptor(Het.prototype,"size"),Het.prototype),lt(Het.prototype,"range",[Uet],Object.getOwnPropertyDescriptor(Het.prototype,"range"),Het.prototype),Get=Het))||Get)||Get)||Get)||Get),wit=(Jet=pc("cc.SpotLight"),Qet=Rc(),Zet=wc(),$et=Sc("_luminance"),tit=Nc(),eit=Uc(),iit=Nc(),nit=Uc(),rit=Kc(xit),oit=Uc(),ait=Nc(),sit=Nc(),cit=Nc(),lit=Lc(),uit=Nc(),Jet(hit=Qet(hit=Zet(hit=Tc((yit=function(t){function e(){var e;return ct(e=t.call(this)||this,"_size",fit,ot(e)),ct(e,"_luminanceHDR",pit,ot(e)),ct(e,"_luminanceLDR",dit,ot(e)),ct(e,"_term",mit,ot(e)),ct(e,"_range",vit,ot(e)),ct(e,"_spotAngle",git,ot(e)),e._type=ry.SPOT,e._light=null,e._lightType=Eb,e}return $(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*vg.standardExposureValue*vg.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/vg.standardExposureValue/vg.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Q(e,[{key:"luminousFlux",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*yy(this._size):this._luminanceLDR},set:function(t){var e=0;u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/yy(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=li(t))}}]),e}(Cit),fit=lt((_it=yit).prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),pit=lt(_it.prototype,"_luminanceHDR",[xc,$et],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/yy(.15)}}),dit=lt(_it.prototype,"_luminanceLDR",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mit=lt(_it.prototype,"_term",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xit.LUMINOUS_FLUX}}),vit=lt(_it.prototype,"_range",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),git=lt(_it.prototype,"_spotAngle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),lt(_it.prototype,"luminousFlux",[tit,eit],Object.getOwnPropertyDescriptor(_it.prototype,"luminousFlux"),_it.prototype),lt(_it.prototype,"luminance",[iit,nit],Object.getOwnPropertyDescriptor(_it.prototype,"luminance"),_it.prototype),lt(_it.prototype,"term",[rit,oit,ait],Object.getOwnPropertyDescriptor(_it.prototype,"term"),_it.prototype),lt(_it.prototype,"size",[sit],Object.getOwnPropertyDescriptor(_it.prototype,"size"),_it.prototype),lt(_it.prototype,"range",[cit],Object.getOwnPropertyDescriptor(_it.prototype,"range"),_it.prototype),lt(_it.prototype,"spotAngle",[kc,lit,uit],Object.getOwnPropertyDescriptor(_it.prototype,"spotAngle"),_it.prototype),hit=_it))||hit)||hit)||hit)||hit);u.LightComponent=Cit,ne.setClassAlias(Cit,"cc.LightComponent"),u.DirectionalLightComponent=Ait,ne.setClassAlias(Ait,"cc.DirectionalLightComponent"),u.SphereLightComponent=Tit,ne.setClassAlias(Tit,"cc.SphereLightComponent"),u.SpotLightComponent=wit,ne.setClassAlias(wit,"cc.SpotLightComponent"),k(wit.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),k(Tit.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),k(Cit.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var Eit=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function Pit(t,e){var i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new Bi,new Bi,new Ei,new Bi,new Ei;var Iit=new gr(An.POINT,An.POINT,An.NONE,Tn.CLAMP,Tn.CLAMP,Tn.CLAMP),Rit=new Ei,Dit=new Ei,Mit=new Ei,Oit=new Ei,Bit=new Gi,Nit=new Gi,Lit=new Ws,Fit=Number.MAX_SAFE_INTEGER,zit=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(hn.TEXTURE_FLOAT)?_n.RGBA32F:_n.RGBA8}(this._device);this._formatSize=Zr[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new RW(t),this._pool.initialize({format:e,roundUpFn:Pit}),this._customPool=new RW(t),this._customPool.initialize({format:e,roundUpFn:Pit})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var o=i.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,n);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,n)}}},e.getDefaultPoseTexture=function(t,e,i){var n=0^t.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var o=t.joints,a=t.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(n),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),c=!0}Ei.set(Mit,Fit,Fit,Fit),Ei.set(Oit,-Fit,-Fit,-Fit);for(var f=e.getBoneSpaceBounds(t),p=0,d=0;p<l;p++,d+=12){var m=i.getChildByPath(o[p]),v=m?VU(m,i,Bit):t.inverseBindposes[p],g=f[p];g&&(Ws.transform(Lit,g,v),Lit.getBoundary(Rit,Dit),Ei.min(Mit,Mit,Rit),Ei.max(Oit,Oit,Dit)),c&&(m&&Gi.multiply(v,v,a[p]),Eit(s,d,m?v:Gi.IDENTITY))}var y=[new Ws];return r.bounds.set(e.hash,y),Ws.fromPoints(y[0],Mit,Oit),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(n,r)),r},e.getSequencePoseTexture=function(t,e,i,n){var r=t.hash^e.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(i.hash))return o.refCount++,o;var a=t.joints,s=t.bindposes,c=oV.getOrExtract(e).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var _=12*h*c,f=this._chunkIdxMap.get(r),p=void 0!==f?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!p)return null;var d=this._createAnimInfos(t,e,n);o={pixelOffset:p.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:p,animInfos:d},l=new Float32Array(_),u=!0}var m=i.getBoneSpaceBounds(t),v=[];o.bounds.set(i.hash,v);for(var g=0;g<c;g++)v.push(new Ws(Fit,Fit,Fit,-Fit,-Fit,-Fit));for(var y=0,x=0;y<c;y++){for(var S=v[y],b=0;b<h;b++,x+=12){var C=o.animInfos[b],A=C.curveData,T=C.downstream,w=C.bindposeIdx,E=C.bindposeCorrection,P=void 0,I=!0;A&&T?P=Gi.multiply(Bit,A[y],T):A?P=A[y]:T?P=T:(P=t.inverseBindposes[w],I=!1);var R=m[b];if(R){var D=E?Gi.multiply(Nit,P,E):P;Ws.transform(Lit,R,D),Lit.getBoundary(Rit,Dit),Ei.min(S.center,S.center,Rit),Ei.max(S.halfExtents,S.halfExtents,Dit)}u&&(I&&Gi.multiply(Bit,P,s[w]),Eit(l,x,I?Bit:Gi.IDENTITY))}Ws.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e._createAnimInfos=function(t,e,i){for(var n=[],r=t.joints,o=t.bindposes,a=r.length,s=oV.getOrExtract(e),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=i.getChildByPath(l),_=void 0,f=void 0;!u;){var p=l.lastIndexOf("/");if(l=l.substring(0,p),u=s.joints[l],h?(_||(_=new Gi),Gi.fromRTS(Bit,h.rotation,h.position,h.scale),Gi.multiply(_,Bit,_),h=h.parent):f=l,p<0)break}var d=c,m=void 0;if(void 0!==f&&u){d=c-1;for(var v=0;v<a;v++)if(r[v]===f){d=v,m=new Gi,Gi.multiply(m,o[v],t.inverseBindposes[c]);break}}n.push({curveData:u&&u.transforms,downstream:_,bindposeIdx:d,bindposeCorrection:m})}return n},Q(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),Vit=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var i=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,yd.SIZE,yd.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e._setAnimInfoDirty=function(t,e){t.dirty=e},e.switchClip=function(t,e){return t.currentClip=e,t.data[0]=-1,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t},e.clear=function(){for(var t,e=st(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),kit=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new zit(t),this.jointAnimationInfo=new Vit(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();u.internal.DataPoolManager=kit;var Uit=[{name:"CC_USE_SKINNING",value:!0}];function Git(t,e,i,n){for(var r=0;r<i.length;r++){for(var o=i[r],a=-1,s=0;s<o.length;s++)if(o[s]===n){a=s;break}a>=0&&(e.push(r),t.push(a))}}var Hit,jit,Wit,qit,Xit,Yit,Kit,Jit,Qit,Zit,$it,tnt,ent,int,nnt,rnt,ont,ant,snt,cnt,lnt,unt,hnt,_nt,fnt,pnt,dnt,mnt,vnt,gnt,ynt,xnt,Snt,bnt,Cnt,Ant,Tnt,wnt,Ent,Pnt,Int,Rnt,Dnt,Mnt,Ont,Bnt=new Ei,Nnt=new Ei,Lnt=new Ei,Fnt=new Ei,znt=new Gi,Vnt=new Ws,knt=function(t){function e(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=tb.SKINNING,e}$(e,t);var i=e.prototype;return i._init=function(){},i.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)MU(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&i){this.transform=e;var r=i.getBoneSpaceBounds(t),o=i.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=i.jointBufferIndices;for(var a=0;a<t.joints.length;a++){var s=r[a],c=e.getChildByPath(t.joints[a]);if(s&&c){var l=DU(c,e),u=t.bindposes[a],h=[],_=[];o?Git(h,_,o,a):(h.push(a),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:c,bindpose:u,transform:l})}}}},i.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),Ei.set(Bnt,1/0,1/0,1/0),Ei.set(Nnt,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,o=RU(n.transform,t);Ws.transform(Vnt,r,o),Vnt.getBoundary(Lnt,Fnt),Ei.min(Bnt,Bnt,Lnt),Ei.max(Nnt,Nnt,Fnt)}var a=this._worldBounds;this._modelBounds&&a&&(Ws.fromPoints(this._modelBounds,Bnt,Nnt),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,o=n.buffers,a=n.transform,s=n.bindpose;Gi.multiply(znt,a.world,s);for(var c=0;c<o.length;c++)Eit(this._dataArray[o[c]],12*r[c],znt)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},i.initSubModel=function(e,i,n){var r=i.vertexBuffers,o=i.iaInfo;o.vertexBuffers=i.jointMappedBuffers,t.prototype.initSubModel.call(this,e,i,n),o.vertexBuffers=r},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?Uit.concat(i):Uit},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._buffers[this._bufferIndices[e]];n&&i.bindBuffer(Sd.BINDING,n)},i._updateInstancedAttributes=function(e,i){i.batchingScheme!==Pv.NONE&&D(3936,this.node.name),t.prototype._updateInstancedAttributes.call(this,e,i)},i._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,Sd.SIZE,Sd.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(Sd.COUNT))},e}(Htt),Unt=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],Gnt=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=tb.BAKED_SKINNING,e._dataPoolManager=u.director.root.dataPoolManager;var i=new Float32Array(4),n=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:n,texture:null,boundsInfo:null},e}$(e,t);var i=e.prototype;return i._init=function(){},i.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,t&&e&&i){this.transform=e;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new hr(dn.UNIFORM|dn.TRANSFER_DST,gn.DEVICE,gd.SIZE,gd.SIZE)))}},i.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;return n>=0?this.instancedAttributes.views[n][0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},i._applyNativeJointMedium=function(){},i._updateModelBounds=function(t){this._modelBounds=t},i.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(i&&i.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(i),this._applyNativeJointMedium()}},i._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var o=t.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Ad,o)}},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?i.concat(Unt):Unt},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._jointsMedium,r=n.buffer,o=n.texture,a=n.animInfo;if(i.bindBuffer(gd.BINDING,r),i.bindBuffer(yd.BINDING,a.buffer),o){var s=this._device.getSampler(Iit);i.bindTexture(Ad,o.handle.texture),i.bindSampler(Ad,s)}},i._setInstAnimInfoIdx=function(t){this._instAnimInfoIdx=t},i._updateInstancedAttributes=function(e,i){t.prototype._updateInstancedAttributes.call(this,e,i),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(xd)),this.updateInstancedJointTextureInfo()},i.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,i=t.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.views[n];r[0]=i.data[0],r[1]=e[1],r[2]=e[2]}},e}(Htt),Hnt=(Hit=pc("cc.SkinnedMeshRenderer"),jit=Rc(),Wit=mc(100),qit=wc(),Xit=Kc(vet),Yit=Kc(jT),Kit=Kc(vet),Jit=Kc(jT),Qit=Nc(),Hit(Zit=jit(Zit=Wit(Zit=Tc(Zit=qit((int=function(t){function e(){var e;return ct(e=t.call(this)||this,"_skeleton",tnt,ot(e)),ct(e,"_skinningRoot",ent,ot(e)),e._clip=null,e.associatedAnimation=null,e._modelType=Gnt,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._tryBindAnimation()},i.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),t.prototype.onDestroy.call(this)},i.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},i.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var i=t?Gnt:knt;(e||this._modelType!==i)&&(this._modelType=i,this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},i.setMaterial=function(e,i){t.prototype.setMaterial.call(this,e,i),this._modelType===knt&&this.getMaterialInstance(i)},i._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},i._tryBindAnimation=function(){var t=this._skinningRoot;if(t){for(var e=!1,i=this.node;i;i=i.parent)if(i===t){e=!0;break}if(e){var n=t.getComponent("cc.SkeletalAnimation");n?n.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},i._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},Q(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){this._skinningRoot=t,this._tryBindAnimation(),t!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),e}(Xtt),tnt=lt(($it=int).prototype,"_skeleton",[Xit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ent=lt($it.prototype,"_skinningRoot",[Yit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt($it.prototype,"skeleton",[Kit],Object.getOwnPropertyDescriptor($it.prototype,"skeleton"),$it.prototype),lt($it.prototype,"skinningRoot",[Jit,Qit],Object.getOwnPropertyDescriptor($it.prototype,"skinningRoot"),$it.prototype),Zit=$it))||Zit)||Zit)||Zit)||Zit)||Zit),jnt=new Pr(Kn.ATTR_BATCH_ID,_n.R32F),Wnt=new Pr(Kn.ATTR_BATCH_UV,_n.RG32F),qnt=Zr[jnt.format].size+Zr[Wnt.format].size,Xnt=(nnt=pc("cc.SkinnedMeshUnit"),rnt=Kc(D1),ont=Kc(vet),ant=Kc(cg),snt=Kc(Hnt),nnt((mnt=function(){function t(){ct(this,"mesh",unt,this),ct(this,"skeleton",hnt,this),ct(this,"material",_nt,this),ct(this,"_localTransform",fnt,this),ct(this,"_offset",pnt,this),ct(this,"_size",dnt,this)}return Q(t,[{key:"offset",get:function(){return this._offset},set:function(t){qi.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){qi.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&VU(t.node,t.skinningRoot,this._localTransform))}}]),t}(),unt=lt((lnt=mnt).prototype,"mesh",[rnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hnt=lt(lnt.prototype,"skeleton",[ont],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_nt=lt(lnt.prototype,"material",[ant],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fnt=lt(lnt.prototype,"_localTransform",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),pnt=lt(lnt.prototype,"_offset",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(0,0)}}),dnt=lt(lnt.prototype,"_size",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi(1,1)}}),lt(lnt.prototype,"offset",[Dc],Object.getOwnPropertyDescriptor(lnt.prototype,"offset"),lnt.prototype),lt(lnt.prototype,"size",[Dc],Object.getOwnPropertyDescriptor(lnt.prototype,"size"),lnt.prototype),lt(lnt.prototype,"copyFrom",[snt],Object.getOwnPropertyDescriptor(lnt.prototype,"copyFrom"),lnt.prototype),cnt=lnt))||cnt),Ynt=new Gi,Knt=(new Gi,new Ei),Jnt=(vnt=pc("cc.SkinnedMeshBatchRenderer"),gnt=Rc(),ynt=mc(100),xnt=wc(),Snt=Nc(),bnt=Kc([Ne]),Cnt=Nc(),Ant=Kc([Xnt]),Tnt=Nc(),wnt=Mc(),Ent=Mc(),vnt(Pnt=gnt(Pnt=ynt(Pnt=Tc(Pnt=xnt((Ont=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"atlasSize",Rnt,ot(e)),ct(e,"batchableTextureNames",Dnt,ot(e)),ct(e,"units",Mnt,ot(e)),e._textures={},e._batchMaterial=null,e}$(e,t);var i=e.prototype;return i.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},i.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},i._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},i.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},i.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var i=e.effectAsset.techniques[e.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var o=function(i){if(r.properties[i].type>=pn.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===i}))?((o=t._textures[i])||(o=t.createTexture(i)),t.cookTextures(o,i,n)):t.units.some((function(t){return o=t.material&&t.material.getProperty(i,n)})),o&&e.setProperty(i,o,n)}else{for(var a=[],s=0;s<t.units.length;s++){var c=t.units[s];c.material&&a.push(c.material.getProperty(i.slice(0,-3),n))}e.setProperty(i,a,n)}};for(var a in r.properties)o(a)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")},i.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],i=0;i<this.units.length;i++){var n=this.units[i];if(n&&n.skeleton){var r=n.skeleton;Gi.invert(Ynt,n._localTransform);for(var o=function(i){var n=r.joints[i];if(t.findIndex((function(t){return t===n}))>=0)return"continue";t.push(n),e.push(Gi.multiply(new Gi,r.bindposes[i]||Gi.IDENTITY,Ynt))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(t.length).keys()).sort((function(e,i){return t[e]>t[i]?1:t[e]<t[i]?-1:0})),c=new vet;c.joints=t.map((function(t,e,i){return i[s[e]]})),c.bindposes=e.map((function(t,e,i){return i[s[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},i.cookMeshes=function(){for(var t=this,e=!1,i=0;i<this.units.length;i++)if(this.units[i].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new D1;for(var n=0,r=_n.UNKNOWN,o=0,a=_n.UNKNOWN,s=0,c=_n.UNKNOWN,l=0,u=_n.UNKNOWN,h=0,_=_n.UNKNOWN,f=new Array(this.units.length),p=this.units.length,d=0;d<p;d++){var m=this.units[d];m&&m.skeleton&&(f[d]=m.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var v=function(e){var i=t.units[e];if(!i||!i.mesh||!i.mesh.data)return"continue";var p=t._createUnitMesh(e,i.mesh),d=new DataView(p.data.buffer);Gi.inverseTranspose(Ynt,i._localTransform);for(var m=i.offset,v=i.size,g=function(t){var g=p.struct.vertexBundles[t];n=g.view.offset,r=_n.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===Kn.ATTR_POSITION){r=x.format;break}n+=Zr[x.format].size}if(r){for(var S=Fw(d,r,n,g.view.length,g.view.stride),b=0;b<S.length;b+=3)Ei.fromArray(Knt,S,b),Ei.transformMat4(Knt,Knt,i._localTransform),Ei.toArray(S,Knt,b);Lw(d,S,r,n,g.view.stride)}o=g.view.offset,a=_n.UNKNOWN;for(var C=0;C<g.attributes.length;C++){var A=g.attributes[C];if(A.name===Kn.ATTR_NORMAL){a=A.format;break}o+=Zr[A.format].size}if(a){for(var T=Fw(d,a,o,g.view.length,g.view.stride),w=0;w<T.length;w+=3)Ei.fromArray(Knt,T,w),Ei.transformMat4Normal(Knt,Knt,Ynt),Ei.toArray(T,Knt,w);Lw(d,T,a,o,g.view.stride)}s=g.view.offset,c=_n.UNKNOWN;for(var E=0;E<g.attributes.length;E++){var P=g.attributes[E];if(P.name===Kn.ATTR_TANGENT){c=P.format;break}s+=Zr[P.format].size}if(c){for(var I=Fw(d,c,s,g.view.length,g.view.stride),R=0;R<I.length;R+=3)Ei.fromArray(Knt,I,R),Ei.transformMat4Normal(Knt,Knt,Ynt),Ei.toArray(I,Knt,R);Lw(d,I,c,s,g.view.stride)}l=g.view.offset,u=_n.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var M=g.attributes[D];if(M.name===Kn.ATTR_BATCH_UV){u=M.format;break}l+=Zr[M.format].size}u&&zw(d,(function(t,e){var i,n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*v[n]+m[n]}),u,l,g.view.length,g.view.stride,d);var O=f[e];if(!O)return"continue";h=g.view.offset,_=_n.UNKNOWN;for(var B=0;B<g.attributes.length;B++){var N=g.attributes[B];if(N.name===Kn.ATTR_JOINTS){_=N.format;break}h+=Zr[N.format].size}_&&zw(d,(function(t){return O[t]}),_,h,g.view.length,g.view.stride,d)},y=0;y<p.struct.vertexBundles.length;y++)g(y);t._mesh.merge(p)},g=0;g<p;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},i.cookTextures=function(t,e,i){for(var n=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var l=c.material.getProperty(e,i);if(l&&l.image&&l.image.data){var h=new or;h.texOffset.x=c.offset.x*this.atlasSize,h.texOffset.y=c.offset.y*this.atlasSize,h.texExtent.width=c.size.x*this.atlasSize,h.texExtent.height=c.size.y*this.atlasSize;var _=l.image.data;ArrayBuffer.isView(_)?(o.push(_),a.push(h)):(n.push(_),r.push(h))}}}var f=t.getGFXTexture(),p=u.director.root.device;o.length>0&&p.copyBuffersToTexture(o,f,a),n.length>0&&p.copyTexImagesToTexture(n,f,r)},i.createTexture=function(t){var e=new Cv;return e.setFilters(Om.LINEAR,Om.LINEAR),e.setMipFilter(Om.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:Dm.RGBA8888}),this._textures[t]=e,e},i.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:Dm.RGBA8888})},i._createUnitMesh=function(t,e){for(var i=JSON.parse(JSON.stringify(e.struct)),n={},r=0;r<e.struct.primitives.length;r++){for(var o=e.struct.primitives[r],a=0,s=_n.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){var l=e.struct.vertexBundles[o.vertexBundelIndices[c]];a=l.view.offset,s=_n.UNKNOWN;for(var h=0;h<l.attributes.length;h++){var _=l.attributes[h];if(_.name===Kn.ATTR_TEX_COORD){s=_.format;break}a+=Zr[_.format].size}if(s)break}if(void 0===n[c]){n[c]=[s,a];var f=i.vertexBundles[c];f.attributes.push(jnt),f.attributes.push(Wnt),f.view.offset=0,f.view.length+=f.view.count*qnt,f.view.stride+=qnt}}for(var p=0,d=0;d<i.vertexBundles.length;d++)p+=i.vertexBundles[d].view.length;for(var m=0;m<i.primitives.length;m++){var v=i.primitives[m];v.indexView&&(v.indexView.offset=p,p+=v.indexView.length)}var g=new Uint8Array(p),y=e.data,x=new DataView(g.buffer),S=new DataView(y.buffer),b=u.sys.isLittleEndian;for(var C in n)for(var A=i.vertexBundles[C],T=e.struct.vertexBundles[C],w=n[C],E=Fw(S,w[0],w[1],T.view.length,T.view.stride),P=T.view,I=A.view,R=P.stride,D=I.stride,M=P.offset,O=I.offset,B=0;B<I.count;B++){var N=y.subarray(M,M+R);g.set(N,O),x.setFloat32(O+R,t),x.setFloat32(O+R+4,E[2*B],b),x.setFloat32(O+R+8,E[2*B+1],b),O+=D,M+=R}for(var L=0;L<i.primitives.length;L++){var F=e.struct.primitives[L],z=i.primitives[L];if(F.indexView&&z.indexView)for(var V=F.indexView.stride,k=z.indexView.stride,U=F.indexView.offset,G=z.indexView.offset,H=0;H<z.indexView.count;H++){var j=y.subarray(U,U+V);g.set(j,G),G+=k,U+=V}}var W=new D1;return W.reset({struct:i,data:g}),W},Q(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(Hnt),Rnt=lt((Int=Ont).prototype,"atlasSize",[xc,Snt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),Dnt=lt(Int.prototype,"batchableTextureNames",[bnt,xc,Cnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mnt=lt(Int.prototype,"units",[Ant,xc,Tnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(Int.prototype,"mesh",[ol,wnt],Object.getOwnPropertyDescriptor(Int.prototype,"mesh"),Int.prototype),lt(Int.prototype,"skeleton",[ol,Ent],Object.getOwnPropertyDescriptor(Int.prototype,"skeleton"),Int.prototype),Pnt=Int))||Pnt)||Pnt)||Pnt)||Pnt)||Pnt);u.SkinningModelComponent=Hnt,ne.setClassAlias(Hnt,"cc.SkinningModelComponent"),u.SkinningModelUnit=Xnt,ne.setClassAlias(Xnt,"cc.SkinningModelUnit"),u.BatchedSkinningModelComponent=Jnt,ne.setClassAlias(Jnt,"cc.BatchedSkinningModelComponent");var Qnt,Znt,$nt,trt,ert,irt,nrt,rrt,ort,art,srt,crt,lrt,urt,hrt,_rt,frt,prt,drt,mrt,vrt=new Gi,grt=new Gi,yrt=function(t){function e(e,i){var n;return void 0===i&&(i=""),(n=t.call(this,e,i)||this)._frames=1,n._bakedDuration=0,n._animInfo=null,n._sockets=[],n._animInfoMgr=void 0,n._parent=null,n._curvesInited=!1,n._animInfoMgr=u.director.root.dataPoolManager.jointAnimationInfo,n}$(e,t);var i=e.prototype;return i.initialize=function(e){if(!this._curveLoaded){this._parent=e.getComponent("cc.SkeletalAnimation");var i=this._parent.useBakedAnimation;this._doNotCreateEval=i,t.prototype.initialize.call(this,e),this._curvesInited=!i;var n=oV.getOrExtract(this.clip),r=n.frames,o=n.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(i)}},i.setUseBaked=function(e){e?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},i.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,i=0;i<t.length;++i){var n=t[i],r=e.getChildByPath(n.path);if(n.target){for(var o=oV.getOrExtract(this.clip),a=n.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Gi.identity(grt)),Gi.fromRTS(vrt,c.rotation,c.position,c.scale),Gi.multiply(l,vrt,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,_=o.frames,f=[],p=0;p<_;p++){var d;d=h&&l?Gi.multiply(vrt,h[p],l):h?h[p]:l||new Gi;var m={pos:new Ei,rot:new Bi,scale:new Ei};Gi.toRTS(d,m.rot,m.pos,m.scale),f.push(m)}this._sockets.push({target:n.target,frames:f})}}},i._setAnimInfoDirty=function(t,e){t.dirty=e},i._sampleCurvesBaked=function(t){var e=t/this.duration,i=this._animInfo,n=this.clip;i.currentClip!==n&&(this._animInfoMgr.switchClip(this._animInfo,n),this._parent.getUsers().forEach((function(t){t.uploadAnimation(n)})));var r=e*this._frames+.5|0;if(r!==i.data[0]){i.data[0]=r,this._setAnimInfoDirty(i,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},e}(Zk),xrt=(Qnt=pc("cc.SkeletalAnimation.Socket"),Znt=Kc(jT),Qnt((ert=lt((trt=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),ct(this,"path",ert,this),ct(this,"target",irt,this),this.path=t,this.target=e}).prototype,"path",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),irt=lt(trt.prototype,"target",[Znt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$nt=trt))||$nt);ne.setClassAlias(xrt,"cc.SkeletalAnimationComponent.Socket");var Srt=new Gi,brt=new Gi;function Crt(t,e,i){void 0===e&&(e=""),void 0===i&&(i=[]);for(var n=0;n<t.children.length;n++){var r=t.children[n];if(r){var o=e?e+"/"+r.name:r.name;i.push(o),Crt(r,o,i)}}return i}var Art=(nrt=pc("cc.SkeletalAnimation"),rrt=Rc(),ort=mc(99),art=wc(),srt=Kc([xrt]),crt=Nc(),lrt=Nc(),urt=Kc([xrt]),nrt(hrt=rrt(hrt=ort(hrt=Tc(hrt=art((mrt=drt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_useBakedAnimation",frt,ot(e)),ct(e,"_sockets",prt,ot(e)),e._users=new Set,e._currentBakedState=null,e}$(e,t);var i=e.prototype;return i.onLoad=function(){t.prototype.onLoad.call(this);for(var e=this.node.getComponentsInChildren(Hnt),i=0;i<e.length;++i){var n=e[i];n.skinningRoot===this.node&&this.notifySkinnedMeshAdded(n)}},i.onDestroy=function(){t.prototype.onDestroy.call(this),u.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),u.director.getAnimationManager().removeSockets(this.node,this._sockets),this._removeAllUsers()},i.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},i.pause=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.pause():t.prototype.pause.call(this)},i.resume=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.resume():t.prototype.resume.call(this)},i.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):t.prototype.stop.call(this)},i.querySockets=function(){var t=this._defaultClip&&Object.keys(oV.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],i=0;i<t.length;i++){var n=t[i],r=this.node.getChildByPath(n);r&&(e.push(n),Crt(r,n,e))}return e},i.rebuildSocketAnimations=function(){for(var t,e=st(this._sockets);!(t=e()).done;){var i=t.value,n=this.node.getChildByPath(i.path),r=i.target;n&&r&&(r.name=i.path.substring(i.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,VU(n,this.node,Srt),Gi.fromRTS(brt,r.rotation,r.position,r.scale),Gi.equals(brt,Srt)||(r.matrix=Srt))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},i.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new jT;return i.parent=this.node,this._sockets.push(new xrt(t,i)),this.rebuildSocketAnimations(),i},i.notifySkinnedMeshAdded=function(t){var e=this._useBakedAnimation,i=t.associatedAnimation;if(i&&i._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){var n=this._currentBakedState;n&&t.uploadAnimation(n.clip)}this._users.add(t)},i.notifySkinnedMeshRemoved=function(t){t.associatedAnimation,t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)},i.getUsers=function(){return this._users},i._createState=function(t,e){return new yrt(t,e)},i._doCreateState=function(e,i){var n=t.prototype._doCreateState.call(this,e,i);return n.rebuildSocketCurves(this._sockets),n},i.doPlayOrCrossFade=function(e,i){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var n=e;this._currentBakedState=n,n.play()}else t.prototype.doPlayOrCrossFade.call(this,e,i)},i._removeAllUsers=function(){var t=this;Array.from(this._users).forEach((function(e){t.notifySkinnedMeshRemoved(e)}))},Q(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=u.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){for(var e in this._useBakedAnimation=t,this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((function(e){e.setUseBakedAnimation(t)})),this._useBakedAnimation?u.director.getAnimationManager().removeSockets(this.node,this._sockets):(u.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),e}(vU),drt.Socket=xrt,lt((_rt=mrt).prototype,"sockets",[srt,crt],Object.getOwnPropertyDescriptor(_rt.prototype,"sockets"),_rt.prototype),lt(_rt.prototype,"useBakedAnimation",[lrt],Object.getOwnPropertyDescriptor(_rt.prototype,"useBakedAnimation"),_rt.prototype),frt=lt(_rt.prototype,"_useBakedAnimation",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),prt=lt(_rt.prototype,"_sockets",[urt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hrt=_rt))||hrt)||hrt)||hrt)||hrt)||hrt);u.SkeletalAnimationComponent=Art,ne.setClassAlias(Art,"cc.SkeletalAnimationComponent"),u.utils=B2;var Trt,wrt,Ert,Prt,Irt,Rrt,Drt,Mrt,Ort,Brt,Nrt,Lrt,Frt,zrt,Vrt,krt,Urt,Grt,Hrt,jrt,Wrt,qrt,Xrt,Yrt,Krt,Jrt,Qrt,Zrt,$rt,tot,eot,iot,not,rot,oot=[0,0,1,0,0,1,1,1],aot=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e.type=tb.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=new dr([new fr]),e._iaInfoBuffer=e._device.createBuffer(new hr(dn.INDIRECT,gn.HOST|gn.DEVICE,io,io)),e._subMeshData=null,e._mesh=null,e}$(e,t);var i=e.prototype;return i.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._subMeshData&&e&&this.rebuild()},i.setVertexAttributes=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertSize=0;for(var i,n=st(this._vertAttrs);!(i=n()).done;){var r=i.value;r.offset=this._vertSize,this._vertSize+=Zr[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},i.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var i=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===Kn.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,Kn.ATTR_TEX_COORD,e,this._vertSize,i);var n=this._vertAttrs.findIndex((function(t){return t.name===Kn.ATTR_TEX_COORD3}));if(i=this._vertAttrs[n++].offset,this._mesh.copyAttribute(0,Kn.ATTR_POSITION,e,this._vertSize,i),i=this._vertAttrs[n++].offset,this._mesh.copyAttribute(0,Kn.ATTR_NORMAL,e,this._vertSize,i),i=this._vertAttrs[n++].offset,!this._mesh.copyAttribute(0,Kn.ATTR_COLOR,e,this._vertSize,i))for(var r=new Uint32Array(e),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+i/4]=Ti.WHITE._val;for(var a=new Float32Array(e),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}t.update(e);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var f=4*_;c[h++]=f,c[h++]=f+1,c[h++]=f+2,c[h++]=f+3,c[h++]=f+2,c[h++]=f+1}var p=this._device.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return p.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new hr(dn.INDIRECT,gn.HOST|gn.DEVICE,io,io))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Uw([t],this._vertAttrs,Fn.TRIANGLE_LIST,p,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},i.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},i.addParticleVertexData=function(t,e){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,n+=2,this._vdataF32[n++]=e[1].z,this._vdataF32[n++]=e[2].x,this._vdataF32[n++]=e[2].y,this._vdataF32[n++]=e[2].z,this._vdataF32[n++]=e[3].x,this._vdataF32[n++]=e[3].y,this._vdataF32[n++]=e[3].z,this._vdataUint32[n++]=e[4]}else{var r=t*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=e[1].x,this._vdataF32[r++]=e[1].y,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4],e[5]&&(this._vdataF32[r++]=e[5].x,this._vdataF32[r++]=e[5].y,this._vdataF32[r++]=e[5].z)}},i.addGPUParticleVertexData=function(t,e,i){for(var n=e*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=n;this._vdataF32[o++]=t.position.x,this._vdataF32[o++]=t.position.y,this._vdataF32[o++]=t.position.z,this._vdataF32[o++]=i,this._vdataF32[o++]=t.startSize.x,this._vdataF32[o++]=t.startSize.y,this._vdataF32[o++]=t.startSize.z,this._vdataF32[o++]=oot[2*r],this._vdataF32[o++]=t.rotation.x,this._vdataF32[o++]=t.rotation.y,this._vdataF32[o++]=t.rotation.z,this._vdataF32[o++]=oot[2*r+1],this._vdataF32[o++]=t.startColor.r/255,this._vdataF32[o++]=t.startColor.g/255,this._vdataF32[o++]=t.startColor.b/255,this._vdataF32[o++]=t.startColor.a/255,this._vdataF32[o++]=t.velocity.x,this._vdataF32[o++]=t.velocity.y,this._vdataF32[o++]=t.velocity.z,this._vdataF32[o++]=t.startLifetime,this._vdataF32[o++]=t.randomSeed,n+=this._vertAttrsFloatCount}},i.updateGPUParticles=function(t,e,i){for(var n=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<t;++s)r=s*n,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-o)<i&&(a=--t*n,this._vdataF32.copyWithin(r,a,a+n),s--);return t},i.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},i.updateIA=function(t){t<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo))},i.clear=function(){this._subModels[0].inputAssembler.indexCount=0},i.destroy=function(){t.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},i.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},e}(cb),sot=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=t}var e=t.prototype;return e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===X3.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){this._model||(this._model=u.director.root.createModel(aot),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},t}(),cot=new Ei,lot=new Gi,uot=new Bi,hot=(new Ei,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),_ot=[0,0,1,0,0,1,1,1],fot=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD1,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD2,_n.RGB32F),new Pr(Kn.ATTR_COLOR,_n.RGBA8,!0)],pot=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD1,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD2,_n.RGB32F),new Pr(Kn.ATTR_COLOR,_n.RGBA8,!0),new Pr(Kn.ATTR_COLOR1,_n.RGB32F)],dot=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD1,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD2,_n.RGB32F),new Pr(Kn.ATTR_COLOR,_n.RGBA8,!0),new Pr(Kn.ATTR_TEX_COORD3,_n.RGB32F),new Pr(Kn.ATTR_NORMAL,_n.RGB32F),new Pr(Kn.ATTR_COLOR1,_n.RGBA8,!0)],mot={parent:null,owner:null,subModelIdx:0},vot=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._tmp_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._attrs=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._uNodeRotHandle=0,i._alignSpace=q3.View,i._inited=!1,i._localMat=new Gi,i._gravity=new Ji,i._model=null,i._frameTile_velLenScale=new Ji(1,1,0,0),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new Ji,i._attrs=new Array(5),i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}$(e,t);var i=e.prototype;return i.onInit=function(e){var i=this;t.prototype.onInit.call(this,e),this._particles=new Wl((function(){return new i3(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},i.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},i.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},i.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},i.getDefaultTrailMaterial=function(){return this._defaultTrailMat},i.setNewParticle=function(){},i._initModuleList=function(){var t=this;hot.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=U3.length;e<i;e++){var n=this._animateList[U3[e]];n&&this._runAnimateList.push(n)}},i.enableModule=function(t,e,i){e?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var n=0,r=U3.length;n<r;n++){var o=this._animateList[U3[n]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},i.updateAlignSpace=function(t){this._alignSpace=t},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===X3.Mesh||this._alignSpace!==q3.View){if(this._alignSpace===q3.Local)this._particleSystem.node.getRotation(uot);else if(this._alignSpace===q3.World)this._particleSystem.node.getWorldRotation(uot);else if(this._alignSpace===q3.View){var e;uot.set(0,0,0,1);var i=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==i)for(var n=0;n<(null==i?void 0:i.length);++n){var r=i[n];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Bi.fromViewUp(uot,r.forward);break}}}else uot.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,uot)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case j3.Local:this._particleSystem.node.getScale(this._node_scale);break;case j3.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(this._uScaleHandle,this._node_scale)},i.updateParticles=function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;i.node.getWorldMatrix(lot);var n=(i.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(n),this.doUpdateRotation(n),this._updateList.forEach((function(t){t.update(i._simulationSpace,lot)}));var r=i._trailModule,o=r&&r.enable;if(o&&r.update(),i.simulationSpace===j3.Local){var a=i.node.getRotation();Gi.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(n){var a=e._particles.data[n];if(a.remainingLifetime-=t,Ei.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),e._particles.removeAt(n),--n,c=n,"continue";if(i.simulationSpace===j3.Local){var s=9.8*-i.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,pi(a.randomSeed))*t;e._gravity.x=0,e._gravity.y=s,e._gravity.z=0,e._gravity.w=1,e._gravity=e._gravity.transformMat4(e._localMat),a.velocity.x+=e._gravity.x,a.velocity.y+=e._gravity.y,a.velocity.z+=e._gravity.z}else a.velocity.y-=9.8*i.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,pi(a.randomSeed))*t;Ei.copy(a.ultimateVelocity,a.velocity),e._runAnimateList.forEach((function(e){e.animate(a,t)})),Ei.scaleAndAdd(a.position,a.position,a.ultimateVelocity,t),o&&r.animate(a,t),c=n},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},i.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],n=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(n=i.frameIndex),t=4*e,this._fillDataFunc(i,t,n)}},i.beforeRender=function(){this._model.updateIA(this._particles.length)},i.getParticleCount=function(){return this._particles.length},i.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===t&&i._trailModel.setSubModelMaterial(0,e)},i._setFillFunc=function(){this._renderInfo.renderMode===X3.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===X3.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},i._fillMeshData=function(t,e,i){var n=e/4;this._attrs[0]=t.position,cot.z=i,this._attrs[1]=cot,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._model.addParticleVertexData(n,this._attrs)},i._fillStrecthedData=function(t,e,i){for(var n=0;n<4;++n)this._attrs[0]=t.position,cot.x=_ot[2*n],cot.y=_ot[2*n+1],cot.z=i,this._attrs[1]=cot,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(e++,this._attrs)},i._fillNormalData=function(t,e,i){for(var n=0;n<4;++n)this._attrs[0]=t.position,cot.x=_ot[2*n],cot.y=_ot[2*n+1],cot.z=i,this._attrs[1]=cot,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(e++,this._attrs)},i._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case X3.StrecthedBillboard:this._vertAttrs=pot.slice();break;case X3.Mesh:this._vertAttrs=dot.slice();break;default:this._vertAttrs=fot.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!=e){var i=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1!==i.indexOf("particle")&&-1===i.indexOf("particle-gpu")||t.setMaterial(null,0)}null==t.sharedMaterial&&null==this._defaultMat&&(mot.parent=Mv.get("default-particle-material"),mot.owner=this._particleSystem,mot.subModelIdx=0,this._defaultMat=new mb(mot),mot.parent=null,mot.owner=null,mot.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var n=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===j3.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=n.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===X3.Billboard?this._defines.CC_RENDER_MODE=0:o===X3.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===X3.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===X3.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===X3.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=t._textureAnimationModule;s&&s.enable?(Ji.copy(this._tmp_velLenScale,a),qi.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,n.recompileShaders(this._defines),this._model&&this._model.updateMaterial(n)}},i.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===j3.World||e.space===j3.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(mot.parent=Mv.get("default-trail-material"),mot.owner=this._particleSystem,mot.subModelIdx=1,this._defaultTrailMat=new mb(mot),mot.parent=null,mot.owner=null,mot.subModelIdx=0),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},e}(sot),got=new Gi,yot=new Ji,xot=new Bi,Sot=new Bi,bot=(new Ei,32),Cot="a_position_starttime",Aot="a_size_uv",Tot="a_rotation_uv",wot="a_color",Eot="a_dir_life",Pot="a_rndSeed",Iot=[new Pr(Cot,_n.RGBA32F),new Pr(Aot,_n.RGBA32F),new Pr(Tot,_n.RGBA32F),new Pr(wot,_n.RGBA32F),new Pr(Eot,_n.RGBA32F),new Pr(Pot,_n.R32F)],Rot=[new Pr(Cot,_n.RGBA32F),new Pr(Aot,_n.RGBA32F),new Pr(Tot,_n.RGBA32F),new Pr(wot,_n.RGBA32F),new Pr(Eot,_n.RGBA32F),new Pr(Pot,_n.R32F),new Pr(Kn.ATTR_TEX_COORD,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD3,_n.RGB32F),new Pr(Kn.ATTR_NORMAL,_n.RGB32F),new Pr(Kn.ATTR_COLOR1,_n.RGBA8,!0)],Dot={parent:null,owner:null,subModelIdx:0},Mot=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._frameTile_velLenScale=void 0,i._unifrom_velLenScale=void 0,i._tmp_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._uTimeHandle=0,i._uRotHandle=0,i._uNodeRotHandle=0,i._alignSpace=q3.View,i._inited=!1,i._frameTile_velLenScale=new Ji(1,1,0,0),i._unifrom_velLenScale=i._frameTile_velLenScale.clone(),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new Ji,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new i3(null),i._particleNum=0,i}$(e,t);var i=e.prototype;return i.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},i.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},i.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},i.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},i.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},i.enableModule=function(){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,t))},i.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},i.setNewParticle=function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===X3.Mesh||this._alignSpace!==q3.View){if(this._alignSpace===q3.Local)this._particleSystem.node.getRotation(Sot);else if(this._alignSpace===q3.World)this._particleSystem.node.getWorldRotation(Sot);else if(this._alignSpace===q3.View){var e;Sot.set(0,0,0,1);var i=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==i)for(var n=0;n<(null==i?void 0:i.length);++n){var r=i[n];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Bi.fromViewUp(Sot,r.forward);break}}}else Sot.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,Sot)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case j3.Local:this._particleSystem.node.getScale(this._node_scale);break;case j3.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(t.getHandle("scale"),this._node_scale)},i.updateParticles=function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum},i.updateRenderData=function(){},i.beforeRender=function(){this._model.updateIA(this._particleNum)},i.updateAlignSpace=function(t){this._alignSpace=t},i.updateShaderUniform=function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var i=e.passes[0];yot.x=this._particleSystem._time,yot.y=t,i.setUniform(this._uTimeHandle,yot),this._particleSystem.node.getWorldRotation(xot),i.setUniform(this._uRotHandle,xot),this.doUpdateRotation(i)}},i.initShaderUniform=function(t){var e=t.passes[0];this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),this._uNodeRotHandle=e.getHandle("nodeRotation"),this.doUpdateScale(e),e.setUniform(e.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),yot.x=bot,yot.y=.03125,e.setUniform(e.getHandle("u_sampleInfo"),yot);var i=!1,n=this._particleSystem._forceOvertimeModule;if(i=n&&n.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=q2(bot,n.x,n.y,n.z);var r=e.getHandle("force_over_time_tex0"),o=Vv.getBindingFromHandle(r);e.bindSampler(o,this._forceTexture.getGFXSampler()),e.bindTexture(o,this._forceTexture.getGFXTexture());var a=e.getHandle("u_force_space");e.setUniform(a,n.space);var s=e.getHandle("u_force_mode");e.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(i=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(t,e,i,n,r){for(var o=Math.max(j2(e),j2(i),j2(n),j2(r)),a=new Float32Array(t*o*4),s=[e,i,n,r],c=1/(t-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],_=0,f=0,p=0;p<t;p++){var d=H2(h,c*p,l);f=(_+=d)/(p+1),a[4*p+u]=f}return W2(a,t,o)}(bot,c.x,c.y,c.z,c.speedModifier);var l=e.getHandle("velocity_over_time_tex0"),h=Vv.getBindingFromHandle(l);e.bindSampler(h,this._velocityTexture.getGFXSampler()),e.bindTexture(h,this._velocityTexture.getGFXTexture());var _=e.getHandle("u_velocity_space");e.setUniform(_,c.space);var f=e.getHandle("u_velocity_mode");e.setUniform(f,this._velocityTexture.height)}var p=this._particleSystem._colorOverLifetimeModule;if(i=p&&p.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(t,e){for(var i=function(t){switch(t.mode){case J4.TwoColors:case J4.TwoGradients:return 2;default:return 1}}(e),n=new Uint8Array(t*i*4),r=1/(t-1),o=0,a=0;a<i;a++)for(var s=0;s<t;s++){var c=Z4(e,r*s,a);n[o]=c.r,n[o+1]=c.g,n[o+2]=c.b,n[o+3]=c.a,o+=4}var l=new Cv;return l.create(t,i,Dm.RGBA8888),l.setFilters(Om.LINEAR,Om.LINEAR),l.setWrapMode(Mm.CLAMP_TO_EDGE,Mm.CLAMP_TO_EDGE),l.uploadData(n),l}(bot,p.color);var d=e.getHandle("color_over_time_tex0"),m=Vv.getBindingFromHandle(d);e.bindSampler(m,this._colorTexture.getGFXSampler()),e.bindTexture(m,this._colorTexture.getGFXTexture());var v=e.getHandle("u_color_mode");e.setUniform(v,this._colorTexture.height)}var g=this._particleSystem._rotationOvertimeModule;if(i=g&&g.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i){this._rotationTexture&&this._rotationTexture.destroy(),g.separateAxes?this._rotationTexture=q2(bot,g.x,g.y,g.z):this._rotationTexture=function(t,e){for(var i=j2(e),n=new Float32Array(t*i*4),r=1/(t-1),o=0,a=0;a<i;a++)for(var s=0;s<t;s++){var c=H2(e,r*s,a);n[o+2]=c,o+=4}return W2(n,t,i)}(bot,g.z);var y=e.getHandle("rotation_over_time_tex0"),x=Vv.getBindingFromHandle(y);e.bindSampler(x,this._rotationTexture.getGFXSampler()),e.bindTexture(x,this._rotationTexture.getGFXTexture());var S=e.getHandle("u_rotation_mode");e.setUniform(S,this._rotationTexture.height)}var b=this._particleSystem._sizeOvertimeModule;if(i=b&&b.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i){this._sizeTexture&&this._sizeTexture.destroy(),b.separateAxes?this._sizeTexture=q2(bot,b.x,b.y,b.z,!0):this._sizeTexture=function(t,e){for(var i=j2(e),n=new Float32Array(t*i*4),r=1/(t-1),o=0,a=0,s=0;s<i;s++){0;for(var c=0;c<t;c++){var l=H2(e,r*c,s);o=l,n[a]=o,n[a+1]=o,n[a+2]=o,a+=4}}return W2(n,t,i)}(bot,b.size);var C=e.getHandle("size_over_time_tex0"),A=Vv.getBindingFromHandle(C);e.bindSampler(A,this._sizeTexture.getGFXSampler()),e.bindTexture(A,this._sizeTexture.getGFXTexture());var T=e.getHandle("u_size_mode");e.setUniform(T,this._sizeTexture.height)}var w=this._particleSystem._textureAnimationModule;if(i=w&&w.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(t,e,i){for(var n=Math.max(j2(e),j2(i)),r=new Float32Array(t*n*4),o=[e,i],a=1/(t-1),s=0;s<n;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,_=0;_<t;_++){var f=H2(l,a*_,s);h=(u+=f)/(_+1),r[4*_+c]=h}return W2(r,t,n)}(bot,w.startFrame,w.frameOverTime);var E=e.getHandle("texture_animation_tex0"),P=Vv.getBindingFromHandle(E);e.bindSampler(P,this._animTexture.getGFXSampler()),e.bindTexture(P,this._animTexture.getGFXTexture());var I=e.getHandle("u_anim_info");yot.x=this._animTexture.height,yot.y=w.numTilesX*w.numTilesY,yot.z=w.cycleCount,e.setUniform(I,yot)}this._defines.USE_VK_SHADER=u.game._gfxDevice.gfxAPI===ln.VULKAN},i.getParticleCount=function(){return this._particleNum},i.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},i._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case X3.StrecthedBillboard:this._vertAttrs=Iot.slice();break;case X3.Mesh:this._vertAttrs=Rot.slice();break;default:this._vertAttrs=Iot.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!==e){var i=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1===i.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==t.sharedMaterial&&null==this._defaultMat&&(Dot.parent=Mv.get("default-particle-gpu-material"),Dot.owner=t,Dot.subModelIdx=0,this._defaultMat=new mb(Dot),Dot.parent=null,Dot.owner=null,Dot.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var n=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(got),t._simulationSpace===j3.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===X3.Billboard?this._defines.CC_RENDER_MODE=0:r===X3.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===X3.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===X3.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===X3.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=t._textureAnimationModule;o&&o.enable?(qi.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),Ji.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,Ji.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(n),n.recompileShaders(this._defines),this._model&&this._model.updateMaterial(n)}},e}(sot);function Oot(){var t=HO.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.hasFeature(hn.TEXTURE_FLOAT))||(u.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Bot,Not,Lot,Fot,zot,Vot,kot,Uot,Got,Hot,jot,Wot,qot,Xot,Yot,Kot,Jot,Qot,Zot,$ot,tat,eat,iat,nat,rat,oat,aat,sat,cat,lat,uat,hat,_at,fat,pat,dat,mat,vat,gat,yat,xat,Sat,bat,Cat,Aat,Tat,wat,Eat,Pat,Iat,Rat,Dat,Mat,Oat,Bat,Nat,Lat,Fat,zat,Vat,kat,Uat,Gat,Hat,jat,Wat,qat,Xat,Yat,Kat,Jat,Qat,Zat,$at,tst,est,ist,nst,rst,ost,ast,sst,cst,lst,ust,hst,_st,fst,pst,dst,mst,vst,gst,yst,xst,Sst,bst,Cst,Ast,Tst,wst,Est,Pst,Ist,Rst,Dst,Mst,Ost,Bst,Nst,Lst,Fst,zst,Vst,kst,Ust,Gst,Hst,jst,Wst,qst,Xst,Yst,Kst,Jst,Qst,Zst,$st,tct,ect,ict,nct,rct,oct,act,sct,cct,lct,uct,hct,_ct,fct,pct,dct,mct,vct,gct,yct,xct,Sct,bct,Cct,Act,Tct,wct,Ect,Pct,Ict,Rct,Dct,Mct,Oct,Bct,Nct,Lct,Fct,zct,Vct,kct,Uct,Gct,Hct,jct,Wct,qct,Xct,Yct,Kct,Jct,Qct,Zct,$ct,tlt,elt,ilt,nlt,rlt,olt,alt,slt,clt,llt,ult,hlt,_lt,flt,plt,dlt,mlt,vlt,glt,ylt,xlt,Slt,blt,Clt,Alt,Tlt,wlt,Elt,Plt,Ilt,Rlt,Dlt,Mlt,Olt,Blt,Nlt,Llt,Flt,zlt,Vlt,klt,Ult,Glt,Hlt,jlt,Wlt,qlt,Xlt,Ylt,Klt,Jlt,Qlt,Zlt=(Trt=pc("cc.ParticleSystemRenderer"),wrt=Kc(X3),Ert=Uc(),Prt=Nc(),Irt=Uc(),Rrt=Nc(),Drt=Uc(),Mrt=Nc(),Ort=Kc(X3),Brt=Kc(D1),Nrt=Uc(),Lrt=Nc(),Frt=Kc(cg),zrt=Uc(),Vrt=Nc(),krt=Kc(cg),Urt=Uc(),Grt=Nc(),Hrt=Uc(),jrt=Nc(),Wrt=Kc(q3),qrt=Uc(),Xrt=Nc(),Trt((rot=not=function(){function t(){ct(this,"_renderMode",Jrt,this),ct(this,"_velocityScale",Qrt,this),ct(this,"_lengthScale",Zrt,this),ct(this,"_mesh",$rt,this),ct(this,"_mainTexture",tot,this),ct(this,"_useGPU",eot,this),ct(this,"_alignSpace",iot,this),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&O(6033)},e.onInit=function(t){if(this.create(t),this._particleSystem.processor)O(6034);else{var e=this._useGPU&&Oot();this._particleSystem.processor=e?new Mot(this):new vot(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)}},e._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Mot(this):new vot(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},Q(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(Oot()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}(),not.AlignmentSpace=q3,lt((Krt=rot).prototype,"renderMode",[wrt,Ert,Prt],Object.getOwnPropertyDescriptor(Krt.prototype,"renderMode"),Krt.prototype),lt(Krt.prototype,"velocityScale",[Irt,Rrt],Object.getOwnPropertyDescriptor(Krt.prototype,"velocityScale"),Krt.prototype),lt(Krt.prototype,"lengthScale",[Drt,Mrt],Object.getOwnPropertyDescriptor(Krt.prototype,"lengthScale"),Krt.prototype),Jrt=lt(Krt.prototype,"_renderMode",[Ort,xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return X3.Billboard}}),Qrt=lt(Krt.prototype,"_velocityScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Zrt=lt(Krt.prototype,"_lengthScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$rt=lt(Krt.prototype,"_mesh",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(Krt.prototype,"mesh",[Brt,Nrt,Lrt],Object.getOwnPropertyDescriptor(Krt.prototype,"mesh"),Krt.prototype),lt(Krt.prototype,"particleMaterial",[Frt,zrt,Vrt],Object.getOwnPropertyDescriptor(Krt.prototype,"particleMaterial"),Krt.prototype),lt(Krt.prototype,"trailMaterial",[krt,Urt,Grt],Object.getOwnPropertyDescriptor(Krt.prototype,"trailMaterial"),Krt.prototype),tot=lt(Krt.prototype,"_mainTexture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eot=lt(Krt.prototype,"_useGPU",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(Krt.prototype,"useGPU",[Hrt,jrt],Object.getOwnPropertyDescriptor(Krt.prototype,"useGPU"),Krt.prototype),lt(Krt.prototype,"alignSpace",[Wrt,qrt,Xrt],Object.getOwnPropertyDescriptor(Krt.prototype,"alignSpace"),Krt.prototype),iot=lt(Krt.prototype,"_alignSpace",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q3.View}}),Yrt=Krt))||Yrt),$lt=Math.cos(li(100)),tut={position:new Ei,velocity:new Ei},eut=new Bi,iut=new Gi,nut=new Ei,rut=new Ei,out=new Ti,aut=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new Ei,lifetime:0,width:0,velocity:new Ei,direction:0,color:new Ti})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new Ei,lifetime:0,width:0,velocity:new Ei,direction:0,color:new Ti}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)e(t,this.trailElements[o%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),sut=(Bot=pc("cc.TrailModule"),Not=Uc(),Lot=Kc(Q3),Fot=Uc(),zot=Nc(),Vot=Kc(G2),kot=Lc(),Uot=Uc(),Got=Nc(),Hot=Uc(),jot=Nc(),Wot=Kc(j3),qot=Uc(),Xot=Nc(),Yot=Kc(Z3),Kot=Uc(),Jot=Nc(),Qot=Uc(),Zot=Nc(),$ot=Kc(G2),tat=Lc(),eat=Uc(),iat=Nc(),nat=Uc(),rat=Nc(),oat=Kc(Q4),aat=Uc(),sat=Nc(),cat=Kc(Q4),lat=Uc(),uat=Nc(),hat=Kc(j3),Bot((lt((fat=function(){function t(){ct(this,"_enable",pat,this),ct(this,"mode",dat,this),ct(this,"lifeTime",mat,this),ct(this,"_minParticleDistance",vat,this),ct(this,"existWithParticles",gat,this),ct(this,"textureMode",yat,this),ct(this,"widthFromParticle",xat,this),ct(this,"widthRatio",Sat,this),ct(this,"colorFromParticle",bat,this),ct(this,"colorOverTrail",Cat,this),ct(this,"colorOvertime",Aat,this),ct(this,"_space",Tat,this),ct(this,"_particleSystem",wat,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new dr([new fr]),this._vertAttrs=[new Pr(Kn.ATTR_POSITION,_n.RGB32F),new Pr(Kn.ATTR_TEX_COORD,_n.RGBA32F),new Pr(Kn.ATTR_TEX_COORD1,_n.RGB32F),new Pr(Kn.ATTR_COLOR,_n.RGBA8,!0)],this._vertSize=0;for(var t,e=st(this._vertAttrs);!(t=e()).done;){var i=t.value;this._vertSize+=Zr[i.format].size}this._particleTrail=new Map}var e=t.prototype;return e.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,i=t.startLifetime.getMax(),n=t.rateOverTime.getMax(),r=t.duration,o=0,a=t.bursts.length;o<a;o++)e+=t.bursts[o].getMaxCount(t)*Math.ceil(i/r);this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(n*r+e)),this._trailSegments=new jl((function(){return new aut(10)}),Math.ceil(n*r),(function(t){return t.trailElements.length=0})),this._enable&&(this.enable=this._enable)},e.onEnable=function(){this._attachToScene()},e.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},e._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},e._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},e.destroy=function(){this.destroySubMeshData(),this._trailModel&&(HO.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},e.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},e.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},e.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},e.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===j3.World&&this._particleSystem._simulationSpace===j3.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(iut),this._particleSystem.node.getWorldRotation(eut)):this._needTransform=!1},e.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var n=i.getElement(i.end-1);if(this._needTransform?Ei.transformMat4(nut,t.position,iut):Ei.copy(nut,t.position),!(n&&(i.iterateElement(this,this._updateTrailElement,t,e),Ei.squaredDistance(n.position,nut)<this._minSquaredDistance))&&(n=i.addElement())){Ei.copy(n.position,nut),n.lifetime=0,this.widthFromParticle?n.width=t.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var o=i.getElement(i.end-2);Ei.subtract(o.velocity,n.position,o.position)}else if(r>2){var a=i.getElement(i.end-2),s=i.getElement(i.end-3);Ei.subtract(nut,s.position,a.position),Ei.subtract(rut,n.position,a.position),Ei.subtract(a.velocity,rut,nut),Ei.equals(Ei.ZERO,a.velocity)&&Ei.copy(a.velocity,nut),Ei.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?n.color.set(t.color):n.color.set(this.colorOvertime.evaluate(0,1))}}},e.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},e.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=st(this._particleTrail.keys());!(t=e()).done;){var i=t.value,n=this._particleTrail.get(i);if(-1!==n.start){var r=4*this.vbOffset/this._vertSize,o=n.start>=n.end?n.end+n.trailElements.length:n.end,a=o-n.start,s=1/a,c=n.trailElements[n.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=n.start+1;l<o;l++){var u=n.trailElements[l%n.trailElements.length],h=l-n.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?Ei.transformMat4(tut.position,i.position,iut):Ei.copy(tut.position,i.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(ny.POSITION),1===a||2===a){var f=n.getElement(n.end-1);Ei.subtract(f.velocity,tut.position,f.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=f.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=f.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=f.velocity.z,this._vbF32[this.vbOffset-4]=f.velocity.x,this._vbF32[this.vbOffset-3]=f.velocity.y,this._vbF32[this.vbOffset-2]=f.velocity.z,Ei.subtract(tut.velocity,tut.position,f.position),this._checkDirectionReverse(tut,f)}else if(a>2){var p=n.getElement(n.end-1),d=n.getElement(n.end-2);Ei.subtract(nut,d.position,p.position),Ei.subtract(rut,tut.position,p.position),Ei.normalize(nut,nut),Ei.normalize(rut,rut),Ei.subtract(p.velocity,rut,nut),Ei.normalize(p.velocity,p.velocity),this._checkDirectionReverse(p,d),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(p,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),Ei.subtract(tut.velocity,tut.position,p.position),Ei.normalize(tut.velocity,tut.velocity),this._checkDirectionReverse(tut,p)}this.widthFromParticle?tut.width=i.size.x*this.widthRatio.evaluate(0,1):tut.width=this.widthRatio.evaluate(0,1),tut.color=i.color,Ei.equals(tut.velocity,Ei.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(tut,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},e.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=t,this._iaInfoBuffer.update(this._iaInfo)}},e.beforeRender=function(){this.updateIA(this.ibOffset)},e._createModel=function(){this._trailModel||(this._trailModel=u.director.root.createModel(cb))},e.rebuild=function(){var t=HO.root.device,e=t.createBuffer(new hr(dn.VERTEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);var n=t.createBuffer(new hr(dn.INDEX|dn.TRANSFER_DST,gn.HOST|gn.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),n.update(this._iBuffer),this._iaInfoBuffer=t.createBuffer(new hr(dn.INDIRECT,gn.HOST|gn.DEVICE,io,io)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Uw([e],this._vertAttrs,Fn.TRIANGLE_LIST,n,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},e._updateTrailElement=function(t,e,i,n){return e.lifetime+=n,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},e._fillVertexBuffer=function(t,e,i,n,r,o){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,out.set(t.color),out.multiply(e),this._vbUint32[this.vbOffset++]=out._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=out._val,1&o&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)},e._checkDirectionReverse=function(t,e){Ei.dot(t.velocity,e.velocity)<$lt?t.direction=1-e.direction:t.direction=e.direction},e.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},Q(t,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}}]),t}()).prototype,"enable",[Not],Object.getOwnPropertyDescriptor(fat.prototype,"enable"),fat.prototype),pat=lt(fat.prototype,"_enable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dat=lt(fat.prototype,"mode",[Lot,xc,Fot,zot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q3.Particles}}),mat=lt(fat.prototype,"lifeTime",[Vot,xc,kot,Uot,Got],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),vat=lt(fat.prototype,"_minParticleDistance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),lt(fat.prototype,"minParticleDistance",[Hot,jot],Object.getOwnPropertyDescriptor(fat.prototype,"minParticleDistance"),fat.prototype),lt(fat.prototype,"space",[Wot,qot,Xot],Object.getOwnPropertyDescriptor(fat.prototype,"space"),fat.prototype),gat=lt(fat.prototype,"existWithParticles",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yat=lt(fat.prototype,"textureMode",[Yot,xc,Kot,Jot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z3.Stretch}}),xat=lt(fat.prototype,"widthFromParticle",[xc,Qot,Zot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Sat=lt(fat.prototype,"widthRatio",[$ot,xc,tat,eat,iat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),bat=lt(fat.prototype,"colorFromParticle",[xc,nat,rat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cat=lt(fat.prototype,"colorOverTrail",[oat,xc,aat,sat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q4}}),Aat=lt(fat.prototype,"colorOvertime",[cat,xc,lat,uat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q4}}),Tat=lt(fat.prototype,"_space",[hat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j3.World}}),wat=lt(fat.prototype,"_particleSystem",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_at=fat))||_at),cut=new Gi,lut=new Bi,uut=new Ei,hut=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],_ut=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Gi,this._gravity=new Ji,this.minPos=new Ei,this.maxPos=new Ei,this._nodePos=new Ei,this._nodeSize=new Ei,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,i){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;hut.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=U3.length;e<i;e++){var n=this._animateList[U3[e]];n&&this._runAnimateList.push(n)}},e._emit=function(t,e,n){var r=this._particleSystem,o=this._node,a=r.time%r.duration/r.duration;o.invalidateChildren(ny.POSITION),r.simulationSpace===j3.World&&(o.getWorldMatrix(cut),o.getWorldRotation(lut));for(var s=0;s<t;++s){var c=new i3(r);c.particleSystem=r,c.reset();var l=pi(fi(0,i));r._shapeModule&&r._shapeModule.enable?r._shapeModule.emit(c):(Ei.set(c.position,0,0,0),Ei.copy(c.velocity,t5)),r._textureAnimationModule&&r._textureAnimationModule.enable&&r._textureAnimationModule.init(c);var u=r.startSpeed.evaluate(a,l);Ei.multiplyScalar(c.velocity,c.velocity,u),r.simulationSpace===j3.World&&(Ei.transformMat4(c.position,c.position,cut),Ei.transformQuat(c.velocity,c.velocity,lut)),Ei.copy(c.ultimateVelocity,c.velocity),Ei.set(c.rotation,0,0,0),r.startSize3D?Ei.set(c.startSize,r.startSizeX.evaluate(a,l),r.startSizeY.evaluate(a,l),r.startSizeZ.evaluate(a,l)):(Ei.set(c.startSize,r.startSizeX.evaluate(a,l),1,1),c.startSize.y=c.startSize.x),Ei.copy(c.size,c.startSize),c.startLifetime=r.startLifetime.evaluate(a,l)+e,c.remainingLifetime=c.startLifetime,n.push(c)}},e._updateParticles=function(t,e){var i=this,n=this._particleSystem;switch(n.node.getWorldMatrix(cut),n.scaleSpace){case j3.Local:n.node.getScale(uut);break;case j3.World:n.node.getWorldScale(uut)}if(this._updateList.forEach((function(t){t.update(n.simulationSpace,cut)})),n.simulationSpace===j3.Local){var r=n.node.getRotation();Gi.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=e[r];if(o.remainingLifetime-=t,Ei.set(o.animatedVelocity,0,0,0),n.simulationSpace===j3.Local){var a=9.8*-n.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,pi(o.randomSeed))*t;i._gravity.x=0,i._gravity.y=a,i._gravity.z=0,i._gravity.w=1,i._gravity=i._gravity.transformMat4(i._localMat),o.velocity.x+=i._gravity.x,o.velocity.y+=i._gravity.y,o.velocity.z+=i._gravity.z}else o.velocity.y-=9.8*n.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,pi(o.randomSeed))*t;Ei.copy(o.ultimateVelocity,o.velocity),i._runAnimateList.forEach((function(e){e.animate(o,t)})),Ei.scaleAndAdd(o.position,o.position,o.ultimateVelocity,t)},a=0;a<e.length;++a)o(a)},e._calculateBounding=function(t){var e=new Ei,i=new Ei,n=new Ei,r=new Ei,o=new Ei(1,1,1);if(this._processor.getInfo().renderMode===X3.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new Ws;Ws.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];Ei.multiply(e,uut,u.size),Ei.multiply(e,e,o),i.set(u.position),this._particleSystem.simulationSpace!==j3.World&&Ei.transformMat4(i,i,this._particleSystem.node._mat),t&&0===l?(Ei.subtract(this.minPos,i,e),Ei.add(this.maxPos,i,e)):(Ei.subtract(n,i,e),Ei.add(r,i,e),Ei.min(this.minPos,this.minPos,n),Ei.max(this.maxPos,this.maxPos,r))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=pi(fi(0,i));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),fut=new Gi,put=new Bi,dut=Object.getOwnPropertyDescriptor(fF.prototype,"sharedMaterials"),mut=function(e){return t({ParticleSystem:e,ParticleSystemComponent:e}),e}((Eat=pc("cc.ParticleSystem"),Pat=Rc(),Iat=wc(),Rat=mc(99),Dat=Lc(),Mat=Uc(),Oat=Nc(),Bat=Kc(Q4),Nat=Uc(),Lat=Nc(),Fat=Kc(j3),zat=Uc(),Vat=Nc(),kat=Uc(),Uat=Nc(),Gat=Sc("startSize"),Hat=Lc(),jat=Kc(G2),Wat=Uc(),qat=Nc(),Xat=Kc(G2),Yat=Lc(),Kat=Uc(),Jat=Nc(),Qat=Kc(G2),Zat=Lc(),$at=Uc(),tst=Nc(),est=Kc(G2),ist=Lc(),nst=Uc(),rst=Nc(),ost=Uc(),ast=Nc(),sst=Kc(G2),cst=Lc(),lst=Uc(),ust=Nc(),hst=Kc(G2),_st=Lc(),fst=Uc(),pst=Nc(),dst=Kc(G2),mst=Sc("startRotation"),vst=Lc(),gst=Uc(),yst=Nc(),xst=Kc(G2),Sst=Lc(),bst=Uc(),Cst=Nc(),Ast=Kc(G2),Tst=Lc(),wst=Uc(),Est=Nc(),Pst=Uc(),Ist=Nc(),Rst=Uc(),Dst=Nc(),Mst=Uc(),Ost=Nc(),Bst=Kc(j3),Nst=Uc(),Lst=Nc(),Fst=Uc(),zst=Nc(),Vst=Uc(),kst=Nc(),Ust=Kc(G2),Gst=Lc(),Hst=Uc(),jst=Nc(),Wst=Kc(G2),qst=Lc(),Xst=Uc(),Yst=Nc(),Kst=Kc(G2),Jst=Lc(),Qst=Uc(),Zst=Nc(),$st=Kc([Q9]),tct=Uc(),ect=Nc(),ict=Kc(Boolean),nct=Uc(),rct=Nc(),oct=Kc(W3),act=Uc(),sct=Nc(),cct=Kc(Number),lct=Uc(),uct=Nc(),hct=Kc(Number),_ct=Uc(),fct=Nc(),pct=Kc(Number),dct=Uc(),mct=Nc(),vct=Uc(),gct=Nc(),yct=Sc("enableCulling"),xct=Mc(),Sct=Kc(cg),bct=Bc(),Cct=Kc($3),Act=Kc($3),Tct=Uc(),wct=Nc(),Ect=Kc(ett),Pct=Kc(ett),Ict=Uc(),Rct=Nc(),Dct=Kc(H9),Mct=Kc(H9),Oct=Uc(),Bct=Nc(),Nct=Kc(J9),Lct=Kc(J9),Fct=Uc(),zct=Nc(),Vct=Kc(m6),kct=Kc(m6),Uct=Uc(),Gct=Nc(),Hct=Kc(x6),jct=Kc(x6),Wct=Uc(),qct=Nc(),Xct=Kc(G9),Yct=Kc(G9),Kct=Uc(),Jct=Nc(),Qct=Kc(X9),Zct=Kc(X9),$ct=Uc(),tlt=Nc(),elt=Kc(sut),ilt=Kc(sut),nlt=Uc(),rlt=Nc(),olt=Kc(Zlt),alt=Uc(),slt=Nc(),Eat(clt=Pat(clt=Iat(clt=Rat(clt=Tc((Qlt=Jlt=function(t){function e(){var e;return ct(e=t.call(this)||this,"startColor",ult,ot(e)),ct(e,"scaleSpace",hlt,ot(e)),ct(e,"startSize3D",_lt,ot(e)),ct(e,"startSizeX",flt,ot(e)),ct(e,"startSizeY",plt,ot(e)),ct(e,"startSizeZ",dlt,ot(e)),ct(e,"startSpeed",mlt,ot(e)),ct(e,"startRotation3D",vlt,ot(e)),ct(e,"startRotationX",glt,ot(e)),ct(e,"startRotationY",ylt,ot(e)),ct(e,"startRotationZ",xlt,ot(e)),ct(e,"startDelay",Slt,ot(e)),ct(e,"startLifetime",blt,ot(e)),ct(e,"duration",Clt,ot(e)),ct(e,"loop",Alt,ot(e)),ct(e,"simulationSpeed",Tlt,ot(e)),ct(e,"playOnAwake",wlt,ot(e)),ct(e,"gravityModifier",Elt,ot(e)),ct(e,"rateOverTime",Plt,ot(e)),ct(e,"rateOverDistance",Ilt,ot(e)),ct(e,"bursts",Rlt,ot(e)),ct(e,"_renderCulling",Dlt,ot(e)),ct(e,"_cullingMode",Mlt,ot(e)),ct(e,"_aabbHalfX",Olt,ot(e)),ct(e,"_aabbHalfY",Blt,ot(e)),ct(e,"_aabbHalfZ",Nlt,ot(e)),ct(e,"_dataCulling",Llt,ot(e)),ct(e,"_colorOverLifetimeModule",Flt,ot(e)),ct(e,"_shapeModule",zlt,ot(e)),ct(e,"_sizeOvertimeModule",Vlt,ot(e)),ct(e,"_velocityOvertimeModule",klt,ot(e)),ct(e,"_forceOvertimeModule",Ult,ot(e)),ct(e,"_limitVelocityOvertimeModule",Glt,ot(e)),ct(e,"_rotationOvertimeModule",Hlt,ot(e)),ct(e,"_textureAnimationModule",jlt,ot(e)),ct(e,"_trailModule",Wlt,ot(e)),ct(e,"renderer",qlt,ot(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,ct(e,"_prewarm",Xlt,ot(e)),ct(e,"_capacity",Ylt,ot(e)),ct(e,"_simulationSpace",Klt,ot(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needRefresh=!0,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Ei,e._curWPos=new Ei,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new qi,e._customData2=new qi,e._subEmitters=[],e}$(e,t);var n=e.prototype;return n.onFocusInEditor=function(){this.renderer.create(this)},n.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},n._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},n._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},n._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},n._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},n._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},n.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}},n.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},n.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var t,e=st(this.bursts);!(t=e()).done;)t.value.reset()},n.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},n.getParticleCount=function(){return this.processor.getParticleCount()},n.setCustomData1=function(t,e){qi.set(this._customData1,t,e)},n.setCustomData2=function(t,e){qi.set(this._customData2,t,e)},n.onDestroy=function(){u.director.off(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.onEnable=function(){u.director.on(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},n.onDisable=function(){u.director.off(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n._calculateBounding=function(t){this._boundingBox&&(this._culler||(this._culler=new _ut(this)),this._culler.calculatePositions(),Ws.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},n.update=function(t){var e=t*this.simulationSpeed;if(this.renderCulling){var i;if(this._boundingBox||(this._boundingBox=new Ws,this._calculateBounding(!1)),this._curPos||(this._curPos=new Ei),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new Ei,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var n=this._curPos.x-this._oldPos.x,r=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,a=this._boundingBox.center;a.x+=n,a.y+=r,a.z+=o,this._culler.setBoundingBoxCenter(a.x,a.y,a.z),this._oldPos.set(this._curPos)}var s=null===(i=this.node.scene.renderScene)||void 0===i?void 0:i.cameras,c=!0;if(void 0!==s&&this._boundingBox)for(var l=0;l<s.length;++l){var u=s[l];if((u.visibility&this.node.layer)===this.node.layer&&hs.aabbFrustum(this._boundingBox,u.frustum)){c=!1;break}}if(c){if(this._cullingMode!==W3.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===W3.PauseAndCatchup&&(this._time+=e),this._cullingMode!==W3.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop();else{var h=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(h),this.processor.updateScale(h)}this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},n.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},n._onVisibilityChange=function(t){this.processor._model&&(this.processor._model.visFlags=t)},n.emit=function(t,e){var n=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(ny.POSITION),this._needRefresh=!1),this._simulationSpace===j3.World&&(this.node.getWorldMatrix(fut),this.node.getWorldRotation(put));for(var r=0;r<t;++r){var o=this.processor.getFreeParticle();if(null===o)return;o.particleSystem=this,o.reset();var a=pi(fi(0,i));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(o):(Ei.set(o.position,0,0,0),Ei.copy(o.velocity,t5)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(o);var s=this.startSpeed.evaluate(n,a);Ei.multiplyScalar(o.velocity,o.velocity,s),this._simulationSpace===j3.World&&(Ei.transformMat4(o.position,o.position,fut),Ei.transformQuat(o.velocity,o.velocity,put)),Ei.copy(o.ultimateVelocity,o.velocity),this.startRotation3D?o.startEuler.set(this.startRotationX.evaluate(n,a),this.startRotationY.evaluate(n,a),this.startRotationZ.evaluate(n,a)):o.startEuler.set(0,0,this.startRotationZ.evaluate(n,a)),o.rotation.set(o.startEuler),this.startSize3D?Ei.set(o.startSize,this.startSizeX.evaluate(n,a),this.startSizeY.evaluate(n,a),this.startSizeZ.evaluate(n,a)):(Ei.set(o.startSize,this.startSizeX.evaluate(n,a),1,1),o.startSize.y=o.startSize.x),Ei.copy(o.size,o.startSize),o.startColor.set(this.startColor.evaluate(n,a)),o.color.set(o.startColor),o.startLifetime=this.startLifetime.evaluate(n,a)+e,o.remainingLifetime=o.startLifetime,o.randomSeed=fi(0,233280),o.loopCount++,this.processor.setNewParticle(o)}},n._prewarmSystem=function(){this.startDelay.mode=U2.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},n._emit=function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,t)}this.node.getWorldPosition(this._curWPos);var n=Ei.distance(this._curWPos,this._oldWPos);if(Ei.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,t)}for(var o,a=st(this.bursts);!(o=a()).done;)o.value.update(this,t)}},n._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),Ei.copy(this._curWPos,this._oldWPos)},n.addSubEmitter=function(t){this._subEmitters.push(t)},n.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},n.addBurst=function(t){this.bursts.push(t)},n.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},n.getBoundingX=function(){return this._aabbHalfX},n.getBoundingY=function(){return this._aabbHalfY},n.getBoundingZ=function(){return this._aabbHalfZ},n.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},n.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},n.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},n._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!G3.includes(t)||e[t]&&e[t].enable})):t},Q(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new Ws,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return dut.get.call(this)},set:function(t){dut.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(fF),Jlt.CullingMode=W3,lt((llt=Qlt).prototype,"capacity",[Dat,Mat,Oat],Object.getOwnPropertyDescriptor(llt.prototype,"capacity"),llt.prototype),ult=lt(llt.prototype,"startColor",[Bat,xc,Nat,Lat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Q4}}),hlt=lt(llt.prototype,"scaleSpace",[Fat,xc,zat,Vat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j3.Local}}),_lt=lt(llt.prototype,"startSize3D",[xc,kat,Uat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),flt=lt(llt.prototype,"startSizeX",[Gat,Hat,jat,Wat,qat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),plt=lt(llt.prototype,"startSizeY",[Xat,xc,Yat,Kat,Jat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),dlt=lt(llt.prototype,"startSizeZ",[Qat,xc,Zat,$at,tst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),mlt=lt(llt.prototype,"startSpeed",[est,xc,ist,nst,rst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),vlt=lt(llt.prototype,"startRotation3D",[xc,ost,ast],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),glt=lt(llt.prototype,"startRotationX",[sst,xc,cst,Gc,lst,ust],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),ylt=lt(llt.prototype,"startRotationY",[hst,xc,_st,Gc,fst,pst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),xlt=lt(llt.prototype,"startRotationZ",[dst,mst,vst,Gc,gst,yst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),Slt=lt(llt.prototype,"startDelay",[xst,xc,Sst,bst,Cst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),blt=lt(llt.prototype,"startLifetime",[Ast,xc,Tst,wst,Est],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),Clt=lt(llt.prototype,"duration",[xc,Pst,Ist],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Alt=lt(llt.prototype,"loop",[xc,Rst,Dst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(llt.prototype,"prewarm",[Mst,Ost],Object.getOwnPropertyDescriptor(llt.prototype,"prewarm"),llt.prototype),lt(llt.prototype,"simulationSpace",[Bst,xc,Nst,Lst],Object.getOwnPropertyDescriptor(llt.prototype,"simulationSpace"),llt.prototype),Tlt=lt(llt.prototype,"simulationSpeed",[xc,Fst,zst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wlt=lt(llt.prototype,"playOnAwake",[xc,Vst,kst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Elt=lt(llt.prototype,"gravityModifier",[Ust,xc,Gst,Hst,jst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),Plt=lt(llt.prototype,"rateOverTime",[Wst,xc,qst,Xst,Yst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),Ilt=lt(llt.prototype,"rateOverDistance",[Kst,xc,Jst,Qst,Zst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new G2}}),Rlt=lt(llt.prototype,"bursts",[$st,xc,tct,ect],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lt(llt.prototype,"renderCulling",[ict,nct,rct],Object.getOwnPropertyDescriptor(llt.prototype,"renderCulling"),llt.prototype),Dlt=lt(llt.prototype,"_renderCulling",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(llt.prototype,"cullingMode",[oct,act,sct],Object.getOwnPropertyDescriptor(llt.prototype,"cullingMode"),llt.prototype),Mlt=lt(llt.prototype,"_cullingMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W3.Pause}}),lt(llt.prototype,"aabbHalfX",[cct,lct,uct],Object.getOwnPropertyDescriptor(llt.prototype,"aabbHalfX"),llt.prototype),Olt=lt(llt.prototype,"_aabbHalfX",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(llt.prototype,"aabbHalfY",[hct,_ct,fct],Object.getOwnPropertyDescriptor(llt.prototype,"aabbHalfY"),llt.prototype),Blt=lt(llt.prototype,"_aabbHalfY",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(llt.prototype,"aabbHalfZ",[pct,dct,mct],Object.getOwnPropertyDescriptor(llt.prototype,"aabbHalfZ"),llt.prototype),Nlt=lt(llt.prototype,"_aabbHalfZ",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(llt.prototype,"dataCulling",[vct,gct],Object.getOwnPropertyDescriptor(llt.prototype,"dataCulling"),llt.prototype),Llt=lt(llt.prototype,"_dataCulling",[xc,yct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(llt.prototype,"sharedMaterials",[ol,xct,Sct,xc,bct],Object.getOwnPropertyDescriptor(llt.prototype,"sharedMaterials"),llt.prototype),Flt=lt(llt.prototype,"_colorOverLifetimeModule",[Cct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"colorOverLifetimeModule",[Act,Tct,wct],Object.getOwnPropertyDescriptor(llt.prototype,"colorOverLifetimeModule"),llt.prototype),zlt=lt(llt.prototype,"_shapeModule",[Ect],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"shapeModule",[Pct,Ict,Rct],Object.getOwnPropertyDescriptor(llt.prototype,"shapeModule"),llt.prototype),Vlt=lt(llt.prototype,"_sizeOvertimeModule",[Dct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"sizeOvertimeModule",[Mct,Oct,Bct],Object.getOwnPropertyDescriptor(llt.prototype,"sizeOvertimeModule"),llt.prototype),klt=lt(llt.prototype,"_velocityOvertimeModule",[Nct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"velocityOvertimeModule",[Lct,Fct,zct],Object.getOwnPropertyDescriptor(llt.prototype,"velocityOvertimeModule"),llt.prototype),Ult=lt(llt.prototype,"_forceOvertimeModule",[Vct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"forceOvertimeModule",[kct,Uct,Gct],Object.getOwnPropertyDescriptor(llt.prototype,"forceOvertimeModule"),llt.prototype),Glt=lt(llt.prototype,"_limitVelocityOvertimeModule",[Hct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"limitVelocityOvertimeModule",[jct,Wct,qct],Object.getOwnPropertyDescriptor(llt.prototype,"limitVelocityOvertimeModule"),llt.prototype),Hlt=lt(llt.prototype,"_rotationOvertimeModule",[Xct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"rotationOvertimeModule",[Yct,Kct,Jct],Object.getOwnPropertyDescriptor(llt.prototype,"rotationOvertimeModule"),llt.prototype),jlt=lt(llt.prototype,"_textureAnimationModule",[Qct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"textureAnimationModule",[Zct,$ct,tlt],Object.getOwnPropertyDescriptor(llt.prototype,"textureAnimationModule"),llt.prototype),Wlt=lt(llt.prototype,"_trailModule",[elt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lt(llt.prototype,"trailModule",[ilt,nlt,rlt],Object.getOwnPropertyDescriptor(llt.prototype,"trailModule"),llt.prototype),qlt=lt(llt.prototype,"renderer",[olt,xc,alt,slt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zlt}}),Xlt=lt(llt.prototype,"_prewarm",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ylt=lt(llt.prototype,"_capacity",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Klt=lt(llt.prototype,"_simulationSpace",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return j3.Local}}),clt=llt))||clt)||clt)||clt)||clt)||clt)),vut=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||(HO.on(GO.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new jl((function(){return $h(t)||new jT}),1,(function(t){return t.destroy()}))),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,i=st(t.getComponentsInChildren(mut));!(e=i()).done;)e.value.play()},t.stop=function(t){for(var e,i=st(t.getComponentsInChildren(mut));!(e=i()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());vut.particleSystemPool=new Map,vut.registeredSceneEvent=!1,U(Q9.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),k(mut.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),u.ParticleSystemComponent=mut,ne.setClassAlias(mut,"cc.ParticleSystemComponent"),u.BillboardComponent=N2,ne.setClassAlias(N2,"cc.BillboardComponent"),u.LineComponent=e3,ne.setClassAlias(e3,"cc.LineComponent"),u.ParticleUtils=vut;var gut,yut,xut,Sut,but=oe({GRAVITY:0,RADIUS:1}),Cut=oe({FREE:0,RELATIVE:1,GROUPED:2}),Aut=new qi(0,0),Tut=new qi,wut=new qi,Eut=new qi,Put=new qi,Iut=rH(iH),Rut=function(){this.pos=new qi(0,0),this.startPos=new qi(0,0),this.color=new Ti(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new qi(0,0),this.aspectRatio=1,this.dir=new qi(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0},Dut=new(function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.prototype.get=function(){return this._get()||new Rut},e}(ee))((function(t){t.pos.set(Aut),t.startPos.set(Aut),t.color._val=4278190080,t.deltaColor.r=t.deltaColor.g=t.deltaColor.b=0,t.deltaColor.a=255,t.size=0,t.deltaSize=0,t.rotation=0,t.deltaRotation=0,t.timeToLive=0,t.drawPos.set(Aut),t.aspectRatio=1,t.dir.set(Aut),t.radialAccel=0,t.tangentialAccel=0,t.angle=0,t.degreesPerSecond=0,t.radius=0,t.deltaRadius=0}),1024),Mut=function(){function t(t){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}var e=t.prototype;return e.stop=function(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0},e.reset=function(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;for(var t=this.particles,e=0;e<t.length;++e)Dut.put(t[e]);t.length=0},e.emitParticle=function(t){var e=this.sys,i=Dut.get();this.particles.push(i),i.timeToLive=e.life+e.lifeVar*(Math.random()-.5)*2;var n=i.timeToLive=Math.max(0,i.timeToLive);i.pos.x=e.sourcePos.x+e.posVar.x*(Math.random()-.5)*2,i.pos.y=e.sourcePos.y+e.posVar.y*(Math.random()-.5)*2;var r,o,a,s,c=e.startColor,l=e.startColorVar,u=e.endColor,h=e.endColorVar;i.color.r=r=be(c.r+l.r*(Math.random()-.5)*2,0,255),i.color.g=o=be(c.g+l.g*(Math.random()-.5)*2,0,255),i.color.b=a=be(c.b+l.b*(Math.random()-.5)*2,0,255),i.color.a=s=be(c.a+l.a*(Math.random()-.5)*2,0,255),i.deltaColor.r=(be(u.r+h.r*(Math.random()-.5)*2,0,255)-r)/n,i.deltaColor.g=(be(u.g+h.g*(Math.random()-.5)*2,0,255)-o)/n,i.deltaColor.b=(be(u.b+h.b*(Math.random()-.5)*2,0,255)-a)/n,i.deltaColor.a=(be(u.a+h.a*(Math.random()-.5)*2,0,255)-s)/n;var _=e.startSize+e.startSizeVar*(Math.random()-.5)*2;if(_=Math.max(0,_),i.size=_,-1===e.endSize)i.deltaSize=0;else{var f=e.endSize+e.endSizeVar*(Math.random()-.5)*2;f=Math.max(0,f),i.deltaSize=(f-_)/n}var p=e.startSpin+e.startSpinVar*(Math.random()-.5)*2,d=e.endSpin+e.endSpinVar*(Math.random()-.5)*2;i.rotation=p,i.deltaRotation=(d-p)/n,i.startPos.x=t.x,i.startPos.y=t.y,i.aspectRatio=e.aspectRatio||1;var m=Ce(e.angle+this._worldRotation+e.angleVar*(Math.random()-.5)*2);if(e.emitterMode===but.GRAVITY){var v=e.speed+e.speedVar*(Math.random()-.5)*2;i.dir.x=Math.cos(m),i.dir.y=Math.sin(m),i.dir.multiplyScalar(v),i.radialAccel=e.radialAccel+e.radialAccelVar*(Math.random()-.5)*2,i.tangentialAccel=e.tangentialAccel+e.tangentialAccelVar*(Math.random()-.5)*2,e.rotationIsDir&&(i.rotation=-Ae(Math.atan2(i.dir.y,i.dir.x)))}else{var g=e.startRadius+e.startRadiusVar*(Math.random()-.5)*2,y=e.endRadius+e.endRadiusVar*(Math.random()-.5)*2;i.radius=g,i.deltaRadius=-1===e.endRadius?0:(y-g)/n,i.angle=m,i.degreesPerSecond=Ce(e.rotatePerS+e.rotatePerSVar*(Math.random()-.5)*2)}},e.updateUVs=function(t){var e=this.renderData;if(e&&this.sys._renderSpriteFrame){for(var i=e.vData,n=this.sys._renderSpriteFrame.uv,r=t?0:this.uvFilled,o=this.particles.length,a=r;a<o;a++){var s=a*Iut*4;i[s+3]=n[0],i[s+4]=n[1],i[s+12]=n[2],i[s+13]=n[3],i[s+21]=n[4],i[s+22]=n[5],i[s+30]=n[6],i[s+31]=n[7]}this.uvFilled=o}},e.updateParticleBuffer=function(t,e,i,n){var r=i.vData,o=e.x,a=e.y,s=t.size,c=s,l=t.aspectRatio;l>1?c=s/l:s=c*l;var u=s/2,h=c/2;if(t.rotation){var _=-u,f=-h,p=u,d=h,m=-Ce(t.rotation),v=Math.cos(m),g=Math.sin(m);r[n]=_*v-f*g+o,r[n+1]=_*g+f*v+a,r[n+2]=0,r[n+9]=p*v-f*g+o,r[n+10]=p*g+f*v+a,r[n+11]=0,r[n+18]=_*v-d*g+o,r[n+19]=_*g+d*v+a,r[n+20]=0,r[n+27]=p*v-d*g+o,r[n+28]=p*g+d*v+a,r[n+29]=0}else r[n]=o-u,r[n+1]=a-h,r[n+2]=0,r[n+9]=o+u,r[n+10]=a-h,r[n+11]=0,r[n+18]=o-u,r[n+19]=a+h,r[n+20]=0,r[n+27]=o+u,r[n+28]=a+h,r[n+29]=0;Ti.toArray(r,t.color,n+5),Ti.toArray(r,t.color,n+14),Ti.toArray(r,t.color,n+23),Ti.toArray(r,t.color,n+32)},e.step=function(t){var e=this.sys.assembler,i=this.sys,n=i.node,r=this.particles;if(t=t>e.maxParticleDeltaTime?e.maxParticleDeltaTime:t,n.updateWorldTransform(),i.positionType===Cut.FREE){this._worldRotation=function(t){for(var e=0,i=t;i;)e+=i.eulerAngles.z,i=i.parent;return e}(n);var o=n.worldMatrix;Tut.x=o.m12,Tut.y=o.m13}else i.positionType===Cut.RELATIVE?(this._worldRotation=n.eulerAngles.z,Tut.x=n.position.x,Tut.y=n.position.y):this._worldRotation=0;if(this.active&&i.emissionRate){var a=1/i.emissionRate;for(r.length<i.totalParticles&&(this.emitCounter+=t);r.length<i.totalParticles&&this.emitCounter>a;)this.emitParticle(Tut),this.emitCounter-=a;this.elapsed+=t,-1!==i.duration&&i.duration<this.elapsed&&i.stopSystem()}var s=this.renderData,c=r.length;s.reset(),this.requestData(4*c,6*c),c>this.uvFilled&&this.updateUVs();for(var l=0;l<r.length;){wut.x=wut.y=Eut.x=Eut.y=Put.x=Put.y=0;var u=r[l];if(u.timeToLive-=t,u.timeToLive>0){if(i.emitterMode===but.GRAVITY){var h=Put,_=wut,f=Eut;(u.pos.x||u.pos.y)&&(_.set(u.pos),_.normalize()),f.set(_),_.multiplyScalar(u.radialAccel);var p=f.x;f.x=-f.y,f.y=p,f.multiplyScalar(u.tangentialAccel),h.set(_),h.add(f),h.add(i.gravity),h.multiplyScalar(t),u.dir.add(h),h.set(u.dir),h.multiplyScalar(t),u.pos.add(h)}else u.angle+=u.degreesPerSecond*t,u.radius+=u.deltaRadius*t,u.pos.x=-Math.cos(u.angle)*u.radius,u.pos.y=-Math.sin(u.angle)*u.radius;u.color.r+=u.deltaColor.r*t,u.color.g+=u.deltaColor.g*t,u.color.b+=u.deltaColor.b*t,u.color.a+=u.deltaColor.a*t,u.size+=u.deltaSize*t,u.size<0&&(u.size=0),u.rotation+=u.deltaRotation*t;var d=wut;d.set(u.pos),i.positionType!==Cut.GROUPED&&d.add(u.startPos);var m=Iut*l*4;this.updateParticleBuffer(u,d,s,m),++l}else{var v=r[l];l!==r.length-1&&(r[l]=r[r.length-1]),Dut.put(v),r.length--,s.resize(s.vertexCount-4,s.indexCount-6)}}0!==r.length||this.active||this.readyToPlay||(this.finished=!0,i._finishedSimulation())},e.requestData=function(t,e){var i=this.renderData.indexCount;this.renderData.request(t,e);for(var n=this.renderData.indexCount/6,r=this.renderData.iData,o=i;o<n;o++){var a=4*o;r[i++]=a,r[i++]=a+1,r[i++]=a+2,r[i++]=a+1,r[i++]=a+3,r[i++]=a+2}},t}(),Out=t("ParticleAsset",pc("cc.ParticleAsset")((Sut=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"spriteFrame",xut,ot(e)),e}return $(e,t),e}(Mu),xut=lt((yut=Sut).prototype,"spriteFrame",[xc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gut=yut))||gut);u.ParticleAsset=Out;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var But={};(function(){function t(t){throw t}var e=void 0,i=!0,n=this;function r(t,i){var r,o=t.split("."),a=n;!(o[0]in a)&&a.execScript&&a.execScript("var "+o[0]);for(;o.length&&(r=o.shift());)o.length||i===e?a=a[r]?a[r]:a[r]={}:a[r]=i}var o="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function a(t){if("string"==typeof t){var e,i,n=t.split("");for(e=0,i=n.length;e<i;e++)n[e]=(255&n[e].charCodeAt(0))>>>0;t=n}for(var r,o=1,a=0,s=t.length,c=0;0<s;){s-=r=1024<s?1024:s;do{a+=o+=t[c++]}while(--r);o%=65521,a%=65521}return(a<<16|o)>>>0}function s(e,i){this.index="number"==typeof i?i:0,this.i=0,this.buffer=e instanceof(o?Uint8Array:Array)?e:new(o?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}s.prototype.f=function(){var t,e=this.buffer,i=e.length,n=new(o?Uint8Array:Array)(i<<1);if(o)n.set(e);else for(t=0;t<i;++t)n[t]=e[t];return this.buffer=n},s.prototype.d=function(t,e,i){var n,r=this.buffer,o=this.index,a=this.i,s=r[o];if(i&&1<e&&(t=8<e?(f[255&t]<<24|f[t>>>8&255]<<16|f[t>>>16&255]<<8|f[t>>>24&255])>>32-e:f[t]>>8-e),8>e+a)s=s<<e|t,a+=e;else for(n=0;n<e;++n)s=s<<1|t>>e-n-1&1,8==++a&&(a=0,r[o++]=f[s],s=0,o===r.length&&(r=this.f()));r[o]=s,this.buffer=r,this.i=a,this.index=o},s.prototype.finish=function(){var t,e=this.buffer,i=this.index;return 0<this.i&&(e[i]<<=8-this.i,e[i]=f[e[i]],i++),o?t=e.subarray(0,i):(e.length=i,t=e),t};var c,l=new(o?Uint8Array:Array)(256);for(c=0;256>c;++c){for(var u=_=c,h=7,_=_>>>1;_;_>>>=1)u<<=1,u|=1&_,--h;l[c]=(u<<h&255)>>>0}var f=l;function p(t){this.buffer=new(o?Uint16Array:Array)(2*t),this.length=0}function d(t){var e,i,n,r,a,s,c,l,u,h=t.length,_=0,f=Number.POSITIVE_INFINITY;for(l=0;l<h;++l)t[l]>_&&(_=t[l]),t[l]<f&&(f=t[l]);for(e=1<<_,i=new(o?Uint32Array:Array)(e),n=1,r=0,a=2;n<=_;){for(l=0;l<h;++l)if(t[l]===n){for(s=0,c=r,u=0;u<n;++u)s=s<<1|1&c,c>>=1;for(u=s;u<e;u+=a)i[u]=n<<16|l;++r}++n,r<<=1,a<<=1}return[i,_,f]}function m(t,e){this.h=g,this.w=0,this.input=t,this.b=0,e&&(e.lazy&&(this.w=e.lazy),"number"==typeof e.compressionType&&(this.h=e.compressionType),e.outputBuffer&&(this.a=o&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.b=e.outputIndex)),this.a||(this.a=new(o?Uint8Array:Array)(32768))}p.prototype.getParent=function(t){return 2*((t-2)/4|0)},p.prototype.push=function(t,e){var i,n,r,o=this.buffer;for(i=this.length,o[this.length++]=e,o[this.length++]=t;0<i&&(n=this.getParent(i),o[i]>o[n]);)r=o[i],o[i]=o[n],o[n]=r,r=o[i+1],o[i+1]=o[n+1],o[n+1]=r,i=n;return this.length},p.prototype.pop=function(){var t,e,i,n,r,o=this.buffer;for(e=o[0],t=o[1],this.length-=2,o[0]=o[this.length],o[1]=o[this.length+1],r=0;!((n=2*r+2)>=this.length)&&(n+2<this.length&&o[n+2]>o[n]&&(n+=2),o[n]>o[r]);)i=o[r],o[r]=o[n],o[n]=i,i=o[r+1],o[r+1]=o[n+1],o[n+1]=i,r=n;return{index:t,value:e,length:this.length}};var v,g=2,y={NONE:0,r:1,j:g,N:3},x=[];for(v=0;288>v;v++)switch(i){case 143>=v:x.push([v+48,8]);break;case 255>=v:x.push([v-144+400,9]);break;case 279>=v:x.push([v-256+0,7]);break;case 287>=v:x.push([v-280+192,8]);break;default:t("invalid literal: "+v)}function S(t,e){this.length=t,this.G=e}function b(){var e=C;switch(i){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:t("invalid length: "+e)}}m.prototype.n=function(){var n,r,a,c,l=this.input;switch(this.h){case 0:for(a=0,c=l.length;a<c;){var u,h,_,f=r=o?l.subarray(a,a+65535):l.slice(a,a+65535),p=(a+=r.length)===c,d=e,m=e,v=this.a,y=this.b;if(o){for(v=new Uint8Array(this.a.buffer);v.length<=y+f.length+5;)v=new Uint8Array(v.length<<1);v.set(this.a)}if(u=p?1:0,v[y++]=0|u,_=65536+~(h=f.length)&65535,v[y++]=255&h,v[y++]=h>>>8&255,v[y++]=255&_,v[y++]=_>>>8&255,o)v.set(f,y),y+=f.length,v=v.subarray(0,y);else{for(d=0,m=f.length;d<m;++d)v[y++]=f[d];v.length=y}this.b=y,this.a=v}break;case 1:var S=new s(new Uint8Array(this.a.buffer),this.b);S.d(1,1,i),S.d(1,2,i);var b,C,A,T=E(this,l);for(b=0,C=T.length;b<C;b++)if(A=T[b],s.prototype.d.apply(S,x[A]),256<A)S.d(T[++b],T[++b],i),S.d(T[++b],5),S.d(T[++b],T[++b],i);else if(256===A)break;this.a=S.finish(),this.b=this.a.length;break;case g:var w,R,D,M,O,B,N,L,F,z,V,k,U,G,H,j=new s(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(w=g,j.d(1,1,i),j.d(w,2,i),R=E(this,l),N=I(B=P(this.L,15)),F=I(L=P(this.K,7)),D=286;257<D&&0===B[D-1];D--);for(M=30;1<M&&0===L[M-1];M--);var X,Y,K,J,Q,Z,$=D,tt=M,et=new(o?Uint32Array:Array)($+tt),it=new(o?Uint32Array:Array)(316),nt=new(o?Uint8Array:Array)(19);for(X=Y=0;X<$;X++)et[Y++]=B[X];for(X=0;X<tt;X++)et[Y++]=L[X];if(!o)for(X=0,J=nt.length;X<J;++X)nt[X]=0;for(X=Q=0,J=et.length;X<J;X+=Y){for(Y=1;X+Y<J&&et[X+Y]===et[X];++Y);if(K=Y,0===et[X])if(3>K)for(;0<K--;)it[Q++]=0,nt[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(it[Q++]=17,it[Q++]=Z-3,nt[17]++):(it[Q++]=18,it[Q++]=Z-11,nt[18]++),K-=Z;else if(it[Q++]=et[X],nt[et[X]]++,3>--K)for(;0<K--;)it[Q++]=et[X],nt[et[X]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),it[Q++]=16,it[Q++]=Z-3,nt[16]++,K-=Z}for(n=o?it.subarray(0,Q):it.slice(0,Q),z=P(nt,7),G=0;19>G;G++)q[G]=z[W[G]];for(O=19;4<O&&0===q[O-1];O--);for(V=I(z),j.d(D-257,5,i),j.d(M-1,5,i),j.d(O-4,4,i),G=0;G<O;G++)j.d(q[G],3,i);for(G=0,H=n.length;G<H;G++)if(k=n[G],j.d(V[k],z[k],i),16<=k){switch(G++,k){case 16:U=2;break;case 17:U=3;break;case 18:U=7;break;default:t("invalid code: "+k)}j.d(n[G],U,i)}var rt,ot,at,st,ct,lt,ut,ht,_t=[N,B],ft=[F,L];for(ct=_t[0],lt=_t[1],ut=ft[0],ht=ft[1],rt=0,ot=R.length;rt<ot;++rt)if(at=R[rt],j.d(ct[at],lt[at],i),256<at)j.d(R[++rt],R[++rt],i),st=R[++rt],j.d(ut[st],ht[st],i),j.d(R[++rt],R[++rt],i);else if(256===at)break;this.a=j.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var C,A,T=[];for(C=3;258>=C;C++)A=b(),T[C]=A[2]<<24|A[1]<<16|A[0];var w=o?new Uint32Array(T):T;function E(n,r){function a(e,n){var r,o,a,s,c=e.G,l=[],u=0;switch(r=w[e.length],l[u++]=65535&r,l[u++]=r>>16&255,l[u++]=r>>24,i){case 1===c:o=[0,c-1,0];break;case 2===c:o=[1,c-2,0];break;case 3===c:o=[2,c-3,0];break;case 4===c:o=[3,c-4,0];break;case 6>=c:o=[4,c-5,1];break;case 8>=c:o=[5,c-7,1];break;case 12>=c:o=[6,c-9,2];break;case 16>=c:o=[7,c-13,2];break;case 24>=c:o=[8,c-17,3];break;case 32>=c:o=[9,c-25,3];break;case 48>=c:o=[10,c-33,4];break;case 64>=c:o=[11,c-49,4];break;case 96>=c:o=[12,c-65,5];break;case 128>=c:o=[13,c-97,5];break;case 192>=c:o=[14,c-129,6];break;case 256>=c:o=[15,c-193,6];break;case 384>=c:o=[16,c-257,7];break;case 512>=c:o=[17,c-385,7];break;case 768>=c:o=[18,c-513,8];break;case 1024>=c:o=[19,c-769,8];break;case 1536>=c:o=[20,c-1025,9];break;case 2048>=c:o=[21,c-1537,9];break;case 3072>=c:o=[22,c-2049,10];break;case 4096>=c:o=[23,c-3073,10];break;case 6144>=c:o=[24,c-4097,11];break;case 8192>=c:o=[25,c-6145,11];break;case 12288>=c:o=[26,c-8193,12];break;case 16384>=c:o=[27,c-12289,12];break;case 24576>=c:o=[28,c-16385,13];break;case 32768>=c:o=[29,c-24577,13];break;default:t("invalid distance")}for(r=o,l[u++]=r[0],l[u++]=r[1],l[u++]=r[2],a=0,s=l.length;a<s;++a)v[g++]=l[a];x[l[0]]++,b[l[3]]++,y=e.length+n-1,p=null}var s,c,l,u,h,_,f,p,d,m={},v=o?new Uint16Array(2*r.length):[],g=0,y=0,x=new(o?Uint32Array:Array)(286),b=new(o?Uint32Array:Array)(30),C=n.w;if(!o){for(l=0;285>=l;)x[l++]=0;for(l=0;29>=l;)b[l++]=0}for(x[256]=1,s=0,c=r.length;s<c;++s){for(l=h=0,u=3;l<u&&s+l!==c;++l)h=h<<8|r[s+l];if(m[h]===e&&(m[h]=[]),_=m[h],!(0<y--)){for(;0<_.length&&32768<s-_[0];)_.shift();if(s+3>=c){for(p&&a(p,-1),l=0,u=c-s;l<u;++l)d=r[s+l],v[g++]=d,++x[d];break}if(0<_.length){var A=e,T=e,E=0,P=e,I=e,R=e,D=r.length,M=(I=0,_.length);t:for(;I<M;I++){if(A=_[M-I-1],P=3,3<E){for(R=E;3<R;R--)if(r[A+R-1]!==r[s+R-1])continue t;P=E}for(;258>P&&s+P<D&&r[A+P]===r[s+P];)++P;if(P>E&&(T=A,E=P),258===P)break}f=new S(E,s-T),p?p.length<f.length?(d=r[s-1],v[g++]=d,++x[d],a(f,0)):a(p,-1):f.length<C?p=f:a(f,0)}else p?a(p,-1):(d=r[s],v[g++]=d,++x[d])}_.push(s)}return v[g++]=256,x[256]++,n.L=x,n.K=b,o?v.subarray(0,g):v}function P(t,e){function i(t){var e=C[t][A[t]];e===g?(i(t+1),i(t+1)):--S[e],++A[t]}var n,r,a,s,c,l=t.length,u=new p(572),h=new(o?Uint8Array:Array)(l);if(!o)for(s=0;s<l;s++)h[s]=0;for(s=0;s<l;++s)0<t[s]&&u.push(s,t[s]);if(n=Array(u.length/2),r=new(o?Uint32Array:Array)(u.length/2),1===n.length)return h[u.pop().index]=1,h;for(s=0,c=u.length/2;s<c;++s)n[s]=u.pop(),r[s]=n[s].value;var _,f,d,m,v,g=r.length,y=new(o?Uint16Array:Array)(e),x=new(o?Uint8Array:Array)(e),S=new(o?Uint8Array:Array)(g),b=Array(e),C=Array(e),A=Array(e),T=(1<<e)-g,w=1<<e-1;for(y[e-1]=g,f=0;f<e;++f)T<w?x[f]=0:(x[f]=1,T-=w),T<<=1,y[e-2-f]=(y[e-1-f]/2|0)+g;for(y[0]=x[0],b[0]=Array(y[0]),C[0]=Array(y[0]),f=1;f<e;++f)y[f]>2*y[f-1]+x[f]&&(y[f]=2*y[f-1]+x[f]),b[f]=Array(y[f]),C[f]=Array(y[f]);for(_=0;_<g;++_)S[_]=e;for(d=0;d<y[e-1];++d)b[e-1][d]=r[d],C[e-1][d]=d;for(_=0;_<e;++_)A[_]=0;for(1===x[e-1]&&(--S[0],++A[e-1]),f=e-2;0<=f;--f){for(m=_=0,v=A[f+1],d=0;d<y[f];d++)(m=b[f+1][v]+b[f+1][v+1])>r[_]?(b[f][d]=m,C[f][d]=g,v+=2):(b[f][d]=r[_],C[f][d]=_,++_);A[f]=0,1===x[f]&&i(f)}for(a=S,s=0,c=n.length;s<c;++s)h[n[s].index]=a[s];return h}function I(e){var i,n,r,a,s=new(o?Uint16Array:Array)(e.length),c=[],l=[],u=0;for(i=0,n=e.length;i<n;i++)c[e[i]]=1+(0|c[e[i]]);for(i=1,n=16;i<=n;i++)l[i]=u,(u+=0|c[i])>1<<i&&t("overcommitted"),u<<=1;for(65536>u&&t("undercommitted"),i=0,n=e.length;i<n;i++)for(u=l[e[i]],l[e[i]]+=1,r=s[i]=0,a=e[i];r<a;r++)s[i]=s[i]<<1|1&u,u>>>=1;return s}function R(t,e){this.input=t,this.a=new(o?Uint8Array:Array)(32768),this.h=D.j;var i,n={};for(i in!e&&(e={})||"number"!=typeof e.compressionType||(this.h=e.compressionType),e)n[i]=e[i];n.outputBuffer=this.a,this.z=new m(this.input,n)}var D=y;function M(e,i){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=o?new Uint8Array(e):e,this.s=!1,this.m=B,this.B=!1,!i&&(i={})||(i.index&&(this.c=i.index),i.bufferSize&&(this.l=i.bufferSize),i.bufferType&&(this.m=i.bufferType),i.resize&&(this.B=i.resize)),this.m){case O:this.b=32768,this.a=new(o?Uint8Array:Array)(32768+this.l+258);break;case B:this.b=0,this.a=new(o?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}R.prototype.n=function(){var e,i,n,r,s,c,l,u=0;switch(l=this.a,e=ut){case ut:i=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(n=i<<4|e,l[u++]=n,e){case ut:switch(this.h){case D.NONE:s=0;break;case D.r:s=1;break;case D.j:s=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return r=s<<6|0,l[u++]=r|31-(256*n+r)%31,c=a(this.input),this.z.b=u,u=(l=this.z.n()).length,o&&((l=new Uint8Array(l.buffer)).length<=u+4&&(this.a=new Uint8Array(l.length+4),this.a.set(l),l=this.a),l=l.subarray(0,u+4)),l[u++]=c>>24&255,l[u++]=c>>16&255,l[u++]=c>>8&255,l[u++]=255&c,l},r("Zlib.Deflate",R),r("Zlib.Deflate.compress",(function(t,e){return new R(t,e).n()})),r("Zlib.Deflate.CompressionType",D),r("Zlib.Deflate.CompressionType.NONE",D.NONE),r("Zlib.Deflate.CompressionType.FIXED",D.r),r("Zlib.Deflate.CompressionType.DYNAMIC",D.j);var O=0,B=1,N={D:O,C:B};M.prototype.p=function(){for(;!this.s;){var n=tt(this,3);switch(1&n&&(this.s=i),n>>>=1){case 0:var r=this.input,a=this.c,s=this.a,c=this.b,l=e,u=e,h=e,_=s.length,f=e;switch(this.e=this.g=0,(l=r[a++])===e&&t(Error("invalid uncompressed block header: LEN (first byte)")),u=l,(l=r[a++])===e&&t(Error("invalid uncompressed block header: LEN (second byte)")),u|=l<<8,(l=r[a++])===e&&t(Error("invalid uncompressed block header: NLEN (first byte)")),h=l,(l=r[a++])===e&&t(Error("invalid uncompressed block header: NLEN (second byte)")),u===~(h|=l<<8)&&t(Error("invalid uncompressed block header: length verify")),a+u>r.length&&t(Error("input buffer is broken")),this.m){case O:for(;c+u>s.length;){if(u-=f=_-c,o)s.set(r.subarray(a,a+f),c),c+=f,a+=f;else for(;f--;)s[c++]=r[a++];this.b=c,s=this.f(),c=this.b}break;case B:for(;c+u>s.length;)s=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(o)s.set(r.subarray(a,a+u),c),c+=u,a+=u;else for(;u--;)s[c++]=r[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(Q,$);break;case 2:it(this);break;default:t(Error("unknown BTYPE: "+n))}}return this.t()};var L,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=o?new Uint16Array(z):z,k=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],U=o?new Uint16Array(k):k,G=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],H=o?new Uint8Array(G):G,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=o?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=o?new Uint8Array(q):q,Y=new(o?Uint8Array:Array)(288);for(L=0,F=Y.length;L<F;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,J,Q=d(Y),Z=new(o?Uint8Array:Array)(30);for(K=0,J=Z.length;K<J;++K)Z[K]=5;var $=d(Z);function tt(i,n){for(var r,o=i.g,a=i.e,s=i.input,c=i.c;a<n;)(r=s[c++])===e&&t(Error("input buffer is broken")),o|=r<<a,a+=8;return r=o&(1<<n)-1,i.g=o>>>n,i.e=a-n,i.c=c,r}function et(i,n){for(var r,o,a,s=i.g,c=i.e,l=i.input,u=i.c,h=n[0],_=n[1];c<_;)(r=l[u++])===e&&t(Error("input buffer is broken")),s|=r<<c,c+=8;return a=(o=h[s&(1<<_)-1])>>>16,i.g=s>>a,i.e=c-a,i.c=u,65535&o}function it(t){function e(t,e,i){var n,r,o,a;for(a=0;a<t;)switch(n=et(this,e)){case 16:for(o=3+tt(this,2);o--;)i[a++]=r;break;case 17:for(o=3+tt(this,3);o--;)i[a++]=0;r=0;break;case 18:for(o=11+tt(this,7);o--;)i[a++]=0;r=0;break;default:r=i[a++]=n}return i}var i,n,r,a,s=tt(t,5)+257,c=tt(t,5)+1,l=tt(t,4)+4,u=new(o?Uint8Array:Array)(V.length);for(a=0;a<l;++a)u[V[a]]=tt(t,3);i=d(u),n=new(o?Uint8Array:Array)(s),r=new(o?Uint8Array:Array)(c),t.o(d(e.call(t,s,i,n)),d(e.call(t,c,i,r)))}function nt(e,i){var n,r;switch(this.input=e,this.c=0,!i&&(i={})||(i.index&&(this.c=i.index),i.verify&&(this.M=i.verify)),n=e[this.c++],r=e[this.c++],15&n){case ut:this.method=ut;break;default:t(Error("unsupported compression method"))}0!=((n<<8)+r)%31&&t(Error("invalid fcheck flag:"+((n<<8)+r)%31)),32&r&&t(Error("fdict flag is not supported")),this.A=new M(e,{index:this.c,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}M.prototype.o=function(t,e){var i=this.a,n=this.b;this.u=t;for(var r,o,a,s,c=i.length-258;256!==(r=et(this,t));)if(256>r)n>=c&&(this.b=n,i=this.f(),n=this.b),i[n++]=r;else for(s=U[o=r-257],0<H[o]&&(s+=tt(this,H[o])),r=et(this,e),a=W[r],0<X[r]&&(a+=tt(this,X[r])),n>=c&&(this.b=n,i=this.f(),n=this.b);s--;)i[n]=i[n++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.I=function(t,e){var i=this.a,n=this.b;this.u=t;for(var r,o,a,s,c=i.length;256!==(r=et(this,t));)if(256>r)n>=c&&(c=(i=this.f()).length),i[n++]=r;else for(s=U[o=r-257],0<H[o]&&(s+=tt(this,H[o])),r=et(this,e),a=W[r],0<X[r]&&(a+=tt(this,X[r])),n+s>c&&(c=(i=this.f()).length);s--;)i[n]=i[n++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.f=function(){var t,e,i=new(o?Uint8Array:Array)(this.b-32768),n=this.b-32768,r=this.a;if(o)i.set(r.subarray(32768,i.length));else for(t=0,e=i.length;t<e;++t)i[t]=r[t+32768];if(this.k.push(i),this.q+=i.length,o)r.set(r.subarray(n,n+32768));else for(t=0;32768>t;++t)r[t]=r[n+t];return this.b=32768,r},M.prototype.J=function(t){var e,i,n,r=this.input.length/this.c+1|0,a=this.input,s=this.a;return t&&("number"==typeof t.v&&(r=t.v),"number"==typeof t.F&&(r+=t.F)),i=2>r?(n=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+n:s.length<<1:s.length*r,o?(e=new Uint8Array(i)).set(s):e=s,this.a=e},M.prototype.t=function(){var t,e,i,n,r,a=0,s=this.a,c=this.k,l=new(o?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return o?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(e=0,i=c.length;e<i;++e)for(n=0,r=(t=c[e]).length;n<r;++n)l[a++]=t[n];for(e=32768,i=this.b;e<i;++e)l[a++]=s[e];return this.k=[],this.buffer=l},M.prototype.H=function(){var t,e=this.b;return o?this.B?(t=new Uint8Array(e)).set(this.a.subarray(0,e)):t=this.a.subarray(0,e):(this.a.length>e&&(this.a.length=e),t=this.a),this.buffer=t},nt.prototype.p=function(){var e,i=this.input;return e=this.A.p(),this.c=this.A.c,this.M&&(i[this.c++]<<24|i[this.c++]<<16|i[this.c++]<<8|i[this.c++])>>>0!==a(e)&&t(Error("invalid adler-32 checksum")),e},r("Zlib.Inflate",nt),r("Zlib.Inflate.BufferType",N),N.ADAPTIVE=N.C,N.BLOCK=N.D,r("Zlib.Inflate.prototype.decompress",nt.prototype.p);var rt,ot,at=new(o?Uint8Array:Array)(288);for(rt=0,ot=at.length;rt<ot;++rt)at[rt]=143>=rt?8:255>=rt?9:279>=rt?7:8;d(at);var st,ct,lt=new(o?Uint8Array:Array)(30);for(st=0,ct=lt.length;st<ct;++st)lt[st]=5;d(lt);var ut=8}).call(But);var Nut=But.Zlib;Nut.Deflate=Nut.Deflate,Nut.Deflate.compress=Nut.Deflate.compress,Nut.Inflate=Nut.Inflate,Nut.Inflate.BufferType=Nut.Inflate.BufferType,Nut.Inflate.prototype.decompress=Nut.Inflate.prototype.decompress;for(var Lut=function(){function t(t){var e,i=this;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};for(var n=0,r=0,o=0;;){o=this.readUInt32();var a=function(){var t=[];for(n=0;n<4;++n)t.push(String.fromCharCode(i.data[i.pos++]));return t}.call(this).join("");switch(a){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(o);break;case"fcTL":e&&this.animation.frames.push(e),this.pos+=4,e={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};var s=this.readUInt16(),c=this.readUInt16()||100;e.delay=1e3*s/c,e.disposeOp=this.data[this.pos++],e.blendOp=this.data[this.pos++],e.data=[];break;case"IDAT":case"fdAT":for("fdAT"===a&&(this.pos+=4,o-=4),t=(null!=e?e.data:void 0)||this.imgData,n=0;o>=0?n<o:n>o;o>=0?++n:--n)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(o);var l=255-this.transparency.indexed.length;if(l>0)for(r=0;l>=0?r<l:r>l;l>=0?++r:--r)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(o)[0];break;case 2:this.transparency.rgb=this.read(o)}break;case"tEXt":var u=this.read(o),h=u.indexOf(0),_=String.fromCharCode.apply(String,u.slice(0,h));this.text[_]=String.fromCharCode.apply(String,u.slice(h+1));break;case"IEND":e&&this.animation.frames.push(e),this.colors=function(){switch(i.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this);var f=this.colorType;this.hasAlphaChannel=4===f||6===f;var p=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*p,this.colorSpace=function(){switch(i.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=o}if(this.pos+=4,this.pos>this.data.length)throw new Error(F(6017))}}var e=t.prototype;return e.read=function(t){var e=0,i=[];for(e=0;t>=0?e<t:e>t;t>=0?++e:--e)i.push(this.data[this.pos++]);return i},e.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},e.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},e.decodePixels=function(t){if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);t=new Nut.Inflate(t,{index:0,verify:!1}).decompress();for(var e=this.pixelBitlength/8,i=e*this.width,n=new Uint8Array(i*this.height),r=t.length,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,b=0,C=0;a<r;){switch(t[a++]){case 0:for(u=h=0;h<i;u=h+=1)n[s++]=t[a++];break;case 1:for(u=_=0;_<i;u=_+=1)c=t[a++],m=u<e?0:n[s-e],n[s++]=(c+m)%256;break;case 2:for(u=f=0;f<i;u=f+=1)c=t[a++],l=(u-u%e)/e,b=o&&n[(o-1)*i+l*e+u%e],n[s++]=(b+c)%256;break;case 3:for(u=p=0;p<i;u=p+=1)c=t[a++],l=(u-u%e)/e,m=u<e?0:n[s-e],b=o&&n[(o-1)*i+l*e+u%e],n[s++]=(c+Math.floor((m+b)/2))%256;break;case 4:for(u=d=0;d<i;u=d+=1)c=t[a++],l=(u-u%e)/e,m=u<e?0:n[s-e],0===o?b=C=0:(b=n[(o-1)*i+l*e+u%e],C=l&&n[(o-1)*i+(l-1)*e+u%e]),v=m+b-C,g=Math.abs(v-m),x=Math.abs(v-b),S=Math.abs(v-C),y=g<=x&&g<=S?m:x<=S?b:C,n[s++]=(c+y)%256;break;default:throw new Error(F(6018,t[a-1]))}o++}return n},e.copyToImageData=function(t,e){var i,n=this.hasAlphaChannel,r=this.colors;this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),r=4,n=!0);var o=t.data||t,a=o.length,s=i||e,c=0,l=0,u=0,h=0;if(1===r)for(;c<a;)u=i?4*e[c/4]:l,h=s[u++],o[c++]=h,o[c++]=h,o[c++]=h,o[c++]=n?s[u++]:255,l=u;else for(;c<a;)u=i?4*e[c/4]:l,o[c++]=s[u++],o[c++]=s[u++],o[c++]=s[u++],o[c++]=n?s[u++]:255,l=u},e.decodePalette=function(){for(var t=this.palette,e=this.transparency.indexed||[],i=new Uint8Array((e.length||0)+t.length),n=0,r=0,o=0,a=0,s=0,c=t.length;s<c;a=s+=3)i[n++]=t[a],i[n++]=t[a+1],i[n++]=t[a+2],o=e[r++],i[n++]=null!=o?o:255;return i},e.render=function(t){t.width=this.width,t.height=this.height;var e=t.getContext("2d"),i=e.createImageData(this.width,this.height);return this.copyToImageData(i,this.decodePixels(null)),e.putImageData(i,0,0)},t}(),Fut=function(){function t(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}var e=t.prototype;return e.getUint8=function(t){return this._tiffData[t]},e.getUint16=function(t){return this._littleEndian?this._tiffData[t+1]<<8|this._tiffData[t]:this._tiffData[t]<<8|this._tiffData[t+1]},e.getUint32=function(t){var e=this._tiffData;return this._littleEndian?e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]:e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]},e.checkLittleEndian=function(){var t=this.getUint16(0);if(18761===t)this._littleEndian=!0;else{if(19789!==t)throw console.log(t),TypeError(F(6019));this._littleEndian=!1}return this._littleEndian},e.hasTowel=function(){if(42!==this.getUint16(2))throw RangeError(F(6020));return!0},e.getFieldTypeName=function(t){return t in Vut?Vut[t]:null},e.getFieldTagName=function(t){return t in zut?zut[t]:(I(6021,t),"Tag"+t)},e.getFieldTypeLength=function(t){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(t)?1:-1!==["SHORT","SSHORT"].indexOf(t)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(t)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(t)?8:0},e.getFieldValues=function(t,e,i,n){var r=[],o=this.getFieldTypeLength(e);if(o*i<=4)!1===this._littleEndian?r.push(n>>>8*(4-o)):r.push(n);else for(var a=0;a<i;a++){var s=o*a;o>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(e)?(r.push(this.getUint32(n+s)),r.push(this.getUint32(n+s+4))):I(8e3):r.push(this.getBytes(o,n+s))}return"ASCII"===e&&r.forEach((function(t,e,i){i[e]=String.fromCharCode(t)})),r},e.getBytes=function(t,e){if(t<=0)I(8001);else{if(t<=1)return this.getUint8(e);if(t<=2)return this.getUint16(e);if(t<=3)return this.getUint32(e)>>>8;if(t<=4)return this.getUint32(e);I(8002)}return 0},e.getBits=function(t,e,i){i=i||0;var n=e+Math.floor(i/8),r=i+t,o=32-t,a=0,s=0;return r<=0?I(6023):r<=8?(a=24+i,s=this.getUint8(n)):r<=16?(a=16+i,s=this.getUint16(n)):r<=32?(a=i,s=this.getUint32(n)):I(6022),{bits:s<<a>>>o,byteOffset:n+Math.floor(r/8),bitOffset:r%8}},e.parseFileDirectory=function(t){var e=this.getUint16(t),i=[],n=0,r=0;for(n=t+2,r=0;r<e;n+=12,r++){var o=this.getUint16(n),a=this.getUint16(n+2),s=this.getUint32(n+4),c=this.getUint32(n+8),l=this.getFieldTagName(o),u=this.getFieldTypeName(a),h=this.getFieldValues(l,u,s,c);i[l]={type:u,values:h}}this._fileDirectories.push(i);var _=this.getUint32(n);0!==_&&this.parseFileDirectory(_)},e.clampColorSample=function(t,e){var i=Math.pow(2,8-e);return Math.floor(t*i+(i-1))},e.parseTIFF=function(t,e){var i=this;if(e=e||document.createElement("canvas"),this._tiffData=t,this._canvas=e,this.checkLittleEndian(),this.hasTowel()){var n=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(n);var r=this._fileDirectories[0],o=r.ImageWidth.values[0],a=r.ImageLength.values[0];this._canvas.width=o,this._canvas.height=a;var s=[],c=r.Compression?r.Compression.values[0]:1,l=r.SamplesPerPixel.values[0],u=[],h=0,_=!1;r.BitsPerSample.values.forEach((function(t,e){u[e]={bitsPerSample:t,hasBytesPerSample:!1,bytesPerSample:void 0},t%8==0&&(u[e].hasBytesPerSample=!0,u[e].bytesPerSample=t/8),h+=t}),this);var f=0;h%8==0&&(_=!0,f=h/8);var p,d=r.StripOffsets.values,m=d.length;if(r.StripByteCounts)p=r.StripByteCounts.values;else{if(I(8003),1!==m)throw Error(F(6024));p=[Math.ceil(o*a*h/8)]}for(var v=1,g=1,y=0;y<m;y++){var x=d[y];s[y]=[];for(var S=p[y],b=0,C=0,A=1,T=!0,w=[],E=0,P=0,R=0;b<S;b+=A)switch(c){case 1:w=[];for(var D=0;D<l;D++){var M=u[D];if(!M.hasBytesPerSample){var O=this.getBits(M.bitsPerSample,x+b,C);throw w.push(O.bits),b=O.byteOffset-x,C=O.bitOffset,RangeError(F(6025))}var B=M.bytesPerSample*D;w.push(this.getBytes(M.bytesPerSample,x+b+B))}if(s[y].push(w),!_)throw A=0,RangeError(F(6026));A=f;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(T){T=!1;var N=this.getUint8(x+b);N>=0&&N<=127?v=N+1:N>=-127&&N<=-1?g=1-N:T=!0}else{for(var L=this.getUint8(x+b),z=0;z<g;z++){var V=u[P];if(!V.hasBytesPerSample)throw RangeError(F(6025));R=R<<8*E|L,++E===V.bytesPerSample&&(w.push(R),R=E=0,P++),P===l&&(s[y].push(w),w=[],P=0)}0==--v&&(T=!0)}A=1}}if(e.getContext){var k=this._canvas.getContext("2d");k.fillStyle="rgba(255, 255, 255, 0)";var U=r.RowsPerStrip?r.RowsPerStrip.values[0]:a,G=s.length,H=a%U,j=0===H?U:H,W=U,q=0,X=r.PhotometricInterpretation.values[0],Y=[],K=0;r.ExtraSamples&&(K=(Y=r.ExtraSamples.values).length);var J=[],Q=0;r.ColorMap&&(J=r.ColorMap.values,Q=Math.pow(2,u[0].bitsPerSample));for(var Z=0;Z<G;Z++){Z+1===G&&(W=j);for(var $=s[Z].length,tt=q*Z,et=0,it=0;et<W&&it<$;et++)for(var nt=0;nt<o;nt++,it++){var rt=s[Z][it],ot=0,at=0,st=0,ct=1;if(K>0)for(var lt=0;lt<K;lt++)if(1===Y[lt]||2===Y[lt]){ct=rt[3+lt]/256;break}!function(){switch(X){case 0:var t=0;u[0].hasBytesPerSample&&(t=Math.pow(16,2*u[0].bytesPerSample)),rt.forEach((function(e,i,n){n[i]=t-e}));case 1:ot=at=st=i.clampColorSample(rt[0],u[0].bitsPerSample);break;case 2:ot=i.clampColorSample(rt[0],u[0].bitsPerSample),at=i.clampColorSample(rt[1],u[1].bitsPerSample),st=i.clampColorSample(rt[2],u[2].bitsPerSample);break;case 3:if(void 0===J)throw Error(F(6027));var e=rt[0];ot=i.clampColorSample(J[e],16),at=i.clampColorSample(J[Q+e],16),st=i.clampColorSample(J[2*Q+e],16);break;default:throw RangeError(F(6028,X))}}(),k.fillStyle="rgba("+ot+", "+at+", "+st+", "+ct+")",k.fillRect(nt,tt+et,1,1)}q=W}}return this._canvas}},t}(),zut={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},Vut={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},kut=new Array(123),Uut=0;Uut<123;++Uut)kut[Uut]=64;for(var Gut=0;Gut<64;++Gut)kut["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Gut)]=Gut;var Hut={name:"Jacob__Codec__Base64",decode:function(t){var e,i,n,r,o,a,s=[],c=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<t.length;)e=kut[t.charCodeAt(c++)]<<2|(r=kut[t.charCodeAt(c++)])>>4,i=(15&r)<<4|(o=kut[t.charCodeAt(c++)])>>2,n=(3&o)<<6|(a=kut[t.charCodeAt(c++)]),s.push(String.fromCharCode(e)),64!==o&&s.push(String.fromCharCode(i)),64!==a&&s.push(String.fromCharCode(n));return s.join("")},decodeAsArray:function(t,e){var i,n,r,o=this.decode(t),a=[];for(i=0,r=o.length/e;i<r;i++)for(a[i]=0,n=e-1;n>=0;--n)a[i]+=o.charCodeAt(i*e+n)<<8*n;return a}},jut=function(t){this.data=t,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(jut.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};jut.gunzip=function(t){return t.constructor===Array||t.constructor,new jut(t).gunzip()[0][0]},jut.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},jut.LITERALS=288,jut.NAMEMAX=256,jut.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],jut.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],jut.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],jut.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],jut.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],jut.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],jut.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},jut.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},jut.prototype.byteAlign=function(){this.bb=1},jut.prototype.readBit=function(){var t;return this.bits++,t=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),t=1&this.bb,this.bb=this.bb>>1|128),t},jut.prototype.readBits=function(t){for(var e=0,i=t;i--;)e=e<<1|this.readBit();return t&&(e=jut.bitReverse[e]>>8-t),e},jut.prototype.flushBuffer=function(){this.bIdx=0},jut.prototype.addBuffer=function(t){this.buf32k[this.bIdx++]=t,this.outputArr.push(String.fromCharCode(t)),32768===this.bIdx&&(this.bIdx=0)},jut.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},jut.prototype.Rec=function(){var t,e=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(t=this.IsPat())>=0)e.b0=t;else if(e.b0=32768,this.Rec())return-1;if((t=this.IsPat())>=0)e.b1=t,e.jump=null;else if(e.b1=32768,e.jump=this.Places[this.treepos],e.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},jut.prototype.CreateTree=function(t,e,i){var n;for(this.Places=t,this.treepos=0,this.flens=i,this.fmax=e,n=0;n<17;n++)this.fpos[n]=0;return this.len=0,this.Rec()?-1:0},jut.prototype.DecodeValue=function(t){for(var e,i,n=0,r=t[n];;)if(this.readBit()){if(!(32768&r.b1))return r.b1;for(r=r.jump,e=t.length,i=0;i<e;i++)if(t[i]===r){n=i;break}}else{if(!(32768&r.b0))return r.b0;r=t[++n]}return-1},jut.prototype.DeflateLoop=function(){var t,e,i;do{var n,r;if(t=this.readBit(),0===(e=this.readBits(2)))for(this.byteAlign(),n=this.readByte(),n|=this.readByte()<<8,r=this.readByte(),65535&(n^~(r|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");n--;)o=this.readByte(),this.addBuffer(o);else if(1===e)for(;;)if((a=jut.bitReverse[this.readBits(7)]>>1)>23?(a=a<<1|this.readBit())>199?a=(a-=128)<<1|this.readBit():(a-=48)>143&&(a+=136):a+=256,a<256)this.addBuffer(a);else{if(256===a)break;for(a-=257,p=this.readBits(jut.cplext[a])+jut.cplens[a],a=jut.bitReverse[this.readBits(5)]>>3,jut.cpdext[a]>8?(d=this.readBits(8),d|=this.readBits(jut.cpdext[a]-8)<<8):d=this.readBits(jut.cpdext[a]),d+=jut.cpdist[a],a=0;a<p;a++){var o=this.buf32k[this.bIdx-d&32767];this.addBuffer(o)}}else if(2===e){var a,s,c,l,u,h=new Array(320);for(c=257+this.readBits(5),l=1+this.readBits(5),u=4+this.readBits(4),a=0;a<19;a++)h[a]=0;for(a=0;a<u;a++)h[jut.border[a]]=this.readBits(3);for(p=this.distanceTree.length,i=0;i<p;i++)this.distanceTree[i]=new jut.HufNode;if(this.CreateTree(this.distanceTree,19,h,0))return this.flushBuffer(),1;for(s=c+l,i=0;i<s;)if((a=this.DecodeValue(this.distanceTree))<16)h[i++]=a;else if(16===a){var _;if(i+(a=3+this.readBits(2))>s)return this.flushBuffer(),1;for(_=i?h[i-1]:0;a--;)h[i++]=_}else{if(i+(a=17===a?3+this.readBits(3):11+this.readBits(7))>s)return this.flushBuffer(),1;for(;a--;)h[i++]=0}for(p=this.literalTree.length,i=0;i<p;i++)this.literalTree[i]=new jut.HufNode;if(this.CreateTree(this.literalTree,c,h,0))return this.flushBuffer(),1;for(p=this.literalTree.length,i=0;i<p;i++)this.distanceTree[i]=new jut.HufNode;var f=new Array;for(i=c;i<h.length;i++)f[i-c]=h[i];if(this.CreateTree(this.distanceTree,l,f,0))return this.flushBuffer(),1;for(;;)if((a=this.DecodeValue(this.literalTree))>=256){var p,d;if(0==(a-=256))break;for(a--,p=this.readBits(jut.cplext[a])+jut.cplens[a],a=this.DecodeValue(this.distanceTree),jut.cpdext[a]>8?(d=this.readBits(8),d|=this.readBits(jut.cpdext[a]-8)<<8):d=this.readBits(jut.cpdext[a]),d+=jut.cpdist[a];p--;)o=this.buf32k[this.bIdx-d&32767],this.addBuffer(o)}else this.addBuffer(a)}}while(!t);return this.flushBuffer(),this.byteAlign(),0},jut.prototype.unzipFile=function(t){var e;for(this.gunzip(),e=0;e<this.unzipped.length;e++)if(this.unzipped[e][1]===t)return this.unzipped[e][0]},jut.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var t=[];if(t[0]=this.readByte(),t[1]=this.readByte(),120===t[0]&&218===t[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===t[0]&&139===t[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===t[0]&&75===t[1]&&(this.modeZIP=!0,t[2]=this.readByte(),t[3]=this.readByte(),3===t[2]&&4===t[3])){t[0]=this.readByte(),t[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte();e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var i=this.readByte();i|=this.readByte()<<8;var n=this.readByte();for(n|=this.readByte()<<8,o=0,this.nameBuf=[];i--;){var r=this.readByte();"/"===r|":"===r?o=0:o<jut.NAMEMAX-1&&(this.nameBuf[o++]=String.fromCharCode(r))}this.fileout||(this.fileout=this.nameBuf);for(var o=0;o<n;)r=this.readByte(),o++;8===e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},jut.prototype.skipdir=function(){var t,e,i=[];if(8&this.gpflags&&(i[0]=this.readByte(),i[1]=this.readByte(),i[2]=this.readByte(),i[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),i[0]=this.readByte(),8!==i[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(i[0]=this.readByte(),i[2]=this.readByte(),this.len=i[0]+256*i[1],t=0;t<this.len;t++)this.readByte();if(8&this.gpflags)for(t=0,this.nameBuf=[];e=this.readByte();)"7"!==e&&":"!==e||(t=0),t<jut.NAMEMAX-1&&(this.nameBuf[t++]=e);if(16&this.gpflags)for(;e=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var Wut,qut,Xut,Yut,Kut,Jut,Qut,Zut,$ut,tht,eht,iht,nht,rht,oht,aht,sht,cht,lht,uht,hht,_ht,fht,pht,dht,mht,vht,ght,yht,xht,Sht,bht,Cht,Aht,Tht,wht,Eht,Pht,Iht,Rht,Dht,Mht,Oht,Bht,Nht,Lht,Fht,zht,Vht,kht,Uht,Ght,Hht,jht,Wht,qht,Xht,Yht,Kht,Jht,Qht,Zht,$ht,t_t,e_t,i_t,n_t,r_t,o_t,a_t,s_t,c_t,l_t,u_t,h_t,__t,f_t,p_t,d_t,m_t,v_t,g_t,y_t,x_t,S_t,b_t,C_t,A_t,T_t,w_t,E_t,P_t,I_t,R_t,D_t,M_t,O_t,B_t,N_t,L_t,F_t,z_t,V_t,k_t={name:"Jacob__Codec"};function U_t(t){var e=t.parent,i=t.getComponent(ift);return e&&i?U_t(e):t.getComponentsInChildren(ift)}k_t.Base64=Hut,k_t.GZip=jut,k_t.unzip=function(){return k_t.GZip.gunzip.apply(k_t.GZip,arguments)},k_t.unzipBase64=function(){var t=k_t.Base64.decode.apply(k_t.Base64,arguments);try{return k_t.GZip.gunzip.call(k_t.GZip,t)}catch(e){return t.slice(7)}},k_t.unzipBase64AsArray=function(t,e){e=e||1;var i,n,r,o=this.unzipBase64(t),a=[];for(i=0,r=o.length/e;i<r;i++)for(a[i]=0,n=e-1;n>=0;--n)a[i]+=o.charCodeAt(i*e+n)<<8*n;return a},k_t.unzipAsArray=function(t,e){e=e||1;var i,n,r,o=this.unzip(t),a=[];for(i=0,r=o.length/e;i<r;i++)for(a[i]=0,n=e-1;n>=0;--n)a[i]+=o.charCodeAt(i*e+n)<<8*n;return a},function(t){t[t.JPG=0]="JPG",t[t.PNG=1]="PNG",t[t.TIFF=2]="TIFF",t[t.WEBP=3]="WEBP",t[t.PVR=4]="PVR",t[t.ETC=5]="ETC",t[t.S3TC=6]="S3TC",t[t.ATITC=7]="ATITC",t[t.TGA=8]="TGA",t[t.RAWDATA=9]="RAWDATA",t[t.UNKNOWN=10]="UNKNOWN"}(V_t||(V_t={}));var G_t,H_t,j_t,W_t,q_t,X_t,Y_t,K_t,J_t,Q_t,Z_t,$_t,tft,eft,ift=t("ParticleSystem2D",(Wut=pc("cc.ParticleSystem2D"),qut=wc(),Xut=Uc(),Yut=Nc(),Kut=Kc(Out),Jut=Uc(),Qut=Nc(),Zut=Kc(cG),$ut=Nc(),tht=Nc(),eht=Nc(),iht=Nc(),nht=Nc(),rht=Nc(),oht=Nc(),aht=Nc(),sht=Mc(),cht=Nc(),lht=Nc(),uht=Nc(),hht=Nc(),_ht=Nc(),fht=Nc(),pht=Nc(),dht=Nc(),mht=Nc(),vht=Nc(),ght=Nc(),yht=Nc(),xht=Nc(),Sht=Kc(Cut),bht=Nc(),Cht=Uc(),Aht=Nc(),Tht=Kc(but),wht=Nc(),Eht=Nc(),Pht=Nc(),Iht=Nc(),Rht=Nc(),Dht=Nc(),Mht=Nc(),Oht=Nc(),Bht=Nc(),Nht=Nc(),Lht=Nc(),Fht=Nc(),zht=Nc(),Vht=Nc(),kht=Nc(),Uht=Uc(),Ght=Nc(),Hht=Uc(),jht=Nc(),Wht=Sc("preview"),Wut(qht=qut(qht=Ec(qht=Tc((z_t=F_t=function(t){function e(){var e;return ct(e=t.call(this)||this,"duration",Yht,ot(e)),ct(e,"emissionRate",Kht,ot(e)),ct(e,"life",Jht,ot(e)),ct(e,"lifeVar",Qht,ot(e)),ct(e,"angle",Zht,ot(e)),ct(e,"angleVar",$ht,ot(e)),ct(e,"startSize",t_t,ot(e)),ct(e,"startSizeVar",e_t,ot(e)),ct(e,"endSize",i_t,ot(e)),ct(e,"endSizeVar",n_t,ot(e)),ct(e,"startSpin",r_t,ot(e)),ct(e,"startSpinVar",o_t,ot(e)),ct(e,"endSpin",a_t,ot(e)),ct(e,"endSpinVar",s_t,ot(e)),ct(e,"sourcePos",c_t,ot(e)),ct(e,"posVar",l_t,ot(e)),ct(e,"emitterMode",u_t,ot(e)),ct(e,"gravity",h_t,ot(e)),ct(e,"speed",__t,ot(e)),ct(e,"speedVar",f_t,ot(e)),ct(e,"tangentialAccel",p_t,ot(e)),ct(e,"tangentialAccelVar",d_t,ot(e)),ct(e,"radialAccel",m_t,ot(e)),ct(e,"radialAccelVar",v_t,ot(e)),ct(e,"rotationIsDir",g_t,ot(e)),ct(e,"startRadius",y_t,ot(e)),ct(e,"startRadiusVar",x_t,ot(e)),ct(e,"endRadius",S_t,ot(e)),ct(e,"endRadiusVar",b_t,ot(e)),ct(e,"rotatePerS",C_t,ot(e)),ct(e,"rotatePerSVar",A_t,ot(e)),e.aspectRatio=1,ct(e,"playOnLoad",T_t,ot(e)),ct(e,"autoRemoveOnFinish",w_t,ot(e)),ct(e,"_preview",E_t,ot(e)),ct(e,"_custom",P_t,ot(e)),ct(e,"_file",I_t,ot(e)),ct(e,"_spriteFrame",R_t,ot(e)),ct(e,"_totalParticles",D_t,ot(e)),ct(e,"_startColor",M_t,ot(e)),ct(e,"_startColorVar",O_t,ot(e)),ct(e,"_endColor",B_t,ot(e)),ct(e,"_endColorVar",N_t,ot(e)),ct(e,"_positionType",L_t,ot(e)),e._stopped=!0,e.initProperties(),e}$(e,t);var i=e.prototype;return i.onEnable=function(){t.prototype.onEnable.call(this),this._updateMaterial()},i.onDestroy=function(){t.prototype.onDestroy.call(this),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)},i.initProperties=function(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new Mut(this)},i.onFocusInEditor=function(){this._focused=!0;for(var t=U_t(this.node),e=0;e<t.length;++e)t[e]._startPreview()},i.onLostFocusInEditor=function(){this._focused=!1;for(var t=U_t(this.node),e=0;e<t.length;++e)t[e]._stopPreview()},i._startPreview=function(){this._preview&&this.resetSystem()},i._stopPreview=function(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)},i.__preload=function(){t.prototype.__preload.call(this),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()},i._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))},i.lateUpdate=function(t){this._simulator.finished||this._simulator.step(t)},i.addParticle=function(){},i.stopSystem=function(){this._stopped=!0,this._simulator.stop()},i.resetSystem=function(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()},i.isFull=function(){return this.particleCount>=this.totalParticles},i._applyFile=function(){var t=this._file;if(t){if(!t)return void O(6029);if(!this.isValid)return;this._plistFile=t.nativeUrl,this._custom||(this._spriteFrame!==t.spriteFrame&&(this.spriteFrame=t.spriteFrame),this._initWithDictionary(t._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():t.spriteFrame?this.spriteFrame=t.spriteFrame:this._custom&&this._initTextureWithDictionary(t._nativeAsset)}},i._initTextureWithDictionary=function(t){var e,i=this;if(t.spriteFrameUuid){var n=t.spriteFrameUuid;eN.loadAny(n,(function(e,n){e?(t.spriteFrameUuid=void 0,i._initTextureWithDictionary(t),b(e)):i.spriteFrame=n}))}else{var r=Tu(this._plistFile,t.textureFileName||"");if(t.textureFileName)eN.loadRemote(r,(function(e,n){e?(t.textureFileName=void 0,i._initTextureWithDictionary(t),b(e)):i.spriteFrame=n?cG.createWithImage(n):cG.createWithImage(Mv.get("white-texture"))}));else if(t.textureImageData){var o=t.textureImageData;if(!(o&&o.length>0))return!1;var a=eN.assets.get(r);if(!a){var s=k_t.unzipBase64AsArray(o,1);if(!s)return D(6030,this._file.name),!1;var c=(e=s).length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?V_t.PNG:e.length>2&&(73===e[0]&&73===e[1]||77===e[0]&&77===e[1]||255===e[0]&&216===e[1])?V_t.TIFF:V_t.UNKNOWN;if(c!==V_t.TIFF&&c!==V_t.PNG)return D(6031,this._file.name),!1;var l=document.createElement("canvas");c===V_t.PNG?new Lut(s).render(l):(this._tiffReader||(this._tiffReader=new Fut),this._tiffReader.parseTIFF(s,l)),a=new tv(l),eN.assets.add(r,a)}a||D(6032,this._file.name),this.spriteFrame=a?cG.createWithImage(a):cG.createWithImage(Mv.get("white-texture"))}}return!0},i._initWithDictionary=function(t){this.totalParticles=parseInt(t.maxParticles||0),this.life=parseFloat(t.particleLifespan||0),this.lifeVar=parseFloat(t.particleLifespanVariance||0);var e=t.emissionRate;this.emissionRate=e||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(t.duration||0),this._srcBlendFactor=parseInt(t.blendFuncSource||Pn.SRC_ALPHA),this._dstBlendFactor=parseInt(t.blendFuncDestination||Pn.ONE_MINUS_SRC_ALPHA);var i=this._startColor;i.r=255*parseFloat(t.startColorRed||0),i.g=255*parseFloat(t.startColorGreen||0),i.b=255*parseFloat(t.startColorBlue||0),i.a=255*parseFloat(t.startColorAlpha||0);var n=this._startColorVar;n.r=255*parseFloat(t.startColorVarianceRed||0),n.g=255*parseFloat(t.startColorVarianceGreen||0),n.b=255*parseFloat(t.startColorVarianceBlue||0),n.a=255*parseFloat(t.startColorVarianceAlpha||0);var r=this._endColor;r.r=255*parseFloat(t.finishColorRed||0),r.g=255*parseFloat(t.finishColorGreen||0),r.b=255*parseFloat(t.finishColorBlue||0),r.a=255*parseFloat(t.finishColorAlpha||0);var o=this._endColorVar;if(o.r=255*parseFloat(t.finishColorVarianceRed||0),o.g=255*parseFloat(t.finishColorVarianceGreen||0),o.b=255*parseFloat(t.finishColorVarianceBlue||0),o.a=255*parseFloat(t.finishColorVarianceAlpha||0),this.startSize=parseFloat(t.startParticleSize||0),this.startSizeVar=parseFloat(t.startParticleSizeVariance||0),this.endSize=parseFloat(t.finishParticleSize||0),this.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==t.positionType?t.positionType:Cut.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(t.sourcePositionVariancex||0),parseFloat(t.sourcePositionVariancey||0)),this.angle=parseFloat(t.angle||0),this.angleVar=parseFloat(t.angleVariance||0),this.startSpin=parseFloat(t.rotationStart||0),this.startSpinVar=parseFloat(t.rotationStartVariance||0),this.endSpin=parseFloat(t.rotationEnd||0),this.endSpinVar=parseFloat(t.rotationEndVariance||0),this.emitterMode=parseInt(t.emitterType||but.GRAVITY),this.emitterMode===but.GRAVITY){this.gravity.set(parseFloat(t.gravityx||0),parseFloat(t.gravityy||0)),this.speed=parseFloat(t.speed||0),this.speedVar=parseFloat(t.speedVariance||0),this.radialAccel=parseFloat(t.radialAcceleration||0),this.radialAccelVar=parseFloat(t.radialAccelVariance||0),this.tangentialAccel=parseFloat(t.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);var a=t.rotationIsDir||"";null!==a?(a=a.toString().toLowerCase(),this.rotationIsDir="true"===a||"1"===a):this.rotationIsDir=!1}else{if(this.emitterMode!==but.RADIUS)return D(6009),!1;this.startRadius=parseFloat(t.maxRadius||0),this.startRadiusVar=parseFloat(t.maxRadiusVariance||0),this.endRadius=parseFloat(t.minRadius||0),this.endRadiusVar=parseFloat(t.minRadiusVariance||0),this.rotatePerS=parseFloat(t.rotatePerSecond||0),this.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(t),!0},i._syncAspect=function(){if(this._renderSpriteFrame){var t=this._renderSpriteFrame.rect;this.aspectRatio=t.width/t.height}},i._applySpriteFrame=function(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()},i._getTexture=function(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture},i._updateMaterial=function(){var t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==Cut.FREE})},i._finishedSimulation=function(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()},i._canRender=function(){return t.prototype._canRender.call(this)&&!this._stopped&&null!==this._renderSpriteFrame},i._render=function(t){this._positionType===Cut.RELATIVE?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===Cut.GROUPED?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)},Q(e,[{key:"custom",get:function(){return this._custom},set:function(t){this._custom!==t&&(this._custom=t,this._applyFile())}},{key:"file",get:function(){return this._file},set:function(t){this._file!==t&&(this._file=t,t?this._applyFile():this.custom=!0)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._renderSpriteFrame!==t&&(this._renderSpriteFrame=t,t&&!t._uuid||(this._spriteFrame=t),this._applySpriteFrame())}},{key:"particleCount",get:function(){return this._simulator.particles.length}},{key:"totalParticles",get:function(){return this._totalParticles},set:function(t){this._totalParticles!==t&&(this._totalParticles=t)}},{key:"startColor",get:function(){return this._startColor},set:function(t){this._startColor.r=t.r,this._startColor.g=t.g,this._startColor.b=t.b,this._startColor.a=t.a}},{key:"startColorVar",get:function(){return this._startColorVar},set:function(t){this._startColorVar.r=t.r,this._startColorVar.g=t.g,this._startColorVar.b=t.b,this._startColorVar.a=t.a}},{key:"color",get:function(){return this._color},set:function(){}},{key:"endColor",get:function(){return this._endColor},set:function(t){this._endColor.r=t.r,this._endColor.g=t.g,this._endColor.b=t.b,this._endColor.a=t.a}},{key:"endColorVar",get:function(){return this._endColorVar},set:function(t){this._endColorVar.r=t.r,this._endColorVar.g=t.g,this._endColorVar.b=t.b,this._endColorVar.a=t.a}},{key:"positionType",get:function(){return this._positionType},set:function(t){this._positionType=t,this._updateMaterial()}},{key:"preview",get:function(){return this._preview},set:function(t){t?this._startPreview():this._stopPreview(),this._preview=t}},{key:"stopped",get:function(){return this._stopped}},{key:"active",get:function(){return this._simulator.active}},{key:"assembler",get:function(){return this._assembler}}]),e}(yW),F_t.EmitterMode=but,F_t.PositionType=Cut,F_t.DURATION_INFINITY=-1,F_t.START_SIZE_EQUAL_TO_END_SIZE=-1,F_t.START_RADIUS_EQUAL_TO_END_RADIUS=-1,lt((Xht=z_t).prototype,"custom",[Dc,Xut,Yut],Object.getOwnPropertyDescriptor(Xht.prototype,"custom"),Xht.prototype),lt(Xht.prototype,"file",[Kut,Jut,Qut],Object.getOwnPropertyDescriptor(Xht.prototype,"file"),Xht.prototype),lt(Xht.prototype,"spriteFrame",[Zut,$ut],Object.getOwnPropertyDescriptor(Xht.prototype,"spriteFrame"),Xht.prototype),lt(Xht.prototype,"totalParticles",[Dc,tht],Object.getOwnPropertyDescriptor(Xht.prototype,"totalParticles"),Xht.prototype),Yht=lt(Xht.prototype,"duration",[xc,Dc,eht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Kht=lt(Xht.prototype,"emissionRate",[xc,Dc,iht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Jht=lt(Xht.prototype,"life",[xc,Dc,nht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Qht=lt(Xht.prototype,"lifeVar",[xc,Dc,rht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(Xht.prototype,"startColor",[Dc,oht],Object.getOwnPropertyDescriptor(Xht.prototype,"startColor"),Xht.prototype),lt(Xht.prototype,"startColorVar",[Dc,aht],Object.getOwnPropertyDescriptor(Xht.prototype,"startColorVar"),Xht.prototype),lt(Xht.prototype,"color",[sht],Object.getOwnPropertyDescriptor(Xht.prototype,"color"),Xht.prototype),lt(Xht.prototype,"endColor",[Dc,cht],Object.getOwnPropertyDescriptor(Xht.prototype,"endColor"),Xht.prototype),lt(Xht.prototype,"endColorVar",[Dc,lht],Object.getOwnPropertyDescriptor(Xht.prototype,"endColorVar"),Xht.prototype),Zht=lt(Xht.prototype,"angle",[xc,Dc,uht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),$ht=lt(Xht.prototype,"angleVar",[xc,Dc,hht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),t_t=lt(Xht.prototype,"startSize",[xc,Dc,_ht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),e_t=lt(Xht.prototype,"startSizeVar",[xc,Dc,fht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i_t=lt(Xht.prototype,"endSize",[xc,Dc,pht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n_t=lt(Xht.prototype,"endSizeVar",[xc,Dc,dht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r_t=lt(Xht.prototype,"startSpin",[xc,Dc,mht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o_t=lt(Xht.prototype,"startSpinVar",[xc,Dc,vht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a_t=lt(Xht.prototype,"endSpin",[xc,Dc,ght],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),s_t=lt(Xht.prototype,"endSpinVar",[xc,Dc,yht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c_t=lt(Xht.prototype,"sourcePos",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qi.ZERO.clone()}}),l_t=lt(Xht.prototype,"posVar",[xc,Dc,xht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qi.ZERO.clone()}}),lt(Xht.prototype,"positionType",[Sht,bht],Object.getOwnPropertyDescriptor(Xht.prototype,"positionType"),Xht.prototype),lt(Xht.prototype,"preview",[Dc,Cht,Aht],Object.getOwnPropertyDescriptor(Xht.prototype,"preview"),Xht.prototype),u_t=lt(Xht.prototype,"emitterMode",[xc,Dc,Tht,wht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return but.GRAVITY}}),h_t=lt(Xht.prototype,"gravity",[xc,Dc,Eht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qi.ZERO.clone()}}),__t=lt(Xht.prototype,"speed",[xc,Dc,Pht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),f_t=lt(Xht.prototype,"speedVar",[xc,Dc,Iht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),p_t=lt(Xht.prototype,"tangentialAccel",[xc,Dc,Rht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),d_t=lt(Xht.prototype,"tangentialAccelVar",[xc,Dc,Dht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m_t=lt(Xht.prototype,"radialAccel",[xc,Dc,Mht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v_t=lt(Xht.prototype,"radialAccelVar",[xc,Dc,Oht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g_t=lt(Xht.prototype,"rotationIsDir",[xc,Dc,Bht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),y_t=lt(Xht.prototype,"startRadius",[xc,Dc,Nht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x_t=lt(Xht.prototype,"startRadiusVar",[xc,Dc,Lht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S_t=lt(Xht.prototype,"endRadius",[xc,Dc,Fht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b_t=lt(Xht.prototype,"endRadiusVar",[xc,Dc,zht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C_t=lt(Xht.prototype,"rotatePerS",[xc,Dc,Vht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A_t=lt(Xht.prototype,"rotatePerSVar",[xc,Dc,kht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T_t=lt(Xht.prototype,"playOnLoad",[xc,Dc,Uht,Ght],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),w_t=lt(Xht.prototype,"autoRemoveOnFinish",[xc,Dc,Hht,jht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),E_t=lt(Xht.prototype,"_preview",[Wht],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),P_t=lt(Xht.prototype,"_custom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I_t=lt(Xht.prototype,"_file",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R_t=lt(Xht.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D_t=lt(Xht.prototype,"_totalParticles",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),M_t=lt(Xht.prototype,"_startColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(255,255,255,255)}}),O_t=lt(Xht.prototype,"_startColorVar",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(0,0,0,0)}}),B_t=lt(Xht.prototype,"_endColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(255,255,255,0)}}),N_t=lt(Xht.prototype,"_endColorVar",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(0,0,0,0)}}),L_t=lt(Xht.prototype,"_positionType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cut.FREE}}),qht=Xht))||qht)||qht)||qht)||qht)),nft=function(){function t(t,e){this.point=new qi,this.dir=new qi,this.distance=0,this.time=0,t&&this.point.set(t),e&&this.dir.set(e)}var e=t.prototype;return e.setPoint=function(t,e){this.point.x=t,this.point.y=e},e.setDir=function(t,e){this.dir.x=t,this.dir.y=e},t}(),rft=t("MotionStreak",(G_t=pc("cc.MotionStreak"),H_t=wc(),j_t=Rc(),W_t=Kc(Cv),G_t(q_t=Tc(q_t=Ec(q_t=H_t(q_t=j_t((eft=tft=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_preview",Y_t,ot(e)),ct(e,"_fadeTime",K_t,ot(e)),ct(e,"_minSeg",J_t,ot(e)),ct(e,"_stroke",Q_t,ot(e)),ct(e,"_texture",Z_t,ot(e)),ct(e,"_fastMode",$_t,ot(e)),e._points=[],e}$(e,t);var i=e.prototype;return i.onEnable=function(){t.prototype.onEnable.call(this),this.reset()},i._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},i.onFocusInEditor=function(){this._preview&&this.reset()},i.onLostFocusInEditor=function(){this._preview&&this.reset()},i.reset=function(){this._points.length=0,this._renderData&&this._renderData.clear()},i.lateUpdate=function(t){this._assembler&&this._assembler.update(this,t)},i._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},Q(e,[{key:"preview",get:function(){return this._preview},set:function(t){this._preview=t,this.reset()}},{key:"fadeTime",get:function(){return this._fadeTime},set:function(t){this._fadeTime=t,this.reset()}},{key:"minSeg",get:function(){return this._minSeg},set:function(t){this._minSeg=t}},{key:"stroke",get:function(){return this._stroke},set:function(t){this._stroke=t}},{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t)}},{key:"fastMode",get:function(){return this._fastMode},set:function(t){this._fastMode=t}},{key:"points",get:function(){return this._points}}]),e}(yW),tft.Point=nft,lt((X_t=eft).prototype,"preview",[Dc],Object.getOwnPropertyDescriptor(X_t.prototype,"preview"),X_t.prototype),lt(X_t.prototype,"fadeTime",[Dc],Object.getOwnPropertyDescriptor(X_t.prototype,"fadeTime"),X_t.prototype),lt(X_t.prototype,"minSeg",[Dc],Object.getOwnPropertyDescriptor(X_t.prototype,"minSeg"),X_t.prototype),lt(X_t.prototype,"stroke",[Dc],Object.getOwnPropertyDescriptor(X_t.prototype,"stroke"),X_t.prototype),lt(X_t.prototype,"texture",[W_t],Object.getOwnPropertyDescriptor(X_t.prototype,"texture"),X_t.prototype),lt(X_t.prototype,"fastMode",[Dc],Object.getOwnPropertyDescriptor(X_t.prototype,"fastMode"),X_t.prototype),Y_t=lt(X_t.prototype,"_preview",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K_t=lt(X_t.prototype,"_fadeTime",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),J_t=lt(X_t.prototype,"_minSeg",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Q_t=lt(X_t.prototype,"_stroke",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Z_t=lt(X_t.prototype,"_texture",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$_t=lt(X_t.prototype,"_fastMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q_t=X_t))||q_t)||q_t)||q_t)||q_t)||q_t)),oft=(new qi,new qi),aft=new qi;function sft(t,e){return t.x=-e.y,t.y=e.x,t}var cft={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,42),e},update:function(t,e){var i,n=t.stroke/2,r=t.node.worldMatrix,o=r.m12,a=r.m13,s=t.points;if(s.length>1){var c=s[0],l=c.point.x-o,u=c.point.y-a;l*l+u*u<t.minSeg&&(i=c)}i||(i=new rft.Point,s.unshift(i)),i.setPoint(o,a),i.time=t.fadeTime+e;var h,_=0;if(!(s.length<2)){var f=t.renderData;this.updateRenderDataCache(t,f);var p=t.color,d=p.r,m=p.g,v=p.b,g=p.a,y=s[1];y.distance=qi.subtract(aft,i.point,y.point).length(),aft.normalize(),y.setDir(aft.x,aft.y),i.setDir(aft.x,aft.y),f.dataLength=2*s.length;for(var x=f.data,S=t.fadeTime,b=!1,C=s.length-1;C>=0;C--){var A=s[C],T=A.point,w=A.dir;if(A.time-=e,A.time<0)s.splice(C,1);else{var E=A.time/S,P=s[C-1];if(!b){if(!P){s.splice(C,1);continue}T.x=P.point.x-w.x*E,T.y=P.point.y-w.y*E}b=!0,sft(oft,w);var I=(E*g<<24>>>0)+(v<<16)+(m<<8)+d,R=_;x[R].x=T.x+oft.x*n,x[R].y=T.y+oft.y*n,x[R].u=1,x[R].v=E,x[R].color._val=I,x[R+=1].x=T.x-oft.x*n,x[R].y=T.y-oft.y*n,x[R].u=0,x[R].v=E,x[R].color._val=I,_+=2}}h=_<=2?0:3*(_-2),f.resize(_,h)}},updateRenderDataCache:function(t,e){e.passDirty&&e.updatePass(t),e.nodeDirty&&e.updateNode(t),e.textureDirty&&t.texture&&(e.updateTexture(t.texture),e.material=t.getRenderMaterial(0)),e.hashDirty&&e.updateHash()},updateRenderData:function(){},updateColor:function(){},fillBuffers:function(t){for(var e=t.renderData,i=e.chunk,n=e.data,r=e.vertexCount,o=e.indexCount,a=i.vb,s=0,c=0;c<r;c++){var l=n[c];a[s++]=l.x,a[s++]=l.y,a[s++]=l.z,a[s++]=l.u,a[s++]=l.v,Ti.toArray(a,l.color,s),s+=4}for(var u=i.bufferId,h=i.vertexOffset,_=i.vertexAccessor.getMeshBuffer(i.bufferId),f=i.vertexAccessor.getIndexBuffer(u),p=_.indexOffset,d=0,m=o;d<m;d+=2){var v=h+d;f[p++]=v,f[p++]=v+2,f[p++]=v+1,f[p++]=v+1,f[p++]=v+2,f[p++]=v+3}_.indexOffset+=e.indexCount,_.setDirty()}},lft=t("MotionStreakAssemblerManager",{getAssembler:function(){return cft}});rft.Assembler=lft;var uft,hft,_ft={maxParticleDeltaTime:0,createData:function(){return wH.add()},removeData:function(t){wH.remove(t)},updateRenderData:function(){},fillBuffers:function(){}},fft=t("ParticleSystem2DAssembler",{getAssembler:function(){return _ft.maxParticleDeltaTime||(_ft.maxParticleDeltaTime=u.game.frameTime/1e3*2),_ft}});ift.Assembler=fft,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var pft,dft=function(t,e){return function(t,e){!function(t){function e(t){if(!t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];throw nt(Error,i)}}function i(t,e){return void 0!==t?t:e}var n=1e37,r=1e-5,o=r*r,a=3.14159265359,s=2,c=8,l=.1,u=2,h=.008,_=2/180*a,f=2*h,p=8,d=32,m=1,v=.2,g=8/180*a,y=2,x=y*y,S=.5*a,b=S*S,C=.2,A=.75,T=-1,w=2147483647,E=.75,P=1,I=.25,R=.5,D=2,M=D*D,O=256,B=2.5,N=.5,L=.01,F=2/180*a;function z(){return null}function V(){}function k(){}var U=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),G=new U(2,3,2),H="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(t){return parseInt(t,10)}function q(t){return Math.abs(parseInt(t,10))}function X(t,e){for(var i=new Array(t),n=0;n<t;++n)i[n]=e(n);return i}function Y(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=null;return e}function K(t,e){void 0===e&&(e=0);for(var i=new Array(t),n=0;n<t;++n)i[n]=e;return i}var J=a/180,Z=180/a,tt=2*a,et=Math.abs;function it(t,e){return t<e?t:e}function rt(t,e){return t>e?t:e}function ot(t,e,i){return t<e?e:t>i?i:t}function at(t,e){var i=t[0];t[0]=e[0],e[0]=i}var ct=isFinite;function lt(t){return t*t}function ut(t){return 1/Math.sqrt(t)}var ht=Math.sqrt,_t=Math.pow;function ft(t){return t*J}function pt(t){return t*Z}var dt=Math.cos,mt=Math.sin,vt=Math.acos,gt=Math.asin,yt=Math.atan2;function xt(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function St(t){return t>0&&0==(t&t-1)}function bt(){return 2*Math.random()-1}function Ct(t,e){return(e-t)*Math.random()+t}var At=function(){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(e[0]instanceof Float32Array){if(2!==e[0].length)throw new Error;this.data=e[0]}else{var n="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0;this.data=new Float32Array([n,r])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y)},e.SetZero=function(){return this.x=0,this.y=0,this},e.Set=function(t,e){return this.x=t,this.y=e,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.Dot=function(t){return this.x*t.x+this.y*t.y},e.Cross=function(t){return this.x*t.y-this.y*t.x},e.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.Normalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return t},e.SelfNormalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return this},e.SelfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this},e.SelfRotateCosSin=function(t,e){var i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this},e.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.SelfMinV=function(t){return this.x=it(this.x,t.x),this.y=it(this.y,t.y),this},e.SelfMaxV=function(t){return this.x=rt(this.x,t.x),this.y=rt(this.y,t.y),this},e.SelfAbs=function(){return this.x=et(this.x),this.y=et(this.y),this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},t.MakeArray=function(e){return X(e,(function(){return new t}))},t.AbsV=function(t,e){return e.x=et(t.x),e.y=et(t.y),e},t.MinV=function(t,e,i){return i.x=it(t.x,e.x),i.y=it(t.y,e.y),i},t.MaxV=function(t,e,i){return i.x=rt(t.x,e.x),i.y=rt(t.y,e.y),i},t.ClampV=function(t,e,i,n){return n.x=ot(t.x,e.x,i.x),n.y=ot(t.y,e.y,i.y),n},t.RotateV=function(t,e,i){var n=t.x,r=t.y,o=Math.cos(e),a=Math.sin(e);return i.x=o*n-a*r,i.y=a*n+o*r,i},t.DotVV=function(t,e){return t.x*e.x+t.y*e.y},t.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},t.CrossVS=function(t,e,i){var n=t.x;return i.x=e*t.y,i.y=-e*n,i},t.CrossVOne=function(t,e){var i=t.x;return e.x=t.y,e.y=-i,e},t.CrossSV=function(t,e,i){var n=e.x;return i.x=-t*e.y,i.y=t*n,i},t.CrossOneV=function(t,e){var i=t.x;return e.x=-t.y,e.y=i,e},t.AddVV=function(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i},t.SubVV=function(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i},t.MulSV=function(t,e,i){return i.x=e.x*t,i.y=e.y*t,i},t.MulVS=function(t,e,i){return i.x=t.x*e,i.y=t.y*e,i},t.AddVMulSV=function(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n},t.SubVMulSV=function(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n},t.AddVCrossSV=function(t,e,i,n){var r=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*r,n},t.MidVV=function(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i},t.ExtVV=function(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i},t.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},t.DistanceVV=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},t.DistanceSquaredVV=function(t,e){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n},t.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},Q(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}}]),t}();At.ZERO=new At(0,0),At.UNITX=new At(1,0),At.UNITY=new At(0,1),At.s_t0=new At,At.s_t1=new At,At.s_t2=new At,At.s_t3=new At;var Tt=new At(0,0),wt=function(){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(e[0]instanceof Float32Array){if(3!==e[0].length)throw new Error;this.data=e[0]}else{var n="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0,o="number"==typeof e[2]?e[2]:0;this.data=new Float32Array([n,r,o])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y,this.z)},e.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},e.SetXYZ=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.SelfAddXYZ=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.SelfSubXYZ=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.CrossV3V3=function(t,e,i){var n=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return i.x=r*c-o*s,i.y=o*a-n*c,i.z=n*s-r*a,i},Q(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"z",get:function(){return this.data[2]},set:function(t){this.data[2]=t}}]),t}();wt.ZERO=new wt(0,0,0),wt.s_t0=new wt;var Et=function(){function t(){this.data=new Float32Array([1,0,0,1]),this.ex=new At(this.data.subarray(0,2)),this.ey=new At(this.data.subarray(2,4))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},t.FromVV=function(e,i){return(new t).SetVV(e,i)},t.FromSSSS=function(e,i,n,r){return(new t).SetSSSS(e,i,n,r)},t.FromAngle=function(e){return(new t).SetAngle(e)},e.SetSSSS=function(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this},e.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},e.SetAngle=function(t){var e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},e.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},e.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},e.GetInverse=function(t){var e=this.ex.x,i=this.ey.x,n=this.ex.y,r=this.ey.y,o=e*r-i*n;return 0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*i,t.ex.y=-o*n,t.ey.y=o*e,t},e.Solve=function(t,e,i){var n=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=n*a-r*o;return 0!==s&&(s=1/s),i.x=s*(a*t-r*e),i.y=s*(n*e-o*t),i},e.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},e.SelfInv=function(){return this.GetInverse(this),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},e.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},t.AbsM=function(t,e){var i=t.ex,n=t.ey;return e.ex.x=et(i.x),e.ex.y=et(i.y),e.ey.x=et(n.x),e.ey.y=et(n.y),e},t.MulMV=function(t,e,i){var n=t.ex,r=t.ey,o=e.x,a=e.y;return i.x=n.x*o+r.x*a,i.y=n.y*o+r.y*a,i},t.MulTMV=function(t,e,i){var n=t.ex,r=t.ey,o=e.x,a=e.y;return i.x=n.x*o+n.y*a,i.y=r.x*o+r.y*a,i},t.AddMM=function(t,e,i){var n=t.ex,r=t.ey,o=e.ex,a=e.ey;return i.ex.x=n.x+o.x,i.ex.y=n.y+o.y,i.ey.x=r.x+a.x,i.ey.y=r.y+a.y,i},t.MulMM=function(t,e,i){var n=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return i.ex.x=n*s+o*c,i.ex.y=r*s+a*c,i.ey.x=n*l+o*u,i.ey.y=r*l+a*u,i},t.MulTMM=function(t,e,i){var n=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return i.ex.x=n*s+r*c,i.ex.y=o*s+a*c,i.ey.x=n*l+r*u,i.ey.y=o*l+a*u,i},t}();Et.IDENTITY=new Et;var Pt=function(){function t(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new wt(this.data.subarray(0,3)),this.ey=new wt(this.data.subarray(3,6)),this.ez=new wt(this.data.subarray(6,9))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.SetVVV=function(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},e.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},e.Solve33=function(t,e,i,n){var r=this.ex.x,o=this.ex.y,a=this.ex.z,s=this.ey.x,c=this.ey.y,l=this.ey.z,u=this.ez.x,h=this.ez.y,_=this.ez.z,f=r*(c*_-l*h)+o*(l*u-s*_)+a*(s*h-c*u);return 0!==f&&(f=1/f),n.x=f*(t*(c*_-l*h)+e*(l*u-s*_)+i*(s*h-c*u)),n.y=f*(r*(e*_-i*h)+o*(i*u-t*_)+a*(t*h-e*u)),n.z=f*(r*(c*i-l*e)+o*(l*t-s*i)+a*(s*e-c*t)),n},e.Solve22=function(t,e,i){var n=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=n*a-r*o;return 0!==s&&(s=1/s),i.x=s*(a*t-r*e),i.y=s*(n*e-o*t),i},e.GetInverse22=function(t){var e=this.ex.x,i=this.ey.x,n=this.ex.y,r=this.ey.y,o=e*r-i*n;0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*i,t.ex.z=0,t.ex.y=-o*n,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},e.GetSymInverse33=function(t){var e=wt.DotV3V3(this.ex,wt.CrossV3V3(this.ey,this.ez,wt.s_t0));0!==e&&(e=1/e);var i=this.ex.x,n=this.ey.x,r=this.ez.x,o=this.ey.y,a=this.ez.y,s=this.ez.z;t.ex.x=e*(o*s-a*a),t.ex.y=e*(r*a-n*s),t.ex.z=e*(n*a-r*o),t.ey.x=t.ex.y,t.ey.y=e*(i*s-r*r),t.ey.z=e*(r*n-i*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*o-n*n)},t.MulM33V3=function(t,e,i){var n=e.x,r=e.y,o=e.z;return i.x=t.ex.x*n+t.ey.x*r+t.ez.x*o,i.y=t.ex.y*n+t.ey.y*r+t.ez.y*o,i.z=t.ex.z*n+t.ey.z*r+t.ez.z*o,i},t.MulM33XYZ=function(t,e,i,n,r){return r.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,r.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,r.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,r},t.MulM33V2=function(t,e,i){var n=e.x,r=e.y;return i.x=t.ex.x*n+t.ey.x*r,i.y=t.ex.y*n+t.ey.y*r,i},t.MulM33XY=function(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n},t}();Pt.IDENTITY=new Pt;var It=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.s=t.s,this.c=t.c,this},e.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},e.SetIdentity=function(){return this.s=0,this.c=1,this},e.GetAngle=function(){return Math.atan2(this.s,this.c)},e.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},e.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,i){var n=t.c,r=t.s,o=e.c,a=e.s;return i.s=r*o+n*a,i.c=n*o-r*a,i},t.MulTRR=function(t,e,i){var n=t.c,r=t.s,o=e.c,a=e.s;return i.s=n*a-r*o,i.c=n*o+r*a,i},t.MulRV=function(t,e,i){var n=t.c,r=t.s,o=e.x,a=e.y;return i.x=n*o-r*a,i.y=r*o+n*a,i},t.MulTRV=function(t,e,i){var n=t.c,r=t.s,o=e.x,a=e.y;return i.x=n*o+r*a,i.y=-r*o+n*a,i},t}();It.IDENTITY=new It;var Rt=function(){function t(){this.p=new At,this.q=new It}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},e.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},e.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},e.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},e.SetPosition=function(t){return this.p.Copy(t),this},e.SetPositionXY=function(t,e){return this.p.Set(t,e),this},e.SetRotation=function(t){return this.q.Copy(t),this},e.SetRotationAngle=function(t){return this.q.SetAngle(t),this},e.GetPosition=function(){return this.p},e.GetRotation=function(){return this.q},e.GetRotationAngle=function(){return this.q.GetAngle()},e.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,i){var n=t.q.c,r=t.q.s,o=e.x,a=e.y;return i.x=n*o-r*a+t.p.x,i.y=r*o+n*a+t.p.y,i},t.MulTXV=function(t,e,i){var n=t.q.c,r=t.q.s,o=e.x-t.p.x,a=e.y-t.p.y;return i.x=n*o+r*a,i.y=-r*o+n*a,i},t.MulXX=function(t,e,i){return It.MulRR(t.q,e.q,i.q),At.AddVV(It.MulRV(t.q,e.p,i.p),t.p,i.p),i},t.MulTXX=function(t,e,i){return It.MulTRR(t.q,e.q,i.q),It.MulTRV(t.q,At.SubVV(e.p,t.p,i.p),i.p),i},t}();Rt.IDENTITY=new Rt;var Dt,Mt=function(){function t(){this.localCenter=new At,this.c0=new At,this.c=new At,this.a0=0,this.a=0,this.alpha0=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},e.GetTransform=function(t,e){var i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;var n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(It.MulRV(t.q,this.localCenter,At.s_t0)),t},e.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t},e.Normalize=function(){var t=tt*Math.floor(this.a0/tt);this.a0-=t,this.a-=t},t}(),Ot=function(){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(e[0]instanceof Float32Array){if(4!==e[0].length)throw new Error;this.data=e[0]}else{var n="number"==typeof e[0]?e[0]:.5,r="number"==typeof e[1]?e[1]:.5,o="number"==typeof e[2]?e[2]:.5,a="number"==typeof e[3]?e[3]:1;this.data=new Float32Array([n,r,o,a])}}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},e.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},e.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},e.Set=function(t,e,i,n){void 0===n&&(n=this.a),this.SetRGBA(t,e,i,n)},e.SetByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},e.SetByteRGBA=function(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this},e.SetRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},e.SetRGBA=function(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this},e.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},e.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},e.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},e.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},e.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},e.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},e.Mix=function(e,i){t.MixColors(this,e,i)},t.MixColors=function(t,e,i){var n=i*(e.r-t.r),r=i*(e.g-t.g),o=i*(e.b-t.b),a=i*(e.a-t.a);t.r+=n,t.g+=r,t.b+=o,t.a+=a,e.r-=n,e.g-=r,e.b-=o,e.a-=a},e.MakeStyleString=function(e){return void 0===e&&(e=this.a),t.MakeStyleString(this.r,this.g,this.b,e)},t.MakeStyleString=function(t,e,i,n){return void 0===n&&(n=1),t*=255,e*=255,i*=255,n<1?"rgba("+t+","+e+","+i+","+n+")":"rgb("+t+","+e+","+i+")"},Q(t,[{key:"r",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"g",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"b",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"a",get:function(){return this.data[3]},set:function(t){this.data[3]=t}}]),t}();Ot.ZERO=new Ot(0,0,0,0),Ot.RED=new Ot(1,0,0),Ot.GREEN=new Ot(0,1,0),Ot.BLUE=new Ot(0,0,1),(Dt=t.b2DrawFlags||(t.b2DrawFlags={}))[Dt.e_none=0]="e_none",Dt[Dt.e_shapeBit=1]="e_shapeBit",Dt[Dt.e_jointBit=2]="e_jointBit",Dt[Dt.e_aabbBit=4]="e_aabbBit",Dt[Dt.e_pairBit=8]="e_pairBit",Dt[Dt.e_centerOfMassBit=16]="e_centerOfMassBit",Dt[Dt.e_particleBit=32]="e_particleBit",Dt[Dt.e_controllerBit=64]="e_controllerBit",Dt[Dt.e_all=63]="e_all";var Bt=function(){function t(){this.m_drawFlags=0}var e=t.prototype;return e.SetFlags=function(t){this.m_drawFlags=t},e.GetFlags=function(){return this.m_drawFlags},e.AppendFlags=function(t){this.m_drawFlags|=t},e.ClearFlags=function(t){this.m_drawFlags&=~t},t}(),Nt=function(){function t(){this.m_start=Date.now()}var e=t.prototype;return e.Reset=function(){return this.m_start=Date.now(),this},e.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),Lt=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}var e=t.prototype;return e.GetCount=function(){return this.m_count},e.GetMinCount=function(){return this.m_min_count},e.GetMaxCount=function(){return this.m_max_count},e.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},e.ResetMinCount=function(){this.m_min_count=0},e.ResetMaxCount=function(){this.m_max_count=0},e.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},e.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),Ft=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=X(t,(function(){return null})),this.m_count=0}var e=t.prototype;return e.Reset=function(){return this.m_count=0,this},e.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},e.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t},e.GetCount=function(){return this.m_count},t}(),zt=function(){},Vt=function(){},kt=function(){function t(){this.m_buffer=At.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}var e=t.prototype;return e.Copy=function(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this},e.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},e.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},e.SetVerticesRadius=function(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i},e.GetSupport=function(t){for(var e=0,i=At.DotVV(this.m_vertices[0],t),n=1;n<this.m_count;++n){var r=At.DotVV(this.m_vertices[n],t);r>i&&(e=n,i=r)}return e},e.GetSupportVertex=function(t){for(var e=0,i=At.DotVV(this.m_vertices[0],t),n=1;n<this.m_count;++n){var r=At.DotVV(this.m_vertices[n],t);r>i&&(e=n,i=r)}return this.m_vertices[e]},e.GetVertexCount=function(){return this.m_count},e.GetVertex=function(t){return this.m_vertices[t]},t}(),Ut=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),Gt=function(){function t(){this.proxyA=new kt,this.proxyB=new kt,this.transformA=new Rt,this.transformB=new Rt,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),Ht=function(){function t(){this.pointA=new At,this.pointB=new At,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}(),jt=function(){this.proxyA=new kt,this.proxyB=new kt,this.transformA=new Rt,this.transformB=new Rt,this.translationB=new At},Wt=function(){this.point=new At,this.normal=new At,this.lambda=0,this.iterations=0};function qt(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;var Xt=function(){function t(){this.wA=new At,this.wB=new At,this.w=new At,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),Yt=function(){function t(){this.m_v1=new Xt,this.m_v2=new Xt,this.m_v3=new Xt,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}var e=t.prototype;return e.ReadCache=function(t,e,i,n,o){this.m_count=t.count;for(var a=this.m_vertices,s=0;s<this.m_count;++s){var c=a[s];c.indexA=t.indexA[s],c.indexB=t.indexB[s];var l=e.GetVertex(c.indexA),u=n.GetVertex(c.indexB);Rt.MulXV(i,l,c.wA),Rt.MulXV(o,u,c.wB),At.SubVV(c.wB,c.wA,c.w),c.a=0}if(this.m_count>1){var h=t.metric,_=this.GetMetric();(_<.5*h||2*h<_||_<r)&&(this.m_count=0)}if(0===this.m_count){var f=a[0];f.indexA=0,f.indexB=0;var p=e.GetVertex(0),d=n.GetVertex(0);Rt.MulXV(i,p,f.wA),Rt.MulXV(o,d,f.wB),At.SubVV(f.wB,f.wA,f.w),f.a=1,this.m_count=1}},e.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB},e.GetSearchDirection=function(t){switch(this.m_count){case 1:return At.NegV(this.m_v1.w,t);case 2:var e=At.SubVV(this.m_v2.w,this.m_v1.w,t);return At.CrossVV(e,At.NegV(this.m_v1.w,At.s_t0))>0?At.CrossOneV(e,t):At.CrossVOne(e,t);default:return t.SetZero()}},e.GetClosestPoint=function(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}},e.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},e.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return At.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return At.CrossVV(At.SubVV(this.m_v2.w,this.m_v1.w,At.s_t0),At.SubVV(this.m_v3.w,this.m_v1.w,At.s_t1));default:return 0}},e.Solve2=function(){var e=this.m_v1.w,i=this.m_v2.w,n=At.SubVV(i,e,t.s_e12),r=-At.DotVV(e,n);if(r<=0)return this.m_v1.a=1,void(this.m_count=1);var o=At.DotVV(i,n);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var a=1/(o+r);this.m_v1.a=o*a,this.m_v2.a=r*a,this.m_count=2},e.Solve3=function(){var e=this.m_v1.w,i=this.m_v2.w,n=this.m_v3.w,r=At.SubVV(i,e,t.s_e12),o=At.DotVV(e,r),a=At.DotVV(i,r),s=-o,c=At.SubVV(n,e,t.s_e13),l=At.DotVV(e,c),u=At.DotVV(n,c),h=-l,_=At.SubVV(n,i,t.s_e23),f=At.DotVV(i,_),p=At.DotVV(n,_),d=-f,m=At.CrossVV(r,c),v=m*At.CrossVV(i,n),g=m*At.CrossVV(n,e),y=m*At.CrossVV(e,i);if(s<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&s>0&&y<=0){var x=1/(a+s);return this.m_v1.a=a*x,this.m_v2.a=s*x,void(this.m_count=2)}if(u>0&&h>0&&g<=0){var S=1/(u+h);return this.m_v1.a=u*S,this.m_v3.a=h*S,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(a<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(u<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(p>0&&d>0&&v<=0){var b=1/(p+d);return this.m_v2.a=p*b,this.m_v3.a=d*b,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var C=1/(v+g+y);this.m_v1.a=v*C,this.m_v2.a=g*C,this.m_v3.a=y*C,this.m_count=3},t}();Yt.s_e12=new At,Yt.s_e13=new At,Yt.s_e23=new At;var Kt=new Yt,Jt=[0,0,0],Qt=[0,0,0],Zt=new At,$t=new At,te=new At,ee=new At,ie=new At;function ne(e,i,n){++t.b2_gjkCalls;var a=n.proxyA,s=n.proxyB,c=n.transformA,l=n.transformB,u=Kt;u.ReadCache(i,a,c,s,l);for(var h=u.m_vertices,_=20,f=Jt,p=Qt,d=0,m=0;m<_;){d=u.m_count;for(var v=0;v<d;++v)f[v]=h[v].indexA,p[v]=h[v].indexB;switch(u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)break;var g=u.GetSearchDirection($t);if(g.LengthSquared()<o)break;var y=h[u.m_count];y.indexA=a.GetSupport(It.MulTRV(c.q,At.NegV(g,At.s_t0),ee)),Rt.MulXV(c,a.GetVertex(y.indexA),y.wA),y.indexB=s.GetSupport(It.MulTRV(l.q,g,ie)),Rt.MulXV(l,s.GetVertex(y.indexB),y.wB),At.SubVV(y.wB,y.wA,y.w),++m,++t.b2_gjkIters;for(var x=!1,S=0;S<d;++S)if(y.indexA===f[S]&&y.indexB===p[S]){x=!0;break}if(x)break;++u.m_count}if(t.b2_gjkMaxIters=rt(t.b2_gjkMaxIters,m),u.GetWitnessPoints(e.pointA,e.pointB),e.distance=At.DistanceVV(e.pointA,e.pointB),e.iterations=m,u.WriteCache(i),n.useRadii){var b=a.m_radius,C=s.m_radius;if(e.distance>b+C&&e.distance>r){e.distance-=b+C;var A=At.SubVV(e.pointB,e.pointA,te);A.Normalize(),e.pointA.SelfMulAdd(b,A),e.pointB.SelfMulSub(C,A)}else{var T=At.MidVV(e.pointA,e.pointB,Zt);e.pointA.Copy(T),e.pointB.Copy(T),e.distance=0}}}var re,oe=new At,ae=new Yt,se=new At,ce=new At,le=new At,ue=new At,he=new At,_e=new At;function fe(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var i=e.proxyA,n=e.proxyB,r=rt(i.m_radius,f)+rt(n.m_radius,f),o=e.transformA,a=e.transformB,s=e.translationB,c=oe.Set(0,0),l=0,u=ae;u.m_count=0;for(var _=u.m_vertices,p=i.GetSupport(It.MulTRV(o.q,At.NegV(s,At.s_t1),At.s_t0)),d=Rt.MulXV(o,i.GetVertex(p),se),m=n.GetSupport(It.MulTRV(a.q,s,At.s_t0)),v=Rt.MulXV(a,n.GetVertex(m),ce),g=At.SubVV(d,v,le),y=rt(f,r-f),x=.5*h,S=20,b=0;b<S&&et(g.Length()-y)>x;){t.iterations+=1,p=i.GetSupport(It.MulTRV(o.q,At.NegV(g,At.s_t1),At.s_t0)),d=Rt.MulXV(o,i.GetVertex(p),se),m=n.GetSupport(It.MulTRV(a.q,g,At.s_t0)),v=Rt.MulXV(a,n.GetVertex(m),ce);var C=At.SubVV(d,v,ue);g.Normalize();var A=At.DotVV(g,C),T=At.DotVV(g,s);if(A-y>l*T){if(T<=0)return!1;if((l=(A-y)/T)>1)return!1;c.Copy(g).SelfNeg(),u.m_count=0}var w=_[u.m_count];switch(w.indexA=m,w.wA.Copy(v).SelfMulAdd(l,s),w.indexB=p,w.wB.Copy(d),w.w.Copy(w.wB).SelfSub(w.wA),w.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)return!1;u.GetClosestPoint(g),++b}var E=he,P=_e;return u.GetWitnessPoints(E,P),g.LengthSquared()>0&&(c.Copy(g).SelfNeg(),c.Normalize()),t.normal.Copy(c),t.lambda=l,t.iterations=b,!0}(re=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[re.e_vertex=0]="e_vertex",re[re.e_face=1]="e_face";var pe,de=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return Q(t,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0}}]),t}(),me=function(){function t(){this.cf=new de}var e=t.prototype;return e.Copy=function(t){return this.key=t.key,this},e.Clone=function(){return(new t).Copy(this)},Q(t,[{key:"key",get:function(){return this.cf.key},set:function(t){this.cf.key=t}}]),t}(),ve=function(){function t(){this.localPoint=new At,this.normalImpulse=0,this.tangentImpulse=0,this.id=new me}t.MakeArray=function(e){return X(e,(function(){return new t}))};var e=t.prototype;return e.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},e.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},t}();(pe=t.b2ManifoldType||(t.b2ManifoldType={}))[pe.e_unknown=-1]="e_unknown",pe[pe.e_circles=0]="e_circles",pe[pe.e_faceA=1]="e_faceA",pe[pe.e_faceB=2]="e_faceB";var ge,ye=function(){function e(){this.points=ve.MakeArray(s),this.localNormal=new At,this.localPoint=new At,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}var i=e.prototype;return i.Reset=function(){for(var e=0;e<s;++e)this.points[e].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0},i.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<s;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},i.Clone=function(){return(new e).Copy(this)},e}(),xe=function(){function e(){this.normal=new At,this.points=At.MakeArray(s),this.separations=K(s)}return e.prototype.Initialize=function(i,n,r,a,s){if(0!==i.pointCount)switch(i.type){case t.b2ManifoldType.e_circles:this.normal.Set(1,0);var c=Rt.MulXV(n,i.localPoint,e.Initialize_s_pointA),l=Rt.MulXV(a,i.points[0].localPoint,e.Initialize_s_pointB);At.DistanceSquaredVV(c,l)>o&&At.SubVV(l,c,this.normal).SelfNormalize();var u=At.AddVMulSV(c,r,this.normal,e.Initialize_s_cA),h=At.SubVMulSV(l,s,this.normal,e.Initialize_s_cB);At.MidVV(u,h,this.points[0]),this.separations[0]=At.DotVV(At.SubVV(h,u,At.s_t0),this.normal);break;case t.b2ManifoldType.e_faceA:It.MulRV(n.q,i.localNormal,this.normal);for(var _=Rt.MulXV(n,i.localPoint,e.Initialize_s_planePoint),f=0;f<i.pointCount;++f){var p=Rt.MulXV(a,i.points[f].localPoint,e.Initialize_s_clipPoint),d=r-At.DotVV(At.SubVV(p,_,At.s_t0),this.normal),m=At.AddVMulSV(p,d,this.normal,e.Initialize_s_cA),v=At.SubVMulSV(p,s,this.normal,e.Initialize_s_cB);At.MidVV(m,v,this.points[f]),this.separations[f]=At.DotVV(At.SubVV(v,m,At.s_t0),this.normal)}break;case t.b2ManifoldType.e_faceB:It.MulRV(a.q,i.localNormal,this.normal);for(var g=Rt.MulXV(a,i.localPoint,e.Initialize_s_planePoint),y=0;y<i.pointCount;++y){var x=Rt.MulXV(n,i.points[y].localPoint,e.Initialize_s_clipPoint),S=s-At.DotVV(At.SubVV(x,g,At.s_t0),this.normal),b=At.AddVMulSV(x,S,this.normal,e.Initialize_s_cB),C=At.SubVMulSV(x,r,this.normal,e.Initialize_s_cA);At.MidVV(C,b,this.points[y]),this.separations[y]=At.DotVV(At.SubVV(C,b,At.s_t0),this.normal)}this.normal.SelfNeg()}},e}();function Se(e,i,n,r){var o;for(o=0;o<n.pointCount;++o){var a=n.points[o].id.key;e[o]=t.b2PointState.b2_removeState;for(var c=0,l=r.pointCount;c<l;++c)if(r.points[c].id.key===a){e[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)e[o]=t.b2PointState.b2_nullState;for(o=0;o<r.pointCount;++o){var u=r.points[o].id.key;i[o]=t.b2PointState.b2_addState;for(var h=0,_=n.pointCount;h<_;++h)if(n.points[h].id.key===u){i[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)i[o]=t.b2PointState.b2_nullState}xe.Initialize_s_pointA=new At,xe.Initialize_s_pointB=new At,xe.Initialize_s_cA=new At,xe.Initialize_s_cB=new At,xe.Initialize_s_planePoint=new At,xe.Initialize_s_clipPoint=new At,(ge=t.b2PointState||(t.b2PointState={}))[ge.b2_nullState=0]="b2_nullState",ge[ge.b2_addState=1]="b2_addState",ge[ge.b2_persistState=2]="b2_persistState",ge[ge.b2_removeState=3]="b2_removeState";var be=function(){function t(){this.v=new At,this.id=new me}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},t}(),Ce=function(){function t(){this.p1=new At,this.p2=new At,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),Ae=function(){function t(){this.normal=new At,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),Te=function(){function t(){this.lowerBound=new At,this.upperBound=new At,this.m_cache_center=new At,this.m_cache_extent=new At}var e=t.prototype;return e.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},e.IsValid=function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)},e.GetCenter=function(){return At.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},e.GetExtents=function(){return At.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},e.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},e.Combine1=function(t){return this.lowerBound.x=it(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=it(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=rt(this.upperBound.x,t.upperBound.x),this.upperBound.y=rt(this.upperBound.y,t.upperBound.y),this},e.Combine2=function(t,e){return this.lowerBound.x=it(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=it(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=rt(t.upperBound.x,e.upperBound.x),this.upperBound.y=rt(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,i){return i.Combine2(t,e),i},e.Contains=function(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)},e.RayCast=function(t,e){var i=-n,o=n,a=e.p1.x,s=e.p1.y,c=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,u=et(c),h=et(l),_=t.normal;if(u<r){if(a<this.lowerBound.x||this.upperBound.x<a)return!1}else{var f=1/c,p=(this.lowerBound.x-a)*f,d=(this.upperBound.x-a)*f,m=-1;if(p>d){var v=p;p=d,d=v,m=1}if(p>i&&(_.x=m,_.y=0,i=p),i>(o=it(o,d)))return!1}if(h<r){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else{var g=1/l,y=(this.lowerBound.y-s)*g,x=(this.upperBound.y-s)*g,S=-1;if(y>x){var b=y;y=x,x=b,S=1}if(y>i&&(_.x=0,_.y=S,i=y),i>(o=it(o,x)))return!1}return!(i<0||e.maxFraction<i||(t.fraction=i,0))},e.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)},e.TestOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)},t}();function we(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function Ee(e,i,n,r,o){var a=0,s=i[0],c=i[1],l=At.DotVV(n,s.v)-r,u=At.DotVV(n,c.v)-r;if(l<=0&&e[a++].Copy(s),u<=0&&e[a++].Copy(c),l*u<0){var h=l/(l-u),_=e[a].v;_.x=s.v.x+h*(c.v.x-s.v.x),_.y=s.v.y+h*(c.v.y-s.v.y);var f=e[a].id;f.cf.indexA=o,f.cf.indexB=s.id.cf.indexB,f.cf.typeA=t.b2ContactFeatureType.e_vertex,f.cf.typeB=t.b2ContactFeatureType.e_face,++a}return a}var Pe=new Gt,Ie=new Ut,Re=new Ht;function De(t,e,i,n,o,a){var s=Pe.Reset();s.proxyA.SetShape(t,e),s.proxyB.SetShape(i,n),s.transformA.Copy(o),s.transformB.Copy(a),s.useRadii=!0;var c=Ie.Reset();c.count=0;var l=Re.Reset();return ne(l,c,s),l.distance<10*r}function Me(t){if(null===t)throw new Error;return t}var Oe=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new Te,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}var e=t.prototype;return e.Reset=function(){this._userData=null},e.IsLeaf=function(){return null===this.child1},Q(t,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t}}]),t}(),Be=function(){function t(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ft(256)}var e=t.prototype;return e.Query=function(t,e){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var n=i.Pop();if(null!==n&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}},e.QueryPoint=function(t,e){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var n=i.Pop();if(null!==n&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}},e.RayCast=function(e,i){var n=e.p1,r=e.p2,o=At.SubVV(r,n,t.s_r);o.Normalize();var a=At.CrossOneV(o,t.s_v),s=At.AbsV(a,t.s_abs_v),c=e.maxFraction,l=t.s_segmentAABB,u=n.x+c*(r.x-n.x),h=n.y+c*(r.y-n.y);l.lowerBound.x=it(n.x,u),l.lowerBound.y=it(n.y,h),l.upperBound.x=rt(n.x,u),l.upperBound.y=rt(n.y,h);var _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){var f=_.Pop();if(null!==f&&we(f.aabb,l)){var p=f.aabb.GetCenter(),d=f.aabb.GetExtents();if(!(et(At.DotVV(a,At.SubVV(n,p,At.s_t0)))-At.DotVV(s,d)>0))if(f.IsLeaf()){var m=t.s_subInput;m.p1.Copy(e.p1),m.p2.Copy(e.p2),m.maxFraction=c;var v=i(m,f);if(0===v)return;v>0&&(c=v,u=n.x+c*(r.x-n.x),h=n.y+c*(r.y-n.y),l.lowerBound.x=it(n.x,u),l.lowerBound.y=it(n.y,h),l.upperBound.x=rt(n.x,u),l.upperBound.y=rt(n.y,h))}else _.Push(f.child1),_.Push(f.child2)}}},e.AllocateNode=function(){if(null!==this.m_freeList){var e=this.m_freeList;return this.m_freeList=e.parent,e.parent=null,e.child1=null,e.child2=null,e.height=0,e}return new Oe(t.s_node_id++)},e.FreeNode=function(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t},e.CreateProxy=function(t,e){var i=this.AllocateNode(),n=l,r=l;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-r,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+r,i.userData=e,i.height=0,this.InsertLeaf(i),i},e.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},e.MoveProxy=function(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var n=l,r=l;t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-r,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+r;var o=u*i.x,a=u*i.y;return o<0?t.aabb.lowerBound.x+=o:t.aabb.upperBound.x+=o,a<0?t.aabb.lowerBound.y+=a:t.aabb.upperBound.y+=a,this.InsertLeaf(t),!0},e.InsertLeaf=function(e){if(++this.m_insertionCount,null===this.m_root)return this.m_root=e,void(this.m_root.parent=null);for(var i=e.aabb,n=this.m_root;!n.IsLeaf();){var r=Me(n.child1),o=Me(n.child2),a=n.aabb.GetPerimeter(),s=t.s_combinedAABB;s.Combine2(n.aabb,i);var c=s.GetPerimeter(),l=2*c,u=2*(c-a),h=void 0,_=t.s_aabb,f=void 0;r.IsLeaf()?(_.Combine2(i,r.aabb),h=_.GetPerimeter()+u):(_.Combine2(i,r.aabb),f=r.aabb.GetPerimeter(),h=_.GetPerimeter()-f+u);var p=void 0;if(o.IsLeaf()?(_.Combine2(i,o.aabb),p=_.GetPerimeter()+u):(_.Combine2(i,o.aabb),f=o.aabb.GetPerimeter(),p=_.GetPerimeter()-f+u),l<h&&l<p)break;n=h<p?r:o}var d=n.parent,m=this.AllocateNode();m.parent=d,m.aabb.Combine2(i,n.aabb),m.height=n.height+1,null!==d?(d.child1===n?d.child1=m:d.child2=m,m.child1=n,m.child2=e,n.parent=m,e.parent=m):(m.child1=n,m.child2=e,n.parent=m,e.parent=m,this.m_root=m);for(var v=e.parent;null!==v;){var g=Me((v=this.Balance(v)).child1),y=Me(v.child2);v.height=1+rt(g.height,y.height),v.aabb.Combine2(g.aabb,y.aabb),v=v.parent}},e.RemoveLeaf=function(t){if(t!==this.m_root){var e=Me(t.parent),i=e&&e.parent,n=Me(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);for(var r=i;null!==r;){var o=Me((r=this.Balance(r)).child1),a=Me(r.child2);r.aabb.Combine2(o.aabb,a.aabb),r.height=1+rt(o.height,a.height),r=r.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}else this.m_root=null},e.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=Me(t.child1),i=Me(t.child2),n=i.height-e.height;if(n>1){var r=Me(i.child1),o=Me(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,r.height>o.height?(i.child2=r,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),i.aabb.Combine2(t.aabb,r.aabb),t.height=1+rt(e.height,o.height),i.height=1+rt(t.height,r.height)):(i.child2=o,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),i.aabb.Combine2(t.aabb,o.aabb),t.height=1+rt(e.height,r.height),i.height=1+rt(t.height,o.height)),i}if(n<-1){var a=Me(e.child1),s=Me(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,a.height>s.height?(e.child2=a,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+rt(i.height,s.height),e.height=1+rt(t.height,a.height)):(e.child2=s,t.child1=a,a.parent=t,t.aabb.Combine2(i.aabb,a.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+rt(i.height,a.height),e.height=1+rt(t.height,s.height)),e}return t},e.GetHeight=function(){return null===this.m_root?0:this.m_root.height},t.GetAreaNode=function(e){if(null===e)return 0;if(e.IsLeaf())return 0;var i=e.aabb.GetPerimeter();return(i+=t.GetAreaNode(e.child1))+t.GetAreaNode(e.child2)},e.GetAreaRatio=function(){if(null===this.m_root)return 0;var e=this.m_root.aabb.GetPerimeter();return t.GetAreaNode(this.m_root)/e},t.ComputeHeightNode=function(e){return null===e||e.IsLeaf()?0:1+rt(t.ComputeHeightNode(e.child1),t.ComputeHeightNode(e.child2))},e.ComputeHeight=function(){return t.ComputeHeightNode(this.m_root)},e.ValidateStructure=function(t){if(null!==t&&(this.m_root,!t.IsLeaf())){var e=Me(t.child1),i=Me(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}},e.ValidateMetrics=function(e){if(null!==e&&!e.IsLeaf()){var i=Me(e.child1),n=Me(e.child2);t.s_aabb.Combine2(i.aabb,n.aabb),this.ValidateMetrics(i),this.ValidateMetrics(n)}},e.Validate=function(){},t.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var i=Me(t.child1),n=Me(t.child2);return rt(e,et(n.height-i.height))},e.GetMaxBalance=function(){return t.GetMaxBalanceNode(this.m_root,0)},e.RebuildBottomUp=function(){this.Validate()},t.ShiftOriginNode=function(e,i){if(null!==e&&!(e.height<=1)){var n=e.child1,r=e.child2;t.ShiftOriginNode(n,i),t.ShiftOriginNode(r,i),e.aabb.lowerBound.SelfSub(i),e.aabb.upperBound.SelfSub(i)}},e.ShiftOrigin=function(e){t.ShiftOriginNode(this.m_root,e)},t}();function Ne(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function Le(t,e){return t<e}function Fe(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===n&&(n=Le);for(var r=e,o=[],a=0;;){for(;r+1<i;i++){var s=t[r+Math.floor(Math.random()*(i-r))];o[a++]=i;for(var c=r-1;;){for(;n(t[++c],s););for(;n(s,t[--i]););if(c>=i)break;Ne(t,c,i)}}if(0===a)break;r=i,i=o[--a]}return t}Be.s_r=new At,Be.s_v=new At,Be.s_abs_v=new At,Be.s_segmentAABB=new Te,Be.s_subInput=new Ce,Be.s_combinedAABB=new Te,Be.s_aabb=new Te,Be.s_node_id=0;var ze=function(t,e){this.proxyA=t,this.proxyB=e},Ve=function(){function t(){this.m_tree=new Be,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}var e=t.prototype;return e.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},e.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},e.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},e.TouchProxy=function(t){this.BufferMove(t)},e.GetProxyCount=function(){return this.m_proxyCount},e.UpdatePairs=function(t){var e=this;this.m_pairCount=0;for(var i=function(t){var i=e.m_moveBuffer[t];if(null===i)return"continue";var n=i.aabb;e.m_tree.Query(n,(function(t){if(t.m_id===i.m_id)return!0;var n,r;if(t.m_id<i.m_id?(n=t,r=i):(n=i,r=t),e.m_pairCount===e.m_pairBuffer.length)e.m_pairBuffer[e.m_pairCount]=new ze(n,r);else{var o=e.m_pairBuffer[e.m_pairCount];o.proxyA=n,o.proxyB=r}return++e.m_pairCount,!0}))},n=0;n<this.m_moveCount;++n)i(n);this.m_moveCount=0,Fe(this.m_pairBuffer,0,this.m_pairCount,ke);for(var r=0;r<this.m_pairCount;){var o=this.m_pairBuffer[r];for(t(o.proxyA.userData,o.proxyB.userData),++r;r<this.m_pairCount;){var a=this.m_pairBuffer[r];if(a.proxyA.m_id!==o.proxyA.m_id||a.proxyB.m_id!==o.proxyB.m_id)break;++r}}},e.Query=function(t,e){this.m_tree.Query(t,e)},e.QueryPoint=function(t,e){this.m_tree.QueryPoint(t,e)},e.RayCast=function(t,e){this.m_tree.RayCast(t,e)},e.GetTreeHeight=function(){return this.m_tree.GetHeight()},e.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},e.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},e.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},e.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},e.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}();function ke(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Ue(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;var Ge,He=new Rt,je=new Rt,We=new At,qe=new At,Xe=new At,Ye=new At,Ke=new At,Je=function(){this.proxyA=new kt,this.proxyB=new kt,this.sweepA=new Mt,this.sweepB=new Mt,this.tMax=0};(Ge=t.b2TOIOutputState||(t.b2TOIOutputState={}))[Ge.e_unknown=0]="e_unknown",Ge[Ge.e_failed=1]="e_failed",Ge[Ge.e_overlapped=2]="e_overlapped",Ge[Ge.e_touching=3]="e_touching",Ge[Ge.e_separated=4]="e_separated";var Qe,Ze=function(){this.state=t.b2TOIOutputState.e_unknown,this.t=0};(Qe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Qe.e_unknown=-1]="e_unknown",Qe[Qe.e_points=0]="e_points",Qe[Qe.e_faceA=1]="e_faceA",Qe[Qe.e_faceB=2]="e_faceB";var $e=function(){function e(){this.m_sweepA=new Mt,this.m_sweepB=new Mt,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new At,this.m_axis=new At}var i=e.prototype;return i.Initialize=function(e,i,n,r,o,a){this.m_proxyA=i,this.m_proxyB=r;var s=e.count;this.m_sweepA.Copy(n),this.m_sweepB.Copy(o);var c=He,l=je;if(this.m_sweepA.GetTransform(c,a),this.m_sweepB.GetTransform(l,a),1===s){this.m_type=t.b2SeparationFunctionType.e_points;var u=this.m_proxyA.GetVertex(e.indexA[0]),h=this.m_proxyB.GetVertex(e.indexB[0]),_=Rt.MulXV(c,u,We),f=Rt.MulXV(l,h,qe);At.SubVV(f,_,this.m_axis);var p=this.m_axis.Normalize();return this.m_localPoint.SetZero(),p}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;var d=this.m_proxyB.GetVertex(e.indexB[0]),m=this.m_proxyB.GetVertex(e.indexB[1]);At.CrossVOne(At.SubVV(m,d,At.s_t0),this.m_axis).SelfNormalize();var v=It.MulRV(l.q,this.m_axis,Xe);At.MidVV(d,m,this.m_localPoint);var g=Rt.MulXV(l,this.m_localPoint,qe),y=this.m_proxyA.GetVertex(e.indexA[0]),x=Rt.MulXV(c,y,We),S=At.DotVV(At.SubVV(x,g,At.s_t0),v);return S<0&&(this.m_axis.SelfNeg(),S=-S),S}this.m_type=t.b2SeparationFunctionType.e_faceA;var b=this.m_proxyA.GetVertex(e.indexA[0]),C=this.m_proxyA.GetVertex(e.indexA[1]);At.CrossVOne(At.SubVV(C,b,At.s_t0),this.m_axis).SelfNormalize();var A=It.MulRV(c.q,this.m_axis,Xe);At.MidVV(b,C,this.m_localPoint);var T=Rt.MulXV(c,this.m_localPoint,We),w=this.m_proxyB.GetVertex(e.indexB[0]),E=Rt.MulXV(l,w,qe),P=At.DotVV(At.SubVV(E,T,At.s_t0),A);return P<0&&(this.m_axis.SelfNeg(),P=-P),P},i.FindMinSeparation=function(e,i,n){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,n),this.m_sweepB.GetTransform(o,n),this.m_type){case t.b2SeparationFunctionType.e_points:var a=It.MulTRV(r.q,this.m_axis,Ye),s=It.MulTRV(o.q,At.NegV(this.m_axis,At.s_t0),Ke);e[0]=this.m_proxyA.GetSupport(a),i[0]=this.m_proxyB.GetSupport(s);var c=this.m_proxyA.GetVertex(e[0]),l=this.m_proxyB.GetVertex(i[0]),u=Rt.MulXV(r,c,We),h=Rt.MulXV(o,l,qe);return At.DotVV(At.SubVV(h,u,At.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var _=It.MulRV(r.q,this.m_axis,Xe),f=Rt.MulXV(r,this.m_localPoint,We),p=It.MulTRV(o.q,At.NegV(_,At.s_t0),Ke);e[0]=-1,i[0]=this.m_proxyB.GetSupport(p);var d=this.m_proxyB.GetVertex(i[0]),m=Rt.MulXV(o,d,qe);return At.DotVV(At.SubVV(m,f,At.s_t0),_);case t.b2SeparationFunctionType.e_faceB:var v=It.MulRV(o.q,this.m_axis,Xe),g=Rt.MulXV(o,this.m_localPoint,qe),y=It.MulTRV(r.q,At.NegV(v,At.s_t0),Ye);i[0]=-1,e[0]=this.m_proxyA.GetSupport(y);var x=this.m_proxyA.GetVertex(e[0]),S=Rt.MulXV(r,x,We);return At.DotVV(At.SubVV(S,g,At.s_t0),v);default:return e[0]=-1,i[0]=-1,0}},i.Evaluate=function(e,i,n){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,n),this.m_sweepB.GetTransform(o,n),this.m_type){case t.b2SeparationFunctionType.e_points:var a=this.m_proxyA.GetVertex(e),s=this.m_proxyB.GetVertex(i),c=Rt.MulXV(r,a,We),l=Rt.MulXV(o,s,qe);return At.DotVV(At.SubVV(l,c,At.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var u=It.MulRV(r.q,this.m_axis,Xe),h=Rt.MulXV(r,this.m_localPoint,We),_=this.m_proxyB.GetVertex(i),f=Rt.MulXV(o,_,qe);return At.DotVV(At.SubVV(f,h,At.s_t0),u);case t.b2SeparationFunctionType.e_faceB:var p=It.MulRV(o.q,this.m_axis,Xe),d=Rt.MulXV(o,this.m_localPoint,qe),m=this.m_proxyA.GetVertex(e),v=Rt.MulXV(r,m,We);return At.DotVV(At.SubVV(v,d,At.s_t0),p);default:return 0}},e}(),ti=new Nt,ei=new Ut,ii=new Gt,ni=new Ht,ri=new $e,oi=[0],ai=[0],si=new Mt,ci=new Mt;function li(e,i){var n=ti.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;var r=i.proxyA,o=i.proxyB,a=rt(c,rt(r.m_count,o.m_count)),s=si.Copy(i.sweepA),l=ci.Copy(i.sweepB);s.Normalize(),l.Normalize();var u=i.tMax,_=r.m_radius+o.m_radius,f=rt(h,_-3*h),p=.25*h,d=0,m=20,v=0,g=ei;g.count=0;var y=ii;for(y.proxyA.Copy(i.proxyA),y.proxyB.Copy(i.proxyB),y.useRadii=!1;;){var x=He,S=je;s.GetTransform(x,d),l.GetTransform(S,d),y.transformA.Copy(x),y.transformB.Copy(S);var b=ni;if(ne(b,g,y),b.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(b.distance<f+p){e.state=t.b2TOIOutputState.e_touching,e.t=d;break}var C=ri;C.Initialize(g,r,s,o,l,d);for(var A=!1,T=u,w=0;;){var E=oi,P=ai,I=C.FindMinSeparation(E,P,T);if(I>f+p){e.state=t.b2TOIOutputState.e_separated,e.t=u,A=!0;break}if(I>f-p){d=T;break}var R=C.Evaluate(E[0],P[0],d);if(R<f-p){e.state=t.b2TOIOutputState.e_failed,e.t=d,A=!0;break}if(R<=f+p){e.state=t.b2TOIOutputState.e_touching,e.t=d,A=!0;break}for(var D=0,M=d,O=T;;){var B=0;B=1&D?M+(f-R)*(O-M)/(I-R):.5*(M+O),++D,++t.b2_toiRootIters;var N=C.Evaluate(E[0],P[0],B);if(et(N-f)<p){T=B;break}if(N>f?(M=B,R=N):(O=B,I=N),50===D)break}if(t.b2_toiMaxRootIters=rt(t.b2_toiMaxRootIters,D),++w===a)break}if(++v,++t.b2_toiIters,A)break;if(v===m){e.state=t.b2TOIOutputState.e_failed,e.t=d;break}}t.b2_toiMaxIters=rt(t.b2_toiMaxIters,v);var L=n.GetMilliseconds();t.b2_toiMaxTime=rt(t.b2_toiMaxTime,L),t.b2_toiTime+=L}var ui=new At,hi=new At;function _i(e,i,n,r,o){e.pointCount=0;var a=Rt.MulXV(n,i.m_p,ui),s=Rt.MulXV(o,r.m_p,hi),c=At.DistanceSquaredVV(a,s),l=i.m_radius+r.m_radius;c>l*l||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0)}var fi=new At,pi=new At,di=new At;function mi(e,i,o,a,s){e.pointCount=0;for(var c=Rt.MulXV(s,a.m_p,fi),l=Rt.MulTXV(o,c,pi),u=0,h=-n,_=i.m_radius+a.m_radius,f=i.m_count,p=i.m_vertices,d=i.m_normals,m=0;m<f;++m){var v=At.DotVV(d[m],At.SubVV(l,p[m],At.s_t0));if(v>_)return;v>h&&(h=v,u=m)}var g=u,y=(g+1)%f,x=p[g],S=p[y];if(h<r)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[u]),At.MidVV(x,S,e.localPoint),e.points[0].localPoint.Copy(a.m_p),void(e.points[0].id.key=0);var b=At.DotVV(At.SubVV(l,x,At.s_t0),At.SubVV(S,x,At.s_t1)),C=At.DotVV(At.SubVV(l,S,At.s_t0),At.SubVV(x,S,At.s_t1));if(b<=0){if(At.DistanceSquaredVV(l,x)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,At.SubVV(l,x,e.localNormal).SelfNormalize(),e.localPoint.Copy(x),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else if(C<=0){if(At.DistanceSquaredVV(l,S)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,At.SubVV(l,S,e.localNormal).SelfNormalize(),e.localPoint.Copy(S),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else{var A=At.MidVV(x,S,di);if(At.DotVV(At.SubVV(l,A,At.s_t1),d[g])>_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[g]).SelfNormalize(),e.localPoint.Copy(A),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}}var vi=new At,gi=new At,yi=new At,xi=new At;function Si(t,e,i,r,o){for(var a=t.m_vertices,s=t.m_normals,c=r.m_count,l=r.m_vertices,u=It.MulRV(e.q,s[i],vi),h=It.MulTRV(o.q,u,gi),_=0,f=n,p=0;p<c;++p){var d=At.DotVV(l[p],h);d<f&&(f=d,_=p)}var m=Rt.MulXV(e,a[i],yi),v=Rt.MulXV(o,l[_],xi);return At.DotVV(At.SubVV(v,m,At.s_t0),u)}var bi=new At,Ci=new At;function Ai(t,e,i,r,o){for(var a=e.m_count,s=e.m_normals,c=At.SubVV(Rt.MulXV(o,r.m_centroid,At.s_t0),Rt.MulXV(i,e.m_centroid,At.s_t1),bi),l=It.MulTRV(i.q,c,Ci),u=0,h=-n,_=0;_<a;++_){var f=At.DotVV(s[_],l);f>h&&(h=f,u=_)}var p=Si(e,i,u,r,o),d=(u+a-1)%a,m=Si(e,i,d,r,o),v=(u+1)%a,g=Si(e,i,v,r,o),y=0,x=0,S=0;if(m>p&&m>g)S=-1,y=d,x=m;else{if(!(g>p))return t[0]=u,p;S=1,y=v,x=g}for(;(p=Si(e,i,u=-1===S?(y+a-1)%a:(y+1)%a,r,o))>x;)y=u,x=p;return t[0]=y,x}var Ti=new At;function wi(e,i,r,o,a,s){for(var c=i.m_normals,l=a.m_count,u=a.m_vertices,h=a.m_normals,_=It.MulTRV(s.q,It.MulRV(r.q,c[o],At.s_t0),Ti),f=0,p=n,d=0;d<l;++d){var m=At.DotVV(_,h[d]);m<p&&(p=m,f=d)}var v=f,g=(v+1)%l,y=e[0];Rt.MulXV(s,u[v],y.v);var x=y.id.cf;x.indexA=o,x.indexB=v,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex;var S=e[1];Rt.MulXV(s,u[g],S.v);var b=S.id.cf;b.indexA=o,b.indexB=g,b.typeA=t.b2ContactFeatureType.e_face,b.typeB=t.b2ContactFeatureType.e_vertex}var Ei=be.MakeArray(2),Pi=be.MakeArray(2),Ii=be.MakeArray(2),Ri=[0],Di=[0],Mi=new At,Oi=new At,Bi=new At,Ni=new At,Li=new At,Fi=new At,zi=new At,Vi=new At;function ki(e,i,n,r,o){e.pointCount=0;var a=i.m_radius+r.m_radius,c=Ri;c[0]=0;var l=Ai(c,i,n,r,o);if(!(l>a)){var u=Di;u[0]=0;var h=Ai(u,r,o,i,n);if(!(h>a)){var _,f,p,d,m=0,v=0;h>.98*l+.001?(_=r,f=i,p=o,d=n,m=u[0],e.type=t.b2ManifoldType.e_faceB,v=1):(_=i,f=r,p=n,d=o,m=c[0],e.type=t.b2ManifoldType.e_faceA,v=0);var g=Ei;wi(g,_,p,m,f,d);var y=_.m_count,x=_.m_vertices,S=m,b=(m+1)%y,C=x[S],A=x[b],T=At.SubVV(A,C,Mi);T.Normalize();var w=At.CrossVOne(T,Oi),E=At.MidVV(C,A,Bi),P=It.MulRV(p.q,T,Li),I=At.CrossVOne(P,Ni),R=Rt.MulXV(p,C,zi),D=Rt.MulXV(p,A,Vi),M=At.DotVV(I,R),O=-At.DotVV(P,R)+a,B=At.DotVV(P,D)+a,N=Pi,L=Ii;if(!(Ee(N,g,At.NegV(P,Fi),O,S)<2||Ee(L,N,P,B,b)<2)){e.localNormal.Copy(w),e.localPoint.Copy(E);for(var F=0,z=0;z<s;++z){var V=L[z];if(At.DotVV(I,V.v)-M<=a){var k=e.points[F];if(Rt.MulTXV(d,V.v,k.localPoint),k.id.Copy(V.id),v){var U=k.id.cf;k.id.cf.indexA=U.indexB,k.id.cf.indexB=U.indexA,k.id.cf.typeA=U.typeB,k.id.cf.typeB=U.typeA}++F}}e.pointCount=F}}}}var Ui,Gi=new At,Hi=new At,ji=new At,Wi=new At,qi=new At,Xi=new At,Yi=new At,Ki=new me;function Ji(e,i,n,r,o){e.pointCount=0;var a=Rt.MulTXV(n,Rt.MulXV(o,r.m_p,At.s_t0),Gi),s=i.m_vertex1,c=i.m_vertex2,l=At.SubVV(c,s,Hi),u=At.DotVV(l,At.SubVV(c,a,At.s_t0)),h=At.DotVV(l,At.SubVV(a,s,At.s_t0)),_=i.m_radius+r.m_radius,f=Ki;if(f.cf.indexB=0,f.cf.typeB=t.b2ContactFeatureType.e_vertex,h<=0){var p=s,d=At.SubVV(a,p,ji);if(At.DotVV(d,d)>_*_)return;if(i.m_hasVertex0){var m=i.m_vertex0,v=s,g=At.SubVV(v,m,Wi);if(At.DotVV(g,At.SubVV(v,a,At.s_t0))>0)return}return f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(p),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}if(u<=0){var y=c,x=At.SubVV(a,y,ji);if(At.DotVV(x,x)>_*_)return;if(i.m_hasVertex3){var S=i.m_vertex3,b=c,C=At.SubVV(S,b,qi);if(At.DotVV(C,At.SubVV(a,b,At.s_t0))>0)return}return f.cf.indexA=1,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(y),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}var A=At.DotVV(l,l),T=Xi;T.x=1/A*(u*s.x+h*c.x),T.y=1/A*(u*s.y+h*c.y);var w=At.SubVV(a,T,ji);if(!(At.DotVV(w,w)>_*_)){var E=Yi.Set(-l.y,l.x);At.DotVV(E,At.SubVV(a,s,At.s_t0))<0&&E.Set(-E.x,-E.y),E.Normalize(),f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(E),e.localPoint.Copy(s),e.points[0].id.Copy(f),e.points[0].localPoint.Copy(r.m_p)}}!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(Ui||(Ui={}));var Qi,Zi=function(){this.type=Ui.e_unknown,this.index=0,this.separation=0},$i=function(){this.vertices=[],this.normals=[],this.count=0},tn=function(){this.i1=0,this.i2=0,this.v1=new At,this.v2=new At,this.normal=new At,this.sideNormal1=new At,this.sideOffset1=0,this.sideNormal2=new At,this.sideOffset2=0};!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Qi||(Qi={}));var en=function(){function e(){this.m_polygonB=new $i,this.m_xf=new Rt,this.m_centroidB=new At,this.m_v0=new At,this.m_v1=new At,this.m_v2=new At,this.m_v3=new At,this.m_normal0=new At,this.m_normal1=new At,this.m_normal2=new At,this.m_normal=new At,this.m_type1=Qi.e_isolated,this.m_type2=Qi.e_isolated,this.m_lowerLimit=new At,this.m_upperLimit=new At,this.m_radius=0,this.m_front=!1}var i=e.prototype;return i.Collide=function(i,n,r,o,a){Rt.MulTXX(r,a,this.m_xf),Rt.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(n.m_vertex0),this.m_v1.Copy(n.m_vertex1),this.m_v2.Copy(n.m_vertex2),this.m_v3.Copy(n.m_vertex3);var c=n.m_hasVertex0,l=n.m_hasVertex3,u=At.SubVV(this.m_v2,this.m_v1,e.s_edge1);u.Normalize(),this.m_normal1.Set(u.y,-u.x);var h=At.DotVV(this.m_normal1,At.SubVV(this.m_centroidB,this.m_v1,At.s_t0)),_=0,f=0,p=!1,d=!1;if(c){var m=At.SubVV(this.m_v1,this.m_v0,e.s_edge0);m.Normalize(),this.m_normal0.Set(m.y,-m.x),p=At.CrossVV(m,u)>=0,_=At.DotVV(this.m_normal0,At.SubVV(this.m_centroidB,this.m_v0,At.s_t0))}if(l){var v=At.SubVV(this.m_v3,this.m_v2,e.s_edge2);v.Normalize(),this.m_normal2.Set(v.y,-v.x),d=At.CrossVV(u,v)>0,f=At.DotVV(this.m_normal2,At.SubVV(this.m_centroidB,this.m_v2,At.s_t0))}c&&l?p&&d?(this.m_front=_>=0||h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=_>=0||h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=f>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):c?p?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?d?(this.m_front=h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var g=0;g<o.m_count;++g)this.m_polygonB.vertices.length<=g&&this.m_polygonB.vertices.push(new At),this.m_polygonB.normals.length<=g&&this.m_polygonB.normals.push(new At),Rt.MulXV(this.m_xf,o.m_vertices[g],this.m_polygonB.vertices[g]),It.MulRV(this.m_xf.q,o.m_normals[g],this.m_polygonB.normals[g]);this.m_radius=o.m_radius+n.m_radius,i.pointCount=0;var y=this.ComputeEdgeSeparation(e.s_edgeAxis);if(y.type!==Ui.e_unknown&&!(y.separation>this.m_radius)){var x=this.ComputePolygonSeparation(e.s_polygonAxis);if(!(x.type!==Ui.e_unknown&&x.separation>this.m_radius)){var S,b=.98,C=.001;S=x.type===Ui.e_unknown?y:x.separation>b*y.separation+C?x:y;var A=e.s_ie,T=e.s_rf;if(S.type===Ui.e_edgeA){i.type=t.b2ManifoldType.e_faceA;for(var w=0,E=At.DotVV(this.m_normal,this.m_polygonB.normals[0]),P=1;P<this.m_polygonB.count;++P){var I=At.DotVV(this.m_normal,this.m_polygonB.normals[P]);I<E&&(E=I,w=P)}var R=w,D=(R+1)%this.m_polygonB.count,M=A[0];M.v.Copy(this.m_polygonB.vertices[R]),M.id.cf.indexA=0,M.id.cf.indexB=R,M.id.cf.typeA=t.b2ContactFeatureType.e_face,M.id.cf.typeB=t.b2ContactFeatureType.e_vertex;var O=A[1];O.v.Copy(this.m_polygonB.vertices[D]),O.id.cf.indexA=0,O.id.cf.indexB=D,O.id.cf.typeA=t.b2ContactFeatureType.e_face,O.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(T.i1=0,T.i2=1,T.v1.Copy(this.m_v1),T.v2.Copy(this.m_v2),T.normal.Copy(this.m_normal1)):(T.i1=1,T.i2=0,T.v1.Copy(this.m_v2),T.v2.Copy(this.m_v1),T.normal.Copy(this.m_normal1).SelfNeg())}else{i.type=t.b2ManifoldType.e_faceB;var B=A[0];B.v.Copy(this.m_v1),B.id.cf.indexA=0,B.id.cf.indexB=S.index,B.id.cf.typeA=t.b2ContactFeatureType.e_vertex,B.id.cf.typeB=t.b2ContactFeatureType.e_face;var N=A[1];N.v.Copy(this.m_v2),N.id.cf.indexA=0,N.id.cf.indexB=S.index,N.id.cf.typeA=t.b2ContactFeatureType.e_vertex,N.id.cf.typeB=t.b2ContactFeatureType.e_face,T.i1=S.index,T.i2=(T.i1+1)%this.m_polygonB.count,T.v1.Copy(this.m_polygonB.vertices[T.i1]),T.v2.Copy(this.m_polygonB.vertices[T.i2]),T.normal.Copy(this.m_polygonB.normals[T.i1])}T.sideNormal1.Set(T.normal.y,-T.normal.x),T.sideNormal2.Copy(T.sideNormal1).SelfNeg(),T.sideOffset1=At.DotVV(T.sideNormal1,T.v1),T.sideOffset2=At.DotVV(T.sideNormal2,T.v2);var L=e.s_clipPoints1,F=e.s_clipPoints2;if(!(Ee(L,A,T.sideNormal1,T.sideOffset1,T.i1)<s||Ee(F,L,T.sideNormal2,T.sideOffset2,T.i2)<s)){S.type===Ui.e_edgeA?(i.localNormal.Copy(T.normal),i.localPoint.Copy(T.v1)):(i.localNormal.Copy(o.m_normals[T.i1]),i.localPoint.Copy(o.m_vertices[T.i1]));for(var z=0,V=0;V<s;++V)if(At.DotVV(T.normal,At.SubVV(F[V].v,T.v1,At.s_t0))<=this.m_radius){var k=i.points[z];S.type===Ui.e_edgeA?(Rt.MulTXV(this.m_xf,F[V].v,k.localPoint),k.id.Copy(F[V].id)):(k.localPoint.Copy(F[V].v),k.id.cf.typeA=F[V].id.cf.typeB,k.id.cf.typeB=F[V].id.cf.typeA,k.id.cf.indexA=F[V].id.cf.indexB,k.id.cf.indexB=F[V].id.cf.indexA),++z}i.pointCount=z}}}},i.ComputeEdgeSeparation=function(t){var e=t;e.type=Ui.e_edgeA,e.index=this.m_front?0:1,e.separation=n;for(var i=0;i<this.m_polygonB.count;++i){var r=At.DotVV(this.m_normal,At.SubVV(this.m_polygonB.vertices[i],this.m_v1,At.s_t0));r<e.separation&&(e.separation=r)}return e},i.ComputePolygonSeparation=function(t){var i=t;i.type=Ui.e_unknown,i.index=-1,i.separation=-n;for(var r=e.s_perp.Set(-this.m_normal.y,this.m_normal.x),o=0;o<this.m_polygonB.count;++o){var a=At.NegV(this.m_polygonB.normals[o],e.s_n),s=it(At.DotVV(a,At.SubVV(this.m_polygonB.vertices[o],this.m_v1,At.s_t0)),At.DotVV(a,At.SubVV(this.m_polygonB.vertices[o],this.m_v2,At.s_t0)));if(s>this.m_radius)return i.type=Ui.e_edgeB,i.index=o,i.separation=s,i;if(At.DotVV(a,r)>=0){if(At.DotVV(At.SubVV(a,this.m_upperLimit,At.s_t0),this.m_normal)<-_)continue}else if(At.DotVV(At.SubVV(a,this.m_lowerLimit,At.s_t0),this.m_normal)<-_)continue;s>i.separation&&(i.type=Ui.e_edgeB,i.index=o,i.separation=s)}return i},e}();en.s_edge1=new At,en.s_edge0=new At,en.s_edge2=new At,en.s_ie=be.MakeArray(2),en.s_rf=new tn,en.s_clipPoints1=be.MakeArray(2),en.s_clipPoints2=be.MakeArray(2),en.s_edgeAxis=new Zi,en.s_polygonAxis=new Zi,en.s_n=new At,en.s_perp=new At;var nn=new en;function rn(t,e,i,n,r){nn.Collide(t,e,i,n,r)}var on,an=function(){this.mass=0,this.center=new At(0,0),this.I=0};(on=t.b2ShapeType||(t.b2ShapeType={}))[on.e_unknown=-1]="e_unknown",on[on.e_circleShape=0]="e_circleShape",on[on.e_edgeShape=1]="e_edgeShape",on[on.e_polygonShape=2]="e_polygonShape",on[on.e_chainShape=3]="e_chainShape",on[on.e_shapeTypeCount=4]="e_shapeTypeCount";var sn=function(){function e(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}var i=e.prototype;return i.Copy=function(t){return this.m_radius=t.m_radius,this},i.GetType=function(){return this.m_type},e}(),cn=function(e){function i(i){var n;return void 0===i&&(i=0),(n=e.call(this,t.b2ShapeType.e_circleShape,i)||this).m_p=new At,n}$(i,e);var n=i.prototype;return n.Set=function(t,e){return void 0===e&&(e=this.m_radius),this.m_p.Copy(t),this.m_radius=e,this},n.Clone=function(){return(new i).Copy(this)},n.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},n.GetChildCount=function(){return 1},n.TestPoint=function(t,e){var n=Rt.MulXV(t,this.m_p,i.TestPoint_s_center),r=At.SubVV(e,n,i.TestPoint_s_d);return At.DotVV(r,r)<=lt(this.m_radius)},n.ComputeDistance=function(t,e,n){var r=Rt.MulXV(t,this.m_p,i.ComputeDistance_s_center);return At.SubVV(e,r,n),n.Normalize()-this.m_radius},n.RayCast=function(t,e,n){var o=Rt.MulXV(n,this.m_p,i.RayCast_s_position),a=At.SubVV(e.p1,o,i.RayCast_s_s),s=At.DotVV(a,a)-lt(this.m_radius),c=At.SubVV(e.p2,e.p1,i.RayCast_s_r),l=At.DotVV(a,c),u=At.DotVV(c,c),h=l*l-u*s;if(h<0||u<r)return!1;var _=-(l+ht(h));return 0<=_&&_<=e.maxFraction*u&&(_/=u,t.fraction=_,At.AddVMulSV(a,_,c,t.normal).SelfNormalize(),!0)},n.ComputeAABB=function(t,e){var n=Rt.MulXV(e,this.m_p,i.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)},n.ComputeMass=function(t,e){var i=lt(this.m_radius);t.mass=e*a*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+At.DotVV(this.m_p,this.m_p))},n.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},n.ComputeSubmergedArea=function(t,e,i,n){var o=Rt.MulXV(i,this.m_p,new At),s=-(At.DotVV(t,o)-e);if(s<-this.m_radius+r)return 0;if(s>this.m_radius)return n.Copy(o),a*this.m_radius*this.m_radius;var c=this.m_radius*this.m_radius,l=s*s,u=c*(gt(s/this.m_radius)+a/2)+s*ht(c-l),h=-2/3*_t(c-l,1.5)/u;return n.x=o.x+t.x*h,n.y=o.y+t.y*h,u},n.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},i}(sn);cn.TestPoint_s_center=new At,cn.TestPoint_s_d=new At,cn.ComputeDistance_s_center=new At,cn.RayCast_s_position=new At,cn.RayCast_s_s=new At,cn.RayCast_s_r=new At,cn.ComputeAABB_s_p=new At;var ln=function(e){function i(){var i;return(i=e.call(this,t.b2ShapeType.e_polygonShape,f)||this).m_centroid=new At(0,0),i.m_vertices=[],i.m_normals=[],i.m_count=0,i}$(i,e);var o=i.prototype;return o.Clone=function(){return(new i).Copy(this)},o.Copy=function(t){e.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=At.MakeArray(this.m_count),this.m_normals=At.MakeArray(this.m_count);for(var i=0;i<this.m_count;++i)this.m_vertices[i].Copy(t.m_vertices[i]),this.m_normals[i].Copy(t.m_normals[i]);return this},o.GetChildCount=function(){return 1},o.Set=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if("number"==typeof e[0][0]){var n=e[0];if(n.length%2!=0)throw new Error;return this._Set((function(t){return{x:n[2*t],y:n[2*t+1]}}),n.length/2)}var r=e[0],o=e[1]||r.length;return this._Set((function(t){return r[t]}),o)},o._Set=function(t,e){if(e<3)return this.SetAsBox(1,1);for(var n=e,r=[],o=0;o<n;++o){for(var a=t(o),s=!0,c=0;c<r.length;++c)if(At.DistanceSquaredVV(a,r[c])<.25*h*h){s=!1;break}s&&r.push(a)}if((n=r.length)<3)return this.SetAsBox(1,1);for(var l=0,u=r[0].x,_=1;_<n;++_){var f=r[_].x;(f>u||f===u&&r[_].y<r[l].y)&&(l=_,u=f)}for(var p=[],d=0,m=l;;){p[d]=m;for(var v=0,g=1;g<n;++g)if(v!==m){var y=At.SubVV(r[v],r[p[d]],i.Set_s_r),x=At.SubVV(r[g],r[p[d]],i.Set_s_v),S=At.CrossVV(y,x);S<0&&(v=g),0===S&&x.LengthSquared()>y.LengthSquared()&&(v=g)}else v=g;if(++d,m=v,v===l)break}this.m_count=d,this.m_vertices=At.MakeArray(this.m_count),this.m_normals=At.MakeArray(this.m_count);for(var b=0;b<d;++b)this.m_vertices[b].Copy(r[p[b]]);for(var C=0;C<d;++C){var A=this.m_vertices[C],T=this.m_vertices[(C+1)%d],w=At.SubVV(T,A,At.s_t0);At.CrossVOne(w,this.m_normals[C]).SelfNormalize()}return i.ComputeCentroid(this.m_vertices,d,this.m_centroid),this},o.SetAsBox=function(t,e,i,n){if(void 0===n&&(n=0),this.m_count=4,this.m_vertices=At.MakeArray(this.m_count),this.m_normals=At.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);var r=new Rt;r.SetPosition(i),r.SetRotationAngle(n);for(var o=0;o<this.m_count;++o)Rt.MulXV(r,this.m_vertices[o],this.m_vertices[o]),It.MulRV(r.q,this.m_normals[o],this.m_normals[o])}return this},o.TestPoint=function(t,e){for(var n=Rt.MulTXV(t,e,i.TestPoint_s_pLocal),r=0;r<this.m_count;++r)if(At.DotVV(this.m_normals[r],At.SubVV(n,this.m_vertices[r],At.s_t0))>0)return!1;return!0},o.ComputeDistance=function(t,e,r){for(var o=Rt.MulTXV(t,e,i.ComputeDistance_s_pLocal),a=-n,s=i.ComputeDistance_s_normalForMaxDistance.Copy(o),c=0;c<this.m_count;++c){var l=At.DotVV(this.m_normals[c],At.SubVV(o,this.m_vertices[c],At.s_t0));l>a&&(a=l,s.Copy(this.m_normals[c]))}if(a>0){for(var u=i.ComputeDistance_s_minDistance.Copy(s),h=a*a,_=0;_<this.m_count;++_){var f=At.SubVV(o,this.m_vertices[_],i.ComputeDistance_s_distance),p=f.LengthSquared();h>p&&(u.Copy(f),h=p)}return It.MulRV(t.q,u,r),r.Normalize(),Math.sqrt(h)}return It.MulRV(t.q,s,r),a},o.RayCast=function(t,e,n){for(var r=Rt.MulTXV(n,e.p1,i.RayCast_s_p1),o=Rt.MulTXV(n,e.p2,i.RayCast_s_p2),a=At.SubVV(o,r,i.RayCast_s_d),s=0,c=e.maxFraction,l=-1,u=0;u<this.m_count;++u){var h=At.DotVV(this.m_normals[u],At.SubVV(this.m_vertices[u],r,At.s_t0)),_=At.DotVV(this.m_normals[u],a);if(0===_){if(h<0)return!1}else _<0&&h<s*_?(s=h/_,l=u):_>0&&h<c*_&&(c=h/_);if(c<s)return!1}return l>=0&&(t.fraction=s,It.MulRV(n.q,this.m_normals[l],t.normal),!0)},o.ComputeAABB=function(t,e){for(var n=Rt.MulXV(e,this.m_vertices[0],t.lowerBound),r=t.upperBound.Copy(n),o=0;o<this.m_count;++o){var a=Rt.MulXV(e,this.m_vertices[o],i.ComputeAABB_s_v);At.MinV(a,n,n),At.MaxV(a,r,r)}var s=this.m_radius;n.SelfSubXY(s,s),r.SelfAddXY(s,s)},o.ComputeMass=function(t,e){for(var n=i.ComputeMass_s_center.SetZero(),r=0,o=0,a=i.ComputeMass_s_s.SetZero(),s=0;s<this.m_count;++s)a.SelfAdd(this.m_vertices[s]);a.SelfMul(1/this.m_count);for(var c=1/3,l=0;l<this.m_count;++l){var u=At.SubVV(this.m_vertices[l],a,i.ComputeMass_s_e1),h=At.SubVV(this.m_vertices[(l+1)%this.m_count],a,i.ComputeMass_s_e2),_=At.CrossVV(u,h),f=.5*_;r+=f,n.SelfAdd(At.MulSV(f*c,At.AddVV(u,h,At.s_t0),At.s_t1));var p=u.x,d=u.y,m=h.x,v=h.y;o+=.25*c*_*(p*p+m*p+m*m+d*d+v*d+v*v)}t.mass=e*r,n.SelfMul(1/r),At.AddVV(n,a,t.center),t.I=e*o,t.I+=t.mass*(At.DotVV(t.center,t.center)-At.DotVV(n,n))},o.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,n=(t+1)%this.m_count,r=this.m_vertices[e],o=At.SubVV(this.m_vertices[n],r,i.Validate_s_e),a=0;a<this.m_count;++a)if(a!==e&&a!==n){var s=At.SubVV(this.m_vertices[a],r,i.Validate_s_v);if(At.CrossVV(o,s)<0)return!1}return!0},o.SetupDistanceProxy=function(t){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},o.ComputeSubmergedArea=function(t,e,n,o){for(var a=It.MulTRV(n.q,t,i.ComputeSubmergedArea_s_normalL),s=e-At.DotVV(t,n.p),c=[],l=0,u=-1,h=-1,_=!1,f=0;f<this.m_count;++f){c[f]=At.DotVV(a,this.m_vertices[f])-s;var p=c[f]<-r;f>0&&(p?_||(u=f-1,l++):_&&(h=f-1,l++)),_=p}switch(l){case 0:if(_){var d=i.ComputeSubmergedArea_s_md;return this.ComputeMass(d,1),Rt.MulXV(n,d.center,o),d.mass}return 0;case 1:-1===u?u=this.m_count-1:h=this.m_count-1}for(var m,v=(u+1)%this.m_count,g=(h+1)%this.m_count,y=(0-c[u])/(c[v]-c[u]),x=(0-c[h])/(c[g]-c[h]),S=i.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[u].x*(1-y)+this.m_vertices[v].x*y,this.m_vertices[u].y*(1-y)+this.m_vertices[v].y*y),b=i.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[g].y*x),C=0,A=i.ComputeSubmergedArea_s_center.SetZero(),T=this.m_vertices[v],w=v;w!==g;){m=(w=(w+1)%this.m_count)===g?b:this.m_vertices[w];var E=.5*((T.x-S.x)*(m.y-S.y)-(T.y-S.y)*(m.x-S.x));C+=E,A.x+=E*(S.x+T.x+m.x)/3,A.y+=E*(S.y+T.y+m.y)/3,T=m}return A.SelfMul(1/C),Rt.MulXV(n,A,o),C},o.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},i.ComputeCentroid=function(t,e,n){var r=n;r.SetZero();for(var o=0,a=i.ComputeCentroid_s_pRef.SetZero(),s=1/3,c=0;c<e;++c){var l=a,u=t[c],h=t[(c+1)%e],_=At.SubVV(u,l,i.ComputeCentroid_s_e1),f=At.SubVV(h,l,i.ComputeCentroid_s_e2),p=.5*At.CrossVV(_,f);o+=p,r.x+=p*s*(l.x+u.x+h.x),r.y+=p*s*(l.y+u.y+h.y)}return r.SelfMul(1/o),r},i}(sn);ln.Set_s_r=new At,ln.Set_s_v=new At,ln.TestPoint_s_pLocal=new At,ln.ComputeDistance_s_pLocal=new At,ln.ComputeDistance_s_normalForMaxDistance=new At,ln.ComputeDistance_s_minDistance=new At,ln.ComputeDistance_s_distance=new At,ln.RayCast_s_p1=new At,ln.RayCast_s_p2=new At,ln.RayCast_s_d=new At,ln.ComputeAABB_s_v=new At,ln.ComputeMass_s_center=new At,ln.ComputeMass_s_s=new At,ln.ComputeMass_s_e1=new At,ln.ComputeMass_s_e2=new At,ln.Validate_s_e=new At,ln.Validate_s_v=new At,ln.ComputeSubmergedArea_s_normalL=new At,ln.ComputeSubmergedArea_s_md=new an,ln.ComputeSubmergedArea_s_intoVec=new At,ln.ComputeSubmergedArea_s_outoVec=new At,ln.ComputeSubmergedArea_s_center=new At,ln.ComputeCentroid_s_pRef=new At,ln.ComputeCentroid_s_e1=new At,ln.ComputeCentroid_s_e2=new At;var un=function(e){function i(){var i;return(i=e.call(this,t.b2ShapeType.e_edgeShape,f)||this).m_vertex1=new At,i.m_vertex2=new At,i.m_vertex0=new At,i.m_vertex3=new At,i.m_hasVertex0=!1,i.m_hasVertex3=!1,i}$(i,e);var n=i.prototype;return n.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},n.Clone=function(){return(new i).Copy(this)},n.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},n.GetChildCount=function(){return 1},n.TestPoint=function(){return!1},n.ComputeDistance=function(t,e,n){var r=Rt.MulXV(t,this.m_vertex1,i.ComputeDistance_s_v1),o=Rt.MulXV(t,this.m_vertex2,i.ComputeDistance_s_v2),a=At.SubVV(e,r,i.ComputeDistance_s_d),s=At.SubVV(o,r,i.ComputeDistance_s_s),c=At.DotVV(a,s);if(c>0){var l=At.DotVV(s,s);c>l?At.SubVV(e,o,a):a.SelfMulSub(c/l,s)}return n.Copy(a),n.Normalize()},n.RayCast=function(t,e,n){var r=Rt.MulTXV(n,e.p1,i.RayCast_s_p1),o=Rt.MulTXV(n,e.p2,i.RayCast_s_p2),a=At.SubVV(o,r,i.RayCast_s_d),s=this.m_vertex1,c=this.m_vertex2,l=At.SubVV(c,s,i.RayCast_s_e),u=t.normal.Set(l.y,-l.x).SelfNormalize(),h=At.DotVV(u,At.SubVV(s,r,At.s_t0)),_=At.DotVV(u,a);if(0===_)return!1;var f=h/_;if(f<0||e.maxFraction<f)return!1;var p=At.AddVMulSV(r,f,a,i.RayCast_s_q),d=At.SubVV(c,s,i.RayCast_s_r),m=At.DotVV(d,d);if(0===m)return!1;var v=At.DotVV(At.SubVV(p,s,At.s_t0),d)/m;return!(v<0||1<v||(t.fraction=f,It.MulRV(n.q,t.normal,t.normal),h>0&&t.normal.SelfNeg(),0))},n.ComputeAABB=function(t,e){var n=Rt.MulXV(e,this.m_vertex1,i.ComputeAABB_s_v1),r=Rt.MulXV(e,this.m_vertex2,i.ComputeAABB_s_v2);At.MinV(n,r,t.lowerBound),At.MaxV(n,r,t.upperBound);var o=this.m_radius;t.lowerBound.SelfSubXY(o,o),t.upperBound.SelfAddXY(o,o)},n.ComputeMass=function(t){t.mass=0,At.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},n.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},n.ComputeSubmergedArea=function(t,e,i,n){return n.SetZero(),0},n.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},i}(sn);un.ComputeDistance_s_v1=new At,un.ComputeDistance_s_v2=new At,un.ComputeDistance_s_d=new At,un.ComputeDistance_s_s=new At,un.RayCast_s_p1=new At,un.RayCast_s_p2=new At,un.RayCast_s_d=new At,un.RayCast_s_e=new At,un.RayCast_s_q=new At,un.RayCast_s_r=new At,un.ComputeAABB_s_v1=new At,un.ComputeAABB_s_v2=new At;var hn=function(e){function i(){var i;return(i=e.call(this,t.b2ShapeType.e_chainShape,f)||this).m_vertices=[],i.m_count=0,i.m_prevVertex=new At,i.m_nextVertex=new At,i.m_hasPrevVertex=!1,i.m_hasNextVertex=!1,i}$(i,e);var n=i.prototype;return n.CreateLoop=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if("number"==typeof e[0][0]){var n=e[0];if(n.length%2!=0)throw new Error;return this._CreateLoop((function(t){return{x:n[2*t],y:n[2*t+1]}}),n.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateLoop((function(t){return r[t]}),o)},n._CreateLoop=function(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=At.MakeArray(this.m_count);for(var i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},n.CreateChain=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if("number"==typeof e[0][0]){var n=e[0];if(n.length%2!=0)throw new Error;return this._CreateChain((function(t){return{x:n[2*t],y:n[2*t+1]}}),n.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateChain((function(t){return r[t]}),o)},n._CreateChain=function(t,e){this.m_count=e,this.m_vertices=At.MakeArray(e);for(var i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},n.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},n.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},n.Clone=function(){return(new i).Copy(this)},n.Copy=function(t){return e.prototype.Copy.call(this,t),this._CreateChain((function(e){return t.m_vertices[e]}),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},n.GetChildCount=function(){return this.m_count-1},n.GetChildEdge=function(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)},n.TestPoint=function(){return!1},n.ComputeDistance=function(t,e,n,r){var o=i.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,r),o.ComputeDistance(t,e,n,0)},n.RayCast=function(t,e,n,r){var o=i.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[r]),o.m_vertex2.Copy(this.m_vertices[(r+1)%this.m_count]),o.RayCast(t,e,n,0)},n.ComputeAABB=function(t,e,n){var r=this.m_vertices[n],o=this.m_vertices[(n+1)%this.m_count],a=Rt.MulXV(e,r,i.ComputeAABB_s_v1),s=Rt.MulXV(e,o,i.ComputeAABB_s_v2);At.MinV(a,s,t.lowerBound),At.MaxV(a,s,t.upperBound)},n.ComputeMass=function(t){t.mass=0,t.center.SetZero(),t.I=0},n.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},n.ComputeSubmergedArea=function(t,e,i,n){return n.SetZero(),0},n.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},i}(sn);hn.ComputeDistance_s_edgeShape=new un,hn.RayCast_s_edgeShape=new un,hn.ComputeAABB_s_v1=new At,hn.ComputeAABB_s_v2=new At;var _n=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t}();_n.DEFAULT=new _n;var fn=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _n},pn=function(){function t(t,e){this.aabb=new Te,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}var e=t.prototype;return e.Reset=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)},e.Touch=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)},e.Synchronize=function(e,i,n){if(e===i)this.fixture.m_shape.ComputeAABB(this.aabb,e,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,n);else{var r=t.Synchronize_s_aabb1,o=t.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(r,e,this.childIndex),this.fixture.m_shape.ComputeAABB(o,i,this.childIndex),this.aabb.Combine2(r,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,n)}},t}();pn.Synchronize_s_aabb1=new Te,pn.Synchronize_s_aabb2=new Te;var dn,mn=function(){function t(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _n,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=i(e.userData,null),this.m_friction=i(e.friction,.2),this.m_restitution=i(e.restitution,0),this.m_filter.Copy(i(e.filter,_n.DEFAULT)),this.m_isSensor=i(e.isSensor,!1),this.m_density=i(e.density,0)}var e=t.prototype;return e.Reset=function(){},e.GetType=function(){return this.m_shape.GetType()},e.GetShape=function(){return this.m_shape},e.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},e.IsSensor=function(){return this.m_isSensor},e.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},e.GetFilterData=function(){return this.m_filter},e.Refilter=function(){for(var t=this.m_body.GetContactList();t;){var e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!==this&&n!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()},e.GetBody=function(){return this.m_body},e.GetNext=function(){return this.m_next},e.GetUserData=function(){return this.m_userData},e.SetUserData=function(t){this.m_userData=t},e.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},e.ComputeDistance=function(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)},e.RayCast=function(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)},e.GetMassData=function(t){return void 0===t&&(t=new an),this.m_shape.ComputeMass(t,this.m_density),t},e.SetDensity=function(t){this.m_density=t},e.GetDensity=function(){return this.m_density},e.GetFriction=function(){return this.m_friction},e.SetFriction=function(t){this.m_friction=t},e.GetRestitution=function(){return this.m_restitution},e.SetRestitution=function(t){this.m_restitution=t},e.GetAABB=function(t){return this.m_proxies[t].aabb},e.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},e.CreateProxies=function(){if(0!==this.m_proxies.length)throw new Error;for(var t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new pn(this,t)},e.DestroyProxies=function(){for(var t,e=st(this.m_proxies);!(t=e()).done;)t.value.Reset();this.m_proxies.length=0},e.TouchProxies=function(){for(var t,e=st(this.m_proxies);!(t=e()).done;)t.value.Touch()},e.SynchronizeProxies=function(t,e,i){for(var n,r=st(this.m_proxies);!(n=r()).done;)n.value.Synchronize(t,e,i)},Q(t,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}}]),t}();(dn=t.b2BodyType||(t.b2BodyType={}))[dn.b2_unknown=-1]="b2_unknown",dn[dn.b2_staticBody=0]="b2_staticBody",dn[dn.b2_kinematicBody=1]="b2_kinematicBody",dn[dn.b2_dynamicBody=2]="b2_dynamicBody";var vn,gn,yn=function(){this.type=t.b2BodyType.b2_staticBody,this.position=new At(0,0),this.angle=0,this.linearVelocity=new At(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},xn=function(){function e(e,n){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Rt,this.m_xf0=new Rt,this.m_sweep=new Mt,this.m_linearVelocity=new At,this.m_angularVelocity=0,this.m_force=new At,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=i(e.bullet,!1),this.m_fixedRotationFlag=i(e.fixedRotation,!1),this.m_autoSleepFlag=i(e.allowSleep,!0),this.m_awakeFlag=i(e.awake,!0),this.m_activeFlag=i(e.active,!0),this.m_world=n,this.m_xf.p.Copy(i(e.position,At.ZERO)),this.m_xf.q.SetAngle(i(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(i(e.linearVelocity,At.ZERO)),this.m_angularVelocity=i(e.angularVelocity,0),this.m_linearDamping=i(e.linearDamping,0),this.m_angularDamping=i(e.angularDamping,0),this.m_gravityScale=i(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=i(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}var n=e.prototype;return n.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof sn?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},n.CreateFixtureDef=function(t){if(this.m_world.IsLocked())throw new Error;var e=new mn(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},n.CreateFixtureShapeDensity=function(t,i){void 0===i&&(i=0);var n=e.CreateFixtureShapeDensity_s_def;return n.shape=t,n.density=i,this.CreateFixtureDef(n)},n.DestroyFixture=function(t){if(this.m_world.IsLocked())throw new Error;for(var e=this.m_fixtureList,i=null;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}for(var n=this.m_contactList;n;){var r=n.contact;n=n.next;var o=r.GetFixtureA(),a=r.GetFixtureB();t!==o&&t!==a||this.m_world.m_contactManager.Destroy(r)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()},n.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},n.SetTransformXY=function(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(var n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(this.m_xf,this.m_xf,At.ZERO);this.m_world.m_contactManager.FindNewContacts()},n.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},n.GetTransform=function(){return this.m_xf},n.GetPosition=function(){return this.m_xf.p},n.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},n.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},n.GetAngle=function(){return this.m_sweep.a},n.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},n.GetWorldCenter=function(){return this.m_sweep.c},n.GetLocalCenter=function(){return this.m_sweep.localCenter},n.SetLinearVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(At.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))},n.GetLinearVelocity=function(){return this.m_linearVelocity},n.SetAngularVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)},n.GetAngularVelocity=function(){return this.m_angularVelocity},n.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},n.ApplyForce=function(e,i,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))},n.ApplyForceToCenter=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))},n.ApplyTorque=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))},n.ApplyLinearImpulse=function(e,i,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))},n.ApplyLinearImpulseToCenter=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))},n.ApplyAngularImpulse=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))},n.GetMass=function(){return this.m_mass},n.GetInertia=function(){return this.m_I+this.m_mass*At.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},n.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*At.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},n.SetMassData=function(i){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=i.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,i.I>0&&!this.m_fixedRotationFlag&&(this.m_I=i.I-this.m_mass*At.DotVV(i.center,i.center),this.m_invI=1/this.m_I);var n=e.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(i.center),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),At.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,At.SubVV(this.m_sweep.c,n,At.s_t0),this.m_linearVelocity)}},n.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var i=e.ResetMassData_s_localCenter.SetZero(),n=this.m_fixtureList;n;n=n.m_next)if(0!==n.m_density){var r=n.GetMassData(e.ResetMassData_s_massData);this.m_mass+=r.mass,i.x+=r.center.x*r.mass,i.y+=r.center.y*r.mass,this.m_I+=r.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,i.x*=this.m_invMass,i.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*At.DotVV(i,i),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=e.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(i),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),At.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,At.SubVV(this.m_sweep.c,o,At.s_t0),this.m_linearVelocity)},n.GetWorldPoint=function(t,e){return Rt.MulXV(this.m_xf,t,e)},n.GetWorldVector=function(t,e){return It.MulRV(this.m_xf.q,t,e)},n.GetLocalPoint=function(t,e){return Rt.MulTXV(this.m_xf,t,e)},n.GetLocalVector=function(t,e){return It.MulTRV(this.m_xf.q,t,e)},n.GetLinearVelocityFromWorldPoint=function(t,e){return At.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,At.SubVV(t,this.m_sweep.c,At.s_t0),e)},n.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},n.GetLinearDamping=function(){return this.m_linearDamping},n.SetLinearDamping=function(t){this.m_linearDamping=t},n.GetAngularDamping=function(){return this.m_angularDamping},n.SetAngularDamping=function(t){this.m_angularDamping=t},n.GetGravityScale=function(){return this.m_gravityScale},n.SetGravityScale=function(t){this.m_gravityScale=t},n.SetType=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==e){this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var i=this.m_contactList;i;){var n=i;i=i.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null;for(var r=this.m_fixtureList;r;r=r.m_next)r.TouchProxies()}},n.GetType=function(){return this.m_type},n.SetBullet=function(t){this.m_bulletFlag=t},n.IsBullet=function(){return this.m_bulletFlag},n.SetSleepingAllowed=function(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)},n.IsSleepingAllowed=function(){return this.m_autoSleepFlag},n.SetAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},n.IsAwake=function(){return this.m_awakeFlag},n.SetActive=function(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(var e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(var i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxies();for(var n=this.m_contactList;n;){var r=n;n=n.next,this.m_world.m_contactManager.Destroy(r.contact)}this.m_contactList=null}},n.IsActive=function(){return this.m_activeFlag},n.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},n.IsFixedRotation=function(){return this.m_fixedRotationFlag},n.GetFixtureList=function(){return this.m_fixtureList},n.GetJointList=function(){return this.m_jointList},n.GetContactList=function(){return this.m_contactList},n.GetNext=function(){return this.m_next},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.GetWorld=function(){return this.m_world},n.Dump=function(e){var i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");var n="";switch(this.m_type){case t.b2BodyType.b2_staticBody:n="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:n="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:n="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",n),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(var r=this.m_fixtureList;r;r=r.m_next)e("  {\n"),r.Dump(e,i),e("  }\n");e("}\n")},n.SynchronizeFixtures=function(){var t=e.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),It.MulRV(t.q,this.m_sweep.localCenter,t.p),At.SubVV(this.m_sweep.c0,t.p,t.p);for(var i=At.SubVV(this.m_sweep.c,this.m_sweep.c0,e.SynchronizeFixtures_s_displacement),n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(t,this.m_xf,i)},n.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),At.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},n.ShouldCollide=function(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)},n.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},n.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),At.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},n.GetControllerList=function(){return this.m_controllerList},n.GetControllerCount=function(){return this.m_controllerCount},e}();xn.CreateFixtureShapeDensity_s_def=new fn,xn.SetMassData_s_oldCenter=new At,xn.ResetMassData_s_localCenter=new At,xn.ResetMassData_s_oldCenter=new At,xn.ResetMassData_s_massData=new an,xn.SynchronizeFixtures_s_xf1=new Rt,xn.SynchronizeFixtures_s_displacement=new At,(gn=t.b2JointType||(t.b2JointType={}))[gn.e_unknownJoint=0]="e_unknownJoint",gn[gn.e_revoluteJoint=1]="e_revoluteJoint",gn[gn.e_prismaticJoint=2]="e_prismaticJoint",gn[gn.e_distanceJoint=3]="e_distanceJoint",gn[gn.e_pulleyJoint=4]="e_pulleyJoint",gn[gn.e_mouseJoint=5]="e_mouseJoint",gn[gn.e_gearJoint=6]="e_gearJoint",gn[gn.e_wheelJoint=7]="e_wheelJoint",gn[gn.e_weldJoint=8]="e_weldJoint",gn[gn.e_frictionJoint=9]="e_frictionJoint",gn[gn.e_ropeJoint=10]="e_ropeJoint",gn[gn.e_motorJoint=11]="e_motorJoint",gn[gn.e_areaJoint=12]="e_areaJoint",(vn=t.b2LimitState||(t.b2LimitState={}))[vn.e_inactiveLimit=0]="e_inactiveLimit",vn[vn.e_atLowerLimit=1]="e_atLowerLimit",vn[vn.e_atUpperLimit=2]="e_atUpperLimit",vn[vn.e_equalLimits=3]="e_equalLimits";var Sn=function(){function t(){this.linear=new At,this.angularA=0,this.angularB=0}var e=t.prototype;return e.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},e.Set=function(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this},t}(),bn=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.joint=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},Q(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),Cn=function(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e},An=function(){function e(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new bn(this),this.m_edgeB=new bn(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=i(e.collideConnected,!1),this.m_userData=i(e.userData,null)}var n=e.prototype;return n.GetType=function(){return this.m_type},n.GetBodyA=function(){return this.m_bodyA},n.GetBodyB=function(){return this.m_bodyB},n.GetNext=function(){return this.m_next},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},n.GetCollideConnected=function(){return this.m_collideConnected},n.Dump=function(t){t("// Dump is not supported for this joint type.\n")},n.ShiftOrigin=function(){},e}(),Tn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_distanceJoint)||this).localAnchorA=new At,i.localAnchorB=new At,i.length=1,i.frequencyHz=0,i.dampingRatio=0,i}return $(i,e),i.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=At.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0},i}(Cn),wn=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_bias=0,n.m_localAnchorA=new At,n.m_localAnchorB=new At,n.m_gamma=0,n.m_impulse=0,n.m_length=0,n.m_indexA=0,n.m_indexB=0,n.m_u=new At,n.m_rA=new At,n.m_rB=new At,n.m_localCenterA=new At,n.m_localCenterB=new At,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_mass=0,n.m_qA=new It,n.m_qB=new It,n.m_lalcA=new At,n.m_lalcB=new At,n.m_frequencyHz=i(e.frequencyHz,0),n.m_dampingRatio=i(e.dampingRatio,0),n.m_localAnchorA.Copy(e.localAnchorA),n.m_localAnchorB.Copy(e.localAnchorB),n.m_length=e.length,n}$(e,t);var n=e.prototype;return n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e},n.GetReactionTorque=function(){return 0},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.SetLength=function(t){this.m_length=t},n.Length=function(){return this.m_length},n.SetFrequency=function(t){this.m_frequencyHz=t},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t},n.GetDampingRatio=function(){return this.m_dampingRatio},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(n),f=this.m_qB.SetAngle(c);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.x=s.x+this.m_rB.x-i.x-this.m_rA.x,this.m_u.y=s.y+this.m_rB.y-i.y-this.m_rA.y;var p=this.m_u.Length();p>h?this.m_u.SelfMul(1/p):this.m_u.SetZero();var d=At.CrossVV(this.m_rA,this.m_u),m=At.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,this.m_frequencyHz>0){var g=p-this.m_length,y=2*a*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*y,S=this.m_mass*y*y,b=t.step.dt;this.m_gamma=b*(x+b*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*b*S*this.m_gamma,v+=this.m_gamma,this.m_mass=0!==v?1/v:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var C=At.MulSV(this.m_impulse,this.m_u,e.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,C),o-=this.m_invIA*At.CrossVV(this.m_rA,C),l.SelfMulAdd(this.m_invMassB,C),u+=this.m_invIB*At.CrossVV(this.m_rB,C)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=u},n.SolveVelocityConstraints=function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=At.AddVCrossSV(i,n,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=At.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=At.DotVV(this.m_u,At.SubVV(s,a,At.s_t0)),l=-this.m_mass*(c+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;var u=At.MulSV(l,this.m_u,e.SolveVelocityConstraints_s_P);i.SelfMulSub(this.m_invMassA,u),n-=this.m_invIA*At.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*At.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o),c=It.MulRV(a,this.m_lalcA,this.m_rA),l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u;u.x=r.x+l.x-i.x-c.x,u.y=r.y+l.y-i.y-c.y;var _=this.m_u.Normalize()-this.m_length;_=ot(_,-v,v);var f=-this.m_mass*_,p=At.MulSV(f,u,e.SolvePositionConstraints_s_P);return i.SelfMulSub(this.m_invMassA,p),n-=this.m_invIA*At.CrossVV(c,p),r.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*At.CrossVV(l,p),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,et(_)<h},e}(An);wn.InitVelocityConstraints_s_P=new At,wn.SolveVelocityConstraints_s_vpA=new At,wn.SolveVelocityConstraints_s_vpB=new At,wn.SolveVelocityConstraints_s_P=new At,wn.SolvePositionConstraints_s_P=new At;var En=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_areaJoint)||this).bodies=[],i.frequencyHz=0,i.dampingRatio=0,i}return $(i,e),i.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},i}(Cn),Pn=function(t){function e(e){var n;(n=t.call(this,e)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_impulse=0,n.m_targetArea=0,n.m_delta=new At,n.m_bodies=e.bodies,n.m_frequencyHz=i(e.frequencyHz,0),n.m_dampingRatio=i(e.dampingRatio,0),n.m_targetLengths=K(e.bodies.length),n.m_normals=At.MakeArray(e.bodies.length),n.m_joints=[],n.m_deltas=At.MakeArray(e.bodies.length);var r=new Tn;r.frequencyHz=n.m_frequencyHz,r.dampingRatio=n.m_dampingRatio,n.m_targetArea=0;for(var o=0;o<n.m_bodies.length;++o){var a=n.m_bodies[o],s=n.m_bodies[(o+1)%n.m_bodies.length],c=a.GetWorldCenter(),l=s.GetWorldCenter();n.m_targetLengths[o]=At.DistanceVV(c,l),n.m_targetArea+=At.CrossVV(c,l),r.Initialize(a,s,c,l),n.m_joints[o]=a.GetWorld().CreateJoint(r)}return n.m_targetArea*=.5,n}$(e,t);var n=e.prototype;return n.GetAnchorA=function(t){return t},n.GetAnchorB=function(t){return t},n.GetReactionForce=function(t,e){return e},n.GetReactionTorque=function(){return 0},n.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},n.GetDampingRatio=function(){return this.m_dampingRatio},n.Dump=function(t){t("Area joint dumping is not supported.\n")},n.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],r=t.positions[i.m_islandIndex].c,o=t.positions[n.m_islandIndex].c,a=this.m_deltas[e];At.SubVV(o,r,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(var s=0;s<this.m_bodies.length;++s){var c=this.m_bodies[s],l=t.velocities[c.m_islandIndex].v,u=this.m_deltas[s];l.x+=c.m_invMass*u.y*.5*this.m_impulse,l.y+=c.m_invMass*-u.x*.5*this.m_impulse}}else this.m_impulse=0},n.SolveVelocityConstraints=function(t){for(var e=0,i=0,n=0;n<this.m_bodies.length;++n){var r=this.m_bodies[n],o=t.velocities[r.m_islandIndex].v,a=this.m_deltas[n];e+=a.LengthSquared()/r.GetMass(),i+=At.CrossVV(o,a)}var s=-2*i/e;this.m_impulse+=s;for(var c=0;c<this.m_bodies.length;++c){var l=this.m_bodies[c],u=t.velocities[l.m_islandIndex].v,h=this.m_deltas[c];u.x+=l.m_invMass*h.y*.5*s,u.y+=l.m_invMass*-h.x*.5*s}},n.SolvePositionConstraints=function(t){for(var e=0,i=0,n=0;n<this.m_bodies.length;++n){var o=this.m_bodies[n],a=this.m_bodies[(n+1)%this.m_bodies.length],s=t.positions[o.m_islandIndex].c,c=t.positions[a.m_islandIndex].c,l=At.SubVV(c,s,this.m_delta),u=l.Length();u<r&&(u=1),this.m_normals[n].x=l.y/u,this.m_normals[n].y=-l.x/u,e+=u,i+=At.CrossVV(s,c)}i*=.5;for(var _=.5*(this.m_targetArea-i)/e,f=!0,p=0;p<this.m_bodies.length;++p){var d=this.m_bodies[p],m=t.positions[d.m_islandIndex].c,g=(p+1)%this.m_bodies.length,y=At.AddVV(this.m_normals[p],this.m_normals[g],this.m_delta);y.SelfMul(_);var x=y.LengthSquared();x>lt(v)&&y.SelfMul(v/ht(x)),x>lt(h)&&(f=!1),m.x+=y.x,m.y+=y.y}return f},e}(An),In=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_frictionJoint)||this).localAnchorA=new At,i.localAnchorB=new At,i.maxForce=0,i.maxTorque=0,i}return $(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)},i}(Cn),Rn=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_localAnchorA=new At,n.m_localAnchorB=new At,n.m_linearImpulse=new At,n.m_angularImpulse=0,n.m_maxForce=0,n.m_maxTorque=0,n.m_indexA=0,n.m_indexB=0,n.m_rA=new At,n.m_rB=new At,n.m_localCenterA=new At,n.m_localCenterB=new At,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_linearMass=new Et,n.m_angularMass=0,n.m_qA=new It,n.m_qB=new It,n.m_lalcA=new At,n.m_lalcB=new At,n.m_K=new Et,n.m_localAnchorA.Copy(e.localAnchorA),n.m_localAnchorB.Copy(e.localAnchorB),n.m_linearImpulse.SetZero(),n.m_maxForce=i(e.maxForce,0),n.m_maxTorque=i(e.maxTorque,0),n.m_linearMass.SetZero(),n}$(e,t);var n=e.prototype;return n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,a=t.velocities[this.m_indexB].w,s=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(r);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=It.MulRV(s,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var u=It.MulRV(c,this.m_lalcB,this.m_rB),h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+f*l.y*l.y+p*u.y*u.y,d.ex.y=-f*l.x*l.y-p*u.x*u.y,d.ey.x=d.ex.y,d.ey.y=h+_+f*l.x*l.x+p*u.x*u.x,d.GetInverse(this.m_linearMass),this.m_angularMass=f+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var m=this.m_linearImpulse;i.SelfMulSub(h,m),n-=f*(At.CrossVV(this.m_rA,m)+this.m_angularImpulse),o.SelfMulAdd(_,m),a+=p*(At.CrossVV(this.m_rB,m)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a},n.SolveVelocityConstraints=function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=o-n,_=-this.m_angularMass*h,f=this.m_angularImpulse,p=u*this.m_maxTorque;this.m_angularImpulse=ot(this.m_angularImpulse+_,-p,p),n-=c*(_=this.m_angularImpulse-f),o+=l*_;var d=At.SubVV(At.AddVCrossSV(r,o,this.m_rB,At.s_t0),At.AddVCrossSV(i,n,this.m_rA,At.s_t1),e.SolveVelocityConstraints_s_Cdot_v2),m=Et.MulMV(this.m_linearMass,d,e.SolveVelocityConstraints_s_impulseV).SelfNeg(),v=e.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);var g=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>g*g&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(g)),At.SubVV(this.m_linearImpulse,v,m),i.SelfMulSub(a,m),n-=c*At.CrossVV(this.m_rA,m),r.SelfMulAdd(s,m),o+=l*At.CrossVV(this.m_rB,m),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(){return!0},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e},n.GetReactionTorque=function(t){return t*this.m_angularImpulse},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.SetMaxForce=function(t){this.m_maxForce=t},n.GetMaxForce=function(){return this.m_maxForce},n.SetMaxTorque=function(t){this.m_maxTorque=t},n.GetMaxTorque=function(){return this.m_maxTorque},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(An);Rn.SolveVelocityConstraints_s_Cdot_v2=new At,Rn.SolveVelocityConstraints_s_impulseV=new At,Rn.SolveVelocityConstraints_s_oldImpulseV=new At;var Dn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_gearJoint)||this).ratio=1,i}return $(i,e),i}(Cn),Mn=function(e){function n(n){var r,o,a;(r=e.call(this,n)||this).m_typeA=t.b2JointType.e_unknownJoint,r.m_typeB=t.b2JointType.e_unknownJoint,r.m_localAnchorA=new At,r.m_localAnchorB=new At,r.m_localAnchorC=new At,r.m_localAnchorD=new At,r.m_localAxisC=new At,r.m_localAxisD=new At,r.m_referenceAngleA=0,r.m_referenceAngleB=0,r.m_constant=0,r.m_ratio=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_indexC=0,r.m_indexD=0,r.m_lcA=new At,r.m_lcB=new At,r.m_lcC=new At,r.m_lcD=new At,r.m_mA=0,r.m_mB=0,r.m_mC=0,r.m_mD=0,r.m_iA=0,r.m_iB=0,r.m_iC=0,r.m_iD=0,r.m_JvAC=new At,r.m_JvBD=new At,r.m_JwA=0,r.m_JwB=0,r.m_JwC=0,r.m_JwD=0,r.m_mass=0,r.m_qA=new It,r.m_qB=new It,r.m_qC=new It,r.m_qD=new It,r.m_lalcA=new At,r.m_lalcB=new At,r.m_lalcC=new At,r.m_lalcD=new At,r.m_joint1=n.joint1,r.m_joint2=n.joint2,r.m_typeA=r.m_joint1.GetType(),r.m_typeB=r.m_joint2.GetType(),r.m_bodyC=r.m_joint1.GetBodyA(),r.m_bodyA=r.m_joint1.GetBodyB();var s=r.m_bodyA.m_xf,c=r.m_bodyA.m_sweep.a,l=r.m_bodyC.m_xf,u=r.m_bodyC.m_sweep.a;if(r.m_typeA===t.b2JointType.e_revoluteJoint){var h=n.joint1;r.m_localAnchorC.Copy(h.m_localAnchorA),r.m_localAnchorA.Copy(h.m_localAnchorB),r.m_referenceAngleA=h.m_referenceAngle,r.m_localAxisC.SetZero(),o=c-u-r.m_referenceAngleA}else{var _=n.joint1;r.m_localAnchorC.Copy(_.m_localAnchorA),r.m_localAnchorA.Copy(_.m_localAnchorB),r.m_referenceAngleA=_.m_referenceAngle,r.m_localAxisC.Copy(_.m_localXAxisA);var f=r.m_localAnchorC,p=It.MulTRV(l.q,At.AddVV(It.MulRV(s.q,r.m_localAnchorA,At.s_t0),At.SubVV(s.p,l.p,At.s_t1),At.s_t0),At.s_t0);o=At.DotVV(At.SubVV(p,f,At.s_t0),r.m_localAxisC)}r.m_bodyD=r.m_joint2.GetBodyA(),r.m_bodyB=r.m_joint2.GetBodyB();var d=r.m_bodyB.m_xf,m=r.m_bodyB.m_sweep.a,v=r.m_bodyD.m_xf,g=r.m_bodyD.m_sweep.a;if(r.m_typeB===t.b2JointType.e_revoluteJoint){var y=n.joint2;r.m_localAnchorD.Copy(y.m_localAnchorA),r.m_localAnchorB.Copy(y.m_localAnchorB),r.m_referenceAngleB=y.m_referenceAngle,r.m_localAxisD.SetZero(),a=m-g-r.m_referenceAngleB}else{var x=n.joint2;r.m_localAnchorD.Copy(x.m_localAnchorA),r.m_localAnchorB.Copy(x.m_localAnchorB),r.m_referenceAngleB=x.m_referenceAngle,r.m_localAxisD.Copy(x.m_localXAxisA);var S=r.m_localAnchorD,b=It.MulTRV(v.q,At.AddVV(It.MulRV(d.q,r.m_localAnchorB,At.s_t0),At.SubVV(d.p,v.p,At.s_t1),At.s_t0),At.s_t0);a=At.DotVV(At.SubVV(b,S,At.s_t0),r.m_localAxisD)}return r.m_ratio=i(n.ratio,1),r.m_constant=o+r.m_ratio*a,r.m_impulse=0,r}$(n,e);var r=n.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var i=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=e.positions[this.m_indexC].a,u=e.velocities[this.m_indexC].v,h=e.velocities[this.m_indexC].w,_=e.positions[this.m_indexD].a,f=e.velocities[this.m_indexD].v,p=e.velocities[this.m_indexD].w,d=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(a),v=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var y=It.MulRV(v,this.m_localAxisC,n.InitVelocityConstraints_s_u);At.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var x=It.MulRV(v,this.m_lalcC,n.InitVelocityConstraints_s_rC);At.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var S=It.MulRV(d,this.m_lalcA,n.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(y),this.m_JwC=At.CrossVV(x,y),this.m_JwA=At.CrossVV(S,y),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var b=It.MulRV(g,this.m_localAxisD,n.InitVelocityConstraints_s_u);At.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var C=It.MulRV(g,this.m_lalcD,n.InitVelocityConstraints_s_rD);At.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var A=It.MulRV(m,this.m_lalcB,n.InitVelocityConstraints_s_rB);At.MulSV(this.m_ratio,b,this.m_JvBD),this.m_JwD=this.m_ratio*At.CrossVV(C,b),this.m_JwB=this.m_ratio*At.CrossVV(A,b),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(r.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,s.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),c+=this.m_iB*this.m_impulse*this.m_JwB,u.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,f.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),p-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=p},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,n=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=t.velocities[this.m_indexC].v,a=t.velocities[this.m_indexC].w,s=t.velocities[this.m_indexD].v,c=t.velocities[this.m_indexD].w,l=At.DotVV(this.m_JvAC,At.SubVV(e,o,At.s_t0))+At.DotVV(this.m_JvBD,At.SubVV(n,s,At.s_t0));l+=this.m_JwA*i-this.m_JwC*a+(this.m_JwB*r-this.m_JwD*c);var u=-this.m_mass*l;this.m_impulse+=u,e.SelfMulAdd(this.m_mA*u,this.m_JvAC),i+=this.m_iA*u*this.m_JwA,n.SelfMulAdd(this.m_mB*u,this.m_JvBD),r+=this.m_iB*u*this.m_JwB,o.SelfMulSub(this.m_mC*u,this.m_JvAC),a-=this.m_iC*u*this.m_JwC,s.SelfMulSub(this.m_mD*u,this.m_JvBD),c-=this.m_iD*u*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=c},r.SolvePositionConstraints=function(e){var i,r,o,a,s,c,l=e.positions[this.m_indexA].c,u=e.positions[this.m_indexA].a,_=e.positions[this.m_indexB].c,f=e.positions[this.m_indexB].a,p=e.positions[this.m_indexC].c,d=e.positions[this.m_indexC].a,m=e.positions[this.m_indexD].c,v=e.positions[this.m_indexD].a,g=this.m_qA.SetAngle(u),y=this.m_qB.SetAngle(f),x=this.m_qC.SetAngle(d),S=this.m_qD.SetAngle(v),b=0,C=this.m_JvAC,A=this.m_JvBD,T=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)C.SetZero(),o=1,s=1,T+=this.m_iA+this.m_iC,i=u-d-this.m_referenceAngleA;else{var w=It.MulRV(x,this.m_localAxisC,n.SolvePositionConstraints_s_u),E=It.MulRV(x,this.m_lalcC,n.SolvePositionConstraints_s_rC),P=It.MulRV(g,this.m_lalcA,n.SolvePositionConstraints_s_rA);C.Copy(w),s=At.CrossVV(E,w),o=At.CrossVV(P,w),T+=this.m_mC+this.m_mA+this.m_iC*s*s+this.m_iA*o*o;var I=this.m_lalcC,R=It.MulTRV(x,At.AddVV(P,At.SubVV(l,p,At.s_t0),At.s_t0),At.s_t0);i=At.DotVV(At.SubVV(R,I,At.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)A.SetZero(),a=this.m_ratio,c=this.m_ratio,T+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),r=f-v-this.m_referenceAngleB;else{var D=It.MulRV(S,this.m_localAxisD,n.SolvePositionConstraints_s_u),M=It.MulRV(S,this.m_lalcD,n.SolvePositionConstraints_s_rD),O=It.MulRV(y,this.m_lalcB,n.SolvePositionConstraints_s_rB);At.MulSV(this.m_ratio,D,A),c=this.m_ratio*At.CrossVV(M,D),a=this.m_ratio*At.CrossVV(O,D),T+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*c*c+this.m_iB*a*a;var B=this.m_lalcD,N=It.MulTRV(S,At.AddVV(O,At.SubVV(_,m,At.s_t0),At.s_t0),At.s_t0);r=At.DotVV(At.SubVV(N,B,At.s_t0),this.m_localAxisD)}var L=i+this.m_ratio*r-this.m_constant,F=0;return T>0&&(F=-L/T),l.SelfMulAdd(this.m_mA*F,C),u+=this.m_iA*F*o,_.SelfMulAdd(this.m_mB*F,A),f+=this.m_iB*F*a,p.SelfMulSub(this.m_mC*F,C),d-=this.m_iC*F*s,m.SelfMulSub(this.m_mD*F,A),v-=this.m_iD*F*c,e.positions[this.m_indexA].a=u,e.positions[this.m_indexB].a=f,e.positions[this.m_indexC].a=d,e.positions[this.m_indexD].a=v,b<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return At.MulSV(t*this.m_impulse,this.m_JvAC,e)},r.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},r.GetJoint1=function(){return this.m_joint1},r.GetJoint2=function(){return this.m_joint2},r.GetRatio=function(){return this.m_ratio},r.SetRatio=function(t){this.m_ratio=t},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,r=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",n),t("  jd.joint2 = joints[%d];\n",r),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(An);Mn.InitVelocityConstraints_s_u=new At,Mn.InitVelocityConstraints_s_rA=new At,Mn.InitVelocityConstraints_s_rB=new At,Mn.InitVelocityConstraints_s_rC=new At,Mn.InitVelocityConstraints_s_rD=new At,Mn.SolvePositionConstraints_s_u=new At,Mn.SolvePositionConstraints_s_rA=new At,Mn.SolvePositionConstraints_s_rB=new At,Mn.SolvePositionConstraints_s_rC=new At,Mn.SolvePositionConstraints_s_rD=new At;var On=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_motorJoint)||this).linearOffset=new At(0,0),i.angularOffset=0,i.maxForce=1,i.maxTorque=1,i.correctionFactor=.3,i}return $(i,e),i.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i},i}(Cn),Bn=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_linearOffset=new At,n.m_angularOffset=0,n.m_linearImpulse=new At,n.m_angularImpulse=0,n.m_maxForce=0,n.m_maxTorque=0,n.m_correctionFactor=.3,n.m_indexA=0,n.m_indexB=0,n.m_rA=new At,n.m_rB=new At,n.m_localCenterA=new At,n.m_localCenterB=new At,n.m_linearError=new At,n.m_angularError=0,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_linearMass=new Et,n.m_angularMass=0,n.m_qA=new It,n.m_qB=new It,n.m_K=new Et,n.m_linearOffset.Copy(i(e.linearOffset,At.ZERO)),n.m_linearImpulse.SetZero(),n.m_maxForce=i(e.maxForce,0),n.m_maxTorque=i(e.maxTorque,0),n.m_correctionFactor=i(e.correctionFactor,.3),n}$(e,t);var n=e.prototype;return n.GetAnchorA=function(t){var e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},n.GetAnchorB=function(t){var e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},n.GetReactionForce=function(t,e){return At.MulSV(t,this.m_linearImpulse,e)},n.GetReactionTorque=function(t){return t*this.m_angularImpulse},n.SetLinearOffset=function(t){At.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},n.GetLinearOffset=function(){return this.m_linearOffset},n.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},n.GetAngularOffset=function(){return this.m_angularOffset},n.SetMaxForce=function(t){this.m_maxForce=t},n.GetMaxForce=function(){return this.m_maxForce},n.SetMaxTorque=function(t){this.m_maxTorque=t},n.GetMaxTorque=function(){return this.m_maxTorque},n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(i),u=this.m_qB.SetAngle(a),h=It.MulRV(l,At.SubVV(this.m_linearOffset,this.m_localCenterA,At.s_t0),this.m_rA),_=It.MulRV(u,At.NegV(this.m_localCenterB,At.s_t0),this.m_rB),f=this.m_invMassA,p=this.m_invMassB,d=this.m_invIA,m=this.m_invIB,v=this.m_K;if(v.ex.x=f+p+d*h.y*h.y+m*_.y*_.y,v.ex.y=-d*h.x*h.y-m*_.x*_.y,v.ey.x=v.ex.y,v.ey.y=f+p+d*h.x*h.x+m*_.x*_.x,v.GetInverse(this.m_linearMass),this.m_angularMass=d+m,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),At.SubVV(At.AddVV(o,_,At.s_t0),At.AddVV(e,h,At.s_t1),this.m_linearError),this.m_angularError=a-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var g=this.m_linearImpulse;n.SelfMulSub(f,g),r-=d*(At.CrossVV(h,g)+this.m_angularImpulse),s.SelfMulAdd(p,g),c+=m*(At.CrossVV(_,g)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},n.SolveVelocityConstraints=function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=t.step.inv_dt,_=o-n+h*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*_,p=this.m_angularImpulse,d=u*this.m_maxTorque;this.m_angularImpulse=ot(this.m_angularImpulse+f,-d,d),n-=c*(f=this.m_angularImpulse-p),o+=l*f;var m=this.m_rA,v=this.m_rB,g=At.AddVV(At.SubVV(At.AddVV(r,At.CrossSV(o,v,At.s_t0),At.s_t0),At.AddVV(i,At.CrossSV(n,m,At.s_t1),At.s_t1),At.s_t2),At.MulSV(h*this.m_correctionFactor,this.m_linearError,At.s_t3),e.SolveVelocityConstraints_s_Cdot_v2),y=Et.MulMV(this.m_linearMass,g,e.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),x=e.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);var S=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>S*S&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(S)),At.SubVV(this.m_linearImpulse,x,y),i.SelfMulSub(a,y),n-=c*At.CrossVV(m,y),r.SelfMulAdd(s,y),o+=l*At.CrossVV(v,y),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(){return!0},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(An);Bn.SolveVelocityConstraints_s_Cdot_v2=new At,Bn.SolveVelocityConstraints_s_impulse_v2=new At,Bn.SolveVelocityConstraints_s_oldImpulse_v2=new At;var Nn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_mouseJoint)||this).target=new At,i.maxForce=0,i.frequencyHz=5,i.dampingRatio=.7,i}return $(i,e),i}(Cn),Ln=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_localAnchorB=new At,n.m_targetA=new At,n.m_frequencyHz=0,n.m_dampingRatio=0,n.m_beta=0,n.m_impulse=new At,n.m_maxForce=0,n.m_gamma=0,n.m_indexA=0,n.m_indexB=0,n.m_rB=new At,n.m_localCenterB=new At,n.m_invMassB=0,n.m_invIB=0,n.m_mass=new Et,n.m_C=new At,n.m_qB=new It,n.m_lalcB=new At,n.m_K=new Et,n.m_targetA.Copy(i(e.target,At.ZERO)),Rt.MulTXV(n.m_bodyB.GetTransform(),n.m_targetA,n.m_localAnchorB),n.m_maxForce=i(e.maxForce,0),n.m_impulse.SetZero(),n.m_frequencyHz=i(e.frequencyHz,0),n.m_dampingRatio=i(e.dampingRatio,0),n.m_beta=0,n.m_gamma=0,n}$(e,t);var n=e.prototype;return n.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},n.GetTarget=function(){return this.m_targetA},n.SetMaxForce=function(t){this.m_maxForce=t},n.GetMaxForce=function(){return this.m_maxForce},n.SetFrequency=function(t){this.m_frequencyHz=t},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t},n.GetDampingRatio=function(){return this.m_dampingRatio},n.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=this.m_qB.SetAngle(i),s=this.m_bodyB.GetMass(),c=2*a*this.m_frequencyHz,l=2*s*this.m_dampingRatio*c,u=s*c*c,h=t.step.dt;this.m_gamma=h*(l+h*u),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=h*u*this.m_gamma,At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(o,this.m_lalcB,this.m_rB);var _=this.m_K;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,_.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*At.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=r},n.SolveVelocityConstraints=function(t){var i=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,r=At.AddVCrossSV(i,n,this.m_rB,e.SolveVelocityConstraints_s_Cdot),o=Et.MulMV(this.m_mass,At.AddVV(r,At.AddVV(this.m_C,At.MulSV(this.m_gamma,this.m_impulse,At.s_t0),At.s_t0),At.s_t0).SelfNeg(),e.SolveVelocityConstraints_s_impulse),a=e.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);var s=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>s*s&&this.m_impulse.SelfMul(s/this.m_impulse.Length()),At.SubVV(this.m_impulse,a,o),i.SelfMulAdd(this.m_invMassB,o),n+=this.m_invIB*At.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=n},n.SolvePositionConstraints=function(){return!0},n.GetAnchorA=function(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return At.MulSV(t,this.m_impulse,e)},n.GetReactionTorque=function(){return 0},n.Dump=function(t){t("Mouse joint dumping is not supported.\n")},n.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},e}(An);Ln.SolveVelocityConstraints_s_Cdot=new At,Ln.SolveVelocityConstraints_s_impulse=new At,Ln.SolveVelocityConstraints_s_oldImpulse=new At;var Fn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_prismaticJoint)||this).localAnchorA=new At,i.localAnchorB=new At,i.localAxisA=new At(1,0),i.referenceAngle=0,i.enableLimit=!1,i.lowerTranslation=0,i.upperTranslation=0,i.enableMotor=!1,i.maxMotorForce=0,i.motorSpeed=0,i}return $(i,e),i.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Cn),zn=function(e){function n(n){var r;return(r=e.call(this,n)||this).m_localAnchorA=new At,r.m_localAnchorB=new At,r.m_localXAxisA=new At,r.m_localYAxisA=new At,r.m_referenceAngle=0,r.m_impulse=new wt(0,0,0),r.m_motorImpulse=0,r.m_lowerTranslation=0,r.m_upperTranslation=0,r.m_maxMotorForce=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_enableMotor=!1,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_indexA=0,r.m_indexB=0,r.m_localCenterA=new At,r.m_localCenterB=new At,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_axis=new At(0,0),r.m_perp=new At(0,0),r.m_s1=0,r.m_s2=0,r.m_a1=0,r.m_a2=0,r.m_K=new Pt,r.m_K3=new Pt,r.m_K2=new Et,r.m_motorMass=0,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new At,r.m_lalcB=new At,r.m_rA=new At,r.m_rB=new At,r.m_localAnchorA.Copy(i(n.localAnchorA,At.ZERO)),r.m_localAnchorB.Copy(i(n.localAnchorB,At.ZERO)),r.m_localXAxisA.Copy(i(n.localAxisA,new At(1,0))).SelfNormalize(),At.CrossOneV(r.m_localXAxisA,r.m_localYAxisA),r.m_referenceAngle=i(n.referenceAngle,0),r.m_lowerTranslation=i(n.lowerTranslation,0),r.m_upperTranslation=i(n.upperTranslation,0),r.m_maxMotorForce=i(n.maxMotorForce,0),r.m_motorSpeed=i(n.motorSpeed,0),r.m_enableLimit=i(n.enableLimit,!1),r.m_enableMotor=i(n.enableMotor,!1),r}$(n,e);var r=n.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=It.MulRV(_,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d=It.MulRV(f,this.m_lalcB,this.m_rB),m=At.AddVV(At.SubVV(s,i,At.s_t0),At.SubVV(d,p,At.s_t1),n.InitVelocityConstraints_s_d),v=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,x=this.m_invIB;if(It.MulRV(_,this.m_localXAxisA,this.m_axis),this.m_a1=At.CrossVV(At.AddVV(m,p,At.s_t0),this.m_axis),this.m_a2=At.CrossVV(d,this.m_axis),this.m_motorMass=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),It.MulRV(_,this.m_localYAxisA,this.m_perp),this.m_s1=At.CrossVV(At.AddVV(m,p,At.s_t0),this.m_perp),this.m_s2=At.CrossVV(d,this.m_perp),this.m_K.ex.x=v+g+y*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+x*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var S=At.DotVV(this.m_axis,m);et(this.m_upperTranslation-this.m_lowerTranslation)<2*h?this.m_limitState=t.b2LimitState.e_equalLimits:S<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):S>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var b=At.AddVV(At.MulSV(this.m_impulse.x,this.m_perp,At.s_t0),At.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,At.s_t1),n.InitVelocityConstraints_s_P),C=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,A=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(v,b),a-=y*C,l.SelfMulAdd(g,b),u+=x*A}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(e){var i=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){var h=At.DotVV(this.m_axis,At.SubVV(o,i,At.s_t0))+this.m_a2*a-this.m_a1*r,_=this.m_motorMass*(this.m_motorSpeed-h),f=this.m_motorImpulse,p=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=ot(this.m_motorImpulse+_,-p,p),_=this.m_motorImpulse-f;var d=At.MulSV(_,this.m_axis,n.SolveVelocityConstraints_s_P),m=_*this.m_a1,v=_*this.m_a2;i.SelfMulSub(s,d),r-=l*m,o.SelfMulAdd(c,d),a+=u*v}var g=At.DotVV(this.m_perp,At.SubVV(o,i,At.s_t0))+this.m_s2*a-this.m_s1*r,y=a-r;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){var x=At.DotVV(this.m_axis,At.SubVV(o,i,At.s_t0))+this.m_a2*a-this.m_a1*r,S=n.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),b=this.m_K.Solve33(-g,-y,-x,n.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(b),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=rt(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=it(this.m_impulse.z,0));var C=-g-(this.m_impulse.z-S.z)*this.m_K.ez.x,A=-y-(this.m_impulse.z-S.z)*this.m_K.ez.y,T=this.m_K.Solve22(C,A,n.SolveVelocityConstraints_s_f2r);T.x+=S.x,T.y+=S.y,this.m_impulse.x=T.x,this.m_impulse.y=T.y,b.x=this.m_impulse.x-S.x,b.y=this.m_impulse.y-S.y,b.z=this.m_impulse.z-S.z;var w=At.AddVV(At.MulSV(b.x,this.m_perp,At.s_t0),At.MulSV(b.z,this.m_axis,At.s_t1),n.SolveVelocityConstraints_s_P),E=b.x*this.m_s1+b.y+b.z*this.m_a1,P=b.x*this.m_s2+b.y+b.z*this.m_a2;i.SelfMulSub(s,w),r-=l*E,o.SelfMulAdd(c,w),a+=u*P}else{var I=this.m_K.Solve22(-g,-y,n.SolveVelocityConstraints_s_df2);this.m_impulse.x+=I.x,this.m_impulse.y+=I.y;var R=At.MulSV(I.x,this.m_perp,n.SolveVelocityConstraints_s_P),D=I.x*this.m_s1+I.y,M=I.x*this.m_s2+I.y;i.SelfMulSub(s,R),r-=l*D,o.SelfMulAdd(c,R),a+=u*M}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=It.MulRV(a,this.m_lalcA,this.m_rA),d=It.MulRV(s,this.m_lalcB,this.m_rB),m=At.SubVV(At.AddVV(r,d,At.s_t0),At.AddVV(e,p,At.s_t1),n.SolvePositionConstraints_s_d),g=It.MulRV(a,this.m_localXAxisA,this.m_axis),y=At.CrossVV(At.AddVV(m,p,At.s_t0),g),x=At.CrossVV(d,g),S=It.MulRV(a,this.m_localYAxisA,this.m_perp),b=At.CrossVV(At.AddVV(m,p,At.s_t0),S),C=At.CrossVV(d,S),A=n.SolvePositionConstraints_s_impulse,T=At.DotVV(S,m),w=o-i-this.m_referenceAngle,E=et(T),P=et(w),I=!1,R=0;if(this.m_enableLimit){var D=At.DotVV(g,m);et(this.m_upperTranslation-this.m_lowerTranslation)<2*h?(R=ot(D,-v,v),E=rt(E,et(D)),I=!0):D<=this.m_lowerTranslation?(R=ot(D-this.m_lowerTranslation+h,-v,0),E=rt(E,this.m_lowerTranslation-D),I=!0):D>=this.m_upperTranslation&&(R=ot(D-this.m_upperTranslation-h,0,v),E=rt(E,D-this.m_upperTranslation),I=!0)}if(I){var M=c+l+u*b*b+f*C*C,O=u*b+f*C,B=u*b*y+f*C*x,N=u+f;0===N&&(N=1);var L=u*y+f*x,F=c+l+u*y*y+f*x*x,z=this.m_K3;z.ex.SetXYZ(M,O,B),z.ey.SetXYZ(O,N,L),z.ez.SetXYZ(B,L,F),A=z.Solve33(-T,-w,-R,A)}else{var V=c+l+u*b*b+f*C*C,k=u*b+f*C,U=u+f;0===U&&(U=1);var G=this.m_K2;G.ex.Set(V,k),G.ey.Set(k,U);var H=G.Solve(-T,-w,n.SolvePositionConstraints_s_impulse1);A.x=H.x,A.y=H.y,A.z=0}var j=At.AddVV(At.MulSV(A.x,S,At.s_t0),At.MulSV(A.z,g,At.s_t1),n.SolvePositionConstraints_s_P),W=A.x*b+A.y+A.z*y,q=A.x*C+A.y+A.z*x;return e.SelfMulSub(c,j),i-=u*W,r.SelfMulAdd(l,j),o+=f*q,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,E<=h&&P<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e},r.GetReactionTorque=function(t){return t*this.m_impulse.y},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetLocalAxisA=function(){return this.m_localXAxisA},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,n.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,n.GetJointTranslation_s_pB),i=At.SubVV(e,t,n.GetJointTranslation_s_d),r=this.m_bodyA.GetWorldVector(this.m_localXAxisA,n.GetJointTranslation_s_axis);return At.DotVV(i,r)},r.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;At.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var n=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=At.AddVV(t.m_sweep.c,i,At.s_t0),o=At.AddVV(e.m_sweep.c,n,At.s_t1),a=At.SubVV(o,r,At.s_t2),s=t.GetWorldVector(this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return At.DotVV(a,At.CrossSV(u,s,At.s_t0))+At.DotVV(s,At.SubVV(At.AddVCrossSV(l,h,n,At.s_t0),At.AddVCrossSV(c,u,i,At.s_t1),At.s_t0))},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerTranslation},r.GetUpperLimit=function(){return this.m_upperTranslation},r.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorForce=function(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)},r.GetMaxMotorForce=function(){return this.m_maxMotorForce},r.GetMotorForce=function(t){return t*this.m_motorImpulse},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(An);zn.InitVelocityConstraints_s_d=new At,zn.InitVelocityConstraints_s_P=new At,zn.SolveVelocityConstraints_s_P=new At,zn.SolveVelocityConstraints_s_f2r=new At,zn.SolveVelocityConstraints_s_f1=new wt,zn.SolveVelocityConstraints_s_df3=new wt,zn.SolveVelocityConstraints_s_df2=new At,zn.SolvePositionConstraints_s_d=new At,zn.SolvePositionConstraints_s_impulse=new wt,zn.SolvePositionConstraints_s_impulse1=new At,zn.SolvePositionConstraints_s_P=new At,zn.GetJointTranslation_s_pA=new At,zn.GetJointTranslation_s_pB=new At,zn.GetJointTranslation_s_d=new At,zn.GetJointTranslation_s_axis=new At;var Vn=2,kn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_pulleyJoint)||this).groundAnchorA=new At(-1,1),i.groundAnchorB=new At(1,1),i.localAnchorA=new At(-1,0),i.localAnchorB=new At(1,0),i.lengthA=0,i.lengthB=0,i.ratio=1,i.collideConnected=!0,i}return $(i,e),i.prototype.Initialize=function(t,e,i,n,r,o,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(r,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=At.DistanceVV(r,i),this.lengthB=At.DistanceVV(o,n),this.ratio=a},i}(Cn),Un=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_groundAnchorA=new At,n.m_groundAnchorB=new At,n.m_lengthA=0,n.m_lengthB=0,n.m_localAnchorA=new At,n.m_localAnchorB=new At,n.m_constant=0,n.m_ratio=0,n.m_impulse=0,n.m_indexA=0,n.m_indexB=0,n.m_uA=new At,n.m_uB=new At,n.m_rA=new At,n.m_rB=new At,n.m_localCenterA=new At,n.m_localCenterB=new At,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_mass=0,n.m_qA=new It,n.m_qB=new It,n.m_lalcA=new At,n.m_lalcB=new At,n.m_groundAnchorA.Copy(i(e.groundAnchorA,new At(-1,1))),n.m_groundAnchorB.Copy(i(e.groundAnchorB,new At(1,0))),n.m_localAnchorA.Copy(i(e.localAnchorA,new At(-1,0))),n.m_localAnchorB.Copy(i(e.localAnchorB,new At(1,0))),n.m_lengthA=i(e.lengthA,0),n.m_lengthB=i(e.lengthB,0),n.m_ratio=i(e.ratio,1),n.m_constant=i(e.lengthA,0)+n.m_ratio*i(e.lengthB,0),n.m_impulse=0,n}$(e,t);var n=e.prototype;return n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,a=t.positions[this.m_indexB].c,s=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(n),_=this.m_qB.SetAngle(s);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(u,this.m_lalcA,this.m_rA),At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(i).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var f=this.m_uA.Length(),p=this.m_uB.Length();f>10*h?this.m_uA.SelfMul(1/f):this.m_uA.SetZero(),p>10*h?this.m_uB.SelfMul(1/p):this.m_uB.SetZero();var d=At.CrossVV(this.m_rA,this.m_uA),m=At.CrossVV(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=v+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var y=At.MulSV(-this.m_impulse,this.m_uA,e.InitVelocityConstraints_s_PA),x=At.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,e.InitVelocityConstraints_s_PB);r.SelfMulAdd(this.m_invMassA,y),o+=this.m_invIA*At.CrossVV(this.m_rA,y),c.SelfMulAdd(this.m_invMassB,x),l+=this.m_invIB*At.CrossVV(this.m_rB,x)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l},n.SolveVelocityConstraints=function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=At.AddVCrossSV(i,n,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=At.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=-At.DotVV(this.m_uA,a)-this.m_ratio*At.DotVV(this.m_uB,s),l=-this.m_mass*c;this.m_impulse+=l;var u=At.MulSV(-l,this.m_uA,e.SolveVelocityConstraints_s_PA),h=At.MulSV(-this.m_ratio*l,this.m_uB,e.SolveVelocityConstraints_s_PB);i.SelfMulAdd(this.m_invMassA,u),n+=this.m_invIA*At.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*At.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(t){var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_uA.Copy(i).SelfAdd(c).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(r).SelfAdd(l).SelfSub(this.m_groundAnchorB),f=u.Length(),p=_.Length();f>10*h?u.SelfMul(1/f):u.SetZero(),p>10*h?_.SelfMul(1/p):_.SetZero();var d=At.CrossVV(c,u),m=At.CrossVV(l,_),v=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*m*m,y=v+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);var x=this.m_constant-f-this.m_ratio*p,S=et(x),b=-y*x,C=At.MulSV(-b,u,e.SolvePositionConstraints_s_PA),A=At.MulSV(-this.m_ratio*b,_,e.SolvePositionConstraints_s_PB);return i.SelfMulAdd(this.m_invMassA,C),n+=this.m_invIA*At.CrossVV(c,C),r.SelfMulAdd(this.m_invMassB,A),o+=this.m_invIB*At.CrossVV(l,A),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,S<h},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e},n.GetReactionTorque=function(){return 0},n.GetGroundAnchorA=function(){return this.m_groundAnchorA},n.GetGroundAnchorB=function(){return this.m_groundAnchorB},n.GetLengthA=function(){return this.m_lengthA},n.GetLengthB=function(){return this.m_lengthB},n.GetRatio=function(){return this.m_ratio},n.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e.GetCurrentLengthA_s_p),i=this.m_groundAnchorA;return At.DistanceVV(t,i)},n.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e.GetCurrentLengthB_s_p),i=this.m_groundAnchorB;return At.DistanceVV(t,i)},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},e}(An);Un.InitVelocityConstraints_s_PA=new At,Un.InitVelocityConstraints_s_PB=new At,Un.SolveVelocityConstraints_s_vpA=new At,Un.SolveVelocityConstraints_s_vpB=new At,Un.SolveVelocityConstraints_s_PA=new At,Un.SolveVelocityConstraints_s_PB=new At,Un.SolvePositionConstraints_s_PA=new At,Un.SolvePositionConstraints_s_PB=new At,Un.GetCurrentLengthA_s_p=new At,Un.GetCurrentLengthB_s_p=new At;var Gn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_revoluteJoint)||this).localAnchorA=new At(0,0),i.localAnchorB=new At(0,0),i.referenceAngle=0,i.enableLimit=!1,i.lowerAngle=0,i.upperAngle=0,i.enableMotor=!1,i.motorSpeed=0,i.maxMotorTorque=0,i}return $(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Cn),Hn=function(e){function n(n){var r;return(r=e.call(this,n)||this).m_localAnchorA=new At,r.m_localAnchorB=new At,r.m_impulse=new wt,r.m_motorImpulse=0,r.m_enableMotor=!1,r.m_maxMotorTorque=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_referenceAngle=0,r.m_lowerAngle=0,r.m_upperAngle=0,r.m_indexA=0,r.m_indexB=0,r.m_rA=new At,r.m_rB=new At,r.m_localCenterA=new At,r.m_localCenterB=new At,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=new Pt,r.m_motorMass=0,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new At,r.m_lalcB=new At,r.m_K=new Et,r.m_localAnchorA.Copy(i(n.localAnchorA,At.ZERO)),r.m_localAnchorB.Copy(i(n.localAnchorB,At.ZERO)),r.m_referenceAngle=i(n.referenceAngle,0),r.m_impulse.SetZero(),r.m_motorImpulse=0,r.m_lowerAngle=i(n.lowerAngle,0),r.m_upperAngle=i(n.upperAngle,0),r.m_maxMotorTorque=i(n.maxMotorTorque,0),r.m_motorSpeed=i(n.motorSpeed,0),r.m_enableLimit=i(n.enableLimit,!1),r.m_enableMotor=i(n.enableMotor,!1),r.m_limitState=t.b2LimitState.e_inactiveLimit,r}$(n,e);var r=n.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(i),u=this.m_qB.SetAngle(a);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,f=this.m_invMassB,p=this.m_invIA,d=this.m_invIB,m=p+d===0;if(this.m_mass.ex.x=h+f+this.m_rA.y*this.m_rA.y*p+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*p-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*p-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+f+this.m_rA.x*this.m_rA.x*p+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*p+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=p+d,this.m_motorMass=p+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!m||(this.m_motorImpulse=0),this.m_enableLimit&&!m){var v=a-i-this.m_referenceAngle;et(this.m_upperAngle-this.m_lowerAngle)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:v<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):v>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var g=n.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);r.SelfMulSub(h,g),o-=p*(At.CrossVV(this.m_rA,g)+this.m_motorImpulse+this.m_impulse.z),s.SelfMulAdd(f,g),c+=d*(At.CrossVV(this.m_rB,g)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c},r.SolveVelocityConstraints=function(e){var i=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB,h=l+u===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){var _=a-r-this.m_motorSpeed,f=-this.m_motorMass*_,p=this.m_motorImpulse,d=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=ot(this.m_motorImpulse+f,-d,d),r-=l*(f=this.m_motorImpulse-p),a+=u*f}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){var m=At.SubVV(At.AddVCrossSV(o,a,this.m_rB,At.s_t0),At.AddVCrossSV(i,r,this.m_rA,At.s_t1),n.SolveVelocityConstraints_s_Cdot1),v=a-r,g=this.m_mass.Solve33(m.x,m.y,v,n.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+g.z<0){var y=-m.x+this.m_impulse.z*this.m_mass.ez.x,x=-m.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(y,x,n.SolveVelocityConstraints_s_reduced_v2);g.x=S.x,g.y=S.y,g.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+g.z>0){var b=-m.x+this.m_impulse.z*this.m_mass.ez.x,C=-m.y+this.m_impulse.z*this.m_mass.ez.y,A=this.m_mass.Solve22(b,C,n.SolveVelocityConstraints_s_reduced_v2);g.x=A.x,g.y=A.y,g.z=-this.m_impulse.z,this.m_impulse.x+=A.x,this.m_impulse.y+=A.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);var T=n.SolveVelocityConstraints_s_P.Set(g.x,g.y);i.SelfMulSub(s,T),r-=l*(At.CrossVV(this.m_rA,T)+g.z),o.SelfMulAdd(c,T),a+=u*(At.CrossVV(this.m_rB,T)+g.z)}else{var w=At.SubVV(At.AddVCrossSV(o,a,this.m_rB,At.s_t0),At.AddVCrossSV(i,r,this.m_rA,At.s_t1),n.SolveVelocityConstraints_s_Cdot_v2),E=this.m_mass.Solve22(-w.x,-w.y,n.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=E.x,this.m_impulse.y+=E.y,i.SelfMulSub(s,E),r-=l*At.CrossVV(this.m_rA,E),o.SelfMulAdd(c,E),a+=u*At.CrossVV(this.m_rB,E)}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(e){var i=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,s=this.m_qA.SetAngle(r),c=this.m_qB.SetAngle(a),l=0,u=0,f=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!f){var p=a-r-this.m_referenceAngle,d=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){var m=ot(p-this.m_lowerAngle,-g,g);d=-this.m_motorMass*m,l=et(m)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){var v=p-this.m_lowerAngle;l=-v,v=ot(v+_,-g,0),d=-this.m_motorMass*v}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){var y=p-this.m_upperAngle;l=y,y=ot(y-_,0,g),d=-this.m_motorMass*y}r-=this.m_invIA*d,a+=this.m_invIB*d}s.SetAngle(r),c.SetAngle(a),At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var x=It.MulRV(s,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var S=It.MulRV(c,this.m_lalcB,this.m_rB),b=At.SubVV(At.AddVV(o,S,At.s_t0),At.AddVV(i,x,At.s_t1),n.SolvePositionConstraints_s_C_v2);u=b.Length();var C=this.m_invMassA,A=this.m_invMassB,T=this.m_invIA,w=this.m_invIB,E=this.m_K;E.ex.x=C+A+T*x.y*x.y+w*S.y*S.y,E.ex.y=-T*x.x*x.y-w*S.x*S.y,E.ey.x=E.ex.y,E.ey.y=C+A+T*x.x*x.x+w*S.x*S.x;var P=E.Solve(b.x,b.y,n.SolvePositionConstraints_s_impulse).SelfNeg();return i.SelfMulSub(C,P),r-=T*At.CrossVV(x,P),o.SelfMulAdd(A,P),a+=w*At.CrossVV(S,P),e.positions[this.m_indexA].a=r,e.positions[this.m_indexB].a=a,u<=h&&l<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},r.GetReactionTorque=function(t){return t*this.m_impulse.z},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},r.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.GetMotorTorque=function(t){return t*this.m_motorImpulse},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},r.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerAngle},r.GetUpperLimit=function(){return this.m_upperAngle},r.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(An);Hn.InitVelocityConstraints_s_P=new At,Hn.SolveVelocityConstraints_s_P=new At,Hn.SolveVelocityConstraints_s_Cdot_v2=new At,Hn.SolveVelocityConstraints_s_Cdot1=new At,Hn.SolveVelocityConstraints_s_impulse_v3=new wt,Hn.SolveVelocityConstraints_s_reduced_v2=new At,Hn.SolveVelocityConstraints_s_impulse_v2=new At,Hn.SolvePositionConstraints_s_C_v2=new At,Hn.SolvePositionConstraints_s_impulse=new At;var jn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_ropeJoint)||this).localAnchorA=new At(-1,0),i.localAnchorB=new At(1,0),i.maxLength=0,i}return $(i,e),i}(Cn),Wn=function(e){function n(n){var r;return(r=e.call(this,n)||this).m_localAnchorA=new At,r.m_localAnchorB=new At,r.m_maxLength=0,r.m_length=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_u=new At,r.m_rA=new At,r.m_rB=new At,r.m_localCenterA=new At,r.m_localCenterB=new At,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=0,r.m_state=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new At,r.m_lalcB=new At,r.m_localAnchorA.Copy(i(n.localAnchorA,new At(-1,0))),r.m_localAnchorB.Copy(i(n.localAnchorB,new At(1,0))),r.m_maxLength=i(n.maxLength,0),r}$(n,e);var r=n.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.Copy(s).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var p=this.m_length-this.m_maxLength;if(this.m_state=p>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>h))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var d=At.CrossVV(this.m_rA,this.m_u),m=At.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var g=At.MulSV(this.m_impulse,this.m_u,n.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,g),a-=this.m_invIA*At.CrossVV(this.m_rA,g),l.SelfMulAdd(this.m_invMassB,g),u+=this.m_invIB*At.CrossVV(this.m_rB,g)}else this.m_impulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=At.AddVCrossSV(e,i,this.m_rA,n.SolveVelocityConstraints_s_vpA),s=At.AddVCrossSV(r,o,this.m_rB,n.SolveVelocityConstraints_s_vpB),c=this.m_length-this.m_maxLength,l=At.DotVV(this.m_u,At.SubVV(s,a,At.s_t0));c<0&&(l+=t.step.inv_dt*c);var u=-this.m_mass*l,h=this.m_impulse;this.m_impulse=it(0,this.m_impulse+u),u=this.m_impulse-h;var _=At.MulSV(u,this.m_u,n.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*At.CrossVV(this.m_rA,_),r.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*At.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u.Copy(r).SelfAdd(l).SelfSub(e).SelfSub(c),_=u.Normalize(),f=_-this.m_maxLength;f=ot(f,0,v);var p=-this.m_mass*f,d=At.MulSV(p,u,n.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*At.CrossVV(c,d),r.SelfMulAdd(this.m_invMassB,d),o+=this.m_invIB*At.CrossVV(l,d),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,_-this.m_maxLength<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return At.MulSV(t*this.m_impulse,this.m_u,e)},r.GetReactionTorque=function(){return 0},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.SetMaxLength=function(t){this.m_maxLength=t},r.GetMaxLength=function(){return this.m_maxLength},r.GetLimitState=function(){return this.m_state},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(An);Wn.InitVelocityConstraints_s_P=new At,Wn.SolveVelocityConstraints_s_vpA=new At,Wn.SolveVelocityConstraints_s_vpB=new At,Wn.SolveVelocityConstraints_s_P=new At,Wn.SolvePositionConstraints_s_P=new At;var qn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_weldJoint)||this).localAnchorA=new At,i.localAnchorB=new At,i.referenceAngle=0,i.frequencyHz=0,i.dampingRatio=0,i}return $(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Cn),Xn=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_bias=0,n.m_localAnchorA=new At,n.m_localAnchorB=new At,n.m_referenceAngle=0,n.m_gamma=0,n.m_impulse=new wt(0,0,0),n.m_indexA=0,n.m_indexB=0,n.m_rA=new At,n.m_rB=new At,n.m_localCenterA=new At,n.m_localCenterB=new At,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_mass=new Pt,n.m_qA=new It,n.m_qB=new It,n.m_lalcA=new At,n.m_lalcB=new At,n.m_K=new Pt,n.m_frequencyHz=i(e.frequencyHz,0),n.m_dampingRatio=i(e.dampingRatio,0),n.m_localAnchorA.Copy(i(e.localAnchorA,At.ZERO)),n.m_localAnchorB.Copy(i(e.localAnchorB,At.ZERO)),n.m_referenceAngle=i(e.referenceAngle,0),n.m_impulse.SetZero(),n}$(e,t);var n=e.prototype;return n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(i),u=this.m_qB.SetAngle(o);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*p,d.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*p,d.ez.x=-this.m_rA.y*f-this.m_rB.y*p,d.ex.y=d.ey.x,d.ey.y=h+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*p,d.ez.y=this.m_rA.x*f+this.m_rB.x*p,d.ex.z=d.ez.x,d.ey.z=d.ez.y,d.ez.z=f+p,this.m_frequencyHz>0){d.GetInverse22(this.m_mass);var m=f+p,v=m>0?1/m:0,g=o-i-this.m_referenceAngle,y=2*a*this.m_frequencyHz,x=2*v*this.m_dampingRatio*y,S=v*y*y,b=t.step.dt;this.m_gamma=b*(x+b*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*b*S*this.m_gamma,m+=this.m_gamma,this.m_mass.ez.z=0!==m?1/m:0}else d.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var C=e.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);n.SelfMulSub(h,C),r-=f*(At.CrossVV(this.m_rA,C)+this.m_impulse.z),s.SelfMulAdd(_,C),c+=p*(At.CrossVV(this.m_rB,C)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},n.SolveVelocityConstraints=function(t){var i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){var u=o-n,h=-this.m_mass.ez.z*(u+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,n-=c*h,o+=l*h;var _=At.SubVV(At.AddVCrossSV(r,o,this.m_rB,At.s_t0),At.AddVCrossSV(i,n,this.m_rA,At.s_t1),e.SolveVelocityConstraints_s_Cdot1),f=Pt.MulM33XY(this.m_mass,_.x,_.y,e.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var p=f;i.SelfMulSub(a,p),n-=c*At.CrossVV(this.m_rA,p),r.SelfMulAdd(s,p),o+=l*At.CrossVV(this.m_rB,p)}else{var d=At.SubVV(At.AddVCrossSV(r,o,this.m_rB,At.s_t0),At.AddVCrossSV(i,n,this.m_rA,At.s_t1),e.SolveVelocityConstraints_s_Cdot1),m=o-n,v=Pt.MulM33XYZ(this.m_mass,d.x,d.y,m,e.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(v);var g=e.SolveVelocityConstraints_s_P.Set(v.x,v.y);i.SelfMulSub(a,g),n-=c*(At.CrossVV(this.m_rA,g)+v.z),r.SelfMulAdd(s,g),o+=l*(At.CrossVV(this.m_rB,g)+v.z)}t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(t){var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB;At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=It.MulRV(a,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d,m,v=It.MulRV(s,this.m_lalcB,this.m_rB),g=this.m_K;if(g.ex.x=c+l+p.y*p.y*u+v.y*v.y*f,g.ey.x=-p.y*p.x*u-v.y*v.x*f,g.ez.x=-p.y*u-v.y*f,g.ex.y=g.ey.x,g.ey.y=c+l+p.x*p.x*u+v.x*v.x*f,g.ez.y=p.x*u+v.x*f,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=u+f,this.m_frequencyHz>0){var y=At.SubVV(At.AddVV(r,v,At.s_t0),At.AddVV(i,p,At.s_t1),e.SolvePositionConstraints_s_C1);d=y.Length(),m=0;var x=g.Solve22(y.x,y.y,e.SolvePositionConstraints_s_P).SelfNeg();i.SelfMulSub(c,x),n-=u*At.CrossVV(p,x),r.SelfMulAdd(l,x),o+=f*At.CrossVV(v,x)}else{var S=At.SubVV(At.AddVV(r,v,At.s_t0),At.AddVV(i,p,At.s_t1),e.SolvePositionConstraints_s_C1),b=o-n-this.m_referenceAngle;d=S.Length(),m=et(b);var C=g.Solve33(S.x,S.y,b,e.SolvePositionConstraints_s_impulse).SelfNeg(),A=e.SolvePositionConstraints_s_P.Set(C.x,C.y);i.SelfMulSub(c,A),n-=u*(At.CrossVV(this.m_rA,A)+C.z),r.SelfMulAdd(l,A),o+=f*(At.CrossVV(this.m_rB,A)+C.z)}return t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,d<=h&&m<=_},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},n.GetReactionTorque=function(t){return t*this.m_impulse.z},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.GetReferenceAngle=function(){return this.m_referenceAngle},n.SetFrequency=function(t){this.m_frequencyHz=t},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t},n.GetDampingRatio=function(){return this.m_dampingRatio},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(An);Xn.InitVelocityConstraints_s_P=new At,Xn.SolveVelocityConstraints_s_Cdot1=new At,Xn.SolveVelocityConstraints_s_impulse1=new At,Xn.SolveVelocityConstraints_s_impulse=new wt,Xn.SolveVelocityConstraints_s_P=new At,Xn.SolvePositionConstraints_s_C1=new At,Xn.SolvePositionConstraints_s_P=new At,Xn.SolvePositionConstraints_s_impulse=new wt;var Yn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_wheelJoint)||this).localAnchorA=new At(0,0),i.localAnchorB=new At(0,0),i.localAxisA=new At(1,0),i.enableMotor=!1,i.maxMotorTorque=0,i.motorSpeed=0,i.frequencyHz=2,i.dampingRatio=.7,i}return $(i,e),i.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)},i}(Cn),Kn=function(t){function e(e){var n;return(n=t.call(this,e)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_localAnchorA=new At,n.m_localAnchorB=new At,n.m_localXAxisA=new At,n.m_localYAxisA=new At,n.m_impulse=0,n.m_motorImpulse=0,n.m_springImpulse=0,n.m_maxMotorTorque=0,n.m_motorSpeed=0,n.m_enableMotor=!1,n.m_indexA=0,n.m_indexB=0,n.m_localCenterA=new At,n.m_localCenterB=new At,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_ax=new At,n.m_ay=new At,n.m_sAx=0,n.m_sBx=0,n.m_sAy=0,n.m_sBy=0,n.m_mass=0,n.m_motorMass=0,n.m_springMass=0,n.m_bias=0,n.m_gamma=0,n.m_qA=new It,n.m_qB=new It,n.m_lalcA=new At,n.m_lalcB=new At,n.m_rA=new At,n.m_rB=new At,n.m_frequencyHz=i(e.frequencyHz,2),n.m_dampingRatio=i(e.dampingRatio,.7),n.m_localAnchorA.Copy(i(e.localAnchorA,At.ZERO)),n.m_localAnchorB.Copy(i(e.localAnchorB,At.ZERO)),n.m_localXAxisA.Copy(i(e.localAxisA,At.UNITX)),At.CrossOneV(n.m_localXAxisA,n.m_localYAxisA),n.m_maxMotorTorque=i(e.maxMotorTorque,0),n.m_motorSpeed=i(e.motorSpeed,0),n.m_enableMotor=i(e.enableMotor,!1),n.m_ax.SetZero(),n.m_ay.SetZero(),n}$(e,t);var n=e.prototype;return n.GetMotorSpeed=function(){return this.m_motorSpeed},n.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},n.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},n.GetSpringFrequencyHz=function(){return this.m_frequencyHz},n.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},n.GetSpringDampingRatio=function(){return this.m_dampingRatio},n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_invMassA,n=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,s=t.positions[this.m_indexA].c,c=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v,u=t.velocities[this.m_indexA].w,h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,f=t.velocities[this.m_indexB].v,p=t.velocities[this.m_indexB].w,d=this.m_qA.SetAngle(c),m=this.m_qB.SetAngle(_);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=It.MulRV(d,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var g=It.MulRV(m,this.m_lalcB,this.m_rB),y=At.SubVV(At.AddVV(h,g,At.s_t0),At.AddVV(s,v,At.s_t1),e.InitVelocityConstraints_s_d);if(It.MulRV(d,this.m_localYAxisA,this.m_ay),this.m_sAy=At.CrossVV(At.AddVV(y,v,At.s_t0),this.m_ay),this.m_sBy=At.CrossVV(g,this.m_ay),this.m_mass=i+n+r*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){It.MulRV(d,this.m_localXAxisA,this.m_ax),this.m_sAx=At.CrossVV(At.AddVV(y,v,At.s_t0),this.m_ax),this.m_sBx=At.CrossVV(g,this.m_ax);var x=i+n+r*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(x>0){this.m_springMass=1/x;var S=At.DotVV(y,this.m_ax),b=2*a*this.m_frequencyHz,C=2*this.m_springMass*this.m_dampingRatio*b,A=this.m_springMass*b*b,T=t.step.dt;this.m_gamma=T*(C+T*A),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*T*A*this.m_gamma,this.m_springMass=x+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=r+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var w=At.AddVV(At.MulSV(this.m_impulse,this.m_ay,At.s_t0),At.MulSV(this.m_springImpulse,this.m_ax,At.s_t1),e.InitVelocityConstraints_s_P),E=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,P=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,w),u-=this.m_invIA*E,f.SelfMulAdd(this.m_invMassB,w),p+=this.m_invIB*P}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=u,t.velocities[this.m_indexB].w=p},n.SolveVelocityConstraints=function(t){var i=this.m_invMassA,n=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,a=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=At.DotVV(this.m_ax,At.SubVV(c,a,At.s_t0))+this.m_sBx*l-this.m_sAx*s,h=-this.m_springMass*(u+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;var _=At.MulSV(h,this.m_ax,e.SolveVelocityConstraints_s_P),f=h*this.m_sAx,p=h*this.m_sBx;a.SelfMulSub(i,_),s-=r*f,c.SelfMulAdd(n,_);var d=(l+=o*p)-s-this.m_motorSpeed,m=-this.m_motorMass*d,v=this.m_motorImpulse,g=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=ot(this.m_motorImpulse+m,-g,g),s-=r*(m=this.m_motorImpulse-v),l+=o*m;var y=At.DotVV(this.m_ay,At.SubVV(c,a,At.s_t0))+this.m_sBy*l-this.m_sAy*s,x=-this.m_mass*y;this.m_impulse+=x;var S=At.MulSV(x,this.m_ay,e.SolveVelocityConstraints_s_P),b=x*this.m_sAy,C=x*this.m_sBy;a.SelfMulSub(i,S),s-=r*b,c.SelfMulAdd(n,S),l+=o*C,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l},n.SolvePositionConstraints=function(t){var i=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o);At.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l,u=It.MulRV(s,this.m_lalcB,this.m_rB),_=At.AddVV(At.SubVV(r,i,At.s_t0),At.SubVV(u,c,At.s_t1),e.SolvePositionConstraints_s_d),f=It.MulRV(a,this.m_localYAxisA,this.m_ay),p=At.CrossVV(At.AddVV(_,c,At.s_t0),f),d=At.CrossVV(u,f),m=At.DotVV(_,this.m_ay),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;l=0!==v?-m/v:0;var g=At.MulSV(l,f,e.SolvePositionConstraints_s_P),y=l*p,x=l*d;return i.SelfMulSub(this.m_invMassA,g),n-=this.m_invIA*y,r.SelfMulAdd(this.m_invMassB,g),o+=this.m_invIB*x,t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,et(m)<=h},n.GetDefinition=function(t){return t},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},n.GetReactionTorque=function(t){return t*this.m_motorImpulse},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.GetLocalAxisA=function(){return this.m_localXAxisA},n.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},n.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},n.GetJointAngle=function(){return this.GetRevoluteJointAngle()},n.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},n.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new At),n=e.GetWorldPoint(this.m_localAnchorB,new At),r=At.SubVV(n,i,new At),o=t.GetWorldVector(this.m_localXAxisA,new At);return At.DotVV(r,o)},n.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;At.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);At.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var n=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=At.AddVV(t.m_sweep.c,i,At.s_t0),o=At.AddVV(e.m_sweep.c,n,At.s_t1),a=At.SubVV(o,r,At.s_t2),s=t.GetWorldVector(this.m_localXAxisA,new At),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return At.DotVV(a,At.CrossSV(u,s,At.s_t0))+At.DotVV(s,At.SubVV(At.AddVCrossSV(l,h,n,At.s_t0),At.AddVCrossSV(c,u,i,At.s_t1),At.s_t0))},n.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},n.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},n.IsMotorEnabled=function(){return this.m_enableMotor},n.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},n.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},n.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},n.GetMotorTorque=function(t){return t*this.m_motorImpulse},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(An);function Jn(t,e){return ht(t*e)}function Qn(t,e){return t>e?t:e}Kn.InitVelocityConstraints_s_d=new At,Kn.InitVelocityConstraints_s_P=new At,Kn.SolveVelocityConstraints_s_P=new At,Kn.SolvePositionConstraints_s_d=new At,Kn.SolvePositionConstraints_s_P=new At;var Zn=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.contact=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},Q(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),$n=function(){function t(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Zn(this),this.m_nodeB=new Zn(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new ye,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new ye}var e=t.prototype;return e.GetManifold=function(){return this.m_manifold},e.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),r=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),r.m_radius)},e.IsTouching=function(){return this.m_touchingFlag},e.SetEnabled=function(t){this.m_enabledFlag=t},e.IsEnabled=function(){return this.m_enabledFlag},e.GetNext=function(){return this.m_next},e.GetFixtureA=function(){return this.m_fixtureA},e.GetChildIndexA=function(){return this.m_indexA},e.GetShapeA=function(){return this.m_fixtureA.GetShape()},e.GetFixtureB=function(){return this.m_fixtureB},e.GetChildIndexB=function(){return this.m_indexB},e.GetShapeB=function(){return this.m_fixtureB.GetShape()},e.FlagForFiltering=function(){this.m_filterFlag=!0},e.SetFriction=function(t){this.m_friction=t},e.GetFriction=function(){return this.m_friction},e.ResetFriction=function(){this.m_friction=Jn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},e.SetRestitution=function(t){this.m_restitution=t},e.GetRestitution=function(){return this.m_restitution},e.ResetRestitution=function(){this.m_restitution=Qn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.SetTangentSpeed=function(t){this.m_tangentSpeed=t},e.GetTangentSpeed=function(){return this.m_tangentSpeed},e.Reset=function(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=Jn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Qn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var i=!1,n=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),a=r||o,s=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),l=s.GetTransform(),u=c.GetTransform();if(a){var h=this.GetShapeA(),_=this.GetShapeB();i=De(h,this.m_indexA,_,this.m_indexB,l,u),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,u),i=this.m_manifold.pointCount>0;for(var f=0;f<this.m_manifold.pointCount;++f){var p=this.m_manifold.points[f];p.normalImpulse=0,p.tangentImpulse=0;for(var d=p.id,m=0;m<this.m_oldManifold.pointCount;++m){var v=this.m_oldManifold.points[m];if(v.id.key===d.key){p.normalImpulse=v.normalImpulse,p.tangentImpulse=v.tangentImpulse;break}}}i!==n&&(s.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!a&&i&&t&&t.PreSolve(this,this.m_oldManifold)},e.ComputeTOI=function(e,i){var n=t.ComputeTOI_s_input;n.proxyA.SetShape(this.GetShapeA(),this.m_indexA),n.proxyB.SetShape(this.GetShapeB(),this.m_indexB),n.sweepA.Copy(e),n.sweepB.Copy(i),n.tMax=h;var r=t.ComputeTOI_s_output;return li(r,n),r.t},t}();$n.ComputeTOI_s_input=new Je,$n.ComputeTOI_s_output=new Ze;var tr=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){_i(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}($n),er=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){ki(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}($n),ir=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){mi(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}($n),nr=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){Ji(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}($n),rr=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){rn(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}($n),or=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,i,n){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),Ji(t,r,i,this.GetShapeB(),n)},e}($n);or.Evaluate_s_edge=new un;var ar=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,i,n){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),rn(t,r,i,this.GetShapeB(),n)},e}($n);ar.Evaluate_s_edge=new un;var sr=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},cr=function(){function e(){this.m_registers=[],this.InitializeRegisters()}var i=e.prototype;return i.AddType=function(t,e,i,n){var r=[];function o(){return r.pop()||t()}function a(t){r.push(t)}this.m_registers[i][n].pool=r,this.m_registers[i][n].createFcn=o,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=r,this.m_registers[n][i].createFcn=o,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!1)},i.InitializeRegisters=function(){for(var e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(var i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new sr}this.AddType(tr.Create,tr.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(ir.Create,ir.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(er.Create,er.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(nr.Create,nr.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(rr.Create,rr.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(or.Create,or.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(ar.Create,ar.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)},i.Create=function(t,e,i,n){var r=t.GetType(),o=i.GetType(),a=this.m_registers[r][o];if(a.createFcn){var s=a.createFcn();return a.primary?s.Reset(t,e,i,n):s.Reset(i,n,t,e),s}return null},i.Destroy=function(t){var e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)},e}(),lr=function(){function t(){}var e=t.prototype;return e.SayGoodbyeJoint=function(){},e.SayGoodbyeFixture=function(){},e.SayGoodbyeParticleGroup=function(){},e.SayGoodbyeParticle=function(){},t}(),ur=function(){function e(){}var i=e.prototype;return i.ShouldCollide=function(e,i){var n=e.GetBody(),r=i.GetBody();if(r.GetType()===t.b2BodyType.b2_staticBody&&n.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!r.ShouldCollideConnected(n))return!1;var o=e.GetFilterData(),a=i.GetFilterData();return o.groupIndex===a.groupIndex&&0!==o.groupIndex?o.groupIndex>0:0!=(o.maskBits&a.categoryBits)&&0!=(o.categoryBits&a.maskBits)},i.ShouldCollideFixtureParticle=function(){return!0},i.ShouldCollideParticleParticle=function(){return!0},e}();ur.b2_defaultFilter=new ur;var hr=function(){this.normalImpulses=K(s),this.tangentImpulses=K(s),this.count=0},_r=function(){function t(){}var e=t.prototype;return e.BeginContact=function(){},e.EndContact=function(){},e.BeginContactFixtureParticle=function(){},e.EndContactFixtureParticle=function(){},e.BeginContactParticleParticle=function(){},e.EndContactParticleParticle=function(){},e.PreSolve=function(){},e.PostSolve=function(){},t}();_r.b2_defaultListener=new _r;var fr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(){return!0},e.ReportParticle=function(){return!1},e.ShouldQueryParticleSystem=function(){return!0},t}(),pr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(t,e,i,n){return n},e.ReportParticle=function(){return 0},e.ShouldQueryParticleSystem=function(){return!0},t}(),dr=function(){function e(){this.m_broadPhase=new Ve,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=ur.b2_defaultFilter,this.m_contactListener=_r.b2_defaultListener,this.m_contactFactory=new cr}var i=e.prototype;return i.AddPair=function(t,e){var i=t.fixture,n=e.fixture,r=t.childIndex,o=e.childIndex,a=i.GetBody(),s=n.GetBody();if(a!==s){for(var c=s.GetContactList();c;){if(c.other===a){var l=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),h=c.contact.GetChildIndexA(),_=c.contact.GetChildIndexB();if(l===i&&u===n&&h===r&&_===o)return;if(l===n&&u===i&&h===o&&_===r)return}c=c.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(i,n)){var f=this.m_contactFactory.Create(i,r,n,o);null!==f&&(i=f.GetFixtureA(),n=f.GetFixtureB(),r=f.GetChildIndexA(),o=f.GetChildIndexB(),a=i.m_body,s=n.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),this.m_contactList=f,f.m_nodeA.other=s,f.m_nodeA.prev=null,f.m_nodeA.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=f.m_nodeA),a.m_contactList=f.m_nodeA,f.m_nodeB.other=a,f.m_nodeB.prev=null,f.m_nodeB.next=s.m_contactList,null!==s.m_contactList&&(s.m_contactList.prev=f.m_nodeB),s.m_contactList=f.m_nodeB,i.IsSensor()||n.IsSensor()||(a.SetAwake(!0),s.SetAwake(!0)),++this.m_contactCount)}}},i.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs((function(e,i){t.AddPair(e,i)}))},i.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),r=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===r.m_contactList&&(r.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount},i.Collide=function(){for(var e=this.m_contactList;e;){var i=e.GetFixtureA(),n=e.GetFixtureB(),r=e.GetChildIndexA(),o=e.GetChildIndexB(),a=i.GetBody(),s=n.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n)){var c=e;e=c.m_next,this.Destroy(c);continue}e.m_filterFlag=!1}var l=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody,u=s.IsAwake()&&s.m_type!==t.b2BodyType.b2_staticBody;if(l||u){var h=i.m_proxies[r].treeNode,_=n.m_proxies[o].treeNode;if(we(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{var f=e;e=f.m_next,this.Destroy(f)}}else e=e.m_next}},e}(),mr=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),vr=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),gr=function(){function t(){this.c=new At,this.a=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),yr=function(){function t(){this.v=new At,this.w=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),xr=function(){this.step=new vr},Sr=!1,br=function(){function t(){this.rA=new At,this.rB=new At,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),Cr=function(){function t(){this.points=br.MakeArray(s),this.normal=new At,this.tangent=new At,this.normalMass=new Et,this.K=new Et,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),Ar=function(){function e(){this.localPoints=At.MakeArray(s),this.localNormal=new At,this.localPoint=new At,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new At,this.localCenterB=new At,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),Tr=function(){this.step=new vr,this.count=0},wr=function(){function e(){this.normal=new At,this.point=new At,this.separation=0}return e.prototype.Initialize=function(i,n,r,o){var a=e.Initialize_s_pointA,s=e.Initialize_s_pointB,c=e.Initialize_s_planePoint,l=e.Initialize_s_clipPoint;switch(i.type){case t.b2ManifoldType.e_circles:Rt.MulXV(n,i.localPoint,a),Rt.MulXV(r,i.localPoints[0],s),At.SubVV(s,a,this.normal).SelfNormalize(),At.MidVV(a,s,this.point),this.separation=At.DotVV(At.SubVV(s,a,At.s_t0),this.normal)-i.radiusA-i.radiusB;break;case t.b2ManifoldType.e_faceA:It.MulRV(n.q,i.localNormal,this.normal),Rt.MulXV(n,i.localPoint,c),Rt.MulXV(r,i.localPoints[o],l),this.separation=At.DotVV(At.SubVV(l,c,At.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(l);break;case t.b2ManifoldType.e_faceB:It.MulRV(r.q,i.localNormal,this.normal),Rt.MulXV(r,i.localPoint,c),Rt.MulXV(n,i.localPoints[o],l),this.separation=At.DotVV(At.SubVV(l,c,At.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(l),this.normal.SelfNeg()}},e}();wr.Initialize_s_pointA=new At,wr.Initialize_s_pointB=new At,wr.Initialize_s_planePoint=new At,wr.Initialize_s_clipPoint=new At;var Er=function(){function t(){this.m_step=new vr,this.m_positionConstraints=Ar.MakeArray(1024),this.m_velocityConstraints=Cr.MakeArray(1024),this.m_count=0}var e=t.prototype;return e.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=rt(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new Ar;if(this.m_velocityConstraints.length<this.m_count)for(var i=rt(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<i;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Cr;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var n=0;n<this.m_count;++n){var r=this.m_contacts[n],o=r.m_fixtureA,a=r.m_fixtureB,s=o.GetShape(),c=a.GetShape(),l=s.m_radius,u=c.m_radius,h=o.GetBody(),_=a.GetBody(),f=r.GetManifold(),p=f.pointCount,d=this.m_velocityConstraints[n];d.friction=r.m_friction,d.restitution=r.m_restitution,d.tangentSpeed=r.m_tangentSpeed,d.indexA=h.m_islandIndex,d.indexB=_.m_islandIndex,d.invMassA=h.m_invMass,d.invMassB=_.m_invMass,d.invIA=h.m_invI,d.invIB=_.m_invI,d.contactIndex=n,d.pointCount=p,d.K.SetZero(),d.normalMass.SetZero();var m=this.m_positionConstraints[n];m.indexA=h.m_islandIndex,m.indexB=_.m_islandIndex,m.invMassA=h.m_invMass,m.invMassB=_.m_invMass,m.localCenterA.Copy(h.m_sweep.localCenter),m.localCenterB.Copy(_.m_sweep.localCenter),m.invIA=h.m_invI,m.invIB=_.m_invI,m.localNormal.Copy(f.localNormal),m.localPoint.Copy(f.localPoint),m.pointCount=p,m.radiusA=l,m.radiusB=u,m.type=f.type;for(var v=0;v<p;++v){var g=f.points[v],y=d.points[v];this.m_step.warmStarting?(y.normalImpulse=this.m_step.dtRatio*g.normalImpulse,y.tangentImpulse=this.m_step.dtRatio*g.tangentImpulse):(y.normalImpulse=0,y.tangentImpulse=0),y.rA.SetZero(),y.rB.SetZero(),y.normalMass=0,y.tangentMass=0,y.velocityBias=0,m.localPoints[v].Copy(g.localPoint)}}return this},e.InitializeVelocityConstraints=function(){for(var e=t.InitializeVelocityConstraints_s_xfA,i=t.InitializeVelocityConstraints_s_xfB,n=t.InitializeVelocityConstraints_s_worldManifold,r=1e3,o=0;o<this.m_count;++o){var a=this.m_velocityConstraints[o],s=this.m_positionConstraints[o],c=s.radiusA,l=s.radiusB,u=this.m_contacts[a.contactIndex].GetManifold(),h=a.indexA,_=a.indexB,f=a.invMassA,p=a.invMassB,d=a.invIA,v=a.invIB,g=s.localCenterA,y=s.localCenterB,x=this.m_positions[h].c,S=this.m_positions[h].a,b=this.m_velocities[h].v,C=this.m_velocities[h].w,A=this.m_positions[_].c,T=this.m_positions[_].a,w=this.m_velocities[_].v,E=this.m_velocities[_].w;e.q.SetAngle(S),i.q.SetAngle(T),At.SubVV(x,It.MulRV(e.q,g,At.s_t0),e.p),At.SubVV(A,It.MulRV(i.q,y,At.s_t0),i.p),n.Initialize(u,e,c,i,l),a.normal.Copy(n.normal),At.CrossVOne(a.normal,a.tangent);for(var P=a.pointCount,I=0;I<P;++I){var R=a.points[I];At.SubVV(n.points[I],x,R.rA),At.SubVV(n.points[I],A,R.rB);var D=At.CrossVV(R.rA,a.normal),M=At.CrossVV(R.rB,a.normal),O=f+p+d*D*D+v*M*M;R.normalMass=O>0?1/O:0;var B=a.tangent,N=At.CrossVV(R.rA,B),L=At.CrossVV(R.rB,B),F=f+p+d*N*N+v*L*L;R.tangentMass=F>0?1/F:0,R.velocityBias=0;var z=At.DotVV(a.normal,At.SubVV(At.AddVCrossSV(w,E,R.rB,At.s_t0),At.AddVCrossSV(b,C,R.rA,At.s_t1),At.s_t0));z<-m&&(R.velocityBias+=-a.restitution*z)}if(2===a.pointCount&&Sr){var V=a.points[0],k=a.points[1],U=At.CrossVV(V.rA,a.normal),G=At.CrossVV(V.rB,a.normal),H=At.CrossVV(k.rA,a.normal),j=At.CrossVV(k.rB,a.normal),W=f+p+d*U*U+v*G*G,q=f+p+d*H*H+v*j*j,X=f+p+d*U*H+v*G*j;W*W<r*(W*q-X*X)?(a.K.ex.Set(W,X),a.K.ey.Set(X,q),a.K.GetInverse(a.normalMass)):a.pointCount=1}}},e.WarmStart=function(){for(var e=t.WarmStart_s_P,i=0;i<this.m_count;++i){for(var n=this.m_velocityConstraints[i],r=n.indexA,o=n.indexB,a=n.invMassA,s=n.invIA,c=n.invMassB,l=n.invIB,u=n.pointCount,h=this.m_velocities[r].v,_=this.m_velocities[r].w,f=this.m_velocities[o].v,p=this.m_velocities[o].w,d=n.normal,m=n.tangent,v=0;v<u;++v){var g=n.points[v];At.AddVV(At.MulSV(g.normalImpulse,d,At.s_t0),At.MulSV(g.tangentImpulse,m,At.s_t1),e),_-=s*At.CrossVV(g.rA,e),h.SelfMulSub(a,e),p+=l*At.CrossVV(g.rB,e),f.SelfMulAdd(c,e)}this.m_velocities[r].w=_,this.m_velocities[o].w=p}},e.SolveVelocityConstraints=function(){for(var e=t.SolveVelocityConstraints_s_dv,i=t.SolveVelocityConstraints_s_dv1,n=t.SolveVelocityConstraints_s_dv2,r=t.SolveVelocityConstraints_s_P,o=t.SolveVelocityConstraints_s_a,a=t.SolveVelocityConstraints_s_b,s=t.SolveVelocityConstraints_s_x,c=t.SolveVelocityConstraints_s_d,l=t.SolveVelocityConstraints_s_P1,u=t.SolveVelocityConstraints_s_P2,h=t.SolveVelocityConstraints_s_P1P2,_=0;_<this.m_count;++_){for(var f=this.m_velocityConstraints[_],p=f.indexA,d=f.indexB,m=f.invMassA,v=f.invIA,g=f.invMassB,y=f.invIB,x=f.pointCount,S=this.m_velocities[p].v,b=this.m_velocities[p].w,C=this.m_velocities[d].v,A=this.m_velocities[d].w,T=f.normal,w=f.tangent,E=f.friction,P=0;P<x;++P){var I=f.points[P];At.SubVV(At.AddVCrossSV(C,A,I.rB,At.s_t0),At.AddVCrossSV(S,b,I.rA,At.s_t1),e);var R=At.DotVV(e,w)-f.tangentSpeed,D=I.tangentMass*-R,M=E*I.normalImpulse,O=ot(I.tangentImpulse+D,-M,M);D=O-I.tangentImpulse,I.tangentImpulse=O,At.MulSV(D,w,r),S.SelfMulSub(m,r),b-=v*At.CrossVV(I.rA,r),C.SelfMulAdd(g,r),A+=y*At.CrossVV(I.rB,r)}if(1===f.pointCount||!1===Sr)for(var B=0;B<x;++B){var N=f.points[B];At.SubVV(At.AddVCrossSV(C,A,N.rB,At.s_t0),At.AddVCrossSV(S,b,N.rA,At.s_t1),e);var L=At.DotVV(e,T),F=-N.normalMass*(L-N.velocityBias),z=rt(N.normalImpulse+F,0);F=z-N.normalImpulse,N.normalImpulse=z,At.MulSV(F,T,r),S.SelfMulSub(m,r),b-=v*At.CrossVV(N.rA,r),C.SelfMulAdd(g,r),A+=y*At.CrossVV(N.rB,r)}else{var V=f.points[0],k=f.points[1];o.Set(V.normalImpulse,k.normalImpulse),At.SubVV(At.AddVCrossSV(C,A,V.rB,At.s_t0),At.AddVCrossSV(S,b,V.rA,At.s_t1),i),At.SubVV(At.AddVCrossSV(C,A,k.rB,At.s_t0),At.AddVCrossSV(S,b,k.rA,At.s_t1),n);var U=At.DotVV(i,T),G=At.DotVV(n,T);for(a.x=U-V.velocityBias,a.y=G-k.velocityBias,a.SelfSub(Et.MulMV(f.K,o,At.s_t0));;){if(Et.MulMV(f.normalMass,a,s).SelfNeg(),s.x>=0&&s.y>=0){At.SubVV(s,o,c),At.MulSV(c.x,T,l),At.MulSV(c.y,T,u),At.AddVV(l,u,h),S.SelfMulSub(m,h),b-=v*(At.CrossVV(V.rA,l)+At.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),A+=y*(At.CrossVV(V.rB,l)+At.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}if(s.x=-V.normalMass*a.x,s.y=0,U=0,G=f.K.ex.y*s.x+a.y,s.x>=0&&G>=0){At.SubVV(s,o,c),At.MulSV(c.x,T,l),At.MulSV(c.y,T,u),At.AddVV(l,u,h),S.SelfMulSub(m,h),b-=v*(At.CrossVV(V.rA,l)+At.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),A+=y*(At.CrossVV(V.rB,l)+At.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}if(s.x=0,s.y=-k.normalMass*a.y,U=f.K.ey.x*s.y+a.x,G=0,s.y>=0&&U>=0){At.SubVV(s,o,c),At.MulSV(c.x,T,l),At.MulSV(c.y,T,u),At.AddVV(l,u,h),S.SelfMulSub(m,h),b-=v*(At.CrossVV(V.rA,l)+At.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),A+=y*(At.CrossVV(V.rB,l)+At.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}if(s.x=0,s.y=0,U=a.x,G=a.y,U>=0&&G>=0){At.SubVV(s,o,c),At.MulSV(c.x,T,l),At.MulSV(c.y,T,u),At.AddVV(l,u,h),S.SelfMulSub(m,h),b-=v*(At.CrossVV(V.rA,l)+At.CrossVV(k.rA,u)),C.SelfMulAdd(g,h),A+=y*(At.CrossVV(V.rB,l)+At.CrossVV(k.rB,u)),V.normalImpulse=s.x,k.normalImpulse=s.y;break}break}}this.m_velocities[p].w=b,this.m_velocities[d].w=A}},e.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold(),n=0;n<e.pointCount;++n)i.points[n].normalImpulse=e.points[n].normalImpulse,i.points[n].tangentImpulse=e.points[n].tangentImpulse},e.SolvePositionConstraints=function(){for(var e=t.SolvePositionConstraints_s_xfA,i=t.SolvePositionConstraints_s_xfB,n=t.SolvePositionConstraints_s_psm,r=t.SolvePositionConstraints_s_rA,o=t.SolvePositionConstraints_s_rB,a=t.SolvePositionConstraints_s_P,s=0,c=0;c<this.m_count;++c){for(var l=this.m_positionConstraints[c],u=l.indexA,_=l.indexB,f=l.localCenterA,p=l.invMassA,d=l.invIA,m=l.localCenterB,g=l.invMassB,y=l.invIB,x=l.pointCount,S=this.m_positions[u].c,b=this.m_positions[u].a,A=this.m_positions[_].c,T=this.m_positions[_].a,w=0;w<x;++w){e.q.SetAngle(b),i.q.SetAngle(T),At.SubVV(S,It.MulRV(e.q,f,At.s_t0),e.p),At.SubVV(A,It.MulRV(i.q,m,At.s_t0),i.p),n.Initialize(l,e,i,w);var E=n.normal,P=n.point,I=n.separation;At.SubVV(P,S,r),At.SubVV(P,A,o),s=it(s,I);var R=ot(C*(I+h),-v,0),D=At.CrossVV(r,E),M=At.CrossVV(o,E),O=p+g+d*D*D+y*M*M,B=O>0?-R/O:0;At.MulSV(B,E,a),S.SelfMulSub(p,a),b-=d*At.CrossVV(r,a),A.SelfMulAdd(g,a),T+=y*At.CrossVV(o,a)}this.m_positions[u].a=b,this.m_positions[_].a=T}return s>-3*h},e.SolveTOIPositionConstraints=function(e,i){for(var n=t.SolveTOIPositionConstraints_s_xfA,r=t.SolveTOIPositionConstraints_s_xfB,o=t.SolveTOIPositionConstraints_s_psm,a=t.SolveTOIPositionConstraints_s_rA,s=t.SolveTOIPositionConstraints_s_rB,c=t.SolveTOIPositionConstraints_s_P,l=0,u=0;u<this.m_count;++u){var _=this.m_positionConstraints[u],f=_.indexA,p=_.indexB,d=_.localCenterA,m=_.localCenterB,g=_.pointCount,y=0,x=0;f!==e&&f!==i||(y=_.invMassA,x=_.invIA);var S=0,b=0;p!==e&&p!==i||(S=_.invMassB,b=_.invIB);for(var C=this.m_positions[f].c,T=this.m_positions[f].a,w=this.m_positions[p].c,E=this.m_positions[p].a,P=0;P<g;++P){n.q.SetAngle(T),r.q.SetAngle(E),At.SubVV(C,It.MulRV(n.q,d,At.s_t0),n.p),At.SubVV(w,It.MulRV(r.q,m,At.s_t0),r.p),o.Initialize(_,n,r,P);var I=o.normal,R=o.point,D=o.separation;At.SubVV(R,C,a),At.SubVV(R,w,s),l=it(l,D);var M=ot(A*(D+h),-v,0),O=At.CrossVV(a,I),B=At.CrossVV(s,I),N=y+S+x*O*O+b*B*B,L=N>0?-M/N:0;At.MulSV(L,I,c),C.SelfMulSub(y,c),T-=x*At.CrossVV(a,c),w.SelfMulAdd(S,c),E+=b*At.CrossVV(s,c)}this.m_positions[f].a=T,this.m_positions[p].a=E}return l>=-1.5*h},t}();Er.InitializeVelocityConstraints_s_xfA=new Rt,Er.InitializeVelocityConstraints_s_xfB=new Rt,Er.InitializeVelocityConstraints_s_worldManifold=new xe,Er.WarmStart_s_P=new At,Er.SolveVelocityConstraints_s_dv=new At,Er.SolveVelocityConstraints_s_dv1=new At,Er.SolveVelocityConstraints_s_dv2=new At,Er.SolveVelocityConstraints_s_P=new At,Er.SolveVelocityConstraints_s_a=new At,Er.SolveVelocityConstraints_s_b=new At,Er.SolveVelocityConstraints_s_x=new At,Er.SolveVelocityConstraints_s_d=new At,Er.SolveVelocityConstraints_s_P1=new At,Er.SolveVelocityConstraints_s_P2=new At,Er.SolveVelocityConstraints_s_P1P2=new At,Er.SolvePositionConstraints_s_xfA=new Rt,Er.SolvePositionConstraints_s_xfB=new Rt,Er.SolvePositionConstraints_s_psm=new wr,Er.SolvePositionConstraints_s_rA=new At,Er.SolvePositionConstraints_s_rB=new At,Er.SolvePositionConstraints_s_P=new At,Er.SolveTOIPositionConstraints_s_xfA=new Rt,Er.SolveTOIPositionConstraints_s_xfB=new Rt,Er.SolveTOIPositionConstraints_s_psm=new wr,Er.SolveTOIPositionConstraints_s_rA=new At,Er.SolveTOIPositionConstraints_s_rB=new At,Er.SolveTOIPositionConstraints_s_P=new At;var Pr,Ir=function(){function e(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=gr.MakeArray(1024),this.m_velocities=yr.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}var i=e.prototype;return i.Initialize=function(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t)for(var r=rt(2*this.m_positions.length,t);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new gr;if(this.m_velocities.length<t)for(var o=rt(2*this.m_velocities.length,t);this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new yr},i.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},i.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},i.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},i.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},i.Solve=function(i,r,o,a){for(var s=e.s_timer.Reset(),c=r.dt,l=0;l<this.m_bodyCount;++l){var u=this.m_bodies[l];this.m_positions[l].c.Copy(u.m_sweep.c);var h=u.m_sweep.a,_=this.m_velocities[l].v.Copy(u.m_linearVelocity),f=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===t.b2BodyType.b2_dynamicBody&&(_.x+=c*(u.m_gravityScale*o.x+u.m_invMass*u.m_force.x),_.y+=c*(u.m_gravityScale*o.y+u.m_invMass*u.m_force.y),f+=c*u.m_invI*u.m_torque,_.SelfMul(1/(1+c*u.m_linearDamping)),f*=1/(1+c*u.m_angularDamping)),this.m_positions[l].a=h,this.m_velocities[l].w=f}s.Reset();var p=e.s_solverData;p.step.Copy(r),p.positions=this.m_positions,p.velocities=this.m_velocities;var d=e.s_contactSolverDef;d.step.Copy(r),d.contacts=this.m_contacts,d.count=this.m_contactCount,d.positions=this.m_positions,d.velocities=this.m_velocities;var m=e.s_contactSolver.Initialize(d);m.InitializeVelocityConstraints(),r.warmStarting&&m.WarmStart();for(var v=0;v<this.m_jointCount;++v)this.m_joints[v].InitVelocityConstraints(p);i.solveInit=s.GetMilliseconds(),s.Reset();for(var g=0;g<r.velocityIterations;++g){for(var C=0;C<this.m_jointCount;++C)this.m_joints[C].SolveVelocityConstraints(p);m.SolveVelocityConstraints()}m.StoreImpulses(),i.solveVelocity=s.GetMilliseconds();for(var A=0;A<this.m_bodyCount;++A){var T=this.m_positions[A].c,w=this.m_positions[A].a,E=this.m_velocities[A].v,P=this.m_velocities[A].w,I=At.MulSV(c,E,e.s_translation);if(At.DotVV(I,I)>x){var R=y/I.Length();E.SelfMul(R)}var D=c*P;D*D>b&&(P*=S/et(D)),T.x+=c*E.x,T.y+=c*E.y,w+=c*P,this.m_positions[A].a=w,this.m_velocities[A].w=P}s.Reset();for(var M=!1,O=0;O<r.positionIterations;++O){for(var B=m.SolvePositionConstraints(),z=!0,V=0;V<this.m_jointCount;++V){var k=this.m_joints[V].SolvePositionConstraints(p);z=z&&k}if(B&&z){M=!0;break}}for(var U=0;U<this.m_bodyCount;++U){var G=this.m_bodies[U];G.m_sweep.c.Copy(this.m_positions[U].c),G.m_sweep.a=this.m_positions[U].a,G.m_linearVelocity.Copy(this.m_velocities[U].v),G.m_angularVelocity=this.m_velocities[U].w,G.SynchronizeTransform()}if(i.solvePosition=s.GetMilliseconds(),this.Report(m.m_velocityConstraints),a){for(var H=n,j=L*L,W=F*F,q=0;q<this.m_bodyCount;++q){var X=this.m_bodies[q];X.GetType()!==t.b2BodyType.b2_staticBody&&(!X.m_autoSleepFlag||X.m_angularVelocity*X.m_angularVelocity>W||At.DotVV(X.m_linearVelocity,X.m_linearVelocity)>j?(X.m_sleepTime=0,H=0):(X.m_sleepTime+=c,H=it(H,X.m_sleepTime)))}if(H>=N&&M)for(var Y=0;Y<this.m_bodyCount;++Y)this.m_bodies[Y].SetAwake(!1)}},i.SolveTOI=function(t,i,n){for(var r=0;r<this.m_bodyCount;++r){var o=this.m_bodies[r];this.m_positions[r].c.Copy(o.m_sweep.c),this.m_positions[r].a=o.m_sweep.a,this.m_velocities[r].v.Copy(o.m_linearVelocity),this.m_velocities[r].w=o.m_angularVelocity}var a=e.s_contactSolverDef;a.contacts=this.m_contacts,a.count=this.m_contactCount,a.step.Copy(t),a.positions=this.m_positions,a.velocities=this.m_velocities;for(var s=e.s_contactSolver.Initialize(a),c=0;c<t.positionIterations&&!s.SolveTOIPositionConstraints(i,n);++c);this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,s.InitializeVelocityConstraints();for(var l=0;l<t.velocityIterations;++l)s.SolveVelocityConstraints();for(var u=t.dt,h=0;h<this.m_bodyCount;++h){var _=this.m_positions[h].c,f=this.m_positions[h].a,p=this.m_velocities[h].v,d=this.m_velocities[h].w,m=At.MulSV(u,p,e.s_translation);if(At.DotVV(m,m)>x){var v=y/m.Length();p.SelfMul(v)}var g=u*d;g*g>b&&(d*=S/et(g)),_.SelfMulAdd(u,p),f+=u*d,this.m_positions[h].a=f,this.m_velocities[h].w=d;var C=this.m_bodies[h];C.m_sweep.c.Copy(_),C.m_sweep.a=f,C.m_linearVelocity.Copy(p),C.m_angularVelocity=d,C.SynchronizeTransform()}this.Report(s.m_velocityConstraints)},i.Report=function(t){if(null!==this.m_listener)for(var i=0;i<this.m_contactCount;++i){var n=this.m_contacts[i];if(n){var r=t[i],o=e.s_impulse;o.count=r.pointCount;for(var a=0;a<r.pointCount;++a)o.normalImpulses[a]=r.points[a].normalImpulse,o.tangentImpulses[a]=r.points[a].tangentImpulse;this.m_listener.PostSolve(n,o)}}},e}();Ir.s_timer=new Nt,Ir.s_solverData=new xr,Ir.s_contactSolverDef=new Tr,Ir.s_contactSolver=new Er,Ir.s_translation=new At,Ir.s_impulse=new hr,(Pr=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Pr.b2_waterParticle=0]="b2_waterParticle",Pr[Pr.b2_zombieParticle=2]="b2_zombieParticle",Pr[Pr.b2_wallParticle=4]="b2_wallParticle",Pr[Pr.b2_springParticle=8]="b2_springParticle",Pr[Pr.b2_elasticParticle=16]="b2_elasticParticle",Pr[Pr.b2_viscousParticle=32]="b2_viscousParticle",Pr[Pr.b2_powderParticle=64]="b2_powderParticle",Pr[Pr.b2_tensileParticle=128]="b2_tensileParticle",Pr[Pr.b2_colorMixingParticle=256]="b2_colorMixingParticle",Pr[Pr.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Pr[Pr.b2_barrierParticle=1024]="b2_barrierParticle",Pr[Pr.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Pr[Pr.b2_reactiveParticle=4096]="b2_reactiveParticle",Pr[Pr.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Pr[Pr.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Pr[Pr.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Pr[Pr.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Pr[Pr.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var Rr=function(){this.flags=0,this.position=new At,this.velocity=new At,this.color=new Ot(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Dr(t,e,i){var n=8,r=.01;return ot(Math.ceil(Math.sqrt(t/(r*e))*i),1,n)}var Mr,Or=function(){function t(){this.m_index=T}var e=t.prototype;return e.GetIndex=function(){return this.m_index},e.SetIndex=function(t){this.m_index=t},t}();(Mr=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[Mr.b2_solidParticleGroup=1]="b2_solidParticleGroup",Mr[Mr.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Mr[Mr.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Mr[Mr.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Mr[Mr.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Mr[Mr.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Br=function(){this.flags=0,this.groupFlags=0,this.position=new At,this.angle=0,this.linearVelocity=new At,this.angularVelocity=0,this.color=new Ot,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Nr=function(){function e(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new At,this.m_linearVelocity=new At,this.m_angularVelocity=0,this.m_transform=new Rt,this.m_userData=null,this.m_system=t}var i=e.prototype;return i.GetNext=function(){return this.m_next},i.GetParticleSystem=function(){return this.m_system},i.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},i.GetBufferIndex=function(){return this.m_firstIndex},i.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},i.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},i.GetGroupFlags=function(){return this.m_groupFlags},i.SetGroupFlags=function(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)},i.GetMass=function(){return this.UpdateStatistics(),this.m_mass},i.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},i.GetCenter=function(){return this.UpdateStatistics(),this.m_center},i.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},i.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},i.GetTransform=function(){return this.m_transform},i.GetPosition=function(){return this.m_transform.p},i.GetAngle=function(){return this.m_transform.q.GetAngle()},i.GetLinearVelocityFromWorldPoint=function(t,i){var n=e.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),At.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,At.SubVV(t,this.m_center,n),i)},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},i.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},i.DestroyParticles=function(t){if(this.m_system.m_world.IsLocked())throw new Error;for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},i.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var t=new At,e=new At;if(this.m_timestamp!==this.m_system.m_timestamp){var i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var n=this.m_firstIndex;n<this.m_lastIndex;n++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[n]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[n]);if(this.m_mass>0){var r=1/this.m_mass;this.m_center.SelfMul(r),this.m_linearVelocity.SelfMul(r)}this.m_inertia=0,this.m_angularVelocity=0;for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)At.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),At.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=i*At.DotVV(t,t),this.m_angularVelocity+=i*At.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},e}();Nr.GetLinearVelocityFromWorldPoint_s_t0=new At;var Lr=function(){function t(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}var e=t.prototype;return e.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++},e.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},e.Empty=function(){return this.m_front===this.m_back},e.Front=function(){var t=this.m_buffer[this.m_front];if(!t)throw new Error;return t},Q(t,[{key:"m_capacity",get:function(){return this.m_buffer.length}}]),t}(),Fr=function(){function t(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(t,(function(){return new zr})),this.m_generatorCapacity=t}var e=t.prototype;return e.AddGenerator=function(t,e,i){var n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i},e.Generate=function(t,e){for(var i=1/t,r=new At(+n,+n),o=new At(-n,-n),a=0,s=0;s<this.m_generatorCount;s++){var c=this.m_generatorBuffer[s];c.necessary&&(At.MinV(r,c.center,r),At.MaxV(o,c.center,o),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);r.x-=e,r.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(i*(o.x-r.x)),this.m_countY=1+Math.floor(i*(o.y-r.y)),this.m_diagram=[];for(var l=new Lr(4*this.m_countX*this.m_countY),u=0;u<this.m_generatorCount;u++){var h=this.m_generatorBuffer[u];h.center.SelfSub(r).SelfMul(i);var _=Math.floor(h.center.x),f=Math.floor(h.center.y);_>=0&&f>=0&&_<this.m_countX&&f<this.m_countY&&l.Push(new Vr(_,f,_+f*this.m_countX,h))}for(;!l.Empty();){var p=l.Front(),d=p.m_x,m=p.m_y,v=p.m_i,g=p.m_generator;l.Pop(),this.m_diagram[v]||(this.m_diagram[v]=g,d>0&&l.Push(new Vr(d-1,m,v-1,g)),m>0&&l.Push(new Vr(d,m-1,v-this.m_countX,g)),d<this.m_countX-1&&l.Push(new Vr(d+1,m,v+1,g)),m<this.m_countY-1&&l.Push(new Vr(d,m+1,v+this.m_countX,g)))}for(var y=0;y<this.m_countY;y++)for(var x=0;x<this.m_countX-1;x++){var S=x+y*this.m_countX,b=this.m_diagram[S],C=this.m_diagram[S+1];b!==C&&(l.Push(new Vr(x,y,S,C)),l.Push(new Vr(x+1,y,S+1,b)))}for(var A=0;A<this.m_countY-1;A++)for(var T=0;T<this.m_countX;T++){var w=T+A*this.m_countX,E=this.m_diagram[w],P=this.m_diagram[w+this.m_countX];E!==P&&(l.Push(new Vr(T,A,w,P)),l.Push(new Vr(T,A+1,w+this.m_countX,E)))}for(;!l.Empty();){var I=l.Front(),R=I.m_x,D=I.m_y,M=I.m_i,O=I.m_generator;l.Pop();var B=this.m_diagram[M],N=O;if(B!==N){var L=B.center.x-R,F=B.center.y-D,z=N.center.x-R,V=N.center.y-D;L*L+F*F>z*z+V*V&&(this.m_diagram[M]=N,R>0&&l.Push(new Vr(R-1,D,M-1,N)),D>0&&l.Push(new Vr(R,D-1,M-this.m_countX,N)),R<this.m_countX-1&&l.Push(new Vr(R+1,D,M+1,N)),D<this.m_countY-1&&l.Push(new Vr(R,D+1,M+this.m_countX,N)))}}},e.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var i=0;i<this.m_countX-1;i++){var n=i+e*this.m_countX,r=this.m_diagram[n],o=this.m_diagram[n+1],a=this.m_diagram[n+this.m_countX],s=this.m_diagram[n+1+this.m_countX];o!==a&&(r!==o&&r!==a&&(r.necessary||o.necessary||a.necessary)&&t(r.tag,o.tag,a.tag),s!==o&&s!==a&&(r.necessary||o.necessary||a.necessary)&&t(o.tag,s.tag,a.tag))}},t}(),zr=function(){this.center=new At,this.tag=0,this.necessary=!1},Vr=function(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n};function kr(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function Ur(t,e){return t<e}function Gr(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===n&&(n=Ur);for(var r=e,o=[],a=0;;){for(;r+1<i;i++){var s=t[r+Math.floor(Math.random()*(i-r))];o[a++]=i;for(var c=r-1;;){for(;n(t[++c],s););for(;n(s,t[--i]););if(c>=i)break;kr(t,c,i)}}if(0===a)break;r=i,i=o[--a]}return t}function Hr(t,e,i,n){return void 0===e&&(e=0),void 0===i&&(i=t.length-e),void 0===n&&(n=Ur),Gr(t,e,i,n)}function jr(t,e,i){void 0===i&&(i=t.length);for(var n=0,r=0;r<i;++r)e(t[r])||(r!==n?kr(t,n++,r):++n);return n}function Wr(t,e,i,n,r){for(var o=i-e;o>0;){var a=Math.floor(o/2),s=e+a;r(t[s],n)?(e=++s,o-=a+1):o=a}return e}function qr(t,e,i,n,r){for(var o=i-e;o>0;){var a=Math.floor(o/2),s=e+a;r(n,t[s])?o=a:(e=++s,o-=a+1)}return e}function Xr(t,e,i,n){for(var r=i;e!==r;)kr(t,e++,r++),r===n?r=i:e===i&&(i=r)}function Yr(t,e,i,n){if(e===i)return i;for(var r=e;++e!==i;)n(t[r],t[e])||kr(t,++r,e);return++r}var Kr=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}var e=t.prototype;return e.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},e.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},e.Grow=function(){var t=this.capacity?2*this.capacity:O;this.Reserve(t)},e.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},e.Shorten=function(){},e.Data=function(){return this.data},e.GetCount=function(){return this.count},e.SetCount=function(t){this.count=t},e.GetCapacity=function(){return this.capacity},e.RemoveIf=function(t){this.count=jr(this.data,t,this.count)},e.Unique=function(t){this.count=Yr(this.data,0,this.count,t)},t}(),Jr=function(t){function e(e){var i;return(i=t.call(this)||this).m_system=e,i}$(e,t);var i=e.prototype;return i.ShouldQueryParticleSystem=function(){return!1},i.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),i=0;i<e;i++)for(var n=t.GetAABB(i),r=this.m_system.GetInsideBoundsEnumerator(n),o=void 0;(o=r.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,o);return!0},i.ReportParticle=function(){return!1},i.ReportFixtureAndParticle=function(){},e}(fr),Qr=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new At,this.flags=0}var e=t.prototype;return e.SetIndices=function(t,e){this.indexA=t,this.indexB=e},e.SetWeight=function(t){this.weight=t},e.SetNormal=function(t){this.normal.Copy(t)},e.SetFlags=function(t){this.flags=t},e.GetIndexA=function(){return this.indexA},e.GetIndexB=function(){return this.indexB},e.GetWeight=function(){return this.weight},e.GetNormal=function(){return this.normal},e.GetFlags=function(){return this.flags},e.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},e.IsNotEqual=function(t){return!this.IsEqual(t)},e.ApproximatelyEqual=function(t){var e=.01,i=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&et(this.weight-t.weight)<e&&At.DistanceSquaredVV(this.normal,t.normal)<i},t}(),Zr=function(){this.index=0,this.weight=0,this.normal=new At,this.mass=0},$r=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},to=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new At(0,0),this.pb=new At(0,0),this.pc=new At(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},eo=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}var e=t.prototype;return e.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},e.Clone=function(){return(new t).Copy(this)},t}(),io=function(){function e(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new no,this.m_flagsBuffer=new no,this.m_positionBuffer=new no,this.m_velocityBuffer=new no,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new no,this.m_groupBuffer=[],this.m_userDataBuffer=new no,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new no,this.m_bodyContactCountBuffer=new no,this.m_consecutiveContactStepsBuffer=new no,this.m_stuckParticleBuffer=new Kr((function(){return 0})),this.m_proxyBuffer=new Kr((function(){return new ro})),this.m_contactBuffer=new Kr((function(){return new Qr})),this.m_bodyContactBuffer=new Kr((function(){return new Zr})),this.m_pairBuffer=new Kr((function(){return new $r})),this.m_triadBuffer=new Kr((function(){return new to})),this.m_expirationTimeBuffer=new no,this.m_indexByExpirationTimeBuffer=new no,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new eo,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}e.computeTag=function(t,i){return(i+e.yOffset>>>0<<e.yShift)+(e.xScale*t+e.xOffset>>>0)>>>0},e.computeRelativeTag=function(t,i,n){return t+(n<<e.yShift)+(i<<e.xShift)>>>0};var r=e.prototype;return r.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},r.CreateParticle=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var e=this.m_count?2*this.m_count:O;this.ReallocateInternalAllocatedBuffers(e)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var n=this.m_count++;this.m_flagsBuffer.data[n]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=0),this.m_positionBuffer.data[n]=(this.m_positionBuffer.data[n]||new At).Copy(i(t.position,At.ZERO)),this.m_velocityBuffer.data[n]=(this.m_velocityBuffer.data[n]||new At).Copy(i(t.velocity,At.ZERO)),this.m_weightBuffer[n]=0,this.m_forceBuffer[n]=(this.m_forceBuffer[n]||new At).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=0),this.m_depthBuffer&&(this.m_depthBuffer[n]=0);var r=(new Ot).Copy(i(t.color,Ot.ZERO));!this.m_colorBuffer.data&&r.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[n]=(this.m_colorBuffer.data[n]||new Ot).Copy(r)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[n]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[n]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],a=i(t.lifetime,0),s=a>0;(this.m_expirationTimeBuffer.data||s)&&(this.SetParticleLifetime(n,s?a:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[n]=n),o.index=n;var c=i(t.group,null);return this.m_groupBuffer[n]=c,c&&(c.m_firstIndex<c.m_lastIndex?(this.RotateBuffer(c.m_firstIndex,c.m_lastIndex,n),c.m_lastIndex=n+1):(c.m_firstIndex=n,c.m_lastIndex=n+1)),this.SetParticleFlags(n,i(t.flags,0)),n},r.GetParticleHandleFromIndex=function(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new Or).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)},r.DestroyParticle=function(e,i){void 0===i&&(i=!1);var n=t.b2ParticleFlag.b2_zombieParticle;i&&(n|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|n)},r.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],r=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:r,e)},r.DestroyParticlesInShape=function(t,i,n){void 0===n&&(n=!1);var r=e.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var o=new fo(this,t,i,n),a=r;return t.ComputeAABB(a,i,0),this.m_world.QueryAABB(o,a),o.Destroyed()},r.CreateParticleGroup=function(t){var n=e.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var r=n;r.SetPositionAngle(i(t.position,At.ZERO),i(t.angle,0));var o=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,r),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,i(t.shapeCount,t.shapes.length),t,r),t.positionData)for(var a=i(t.particleCount,t.positionData.length),s=0;s<a;s++){var c=t.positionData[s];this.CreateParticleForGroup(t,r,c)}var l=this.m_count,u=new Nr(this);u.m_firstIndex=o,u.m_lastIndex=l,u.m_strength=i(t.strength,1),u.m_userData=t.userData,u.m_transform.Copy(r),u.m_prev=null,u.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=u),this.m_groupList=u,++this.m_groupCount;for(var h=o;h<l;h++)this.m_groupBuffer[h]=u;this.SetGroupFlags(u,i(t.groupFlags,0));var _=new _o;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,l,_),t.group&&(this.JoinParticleGroups(t.group,u),u=t.group),u},r.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);var i=new po(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(var n=e.m_firstIndex;n<e.m_lastIndex;n++)this.m_groupBuffer[n]=t;var r=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,r),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)},r.SplitParticleGroup=function(t){this.UpdateContacts(!0);var i=X(t.GetParticleCount(),(function(){return new ao}));e.InitializeParticleLists(t,i),this.MergeParticleListsInContact(t,i);var n=e.FindLongestParticleList(t,i);this.MergeZombieParticleListNodes(t,i,n),this.CreateParticleGroupsFromParticleList(t,i,n),this.UpdatePairsAndTriadsWithParticleList(t,i)},r.GetParticleGroupList=function(){return this.m_groupList},r.GetParticleGroupCount=function(){return this.m_groupCount},r.GetParticleCount=function(){return this.m_count},r.GetMaxParticleCount=function(){return this.m_def.maxCount},r.SetMaxParticleCount=function(t){this.m_def.maxCount=t},r.GetAllParticleFlags=function(){return this.m_allParticleFlags},r.GetAllGroupFlags=function(){return this.m_allGroupFlags},r.SetPaused=function(t){this.m_paused=t},r.GetPaused=function(){return this.m_paused},r.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},r.GetDensity=function(){return this.m_def.density},r.SetGravityScale=function(t){this.m_def.gravityScale=t},r.GetGravityScale=function(){return this.m_def.gravityScale},r.SetDamping=function(t){this.m_def.dampingStrength=t},r.GetDamping=function(){return this.m_def.dampingStrength},r.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},r.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},r.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},r.GetRadius=function(){return this.m_particleDiameter/2},r.GetPositionBuffer=function(){return this.m_positionBuffer.data},r.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},r.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},r.GetGroupBuffer=function(){return this.m_groupBuffer},r.GetWeightBuffer=function(){return this.m_weightBuffer},r.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},r.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},r.SetParticleFlags=function(e,i){this.m_flagsBuffer.data[e]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[e]=i},r.GetParticleFlags=function(t){return this.m_flagsBuffer.data[t]},r.SetFlagsBuffer=function(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)},r.SetPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),n=0;n<e;++n)i[n]=new At(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)},r.SetVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),n=0;n<e;++n)i[n]=new At(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)},r.SetColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,i=new Array(e),n=0;n<e;++n)i[n]=new Ot(t.subarray(4*n,4*n+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)},r.SetUserDataBuffer=function(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)},r.GetContacts=function(){return this.m_contactBuffer.data},r.GetContactCount=function(){return this.m_contactBuffer.count},r.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},r.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},r.GetPairs=function(){return this.m_pairBuffer.data},r.GetPairCount=function(){return this.m_pairBuffer.count},r.GetTriads=function(){return this.m_triadBuffer.data},r.GetTriadCount=function(){return this.m_triadBuffer.count},r.SetStuckThreshold=function(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},r.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},r.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},r.ComputeCollisionEnergy=function(){for(var t=e.ComputeCollisionEnergy_s_v,i=this.m_velocityBuffer.data,n=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=o.normal,l=At.SubVV(i[s],i[a],t),u=At.DotVV(l,c);u<0&&(n+=u*u)}return.5*this.GetParticleMass()*n},r.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},r.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},r.SetParticleLifetime=function(t,e){var i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i)for(var n=this.GetParticleCount(),r=0;r<n;++r)this.m_indexByExpirationTimeBuffer.data[r]=r;var o=e/this.m_def.lifetimeGranularity,a=o>0?this.GetQuantizedTimeElapsed()+o:o;a!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=a,this.m_expirationTimeBufferRequiresSorting=!0)},r.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},r.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},r.GetDestructionByAge=function(){return this.m_def.destroyByAge},r.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},r.ExpirationTimeToLifetime=function(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},r.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},r.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},r.ApplyLinearImpulse=function(t,e,i){for(var n=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),o=(new At).Copy(i).SelfMul(1/r),a=t;a<e;a++)n[a].SelfAdd(o)},e.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},r.ParticleApplyForce=function(t,i){e.IsSignificantForce(i)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(i))},r.ApplyForce=function(t,i,n){var r=(new At).Copy(n).SelfMul(1/(i-t));if(e.IsSignificantForce(r)){this.PrepareForceBuffer();for(var o=t;o<i;o++)this.m_forceBuffer[o].SelfAdd(r)}},r.GetNext=function(){return this.m_next},r.QueryAABB=function(t,i){if(0!==this.m_proxyBuffer.count)for(var n=0,r=this.m_proxyBuffer.count,o=Wr(this.m_proxyBuffer.data,n,r,e.computeTag(this.m_inverseDiameter*i.lowerBound.x,this.m_inverseDiameter*i.lowerBound.y),ro.CompareProxyTag),a=qr(this.m_proxyBuffer.data,o,r,e.computeTag(this.m_inverseDiameter*i.upperBound.x,this.m_inverseDiameter*i.upperBound.y),ro.CompareTagProxy),s=this.m_positionBuffer.data,c=o;c<a;++c){var l=this.m_proxyBuffer.data[c].index,u=s[l];if(i.lowerBound.x<u.x&&u.x<i.upperBound.x&&i.lowerBound.y<u.y&&u.y<i.upperBound.y&&!t.ReportParticle(this,l))break}},r.QueryShapeAABB=function(t,i,n,r){void 0===r&&(r=0);var o=e.QueryShapeAABB_s_aabb;i.ComputeAABB(o,n,r),this.QueryAABB(t,o)},r.QueryPointAABB=function(t,i,n){void 0===n&&(n=h);var r=e.QueryPointAABB_s_aabb;r.lowerBound.Set(i.x-n,i.y-n),r.upperBound.Set(i.x+n,i.y+n),this.QueryAABB(t,r)},r.RayCast=function(t,i,n){var r=e.RayCast_s_aabb,o=e.RayCast_s_p,a=e.RayCast_s_v,s=e.RayCast_s_n,c=e.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var l=this.m_positionBuffer.data,u=r;At.MinV(i,n,u.lowerBound),At.MaxV(i,n,u.upperBound);for(var h,_=1,f=At.SubVV(n,i,a),p=At.DotVV(f,f),d=this.GetInsideBoundsEnumerator(u);(h=d.GetNext())>=0;){var m=At.SubVV(i,l[h],o),v=At.DotVV(m,f),g=v*v-p*(At.DotVV(m,m)-this.m_squaredDiameter);if(g>=0){var y=ht(g),x=(-v-y)/p;if(x>_)continue;if(x<0&&((x=(-v+y)/p)<0||x>_))continue;var S=At.AddVMulSV(m,x,f,s);if(S.Normalize(),(_=it(_,t.ReportParticle(this,h,At.AddVMulSV(i,x,f,c),S,x)))<=0)break}}}},r.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;for(var i=this.m_positionBuffer.data,r=0;r<e;r++){var o=i[r];At.MinV(t.lowerBound,o,t.lowerBound),At.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},r.FreeBuffer=function(t){null!==t&&(t.length=0)},r.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},r.ReallocateBuffer3=function(t,e,i){if(i<=e)throw new Error;var n=t?t.slice():[];return n.length=i,n},r.ReallocateBuffer5=function(t,e,i,n,r){if(n<=i)throw new Error;if(e&&!(n<=e))throw new Error;return r&&!t||e||(t=this.ReallocateBuffer3(t,i,n)),t},r.ReallocateBuffer4=function(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)},r.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(O),(t=[]).length=this.m_internalAllocatedCapacity),t},r.ReallocateHandleBuffers=function(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},r.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var i=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},r.CreateParticleForGroup=function(t,e,n){var r=new Rr;r.flags=i(t.flags,0),Rt.MulXV(e,n,r.position),At.AddVV(i(t.linearVelocity,At.ZERO),At.CrossSV(i(t.angularVelocity,0),At.SubVV(r.position,i(t.position,At.ZERO),At.s_t0),At.s_t0),r.velocity),r.color.Copy(i(t.color,Ot.ZERO)),r.lifetime=i(t.lifetime,0),r.userData=t.userData,this.CreateParticle(r)},r.CreateParticlesStrokeShapeForGroup=function(n,r,o){var a=e.CreateParticlesStrokeShapeForGroup_s_edge,s=e.CreateParticlesStrokeShapeForGroup_s_d,c=e.CreateParticlesStrokeShapeForGroup_s_p,l=i(r.stride,0);0===l&&(l=this.GetParticleStride());for(var u=0,h=n.GetChildCount(),_=0;_<h;_++){var f=null;n.GetType()===t.b2ShapeType.e_edgeShape?f=n:(f=a,n.GetChildEdge(f,_));for(var p=At.SubVV(f.m_vertex2,f.m_vertex1,s),d=p.Length();u<d;){var m=At.AddVMulSV(f.m_vertex1,u/d,p,c);this.CreateParticleForGroup(r,o,m),u+=l}u-=d}},r.CreateParticlesFillShapeForGroup=function(t,n,r){var o=e.CreateParticlesFillShapeForGroup_s_aabb,a=e.CreateParticlesFillShapeForGroup_s_p,s=i(n.stride,0);0===s&&(s=this.GetParticleStride());var c=Rt.IDENTITY,l=o;t.ComputeAABB(l,c,0);for(var u=Math.floor(l.lowerBound.y/s)*s;u<l.upperBound.y;u+=s)for(var h=Math.floor(l.lowerBound.x/s)*s;h<l.upperBound.x;h+=s){var _=a.Set(h,u);t.TestPoint(c,_)&&this.CreateParticleForGroup(n,r,_)}},r.CreateParticlesWithShapeForGroup=function(e,i,n){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,i,n);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,i,n)}},r.CreateParticlesWithShapesForGroup=function(t,e,i,n){var r=new mo(t,e);this.CreateParticlesFillShapeForGroup(r,i,n)},r.CloneParticle=function(t,e){var i=new Rr;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;var n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){var r=this.m_handleIndexBuffer.data[t];r&&r.SetIndex(n),this.m_handleIndexBuffer.data[n]=r,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n},r.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)},r.DestroyParticleGroup=function(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},e.ParticleCanBeConnected=function(e,i){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==i&&0!=(i.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.UpdatePairsAndTriads=function(i,n,r){for(var o=e.UpdatePairsAndTriads_s_dab,a=e.UpdatePairsAndTriads_s_dbc,s=e.UpdatePairsAndTriads_s_dca,c=this.m_positionBuffer.data,l=0,u=i;u<n;u++)l|=this.m_flagsBuffer.data[u];if(l&e.k_pairFlags)for(var h=0;h<this.m_contactBuffer.count;h++){var _=this.m_contactBuffer.data[h],f=_.indexA,p=_.indexB,d=this.m_flagsBuffer.data[f],m=this.m_flagsBuffer.data[p],v=this.m_groupBuffer[f],g=this.m_groupBuffer[p];if(f>=i&&f<n&&p>=i&&p<n&&!((d|m)&t.b2ParticleFlag.b2_zombieParticle)&&(d|m)&e.k_pairFlags&&(r.IsNecessary(f)||r.IsNecessary(p))&&e.ParticleCanBeConnected(d,v)&&e.ParticleCanBeConnected(m,g)&&r.ShouldCreatePair(f,p)){var y=this.m_pairBuffer.data[this.m_pairBuffer.Append()];y.indexA=f,y.indexB=p,y.flags=_.flags,y.strength=it(v?v.m_strength:1,g?g.m_strength:1),y.distance=At.DistanceVV(c[f],c[p])}Hr(this.m_pairBuffer.data,0,this.m_pairBuffer.count,e.ComparePairIndices),this.m_pairBuffer.Unique(e.MatchPairIndices)}if(l&e.k_triadFlags){for(var x=new Fr(n-i),S=i;S<n;S++){var b=this.m_flagsBuffer.data[S],C=this.m_groupBuffer[S];b&t.b2ParticleFlag.b2_zombieParticle||!e.ParticleCanBeConnected(b,C)||x.AddGenerator(c[S],S,r.IsNecessary(S))}var A=this.GetParticleStride();x.Generate(A/2,2*A);var T=this,w=function(t,i,n){var l=T.m_flagsBuffer.data[t],u=T.m_flagsBuffer.data[i],h=T.m_flagsBuffer.data[n];if((l|u|h)&e.k_triadFlags&&r.ShouldCreateTriad(t,i,n)){var _=c[t],f=c[i],p=c[n],d=At.SubVV(_,f,o),m=At.SubVV(f,p,a),v=At.SubVV(p,_,s),g=M*T.m_squaredDiameter;if(At.DotVV(d,d)>g||At.DotVV(m,m)>g||At.DotVV(v,v)>g)return;var y=T.m_groupBuffer[t],x=T.m_groupBuffer[i],S=T.m_groupBuffer[n],b=T.m_triadBuffer.data[T.m_triadBuffer.Append()];b.indexA=t,b.indexB=i,b.indexC=n,b.flags=l|u|h,b.strength=it(it(y?y.m_strength:1,x?x.m_strength:1),S?S.m_strength:1);var C=(_.x+f.x+p.x)/3,A=(_.y+f.y+p.y)/3;b.pa.x=_.x-C,b.pa.y=_.y-A,b.pb.x=f.x-C,b.pb.y=f.y-A,b.pc.x=p.x-C,b.pc.y=p.y-A,b.ka=-At.DotVV(v,d),b.kb=-At.DotVV(d,m),b.kc=-At.DotVV(m,v),b.s=At.CrossVV(_,f)+At.CrossVV(f,p)+At.CrossVV(p,_)}};x.GetNodes(w),Hr(this.m_triadBuffer.data,0,this.m_triadBuffer.count,e.CompareTriadIndices),this.m_triadBuffer.Unique(e.MatchTriadIndices)}},r.UpdatePairsAndTriadsWithReactiveParticles=function(){var e=new vo(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(var i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle},e.ComparePairIndices=function(t,e){var i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB},e.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},e.CompareTriadIndices=function(t,e){var i=t.indexA-e.indexA;if(0!==i)return i<0;var n=t.indexB-e.indexB;return 0!==n?n<0:t.indexC<e.indexC},e.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},e.InitializeParticleLists=function(t,e){for(var i=t.GetBufferIndex(),n=t.GetParticleCount(),r=0;r<n;r++){var o=e[r];o.list=o,o.next=null,o.count=1,o.index=r+i}},r.MergeParticleListsInContact=function(t,i){for(var n=t.GetBufferIndex(),r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB;if(t.ContainsParticle(a)&&t.ContainsParticle(s)){var c=i[a-n].list,l=i[s-n].list;if(c!==l){if(c.count<l.count){var u=c;c=l,l=u}e.MergeParticleLists(c,l)}}}},e.MergeParticleLists=function(t,e){for(var i=e;;){i.list=t;var n=i.next;if(!n){i.next=t.next;break}i=n}t.next=e,t.count+=e.count,e.count=0},e.FindLongestParticleList=function(t,e){for(var i=t.GetParticleCount(),n=e[0],r=0;r<i;r++){var o=e[r];n.count<o.count&&(n=o)}return n},r.MergeZombieParticleListNodes=function(i,n,r){for(var o=i.GetParticleCount(),a=0;a<o;a++){var s=n[a];s!==r&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&e.MergeParticleListAndNode(r,s)}},e.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},r.CreateParticleGroupsFromParticleList=function(e,i,n){var r=e.GetParticleCount(),o=new Br;o.groupFlags=e.GetGroupFlags(),o.userData=e.GetUserData();for(var a=0;a<r;a++){var s=i[a];if(s.count&&s!==n)for(var c=this.CreateParticleGroup(o),l=s;l;l=l.next){var u=l.index,h=this.CloneParticle(u,c);this.m_flagsBuffer.data[u]|=t.b2ParticleFlag.b2_zombieParticle,l.index=h}}},r.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var i=t.GetBufferIndex(),n=0;n<this.m_pairBuffer.count;n++){var r=this.m_pairBuffer.data[n],o=r.indexA,a=r.indexB;t.ContainsParticle(o)&&(r.indexA=e[o-i].index),t.ContainsParticle(a)&&(r.indexB=e[a-i].index)}for(var s=0;s<this.m_triadBuffer.count;s++){var c=this.m_triadBuffer.data[s],l=c.indexA,u=c.indexB,h=c.indexC;t.ContainsParticle(l)&&(c.indexA=e[l-i].index),t.ContainsParticle(u)&&(c.indexB=e[u-i].index),t.ContainsParticle(h)&&(c.indexC=e[h-i].index)}},r.ComputeDepth=function(){for(var e=[],i=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=this.m_groupBuffer[a],l=this.m_groupBuffer[s];c&&c===l&&c.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[i++]=o)}for(var u=[],h=0,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){u[h++]=_,this.SetGroupFlags(_,_.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var f=_.m_firstIndex;f<_.m_lastIndex;f++)this.m_accumulationBuffer[f]=0}for(var p=0;p<i;p++){var d=e[p],m=d.indexA,v=d.indexB,g=d.weight;this.m_accumulationBuffer[m]+=g,this.m_accumulationBuffer[v]+=g}for(var y=0;y<h;y++)for(var x=u[y],S=x.m_firstIndex;S<x.m_lastIndex;S++){var b=this.m_accumulationBuffer[S];this.m_depthBuffer[S]=b<.8?0:n}for(var C=ht(this.m_count)>>0,A=0;A<C;A++){for(var T=!1,w=0;w<i;w++){var E=e[w],P=E.indexA,I=E.indexB,R=1-E.weight,D=this.m_depthBuffer[P],M=this.m_depthBuffer[I],O=M+R,B=D+R;D>O&&(this.m_depthBuffer[P]=O,T=!0),M>B&&(this.m_depthBuffer[I]=B,T=!0)}if(!T)break}for(var N=0;N<h;N++)for(var L=u[N],F=L.m_firstIndex;F<L.m_lastIndex;F++)this.m_depthBuffer[F]<n?this.m_depthBuffer[F]*=this.m_particleDiameter:this.m_depthBuffer[F]=0},r.GetInsideBoundsEnumerator=function(t){var i=e.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),n=e.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),r=0,o=this.m_proxyBuffer.count,a=Wr(this.m_proxyBuffer.data,r,o,i,ro.CompareProxyTag),s=qr(this.m_proxyBuffer.data,r,o,n,ro.CompareTagProxy);return new oo(this,i,n,a,s)},r.UpdateAllParticleFlags=function(){this.m_allParticleFlags=0;for(var t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},r.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},r.AddContact=function(t,i){var n=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,o=At.SubVV(r[i],r[t],e.AddContact_s_d),a=At.DotVV(o,o);if(0<a&&a<this.m_squaredDiameter){var s=ut(a),c=this.m_contactBuffer.data[this.m_contactBuffer.Append()];c.indexA=t,c.indexB=i,c.flags=n[t]|n[i],c.weight=1-a*s*this.m_inverseDiameter,c.normal.x=s*o.x,c.normal.y=s*o.y}},r.FindContacts_Reference=function(){var t=0,i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var n=t,r=t;n<i;n++){for(var o=e.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,0),a=n+1;a<i&&!(o<this.m_proxyBuffer.data[a].tag);a++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[a].index,this.m_contactBuffer);for(var s=e.computeRelativeTag(this.m_proxyBuffer.data[n].tag,-1,1);r<i&&!(s<=this.m_proxyBuffer.data[r].tag);r++);for(var c=e.computeRelativeTag(this.m_proxyBuffer.data[n].tag,1,1),l=r;l<i&&!(c<this.m_proxyBuffer.data[l].tag);l++)this.AddContact(this.m_proxyBuffer.data[n].index,this.m_proxyBuffer.data[l].index,this.m_contactBuffer)}},r.FindContacts=function(t){this.FindContacts_Reference(t)},r.UpdateProxies_Reference=function(){for(var t=this.m_positionBuffer.data,i=this.m_inverseDiameter,n=0;n<this.m_proxyBuffer.count;++n){var r=this.m_proxyBuffer.data[n],o=t[r.index];r.tag=e.computeTag(i*o.x,i*o.y)}},r.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},r.SortProxies=function(){Gr(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,ro.CompareProxyProxy)},r.FilterContacts=function(){var e=this.GetParticleContactFilter();if(null!==e){var i=this,n=function(n){return 0!=(n.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!e.ShouldCollideParticleParticle(i,n.indexA,n.indexB)};this.m_contactBuffer.RemoveIf(n)}},r.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},r.NotifyContactListenerPostContact=function(){var t=this.GetParticleContactListener();if(null!==t){for(var e=0;e<this.m_contactBuffer.count;++e){var i=this.m_contactBuffer.data[e];t.BeginContactParticleParticle(this,i)}throw new Error}},e.b2ParticleContactIsZombie=function(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle},r.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var i=new ho;this.NotifyContactListenerPreContact(i),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(i),t&&this.m_contactBuffer.RemoveIf(e.b2ParticleContactIsZombie)},r.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},r.NotifyBodyContactListenerPostContact=function(){var t=this.GetFixtureContactListener();if(null!==t){for(var e=0;e<this.m_bodyContactBuffer.count;e++){var i=this.m_bodyContactBuffer.data[e];t.BeginContactFixtureParticle(this,i)}throw new Error}},r.UpdateBodyContacts=function(){var t=e.UpdateBodyContacts_s_aabb,i=new lo;if(this.NotifyBodyContactListenerPreContact(i),this.m_stuckThreshold>0)for(var n=this.GetParticleCount(),r=0;r<n;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var o=t;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new go(this));var a=this.UpdateBodyContacts_callback;a.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(a,o),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(i)},r.Solve=function(i){var n=e.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(i),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<i.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var r=n.Copy(i);r.dt/=i.particleIterations,r.inv_dt*=i.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(r),this.SolvePressure(r),this.SolveDamping(r),this.m_allParticleFlags&e.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(r),this.LimitVelocity(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(r),this.SolveCollision(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(r.dt,this.m_velocityBuffer.data[o])}},r.SolveCollision=function(t){var i=e.SolveCollision_s_aabb,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=i;a.lowerBound.x=+n,a.lowerBound.y=+n,a.upperBound.x=-n,a.upperBound.y=-n;for(var s=0;s<this.m_count;s++){var c=o[s],l=r[s],u=l.x+t.dt*c.x,h=l.y+t.dt*c.y;a.lowerBound.x=it(a.lowerBound.x,it(l.x,u)),a.lowerBound.y=it(a.lowerBound.y,it(l.y,h)),a.upperBound.x=rt(a.upperBound.x,rt(l.x,u)),a.upperBound.y=rt(a.upperBound.y,rt(l.y,h))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new yo(this,t));var _=this.SolveCollision_callback;_.m_step=t,this.m_world.QueryAABB(_,a)},r.LimitVelocity=function(t){for(var e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t),n=0;n<this.m_count;n++){var r=e[n],o=At.DotVV(r,r);o>i&&r.SelfMul(ht(i/o))}},r.SolveGravity=function(t){for(var i=e.SolveGravity_s_gravity,n=this.m_velocityBuffer.data,r=At.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),i),o=0;o<this.m_count;o++)n[o].SelfAdd(r)},r.SolveBarrier=function(i){for(var n=e.SolveBarrier_s_aabb,r=e.SolveBarrier_s_va,o=e.SolveBarrier_s_vb,a=e.SolveBarrier_s_pba,s=e.SolveBarrier_s_vba,c=e.SolveBarrier_s_vc,l=e.SolveBarrier_s_pca,u=e.SolveBarrier_s_vca,h=e.SolveBarrier_s_qba,_=e.SolveBarrier_s_qca,f=e.SolveBarrier_s_dv,p=e.SolveBarrier_s_f,d=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,v=0;v<this.m_count;v++)0!=(this.m_flagsBuffer.data[v]&e.k_barrierWallFlags)&&m[v].SetZero();for(var g=B*i.dt,y=this.GetParticleMass(),x=0;x<this.m_pairBuffer.count;x++){var S=this.m_pairBuffer.data[x];if(S.flags&t.b2ParticleFlag.b2_barrierParticle){var b=S.indexA,C=S.indexB,A=d[b],T=d[C],w=n;At.MinV(A,T,w.lowerBound),At.MaxV(A,T,w.upperBound);for(var E=this.m_groupBuffer[b],P=this.m_groupBuffer[C],I=this.GetLinearVelocity(E,b,A,r),R=this.GetLinearVelocity(P,C,T,o),D=At.SubVV(T,A,a),M=At.SubVV(R,I,s),O=this.GetInsideBoundsEnumerator(w),N=void 0;(N=O.GetNext())>=0;){var L=d[N],F=this.m_groupBuffer[N];if(E!==F&&P!==F){var z=this.GetLinearVelocity(F,N,L,c),V=At.SubVV(L,A,l),k=At.SubVV(z,I,u),U=At.CrossVV(M,k),G=At.CrossVV(D,k)-At.CrossVV(V,M),H=At.CrossVV(D,V),j=void 0,W=void 0,q=h,X=_;if(0===U){if(0===G)continue;if(!((W=-H/G)>=0&&W<g))continue;if(At.AddVMulSV(D,W,M,q),At.AddVMulSV(V,W,k,X),!((j=At.DotVV(q,X)/At.DotVV(q,q))>=0&&j<=1))continue}else{var Y=G*G-4*H*U;if(Y<0)continue;var K=ht(Y),J=(-G-K)/(2*U),Q=(-G+K)/(2*U);if(J>Q){var Z=J;J=Q,Q=Z}if(W=J,At.AddVMulSV(D,W,M,q),At.AddVMulSV(V,W,k,X),j=At.DotVV(q,X)/At.DotVV(q,q),!(W>=0&&W<g&&j>=0&&j<=1)){if(!((W=Q)>=0&&W<g))continue;if(At.AddVMulSV(D,W,M,q),At.AddVMulSV(V,W,k,X),!((j=At.DotVV(q,X)/At.DotVV(q,q))>=0&&j<=1))continue}}var $=f;$.x=I.x+j*M.x-z.x,$.y=I.y+j*M.y-z.y;var tt=At.MulSV(y,$,p);if(F&&this.IsRigidGroup(F)){var et=F.GetMass(),it=F.GetInertia();et>0&&F.m_linearVelocity.SelfMulAdd(1/et,tt),it>0&&(F.m_angularVelocity+=At.CrossVV(At.SubVV(L,F.GetCenter(),At.s_t0),tt)/it)}else m[N].SelfAdd($);this.ParticleApplyForce(N,tt.SelfMul(-i.inv_dt))}}}}},r.SolveStaticPressure=function(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var i=this.GetCriticalPressure(e),n=this.m_def.staticPressureStrength*i,r=I*i,o=this.m_def.staticPressureRelaxation,a=0;a<this.m_def.staticPressureIterations;a++){for(var s=0;s<this.m_count;s++)this.m_accumulationBuffer[s]=0;for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_staticPressureParticle){var u=l.indexA,h=l.indexB,_=l.weight;this.m_accumulationBuffer[u]+=_*this.m_staticPressureBuffer[h],this.m_accumulationBuffer[h]+=_*this.m_staticPressureBuffer[u]}}for(var f=0;f<this.m_count;f++){var p=this.m_weightBuffer[f];if(this.m_flagsBuffer.data[f]&t.b2ParticleFlag.b2_staticPressureParticle){var d=(this.m_accumulationBuffer[f]+n*(p-P))/(p+o);this.m_staticPressureBuffer[f]=ot(d,0,r)}else this.m_staticPressureBuffer[f]=0}}},r.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(var e=0;e<this.m_bodyContactBuffer.count;e++){var i=this.m_bodyContactBuffer.data[e],n=i.index,r=i.weight;this.m_weightBuffer[n]+=r}for(var o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB,l=a.weight;this.m_weightBuffer[s]+=l,this.m_weightBuffer[c]+=l}},r.SolvePressure=function(i){for(var n=e.SolvePressure_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.GetCriticalPressure(i),s=this.m_def.pressureStrength*a,c=I*a,l=0;l<this.m_count;l++){var u=s*rt(0,this.m_weightBuffer[l]-P);this.m_accumulationBuffer[l]=it(u,c)}if(this.m_allParticleFlags&e.k_noPressureFlags)for(var h=0;h<this.m_count;h++)this.m_flagsBuffer.data[h]&e.k_noPressureFlags&&(this.m_accumulationBuffer[h]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(var _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var f=i.dt/(this.m_def.density*this.m_particleDiameter),p=this.GetParticleInvMass(),d=0;d<this.m_bodyContactBuffer.count;d++){var m=this.m_bodyContactBuffer.data[d],v=m.index,g=m.body,y=m.weight,x=m.mass,S=m.normal,b=r[v],C=this.m_accumulationBuffer[v]+s*y,A=At.MulSV(f*y*x*C,S,n);o[v].SelfMulSub(p,A),g.ApplyLinearImpulse(A,b,!0)}for(var T=0;T<this.m_contactBuffer.count;T++){var w=this.m_contactBuffer.data[T],E=w.indexA,R=w.indexB,D=w.weight,M=w.normal,O=this.m_accumulationBuffer[E]+this.m_accumulationBuffer[R],B=At.MulSV(f*D*O,M,n);o[E].SelfSub(B),o[R].SelfAdd(B)}},r.SolveDamping=function(t){for(var i=e.SolveDamping_s_v,n=e.SolveDamping_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.dampingStrength,s=1/this.GetCriticalVelocity(t),c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index,_=u.body,f=u.weight,p=u.mass,d=u.normal,m=r[h],v=At.SubVV(_.GetLinearVelocityFromWorldPoint(m,At.s_t0),o[h],i),g=At.DotVV(v,d);if(g<0){var y=rt(a*f,it(-s*g,.5)),x=At.MulSV(y*p*g,d,n);o[h].SelfMulAdd(c,x),_.ApplyLinearImpulse(x.SelfNeg(),m,!0)}}for(var S=0;S<this.m_contactBuffer.count;S++){var b=this.m_contactBuffer.data[S],C=b.indexA,A=b.indexB,T=b.weight,w=b.normal,E=At.SubVV(o[A],o[C],i),P=At.DotVV(E,w);if(P<0){var I=rt(a*T,it(-s*P,.5)),R=At.MulSV(I*P,w,n);o[C].SelfAdd(R),o[A].SelfSub(R)}}},r.SolveRigidDamping=function(){for(var t=e.SolveRigidDamping_s_t0,i=e.SolveRigidDamping_s_t1,n=e.SolveRigidDamping_s_p,r=e.SolveRigidDamping_s_v,o=[0],a=[0],s=[0],c=[0],l=[0],u=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength,f=0;f<this.m_bodyContactBuffer.count;f++){var p=this.m_bodyContactBuffer.data[f],d=p.index,m=this.m_groupBuffer[d];if(m&&this.IsRigidGroup(m)){var v=p.body,g=p.normal,y=p.weight,x=h[d],S=At.SubVV(v.GetLinearVelocityFromWorldPoint(x,t),m.GetLinearVelocityFromWorldPoint(x,i),r),b=At.DotVV(S,g);if(b<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,!0,m,d,x,g),this.InitDampingParameter(c,l,u,v.GetMass(),v.GetInertia()-v.GetMass()*v.GetLocalCenter().LengthSquared(),v.GetWorldCenter(),x,g);var C=_*it(y,1)*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],b);this.ApplyDamping(o[0],a[0],s[0],!0,m,d,C,g),v.ApplyLinearImpulse(At.MulSV(-C,g,At.s_t0),x,!0)}}}for(var A=0;A<this.m_contactBuffer.count;A++){var T=this.m_contactBuffer.data[A],w=T.indexA,E=T.indexB,P=T.normal,I=T.weight,R=this.m_groupBuffer[w],D=this.m_groupBuffer[E],M=this.IsRigidGroup(R),O=this.IsRigidGroup(D);if(R!==D&&(M||O)){var B=At.MidVV(h[w],h[E],n),N=At.SubVV(this.GetLinearVelocity(D,E,B,t),this.GetLinearVelocity(R,w,B,i),r),L=At.DotVV(N,P);if(L<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,M,R,w,B,P),this.InitDampingParameterWithRigidGroupOrParticle(c,l,u,O,D,E,B,P);var F=_*I*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],L);this.ApplyDamping(o[0],a[0],s[0],M,R,w,F,P),this.ApplyDamping(c[0],l[0],u[0],O,D,E,-F,P)}}}},r.SolveExtraDamping=function(){for(var t=e.SolveExtraDamping_s_v,i=e.SolveExtraDamping_s_f,n=this.m_velocityBuffer.data,r=this.m_positionBuffer.data,o=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var s=this.m_bodyContactBuffer.data[a],c=s.index;if(this.m_flagsBuffer.data[c]&e.k_extraDampingFlags){var l=s.body,u=s.mass,h=s.normal,_=r[c],f=At.SubVV(l.GetLinearVelocityFromWorldPoint(_,At.s_t0),n[c],t),p=At.DotVV(f,h);if(p<0){var d=At.MulSV(.5*u*p,h,i);n[c].SelfMulAdd(o,d),l.ApplyLinearImpulse(d.SelfNeg(),_,!0)}}}},r.SolveWall=function(){for(var e=this.m_velocityBuffer.data,i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&t.b2ParticleFlag.b2_wallParticle&&e[i].SetZero()},r.SolveRigid=function(i){for(var n=e.SolveRigid_s_position,r=e.SolveRigid_s_rotation,o=e.SolveRigid_s_transform,a=e.SolveRigid_s_velocityTransform,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();var u=r;u.SetAngle(i.dt*l.m_angularVelocity);var h=At.AddVV(l.m_center,At.SubVV(At.MulSV(i.dt,l.m_linearVelocity,At.s_t0),It.MulRV(u,l.m_center,At.s_t1),At.s_t0),n),_=o;_.SetPositionRotation(h,u),Rt.MulXX(_,l.m_transform,l.m_transform);var f=a;f.p.x=i.inv_dt*_.p.x,f.p.y=i.inv_dt*_.p.y,f.q.s=i.inv_dt*_.q.s,f.q.c=i.inv_dt*(_.q.c-1);for(var p=l.m_firstIndex;p<l.m_lastIndex;p++)Rt.MulXV(f,s[p],c[p])}},r.SolveElastic=function(i){for(var n=e.SolveElastic_s_pa,r=e.SolveElastic_s_pb,o=e.SolveElastic_s_pc,a=e.SolveElastic_s_r,s=e.SolveElastic_s_t0,c=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,u=i.inv_dt*this.m_def.elasticStrength,h=0;h<this.m_triadBuffer.count;h++){var _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){var f=_.indexA,p=_.indexB,d=_.indexC,m=_.pa,v=_.pb,g=_.pc,y=n.Copy(c[f]),x=r.Copy(c[p]),S=o.Copy(c[d]),b=l[f],C=l[p],A=l[d];y.SelfMulAdd(i.dt,b),x.SelfMulAdd(i.dt,C),S.SelfMulAdd(i.dt,A);var T=(y.x+x.x+S.x)/3,w=(y.y+x.y+S.y)/3;y.x-=T,y.y-=w,x.x-=T,x.y-=w,S.x-=T,S.y-=w;var E=a;E.s=At.CrossVV(m,y)+At.CrossVV(v,x)+At.CrossVV(g,S),E.c=At.DotVV(m,y)+At.DotVV(v,x)+At.DotVV(g,S);var P=ut(E.s*E.s+E.c*E.c);isFinite(P)||(P=198177537e11),E.s*=P,E.c*=P;var I=u*_.strength;It.MulRV(E,m,s),At.SubVV(s,y,s),At.MulSV(I,s,s),b.SelfAdd(s),It.MulRV(E,v,s),At.SubVV(s,x,s),At.MulSV(I,s,s),C.SelfAdd(s),It.MulRV(E,g,s),At.SubVV(s,S,s),At.MulSV(I,s,s),A.SelfAdd(s)}}},r.SolveSpring=function(i){for(var n=e.SolveSpring_s_pa,r=e.SolveSpring_s_pb,o=e.SolveSpring_s_d,a=e.SolveSpring_s_f,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=i.inv_dt*this.m_def.springStrength,u=0;u<this.m_pairBuffer.count;u++){var h=this.m_pairBuffer.data[u];if(h.flags&t.b2ParticleFlag.b2_springParticle){var _=h.indexA,f=h.indexB,p=n.Copy(s[_]),d=r.Copy(s[f]),m=c[_],v=c[f];p.SelfMulAdd(i.dt,m),d.SelfMulAdd(i.dt,v);var g=At.SubVV(d,p,o),y=h.distance,x=g.Length(),S=l*h.strength,b=At.MulSV(S*(y-x)/x,g,a);m.SelfSub(b),v.SelfAdd(b)}}},r.SolveTensile=function(i){for(var n=e.SolveTensile_s_weightedNormal,r=e.SolveTensile_s_s,o=e.SolveTensile_s_f,a=this.m_velocityBuffer.data,s=0;s<this.m_count;s++)this.m_accumulation2Buffer[s]=new At,this.m_accumulation2Buffer[s].SetZero();for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_tensileParticle){var u=l.indexA,h=l.indexB,_=l.weight,f=l.normal,p=At.MulSV((1-_)*_,f,n);this.m_accumulation2Buffer[u].SelfSub(p),this.m_accumulation2Buffer[h].SelfAdd(p)}}for(var d=this.GetCriticalVelocity(i),m=this.m_def.surfaceTensionPressureStrength*d,v=this.m_def.surfaceTensionNormalStrength*d,g=R*d,y=0;y<this.m_contactBuffer.count;y++){var x=this.m_contactBuffer.data[y];if(x.flags&t.b2ParticleFlag.b2_tensileParticle){var S=x.indexA,b=x.indexB,C=x.weight,A=x.normal,T=this.m_weightBuffer[S]+this.m_weightBuffer[b],w=At.SubVV(this.m_accumulation2Buffer[b],this.m_accumulation2Buffer[S],r),E=it(m*(T-2)+v*At.DotVV(w,A),g)*C,P=At.MulSV(E,A,o);a[S].SelfSub(P),a[b].SelfAdd(P)}}},r.SolveViscous=function(){for(var i=e.SolveViscous_s_v,n=e.SolveViscous_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.viscousStrength,s=this.GetParticleInvMass(),c=0;c<this.m_bodyContactBuffer.count;c++){var l=this.m_bodyContactBuffer.data[c],u=l.index;if(this.m_flagsBuffer.data[u]&t.b2ParticleFlag.b2_viscousParticle){var h=l.body,_=l.weight,f=l.mass,p=r[u],d=At.SubVV(h.GetLinearVelocityFromWorldPoint(p,At.s_t0),o[u],i),m=At.MulSV(a*f*_,d,n);o[u].SelfMulAdd(s,m),h.ApplyLinearImpulse(m.SelfNeg(),p,!0)}}for(var v=0;v<this.m_contactBuffer.count;v++){var g=this.m_contactBuffer.data[v];if(g.flags&t.b2ParticleFlag.b2_viscousParticle){var y=g.indexA,x=g.indexB,S=g.weight,b=At.SubVV(o[x],o[y],i),C=At.MulSV(a*S,b,n);o[y].SelfAdd(C),o[x].SelfSub(C)}}},r.SolveRepulsive=function(i){for(var n=e.SolveRepulsive_s_f,r=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(i),a=0;a<this.m_contactBuffer.count;a++){var s=this.m_contactBuffer.data[a];if(s.flags&t.b2ParticleFlag.b2_repulsiveParticle){var c=s.indexA,l=s.indexB;if(this.m_groupBuffer[c]!==this.m_groupBuffer[l]){var u=s.weight,h=s.normal,_=At.MulSV(o*u,h,n);r[c].SelfSub(_),r[l].SelfAdd(_)}}}},r.SolvePowder=function(i){for(var n=e.SolvePowder_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.powderStrength*this.GetCriticalVelocity(i),s=1-E,c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index;if(this.m_flagsBuffer.data[h]&t.b2ParticleFlag.b2_powderParticle){var _=u.weight;if(_>s){var f=u.body,p=u.mass,d=r[h],m=u.normal,v=At.MulSV(a*p*(_-s),m,n);o[h].SelfMulSub(c,v),f.ApplyLinearImpulse(v,d,!0)}}}for(var g=0;g<this.m_contactBuffer.count;g++){var y=this.m_contactBuffer.data[g];if(y.flags&t.b2ParticleFlag.b2_powderParticle){var x=y.weight;if(x>s){var S=y.indexA,b=y.indexB,C=y.normal,A=At.MulSV(a*(x-s),C,n);o[S].SelfSub(A),o[b].SelfAdd(A)}}}},r.SolveSolid=function(t){var i=e.SolveSolid_s_f,n=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var r=t.inv_dt*this.m_def.ejectionStrength,o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB;if(this.m_groupBuffer[s]!==this.m_groupBuffer[c]){var l=a.weight,u=a.normal,h=this.m_depthBuffer[s]+this.m_depthBuffer[c],_=At.MulSV(r*h*l,u,i);n[s].SelfSub(_),n[c].SelfAdd(_)}}},r.SolveForce=function(t){for(var e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass(),n=0;n<this.m_count;n++)e[n].SelfMulAdd(i,this.m_forceBuffer[n]);this.m_hasForce=!1},r.SolveColorMixing=function(){var e=.5*this.m_def.colorMixingStrength;if(e)for(var i=0;i<this.m_contactBuffer.count;i++){var n=this.m_contactBuffer.data[i],r=n.indexA,o=n.indexB;if(this.m_flagsBuffer.data[r]&this.m_flagsBuffer.data[o]&t.b2ParticleFlag.b2_colorMixingParticle){var a=this.m_colorBuffer.data[r],s=this.m_colorBuffer.data[o];Ot.MixColors(a,s,e)}}},r.SolveZombie=function(){for(var e=0,i=[],n=0;n<this.m_count;n++)i[n]=T;for(var r=0,o=0;o<this.m_count;o++){var a=this.m_flagsBuffer.data[o];if(a&t.b2ParticleFlag.b2_zombieParticle){var s=this.m_world.m_destructionListener;if(a&t.b2ParticleFlag.b2_destructionListenerParticle&&s&&s.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){var c=this.m_handleIndexBuffer.data[o];c&&(c.SetIndex(T),this.m_handleIndexBuffer.data[o]=null)}i[o]=T}else{if(i[o]=e,o!==e){if(this.m_handleIndexBuffer.data){var l=this.m_handleIndexBuffer.data[o];l&&l.SetIndex(e),this.m_handleIndexBuffer.data[e]=l}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[e]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[o])}e++,r|=a}}for(var u={IsProxyInvalid:function(t){return t.index<0},IsContactInvalid:function(t){return t.indexA<0||t.indexB<0},IsBodyContactInvalid:function(t){return t.index<0},IsPairInvalid:function(t){return t.indexA<0||t.indexB<0},IsTriadInvalid:function(t){return t.indexA<0||t.indexB<0||t.indexC<0}},h=0;h<this.m_proxyBuffer.count;h++){var _=this.m_proxyBuffer.data[h];_.index=i[_.index]}this.m_proxyBuffer.RemoveIf(u.IsProxyInvalid);for(var f=0;f<this.m_contactBuffer.count;f++){var p=this.m_contactBuffer.data[f];p.indexA=i[p.indexA],p.indexB=i[p.indexB]}this.m_contactBuffer.RemoveIf(u.IsContactInvalid);for(var d=0;d<this.m_bodyContactBuffer.count;d++){var m=this.m_bodyContactBuffer.data[d];m.index=i[m.index]}this.m_bodyContactBuffer.RemoveIf(u.IsBodyContactInvalid);for(var v=0;v<this.m_pairBuffer.count;v++){var g=this.m_pairBuffer.data[v];g.indexA=i[g.indexA],g.indexB=i[g.indexB]}this.m_pairBuffer.RemoveIf(u.IsPairInvalid);for(var y=0;y<this.m_triadBuffer.count;y++){var x=this.m_triadBuffer.data[y];x.indexA=i[x.indexA],x.indexB=i[x.indexB],x.indexC=i[x.indexC]}if(this.m_triadBuffer.RemoveIf(u.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var S=0,b=0;b<this.m_count;b++){var C=i[this.m_indexByExpirationTimeBuffer.data[b]];C!==T&&(this.m_indexByExpirationTimeBuffer.data[S++]=C)}for(var A=this.m_groupList;A;A=A.GetNext()){for(var w=e,E=0,P=!1,I=A.m_firstIndex;I<A.m_lastIndex;I++){var R=i[I];R>=0?(w=it(w,R),E=rt(E,R+1)):P=!0}w<E?(A.m_firstIndex=w,A.m_lastIndex=E,P&&A.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(A,A.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(A.m_firstIndex=0,A.m_lastIndex=0,A.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(A,A.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=r,this.m_needsUpdateAllParticleFlags=!1;for(var D=this.m_groupList;D;){var M=D.GetNext();D.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(D),D=M}},r.SolveLifetimes=function(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(Gr(n,0,r,(function(t,e){var n=i[t],r=i[e],o=n<=0;return o===r<=0?n>r:o})),this.m_expirationTimeBufferRequiresSorting=!1);for(var o=r-1;o>=0;--o){var a=n[o],s=i[a];if(e<s||s<=0)break;this.DestroyParticle(a)}},r.RotateBuffer=function(t,e,i){if(t!==e&&e!==i){if(Xr(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&Xr(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&Xr(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&Xr(this.m_consecutiveContactStepsBuffer.data,t,e,i),Xr(this.m_positionBuffer.data,t,e,i),Xr(this.m_velocityBuffer.data,t,e,i),Xr(this.m_groupBuffer,t,e,i),this.m_hasForce&&Xr(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&Xr(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&Xr(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&Xr(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&Xr(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){Xr(this.m_handleIndexBuffer.data,t,e,i);for(var n=t;n<i;++n){var r=this.m_handleIndexBuffer.data[n];r&&r.SetIndex(y(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Xr(this.m_expirationTimeBuffer.data,t,e,i);for(var o=this.GetParticleCount(),a=this.m_indexByExpirationTimeBuffer.data,s=0;s<o;++s)a[s]=y(a[s])}for(var c=0;c<this.m_proxyBuffer.count;c++){var l=this.m_proxyBuffer.data[c];l.index=y(l.index)}for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];h.indexA=y(h.indexA),h.indexB=y(h.indexB)}for(var _=0;_<this.m_bodyContactBuffer.count;_++){var f=this.m_bodyContactBuffer.data[_];f.index=y(f.index)}for(var p=0;p<this.m_pairBuffer.count;p++){var d=this.m_pairBuffer.data[p];d.indexA=y(d.indexA),d.indexB=y(d.indexB)}for(var m=0;m<this.m_triadBuffer.count;m++){var v=this.m_triadBuffer.data[m];v.indexA=y(v.indexA),v.indexB=y(v.indexB),v.indexC=y(v.indexC)}for(var g=this.m_groupList;g;g=g.GetNext())g.m_firstIndex=y(g.m_firstIndex),g.m_lastIndex=y(g.m_lastIndex-1)+1}function y(n){return n<t?n:n<e?n+i-e:n<i?n+t-e:n}},r.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},r.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},r.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},r.GetParticleStride=function(){return E*this.m_particleDiameter},r.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},r.GetParticleInvMass=function(){var t=this.m_inverseDiameter*(1/E);return this.m_inverseDensity*t*t},r.GetFixtureContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetParticleContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetFixtureContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.GetParticleContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.SetUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},r.SetGroupFlags=function(e,i){var n=e.m_groupFlags;(n^i)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),n&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),e.m_groupFlags=i},e.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},r.RemoveSpuriousBodyContacts=function(){Gr(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,e.BodyContactCompare);var t=e.RemoveSpuriousBodyContacts_s_n,i=e.RemoveSpuriousBodyContacts_s_pos,n=e.RemoveSpuriousBodyContacts_s_normal,r=3,o=this,a=-1,s=0,c=function(e){if(e.index!==a&&(s=0,a=e.index),s++>r)return!0;var c=t.Copy(e.normal);c.SelfMul(o.m_particleDiameter*(1-e.weight));var l=At.AddVV(o.m_positionBuffer.data[e.index],c,i);if(!e.fixture.TestPoint(l)){for(var u=e.fixture.GetShape().GetChildCount(),_=0;_<u;_++){var f=n;if(e.fixture.ComputeDistance(l,f,_)<h)return!1}return!0}return!1};this.m_bodyContactBuffer.count=jr(this.m_bodyContactBuffer.data,c,this.m_bodyContactBuffer.count)},r.DetectStuckParticle=function(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)},r.ValidateParticleIndex=function(t){return t>=0&&t<this.GetParticleCount()&&t!==T},r.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},r.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},r.ForceCanBeApplied=function(e){return!(e&t.b2ParticleFlag.b2_wallParticle)},r.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},r.IsRigidGroup=function(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.GetLinearVelocity=function(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])},r.InitDampingParameter=function(t,e,i,n,r,o,a,s){t[0]=n>0?1/n:0,e[0]=r>0?1/r:0,i[0]=At.CrossVV(At.SubVV(a,o,At.s_t0),s)},r.InitDampingParameterWithRigidGroupOrParticle=function(e,i,n,r,o,a,s,c){if(o&&r)this.InitDampingParameter(e,i,n,o.GetMass(),o.GetInertia(),o.GetCenter(),s,c);else{var l=this.m_flagsBuffer.data[a];this.InitDampingParameter(e,i,n,l&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,s,s,c)}},r.ComputeDampingImpulse=function(t,e,i,n,r,o,a){var s=t+e*i*i+n+r*o*o;return s>0?a/s:0},r.ApplyDamping=function(t,e,i,n,r,o,a,s){r&&n?(r.m_linearVelocity.SelfMulAdd(a*t,s),r.m_angularVelocity+=a*i*e):this.m_velocityBuffer.data[o].SelfMulAdd(a*t,s)},e}();io.xTruncBits=12,io.yTruncBits=12,io.tagBits=32,io.yOffset=1<<io.yTruncBits-1,io.yShift=io.tagBits-io.yTruncBits,io.xShift=io.tagBits-io.yTruncBits-io.xTruncBits,io.xScale=1<<io.xShift,io.xOffset=io.xScale*(1<<io.xTruncBits-1),io.yMask=(1<<io.yTruncBits)-1<<io.yShift,io.xMask=~io.yMask,io.DestroyParticlesInShape_s_aabb=new Te,io.CreateParticleGroup_s_transform=new Rt,io.ComputeCollisionEnergy_s_v=new At,io.QueryShapeAABB_s_aabb=new Te,io.QueryPointAABB_s_aabb=new Te,io.RayCast_s_aabb=new Te,io.RayCast_s_p=new At,io.RayCast_s_v=new At,io.RayCast_s_n=new At,io.RayCast_s_point=new At,io.k_pairFlags=t.b2ParticleFlag.b2_springParticle,io.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,io.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,io.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,io.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,io.CreateParticlesStrokeShapeForGroup_s_edge=new un,io.CreateParticlesStrokeShapeForGroup_s_d=new At,io.CreateParticlesStrokeShapeForGroup_s_p=new At,io.CreateParticlesFillShapeForGroup_s_aabb=new Te,io.CreateParticlesFillShapeForGroup_s_p=new At,io.UpdatePairsAndTriads_s_dab=new At,io.UpdatePairsAndTriads_s_dbc=new At,io.UpdatePairsAndTriads_s_dca=new At,io.AddContact_s_d=new At,io.UpdateBodyContacts_s_aabb=new Te,io.Solve_s_subStep=new vr,io.SolveCollision_s_aabb=new Te,io.SolveGravity_s_gravity=new At,io.SolveBarrier_s_aabb=new Te,io.SolveBarrier_s_va=new At,io.SolveBarrier_s_vb=new At,io.SolveBarrier_s_pba=new At,io.SolveBarrier_s_vba=new At,io.SolveBarrier_s_vc=new At,io.SolveBarrier_s_pca=new At,io.SolveBarrier_s_vca=new At,io.SolveBarrier_s_qba=new At,io.SolveBarrier_s_qca=new At,io.SolveBarrier_s_dv=new At,io.SolveBarrier_s_f=new At,io.SolvePressure_s_f=new At,io.SolveDamping_s_v=new At,io.SolveDamping_s_f=new At,io.SolveRigidDamping_s_t0=new At,io.SolveRigidDamping_s_t1=new At,io.SolveRigidDamping_s_p=new At,io.SolveRigidDamping_s_v=new At,io.SolveExtraDamping_s_v=new At,io.SolveExtraDamping_s_f=new At,io.SolveRigid_s_position=new At,io.SolveRigid_s_rotation=new It,io.SolveRigid_s_transform=new Rt,io.SolveRigid_s_velocityTransform=new Rt,io.SolveElastic_s_pa=new At,io.SolveElastic_s_pb=new At,io.SolveElastic_s_pc=new At,io.SolveElastic_s_r=new It,io.SolveElastic_s_t0=new At,io.SolveSpring_s_pa=new At,io.SolveSpring_s_pb=new At,io.SolveSpring_s_d=new At,io.SolveSpring_s_f=new At,io.SolveTensile_s_weightedNormal=new At,io.SolveTensile_s_s=new At,io.SolveTensile_s_f=new At,io.SolveViscous_s_v=new At,io.SolveViscous_s_f=new At,io.SolveRepulsive_s_f=new At,io.SolvePowder_s_f=new At,io.SolveSolid_s_f=new At,io.RemoveSpuriousBodyContacts_s_n=new At,io.RemoveSpuriousBodyContacts_s_pos=new At,io.RemoveSpuriousBodyContacts_s_normal=new At;var no=function(){function t(){this._data=null,this.userSuppliedCapacity=0}return Q(t,[{key:"data",get:function(){return this._data},set:function(t){this._data=t}}]),t}(),ro=function(){function t(){this.index=T,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}(),oo=function(){function t(t,e,i,n,r){this.m_system=t,this.m_xLower=(e&io.xMask)>>>0,this.m_xUpper=(i&io.xMask)>>>0,this.m_yLower=(e&io.yMask)>>>0,this.m_yUpper=(i&io.yMask)>>>0,this.m_first=n,this.m_last=r}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&io.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T},t}(),ao=function(){this.next=null,this.count=0,this.index=0},so=function(){function t(){}var e=t.prototype;return e.Allocate=function(t,e){return e},e.Clear=function(){},e.GetCount=function(){return 0},e.Invalidate=function(){},e.GetValidBuffer=function(){return[]},e.GetBuffer=function(){return[]},e.SetCount=function(){},t}(),co=function(t,e){this.second=T,this.first=t,this.second=e},lo=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.Initialize=function(){},i.Find=function(){return T},e}(so),uo=function(t,e){this.first=T,this.second=T,this.first=t,this.second=e},ho=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.Initialize=function(){},i.Find=function(){return T},e}(so),_o=function(){function t(){}var e=t.prototype;return e.IsNecessary=function(){return!0},e.ShouldCreatePair=function(){return!0},e.ShouldCreateTriad=function(){return!0},t}(),fo=function(t){function e(e,i,n,r){var o;return(o=t.call(this)||this).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=e,o.m_shape=i,o.m_xf=n,o.m_callDestructionListener=r,o.m_destroyed=0,o}$(e,t);var i=e.prototype;return i.ReportFixture=function(){return!1},i.ReportParticle=function(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)},i.Destroyed=function(){return this.m_destroyed},e}(fr),po=function(t){function e(e){var i;return(i=t.call(this)||this).m_threshold=0,i.m_threshold=e,i}$(e,t);var i=e.prototype;return i.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},i.ShouldCreateTriad=function(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)},e}(_o),mo=function(e){function i(i,n){var r;return void 0===n&&(n=i.length),(r=e.call(this,t.b2ShapeType.e_unknown,0)||this).m_shapeCount=0,r.m_shapes=i,r.m_shapeCount=n,r}$(i,e);var r=i.prototype;return r.Clone=function(){throw new Error},r.GetChildCount=function(){return 1},r.TestPoint=function(t,e){for(var i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1},r.ComputeDistance=function(){return 0},r.RayCast=function(){return!1},r.ComputeAABB=function(t,e){var i=new Te;t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;for(var r=0;r<this.m_shapeCount;r++)for(var o=this.m_shapes[r].GetChildCount(),a=0;a<o;a++){var s=i;this.m_shapes[r].ComputeAABB(s,e,a),t.Combine1(s)}},r.ComputeMass=function(){},r.SetupDistanceProxy=function(){},r.ComputeSubmergedArea=function(){return 0},r.Dump=function(){},i}(sn),vo=function(e){function i(t){var i;return(i=e.call(this)||this).m_flagsBuffer=t,i}return $(i,e),i.prototype.IsNecessary=function(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)},i}(_o),go=function(e){function i(t,i){var n;return void 0===i&&(i=null),(n=e.call(this,t)||this).m_contactFilter=null,n.m_contactFilter=i,n}$(i,e);var n=i.prototype;return n.ShouldCollideFixtureParticle=function(e,i,n){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[n]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,n)},n.ReportFixtureAndParticle=function(e,n,r){var o=i.ReportFixtureAndParticle_s_n,a=i.ReportFixtureAndParticle_s_rp,s=this.m_system.m_positionBuffer.data[r],c=o,l=e.ComputeDistance(s,c,n);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,r)){var u=e.GetBody(),h=u.GetWorldCenter(),_=u.GetMass(),f=u.GetInertia()-_*u.GetLocalCenter().LengthSquared(),p=_>0?1/_:0,d=f>0?1/f:0,m=this.m_system.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),v=At.SubVV(s,h,a),g=At.CrossVV(v,c),y=m+p+d*g*g,x=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];x.index=r,x.body=u,x.fixture=e,x.weight=1-l*this.m_system.m_inverseDiameter,x.normal.Copy(c.SelfNeg()),x.mass=y>0?1/y:0,this.m_system.DetectStuckParticle(r)}},i}(Jr);go.ReportFixtureAndParticle_s_n=new At,go.ReportFixtureAndParticle_s_rp=new At;var yo=function(e){function i(t,i){var n;return(n=e.call(this,t)||this).m_step=i,n}$(i,e);var n=i.prototype;return n.ReportFixtureAndParticle=function(e,n,r){var o=i.ReportFixtureAndParticle_s_p1,a=i.ReportFixtureAndParticle_s_output,s=i.ReportFixtureAndParticle_s_input,c=i.ReportFixtureAndParticle_s_p,l=i.ReportFixtureAndParticle_s_v,u=i.ReportFixtureAndParticle_s_f,_=e.GetBody(),f=this.m_system.m_positionBuffer.data[r],p=this.m_system.m_velocityBuffer.data[r],d=a,m=s;if(0===this.m_system.m_iterationIndex){var v=Rt.MulTXV(_.m_xf0,f,o);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(v.SelfSub(_.GetLocalCenter()),It.MulRV(_.m_xf0.q,v,v),It.MulTRV(_.m_xf.q,v,v),v.SelfAdd(_.GetLocalCenter())),Rt.MulXV(_.m_xf,v,m.p1)}else m.p1.Copy(f);if(At.AddVMulSV(f,this.m_step.dt,p,m.p2),m.maxFraction=1,e.RayCast(d,m,n)){var g=d.normal,y=c;y.x=(1-d.fraction)*m.p1.x+d.fraction*m.p2.x+h*g.x,y.y=(1-d.fraction)*m.p1.y+d.fraction*m.p2.y+h*g.y;var x=l;x.x=this.m_step.inv_dt*(y.x-f.x),x.y=this.m_step.inv_dt*(y.y-f.y),this.m_system.m_velocityBuffer.data[r].Copy(x);var S=u;S.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.x-x.x),S.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.y-x.y),this.m_system.ParticleApplyForce(r,S)}},n.ReportParticle=function(){return!1},i}(Jr);yo.ReportFixtureAndParticle_s_p1=new At,yo.ReportFixtureAndParticle_s_output=new Ae,yo.ReportFixtureAndParticle_s_input=new Ce,yo.ReportFixtureAndParticle_s_p=new At,yo.ReportFixtureAndParticle_s_v=new At,yo.ReportFixtureAndParticle_s_f=new At;var xo=function(){function e(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new dr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new At,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new mr,this.m_island=new Ir,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}var i=e.prototype;return i.SetDestructionListener=function(t){this.m_destructionListener=t},i.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},i.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},i.SetDebugDraw=function(t){this.m_debugDraw=t},i.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new xn(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},i.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;for(var n=t.m_controllerList;n;){var r=n;n=n.nextController,r.controller.RemoveBody(t)}for(var o=t.m_contactList;o;){var a=o;o=o.next,this.m_contactManager.Destroy(a.contact)}t.m_contactList=null;for(var s=t.m_fixtureList;s;){var c=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(c),c.DestroyProxies(),c.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount},e._Joint_Create=function(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new wn(e);case t.b2JointType.e_mouseJoint:return new Ln(e);case t.b2JointType.e_prismaticJoint:return new zn(e);case t.b2JointType.e_revoluteJoint:return new Hn(e);case t.b2JointType.e_pulleyJoint:return new Un(e);case t.b2JointType.e_gearJoint:return new Mn(e);case t.b2JointType.e_wheelJoint:return new Kn(e);case t.b2JointType.e_weldJoint:return new Xn(e);case t.b2JointType.e_frictionJoint:return new Rn(e);case t.b2JointType.e_ropeJoint:return new Wn(e);case t.b2JointType.e_motorJoint:return new Bn(e);case t.b2JointType.e_areaJoint:return new Pn(e)}throw new Error},e._Joint_Destroy=function(){},i.CreateJoint=function(t){if(this.IsLocked())throw new Error;var i=e._Joint_Create(t);i.m_prev=null,i.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=i),this.m_jointList=i,++this.m_jointCount,i.m_edgeA.prev=null,i.m_edgeA.next=i.m_bodyA.m_jointList,i.m_bodyA.m_jointList&&(i.m_bodyA.m_jointList.prev=i.m_edgeA),i.m_bodyA.m_jointList=i.m_edgeA,i.m_edgeB.prev=null,i.m_edgeB.next=i.m_bodyB.m_jointList,i.m_bodyB.m_jointList&&(i.m_bodyB.m_jointList.prev=i.m_edgeB),i.m_bodyB.m_jointList=i.m_edgeB;var n=i.m_bodyA,r=i.m_bodyB;if(!i.m_collideConnected)for(var o=r.GetContactList();o;)o.other===n&&o.contact.FlagForFiltering(),o=o.next;return i},i.DestroyJoint=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,n=t.m_bodyB,r=t.m_collideConnected;if(i.SetAwake(!0),n.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===n.m_jointList&&(n.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),e._Joint_Destroy(t),--this.m_jointCount,!r)for(var o=n.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next},i.CreateParticleSystem=function(t){if(this.IsLocked())throw new Error;var e=new io(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e},i.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)},i.CalculateReasonableParticleIterations=function(t){if(null===this.m_particleSystemList)return 1;function e(t){for(var e=n,i=t.GetParticleSystemList();null!==i;i=i.m_next)e=it(e,i.GetRadius());return e}return Dr(this.m_gravity.Length(),e(this),t)},i.Step=function(t,i,n,r){void 0===r&&(r=this.CalculateReasonableParticleIterations(t));var o=e.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var a=e.Step_s_step;a.dt=t,a.velocityIterations=i,a.positionIterations=n,a.particleIterations=r,a.inv_dt=t>0?1/t:0,a.dtRatio=this.m_inv_dt0*t,a.warmStarting=this.m_warmStarting;var s=e.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=s.GetMilliseconds(),this.m_stepComplete&&a.dt>0){for(var c=e.Step_s_timer.Reset(),l=this.m_particleSystemList;l;l=l.m_next)l.Solve(a);this.Solve(a),this.m_profile.solve=c.GetMilliseconds()}if(this.m_continuousPhysics&&a.dt>0){var u=e.Step_s_timer.Reset();this.SolveTOI(a),this.m_profile.solveTOI=u.GetMilliseconds()}a.dt>0&&(this.m_inv_dt0=a.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()},i.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},i.DrawParticleSystem=function(t){if(null!==this.m_debugDraw){var e=t.GetParticleCount();if(e){var i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){var r=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,r,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}},i.DrawDebugData=function(){if(null!==this.m_debugDraw){var i=this.m_debugDraw.GetFlags(),n=e.DrawDebugData_s_color.SetRGB(0,0,0);if(i&t.b2DrawFlags.e_shapeBit)for(var r=this.m_bodyList;r;r=r.m_next){var o=r.m_xf;this.m_debugDraw.PushTransform(o);for(var a=r.GetFixtureList();a;a=a.m_next)r.IsActive()?r.GetType()===t.b2BodyType.b2_staticBody?(n.SetRGB(.5,.9,.5),this.DrawShape(a,n)):r.GetType()===t.b2BodyType.b2_kinematicBody?(n.SetRGB(.5,.5,.9),this.DrawShape(a,n)):r.IsAwake()?(n.SetRGB(.9,.7,.7),this.DrawShape(a,n)):(n.SetRGB(.6,.6,.6),this.DrawShape(a,n)):(n.SetRGB(.5,.5,.3),this.DrawShape(a,n));this.m_debugDraw.PopTransform(o)}if(i&t.b2DrawFlags.e_particleBit)for(var s=this.m_particleSystemList;s;s=s.m_next)this.DrawParticleSystem(s);if(i&t.b2DrawFlags.e_jointBit)for(var c=this.m_jointList;c;c=c.m_next)this.DrawJoint(c);if(i&t.b2DrawFlags.e_aabbBit){n.SetRGB(.9,.3,.9);for(var l=e.DrawDebugData_s_vs,u=this.m_bodyList;u;u=u.m_next)if(u.IsActive())for(var h=u.GetFixtureList();h;h=h.m_next)for(var _=0;_<h.m_proxyCount;++_){var f=h.m_proxies[_].treeNode.aabb;l[0].Set(f.lowerBound.x,f.lowerBound.y),l[1].Set(f.upperBound.x,f.lowerBound.y),l[2].Set(f.upperBound.x,f.upperBound.y),l[3].Set(f.lowerBound.x,f.upperBound.y),this.m_debugDraw.DrawPolygon(l,4,n)}}if(i&t.b2DrawFlags.e_centerOfMassBit)for(var p=this.m_bodyList;p;p=p.m_next){var d=e.DrawDebugData_s_xf;d.q.Copy(p.m_xf.q),d.p.Copy(p.GetWorldCenter()),this.m_debugDraw.DrawTransform(d)}if(i&t.b2DrawFlags.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw)}},i.QueryAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},i._QueryAABB=function(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(function(e){var n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof fr)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryAABB(t,e)},i.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(t,(function(t){return e.push(t),!0})),e},i.QueryPointAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},i._QueryPointAABB=function(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(e){var n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof fr)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)},i.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(t,(function(t){return e.push(t),!0})),e},i.QueryFixtureShape=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])},i._QueryFixtureShape=function(t,i,n,r,o){var a=e.QueryFixtureShape_s_aabb;if(i.ComputeAABB(a,r,n),this.m_contactManager.m_broadPhase.Query(a,(function(e){var a=e.userData,s=a.fixture;if(De(i,n,s.GetShape(),a.childIndex,r,s.GetBody().GetTransform())){if(t)return t.ReportFixture(s);if(o)return o(s)}return!0})),t instanceof fr)for(var s=this.m_particleSystemList;s;s=s.m_next)t.ShouldQueryParticleSystem(s)&&s.QueryAABB(t,a)},i.QueryAllFixtureShape=function(t,e,i,n){return void 0===n&&(n=[]),this.QueryFixtureShape(t,e,i,(function(t){return n.push(t),!0})),n},i.QueryFixturePoint=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},i._QueryFixturePoint=function(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(n){var r=n.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(i)return i(r)}return!0})),t)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)},i.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(t,(function(t){return e.push(t),!0})),e},i.RayCast=function(){(arguments.length<=0?void 0:arguments[0])instanceof pr?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])},i._RayCast=function(t,i,n,r){var o=e.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(i),o.p2.Copy(n),this.m_contactManager.m_broadPhase.RayCast(o,(function(o,a){var s=a.userData,c=s.fixture,l=s.childIndex,u=e.RayCast_s_output;if(c.RayCast(u,o,l)){var h=u.fraction,_=e.RayCast_s_point;if(_.Set((1-h)*i.x+h*n.x,(1-h)*i.y+h*n.y),t)return t.ReportFixture(c,_,u.normal,h);if(r)return r(c,_,u.normal,h)}return o.maxFraction})),t)for(var a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.RayCast(t,i,n)},i.RayCastOne=function(t,e){var i=null,n=1;return this.RayCast(t,e,(function(t,e,r,o){return o<n&&(n=o,i=t),n})),i},i.RayCastAll=function(t,e,i){return void 0===i&&(i=[]),this.RayCast(t,e,(function(t){return i.push(t),1})),i},i.GetBodyList=function(){return this.m_bodyList},i.GetJointList=function(){return this.m_jointList},i.GetParticleSystemList=function(){return this.m_particleSystemList},i.GetContactList=function(){return this.m_contactManager.m_contactList},i.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},i.GetAllowSleeping=function(){return this.m_allowSleep},i.SetWarmStarting=function(t){this.m_warmStarting=t},i.GetWarmStarting=function(){return this.m_warmStarting},i.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},i.GetContinuousPhysics=function(){return this.m_continuousPhysics},i.SetSubStepping=function(t){this.m_subStepping=t},i.GetSubStepping=function(){return this.m_subStepping},i.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},i.GetBodyCount=function(){return this.m_bodyCount},i.GetJointCount=function(){return this.m_jointCount},i.GetContactCount=function(){return this.m_contactManager.m_contactCount},i.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},i.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},i.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},i.SetGravity=function(t,e){if(void 0===e&&(e=!0),!At.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)},i.GetGravity=function(){return this.m_gravity},i.IsLocked=function(){return this.m_locked},i.SetAutoClearForces=function(t){this.m_clearForces=t},i.GetAutoClearForces=function(){return this.m_clearForces},i.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var i=this.m_jointList;i;i=i.m_next)i.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)},i.GetContactManager=function(){return this.m_contactManager},i.GetProfile=function(){return this.m_profile},i.Dump=function(e){if(!this.m_locked){e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");for(var i=0,n=this.m_bodyList;n;n=n.m_next)n.m_islandIndex=i,n.Dump(e),++i;i=0;for(var r=this.m_jointList;r;r=r.m_next)r.m_index=i,++i;for(var o=this.m_jointList;o;o=o.m_next)o.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),o.Dump(e),e("}\n"));for(var a=this.m_jointList;a;a=a.m_next)a.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),a.Dump(e),e("}\n"))}},i.DrawJoint=function(i){if(null!==this.m_debugDraw){var n=i.GetBodyA(),r=i.GetBodyB(),o=n.m_xf,a=r.m_xf,s=o.p,c=a.p,l=i.GetAnchorA(e.DrawJoint_s_p1),u=i.GetAnchorB(e.DrawJoint_s_p2),h=e.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(i.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,u,h);break;case t.b2JointType.e_pulleyJoint:var _=i,f=_.GetGroundAnchorA(),p=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(f,l,h),this.m_debugDraw.DrawSegment(p,u,h),this.m_debugDraw.DrawSegment(f,p,h);break;case t.b2JointType.e_mouseJoint:var d=e.DrawJoint_s_c;d.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,d),this.m_debugDraw.DrawPoint(u,4,d),d.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,u,d);break;default:this.m_debugDraw.DrawSegment(s,l,h),this.m_debugDraw.DrawSegment(l,u,h),this.m_debugDraw.DrawSegment(c,u,h)}}},i.DrawShape=function(i,n){if(null!==this.m_debugDraw){var r=i.GetShape();switch(r.m_type){case t.b2ShapeType.e_circleShape:var o=r,a=o.m_p,s=o.m_radius,c=At.UNITX;this.m_debugDraw.DrawSolidCircle(a,s,c,n);break;case t.b2ShapeType.e_edgeShape:var l=r,u=l.m_vertex1,h=l.m_vertex2;this.m_debugDraw.DrawSegment(u,h,n);break;case t.b2ShapeType.e_chainShape:var _=r,f=_.m_count,p=_.m_vertices,d=e.DrawShape_s_ghostColor.SetRGBA(.75*n.r,.75*n.g,.75*n.b,n.a),m=p[0];if(this.m_debugDraw.DrawPoint(m,4,n),_.m_hasPrevVertex){var v=_.m_prevVertex;this.m_debugDraw.DrawSegment(v,m,d),this.m_debugDraw.DrawCircle(v,.1,d)}for(var g=1;g<f;++g){var y=p[g];this.m_debugDraw.DrawSegment(m,y,n),this.m_debugDraw.DrawPoint(y,4,n),m=y}if(_.m_hasNextVertex){var x=_.m_nextVertex;this.m_debugDraw.DrawSegment(x,m,d),this.m_debugDraw.DrawCircle(x,.1,d)}break;case t.b2ShapeType.e_polygonShape:var S=r,b=S.m_count,C=S.m_vertices;this.m_debugDraw.DrawSolidPolygon(C,b,n)}}},i.Solve=function(e){for(var i=this.m_bodyList;i;i=i.m_next)i.m_xf0.Copy(i.m_xf);for(var n=this.m_controllerList;n;n=n.m_next)n.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var r=this.m_island;r.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_islandFlag=!1;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;for(var c=this.s_stack,l=this.m_bodyList;l;l=l.m_next)if(!l.m_islandFlag&&l.IsAwake()&&l.IsActive()&&l.GetType()!==t.b2BodyType.b2_staticBody){r.Clear();var u=0;for(c[u++]=l,l.m_islandFlag=!0;u>0;){var h=c[--u];if(!h)throw new Error;if(r.AddBody(h),h.m_awakeFlag=!0,h.GetType()!==t.b2BodyType.b2_staticBody){for(var _=h.m_contactList;_;_=_.next){var f=_.contact;if(!f.m_islandFlag&&f.IsEnabled()&&f.IsTouching()){var p=f.m_fixtureA.m_isSensor,d=f.m_fixtureB.m_isSensor;if(!p&&!d){r.AddContact(f),f.m_islandFlag=!0;var m=_.other;m.m_islandFlag||(c[u++]=m,m.m_islandFlag=!0)}}}for(var v=h.m_jointList;v;v=v.next)if(!v.joint.m_islandFlag){var g=v.other;g.IsActive()&&(r.AddJoint(v.joint),v.joint.m_islandFlag=!0,g.m_islandFlag||(c[u++]=g,g.m_islandFlag=!0))}}}var y=new mr;r.Solve(y,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=y.solveInit,this.m_profile.solveVelocity+=y.solveVelocity,this.m_profile.solvePosition+=y.solvePosition;for(var x=0;x<r.m_bodyCount;++x){var S=r.m_bodies[x];S.GetType()===t.b2BodyType.b2_staticBody&&(S.m_islandFlag=!1)}}for(var b=0;b<c.length&&c[b];++b)c[b]=null;for(var C=new Nt,A=this.m_bodyList;A;A=A.m_next)A.m_islandFlag&&A.GetType()!==t.b2BodyType.b2_staticBody&&A.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=C.GetMilliseconds()},i.SolveTOI=function(i){var n=this.m_island;if(n.Initialize(2*d,d,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1,o.m_sweep.alpha0=0;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_toiFlag=!1,a.m_islandFlag=!1,a.m_toiCount=0,a.m_toi=1}for(;;){for(var s=null,c=1,l=this.m_contactManager.m_contactList;l;l=l.m_next)if(l.IsEnabled()&&!(l.m_toiCount>p)){var u=1;if(l.m_toiFlag)u=l.m_toi;else{var h=l.GetFixtureA(),_=l.GetFixtureB();if(h.IsSensor()||_.IsSensor())continue;var f=h.GetBody(),m=_.GetBody(),v=f.m_type,g=m.m_type,y=f.IsAwake()&&v!==t.b2BodyType.b2_staticBody,x=m.IsAwake()&&g!==t.b2BodyType.b2_staticBody;if(!y&&!x)continue;var S=f.IsBullet()||v!==t.b2BodyType.b2_dynamicBody,b=m.IsBullet()||g!==t.b2BodyType.b2_dynamicBody;if(!S&&!b)continue;var C=f.m_sweep.alpha0;f.m_sweep.alpha0<m.m_sweep.alpha0?(C=m.m_sweep.alpha0,f.m_sweep.Advance(C)):m.m_sweep.alpha0<f.m_sweep.alpha0&&(C=f.m_sweep.alpha0,m.m_sweep.Advance(C));var A=l.GetChildIndexA(),T=l.GetChildIndexB(),w=e.SolveTOI_s_toi_input;w.proxyA.SetShape(h.GetShape(),A),w.proxyB.SetShape(_.GetShape(),T),w.sweepA.Copy(f.m_sweep),w.sweepB.Copy(m.m_sweep),w.tMax=1;var E=e.SolveTOI_s_toi_output;li(E,w);var P=E.t;u=E.state===t.b2TOIOutputState.e_touching?it(C+(1-C)*P,1):1,l.m_toi=u,l.m_toiFlag=!0}u<c&&(s=l,c=u)}if(null===s||1-10*r<c){this.m_stepComplete=!0;break}var I=s.GetFixtureA(),R=s.GetFixtureB(),D=I.GetBody(),M=R.GetBody(),O=e.SolveTOI_s_backup1.Copy(D.m_sweep),B=e.SolveTOI_s_backup2.Copy(M.m_sweep);if(D.Advance(c),M.Advance(c),s.Update(this.m_contactManager.m_contactListener),s.m_toiFlag=!1,++s.m_toiCount,s.IsEnabled()&&s.IsTouching()){D.SetAwake(!0),M.SetAwake(!0),n.Clear(),n.AddBody(D),n.AddBody(M),n.AddContact(s),D.m_islandFlag=!0,M.m_islandFlag=!0,s.m_islandFlag=!0;for(var N=0;N<2;++N){var L=0===N?D:M;if(L.m_type===t.b2BodyType.b2_dynamicBody)for(var F=L.m_contactList;F&&n.m_bodyCount!==n.m_bodyCapacity&&n.m_contactCount!==n.m_contactCapacity;F=F.next){var z=F.contact;if(!z.m_islandFlag){var V=F.other;if(V.m_type!==t.b2BodyType.b2_dynamicBody||L.IsBullet()||V.IsBullet()){var k=z.m_fixtureA.m_isSensor,U=z.m_fixtureB.m_isSensor;if(!k&&!U){var G=e.SolveTOI_s_backup.Copy(V.m_sweep);V.m_islandFlag||V.Advance(c),z.Update(this.m_contactManager.m_contactListener),z.IsEnabled()&&z.IsTouching()?(z.m_islandFlag=!0,n.AddContact(z),V.m_islandFlag||(V.m_islandFlag=!0,V.m_type!==t.b2BodyType.b2_staticBody&&V.SetAwake(!0),n.AddBody(V))):(V.m_sweep.Copy(G),V.SynchronizeTransform())}}}}}var H=e.SolveTOI_s_subStep;H.dt=(1-c)*i.dt,H.inv_dt=1/H.dt,H.dtRatio=1,H.positionIterations=20,H.velocityIterations=i.velocityIterations,H.particleIterations=i.particleIterations,H.warmStarting=!1,n.SolveTOI(H,D.m_islandIndex,M.m_islandIndex);for(var j=0;j<n.m_bodyCount;++j){var W=n.m_bodies[j];if(W.m_islandFlag=!1,W.m_type===t.b2BodyType.b2_dynamicBody){W.SynchronizeFixtures();for(var q=W.m_contactList;q;q=q.next)q.contact.m_toiFlag=!1,q.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else s.SetEnabled(!1),D.m_sweep.Copy(O),M.m_sweep.Copy(B),D.SynchronizeTransform(),M.SynchronizeTransform()}},i.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t},i.RemoveController=function(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t},e}();xo.Step_s_step=new vr,xo.Step_s_stepTimer=new Nt,xo.Step_s_timer=new Nt,xo.DrawDebugData_s_color=new Ot(0,0,0),xo.DrawDebugData_s_vs=At.MakeArray(4),xo.DrawDebugData_s_xf=new Rt,xo.QueryFixtureShape_s_aabb=new Te,xo.RayCast_s_input=new Ce,xo.RayCast_s_output=new Ae,xo.RayCast_s_point=new At,xo.DrawJoint_s_p1=new At,xo.DrawJoint_s_p2=new At,xo.DrawJoint_s_color=new Ot(.5,.8,.8),xo.DrawJoint_s_c=new Ot,xo.DrawShape_s_ghostColor=new Ot,xo.SolveTOI_s_subStep=new vr,xo.SolveTOI_s_backup=new Mt,xo.SolveTOI_s_backup1=new Mt,xo.SolveTOI_s_backup2=new Mt,xo.SolveTOI_s_toi_input=new Je,xo.SolveTOI_s_toi_output=new Ze;var So=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e},bo=function(){function t(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}var e=t.prototype;return e.GetNext=function(){return this.m_next},e.GetPrev=function(){return this.m_prev},e.GetBodyList=function(){return this.m_bodyList},e.AddBody=function(t){var e=new So(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount},e.RemoveBody=function(t){if(this.m_bodyCount<=0)throw new Error;for(var e=this.m_bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount},e.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},t}(),Co=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).normal=new At(0,1),e.offset=0,e.density=0,e.velocity=new At(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new At(0,0),e}$(e,t);var i=e.prototype;return i.Step=function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;if(e.IsAwake()){for(var i=new At,n=new At,o=0,a=0,s=e.GetFixtureList();s;s=s.m_next){var c=new At,l=s.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),c);o+=l,i.x+=l*c.x,i.y+=l*c.y;var u=0;a+=l*(u=this.useDensity?s.GetDensity():1),n.x+=l*c.x*u,n.y+=l*c.y*u}if(i.x/=o,i.y/=o,n.x/=a,n.y/=a,!(o<r)){var h=this.gravity.Clone().SelfNeg();h.SelfMul(this.density*o),e.ApplyForce(h,n);var _=e.GetLinearVelocityFromWorldPoint(i,new At);_.SelfSub(this.velocity),_.SelfMul(-this.linearDrag*o),e.ApplyForce(_,i),e.ApplyTorque(-e.GetInertia()/e.GetMass()*o*e.GetAngularVelocity()*this.angularDrag)}}}}},i.Draw=function(t){var e=100,i=new At,n=new At;i.x=this.normal.x*this.offset+this.normal.y*e,i.y=this.normal.y*this.offset-this.normal.x*e,n.x=this.normal.x*this.offset-this.normal.y*e,n.y=this.normal.y*this.offset+this.normal.x*e;var r=new Ot(0,0,.8);t.DrawSegment(i,n,r)},e}(bo),Ao=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).A=new At(0,0),e}$(e,t);var i=e.prototype;return i.Step=function(t){for(var i=At.MulSV(t.dt,this.A,e.Step_s_dtA),n=this.m_bodyList;n;n=n.nextBody){var r=n.body;r.IsAwake()&&r.SetLinearVelocity(At.AddVV(r.GetLinearVelocity(),i,At.s_t0))}},i.Draw=function(){},e}(bo);Ao.Step_s_dtA=new At;var To=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).F=new At(0,0),e}$(e,t);var i=e.prototype;return i.Step=function(){for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}},i.Draw=function(){},e}(bo),wo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).G=1,e.invSqr=!0,e}$(e,t);var i=e.prototype;return i.Step=function(){if(this.invSqr)for(var t=this.m_bodyList;t;t=t.nextBody)for(var i=t.body,n=i.GetWorldCenter(),o=i.GetMass(),a=this.m_bodyList;a&&a!==t;a=a.nextBody){var s=a.body,c=s.GetWorldCenter(),l=s.GetMass(),u=c.x-n.x,h=c.y-n.y,_=u*u+h*h;if(!(_<r)){var f=e.Step_s_f.Set(u,h);f.SelfMul(this.G/_/ht(_)*o*l),i.IsAwake()&&i.ApplyForce(f,n),s.IsAwake()&&s.ApplyForce(f.SelfMul(-1),c)}}else for(var p=this.m_bodyList;p;p=p.nextBody)for(var d=p.body,m=d.GetWorldCenter(),v=d.GetMass(),g=this.m_bodyList;g&&g!==p;g=g.nextBody){var y=g.body,x=y.GetWorldCenter(),S=y.GetMass(),b=x.x-m.x,C=x.y-m.y,A=b*b+C*C;if(!(A<r)){var T=e.Step_s_f.Set(b,C);T.SelfMul(this.G/A*v*S),d.IsAwake()&&d.ApplyForce(T,m),y.IsAwake()&&y.ApplyForce(T.SelfMul(-1),x)}}},i.Draw=function(){},e}(bo);wo.Step_s_f=new At;var Eo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).T=new Et,e.maxTimestep=0,e}$(e,t);var i=e.prototype;return i.Step=function(t){var i=t.dt;if(!(i<=r)){i>this.maxTimestep&&this.maxTimestep>0&&(i=this.maxTimestep);for(var n=this.m_bodyList;n;n=n.nextBody){var o=n.body;if(o.IsAwake()){var a=o.GetWorldVector(Et.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),At.s_t0),At.s_t1),e.Step_s_damping);o.SetLinearVelocity(At.AddVV(o.GetLinearVelocity(),At.MulSV(i,a,At.s_t0),At.s_t1))}}}},i.Draw=function(){},i.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/rt(t,e):0},e}(bo);Eo.Step_s_damping=new At;var Po=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new At(0,0),this.damping=.1,this.k2=.9,this.k3=.1},Io=function(){function t(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new At,this.m_damping=0,this.m_k2=1,this.m_k3=.1}var e=t.prototype;return e.GetVertexCount=function(){return this.m_count},e.GetVertices=function(){return this.m_ps},e.Initialize=function(t){this.m_count=t.count,this.m_ps=At.MakeArray(this.m_count),this.m_p0s=At.MakeArray(this.m_count),this.m_vs=At.MakeArray(this.m_count),this.m_ims=K(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var i=t.masses[e];this.m_ims[e]=i>0?1/i:0}var n=this.m_count-1,r=this.m_count-2;this.m_Ls=K(n),this.m_as=K(r);for(var o=0;o<n;++o){var a=this.m_ps[o],s=this.m_ps[o+1];this.m_Ls[o]=At.DistanceVV(a,s)}for(var c=0;c<r;++c){var l=this.m_ps[c],u=this.m_ps[c+1],h=this.m_ps[c+2],_=At.SubVV(u,l,At.s_t0),f=At.SubVV(h,u,At.s_t1),p=At.CrossVV(_,f),d=At.DotVV(_,f);this.m_as[c]=yt(p,d)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},e.Step=function(t,e){if(0!==t){for(var i=Math.exp(-t*this.m_damping),n=0;n<this.m_count;++n)this.m_p0s[n].Copy(this.m_ps[n]),this.m_ims[n]>0&&this.m_vs[n].SelfMulAdd(t,this.m_gravity),this.m_vs[n].SelfMul(i),this.m_ps[n].SelfMulAdd(t,this.m_vs[n]);for(var r=0;r<e;++r)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var o=1/t,a=0;a<this.m_count;++a)At.MulSV(o,At.SubVV(this.m_ps[a],this.m_p0s[a],At.s_t0),this.m_vs[a])}},e.SolveC2=function(){for(var e=this.m_count-1,i=0;i<e;++i){var n=this.m_ps[i],r=this.m_ps[i+1],o=At.SubVV(r,n,t.s_d),a=o.Normalize(),s=this.m_ims[i],c=this.m_ims[i+1];if(s+c!==0){var l=s/(s+c),u=c/(s+c);n.SelfMulSub(this.m_k2*l*(this.m_Ls[i]-a),o),r.SelfMulAdd(this.m_k2*u*(this.m_Ls[i]-a),o)}}},e.SetAngle=function(t){for(var e=this.m_count-2,i=0;i<e;++i)this.m_as[i]=t},e.SolveC3=function(){for(var e=this.m_count-2,i=0;i<e;++i){var n=this.m_ps[i],r=this.m_ps[i+1],o=this.m_ps[i+2],s=this.m_ims[i],c=this.m_ims[i+1],l=this.m_ims[i+2],u=At.SubVV(r,n,t.s_d1),h=At.SubVV(o,r,t.s_d2),_=u.LengthSquared(),f=h.LengthSquared();if(_*f!=0){var p=At.CrossVV(u,h),d=At.DotVV(u,h),m=yt(p,d),v=At.MulSV(-1/_,u.SelfSkew(),t.s_Jd1),g=At.MulSV(1/f,h.SelfSkew(),t.s_Jd2),y=At.NegV(v,t.s_J1),x=At.SubVV(v,g,t.s_J2),S=g,b=s*At.DotVV(y,y)+c*At.DotVV(x,x)+l*At.DotVV(S,S);if(0!==b){b=1/b;for(var C=m-this.m_as[i];C>a;)C=(m-=2*a)-this.m_as[i];for(;C<-a;)C=(m+=2*a)-this.m_as[i];var A=-this.m_k3*b*C;n.SelfMulAdd(s*A,y),r.SelfMulAdd(c*A,x),o.SelfMulAdd(l*A,S)}}}},e.Draw=function(t){for(var e=new Ot(.4,.5,.7),i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)},t}();Io.s_d=new At,Io.s_d1=new At,Io.s_d2=new At,Io.s_Jd1=new At,Io.s_Jd2=new At,Io.s_J1=new At,Io.s_J2=new At,t.b2AABB=Te,t.b2Abs=et,t.b2Acos=vt,t.b2Alloc=z,t.b2AreaJoint=Pn,t.b2AreaJointDef=En,t.b2Asin=gt,t.b2Assert=e,t.b2Atan2=yt,t.b2BlockAllocator=zt,t.b2Body=xn,t.b2BodyDef=yn,t.b2BroadPhase=Ve,t.b2BuoyancyController=Co,t.b2CalculateParticleIterations=Dr,t.b2ChainAndCircleContact=or,t.b2ChainAndPolygonContact=ar,t.b2ChainShape=hn,t.b2CircleContact=tr,t.b2CircleShape=cn,t.b2Clamp=ot,t.b2ClipSegmentToLine=Ee,t.b2ClipVertex=be,t.b2CollideCircles=_i,t.b2CollideEdgeAndCircle=Ji,t.b2CollideEdgeAndPolygon=rn,t.b2CollidePolygonAndCircle=mi,t.b2CollidePolygons=ki,t.b2Color=Ot,t.b2ConstantAccelController=Ao,t.b2ConstantForceController=To,t.b2Contact=$n,t.b2ContactEdge=Zn,t.b2ContactFactory=cr,t.b2ContactFeature=de,t.b2ContactFilter=ur,t.b2ContactID=me,t.b2ContactImpulse=hr,t.b2ContactListener=_r,t.b2ContactManager=dr,t.b2ContactPositionConstraint=Ar,t.b2ContactRegister=sr,t.b2ContactSolver=Er,t.b2ContactSolverDef=Tr,t.b2ContactVelocityConstraint=Cr,t.b2Controller=bo,t.b2ControllerEdge=So,t.b2Cos=dt,t.b2Counter=Lt,t.b2DegToRad=ft,t.b2DestructionListener=lr,t.b2Distance=ne,t.b2DistanceInput=Gt,t.b2DistanceJoint=wn,t.b2DistanceJointDef=Tn,t.b2DistanceOutput=Ht,t.b2DistanceProxy=kt,t.b2Draw=Bt,t.b2DynamicTree=Be,t.b2EdgeAndCircleContact=nr,t.b2EdgeAndPolygonContact=rr,t.b2EdgeShape=un,t.b2Filter=_n,t.b2Fixture=mn,t.b2FixtureDef=fn,t.b2FixtureParticleQueryCallback=Jr,t.b2FixtureProxy=pn,t.b2Free=V,t.b2FrictionJoint=Rn,t.b2FrictionJointDef=In,t.b2GearJoint=Mn,t.b2GearJointDef=Dn,t.b2GetPointStates=Se,t.b2GravityController=wo,t.b2GrowableBuffer=Kr,t.b2GrowableStack=Ft,t.b2InvSqrt=ut,t.b2IsPowerOfTwo=St,t.b2IsValid=ct,t.b2Island=Ir,t.b2Jacobian=Sn,t.b2Joint=An,t.b2JointDef=Cn,t.b2JointEdge=bn,t.b2Log=k,t.b2MakeArray=X,t.b2MakeNullArray=Y,t.b2MakeNumberArray=K,t.b2Manifold=ye,t.b2ManifoldPoint=ve,t.b2MassData=an,t.b2Mat22=Et,t.b2Mat33=Pt,t.b2Max=rt,t.b2Maybe=i,t.b2Min=it,t.b2MixFriction=Jn,t.b2MixRestitution=Qn,t.b2MotorJoint=Bn,t.b2MotorJointDef=On,t.b2MouseJoint=Ln,t.b2MouseJointDef=Nn,t.b2NextPowerOfTwo=xt,t.b2Pair=ze,t.b2PairLessThan=ke,t.b2ParseInt=W,t.b2ParseUInt=q,t.b2ParticleBodyContact=Zr,t.b2ParticleContact=Qr,t.b2ParticleDef=Rr,t.b2ParticleGroup=Nr,t.b2ParticleGroupDef=Br,t.b2ParticleHandle=Or,t.b2ParticlePair=$r,t.b2ParticlePairSet=ho,t.b2ParticleSystem=io,t.b2ParticleSystemDef=eo,t.b2ParticleSystem_CompositeShape=mo,t.b2ParticleSystem_ConnectionFilter=_o,t.b2ParticleSystem_DestroyParticlesInShapeCallback=fo,t.b2ParticleSystem_FixedSetAllocator=so,t.b2ParticleSystem_FixtureParticle=co,t.b2ParticleSystem_FixtureParticleSet=lo,t.b2ParticleSystem_InsideBoundsEnumerator=oo,t.b2ParticleSystem_JoinParticleGroupsFilter=po,t.b2ParticleSystem_ParticleListNode=ao,t.b2ParticleSystem_ParticlePair=uo,t.b2ParticleSystem_Proxy=ro,t.b2ParticleSystem_ReactiveFilter=vo,t.b2ParticleSystem_SolveCollisionCallback=yo,t.b2ParticleSystem_UpdateBodyContactsCallback=go,t.b2ParticleSystem_UserOverridableBuffer=no,t.b2ParticleTriad=to,t.b2PolygonAndCircleContact=ir,t.b2PolygonContact=er,t.b2PolygonShape=ln,t.b2Position=gr,t.b2PositionSolverManifold=wr,t.b2Pow=_t,t.b2PrismaticJoint=zn,t.b2PrismaticJointDef=Fn,t.b2Profile=mr,t.b2PulleyJoint=Un,t.b2PulleyJointDef=kn,t.b2QueryCallback=fr,t.b2RadToDeg=pt,t.b2Random=bt,t.b2RandomRange=Ct,t.b2RayCastCallback=pr,t.b2RayCastInput=Ce,t.b2RayCastOutput=Ae,t.b2RevoluteJoint=Hn,t.b2RevoluteJointDef=Gn,t.b2Rope=Io,t.b2RopeDef=Po,t.b2RopeJoint=Wn,t.b2RopeJointDef=jn,t.b2Rot=It,t.b2SeparationFunction=$e,t.b2Shape=sn,t.b2ShapeCast=fe,t.b2ShapeCastInput=jt,t.b2ShapeCastOutput=Wt,t.b2Simplex=Yt,t.b2SimplexCache=Ut,t.b2SimplexVertex=Xt,t.b2Sin=mt,t.b2SolverData=xr,t.b2Sq=lt,t.b2Sqrt=ht,t.b2StackAllocator=Vt,t.b2Swap=at,t.b2Sweep=Mt,t.b2TOIInput=Je,t.b2TOIOutput=Ze,t.b2TensorDampingController=Eo,t.b2TestOverlapAABB=we,t.b2TestOverlapShape=De,t.b2TimeOfImpact=li,t.b2TimeStep=vr,t.b2Timer=Nt,t.b2Transform=Rt,t.b2TreeNode=Oe,t.b2Vec2=At,t.b2Vec2_zero=Tt,t.b2Vec3=wt,t.b2Velocity=yr,t.b2VelocityConstraintPoint=br,t.b2Version=U,t.b2WeldJoint=Xn,t.b2WeldJointDef=qn,t.b2WheelJoint=Kn,t.b2WheelJointDef=Yn,t.b2World=xo,t.b2WorldManifold=xe,t.b2_180_over_pi=Z,t.b2_aabbExtension=l,t.b2_aabbMultiplier=u,t.b2_angularSleepTolerance=F,t.b2_angularSlop=_,t.b2_barrierCollisionTime=B,t.b2_baumgarte=C,t.b2_branch=H,t.b2_commit=j,t.b2_epsilon=r,t.b2_epsilon_sq=o,t.b2_gjk_reset=qt,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=L,t.b2_linearSlop=h,t.b2_maxAngularCorrection=g,t.b2_maxFloat=n,t.b2_maxLinearCorrection=v,t.b2_maxManifoldPoints=s,t.b2_maxParticleForce=R,t.b2_maxParticleIndex=w,t.b2_maxParticlePressure=I,t.b2_maxPolygonVertices=c,t.b2_maxRotation=S,t.b2_maxRotationSquared=b,t.b2_maxSubSteps=p,t.b2_maxTOIContacts=d,t.b2_maxTranslation=y,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=D,t.b2_maxTriadDistanceSquared=M,t.b2_minParticleSystemBufferCapacity=O,t.b2_minParticleWeight=P,t.b2_minPulleyLength=Vn,t.b2_particleStride=E,t.b2_pi=a,t.b2_pi_over_180=J,t.b2_polygonRadius=f,t.b2_timeToSleep=N,t.b2_toiBaumgarte=A,t.b2_toi_reset=Ue,t.b2_two_pi=tt,t.b2_velocityThreshold=m,t.b2_version=G,t.g_blockSolve=Sr,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(pft=dft)&&pft.__esModule&&Object.prototype.hasOwnProperty.call(pft,"default")&&pft.default;var mft={};for(var vft in dft)-1===vft.indexOf("b2_")&&(mft[vft.replace("b2","")]=dft[vft]);var gft,yft,xft,Sft,bft,Cft=mft;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(gft||(gft=t("ERigidBody2DType",{}))),oe(gft),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}(yft||(yft=t("ECollider2DType",{}))),oe(yft),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(xft||(xft=t("EJoint2DType",{}))),oe(xft),function(t){t[t.DEFAULT=1]="DEFAULT"}(Sft||(Sft=t("PhysicsGroup",{}))),oe(Sft),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(bft||(bft=t("ERaycast2DType",{})));var Aft,Tft=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(Aft||(Aft=t("EPhysics2DDrawFlags",{})));var wft=t("PHYSICS_2D_PTM_RATIO",32),Eft=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._contactFixtures=[],e._BeginContact=null,e._EndContact=null,e._PreSolve=null,e._PostSolve=null,e}$(e,t);var i=e.prototype;return i.setBeginContact=function(t){this._BeginContact=t},i.setEndContact=function(t){this._EndContact=t},i.setPreSolve=function(t){this._PreSolve=t},i.setPostSolve=function(t){this._PostSolve=t},i.BeginContact=function(t){if(this._BeginContact){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=this._contactFixtures;t._shouldReport=!1,-1===n.indexOf(e)&&-1===n.indexOf(i)||(t._shouldReport=!0,this._BeginContact(t))}},i.EndContact=function(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))},i.PreSolve=function(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)},i.PostSolve=function(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)},i.registerContactFixture=function(t){this._contactFixtures.push(t)},i.unregisterContactFixture=function(t){ft(this._contactFixtures,t)},e}(Cft.ContactListener),Pft=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._point=new Cft.Vec2,e._isPoint=!1,e._fixtures=[],e}$(e,t);var i=e.prototype;return i.init=function(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0},i.ReportFixture=function(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0},i.getFixture=function(){return this._fixtures[0]},i.getFixtures=function(){return this._fixtures},e}(Cft.QueryCallback);function Ift(t,e){var i=e.length;return e[t<0?i- -t%i:t%i]}function Rft(t,e,i){for(var n=[];e<t;)e+=i.length;for(;t<=e;++t)n.push(Ift(t,i));return n}function Dft(t){Vft(t);for(var e,i,n,r,o,a,s=[],c=new qi,l=new qi,u=0,h=0,_=0;_<t.length;++_)if(Oft(_,t)){i=n=1e8;for(var f=0;f<t.length;++f)Nft(Ift(_-1,t),Ift(_,t),Ift(f,t))&&Fft(Ift(_-1,t),Ift(_,t),Ift(f-1,t))&&(r=Uft(Ift(_-1,t),Ift(_,t),Ift(f,t),Ift(f-1,t)),Bft(Ift(_+1,t),Ift(_,t),r)&&(e=zft(Ift(_,t),r))<i&&(i=e,c=r,u=f)),Nft(Ift(_+1,t),Ift(_,t),Ift(f+1,t))&&Fft(Ift(_+1,t),Ift(_,t),Ift(f,t))&&(r=Uft(Ift(_+1,t),Ift(_,t),Ift(f,t),Ift(f+1,t)),Nft(Ift(_-1,t),Ift(_,t),r)&&(e=zft(Ift(_,t),r))<n&&(n=e,h=f,l=r));if(u==(h+1)%t.length){var p=c.add(l).multiplyScalar(.5);(o=Rft(_,h,t)).push(p),(a=Rft(u,_,t)).push(p)}else{for(var d=0,m=u;h<u;)h+=t.length;for(var v=u;v<=h;++v)if(Mft(_,v,t)){var g=1/(zft(Ift(_,t),Ift(v,t))+1);Oft(v,t)?Fft(Ift(v-1,t),Ift(v,t),Ift(_,t))&&Lft(Ift(v+1,t),Ift(v,t),Ift(_,t))?g+=3:g+=2:g+=1,g>d&&(m=v,d=g)}o=Rft(_,m,t),a=Rft(m,_,t)}return(s=s.concat(Dft(o))).concat(Dft(a))}s.push(t);for(var y=s.length-1;y>=0;y--)0==s[y].length&&s.splice(y,0);return s}function Mft(t,e,i){if(Oft(t,i)){if(Lft(Ift(t,i),Ift(t-1,i),Ift(e,i))&&Fft(Ift(t,i),Ift(t+1,i),Ift(e,i)))return!1}else if(Fft(Ift(t,i),Ift(t+1,i),Ift(e,i))||Lft(Ift(t,i),Ift(t-1,i),Ift(e,i)))return!1;if(Oft(e,i)){if(Lft(Ift(e,i),Ift(e-1,i),Ift(t,i))&&Fft(Ift(e,i),Ift(e+1,i),Ift(t,i)))return!1}else if(Fft(Ift(e,i),Ift(e+1,i),Ift(t,i))||Lft(Ift(e,i),Ift(e-1,i),Ift(t,i)))return!1;for(var n=0;n<i.length;++n)if((n+1)%i.length!=t&&n!=t&&(n+1)%i.length!=e&&n!=e){var r=new qi;if(Gft(Ift(t,i),Ift(e,i),Ift(n,i),Ift(n+1,i),r))return!1}return!0}function Oft(t,e){return Bft(t,e)}function Bft(t,e,i){if(void 0===i){var n=t,r=e;t=Ift(n-1,r),e=Ift(n,r),i=Ift(n+1,r)}return Hft(t,e,i)<0}function Nft(t,e,i){return Hft(t,e,i)>0}function Lft(t,e,i){return Hft(t,e,i)>=0}function Fft(t,e,i){return Hft(t,e,i)<=0}function zft(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n}function Vft(t){kft(t)||t.reverse()}function kft(t){return t.length<3||function(t){var e,i=0;for(e=0;e<t.length;e++){var n=(e+1)%t.length;i+=t[e].x*t[n].y,i-=t[e].y*t[n].x}return i/2}(t)>0}function Uft(t,e,i,n){var r,o=new qi,a=e.y-t.y,s=t.x-e.x,c=a*t.x+s*t.y,l=n.y-i.y,u=i.x-n.x,h=l*i.x+u*i.y,_=a*u-l*s;return r=_,0,Math.abs(r-0)<=1e-6||(o.x=(u*c-s*h)/_,o.y=(a*h-l*c)/_),o}function Gft(t,e,i,n,r){if(t==i||t==n||e==i||e==n)return!1;var o=t.x,a=t.y,s=e.x,c=e.y,l=i.x,u=i.y,h=n.x,_=n.y;if(Math.max(o,s)<Math.min(l,h)||Math.max(l,h)<Math.min(o,s))return!1;if(Math.max(a,c)<Math.min(u,_)||Math.max(u,_)<Math.min(a,c))return!1;var f=(h-l)*(a-u)-(_-u)*(o-l),p=(s-o)*(a-u)-(c-a)*(o-l),d=(_-u)*(s-o)-(h-l)*(c-a);return!(Math.abs(d)<1e-6)&&(p/=d,(f/=d)>0&&f<1&&p>0&&p<1&&(r.x=o+f*(s-o),r.y=a+f*(c-a),!0))}function Hft(t,e,i){return t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y)}var jft=Object.freeze({__proto__:null,ConvexPartition:Dft,ForceCounterClockWise:Vft,IsCounterClockWise:kft}),Wft=function(){return 0},qft={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:Wft,setType:Wft,setLinearDamping:Wft,setAngularDamping:Wft,setGravityScale:Wft,setFixedRotation:Wft,setAllowSleep:Wft,isActive:Wft,setActive:Wft,wakeUp:Wft,sleep:Wft,getMass:Wft,getInertia:Wft,getLinearVelocity:Wft,setLinearVelocity:Wft,getLinearVelocityFromWorldPoint:Wft,getAngularVelocity:Wft,setAngularVelocity:Wft,getLocalVector:Wft,getWorldVector:Wft,getLocalPoint:Wft,getWorldPoint:Wft,getLocalCenter:Wft,getWorldCenter:Wft,applyForce:Wft,applyForceToCenter:Wft,applyTorque:Wft,applyLinearImpulse:Wft,applyLinearImpulseToCenter:Wft,applyAngularImpulse:Wft,onEnable:Wft,onDisable:Wft,onDestroy:Wft},Xft={INITED:!1};var Yft,Kft,Jft,Qft,Zft,$ft,tpt={INITED:!1},ept={impl:null,initialize:Wft,setDampingRatio:Wft,setFrequency:Wft,setMaxForce:Wft,setTarget:Wft,setDistance:Wft,setAngularOffset:Wft,setCorrectionFactor:Wft,setLinearOffset:Wft,setMaxLength:Wft,setMaxTorque:Wft,setLowerLimit:Wft,setUpperLimit:Wft,setMaxMotorForce:Wft,setMaxMotorTorque:Wft,setMotorSpeed:Wft,enableLimit:Wft,enableMotor:Wft,setLowerAngle:Wft,setUpperAngle:Wft};!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(Yft||(Yft={})),oe(Yft),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(Kft||(Kft={})),oe(Kft),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(Jft||(Jft={})),oe(Jft),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(Qft||(Qft={})),oe(Qft),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(Zft||(Zft={})),oe(Zft),function(t){t[t.DEFAULT=1]="DEFAULT"}($ft||($ft={})),oe($ft);var ipt,npt,rpt,opt,apt,spt,cpt,lpt,upt,hpt,_pt,fpt,ppt,dpt,mpt,vpt,gpt,ypt,xpt,Spt=function(t){if(1===t){for(var e=this,i=function(t){var i="_"+(1<<t);e[i]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get:function(){return this[i]},set:function(e){this[i]!==e&&(this[i]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})},n=0;n<32;n++)i(n);this._1=$ft.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=$ft.DEFAULT}},bpt=null,Cpt=t("PhysicsSystem2D",function(t){function e(){var e;(e=t.call(this)||this).velocityIterations=10,e.positionIterations=10,e.physicsWorld=void 0,e.collisionMatrix=new Spt,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._steping=!1,e._gravity=new qi(0,-10*wft),e._delayEvents=[];var i=UO.config?UO.config.physics:null;if(i){if(qi.copy(e._gravity,i.gravity),e._gravity.multiplyScalar(wft),e._allowSleep=i.allowSleep,e._fixedTimeStep=i.fixedTimeStep,e._maxSubSteps=i.maxSubSteps,e._autoSimulation=i.autoSimulation,i.collisionMatrix)for(var n in i.collisionMatrix){var r=parseInt(n),o=1<<parseInt(n);e.collisionMatrix[""+o]=i.collisionMatrix[r]}if(i.collisionGroups){var a=i.collisionGroups;a instanceof Array&&(a.forEach((function(t){Sft[t.name]=1<<t.index})),oe.update(Sft))}}return e.physicsWorld=new uft.PhysicsWorld,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e}$(e,t);var i=e.prototype;return i.postUpdate=function(t){if(this._enable&&this._autoSimulation){HO.emit(GO.EVENT_BEFORE_PHYSICS),this._steping=!0;var e=this._fixedTimeStep,i=this.velocityIterations,n=this.positionIterations;this._accumulator+=t;for(var r=0;r++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,i,n),this._accumulator-=e;for(var o=this._delayEvents,a=0,s=o.length;a<s;a++){var c=o[a];c.func.call(c.target)}o.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,HO.emit(GO.EVENT_AFTER_PHYSICS)}},i._callAfterStep=function(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)},i.resetAccumulator=function(t){void 0===t&&(t=0),this._accumulator=t},i.step=function(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)},i.raycast=function(t,e,i,n){return void 0===i&&(i=bft.Closest),void 0===n&&(n=4294967295),this.physicsWorld.raycast(t,e,i,n)},i.testPoint=function(t){return this.physicsWorld.testPoint(t)},i.testAABB=function(t){return this.physicsWorld.testAABB(t)},Q(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}},{key:"gravity",get:function(){return this._gravity},set:function(t){this._gravity.set(t),this.physicsWorld.setGravity(new qi(t.x/wft,t.y/wft))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(t){this._maxSubSteps=t}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(t){this._autoSimulation=t}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(t){this.physicsWorld.debugDrawFlags=t}},{key:"stepping",get:function(){return this._steping}}],[{key:"PHYSICS_NONE",get:function(){return!hft}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===hft}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===hft}},{key:"PhysicsGroup",get:function(){return Sft}},{key:"instance",get:function(){return bpt||(bpt=new e),bpt}}]),e}(tu(IO)));Cpt.ID="PHYSICS_2D",HO.once(GO.EVENT_INIT,(function(){Cpt.PHYSICS_NONE||HO.registerSystem(Cpt.ID,Cpt.instance,IO.Priority.LOW)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(ipt||(ipt=t("Physics2DManifoldType",{})));var Apt,Tpt,wpt,Ept,Ppt,Ipt,Rpt,Dpt,Mpt,Opt,Bpt,Npt,Lpt,Fpt,zpt,Vpt,kpt,Upt,Gpt,Hpt,jpt,Wpt,qpt,Xpt,Ypt,Kpt,Jpt,Qpt,Zpt,$pt,tdt,edt,idt,ndt,rdt,odt,adt,sdt,cdt,ldt,udt,hdt,_dt,fdt,pdt,ddt,mdt,vdt,gdt,ydt,xdt,Sdt,bdt,Cdt,Adt,Tdt,wdt,Edt,Pdt,Idt,Rdt,Ddt,Mdt,Odt,Bdt,Ndt,Ldt,Fdt,zdt,Vdt,kdt,Udt,Gdt,Hdt,jdt,Wdt,qdt,Xdt,Ydt,Kdt,Jdt,Qdt,Zdt,$dt,tmt,emt,imt,nmt,rmt,omt,amt,smt,cmt=gc,lmt=Kc,umt=wc,hmt=t("RigidBody2D",(npt=pc("cc.RigidBody2D"),rpt=umt(),opt=lmt($ft),apt=lmt(gft),npt(spt=rpt((lt((cpt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"enabledContactListener",lpt,ot(e)),ct(e,"bullet",upt,ot(e)),ct(e,"awakeOnLoad",hpt,ot(e)),e._body=null,ct(e,"_group",_pt,ot(e)),ct(e,"_type",fpt,ot(e)),ct(e,"_allowSleep",ppt,ot(e)),ct(e,"_gravityScale",dpt,ot(e)),ct(e,"_linearDamping",mpt,ot(e)),ct(e,"_angularDamping",vpt,ot(e)),ct(e,"_linearVelocity",gpt,ot(e)),ct(e,"_angularVelocity",ypt,ot(e)),ct(e,"_fixedRotation",xpt,ot(e)),e}$(e,t);var i=e.prototype;return i.isAwake=function(){return!!this._body&&this._body.isAwake},i.wakeUp=function(){this._body&&this._body.wakeUp()},i.sleep=function(){this._body&&this._body.sleep()},i.getMass=function(){return this._body?this._body.getMass():0},i.applyForce=function(t,e,i){this._body&&this._body.applyForce(t,e,i)},i.applyForceToCenter=function(t,e){this._body&&this._body.applyForceToCenter(t,e)},i.applyTorque=function(t,e){this._body&&this._body.applyTorque(t,e)},i.applyLinearImpulse=function(t,e,i){this._body&&this._body.applyLinearImpulse(t,e,i)},i.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)},i.applyAngularImpulse=function(t,e){this._body&&this._body.applyAngularImpulse(t,e)},i.getLinearVelocityFromWorldPoint=function(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e},i.getLocalVector=function(t,e){return this._body?this._body.getLocalVector(t,e):e},i.getWorldVector=function(t,e){return this._body?this._body.getWorldVector(t,e):e},i.getLocalPoint=function(t,e){return this._body?this._body.getLocalPoint(t,e):e},i.getWorldPoint=function(t,e){return this._body?this._body.getWorldPoint(t,e):e},i.getLocalCenter=function(t){return this._body?this._body.getLocalCenter(t):t},i.getWorldCenter=function(t){return this._body?this._body.getWorldCenter(t):t},i.getInertia=function(){return this._body&&this._body.getInertia(),0},i.onLoad=function(){this._body=u._global.CC_PHYSICS_2D_BUILTIN?qft:new uft.RigidBody,this._body.initialize(this)},i.onEnable=function(){this._body&&this._body.onEnable()},i.onDisable=function(){this._body&&this._body.onDisable()},i.onDestroy=function(){this._body&&this._body.onDestroy()},Q(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._body&&(t===gft.Animated?this._body.setType(gft.Kinematic):this._body.setType(t))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}},{key:"impl",get:function(){return this._body}}]),e}($u)).prototype,"group",[opt],Object.getOwnPropertyDescriptor(cpt.prototype,"group"),cpt.prototype),lpt=lt(cpt.prototype,"enabledContactListener",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),upt=lt(cpt.prototype,"bullet",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(cpt.prototype,"type",[apt],Object.getOwnPropertyDescriptor(cpt.prototype,"type"),cpt.prototype),lt(cpt.prototype,"allowSleep",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"allowSleep"),cpt.prototype),lt(cpt.prototype,"gravityScale",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"gravityScale"),cpt.prototype),lt(cpt.prototype,"linearDamping",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"linearDamping"),cpt.prototype),lt(cpt.prototype,"angularDamping",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"angularDamping"),cpt.prototype),lt(cpt.prototype,"linearVelocity",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"linearVelocity"),cpt.prototype),lt(cpt.prototype,"angularVelocity",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"angularVelocity"),cpt.prototype),lt(cpt.prototype,"fixedRotation",[cmt],Object.getOwnPropertyDescriptor(cpt.prototype,"fixedRotation"),cpt.prototype),hpt=lt(cpt.prototype,"awakeOnLoad",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_pt=lt(cpt.prototype,"_group",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $ft.DEFAULT}}),fpt=lt(cpt.prototype,"_type",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gft.Dynamic}}),ppt=lt(cpt.prototype,"_allowSleep",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dpt=lt(cpt.prototype,"_gravityScale",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mpt=lt(cpt.prototype,"_linearDamping",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vpt=lt(cpt.prototype,"_angularDamping",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gpt=lt(cpt.prototype,"_linearVelocity",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi}}),ypt=lt(cpt.prototype,"_angularVelocity",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xpt=lt(cpt.prototype,"_fixedRotation",[cmt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),spt=cpt))||spt)||spt)),_mt=t("Collider2D",(Apt=pc("cc.Collider2D"),Tpt=Kc($ft),Apt((Lpt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"editing",Ppt,ot(e)),ct(e,"tag",Ipt,ot(e)),e.TYPE=yft.None,e._shape=null,e._body=null,ct(e,"_group",Rpt,ot(e)),ct(e,"_density",Dpt,ot(e)),ct(e,"_sensor",Mpt,ot(e)),ct(e,"_friction",Opt,ot(e)),ct(e,"_restitution",Bpt,ot(e)),ct(e,"_offset",Npt,ot(e)),e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._shape=function(t){return Xft.INITED||(Xft.INITED=!0,Xft[yft.BOX]=function(){return new uft.BoxShape},Xft[yft.CIRCLE]=function(){return new uft.CircleShape},Xft[yft.POLYGON]=function(){return new uft.PolygonShape}),Xft[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(hmt)},i.onEnable=function(){this._shape&&this._shape.onEnable()},i.onDisable=function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()},i.onDestroy=function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()},i.apply=function(){this._shape&&this._shape.apply&&this._shape.apply()},Q(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(t){this._density=t}},{key:"sensor",get:function(){return this._sensor},set:function(t){this._sensor=t}},{key:"friction",get:function(){return this._friction},set:function(t){this._friction=t}},{key:"restitution",get:function(){return this._restitution},set:function(t){this._restitution=t}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new en}}]),e}(tu($u)),Ppt=lt((Ept=Lpt).prototype,"editing",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ipt=lt(Ept.prototype,"tag",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lt(Ept.prototype,"group",[Tpt],Object.getOwnPropertyDescriptor(Ept.prototype,"group"),Ept.prototype),lt(Ept.prototype,"density",[gc],Object.getOwnPropertyDescriptor(Ept.prototype,"density"),Ept.prototype),lt(Ept.prototype,"sensor",[gc],Object.getOwnPropertyDescriptor(Ept.prototype,"sensor"),Ept.prototype),lt(Ept.prototype,"friction",[gc],Object.getOwnPropertyDescriptor(Ept.prototype,"friction"),Ept.prototype),lt(Ept.prototype,"restitution",[gc],Object.getOwnPropertyDescriptor(Ept.prototype,"restitution"),Ept.prototype),lt(Ept.prototype,"offset",[gc],Object.getOwnPropertyDescriptor(Ept.prototype,"offset"),Ept.prototype),Rpt=lt(Ept.prototype,"_group",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $ft.DEFAULT}}),Dpt=lt(Ept.prototype,"_density",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Mpt=lt(Ept.prototype,"_sensor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Opt=lt(Ept.prototype,"_friction",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),Bpt=lt(Ept.prototype,"_restitution",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Npt=lt(Ept.prototype,"_offset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi}}),wpt=Ept))||wpt)),fmt=(t("BoxCollider2D",pc("cc.BoxCollider2D")(Fpt=wc()((kpt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_size",Vpt,ot(e)),e.TYPE=yft.BOX,e}return $(e,t),Q(e,[{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}(_mt),Vpt=lt((zpt=kpt).prototype,"_size",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $i(1,1)}}),lt(zpt.prototype,"size",[gc],Object.getOwnPropertyDescriptor(zpt.prototype,"size"),zpt.prototype),Fpt=zpt))||Fpt)||Fpt),t("CircleCollider2D",pc("cc.CircleCollider2D")(Upt=wc()((jpt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_radius",Hpt,ot(e)),e.TYPE=yft.CIRCLE,e}return $(e,t),Q(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t<0?0:t}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new qi}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),e}(_mt),Hpt=lt((Gpt=jpt).prototype,"_radius",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lt(Gpt.prototype,"radius",[gc],Object.getOwnPropertyDescriptor(Gpt.prototype,"radius"),Gpt.prototype),Upt=Gpt))||Upt)||Upt),t("PolygonCollider2D",(Wpt=pc("cc.PolygonCollider2D"),qpt=wc(),Xpt=gc({serializable:!1,displayOrder:0}),Ypt=gc({type:qi}),Wpt(Kpt=qpt(($pt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"threshold",Qpt,ot(e)),ct(e,"_points",Zpt,ot(e)),e.TYPE=yft.POLYGON,e}return $(e,t),Q(e,[{key:"points",get:function(){return this._points},set:function(t){this._points=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}(_mt),Qpt=lt((Jpt=$pt).prototype,"threshold",[Xpt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Zpt=lt(Jpt.prototype,"_points",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new qi(-1,-1),new qi(1,-1),new qi(1,1),new qi(-1,1)]}}),lt(Jpt.prototype,"points",[Ypt],Object.getOwnPropertyDescriptor(Jpt.prototype,"points"),Jpt.prototype),Kpt=Jpt))||Kpt)||Kpt)),t("Joint2D",(tdt=pc("cc.Joint2D"),edt=Kc(hmt),tdt((cdt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"anchor",rdt,ot(e)),ct(e,"connectedAnchor",odt,ot(e)),ct(e,"collideConnected",adt,ot(e)),ct(e,"connectedBody",sdt,ot(e)),e._body=null,e._joint=null,e.TYPE=xft.None,e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._joint=function(t){return function(){if(!tpt.INITED){tpt.INITED=!0;var t=u._global.CC_PHYSICS_2D_BUILTIN;tpt[xft.SPRING]=function(){return t?ept:new uft.SpringJoint},tpt[xft.DISTANCE]=function(){return t?ept:new uft.DistanceJoint},tpt[xft.FIXED]=function(){return t?ept:new uft.FixedJoint},tpt[xft.MOUSE]=function(){return t?ept:new uft.MouseJoint},tpt[xft.RELATIVE]=function(){return t?ept:new uft.RelativeJoint},tpt[xft.SLIDER]=function(){return t?ept:new uft.SliderJoint},tpt[xft.WHEEL]=function(){return t?ept:new uft.WheelJoint},tpt[xft.HINGE]=function(){return t?ept:new uft.HingeJoint}}}(),tpt[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(hmt)},i.onEnable=function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()},i.onDisable=function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()},i.start=function(){this._joint&&this._joint.start&&this._joint.start()},i.onDestroy=function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()},Q(e,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}}]),e}($u),rdt=lt((ndt=cdt).prototype,"anchor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi}}),odt=lt(ndt.prototype,"connectedAnchor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi}}),adt=lt(ndt.prototype,"collideConnected",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sdt=lt(ndt.prototype,"connectedBody",[edt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),idt=ndt))||idt))),pmt=(t("DistanceJoint2D",pc("cc.DistanceJoint2D")(ldt=wc()((lt((udt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.DISTANCE,ct(e,"_maxLength",hdt,ot(e)),ct(e,"_autoCalcDistance",_dt,ot(e)),e}return $(e,t),Q(e,[{key:"maxLength",get:function(){return this._autoCalcDistance&&this.connectedBody?Ei.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength},set:function(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(fmt)).prototype,"maxLength",[gc],Object.getOwnPropertyDescriptor(udt.prototype,"maxLength"),udt.prototype),lt(udt.prototype,"autoCalcDistance",[gc],Object.getOwnPropertyDescriptor(udt.prototype,"autoCalcDistance"),udt.prototype),hdt=lt(udt.prototype,"_maxLength",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),_dt=lt(udt.prototype,"_autoCalcDistance",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ldt=udt))||ldt)||ldt),t("SpringJoint2D",pc("cc.SpringJoint2D")(fdt=wc()((lt((pdt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.SPRING,ct(e,"_frequency",ddt,ot(e)),ct(e,"_dampingRatio",mdt,ot(e)),ct(e,"_distance",vdt,ot(e)),ct(e,"_autoCalcDistance",gdt,ot(e)),e}return $(e,t),Q(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"distance",get:function(){return this._autoCalcDistance&&this.connectedBody?Ei.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance},set:function(t){this._distance=t,this._joint&&this._joint.setDistance(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(fmt)).prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(pdt.prototype,"frequency"),pdt.prototype),lt(pdt.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(pdt.prototype,"dampingRatio"),pdt.prototype),lt(pdt.prototype,"distance",[gc],Object.getOwnPropertyDescriptor(pdt.prototype,"distance"),pdt.prototype),lt(pdt.prototype,"autoCalcDistance",[gc],Object.getOwnPropertyDescriptor(pdt.prototype,"autoCalcDistance"),pdt.prototype),ddt=lt(pdt.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),mdt=lt(pdt.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),vdt=lt(pdt.prototype,"_distance",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),gdt=lt(pdt.prototype,"_autoCalcDistance",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fdt=pdt))||fdt)||fdt),t("MouseJoint2D",pc("cc.MouseJoint2D")(ydt=wc()((lt((xdt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.MOUSE,ct(e,"_maxForce",Sdt,ot(e)),ct(e,"_dampingRatio",bdt,ot(e)),ct(e,"_frequency",Cdt,ot(e)),e._target=new qi,e}return $(e,t),e.prototype.update=function(t){this._joint.update(t)},Q(e,[{key:"target",get:function(){return this._target},set:function(t){this._target=t,this._joint&&this._joint.setTarget(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}}]),e}(fmt)).prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(xdt.prototype,"frequency"),xdt.prototype),lt(xdt.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(xdt.prototype,"dampingRatio"),xdt.prototype),lt(xdt.prototype,"maxForce",[gc],Object.getOwnPropertyDescriptor(xdt.prototype,"maxForce"),xdt.prototype),Sdt=lt(xdt.prototype,"_maxForce",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),bdt=lt(xdt.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Cdt=lt(xdt.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),ydt=xdt))||ydt)||ydt),new Ei),dmt=new Ei,mmt=(t("RelativeJoint2D",pc("cc.RelativeJoint2D")(Adt=wc()((lt((Tdt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.RELATIVE,ct(e,"_maxForce",wdt,ot(e)),ct(e,"_maxTorque",Edt,ot(e)),ct(e,"_correctionFactor",Pdt,ot(e)),ct(e,"_angularOffset",Idt,ot(e)),ct(e,"_linearOffset",Rdt,ot(e)),ct(e,"_autoCalcOffset",Ddt,ot(e)),e}return $(e,t),Q(e,[{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}},{key:"linearOffset",get:function(){return this._autoCalcOffset&&this.connectedBody?qi.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset},set:function(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&this.connectedBody&&(Bi.toEuler(pmt,this.node.worldRotation),Bi.toEuler(dmt,this.connectedBody.node.worldRotation),this._angularOffset=dmt.z-pmt.z),this._angularOffset},set:function(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(t){this._autoCalcOffset=t}}]),e}(fmt)).prototype,"maxForce",[gc],Object.getOwnPropertyDescriptor(Tdt.prototype,"maxForce"),Tdt.prototype),lt(Tdt.prototype,"maxTorque",[gc],Object.getOwnPropertyDescriptor(Tdt.prototype,"maxTorque"),Tdt.prototype),lt(Tdt.prototype,"correctionFactor",[gc],Object.getOwnPropertyDescriptor(Tdt.prototype,"correctionFactor"),Tdt.prototype),lt(Tdt.prototype,"linearOffset",[gc],Object.getOwnPropertyDescriptor(Tdt.prototype,"linearOffset"),Tdt.prototype),lt(Tdt.prototype,"angularOffset",[gc],Object.getOwnPropertyDescriptor(Tdt.prototype,"angularOffset"),Tdt.prototype),lt(Tdt.prototype,"autoCalcOffset",[gc],Object.getOwnPropertyDescriptor(Tdt.prototype,"autoCalcOffset"),Tdt.prototype),wdt=lt(Tdt.prototype,"_maxForce",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Edt=lt(Tdt.prototype,"_maxTorque",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Pdt=lt(Tdt.prototype,"_correctionFactor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Idt=lt(Tdt.prototype,"_angularOffset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rdt=lt(Tdt.prototype,"_linearOffset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qi}}),Ddt=lt(Tdt.prototype,"_autoCalcOffset",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Adt=Tdt))||Adt)||Adt),new qi),vmt=(t("SliderJoint2D",pc("cc.SliderJoint2D")(Mdt=wc()((lt((Odt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.SLIDER,ct(e,"_angle",Bdt,ot(e)),ct(e,"_autoCalcAngle",Ndt,ot(e)),ct(e,"_enableMotor",Ldt,ot(e)),ct(e,"_maxMotorForce",Fdt,ot(e)),ct(e,"_motorSpeed",zdt,ot(e)),ct(e,"_enableLimit",Vdt,ot(e)),ct(e,"_lowerLimit",kdt,ot(e)),ct(e,"_upperLimit",Udt,ot(e)),e}return $(e,t),Q(e,[{key:"angle",get:function(){return this._autoCalcAngle&&this.connectedBody&&(qi.subtract(mmt,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=ui(Math.atan2(mmt.y,mmt.x))),this._angle},set:function(t){this._angle=t}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(t){this._autoCalcAngle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}]),e}(fmt)).prototype,"angle",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"angle"),Odt.prototype),lt(Odt.prototype,"autoCalcAngle",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"autoCalcAngle"),Odt.prototype),lt(Odt.prototype,"enableMotor",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"enableMotor"),Odt.prototype),lt(Odt.prototype,"maxMotorForce",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"maxMotorForce"),Odt.prototype),lt(Odt.prototype,"motorSpeed",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"motorSpeed"),Odt.prototype),lt(Odt.prototype,"enableLimit",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"enableLimit"),Odt.prototype),lt(Odt.prototype,"lowerLimit",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"lowerLimit"),Odt.prototype),lt(Odt.prototype,"upperLimit",[gc],Object.getOwnPropertyDescriptor(Odt.prototype,"upperLimit"),Odt.prototype),Bdt=lt(Odt.prototype,"_angle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ndt=lt(Odt.prototype,"_autoCalcAngle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ldt=lt(Odt.prototype,"_enableMotor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fdt=lt(Odt.prototype,"_maxMotorForce",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),zdt=lt(Odt.prototype,"_motorSpeed",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Vdt=lt(Odt.prototype,"_enableLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kdt=lt(Odt.prototype,"_lowerLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Udt=lt(Odt.prototype,"_upperLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mdt=Odt))||Mdt)||Mdt),t("FixedJoint2D",pc("cc.FixedJoint2D")(Gdt=wc()((lt((Hdt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.FIXED,ct(e,"_frequency",jdt,ot(e)),ct(e,"_dampingRatio",Wdt,ot(e)),e}return $(e,t),Q(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(fmt)).prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(Hdt.prototype,"frequency"),Hdt.prototype),lt(Hdt.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(Hdt.prototype,"dampingRatio"),Hdt.prototype),jdt=lt(Hdt.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Wdt=lt(Hdt.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Gdt=Hdt))||Gdt)||Gdt),t("WheelJoint2D",pc("cc.WheelJoint2D")(qdt=wc()((lt((Xdt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.WHEEL,ct(e,"_angle",Ydt,ot(e)),ct(e,"_enableMotor",Kdt,ot(e)),ct(e,"_maxMotorTorque",Jdt,ot(e)),ct(e,"_motorSpeed",Qdt,ot(e)),ct(e,"_frequency",Zdt,ot(e)),ct(e,"_dampingRatio",$dt,ot(e)),e}return $(e,t),Q(e,[{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(fmt)).prototype,"angle",[gc],Object.getOwnPropertyDescriptor(Xdt.prototype,"angle"),Xdt.prototype),lt(Xdt.prototype,"enableMotor",[gc],Object.getOwnPropertyDescriptor(Xdt.prototype,"enableMotor"),Xdt.prototype),lt(Xdt.prototype,"maxMotorTorque",[gc],Object.getOwnPropertyDescriptor(Xdt.prototype,"maxMotorTorque"),Xdt.prototype),lt(Xdt.prototype,"motorSpeed",[gc],Object.getOwnPropertyDescriptor(Xdt.prototype,"motorSpeed"),Xdt.prototype),lt(Xdt.prototype,"frequency",[gc],Object.getOwnPropertyDescriptor(Xdt.prototype,"frequency"),Xdt.prototype),lt(Xdt.prototype,"dampingRatio",[gc],Object.getOwnPropertyDescriptor(Xdt.prototype,"dampingRatio"),Xdt.prototype),Ydt=lt(Xdt.prototype,"_angle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),Kdt=lt(Xdt.prototype,"_enableMotor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jdt=lt(Xdt.prototype,"_maxMotorTorque",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Qdt=lt(Xdt.prototype,"_motorSpeed",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zdt=lt(Xdt.prototype,"_frequency",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),$dt=lt(Xdt.prototype,"_dampingRatio",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),qdt=Xdt))||qdt)||qdt),t("HingeJoint2D",pc("cc.HingeJoint2D")(tmt=wc()((lt((emt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).TYPE=xft.HINGE,ct(e,"_enableLimit",imt,ot(e)),ct(e,"_lowerAngle",nmt,ot(e)),ct(e,"_upperAngle",rmt,ot(e)),ct(e,"_enableMotor",omt,ot(e)),ct(e,"_maxMotorTorque",amt,ot(e)),ct(e,"_motorSpeed",smt,ot(e)),e}return $(e,t),Q(e,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}]),e}(fmt)).prototype,"enableLimit",[gc],Object.getOwnPropertyDescriptor(emt.prototype,"enableLimit"),emt.prototype),lt(emt.prototype,"lowerAngle",[gc],Object.getOwnPropertyDescriptor(emt.prototype,"lowerAngle"),emt.prototype),lt(emt.prototype,"upperAngle",[gc],Object.getOwnPropertyDescriptor(emt.prototype,"upperAngle"),emt.prototype),lt(emt.prototype,"enableMotor",[gc],Object.getOwnPropertyDescriptor(emt.prototype,"enableMotor"),emt.prototype),lt(emt.prototype,"maxMotorTorque",[gc],Object.getOwnPropertyDescriptor(emt.prototype,"maxMotorTorque"),emt.prototype),lt(emt.prototype,"motorSpeed",[gc],Object.getOwnPropertyDescriptor(emt.prototype,"motorSpeed"),emt.prototype),imt=lt(emt.prototype,"_enableLimit",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nmt=lt(emt.prototype,"_lowerAngle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rmt=lt(emt.prototype,"_upperAngle",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),omt=lt(emt.prototype,"_enableMotor",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),amt=lt(emt.prototype,"_maxMotorTorque",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),smt=lt(emt.prototype,"_motorSpeed",[gc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tmt=emt))||tmt)||tmt),t("Physics2DUtils",{PolygonSeparator:jft}),function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._type=bft.Closest,e._fixtures=[],e._points=[],e._normals=[],e._fractions=[],e._mask=4294967295,e}$(e,t);var i=e.prototype;return i.init=function(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0},i.ReportFixture=function(t,e,i,n){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===bft.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=i,this._fractions[0]=n,n):(this._fixtures.push(t),this._points.push(new qi(e.x,e.y)),this._normals.push(new qi(i.x,i.y)),this._fractions.push(n),this._type===bft.Any?0:this._type>=bft.All?1:n)},i.getFixtures=function(){return this._fixtures},i.getPoints=function(){return this._points},i.getNormals=function(){return this._normals},i.getFractions=function(){return this._fractions},e}(Cft.RayCastCallback)),gmt=[],ymt=[new qi,new qi],xmt=new Cft.WorldManifold,Smt={points:[],separations:[],normal:new qi},bmt=function(){this.localPoint=new qi,this.normalImpulse=0,this.tangentImpulse=0},Cmt=[new bmt,new bmt],Amt={type:0,localPoint:new qi,localNormal:new qi,points:[]},Tmt={normalImpulses:[],tangentImpulses:[]},wmt=function(){function t(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}t.get=function(e){var i=gmt.pop();return i||(i=new t),i.init(e),i},t.put=function(t){var e=t.m_userData;e&&(gmt.push(e),e.reset())};var e=t.prototype;return e._setImpulse=function(t){this._impulse=t},e.init=function(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this},e.reset=function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null},e.getWorldManifold=function(){var t=Smt.points,e=Smt.separations,i=Smt.normal;this._b2contact.GetWorldManifold(xmt);var n=xmt.points,r=xmt.separations,o=this._b2contact.GetManifold().pointCount;t.length=e.length=o;for(var a=0;a<o;a++){var s=ymt[a];s.x=n[a].x*wft,s.y=n[a].y*wft,t[a]=s,e[a]=r[a]*wft}return i.x=xmt.normal.x,i.y=xmt.normal.y,this._inverted&&(i.x*=-1,i.y*=-1),Smt},e.getManifold=function(){for(var t=Amt.points,e=Amt.localNormal,i=Amt.localPoint,n=this._b2contact.GetManifold(),r=n.points,o=t.length=n.pointCount,a=0;a<o;a++){var s=Cmt[a],c=r[a];s.localPoint.x=c.localPoint.x*wft,s.localPoint.y=c.localPoint.y*wft,s.normalImpulse=c.normalImpulse*wft,s.tangentImpulse=c.tangentImpulse,t[a]=s}return i.x=n.localPoint.x*wft,i.y=n.localPoint.y*wft,e.x=n.localNormal.x,e.y=n.localNormal.y,Amt.type=n.type,this._inverted&&(e.x*=-1,e.y*=-1),Amt},e.getImpulse=function(){var t=this._impulse;if(!t)return null;for(var e=Tmt.normalImpulses,i=Tmt.tangentImpulses,n=t.count,r=0;r<n;r++)e[r]=t.normalImpulses[r]*wft,i[r]=t.tangentImpulses[r];return i.length=e.length=n,Tmt},e.emit=function(t){var e=this.colliderA,i=this.colliderB,n=e.body,r=i.body;n.enabledContactListener&&(null==e||e.emit(t,e,i,this)),r.enabledContactListener&&(null==i||i.emit(t,i,e,this)),(n.enabledContactListener||r.enabledContactListener)&&Cpt.instance.emit(t,e,i,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)},e.setEnabled=function(t){this._b2contact.SetEnabled(t)},e.isTouching=function(){return this._b2contact.IsTouching()},e.setTangentSpeed=function(t){this._b2contact.SetTangentSpeed(t)},e.getTangentSpeed=function(){return this._b2contact.GetTangentSpeed()},e.setFriction=function(t){this._b2contact.SetFriction(t)},e.getFriction=function(){return this._b2contact.GetFriction()},e.resetFriction=function(){return this._b2contact.ResetFriction()},e.setRestitution=function(t){this._b2contact.SetRestitution(t)},e.getRestitution=function(){return this._b2contact.GetRestitution()},e.resetRestitution=function(){return this._b2contact.ResetRestitution()},t}(),Emt=new Cft.Vec2,Pmt=new Ti,Imt=Ti.GREEN,Rmt=Ti.RED,Dmt=function(t){function e(e){var i;return(i=t.call(this)||this)._drawer=null,i._xf=new Cft.Transform,i._dxf=new Cft.Transform,i._drawer=e,i}$(e,t);var i=e.prototype;return i._DrawPolygon=function(t,e){for(var i=this._drawer,n=0;n<e;n++){Cft.Transform.MulXV(this._xf,t[n],Emt);var r=Emt.x*wft,o=Emt.y*wft;0===n?i.moveTo(r,o):i.lineTo(r,o)}i.close()},i.DrawPolygon=function(t,e,i){this._applyStrokeColor(i),this._DrawPolygon(t,e),this._drawer.stroke()},i.DrawSolidPolygon=function(t,e,i){this._applyFillColor(i),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()},i._DrawCircle=function(t,e){var i=this._xf.p;this._drawer.circle((t.x+i.x)*wft,(t.y+i.y)*wft,e*wft)},i.DrawCircle=function(t,e,i){this._applyStrokeColor(i),this._DrawCircle(t,e),this._drawer.stroke()},i.DrawSolidCircle=function(t,e,i,n){this._applyFillColor(n),this._DrawCircle(t,e),this._drawer.fill()},i.DrawSegment=function(t,e,i){var n=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(i),this._DrawCircle(t,2/wft),void n.fill();this._applyStrokeColor(i),Cft.Transform.MulXV(this._xf,t,Emt),n.moveTo(Emt.x*wft,Emt.y*wft),Cft.Transform.MulXV(this._xf,e,Emt),n.lineTo(Emt.x*wft,Emt.y*wft),n.stroke()},i.DrawTransform=function(t){var e=this._drawer;e.strokeColor=Rmt,Emt.x=Emt.y=0,Cft.Transform.MulXV(t,Emt,Emt),e.moveTo(Emt.x*wft,Emt.y*wft),Emt.x=1,Emt.y=0,Cft.Transform.MulXV(t,Emt,Emt),e.lineTo(Emt.x*wft,Emt.y*wft),e.stroke(),e.strokeColor=Imt,Emt.x=Emt.y=0,Cft.Transform.MulXV(t,Emt,Emt),e.moveTo(Emt.x*wft,Emt.y*wft),Emt.x=0,Emt.y=1,Cft.Transform.MulXV(t,Emt,Emt),e.lineTo(Emt.x*wft,Emt.y*wft),e.stroke()},i.DrawPoint=function(){},i.DrawParticles=function(){},i._applyStrokeColor=function(t){this._drawer.strokeColor=Pmt.set(255*t.r,255*t.g,255*t.b,150)},i._applyFillColor=function(t){this._drawer.fillColor=Pmt.set(255*t.r,255*t.g,255*t.b,150)},i.PushTransform=function(t){this._xf=t},i.PopTransform=function(){this._xf=this._dxf},e}(Cft.Draw),Mmt=new Ei,Omt=new qi,Bmt=new qi,Nmt=new Cft.BodyDef,Lmt=new Cft.AABB,Fmt=[],zmt=function(){function t(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new Ei,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new Cft.World(new Cft.Vec2(0,-10));var t=new Eft;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new Pft,this._raycastQueryCallback=new vmt}var e=t.prototype;return e._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var t=bD("Canvas");if(!t){var e=HO.getScene();if(!e)return;(t=new jT("Canvas")).addComponent(sK),t.parent=e}var i=new jT("PHYSICS_2D_DEBUG_DRAW");i.hideFlags|=pl.Flags.DontSave,i.parent=t,i.worldPosition=Ei.ZERO,i.layer=Np.Enum.UI_2D,this._debugGraphics=i.addComponent(Gq),this._debugGraphics.lineWidth=2;var n=new Dmt(this._debugGraphics);this._b2DebugDrawer=n,this._world.SetDebugDraw(n)}var r=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(r.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)},e.setGravity=function(t){this._world.SetGravity(t)},e.setAllowSleep=function(){this._world.SetAllowSleeping(!0)},e.step=function(t,e,i){void 0===e&&(e=10),void 0===i&&(i=10);for(var n=this._animatedBodies,r=0,o=n.length;r<o;r++)n[r].animate(t);this._world.Step(t,e,i)},e.raycast=function(t,e,i,n){if(t.equals(e))return[];i=i||bft.Closest,Omt.x=t.x/wft,Omt.y=t.y/wft,Bmt.x=e.x/wft,Bmt.y=e.y/wft;var r=this._raycastQueryCallback;r.init(i,n),this._world.RayCast(r,Omt,Bmt);var o=r.getFixtures();if(o.length>0){for(var a=r.getPoints(),s=r.getNormals(),c=r.getFractions(),l=[],u=0,h=o.length;u<h;u++){var _=o[u],f=_.m_userData,p=f.collider;if(i===bft.AllClosest){for(var d=void 0,m=0;m<l.length;m++)l[m].collider===p&&(d=l[m]);if(d){c[u]<d.fraction&&(d.fixtureIndex=f.getFixtureIndex(_),d.point.x=a[u].x*wft,d.point.y=a[u].y*wft,d.normal.x=s[u].x,d.normal.y=s[u].y,d.fraction=c[u]);continue}}l.push({collider:p,fixtureIndex:f.getFixtureIndex(_),point:new qi(a[u].x*wft,a[u].y*wft),normal:new qi(s[u].x,s[u].y),fraction:c[u]})}return l}return[]},e.syncPhysicsToScene=function(){for(var t=this._bodies,e=0,i=t.length;e<i;e++){var n=t[e],r=n.rigidBody;if(r.type!==gft.Animated){var o=r.node,a=n.impl,s=a.GetPosition();Mmt.x=s.x*wft,Mmt.y=s.y*wft,Mmt.z=0,o.worldPosition=Mmt;var c=ui(a.GetAngle());o.setWorldRotationFromEuler(0,0,c)}else n.resetVelocity()}},e.syncSceneToPhysics=function(){for(var t=this._bodies,e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()},e.addBody=function(t){if(!this._bodies.includes(t)){var e=Nmt,i=t.rigidBody;e.allowSleep=i.allowSleep,e.gravityScale=i.gravityScale,e.linearDamping=i.linearDamping,e.angularDamping=i.angularDamping,e.fixedRotation=i.fixedRotation,e.bullet=i.bullet;var n=i.node,r=n.worldPosition;e.position.Set(r.x/wft,r.y/wft),Mmt.z=Bi.getAxisAngle(this._rotationAxis,n.worldRotation),e.angle=Mmt.z,e.awake=i.awakeOnLoad,i.type===gft.Animated?(e.type=gft.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=i.type;var o=i,a=o._linearVelocity;e.linearVelocity.Set(a.x,a.y),e.angularVelocity=li(o._angularVelocity);var s=this._world.CreateBody(e);s.m_userData=t,t._imp=s,this._bodies.push(t)}},e.removeBody=function(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),ie.remove(this._bodies,t),t.rigidBody.type===gft.Animated&&ie.remove(this._animatedBodies,t))},e.registerContactFixture=function(t){this._contactListener.registerContactFixture(t)},e.unregisterContactFixture=function(t){this._contactListener.unregisterContactFixture(t)},e.testPoint=function(t){var e=Omt.x=t.x/wft,i=Omt.y=t.y/wft,n=.2/wft;Lmt.lowerBound.x=e-n,Lmt.lowerBound.y=i-n,Lmt.upperBound.x=e+n,Lmt.upperBound.y=i+n;var r=this._aabbQueryCallback;r.init(Omt),this._world.QueryAABB(r,Lmt);var o=r.getFixtures();Fmt.length=0;for(var a=0;a<o.length;a++){var s=o[a].m_userData.collider;Fmt.includes(s)||Fmt.push(s)}return Fmt},e.testAABB=function(t){Lmt.lowerBound.x=t.xMin/wft,Lmt.lowerBound.y=t.yMin/wft,Lmt.upperBound.x=t.xMax/wft,Lmt.upperBound.y=t.yMax/wft;var e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,Lmt);var i=e.getFixtures();Fmt.length=0;for(var n=0;n<i.length;n++){var r=i[n].m_userData.collider;Fmt.includes(r)||Fmt.push(r)}return Fmt},e.drawDebug=function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())},e._onBeginContact=function(t){wmt.get(t).emit(Tft.BEGIN_CONTACT)},e._onEndContact=function(t){var e=t.m_userData;e&&(e.emit(Tft.END_CONTACT),wmt.put(t))},e._onPreSolve=function(t){var e=t.m_userData;e&&e.emit(Tft.PRE_SOLVE)},e._onPostSolve=function(t,e){var i=t.m_userData;i&&(i._setImpulse(e),i.emit(Tft.POST_SOLVE),i._setImpulse(null))},Q(t,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}}]),t}(),Vmt=(new Ei,new Cft.Vec2),kmt=function(){function t(){this._animatedPos=new qi,this._animatedAngle=0,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._rigidBody=t,Cpt.instance._callAfterStep(this,this._init)},e.onDestroy=function(){Cpt.instance._callAfterStep(this,this._destroy)},e.onEnable=function(){this.setActive(!0)},e.onDisable=function(){this.setActive(!1)},e._registerNodeEvents=function(){this.rigidBody.node.on(GC.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._unregisterNodeEvents=function(){this.rigidBody.node.off(GC.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._onNodeTransformChanged=function(t){if(!Cpt.instance.stepping){if(t&jT.TransformBit.SCALE)for(var e=this.rigidBody.getComponents(_mt),i=0;i<e.length;i++)e[i].apply();t&jT.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&jT.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}},e._init=function(){this._inited||(this._registerNodeEvents(),Cpt.instance.physicsWorld.addBody(this),this._inited=!0)},e._destroy=function(){this._inited&&(Cpt.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)},e.animate=function(t){var e=this._body;if(e){var i=e.GetPosition();e.SetAwake(!0);var n=1/t;Vmt.x=(this._animatedPos.x-i.x)*n,Vmt.y=(this._animatedPos.y-i.y)*n,e.SetLinearVelocity(Vmt);var r=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-r)*n)}},e.syncPositionToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var i,n=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(i=r===gft.Animated?e.GetLinearVelocity():e.GetPosition()).x=n.x/wft,i.y=n.y/wft,r===gft.Animated&&t?this._animatedPos.set(i.x,i.y):e.SetTransformVec(i,e.GetAngle())}},e.syncRotationToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var i=li(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===gft.Animated&&t?this._animatedAngle=i:e.SetTransformVec(e.GetPosition(),i)}},e.resetVelocity=function(){var t=this._body;if(t){var e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}},e.setType=function(t){this._body.SetType(t)},e.setLinearDamping=function(t){this._body.SetLinearDamping(t)},e.setAngularDamping=function(t){this._body.SetAngularDamping(t)},e.setGravityScale=function(t){this._body.SetGravityScale(t)},e.setFixedRotation=function(t){this._body.SetFixedRotation(t)},e.setAllowSleep=function(t){this._body.SetSleepingAllowed(t)},e.isActive=function(){return this._body.IsActive()},e.setActive=function(t){this._body.SetActive(t)},e.wakeUp=function(){this._body.SetAwake(!0)},e.sleep=function(){this._body.SetAwake(!1)},e.getMass=function(){return this._body.GetMass()},e.setLinearVelocity=function(t){this._body.SetLinearVelocity(t)},e.getLinearVelocity=function(t){var e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t},e.getLinearVelocityFromWorldPoint=function(t,e){return Vmt.Set(t.x/wft,t.y/wft),this._body.GetLinearVelocityFromWorldPoint(Vmt,e),e.x*=wft,e.y*=wft,e},e.setAngularVelocity=function(t){this._body.SetAngularVelocity(t)},e.getAngularVelocity=function(){return ui(this._body.GetAngularVelocity())},e.getLocalVector=function(t,e){return e=e||new qi,Vmt.Set(t.x/wft,t.y/wft),this._body.GetLocalVector(Vmt,e),e.x*=wft,e.y*=wft,e},e.getWorldVector=function(t,e){return Vmt.Set(t.x/wft,t.y/wft),this._body.GetWorldVector(Vmt,e),e.x*=wft,e.y*=wft,e},e.getLocalPoint=function(t,e){return e=e||new qi,Vmt.Set(t.x/wft,t.y/wft),this._body.GetLocalPoint(Vmt,e),e.x*=wft,e.y*=wft,e},e.getWorldPoint=function(t,e){return e=e||new qi,Vmt.Set(t.x/wft,t.y/wft),this._body.GetWorldPoint(Vmt,e),e.x*=wft,e.y*=wft,e},e.getLocalCenter=function(t){t=t||new qi;var e=this._body.GetLocalCenter();return t.x=e.x*wft,t.y=e.y*wft,t},e.getWorldCenter=function(t){t=t||new qi;var e=this._body.GetWorldCenter();return t.x=e.x*wft,t.y=e.y*wft,t},e.getInertia=function(){return this._body.GetInertia()},e.applyForce=function(t,e,i){this._body&&(Vmt.Set(e.x/wft,e.y/wft),this._body.ApplyForce(t,Vmt,i))},e.applyForceToCenter=function(t,e){this._body&&this._body.ApplyForceToCenter(t,e)},e.applyTorque=function(t,e){this._body&&this._body.ApplyTorque(t,e)},e.applyLinearImpulse=function(t,e,i){this._body&&(Vmt.Set(e.x/wft,e.y/wft),this._body.ApplyLinearImpulse(t,Vmt,i))},e.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)},e.applyAngularImpulse=function(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)},Q(t,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(t){this._body=t}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}}]),t}(),Umt=new Cft.Filter;function Gmt(t){var e=t.collider;return Umt.categoryBits=e.group===$ft.DEFAULT?e.body.group:e.group,Umt.maskBits=Cpt.instance.collisionMatrix[Umt.categoryBits],Umt}var Hmt,jmt=function(){function t(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new en}var e=t.prototype;return e.initialize=function(t){this._collider=t},e.onLoad=function(){},e.onEnable=function(){Cpt.instance._callAfterStep(this,this._init)},e.onDisable=function(){Cpt.instance._callAfterStep(this,this._destroy)},e.start=function(){},e.onGroupChanged=function(){var t=Gmt(this);this._fixtures.forEach((function(e){e.SetFilterData(t)}))},e.apply=function(){this._destroy(),this._init()},e.getFixtureIndex=function(t){return this._fixtures.indexOf(t)},e._createShapes=function(){return[]},e._init=function(){var t;if(!this._inited){var e=this.collider,i=e.getComponent(hmt);if(i){var n=null===(t=i.impl)||void 0===t?void 0:t.impl;if(n){for(var r=i.node.worldScale,o=0===r.x&&0===r.y?[]:this._createShapes(r.x,r.y),a=Gmt(this),s=0;s<o.length;s++){var c=o[s],l={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:c,filter:a},u=n.CreateFixture(l);u.m_userData=this,i.enabledContactListener&&Cpt.instance.physicsWorld.registerContactFixture(u),this._shapes.push(c),this._fixtures.push(u)}this._body=n,this._inited=!0}}}},e._destroy=function(){if(this._inited){for(var t=this._fixtures,e=this._body,i=t.length-1;i>=0;i--){var n=t[i];n.m_userData=null,Cpt.instance.physicsWorld.unregisterContactFixture(n),e&&e.DestroyFixture(n)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}},Q(t,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){for(var t=1e7,e=t,i=t,n=-t,r=-t,o=this._fixtures,a=0;a<o.length;a++)for(var s=o[a],c=s.GetShape().GetChildCount(),l=0;l<c;l++){var u=s.GetAABB(l);u.lowerBound.x<e&&(e=u.lowerBound.x),u.lowerBound.y<i&&(i=u.lowerBound.y),u.upperBound.x>n&&(n=u.upperBound.x),u.upperBound.y>r&&(r=u.upperBound.y)}e*=wft,i*=wft,n*=wft,r*=wft;var h=this._rect;return h.x=e,h.y=i,h.width=n-e,h.height=r-i,h}}]),t}(),Wmt=new en,qmt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._worldPoints=[new qi,new qi,new qi,new qi],e}return $(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var i=this.collider,n=i.size.width/2/wft*t,r=i.size.height/2/wft*e,o=i.offset.x/wft*t,a=i.offset.y/wft*e,s=new Cft.PolygonShape;return s.SetAsBox(n,r,new Cft.Vec2(o,a),0),[s]},Q(e,[{key:"worldPoints",get:function(){var t=Wmt,e=this.collider,i=e.size,n=e.offset;t.x=n.x-i.width/2,t.y=n.y-i.height/2,t.width=i.width,t.height=i.height;var r=this._worldPoints,o=r[0],a=r[1],s=r[2],c=r[3];return t.transformMat4ToPoints(e.node.worldMatrix,o,a,s,c),r}}]),e}(jmt),Xmt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._worldPosition=new qi,e}return $(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var i=this.collider,n=i.offset.x/wft*t,r=i.offset.y/wft*e,o=new Cft.CircleShape;return o.m_radius=i.radius/wft*t,o.m_p.Set(n,r),[o]},Q(e,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*wft}},{key:"worldPosition",get:function(){var t=this._shapes[0].m_p;return this._worldPosition.set(t.x*wft,t.y*wft)}}]),e}(jmt),Ymt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._worldPoints=[],e}return $(e,t),e.prototype._createShapes=function(t,e){var i=[],n=this.collider,r=n.points;r.length>0&&r[0].equals(r[r.length-1])&&(r.length-=1);for(var o=Dft(r),a=n.offset,s=0;s<o.length;s++){for(var c=o[s],l=null,u=[],h=null,_=0,f=c.length;_<f;_++){l||(l=new Cft.PolygonShape);var p=c[_],d=(p.x+a.x)/wft*t,m=(p.y+a.y)/wft*e,v=new Cft.Vec2(d,m);u.push(v),h||(h=v),u.length===Cft.maxPolygonVertices&&(l.Set(u,u.length),i.push(l),l=null,_<f-1&&(u=[h,u[u.length-1]]))}l&&(l.Set(u,u.length),i.push(l))}return i},Q(e,[{key:"worldPoints",get:function(){for(var t=this.collider,e=t.points,i=this._worldPoints,n=t.node.worldMatrix,r=0;r<e.length;r++)i[r]||(i[r]=new qi),qi.transformMat4(i[r],e[r],n);return i.length=e.length,this._worldPoints}}]),e}(jmt),Kmt=function(){function t(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._jointComp=t},e.onEnable=function(){Cpt.instance._callAfterStep(this,this._init)},e.onDisable=function(){Cpt.instance._callAfterStep(this,this._destroy)},e.start=function(){Cpt.instance._callAfterStep(this,this._init)},e._init=function(){if(!this._inited){var t=this._jointComp;if(t.isValid){this._body=t.getComponent(hmt);var e=this._createJointDef();if(e){var i=t.connectedBody;i&&i.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=i.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=Cpt.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}}}},e._destroy=function(){this._inited&&(Cpt.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)},e._createJointDef=function(){return null},e.isValid=function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl},Q(t,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}}]),t}(),Jmt=new Cft.Vec2;Hmt={PhysicsWorld:zmt,RigidBody:kmt,BoxShape:qmt,CircleShape:Xmt,PolygonShape:Ymt,MouseJoint:function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._touchPoint=new qi,e._isTouched=!1,e}$(e,t);var i=e.prototype;return i.setTarget=function(t){this._b2joint&&(Jmt.x=t.x/wft,Jmt.y=t.y/wft,this._b2joint.SetTarget(Jmt))},i.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},i.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},i.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},i._createJointDef=function(){var t=new Cft.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/wft,this._touchPoint.y/wft),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t},i.initialize=function(e){t.prototype.initialize.call(this,e);var i=bD("Canvas");i&&(i.on(GC.TOUCH_START,this.onTouchBegan,this),i.on(GC.TOUCH_MOVE,this.onTouchMove,this),i.on(GC.TOUCH_END,this.onTouchEnd,this),i.on(GC.TOUCH_CANCEL,this.onTouchEnd,this))},i.onEnable=function(){},i.start=function(){},i.onTouchBegan=function(t){this._isTouched=!0;var e=this._touchPoint.set(t.getUILocation()),i=Cpt.instance.physicsWorld.testPoint(e);if(!(i.length<=0)){var n=i[0].body;n.wakeUp();var r=this._jointComp;r.connectedBody=n,this._init(),this.setMaxForce(r.maxForce*n.getMass()),this.setTarget(e)}},i.onTouchMove=function(t){this._touchPoint=t.getUILocation()},i.onTouchEnd=function(){this._destroy(),this._isTouched=!1},i.update=function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)},e}(Kmt),DistanceJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.setMaxLength=function(t){this._b2joint&&this._b2joint.SetMaxLength(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/wft,t.anchor.y/wft),e.localAnchorB.Set(t.connectedAnchor.x/wft,t.connectedAnchor.y/wft),e.maxLength=t.maxLength/wft,e},e}(Kmt),SpringJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},i.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},i.setDistance=function(t){this._b2joint&&this._b2joint.SetLength(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/wft,t.anchor.y/wft),e.localAnchorB.Set(t.connectedAnchor.x/wft,t.connectedAnchor.y/wft),e.length=t.distance/wft,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(Kmt),RelativeJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},i.setAngularOffset=function(t){this._b2joint&&this._b2joint.SetAngularOffset(li(t))},i.setLinearOffset=function(t){this._b2joint&&this._b2joint.SetLinearOffset(new Cft.Vec2(t.x/wft,t.y/wft))},i.setCorrectionFactor=function(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)},i.setMaxTorque=function(t){this._b2joint&&this._b2joint.SetMaxTorque(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/wft,t.linearOffset.y/wft),e.angularOffset=li(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e},e}(Kmt),SliderJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},i.setLowerLimit=function(){this.updateLimits()},i.setUpperLimit=function(){this.updateLimits()},i.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/wft,t.upperLimit/wft)}},i.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},i.setMaxMotorForce=function(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)},i.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/wft,t.anchor.y/wft),e.localAnchorB.Set(t.connectedAnchor.x/wft,t.connectedAnchor.y/wft);var i=li(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/wft,e.upperTranslation=t.upperLimit/wft,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e},e}(Kmt),FixedJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},i.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/wft,t.anchor.y/wft),e.localAnchorB.Set(t.connectedAnchor.x/wft,t.connectedAnchor.y/wft),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e},e}(Kmt),WheelJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)},i.setFrequency=function(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)},i.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},i.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},i.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.WheelJointDef;e.localAnchorA.Set(t.anchor.x/wft,t.anchor.y/wft),e.localAnchorB.Set(t.connectedAnchor.x/wft,t.connectedAnchor.y/wft);var i=li(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=li(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(Kmt),HingeJoint:function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},i.setLowerAngle=function(){this.updateLimits()},i.setUpperAngle=function(){this.updateLimits()},i.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(li(t.lowerAngle),li(t.upperAngle))}},i.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},i.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},i.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},i._createJointDef=function(){var t=this._jointComp,e=new Cft.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/wft,t.anchor.y/wft),e.localAnchorB.Set(t.connectedAnchor.x/wft,t.connectedAnchor.y/wft),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=li(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e},e}(Kmt)},hft="box2d",u._global.CC_PHYSICS_2D_BUILTIN=!1,u._global.CC_PHYSICS_2D_BOX2D=!0,uft=Hmt;var Qmt,Zmt=function(){function t(t,e,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}var e=t.prototype;return e.sample=function(t){this._average(this._value,t)},e.human=function(){var t=this._opts,e=t.average,i=t.isInteger,n=e?this._averageValue:this._value;return i?Math.round(n):Math.round(100*n)/100},e.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},e._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}},Q(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),$mt=pc("cc.PerfCounter")(Qmt=function(t){function e(e,i,n){var r;return(r=t.call(this,e,i,n)||this)._time=void 0,r._time=n,r}$(e,t);var i=e.prototype;return i.start=function(t){void 0===t&&(t=0),this._time=t},i.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},i.tick=function(){this.end(),this.start()},i.frame=function(t){var e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))},e}(Zmt))||Qmt,tvt="0123456789. ",evt=500,ivt={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},nvt={fps:{desc:"Framerate (FPS)",below:30,average:evt,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:evt},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:evt,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:evt},render:{desc:"Renderer (ms)",min:0,max:50,average:evt,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},rvt=t("Profiler",function(){function t(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new or,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(nvt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var e=t.prototype;return e.reset=function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(nvt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0},e.isShowingStats=function(){return this._showFPS},e.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),u.director.off(u.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),u.director.off(u.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),u.director.off(u.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),u.director.off(u.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),u.director.off(u.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),u.director.off(u.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,u.game.config.showFPS=!1)},e.showStats=function(){if(!this._showFPS){if(!this._device){var t=u.director.root;this._device=t.device,this._swapchain=t.mainWindow.swapchain,this._pipeline=t.pipeline}this.generateCanvas(),this.generateStats(),u.game.once(u.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),u.director.on(u.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),u.director.on(u.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),u.director.on(u.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),u.director.on(u.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),u.director.on(u.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),u.director.on(u.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,u.game.config.showFPS=!0}},e.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new mr(yn.TEX2D,xn.SAMPLED|xn.TRANSFER_DST,_n.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},e.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var t=performance.now();this._ctx.textAlign="left";var e=0;for(var i in nvt){var n=nvt[i];this._ctx.fillText(n.desc,0,e*this._lineHeight),n.counter=new $mt(i,n,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<tvt.length;++r){var o=this._ctx.measureText(tvt[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<tvt.length;++a)this._ctx.fillText(tvt[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=nvt,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},e.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new jT("PROFILER_NODE"),u.game.addPersistRootNode(this._rootNode);var t=new jT("Profiler_Root");t.parent=this._rootNode;for(var e=.4,i=e/this._totalLines,n=e/this._wordHeight,r=i/23,o=this._eachNumWidth*this._canvas.width*r,a=[0,e,0,n,e,0,n,0,0,0,0,0],s=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],l=0,h=0;h<this._totalLines;h++)for(var _=0;_<8;_++){a.push(n+_*o,e-h*i,0),a.push(n+(_+1)*o,e-h*i,0),a.push(n+(_+1)*o,e-(h+1)*i,0),a.push(n+_*o,e-(h+1)*i,0),l=4*(8*h+_+1),s.push(0+l,2+l,1+l,0+l,3+l,2+l);var f=8*h+_,p=Math.floor(f/4),d=f-4*p;c.push(0,this._wordHeight,p,d),c.push(this._eachNumWidth,this._wordHeight,p,d),c.push(this._eachNumWidth,1,p,d),c.push(0,1,p,d)}this._meshRenderer=t.addComponent(Xtt),this._meshRenderer.mesh=V1({positions:a,indices:s,colors:c});var m=new cg;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),x=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=Np.Enum.PROFILER,this._inited=!0}},e.beforeUpdate=function(){if(this._stats){var t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}},e.afterUpdate=function(){if(this._stats){var t=performance.now();u.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}},e.beforePhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.start(t)}},e.afterPhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.end(t)}},e.beforeDraw=function(){if(this._stats&&this._inited){var t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){var i=Ui[t],n=-.9*e;this.offsetData[0]=-.9*i[0]+n*i[2],this.offsetData[1]=-.9*i[1]+n*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},e.afterDraw=function(){if(this._stats&&this._inited){var t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),!(t-this.lastTime<evt)){this.lastTime=t;var e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;var i=0,n=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(t);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*i+s,l=a[a.length-(8-s)],u=ivt[l];void 0===u&&(u=11),n[c]=u}i++}}}},t}()),ovt=t("profiler",new rvt);u.profiler=ovt;var avt=function(){function t(){this.originalTarget=null,this.target=null,this.tag=t.TAG_INVALID}var e=t.prototype;return e.clone=function(){var e=new t;return e.originalTarget=null,e.target=null,e.tag=this.tag,e},e.isDone=function(){return!0},e.startWithTarget=function(t){this.originalTarget=t,this.target=t},e.stop=function(){this.target=null},e.step=function(){I(1006)},e.update=function(){I(1007)},e.getTarget=function(){return this.target},e.setTarget=function(t){this.target=t},e.getOriginalTarget=function(){return this.originalTarget},e.setOriginalTarget=function(t){this.originalTarget=t},e.getTag=function(){return this.tag},e.setTag=function(t){this.tag=t},e.reverse=function(){return I(1008),null},e.retain=function(){},e.release=function(){},t}();avt.TAG_INVALID=-1;var svt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._duration=0,e._timesForRepeat=1,e}$(e,t);var i=e.prototype;return i.getDuration=function(){return this._duration*(this._timesForRepeat||1)},i.setDuration=function(t){this._duration=t},i.clone=function(){return new e},e}(avt),cvt=(function(t){function e(e,i){var n;return void 0===i&&(i=1),(n=t.call(this)||this)._speed=0,n._innerAction=null,e&&n.initWithAction(e,i),n}$(e,t);var i=e.prototype;i.getSpeed=function(){return this._speed},i.setSpeed=function(t){this._speed=t},i.initWithAction=function(t,e){return t?(this._innerAction=t,this._speed=e,!0):(O(1021),!1)},i.clone=function(){var t=new e;return t.initWithAction(this._innerAction.clone(),this._speed),t},i.startWithTarget=function(t){avt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},i.stop=function(){this._innerAction.stop(),avt.prototype.stop.call(this)},i.step=function(t){this._innerAction.step(t*this._speed)},i.isDone=function(){return this._innerAction.isDone()},i.reverse=function(){return new e(this._innerAction.reverse(),this._speed)},i.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},i.getInnerAction=function(){return this._innerAction}}(avt),0),lvt=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},uvt=function(){function t(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var e=t.prototype;return e._searchElementByTarget=function(t,e){for(var i=0;i<t.length;i++)if(e===t[i].target)return t[i];return null},e._getElement=function(t,e){var i=this._elementPool.pop();return i||(i=new lvt),i.target=t,i.paused=!!e,i},e._putElement=function(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)},e.addAction=function(t,e,i){if(t&&e){null==e.uuid&&(e.uuid="_TWEEN_UUID_"+cvt++);var n=this._hashTargets.get(e);n?n.actions||(n.actions=[]):(n=this._getElement(e,i),this._hashTargets.set(e,n),this._arrayTargets.push(n)),n.target=e,n.actions.push(t),t.startWithTarget(e)}else O(1e3)},e.removeAllActions=function(){for(var t=this._arrayTargets,e=0;e<t.length;e++){var i=t[e];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map},e.removeAllActionsFromTarget=function(t){if(null!=t){var e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}},e.removeAction=function(t){if(null!=t){var e=t.getOriginalTarget(),i=this._hashTargets.get(e);if(i)for(var n=0;n<i.actions.length;n++)if(i.actions[n]===t){i.actions.splice(n,1),i.actionIndex>=n&&i.actionIndex--;break}}},e._removeActionByTag=function(t,e,i){for(var n=0,r=e.actions.length;n<r;++n){var o=e.actions[n];if(o&&o.getTag()===t){if(i&&o.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,e);break}}},e._removeAllActionsByTag=function(t,e,i){for(var n=e.actions.length-1;n>=0;--n){var r=e.actions[n];if(r&&r.getTag()===t){if(i&&r.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,e)}}},e.removeActionByTag=function(t,e){var i=this;t===avt.TAG_INVALID&&I(1002);var n=this._hashTargets;if(e){var r=n.get(e);r&&this._removeActionByTag(t,r,e)}else n.forEach((function(e){i._removeActionByTag(t,e)}))},e.removeAllActionsByTag=function(t,e){var i=this;t===avt.TAG_INVALID&&I(1002);var n=this._hashTargets;if(e){var r=n.get(e);r&&this._removeAllActionsByTag(t,r,e)}else n.forEach((function(e){i._removeAllActionsByTag(t,e)}))},e.getActionByTag=function(t,e){t===avt.TAG_INVALID&&I(1004);var i=this._hashTargets.get(e);if(i){if(null!=i.actions)for(var n=0;n<i.actions.length;++n){var r=i.actions[n];if(r&&r.getTag()===t)return r}I(1005,t)}return null},e.getNumberOfRunningActionsInTarget=function(t){var e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0},e.pauseTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!0)},e.resumeTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!1)},e.pauseAllRunningActions=function(){for(var t=[],e=this._arrayTargets,i=0;i<e.length;i++){var n=e[i];n&&!n.paused&&(n.paused=!0,t.push(n.target))}return t},e.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])},e.pauseTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])},e.purgeSharedManager=function(){u.director.getScheduler().unscheduleUpdate(this)},e._removeActionAtIndex=function(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)},e._deleteHashElement=function(t){var e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);for(var i=this._arrayTargets,n=0,r=i.length;n<r;n++)if(i[n]===t){i.splice(n,1);break}this._putElement(t),e=!0}return e},e.update=function(t){for(var e,i=this._arrayTargets,n=0;n<i.length;n++){this._currentTarget=i[n];var r=(e=this._currentTarget).target;if(r instanceof pl&&!r.isValid)this.removeAllActionsFromTarget(r),n--;else{if(!e.paused&&e.actions){for(e.lock=!0,e.actionIndex=0;e.actionIndex<e.actions.length;e.actionIndex++)if(e.currentAction=e.actions[e.actionIndex],e.currentAction){if(e.currentAction.step(t*(e.currentAction._speedMethod?e.currentAction._speed:1)),e.currentAction&&e.currentAction.isDone()){e.currentAction.stop();var o=e.currentAction;e.currentAction=null,this.removeAction(o)}e.currentAction=null}e.lock=!1}0===e.actions.length&&this._deleteHashElement(e)&&n--}}},t}(),hvt=t("TweenSystem",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).actionMgr=new uvt,e}return $(e,t),e.prototype.update=function(t){this.actionMgr.update(t)},Q(e,[{key:"ActionManager",get:function(){return this.actionMgr}}]),e}(IO));hvt.ID="TWEEN",hvt.instance=void 0,HO.on(GO.EVENT_INIT,(function(){var t=new hvt;hvt.instance=t,HO.registerSystem(hvt.ID,t,IO.Priority.MEDIUM)}));var _vt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.isDone=function(){return!0},i.step=function(){this.update(1)},i.update=function(){},i.reverse=function(){return this.clone()},i.clone=function(){return new e},e}(svt),fvt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.update=function(){for(var t=this.target.getComponentsInChildren(fF),e=0;e<t.length;++e)t[e].enabled=!0},i.reverse=function(){return new pvt},i.clone=function(){return new e},e}(_vt),pvt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.update=function(){for(var t=this.target.getComponentsInChildren(fF),e=0;e<t.length;++e)t[e].enabled=!1},i.reverse=function(){return new fvt},i.clone=function(){return new e},e}(_vt);!function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;i.update=function(){for(var t=this.target.getComponentsInChildren(fF),e=0;e<t.length;++e){var i=t[e];i.enabled=!i.enabled}},i.reverse=function(){return new e},i.clone=function(){return new e}}(_vt);var dvt=function(t){function e(e){var i;return(i=t.call(this)||this)._isNeedCleanUp=!0,void 0!==e&&i.init(e),i}$(e,t);var i=e.prototype;return i.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},i.init=function(t){return this._isNeedCleanUp=t,!0},i.reverse=function(){return new e(this._isNeedCleanUp)},i.clone=function(){return new e(this._isNeedCleanUp)},e}(_vt),mvt=function(t){function e(e,i,n){var r;return(r=t.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(e,i,n),r}$(e,t);var i=e.prototype;return i.initWithFunction=function(t,e,i){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==i&&(this._data=i),!0},i.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},i.update=function(){this.execute()},i.getTargetCallback=function(){return this._selectorTarget},i.setTargetCallback=function(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)},i.clone=function(){var t=new e;return t.initWithFunction(this._function,this._selectorTarget,this._data),t},e}(_vt),vvt=function(t){function e(e){var i;return(i=t.call(this)||this).MAX_VALUE=2,i._elapsed=0,i._firstTick=!1,i._easeList=[],i._speed=1,i._repeatForever=!1,i._repeatMethod=!1,i._speedMethod=!1,void 0===e||isNaN(e)||i.initWithDuration(e),i}$(e,t);var i=e.prototype;return i.getElapsed=function(){return this._elapsed},i.initWithDuration=function(t){return this._duration=0===t?ue.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0},i.isDone=function(){return this._elapsed>=this._duration},i._cloneDecoration=function(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod},i._reverseEaseList=function(t){if(this._easeList){t._easeList=[];for(var e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}},i.clone=function(){var t=new e(this._duration);return this._cloneDecoration(t),t},i.easing=function(t){this._easeList?this._easeList.length=0:this._easeList=[];for(var e=0;e<arguments.length;e++)this._easeList.push(arguments[e]);return this},i._computeEaseTime=function(t){return t},i.step=function(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;var e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},i.startWithTarget=function(t){avt.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0},i.reverse=function(){return I(1010),this},i.setAmplitudeRate=function(){I(1011)},i.getAmplitudeRate=function(){return I(1012),0},i.speed=function(t){return t<=0?(I(1013),this):(this._speedMethod=!0,this._speed*=t,this)},i.getSpeed=function(){return this._speed},i.setSpeed=function(t){return this._speed=t,this},i.repeat=function(t){return t=Math.round(t),isNaN(t)||t<1?(I(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)},i.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},e}(svt),gvt=function(t){function e(i){var n;(n=t.call(this)||this)._actions=[],n._split=0,n._last=0,n._reversed=!1;var r=i instanceof Array?i:arguments;if(1===r.length)return O(1019),ot(n);var o=r.length-1;if(o>=0&&null==r[o]&&I(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));n.initWithTwoActions(s,r[o])}return n}$(e,t);var i=e.prototype;return i.initWithTwoActions=function(t,e){if(!t||!e)return O(1025),!1;var i=t._duration,n=e._duration,r=(i*=t._repeatMethod?t._timesForRepeat:1)+(n*=e._repeatMethod?e._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=t,this._actions[1]=e,!0},i.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t},i.startWithTarget=function(t){vvt.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},i.stop=function(){-1!==this._last&&this._actions[this._last].stop(),avt.prototype.stop.call(this)},i.update=function(t){var e,i,n=0,r=this._split,o=this._actions,a=this._last;(t=this._computeEaseTime(t))<r?(e=0!==r?t/r:1,0===n&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(n=1,e=1===r?1:(t-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),i=o[n],a===n&&i.isDone()||(a!==n&&i.startWithTarget(this.target),e*=i._timesForRepeat,i.update(e>1?e%1:e),this._last=n)},i.reverse=function(){var t=e._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t},e}(vvt);function yvt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return O(1019),null;var i=e.length-1;i>=0&&null==e[i]&&I(1015);var n=null;if(i>=0){n=e[0];for(var r=1;r<=i;r++)e[r]&&(n=gvt._actionOneTwo(n,e[r]))}return n}gvt._actionOneTwo=function(t,e){var i=new gvt;return i.initWithTwoActions(t,e),i};var xvt=function(t){function e(e,i){var n;return(n=t.call(this)||this)._times=0,n._total=0,n._nextDt=0,n._actionInstant=!1,n._innerAction=null,void 0!==i&&n.initWithAction(e,i),n}$(e,t);var i=e.prototype;return i.initWithAction=function(t,e){var i=t._duration*e;return!!this.initWithDuration(i)&&(this._times=e,this._innerAction=t,t instanceof _vt&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},i.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t},i.startWithTarget=function(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,vvt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},i.stop=function(){this._innerAction.stop(),avt.prototype.stop.call(this)},i.update=function(t){t=this._computeEaseTime(t);var e=this._innerAction,i=this._duration,n=this._times,r=this._nextDt;if(t>=r){for(;t>r&&this._total<n;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),r+=e._duration/i,this._nextDt=r>1?1:r;t>=1&&this._total<n&&(e.update(1),this._total++),this._actionInstant||(this._total===n?e.stop():e.update(t-(r-e._duration/i)))}else e.update(t*n%1)},i.isDone=function(){return this._total===this._times},i.reverse=function(){var t=new e(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t},i.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},i.getInnerAction=function(){return this._innerAction},e}(vvt),Svt=function(t){function e(e){var i;return(i=t.call(this)||this)._innerAction=null,e&&i.initWithAction(e),i}$(e,t);var i=e.prototype;return i.initWithAction=function(t){return t?(this._innerAction=t,!0):(O(1026),!1)},i.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t},i.startWithTarget=function(t){vvt.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},i.step=function(t){var e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))},i.isDone=function(){return!1},i.reverse=function(){var t=new e(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},i.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},i.getInnerAction=function(){return this._innerAction},e}(vvt),bvt=function(t){function e(i){var n;(n=t.call(this)||this)._one=null,n._two=null;var r=i instanceof Array?i:arguments;if(1===r.length)return O(1020),ot(n);var o=r.length-1;if(o>=0&&null==r[o]&&I(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));n.initWithTwoActions(s,r[o])}return n}$(e,t);var i=e.prototype;return i.initWithTwoActions=function(t,e){if(!t||!e)return O(1027),!1;var i=!1,n=t._duration,r=e._duration;return this.initWithDuration(Math.max(n,r))&&(this._one=t,this._two=e,n>r?this._two=gvt._actionOneTwo(e,Tvt(n-r)):n<r&&(this._one=gvt._actionOneTwo(t,Tvt(r-n))),i=!0),i},i.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t},i.startWithTarget=function(t){vvt.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)},i.stop=function(){this._one.stop(),this._two.stop(),avt.prototype.stop.call(this)},i.update=function(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)},i.reverse=function(){var t=e._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},e}(vvt);function Cvt(t){var e=t instanceof Array?t:arguments;if(1===e.length)return O(1020),null;e.length>0&&null==e[e.length-1]&&I(1015);for(var i=e[0],n=1;n<e.length;n++)null!=e[n]&&(i=bvt._actionOneTwo(i,e[n]));return i}bvt._actionOneTwo=function(t,e){var i=new bvt;return i.initWithTwoActions(t,e),i};var Avt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.update=function(){},i.reverse=function(){var t=new e(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t},i.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithDuration(this._duration),t},e}(vvt);function Tvt(t){return new Avt(t)}var wvt,Evt,Pvt,Ivt,Rvt,Dvt,Mvt,Ovt,Bvt,Nvt,Lvt,Fvt,zvt,Vvt,kvt,Uvt,Gvt,Hvt,jvt,Wvt,qvt,Xvt,Yvt,Kvt,Jvt,Qvt,Zvt,$vt,tgt,egt,igt,ngt,rgt,ogt,agt,sgt,cgt,lgt,ugt,hgt,_gt,fgt,pgt,dgt,mgt,vgt,ggt,ygt,xgt,Sgt,bgt,Cgt,Agt,Tgt,wgt,Egt,Pgt,Igt,Rgt,Dgt,Mgt=function(t){function e(e){var i;return(i=t.call(this)||this)._other=null,e&&i.initWithAction(e),i}$(e,t);var i=e.prototype;return i.initWithAction=function(t){return t?t===this._other?(O(1029),!1):!!vvt.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(O(1028),!1)},i.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t},i.startWithTarget=function(t){vvt.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)},i.update=function(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)},i.reverse=function(){return this._other.clone()},i.stop=function(){this._other.stop(),avt.prototype.stop.call(this)},e}(vvt),Ogt=t("TweenAction",function(t){function e(e,i,n){var r;if((r=t.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==n)n=Object.create(null);else if(function(t){var e=" [Tween:] ",i=" option is not support in v + "+h,n=t;n.delay&&S(e+"delay"+i),n.repeat&&S(e+"repeat"+i),n.repeatDelay&&S(e+"repeatDelay"+i),n.interpolation&&S(e+"interpolation"+i),n.onStop&&S(e+"onStop"+i)}(n),n.easing&&"string"==typeof n.easing&&(n.easing=function(t){var e=t.charAt(0);if(/[A-Z]/.test(e)){var i=(t=t.replace(e,e.toLowerCase())).split("-");if(2===i.length){var n=i[0];if("linear"===n)t="linear";else{var r=i[1];switch(n){case"quadratic":t="quad"+r;break;case"quartic":t="quart"+r;break;case"quintic":t="quint"+r;break;case"sinusoidal":t="sine"+r;break;case"exponential":t="expo"+r;break;case"circular":t="circ"+r;break;default:t=n+r}}}}return t}(n.easing)),n.progress||(n.progress=r.progress),n.easing&&"string"==typeof n.easing){var o=n.easing;n.easing=tf[o],n.easing||D(1031,o)}for(var a in r._opts=n,r._props=Object.create(null),i)if(i.hasOwnProperty(a)){var s=i[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=tf[s.easing])||D(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var u=Object.create(null);u.value=s,u.easing=c,u.progress=l,r._props[a]=u}}return r._originProps=i,r.initWithDuration(e),r}$(e,t);var i=e.prototype;return i.clone=function(){var t=new e(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t},i.startWithTarget=function(t){vvt.prototype.startWithTarget.call(this,t);var e=!!this._opts.relative,i=this._props;for(var n in i){var r=t[n];if(void 0!==r){var o=i[n],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=e?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=e?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},i.update=function(t){var e=this.target;if(e){var i=this._props,n=this._opts,r=t;n.easing&&(r=n.easing(t));var o=n.progress;for(var a in i){var s=i[a],c=s.easing?s.easing(t):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);e[a]=s.current}n.onUpdate&&n.onUpdate(this.target,t),1===t&&n.onComplete&&n.onComplete(this.target)}},i.progress=function(t,e,i,n){return t+(e-t)*n},e}(vvt)),Bgt=function(t){function e(e){var i;return(i=t.call(this)||this)._props=void 0,i._props={},void 0!==e&&i.init(e),i}$(e,t);var i=e.prototype;return i.init=function(t){for(var e in t)this._props[e]=t[e];return!0},i.update=function(){var t=this._props,e=this.target;for(var i in t)e[i]=t[i]},i.clone=function(){var t=new e;return t.init(this._props),t},e}(_vt),Ngt=t("Tween",function(){function t(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=avt.TAG_INVALID,this._target=void 0===t?null:t}var e=t.prototype;return e.tag=function(t){return this._tag=t,this},e.then=function(t){return t instanceof avt?this._actions.push(t.clone()):this._actions.push(t._union()),this},e.target=function(t){return this._target=t,this},e.start=function(){return this._target?(this._finalAction&&hvt.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),hvt.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(S("Please set target to tween first"),this)},e.stop=function(){return this._finalAction&&hvt.instance.ActionManager.removeAction(this._finalAction),this},e.clone=function(t){var e=this._union();return Lgt(t).then(e.clone())},e.union=function(){var t=this._union();return this._actions.length=0,this._actions.push(t),this},e.to=function(t,e,i){(i=i||Object.create(null)).relative=!1;var n=new Ogt(t,e,i);return this._actions.push(n),this},e.by=function(t,e,i){(i=i||Object.create(null)).relative=!0;var n=new Ogt(t,e,i);return this._actions.push(n),this},e.set=function(t){var e=new Bgt(t);return this._actions.push(e),this},e.delay=function(t){var e=Tvt(t);return this._actions.push(e),this},e.call=function(t){var e=new mvt(t,undefined,undefined);return this._actions.push(e),this},e.sequence=function(){var e=t._wrappedSequence.apply(t,arguments);return this._actions.push(e),this},e.parallel=function(){var e=t._wrappedParallel.apply(t,arguments);return this._actions.push(e),this},e.repeat=function(e,i){if(e===1/0)return this.repeatForever(i);var n,r=this._actions;return n=i instanceof t?i._union():r.pop(),r.push(function(t,e){return new xvt(t,e)}(n,e)),this},e.repeatForever=function(e){var i,n=this._actions;return i=e instanceof t?e._union():n.pop(),n.push(function(t){return new Svt(t)}(i)),this},e.reverseTime=function(e){var i,n=this._actions;return i=e instanceof t?e._union():n.pop(),n.push(function(t){return new Mgt(t)}(i)),this},e.hide=function(){var t=new pvt;return this._actions.push(t),this},e.show=function(){var t=new fvt;return this._actions.push(t),this},e.removeSelf=function(){var t=new dvt(!1);return this._actions.push(t),this},t.stopAll=function(){hvt.instance.ActionManager.removeAllActions()},t.stopAllByTag=function(t,e){hvt.instance.ActionManager.removeAllActionsByTag(t,e)},t.stopAllByTarget=function(t){hvt.instance.ActionManager.removeAllActionsFromTarget(t)},e._union=function(){var t=this._actions;return 1===t.length?t[0]:yvt(t)},e._destroy=function(){this.stop()},t._wrappedSequence=function(){var e=t._tmp_args;e.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=e[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof t&&(e[n]=r._union())}return yvt.apply(yvt,e)},t._wrappedParallel=function(){var e=t._tmp_args;e.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=e[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof t&&(e[n]=r._union())}return Cvt.apply(Cvt,e)},t}());function Lgt(t){return new Ngt(t)}function Fgt(t){return S("tweenUtil' is deprecated, please use 'tween' instead "),new Ngt(t)}Ngt._tmp_args=[],u.Tween=Ngt,u.tween=Lgt,u.tweenUtil=Fgt;var zgt,Vgt,kgt,Ugt=new Ti;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(zgt||(zgt={})),ce(zgt),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(Vgt||(Vgt={})),function(t){t.CLICK="click"}(kgt||(kgt={}));var Ggt=function(e){return t({Button:e,ButtonComponent:e}),e}((wvt=pc("cc.Button"),Evt=Rc(),Pvt=mc(110),Ivt=wc(),Rvt=dc(NH),Dvt=Kc(jT),Mvt=Uc(),Ovt=Nc(),Bvt=Uc(),Nvt=Nc(),Lvt=Kc(zgt),Fvt=Uc(),zvt=Nc(),Vvt=Uc(),kvt=Nc(),Uvt=Uc(),Gvt=Nc(),Hvt=Uc(),jvt=Nc(),Wvt=Uc(),qvt=Nc(),Xvt=Fc(),Yvt=zc(),Kvt=Uc(),Jvt=Nc(),Qvt=Uc(),Zvt=Nc(),$vt=Kc(cG),tgt=Uc(),egt=Nc(),igt=Kc(cG),ngt=Uc(),rgt=Nc(),ogt=Kc(cG),agt=Uc(),sgt=Nc(),cgt=Kc(cG),lgt=Uc(),ugt=Nc(),hgt=Kc([zL]),_gt=Uc(),fgt=Nc(),wvt(pgt=Evt(pgt=Pvt(pgt=Ivt(pgt=Rvt(pgt=Tc((Dgt=Rgt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"clickEvents",mgt,ot(e)),ct(e,"_interactable",vgt,ot(e)),ct(e,"_transition",ggt,ot(e)),ct(e,"_normalColor",ygt,ot(e)),ct(e,"_hoverColor",xgt,ot(e)),ct(e,"_pressedColor",Sgt,ot(e)),ct(e,"_disabledColor",bgt,ot(e)),ct(e,"_normalSprite",Cgt,ot(e)),ct(e,"_hoverSprite",Agt,ot(e)),ct(e,"_pressedSprite",Tgt,ot(e)),ct(e,"_disabledSprite",wgt,ot(e)),ct(e,"_duration",Egt,ot(e)),ct(e,"_zoomScale",Pgt,ot(e)),ct(e,"_target",Igt,ot(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new Ti,e._toColor=new Ti,e._time=0,e._transitionFinished=!0,e._fromScale=new Ei,e._toScale=new Ei,e._originalScale=null,e._sprite=null,e._targetScale=new Ei,e}$(e,t);var i=e.prototype;return i.__preload=function(){this.target||(this.target=this.node);var t=this.node.getComponent(cY);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()},i.onEnable=function(){this._registerNodeEvent()},i.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},i.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},i.update=function(t){var e=this.target;if(!this._transitionFinished&&e&&(this._transition===zgt.COLOR||this._transition===zgt.SCALE)){this._time+=t;var i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),this._transition===zgt.COLOR){var n=e._uiProps.uiComp;Ti.lerp(Ugt,this._fromColor,this._toColor,i),n&&(n.color=Ugt)}else this.transition===zgt.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=ci(this._fromScale.x,this._toScale.x,i),this._targetScale.y=ci(this._fromScale.y,this._toScale.y,i),e.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}},i._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},i._resetState=function(){this._pressed=!1,this._hovered=!1;var t=this.target;if(t){var e=this._transition;if(e===zgt.COLOR&&this._interactable){var i=t.getComponent(yW);i&&(i.color=this._normalColor)}else e===zgt.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}},i._registerNodeEvent=function(){this.node.on(GC.TOUCH_START,this._onTouchBegan,this),this.node.on(GC.TOUCH_MOVE,this._onTouchMove,this),this.node.on(GC.TOUCH_END,this._onTouchEnded,this),this.node.on(GC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(GC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(GC.MOUSE_LEAVE,this._onMouseMoveOut,this)},i._registerTargetEvent=function(t){t.on(GC.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},i._unregisterNodeEvent=function(){this.node.off(GC.TOUCH_START,this._onTouchBegan,this),this.node.off(GC.TOUCH_MOVE,this._onTouchMove,this),this.node.off(GC.TOUCH_END,this._onTouchEnded,this),this.node.off(GC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(GC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(GC.MOUSE_LEAVE,this._onMouseMoveOut,this)},i._unregisterTargetEvent=function(t){t.off(GC.TRANSFORM_CHANGED)},i._getTargetSprite=function(t){var e=null;return t&&(e=t.getComponent(cY)),e},i._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Ei),Ei.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},i._onTargetSpriteFrameChanged=function(t){this._transition===zgt.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)},i._setCurrentStateSpriteFrame=function(t){if(t)switch(this._getButtonState()){case Vgt.NORMAL:this._normalSprite=t;break;case Vgt.HOVER:this._hoverSprite=t;break;case Vgt.PRESSED:this._pressedSprite=t;break;case Vgt.DISABLED:this._disabledSprite=t}},i._onTargetColorChanged=function(t){this._transition===zgt.COLOR&&this._setCurrentStateColor(t)},i._setCurrentStateColor=function(t){switch(this._getButtonState()){case Vgt.NORMAL:this._normalColor=t;break;case Vgt.HOVER:this._hoverColor=t;break;case Vgt.PRESSED:this._pressedColor=t;break;case Vgt.DISABLED:this._disabledColor=t}},i._onTargetTransformChanged=function(t){t&ny.SCALE&&this._originalScale&&this._transition===zgt.SCALE&&this._transitionFinished&&Ei.copy(this._originalScale,this.target.getScale())},i._onTouchBegan=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))},i._onTouchMove=function(t){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&t){var e=t.touch;if(e){var i,n=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());this._transition===zgt.SCALE&&this.target&&this._originalScale?n?(Ei.copy(this._fromScale,this._originalScale),Ei.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(i=n?Vgt.PRESSED:Vgt.NORMAL,this._applyTransition(i)),t&&(t.propagationStopped=!0)}}},i._onTouchEnded=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(zL.emitEvents(this.clickEvents,t),this.node.emit(kgt.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))},i._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},i._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==zgt.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},i._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},i._updateState=function(){var t=this._getButtonState();this._applyTransition(t)},i._getButtonState=function(){var t=Vgt.NORMAL;return this._interactable?this._pressed?t=Vgt.PRESSED:this._hovered&&(t=Vgt.HOVER):t=Vgt.DISABLED,t.toString()},i._updateColorTransition=function(t){var e,i=this[t+"Color"],n=null===(e=this.target)||void 0===e?void 0:e.getComponent(yW);n&&(t===Vgt.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))},i._updateSpriteTransition=function(t){var e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},i._updateScaleTransition=function(t){this._interactable&&(t===Vgt.PRESSED?this._zoomUp():this._zoomBack())},i._zoomUp=function(){this._originalScale&&(Ei.copy(this._fromScale,this._originalScale),Ei.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},i._zoomBack=function(){this.target&&this._originalScale&&(Ei.copy(this._fromScale,this.target.getScale()),Ei.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},i._applyTransition=function(t){var e=this._transition;e===zgt.COLOR?this._updateColorTransition(t):e===zgt.SPRITE?this._updateSpriteTransition(t):e===zgt.SCALE&&this._updateScaleTransition(t)},Q(e,[{key:"target",get:function(){return this._target||this.node},set:function(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(t){this._transition!==t&&(this._transition===zgt.COLOR?this._updateColorTransition(Vgt.NORMAL):this._transition===zgt.SPRITE&&this._updateSpriteTransition(Vgt.NORMAL),this._transition=t,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(t){this._pressedColor!==t&&this._pressedColor.set(t)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(t){this._hoverColor!==t&&this._hoverColor.set(t)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(t){this._duration!==t&&(this._duration=t)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(t){this._zoomScale!==t&&(this._zoomScale=t)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(t){if(this._normalSprite!==t){this._normalSprite=t;var e=this.node.getComponent(cY);e&&(e.spriteFrame=t),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}}]),e}($u),Rgt.Transition=zgt,Rgt.EventType=kgt,lt((dgt=Dgt).prototype,"target",[Dvt,Mvt,Ovt],Object.getOwnPropertyDescriptor(dgt.prototype,"target"),dgt.prototype),lt(dgt.prototype,"interactable",[Bvt,Nvt],Object.getOwnPropertyDescriptor(dgt.prototype,"interactable"),dgt.prototype),lt(dgt.prototype,"transition",[Lvt,Fvt,zvt],Object.getOwnPropertyDescriptor(dgt.prototype,"transition"),dgt.prototype),lt(dgt.prototype,"normalColor",[Vvt,kvt],Object.getOwnPropertyDescriptor(dgt.prototype,"normalColor"),dgt.prototype),lt(dgt.prototype,"pressedColor",[Uvt,Gvt],Object.getOwnPropertyDescriptor(dgt.prototype,"pressedColor"),dgt.prototype),lt(dgt.prototype,"hoverColor",[Hvt,jvt],Object.getOwnPropertyDescriptor(dgt.prototype,"hoverColor"),dgt.prototype),lt(dgt.prototype,"disabledColor",[Wvt,qvt],Object.getOwnPropertyDescriptor(dgt.prototype,"disabledColor"),dgt.prototype),lt(dgt.prototype,"duration",[Xvt,Yvt,Kvt,Jvt],Object.getOwnPropertyDescriptor(dgt.prototype,"duration"),dgt.prototype),lt(dgt.prototype,"zoomScale",[Qvt,Zvt],Object.getOwnPropertyDescriptor(dgt.prototype,"zoomScale"),dgt.prototype),lt(dgt.prototype,"normalSprite",[$vt,tgt,egt],Object.getOwnPropertyDescriptor(dgt.prototype,"normalSprite"),dgt.prototype),lt(dgt.prototype,"pressedSprite",[igt,ngt,rgt],Object.getOwnPropertyDescriptor(dgt.prototype,"pressedSprite"),dgt.prototype),lt(dgt.prototype,"hoverSprite",[ogt,agt,sgt],Object.getOwnPropertyDescriptor(dgt.prototype,"hoverSprite"),dgt.prototype),lt(dgt.prototype,"disabledSprite",[cgt,lgt,ugt],Object.getOwnPropertyDescriptor(dgt.prototype,"disabledSprite"),dgt.prototype),mgt=lt(dgt.prototype,"clickEvents",[hgt,xc,_gt,fgt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vgt=lt(dgt.prototype,"_interactable",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ggt=lt(dgt.prototype,"_transition",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zgt.NONE}}),ygt=lt(dgt.prototype,"_normalColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),xgt=lt(dgt.prototype,"_hoverColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(211,211,211,255)}}),Sgt=lt(dgt.prototype,"_pressedColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.WHITE.clone()}}),bgt=lt(dgt.prototype,"_disabledColor",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(124,124,124,255)}}),Cgt=lt(dgt.prototype,"_normalSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Agt=lt(dgt.prototype,"_hoverSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tgt=lt(dgt.prototype,"_pressedSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wgt=lt(dgt.prototype,"_disabledSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Egt=lt(dgt.prototype,"_duration",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Pgt=lt(dgt.prototype,"_zoomScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Igt=lt(dgt.prototype,"_target",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pgt=dgt))||pgt)||pgt)||pgt)||pgt)||pgt)||pgt));u.Button=Ggt;var Hgt,jgt,Wgt,qgt=function(){function t(){}return t.add=function(t){var e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)},t.remove=function(t){var e=this._tabIndexList,i=e.indexOf(t);-1!==i&&e.splice(i,1)},t.resort=function(){this._tabIndexList.sort((function(t,e){return t._delegate.tabIndex-e._delegate.tabIndex}))},t.next=function(t){var e=this._tabIndexList,i=e.indexOf(t);if(t.setFocus(!1),-1!==i){var n=e[i+1];n&&n._delegate.tabIndex>=0&&n.setFocus(!0)}},t}();qgt._tabIndexList=[],function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"}(Hgt||(Hgt={})),oe(Hgt),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(jgt||(jgt={})),oe(jgt),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(Wgt||(Wgt={})),oe(Wgt);var Xgt,Ygt,Kgt,Jgt,Qgt,Zgt,$gt,tyt,eyt,iyt,nyt,ryt,oyt,ayt,syt,cyt,lyt,uyt,hyt,_yt,fyt,pyt,dyt,myt,vyt,gyt,yyt,xyt,Syt,byt,Cyt,Ayt,Tyt,wyt,Eyt,Pyt,Iyt,Ryt,Dyt,Myt,Oyt,Byt,Nyt,Lyt,Fyt,zyt,Vyt,kyt,Uyt,Gyt,Hyt,jyt,Wyt,qyt,Xyt,Yyt,Kyt,Jyt,Qyt,Zyt,$yt,txt=function(){function t(){this._editing=!1,this._delegate=null}var e=t.prototype;return e.init=function(){},e.onEnable=function(){},e.update=function(){},e.onDisable=function(){this._editing&&this.endEditing()},e.clear=function(){this._delegate=null},e.setTabIndex=function(){},e.setSize=function(){},e.setFocus=function(t){t?this.beginEditing():this.endEditing()},e.isFocused=function(){return this._editing},e.beginEditing=function(){},e.endEditing=function(){},t}(),ext=new Gi,ixt=new Gi,nxt=new Ei,rxt=null,oxt=0,axt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++oxt,e}$(e,t);var i=e.prototype;return i.init=function(t){t&&(this._delegate=t,t.inputMode===jgt.ANY?this._createTextArea():this._createInput(),qgt.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},i.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),qgt.remove(this),rxt===this&&(rxt=null),this._delegate=null},i.update=function(){this._updateMatrix()},i.setTabIndex=function(t){this._edTxt.tabIndex=t,qgt.resort()},i.setSize=function(t,e){var i=this._edTxt;i&&(i.style.width=t+"px",i.style.height=e+"px")},i.beginEditing=function(){rxt&&rxt!==this&&rxt.setFocus(!1),this._editing=!0,rxt=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},i.endEditing=function(){this._edTxt.blur()},i._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},i._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},i._addDomToGameContainer=function(){u.GAME_VIEW&&this._edTxt?(u.gameView.container.appendChild(this._edTxt),u.gameView.head.appendChild(this._placeholderStyleSheet)):UO.container&&this._edTxt&&(UO.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},i._removeDomFromGameContainer=function(){(u.GAME_VIEW?ge(u.gameView.container,this._edTxt):ge(UO.container,this._edTxt))&&this._edTxt&&(u.GAME_VIEW?u.gameView.container.removeChild(this._edTxt):UO.container.removeChild(this._edTxt)),(u.GAME_VIEW?ge(u.gameView.head,this._placeholderStyleSheet):ge(document.head,this._placeholderStyleSheet))&&(u.GAME_VIEW?u.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},i._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),lh.isMobile&&this._showDomOnMobile()},i._hideDom=function(){var t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),lh.isMobile&&this._hideDomOnMobile()},i._showDomOnMobile=function(){lh.os!==au.ANDROID&&lh.os!==au.OHOS||(ah.handleResizeEvent=!1,this._adjustWindowScroll())},i._hideDomOnMobile=function(){lh.os!==au.ANDROID&&lh.os!==au.OHOS||(ah.handleResizeEvent=!0),this._scrollBackWindow()},i._adjustWindowScroll=function(){var t=this;setTimeout((function(){window.scrollY<40&&t._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},i._scrollBackWindow=function(){setTimeout((function(){lh.browserType!==nu.WECHAT||lh.os!==au.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},i._updateMatrix=function(){if(this._edTxt){var t=this._delegate.node,e=$O.getScaleX(),i=$O.getScaleY(),n=1,r=1;u.GAME_VIEW&&(n=u.gameView.canvas.width/u.game.canvas.width,r=u.gameView.canvas.height/u.game.canvas.height),e*=n,i*=r;var o=$O.getViewportRect(),a=ah.devicePixelRatio;t.getWorldMatrix(ext);var s=t._uiProps.uiTransformComp;if(s&&Ei.set(nxt,-s.anchorX*s.width,-s.anchorY*s.height,nxt.z),Gi.transform(ext,ext,nxt),t._uiProps.uiTransformComp){var c=HO.root.batcher2D.getFirstRenderCamera(t);if(c){c.node.getWorldRT(ixt);var l=ixt.m12,h=ixt.m13,_=qO.center;ixt.m12=_.x-(ixt.m00*l+ixt.m04*h),ixt.m13=_.y-(ixt.m01*l+ixt.m05*h),Gi.multiply(ixt,ixt,ext),e/=a,i/=a;var f=u.GAME_VIEW?u.gameView.container:UO.container,p=ixt.m00*e,d=ext.m01,m=ext.m04,v=ixt.m05*i,g=parseInt(f&&f.style.paddingLeft||"0");g+=o.x*n/a;var y=parseInt(f&&f.style.paddingBottom||"0");y+=o.y/a;var x="matrix("+p+","+-d+","+-m+","+v+","+(ixt.m12*e+g)+","+-(ixt.m13*i+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},i._updateInputType=function(){var t=this._delegate,e=t.inputMode,i=t.inputFlag,n=t.returnType,r=this._edTxt;if(this._inputMode!==e||this._inputFlag!==i||this._returnType!==n){if(this._inputMode=e,this._inputFlag=i,this._returnType=n,this._isTextArea){var o="none";return i===Wgt.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":i===Wgt.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,i===Wgt.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;e===jgt.EMAIL_ADDR?a="email":e===jgt.NUMERIC||e===jgt.DECIMAL?a="number":e===jgt.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):e===jgt.URL?a="url":(a="text",n===Hgt.SEARCH&&(a="search")),r.type=a;var s="none";i===Wgt.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":i===Wgt.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},i._updateMaxLength=function(){var t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t},i._initStyleSheet=function(){if(this._edTxt){var t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):((t=t).type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},i._updateStyleSheet=function(){var t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,e.placeholder=t.placeholder,this._updateTextLabel(t.textLabel),this._updatePlaceholderLabel(t.placeholderLabel))},i._updateTextLabel=function(t){if(t){var e=t.font;e=!e||e instanceof IG?t.fontFamily:e._fontFamily;var i=t.fontSize*t.node.scale.y;if((this._textLabelFont!==e||this._textLabelFontSize!==i||this._textLabelFontColor!==t.fontColor||this._textLabelAlign!==t.horizontalAlign)&&(this._textLabelFont=e,this._textLabelFontSize=i,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,this._edTxt)){var n=this._edTxt;switch(n.style.fontSize=i+"px",n.style.color=t.color.toCSS(),n.style.fontFamily=e,t.horizontalAlign){case xW.HorizontalAlign.LEFT:n.style.textAlign="left";break;case xW.HorizontalAlign.CENTER:n.style.textAlign="center";break;case xW.HorizontalAlign.RIGHT:n.style.textAlign="right"}}}},i._updatePlaceholderLabel=function(t){if(t){var e=t.font;e=!e||e instanceof IG?t.fontFamily:t.font._fontFamily;var i=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont!==e||this._placeholderLabelFontSize!==i||this._placeholderLabelFontColor!==t.fontColor||this._placeholderLabelAlign!==t.horizontalAlign||this._placeholderLineHeight!==t.fontSize){this._placeholderLabelFont=e,this._placeholderLabelFontSize=i,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;var n=this._placeholderStyleSheet,r=t.color.toCSS(),o=t.fontSize,a="";switch(t.horizontalAlign){case xW.HorizontalAlign.LEFT:a="left";break;case xW.HorizontalAlign.CENTER:a="center";break;case xW.HorizontalAlign.RIGHT:a="right"}n.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+i+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+e+";font-size: "+i+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+i+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",lh.browserType===nu.EDGE&&(n.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},i._registerEventListeners=function(){var t=this;if(this._edTxt){var e=this._edTxt,i=!1,n=this.__eventListeners;n.compositionStart=function(){i=!0},n.compositionEnd=function(){i=!1,t._delegate._editBoxTextChanged(e.value)},n.onInput=function(){if(!i){var n=t._delegate,r=n.maxLength;r>=0&&(e.value=e.value.slice(0,r)),n._editBoxTextChanged(e.value)}},n.onClick=function(){t._editing&&lh.isMobile&&t._adjustWindowScroll()},n.onKeydown=function(i){i.keyCode===YR.ENTER?(i.propagationStopped=!0,t._delegate._editBoxEditingReturn(),t._isTextArea||e.blur()):i.keyCode===YR.TAB&&(i.propagationStopped=!0,i.preventDefault(),qgt.next(t))},n.onBlur=function(){lh.isMobile&&i&&n.compositionEnd(),t._editing=!1,rxt=null,t._hideDom(),t._delegate._editBoxEditingDidEnded()},e.addEventListener("compositionstart",n.compositionStart),e.addEventListener("compositionend",n.compositionEnd),e.addEventListener("input",n.onInput),e.addEventListener("keydown",n.onKeydown),e.addEventListener("blur",n.onBlur),e.addEventListener("touchstart",n.onClick)}},i._removeEventListeners=function(){if(this._edTxt){var t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}},e}(txt);!function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}($yt||($yt={}));var sxt,cxt,lxt,uxt,hxt,_xt,fxt,pxt,dxt,mxt,vxt,gxt,yxt,xxt,Sxt,bxt,Cxt,Axt,Txt,wxt,Ext,Pxt,Ixt,Rxt,Dxt,Mxt,Oxt,Bxt,Nxt,Lxt,Fxt,zxt,Vxt,kxt,Uxt,Gxt,Hxt,jxt,Wxt,qxt,Xxt,Yxt,Kxt,Jxt,Qxt,Zxt,$xt,tSt,eSt,iSt,nSt,rSt,oSt,aSt,sSt,cSt,lSt,uSt,hSt,_St,fSt,pSt=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((Xgt=pc("cc.EditBox"),Ygt=Rc(),Kgt=mc(110),Jgt=wc(),Qgt=dc(NH),Zgt=Uc(),$gt=Nc(),tyt=Uc(),eyt=Nc(),iyt=Kc(xW),nyt=Uc(),ryt=Nc(),oyt=Kc(xW),ayt=Uc(),syt=Nc(),cyt=Kc(cG),lyt=Uc(),uyt=Nc(),hyt=Kc(Wgt),_yt=Uc(),fyt=Nc(),pyt=Kc(jgt),dyt=Uc(),myt=Nc(),vyt=Kc(Hgt),gyt=Uc(),yyt=Nc(),xyt=Uc(),Syt=Nc(),byt=Uc(),Cyt=Nc(),Ayt=Kc([zL]),Tyt=Uc(),wyt=Nc(),Eyt=Kc([zL]),Pyt=Uc(),Iyt=Nc(),Ryt=Kc([zL]),Dyt=Uc(),Myt=Nc(),Oyt=Kc([zL]),Byt=Uc(),Nyt=Nc(),Xgt(Lyt=Ygt(Lyt=Kgt(Lyt=Jgt(Lyt=Qgt(Lyt=Tc((Zyt=Qyt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"editingDidBegan",zyt,ot(e)),ct(e,"textChanged",Vyt,ot(e)),ct(e,"editingDidEnded",kyt,ot(e)),ct(e,"editingReturn",Uyt,ot(e)),e._impl=null,e._background=null,ct(e,"_textLabel",Gyt,ot(e)),ct(e,"_placeholderLabel",Hyt,ot(e)),ct(e,"_returnType",jyt,ot(e)),ct(e,"_string",Wyt,ot(e)),ct(e,"_tabIndex",qyt,ot(e)),ct(e,"_backgroundImage",Xyt,ot(e)),ct(e,"_inputFlag",Yyt,ot(e)),ct(e,"_inputMode",Kyt,ot(e)),ct(e,"_maxLength",Jyt,ot(e)),e._isLabelVisible=!1,e}$(e,t);var i=e.prototype;return i.__preload=function(){this._init()},i.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},i.update=function(){this._impl&&this._impl.update()},i.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},i.onDestroy=function(){this._impl&&this._impl.clear()},i.setFocus=function(){this._impl&&this._impl.setFocus(!0)},i.focus=function(){this._impl&&this._impl.setFocus(!0)},i.blur=function(){this._impl&&this._impl.setFocus(!1)},i.isFocused=function(){return!!this._impl&&this._impl.isFocused()},i._editBoxEditingDidBegan=function(){zL.emitEvents(this.editingDidBegan,this),this.node.emit($yt.EDITING_DID_BEGAN,this)},i._editBoxEditingDidEnded=function(){zL.emitEvents(this.editingDidEnded,this),this.node.emit($yt.EDITING_DID_ENDED,this)},i._editBoxTextChanged=function(t){t=this._updateLabelStringStyle(t,!0),this.string=t,zL.emitEvents(this.textChanged,t,this),this.node.emit($yt.TEXT_CHANGED,this)},i._editBoxEditingReturn=function(){zL.emitEvents(this.editingReturn,this),this.node.emit($yt.EDITING_RETURN,this)},i._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},i._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},i._onTouchBegan=function(t){t.propagationStopped=!0},i._onTouchCancel=function(t){t.propagationStopped=!0},i._onTouchEnded=function(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0},i._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(GC.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},i._ensureBackgroundSprite=function(){if(!this._background){var t=this.node.getComponent(cY);t||(t=this.node.addComponent(cY)),t!==this._background&&(t.type=cY.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}},i._updateTextLabel=function(){var t=this._textLabel;if(!t){var e=this.node.getChildByName("TEXT_LABEL");e||((e=new jT("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(xW))||(t=e.addComponent(xW)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=xW.Overflow.CLAMP,this._inputMode===jgt.ANY?(t.verticalAlign=mW.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},i._updatePlaceholderLabel=function(){var t=this._placeholderLabel;if(!t){var e=this.node.getChildByName("PLACEHOLDER_LABEL");e||((e=new jT("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(xW))||(t=e.addComponent(xW)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=xW.Overflow.CLAMP,this._inputMode===jgt.ANY?(t.verticalAlign=mW.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},i._syncSize=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){var i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=t.anchorPoint,i.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)},i._updateLabels=function(){if(this._isLabelVisible){var t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}},i._updateString=function(t){var e=this._textLabel;if(e){var i=t;i&&(i=this._updateLabelStringStyle(i)),e.string=i,this._updateLabels()}},i._updateLabelStringStyle=function(t,e){void 0===e&&(e=!1);var i,n=this._inputFlag;if(e||n!==Wgt.PASSWORD)n===Wgt.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():n===Wgt.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(function(t){return t.toUpperCase()})):n===Wgt.INITIAL_CAPS_SENTENCE&&(t=(i=t).charAt(0).toUpperCase()+i.slice(1));else{for(var r="",o=t.length,a=0;a<o;++a)r+="";t=r}return t},i._registerEvent=function(){this.node.on(GC.TOUCH_START,this._onTouchBegan,this),this.node.on(GC.TOUCH_END,this._onTouchEnded,this)},i._unregisterEvent=function(){this.node.off(GC.TOUCH_START,this._onTouchBegan,this),this.node.off(GC.TOUCH_END,this._onTouchEnded,this)},i._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},i._registerBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.on(cY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},i._unregisterBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.off(cY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},i._updateLabelPosition=function(t){var e=this.node._uiProps.uiTransformComp,i=-e.anchorX*e.width,n=-e.anchorY*e.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(i+2,n+t.height,o.node.position.z),this._inputMode===jgt.ANY&&(o.verticalAlign=mW.TOP),o.enableWrapText=this._inputMode===jgt.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.lineHeight=t.height,r.node.setPosition(i+2,n+t.height,r.node.position.z),this._inputMode===jgt.ANY&&(r.verticalAlign=mW.TOP),r.enableWrapText=this._inputMode===jgt.ANY)},i._resizeChildNodes=function(){var t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));var i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-t.width/2,t.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(t.contentSize));var n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(t.contentSize),this._syncSize()},Q(e,[{key:"string",get:function(){return this._string},set:function(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}},{key:"textLabel",get:function(){return this._textLabel},set:function(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(t){this._inputFlag=t,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(t){this._returnType=t}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}}]),e}($u),Qyt._EditBoxImpl=txt,Qyt.KeyboardReturnType=Hgt,Qyt.InputFlag=Wgt,Qyt.InputMode=jgt,Qyt.EventType=$yt,lt((Fyt=Zyt).prototype,"string",[Zgt,$gt],Object.getOwnPropertyDescriptor(Fyt.prototype,"string"),Fyt.prototype),lt(Fyt.prototype,"placeholder",[tyt,eyt],Object.getOwnPropertyDescriptor(Fyt.prototype,"placeholder"),Fyt.prototype),lt(Fyt.prototype,"textLabel",[iyt,nyt,ryt],Object.getOwnPropertyDescriptor(Fyt.prototype,"textLabel"),Fyt.prototype),lt(Fyt.prototype,"placeholderLabel",[oyt,ayt,syt],Object.getOwnPropertyDescriptor(Fyt.prototype,"placeholderLabel"),Fyt.prototype),lt(Fyt.prototype,"backgroundImage",[cyt,lyt,uyt],Object.getOwnPropertyDescriptor(Fyt.prototype,"backgroundImage"),Fyt.prototype),lt(Fyt.prototype,"inputFlag",[hyt,_yt,fyt],Object.getOwnPropertyDescriptor(Fyt.prototype,"inputFlag"),Fyt.prototype),lt(Fyt.prototype,"inputMode",[pyt,dyt,myt],Object.getOwnPropertyDescriptor(Fyt.prototype,"inputMode"),Fyt.prototype),lt(Fyt.prototype,"returnType",[vyt,gyt,yyt],Object.getOwnPropertyDescriptor(Fyt.prototype,"returnType"),Fyt.prototype),lt(Fyt.prototype,"maxLength",[xyt,Syt],Object.getOwnPropertyDescriptor(Fyt.prototype,"maxLength"),Fyt.prototype),lt(Fyt.prototype,"tabIndex",[byt,Cyt],Object.getOwnPropertyDescriptor(Fyt.prototype,"tabIndex"),Fyt.prototype),zyt=lt(Fyt.prototype,"editingDidBegan",[Ayt,xc,Tyt,wyt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vyt=lt(Fyt.prototype,"textChanged",[Eyt,xc,Pyt,Iyt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kyt=lt(Fyt.prototype,"editingDidEnded",[Ryt,xc,Dyt,Myt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uyt=lt(Fyt.prototype,"editingReturn",[Oyt,xc,Byt,Nyt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gyt=lt(Fyt.prototype,"_textLabel",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hyt=lt(Fyt.prototype,"_placeholderLabel",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jyt=lt(Fyt.prototype,"_returnType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hgt.DEFAULT}}),Wyt=lt(Fyt.prototype,"_string",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qyt=lt(Fyt.prototype,"_tabIndex",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xyt=lt(Fyt.prototype,"_backgroundImage",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yyt=lt(Fyt.prototype,"_inputFlag",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wgt.DEFAULT}}),Kyt=lt(Fyt.prototype,"_inputMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jgt.ANY}}),Jyt=lt(Fyt.prototype,"_maxLength",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Lyt=Fyt))||Lyt)||Lyt)||Lyt)||Lyt)||Lyt)||Lyt));"object"==typeof window&&"object"==typeof document&&(pSt._EditBoxImpl=axt),u.internal.EditBox=pSt,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(cSt||(cSt={})),ce(cSt),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(lSt||(lSt={})),ce(lSt),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(uSt||(uSt={})),ce(uSt),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(hSt||(hSt={})),ce(hSt),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(_St||(_St={})),ce(_St),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(fSt||(fSt={})),ce(fSt);var dSt,mSt,vSt,gSt,ySt,xSt,SSt,bSt,CSt,ASt,TSt,wSt,ESt,PSt,ISt,RSt,DSt,MSt,OSt,BSt,NSt,LSt,FSt,zSt=new Ei,VSt=function(e){return t({Layout:e,LayoutComponent:e}),e}((sxt=pc("cc.Layout"),cxt=Rc(),lxt=mc(110),uxt=wc(),hxt=dc(NH),_xt=Mc(),fxt=Nc(),pxt=Mc(),dxt=Nc(),mxt=Kc(cSt),vxt=Uc(),gxt=Nc(),yxt=Kc(lSt),xxt=Mc(),Sxt=Nc(),bxt=Mc(),Cxt=Nc(),Axt=Kc(uSt),Txt=Nc(),wxt=Nc(),Ext=Nc(),Pxt=Nc(),Ixt=Nc(),Rxt=Nc(),Dxt=Nc(),Mxt=Kc(hSt),Oxt=Nc(),Bxt=Kc(_St),Nxt=Nc(),Lxt=Kc(fSt),Fxt=Mc(),zxt=Nc(),Vxt=Mc(),kxt=Nc(),Uxt=Nc(),sxt(Gxt=cxt(Gxt=lxt(Gxt=uxt(Gxt=hxt(Gxt=Tc((sSt=aSt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_resizeMode",jxt,ot(e)),ct(e,"_layoutType",Wxt,ot(e)),ct(e,"_cellSize",qxt,ot(e)),ct(e,"_startAxis",Xxt,ot(e)),ct(e,"_paddingLeft",Yxt,ot(e)),ct(e,"_paddingRight",Kxt,ot(e)),ct(e,"_paddingTop",Jxt,ot(e)),ct(e,"_paddingBottom",Qxt,ot(e)),ct(e,"_spacingX",Zxt,ot(e)),ct(e,"_spacingY",$xt,ot(e)),ct(e,"_verticalDirection",tSt,ot(e)),ct(e,"_horizontalDirection",eSt,ot(e)),ct(e,"_constraint",iSt,ot(e)),ct(e,"_constraintNum",nSt,ot(e)),ct(e,"_affectedByScale",rSt,ot(e)),ct(e,"_isAlign",oSt,ot(e)),e._layoutSize=new $i(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}$(e,t);var i=e.prototype;return i.updateLayout=function(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},i.onEnable=function(){this._addEventListeners();var t=this.node._uiProps.uiTransformComp;t.contentSize.equals($i.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()},i.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},i._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var t=this.node.children,e=0;e<t.length;++e){var i=t[e],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}},i._addEventListeners=function(){HO.on(GO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(GC.SIZE_CHANGED,this._resized,this),this.node.on(GC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(GC.CHILD_ADDED,this._childAdded,this),this.node.on(GC.CHILD_REMOVED,this._childRemoved,this),this.node.on(GC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},i._removeEventListeners=function(){HO.off(GO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(GC.SIZE_CHANGED,this._resized,this),this.node.off(GC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(GC.CHILD_ADDED,this._childAdded,this),this.node.off(GC.CHILD_REMOVED,this._childRemoved,this),this.node.off(GC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},i._addChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var i=t[e];i.on(GC.SIZE_CHANGED,this._doLayoutDirty,this),i.on(GC.TRANSFORM_CHANGED,this._transformDirty,this),i.on(GC.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on(GC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},i._removeChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var i=t[e];i.off(GC.SIZE_CHANGED,this._doLayoutDirty,this),i.off(GC.TRANSFORM_CHANGED,this._transformDirty,this),i.off(GC.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off(GC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},i._childAdded=function(t){t.on(GC.SIZE_CHANGED,this._doLayoutDirty,this),t.on(GC.TRANSFORM_CHANGED,this._transformDirty,this),t.on(GC.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(GC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},i._childRemoved=function(t){t.off(GC.SIZE_CHANGED,this._doLayoutDirty,this),t.off(GC.TRANSFORM_CHANGED,this._transformDirty,this),t.off(GC.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(GC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},i._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},i._doLayoutHorizontally=function(t,e,i,n){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===_St.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*t+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==cSt.GRID&&this._resizeMode===lSt.CHILDREN&&(m=(t-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,b=S.scale,C=this._getUsedScaleValue(b.x),A=this._getUsedScaleValue(b.y);this._resizeMode===lSt.CHILDREN&&(x.width=m/C,this._layoutType===cSt.GRID&&(x.height=this._cellSize.height/A));var T=Math.abs(this._horizontalDirection-x.anchorX),w=x.width*C,E=x.height*A;E>_&&(f=Math.max(_,f),h=_||E,_=E),l+=a*(T*w+this._spacingX);var P=a*(1-T)*w;if(e){if(o>0)(p=y/o>0&&y%o==0)&&(h=_>E?_:h);else if(w>t-v)l>c+a*T*w&&(p=!0);else{var I=(1-this._horizontalDirection-r.x)*t,R=l+P+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(R)>Math.abs(I)}p&&(l=c+a*T*w,E!==_&&(h=_),u+=h+this._spacingY,h=_=E)}var D=i(S,x,u);n&&S.setPosition(l,D),l+=P}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},i._doLayoutVertically=function(t,e,i,n){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===hSt.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*t+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==cSt.GRID&&this._resizeMode===lSt.CHILDREN&&(m=(t-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,b=S.scale,C=this._getUsedScaleValue(b.x),A=this._getUsedScaleValue(b.y);this._resizeMode===lSt.CHILDREN&&(x.height=m/A,this._layoutType===cSt.GRID&&(x.width=this._cellSize.width/C));var T=Math.abs(this._verticalDirection-x.anchorY),w=x.width*C,E=x.height*A;w>u&&(h=Math.max(u,h),_=u||w,u=w),l+=a*(T*E+this._spacingY);var P=a*(1-T)*E;if(e){if(o>0)(p=y/o>0&&y%o==0)&&(_=u>E?u:_);else if(E>t-v)l>c+a*T*E&&(p=!0);else{var I=(1-this._verticalDirection-r.y)*t,R=l+P+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(R)>Math.abs(I)}p&&(l=c+a*T*E,w!==u&&(_=u),f+=_+this._spacingX,_=u=w)}var D=i(S,x,f);n&&(S.getPosition(zSt),S.setPosition(D,l,zSt.z)),l+=P}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},i._doLayoutGridAxisHorizontal=function(t,e){var i=this,n=e.width,r=1,o=-t.y*e.height,a=this._paddingBottom;this._verticalDirection===hSt.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*e.height,a=this._paddingTop);var s=function(t,e,n){return o+r*(n+(1-e.anchorY)*e.height*i._getUsedScaleValue(t.scale.y)+a)},c=0;this._resizeMode===lSt.CONTAINER&&(c=this._doLayoutHorizontally(n,!0,s,!1),o=-t.y*c,this._verticalDirection===hSt.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*c)),this._doLayoutHorizontally(n,!0,s,!0),this._resizeMode===lSt.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(n,c)},i._doLayoutGridAxisVertical=function(t,e){var i=this,n=e.height,r=1,o=-t.x*e.width,a=this._paddingLeft;this._horizontalDirection===_St.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*e.width,a=this._paddingRight);var s=function(t,e,n){return o+r*(n+(1-e.anchorX)*e.width*i._getUsedScaleValue(t.scale.x)+a)},c=0;this._resizeMode===lSt.CONTAINER&&(c=this._doLayoutVertically(n,!0,s,!1),o=-t.x*c,this._horizontalDirection===_St.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*c)),this._doLayoutVertically(n,!0,s,!0),this._resizeMode===lSt.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,n)},i._doLayoutGrid=function(){var t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,i=t.contentSize;this.startAxis===uSt.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,i):this.startAxis===uSt.VERTICAL&&this._doLayoutGridAxisVertical(e,i)},i._getHorizontalBaseWidth=function(){var t=this._usefulLayoutObj,e=0,i=t.length;if(this._resizeMode===lSt.CONTAINER){for(var n=0;n<t.length;++n){var r=t[n],o=r.node.scale;e+=r.width*this._getUsedScaleValue(o.x)}e+=(i-1)*this._spacingX+this._getPaddingH()}else e=this.node._uiProps.uiTransformComp.width;return e},i._getVerticalBaseHeight=function(){var t=this._usefulLayoutObj,e=0,i=t.length;if(this._resizeMode===lSt.CONTAINER){for(var n=0;n<t.length;++n){var r=t[n],o=r.node.scale;e+=r.height*this._getUsedScaleValue(o.y)}e+=(i-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e},i._doLayout=function(){var t=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===cSt.HORIZONTAL){var e=this._getHorizontalBaseWidth();this._doLayoutHorizontally(e,!1,(function(e){return(t._isAlign?Ei.ZERO:e.position).y}),!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===cSt.VERTICAL){var i=this._getVerticalBaseHeight();this._doLayoutVertically(i,!1,(function(e){return(t._isAlign?Ei.ZERO:e.position).x}),!0),this.node._uiProps.uiTransformComp.height=i}else this._layoutType===cSt.GRID&&this._doLayoutGrid()},i._getUsedScaleValue=function(t){return this._affectedByScale?Math.abs(t):1},i._transformDirty=function(t){t&ny.SCALE&&t&ny.POSITION&&this._affectedByScale&&this._doLayoutDirty()},i._doLayoutDirty=function(){this._layoutDirty=!0},i._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},i._getPaddingH=function(){return this._paddingLeft+this._paddingRight},i._getPaddingV=function(){return this._paddingTop+this._paddingBottom},i._getFixedBreakingNum=function(){if(this._layoutType!==cSt.GRID||this._constraint===fSt.NONE||this._constraintNum<=0)return 0;var t=this._constraint===fSt.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===uSt.VERTICAL&&(t=this._constraint===fSt.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t},Q(e,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(t){this._layoutType===cSt.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(t){this._layoutType===cSt.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(t){this._layoutType=t,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(t){this._layoutType!==cSt.NONE&&(this._resizeMode=t,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(t){this._layoutType!==cSt.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(t){this._constraint!==fSt.NONE&&this._constraintNum!==t&&(t<=0&&S("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(t){this._affectedByScale=t,this._doLayoutDirty()}}]),e}($u),aSt.Type=cSt,aSt.VerticalDirection=hSt,aSt.HorizontalDirection=_St,aSt.ResizeMode=lSt,aSt.AxisDirection=uSt,aSt.Constraint=fSt,lt((Hxt=sSt).prototype,"alignHorizontal",[_xt,fxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"alignHorizontal"),Hxt.prototype),lt(Hxt.prototype,"alignVertical",[pxt,dxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"alignVertical"),Hxt.prototype),lt(Hxt.prototype,"type",[mxt,vxt,gxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"type"),Hxt.prototype),lt(Hxt.prototype,"resizeMode",[yxt,xxt,Sxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"resizeMode"),Hxt.prototype),lt(Hxt.prototype,"cellSize",[bxt,Cxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"cellSize"),Hxt.prototype),lt(Hxt.prototype,"startAxis",[Axt,Txt],Object.getOwnPropertyDescriptor(Hxt.prototype,"startAxis"),Hxt.prototype),lt(Hxt.prototype,"paddingLeft",[wxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"paddingLeft"),Hxt.prototype),lt(Hxt.prototype,"paddingRight",[Ext],Object.getOwnPropertyDescriptor(Hxt.prototype,"paddingRight"),Hxt.prototype),lt(Hxt.prototype,"paddingTop",[Pxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"paddingTop"),Hxt.prototype),lt(Hxt.prototype,"paddingBottom",[Ixt],Object.getOwnPropertyDescriptor(Hxt.prototype,"paddingBottom"),Hxt.prototype),lt(Hxt.prototype,"spacingX",[Rxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"spacingX"),Hxt.prototype),lt(Hxt.prototype,"spacingY",[Dxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"spacingY"),Hxt.prototype),lt(Hxt.prototype,"verticalDirection",[Mxt,Oxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"verticalDirection"),Hxt.prototype),lt(Hxt.prototype,"horizontalDirection",[Bxt,Nxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"horizontalDirection"),Hxt.prototype),lt(Hxt.prototype,"constraint",[Lxt,Fxt,zxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"constraint"),Hxt.prototype),lt(Hxt.prototype,"constraintNum",[Vxt,kxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"constraintNum"),Hxt.prototype),lt(Hxt.prototype,"affectedByScale",[Uxt],Object.getOwnPropertyDescriptor(Hxt.prototype,"affectedByScale"),Hxt.prototype),jxt=lt(Hxt.prototype,"_resizeMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lSt.NONE}}),Wxt=lt(Hxt.prototype,"_layoutType",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cSt.NONE}}),qxt=lt(Hxt.prototype,"_cellSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $i(40,40)}}),Xxt=lt(Hxt.prototype,"_startAxis",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uSt.HORIZONTAL}}),Yxt=lt(Hxt.prototype,"_paddingLeft",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kxt=lt(Hxt.prototype,"_paddingRight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jxt=lt(Hxt.prototype,"_paddingTop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qxt=lt(Hxt.prototype,"_paddingBottom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zxt=lt(Hxt.prototype,"_spacingX",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$xt=lt(Hxt.prototype,"_spacingY",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tSt=lt(Hxt.prototype,"_verticalDirection",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hSt.TOP_TO_BOTTOM}}),eSt=lt(Hxt.prototype,"_horizontalDirection",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _St.LEFT_TO_RIGHT}}),iSt=lt(Hxt.prototype,"_constraint",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fSt.NONE}}),nSt=lt(Hxt.prototype,"_constraintNum",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),rSt=lt(Hxt.prototype,"_affectedByScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oSt=lt(Hxt.prototype,"_isAlign",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gxt=Hxt))||Gxt)||Gxt)||Gxt)||Gxt)||Gxt)||Gxt));u.Layout=VSt,function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(FSt||(FSt={})),oe(FSt);var kSt,USt,GSt,HSt,jSt,WSt,qSt,XSt,YSt,KSt,JSt,QSt,ZSt,$St,tbt,ebt,ibt,nbt,rbt,obt,abt,sbt,cbt,lbt,ubt=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((dSt=pc("cc.ProgressBar"),mSt=Rc(),vSt=mc(110),gSt=wc(),ySt=dc(NH),xSt=Kc(cY),SSt=Nc(),bSt=Kc(FSt),CSt=Nc(),ASt=Nc(),TSt=Lc(),wSt=Nc(),ESt=Nc(),dSt(PSt=mSt(PSt=vSt(PSt=gSt(PSt=ySt((LSt=NSt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_barSprite",RSt,ot(e)),ct(e,"_mode",DSt,ot(e)),ct(e,"_totalLength",MSt,ot(e)),ct(e,"_progress",OSt,ot(e)),ct(e,"_reverse",BSt,ot(e)),e}$(e,t);var i=e.prototype;return i._initBarSprite=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===cY.FillType.RADIAL&&(this._mode=FSt.FILLED),this._mode===FSt.HORIZONTAL?this.totalLength=r.width:this._mode===FSt.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){var o=-i.width*n.x;t.setPosition(o,0,0)}}},i._updateBarStatus=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=t._uiProps.uiTransformComp,i=e.anchorPoint,n=e.contentSize,r=t.getPosition(),o=new qi(0,.5),a=si(this._progress),s=this._totalLength*a,c=n,l=0,u=0;switch(this._mode){case FSt.HORIZONTAL:this._reverse&&(o=new qi(1,.5)),c=new $i(s,n.height),l=this._totalLength,u=n.height;break;case FSt.VERTICAL:o=this._reverse?new qi(.5,1):new qi(.5,0),c=new $i(n.width,s),l=n.width,u=this._totalLength}if(this._mode===FSt.FILLED)this._barSprite.type!==cY.Type.FILLED?S("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==cY.Type.FILLED){var h=o.x-i.x,_=o.y-i.y,f=new Ei(l*h,u*_,0);t.setPosition(r.x+f.x,r.y+f.y,r.z),e.setAnchorPoint(o),e.setContentSize(c)}else S("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},Q(e,[{key:"barSprite",get:function(){return this._barSprite},set:function(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){var e=this._barSprite.node;if(!e)return;var i=e._uiProps.uiTransformComp.contentSize;this._mode===FSt.HORIZONTAL?this.totalLength=i.width:this._mode===FSt.VERTICAL?this.totalLength=i.height:this._mode===FSt.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(t){this._mode===FSt.FILLED&&(t=si(t)),this._totalLength=t,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),e}($u),NSt.Mode=FSt,lt((ISt=LSt).prototype,"barSprite",[xSt,SSt],Object.getOwnPropertyDescriptor(ISt.prototype,"barSprite"),ISt.prototype),lt(ISt.prototype,"mode",[bSt,CSt],Object.getOwnPropertyDescriptor(ISt.prototype,"mode"),ISt.prototype),lt(ISt.prototype,"totalLength",[ASt],Object.getOwnPropertyDescriptor(ISt.prototype,"totalLength"),ISt.prototype),lt(ISt.prototype,"progress",[TSt,kc,wSt],Object.getOwnPropertyDescriptor(ISt.prototype,"progress"),ISt.prototype),lt(ISt.prototype,"reverse",[ESt],Object.getOwnPropertyDescriptor(ISt.prototype,"reverse"),ISt.prototype),RSt=lt(ISt.prototype,"_barSprite",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DSt=lt(ISt.prototype,"_mode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FSt.HORIZONTAL}}),MSt=lt(ISt.prototype,"_totalLength",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),OSt=lt(ISt.prototype,"_progress",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),BSt=lt(ISt.prototype,"_reverse",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PSt=ISt))||PSt)||PSt)||PSt)||PSt)||PSt));u.ProgressBar=ubt;var hbt,_bt=new Ei,fbt=new Ei,pbt=new Ei,dbt=new qi,mbt=new Ti,vbt=new qi;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(hbt||(hbt={})),ce(hbt);var gbt,ybt=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((kSt=pc("cc.ScrollBar"),USt=Rc(),GSt=mc(110),HSt=wc(),jSt=dc(NH),WSt=Kc(cY),qSt=Uc(),XSt=Nc(),YSt=Kc(hbt),KSt=Uc(),JSt=Nc(),QSt=Uc(),ZSt=Nc(),$St=Uc(),tbt=Nc(),kSt(ebt=USt(ebt=GSt(ebt=HSt(ebt=jSt((lbt=cbt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_scrollView",nbt,ot(e)),ct(e,"_handle",rbt,ot(e)),ct(e,"_direction",obt,ot(e)),ct(e,"_enableAutoHide",abt,ot(e)),ct(e,"_autoHideTime",sbt,ot(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}$(e,t);var i=e.prototype;return i.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},i.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},i.onScroll=function(t){if(this._scrollView){var e=this._scrollView.content;if(e){var i=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=vbt;u.set(0,0),this._direction===hbt.HORIZONTAL?(o=i.width,a=n.width,l=r.width,s=t.x,this._convertToScrollViewSpace(u,e),c=-u.x):this._direction===hbt.VERTICAL&&(o=i.height,a=n.height,l=r.height,s=t.y,this._convertToScrollViewSpace(u,e),c=-u.y);var h=this._calculateLength(o,a,l,s),_=vbt;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},i.setScrollView=function(t){this._scrollView=t},i.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},i.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var t=this._scrollView.content;if(t){var e=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,i))return}}this._autoHideRemainingTime=this._autoHideTime}},i.onEnable=function(){var t=this.node.getComponent(cY);t&&(this._opacity=t.color.a)},i.start=function(){this._enableAutoHide&&this._setOpacity(0)},i.update=function(t){this._processAutoHide(t)},i._convertToScrollViewSpace=function(t,e){var i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp;if(i&&n){_bt.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(_bt,fbt);var r=i.convertToNodeSpaceAR(fbt);r.x+=i.anchorX*i.width,r.y+=i.anchorY*i.height,t.set(r.x,r.y)}else t.set(qi.ZERO)},i._setOpacity=function(t){if(this._handle){var e=this.node.getComponent(cY);e&&(mbt.set(e.color),mbt.a=t,e.color=mbt),(e=this._handle.getComponent(cY))&&(mbt.set(e.color),mbt.a=t,e.color=mbt)}},i._updateHandlerPosition=function(t){if(this._handle){var e=pbt;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}},i._fixupHandlerPosition=function(t){var e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;Ei.set(_bt,-i.width*n.x,-i.height*n.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(_bt,fbt),s=t;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===hbt.HORIZONTAL?s.set(s.x,s.y+(i.height-r.height)/2,s.z):this.direction===hbt.VERTICAL&&s.set(s.x+(i.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},i._conditionalDisableScrollBar=function(t,e){return t.width<=e.width&&this._direction===hbt.HORIZONTAL||t.height<=e.height&&this._direction===hbt.VERTICAL},i._calculateLength=function(t,e,i,n){var r=t;return n&&(r+=20*(n>0?n:-n)),i*(e/r)},i._calculatePosition=function(t,e,i,n,r,o,a){var s=e-i;o&&(s+=Math.abs(o));var c=0;s&&(c=si(c=r/s));var l=(n-a)*c;this._direction===hbt.VERTICAL?t.set(0,l):t.set(l,0)},i._updateLength=function(t){if(this._handle){var e=this._handle.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint;n.x===dbt.x&&n.y===dbt.y||e.setAnchorPoint(dbt),this._direction===hbt.HORIZONTAL?e.setContentSize(t,i.height):e.setContentSize(i.width,t)}},i._processAutoHide=function(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}},Q(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t,this.onScroll(qi.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this.onScroll(qi.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(t){this._autoHideTime!==t&&(this._autoHideTime=t)}}]),e}($u),cbt.Direction=hbt,lt((ibt=lbt).prototype,"handle",[WSt,qSt,XSt],Object.getOwnPropertyDescriptor(ibt.prototype,"handle"),ibt.prototype),lt(ibt.prototype,"direction",[YSt,KSt,JSt],Object.getOwnPropertyDescriptor(ibt.prototype,"direction"),ibt.prototype),lt(ibt.prototype,"enableAutoHide",[QSt,ZSt],Object.getOwnPropertyDescriptor(ibt.prototype,"enableAutoHide"),ibt.prototype),lt(ibt.prototype,"autoHideTime",[$St,tbt],Object.getOwnPropertyDescriptor(ibt.prototype,"autoHideTime"),ibt.prototype),nbt=lt(ibt.prototype,"_scrollView",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rbt=lt(ibt.prototype,"_handle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),obt=lt(ibt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hbt.HORIZONTAL}}),abt=lt(ibt.prototype,"_enableAutoHide",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sbt=lt(ibt.prototype,"_autoHideTime",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ebt=ibt))||ebt)||ebt)||ebt)||ebt)||ebt));u.ScrollBar=ybt;var xbt,Sbt,bbt,Cbt,Abt,Tbt,wbt,Ebt,Pbt,Ibt,Rbt,Dbt,Mbt,Obt,Bbt,Nbt,Lbt,Fbt,zbt,Vbt,kbt,Ubt,Gbt,Hbt,jbt,Wbt,qbt,Xbt,Ybt,Kbt,Jbt,Qbt,Zbt,$bt,tCt,eCt,iCt,nCt,rCt,oCt,aCt,sCt,cCt,lCt,uCt,hCt,_Ct,fCt,pCt=t("ViewGroup",pc("cc.ViewGroup")(gbt=mc(110)(gbt=function(t){function e(){return t.apply(this,arguments)||this}return $(e,t),e}($u))||gbt)||gbt);u.ViewGroup=pCt;var dCt,mCt=1e-4,vCt=new Ei,gCt=new Ei,yCt=new qi,xCt=new qi,SCt=function(){return(new Date).getMilliseconds()},bCt={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(dCt||(dCt={}));var CCt,ACt,TCt,wCt,ECt,PCt,ICt,RCt,DCt,MCt,OCt,BCt,NCt,LCt,FCt,zCt,VCt,kCt,UCt,GCt,HCt,jCt=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((xbt=pc("cc.ScrollView"),Sbt=Rc(),bbt=mc(110),Cbt=wc(),Abt=dc(NH),Tbt=Lc(),wbt=Uc(),Ebt=Nc(),Pbt=Lc(),Ibt=Uc(),Rbt=Nc(),Dbt=Uc(),Mbt=Nc(),Obt=Uc(),Bbt=Nc(),Nbt=Kc(jT),Lbt=Uc(),Fbt=Nc(),zbt=Uc(),Vbt=Nc(),kbt=Kc(ybt),Ubt=Uc(),Gbt=Nc(),Hbt=Uc(),jbt=Nc(),Wbt=Kc(ybt),qbt=Uc(),Xbt=Nc(),Ybt=Uc(),Kbt=Nc(),Jbt=Kc([zL]),Qbt=Uc(),Zbt=Nc(),xbt($bt=Sbt($bt=bbt($bt=Cbt($bt=Abt((fCt=_Ct=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"bounceDuration",eCt,ot(e)),ct(e,"brake",iCt,ot(e)),ct(e,"elastic",nCt,ot(e)),ct(e,"inertia",rCt,ot(e)),ct(e,"horizontal",oCt,ot(e)),ct(e,"vertical",aCt,ot(e)),ct(e,"cancelInnerEvents",sCt,ot(e)),ct(e,"scrollEvents",cCt,ot(e)),e._autoScrolling=!1,e._scrolling=!1,ct(e,"_content",lCt,ot(e)),ct(e,"_horizontalScrollBar",uCt,ot(e)),ct(e,"_verticalScrollBar",hCt,ot(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new Ei,e._autoScrollTargetDelta=new Ei,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new Ei,e._outOfBoundaryAmount=new Ei,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new Ei,e._deltaPos=new Ei,e}$(e,t);var i=e.prototype;return i.scrollToBottom=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i,!0)},i.scrollToTop=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToLeft=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToRight=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToTopLeft=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToTopRight=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToBottomLeft=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToBottomRight=function(t,e){void 0===e&&(e=!0);var i=this._calculateMovePercentDelta({anchor:new qi(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)},i.scrollToOffset=function(t,e,i){void 0===i&&(i=!0);var n=this.getMaxScrollOffset(),r=new qi(0,0);0===n.x?r.x=0:r.x=t.x/n.x,0===n.y?r.y=1:r.y=(n.y-t.y)/n.y,this.scrollTo(r,e,i)},i.getScrollOffset=function(){var t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new qi(e,t)},i.getMaxScrollOffset=function(){if(!this._content||!this.view)return qi.ZERO;var t=this._content._uiProps.uiTransformComp.contentSize,e=t.width-this.view.width,i=t.height-this.view.height;return new qi(e=e>=0?e:0,i=i>=0?i:0)},i.scrollToPercentHorizontal=function(t,e,i){var n=this._calculateMovePercentDelta({anchor:new qi(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==i):this._moveContent(n)},i.scrollTo=function(t,e,i){var n=this._calculateMovePercentDelta({anchor:new qi(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)},i.scrollToPercentVertical=function(t,e,i){var n=this._calculateMovePercentDelta({anchor:new qi(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)},i.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},i.setContentPosition=function(t){this._setContentPosition(t)},i._setContentPosition=function(t){if(this._content){var e=this._getContentPosition();Math.abs(t.x-e.x)<mCt&&Math.abs(t.y-e.y)<mCt||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}},i.getContentPosition=function(){return this._getContentPosition()},i._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Ei.ZERO.clone()},i.isScrolling=function(){return this._scrolling},i.isAutoScrolling=function(){return this._autoScrolling},i.getScrollEndedEventTiming=function(){return mCt},i.start=function(){this._calculateBoundary(),this._content&&HO.once(GO.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},i.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(GC.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(GC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(GC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(GC.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},i.update=function(t){this._autoScrolling&&this._processAutoScrolling(t)},i.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(GC.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(GC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(GC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(GC.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},i._registerEvent=function(){this.node.on(GC.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(GC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(GC.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(GC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(GC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},i._unregisterEvent=function(){this.node.off(GC.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(GC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(GC.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(GC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(GC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},i._onMouseWheel=function(t,e){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(t,e)){var i=new Ei,n=t.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}},i._onTouchBegan=function(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))},i._onTouchMoved=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){var i=t.touch;if(this._handleMoveLogic(i),this.cancelInnerEvents){var n=i.getUILocation(yCt);if(n.subtract(i.getUIStartLocation(xCt)),n.length()>7&&!this._touchMoved&&t.target!==this.node){var r=new XR(t.getTouches(),t.bubbles,Vw.TOUCH_CANCEL);r.touch=t.touch,r.simulate=!0,t.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}}},i._onTouchEnded=function(t,e){if(this.enabledInHierarchy&&this._content&&t&&!this._hasNestedViewGroup(t,e)){this._dispatchEvent(dCt.TOUCH_UP);var i=t.touch;this._handleReleaseLogic(i),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}},i._onTouchCancelled=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){var i=t.touch;this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(t)}},i._calculateBoundary=function(){if(this._content&&this.view){var t=this._content.getComponent(VSt);t&&t.enabledInHierarchy&&t.updateLayout();var e=this.view,i=e.width*e.anchorX,n=e.height*e.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}},i._hasNestedViewGroup=function(t,e){if(!t||t.eventPhase!==GR.CAPTURING_PHASE)return!1;if(e)for(var i,n=st(e);!(i=n()).done;){var r=i.value;if(this.node===r)return!(!t.target||!t.target.getComponent(pCt));if(r.getComponent(pCt))return!0}return!1},i._startInertiaScroll=function(t){var e=new Ei(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)},i._calculateAttenuatedFactor=function(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))},i._startAttenuatingAutoScroll=function(t,e){var i=t.clone();if(i.normalize(),this._content&&this.view){var n=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=n.width-r.width,a=n.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);i.x=i.x*o*(1-this.brake)*s,i.y=i.y*a*c*(1-this.brake),i.z=0}var l=t.length(),u=i.length()/l;if(i.add(t),this.brake>0&&u>7){u=Math.sqrt(u);var h=t.clone();h.multiplyScalar(u),i.set(h),i.add(t)}var _=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(i,_,!0)},i._calculateAutoScrollTimeByInitialSpeed=function(t){return Math.sqrt(Math.sqrt(t/5))},i._startAutoScroll=function(t,e,i){void 0===i&&(i=!1);var n=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,Ei.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Ei.ZERO,mCt)||(this._autoScrollCurrentlyOutOfBoundary=!0)},i._calculateTouchMoveVelocity=function(){var t=new Ei,e=0;if((e=this._touchMoveTimeDeltas.reduce((function(t,e){return t+e}),e))<=0||e>=.5)t.set(Ei.ZERO);else{var i=new Ei;i=this._touchMoveDisplacements.reduce((function(t,e){return t.add(e),t}),i),t.set(i.x*(1-this.brake)/e,i.y*(1-this.brake)/e,i.z)}return t},i._flattenVectorByDirection=function(t){var e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},i._moveContent=function(t,e){var i=this._flattenVectorByDirection(t);vCt.set(this._getContentPosition()),vCt.add(i),vCt.set(Math.round(1e4*vCt.x)*mCt,Math.round(1e4*vCt.y)*mCt,vCt.z),this._setContentPosition(vCt);var n=this._getHowMuchOutOfBoundary();yCt.set(n.x,n.y),this._updateScrollBar(yCt),this.elastic&&e&&this._startBounceBackIfNeeded()},i._getContentLeftBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width},i._getContentRightBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width},i._getContentTopBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height},i._getContentBottomBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height},i._getHowMuchOutOfBoundary=function(t){if((t=t||new Ei).equals(Ei.ZERO,mCt)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var e=new Ei,i=this._getContentLeftBoundary(),n=this._getContentRightBoundary();i+t.x>this._leftBoundary?e.x=this._leftBoundary-(i+t.x):n+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(n+t.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):o+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(o+t.y)),t.equals(Ei.ZERO,mCt)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e},i._updateScrollBar=function(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)},i._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},i._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},i._dispatchEvent=function(t){if(t===dCt.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===dCt.SCROLL_TO_TOP||t===dCt.SCROLL_TO_BOTTOM||t===dCt.SCROLL_TO_LEFT||t===dCt.SCROLL_TO_RIGHT){var e=1<<bCt[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}zL.emitEvents(this.scrollEvents,this,bCt[t]),this.node.emit(t,this)},i._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var t=this._getHowMuchOutOfBoundary();vCt.set(this._getContentPosition()),vCt.add(t),this._content.setPosition(vCt),this._updateScrollBar(qi.ZERO)}},i._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},i._updateScrollBarState=function(){if(this._content&&this.view){var t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},i._stopPropagationIfTargetIsMe=function(t){t.eventPhase===GR.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)},i._processDeltaMove=function(t){this._scrollChildren(t),this._gatherTouchMove(t)},i._handleMoveLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)},i._handleReleaseLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(dCt.SCROLL_ENDED))},i._getLocalAxisAlignDelta=function(t,e){var i=this.node._uiProps.uiTransformComp,n=new Ei;i&&(e.getUILocation(yCt),e.getUIPreviousLocation(xCt),vCt.set(yCt.x,yCt.y,0),gCt.set(xCt.x,xCt.y,0),i.convertToNodeSpaceAR(vCt,vCt),i.convertToNodeSpaceAR(gCt,gCt),Ei.subtract(n,vCt,gCt)),t.set(n)},i._scrollChildren=function(t){this._clampDelta(t);var e,i=t;this.elastic&&(e=this._getHowMuchOutOfBoundary(),i.x*=0===e.x?1:.5,i.y*=0===e.y?1:.5),this.elastic||(e=this._getHowMuchOutOfBoundary(i),i.add(e));var n="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||Ei.ZERO;this.vertical&&(i.y>0?u.y-s*l+i.y>=this._bottomBoundary&&(n=dCt.SCROLL_TO_BOTTOM):i.y<0&&u.y-s*l+l+i.y<=this._topBoundary&&(n=dCt.SCROLL_TO_TOP)),this.horizontal&&(i.x<0?u.x-a*c+c+i.x<=this._rightBoundary&&(r=dCt.SCROLL_TO_RIGHT):i.x>0&&u.x-a*c+i.x>=this._leftBoundary&&(r=dCt.SCROLL_TO_LEFT))}this._moveContent(i,!1),(this.horizontal&&0!==i.x||this.vertical&&0!==i.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(dCt.SCROLL_BEGAN)),this._dispatchEvent(dCt.SCROLLING)),""!==n&&this._dispatchEvent(n),""!==r&&this._dispatchEvent(r)},i._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(dCt.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=SCt(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},i._clampDelta=function(t){if(this._content&&this.view){var e=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<e.width&&(t.x=0),i.height<e.height&&(t.y=0)}},i._gatherTouchMove=function(t){var e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var i=SCt();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i},i._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(Ei.ZERO,mCt))return!1;var e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(dCt.BOUNCE_TOP),t.y<0&&this._dispatchEvent(dCt.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(dCt.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(dCt.BOUNCE_LEFT),this._isBouncing=!0),!0},i._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var t=this._calculateTouchMoveVelocity();!t.equals(vCt,mCt)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()},i._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Ei.ZERO,mCt)},i._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},i._processAutoScrolling=function(t){var e=this._isNecessaryAutoScrollBrake(),i=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/i);var n,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=mCt;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(dCt.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),e&&c.multiplyScalar(i),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Ei.ZERO,mCt)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(dCt.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(dCt.SCROLL_ENDED))},i._checkMouseWheel=function(t){if(!this._getHowMuchOutOfBoundary().equals(Ei.ZERO,mCt))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(dCt.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(dCt.SCROLL_ENDED),this._stopMouseWheel=!1)},i._calculateMovePercentDelta=function(t){var e=t.anchor,i=t.applyToHorizontal,n=t.applyToVertical;this._calculateBoundary(),e.clampf(qi.ZERO,qi.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new Ei;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;i&&(s=c.width-l.width,a.x=o-s*e.x),n&&(s=c.height-l.height,a.y=r-s*e.y)}return a},i._moveContentToTopLeft=function(t){var e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;var i=new Ei,n=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(n=o.height-t.height,i.y=e-n),o.width<t.width&&(n=o.width-t.width,i.x=r)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()},i._scaleChanged=function(t){t===ny.SCALE&&this._calculateBoundary()},Q(e,[{key:"content",get:function(){return this._content},set:function(t){if(this._content!==t){var e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):I(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(qi.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(qi.ZERO)))}},{key:"view",get:function(){var t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}}]),e}(pCt),_Ct.EventType=dCt,eCt=lt((tCt=fCt).prototype,"bounceDuration",[xc,Tbt,wbt,Ebt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iCt=lt(tCt.prototype,"brake",[xc,Pbt,Ibt,Rbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),nCt=lt(tCt.prototype,"elastic",[xc,Dbt,Mbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rCt=lt(tCt.prototype,"inertia",[xc,Obt,Bbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(tCt.prototype,"content",[Nbt,Lbt,Fbt],Object.getOwnPropertyDescriptor(tCt.prototype,"content"),tCt.prototype),oCt=lt(tCt.prototype,"horizontal",[xc,zbt,Vbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(tCt.prototype,"horizontalScrollBar",[kbt,Ubt,Gbt],Object.getOwnPropertyDescriptor(tCt.prototype,"horizontalScrollBar"),tCt.prototype),aCt=lt(tCt.prototype,"vertical",[xc,Hbt,jbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lt(tCt.prototype,"verticalScrollBar",[Wbt,qbt,Xbt],Object.getOwnPropertyDescriptor(tCt.prototype,"verticalScrollBar"),tCt.prototype),sCt=lt(tCt.prototype,"cancelInnerEvents",[xc,Ybt,Kbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cCt=lt(tCt.prototype,"scrollEvents",[Jbt,xc,Qbt,Zbt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lCt=lt(tCt.prototype,"_content",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uCt=lt(tCt.prototype,"_horizontalScrollBar",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hCt=lt(tCt.prototype,"_verticalScrollBar",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$bt=tCt))||$bt)||$bt)||$bt)||$bt)||$bt));u.ScrollView=jCt;var WCt,qCt=new Ei;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(WCt||(WCt={})),ce(WCt);var XCt,YCt,KCt,JCt,QCt,ZCt,$Ct,tAt,eAt,iAt,nAt,rAt,oAt,aAt,sAt,cAt,lAt,uAt,hAt,_At,fAt=function(e){return t({Slider:e,SliderComponent:e}),e}((CCt=pc("cc.Slider"),ACt=Rc(),TCt=mc(110),wCt=wc(),ECt=dc(NH),PCt=Kc(cY),ICt=Nc(),RCt=Kc(WCt),DCt=Nc(),MCt=Lc(),OCt=Nc(),BCt=Kc([zL]),NCt=Nc(),CCt(LCt=ACt(LCt=TCt(LCt=wCt(LCt=ECt((HCt=GCt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"slideEvents",zCt,ot(e)),ct(e,"_handle",VCt,ot(e)),ct(e,"_direction",kCt,ot(e)),ct(e,"_progress",UCt,ot(e)),e._offset=new Ei,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new Ei,e._touchPos=new Ei,e}$(e,t);var i=e.prototype;return i.__preload=function(){this._updateHandlePosition()},i.onEnable=function(){this._updateHandlePosition(),this.node.on(GC.TOUCH_START,this._onTouchBegan,this),this.node.on(GC.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(GC.TOUCH_END,this._onTouchEnded,this),this.node.on(GC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(GC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(GC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(GC.TOUCH_END,this._onTouchEnded,this))},i.onDisable=function(){this.node.off(GC.TOUCH_START,this._onTouchBegan,this),this.node.off(GC.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(GC.TOUCH_END,this._onTouchEnded,this),this.node.off(GC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(GC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(GC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(GC.TOUCH_END,this._onTouchEnded,this))},i._onHandleDragStart=function(t){if(t&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var e=t.touch.getUILocation();Ei.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}},i._onTouchBegan=function(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)},i._onTouchMoved=function(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)},i._onTouchEnded=function(t){this._dragging=!1,this._touchHandle=!1,this._offset=new Ei,t&&(t.propagationStopped=!0)},i._onTouchCancelled=function(t){this._dragging=!1,t&&(t.propagationStopped=!0)},i._handleSliderLogic=function(t){this._updateProgress(t),this._emitSlideEvent()},i._emitSlideEvent=function(){zL.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},i._updateProgress=function(t){if(this._handle&&t){var e=t.getUILocation();Ei.set(this._touchPos,e.x,e.y,0);var i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,qCt);this.direction===WCt.Horizontal?this.progress=si(.5+(n.x-this._offset.x)/i.width):this.progress=si(.5+(n.y-this._offset.y)/i.height)}},i._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var t=this.node._uiProps.uiTransformComp;this._direction===WCt.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}},i._changeLayout=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){var i=this._handle.node.position;this._direction===WCt.Horizontal?this._handle.node.setPosition(i.x,0,i.z):this._handle.node.setPosition(0,i.y,i.z),this._updateHandlePosition()}},Q(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}}]),e}($u),GCt.Direction=WCt,lt((FCt=HCt).prototype,"handle",[PCt,ICt],Object.getOwnPropertyDescriptor(FCt.prototype,"handle"),FCt.prototype),lt(FCt.prototype,"direction",[RCt,DCt],Object.getOwnPropertyDescriptor(FCt.prototype,"direction"),FCt.prototype),lt(FCt.prototype,"progress",[kc,MCt,OCt],Object.getOwnPropertyDescriptor(FCt.prototype,"progress"),FCt.prototype),zCt=lt(FCt.prototype,"slideEvents",[BCt,xc,NCt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VCt=lt(FCt.prototype,"_handle",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kCt=lt(FCt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WCt.Horizontal}}),UCt=lt(FCt.prototype,"_progress",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),LCt=FCt))||LCt)||LCt)||LCt)||LCt)||LCt));function pAt(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return Object.assign.apply(Object,[{}].concat(e))}u.Slider=fAt,function(t){t.TOGGLE="toggle"}(_At||(_At={}));var dAt,mAt,vAt,gAt,yAt,xAt,SAt,bAt,CAt,AAt,TAt,wAt,EAt=function(e){return t({Toggle:e,ToggleComponent:e}),e}((XCt=pc("cc.Toggle"),YCt=Rc(),KCt=mc(110),JCt=wc(),QCt=dc(NH),ZCt=Uc(),$Ct=Nc(),tAt=Kc(cY),eAt=Uc(),iAt=Nc(),nAt=Kc([zL]),rAt=Nc(),XCt(oAt=YCt(oAt=KCt(oAt=JCt(oAt=QCt((hAt=uAt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"checkEvents",sAt,ot(e)),ct(e,"_isChecked",cAt,ot(e)),ct(e,"_checkMark",lAt,ot(e)),e}$(e,t);var i=e.prototype;return i._internalToggle=function(){this.isChecked=!this.isChecked},i._set=function(t,e){if(void 0===e&&(e=!0),this._isChecked!=t){this._isChecked=t;var i=this._toggleContainer;i&&i.enabled&&this.enabled&&(t||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}},i.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},i.setIsCheckedWithoutNotify=function(t){this._set(t,!1)},i.onEnable=function(){t.prototype.onEnable.call(this),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)},i.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(e.EventType.CLICK,this._internalToggle,this)},i.OnDestroy=function(){var t=this._toggleContainer;t&&t.ensureValidState()},i._emitToggleEvents=function(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&zL.emitEvents(this.checkEvents,this)},Q(e,[{key:"isChecked",get:function(){return this._isChecked},set:function(t){this._set(t)}},{key:"checkMark",get:function(){return this._checkMark},set:function(t){this._checkMark!==t&&(this._checkMark=t)}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var t=this.node.parent;return u.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}}]),e}(Ggt),uAt.EventType=pAt(_At,kgt),lt((aAt=hAt).prototype,"isChecked",[ZCt,$Ct],Object.getOwnPropertyDescriptor(aAt.prototype,"isChecked"),aAt.prototype),lt(aAt.prototype,"checkMark",[tAt,eAt,iAt],Object.getOwnPropertyDescriptor(aAt.prototype,"checkMark"),aAt.prototype),sAt=lt(aAt.prototype,"checkEvents",[nAt,xc,rAt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cAt=lt(aAt.prototype,"_isChecked",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lAt=lt(aAt.prototype,"_checkMark",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oAt=aAt))||oAt)||oAt)||oAt)||oAt)||oAt));u.Toggle=EAt;var PAt,IAt,RAt,DAt,MAt,OAt,BAt,NAt,LAt,FAt,zAt,VAt,kAt,UAt,GAt,HAt,jAt,WAt,qAt,XAt,YAt,KAt,JAt,QAt,ZAt,$At,tTt,eTt,iTt,nTt,rTt,oTt,aTt,sTt,cTt,lTt,uTt,hTt,_Tt,fTt,pTt,dTt,mTt,vTt,gTt,yTt=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((dAt=pc("cc.ToggleContainer"),mAt=Rc(),vAt=mc(110),gAt=wc(),yAt=Nc(),xAt=Kc([zL]),SAt=Nc(),dAt(bAt=mAt(bAt=vAt(bAt=gAt(bAt=Tc((wAt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"_allowSwitchOff",AAt,ot(e)),ct(e,"checkEvents",TAt,ot(e)),e}$(e,t);var i=e.prototype;return i.onEnable=function(){this.ensureValidState(),this.node.on(GC.CHILD_ADDED,this.ensureValidState,this),this.node.on(GC.CHILD_REMOVED,this.ensureValidState,this)},i.onDisable=function(){this.node.off(GC.CHILD_ADDED,this.ensureValidState,this),this.node.off(GC.CHILD_REMOVED,this.ensureValidState,this)},i.activeToggles=function(){return this.toggleItems.filter((function(t){return t.isChecked}))},i.anyTogglesChecked=function(){return!!this.toggleItems.find((function(t){return t.isChecked}))},i.notifyToggleCheck=function(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(var i=0;i<this.toggleItems.length;i++){var n=this.toggleItems[i];n!==t&&(e?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&u.Component.EventHandler.emitEvents(this.checkEvents,t)}},i.ensureValidState=function(){var t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){var e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}var i=this.activeToggles();if(i.length>1)for(var n=i[0],r=0;r<i.length;++r){var o=i[r];o!==n&&(o.isChecked=!1)}},Q(e,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(t){this._allowSwitchOff=t}},{key:"toggleItems",get:function(){return this.node.children.map((function(t){var e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}}]),e}($u),AAt=lt((CAt=wAt).prototype,"_allowSwitchOff",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lt(CAt.prototype,"allowSwitchOff",[yAt],Object.getOwnPropertyDescriptor(CAt.prototype,"allowSwitchOff"),CAt.prototype),TAt=lt(CAt.prototype,"checkEvents",[xAt,xc,SAt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bAt=CAt))||bAt)||bAt)||bAt)||bAt)||bAt));u.ToggleContainer=yTt;var xTt,STt,bTt=new qi;function CTt(t){return t instanceof SD?qO:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:$i.ZERO}function ATt(t,e,i,n){t.parent?bTt.set(t.parent.getScale().x,t.parent.getScale().y):bTt.set(0,0);for(var r=bTt.x,o=bTt.y,a=0,s=0,c=t.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===e)break;c?bTt.set(c.getScale().x,c.getScale().y):bTt.set(0,0);var u=bTt.x,h=bTt.y;a*=u,s*=h,r*=u,o*=h}n.x=0!==r?1/r:1,n.y=0!==o?1/o:1,i.x=-a,i.y=-s}!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(xTt||(xTt={})),ce(xTt),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(STt||(STt={}));var TTt,wTt,ETt,PTt,ITt,RTt,DTt,MTt,OTt,BTt,NTt,LTt,FTt,zTt,VTt,kTt,UTt,GTt,HTt,jTt=STt.TOP|STt.BOT,WTt=STt.LEFT|STt.RIGHT,qTt=function(e){return t({Widget:e,WidgetComponent:e}),e}((PAt=pc("cc.Widget"),IAt=Rc(),RAt=mc(110),DAt=wc(),MAt=dc(NH),OAt=Kc(jT),BAt=Nc(),NAt=Nc(),LAt=Nc(),FAt=Nc(),zAt=Nc(),VAt=Nc(),kAt=Nc(),UAt=Mc(),GAt=Mc(),HAt=Nc(),jAt=Nc(),WAt=Nc(),qAt=Nc(),XAt=Nc(),YAt=Nc(),KAt=Kc(xTt),JAt=Nc(),PAt(QAt=IAt(QAt=RAt(QAt=DAt(QAt=MAt(QAt=Tc((gTt=vTt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._lastPos=new Ei,e._lastSize=new $i,e._dirty=!0,e._hadAlignOnce=!1,ct(e,"_alignFlags",$At,ot(e)),ct(e,"_target",tTt,ot(e)),ct(e,"_left",eTt,ot(e)),ct(e,"_right",iTt,ot(e)),ct(e,"_top",nTt,ot(e)),ct(e,"_bottom",rTt,ot(e)),ct(e,"_horizontalCenter",oTt,ot(e)),ct(e,"_verticalCenter",aTt,ot(e)),ct(e,"_isAbsLeft",sTt,ot(e)),ct(e,"_isAbsRight",cTt,ot(e)),ct(e,"_isAbsTop",lTt,ot(e)),ct(e,"_isAbsBottom",uTt,ot(e)),ct(e,"_isAbsHorizontalCenter",hTt,ot(e)),ct(e,"_isAbsVerticalCenter",_Tt,ot(e)),ct(e,"_originalWidth",fTt,ot(e)),ct(e,"_originalHeight",pTt,ot(e)),ct(e,"_alignMode",dTt,ot(e)),ct(e,"_lockFlags",mTt,ot(e)),e}$(e,t);var i=e.prototype;return i.updateAlignment=function(){u._widgetManager.updateAlignment(this.node)},i._validateTargetInDEV=function(){},i.setDirty=function(){this._recursiveDirty()},i.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),u._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},i.onDisable=function(){u._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},i.onDestroy=function(){this._removeParentEvent()},i._adjustWidgetToAllowMovingInEditor=function(){},i._adjustWidgetToAllowResizingInEditor=function(){},i._adjustWidgetToAnchorChanged=function(){this.setDirty()},i._adjustTargetToParentChanged=function(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},i._registerEvent=function(){this.node.on(GC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(GC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(GC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(GC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},i._unregisterEvent=function(){this.node.off(GC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(GC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(GC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},i._removeParentEvent=function(){this.node.off(GC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},i._autoChangedValue=function(t,e){if((this._alignFlags&t)>0){var i=this.node.parent&&this.node.parent._uiProps,n=i&&i.uiTransformComp,r=n?n.contentSize:qO;this.isAlignLeft&&t===STt.LEFT?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&t===STt.RIGHT?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&t===STt.CENTER?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&t===STt.TOP?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&t===STt.BOT?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&t===STt.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},i._registerTargetEvents=function(){var t=this._target||this.node.parent;t&&t.getComponent(NH)&&(t.on(GC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(GC.SIZE_CHANGED,this._setDirtyByMode,this),t.on(GC.ANCHOR_CHANGED,this._setDirtyByMode,this))},i._unregisterTargetEvents=function(){var t=this._target||this.node.parent;t&&(t.off(GC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(GC.SIZE_CHANGED,this._setDirtyByMode,this),t.off(GC.ANCHOR_CHANGED,this._setDirtyByMode,this))},i._unregisterOldParentEvents=function(t){var e=this._target||t;e&&(e.off(GC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(GC.SIZE_CHANGED,this._setDirtyByMode,this))},i._setDirtyByMode=function(){this.alignMode===xTt.ALWAYS&&this._recursiveDirty()},i._setAlign=function(t,e){if(e!==(this._alignFlags&t)>0){var i=(t&WTt)>0,n=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~t)}},i._recursiveDirty=function(){this._dirty||(this._dirty=!0)},Q(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&STt.TOP)>0},set:function(t){this._setAlign(STt.TOP,t),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&STt.BOT)>0},set:function(t){this._setAlign(STt.BOT,t),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&STt.LEFT)>0},set:function(t){this._setAlign(STt.LEFT,t),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&STt.RIGHT)>0},set:function(t){this._setAlign(STt.RIGHT,t),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&STt.MID)>0},set:function(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=STt.MID):this._alignFlags&=~STt.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&STt.CENTER)>0},set:function(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=STt.CENTER):this._alignFlags&=~STt.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&WTt)===WTt}},{key:"isStretchHeight",get:function(){return(this._alignFlags&jTt)===jTt}},{key:"top",get:function(){return this._top},set:function(t){this._top=t,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom=t,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(t){this._left=t,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(t){this._right=t,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(t){this._horizontalCenter=t,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(t){this._verticalCenter=t,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(STt.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(STt.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(STt.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(STt.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(STt.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(STt.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(t){this._alignMode=t,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}}]),e}($u),vTt.AlignMode=xTt,lt((ZAt=gTt).prototype,"target",[OAt,BAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"target"),ZAt.prototype),lt(ZAt.prototype,"isAlignTop",[NAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAlignTop"),ZAt.prototype),lt(ZAt.prototype,"isAlignBottom",[LAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAlignBottom"),ZAt.prototype),lt(ZAt.prototype,"isAlignLeft",[FAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAlignLeft"),ZAt.prototype),lt(ZAt.prototype,"isAlignRight",[zAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAlignRight"),ZAt.prototype),lt(ZAt.prototype,"isAlignVerticalCenter",[VAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAlignVerticalCenter"),ZAt.prototype),lt(ZAt.prototype,"isAlignHorizontalCenter",[kAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAlignHorizontalCenter"),ZAt.prototype),lt(ZAt.prototype,"isStretchWidth",[UAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isStretchWidth"),ZAt.prototype),lt(ZAt.prototype,"isStretchHeight",[GAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"isStretchHeight"),ZAt.prototype),lt(ZAt.prototype,"top",[HAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"top"),ZAt.prototype),lt(ZAt.prototype,"editorTop",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"editorTop"),ZAt.prototype),lt(ZAt.prototype,"bottom",[jAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"bottom"),ZAt.prototype),lt(ZAt.prototype,"editorBottom",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"editorBottom"),ZAt.prototype),lt(ZAt.prototype,"left",[WAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"left"),ZAt.prototype),lt(ZAt.prototype,"editorLeft",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"editorLeft"),ZAt.prototype),lt(ZAt.prototype,"right",[qAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"right"),ZAt.prototype),lt(ZAt.prototype,"editorRight",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"editorRight"),ZAt.prototype),lt(ZAt.prototype,"horizontalCenter",[XAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"horizontalCenter"),ZAt.prototype),lt(ZAt.prototype,"editorHorizontalCenter",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"editorHorizontalCenter"),ZAt.prototype),lt(ZAt.prototype,"verticalCenter",[YAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"verticalCenter"),ZAt.prototype),lt(ZAt.prototype,"editorVerticalCenter",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"editorVerticalCenter"),ZAt.prototype),lt(ZAt.prototype,"isAbsoluteTop",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAbsoluteTop"),ZAt.prototype),lt(ZAt.prototype,"isAbsoluteBottom",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAbsoluteBottom"),ZAt.prototype),lt(ZAt.prototype,"isAbsoluteLeft",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAbsoluteLeft"),ZAt.prototype),lt(ZAt.prototype,"isAbsoluteRight",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAbsoluteRight"),ZAt.prototype),lt(ZAt.prototype,"isAbsoluteHorizontalCenter",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAbsoluteHorizontalCenter"),ZAt.prototype),lt(ZAt.prototype,"isAbsoluteVerticalCenter",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"isAbsoluteVerticalCenter"),ZAt.prototype),lt(ZAt.prototype,"alignMode",[KAt,JAt],Object.getOwnPropertyDescriptor(ZAt.prototype,"alignMode"),ZAt.prototype),lt(ZAt.prototype,"alignFlags",[Dc],Object.getOwnPropertyDescriptor(ZAt.prototype,"alignFlags"),ZAt.prototype),$At=lt(ZAt.prototype,"_alignFlags",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tTt=lt(ZAt.prototype,"_target",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eTt=lt(ZAt.prototype,"_left",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iTt=lt(ZAt.prototype,"_right",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nTt=lt(ZAt.prototype,"_top",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rTt=lt(ZAt.prototype,"_bottom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oTt=lt(ZAt.prototype,"_horizontalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aTt=lt(ZAt.prototype,"_verticalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sTt=lt(ZAt.prototype,"_isAbsLeft",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cTt=lt(ZAt.prototype,"_isAbsRight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lTt=lt(ZAt.prototype,"_isAbsTop",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uTt=lt(ZAt.prototype,"_isAbsBottom",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hTt=lt(ZAt.prototype,"_isAbsHorizontalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_Tt=lt(ZAt.prototype,"_isAbsVerticalCenter",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fTt=lt(ZAt.prototype,"_originalWidth",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pTt=lt(ZAt.prototype,"_originalHeight",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dTt=lt(ZAt.prototype,"_alignMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xTt.ON_WINDOW_RESIZE}}),mTt=lt(ZAt.prototype,"_lockFlags",[xc,bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QAt=ZAt))||QAt)||QAt)||QAt)||QAt)||QAt)||QAt));u.internal.computeInverseTransForTarget=ATt,u.internal.getReadonlyNodeSize=CTt,u.Widget=qTt;var XTt,YTt=new Ti;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(XTt||(XTt={})),ce(XTt);var KTt,JTt,QTt,ZTt,$Tt,twt,ewt,iwt,nwt,rwt,owt,awt,swt,cwt,lwt,uwt,hwt,_wt,fwt,pwt,dwt,mwt,vwt,gwt,ywt,xwt,Swt,bwt,Cwt,Awt,Twt,wwt,Ewt,Pwt,Iwt,Rwt,Dwt,Mwt,Owt,Bwt,Nwt,Lwt,Fwt,zwt=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((TTt=pc("cc.PageViewIndicator"),wTt=Rc(),ETt=mc(110),PTt=wc(),ITt=Kc(cG),RTt=Nc(),DTt=Kc(XTt),MTt=Nc(),OTt=Kc($i),BTt=Nc(),NTt=Nc(),TTt(LTt=wTt(LTt=ETt(LTt=PTt((HTt=GTt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"spacing",zTt,ot(e)),ct(e,"_spriteFrame",VTt,ot(e)),ct(e,"_direction",kTt,ot(e)),ct(e,"_cellSize",UTt,ot(e)),e._layout=null,e._pageView=null,e._indicators=[],e}$(e,t);var i=e.prototype;return i.onLoad=function(){this._updateLayout()},i.setPageView=function(t){this._pageView=t,this._refresh()},i._updateLayout=function(){this._layout=this.getComponent(VSt),this._layout||(this._layout=this.addComponent(VSt));var t=this._layout;this.direction===XTt.HORIZONTAL?(t.type=VSt.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===XTt.VERTICAL&&(t.type=VSt.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=VSt.ResizeMode.CONTAINER},i._createIndicator=function(){var t=new jT;t.layer=this.node.layer;var e=t.addComponent(cY);return e.spriteFrame=this.spriteFrame,e.sizeMode=cY.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t},i._changedState=function(){var t=this._indicators;if(0!==t.length&&this._pageView){var e=this._pageView.curPageIdx;if(!(e>=t.length)){for(var i=0;i<t.length;++i){var n=t[i];if(n._uiProps.uiComp){var r=n._uiProps.uiComp;YTt.set(r.color),YTt.a=127.5,r.color=YTt}}if(t[e]._uiProps.uiComp){var o=t[e]._uiProps.uiComp;YTt.set(o.color),YTt.a=255,o.color=YTt}}}},i._refresh=function(){if(this._pageView){var t=this._indicators,e=this._pageView.getPages();if(e.length!==t.length){var i=0;if(e.length>t.length)for(i=0;i<e.length;++i)t[i]||(t[i]=this._createIndicator());else for(i=t.length-e.length;i>0;--i){var n=t[i-1];this.node.removeChild(n),t.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},Q(e,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._spriteFrame!==t&&(this._spriteFrame=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t)}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize=t)}}]),e}($u),GTt.Direction=XTt,lt((FTt=HTt).prototype,"spriteFrame",[ITt,RTt],Object.getOwnPropertyDescriptor(FTt.prototype,"spriteFrame"),FTt.prototype),lt(FTt.prototype,"direction",[DTt,MTt],Object.getOwnPropertyDescriptor(FTt.prototype,"direction"),FTt.prototype),lt(FTt.prototype,"cellSize",[OTt,BTt],Object.getOwnPropertyDescriptor(FTt.prototype,"cellSize"),FTt.prototype),zTt=lt(FTt.prototype,"spacing",[xc,NTt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VTt=lt(FTt.prototype,"_spriteFrame",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kTt=lt(FTt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XTt.HORIZONTAL}}),UTt=lt(FTt.prototype,"_cellSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $i(20,20)}}),LTt=FTt))||LTt)||LTt)||LTt)||LTt));u.PageViewIndicator=zwt;var Vwt,kwt,Uwt,Gwt=new qi;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(Vwt||(Vwt={})),ce(Vwt),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(kwt||(kwt={})),ce(kwt),function(t){t.PAGE_TURNING="page-turning"}(Uwt||(Uwt={}));var Hwt=function(e){return t({PageView:e,PageViewComponent:e}),e}((KTt=pc("cc.PageView"),JTt=Rc(),QTt=mc(110),ZTt=wc(),$Tt=Kc(Vwt),twt=Nc(),ewt=Kc(kwt),iwt=Nc(),nwt=Lc(),rwt=Nc(),owt=Lc(),awt=Nc(),swt=Kc(zwt),cwt=Nc(),lwt=Nc(),uwt=Kc(ybt),hwt=Mc(),_wt=Kc(ybt),fwt=Mc(),pwt=Mc(),dwt=Mc(),mwt=Mc(),vwt=Kc([zL]),gwt=Mc(),ywt=Nc(),xwt=Kc([zL]),Swt=Nc(),KTt(bwt=JTt(bwt=QTt(bwt=ZTt((Fwt=Lwt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"autoPageTurningThreshold",Awt,ot(e)),ct(e,"horizontal",Twt,ot(e)),ct(e,"vertical",wwt,ot(e)),ct(e,"cancelInnerEvents",Ewt,ot(e)),ct(e,"scrollEvents",Pwt,ot(e)),ct(e,"pageTurningSpeed",Iwt,ot(e)),ct(e,"pageEvents",Rwt,ot(e)),ct(e,"_sizeMode",Dwt,ot(e)),ct(e,"_direction",Mwt,ot(e)),ct(e,"_scrollThreshold",Owt,ot(e)),ct(e,"_pageTurningEventTiming",Bwt,ot(e)),ct(e,"_indicator",Nwt,ot(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new Ei,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new qi,e._touchEndPosition=new qi,e}$(e,t);var i=e.prototype;return i.onEnable=function(){t.prototype.onEnable.call(this),this.node.on(GC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},i.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(GC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},i.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},i.getCurrentPageIndex=function(){return this._curPageIdx},i.setCurrentPageIndex=function(t){this.scrollToPage(t,1)},i.getPages=function(){return this._pages},i.addPage=function(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):I(4301))},i.insertPage=function(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void I(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}},i.removePage=function(t){if(t&&this.content){var e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):D(4300,t.name)}},i.removePageAtIndex=function(t){var e=this._pages;if(!(t<0||t>=e.length)){var i=e[t];i&&this.content&&(this.content.removeChild(i),e.splice(t,1),this._updatePageView())}},i.removeAllPages=function(){if(this.content){for(var t=this._pages,e=0,i=t.length;e<i;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}},i.scrollToPage=function(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())},i.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},i._updatePageView=function(){if(this.content){var t=this.content.getComponent(VSt);t&&t.enabled&&t.updateLayout();var e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<e;++n){var r=this._pages[n].position;this.direction===kwt.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},i._updateAllPagesSize=function(){var t=this.view;if(this.content&&t&&this._sizeMode===Vwt.Unified)for(var e=this._pages,i=t.contentSize,n=0,r=e.length;n<r;n++)e[n]._uiProps.uiTransformComp.setContentSize(i)},i._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))},i._onTouchBegan=function(e,i){e.touch.getUILocation(Gwt),qi.set(this._touchBeganPosition,Gwt.x,Gwt.y),t.prototype._onTouchBegan.call(this,e,i)},i._onTouchMoved=function(e,i){t.prototype._onTouchMoved.call(this,e,i)},i._onTouchEnded=function(e,i){e.touch.getUILocation(Gwt),qi.set(this._touchEndPosition,Gwt.x,Gwt.y),t.prototype._onTouchEnded.call(this,e,i)},i._onTouchCancelled=function(e,i){e.touch.getUILocation(Gwt),qi.set(this._touchEndPosition,Gwt.x,Gwt.y),t.prototype._onTouchCancelled.call(this,e,i)},i._onMouseWheel=function(){},i._syncScrollDirection=function(){this.horizontal=this.direction===kwt.Horizontal,this.vertical=this.direction===kwt.Vertical},i._syncSizeMode=function(){var t=this.view;if(this.content&&t){var e=this.content.getComponent(VSt);if(e){if(this._sizeMode===Vwt.Free&&this._pages.length>0){var i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===kwt.Horizontal?(e.paddingLeft=(t.width-i.width)/2,e.paddingRight=(t.width-n.width)/2):this.direction===kwt.Vertical&&(e.paddingTop=(t.height-i.height)/2,e.paddingBottom=(t.height-n.height)/2)}e.updateLayout()}}},i._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var t=this.content.children,e=0;e<t.length;++e){var i=t[e];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},i._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,zL.emitEvents(this.pageEvents,this,Uwt.PAGE_TURNING),this.node.emit(Uwt.PAGE_TURNING,this))},i._isQuicklyScrollable=function(t){if(this.direction===kwt.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===kwt.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1},i._moveOffsetValue=function(t){var e=new qi;if(this._sizeMode===Vwt.Free)this.direction===kwt.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===kwt.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{var i=this.view;if(!i)return e;this.direction===kwt.Horizontal?e.x=t*i.width:this.direction===kwt.Vertical&&(e.y=t*i.height)}return e},i._getDragDirection=function(t){return this._direction===kwt.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1},i._isScrollable=function(t,e,i){if(this._sizeMode===Vwt.Free){var n=0,r=0;if(this.direction===kwt.Horizontal)return n=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[i],Math.abs(t.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===kwt.Vertical)return n=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[i],Math.abs(t.y)>=Math.abs(n-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===kwt.Horizontal)return Math.abs(t.x)>=o.width*this.scrollThreshold;if(this.direction===kwt.Vertical)return Math.abs(t.y)>=o.height*this.scrollThreshold}return!1},i._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new qi;qi.subtract(e,this._touchBeganPosition,this._touchEndPosition);var i=this._curPageIdx,n=i+this._getDragDirection(e),r=this.pageTurningSpeed*Math.abs(i-n);if(n<this._pages.length){if(this._isScrollable(e,i,n))return void this.scrollToPage(n,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(n,r)}this.scrollToPage(i,r)}},Q(e,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}},{key:"indicator",get:function(){return this._indicator},set:function(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return t.prototype.verticalScrollBar},set:function(t){this.verticalScrollBar=t}},{key:"horizontalScrollBar",get:function(){return t.prototype.horizontalScrollBar},set:function(t){this.horizontalScrollBar=t}}]),e}(jCt),Lwt.SizeMode=Vwt,Lwt.Direction=kwt,Lwt.EventType=pAt(Uwt,dCt),lt((Cwt=Fwt).prototype,"sizeMode",[$Tt,twt],Object.getOwnPropertyDescriptor(Cwt.prototype,"sizeMode"),Cwt.prototype),lt(Cwt.prototype,"direction",[ewt,iwt],Object.getOwnPropertyDescriptor(Cwt.prototype,"direction"),Cwt.prototype),lt(Cwt.prototype,"scrollThreshold",[kc,nwt,rwt],Object.getOwnPropertyDescriptor(Cwt.prototype,"scrollThreshold"),Cwt.prototype),lt(Cwt.prototype,"pageTurningEventTiming",[kc,owt,awt],Object.getOwnPropertyDescriptor(Cwt.prototype,"pageTurningEventTiming"),Cwt.prototype),lt(Cwt.prototype,"indicator",[swt,cwt],Object.getOwnPropertyDescriptor(Cwt.prototype,"indicator"),Cwt.prototype),Awt=lt(Cwt.prototype,"autoPageTurningThreshold",[xc,lwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),lt(Cwt.prototype,"verticalScrollBar",[uwt,ol,hwt],Object.getOwnPropertyDescriptor(Cwt.prototype,"verticalScrollBar"),Cwt.prototype),lt(Cwt.prototype,"horizontalScrollBar",[_wt,ol,fwt],Object.getOwnPropertyDescriptor(Cwt.prototype,"horizontalScrollBar"),Cwt.prototype),Twt=lt(Cwt.prototype,"horizontal",[ol,xc,pwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wwt=lt(Cwt.prototype,"vertical",[ol,xc,dwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ewt=lt(Cwt.prototype,"cancelInnerEvents",[ol,xc,mwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Pwt=lt(Cwt.prototype,"scrollEvents",[vwt,xc,ol,gwt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Iwt=lt(Cwt.prototype,"pageTurningSpeed",[xc,Dc,ywt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Rwt=lt(Cwt.prototype,"pageEvents",[xwt,xc,Swt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dwt=lt(Cwt.prototype,"_sizeMode",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vwt.Unified}}),Mwt=lt(Cwt.prototype,"_direction",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kwt.Horizontal}}),Owt=lt(Cwt.prototype,"_scrollThreshold",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Bwt=lt(Cwt.prototype,"_pageTurningEventTiming",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Nwt=lt(Cwt.prototype,"_indicator",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bwt=Cwt))||bwt)||bwt)||bwt)||bwt));u.PageView=Hwt;var jwt=new Ei,Wwt=new qi,qwt=new qi,Xwt=new qi(1,1),Ywt=new qi,Kwt=new qi;function Jwt(t,e){if(!e._hadAlignOnce){e.alignMode===xTt.ONCE&&(e._hadAlignOnce=!0);var i,n=e.target,r=qwt,o=Xwt;n?ATt(t,i=n,r,o):i=t.parent;var a=CTt(i),s=i instanceof SD||!i.getComponent(NH),c=s?Wwt:i.getComponent(NH).anchorPoint,l=s;t.getPosition(jwt);var u=t._uiProps.uiTransformComp,h=jwt.x,_=jwt.y,f=u.anchorPoint,p=t.getScale();if(e.alignFlags&STt.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=qO.left.x,m=qO.right.x):m=(d=-c.x*v)+v,d+=e.isAbsoluteLeft?e.left:e.left*v,m-=e.isAbsoluteRight?e.right:e.right*v,n&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=p.x;if(x<0&&(y=1-y,x=-x),e.isStretchWidth)g=m-d,0!==x&&(u.width=g/x),h=d+y*g;else if(g=u.width*x,e.isAlignHorizontalCenter){var S=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*v,b=(.5-c.x)*a.width;n&&(S*=o.x,b+=r.x,b*=o.x),h=b+(y-.5)*g+S}else h=e.isAlignLeft?d+y*g:m+(y-1)*g;e._lastSize.width=g}if(e.alignFlags&STt.VERTICAL){var C=0,A=0,T=a.height;l?(A=qO.bottom.y,C=qO.top.y):C=(A=-c.y*T)+T,A+=e.isAbsoluteBottom?e.bottom:e.bottom*T,C-=e.isAbsoluteTop?e.top:e.top*T,n&&(A+=r.y,A*=o.y,C+=r.y,C*=o.y);var w=0,E=f.y,P=p.y;if(P<0&&(E=1-E,P=-P),e.isStretchHeight)w=C-A,0!==P&&(u.height=w/P),_=A+E*w;else if(w=u.height*P,e.isAlignVerticalCenter){var I=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*T,R=(.5-c.y)*a.height;n&&(I*=o.y,R+=r.y,R*=o.y),_=R+(E-.5)*w+I}else _=e.isAlignBottom?A+E*w:C+(E-1)*w;e._lastSize.height=w}t.setPosition(h,_,jwt.z),Ei.set(e._lastPos,h,_,jwt.z)}}function Qwt(t){var e=t.getComponent(qTt);if(e&&e.enabled){if(!u.isValid(t,!0))return;tEt.push(e)}for(var i,n=st(t.children);!(i=n()).done;){var r=i.value;r.active&&Qwt(r)}}function Zwt(){var t=HO.getScene();if(t){eEt.isAligning=!0,eEt._nodesOrderDirty&&(tEt.length=0,Qwt(t),eEt._nodesOrderDirty=!1);var e=null,i=eEt._activeWidgetsIterator;for(i.i=0;i.i<tEt.length;++i.i)(e=tEt[i.i])._dirty&&(Jwt(e.node,e),e._dirty=!1);eEt.isAligning=!1}}var $wt,tEt=[],eEt=t("widgetManager",u._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new ie.MutableForwardIterator(tEt),animationState:null,init:function(){HO.on(GO.EVENT_AFTER_SCENE_LAUNCH,Zwt),HO.on(GO.EVENT_AFTER_UPDATE,Zwt),KO.instance.on("design-resolution-changed",this.onResized,this);var t=this.onResized.bind(this);KO.instance.on("canvas-resize",t),ah.on("orientation-change",t)},add:function(){this._nodesOrderDirty=!0},remove:function(t){this._activeWidgetsIterator.remove(t)},onResized:function(){var t=HO.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized:function(t){var e=jT.isNode(t)&&t.getComponent(qTt);e&&e.enabled&&(e.alignMode===xTt.ON_WINDOW_RESIZE||e.alignMode===xTt.ALWAYS)&&e.setDirty();for(var i,n=st(t.children);!(i=n()).done;){var r=i.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(t,e){function i(t,e){return Math.abs(t-e)>1e-10?e:t}var n=t.node,r=n.parent;if(r){var o=Ywt;o.set(0,0);var a=Kwt;if(a.set(1,1),t.target&&ATt(n,r=t.target,o,a),!e)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:Wwt,l=n._uiProps.uiTransformComp,u=CTt(r),h=l.anchorPoint,_=n.getPosition(),f=STt,p=n.getScale(),d=0;if(e&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=_.x-h.x*l.width*p.x-m,t.isAbsoluteLeft||(d/=u.width),d/=a.x,t.left=i(t.left,d)}if(e&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(_.x+(1-h.x)*l.width*p.x),t.isAbsoluteRight||(d/=u.width),d/=a.x,t.right=i(t.right,d)}if(e&f.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(_.y+(1-h.y)*l.height*p.y),t.isAbsoluteTop||(d/=u.height),d/=a.y,t.top=i(t.top,d)}if(e&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=_.y-h.y*l.height*p.y-y,t.isAbsoluteBottom||(d/=u.height),d/=a.y,t.bottom=i(t.bottom,d)}}},updateAlignment:function t(e){var i=e.parent;i&&jT.isNode(i)&&t(i);var n=e.getComponent(qTt);n&&i&&Jwt(e,n)},AlignMode:xTt,AlignFlags:STt});HO.on(GO.EVENT_INIT,(function(){eEt.init()}));var iEt,nEt,rEt,oEt,aEt,sEt,cEt,lEt,uEt,hEt,_Et,fEt,pEt,dEt,mEt,vEt,gEt,yEt,xEt,SEt=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(pc("cc.SafeArea")($wt=Rc()($wt=mc(110)($wt=Tc($wt=wc()($wt=dc(qTt)($wt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.onEnable=function(){this.updateArea(),ah.on("window-resize",this.updateArea,this),ah.on("orientation-change",this.updateArea,this)},i.onDisable=function(){ah.off("window-resize",this.updateArea,this),ah.off("orientation-change",this.updateArea,this)},i.updateArea=function(){var t=this.node.getComponent(qTt),e=this.node.getComponent(NH);if(t&&e){t.updateAlignment();var i=this.node.position.clone(),n=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;var r=$O.getVisibleSize(),o=r.width,a=r.height,s=lh.getSafeAreaRect();t.top=a-s.y-s.height,t.bottom=s.y,t.left=s.x,t.right=o-s.x-s.width,t.updateAlignment();var c=this.node.position.clone(),l=n.x-(c.x-i.x)/e.width,u=n.y-(c.y-i.y)/e.height;e.setAnchorPoint(l,u),eEt.add(t)}},e}($u))||$wt)||$wt)||$wt)||$wt)||$wt)||$wt);u.SafeArea=SEt;var bEt,CEt=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((iEt=pc("cc.UICoordinateTracker"),nEt=Rc(),rEt=wc(),oEt=mc(110),aEt=Kc(jT),sEt=Nc(),cEt=Kc(nF),lEt=Nc(),uEt=Nc(),hEt=Nc(),_Et=Kc([zL]),fEt=Nc(),iEt(pEt=nEt(pEt=rEt(pEt=oEt((lt((dEt=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return ct(e=t.call.apply(t,[this].concat(n))||this,"syncEvents",mEt,ot(e)),ct(e,"_target",vEt,ot(e)),ct(e,"_camera",gEt,ot(e)),ct(e,"_useScale",yEt,ot(e)),ct(e,"_distance",xEt,ot(e)),e._transformPos=new Ei,e._viewPos=new Ei,e._canMove=!0,e._lastWPos=new Ei,e._lastCameraPos=new Ei,e}$(e,t);var i=e.prototype;return i.onEnable=function(){this._checkCanMove()},i.update=function(){var t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&Ei.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){var i=this._distance/Math.abs(this._viewPos.z);zL.emitEvents(this.syncEvents,this._transformPos,i)}},i._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},Q(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._target=t,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(t){this._useScale!==t&&(this._useScale=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t)}}]),e}($u)).prototype,"target",[aEt,sEt],Object.getOwnPropertyDescriptor(dEt.prototype,"target"),dEt.prototype),lt(dEt.prototype,"camera",[cEt,lEt],Object.getOwnPropertyDescriptor(dEt.prototype,"camera"),dEt.prototype),lt(dEt.prototype,"useScale",[uEt],Object.getOwnPropertyDescriptor(dEt.prototype,"useScale"),dEt.prototype),lt(dEt.prototype,"distance",[hEt],Object.getOwnPropertyDescriptor(dEt.prototype,"distance"),dEt.prototype),mEt=lt(dEt.prototype,"syncEvents",[_Et,xc,fEt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vEt=lt(dEt.prototype,"_target",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gEt=lt(dEt.prototype,"_camera",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yEt=lt(dEt.prototype,"_useScale",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xEt=lt(dEt.prototype,"_distance",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pEt=dEt))||pEt)||pEt)||pEt)||pEt)),AEt=[GC.TOUCH_START,GC.TOUCH_END,GC.TOUCH_MOVE,GC.MOUSE_DOWN,GC.MOUSE_MOVE,GC.MOUSE_UP,GC.MOUSE_ENTER,GC.MOUSE_LEAVE,GC.MOUSE_WHEEL];function TEt(t){t.propagationStopped=!0}var wEt,EEt,PEt,IEt,REt,DEt,MEt,OEt,BEt,NEt,LEt,FEt,zEt=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(pc("cc.BlockInputEvents")(bEt=Rc()(bEt=wc()(bEt=function(t){function e(){return t.apply(this,arguments)||this}$(e,t);var i=e.prototype;return i.onEnable=function(){for(var t=0;t<AEt.length;t++)this.node.on(AEt[t],TEt,this)},i.onDisable=function(){for(var t=0;t<AEt.length;t++)this.node.off(AEt[t],TEt,this)},e}($u))||bEt)||bEt)||bEt),VEt={},kEt=t("SubContextView",(wEt=pc("cc.SubContextView"),EEt=Rc(),PEt=mc(110),IEt=dc(NH),REt=wc(),DEt=Nc(),MEt=Nc(),wEt(OEt=EEt(OEt=PEt(OEt=IEt(OEt=REt((lt((BEt=function(t){function e(){var e;return ct(e=t.call(this)||this,"_fps",NEt,ot(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,ct(e,"_designResolutionSize",LEt,ot(e)),e._content=new jT("content"),e._content.hideFlags|=pl.Flags.DontSave|pl.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new tv,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new Cv,e}$(e,t);var i=e.prototype;return i.onLoad=function(){VEt.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=VEt.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},i.onEnable=function(){this._registerNodeEvent()},i.onDisable=function(){this._unregisterNodeEvent()},i._initSharedCanvas=function(){if(this._openDataContext){var t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}},i._initContentNode=function(){if(this._openDataContext){var t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(cY),this._sprite||(this._sprite=this._content.addComponent(cY)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var i=new cG;i.texture=this._texture,this._sprite.spriteFrame=i}this._content.parent=this.node}},i._updateSubContextView=function(){if(this._openDataContext){var t=this.node.getComponent(NH),e=this._content.getComponent(NH),i=t.width/e.width,n=t.height/e.height,r=i>n?n:i;e.width*=r,e.height*=r;var o=$O.getViewportRect(),a=e.getBoundingBoxToWorld(),s=$O.getVisibleSize(),c=ah.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},i._updateSubContextTexture=function(){var t=this._imageAsset;if(t&&this._openDataContext&&!(t.width<=0||t.height<=0)){var e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}},i._registerNodeEvent=function(){this.node.on(GC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(GC.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(GC.LAYER_CHANGED,this._updateContentLayer,this)},i._unregisterNodeEvent=function(){this.node.off(GC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(GC.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(GC.LAYER_CHANGED,this._updateContentLayer,this)},i._updateContentLayer=function(){this._content.layer=this.node.layer},i.update=function(t){void 0===t?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},i.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},Q(e,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}}]),e}($u)).prototype,"designResolutionSize",[DEt],Object.getOwnPropertyDescriptor(BEt.prototype,"designResolutionSize"),BEt.prototype),lt(BEt.prototype,"fps",[MEt],Object.getOwnPropertyDescriptor(BEt.prototype,"fps"),BEt.prototype),NEt=lt(BEt.prototype,"_fps",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),LEt=lt(BEt.prototype,"_designResolutionSize",[xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $i(640,960)}}),OEt=BEt))||OEt)||OEt)||OEt)||OEt)||OEt));u.SubContextView=kEt;var UEt=t("UIReorderComponent",pc("cc.UIReorderComponent")(FEt=function(){D(1408,"UIReorderComponent")})||FEt);u.UIReorderComponent=UEt,u.ButtonComponent=Ggt,ne.setClassAlias(Ggt,"cc.ButtonComponent"),u.EditBoxComponent=pSt,ne.setClassAlias(pSt,"cc.EditBoxComponent"),u.LayoutComponent=VSt,ne.setClassAlias(VSt,"cc.LayoutComponent"),u.ProgressBarComponent=ubt,ne.setClassAlias(ubt,"cc.ProgressBarComponent"),u.ScrollViewComponent=jCt,ne.setClassAlias(jCt,"cc.ScrollViewComponent"),u.ScrollBarComponent=ybt,ne.setClassAlias(ybt,"cc.ScrollBarComponent"),u.SliderComponent=fAt,ne.setClassAlias(fAt,"cc.SliderComponent"),u.ToggleComponent=EAt,ne.setClassAlias(EAt,"cc.ToggleComponent"),u.ToggleContainerComponent=yTt,ne.setClassAlias(yTt,"cc.ToggleContainerComponent"),u.WidgetComponent=qTt,ne.setClassAlias(qTt,"cc.WidgetComponent"),u.PageViewComponent=Hwt,ne.setClassAlias(Hwt,"cc.PageViewComponent"),u.PageViewIndicatorComponent=zwt,ne.setClassAlias(zwt,"cc.PageViewIndicatorComponent"),u.SafeAreaComponent=SEt,ne.setClassAlias(SEt,"cc.SafeAreaComponent"),ne.setClassAlias(CEt,"cc.UICoordinateTrackerComponent"),u.BlockInputEventsComponent=zEt,ne.setClassAlias(zEt,"cc.BlockInputEventsComponent")}}}));
