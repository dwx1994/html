System.register([],function(Rre,Dre){"use strict";return{execute:function(){Rre({BitMask:Dt,CCClass:Ti,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:Ot,Eventify:Gi,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:sE,WorldNode3DToWorldNodeUI:cE,absMax:$n,absMaxComponent:Jn,approx:Bn,assert:q,assertID:re,bezier:vm,bezierByTime:Dm,ccenum:Lt,clamp:Fn,clamp01:zn,color:or,computeRatioByType:bO,createDefaultPipeline:CP,debug:fe,deserialize:kf,earcut:kU,enumerableProps:er,equals:Ln,error:tt,errorID:ee,find:Ww,fragmentText:YF,getBaselineOffset:function(){return 0},getError:oe,getPathFromRoot:function(e,t){for(var i=e,n="";null!==i&&i!==t;)n=i.name+"/"+n,i=i.parent;return n.slice(0,-1)},getSerializationMetadata:function(e){return e[vp]},getWorldTransformUntilRoot:WN,instantiate:Zf,inverseLerp:Zn,isCustomTargetModifier:iL,isDisplayStats:ae,isElementModifier:tL,isPropertyModifier:eL,isUnicodeCJK:jF,isUnicodeSpace:WF,isValid:Ri,lerp:Un,log:H,logID:ne,markAsWarning:void 0,mat4:Rr,murmurhash2_32_gc:Gc,nextPow2:Yn,pingPong:Qn,pseudoRandom:Wn,pseudoRandomRange:qn,pseudoRandomRangeInt:Xn,quat:Er,randomRange:Vn,randomRangeInt:jn,rect:Yr,removeProperty:void 0,repeat:Kn,replaceProperty:void 0,safeMeasureText:qF,sampleAnimationCurve:SO,setDefaultLogTimes:function(e){0<e&&(Cn=e)},setDisplayStats:se,size:jr,toDegree:Gn,toRadian:kn,tween:Pre,tweenUtil:Ire,v2:Lr,v3:ur,v4:Ur,warn:V,warnID:J});var D="undefined"==typeof window?global:window,j=Rre("cclegacy",{_global:D}),O=(j.internal={},D.CC_BUILD=!0,D.CC_TEST=!1,D.CC_EDITOR=!1,D.CC_PREVIEW=!1,D.CC_DEV=!1,D.CC_DEBUG=!1,D.CC_JSB=!1,D.CC_BYTEDANCE=!1,D.CC_WECHAT=!1,D.CC_ALIPAY=!1,D.CC_XIAOMI=!1,D.CC_BAIDU=!1,D.CC_COCOSPLAY=!1,D.CC_HUAWEI=!1,D.CC_OPPO=!1,D.CC_VIVO=!1,D.CC_MINIGAME=!1,D.CC_RUNTIME_BASED=!1,D.CC_SUPPORT_JIT=!0,D.CC_UI_GPU_DRIVEN=!1,Rre("VERSION","3.4.1")),M=(D.CocosEngine=j.ENGINE_VERSION=O,D.cc=j,null),N=console.log.bind(console),L=N,F=N,z=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+G.apply(void 0,[t].concat(n)))}},k=N;function G(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return j.js.formatStr.apply(null,[e].concat(i))}function H(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return N.apply(void 0,[e].concat(i))}function V(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return L.apply(void 0,[e].concat(i))}function tt(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return F.apply(void 0,[e].concat(i))}function q(e,t){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return z.apply(void 0,[e,t].concat(n))}function fe(){return k.apply(void 0,arguments)}function X(e){var o,t;N=L=F=z=k=function(){},e!==te.NONE&&(e>te.ERROR?(o=function(e){var t,i;j.game.canvas&&(M||((t=document.createElement("Div")).setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",j.game.canvas.height),(i=t.style).zIndex="99999",i.position="absolute",i.top=i.left="0",(M=document.createElement("textarea")).setAttribute("rows","20"),M.setAttribute("cols","30"),M.setAttribute("disabled","true"),(i=M.style).backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(M),j.game.canvas.parentNode.appendChild(t)),M.value=M.value+e+"\r\n",M.scrollTop=M.scrollHeight)},F=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];o("ERROR :  "+G.apply(void 0,[e].concat(i)))},z=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];o("ASSERT: "+G.apply(void 0,[t].concat(n)))}},e!==te.ERROR_FOR_WEB_PAGE&&(L=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];o("WARN :  "+G.apply(void 0,[e].concat(i)))}),e===te.INFO_FOR_WEB_PAGE&&(N=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];o(G.apply(void 0,[e].concat(i)))})):console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),F=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},z=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];e=G.apply(void 0,[t].concat(n));throw new Error(e)}}),e!==te.ERROR&&(L=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e<=te.INFO&&(N=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))}),e<=te.VERBOSE&&"function"==typeof console.debug&&(t=console.debug.bind(console),k=function(){return t.apply(void 0,arguments)}))}function Y(e){tt(e.stack||e)}function K(r){return function(e){for(var e=r+" "+e+", please go to https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md#"+e+" to see details.",t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return 0===i.length?e:e+" Arguments: "+i.join(", ")}}var Q=K("Log");function ne(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];H(Q.apply(void 0,[e].concat(i)))}var Z=K("Warning");function J(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];V(Z.apply(void 0,[e].concat(i)))}var $=K("Error");function ee(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];tt($.apply(void 0,[e].concat(i)))}var te,ie=K("Assert");function re(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];q(!1,ie.apply(void 0,[t].concat(n)))}}function oe(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return $.apply(void 0,[e].concat(i))}function ae(){return!!j.profiler&&j.profiler.isShowingStats()}function se(e){j.profiler&&(e?j.profiler.showStats():j.profiler.hideStats(),j.game.config.showFPS=!!e)}(D=te=te||Rre("DebugMode",{}))[D.NONE=0]="NONE",D[D.VERBOSE=1]="VERBOSE",D[D.INFO=2]="INFO",D[D.WARN=3]="WARN",D[D.ERROR=4]="ERROR",D[D.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",D[D.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",D[D.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE";D=Object.freeze({__proto__:null,log:H,warn:V,error:tt,assert:q,debug:fe,_resetDebugSetting:X,_throw:Y,logID:ne,warnID:J,errorID:ee,assertID:re,get DebugMode(){return te},getError:oe,isDisplayStats:ae,setDisplayStats:se});function le(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function e(e,t,i){t&&le(e.prototype,t),i&&le(e,i)}function ue(){return(ue=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i,n=arguments[t];for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function l(e,t){e.prototype=Object.create(t.prototype),pe(e.prototype.constructor=e,t)}function he(e){return(he=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function pe(e,t){return(pe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _e(e,t,i){return(_e=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function(e,t,i){var n=[null],t=(n.push.apply(n,t),new(Function.bind.apply(e,n)));return i&&pe(t,i.prototype),t}).apply(null,arguments)}function de(e){var i="function"==typeof Map?new Map:void 0;return function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(e))return i.get(e);i.set(e,t)}function t(){return _e(e,arguments,he(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),pe(t,e)}(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function me(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function ge(e,t){var i,n;if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator])return(i=e[Symbol.iterator]()).next.bind(i);if(Array.isArray(e)||(i=function(e){if(e){if("string"==typeof e)return me(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?me(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),n=0,function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function i(i,n,e,t,r){var o={};return Object.keys(t).forEach(function(e){o[e]=t[e]}),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(i,n,o),o=null),o}(Ee=ye.prototype).remove=function(e){e=this.array.indexOf(e);0<=e&&this.removeAt(e)},Ee.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},Ee.fastRemove=function(e){e=this.array.indexOf(e);0<=e&&this.fastRemoveAt(e)},Ee.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},Ee.push=function(e){this.array.push(e)},e(ye,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]);var ve=ye;function ye(e){this.i=0,this.array=e}function xe(e,t){e.splice(t,1)}function Se(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)}function be(e,t){t=e.indexOf(t);return 0<=t&&(xe(e,t),!0)}function Te(e,t){return 0<=e.indexOf(t)}var Ee=Object.freeze({__proto__:null,removeAt:xe,fastRemoveAt:Se,remove:be,fastRemove:function(e,t){t=e.indexOf(t);0<=t&&(e[t]=e[e.length-1],--e.length)},removeIf:function(e,t){var i,t=e.findIndex(t);if(0<=t)return i=e[t],xe(e,t),i},verifyType:function(e,t){if(e&&0<e.length)for(var i,n=ge(e);!(i=n()).done;)if(!(i.value instanceof t))return ne(1300),!1;return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)be(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(t)),e},contains:Te,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:ve}),Ce=(we.prototype.getNewId=function(){return this.prefix+ ++this.id},we);function we(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}Ce.global=new Ce("global");var Ae=new Ce("TmpCId."),Pe="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),Ie="__cid__";function Re(e){return"number"==typeof e||e instanceof Number}function De(e){return"string"==typeof e||e instanceof String}function Oe(e){for(var t in e)return!1;return!0}function Me(e,t,i,n,r){Le.set=i,Le.enumerable=n,Le.configurable=r,Object.defineProperty(e,t,Le),Le.set=void 0}var Ne,Le,Be,Fe,ze=function(e,t,i,n,r){Ne.value=i,Ne.writable=n,Ne.enumerable=r,Object.defineProperty(e,t,Ne),Ne.value=void 0},Ue=function(e,t,i,n,r,o){void 0===r&&(r=!1),void 0===o&&(o=!1),"boolean"==typeof n&&(r=n,n=void 0),Fe.get=i,Fe.set=n,Fe.enumerable=r,Fe.configurable=o,Object.defineProperty(e,t,Fe),Fe.get=void 0,Fe.set=void 0},ke=function(e,t,i,n,r){Be.get=i,Be.enumerable=n,Be.configurable=r,Object.defineProperty(e,t,Be),Be.get=void 0};Le={set:void 0,enumerable:!(Be={get:void 0,enumerable:!(Fe={get:void 0,set:void 0,enumerable:!(Ne={value:void 0,enumerable:!1,writable:!1,configurable:!0})}),configurable:!1}),configurable:!1};function Ge(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function He(e){if("function"!=typeof e)return e&&e.constructor?He(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;t="";return e.name&&(t=e.name),"Object"!==(t=e.toString&&(e="["===(e=e.toString()).charAt(0)?e.match(/\[\w+\s*(\w+)\]/):e.match(/function\s*(\w+)/))&&2===e.length?e[1]:t)?t:""}function Ve(e,t,i,n){var r=/([^.]+)$/,t=r.exec(t)[0],o=r.exec(i)[0];function a(){return this[o]}n?Ue(e,t,a,function(e){this[o]=e}):ke(e,t,a)}function je(e,t,i,n){for(var r in i)Ve(e,t+"."+r,i[r],n)}var We=/(%d)|(%s)/,qe=/%s/;function Xe(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&We.test(e))for(var r=ge(i);!(o=r()).done;){var o=o.value,a="number"==typeof o?We:qe;a.test(e)?e=e.replace(a,""+o):e+=" "+o}else for(var s,c=ge(i);!(s=c()).done;)e+=" "+s.value;return e}function Ye(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function Ke(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function Qe(e,t,i){t=Ke(t,e);t&&Object.defineProperty(i,e,t)}function Ze(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,o=i;r<o.length;r++){var a=o[r];if(a)if("object"!=typeof a)ee(5402,a);else for(var s in a)s in e||Qe(s,a,e)}return e}function Je(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,o=i;r<o.length;r++){var a=o[r];if(a)if("object"!=typeof a)ee(5403,a);else for(var s in a)Qe(s,a,e)}return e}function $e(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function et(e){e=e.prototype,e=e&&Object.getPrototypeOf(e);return e&&e.constructor}function it(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=et(e)))return!1;if(e===t)return!0}}return!1}function nt(e){for(var t=0,i=Object.keys(e);t<i.length;t++)delete e[i[t]]}var rt=Ge(!0),ot=Ge(!0);function at(n,r){return function(e,t){var i;t.prototype.hasOwnProperty(n)&&delete r[t.prototype[n]],ze(t.prototype,n,e),e&&((i=r[e])&&i!==t?tt("A Class already exists with the same "+n+' : "'+e+'".'):r[e]=t)}}var st=at("__cid__",rt),ct=at("__classname__",ot);function lt(e,t){ct(e,t),t.prototype.hasOwnProperty(Ie)||(e=e||Ae.getNewId())&&st(e,t)}function ut(e,t){var i=ot[t],n=rt[t],r=!0;i&&i!==e&&(tt('"'+t+'" has already been set as name or alias of another class.'),r=!1),n&&n!==e&&(tt('"'+t+'" has already been set as id or alias of another class.'),r=!1),r&&((i=e[Pe])||(e[Pe]=i=[]),i.push(t),ot[t]=e,rt[t]=e)}function ht(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var o=r[n].prototype,a=o.__cid__,a=(a&&delete rt[a],o.__classname__),s=(a&&delete ot[a],o[Pe]);if(s)for(var c=0;c<s.length;++c){var l=s[c];delete ot[l],delete rt[l]}}}function pt(e){return rt[e]}function _t(e){return ot[e]}function ft(e,t){if("function"==typeof e&&e.prototype.hasOwnProperty(Ie))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty(Ie))return e.__cid__}return""}(dt=vt.prototype).get=function(){return this._get()},dt._get=function(){var e;return 0<this.count?(--this.count,e=this._pool[this.count],this._pool[this.count]=null,e):null},dt.put=function(e){var t=this._pool;this.count<t.length&&(this._cleanup&&!1===this._cleanup(e)||(t[this.count]=e,++this.count))},dt.resize=function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))};var dt=vt,mt=Ee,gt={IDGenerator:Ce,Pool:dt,array:Ee,isNumber:Re,isString:De,isEmptyObject:Oe,getPropertyDescriptor:Ke,addon:Ze,mixin:Je,extend:$e,getSuper:et,isChildClassOf:it,clear:nt,value:ze,getset:Ue,get:ke,set:Me,unregisterClass:ht,getClassName:He,setClassName:lt,setClassAlias:ut,getClassByName:_t,get _registeredClassNames(){return ue({},ot)},set _registeredClassNames(e){nt(ot),Object.assign(ot,e)},get _registeredClassIds(){return ue({},rt)},set _registeredClassIds(e){nt(rt),Object.assign(rt,e)},_getClassId:ft,_setClassId:st,_getClassById:pt,obsolete:Ve,obsoletes:je,formatStr:Xe,shiftArguments:Ye,createMap:Ge};function vt(e,t){this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,t=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=t}j.js=gt,Rre("js",Object.freeze({__proto__:null,array:mt,js:gt,IDGenerator:Ce,Pool:dt,isNumber:Re,isString:De,isEmptyObject:Oe,value:ze,getset:Ue,get:ke,set:Me,createMap:Ge,getClassName:He,obsolete:Ve,obsoletes:je,formatStr:Xe,shiftArguments:Ye,getPropertyDescriptor:Ke,addon:Ze,mixin:Je,extend:$e,getSuper:et,isChildClassOf:it,clear:nt,_idToClass:rt,_nameToClass:ot,_setClassId:st,setClassName:lt,setClassAlias:ut,unregisterClass:ht,_getClassById:pt,getClassByName:_t,_getClassId:ft}));(Ee=Rt.prototype).addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},Ee.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,gt.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)},Ee.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},Ee.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)};var yt,xt,St,bt=new Rt,Ee=(It.prototype.destroy=function(){bt.removeContainer(this)},It),Tt=Rre("Pool",(l(Pt,St=Ee),(pi=Pt.prototype).alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},pi.free=function(e){this._freepool[++this._nextAvail]=e},pi.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},pi.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},pi.destroy=function(){var e=0<arguments.length?arguments[0]:null,t=(e&&J(14100),e||this._dtor);if(t)for(var i=0;i<=this._nextAvail;i++)t(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,St.prototype.destroy.call(this)},Pt)),Et=Rre("RecyclePool",(l(At,xt=Ee),(pi=At.prototype).reset=function(){this._count=0},pi.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},pi.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},pi.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,xt.prototype.destroy.call(this)},pi.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},pi.removeAt=function(e){var t,i;e>=this._count||(t=this._count-1,i=this._data[e],this._data[e]=this._data[t],this._data[t]=i,--this._count)},e(At,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),At)),Ct=Rre("CachedArray",(l(wt,yt=Ee),(pi=wt.prototype).push=function(e){this.array[this.length++]=e},pi.pop=function(){return this.array[--this.length]},pi.get=function(e){return this.array[e]},pi.clear=function(){this.length=0},pi.destroy=function(){this.length=0,this.array.length=0,yt.prototype.destroy.call(this)},pi.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},pi.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},pi.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},pi.fastRemove=function(e){var t;e>=this.length||e<0||(t=--this.length,this.array[e]=this.array[t])},pi.indexOf=function(e){for(var t=0,i=this.length;t<i;++t)if(this.array[t]===e)return t;return-1},wt));function wt(e,t){var i;return(i=yt.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(e),i._initSize=e,i.length=0,i._compareFn=void 0!==t?t:function(e,t){return e-t},i}function At(e,t,i){var n;(n=xt.call(this)||this)._fn=void 0,n._dtor=null,n._count=0,n._data=void 0,n._initSize=0,n._fn=e,n._dtor=i||null,n._data=new Array(t),n._initSize=t;for(var r=0;r<t;++r)n._data[r]=e();return n}function Pt(e,t,i){var n;(n=St.call(this)||this)._ctor=void 0,n._elementsPerBatch=void 0,n._nextAvail=void 0,n._freepool=[],n._dtor=void 0,n._ctor=e,n._dtor=i||null,n._elementsPerBatch=Math.max(t,1),n._nextAvail=n._elementsPerBatch-1;for(var r=0;r<n._elementsPerBatch;++r)n._freepool.push(e());return n}function It(){this._poolHandle=-1,bt.addContainer(this)}function Rt(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}function Dt(e){if("__bitmask__"in e)return e;ze(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;o=""+o;r!==o&&ze(e,o,r)}return e}function Ot(e){return"__enums__"in e?e:(ze(e,"__enums__",null,!0),Ot.update(e))}function Mt(e){e.hasOwnProperty("__enums__")}function Nt(e){Mt(e);var t,i=e.__enums__||[];for(t in i.length=0,e){var n=e[t];Number.isInteger(n)&&i.push({name:t,value:n})}return i.sort(function(e,t){return e.value-t.value}),e.__enums__=i}function Lt(e){"__enums__"in e||ze(e,"__enums__",null,!0)}Rre("memop",Object.freeze({__proto__:null,Pool:Tt,RecyclePool:Et,CachedArray:Ct})),Dt.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Dt.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t,i=e.__bitmask__=[];for(t in e){var n=e[t];Number.isInteger(n)&&i.push({name:t,value:n})}return i.sort(function(e,t){return e.value-t.value}),i},j.BitMask=Dt,Ot.update=function(e){for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;o=""+o;r!==o&&ze(e,o,r)}return Array.isArray(e.__enums__)&&Nt(e),e},(Ot=Ot||Rre("Enum",{})).isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Ot.getList=function(e){return Mt(e),e.__enums__||Nt(e)},j.Enum=Ot;var Bt=Rre("ValueType",((Ee=Ft.prototype).clone=function(){return ee(100,He(this)+".clone"),this},Ee.equals=function(){return!1},Ee.set=function(){ee(100,He(this)+".set")},Ee.toString=function(){return""+{}},Ft));function Ft(){}lt("cc.ValueType",Bt),j.ValueType=Bt;var zt=Rre("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});j.macro=zt;for(var Ut=/^(?:cc|dragonBones|sp|ccsg)\..+/,kt=new Array(123),Gt=0;Gt<123;++Gt)kt[Gt]=64;for(var Ht=0;Ht<64;++Ht)kt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Ht)]=Ht;var Vt=kt;function jt(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);r?(r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set)):(r=e[i],Ue(e,t,r,e[n]))}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);n(o,r,"get"+s,"set"+s)}for(r in i){var c=i[r];n(o,r,c[0],c[1])}}function Wt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function qt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0}while(null!==(i=i.parentNode));return!1}function Xt(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function Yt(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function Kt(e){return!(!e||e.constructor!==Object)&&Oe(e)}function Qt(e,t,i){var n;return i<t&&(n=t,t=i,i=n),e<t?t:e<i?e:i}function Zt(e){return e*zt.RAD}function Jt(e){return e*zt.DEG}j.misc={BUILTIN_CLASSID_RE:Ut,BASE64_VALUES:Vt,propertyDefine:jt,pushToMap:Wt,contains:qt,isDomNode:Xt,callInNextTick:Yt,isPlainEmptyObj_DEV:Kt,clampf:Qt,degreesToRadians:Zt,radiansToDegrees:Jt},Rre("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Ut,BASE64_VALUES:Vt,propertyDefine:jt,pushToMap:Wt,contains:qt,isDomNode:Xt,callInNextTick:Yt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:Kt,clampf:Qt,degreesToRadians:Zt,radiansToDegrees:Jt}));var $t="$_$";function ei(e,t){t=t?Object.create(t):{};return ze(e,"__attrs__",t),t}function ti(e){if("function"!=typeof e)return ei(e,ni(e.constructor));for(var t,i=j.Class.getInheritanceChain(e),n=i.length-1;0<=n;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||ei(r,(t=i[n+1])&&t.__attrs__)}return ei(e,(t=i[0])&&t.__attrs__),e.__attrs__}function ii(e,t){var i,n=ni(e),r=t+$t,o={};for(i in n)i.startsWith(r)&&(o[i.slice(r.length)]=n[i]);return o}function ni(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||ti(e)}function ri(e,t,i,n){ni(e)[t+$t+i]=n}si.prototype.toString=function(){return this.name};var oi=si,ai=Rre("CCInteger",new oi("Integer",0));function si(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}j.Integer=ai,j.CCInteger=ai;var ci=Rre("CCFloat",new oi("Float",0)),li=(j.Float=ci,j.CCFloat=ci,Rre("CCBoolean",new oi("Boolean",!1))),ui=(j.Boolean=li,j.CCBoolean=li,Rre("CCString",new oi("String","")));function hi(o,a){return function(e,t){var i='"'+He(e)+"."+t+'"',e=ii(e,t),t=e.type;if(t===ai||t===ci?t="Number":t!==ui&&t!==li||(t=""+t),t===o){if(e.hasOwnProperty("default")){t=e.default;if(void 0!==t&&!Array.isArray(t)&&!Kt(t)){var n=typeof t,r=o.toLowerCase();if(n===r)if("object"===r){if(!t||t instanceof e.ctor)return;J(3605,i,He(e.ctor))}else"Number"!==o&&J(3606,a,i,o);else{if("function"==n)return;o===ui.default&&null==t?J(3607,i):J(3611,a,i,n)}delete e.type}}}else J(3604,i)}}j.String=ui,j.CCString=ui;var pi=Object.freeze({__proto__:null,DELIMETER:$t,createAttrsSingle:ei,createAttrs:ti,attr:ii,getClassAttrs:ni,setClassAttr:ri,PrimitiveType:oi,CCInteger:ai,CCFloat:ci,CCBoolean:li,CCString:ui,getTypeChecker_ET:hi,getObjTypeChecker_ET:function(o){return function(e,t){hi("Object","type")(e,t);var i,n=ni(e)[t+$t+"default"],r=j.Class.getDefault(n);!Array.isArray(r)&&it(o,j.ValueType)&&(r=He(o),i=Xe('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',He(e),t,r),n?H(i):J(3612,i,r,He(e),t,r))}}}),_i={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function fi(e,t,i){e=e?{_short:!0}:{_short:!0,default:t};return i&&(e.type=i),e}function di(e,t){var i;return e&&e.constructor===Object?null:Array.isArray(e)&&0<e.length?fi(t,[],e):"function"==typeof e?fi(t,it(i=e,j.ValueType)?new i:null,i):fi(t,e instanceof oi?e.default:e)}var mi=[];function gi(){return mi[mi.length-1]}j._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),mi.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){var e=mi.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=e.cls}},peek:gi};var vi=$t,yi={datas:null,push:function(e){var t;this.datas?this.datas.push(e):(this.datas=[e],t=this,setTimeout(function(){t.init()},0))},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props,o=("function"==typeof r&&(r=r()),He(n));r?bi(n,o,r,n.$super,i.mixins):ee(3633,o)}this.datas=null}}};function xi(e){return"function"==typeof e?e():e}function Si(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,Ke(t,n))}function bi(t,e,i,n,r){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i){{var s=i;var c=e;for(var l in s){var u=s[l],h=di(u,!1);(u=h?s[l]=h:u)&&((h=u.notify)&&function(e,t,i,n){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r,o="_N$"+t,a=(e.get=function(){return this[o]},e.set=function(e){var t=this[o];this[o]=e,i.call(this,t)},{});for(r in n[o]=a,_i){var s=_i[r];e.hasOwnProperty(r)&&(a[r]=e[r],s.canUsedInGet||delete e[r])}}}(u,l,h,s),"type"in u&&function(e,t,i,n){if(Array.isArray(t)){if(!(0<t.length))return ee(5508,i,n);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=j.String:t===Boolean?e.type=j.Boolean:t===Number&&(e.type=j.Float))}(u,u.type,c,l))}}for(var p in i){var _=i[p];_.get||_.set?(f=t,d=e,m=p,v=void 0,v=(g=_).get,g.set,v&&(Ci(f,g,d,m),ri(f,m,"serializable",!1))):(v=e,g=p,d=_,m=f=void 0,f=(p=t).__props__,m=g,f.indexOf(m)<0&&f.push(m),Ci(p,d,v,g))}}var f,d,m,g,v,y=ni(t);t.__values__=t.__props__.filter(function(e){return!1!==y[e+vi+"serializable"]})}function Ti(e){var t=e.name,i=e.extends,n=e.mixins,r=function(e,t,i,l){var n=j.Component,r=gi();if(r&&it(t,n)){if(it(r.cls,n))return ee(3615),null;e=e||r.script}e=function(e,t,i){var n=l.ctor,r=[n],o=n,a=(ze(o,"__ctors__",0<r.length?r:null,!0),o.prototype);if(t&&(o.$super=t),i){for(var s=i.length-1;0<=s;s--){var c=i[s];Si(a,c.prototype),Ti._isCCClass(c)&&Si(ni(o),ni(c))}a.constructor=o}return lt(e,o),o}(e,t,i);return r&&(it(t,n)?((i=r.uuid)&&st(i,e),r.cls=e):it(r.cls,n)||(r.cls=e)),e}(t,i,n,e),t=t||j.js.getClassName(r),o=(r._sealed=!0,i&&(i._sealed=!1),e.properties),n=("function"==typeof o||i&&null===i.__props__||n&&n.some(function(e){return null===e.__props__})?(yi.push({cls:r,props:o,mixins:n}),r.__props__=r.__values__=null):bi(r,t,o,i,e.mixins),e.editor);return n&&it(i,j.Component)&&j.Component._registerEditorProps(r,n),r}Ti._isCCClass=function(e){var t;return null==e||null==(t=e.hasOwnProperty)?void 0:t.call(e,"__ctors__")},Ti.fastDefine=function(e,t,i){lt(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=ni(t),o=0;o<n.length;o++){var a=n[o];r[a+vi+"visible"]=!1,r[a+vi+"default"]=i[a]}},Ti.Attr=pi,Ti.attr=ii,Ti.getInheritanceChain=function(e){for(var t=[];e=et(e);)e!==Object&&t.push(e);return t};var Ei={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Ci(e,n,t,i){var r=null,o="";function a(){return o=i+vi,r=ni(e)}"type"in n&&void 0===n.type&&J(3660,i,t);t=n.type;t&&(Ei[t]?(r||a())[o+"type"]=t:"Object"!==t&&("object"==typeof t?Ot.isEnum(t)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Ot.getList(t)):Dt.isBitMask(t)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Dt.getList(t)):"function"==typeof t&&((r||a())[o+"type"]="Object",r[o+"ctor"]=t))),"default"in n&&((r||a())[o+"default"]=n.default);function s(e,t){var i;e in n&&(typeof(i=n[e])===t&&((r||a())[o+e]=i))}n.editorOnly&&((r||a())[o+"editorOnly"]=!0),n.__noImplicit?(r||a())[o+"serializable"]=null!=(t=n.serializable)&&t:!1===n.serializable&&((r||a())[o+"serializable"]=!1),s("formerlySerializedAs","string");t=n.range;t&&Array.isArray(t)&&2<=t.length&&((r||a())[o+"min"]=t[0],r[o+"max"]=t[1],2<t.length&&(r[o+"step"]=t[2])),s("min","number"),s("max","number"),s("step","number")}Ti.isArray=function(e){return e=xi(e),Array.isArray(e)},Ti.getDefault=xi,Ti.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Ti.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Ti.getNewValueTypeCode=function(e){for(var t=He(e),i=e.constructor,n="new "+t+"(",r=0;r<i.__props__.length;r++)n+=e[i.__props__[r]],r<i.__props__.length-1&&(n+=",");return n+")"},j.Class=Ti;var wi=Rre("editorExtrasTag","__editorExtras__"),Ai=[],Pi=Rre("CCObject",(Ii._deferredDestroy=function(){for(var e=Ai.length,t=0;t<e;++t){var i=Ai[t];1&i._objFlags||i._destroyImmediate()}e===Ai.length?Ai.length=0:Ai.splice(0,e)},(Ee=Ii.prototype).destroy=function(){return 1&this._objFlags?(J(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Ai.push(this),0))},Ee._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof j._BaseNode||e instanceof j.Component,r=n?"_id":null,o={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(typeof e[i]){case"string":o[i]="";break;case"object":case"function":o[i]=null}}if(Ti._isCCClass(t))for(var a=j.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var l=(i=s[c])+j.Class.Attr.DELIMETER+"default";if(l in a&&(!n||"_id"!==i))switch(typeof a[l]){case"string":o[i]="";break;case"object":case"function":o[i]=null;break;case"undefined":o[i]=void 0}}var u="";for(i in o){var h=Ti.IDENTIFIER_RE.test(i)?"o."+i+"=":"o["+Ti.escapeForJS(i)+"]=",p=o[i];u+=h+(p=""===p?'""':p)+";\n"}return Function("o",u)}(this,e),ze(e,"__destruct__",t,!0)),t(this)},Ee._destroyImmediate=function(){1&this._objFlags?ee(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},e(Ii,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&Ii.Flags.AllHideMasks},set:function(e){e&=Ii.Flags.AllHideMasks;this._objFlags=this._objFlags&~Ii.Flags.AllHideMasks|e}},{key:"replicated",get:function(){return!!(this._objFlags&1<<22)},set:function(e){e?this._objFlags|=1<<22:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),Ii)),pi=Pi.prototype;function Ii(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}function Ri(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}pi._deserialize=null,pi._onPreDestroy=null,Ti.fastDefine("cc.Object",Pi,((Ee={_name:"",_objFlags:0})[wi]={},Ee)),Ti.Attr.setClassAttr(Pi,wi,"editorOnly",!0),Ti.Attr.setClassAttr(Pi,"replicated","visible",!1),ze(Pi,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),j.isValid=Ri,j.Object=Pi;var Di=mt.fastRemoveAt;function Oi(){}(pi=ki.prototype).set=function(e,t,i){this.callback=e||Oi,this.target=t,this.once=!!i},pi.reset=function(){this.target=void 0,this.callback=Oi,this.once=!1},pi.check=function(){return!(this.target instanceof Pi&&!Ri(this.target,!0))};var Mi=ki,Ni=new Tt(function(){return new Mi},32),Li=((Ee=Ui.prototype).removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(i.reset(),Ni.free(i),Di(this.callbackInfos,t),--t)}},Ee.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(i.reset(),Ni.free(i),Di(this.callbackInfos,t),--t)}},Ee.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Di(this.callbackInfos,e),Ni.free(t)),this.containCanceled=!0},Ee.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Ni.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},Ee.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;0<=e;--e)this.callbackInfos[e]||Di(this.callbackInfos,e);this.containCanceled=!1},Ee.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},Ui),Bi=new Tt(function(){return new Li},16),Fi=((pi=zi.prototype).on=function(e,t,i,n){var r;return this.hasEventListener(e,t,i)||(r=(r=this._callbackTable[e])||(this._callbackTable[e]=Bi.alloc()),(e=Ni.alloc()).set(t,i,n),r.callbackInfos.push(e)),t},pi.hasEventListener=function(e,t,i){e=this._callbackTable&&this._callbackTable[e];if(!e)return!1;var n=e.callbackInfos;if(!t){if(e.isInvoking){for(var r=0;r<n.length;++r)if(n[r])return!0;return!1}return 0<n.length}for(var o=0;o<n.length;++o){var a=n[o];if(a&&a.check()&&a.callback===t&&a.target===i)return!0}return!1},pi.removeAll=function(e){var t=typeof e;if("string"==t||"number"==t){t=this._callbackTable&&this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),Bi.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,o=0;o<r.length;++o){var a=r[o];a&&a.target===e&&n.cancel(o)}else n.removeByTarget(e)}},pi.off=function(e,t,i){var n=this._callbackTable&&this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var o=0;o<r.length;++o){var a=r[o];if(a&&a.callback===t&&a.target===i){n.cancel(o);break}}else this.removeAll(e)}null!=(e=this._offCallback)&&e.call(this)},pi.emit=function(e,t,i,n,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h,p,_=c[l];_&&(h=_.callback,p=_.target,_.once&&this.off(e,h,p),_.check()?p?h.call(p,t,i,n,r,o):h(t,i,n,r,o):this.off(e,h,p))}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},pi.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Bi.free(t),delete this._callbackTable[e])}},pi._registerOffCallback=function(e){this._offCallback=e},zi);function zi(){this._callbackTable=Ge(!0),this._offCallback=void 0}function Ui(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}function ki(){this.callback=Oi,this.target=void 0,this.once=!1}function Gi(e){l(c,r=e),(e=c.prototype).once=function(e,t,i){return this.on(e,t,i,!0)},e.targetOff=function(e){this.removeAll(e)};for(var r,t=c,i=Fi.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i)),o=0;o<n.length;++o){var a,s=n[o];s in t.prototype||(a=Object.getOwnPropertyDescriptor(i,s))&&Object.defineProperty(t.prototype,s,a)}function c(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=r.call.apply(r,[this].concat(i))||this)._callbackTable=Ge(!0),e}return t}var Hi,Vi,ji,Wi,qi,Xi,Yi,Ki=Rre("EventTarget",Gi(function(){})),Qi=(j.EventTarget=Ki,(Ee=Hi=Hi||{}).UNKNOWN="unknown",Ee.WECHAT="wechat",Ee.ANDROID="androidbrowser",Ee.IE="ie",Ee.EDGE="edge",Ee.QQ="qqbrowser",Ee.MOBILE_QQ="mqqbrowser",Ee.UC="ucbrowser",Ee.UCBS="ucbs",Ee.BROWSER_360="360browser",Ee.BAIDU_APP="baiduboxapp",Ee.BAIDU="baidubrowser",Ee.MAXTHON="maxthon",Ee.OPERA="opera",Ee.OUPENG="oupeng",Ee.MIUI="miuibrowser",Ee.FIREFOX="firefox",Ee.SAFARI="safari",Ee.CHROME="chrome",Ee.LIEBAO="liebao",Ee.QZONE="qzone",Ee.SOUGOU="sogou",Ee.HUAWEI="huawei",(pi=Vi=Vi||{}).UNKNOWN="unknown",pi.ENGLISH="en",pi.CHINESE="zh",pi.FRENCH="fr",pi.ITALIAN="it",pi.GERMAN="de",pi.SPANISH="es",pi.DUTCH="du",pi.RUSSIAN="ru",pi.KOREAN="ko",pi.JAPANESE="ja",pi.HUNGARIAN="hu",pi.PORTUGUESE="pt",pi.ARABIC="ar",pi.NORWEGIAN="no",pi.POLISH="pl",pi.TURKISH="tr",pi.UKRAINIAN="uk",pi.ROMANIAN="ro",pi.BULGARIAN="bg",(Ee=ji=ji||{})[Ee.NONE=0]="NONE",Ee[Ee.LAN=1]="LAN",Ee[Ee.WWAN=2]="WWAN",(pi=Wi=Wi||{}).UNKNOWN="Unknown",pi.IOS="iOS",pi.ANDROID="Android",pi.WINDOWS="Windows",pi.LINUX="Linux",pi.OSX="OS X",pi.OHOS="OHOS",(Ee=qi=qi||{}).UNKNOWN="UNKNOWN",Ee.EDITOR_PAGE="EDITOR_PAGE",Ee.EDITOR_CORE="EDITOR_CORE",Ee.MOBILE_BROWSER="MOBILE_BROWSER",Ee.DESKTOP_BROWSER="DESKTOP_BROWSER",Ee.WIN32="WIN32",Ee.ANDROID="ANDROID",Ee.IOS="IOS",Ee.MACOS="MACOS",Ee.OHOS="OHOS",Ee.WECHAT_GAME="WECHAT_GAME",Ee.BAIDU_MINI_GAME="BAIDU_MINI_GAME",Ee.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",Ee.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",Ee.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",Ee.OPPO_MINI_GAME="OPPO_MINI_GAME",Ee.VIVO_MINI_GAME="VIVO_MINI_GAME",Ee.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",Ee.COCOSPLAY="COCOSPLAY",Ee.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",Ee.QTT_MINI_GAME="QTT_MINI_GAME",(pi=Xi=Xi||{}).WEBP="WEBP",pi.IMAGE_BITMAP="IMAGE_BITMAP",pi.WEB_VIEW="WEB_VIEW",pi.VIDEO_PLAYER="VIDEO_PLAYER",pi.SAFE_AREA="SAFE_AREA",pi.INPUT_TOUCH="INPUT_TOUCH",pi.EVENT_KEYBOARD="EVENT_KEYBOARD",pi.EVENT_MOUSE="EVENT_MOUSE",pi.EVENT_TOUCH="EVENT_TOUCH",pi.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER",l(en,Yi=Ki),(Ee=en.prototype)._registerEvent=function(){function t(){a||(a=!0,o.emit("hide"))}function i(e,t,i,n,r){a&&(a=!1,o.emit("show",e,t,i,n,r))}var o=this,n=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden",a=!1;if(n)for(var e=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],r=0;r<e.length;r++)document.addEventListener(e[r],function(e){(document[n]||e.hidden?t:i)()});else window.addEventListener("blur",t),window.addEventListener("focus",i);-1<window.navigator.userAgent.indexOf("MicroMessenger")&&(window.onfocus=i),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",t),window.addEventListener("pageshow",i),document.addEventListener("pagehide",t),document.addEventListener("pageshow",i))},Ee.hasFeature=function(e){return this._featureMap[e]},Ee.getBatteryLevel=function(){return this._battery?this._battery.level:1},Ee.triggerGC=function(){},Ee.openURL=function(e){window.open(e)},Ee.now=function(){return Date.now?Date.now():+new Date},Ee.restartJSVM=function(){},Ee.close=function(){this.emit("close"),window.close()},new en),Zi=/(\.[^\.\/\?\\]*)(\?.*)?$/,Ji=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,$i=/[^\.\/]+\/\.\.\//;function en(){var t;(t=Yi.call(this)||this).networkType=void 0,t.isNative=void 0,t.isBrowser=void 0,t.isMobile=void 0,t.isLittleEndian=void 0,t.platform=void 0,t.language=void 0,t.nativeLanguage=void 0,t.os=void 0,t.osVersion=void 0,t.osMainVersion=void 0,t.browserType=void 0,t.browserVersion=void 0,t._battery=void 0,t._featureMap=void 0;var e=window.navigator,i=e.userAgent.toLowerCase(),n=(null!=(n=e.getBattery)&&n.call(e).then(function(e){t._battery=e}),t.networkType=ji.LAN,t.isNative=!1,t.isBrowser=!0,t.isMobile=/mobile|android|iphone|ipad/.test(i),t.platform=t.isMobile?qi.MOBILE_BROWSER:qi.DESKTOP_BROWSER,t.isLittleEndian=(n=new ArrayBuffer(2),new DataView(n).setInt16(0,256,!0),256===new Int16Array(n)[0]),e.language),n=(t.nativeLanguage=n.toLowerCase(),n=(n=n||e.browserLanguage)?n.split("-")[0]:Vi.ENGLISH,t.language=n,!1),r=!1,o="",a=0,s=/android\s*(\d+(?:\.\d+)*)/i.exec(i)||/android\s*(\d+(?:\.\d+)*)/i.exec(e.platform),s=(s&&(n=!0,o=s[1]||"",a=parseInt(o)||0),(s=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(i))?(r=!0,o=s[2]||"",a=parseInt(o)||0):(/(iPhone|iPad|iPod)/.exec(e.platform)||"MacIntel"===e.platform&&e.maxTouchPoints&&1<e.maxTouchPoints)&&(r=!0,o="",a=0),Wi.UNKNOWN),r=(-1!==e.appVersion.indexOf("Win")?s=Wi.WINDOWS:r?s=Wi.IOS:-1!==e.appVersion.indexOf("Mac")?s=Wi.OSX:-1!==e.appVersion.indexOf("X11")&&-1===e.appVersion.indexOf("Linux")?s=Wi.LINUX:n?s=Wi.ANDROID:-1===e.appVersion.indexOf("Linux")&&-1===i.indexOf("ubuntu")||(s=Wi.LINUX),t.os=s,t.osVersion=o,t.osMainVersion=a,t.browserType=Hi.UNKNOWN,/wechat|weixin|micromessenger/i.exec(i)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(i)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(i)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(i)),e=r?r[0].toLowerCase():Wi.UNKNOWN,s=(("safari"===e&&n||"qq"===e&&/android.*applewebkit/i.test(i))&&(e=Hi.ANDROID),{micromessenger:Hi.WECHAT,wechat:Hi.WECHAT,weixin:Hi.WECHAT,trident:Hi.IE,edge:Hi.EDGE,"360 aphone":Hi.BROWSER_360,mxbrowser:Hi.MAXTHON,"opr/":Hi.OPERA,ubrowser:Hi.UC,huaweibrowser:Hi.HUAWEI});t.browserType=s[e]||e,t.browserVersion="";o=(o=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(i))||/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(i);t.browserVersion=o?o[4]:"";var c,a=document.createElement("canvas");a.getContext("2d");try{c=a.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){c=!1}var l=!1,r=("undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(a.width=a.height=2,createImageBitmap(a,{}).then(function(e){l=!0,null!=e&&e.close()}).catch(function(){})),void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart),n=void 0!==document.documentElement.onmouseup;return t._featureMap=((s={})[Xi.WEBP]=c,s[Xi.IMAGE_BITMAP]=l,s[Xi.WEB_VIEW]=!0,s[Xi.VIDEO_PLAYER]=!0,s[Xi.SAFE_AREA]=!1,s[Xi.INPUT_TOUCH]=r,s[Xi.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,s[Xi.EVENT_MOUSE]=n,s[Xi.EVENT_TOUCH]=r||n,s[Xi.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,s),t._registerEvent(),t}function tn(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,o=i;r<o.length;r++)e=(e+(""===e?"":"/")+o[r]).replace(/(\/|\\\\)$/,"");return e}function nn(e){e=Zi.exec(e);return e?e[1]:""}function rn(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function on(e,t){var i=e.indexOf("?"),i=(0<i&&(e=e.substring(0,i)),/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,"")));if(!i)return e;i=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?i.substring(0,i.length-t.length):i}function an(e){e=Ji.exec(e);return e?e[2]:""}function sn(e,t){t=t||"";var i=e.indexOf("?"),n="";return 0<i&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function cn(e,t,i){if(0===t.indexOf("."))return sn(e,t);var n=e.indexOf("?"),r="",i=i?nn(e):"";return 0<n&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+i+r}function ln(e){var t;for(e=String(e);e=(t=e).replace($i,""),t.length!==e.length;);return e}function un(e){return e.replace(/[\/\\]$/,"")}function hn(){return Qi.os===Wi.WINDOWS?"\\":"/"}Rre("path",Object.freeze({__proto__:null,join:tn,extname:nn,mainFileName:rn,basename:on,dirname:an,changeExtname:sn,changeBasename:cn,_normalize:ln,stripSep:un,getSeperator:hn})),j.log=H,j.warn=V,j.error=tt,j.assert=q,j._throw=Y,j.logID=ne,j.warnID=J,j.errorID=ee,j.assertID=re,j.debug=D,j.path={join:tn,extname:nn,mainFileName:rn,basename:on,dirname:an,changeExtname:sn,changeBasename:cn,_normalize:ln,stripSep:un,get sep(){return hn()}};var pn=0,_n={},fn=2147483647;function dn(e){return(0<e)-(e<0)}function mn(e){var t,i=(65535<e)<<4;return(i|=t=(255<(e>>>=i))<<3)|(t=(15<(e>>>=t))<<2)|(t=(3<(e>>>=t))<<1)|e>>>t>>1}function gn(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&--t,t}function vn(e){return--e,1+((e=(e=(e=(e|=e>>>1)|e>>>2)|e>>>4)|e>>>8)|e>>>16)}for(var yn=new Array(256),xn=yn,Sn=0;Sn<256;++Sn){var bn=Sn,Tn=Sn,En=7;for(bn>>>=1;bn;bn>>>=1)Tn=Tn<<1|1&bn,--En;xn[Sn]=Tn<<En&255}pi=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:fn,INT_MIN:-2147483648,sign:dn,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:mn,log10:function(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:gn,nextPow2:vn,prevPow2:function(e){return(e=(e=(e=(e=(e|=e>>>1)|e>>>2)|e>>>4)|e>>>8)|e>>>16)-(e>>>1)},parity:function(e){return 27030>>>(15&(e=(e=(e^=e>>>16)^e>>>8)^e>>>4))&1},reverse:function(e){return yn[255&e]<<24|yn[e>>>8&255]<<16|yn[e>>>16&255]<<8|yn[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return 1+t|(~t&-~t)-1>>>gn(e)+1}});Rre("bits",pi);var Cn=10,wn=0,An=new Map,Pn=function(e,t,i,n,r,o,a){o=An.get(o);o&&o.logTimes>o.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,i+"."+n),o.count++)},In=Rre("replaceProperty",function(l,u,e){null!=l&&e.forEach(function(t){var e,i,n=wn++,r=(An.set(n,{id:n,count:0,logTimes:void 0!==t.logTimes?t.logTimes:Cn}),null!=t.target?t.target:l),o=null!=t.newName?t.newName:t.name,a=null!=t.targetName?t.targetName:u,s=r===l,c=t.suggest?"("+t.suggest+")":"";null!=t.customFunction?l[t.name]=function(){var e;return Pn(u,t.name,a,o,V,n,c),(e=t.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))}:null!=t.customSetter||null!=t.customGetter?(e=null!=t.customSetter,i=null!=t.customGetter,e&&i?Object.defineProperty(l,t.name,{get:function(){return Pn(u,t.name,a,o,V,n,c),t.customGetter.call(this)},set:function(e){Pn(u,t.name,a,o,V,n,c),t.customSetter.call(this,e)},enumerable:!1}):e?Object.defineProperty(l,t.name,{set:function(e){Pn(u,t.name,a,o,V,n,c),t.customSetter.call(this,e)},enumerable:!1}):i&&Object.defineProperty(l,t.name,{get:function(){return Pn(u,t.name,a,o,V,n,c),t.customGetter.call(this)},enumerable:!1})):Object.defineProperty(l,t.name,{get:function(){return Pn(u,t.name,a,o,V,n,c),(s?this:r)[o]},set:function(e){Pn(u,t.name,a,o,V,n,c),s?this[o]=e:r[o]=e},enumerable:!1})})}),Rn=function(e,t,i,n,r){n=An.get(n);n&&n.logTimes>n.count&&(i("'%s' has been removed. "+r,e+"."+t),n.count++)},Ee=Rre("removeProperty",function(n,r,e){null!=n&&e.forEach(function(e){var t=wn++,i=(An.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:Cn}),e.suggest?"("+e.suggest+")":"");Object.defineProperty(n,e.name,{get:function(){return Rn(r,e.name,tt,t,i)},set:function(){Rn(r,e.name,tt,t,i)},enumerable:!1})})}),Dn=function(e,t,i,n,r){n=An.get(n);n&&n.logTimes>n.count&&(i("'%s' is deprecated. "+r,e+"."+t),n.count++)},D=Rre("markAsWarning",function(f,d,e){null!=f&&e.forEach(function(e){var t,i,n,r,o,a,s,c,l,u,h,p=e.name,_=Object.getOwnPropertyDescriptor(f,p);_&&_.configurable&&(t=wn++,An.set(t,{id:t,count:0,logTimes:void 0!==e.logTimes?e.logTimes:Cn}),i=e.suggest?"("+e.suggest+")":"",void 0!==_.value?"function"==typeof _.value?(n=_.value,f[p]=function(){return Dn(d,p,V,t,i),n.call.apply(n,[this].concat(Array.prototype.slice.call(arguments)))}):(r=_.value,Object.defineProperty(f,p,{configurable:!0,get:function(){return Dn(d,p,V,t,i),r}}),_.writable&&Object.defineProperty(f,p,{set:function(e){Dn(d,p,V,t,i),r=e}})):(o=d,a=p,s=V,c=t,l=i,(e=_).get&&(u=e.get,e.get=function(){return Dn(o,a,s,c,l),u.call(this)}),e.set&&(h=e.set,e.set=function(e){Dn(o,a,s,c,l),h.call(this,e)}),Object.defineProperty(f,a,e)),Object.defineProperty(f,p,{enumerable:!1}))})}),On=Math.PI/180,Mn=180/Math.PI,Nn=Rre("EPSILON",1e-6);function Ln(e,t){return Math.abs(e-t)<=Nn*Math.max(1,Math.abs(e),Math.abs(t))}function Bn(e,t,i){return i=i||Nn,Math.abs(e-t)<=i}function Fn(e,t,i){var n;return i<t&&(n=t,t=i,i=n),e<t?t:i<e?i:e}function zn(e){return e<0?0:1<e?1:e}function Un(e,t,i){return e+(t-e)*i}function kn(e){return e*On}function Gn(e){return e*Mn}var Hn=Rre("random",Math.random);function Vn(e,t){return Math.random()*(t-e)+e}function jn(e,t){return Math.floor(Vn(e,t))}function Wn(e){return(9301*e+49297)%233280/233280}function qn(e,t,i){return Wn(e)*(i-t)+t}function Xn(e,t,i){return Math.floor(qn(e,t,i))}function Yn(e){return--e,e=(e=(e=(e=(e|=e>>1)|e>>2)|e>>4)|e>>8)|e>>16,++e}function Kn(e,t){return e-Math.floor(e/t)*t}function Qn(e,t){return e=Kn(e,2*t),t-Math.abs(e-t)}function Zn(e,t,i){return(i-e)/(t-e)}function Jn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function $n(e,t){return Math.abs(e)>Math.abs(t)?e:t}function er(t,e){e.forEach(function(e){Object.defineProperty(t,e,{enumerable:!0})})}var tr,ir=1/255,nr=Rre("Color",(l(rr,tr=Bt),rr.clone=function(e){var t=new rr;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t},rr.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},rr.set=function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e},rr.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;t=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(t)?255:t,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},rr.add=function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e},rr.subtract=function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e},rr.multiply=function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e},rr.divide=function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e},rr.scale=function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e},rr.lerp=function(e,t,i,n){var r=t.r,o=t.g,a=t.b,t=t.a;return r+=(i.r-r)*n,o+=(i.g-o)*n,a+=(i.b-a)*n,t+=(i.a-t)*n,e._val=Math.floor((t<<24>>>0)+(a<<16)+(o<<8)+r),e},rr.toArray=function(e,t,i){var n=t instanceof rr||1<t.a?1/255:1;return e[(i=void 0===i?0:i)+0]=t.r*n,e[i+1]=t.g*n,e[i+2]=t.b*n,e[i+3]=t.a*n,e},rr.fromArray=function(e,t,i){return t.r=255*e[(i=void 0===i?0:i)+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t},rr.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},rr.equals=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))},rr.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0},(t=rr.prototype).clone=function(){var e=new rr;return e._val=this._val,e},t.equals=function(e){return e&&this._val===e._val},t.lerp=function(e,t){var i=this.r,n=this.g,r=this.b,o=this.a;return i+=(e.r-i)*t,n+=(e.g-n)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(n<<8)+i),this},t.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},t.toCSS=function(e){return"rgba"===(e=void 0===e?"rgba":e)?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*ir).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},t.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,e=parseInt(e.substr(6,2),16),e=Number.isNaN(e)?255:e;return this._val=(e<<24>>>0)+(n<<16)+(i<<8)+(0|t),this},t.toHEX=function(e){void 0===e&&(e="#rrggbb");var t=[(this.r<16?"0":"")+this.r.toString(16),(this.g<16?"0":"")+this.g.toString(16),(this.b<16?"0":"")+this.b.toString(16)];return"#rgb"===e?(t[0]=t[0][0],t[1]=t[1][0],t[2]=t[2][0]):"#rrggbbaa"===e&&t.push((this.a<16?"0":"")+this.a.toString(16)),t.join("")},t.toRGBValue=function(){return 16777215&this._val},t.fromHSV=function(e,t,i){var n=0,r=0,o=0;if(0===t)n=r=o=i;else if(0===i)n=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),e=e-a,s=i*(1-t),c=i*(1-t*e),l=i*(1-t*(1-e));switch(a){case 0:n=i,r=l,o=s;break;case 1:n=c,r=i,o=s;break;case 2:n=s,r=i,o=l;break;case 3:n=s,r=c,o=i;break;case 4:n=l,r=s,o=i;break;case 5:n=i,r=s,o=c}}return this._val=(this.a<<24>>>0)+((o*=255)<<16)+((r*=255)<<8)+(0|(n*=255)),this},t.toHSV=function(){var e=this.r*ir,t=this.g*ir,i=this.b*ir,n={h:0,s:0,v:0},r=Math.max(e,t,i),o=Math.min(e,t,i);return n.v=r,n.s=r?(r-o)/r:0,n.s?(o=r-o,n.h=e===r?(t-i)/o:t===r?2+(i-e)/o:4+(e-t)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n},t.set=function(e,t,i,n){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,i=e.b||0,n="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(n<<24>>>0)+(i<<16)+(t<<8)+(0|e)):this._val=((n="number"==typeof n?n:255)<<24>>>0)+((i=i||0)<<16)+((t=t||0)<<8)+(0|(e=e||0)),this},t.multiply=function(e){var t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,e=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&e|16711680&n|65280&i|255&t,this},t._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},t._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},t._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},t._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},e(rr,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~Fn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~Fn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~Fn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~Fn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*ir},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*ir},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*ir},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*ir},set:function(e){this.a=255*e}}]),rr));function rr(e,t,i,n){var r;return(r=tr.call(this)||this)._val=0,"string"==typeof e?r.fromHEX(e):void 0!==t?r.set(e,t,i,n):r.set(e),r}function or(e,t,i,n){return new nr(e,t,i,n)}nr.WHITE=Object.freeze(new nr(255,255,255,255)),nr.GRAY=Object.freeze(new nr(127,127,127,255)),nr.BLACK=Object.freeze(new nr(0,0,0,255)),nr.TRANSPARENT=Object.freeze(new nr(0,0,0,0)),nr.RED=Object.freeze(new nr(255,0,0,255)),nr.GREEN=Object.freeze(new nr(0,255,0,255)),nr.BLUE=Object.freeze(new nr(0,0,255,255)),nr.CYAN=Object.freeze(new nr(0,255,255,255)),nr.MAGENTA=Object.freeze(new nr(255,0,255,255)),nr.YELLOW=Object.freeze(new nr(255,255,0,255)),Ti.fastDefine("cc.Color",nr,{r:0,g:0,b:0,a:255}),j.Color=nr,j.color=or;var ar,ce=Rre("Vec3",(l(sr,ar=Bt),sr.zero=function(e){return e.x=0,e.y=0,e.z=0,e},sr.clone=function(e){return new sr(e.x,e.y,e.z)},sr.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},sr.set=function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e},sr.add=function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e},sr.subtract=function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e},sr.multiply=function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e},sr.divide=function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e},sr.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},sr.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},sr.min=function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e},sr.max=function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e},sr.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},sr.multiplyScalar=function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e},sr.scaleAndAdd=function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e},sr.distance=function(e,t){var i=t.x-e.x,n=t.y-e.y,t=t.z-e.z;return Math.sqrt(i*i+n*n+t*t)},sr.squaredDistance=function(e,t){var i=t.x-e.x,n=t.y-e.y,t=t.z-e.z;return i*i+n*n+t*t},sr.len=function(e){var t=e.x,i=e.y,e=e.z;return Math.sqrt(t*t+i*i+e*e)},sr.lengthSqr=function(e){var t=e.x,i=e.y,e=e.z;return t*t+i*i+e*e},sr.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},sr.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},sr.invertSafe=function(e,t){var i=t.x,n=t.y,t=t.z;return Math.abs(i)<Nn?e.x=0:e.x=1/i,Math.abs(n)<Nn?e.y=0:e.y=1/n,Math.abs(t)<Nn?e.z=0:e.z=1/t,e},sr.normalize=function(e,t){var i=t.x,n=t.y,t=t.z,r=i*i+n*n+t*t;return 0<r&&(r=1/Math.sqrt(r),e.x=i*r,e.y=n*r,e.z=t*r),e},sr.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},sr.cross=function(e,t,i){var n=t.x,r=t.y,t=t.z,o=i.x,a=i.y,i=i.z;return e.x=r*i-t*a,e.y=t*o-n*i,e.z=n*a-r*o,e},sr.lerp=function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e},sr.random=function(e,t){t=t||1;var i=2*Hn()*Math.PI,n=2*Hn()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e},sr.transformMat4=function(e,t,i){var n=t.x,r=t.y,t=t.z,o=(o=i.m03*n+i.m07*r+i.m11*t+i.m15)?Math.abs(1/o):1;return e.x=(i.m00*n+i.m04*r+i.m08*t+i.m12)*o,e.y=(i.m01*n+i.m05*r+i.m09*t+i.m13)*o,e.z=(i.m02*n+i.m06*r+i.m10*t+i.m14)*o,e},sr.transformMat4Normal=function(e,t,i){var n=t.x,r=t.y,t=t.z,o=(o=i.m03*n+i.m07*r+i.m11*t)?Math.abs(1/o):1;return e.x=(i.m00*n+i.m04*r+i.m08*t)*o,e.y=(i.m01*n+i.m05*r+i.m09*t)*o,e.z=(i.m02*n+i.m06*r+i.m10*t)*o,e},sr.transformMat3=function(e,t,i){var n=t.x,r=t.y,t=t.z;return e.x=n*i.m00+r*i.m03+t*i.m06,e.y=n*i.m01+r*i.m04+t*i.m07,e.z=n*i.m02+r*i.m05+t*i.m08,e},sr.transformAffine=function(e,t,i){var n=t.x,r=t.y,t=t.z;return e.x=i.m00*n+i.m04*r+i.m08*t+i.m12,e.y=i.m01*n+i.m05*r+i.m09*t+i.m13,e.x=i.m02*n+i.m06*r+i.m10*t+i.m14,e},sr.transformQuat=function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,o=i.w*t.z+i.x*t.y-i.y*t.x,t=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+t*-i.x+r*-i.z-o*-i.y,e.y=r*i.w+t*-i.y+o*-i.x-n*-i.z,e.z=o*i.w+t*-i.z+n*-i.y-r*-i.x,e},sr.transformRTS=function(e,t,i,n,r){var o=t.x*r.x,a=t.y*r.y,t=t.z*r.z,r=i.w*o+i.y*t-i.z*a,s=i.w*a+i.z*o-i.x*t,c=i.w*t+i.x*a-i.y*o,o=-i.x*o-i.y*a-i.z*t;return e.x=r*i.w+o*-i.x+s*-i.z-c*-i.y+n.x,e.y=s*i.w+o*-i.y+c*-i.x-r*-i.z+n.y,e.z=c*i.w+o*-i.z+r*-i.y-s*-i.x+n.z,e},sr.transformInverseRTS=function(e,t,i,n,r){var o=t.x-n.x,a=t.y-n.y,t=t.z-n.z,n=i.w*o-i.y*t+i.z*a,s=i.w*a-i.z*o+i.x*t,c=i.w*t-i.x*a+i.y*o,o=i.x*o+i.y*a+i.z*t;return e.x=(n*i.w+o*i.x+s*i.z-c*i.y)/r.x,e.y=(s*i.w+o*i.y+c*i.x-n*i.z)/r.y,e.z=(c*i.w+o*i.z+n*i.y-s*i.x)/r.z,e},sr.rotateX=function(e,t,i,n){var r=t.x-i.x,o=t.y-i.y,t=t.z-i.z,a=Math.cos(n),n=Math.sin(n),s=o*a-t*n,o=o*n+t*a;return e.x=r+i.x,e.y=s+i.y,e.z=o+i.z,e},sr.rotateY=function(e,t,i,n){var r=t.x-i.x,o=t.y-i.y,t=t.z-i.z,a=Math.cos(n),n=Math.sin(n),s=t*a-r*n;return e.x=t*n+r*a+i.x,e.y=o+i.y,e.z=s+i.z,e},sr.rotateZ=function(e,t,i,n){var r=t.x-i.x,o=t.y-i.y,t=t.z-i.z,a=Math.cos(n),n=Math.sin(n),s=r*n+o*a;return e.x=r*a-o*n+i.x,e.y=s+i.y,e.z=t+i.z,e},sr.toArray=function(e,t,i){return e[(i=void 0===i?0:i)+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e},sr.fromArray=function(e,t,i){return e.x=t[(i=void 0===i?0:i)+0],e.y=t[i+1],e.z=t[i+2],e},sr.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},sr.equals=function(e,t,i){void 0===i&&(i=Nn);var n=e.x,r=e.y,e=e.z,o=t.x,a=t.y,t=t.z;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-a)<=i*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(e-t)<=i*Math.max(1,Math.abs(e),Math.abs(t))},sr.angle=function(e,t){sr.normalize(cr,e),sr.normalize(lr,t);e=sr.dot(cr,lr);return 1<e?0:e<-1?Math.PI:Math.acos(e)},sr.projectOnPlane=function(e,t,i){return sr.subtract(e,t,sr.project(e,t,i))},sr.project=function(e,t,i){var n=sr.lengthSqr(i);return n<1e-6?sr.set(e,0,0,0):sr.multiplyScalar(e,i,sr.dot(t,i)/n)},(t=sr.prototype).clone=function(){return new sr(this.x,this.y,this.z)},t.set=function(e,t,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=i||0),this},t.equals=function(e,t){return void 0===t&&(t=Nn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},t.equals3f=function(e,t,i,n){return void 0===n&&(n=Nn),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))},t.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},t.strictEquals3f=function(e,t,i){return this.x===e&&this.y===t&&this.z===i},t.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},t.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.add3f=function(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.subtract3f=function(e,t,i){return this.x-=e,this.y-=t,this.z-=i,this},t.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},t.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.multiply3f=function(e,t,i){return this.x*=e,this.y*=t,this.z*=i,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},t.divide3f=function(e,t,i){return this.x/=e,this.y/=t,this.z/=i,this},t.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.clampf=function(e,t){return this.x=Fn(this.x,e.x,t.x),this.y=Fn(this.y,e.y,t.y),this.z=Fn(this.z,e.z,t.z),this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},t.cross=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,o=e.y,e=e.z;return this.x=i*e-n*o,this.y=n*r-t*e,this.z=t*o-i*r,this},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.normalize=function(){var e=this.x,t=this.y,i=this.z,n=e*e+t*t+i*i;return 0<n&&(n=1/Math.sqrt(n),this.x=e*n,this.y=t*n,this.z=i*n),this},t.transformMat4=function(e){var t=this.x,i=this.y,n=this.z,r=(r=e.m03*t+e.m07*i+e.m11*n+e.m15)?1/r:1;return this.x=(e.m00*t+e.m04*i+e.m08*n+e.m12)*r,this.y=(e.m01*t+e.m05*i+e.m09*n+e.m13)*r,this.z=(e.m02*t+e.m06*i+e.m10*n+e.m14)*r,this},sr));function sr(e,t,i){var n=ar.call(this)||this;return e&&"object"==typeof e?(n.x=e.x,n.y=e.y,n.z=e.z):(n.x=e||0,n.y=t||0,n.z=i||0),n}ce.UNIT_X=Object.freeze(new ce(1,0,0)),ce.UNIT_Y=Object.freeze(new ce(0,1,0)),ce.UNIT_Z=Object.freeze(new ce(0,0,1)),ce.RIGHT=Object.freeze(new ce(1,0,0)),ce.UP=Object.freeze(new ce(0,1,0)),ce.FORWARD=Object.freeze(new ce(0,0,-1)),ce.ZERO=Object.freeze(new ce(0,0,0)),ce.ONE=Object.freeze(new ce(1,1,1)),ce.NEG_ONE=Object.freeze(new ce(-1,-1,-1));var cr=new ce,lr=new ce;function ur(e,t,i){return new ce(e,t,i)}Ti.fastDefine("cc.Vec3",ce,{x:0,y:0,z:0}),j.Vec3=ce,j.v3=ur;var hr,pr=Rre("Mat3",(l(_r,hr=Bt),_r.clone=function(e){return new _r(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},_r.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},_r.set=function(e,t,i,n,r,o,a,s,c,l){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},_r.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},_r.transpose=function(e,t){var i,n,r;return e===t?(i=t.m01,n=t.m02,r=t.m05,e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=r):(e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08),e},_r.invert=function(e,t){var i=t.m00,n=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,t=t.m08,u=t*a-s*l,h=-t*o+s*c,p=l*o-a*c,_=i*u+n*h+r*p;return 0==_?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0):(e.m00=u*(_=1/_),e.m01=(-t*n+r*l)*_,e.m02=(s*n-r*a)*_,e.m03=h*_,e.m04=(t*i-r*c)*_,e.m05=(-s*i+r*o)*_,e.m06=p*_,e.m07=(-l*i+n*c)*_,e.m08=(a*i-n*o)*_),e},_r.determinant=function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,e=e.m08;return t*(e*o-a*c)+i*(-e*r+a*s)+n*(c*r-o*s)},_r.multiply=function(e,t,i){var n=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,t=t.m08,h=i.m00,p=i.m01,_=i.m02,f=i.m03,d=i.m04,m=i.m05,g=i.m06,v=i.m07,i=i.m08;return e.m00=h*n+p*a+_*l,e.m01=h*r+p*s+_*u,e.m02=h*o+p*c+_*t,e.m03=f*n+d*a+m*l,e.m04=f*r+d*s+m*u,e.m05=f*o+d*c+m*t,e.m06=g*n+v*a+i*l,e.m07=g*r+v*s+i*u,e.m08=g*o+v*c+i*t,e},_r.multiplyMat4=function(e,t,i){var n=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,t=t.m08,h=i.m00,p=i.m01,_=i.m02,f=i.m04,d=i.m05,m=i.m06,g=i.m08,v=i.m09,i=i.m10;return e.m00=h*n+p*a+_*l,e.m01=h*r+p*s+_*u,e.m02=h*o+p*c+_*t,e.m03=f*n+d*a+m*l,e.m04=f*r+d*s+m*u,e.m05=f*o+d*c+m*t,e.m06=g*n+v*a+i*l,e.m07=g*r+v*s+i*u,e.m08=g*o+v*c+i*t,e},_r.transform=function(e,t,i){var n=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,t=t.m08,h=i.x,i=i.y;return e.m00=n,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=h*n+i*a+l,e.m07=h*r+i*s+u,e.m08=h*o+i*c+t,e},_r.scale=function(e,t,i){var n=i.x,i=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=i*t.m03,e.m04=i*t.m04,e.m05=i*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},_r.rotate=function(e,t,i){var n=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,t=t.m08,h=Math.sin(i),i=Math.cos(i);return e.m00=i*n+h*a,e.m01=i*r+h*s,e.m02=i*o+h*c,e.m03=i*a-h*n,e.m04=i*s-h*r,e.m05=i*c-h*o,e.m06=l,e.m07=u,e.m08=t,e},_r.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},_r.fromViewUp=function(e,t,i){return ce.lengthSqr(t)<Nn*Nn?_r.identity(e):(i=i||ce.UNIT_Y,ce.normalize(dr,ce.cross(dr,i,t)),ce.lengthSqr(dr)<Nn*Nn?_r.identity(e):(ce.cross(mr,t,dr),_r.set(e,dr.x,dr.y,dr.z,mr.x,mr.y,mr.z,t.x,t.y,t.z))),e},_r.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},_r.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},_r.fromRotation=function(e,t){var i=Math.sin(t),t=Math.cos(t);return e.m00=t,e.m01=i,e.m02=0,e.m03=-i,e.m04=t,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},_r.fromQuat=function(e,t){var i=t.x,n=t.y,r=t.z,t=t.w,o=i+i,a=n+n,s=r+r,i=i*o,c=n*o,n=n*a,l=r*o,u=r*a,r=r*s,o=t*o,a=t*a,t=t*s;return e.m00=1-n-r,e.m03=c-t,e.m06=l+a,e.m01=c+t,e.m04=1-i-r,e.m07=u-o,e.m02=l-a,e.m05=u+o,e.m08=1-i-n,e},_r.inverseTransposeMat4=function(e,t){var i=t.m00,n=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,p=t.m10,_=t.m11,f=t.m12,d=t.m13,m=t.m14,t=t.m15,g=i*s-n*a,v=i*c-r*a,y=i*l-o*a,x=n*c-r*s,S=n*l-o*s,b=r*l-o*c,T=u*d-h*f,E=u*m-p*f,u=u*t-_*f,C=h*m-p*d,h=h*t-_*d,p=p*t-_*m,_=g*p-v*h+y*C+x*u-S*E+b*T;return _?(e.m00=(s*p-c*h+l*C)*(_=1/_),e.m01=(c*u-a*p-l*E)*_,e.m02=(a*h-s*u+l*T)*_,e.m03=(r*h-n*p-o*C)*_,e.m04=(i*p-r*u+o*E)*_,e.m05=(n*u-i*h-o*T)*_,e.m06=(d*b-m*S+t*x)*_,e.m07=(m*y-f*b-t*v)*_,e.m08=(f*S-d*y+t*g)*_,e):null},_r.toArray=function(e,t,i){return e[(i=void 0===i?0:i)+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e},_r.fromArray=function(e,t,i){return e.m00=t[(i=void 0===i?0:i)+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e},_r.add=function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e},_r.subtract=function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e},_r.multiplyScalar=function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e},_r.multiplyScalarAndAdd=function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e},_r.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},_r.equals=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))},(t=_r.prototype).clone=function(){return new _r(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08)},t.set=function(e,t,i,n,r,o,a,s,c){return void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof(e=void 0===e?1:e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},t.equals=function(e,t){return void 0===t&&(t=Nn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},t.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},t.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+",\n"+this.m03+",\n"+this.m04+", "+this.m05+",\n"+this.m06+", "+this.m07+",\n"+this.m08+"\n]"},t.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},t.transpose=function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this},t.invert=function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*n+o*a,h=s*n-r*a,p=e*l+t*u+i*h;return 0==p?this.set(0,0,0,0,0,0,0,0,0):(this.m00=l*(p=1/p),this.m01=(-c*t+i*s)*p,this.m02=(o*t-i*r)*p,this.m03=u*p,this.m04=(c*e-i*a)*p,this.m05=(-o*e+i*n)*p,this.m06=h*p,this.m07=(-s*e+t*a)*p,this.m08=(r*e-t*n)*p),this},t.determinant=function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*n+o*a)+i*(s*n-r*a)},t.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},t.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},t.multiply=function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,p=e.m02,_=e.m03,f=e.m04,d=e.m05,m=e.m06,g=e.m07,e=e.m08;return this.m00=u*t+h*r+p*s,this.m01=u*i+h*o+p*c,this.m02=u*n+h*a+p*l,this.m03=_*t+f*r+d*s,this.m04=_*i+f*o+d*c,this.m05=_*n+f*a+d*l,this.m06=m*t+g*r+e*s,this.m07=m*i+g*o+e*c,this.m08=m*n+g*a+e*l,this},t.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},t.scale=function(e){var t=e.x,e=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=e*this.m03,this.m04=e*this.m04,this.m05=e*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},t.rotate=function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),e=Math.cos(e);return this.m00=e*t+u*r,this.m01=e*i+u*o,this.m02=e*n+u*a,this.m03=e*r-u*t,this.m04=e*o-u*i,this.m05=e*a-u*n,this.m06=s,this.m07=c,this.m08=l,this},t.fromQuat=function(e){var t=e.x,i=e.y,n=e.z,e=e.w,r=t+t,o=i+i,a=n+n,t=t*r,s=i*r,i=i*o,c=n*r,l=n*o,n=n*a,r=e*r,o=e*o,e=e*a;return this.m00=1-i-n,this.m03=s-e,this.m06=c+o,this.m01=s+e,this.m04=1-t-n,this.m07=l-r,this.m02=c-o,this.m05=l+r,this.m08=1-t-i,this},_r));function _r(e,t,i,n,r,o,a,s,c){var l;return void 0===e&&(e=1),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),l=hr.call(this)||this,"object"==typeof e?(l.m00=e.m00,l.m01=e.m01,l.m02=e.m02,l.m03=e.m03,l.m04=e.m04,l.m05=e.m05,l.m06=e.m06,l.m07=e.m07,l.m08=e.m08):(l.m00=e,l.m01=t,l.m02=i,l.m03=n,l.m04=r,l.m05=o,l.m06=a,l.m07=s,l.m08=c),l}pr.IDENTITY=Object.freeze(new pr);var fr,dr=new ce,mr=new ce,gr=(Ti.fastDefine("cc.Mat3",pr,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),j.Mat3=pr,Rre("Quat",(l(vr,fr=Bt),vr.clone=function(e){return new vr(e.x,e.y,e.z,e.w)},vr.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},vr.set=function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e},vr.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},vr.rotationTo=function(e,t,i){var n=ce.dot(t,i);return n<-.999999?(ce.cross(Sr,ce.UNIT_X,t),Sr.length()<1e-6&&ce.cross(Sr,ce.UNIT_Y,t),ce.normalize(Sr,Sr),vr.fromAxisAngle(e,Sr,Math.PI),e):.999999<n?(e.x=0,e.y=0,e.z=0,e.w=1,e):(ce.cross(Sr,t,i),e.x=Sr.x,e.y=Sr.y,e.z=Sr.z,e.w=1+n,vr.normalize(e,e))},vr.getAxisAngle=function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i},vr.multiply=function(e,t,i){var n=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,r=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,o=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,t=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z;return e.x=n,e.y=r,e.z=o,e.w=t,e},vr.multiplyScalar=function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e},vr.scaleAndAdd=function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e},vr.rotateX=function(e,t,i){i*=.5;var n=Math.sin(i),i=Math.cos(i),r=t.x,o=t.y,a=t.z,t=t.w;return e.x=r*i+t*n,e.y=o*i+a*n,e.z=a*i-o*n,e.w=t*i-r*n,e},vr.rotateY=function(e,t,i){i*=.5;var n=Math.sin(i),i=Math.cos(i),r=t.x,o=t.y,a=t.z,t=t.w;return e.x=r*i-a*n,e.y=o*i+t*n,e.z=a*i+r*n,e.w=t*i-o*n,e},vr.rotateZ=function(e,t,i){i*=.5;var n=Math.sin(i),i=Math.cos(i),r=t.x,o=t.y,a=t.z,t=t.w;return e.x=r*i+o*n,e.y=o*i-r*n,e.z=a*i+t*n,e.w=t*i-a*n,e},vr.rotateAround=function(e,t,i,n){return vr.invert(yr,t),ce.transformQuat(Sr,i,yr),vr.fromAxisAngle(yr,Sr,n),vr.multiply(e,t,yr),e},vr.rotateAroundLocal=function(e,t,i,n){return vr.fromAxisAngle(yr,i,n),vr.multiply(e,t,yr),e},vr.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},vr.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},vr.lerp=function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e},vr.slerp=function(e,t,i,n){var r,o=0,a=0,s=i.x,c=i.y,l=i.z,u=i.w,i=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;return i<0&&(i=-i,s=-s,c=-c,l=-l,u=-u),a=1e-6<1-i?(i=Math.acos(i),r=Math.sin(i),o=Math.sin((1-n)*i)/r,Math.sin(n*i)/r):(o=1-n,n),e.x=o*t.x+a*s,e.y=o*t.y+a*c,e.z=o*t.z+a*l,e.w=o*t.w+a*u,e},vr.sqlerp=function(e,t,i,n,r,o){return vr.slerp(yr,t,r,o),vr.slerp(xr,i,n,o),vr.slerp(e,yr,xr,2*o*(1-o)),e},vr.invert=function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=i?1/i:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},vr.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},vr.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},vr.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},vr.normalize=function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return 0<i&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e},vr.fromAxes=function(e,t,i,n){return pr.set(br,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),vr.normalize(e,vr.fromMat3(e,br))},vr.fromViewUp=function(e,t,i){return pr.fromViewUp(br,t,i),vr.normalize(e,vr.fromMat3(e,br))},vr.fromAxisAngle=function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e},vr.fromMat3=function(e,t){var i=t.m00,n=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,t=t.m08,u=i+a+t;return 0<u?(u=.5/Math.sqrt(u+1),e.w=.25/u,e.x=(l-s)*u,e.y=(r-c)*u,e.z=(o-n)*u):a<i&&t<i?(u=2*Math.sqrt(1+i-a-t),e.w=(l-s)/u,e.x=.25*u,e.y=(n+o)/u,e.z=(r+c)/u):t<a?(u=2*Math.sqrt(1+a-i-t),e.w=(r-c)/u,e.x=(n+o)/u,e.y=.25*u,e.z=(s+l)/u):(u=2*Math.sqrt(1+t-i-a),e.w=(o-n)/u,e.x=(r+c)/u,e.y=(s+l)/u,e.z=.25*u),e},vr.fromEuler=function(e,t,i,n){t*=Tr,i*=Tr,n*=Tr;var r=Math.sin(t),t=Math.cos(t),o=Math.sin(i),i=Math.cos(i),a=Math.sin(n),n=Math.cos(n);return e.x=r*i*n+t*o*a,e.y=t*o*n+r*i*a,e.z=t*i*a-r*o*n,e.w=t*i*n-r*o*a,e},vr.fromAngleZ=function(e,t){return t*=Tr,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},vr.toAxisX=function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e},vr.toAxisY=function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e},vr.toAxisZ=function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e},vr.toEuler=function(e,t,i){var n,r,o=t.x,a=t.y,s=t.z,t=t.w,c=0,l=0,u=0,h=o*a+s*t;return.499999<h?(c=0,l=Gn(2*Math.atan2(o,t)),u=90):h<-.499999?(c=0,l=-Gn(2*Math.atan2(o,t)),u=-90):(n=a*a,r=s*s,c=Gn(Math.atan2(2*o*t-2*a*s,1-2*(o*o)-2*r)),l=Gn(Math.atan2(2*a*t-2*o*s,1-2*n-2*r)),u=Gn(Math.asin(2*h)),i&&(c=-180*Math.sign(c+1e-6)+c,l=-180*Math.sign(l+1e-6)+l,u=180*Math.sign(u+1e-6)-u)),e.x=c,e.y=l,e.z=u,e},vr.toArray=function(e,t,i){return e[(i=void 0===i?0:i)+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e},vr.fromArray=function(e,t,i){return e.x=t[(i=void 0===i?0:i)+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e},vr.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},vr.equals=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))},(t=vr.prototype).clone=function(){return new vr(this.x,this.y,this.z,this.w)},t.set=function(e,t,i,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=null!=n?n:1),this},t.equals=function(e,t){return void 0===t&&(t=Nn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},t.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.getEulerAngles=function(e){return vr.toEuler(e,this)},t.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},t.slerp=function(e,t){return vr.slerp(this,this,e,t)},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},vr)));function vr(e,t,i,n){var r=fr.call(this)||this;return e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=null!=n?n:1),r}gr.IDENTITY=Object.freeze(new gr);var yr=new gr,xr=new gr,Sr=new ce,br=new pr,Tr=.5*Math.PI/180;function Er(e,t,i,n){return new gr(e=void 0===e?0:e,t=void 0===t?0:t,i=void 0===i?0:i,n=void 0===n?1:n)}Ti.fastDefine("cc.Quat",gr,{x:0,y:0,z:0,w:1}),j.Quat=gr,j.quat=Er;var Cr,wr=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),B=Rre("Mat4",(l(Ar,Cr=Bt),Ar.clone=function(e){return new Ar(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},Ar.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},Ar.set=function(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d,m){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=p,e.m12=_,e.m13=f,e.m14=d,e.m15=m,e},Ar.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.transpose=function(e,t){var i,n,r,o,a,s;return e===t?(i=t.m01,n=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s):(e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15),e},Ar.invert=function(e,t){var i=t.m00,n=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,p=t.m10,_=t.m11,f=t.m12,d=t.m13,m=t.m14,t=t.m15,g=i*s-n*a,v=i*c-r*a,y=i*l-o*a,x=n*c-r*s,S=n*l-o*s,b=r*l-o*c,T=u*d-h*f,E=u*m-p*f,C=u*t-_*f,w=h*m-p*d,A=h*t-_*d,P=p*t-_*m,I=g*P-v*A+y*w+x*C-S*E+b*T;return 0==I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0):(e.m00=(s*P-c*A+l*w)*(I=1/I),e.m01=(r*A-n*P-o*w)*I,e.m02=(d*b-m*S+t*x)*I,e.m03=(p*S-h*b-_*x)*I,e.m04=(c*C-a*P-l*E)*I,e.m05=(i*P-r*C+o*E)*I,e.m06=(m*y-f*b-t*v)*I,e.m07=(u*b-p*y+_*v)*I,e.m08=(a*A-s*C+l*T)*I,e.m09=(n*C-i*A-o*T)*I,e.m10=(f*S-d*y+t*g)*I,e.m11=(h*y-u*S-_*g)*I,e.m12=(s*E-a*w-c*T)*I,e.m13=(i*w-n*E+r*T)*I,e.m14=(d*v-f*x-m*g)*I,e.m15=(u*x-h*v+p*g)*I),e},Ar.determinant=function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,p=e.m11,_=e.m12,f=e.m13,d=e.m14,e=e.m15;return(t*a-i*o)*(h*e-p*d)-(t*s-n*o)*(u*e-p*f)+(t*c-r*o)*(u*d-h*f)+(i*s-n*a)*(l*e-p*_)-(i*c-r*a)*(l*d-h*_)+(n*c-r*s)*(l*f-u*_)},Ar.multiply=function(e,t,i){var n=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,p=t.m09,_=t.m10,f=t.m11,d=t.m12,m=t.m13,g=t.m14,t=t.m15,v=i.m00,y=i.m01,x=i.m02,S=i.m03;return e.m00=v*n+y*s+x*h+S*d,e.m01=v*r+y*c+x*p+S*m,e.m02=v*o+y*l+x*_+S*g,e.m03=v*a+y*u+x*f+S*t,v=i.m04,y=i.m05,x=i.m06,S=i.m07,e.m04=v*n+y*s+x*h+S*d,e.m05=v*r+y*c+x*p+S*m,e.m06=v*o+y*l+x*_+S*g,e.m07=v*a+y*u+x*f+S*t,v=i.m08,y=i.m09,x=i.m10,S=i.m11,e.m08=v*n+y*s+x*h+S*d,e.m09=v*r+y*c+x*p+S*m,e.m10=v*o+y*l+x*_+S*g,e.m11=v*a+y*u+x*f+S*t,v=i.m12,y=i.m13,x=i.m14,S=i.m15,e.m12=v*n+y*s+x*h+S*d,e.m13=v*r+y*c+x*p+S*m,e.m14=v*o+y*l+x*_+S*g,e.m15=v*a+y*u+x*f+S*t,e},Ar.transform=function(e,t,i){var n,r,o,a,s,c,l,u,h,p,_,f,d=i.x,m=i.y,i=i.z;return t===e?(e.m12=t.m00*d+t.m04*m+t.m08*i+t.m12,e.m13=t.m01*d+t.m05*m+t.m09*i+t.m13,e.m14=t.m02*d+t.m06*m+t.m10*i+t.m14,e.m15=t.m03*d+t.m07*m+t.m11*i+t.m15):(n=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,p=t.m09,_=t.m10,f=t.m11,t.m12,t.m13,t.m14,t.m15,e.m00=n,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=l,e.m07=u,e.m08=h,e.m09=p,e.m10=_,e.m11=f,e.m12=n*d+s*m+h*i+t.m12,e.m13=r*d+c*m+p*i+t.m13,e.m14=o*d+l*m+_*i+t.m14,e.m15=a*d+u*m+f*i+t.m15),e},Ar.translate=function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e},Ar.scale=function(e,t,i){var n=i.x,r=i.y,i=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},Ar.rotate=function(e,t,i,n){var r=n.x,o=n.y,n=n.z,a=Math.sqrt(r*r+o*o+n*n);if(Math.abs(a)<Nn)return null;r*=a=1/a,o*=a,n*=a;var a=Math.sin(i),i=Math.cos(i),s=1-i,c=t.m00,l=t.m01,u=t.m02,h=t.m03,p=t.m04,_=t.m05,f=t.m06,d=t.m07,m=t.m08,g=t.m09,v=t.m10,y=t.m11,x=r*r*s+i,S=o*r*s+n*a,b=n*r*s-o*a,T=r*o*s-n*a,E=o*o*s+i,C=n*o*s+r*a,w=r*n*s+o*a,o=o*n*s-r*a,r=n*n*s+i;return e.m00=c*x+p*S+m*b,e.m01=l*x+_*S+g*b,e.m02=u*x+f*S+v*b,e.m03=h*x+d*S+y*b,e.m04=c*T+p*E+m*C,e.m05=l*T+_*E+g*C,e.m06=u*T+f*E+v*C,e.m07=h*T+d*E+y*C,e.m08=c*w+p*o+m*r,e.m09=l*w+_*o+g*r,e.m10=u*w+f*o+v*r,e.m11=h*w+d*o+y*r,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},Ar.rotateX=function(e,t,i){var n=Math.sin(i),i=Math.cos(i),r=t.m04,o=t.m05,a=t.m06,s=t.m07,c=t.m08,l=t.m09,u=t.m10,h=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=r*i+c*n,e.m05=o*i+l*n,e.m06=a*i+u*n,e.m07=s*i+h*n,e.m08=c*i-r*n,e.m09=l*i-o*n,e.m10=u*i-a*n,e.m11=h*i-s*n,e},Ar.rotateY=function(e,t,i){var n=Math.sin(i),i=Math.cos(i),r=t.m00,o=t.m01,a=t.m02,s=t.m03,c=t.m08,l=t.m09,u=t.m10,h=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=r*i-c*n,e.m01=o*i-l*n,e.m02=a*i-u*n,e.m03=s*i-h*n,e.m08=r*n+c*i,e.m09=o*n+l*i,e.m10=a*n+u*i,e.m11=s*n+h*i,e},Ar.rotateZ=function(e,t,i){var n=Math.sin(i),i=Math.cos(i),r=t.m00,o=t.m01,a=t.m02,s=t.m03,c=t.m04,l=t.m05,u=t.m06,h=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=r*i+c*n,e.m01=o*i+l*n,e.m02=a*i+u*n,e.m03=s*i+h*n,e.m04=c*i-r*n,e.m05=l*i-o*n,e.m06=u*i-a*n,e.m07=h*i-s*n,e},Ar.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},Ar.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.fromRotation=function(e,t,i){var n=i.x,r=i.y,i=i.z,o=Math.sqrt(n*n+r*r+i*i);if(Math.abs(o)<Nn)return null;n*=o=1/o,r*=o,i*=o;var o=Math.sin(t),t=Math.cos(t),a=1-t;return e.m00=n*n*a+t,e.m01=r*n*a+i*o,e.m02=i*n*a-r*o,e.m03=0,e.m04=n*r*a-i*o,e.m05=r*r*a+t,e.m06=i*r*a+n*o,e.m07=0,e.m08=n*i*a+r*o,e.m09=r*i*a-n*o,e.m10=i*i*a+t,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.fromXRotation=function(e,t){var i=Math.sin(t),t=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=t,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.fromYRotation=function(e,t){var i=Math.sin(t),t=Math.cos(t);return e.m00=t,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=t,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.fromZRotation=function(e,t){var i=Math.sin(t),t=Math.cos(t);return e.m00=t,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=t,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.fromRT=function(e,t,i){var n=t.x,r=t.y,o=t.z,t=t.w,a=n+n,s=r+r,c=o+o,l=n*a,u=n*s,n=n*c,h=r*s,r=r*c,o=o*c,a=t*a,s=t*s,t=t*c;return e.m00=1-(h+o),e.m01=u+t,e.m02=n-s,e.m03=0,e.m04=u-t,e.m05=1-(l+o),e.m06=r+a,e.m07=0,e.m08=n+s,e.m09=r-a,e.m10=1-(l+h),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e},Ar.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},Ar.getScaling=function(e,t){var i=Ir.m00=t.m00,n=Ir.m01=t.m01,r=Ir.m02=t.m02,o=Ir.m03=t.m04,a=Ir.m04=t.m05,s=Ir.m05=t.m06,c=Ir.m06=t.m08,l=Ir.m07=t.m09,t=Ir.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+t*t),pr.determinant(Ir)<0&&(e.x*=-1),e},Ar.getRotation=function(e,t){var i=t.m00+t.m05+t.m10,n=0;return 0<i?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e},Ar.toRTS=function(e,t,i,n){n.x=ce.set(Pr,e.m00,e.m01,e.m02).length(),Ir.m00=e.m00/n.x,Ir.m01=e.m01/n.x,Ir.m02=e.m02/n.x,n.y=ce.set(Pr,e.m04,e.m05,e.m06).length(),Ir.m03=e.m04/n.y,Ir.m04=e.m05/n.y,Ir.m05=e.m06/n.y,n.z=ce.set(Pr,e.m08,e.m09,e.m10).length(),Ir.m06=e.m08/n.z,Ir.m07=e.m09/n.z,Ir.m08=e.m10/n.z,pr.determinant(Ir)<0&&(n.x*=-1,Ir.m00*=-1,Ir.m01*=-1,Ir.m02*=-1),gr.fromMat3(t,Ir),ce.set(i,e.m12,e.m13,e.m14)},Ar.fromRTS=function(e,t,i,n){var r=t.x,o=t.y,a=t.z,t=t.w,s=r+r,c=o+o,l=a+a,u=r*s,h=r*c,r=r*l,p=o*c,o=o*l,a=a*l,s=t*s,c=t*c,t=t*l,l=n.x,_=n.y,n=n.z;return e.m00=(1-(p+a))*l,e.m01=(h+t)*l,e.m02=(r-c)*l,e.m03=0,e.m04=(h-t)*_,e.m05=(1-(u+a))*_,e.m06=(o+s)*_,e.m07=0,e.m08=(r+c)*n,e.m09=(o-s)*n,e.m10=(1-(u+p))*n,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e},Ar.fromRTSOrigin=function(e,t,i,n,r){var o=t.x,a=t.y,s=t.z,t=t.w,c=o+o,l=a+a,u=s+s,h=o*c,p=o*l,o=o*u,_=a*l,a=a*u,s=s*u,c=t*c,l=t*l,t=t*u,u=n.x,f=n.y,n=n.z,d=r.x,m=r.y,r=r.z;return e.m00=(1-(_+s))*u,e.m01=(p+t)*u,e.m02=(o-l)*u,e.m03=0,e.m04=(p-t)*f,e.m05=(1-(h+s))*f,e.m06=(a+c)*f,e.m07=0,e.m08=(o+l)*n,e.m09=(a-c)*n,e.m10=(1-(h+_))*n,e.m11=0,e.m12=i.x+d-(e.m00*d+e.m04*m+e.m08*r),e.m13=i.y+m-(e.m01*d+e.m05*m+e.m09*r),e.m14=i.z+r-(e.m02*d+e.m06*m+e.m10*r),e.m15=1,e},Ar.fromQuat=function(e,t){var i=t.x,n=t.y,r=t.z,t=t.w,o=i+i,a=n+n,s=r+r,i=i*o,c=n*o,n=n*a,l=r*o,u=r*a,r=r*s,o=t*o,a=t*a,t=t*s;return e.m00=1-n-r,e.m01=c+t,e.m02=l-a,e.m03=0,e.m04=c-t,e.m05=1-i-r,e.m06=u+o,e.m07=0,e.m08=l+a,e.m09=u-o,e.m10=1-i-n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},Ar.frustum=function(e,t,i,n,r,o,a){var s=1/(i-t),c=1/(r-n),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(i+t)*s,e.m09=(r+n)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},Ar.perspective=function(e,t,i,n,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var t=1/Math.tan(t/2),l=1/(n-r),u=o?t/i:t,o=(o?t:t*i)*s,t=wr[c];return e.m00=u*t[0],e.m01=u*t[1],e.m02=0,e.m03=0,e.m04=o*t[2],e.m05=o*t[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*n)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*n*l*(1-a),e.m15=0,e},Ar.ortho=function(e,t,i,n,r,o,a,s,c,l){void 0===s&&(s=-1);var u=1/(t-i),c=1/(n-r)*(c=void 0===c?1:c),h=1/(o-a),p=-2*u,_=-2*c,t=(t+i)*u,i=(r+n)*c,u=wr[l=void 0===l?0:l];return e.m00=p*u[0],e.m01=p*u[1],e.m02=0,e.m03=0,e.m04=_*u[2],e.m05=_*u[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=h*(1-s),e.m11=0,e.m12=t*u[0]+i*u[2],e.m13=t*u[1]+i*u[3],e.m14=(o-s*a)*h,e.m15=1,e},Ar.lookAt=function(e,t,i,n){var r=t.x,o=t.y,t=t.z,a=n.x,s=n.y,n=n.z,c=r-i.x,l=o-i.y,i=t-i.z,u=1/Math.sqrt(c*c+l*l+i*i),h=s*(i*=u)-n*(l*=u),n=n*(c*=u)-a*i,a=a*l-s*c,s=l*(a*=u=1/Math.sqrt(h*h+n*n+a*a))-i*(n*=u),u=i*(h*=u)-c*a,p=c*n-l*h;return e.m00=h,e.m01=s,e.m02=c,e.m03=0,e.m04=n,e.m05=u,e.m06=l,e.m07=0,e.m08=a,e.m09=p,e.m10=i,e.m11=0,e.m12=-(h*r+n*o+a*t),e.m13=-(s*r+u*o+p*t),e.m14=-(c*r+l*o+i*t),e.m15=1,e},Ar.inverseTranspose=function(e,t){var i=t.m00,n=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,p=t.m10,_=t.m11,f=t.m12,d=t.m13,m=t.m14,t=t.m15,g=i*s-n*a,v=i*c-r*a,y=i*l-o*a,x=n*c-r*s,S=n*l-o*s,b=r*l-o*c,T=u*d-h*f,E=u*m-p*f,u=u*t-_*f,C=h*m-p*d,h=h*t-_*d,p=p*t-_*m,_=g*p-v*h+y*C+x*u-S*E+b*T;return _?(e.m00=(s*p-c*h+l*C)*(_=1/_),e.m01=(c*u-a*p-l*E)*_,e.m02=(a*h-s*u+l*T)*_,e.m03=0,e.m04=(r*h-n*p-o*C)*_,e.m05=(i*p-r*u+o*E)*_,e.m06=(n*u-i*h-o*T)*_,e.m07=0,e.m08=(d*b-m*S+t*x)*_,e.m09=(m*y-f*b-t*v)*_,e.m10=(f*S-d*y+t*g)*_,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},Ar.toArray=function(e,t,i){return e[(i=void 0===i?0:i)+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e},Ar.fromArray=function(e,t,i){return e.m00=t[(i=void 0===i?0:i)+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e},Ar.add=function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e},Ar.subtract=function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e},Ar.multiplyScalar=function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e},Ar.multiplyScalarAndAdd=function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e},Ar.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},Ar.equals=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))},(t=Ar.prototype).clone=function(){return new Ar(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},t.set=function(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d){return void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),"object"==typeof(e=void 0===e?1:e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=p,this.m13=_,this.m14=f,this.m15=d,this.m00=e),this},t.equals=function(e,t){return void 0===t&&(t=Nn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},t.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},t.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},t.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},t.transpose=function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=o,this},t.invert=function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,p=this.m12,_=this.m13,f=this.m14,d=this.m15,m=e*o-t*r,g=e*a-i*r,v=e*s-n*r,y=t*a-i*o,x=t*s-n*o,S=i*s-n*a,b=c*_-l*p,T=c*f-u*p,E=c*d-h*p,C=l*f-u*_,w=l*d-h*_,A=u*d-h*f,P=m*A-g*w+v*C+y*E-x*T+S*b;return 0==P?this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0):(this.m00=(o*A-a*w+s*C)*(P=1/P),this.m01=(i*w-t*A-n*C)*P,this.m02=(_*S-f*x+d*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*E-r*A-s*T)*P,this.m05=(e*A-i*E+n*T)*P,this.m06=(f*v-p*S-d*g)*P,this.m07=(c*S-u*v+h*g)*P,this.m08=(r*w-o*E+s*b)*P,this.m09=(t*E-e*w-n*b)*P,this.m10=(p*x-_*v+d*m)*P,this.m11=(l*v-c*x-h*m)*P,this.m12=(o*T-r*C-a*b)*P,this.m13=(e*C-t*T+i*b)*P,this.m14=(_*g-p*y-f*m)*P,this.m15=(c*y-l*g+u*m)*P),this},t.determinant=function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,p=this.m12,_=this.m13,f=this.m14,d=this.m15;return(e*o-t*r)*(u*d-h*f)-(e*a-i*r)*(l*d-h*_)+(e*s-n*r)*(l*f-u*_)+(t*a-i*o)*(c*d-h*p)-(t*s-n*o)*(c*f-u*p)+(i*s-n*a)*(c*_-l*p)},t.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},t.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},t.multiply=function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,p=this.m11,_=this.m12,f=this.m13,d=this.m14,m=this.m15,g=e.m00,v=e.m01,y=e.m02,x=e.m03;return this.m00=g*t+v*o+y*l+x*_,this.m01=g*i+v*a+y*u+x*f,this.m02=g*n+v*s+y*h+x*d,this.m03=g*r+v*c+y*p+x*m,g=e.m04,v=e.m05,y=e.m06,x=e.m07,this.m04=g*t+v*o+y*l+x*_,this.m05=g*i+v*a+y*u+x*f,this.m06=g*n+v*s+y*h+x*d,this.m07=g*r+v*c+y*p+x*m,g=e.m08,v=e.m09,y=e.m10,x=e.m11,this.m08=g*t+v*o+y*l+x*_,this.m09=g*i+v*a+y*u+x*f,this.m10=g*n+v*s+y*h+x*d,this.m11=g*r+v*c+y*p+x*m,g=e.m12,v=e.m13,y=e.m14,x=e.m15,this.m12=g*t+v*o+y*l+x*_,this.m13=g*i+v*a+y*u+x*f,this.m14=g*n+v*s+y*h+x*d,this.m15=g*r+v*c+y*p+x*m,this},t.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},t.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},t.scale=function(e){var t=e.x,i=e.y,e=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=i,this.m05*=i,this.m06*=i,this.m07*=i,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this},t.rotate=function(e,t){var i=t.x,n=t.y,t=t.z,r=Math.sqrt(i*i+n*n+t*t);if(Math.abs(r)<Nn)return null;i*=r=1/r,n*=r,t*=r;var r=Math.sin(e),e=Math.cos(e),o=1-e,a=this.m00,s=this.m01,c=this.m02,l=this.m03,u=this.m04,h=this.m05,p=this.m06,_=this.m07,f=this.m08,d=this.m09,m=this.m10,g=this.m11,v=i*i*o+e,y=n*i*o+t*r,x=t*i*o-n*r,S=i*n*o-t*r,b=n*n*o+e,T=t*n*o+i*r,E=i*t*o+n*r,n=n*t*o-i*r,i=t*t*o+e;return this.m00=a*v+u*y+f*x,this.m01=s*v+h*y+d*x,this.m02=c*v+p*y+m*x,this.m03=l*v+_*y+g*x,this.m04=a*S+u*b+f*T,this.m05=s*S+h*b+d*T,this.m06=c*S+p*b+m*T,this.m07=l*S+_*b+g*T,this.m08=a*E+u*n+f*i,this.m09=s*E+h*n+d*i,this.m10=c*E+p*n+m*i,this.m11=l*E+_*n+g*i,this},t.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},t.getScale=function(e){var t=Ir.m00=this.m00,i=Ir.m01=this.m01,n=Ir.m02=this.m02,r=Ir.m03=this.m04,o=Ir.m04=this.m05,a=Ir.m05=this.m06,s=Ir.m06=this.m08,c=Ir.m07=this.m09,l=Ir.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),pr.determinant(Ir)<0&&(e.x*=-1),e},t.getRotation=function(e){var t=this.m00+this.m05+this.m10,i=0;return 0<t?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e},t.fromRTS=function(e,t,i){var n=e.x,r=e.y,o=e.z,e=e.w,a=n+n,s=r+r,c=o+o,l=n*a,u=n*s,n=n*c,h=r*s,r=r*c,o=o*c,a=e*a,s=e*s,e=e*c,c=i.x,p=i.y,i=i.z;return this.m00=(1-(h+o))*c,this.m01=(u+e)*c,this.m02=(n-s)*c,this.m03=0,this.m04=(u-e)*p,this.m05=(1-(l+o))*p,this.m06=(r+a)*p,this.m07=0,this.m08=(n+s)*i,this.m09=(r-a)*i,this.m10=(1-(l+h))*i,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},t.fromQuat=function(e){var t=e.x,i=e.y,n=e.z,e=e.w,r=t+t,o=i+i,a=n+n,t=t*r,s=i*r,i=i*o,c=n*r,l=n*o,n=n*a,r=e*r,o=e*o,e=e*a;return this.m00=1-i-n,this.m01=s+e,this.m02=c-o,this.m03=0,this.m04=s-e,this.m05=1-t-n,this.m06=l+r,this.m07=0,this.m08=c+o,this.m09=l-r,this.m10=1-t-i,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},Ar));function Ar(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d){var m;return void 0===e&&(e=1),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),(m=Cr.call(this)||this).m00=void 0,m.m01=void 0,m.m02=void 0,m.m03=void 0,m.m04=void 0,m.m05=void 0,m.m06=void 0,m.m07=void 0,m.m08=void 0,m.m09=void 0,m.m10=void 0,m.m11=void 0,m.m12=void 0,m.m13=void 0,m.m14=void 0,m.m15=void 0,"object"==typeof e?(m.m00=e.m00,m.m01=e.m01,m.m02=e.m02,m.m03=e.m03,m.m04=e.m04,m.m05=e.m05,m.m06=e.m06,m.m07=e.m07,m.m08=e.m08,m.m09=e.m09,m.m10=e.m10,m.m11=e.m11,m.m12=e.m12,m.m13=e.m13,m.m14=e.m14,m.m15=e.m15):(m.m00=e,m.m01=t,m.m02=i,m.m03=n,m.m04=r,m.m05=o,m.m06=a,m.m07=s,m.m08=c,m.m09=l,m.m10=u,m.m11=h,m.m12=p,m.m13=_,m.m14=f,m.m15=d),m}B.IDENTITY=Object.freeze(new B);var Pr=new ce,Ir=new pr;function Rr(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d){return new B(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d)}Ti.fastDefine("cc.Mat4",B,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),j.Mat4=B,j.mat4=Rr;var Dr,U=Rre("Vec2",(l(Or,Dr=Bt),Or.clone=function(e){return new Or(e.x,e.y)},Or.copy=function(e,t){return e.x=t.x,e.y=t.y,e},Or.set=function(e,t,i){return e.x=t,e.y=i,e},Or.add=function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e},Or.subtract=function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e},Or.multiply=function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e},Or.divide=function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e},Or.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},Or.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},Or.min=function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e},Or.max=function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e},Or.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},Or.multiplyScalar=function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e},Or.scaleAndAdd=function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e},Or.distance=function(e,t){var i=t.x-e.x,t=t.y-e.y;return Math.sqrt(i*i+t*t)},Or.squaredDistance=function(e,t){var i=t.x-e.x,t=t.y-e.y;return i*i+t*t},Or.len=function(e){var t=e.x,e=e.y;return Math.sqrt(t*t+e*e)},Or.lengthSqr=function(e){var t=e.x,e=e.y;return t*t+e*e},Or.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},Or.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},Or.inverseSafe=function(e,t){var i=t.x,t=t.y;return Math.abs(i)<Nn?e.x=0:e.x=1/i,Math.abs(t)<Nn?e.y=0:e.y=1/t,e},Or.normalize=function(e,t){var i=t.x,t=t.y,n=i*i+t*t;return 0<n&&(n=1/Math.sqrt(n),e.x=i*n,e.y=t*n),e},Or.dot=function(e,t){return e.x*t.x+e.y*t.y},Or.cross=function(e,t,i){return e instanceof ce?(e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e):e.x*t.y-e.y*t.x},Or.lerp=function(e,t,i,n){var r=t.x,t=t.y;return e.x=r+n*(i.x-r),e.y=t+n*(i.y-t),e},Or.random=function(e,t){t=t||1;var i=2*Hn()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e},Or.transformMat3=function(e,t,i){var n=t.x,t=t.y;return e.x=i.m00*n+i.m03*t+i.m06,e.y=i.m01*n+i.m04*t+i.m07,e},Or.transformMat4=function(e,t,i){var n=t.x,t=t.y;return e.x=i.m00*n+i.m04*t+i.m12,e.y=i.m01*n+i.m05*t+i.m13,e},Or.str=function(e){return"Vec2("+e.x+", "+e.y+")"},Or.toArray=function(e,t,i){return e[(i=void 0===i?0:i)+0]=t.x,e[i+1]=t.y,e},Or.fromArray=function(e,t,i){return e.x=t[(i=void 0===i?0:i)+0],e.y=t[i+1],e},Or.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},Or.equals=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))},Or.angle=function(e,t){Or.normalize(Mr,e),Or.normalize(Nr,t);e=Or.dot(Mr,Nr);return 1<e?0:e<-1?Math.PI:Math.acos(e)},(t=Or.prototype).clone=function(){return new Or(this.x,this.y)},t.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},t.equals=function(e,t){return void 0===t&&(t=Nn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},t.equals2f=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))},t.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},t.strictEquals2f=function(e,t){return this.x===e&&this.y===t},t.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},t.lerp=function(e,t){var i=this.x,n=this.y;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this},t.clampf=function(e,t){return this.x=Fn(this.x,e.x,t.x),this.y=Fn(this.y,e.y,t.y),this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this},t.add2f=function(e,t){return this.x+=e,this.y+=t,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},t.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},t.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},t.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},t.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this},t.divide2f=function(e,t){return this.x/=e,this.y/=t,this},t.negative=function(){return this.x=-this.x,this.y=-this.y,this},t.dot=function(e){return this.x*e.x+this.y*e.y},t.cross=function(e){return this.x*e.y-this.y*e.x},t.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.lengthSqr=function(){return this.x*this.x+this.y*this.y},t.normalize=function(){var e=this.x,t=this.y,e=e*e+t*t;return 0<e&&(e=1/Math.sqrt(e),this.x*=e,this.y*=e),this},t.angle=function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;e=Fn(this.dot(e)/Math.sqrt(t*i),-1,1);return Math.acos(e)},t.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},t.rotate=function(e){var t=this.x,i=this.y,n=Math.sin(e),e=Math.cos(e);return this.x=e*t-n*i,this.y=n*t+e*i,this},t.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},t.transformMat4=function(e){var t=this.x,i=this.y;return this.x=e.m00*t+e.m04*i+e.m12,this.y=e.m01*t+e.m05*i+e.m13,this},Or));function Or(e,t){var i=Dr.call(this)||this;return e&&"object"==typeof e?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}U.ZERO=Object.freeze(new U(0,0)),U.ONE=Object.freeze(new U(1,1)),U.NEG_ONE=Object.freeze(new U(-1,-1)),U.UNIT_X=Object.freeze(new U(1,0)),U.UNIT_Y=Object.freeze(new U(0,1));var Mr=new U,Nr=new U;function Lr(e,t){return new U(e,t)}Ti.fastDefine("cc.Vec2",U,{x:0,y:0}),j.Vec2=U,j.v2=Lr;var Br,Fr=Rre("Vec4",(l(zr,Br=Bt),zr.clone=function(e){return new zr(e.x,e.y,e.z,e.w)},zr.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},zr.set=function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e},zr.add=function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e},zr.subtract=function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e},zr.multiply=function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e},zr.divide=function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e},zr.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},zr.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},zr.min=function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e},zr.max=function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e},zr.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},zr.multiplyScalar=function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e},zr.scaleAndAdd=function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e},zr.distance=function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,t=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+t*t)},zr.squaredDistance=function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,t=t.w-e.w;return i*i+n*n+r*r+t*t},zr.len=function(e){var t=e.x,i=e.y,n=e.z,e=e.w;return Math.sqrt(t*t+i*i+n*n+e*e)},zr.lengthSqr=function(e){var t=e.x,i=e.y,n=e.z,e=e.w;return t*t+i*i+n*n+e*e},zr.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},zr.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},zr.inverseSafe=function(e,t){var i=t.x,n=t.y,r=t.z,t=t.w;return Math.abs(i)<Nn?e.x=0:e.x=1/i,Math.abs(n)<Nn?e.y=0:e.y=1/n,Math.abs(r)<Nn?e.z=0:e.z=1/r,Math.abs(t)<Nn?e.w=0:e.w=1/t,e},zr.normalize=function(e,t){var i=t.x,n=t.y,r=t.z,t=t.w,o=i*i+n*n+r*r+t*t;return 0<o&&(o=1/Math.sqrt(o),e.x=i*o,e.y=n*o,e.z=r*o,e.w=t*o),e},zr.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},zr.lerp=function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e},zr.random=function(e,t){t=t||1;var i=2*Hn()*Math.PI,n=2*Hn()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e},zr.transformMat4=function(e,t,i){var n=t.x,r=t.y,o=t.z,t=t.w;return e.x=i.m00*n+i.m04*r+i.m08*o+i.m12*t,e.y=i.m01*n+i.m05*r+i.m09*o+i.m13*t,e.z=i.m02*n+i.m06*r+i.m10*o+i.m14*t,e.w=i.m03*n+i.m07*r+i.m11*o+i.m15*t,e},zr.transformAffine=function(e,t,i){var n=t.x,r=t.y,o=t.z,a=t.w;return e.x=i.m00*n+i.m01*r+i.m02*o+i.m03*a,e.y=i.m04*n+i.m05*r+i.m06*o+i.m07*a,e.x=i.m08*n+i.m09*r+i.m10*o+i.m11*a,e.w=t.w,e},zr.transformQuat=function(e,t,i){var n=t.x,r=t.y,o=t.z,a=i.x,s=i.y,c=i.z,i=i.w,l=i*n+s*o-c*r,u=i*r+c*n-a*o,h=i*o+a*r-s*n,n=-a*n-s*r-c*o;return e.x=l*i+n*-a+u*-c-h*-s,e.y=u*i+n*-s+h*-a-l*-c,e.z=h*i+n*-c+l*-s-u*-a,e.w=t.w,e},zr.toArray=function(e,t,i){return e[(i=void 0===i?0:i)+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e},zr.fromArray=function(e,t,i){return e.x=t[(i=void 0===i?0:i)+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e},zr.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},zr.equals=function(e,t,i){return void 0===i&&(i=Nn),Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))},(t=zr.prototype).clone=function(){return new zr(this.x,this.y,this.z,this.w)},t.set=function(e,t,i,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=i||0,this.w=n||0),this},t.equals=function(e,t){return void 0===t&&(t=Nn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},t.equals4f=function(e,t,i,n,r){return void 0===r&&(r=Nn),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))},t.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.strictEquals4f=function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n},t.lerp=function(e,t){var i=this.x,n=this.y,r=this.z,o=this.w;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},t.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},t.clampf=function(e,t){return this.x=Fn(this.x,e.x,t.x),this.y=Fn(this.y,e.y,t.y),this.z=Fn(this.z,e.z,t.z),this.w=Fn(this.w,e.w,t.w),this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.add4f=function(e,t,i,n){return this.x+=e,this.y+=t,this.z+=i,this.w+=n,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.subtract4f=function(e,t,i,n){return this.x-=e,this.y-=t,this.z-=i,this.w-=n,this},t.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.multiply4f=function(e,t,i,n){return this.x*=e,this.y*=t,this.z*=i,this.w*=n,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},t.divide4f=function(e,t,i,n){return this.x/=e,this.y/=t,this.z/=i,this.w/=n,this},t.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},t.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},t.cross=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,o=e.y,e=e.z;return this.x=i*e-n*o,this.y=n*r-t*e,this.z=t*o-i*r,this},t.length=function(){var e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)},t.lengthSqr=function(){var e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n},t.normalize=function(){var e=this.x,t=this.y,i=this.z,n=this.w,r=e*e+t*t+i*i+n*n;return 0<r&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=i*r,this.w=n*r),this},t.transformMat4=function(e){var t=this.x,i=this.y,n=this.z,r=this.w;return this.x=e.m00*t+e.m04*i+e.m08*n+e.m12*r,this.y=e.m01*t+e.m05*i+e.m09*n+e.m13*r,this.z=e.m02*t+e.m06*i+e.m10*n+e.m14*r,this.w=e.m03*t+e.m07*i+e.m11*n+e.m15*r,this},zr));function zr(e,t,i,n){var r=Br.call(this)||this;return e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||0),r}function Ur(e,t,i,n){return new Fr(e,t,i,n)}Fr.ZERO=Object.freeze(new Fr(0,0,0,0)),Fr.ONE=Object.freeze(new Fr(1,1,1,1)),Fr.NEG_ONE=Object.freeze(new Fr(-1,-1,-1,-1)),Ti.fastDefine("cc.Vec4",Fr,{x:0,y:0,z:0,w:0}),j.Vec4=Fr,j.v4=Ur,In(U,"Vec2",[{name:"sub",newName:"subtract",target:U,targetName:"Vec2"},{name:"mul",newName:"multiply",target:U,targetName:"Vec2"},{name:"div",newName:"divide",target:U,targetName:"Vec2"},{name:"dist",newName:"distance",target:U,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:U,targetName:"Vec2"},{name:"mag",newName:"len",target:U,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:U,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:U,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:U,targetName:"Vec2"}]),In(U.prototype,"Vec2",[{name:"mag",newName:"length",target:U.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:U.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:U.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:U.prototype,targetName:"Vec2"}]),In(ce,"Vec3",[{name:"sub",newName:"subtract",target:ce,targetName:"Vec3"},{name:"mul",newName:"multiply",target:ce,targetName:"Vec3"},{name:"div",newName:"divide",target:ce,targetName:"Vec3"},{name:"dist",newName:"distance",target:ce,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:ce,targetName:"Vec3"},{name:"mag",newName:"len",target:ce,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:ce,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:ce,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:ce,targetName:"Vec3"}]),In(ce.prototype,"Vec3",[{name:"mag",newName:"length",target:ce.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:ce.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:ce.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:ce.prototype,targetName:"Vec3"}]),In(Fr,"Vec4",[{name:"sub",newName:"subtract",target:Fr,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Fr,targetName:"Vec4"},{name:"div",newName:"divide",target:Fr,targetName:"Vec4"},{name:"dist",newName:"distance",target:Fr,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Fr,targetName:"Vec4"},{name:"mag",newName:"len",target:Fr,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Fr,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Fr,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Fr,targetName:"Vec4"}]),In(Fr.prototype,"Vec4",[{name:"mag",newName:"length",target:Fr.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Fr.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Fr.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Fr.prototype,targetName:"Vec4"}]),In(gr,"Quat",[{name:"mag",newName:"len",target:gr,targetName:"Quat"},{name:"mul",newName:"multiply",target:gr,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:gr,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:gr,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:gr,targetName:"Quat"}]),In(gr.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:gr.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:gr.prototype,targetName:"Quat"}]),In(nr,"Color",[{name:"sub",newName:"subtract",target:nr,targetName:"Color"},{name:"mul",newName:"multiply",target:nr,targetName:"Color"},{name:"div",newName:"divide",target:nr,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:nr,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[1].toString(16);return j.Color.fromHEX(t[0],n)}}]),In(pr,"Mat3",[{name:"sub",newName:"subtract",target:pr,targetName:"Mat3"},{name:"mul",newName:"multiply",target:pr,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:pr,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:pr,targetName:"Mat3"}]),In(pr.prototype,"Mat3",[{name:"sub",newName:"subtract",target:pr.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:pr.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:pr.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:pr.prototype,targetName:"Mat3"}]),In(B,"Mat4",[{name:"sub",newName:"subtract",target:B,targetName:"Mat4"},{name:"mul",newName:"multiply",target:B,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:B,targetName:"Mat4"}]),In(B.prototype,"Mat4",[{name:"sub",newName:"subtract",target:B.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:B.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:B.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:B.prototype,targetName:"Mat4"}]);var t=Rre("AffineTransform",(kr.identity=function(){return new kr},kr.clone=function(e){return new kr(e.a,e.b,e.c,e.d,e.tx,e.ty)},kr.concat=function(e,t,i){var n=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,t=t.ty;e.a=n*i.a+r*i.c,e.b=n*i.b+r*i.d,e.c=o*i.a+a*i.c,e.d=o*i.b+a*i.d,e.tx=s*i.a+t*i.c+i.tx,e.ty=s*i.b+t*i.d+i.ty},kr.invert=function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)},kr.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},kr.transformVec2=function(e,t,i,n){var r,t=void 0===n?(n=i,r=t.x,t.y):(r=t,i);e.x=n.a*r+n.c*t+n.tx,e.y=n.b*r+n.d*t+n.ty},kr.transformSize=function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height},kr.transformRect=function(e,t,i){var n=t.x+t.width,r=t.y+t.height,o=i.a*t.x+i.c*t.y+i.tx,a=i.b*t.x+i.d*t.y+i.ty,s=i.a*n+i.c*t.y+i.tx,c=i.b*n+i.d*t.y+i.ty,l=i.a*t.x+i.c*r+i.tx,t=i.b*t.x+i.d*r+i.ty,u=i.a*n+i.c*r+i.tx,n=i.b*n+i.d*r+i.ty,r=Math.min(o,s,l,u),i=Math.max(o,s,l,u),o=Math.min(a,c,t,n),s=Math.max(a,c,t,n);e.x=r,e.y=o,e.width=i-r,e.height=s-o},kr.transformObb=function(e,t,i,n,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,o=o.d*r.height;t.x=a,t.y=s,i.x=c+a,i.y=l+s,e.x=u+a,e.y=o+s,n.x=c+u+a,n.y=l+o+s},kr));function kr(e,t,i,n,r,o){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e=void 0===e?1:e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=o}j.AffineTransform=t;var Gr,Hr=Rre("Size",(l(Vr,Gr=Bt),Vr.lerp=function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e},(n=Vr.prototype).clone=function(){return new Vr(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},e(Vr,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),Vr));function Vr(e,t){var i=Gr.call(this)||this;return e&&"object"==typeof e?(i.width=e.width,i.height=e.height):(i.width=e||0,i.height=t||0),i}function jr(e,t){return new Hr(e=void 0===e?0:e,t=void 0===t?0:t)}Hr.ZERO=Object.freeze(new Hr(0,0)),Hr.ONE=Object.freeze(new Hr(1,1)),Ti.fastDefine("cc.Size",Hr,{width:0,height:0}),j.size=jr,j.Size=Hr;var Wr,qr=Rre("Rect",(l(Xr,Wr=Bt),Xr.fromMinMax=function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),o=Math.max(t.x,i.x),t=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=o-n,e.height=t-r,e},Xr.lerp=function(e,t,i,n){var r=t.x,o=t.y,a=t.width,t=t.height;return e.x=r+(i.x-r)*n,e.y=o+(i.y-o)*n,e.width=a+(i.width-a)*n,e.height=t+(i.height-t)*n,e},Xr.intersection=function(e,t,i){var n=t.x,r=t.y,o=t.x+t.width,t=t.y+t.height,a=i.x,s=i.y,c=i.x+i.width,i=i.y+i.height;return e.x=Math.max(n,a),e.y=Math.max(r,s),e.width=Math.min(o,c)-e.x,e.height=Math.min(t,i)-e.y,e},Xr.union=function(e,t,i){var n=t.x,r=t.y,o=t.width,t=t.height,a=i.x,s=i.y,c=i.width,i=i.height;return e.x=Math.min(n,a),e.y=Math.min(r,s),e.width=Math.max(n+o,a+c)-e.x,e.height=Math.max(r+t,s+i)-e.y,e},(n=Xr.prototype).clone=function(){return new Xr(this.x,this.y,this.width,this.height)},n.set=function(e,t,i,n){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var i=this.x,n=this.y,r=this.width,o=this.height;return this.x=i+(e.x-i)*t,this.y=n+(e.y-n)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,o=e.m00*t+e.m04*i+e.m12,a=e.m01*t+e.m05*i+e.m13,s=e.m00*n+e.m04*i+e.m12,i=e.m01*n+e.m05*i+e.m13,c=e.m00*t+e.m04*r+e.m12,t=e.m01*t+e.m05*r+e.m13,l=e.m00*n+e.m04*r+e.m12,n=e.m01*n+e.m05*r+e.m13,r=Math.min(o,s,c,l),e=Math.max(o,s,c,l),o=Math.min(a,i,t,n),s=Math.max(a,i,t,n);return this.x=r,this.y=o,this.width=e-r,this.height=s-o,this},n.transformMat4ToPoints=function(e,t,i,n,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,i.x=e.m00*o+e.m04*c+e.m12,i.y=e.m01*o+e.m05*c+e.m13,n.x=e.m00*s+e.m04*c+e.m12,n.y=e.m01*s+e.m05*c+e.m13},e(Xr,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new U(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new U(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Hr(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),Xr));function Xr(e,t,i,n){var r=Wr.call(this)||this;return e&&"object"==typeof e?(r.y=e.y,r.width=e.width,r.height=e.height,r.x=e.x):(r.x=e||0,r.y=t||0,r.width=i||0,r.height=n||0),r}function Yr(e,t,i,n){return new qr(e=void 0===e?0:e,t=void 0===t?0:t,i=void 0===i?0:i,n=void 0===n?0:n)}Ti.fastDefine("cc.Rect",qr,{x:0,y:0,width:0,height:0}),j.Rect=qr,j.rect=Yr;var Kr,Qr=Rre("MATH_FLOAT_ARRAY",Float64Array),n=Rre("MathBase",(l(Zr,Kr=Bt),Zr.createFloatArray=function(e){return new Qr(e)},e(Zr,[{key:"array",get:function(){return this._array}}]),Zr)),pi=Object.freeze({__proto__:null,bits:pi,Vec2:U,v2:Lr,Vec3:ce,v3:ur,Vec4:Fr,v4:Ur,Quat:gr,quat:Er,Mat3:pr,Mat4:B,mat4:Rr,AffineTransform:t,Size:Hr,size:jr,Rect:qr,rect:Yr,Color:nr,color:or,EPSILON:Nn,equals:Ln,approx:Bn,clamp:Fn,clamp01:zn,lerp:Un,toRadian:kn,toDegree:Gn,random:Hn,randomRange:Vn,randomRangeInt:jn,pseudoRandom:Wn,pseudoRandomRange:qn,pseudoRandomRangeInt:Xn,nextPow2:Yn,repeat:Kn,pingPong:Qn,inverseLerp:Zn,absMaxComponent:Jn,absMax:$n,enumerableProps:er,MATH_FLOAT_ARRAY:Qr,MathBase:n});function Zr(){return Kr.apply(this,arguments)||this}Rre("math",pi);(t=$r.prototype).initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},e($r,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){(j.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR).set(e)}},{key:"skyIllum",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){(j.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR).set(e)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(e){this._mipmapCount=e}},{key:"native",get:function(){return this._nativeObj}}]);var Jr=$r;function $r(){this._groundAlbedoHDR=new Fr(.2,.2,.2,1),this._skyColorHDR=new Fr(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Fr(.2,.2,.2,1),this._skyColorLDR=new Fr(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}Jr.SUN_ILLUM=65e3,Jr.SKY_ILLUM=2e4,j.Ambient=Jr;(n=lo.prototype).initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},n._destroy=function(){},n.destroy=function(){this._destroy()},e(lo,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]);var eo=lo,to=new ce,io=new ce,no=new ce,ro=new ce,oo=new ce,ao=new ce,so=new Array(3),co=new Array(3);function lo(){this._enabled=!1,this._minPos=new ce(0,0,0),this._maxPos=new ce(0,0,0),this._depth=0}function uo(e,t){return ce.dot(t.n,e)-t.d}function ho(e,t,i){return ce.copy(e,t),ce.subtract(oo,i.center,i.halfExtents),ce.add(ao,i.center,i.halfExtents),e.x=(e.x<oo.x?oo:e).x,e.y=(e.y<oo.y?oo:e).y,e.z=(e.z<oo.z?oo:e).z,e.x=(e.x>ao.x?ao:e).x,e.y=(e.y>ao.y?ao:e).y,e.z=(e.z>ao.z?ao:e).z,e}function po(e,t,i){ce.set(to,i.orientation.m00,i.orientation.m01,i.orientation.m02),ce.set(io,i.orientation.m03,i.orientation.m04,i.orientation.m05),ce.set(no,i.orientation.m06,i.orientation.m07,i.orientation.m08),so[0]=to,so[1]=io,so[2]=no,co[0]=i.halfExtents.x,co[1]=i.halfExtents.y,co[2]=i.halfExtents.z,ce.subtract(ro,t,i.center),ce.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=ce.dot(ro,so[n]);(r=r>co[n]?co[n]:r)<-co[n]&&(r=-co[n]),e.x+=r*so[n].x,e.y+=r*so[n].y,e.z+=r*so[n].z}return e}var t=Object.freeze({__proto__:null,point_plane:uo,pt_point_plane:function(e,t,i){var n=uo(t,i);return ce.subtract(e,t,ce.multiplyScalar(e,i.n,n))},pt_point_aabb:ho,pt_point_obb:po,pt_point_line:function(e,t,i,n){ce.subtract(to,i,n);var r=to,o=ce.lengthSqr(r);0==o?ce.copy(e,i):(ce.subtract(to,t,i),(t=ce.dot(to,r)/o)<0?ce.copy(e,i):1<t?ce.copy(e,n):ce.scaleAndAdd(e,i,r,t))}}),_o={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},n=(So.create=function(e,t,i,n,r,o){return new So(e,t,i,n,r,o)},So.clone=function(e){return new So(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},So.copy=function(e,t){return ce.copy(e.s,t.s),ce.copy(e.e,t.e),e},So.fromPoints=function(e,t,i){return ce.copy(e.s,t),ce.copy(e.e,i),e},So.set=function(e,t,i,n,r,o,a){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=o,e.e.z=a,e},So.len=function(e){return ce.distance(e.s,e.e)},So.prototype.length=function(){return ce.distance(this.s,this.e)},e(So,[{key:"type",get:function(){return this._type}}]),So),fo=(xo.create=function(e,t,i,n,r,o){return new xo(e=void 0===e?0:e,t=void 0===t?0:t,i=void 0===i?0:i,n=void 0===n?0:n,r=void 0===r?0:r,o=void 0===o?1:o)},xo.clone=function(e){return new xo(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},xo.copy=function(e,t){return ce.copy(e.o,t.o),ce.copy(e.d,t.d),e},xo.fromPoints=function(e,t,i){return ce.copy(e.o,t),ce.normalize(e.d,ce.subtract(e.d,i,t)),e},xo.set=function(e,t,i,n,r,o,a){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=o,e.d.z=a,e},xo.prototype.computeHit=function(e,t){ce.normalize(e,this.d),ce.scaleAndAdd(e,this.o,e,t)},e(xo,[{key:"type",get:function(){return this._type}}]),xo),mo=new ce,go=new ce,vo=new ce,yo=new ce;function xo(e,t,i,n,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=_o.SHAPE_RAY,this.o=new ce(e,t,i),this.d=new ce(n,r,o)}function So(e,t,i,n,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=_o.SHAPE_LINE,this.s=new ce(e,t,i),this.e=new ce(n,r,o)}function bo(e){return Math.max(Math.max(e.x,e.y),e.z)}function To(e,t,i){for(var n=0;n<t.length;++n)e.length<=n&&e.push(new i),e[n].copy(t[n]);e.length=t.length}pa.create=function(e,t,i,n){return new pa(e,t,i,n)},pa.clone=function(e){return new pa(e.center.x,e.center.y,e.center.z,e.radius)},pa.copy=function(e,t){return ce.copy(e.center,t.center),e.radius=t.radius,e},pa.fromPoints=function(e,t,i){return ce.multiplyScalar(e.center,ce.add(mo,t,i),.5),e.radius=.5*ce.subtract(mo,i,t).length(),e},pa.set=function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e},(r=pa.prototype).destroy=function(){},r.clone=function(){return pa.clone(this)},r.copy=function(e){return pa.copy(this,e)},r.getBoundary=function(e,t){ce.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),ce.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},r.transform=function(e,t,i,n,r){ce.transformMat4(r.center,this.center,e),r.radius=this.radius*bo(n)},r.translateAndRotate=function(e,t,i){ce.transformMat4(i.center,this.center,e)},r.setScale=function(e,t){t.radius=this.radius*bo(e)},r.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),ce.subtract(go,e,this.center);var t,e=go.length();e>this.radius&&(t=.5*(e-this.radius),this.radius+=t,ce.multiplyScalar(go,go,t/e),ce.add(this.center,this.center,go))},r.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var i=0;i<t;i++)this.mergePoint(e[i])}},r.mergeAABB=function(e){e.getBoundary(vo,yo),this.mergePoint(vo),this.mergePoint(yo)},e(pa,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]);var Eo,Co,wo,Ao,Po,W,Io,Ro,Do,Oo,Mo,No,Lo,Bo,Fo,zo,Uo,ko,Go,Ho,Vo,jo,Wo,qo,Xo,Yo,Ko,Qo,Zo,Jo,$o,ea,ta,ia,na,ra,oa,aa,sa,ca,la,ua=pa,r=(ha.create=function(e,t,i,n,r,o,a,s,c){return new ha(e=void 0===e?1:e,t=void 0===t?0:t,i=void 0===i?0:i,n=void 0===n?0:n,r=void 0===r?0:r,o=void 0===o?0:o,a=void 0===a?0:a,s=void 0===s?0:s,c=void 0===c?1:c)},ha.clone=function(e){return new ha(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},ha.copy=function(e,t){return ce.copy(e.a,t.a),ce.copy(e.b,t.b),ce.copy(e.c,t.c),e},ha.fromPoints=function(e,t,i,n){return ce.copy(e.a,t),ce.copy(e.b,i),ce.copy(e.c,n),e},ha.set=function(e,t,i,n,r,o,a,s,c,l){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},e(ha,[{key:"type",get:function(){return this._type}}]),ha);function ha(e,t,i,n,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=_o.SHAPE_TRIANGLE,this.a=new ce(e,t,i),this.b=new ce(n,r,o),this.c=new ce(a,s,c)}function pa(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),this._center=new ce(0,0,0),this._radius=0,this._type=void 0,this._type=_o.SHAPE_SPHERE,this._center=new ce(e,t,i),this._radius=n}(o=Eo=Eo||{})[o.UNKNOWN=0]="UNKNOWN",o[o.SWAPCHAIN=1]="SWAPCHAIN",o[o.BUFFER=2]="BUFFER",o[o.TEXTURE=3]="TEXTURE",o[o.RENDER_PASS=4]="RENDER_PASS",o[o.FRAMEBUFFER=5]="FRAMEBUFFER",o[o.SAMPLER=6]="SAMPLER",o[o.SHADER=7]="SHADER",o[o.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",o[o.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",o[o.PIPELINE_STATE=10]="PIPELINE_STATE",o[o.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",o[o.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",o[o.COMMAND_BUFFER=13]="COMMAND_BUFFER",o[o.QUEUE=14]="QUEUE",o[o.QUERY_POOL=15]="QUERY_POOL",o[o.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",o[o.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",o[o.BUFFER_BARRIER=18]="BUFFER_BARRIER",o[o.COUNT=19]="COUNT",(o=Co=Co||{})[o.UNREADY=0]="UNREADY",o[o.FAILED=1]="FAILED",o[o.SUCCESS=2]="SUCCESS",(o=wo=wo||{})[o.UNKNOWN=0]="UNKNOWN",o[o.GLES2=1]="GLES2",o[o.GLES3=2]="GLES3",o[o.METAL=3]="METAL",o[o.VULKAN=4]="VULKAN",o[o.WEBGL=5]="WEBGL",o[o.WEBGL2=6]="WEBGL2",o[o.WEBGPU=7]="WEBGPU",(o=Ao=Ao||{})[o.IDENTITY=0]="IDENTITY",o[o.ROTATE_90=1]="ROTATE_90",o[o.ROTATE_180=2]="ROTATE_180",o[o.ROTATE_270=3]="ROTATE_270",(o=Po=Po||{})[o.COLOR_FLOAT=0]="COLOR_FLOAT",o[o.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",o[o.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",o[o.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",o[o.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",o[o.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",o[o.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",o[o.FORMAT_SRGB=7]="FORMAT_SRGB",o[o.FORMAT_ETC1=8]="FORMAT_ETC1",o[o.FORMAT_ETC2=9]="FORMAT_ETC2",o[o.FORMAT_DXT=10]="FORMAT_DXT",o[o.FORMAT_PVRTC=11]="FORMAT_PVRTC",o[o.FORMAT_ASTC=12]="FORMAT_ASTC",o[o.FORMAT_RGB8=13]="FORMAT_RGB8",o[o.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",o[o.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",o[o.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",o[o.BLEND_MINMAX=17]="BLEND_MINMAX",o[o.COMPUTE_SHADER=18]="COMPUTE_SHADER",o[o.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",o[o.COUNT=20]="COUNT",(o=W=W||{})[o.UNKNOWN=0]="UNKNOWN",o[o.A8=1]="A8",o[o.L8=2]="L8",o[o.LA8=3]="LA8",o[o.R8=4]="R8",o[o.R8SN=5]="R8SN",o[o.R8UI=6]="R8UI",o[o.R8I=7]="R8I",o[o.R16F=8]="R16F",o[o.R16UI=9]="R16UI",o[o.R16I=10]="R16I",o[o.R32F=11]="R32F",o[o.R32UI=12]="R32UI",o[o.R32I=13]="R32I",o[o.RG8=14]="RG8",o[o.RG8SN=15]="RG8SN",o[o.RG8UI=16]="RG8UI",o[o.RG8I=17]="RG8I",o[o.RG16F=18]="RG16F",o[o.RG16UI=19]="RG16UI",o[o.RG16I=20]="RG16I",o[o.RG32F=21]="RG32F",o[o.RG32UI=22]="RG32UI",o[o.RG32I=23]="RG32I",o[o.RGB8=24]="RGB8",o[o.SRGB8=25]="SRGB8",o[o.RGB8SN=26]="RGB8SN",o[o.RGB8UI=27]="RGB8UI",o[o.RGB8I=28]="RGB8I",o[o.RGB16F=29]="RGB16F",o[o.RGB16UI=30]="RGB16UI",o[o.RGB16I=31]="RGB16I",o[o.RGB32F=32]="RGB32F",o[o.RGB32UI=33]="RGB32UI",o[o.RGB32I=34]="RGB32I",o[o.RGBA8=35]="RGBA8",o[o.BGRA8=36]="BGRA8",o[o.SRGB8_A8=37]="SRGB8_A8",o[o.RGBA8SN=38]="RGBA8SN",o[o.RGBA8UI=39]="RGBA8UI",o[o.RGBA8I=40]="RGBA8I",o[o.RGBA16F=41]="RGBA16F",o[o.RGBA16UI=42]="RGBA16UI",o[o.RGBA16I=43]="RGBA16I",o[o.RGBA32F=44]="RGBA32F",o[o.RGBA32UI=45]="RGBA32UI",o[o.RGBA32I=46]="RGBA32I",o[o.R5G6B5=47]="R5G6B5",o[o.R11G11B10F=48]="R11G11B10F",o[o.RGB5A1=49]="RGB5A1",o[o.RGBA4=50]="RGBA4",o[o.RGB10A2=51]="RGB10A2",o[o.RGB10A2UI=52]="RGB10A2UI",o[o.RGB9E5=53]="RGB9E5",o[o.DEPTH=54]="DEPTH",o[o.DEPTH_STENCIL=55]="DEPTH_STENCIL",o[o.BC1=56]="BC1",o[o.BC1_ALPHA=57]="BC1_ALPHA",o[o.BC1_SRGB=58]="BC1_SRGB",o[o.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",o[o.BC2=60]="BC2",o[o.BC2_SRGB=61]="BC2_SRGB",o[o.BC3=62]="BC3",o[o.BC3_SRGB=63]="BC3_SRGB",o[o.BC4=64]="BC4",o[o.BC4_SNORM=65]="BC4_SNORM",o[o.BC5=66]="BC5",o[o.BC5_SNORM=67]="BC5_SNORM",o[o.BC6H_UF16=68]="BC6H_UF16",o[o.BC6H_SF16=69]="BC6H_SF16",o[o.BC7=70]="BC7",o[o.BC7_SRGB=71]="BC7_SRGB",o[o.ETC_RGB8=72]="ETC_RGB8",o[o.ETC2_RGB8=73]="ETC2_RGB8",o[o.ETC2_SRGB8=74]="ETC2_SRGB8",o[o.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",o[o.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",o[o.ETC2_RGBA8=77]="ETC2_RGBA8",o[o.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",o[o.EAC_R11=79]="EAC_R11",o[o.EAC_R11SN=80]="EAC_R11SN",o[o.EAC_RG11=81]="EAC_RG11",o[o.EAC_RG11SN=82]="EAC_RG11SN",o[o.PVRTC_RGB2=83]="PVRTC_RGB2",o[o.PVRTC_RGBA2=84]="PVRTC_RGBA2",o[o.PVRTC_RGB4=85]="PVRTC_RGB4",o[o.PVRTC_RGBA4=86]="PVRTC_RGBA4",o[o.PVRTC2_2BPP=87]="PVRTC2_2BPP",o[o.PVRTC2_4BPP=88]="PVRTC2_4BPP",o[o.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",o[o.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",o[o.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",o[o.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",o[o.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",o[o.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",o[o.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",o[o.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",o[o.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",o[o.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",o[o.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",o[o.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",o[o.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",o[o.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",o[o.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",o[o.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",o[o.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",o[o.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",o[o.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",o[o.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",o[o.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",o[o.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",o[o.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",o[o.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",o[o.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",o[o.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",o[o.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",o[o.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",o[o.COUNT=117]="COUNT",(o=Io=Io||{})[o.NONE=0]="NONE",o[o.UNORM=1]="UNORM",o[o.SNORM=2]="SNORM",o[o.UINT=3]="UINT",o[o.INT=4]="INT",o[o.UFLOAT=5]="UFLOAT",o[o.FLOAT=6]="FLOAT",(o=Ro=Ro||{})[o.UNKNOWN=0]="UNKNOWN",o[o.BOOL=1]="BOOL",o[o.BOOL2=2]="BOOL2",o[o.BOOL3=3]="BOOL3",o[o.BOOL4=4]="BOOL4",o[o.INT=5]="INT",o[o.INT2=6]="INT2",o[o.INT3=7]="INT3",o[o.INT4=8]="INT4",o[o.UINT=9]="UINT",o[o.UINT2=10]="UINT2",o[o.UINT3=11]="UINT3",o[o.UINT4=12]="UINT4",o[o.FLOAT=13]="FLOAT",o[o.FLOAT2=14]="FLOAT2",o[o.FLOAT3=15]="FLOAT3",o[o.FLOAT4=16]="FLOAT4",o[o.MAT2=17]="MAT2",o[o.MAT2X3=18]="MAT2X3",o[o.MAT2X4=19]="MAT2X4",o[o.MAT3X2=20]="MAT3X2",o[o.MAT3=21]="MAT3",o[o.MAT3X4=22]="MAT3X4",o[o.MAT4X2=23]="MAT4X2",o[o.MAT4X3=24]="MAT4X3",o[o.MAT4=25]="MAT4",o[o.SAMPLER1D=26]="SAMPLER1D",o[o.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",o[o.SAMPLER2D=28]="SAMPLER2D",o[o.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",o[o.SAMPLER3D=30]="SAMPLER3D",o[o.SAMPLER_CUBE=31]="SAMPLER_CUBE",o[o.SAMPLER=32]="SAMPLER",o[o.TEXTURE1D=33]="TEXTURE1D",o[o.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",o[o.TEXTURE2D=35]="TEXTURE2D",o[o.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",o[o.TEXTURE3D=37]="TEXTURE3D",o[o.TEXTURE_CUBE=38]="TEXTURE_CUBE",o[o.IMAGE1D=39]="IMAGE1D",o[o.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",o[o.IMAGE2D=41]="IMAGE2D",o[o.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",o[o.IMAGE3D=43]="IMAGE3D",o[o.IMAGE_CUBE=44]="IMAGE_CUBE",o[o.SUBPASS_INPUT=45]="SUBPASS_INPUT",o[o.COUNT=46]="COUNT",(o=Do=Do||{})[o.NONE=0]="NONE",o[o.TRANSFER_SRC=1]="TRANSFER_SRC",o[o.TRANSFER_DST=2]="TRANSFER_DST",o[o.INDEX=4]="INDEX",o[o.VERTEX=8]="VERTEX",o[o.UNIFORM=16]="UNIFORM",o[o.STORAGE=32]="STORAGE",o[o.INDIRECT=64]="INDIRECT",Oo=Oo||{},Oo[Oo.NONE=0]="NONE",(o=Mo=Mo||{})[o.NONE=0]="NONE",o[o.READ_ONLY=1]="READ_ONLY",o[o.WRITE_ONLY=2]="WRITE_ONLY",o[o.READ_WRITE=3]="READ_WRITE",(o=No=No||{})[o.NONE=0]="NONE",o[o.DEVICE=1]="DEVICE",o[o.HOST=2]="HOST",(o=Lo=Lo||{})[o.TEX1D=0]="TEX1D",o[o.TEX2D=1]="TEX2D",o[o.TEX3D=2]="TEX3D",o[o.CUBE=3]="CUBE",o[o.TEX1D_ARRAY=4]="TEX1D_ARRAY",o[o.TEX2D_ARRAY=5]="TEX2D_ARRAY",(o=Bo=Bo||{})[o.NONE=0]="NONE",o[o.TRANSFER_SRC=1]="TRANSFER_SRC",o[o.TRANSFER_DST=2]="TRANSFER_DST",o[o.SAMPLED=4]="SAMPLED",o[o.STORAGE=8]="STORAGE",o[o.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",o[o.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",o[o.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT",(o=Fo=Fo||{})[o.NONE=0]="NONE",o[o.GEN_MIPMAP=1]="GEN_MIPMAP",o[o.GENERAL_LAYOUT=2]="GENERAL_LAYOUT",(o=zo=zo||{})[o.ONE=0]="ONE",o[o.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",o[o.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",o[o.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY",(o=Uo=Uo||{})[o.OFF=0]="OFF",o[o.ON=1]="ON",o[o.RELAXED=2]="RELAXED",o[o.MAILBOX=3]="MAILBOX",o[o.HALF=4]="HALF",(o=ko=ko||{})[o.NONE=0]="NONE",o[o.POINT=1]="POINT",o[o.LINEAR=2]="LINEAR",o[o.ANISOTROPIC=3]="ANISOTROPIC",(o=Go=Go||{})[o.WRAP=0]="WRAP",o[o.MIRROR=1]="MIRROR",o[o.CLAMP=2]="CLAMP",o[o.BORDER=3]="BORDER",(o=Ho=Ho||{})[o.NEVER=0]="NEVER",o[o.LESS=1]="LESS",o[o.EQUAL=2]="EQUAL",o[o.LESS_EQUAL=3]="LESS_EQUAL",o[o.GREATER=4]="GREATER",o[o.NOT_EQUAL=5]="NOT_EQUAL",o[o.GREATER_EQUAL=6]="GREATER_EQUAL",o[o.ALWAYS=7]="ALWAYS",(o=Vo=Vo||{})[o.ZERO=0]="ZERO",o[o.KEEP=1]="KEEP",o[o.REPLACE=2]="REPLACE",o[o.INCR=3]="INCR",o[o.DECR=4]="DECR",o[o.INVERT=5]="INVERT",o[o.INCR_WRAP=6]="INCR_WRAP",o[o.DECR_WRAP=7]="DECR_WRAP",(o=jo=jo||{})[o.ZERO=0]="ZERO",o[o.ONE=1]="ONE",o[o.SRC_ALPHA=2]="SRC_ALPHA",o[o.DST_ALPHA=3]="DST_ALPHA",o[o.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",o[o.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",o[o.SRC_COLOR=6]="SRC_COLOR",o[o.DST_COLOR=7]="DST_COLOR",o[o.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",o[o.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",o[o.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",o[o.CONSTANT_COLOR=11]="CONSTANT_COLOR",o[o.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",o[o.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",o[o.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(o=Wo=Wo||{})[o.ADD=0]="ADD",o[o.SUB=1]="SUB",o[o.REV_SUB=2]="REV_SUB",o[o.MIN=3]="MIN",o[o.MAX=4]="MAX",(o=qo=qo||{})[o.NONE=0]="NONE",o[o.R=1]="R",o[o.G=2]="G",o[o.B=4]="B",o[o.A=8]="A",o[o.ALL=15]="ALL",(o=Xo=Xo||{})[o.NONE=0]="NONE",o[o.VERTEX=1]="VERTEX",o[o.CONTROL=2]="CONTROL",o[o.EVALUATION=4]="EVALUATION",o[o.GEOMETRY=8]="GEOMETRY",o[o.FRAGMENT=16]="FRAGMENT",o[o.COMPUTE=32]="COMPUTE",o[o.ALL=63]="ALL",(o=Yo=Yo||{})[o.LOAD=0]="LOAD",o[o.CLEAR=1]="CLEAR",o[o.DISCARD=2]="DISCARD",(o=Ko=Ko||{})[o.STORE=0]="STORE",o[o.DISCARD=1]="DISCARD",(o=Qo=Qo||{})[o.NONE=0]="NONE",o[o.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",o[o.INDEX_BUFFER=2]="INDEX_BUFFER",o[o.VERTEX_BUFFER=3]="VERTEX_BUFFER",o[o.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",o[o.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",o[o.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",o[o.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",o[o.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",o[o.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",o[o.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",o[o.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",o[o.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",o[o.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",o[o.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",o[o.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",o[o.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",o[o.TRANSFER_READ=17]="TRANSFER_READ",o[o.HOST_READ=18]="HOST_READ",o[o.PRESENT=19]="PRESENT",o[o.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",o[o.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",o[o.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",o[o.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",o[o.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",o[o.TRANSFER_WRITE=25]="TRANSFER_WRITE",o[o.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",o[o.HOST_WRITE=27]="HOST_WRITE",(o=Zo=Zo||{})[o.NONE=0]="NONE",o[o.SAMPLE_ZERO=1]="SAMPLE_ZERO",o[o.AVERAGE=2]="AVERAGE",o[o.MIN=3]="MIN",o[o.MAX=4]="MAX",(o=Jo=Jo||{})[o.GRAPHICS=0]="GRAPHICS",o[o.COMPUTE=1]="COMPUTE",o[o.RAY_TRACING=2]="RAY_TRACING",(o=$o=$o||{})[o.POINT_LIST=0]="POINT_LIST",o[o.LINE_LIST=1]="LINE_LIST",o[o.LINE_STRIP=2]="LINE_STRIP",o[o.LINE_LOOP=3]="LINE_LOOP",o[o.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",o[o.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",o[o.ISO_LINE_LIST=6]="ISO_LINE_LIST",o[o.TRIANGLE_LIST=7]="TRIANGLE_LIST",o[o.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",o[o.TRIANGLE_FAN=9]="TRIANGLE_FAN",o[o.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",o[o.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",o[o.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",o[o.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(o=ea=ea||{})[o.FILL=0]="FILL",o[o.POINT=1]="POINT",o[o.LINE=2]="LINE",(o=ta=ta||{})[o.GOURAND=0]="GOURAND",o[o.FLAT=1]="FLAT",(o=ia=ia||{})[o.NONE=0]="NONE",o[o.FRONT=1]="FRONT",o[o.BACK=2]="BACK",(o=na=na||{})[o.NONE=0]="NONE",o[o.LINE_WIDTH=1]="LINE_WIDTH",o[o.DEPTH_BIAS=2]="DEPTH_BIAS",o[o.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",o[o.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",o[o.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",o[o.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK",(o=ra=ra||{})[o.FRONT=1]="FRONT",o[o.BACK=2]="BACK",o[o.ALL=3]="ALL",(o=oa=oa||{})[o.UNKNOWN=0]="UNKNOWN",o[o.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",o[o.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",o[o.STORAGE_BUFFER=4]="STORAGE_BUFFER",o[o.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",o[o.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",o[o.SAMPLER=32]="SAMPLER",o[o.TEXTURE=64]="TEXTURE",o[o.STORAGE_IMAGE=128]="STORAGE_IMAGE",o[o.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT",(o=aa=aa||{})[o.GRAPHICS=0]="GRAPHICS",o[o.COMPUTE=1]="COMPUTE",o[o.TRANSFER=2]="TRANSFER",(o=sa=sa||{})[o.OCCLUSION=0]="OCCLUSION",o[o.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",o[o.TIMESTAMP=2]="TIMESTAMP",(o=ca=ca||{})[o.PRIMARY=0]="PRIMARY",o[o.SECONDARY=1]="SECONDARY",(o=la=la||{})[o.NONE=0]="NONE",o[o.COLOR=1]="COLOR",o[o.DEPTH=2]="DEPTH",o[o.STENCIL=4]="STENCIL",o[o.DEPTH_STENCIL=6]="DEPTH_STENCIL",o[o.ALL=7]="ALL";function _a(e,t,i,n,r,o,a,s){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=Io.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e=void 0===e?"":e,this.size=t,this.count=i,this.type=n,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s}fc.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this};var fa,da=fc,ma=(_c.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},_c),ga=(pc.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},pc),va=(hc.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},hc),ya=(uc.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},uc),xa=(lc.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},lc),o=(cc.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},cc),Sa=(sc.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},sc),ba=(ac.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},ac),Ta=(oc.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},oc),Ea=(rc.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},rc),Ca=(nc.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},nc),wa=(ic.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},ic),Aa=(tc.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},tc),Pa=(ec.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},ec),Ia=($s.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},$s),Ra=(Js.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},Js),Da=(Zs.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},Zs),Oa=(Qs.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},Qs),Ma=(Ks.prototype.copy=function(e){return To(this.drawInfos,e.drawInfos,Da),this},Ks),Na=(Ys.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},Ys),a=(Xs.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},Xs),La=(qs.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},qs),Ba=(Ws.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},Ws),Fa=(js.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,To(this.members,e.members,Ba),this.count=e.count,this},js),za=(Vs.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},Vs),Ua=(Hs.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},Hs),ka=(Gs.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},Gs),Ga=(ks.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},ks),Ha=(Us.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},Us),Va=(zs.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},zs),ja=(Fs.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},Fs),Wa=(Bs.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},Bs),qa=(Ls.prototype.copy=function(e){return this.name=e.name,To(this.stages,e.stages,ja),To(this.attributes,e.attributes,Wa),To(this.blocks,e.blocks,Fa),To(this.buffers,e.buffers,Ha),To(this.samplerTextures,e.samplerTextures,za),To(this.samplers,e.samplers,Ua),To(this.textures,e.textures,ka),To(this.images,e.images,Ga),To(this.subpassInputs,e.subpassInputs,Va),this},Ls),Xa=(Ns.prototype.copy=function(e){return To(this.attributes,e.attributes,Wa),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},Ns),Ya=(Ms.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},Ms),Ka=(Os.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},Os),Qa=(Ds.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},Ds),Za=(Rs.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},Rs),Ja=(Is.prototype.copy=function(e){return To(this.colorAttachments,e.colorAttachments,Ya),this.depthStencilAttachment.copy(e.depthStencilAttachment),To(this.subpasses,e.subpasses,Qa),To(this.dependencies,e.dependencies,Za),this},Is),$a=(Ps.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},Ps),es=(As.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},As),ts=(ws.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},ws),is=(Cs.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},Cs),ns=(Es.prototype.copy=function(e){return To(this.bindings,e.bindings,is),this},Es),rs=(Ts.prototype.copy=function(e){return this.layout=e.layout,this},Ts),os=(bs.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},bs),as=(Ss.prototype.copy=function(e){return To(this.attributes,e.attributes,Wa),this},Ss),ss=(xs.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},xs),cs=(ys.prototype.copy=function(e){return this.type=e.type,this},ys),ls=(vs.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},vs),us=(gs.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},gs),hs=(ms.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},ms),ps=(ds.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},ds),_s=(e(fs,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),fs);function fs(e){this._objectType=Eo.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=fs._idTable[Eo.UNKNOWN]++,this._typedID=fs._idTable[e]++}function ds(e,t,i,n,r,o,a,s,c,l,u){void 0===e&&(e=new Ea),void 0===t&&(t=new va),void 0===i&&(i=new Ca),void 0===n&&(n=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new hs),void 0===u&&(u=new hs),this.viewport=e,this.scissor=t,this.blendConstant=i,this.lineWidth=n,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}function ms(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.writeMask=e=void 0===e?0:e,this.compareMask=t,this.reference=i}function gs(e,t){void 0===t&&(t=0),this.bufferSize=e=void 0===e?0:e,this.textureSize=t}function vs(e,t,i){void 0===e&&(e=sa.OCCLUSION),void 0===t&&(t=65536),void 0===i&&(i=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=i}function ys(e){void 0===e&&(e=aa.GRAPHICS),this.type=e}function xs(e,t){void 0===t&&(t=ca.PRIMARY),this.queue=e=void 0===e?null:e,this.type=t}function Ss(e){this.attributes=e=void 0===e?[]:e}function bs(e){this.setLayouts=e=void 0===e?[]:e}function Ts(e){this.layout=e=void 0===e?null:e}function Es(e){this.bindings=e=void 0===e?[]:e}function Cs(e,t,i,n,r){void 0===t&&(t=oa.UNKNOWN),void 0===i&&(i=0),void 0===n&&(n=Xo.NONE),void 0===r&&(r=[]),this.binding=e=void 0===e?-1:e,this.descriptorType=t,this.count=i,this.stageFlags=n,this.immutableSamplers=r}function ws(e,t,i){void 0===t&&(t=[]),void 0===i&&(i=null),this.renderPass=e=void 0===e?null:e,this.colorTextures=t,this.depthStencilTexture=i}function As(e,t,i,n,r){void 0===t&&(t=[]),void 0===i&&(i=!1),void 0===n&&(n=null),void 0===r&&(r=null),this.prevAccesses=e=void 0===e?[]:e,this.nextAccesses=t,this.discardContents=i,this.srcQueue=n,this.dstQueue=r}function Ps(e,t){void 0===t&&(t=[]),this.prevAccesses=e=void 0===e?[]:e,this.nextAccesses=t}function Is(e,t,i,n){void 0===e&&(e=[]),void 0===t&&(t=new Ka),void 0===i&&(i=[]),void 0===n&&(n=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=i,this.dependencies=n}function Rs(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=[]),void 0===n&&(n=[]),this.srcSubpass=e=void 0===e?0:e,this.dstSubpass=t,this.srcAccesses=i,this.dstAccesses=n}function Ds(e,t,i,n,r,o,a,s){void 0===t&&(t=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Zo.NONE),void 0===s&&(s=Zo.NONE),this.inputs=e=void 0===e?[]:e,this.colors=t,this.resolves=i,this.preserves=n,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}function Os(e,t,i,n,r,o,a,s,c){void 0===e&&(e=W.UNKNOWN),void 0===t&&(t=zo.ONE),void 0===i&&(i=Yo.CLEAR),void 0===n&&(n=Ko.STORE),void 0===r&&(r=Yo.CLEAR),void 0===o&&(o=Ko.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Qo.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}function Ms(e,t,i,n,r,o,a){void 0===e&&(e=W.UNKNOWN),void 0===t&&(t=zo.ONE),void 0===i&&(i=Yo.CLEAR),void 0===n&&(n=Ko.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Qo.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=i,this.storeOp=n,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}function Ns(e,t,i,n){void 0===t&&(t=[]),void 0===i&&(i=null),void 0===n&&(n=null),this.attributes=e=void 0===e?[]:e,this.vertexBuffers=t,this.indexBuffer=i,this.indirectBuffer=n}function Ls(e,t,i,n,r,o,a,s,c,l){void 0===t&&(t=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e=void 0===e?"":e,this.stages=t,this.attributes=i,this.blocks=n,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}function Bs(e,t,i,n,r,o){void 0===t&&(t=W.UNKNOWN),void 0===i&&(i=!1),void 0===n&&(n=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e=void 0===e?"":e,this.format=t,this.isNormalized=i,this.stream=n,this.isInstanced=r,this.location=o}function Fs(e,t){void 0===e&&(e=Xo.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}function zs(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=0),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.count=n}function Us(e,t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=0),void 0===r&&(r=Mo.READ_WRITE),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.count=n,this.memoryAccess=r}function ks(e,t,i,n,r,o){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=Ro.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=Mo.READ_WRITE),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.type=n,this.count=r,this.memoryAccess=o}function Gs(e,t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=Ro.UNKNOWN),void 0===r&&(r=0),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.type=n,this.count=r}function Hs(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=0),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.count=n}function Vs(e,t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=Ro.UNKNOWN),void 0===r&&(r=0),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.type=n,this.count=r}function js(e,t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=""),void 0===n&&(n=[]),void 0===r&&(r=0),this.set=e=void 0===e?0:e,this.binding=t,this.name=i,this.members=n,this.count=r}function Ws(e,t,i){void 0===t&&(t=Ro.UNKNOWN),void 0===i&&(i=0),this.name=e=void 0===e?"":e,this.type=t,this.count=i}function qs(e,t,i,n,r,o,a,s){void 0===e&&(e=ko.LINEAR),void 0===t&&(t=ko.LINEAR),void 0===i&&(i=ko.NONE),void 0===n&&(n=Go.WRAP),void 0===r&&(r=Go.WRAP),void 0===o&&(o=Go.WRAP),void 0===a&&(a=0),void 0===s&&(s=Ho.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=i,this.addressU=n,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}function Xs(e,t,i,n,r,o,a){void 0===t&&(t=Lo.TEX2D),void 0===i&&(i=W.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e=void 0===e?null:e,this.type=t,this.format=i,this.baseLevel=n,this.levelCount=r,this.baseLayer=o,this.layerCount=a}function Ys(e,t,i,n,r,o,a,s,c,l,u){void 0===e&&(e=Lo.TEX2D),void 0===t&&(t=Bo.NONE),void 0===i&&(i=W.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=Fo.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=zo.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=i,this.width=n,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}function Ks(e){this.drawInfos=e=void 0===e?[]:e}function Qs(e,t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=null),void 0===r&&(r=0),this.groupCountX=e=void 0===e?0:e,this.groupCountY=t,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=r}function Zs(e,t,i,n,r,o,a){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e=void 0===e?0:e,this.firstVertex=t,this.indexCount=i,this.firstIndex=n,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}function Js(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.buffer=e=void 0===e?null:e,this.offset=t,this.range=i}function $s(e,t,i,n,r){void 0===e&&(e=Do.NONE),void 0===t&&(t=No.NONE),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=Oo.NONE),this.usage=e,this.memUsage=t,this.size=i,this.stride=n,this.flags=r}function ec(e){void 0===e&&(e=new wa),this.bindingMappingInfo=e}function tc(e,t,i,n){void 0===t&&(t=Uo.ON),void 0===i&&(i=0),void 0===n&&(n=0),this.windowHandle=e=void 0===e?null:e,this.vsyncMode=t,this.width=i,this.height=n}function ic(e,t,i){void 0===t&&(t=[]),void 0===i&&(i=0),this.bufferOffsets=e=void 0===e?[]:e,this.samplerOffsets=t,this.flexibleSet=i}function nc(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=e=void 0===e?0:e,this.y=t,this.z=i,this.w=n}function rc(e,t,i,n,r,o){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e=void 0===e?0:e,this.top=t,this.width=i,this.height=n,this.minDepth=r,this.maxDepth=o}function oc(e,t,i,n,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=new ga),void 0===n&&(n=new ya),void 0===r&&(r=new xa),this.buffStride=e,this.buffTexHeight=t,this.texOffset=i,this.texExtent=n,this.texSubres=r}function ac(e,t,i,n,r,o){void 0===e&&(e=new xa),void 0===t&&(t=new ga),void 0===i&&(i=new ya),void 0===n&&(n=new xa),void 0===r&&(r=new ga),void 0===o&&(o=new ya),this.srcSubres=e,this.srcOffset=t,this.srcExtent=i,this.dstSubres=n,this.dstOffset=r,this.dstExtent=o}function sc(e,t,i,n,r){void 0===e&&(e=new xa),void 0===t&&(t=new ga),void 0===i&&(i=new xa),void 0===n&&(n=new ga),void 0===r&&(r=new ya),this.srcSubres=e,this.srcOffset=t,this.dstSubres=i,this.dstOffset=n,this.extent=r}function cc(e,t,i,n){void 0===t&&(t=1),void 0===i&&(i=0),void 0===n&&(n=1),this.baseMipLevel=e=void 0===e?0:e,this.levelCount=t,this.baseArrayLayer=i,this.layerCount=n}function lc(e,t,i){void 0===t&&(t=0),void 0===i&&(i=1),this.mipLevel=e=void 0===e?0:e,this.baseArrayLayer=t,this.layerCount=i}function uc(e,t,i){void 0===t&&(t=0),void 0===i&&(i=1),this.width=e=void 0===e?0:e,this.height=t,this.depth=i}function hc(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=e=void 0===e?0:e,this.y=t,this.width=i,this.height=n}function pc(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=e=void 0===e?0:e,this.y=t,this.z=i}function _c(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d,m,g,v,y,x,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===p&&(p=0),void 0===_&&(_=1),void 0===f&&(f=0),void 0===d&&(d=0),void 0===m&&(m=new da),void 0===g&&(g=new da),void 0===v&&(v=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=p,this.uboOffsetAlignment=_,this.maxComputeSharedMemorySize=f,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=g,this.supportQuery=v,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}function fc(e,t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=e=void 0===e?0:e,this.y=t,this.z=i}_s._idTable=Array(Eo.COUNT).fill(65536),(s=fa=fa||{}).ATTR_POSITION="a_position",s.ATTR_NORMAL="a_normal",s.ATTR_TANGENT="a_tangent",s.ATTR_BITANGENT="a_bitangent",s.ATTR_WEIGHTS="a_weights",s.ATTR_JOINTS="a_joints",s.ATTR_COLOR="a_color",s.ATTR_COLOR1="a_color1",s.ATTR_COLOR2="a_color2",s.ATTR_TEX_COORD="a_texCoord",s.ATTR_TEX_COORD1="a_texCoord1",s.ATTR_TEX_COORD2="a_texCoord2",s.ATTR_TEX_COORD3="a_texCoord3",s.ATTR_TEX_COORD4="a_texCoord4",s.ATTR_TEX_COORD5="a_texCoord5",s.ATTR_TEX_COORD6="a_texCoord6",s.ATTR_TEX_COORD7="a_texCoord7",s.ATTR_TEX_COORD8="a_texCoord8",s.ATTR_BATCH_ID="a_batch_id",s.ATTR_BATCH_UV="a_batch_uv";var dc=Object.freeze([new _a("UNKNOWN",0,0,Io.NONE,!1,!1,!1,!1),new _a("A8",1,1,Io.UNORM,!0,!1,!1,!1),new _a("L8",1,1,Io.UNORM,!1,!1,!1,!1),new _a("LA8",1,2,Io.UNORM,!0,!1,!1,!1),new _a("R8",1,1,Io.UNORM,!1,!1,!1,!1),new _a("R8SN",1,1,Io.SNORM,!1,!1,!1,!1),new _a("R8UI",1,1,Io.UINT,!1,!1,!1,!1),new _a("R8I",1,1,Io.INT,!1,!1,!1,!1),new _a("R16F",2,1,Io.FLOAT,!1,!1,!1,!1),new _a("R16UI",2,1,Io.UINT,!1,!1,!1,!1),new _a("R16I",2,1,Io.INT,!1,!1,!1,!1),new _a("R32F",4,1,Io.FLOAT,!1,!1,!1,!1),new _a("R32UI",4,1,Io.UINT,!1,!1,!1,!1),new _a("R32I",4,1,Io.INT,!1,!1,!1,!1),new _a("RG8",2,2,Io.UNORM,!1,!1,!1,!1),new _a("RG8SN",2,2,Io.SNORM,!1,!1,!1,!1),new _a("RG8UI",2,2,Io.UINT,!1,!1,!1,!1),new _a("RG8I",2,2,Io.INT,!1,!1,!1,!1),new _a("RG16F",4,2,Io.FLOAT,!1,!1,!1,!1),new _a("RG16UI",4,2,Io.UINT,!1,!1,!1,!1),new _a("RG16I",4,2,Io.INT,!1,!1,!1,!1),new _a("RG32F",8,2,Io.FLOAT,!1,!1,!1,!1),new _a("RG32UI",8,2,Io.UINT,!1,!1,!1,!1),new _a("RG32I",8,2,Io.INT,!1,!1,!1,!1),new _a("RGB8",3,3,Io.UNORM,!1,!1,!1,!1),new _a("SRGB8",3,3,Io.UNORM,!1,!1,!1,!1),new _a("RGB8SN",3,3,Io.SNORM,!1,!1,!1,!1),new _a("RGB8UI",3,3,Io.UINT,!1,!1,!1,!1),new _a("RGB8I",3,3,Io.INT,!1,!1,!1,!1),new _a("RGB16F",6,3,Io.FLOAT,!1,!1,!1,!1),new _a("RGB16UI",6,3,Io.UINT,!1,!1,!1,!1),new _a("RGB16I",6,3,Io.INT,!1,!1,!1,!1),new _a("RGB32F",12,3,Io.FLOAT,!1,!1,!1,!1),new _a("RGB32UI",12,3,Io.UINT,!1,!1,!1,!1),new _a("RGB32I",12,3,Io.INT,!1,!1,!1,!1),new _a("RGBA8",4,4,Io.UNORM,!0,!1,!1,!1),new _a("BGRA8",4,4,Io.UNORM,!0,!1,!1,!1),new _a("SRGB8_A8",4,4,Io.UNORM,!0,!1,!1,!1),new _a("RGBA8SN",4,4,Io.SNORM,!0,!1,!1,!1),new _a("RGBA8UI",4,4,Io.UINT,!0,!1,!1,!1),new _a("RGBA8I",4,4,Io.INT,!0,!1,!1,!1),new _a("RGBA16F",8,4,Io.FLOAT,!0,!1,!1,!1),new _a("RGBA16UI",8,4,Io.UINT,!0,!1,!1,!1),new _a("RGBA16I",8,4,Io.INT,!0,!1,!1,!1),new _a("RGBA32F",16,4,Io.FLOAT,!0,!1,!1,!1),new _a("RGBA32UI",16,4,Io.UINT,!0,!1,!1,!1),new _a("RGBA32I",16,4,Io.INT,!0,!1,!1,!1),new _a("R5G6B5",2,3,Io.UNORM,!1,!1,!1,!1),new _a("R11G11B10F",4,3,Io.FLOAT,!1,!1,!1,!1),new _a("RGB5A1",2,4,Io.UNORM,!0,!1,!1,!1),new _a("RGBA4",2,4,Io.UNORM,!0,!1,!1,!1),new _a("RGB10A2",2,4,Io.UNORM,!0,!1,!1,!1),new _a("RGB10A2UI",2,4,Io.UINT,!0,!1,!1,!1),new _a("RGB9E5",2,4,Io.FLOAT,!0,!1,!1,!1),new _a("DEPTH",4,1,Io.FLOAT,!1,!0,!1,!1),new _a("DEPTH_STENCIL",5,2,Io.FLOAT,!1,!0,!0,!1),new _a("BC1",1,3,Io.UNORM,!1,!1,!1,!0),new _a("BC1_ALPHA",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC1_SRGB",1,3,Io.UNORM,!1,!1,!1,!0),new _a("BC1_SRGB_ALPHA",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC2",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC2_SRGB",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC3",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC3_SRGB",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC4",1,1,Io.UNORM,!1,!1,!1,!0),new _a("BC4_SNORM",1,1,Io.SNORM,!1,!1,!1,!0),new _a("BC5",1,2,Io.UNORM,!1,!1,!1,!0),new _a("BC5_SNORM",1,2,Io.SNORM,!1,!1,!1,!0),new _a("BC6H_UF16",1,3,Io.UFLOAT,!1,!1,!1,!0),new _a("BC6H_SF16",1,3,Io.FLOAT,!1,!1,!1,!0),new _a("BC7",1,4,Io.UNORM,!0,!1,!1,!0),new _a("BC7_SRGB",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ETC_RGB8",1,3,Io.UNORM,!1,!1,!1,!0),new _a("ETC2_RGB8",1,3,Io.UNORM,!1,!1,!1,!0),new _a("ETC2_SRGB8",1,3,Io.UNORM,!1,!1,!1,!0),new _a("ETC2_RGB8_A1",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ETC2_SRGB8_A1",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ETC2_RGBA8",2,4,Io.UNORM,!0,!1,!1,!0),new _a("ETC2_SRGB8_A8",2,4,Io.UNORM,!0,!1,!1,!0),new _a("EAC_R11",1,1,Io.UNORM,!1,!1,!1,!0),new _a("EAC_R11SN",1,1,Io.SNORM,!1,!1,!1,!0),new _a("EAC_RG11",2,2,Io.UNORM,!1,!1,!1,!0),new _a("EAC_RG11SN",2,2,Io.SNORM,!1,!1,!1,!0),new _a("PVRTC_RGB2",2,3,Io.UNORM,!1,!1,!1,!0),new _a("PVRTC_RGBA2",2,4,Io.UNORM,!0,!1,!1,!0),new _a("PVRTC_RGB4",2,3,Io.UNORM,!1,!1,!1,!0),new _a("PVRTC_RGBA4",2,4,Io.UNORM,!0,!1,!1,!0),new _a("PVRTC2_2BPP",2,4,Io.UNORM,!0,!1,!1,!0),new _a("PVRTC2_4BPP",2,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_4x4",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_5x4",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_5x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_6x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_6x6",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_8x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_8x6",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_8x8",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_10x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_10x6",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_10x8",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_10x10",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_12x10",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_RGBA_12x12",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_4x4",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_5x4",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_5x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_6x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_6x6",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_8x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_8x6",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_8x8",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_10x5",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_10x6",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_10x8",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_10x10",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_12x10",1,4,Io.UNORM,!0,!1,!1,!0),new _a("ASTC_SRGBA_12x12",1,4,Io.UNORM,!0,!1,!1,!0)]),mc=oa.UNIFORM_BUFFER|oa.DYNAMIC_UNIFORM_BUFFER|oa.STORAGE_BUFFER|oa.DYNAMIC_STORAGE_BUFFER,gc=oa.SAMPLER_TEXTURE|oa.SAMPLER|oa.TEXTURE|oa.STORAGE_IMAGE|oa.INPUT_ATTACHMENT,vc=oa.DYNAMIC_STORAGE_BUFFER|oa.DYNAMIC_UNIFORM_BUFFER;function yc(e){return 0<e&&0==(e&e-1)}function xc(e,t,i,n){if(!dc[e].isCompressed)return t*i*n*dc[e].size;switch(e){case W.BC1:case W.BC1_ALPHA:case W.BC1_SRGB:case W.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case W.BC2:case W.BC2_SRGB:case W.BC3:case W.BC3_SRGB:case W.BC4:case W.BC4_SNORM:case W.BC6H_SF16:case W.BC6H_UF16:case W.BC7:case W.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case W.BC5:case W.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case W.ETC_RGB8:case W.ETC2_RGB8:case W.ETC2_SRGB8:case W.ETC2_RGB8_A1:case W.EAC_R11:case W.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case W.ETC2_RGBA8:case W.ETC2_SRGB8_A1:case W.EAC_RG11:case W.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case W.PVRTC_RGB2:case W.PVRTC_RGBA2:case W.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case W.PVRTC_RGB4:case W.PVRTC_RGBA4:case W.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(i,8)/2)*n;case W.ASTC_RGBA_4X4:case W.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case W.ASTC_RGBA_5X4:case W.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(i/4)*16*n;case W.ASTC_RGBA_5X5:case W.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(i/5)*16*n;case W.ASTC_RGBA_6X5:case W.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(i/5)*16*n;case W.ASTC_RGBA_6X6:case W.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(i/6)*16*n;case W.ASTC_RGBA_8X5:case W.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(i/5)*16*n;case W.ASTC_RGBA_8X6:case W.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(i/6)*16*n;case W.ASTC_RGBA_8X8:case W.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(i/8)*16*n;case W.ASTC_RGBA_10X5:case W.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(i/5)*16*n;case W.ASTC_RGBA_10X6:case W.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(i/6)*16*n;case W.ASTC_RGBA_10X8:case W.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(i/8)*16*n;case W.ASTC_RGBA_10X10:case W.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(i/10)*16*n;case W.ASTC_RGBA_12X10:case W.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(i/10)*16*n;case W.ASTC_RGBA_12X12:case W.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(i/12)*16*n;default:return 0}}function Sc(e,t,i,n,r){for(var o=0,a=0;a<r;++a)o+=xc(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return o}var bc=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Tc(e){return bc[e]||0}function Ec(e){var t=e.size/e.count;switch(e.type){case Io.UNORM:case Io.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Io.SNORM:case Io.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Io.FLOAT:return Float32Array}return Float32Array}var Cc,wc,s=Object.freeze({__proto__:null,get ObjectType(){return Eo},get Status(){return Co},get API(){return wo},get SurfaceTransform(){return Ao},get Feature(){return Po},get Format(){return W},get FormatType(){return Io},get Type(){return Ro},get BufferUsageBit(){return Do},get BufferFlagBit(){return Oo},get MemoryAccessBit(){return Mo},get MemoryUsageBit(){return No},get TextureType(){return Lo},get TextureUsageBit(){return Bo},get TextureFlagBit(){return Fo},get SampleCount(){return zo},get VsyncMode(){return Uo},get Filter(){return ko},get Address(){return Go},get ComparisonFunc(){return Ho},get StencilOp(){return Vo},get BlendFactor(){return jo},get BlendOp(){return Wo},get ColorMask(){return qo},get ShaderStageFlagBit(){return Xo},get LoadOp(){return Yo},get StoreOp(){return Ko},get AccessType(){return Qo},get ResolveMode(){return Zo},get PipelineBindPoint(){return Jo},get PrimitiveMode(){return $o},get PolygonMode(){return ea},get ShadeModel(){return ta},get CullMode(){return ia},get DynamicStateFlagBit(){return na},get StencilFace(){return ra},get DescriptorType(){return oa},get QueueType(){return aa},get QueryType(){return sa},get CommandBufferType(){return ca},get ClearFlagBit(){return la},Size:da,DeviceCaps:ma,Offset:ga,Rect:va,Extent:ya,TextureSubresLayers:xa,TextureSubresRange:o,TextureCopy:Sa,TextureBlit:ba,BufferTextureCopy:Ta,Viewport:Ea,Color:Ca,BindingMappingInfo:wa,SwapchainInfo:Aa,DeviceInfo:Pa,BufferInfo:Ia,BufferViewInfo:Ra,DrawInfo:Da,DispatchInfo:Oa,IndirectBuffer:Ma,TextureInfo:Na,TextureViewInfo:a,SamplerInfo:La,Uniform:Ba,UniformBlock:Fa,UniformSamplerTexture:za,UniformSampler:Ua,UniformTexture:ka,UniformStorageImage:Ga,UniformStorageBuffer:Ha,UniformInputAttachment:Va,ShaderStage:ja,Attribute:Wa,ShaderInfo:qa,InputAssemblerInfo:Xa,ColorAttachment:Ya,DepthStencilAttachment:Ka,SubpassInfo:Qa,SubpassDependency:Za,RenderPassInfo:Ja,GlobalBarrierInfo:$a,TextureBarrierInfo:es,FramebufferInfo:ts,DescriptorSetLayoutBinding:is,DescriptorSetLayoutInfo:ns,DescriptorSetInfo:rs,PipelineLayoutInfo:os,InputState:as,CommandBufferInfo:ss,QueueInfo:cs,QueryPoolInfo:ls,FormatInfo:_a,MemoryStatus:us,DynamicStencilStates:hs,DynamicStates:ps,GFXObject:_s,get AttributeName(){return fa},FormatInfos:dc,DESCRIPTOR_BUFFER_TYPE:mc,DESCRIPTOR_SAMPLER_TYPE:gc,DESCRIPTOR_DYNAMIC_TYPE:vc,DRAW_INFO_SIZE:28,IsPowerOf2:yc,FormatSize:xc,FormatSurfaceSize:Sc,GetTypeSize:Tc,getTypedArrayConstructor:Ec}),Ac=(l(Oc,wc=_s),e(Oc,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),Oc),Pc=(l(Dc,Cc=_s),e(Dc,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),Dc),Ic=(Rc.prototype.hasFeature=function(e){return this._features[e]},e(Rc,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),Rc);function Rc(){this._gfxAPI=wo.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(Po.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new us,this._caps=new ma,this._bindingMappingInfo=new wa,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}function Dc(){var e;return(e=Cc.call(this,Eo.COMMAND_BUFFER)||this)._queue=null,e._type=ca.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}function Oc(){var e;return(e=wc.call(this,Eo.BUFFER)||this)._usage=Do.NONE,e._memUsage=No.NONE,e._size=0,e._stride=1,e._count=0,e._flags=Oo.NONE,e._isBufferView=!1,e}Ic.canvas=void 0;l(Uc,Nc=_s),e(Uc,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]);var Mc,Nc,Lc=Uc,Bc=(l(zc,Mc=_s),e(zc,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),zc),Fc=String.prototype.charCodeAt;function zc(){var e;return(e=Mc.call(this,Eo.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}function Uc(){var e;return(e=Nc.call(this,Eo.SWAPCHAIN)||this)._transform=Ao.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}function kc(e){return this[e]}function Gc(e,t){for(var i=e.length,n=t^i,r=0,o="string"==typeof e?Fc:kc;4<=i;){var a=1540483477*(65535&(a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24))+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16);i-=4,++r}switch(i){case 3:n^=(255&o.call(e,r+2))<<16;case 2:n^=(255&o.call(e,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&o.call(e,r)))+((1540483477*(n>>>16)&65535)<<16)}return((n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16))^n>>>15)>>>0}function Hc(e,t,i,n,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null),void 0===n&&(n=new as),void 0===r&&(r=new ol),void 0===o&&(o=new al),void 0===a&&(a=new cl),void 0===s&&(s=$o.TRIANGLE_LIST),void 0===c&&(c=na.NONE),void 0===l&&(l=Jo.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=i,this.inputState=n,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l}l(Ml,el=_s),(tl=Ml.prototype).getVertexBuffer=function(e){return(e=void 0===e?0:e)<this._vertexBuffers.length?this._vertexBuffers[e]:null},tl.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var i=this.attributes[t];e+=","+i.name+","+i.format+","+i.isNormalized+","+i.stream+","+i.isInstanced}return Gc(e,666)},e(Ml,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]);var Vc,jc,Wc,qc,Xc,Yc,Kc,Qc,Zc,Jc,$c,el,tl=Ml,il=(l(Ol,$c=_s),(il=Ol.prototype).bindBuffer=function(e,t,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[e],n=this._layout.bindings[n];n&&n.descriptorType&mc&&(n=this._layout.descriptorIndices[e],this._buffers[n+i]!==t&&(this._buffers[n+i]=t,this._isDirty=!0))},il.bindSampler=function(e,t,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[e],n=this._layout.bindings[n];n&&n.descriptorType&gc&&(n=this._layout.descriptorIndices[e],this._samplers[n+i]!==t&&(this._samplers[n+i]=t,this._isDirty=!0))},il.bindTexture=function(e,t,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[e],n=this._layout.bindings[n];n&&n.descriptorType&gc&&(n=this._layout.descriptorIndices[e],this._textures[n+i]!==t&&(this._textures[n+i]=t,this._isDirty=!0))},il.getBuffer=function(e,t){e=this._layout.descriptorIndices[e];return this._buffers[e+(t=void 0===t?0:t)]},il.getSampler=function(e,t){e=this._layout.descriptorIndices[e];return this._samplers[e+(t=void 0===t?0:t)]},il.getTexture=function(e,t){e=this._layout.descriptorIndices[e];return this._textures[e+(t=void 0===t?0:t)]},e(Ol,[{key:"layout",get:function(){return this._layout}}]),Ol),nl=(l(Dl,Jc=_s),e(Dl,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),Dl),rl=(l(Rl,Zc=_s),e(Rl,[{key:"setLayouts",get:function(){return this._setLayouts}}]),Rl),ol=((ll=Il.prototype).reset=function(){this.isDiscard=!1,this.polygonMode=ea.FILL,this.shadeModel=ta.GOURAND,this.cullMode=ia.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},ll.assign=function(e){Object.assign(this,e)},ll.destroy=function(){},e(Il,[{key:"native",get:function(){return this}}]),Il),al=((ll=Pl.prototype).reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ho.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ho.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Vo.KEEP,this.stencilZFailOpFront=Vo.KEEP,this.stencilPassOpFront=Vo.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ho.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Vo.KEEP,this.stencilZFailOpBack=Vo.KEEP,this.stencilPassOpBack=Vo.KEEP,this.stencilRefBack=1},ll.assign=function(e){Object.assign(this,e)},ll.destroy=function(){},e(Pl,[{key:"native",get:function(){return this}}]),Pl),sl=((ll=Al.prototype).reset=function(){this.blend=!1,this.blendSrc=jo.ONE,this.blendDst=jo.ZERO,this.blendEq=Wo.ADD,this.blendSrcAlpha=jo.ONE,this.blendDstAlpha=jo.ZERO,this.blendAlphaEq=Wo.ADD,this.blendColorMask=qo.ALL},ll.assign=function(e){Object.assign(this,e)},ll.destroy=function(){},Al),cl=((ll=wl.prototype).setTarget=function(e,t){var i=(i=this.targets[e])||(this.targets[e]=new sl);Object.assign(i,t)},ll.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},ll.destroy=function(){},e(wl,[{key:"native",get:function(){return this}}]),wl),ll=(l(Cl,Qc=_s),e(Cl,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),Cl),ul=(l(El,Kc=_s),e(El,[{key:"type",get:function(){return this._type}}]),El),hl=(l(Tl,Yc=_s),Tl.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var i,n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var r=0;r<n.inputs.length;++r){var o=this._colorInfos[n.inputs[r]];e+=","+o.format+","+o.sampleCount}}if(n.colors.length){e+="ca";for(var a=0;a<n.inputs.length;++a){var s=this._colorInfos[n.inputs[a]];e+=","+s.format+","+s.sampleCount}}0<=n.depthStencil&&(e+="ds,"+(i=this._colorInfos[n.depthStencil]).format+","+i.sampleCount)}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return Gc(e,666)},e(Tl,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),Tl),pl=(l(bl,Xc=_s),bl.computeHash=function(e){var t=e.minFilter;return(t|=e.magFilter<<2)|e.mipFilter<<4|e.addressU<<6|e.addressV<<8|e.addressW<<10|e.maxAnisotropy<<12|e.cmpFunc<<16},bl.unpackFromHash=function(e){var t=new La;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},e(bl,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),bl),_l=(l(Sl,qc=_s),e(Sl,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),Sl),fl=(l(xl,Wc=_s),e(xl,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),xl),dl=(l(yl,jc=_s),yl.computeHash=function(e){for(var t="prev:",i=0;i<e.prevAccesses.length;++i)t+=" "+e.prevAccesses[i];t+="next:";for(var n=0;n<e.nextAccesses.length;++n)t+=" "+e.nextAccesses[n];return Gc(t,666)},e(yl,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),yl),ml=(l(vl,Vc=_s),vl.computeHash=function(e){for(var t="prev:",i=0;i<e.prevAccesses.length;++i)t+=" "+e.prevAccesses[i];t+="next:";for(var n=0;n<e.nextAccesses.length;++n)t+=" "+e.nextAccesses[n];return Gc(t=(t=(t+=e.discardContents)+(e.srcQueue?e.srcQueue.type:0))+(e.dstQueue?e.dstQueue.type:0),666)},e(vl,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),vl),gl={Device:Ic,Swapchain:Lc,Buffer:Ac,Texture:fl,Sampler:pl,Shader:_l,InputAssembler:tl,RenderPass:hl,Framebuffer:Bc,DescriptorSet:il,DescriptorSetLayout:nl,PipelineLayout:rl,PipelineState:ll,CommandBuffer:Pc,Queue:ul,GlobalBarrier:dl,TextureBarrier:ml,RasterizerState:ol,BlendState:cl,BlendTarget:sl,DepthStencilState:al,PipelineStateInfo:Hc};function vl(e,t){var i;return(i=Vc.call(this,Eo.TEXTURE_BARRIER)||this)._info=new es,i._hash=0,i._info.copy(e),i._hash=t,i}function yl(e,t){var i;return(i=jc.call(this,Eo.GLOBAL_BARRIER)||this)._info=new $a,i._hash=0,i._info.copy(e),i._hash=t,i}function xl(){var e;return(e=Wc.call(this,Eo.TEXTURE)||this)._type=Lo.TEX2D,e._usage=Bo.NONE,e._format=W.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=zo.ONE,e._flags=Fo.NONE,e._isPowerOf2=!1,e._size=0,e}function Sl(){var e;return(e=qc.call(this,Eo.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}function bl(e,t){var i;return(i=Xc.call(this,Eo.SAMPLER)||this)._info=new La,i._hash=0,i._info.copy(e),i._hash=t,i}function Tl(){var e;return(e=Yc.call(this,Eo.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}function El(){var e;return(e=Kc.call(this,Eo.QUEUE)||this)._type=aa.GRAPHICS,e}function Cl(){var e;return(e=Qc.call(this,Eo.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=$o.TRIANGLE_LIST,e._is=null,e._rs=new ol,e._dss=new al,e._bs=new cl,e._dynamicStates=na.NONE,e._renderPass=null,e}function wl(e,t,i,n){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===i&&(i=new Ca),void 0===n&&(n=[new sl]),this.isA2C=e,this.isIndepend=t,this.blendColor=i,this.targets=n}function Al(e,t,i,n,r,o,a,s){void 0===t&&(t=jo.ONE),void 0===i&&(i=jo.ZERO),void 0===n&&(n=Wo.ADD),void 0===r&&(r=jo.ONE),void 0===o&&(o=jo.ZERO),void 0===a&&(a=Wo.ADD),void 0===s&&(s=qo.ALL),this.blend=e=void 0===e?!1:e,this.blendSrc=t,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}function Pl(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d,m,g,v){void 0===t&&(t=!0),void 0===i&&(i=Ho.LESS),void 0===n&&(n=!1),void 0===r&&(r=Ho.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Vo.KEEP),void 0===c&&(c=Vo.KEEP),void 0===l&&(l=Vo.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===p&&(p=Ho.ALWAYS),void 0===_&&(_=65535),void 0===f&&(f=65535),void 0===d&&(d=Vo.KEEP),void 0===m&&(m=Vo.KEEP),void 0===g&&(g=Vo.KEEP),void 0===v&&(v=1),this.depthTest=e=void 0===e?!0:e,this.depthWrite=t,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=p,this.stencilReadMaskBack=_,this.stencilWriteMaskBack=f,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=g,this.stencilRefBack=v}function Il(e,t,i,n,r,o,a,s,c,l,u,h){void 0===t&&(t=ea.FILL),void 0===i&&(i=ta.GOURAND),void 0===n&&(n=ia.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e=void 0===e?!1:e,this.polygonMode=t,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}function Rl(){var e;return(e=Zc.call(this,Eo.PIPELINE_LAYOUT)||this)._setLayouts=[],e}function Dl(){var e;return(e=Jc.call(this,Eo.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}function Ol(){var e;return(e=$c.call(this,Eo.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}function Ml(){var e;return(e=el.call(this,Eo.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new Da,e}Object.assign(gl,s),j.gfx=gl;var Nl,Ll,Bl,Fl={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(Ll in j.gfx)"__esModule"!==Ll&&(""===(Bl=Fl[Ll])?Bl=Ll:void 0===Bl&&(Bl="GFX"+Ll),In(j,"cc",[{name:Bl,newName:Ll,target:j.gfx,targetName:"cc.gfx"}]));Rre("gfx",Object.freeze({__proto__:null,DescriptorSet:il,Buffer:Ac,CommandBuffer:Pc,get ObjectType(){return Eo},get Status(){return Co},get API(){return wo},get SurfaceTransform(){return Ao},get Feature(){return Po},get Format(){return W},get FormatType(){return Io},get Type(){return Ro},get BufferUsageBit(){return Do},get BufferFlagBit(){return Oo},get MemoryAccessBit(){return Mo},get MemoryUsageBit(){return No},get TextureType(){return Lo},get TextureUsageBit(){return Bo},get TextureFlagBit(){return Fo},get SampleCount(){return zo},get VsyncMode(){return Uo},get Filter(){return ko},get Address(){return Go},get ComparisonFunc(){return Ho},get StencilOp(){return Vo},get BlendFactor(){return jo},get BlendOp(){return Wo},get ColorMask(){return qo},get ShaderStageFlagBit(){return Xo},get LoadOp(){return Yo},get StoreOp(){return Ko},get AccessType(){return Qo},get ResolveMode(){return Zo},get PipelineBindPoint(){return Jo},get PrimitiveMode(){return $o},get PolygonMode(){return ea},get ShadeModel(){return ta},get CullMode(){return ia},get DynamicStateFlagBit(){return na},get StencilFace(){return ra},get DescriptorType(){return oa},get QueueType(){return aa},get QueryType(){return sa},get CommandBufferType(){return ca},get ClearFlagBit(){return la},Size:da,DeviceCaps:ma,Offset:ga,Rect:va,Extent:ya,TextureSubresLayers:xa,TextureSubresRange:o,TextureCopy:Sa,TextureBlit:ba,BufferTextureCopy:Ta,Viewport:Ea,Color:Ca,BindingMappingInfo:wa,SwapchainInfo:Aa,DeviceInfo:Pa,BufferInfo:Ia,BufferViewInfo:Ra,DrawInfo:Da,DispatchInfo:Oa,IndirectBuffer:Ma,TextureInfo:Na,TextureViewInfo:a,SamplerInfo:La,Uniform:Ba,UniformBlock:Fa,UniformSamplerTexture:za,UniformSampler:Ua,UniformTexture:ka,UniformStorageImage:Ga,UniformStorageBuffer:Ha,UniformInputAttachment:Va,ShaderStage:ja,Attribute:Wa,ShaderInfo:qa,InputAssemblerInfo:Xa,ColorAttachment:Ya,DepthStencilAttachment:Ka,SubpassInfo:Qa,SubpassDependency:Za,RenderPassInfo:Ja,GlobalBarrierInfo:$a,TextureBarrierInfo:es,FramebufferInfo:ts,DescriptorSetLayoutBinding:is,DescriptorSetLayoutInfo:ns,DescriptorSetInfo:rs,PipelineLayoutInfo:os,InputState:as,CommandBufferInfo:ss,QueueInfo:cs,QueryPoolInfo:ls,FormatInfo:_a,MemoryStatus:us,DynamicStencilStates:hs,DynamicStates:ps,GFXObject:_s,get AttributeName(){return fa},FormatInfos:dc,DESCRIPTOR_BUFFER_TYPE:mc,DESCRIPTOR_SAMPLER_TYPE:gc,DESCRIPTOR_DYNAMIC_TYPE:vc,DRAW_INFO_SIZE:28,IsPowerOf2:yc,FormatSize:xc,FormatSurfaceSize:Sc,GetTypeSize:Tc,getTypedArrayConstructor:Ec,Device:Ic,Swapchain:Lc,Framebuffer:Bc,InputAssembler:tl,DescriptorSetLayout:nl,PipelineLayout:rl,RasterizerState:ol,DepthStencilState:al,BlendTarget:sl,BlendState:cl,PipelineStateInfo:Hc,PipelineState:ll,Queue:ul,RenderPass:hl,Sampler:pl,Shader:_l,Texture:fl,GlobalBarrier:dl,TextureBarrier:ml})),(s=Nl=Nl||{})[s.ALL=0]="ALL",s[s.CLOSEST=1]="CLOSEST",s[s.ANY=2]="ANY";function zl(e,t){var i=ce.dot(e.d,t.n);return Math.abs(i)<Number.EPSILON?0:(ce.multiplyScalar(Gl,t.n,t.d),(e=ce.dot(ce.subtract(Gl,Gl,e.o),t.n)/i)<0?0:e)}function Ul(e,t,i){ce.subtract(Hl,t.b,t.a),ce.subtract(Vl,t.c,t.a),ce.cross(jl,e.d,Vl);var n=ce.dot(Hl,jl);return n<Number.EPSILON&&(!i||n>-Number.EPSILON)?0:(i=1/n,ce.subtract(Wl,e.o,t.a),(n=ce.dot(Wl,jl)*i)<0||1<n?0:(ce.cross(ql,Wl,Hl),(t=ce.dot(e.d,ql)*i)<0||1<n+t||(e=ce.dot(Vl,ql)*i)<0?0:e))}Gl=new ce(0,0,0),Hl=new ce(0,0,0),Vl=new ce(0,0,0),jl=new ce(0,0,0),Wl=new ce(0,0,0),ql=new ce(0,0,0);function kl(e,t){return ce.subtract(Xl,t.center,t.halfExtents),ce.add(Yl,t.center,t.halfExtents),Zl(e,Xl,Yl)}Kl=new ce(0,0,0);var Gl,Hl,Vl,jl,Wl,ql,Xl,Yl,Kl,Ql=function(e,t){var i=t.radius,t=t.center,n=e.o,e=e.d,i=i*i,t=(ce.subtract(Kl,t,n),Kl.lengthSqr()),n=ce.dot(Kl,e),e=i-(t-n*n);if(e<0)return 0;e=Math.sqrt(e),t=t<i?n+e:n-e;return t<0?0:t};Xl=new ce,Yl=new ce;function Zl(e,t,i){var n=e.o,e=e.d,r=1/e.x,o=1/e.y,e=1/e.z,a=(t.x-n.x)*r,r=(i.x-n.x)*r,s=(t.y-n.y)*o,o=(i.y-n.y)*o,t=(t.z-n.z)*e,i=(i.z-n.z)*e,n=Math.max(Math.max(Math.min(a,r),Math.min(s,o)),Math.min(t,i)),e=Math.min(Math.min(Math.max(a,r),Math.max(s,o)),Math.max(t,i));return e<0||e<n?0:0<n?n:e}function Jl(e,t){var i=t.radius*t.radius,n=ce.normalize(Su,e.d),r=t.ellipseCenter0,o=t.ellipseCenter1,a=ce.subtract(bu,o,r);if(a.equals(ce.ZERO))return Pu.radius=t.radius,Pu.center.set(t.ellipseCenter0),Ch.raySphere(e,Pu);var s=e.o,c=ce.subtract(Tu,s,r),l=(p=ce.cross(Eu,n,a)).lengthSqr();if(0===l)return Pu.radius=t.radius,u=ce.subtract(Cu,o,s),c.lengthSqr()<u.lengthSqr()?Pu.center.set(t.ellipseCenter0):Pu.center.set(t.ellipseCenter1),Ch.raySphere(e,Pu);var u=ce.cross(Cu,c,a),h=a.lengthSqr(),p=2*ce.dot(p,u);return(u=p*p-4*l*(u.lengthSqr()-i*h))<0?0:(i=(-p-Math.sqrt(u))/(2*l))<0?(Pu.radius=t.radius,p=ce.subtract(wu,o,s),c.lengthSqr()<p.lengthSqr()?Pu.center.set(t.ellipseCenter0):Pu.center.set(t.ellipseCenter1),Ch.raySphere(e,Pu)):(u=ce.scaleAndAdd(wu,e.o,n,i),l=ce.subtract(Au,u,r),0<=(o=ce.dot(l,a)/h)&&o<=1?i:o<0?(Pu.radius=t.radius,Pu.center.set(t.ellipseCenter0),Ch.raySphere(e,Pu)):1<o?(Pu.radius=t.radius,Pu.center.set(t.ellipseCenter1),Ch.raySphere(e,Pu)):0)}function $l(e,t,i){if((au=0)===t.geometricInfo.positions.length)return au;var n,i=void 0===i?ou:i;return Zl(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)&&(n=t.primitiveMode,function(e,t,i,n,r){if(i===$o.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2],u=(ce.set(ru.a,e[s],e[1+s],e[2+s]),ce.set(ru.b,e[c],e[1+c],e[2+c]),ce.set(ru.c,e[l],e[1+l],e[2+l]),Ch.rayTriangle(n,ru,r.doubleSided));if(!(0===u||u>r.distance)&&(su(r.mode,u,s,c,l,r.result),r.mode===Nl.ANY))return}else if(i===$o.TRIANGLE_STRIP)for(var h=t.length-2,p=0,_=0;_<h;_+=1){var f=3*t[_-p],d=3*t[_+p+1],m=3*t[_+2],g=(ce.set(ru.a,e[f],e[1+f],e[2+f]),ce.set(ru.b,e[d],e[1+d],e[2+d]),ce.set(ru.c,e[m],e[1+m],e[2+m]),p=~p,Ch.rayTriangle(n,ru,r.doubleSided));if(!(0===g||g>r.distance)&&(su(r.mode,g,f,d,m,r.result),r.mode===Nl.ANY))return}else if(i===$o.TRIANGLE_FAN){var v=t.length-1,y=3*t[0];ce.set(ru.a,e[y],e[1+y],e[2+y]);for(var x=1;x<v;x+=1){var S=3*t[x],b=3*t[x+1],T=(ce.set(ru.b,e[S],e[1+S],e[2+S]),ce.set(ru.c,e[b],e[1+b],e[2+b]),Ch.rayTriangle(n,ru,r.doubleSided));if(!(0===T||T>r.distance)&&(su(r.mode,T,y,S,b,r.result),r.mode===Nl.ANY))return}}}((t=t.geometricInfo).positions,t.indices,n,e,i)),au}function eu(e,t,i){var n=void(yu=0)===i?xu:i,r=t.renderingSubMeshes.length,i=t.struct.minPosition,o=t.struct.maxPosition;if(i&&o&&!Zl(e,i,o))return yu;for(var a=0;a<r;a++){var s=t.renderingSubMeshes[a],s=$l(e,s,n);if(s)if(n.mode===Nl.CLOSEST)(0===yu||s<yu)&&(yu=s,n.subIndices&&(n.subIndices[0]=a));else if(yu=s,n.subIndices&&n.subIndices.push(a),n.mode===Nl.ANY)return s}return yu&&n.mode===Nl.CLOSEST&&(n.result&&(n.result[0].distance=yu,n.result.length=1),n.subIndices&&(n.subIndices.length=1)),yu}function tu(e,t,i){var n=void(du=0)===i?mu:i;if((i=t.worldBounds)&&!kl(e,i))return du;fo.copy(gu,e),t.node&&(B.invert(vu,t.node.getWorldMatrix(vu)),ce.transformMat4(gu.o,e.o,vu),ce.transformMat4Normal(gu.d,e.d,vu));for(var r=t.subModels,o=0;o<r.length;o++){var a=r[o].subMesh,a=$l(gu,a,n);if(a)if(n.mode===Nl.CLOSEST)(0===du||a<du)&&(du=a,n.subIndices&&(n.subIndices[0]=o));else if(du=a,n.subIndices&&n.subIndices.push(o),n.mode===Nl.ANY)return a}return du&&n.mode===Nl.CLOSEST&&(n.result&&(n.result[0].distance=du,n.result.length=1),n.subIndices&&(n.subIndices.length=1)),du}function iu(e,t){return ce.subtract(fu,e.e,e.s),(e=(t.d-ce.dot(e.s,t.n))/ce.dot(fu,t.n))<0||1<e?0:e}function nu(e,t,i){ce.subtract(cu,t.b,t.a),ce.subtract(lu,t.c,t.a),ce.subtract(uu,e.s,e.e),ce.cross(pu,cu,lu);var n=ce.dot(uu,pu);if(n<=0)return 0;if(ce.subtract(hu,e.s,t.a),(e=ce.dot(hu,pu))<0||n<e)return 0;if(ce.cross(_u,uu,hu),(e=ce.dot(lu,_u))<0||n<e)return 0;var r=-ce.dot(cu,_u);return r<0||n<e+r?0:(i&&(n=1-(e*=n=1/n)-(r*=n),ce.set(i,t.a.x*n+t.b.x*e+t.c.x*r,t.a.y*n+t.b.y*e+t.c.y*r,t.a.z*n+t.b.z*e+t.c.z*r)),1)}new ce,new ce,new ce,Ou=new ce,Mu=new ce,Nu=new ce,Lu=new ce,Bu=new Array(3),Fu=new Array(3),zu=new Array(3),Uu=new Array(6);var ru,ou,au,su,cu,lu,uu,hu,pu,_u,fu,du,mu,gu,vu,yu,xu,Su,bu,Tu,Eu,Cu,wu,Au,Pu,Iu,Ru,Du,Ou,Mu,Nu,Lu,Bu,Fu,zu,Uu,ku=function(e,t){Bu[0]=t.halfExtents.x,Bu[1]=t.halfExtents.y,Bu[2]=t.halfExtents.z,Iu=t.center,Ru=e.o,Du=e.d,ce.set(Ou,t.orientation.m00,t.orientation.m01,t.orientation.m02),ce.set(Mu,t.orientation.m03,t.orientation.m04,t.orientation.m05),ce.set(Nu,t.orientation.m06,t.orientation.m07,t.orientation.m08),ce.subtract(Lu,Iu,Ru),Fu[0]=ce.dot(Ou,Du),Fu[1]=ce.dot(Mu,Du),Fu[2]=ce.dot(Nu,Du),zu[0]=ce.dot(Ou,Lu),zu[1]=ce.dot(Mu,Lu),zu[2]=ce.dot(Nu,Lu);for(var i=0;i<3;++i){if(0===Fu[i]){if(0<-zu[i]-Bu[i]||-zu[i]+Bu[i]<0)return 0;Fu[i]=1e-7}Uu[2*i+0]=(zu[i]+Bu[i])/Fu[i],Uu[2*i+1]=(zu[i]-Bu[i])/Fu[i]}e=Math.max(Math.max(Math.min(Uu[0],Uu[1]),Math.min(Uu[2],Uu[3])),Math.min(Uu[4],Uu[5])),t=Math.min(Math.min(Math.max(Uu[0],Uu[1]),Math.max(Uu[2],Uu[3])),Math.max(Uu[4],Uu[5]));return t<0||t<e?0:0<e?e:t},Gu=(Su=new ce,bu=new ce,Tu=new ce,Eu=new ce,Cu=new ce,wu=new ce,Au=new ce,Pu=new ua,ru=r.create(),ou={distance:1/0,doubleSided:!1,mode:Nl.ANY},xu={distance:1/(yu=au=0),doubleSided:!(su=function(e,t,i,n,r,o){e===Nl.CLOSEST?(t<au||0===au)&&(au=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=i/3,o[0].vertexIndex1=n/3,o[0].vertexIndex2=r/3))):(au=t,o&&o.push({distance:t,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}))}),mode:Nl.ANY},mu={distance:1/(du=0),doubleSided:!1,mode:Nl.ANY},gu=new fo,vu=new B,fu=new ce(0,0,0),cu=new ce(0,0,0),lu=new ce(0,0,0),uu=new ce(0,0,0),hu=new ce(0,0,0),pu=new ce(0,0,0),_u=new ce(0,0,0),new fo);function Hu(e,t){Gu.o.set(e.s),ce.subtract(Gu.d,e.e,e.s),Gu.d.normalize();t=kl(Gu,t);return t<=e.length()?t:0}function Vu(e,t){Gu.o.set(e.s),ce.subtract(Gu.d,e.e,e.s),Gu.d.normalize();t=ku(Gu,t);return t<=e.length()?t:0}function ju(e,t){Gu.o.set(e.s),ce.subtract(Gu.d,e.e,e.s),Gu.d.normalize();t=Ql(Gu,t);return t<=e.length()?t:0}function Wu(e,t){return ce.subtract(qu,e.center,e.halfExtents),ce.add(Xu,e.center,e.halfExtents),ce.subtract(Yu,t.center,t.halfExtents),ce.add(Ku,t.center,t.halfExtents),qu.x<=Ku.x&&Xu.x>=Yu.x&&qu.y<=Ku.y&&Xu.y>=Yu.y&&qu.z<=Ku.z&&Xu.z>=Yu.z}var qu,Xu,Yu,Ku;qu=new ce,Xu=new ce,Yu=new ce,Ku=new ce;function Qu(e,t,i,n,r,o){ce.set(o[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),ce.set(o[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),ce.set(o[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),ce.set(o[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),ce.set(o[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),ce.set(o[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),ce.set(o[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),ce.set(o[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function Zu(e,t){for(var i=o=ce.dot(t,e[0]),n=1;n<8;++n)var r=ce.dot(t,e[n]),o=r<o?r:o,i=i<r?r:i;return[o,i]}function Ju(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z);return(e=ce.dot(t.n,e.center))+i<t.d?-1:e-i>t.d?0:1}function $u(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Ju(e,t.planes[i]))return 0;return 1}function eh(e,t){var i=e.halfExtents.x*ph(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*ph(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*ph(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08);return(e=ce.dot(t.n,e.center))+i<t.d?-1:e-i>t.d?0:1}function th(e,t){for(var i=0;i<t.planes.length;i++)if(-1===eh(e,t.planes[i]))return 0;return 1}function ih(e,t){var i=ce.dot(t.n,e.center),e=e.radius*t.n.length();return i+e<t.d?-1:i-e>t.d?0:1}function nh(e,t){for(var i=0;i<t.planes.length;i++)if(-1===ih(e,t.planes[i]))return 0;return 1}function rh(e,t){for(var i=0;i<6;i++){var n=t.planes[i],r=e.radius,o=e.center,a=n.n,n=n.d,s=ce.dot(a,o);if(s+r<n)return 0;if(!(n<s-r)){ce.add(Th,o,ce.multiplyScalar(Th,a,r));for(var c=0;c<6;c++)if(c!==i&&c!==i+Eh[i]){var l=t.planes[c];if(ce.dot(l.n,Th)<l.d)return 0}}}return 1}function oh(e,t){var i=e.radius+t.radius;return ce.squaredDistance(e.center,t.center)<i*i}function ah(e,t){return ho(bh,e.center,t),ce.squaredDistance(e.center,bh)<e.radius*e.radius}function sh(e,t){return po(Sh,e.center,t),ce.squaredDistance(e.center,Sh)<e.radius*e.radius}function ch(e,t){var i=(i=e.radius+t.radius)*i,n=ce.squaredDistance(t.ellipseCenter0,t.ellipseCenter1);return 0===n?ce.squaredDistance(e.center,t.center)<i:(ce.subtract(yh,e.center,t.ellipseCenter0),ce.subtract(xh,t.ellipseCenter1,t.ellipseCenter0),(n=ce.dot(yh,xh)/n)<0?ce.squaredDistance(e.center,t.ellipseCenter0)<i:1<n?ce.squaredDistance(e.center,t.ellipseCenter1)<i:(ce.scaleAndAdd(yh,t.ellipseCenter0,xh,n),ce.squaredDistance(e.center,yh)<i))}function lh(e,t){var i,n,r=ce.subtract(_h,e.ellipseCenter1,e.ellipseCenter0),o=ce.subtract(fh,t.ellipseCenter1,t.ellipseCenter0),a=ce.subtract(dh,e.ellipseCenter0,t.ellipseCenter0),s=ce.dot(r,r),c=ce.dot(r,o),l=ce.dot(o,o),u=ce.dot(r,a),h=ce.dot(o,a),p=f=s*l-c*c,_=f,f=(f<Nn?(i=0,p=1,n=h,_=l):(n=s*h-c*u,(i=c*h-l*u)<0?(i=0,n=h,_=l):p<i&&(i=p,n=h+c,_=l)),n<0?-u<(n=0)?i=0:s<-u?i=p:(i=-u,p=s):_<n&&(n=_,-u+c<0?i=0:s<-u+c?i=p:(i=-u+c,p=s)),Math.abs(i)<Nn?0:i/p),h=Math.abs(n)<Nn?0:n/_,u=((l=mh).set(a),l.add(ce.multiplyScalar(gh,r,f)),l.subtract(ce.multiplyScalar(vh,o,h)),e.radius+t.radius);return l.lengthSqr()<u*u}var uh,hh,ph,_h,fh,dh,mh,gh,vh,yh,xh,Sh,bh,Th,Eh,gl=function(){for(var c=new Array(15),e=0;e<15;e++)c[e]=new ce(0,0,0);for(var l=new Array(8),u=new Array(8),t=0;t<8;t++)l[t]=new ce(0,0,0),u[t]=new ce(0,0,0);var h=new ce,p=new ce;return function(e,t){ce.set(c[0],1,0,0),ce.set(c[1],0,1,0),ce.set(c[2],0,0,1),ce.set(c[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),ce.set(c[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),ce.set(c[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i,n,r=0;r<3;++r)ce.cross(c[6+3*r],c[r],c[3]),ce.cross(c[7+3*r],c[r],c[4]),ce.cross(c[7+3*r],c[r],c[5]);ce.subtract(h,e.center,e.halfExtents),ce.add(p,e.center,e.halfExtents),e=h,i=p,n=l,ce.set(n[0],e.x,i.y,i.z),ce.set(n[1],e.x,i.y,e.z),ce.set(n[2],e.x,e.y,i.z),ce.set(n[3],e.x,e.y,e.z),ce.set(n[4],i.x,i.y,i.z),ce.set(n[5],i.x,i.y,e.z),ce.set(n[6],i.x,e.y,i.z),ce.set(n[7],i.x,e.y,e.z),Qu(t.center,t.halfExtents,c[3],c[4],c[5],u);for(var o=0;o<15;++o){var a=Zu(l,c[o]),s=Zu(u,c[o]);if(s[0]>a[1]||a[0]>s[1])return 0}return 1}}(),o=function(){for(var l=new Array(8),u=0,h=0,e=0;e<l.length;e++)l[e]=new ce(0,0,0);return function(e,t){for(var i,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=Ju(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var o=0;o<t.vertices.length;o++)ce.subtract(l[o],t.vertices[o],e.center);for(var a=h=u=0;a<t.vertices.length;a++)l[a].x>e.halfExtents.x?u++:l[a].x<-e.halfExtents.x&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var s=h=u=0;s<t.vertices.length;s++)l[s].y>e.halfExtents.y?u++:l[s].y<-e.halfExtents.y&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var c=h=u=0;c<t.vertices.length;c++)l[c].z>e.halfExtents.z?u++:l[c].z<-e.halfExtents.z&&h++;return u===t.vertices.length||h===t.vertices.length?0:1}}(),Sa=(uh=new ce(0,0,0),hh=new pr,ph=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(){for(var l=new Array(8),u=0,h=0,p=0,e=0;e<l.length;e++)l[e]=new ce(0,0,0);function _(e,t,i,n){return e.x*t+e.y*i+e.z*n}return function(e,t){for(var i,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=eh(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var o=0;o<t.vertices.length;o++)ce.subtract(l[o],t.vertices[o],e.center);for(var a=p=h=0;a<t.vertices.length;a++)(u=_(l[a],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:u<-e.halfExtents.x&&p++;if(h===t.vertices.length||p===t.vertices.length)return 0;for(var s=p=h=0;s<t.vertices.length;s++)(u=_(l[s],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:u<-e.halfExtents.y&&p++;if(h===t.vertices.length||p===t.vertices.length)return 0;for(var c=p=h=0;c<t.vertices.length;c++)(u=_(l[c],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:u<-e.halfExtents.z&&p++;return h===t.vertices.length||p===t.vertices.length?0:1}}()),ba=function(){for(var a=new Array(15),e=0;e<15;e++)a[e]=new ce(0,0,0);for(var s=new Array(8),c=new Array(8),t=0;t<8;t++)s[t]=new ce(0,0,0),c[t]=new ce(0,0,0);return function(e,t){ce.set(a[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),ce.set(a[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),ce.set(a[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),ce.set(a[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),ce.set(a[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),ce.set(a[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)ce.cross(a[6+3*i],a[i],a[3]),ce.cross(a[7+3*i],a[i],a[4]),ce.cross(a[8+3*i],a[i],a[5]);Qu(e.center,e.halfExtents,a[0],a[1],a[2],s),Qu(t.center,t.halfExtents,a[3],a[4],a[5],c);for(var n=0;n<15;++n){var r=Zu(s,a[n]),o=Zu(c,a[n]);if(o[0]>r[1]||r[0]>o[1])return 0}return 1}}(),Oa=function(){for(var h=new ua,p=new ce,_=new ce,f=new ce,d=new Array(8),e=0;e<8;e++)d[e]=new ce;for(var m=new Array(8),t=0;t<8;t++)m[t]=new ce;return function(e,t){if(0===ce.squaredDistance(t.ellipseCenter0,t.ellipseCenter1))return h.radius=t.radius,h.center.set(t.ellipseCenter0),Ch.sphereOBB(h,e);p.x=e.orientation.m00,p.y=e.orientation.m01,p.z=e.orientation.m02,_.x=e.orientation.m03,_.y=e.orientation.m04,_.z=e.orientation.m05,f.x=e.orientation.m06,f.y=e.orientation.m07,f.z=e.orientation.m08,Qu(e.center,e.halfExtents,p,_,f,d);var i=m,n=ce.copy(i[0],p),r=ce.copy(i[1],_),o=ce.copy(i[2],f),e=(ce.subtract(i[3],t.center,e.center).normalize(),ce.subtract(i[4],t.ellipseCenter0,t.ellipseCenter1));e.normalize(),ce.cross(i[5],n,e),ce.cross(i[6],r,e),ce.cross(i[7],o,e);for(var a=0;a<8;++a){var s=Zu(d,i[a]),c=ce.dot(i[a],t.ellipseCenter0),l=ce.dot(i[a],t.ellipseCenter1),u=Math.max(c,l),c=Math.min(c,l)-t.radius,l=u+t.radius;if(c>s[1]||s[0]>l)return 0}return 1}}(),Ch=(Th=new ce(0,0,0),Eh=[1,-1,1,-1,1,-1],bh=new ce,Sh=new ce,yh=new ce,xh=new ce,_h=new ce,fh=new ce,dh=new ce,mh=new ce,gh=new ce,vh=new ce,{raySphere:Ql,rayAABB:kl,rayOBB:ku,rayPlane:zl,rayTriangle:Ul,rayCapsule:Jl,raySubMesh:$l,rayMesh:eu,rayModel:tu,lineSphere:ju,lineAABB:Hu,lineOBB:Vu,linePlane:iu,lineTriangle:nu,sphereWithSphere:oh,sphereAABB:ah,sphereOBB:sh,spherePlane:ih,sphereFrustum:nh,sphereFrustumAccurate:rh,sphereCapsule:ch,aabbWithAABB:Wu,aabbWithOBB:gl,aabbPlane:Ju,aabbFrustum:$u,aabbFrustumAccurate:o,obbWithOBB:ba,obbPlane:eh,obbFrustum:th,obbFrustumAccurate:Sa,obbPoint:function(e,t){return ce.subtract(uh,t,e.center),ce.transformMat3(uh,uh,pr.transpose(hh,e.orientation)),t=uh,e=e.halfExtents,Math.abs(t.x)<e.x&&Math.abs(t.y)<e.y&&Math.abs(t.z)<e.z},obbCapsule:Oa,capsuleWithCapsule:lh,resolve:function(e,t,i){void 0===i&&(i=null);var n=e._type,r=t._type,o=this[n|r];return n<r?o(e,t,i):o(t,e,i)}});Ch[_o.SHAPE_RAY|_o.SHAPE_SPHERE]=Ql,Ch[_o.SHAPE_RAY|_o.SHAPE_AABB]=kl,Ch[_o.SHAPE_RAY|_o.SHAPE_OBB]=ku,Ch[_o.SHAPE_RAY|_o.SHAPE_PLANE]=zl,Ch[_o.SHAPE_RAY|_o.SHAPE_TRIANGLE]=Ul,Ch[_o.SHAPE_RAY|_o.SHAPE_CAPSULE]=Jl,Ch[_o.SHAPE_LINE|_o.SHAPE_SPHERE]=ju,Ch[_o.SHAPE_LINE|_o.SHAPE_AABB]=Hu,Ch[_o.SHAPE_LINE|_o.SHAPE_OBB]=Vu,Ch[_o.SHAPE_LINE|_o.SHAPE_PLANE]=iu,Ch[_o.SHAPE_LINE|_o.SHAPE_TRIANGLE]=nu,Ch[_o.SHAPE_SPHERE]=oh,Ch[_o.SHAPE_SPHERE|_o.SHAPE_AABB]=ah,Ch[_o.SHAPE_SPHERE|_o.SHAPE_OBB]=sh,Ch[_o.SHAPE_SPHERE|_o.SHAPE_PLANE]=ih,Ch[_o.SHAPE_SPHERE|_o.SHAPE_FRUSTUM]=nh,Ch[_o.SHAPE_SPHERE|_o.SHAPE_FRUSTUM_ACCURATE]=rh,Ch[_o.SHAPE_SPHERE|_o.SHAPE_CAPSULE]=ch,Ch[_o.SHAPE_AABB]=Wu,Ch[_o.SHAPE_AABB|_o.SHAPE_OBB]=gl,Ch[_o.SHAPE_AABB|_o.SHAPE_PLANE]=Ju,Ch[_o.SHAPE_AABB|_o.SHAPE_FRUSTUM]=$u,Ch[_o.SHAPE_AABB|_o.SHAPE_FRUSTUM_ACCURATE]=o,Ch[_o.SHAPE_OBB]=ba,Ch[_o.SHAPE_OBB|_o.SHAPE_PLANE]=eh,Ch[_o.SHAPE_OBB|_o.SHAPE_FRUSTUM]=th,Ch[_o.SHAPE_OBB|_o.SHAPE_FRUSTUM_ACCURATE]=Sa,Ch[_o.SHAPE_OBB|_o.SHAPE_CAPSULE]=Oa,Ch[_o.SHAPE_CAPSULE]=lh,In(n.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Ee(Ch,"intersect",[{name:"line_quad"}]);var wh,Ah=new ce(0,0,0),Ph=new ce(0,0,0),Ih=j.mat4(),Rh=j.v4(),Dh=(Nh.create=function(e,t,i,n){return new Nh(e,t,i,n)},Nh.clone=function(e){return new Nh(e.n.x,e.n.y,e.n.z,e.d)},Nh.copy=function(e,t){return ce.copy(e.n,t.n),e.d=t.d,e},Nh.fromPoints=function(e,t,i,n){return ce.subtract(Ah,i,t),ce.subtract(Ph,n,t),ce.normalize(e.n,ce.cross(e.n,Ah,Ph)),e.d=ce.dot(e.n,t),e},Nh.set=function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e},Nh.fromNormalAndPoint=function(e,t,i){return ce.copy(e.n,t),e.d=ce.dot(t,i),e},Nh.normalize=function(e,t){var i=t.n.length();return ce.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e},Nh.prototype.transform=function(e){B.invert(Ih,e),B.transpose(Ih,Ih),Fr.set(Rh,this.n.x,this.n.y,this.n.z,this.d),Fr.transformMat4(Rh,Rh,Ih),ce.set(this.n,Rh.x,Rh.y,Rh.z),this.d=Rh.w},e(Nh,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),Nh),Oh=(Mh.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},Mh);function Mh(e,t,i){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<t)}function Nh(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=1),void 0===i&&(i=0),void 0===n&&(n=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=_o.SHAPE_PLANE,this.n=new ce(e,t,i),this.d=n}(a=wh=wh||{})[a.UINT32=0]="UINT32",a[a.FLOAT32=1]="FLOAT32",a[a.NEVER=2]="NEVER";(ls=Fh.prototype).alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t,i=this._freeLists[e];if(i.length)return t=i[i.length-1],i.length--,(e<<this._entryBits)+t+this._poolFlag}for(var n=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(n,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(n,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(n),(e<<this._entryBits)+this._poolFlag},ls.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,e=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][e]},ls.getTypedArray=function(e,t){var i=(this._chunkMask&e)>>this._entryBits,e=this._entryMask&e,i=(this._dataType[t]===wh.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][e],e=this._dataMembers[t];return i.subarray(t,t+e)},ls.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,e=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][e].fill(0),this._freeLists[t].push(e)};var Lh,Bh,_s=Fh;function Fh(e,t,i,n,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Oh(e,r,this._stride);var o,a,s,c;wh.NEVER;for(c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==wh.FLOAT32?s||o!==wh.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}(s=Lh=Lh||{})[s.NODE=0]="NODE",s[s.PASS=1]="PASS",s[s.AABB=2]="AABB",(gl=Bh=Bh||{})[gl.DIRTY_FLAG=0]="DIRTY_FLAG",gl[gl.LAYER=1]="LAYER",gl[gl.WORLD_SCALE=2]="WORLD_SCALE",gl[gl.WORLD_POSITION=5]="WORLD_POSITION",gl[gl.WORLD_ROTATION=8]="WORLD_ROTATION",gl[gl.WORLD_MATRIX=12]="WORLD_MATRIX",gl[gl.LOCAL_SCALE=28]="LOCAL_SCALE",gl[gl.LOCAL_POSITION=31]="LOCAL_POSITION",gl[gl.LOCAL_ROTATION=34]="LOCAL_ROTATION",gl[gl.COUNT=38]="COUNT";(o={})[Bh.DIRTY_FLAG]=wh.UINT32,o[Bh.LAYER]=wh.UINT32,o[Bh.WORLD_SCALE]=wh.FLOAT32,o[Bh.WORLD_POSITION]=wh.FLOAT32,o[Bh.WORLD_ROTATION]=wh.FLOAT32,o[Bh.WORLD_MATRIX]=wh.FLOAT32,o[Bh.LOCAL_SCALE]=wh.FLOAT32,o[Bh.LOCAL_POSITION]=wh.FLOAT32,o[Bh.LOCAL_ROTATION]=wh.FLOAT32,o[Bh.COUNT]=wh.NEVER;var zh,ba=o,Oa=((Sa={})[Bh.DIRTY_FLAG]=Bh.LAYER-Bh.DIRTY_FLAG,Sa[Bh.LAYER]=Bh.WORLD_SCALE-Bh.LAYER,Sa[Bh.WORLD_SCALE]=Bh.WORLD_POSITION-Bh.WORLD_SCALE,Sa[Bh.WORLD_POSITION]=Bh.WORLD_ROTATION-Bh.WORLD_POSITION,Sa[Bh.WORLD_ROTATION]=Bh.WORLD_MATRIX-Bh.WORLD_ROTATION,Sa[Bh.WORLD_MATRIX]=Bh.LOCAL_SCALE-Bh.WORLD_MATRIX,Sa[Bh.LOCAL_SCALE]=Bh.LOCAL_POSITION-Bh.LOCAL_SCALE,Sa[Bh.LOCAL_POSITION]=Bh.LOCAL_ROTATION-Bh.LOCAL_POSITION,Sa[Bh.LOCAL_ROTATION]=Bh.COUNT-Bh.LOCAL_ROTATION,Sa[Bh.COUNT]=1,Sa),a=new _s(Lh.NODE,ba,Oa,Bh);(ls=zh=zh||{})[ls.PRIORITY=0]="PRIORITY",ls[ls.STAGE=1]="STAGE",ls[ls.PHASE=2]="PHASE",ls[ls.PRIMITIVE=3]="PRIMITIVE",ls[ls.BATCHING_SCHEME=4]="BATCHING_SCHEME",ls[ls.DYNAMIC_STATE=5]="DYNAMIC_STATE",ls[ls.HASH=6]="HASH",ls[ls.COUNT=7]="COUNT";function Uh(e,t,i){Wh.m00=Math.abs(i.m00),Wh.m01=Math.abs(i.m01),Wh.m02=Math.abs(i.m02),Wh.m03=Math.abs(i.m04),Wh.m04=Math.abs(i.m05),Wh.m05=Math.abs(i.m06),Wh.m06=Math.abs(i.m08),Wh.m07=Math.abs(i.m09),Wh.m08=Math.abs(i.m10),ce.transformMat3(e,t,Wh)}(s={})[zh.PRIORITY]=wh.UINT32,s[zh.STAGE]=wh.UINT32,s[zh.PHASE]=wh.UINT32,s[zh.PRIMITIVE]=wh.UINT32,s[zh.BATCHING_SCHEME]=wh.UINT32,s[zh.DYNAMIC_STATE]=wh.UINT32,s[zh.HASH]=wh.UINT32,s[zh.COUNT]=wh.NEVER;var kh,gl=s,Sa=((o={})[zh.PRIORITY]=zh.STAGE-zh.PRIORITY,o[zh.STAGE]=zh.PHASE-zh.STAGE,o[zh.PHASE]=zh.PRIMITIVE-zh.PHASE,o[zh.PRIMITIVE]=zh.BATCHING_SCHEME-zh.PRIMITIVE,o[zh.BATCHING_SCHEME]=zh.DYNAMIC_STATE-zh.BATCHING_SCHEME,o[zh.DYNAMIC_STATE]=zh.HASH-zh.DYNAMIC_STATE,o[zh.HASH]=zh.COUNT-zh.HASH,o[zh.COUNT]=1,o),ba=new _s(Lh.PASS,gl,Sa,zh),s=((Oa=kh=kh||{})[Oa.CENTER=0]="CENTER",Oa[Oa.HALFEXTENTS=3]="HALFEXTENTS",Oa[Oa.COUNT=6]="COUNT",(ls={})[kh.CENTER]=wh.FLOAT32,ls[kh.HALFEXTENTS]=wh.FLOAT32,ls[kh.COUNT]=wh.NEVER,ls),gl=((o={})[kh.CENTER]=kh.HALFEXTENTS-kh.CENTER,o[kh.HALFEXTENTS]=kh.COUNT-kh.HALFEXTENTS,o[kh.COUNT]=1,o),Sa=new _s(Lh.AABB,s,gl,kh),Gh=new ce,Hh=new ce,Vh=new ce,jh=new ce,Wh=new pr,qh=($h.create=function(e,t,i,n,r,o){return new $h(e,t,i,n,r,o)},$h.clone=function(e){return new $h(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},$h.copy=function(e,t){return ce.copy(e.center,t.center),ce.copy(e.halfExtents,t.halfExtents),e},$h.fromPoints=function(e,t,i){return ce.add(Gh,i,t),ce.subtract(Hh,i,t),ce.multiplyScalar(e.center,Gh,.5),ce.multiplyScalar(e.halfExtents,Hh,.5),e},$h.set=function(e,t,i,n,r,o,a){return e.center.set(t,i,n),e.halfExtents.set(r,o,a),e},$h.merge=function(e,t,i){return ce.subtract(Gh,t.center,t.halfExtents),ce.subtract(Hh,i.center,i.halfExtents),ce.add(Vh,t.center,t.halfExtents),ce.add(jh,i.center,i.halfExtents),ce.max(jh,Vh,jh),ce.min(Vh,Gh,Hh),$h.fromPoints(e,Vh,jh)},$h.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},$h.transform=function(e,t,i){return ce.transformMat4(e.center,t.center,i),Uh(e.halfExtents,t.halfExtents,i),e},(Oa=$h.prototype).getBoundary=function(e,t){ce.subtract(e,this.center,this.halfExtents),ce.add(t,this.center,this.halfExtents)},Oa.transform=function(e,t,i,n,r){ce.transformMat4(r.center,this.center,e),Uh(r.halfExtents,this.halfExtents,e)},Oa.clone=function(){return $h.clone(this)},Oa.copy=function(e){return $h.copy(this,e)},Oa.mergePoint=function(e){this.getBoundary(Gh,Hh),e.x<Gh.x&&(Gh.x=e.x),e.y<Gh.y&&(Gh.y=e.y),e.z<Gh.z&&(Gh.z=e.z),e.x>Hh.x&&(Hh.x=e.x),e.y>Hh.y&&(Hh.y=e.y),e.z>Hh.z&&(Hh.z=e.z),ce.add(Vh,Gh,Hh),this.center.set(ce.multiplyScalar(Vh,Vh,.5)),this.halfExtents.set(Hh.x-Vh.x,Hh.y-Vh.y,Hh.z-Vh.z)},Oa.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},Oa.mergeFrustum=function(e){return this.mergePoints(e.vertices)},e($h,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),$h),Xh=new ce,Yh=new ce,Kh=new pr,o=(Jh.create=function(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f){return new Jh(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f)},Jh.clone=function(e){return new Jh(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},Jh.copy=function(e,t){return ce.copy(e.center,t.center),ce.copy(e.halfExtents,t.halfExtents),pr.copy(e.orientation,t.orientation),e},Jh.fromPoints=function(e,t,i){return ce.multiplyScalar(e.center,ce.add(Xh,t,i),.5),ce.multiplyScalar(e.halfExtents,ce.subtract(Yh,i,t),.5),pr.identity(e.orientation),e},Jh.set=function(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f,d){return ce.set(e.center,t,i,n),ce.set(e.halfExtents,r,o,a),pr.set(e.orientation,s,c,l,u,h,p,_,f,d),e},(ls=Jh.prototype).getBoundary=function(e,t){var i,n,r;i=Xh,n=this.halfExtents,r=this.orientation,Kh.m00=Math.abs(r.m00),Kh.m01=Math.abs(r.m01),Kh.m02=Math.abs(r.m02),Kh.m03=Math.abs(r.m03),Kh.m04=Math.abs(r.m04),Kh.m05=Math.abs(r.m05),Kh.m06=Math.abs(r.m06),Kh.m07=Math.abs(r.m07),Kh.m08=Math.abs(r.m08),ce.transformMat3(i,n,Kh),ce.subtract(e,this.center,Xh),ce.add(t,this.center,Xh)},ls.transform=function(e,t,i,n,r){ce.transformMat4(r.center,this.center,e),pr.fromQuat(r.orientation,i),ce.multiply(r.halfExtents,this.halfExtents,n)},ls.translateAndRotate=function(e,t,i){ce.transformMat4(i.center,this.center,e),pr.fromQuat(i.orientation,t)},ls.setScale=function(e,t){ce.multiply(t.halfExtents,this.halfExtents,e)},e(Jh,[{key:"type",get:function(){return this._type}}]),Jh),s=((_s=Zh.prototype).transform=function(e,t,i,n,r){var o=Jn(n),o=(r.radius=this.radius*Math.abs(o),(this.halfHeight+this.radius)*Math.abs(n.y)-r.radius);r.halfHeight=o=o<0?0:o,ce.transformMat4(r.center,this.center,e),gr.multiply(r.rotation,this.rotation,i),r.updateCache()},_s.updateCache=function(){this.updateLocalCenter(),ce.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),ce.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},_s.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},e(Zh,[{key:"type",get:function(){return this._type}}]),Zh),Qh=new Array(8);function Zh(e,t,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===i&&(i=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=_o.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=i,this.center=new ce,this.rotation=new gr,this.ellipseCenter0=new ce(0,t,0),this.ellipseCenter1=new ce(0,-t,0),this.updateCache()}function Jh(e,t,i,n,r,o,a,s,c,l,u,h,p,_,f){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===p&&(p=0),void 0===_&&(_=0),void 0===f&&(f=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=_o.SHAPE_OBB,this.center=new ce(e,t,i),this.halfExtents=new ce(n,r,o),this.orientation=new pr(a,s,c,l,u,h,p,_,f)}function $h(e,t,i,n,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=_o.SHAPE_AABB,this.center=new ce(e,t,i),this.halfExtents=new ce(n,r,o)}Qh[0]=new ce(1,1,1),Qh[1]=new ce(-1,1,1),Qh[2]=new ce(-1,-1,1),Qh[3]=new ce(1,-1,1),Qh[4]=new ce(1,1,-1),Qh[5]=new ce(-1,1,-1),Qh[6]=new ce(-1,-1,-1),Qh[7]=new ce(1,-1,-1);var ep,tp,ip=new ce,np=new ce,rp=new ce,op=(ap.createFromAABB=function(e,t){var i=new ce,n=new ce;return ce.subtract(i,t.center,t.halfExtents),ce.add(n,t.center,t.halfExtents),e.vertices[0].set(i.x,n.y,i.z),e.vertices[1].set(n.x,n.y,i.z),e.vertices[2].set(n.x,i.y,i.z),e.vertices[3].set(i.x,i.y,i.z),e.vertices[4].set(i.x,n.y,n.z),e.vertices[5].set(n.x,n.y,n.z),e.vertices[6].set(n.x,i.y,n.z),e.vertices[7].set(i.x,i.y,n.z),e._type===_o.SHAPE_FRUSTUM_ACCURATE&&e.updatePlanes(),e},ap.split=function(e,t,i,n,r){var o=Math.tan(.5*t.fov),t=o*t.aspect,n=(ip.set(n*t,n*o,n),np.set(r*t,r*o,r),e.vertices);return rp.set(ip.x,ip.y,ip.z),ce.transformMat4(n[0],rp,i),rp.set(-ip.x,ip.y,ip.z),ce.transformMat4(n[1],rp,i),rp.set(-ip.x,-ip.y,ip.z),ce.transformMat4(n[2],rp,i),rp.set(ip.x,-ip.y,ip.z),ce.transformMat4(n[3],rp,i),rp.set(np.x,np.y,np.z),ce.transformMat4(n[4],rp,i),rp.set(-np.x,np.y,np.z),ce.transformMat4(n[5],rp,i),rp.set(-np.x,-np.y,np.z),ce.transformMat4(n[6],rp,i),rp.set(np.x,-np.y,np.z),ce.transformMat4(n[7],rp,i),e.updatePlanes(),e},ap.create=function(){return new ap},ap.clone=function(e){return ap.copy(new ap,e)},ap.copy=function(e,t){e._type=t._type;for(var i=0;i<6;++i)Dh.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)ce.copy(e.vertices[n],t.vertices[n]);return e},(gl=ap.prototype).update=function(e,t){if(ce.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),ce.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),ce.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),ce.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),ce.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),ce.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===_o.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();ce.multiplyScalar(n.n,n.n,r),n.d*=r}for(var o=0;o<8;o++)ce.transformMat4(this.vertices[o],Qh[o],t)}},gl.transform=function(e){if(this._type===_o.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)ce.transformMat4(this.vertices[t],this.vertices[t],e);Dh.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Dh.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Dh.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Dh.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Dh.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Dh.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},gl.updatePlanes=function(){Dh.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Dh.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Dh.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Dh.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Dh.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Dh.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},e(ap,[{key:"accurate",set:function(e){this._type=e?_o.SHAPE_FRUSTUM_ACCURATE:_o.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),ap);function ap(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=_o.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Dh.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new ce}op.createOrtho=function(e,t,i,n,r,o){t/=2,i/=2;ce.set(rp,t,i,-n),ce.transformMat4(e.vertices[0],rp,o),ce.set(rp,-t,i,-n),ce.transformMat4(e.vertices[1],rp,o),ce.set(rp,-t,-i,-n),ce.transformMat4(e.vertices[2],rp,o),ce.set(rp,t,-i,-n),ce.transformMat4(e.vertices[3],rp,o),ce.set(rp,t,i,-r),ce.transformMat4(e.vertices[4],rp,o),ce.set(rp,-t,i,-r),ce.transformMat4(e.vertices[5],rp,o),ce.set(rp,-t,-i,-r),ce.transformMat4(e.vertices[6],rp,o),ce.set(rp,t,-i,-r),ce.transformMat4(e.vertices[7],rp,o),Dh.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Dh.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Dh.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Dh.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Dh.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Dh.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},(Oa=ep=ep||{})[Oa.Default=0]="Default",Oa[Oa.Normal=1]="Normal",Oa[Oa.Loop=2]="Loop",Oa[Oa.ShouldWrap=4]="ShouldWrap",Oa[Oa.Clamp=8]="Clamp",Oa[Oa.PingPong=22]="PingPong",Oa[Oa.Reverse=36]="Reverse",(ls=tp=tp||{})[ls.Default=ep.Default]="Default",ls[ls.Normal=ep.Normal]="Normal",ls[ls.Reverse=ep.Reverse]="Reverse",ls[ls.Loop=ep.Loop]="Loop",ls[ls.LoopReverse=ep.Loop|ep.Reverse]="LoopReverse",ls[ls.PingPong=ep.PingPong]="PingPong",ls[ls.PingPongReverse=ep.PingPong|ep.Reverse]="PingPongReverse",Lt(tp);cp.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex};var sp=cp;function cp(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}function lp(e,t,i){void 0===i&&(i=1e-6);for(var n=0,r=e.length-1,o=r>>>1;n<=r;o=n+r>>>1){var a=e[o];if(t+i<a)r=o-1;else{if(!(a<t-i))return o;n=o+1}}return~n}function up(){}function hp(){return up}_s=pp(function(){});function pp(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function _p(r){return function(n){return function(e){var t,i;t=r,i=n,(e=dp(e))&&(e=mp(e,"proto"),mp(e,"editor")[t]=i)}}}var fp="__ccclassCache__";function dp(e){return mp(e,fp)}function mp(e,t){return e[t]||(e[t]={})}var f=pp(function(e,t){var i=gt.getSuper(e),t={name:t,extends:i=i===Object?null:i,ctor:e},i=e[fp];return i&&((i=i.proto)&&gt.mixin(t,i),e[fp]=void 0),Ti(t)}),gl=_p("requireComponent"),Oa=_p("executionOrder"),ls=_s;function gp(e,t,i){var l=null;function n(e,t,i){var n,r,o,a,s,c=dp(e.constructor);c&&(n=mp(c,"proto"),n=mp(n,"properties"),e=e.constructor,n=n,t=t,r=l,c=c,a=(i=i)&&(i.get||i.set),r&&(o=di(r,a)),s=n[t],s=gt.mixin(s||{},o||r||{}),a?(i.get&&(s.get=i.get),i.set&&(s.set=i.set)):i?i.initializer&&(s.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(i.initializer)):(o=c.default||(c.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e))).hasOwnProperty(t)&&(s.default=o[t]),n[t]=s)}return void 0===e?gp({type:void 0}):void 0===t?(l=e,n):void n(e,t,i)}function d(e,t,i){return gp(Sp({}))(e,t,i)}var vp=Symbol("cc:SerializationMetadata");function yp(e){return gp(Sp({formerlySerializedAs:e}))}function xp(e,t,i){return gp({editorOnly:!0})(e,t,i)}function Sp(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var bp=up,Tp=_s,Ep=hp,c=hp,Cp=hp,wp=hp,Ap=up,Pp=hp,Ip=up,Rp=hp,u=hp,Dp=hp,Op=hp,Mp=hp,h=hp,Np=up,m=hp,Lp=up,Bp=up,Fp=up,g=v(ai),zp=v(ci),Up=v(li),kp=v(ui);function v(e){return gp({type:e})}function Gp(e,t,i){return gp({__noImplicit:!0,override:!0})(e,t,i)}var Hp,Vp,jp,Wp,qp,Xp=f("cc.KeyframeCurve")((Xp=Symbol.iterator,(Qp=Yp.prototype)[Xp]=function(){var t=this,i=0;return{next:function(){if(i>=t._times.length)return{done:!0,value:void 0};var e=[t._times[i],t._values[i]];return++i,{done:!1,value:e}}}},Qp.keyframes=function(){return this},Qp.times=function(){return this._times},Qp.values=function(){return this._values},Qp.getKeyframeTime=function(e){return this._times[e]},Qp.getKeyframeValue=function(e){return this._values[e]},Qp.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},Qp.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},Qp.indexOfKeyframe=function(e){return lp(this._times,e)},Qp.updateTime=function(e,t){var i=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,i)},Qp.assignSorted=function(e,t){void 0!==t?this.setKeyframes(e.slice(),t.slice()):(t=Array.from(e),this.setKeyframes(t.map(function(e){return e[0]}),t.map(function(e){return e[1]})))},Qp.clear=function(){this._times.length=0,this._values.length=0},Qp.searchKeyframe=function(e){return lp(this._times,e)},Qp.setKeyframes=function(e,t){e.length,t.length,e.every(function(e,t,i){return 0===t||e>i[t-1]||Bn(e,i[t-1],1e-6)}),this._times=e,this._values=t},Qp._insertNewKeyframe=function(e,t){var i=this._times,n=this._values,r=i.length,o=lp(i,e);if(0<=o)return o;o=~o;return 0==o?(i.unshift(e),n.unshift(t)):o===r?(i.push(e),n.push(t)):(i.splice(o-1,0,e),n.splice(o-1,0,t)),o},e(Yp,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),Hp=i((Xp=Yp).prototype,"_times",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vp=i(Xp.prototype,"_values",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qp=Xp))||Qp;function Yp(){_(this,"_times",Hp,this),_(this,"_values",Vp,this)}function Kp(e){return-1e-9<e&&e<1e-9}(Qp=jp=jp||Rre("RealInterpolationMode",{}))[Qp.LINEAR=0]="LINEAR",Qp[Qp.CONSTANT=1]="CONSTANT",Qp[Qp.CUBIC=2]="CUBIC",(Qp=Wp=Wp||Rre("ExtrapolationMode",{}))[Qp.LINEAR=0]="LINEAR",Qp[Qp.CLAMP=1]="CLAMP",Qp[Qp.LOOP=2]="LOOP",Qp[Qp.PING_PONG=3]="PING_PONG",(Qp=qp=qp||Rre("TangentWeightMode",{}))[Qp.NONE=0]="NONE",Qp[Qp.LEFT=1]="LEFT",Qp[Qp.RIGHT=2]="RIGHT",Qp[Qp.BOTH=3]="BOTH";var Qp=Object.freeze({__proto__:null,uniquelyReferenced:bp,ccclass:f,property:gp,requireComponent:gl,executionOrder:Oa,disallowMultiple:ls,allowReplicated:function(e){Ti.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:Tp,menu:Ep,playOnFocus:_s,inspector:c,icon:Cp,help:wp,type:v,integer:g,float:zp,boolean:Up,string:kp}),Zp=(Rre("_decorator",Qp),(Cp=$p.prototype).add=function(e,t){return e in this._map||this._count++,this._map[e]=t},Cp.get=function(e){return this._map[e]},Cp.has=function(e){return e in this._map},Cp.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},Cp.clear=function(){0!==this._count&&(this._map=gt.createMap(!0),this._count=0)},Cp.forEach=function(e){for(var t in this._map)e(this._map[t],t)},Cp.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},Cp.destroy=function(){this._map=null},e($p,[{key:"count",get:function(){return this._count}}]),$p),Up=((g=Jp.prototype).insert=function(e,t){return t>this.pipes.length?J(4921):this.pipes.splice(t,0,e),this},g.append=function(e){return this.pipes.push(e),this},g.remove=function(e){return this.pipes.splice(e,1),this},g.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var i=0,n=t.length;i<n;){var r=(0,t[i])(e);if(r)return e.isFinish=!0,r;++i!==n&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},g.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},g._flow=function(t,i){var n=this;(0,this.pipes[t])(i,function(e){e?(i.isFinish=!0,i.dispatch("complete",e)):++t<n.pipes.length?(i.input=i.output,i.output=null,n._flow(t,i)):(i.isFinish=!0,i.dispatch("complete",e,i.output))})},Jp);function Jp(e,t){this.id=Jp._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var i=0,n=t.length;i<n;i++)this.pipes.push(t[i])}function $p(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=gt.createMap(!0),this._count=0)}function e_(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}Up._pipelineId=0,(Cp=e_.prototype).add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},Cp.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},Cp.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},Cp.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},Cp.clear=function(){this._weakMap=gt.createMap(!0)},Cp.forEach=function(e){for(var t in this._weakMap){var i=this.get(t);i&&e(i,t)}},Cp.find=function(e){for(var t in this._weakMap){var i=this.get(t);if(i&&e(i,t))return this._weakMap[t].deref()}return null},Cp.destroy=function(){this._weakMap={}},e(e_,[{key:"count",get:function(){return Object.values(this._weakMap).filter(function(e){return e.deref()}).length}}]);var t_,i_=new Zp,n_=new Zp,r_=new Zp,o_=new Zp,a_=new Up("normal load",[]),s_=new Up("fetch",[]),c_=new Up("transform url",[]);(g=t_=t_||{}).UUID="uuid",g.PATH="path",g.DIR="dir",g.URL="url",g.SCENE="scene";var l_,u_={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}},h_=((Cp=l_=l_||{}).RESOURCES="resources",Cp.MAIN="main",Cp.START_SCENE="start-scene",p_.create=function(e){var t;return 0!==p_._deadPool.length?(t=p_._deadPool.pop()).set(e):t=new p_(e),t},(g=p_.prototype).set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},g.dispatch=function(e,t,i,n,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,i);break;case"progress":this.onProgress&&this.onProgress(t,i,n,r);break;case"error":this.onError&&this.onError(t,i,n,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,i,n,r)}},g.recycle=function(){p_._deadPool.length!==p_.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,p_._deadPool.push(this))},p_);function p_(e){this.id=p_._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}h_.MAX_DEAD_NUM=500,h_._taskId=0,h_._deadPool=[];var __="0123456789abcdef".split(""),Cp=["","","",""],f_=Cp.concat(Cp,"-",Cp,"-",Cp,"-",Cp,"-",Cp,Cp,Cp),d_=f_.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function m_(e){var t=e.split("@")[0];if(22!==t.length)return e;f_[0]=e[0],f_[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=Vt[e.charCodeAt(i)],o=Vt[e.charCodeAt(i+1)];f_[d_[n++]]=__[r>>2],f_[d_[n++]]=__[(3&r)<<2|o>>4],f_[d_[n++]]=__[15&o]}return e.replace(t,f_.join(""))}var g_=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function v_(e){e=g_.exec(e);return e?e[1]:""}function y_(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var i=o_.find(function(e){return!!e.getAssetInfo(t)});return i&&(e.bundle=i.name),b_(t,e)}function x_(e){return!!e&&(e instanceof j.SceneAsset||e instanceof j.Scene)}function S_(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function b_(e,t){var t=h_.create({input:e,options:t}),i=[];try{for(var n,r=ge(c_.sync(t));!(n=r()).done;){var o=n.value,a=o.url;o.recycle(),i.push(a)}}catch(e){for(var s,c=ge(t.output);!(s=c()).done;)s.value.recycle();tt(e.message,e.stack)}return t.recycle(),1<i.length?i:i[0]}var T_,E_,C_,w_=Object.freeze({__proto__:null,getUuidFromURL:v_,getUrlWithUuid:y_,isScene:x_,normalize:S_,transform:b_,decodeUuid:m_}),A_=((g=D_.prototype).registerGCObject=function(e){return e},g.unregisterGCObject=function(){},g.init=function(){},g.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},g.destroy=function(){},new D_),Cp=f("cc.GCObject")((l(R_,C_=Pi),(Cp=R_.prototype).equals=function(e){return!!e&&e===this},Cp.destroy=function(){return A_.unregisterGCObject(this),C_.prototype.destroy.call(this)},g=R_))||g,P_=Rre("Asset",f("cc.Asset")((l(I_,E_=Gi(Cp)),I_.deserialize=function(e){return j.deserialize(e)},(g=I_.prototype).toString=function(){return this.nativeUrl},g.serialize=function(){},g._setRawAsset=function(e,t){this._native=!1!==(t=void 0===t?!0:t)?e||"":"/"+e},g.addRef=function(){return this._ref++,this},g.decRef=function(e){return void 0===e&&(e=!0),0<this._ref&&this._ref--,e&&j.assetManager._releaseManager.tryRelease(this),this},g.onLoaded=function(){},g.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},g.validate=function(){return!0},g.destroy=function(){return fe(oe(12101,this._uuid)),E_.prototype.destroy.call(this)},e(I_,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=y_(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=y_(this._uuid,{__nativeName__:e,nativeExt:nn(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),T_=i((Cp=I_).prototype,"_native",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),i(Cp.prototype,"_nativeAsset",[gp],Object.getOwnPropertyDescriptor(Cp.prototype,"_nativeAsset"),Cp.prototype),g=Cp))||g);function I_(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=E_.call.apply(E_,[this].concat(i))||this).loaded=!0,_(e,"_native",T_,p(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(p(e),"_uuid",{value:"",writable:!0}),e}function R_(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return e=C_.call.apply(C_,[this].concat(i))||this,A_.registerGCObject(p(e))||p(e)}function D_(){this._finalizationRegistry=null}P_.prototype.createNode=null,j.Asset=P_;var O_,g=Rre("Script",f("cc.Script")((l(M_,O_=P_),Cp=M_))||Cp);function M_(){return O_.apply(this,arguments)||this}j._Script=g;var N_,Cp=Rre("JavaScript",f("cc.JavaScript")((l(L_,N_=g),Cp=L_))||Cp);function L_(){return N_.apply(this,arguments)||this}j._JavaScript=Cp;var B_,F_,z_,U_,Cp=Rre("TypeScript",f("cc.TypeScript")((l(k_,U_=g),Cp=k_))||Cp);function k_(){return U_.apply(this,arguments)||this}j._TypeScript=Cp;var G_,H_,V_=new Ce("Comp"),j_=Pi.Flags.IsOnLoadCalled,W_=Rre("Component",(Cp=f("cc.Component"),kd=Rp(),g=v(g),y=u(),Cp((l(q_,H_=Pi),(Cp=q_.prototype)._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},Cp.addComponent=function(e){return this.node.addComponent(e)},Cp.getComponent=function(e){return this.node.getComponent(e)},Cp.getComponents=function(e){return this.node.getComponents(e)},Cp.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},Cp.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},Cp.destroy=function(){return!!H_.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&j.director._compScheduler.disableComp(this),!0)},Cp._onPreDestroy=function(){this.unscheduleAllCallbacks(),j.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},Cp._instantiate=function(e){return(e=e||j.instantiate._clone(this,this))&&(e.node=null),e},Cp.schedule=function(e,t,i,n){void 0===t&&(t=0),void 0===i&&(i=j.macro.REPEAT_FOREVER),void 0===n&&(n=0),re(e,1619),re(0<=(t=t||0),1620),i=Number.isNaN(i)?j.macro.REPEAT_FOREVER:i,n=n||0;var r=j.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,i,n,o)},Cp.scheduleOnce=function(e,t){this.schedule(e,0,0,t=void 0===t?0:t)},Cp.unschedule=function(e){e&&j.director.getScheduler().unschedule(e,this)},Cp.unscheduleAllCallbacks=function(){j.director.getScheduler().unscheduleAllForTarget(this)},e(q_,[{key:"name",get:function(){if(this._name)return this._name;var e=He(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){var t;this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)&&(t=j.director._compScheduler,e?t.enableComp(this):t.disableComp(this))}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&j_}}]),q_.system=null,i((Cp=q_).prototype,"__scriptAsset",[kd,g,y,Fp],Object.getOwnPropertyDescriptor(Cp.prototype,"__scriptAsset"),Cp.prototype),B_=i(Cp.prototype,"node",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F_=i(Cp.prototype,"_enabled",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),z_=i(Cp.prototype,"__prefab",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kd=Cp))||kd)),g=W_.prototype;function q_(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=H_.call.apply(H_,[this].concat(i))||this,"node",B_,p(e)),_(e,"_enabled",F_,p(e)),_(e,"__prefab",z_,p(e)),e._sceneGetter=null,e._id=V_.getNewId(),e}g.update=null,g.lateUpdate=null,g.__preload=null,g.onLoad=null,g.start=null,g.onEnable=null,g.onDisable=null,g.onDestroy=null,g.onFocusInEditor=null,g.onLostFocusInEditor=null,g.resetInEditor=null,g._getLocalBounds=null,g.onRestore=null,W_._requireComponent=null,W_._executionOrder=0,ze(W_,"_registerEditorProps",function(e,t){var i=t.requireComponent,i=(i&&(Array.isArray(i)&&(i=i.filter(Boolean)),e._requireComponent=i),t.executionOrder);i&&"number"==typeof i&&(e._executionOrder=i)}),j.Component=W_;var X_,Y_,K_=Rre("MissingScript",f("cc.MissingScript")(Cp=c()((l(Q_,Y_=W_),Q_.safeFindClass=function(e){var t=pt(e);if(t)return t;j.deserialize.reportMissingClass(e)},Q_.prototype.onLoad=function(){J(4600,this.node.name)},G_=i((y=Q_).prototype,"_$erialized",[d,xp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cp=y))||Cp)||Cp);function Q_(){var e;return _(e=Y_.call(this)||this,"_$erialized",G_,p(e)),e}j._MissingScript=K_;try{var Z_=K_.__values__;0!==Z_.length&&"_$erialized"===Z_[Z_.length-1]||(tt("The '_$erialized' prop in MissingScript is missing. Please contact jare."),tt("    Error props: ['"+Z_+"']"))}catch(co){tt("Error when checking MissingScript 5, "+co)}(kd=X_=X_||{})[kd.PORTRAIT=1]="PORTRAIT",kd[kd.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",kd[kd.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",kd[kd.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",kd[kd.LANDSCAPE=12]="LANDSCAPE",kd[kd.AUTO=13]="AUTO";var J_,$_={auto:X_.AUTO,landscape:X_.LANDSCAPE,portrait:X_.PORTRAIT},ef=((g=J_=J_||{})[g.Unknown=0]="Unknown",g[g.SubFrame=1]="SubFrame",g[g.BrowserWindow=2]="BrowserWindow",g[g.Fullscreen=3]="Fullscreen",l(of,tf=Ki),(c=of.prototype).init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=$_[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},c.requestFullScreen=function(){var n=this;return new Promise(function(t,i){n.isFullScreen?t():(n._cachedFrameSize=n.windowSize,n._doRequestFullScreen().then(function(){t()}).catch(function(){var e=n._getFullscreenTarget();e?e.addEventListener(n._touchEventName,function(){n._doRequestFullScreen().then(function(){t()}).catch(i)},{once:!0,capture:!0}):i(new Error("Cannot access fullscreen target"))}))})},c.exitFullScreen=function(){var n=this;return new Promise(function(e,t){var i=document[n._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then(function(){n.windowSize=n._cachedFrameSize,e()}).catch(t):(n.windowSize=n._cachedFrameSize,e())})},c._registerEvent=function(){var n=this;document.addEventListener(this._fn.fullscreenerror,function(){var e;null!=(e=n._onFullscreenError)&&e.call(n)}),window.addEventListener("resize",function(){n.handleResizeEvent&&n._resizeFrame()}),"function"==typeof window.matchMedia&&function e(){var t,i=window.devicePixelRatio;null!=(i=window.matchMedia("(resolution: "+i+"dppx)"))&&null!=(t=i.addEventListener)&&t.call(i,"change",function(){n.emit("window-resize"),e()},{once:!0})}(),window.addEventListener("orientationchange",function(){-1!==n._orientationChangeTimeoutId&&clearTimeout(n._orientationChangeTimeoutId),n._orientationChangeTimeoutId=setTimeout(function(){n.handleResizeEvent&&(n._updateFrameState(),n._resizeFrame(),n.emit("orientation-change"),n._orientationChangeTimeoutId=-1)},200)}),document.addEventListener(this._fn.fullscreenchange,function(){var e;null!=(e=n._onFullscreenChange)&&e.call(n),n.emit("fullscreen-change")})},c._convertToSizeInCssPixels=function(e){var e=e.clone(),t=this.devicePixelRatio;return e.width/=t,e.height/=t,e},c._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===J_.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var e=window.innerWidth,t=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=t+"px")}this._updateContainer()}},c._getFullscreenTarget=function(){var e=this._windowType;return e===J_.Fullscreen?document[this._fn.fullscreenElement]:e===J_.SubFrame?this._gameFrame:document.body},c._doRequestFullScreen=function(){var n=this;return new Promise(function(e,t){var i;n._supportFullScreen?(i=n._getFullscreenTarget())?(n._onFullscreenChange=void 0,n._onFullscreenError=void 0,i=i[n._fn.requestFullscreen](),window.Promise&&i instanceof Promise?i.then(e).catch(t):(n._onFullscreenChange=e,n._onFullscreenError=t)):t(new Error("Cannot access fullscreen target")):t(new Error("fullscreen is not supported"))})},c._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=Qi.isMobile&&(t&&e===X_.PORTRAIT||!t&&e===X_.LANDSCAPE)},c._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void J(9201);var e,t=j.view.getDesignResolutionSize(),i=this._gameFrame,n=i.clientWidth,i=i.clientHeight,r=t.width,t=t.height,o=n/r,a=i/t,s=this._gameContainer.style,n=o<a?(e=n,t*o):(e=r*a,i);s.width=e+"px",s.height=n+"px"}else{t=this._gameContainer.style;t.width="100%",t.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else J(9201)},e(of,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!=(e=window.devicePixelRatio)?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===J_.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):J(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new Hr(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){e!==this._resolutionScale&&(this._resolutionScale=e,null!=(e=this._cbToUpdateFrameBuffer)&&e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new Hr(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(J(9201),new Hr(0,0));var e,t;switch(this._windowType){case J_.SubFrame:return this._gameFrame?new Hr(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(J(9201),new Hr(0,0));case J_.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,t=this.isFrameRotated?t.clientWidth:t.clientHeight,new Hr(e,t);case J_.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,t=this.isFrameRotated?window.innerWidth:window.innerHeight,new Hr(e,t);default:J_.Unknown;return new Hr(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?J_.Fullscreen:this._gameFrame?this._exactFitScreen?J_.BrowserWindow:J_.SubFrame:(J(9201),J_.Unknown)}}]),new of);(y=rf.prototype)._init=function(e){ef.init(e,function(){var e,t=j.director;null!=(e=t.root)&&e.pipeline?t.root.pipeline.pipelineSceneData.shadingScale=ef.resolutionScale:J(1220)})},y.fullScreen=function(){return ef.isFullScreen},y.requestFullScreen=function(e,t,i){return 0<arguments.length&&J(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),ef.requestFullScreen().then(function(){null!=t&&t()}).catch(function(e){console.error(e),null!=i&&i()})},y.exitFullScreen=function(){return ef.exitFullScreen()},y.autoFullScreen=function(e,t){null!=(e=this.requestFullScreen(e,t))&&e.catch(function(){})},y.disableAutoFullScreen=function(){},e(rf,[{key:"devicePixelRatio",get:function(){return ef.devicePixelRatio}},{key:"windowSize",get:function(){return ef.windowSize},set:function(e){ef.windowSize=e}},{key:"resolution",get:function(){return ef.resolution}},{key:"supportsFullScreen",get:function(){return ef.supportFullScreen}}]);var tf,nf=Rre("screen",new rf);function rf(){}function of(){var e,t,i;(e=tf.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new Hr(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=X_.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null!=(t=e._gameCanvas)&&null!=(t=t.parentNode)&&t.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null!=(t=e._gameCanvas)&&null!=(t=t.parentNode)&&t.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var n=e._fnGroup,r=0;r<n.length;r++)if(i=n[r],void 0!==document[i[1]]){for(var o=0;o<i.length;o++)e._fn[n[0][o]]=i[o];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}j.screen=nf;var af=Rre("sys",{Feature:Xi,hasFeature:function(e){return Qi.hasFeature(e)},NetworkType:ji,Language:Vi,OS:Wi,Platform:qi,BrowserType:Hi,isNative:Qi.isNative,isBrowser:Qi.isBrowser,isMobile:Qi.isMobile,isLittleEndian:Qi.isLittleEndian,platform:Qi.platform,language:Qi.language,languageCode:Qi.nativeLanguage,os:Qi.os,osVersion:Qi.osVersion,osMainVersion:Qi.osMainVersion,browserType:Qi.browserType,browserVersion:Qi.browserVersion,windowPixelResolution:nf.windowSize,capabilities:{canvas:!0,opengl:!0,webp:Qi.hasFeature(Xi.WEBP),imageBitmap:Qi.hasFeature(Xi.IMAGE_BITMAP),touches:Qi.hasFeature(Xi.INPUT_TOUCH),mouse:Qi.hasFeature(Xi.EVENT_MOUSE),keyboard:Qi.hasFeature(Xi.EVENT_KEYBOARD),accelerometer:Qi.hasFeature(Xi.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return Qi.networkType},getBatteryLevel:function(){return Qi.getBatteryLevel()},garbageCollect:function(){Qi.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";H((e+="isMobile : "+this.isMobile+"\r\n")+("language : "+this.language+"\r\n")+("browserType : "+this.browserType+"\r\n")+("browserVersion : "+this.browserVersion+"\r\n")+("capabilities : "+JSON.stringify(this.capabilities)+"\r\n")+("os : "+this.os+"\r\n")+("osVersion : "+this.osVersion+"\r\n")+("platform : "+this.platform+"\r\n")+("Using "+(j.game.renderType===j.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n"))},openURL:function(e){Qi.openURL(e)},now:function(){return Qi.now()},restartVM:function(){Qi.restartJSVM()},getSafeAreaRect:function(){var e=j.view,t=ef.safeAreaEdge,i=ef.windowSize,n=new U(t.left,t.bottom),i=new U(i.width-t.right,i.height-t.top),t=(e._convertToUISpace(n),e._convertToUISpace(i),n.x),e=n.y,r=i.x-n.x,i=i.y-n.y;return new qr(t,e,r,i)}});try{var sf=af.localStorage=window.localStorage;sf.setItem("storage",""),sf.removeItem("storage"),sf=null}catch(sf){Cp=function(){J(5200)};af.localStorage={getItem:Cp,setItem:Cp,clear:Cp,removeItem:Cp}}af.__isWebIOS14OrIPadOS14Env=(af.os===Wi.IOS||af.os===Wi.OSX)&&Qi.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent),j.sys=af;var Z_=Rre("serializeTag",Symbol("[[Serialize]]")),cf=Rre("deserializeTag",Symbol("[[Deserialize]]")),lf=(e(uf,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),uf);function uf(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}function hf(e){return{chunks:e.chunks,document:e.document}}function pf(e){if(e.length<16)throw new ff(oe(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new ff(oe(13100));var i=t.getUint32(4,!0);if(1!==i)throw new ff(oe(13101,i));if(t.getUint32(8,!0)!==t.byteLength)throw new ff(oe(13102));var n=12,i=t.getUint32(n,!0),r=(n+=4,new Uint8Array(t.buffer,n+t.byteOffset,i));n+=i;var o,i=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(oe(13104))}(r);try{o=JSON.parse(i)}catch(e){throw new ff(e)}for(var a=[];n<t.byteLength;){n%8!=0&&(n+=8-n%8);var s=t.getUint32(n,!0);n+=4,a.push(new Uint8Array(t.buffer,n+t.byteOffset,s)),n+=s}if(n!==t.byteLength)throw new ff(oe(13102));return new lf(o,a)}l(df,_f=de(Error));var _f,ff=df;function df(){return _f.apply(this,arguments)||this}function mf(e,t,i,n,r){t instanceof j.ValueType?(r||e.push("if(prop){"),t=He(t),e.push("s._deserializeFastDefinedObject(o"+i+",prop,"+t+");"),r||e.push("}else o"+i+"=null;")):e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+n+");\n} else {\n    o"+i+"=null;\n}\n")}function gf(){this._viewOrPaddings=[],this._length=0}(kd=gf.prototype).alignAs=function(e){if(0!==e){var t=this._length%e;if(0!=t)return this._viewOrPaddings.push(e=e-t),this._length+=e,e}return 0},kd.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},kd.get=function(){var t=new Uint8Array(this._length),i=0;return this._viewOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i),i+=e.byteLength)}),t},e(gf,[{key:"byteLength",get:function(){return this._length}}]),j.internal.parseCCONJson=hf,j.internal.decodeCCONBinary=pf,j.internal.CCON=lf;var vf,yf="$_$default",xf="$_$formerlySerializedAs",g=(l(Tf,vf=dt),Tf.prototype.get=function(e,t,i,n,r){var o=this._get();return o?(o.reset(e,t,i,n,r),o):new Sf(e,t,i,n,r)},Tf),Sf=((c=bf.prototype).reset=function(e,t,i,n){this.result=e,this.customEnv=n,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced},c.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},c.deserialize=function(e){var t,i=!1,e=(e instanceof lf?(i=!0,t=e.document,0<e.chunks.length&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:i},Array.isArray(t)?t[0]:t);return this.deserializedData=this._deserializeObject(e,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},c._deserializeObject=function(e,t,i,n){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,i,n):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},c._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},c._deserializeTypedArrayViewRef=function(e){var t=e.offset,i=e.length,e=e.ctor;return new globalThis[e](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,i)},c._deserializeArray=function(e){for(var t,i=new Array(e.length),n=0;n<e.length;n++)"object"==typeof(t=e[n])&&t?this._deserializeAndAssignField(i,t,""+n)&&(i[n]=null):i[n]=t;return i},c._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},c._deserializeTypeTaggedObject=function(e,t,i,n){var r=this,o=e.__type__,i=this._classFinder(o,e,i,n);if(!i)return this._classFinder===pt&&this._reportMissingClass(o),null;n=new i,0<=t&&(r.deserializedList[t]=n);o=n;return this._deserializeInto(e,o,i),o},c._deserializeInto=function(e,t,i,n){(n=void 0===n?!1:n)||!t[cf]?t._deserialize?t._deserialize(e.content,this):j.Class._isCCClass(i)?this._deserializeFireClass(t,e,i):this._deserializeFastDefinedObject(t,e,i):this._runCustomizedDeserialize(e,t,i)},c._runCustomizedDeserialize=function(t,i,n){var r=this;i[cf]({readProperty:function(e){e=t[e];return"object"==typeof e&&e?r._deserializeObjectField(e):e},readThis:function(){r._deserializeInto(t,i,n,!0)},readSuper:function(){var e=et(n);e&&r._deserializeInto(t,i,e)}},this._context)},c._deserializeFireClass=function(e,t,i){var n,r,o;if(i.hasOwnProperty("__deserialize__"))o=i.__deserialize__;else{o=function(e){for(var t=ni(e),i=e.__values__,n=["var prop;"],r=Ut.test(ft(e)),o=0;o<i.length;o++){var a=i[o],s=void 0,c=void 0,l=s=Ti.IDENTIFIER_RE.test(a)?(c='"'+a+'"',"."+a):"["+(c=Ti.escapeForJS(a))+"]",u=(t[a+xf]&&(u=t[a+xf],l=Ti.IDENTIFIER_RE.test(u)?"."+u:"["+Ti.escapeForJS(u)+"]"),n.push("prop=d"+l+";"),n.push('if(typeof prop!=="undefined"){'),Ti.getDefault(t[a+yf]));r?(l=t[a+"$_$type"],(void 0===u&&l?l instanceof oi:"string"==(a=typeof u)||"number"==a||"boolean"==a)?n.push("o"+s+"=prop;"):mf(n,u,s,c,!0)):(n.push('if(typeof prop!=="object"){o'+s+"=prop;}else{"),mf(n,u,s,c,!1),n.push("}")),n.push("}")}return(j.js.isChildClassOf(e,j._BaseNode)||j.js.isChildClassOf(e,j.Component))&&n.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(n.push("o._$erialized=JSON.parse(JSON.stringify(d));"),n.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",n.join(""))}(i);try{i===K_&&(0!==(n=i.__values__).length&&"_$erialized"===n[n.length-1]||(tt("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),tt("    Error props: ['"+n+"']. Please contact jare.")),r=o,o=function(e,t,i,n){try{JSON.parse(JSON.stringify(i._$erialized))||tt("Unable to load previously serialized data. "+JSON.stringify(i))}catch(e){tt("Error when checking MissingScript 7, "+e)}r(e,t,i,n)})}catch(e){tt("Error when checking MissingScript 6, "+e)}ze(i,"__deserialize__",o,!0)}o(this,e,t,i)},c._deserializeAndAssignField=function(e,t,i){var n,r=t.__id__;return"number"==typeof r?(n=this.deserializedList[r])?e[i]=n:(n=this._serializedData[r],e[i]=this._deserializeObject(n,r,void 0,i),null!=(n=this._onDereferenced)&&n.call(this,this.deserializedList,r,e,i)):(n=t.__uuid__)?(r=t.__expectedType__,this.result.push(e,i,n,r)):e[i]=this._deserializeObject(t,-1),!1},c._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var i=this.deserializedList[t];if(i)return i;i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},c._fillPlainObject=function(e,t){for(var i in t){var n;t.hasOwnProperty(i)&&("object"!=typeof(n=t[i])?"__type__"!==i&&(e[i]=n):n&&!this._deserializeAndAssignField(e,n,i)||(e[i]=null))}},c._deserializeFastDefinedObject=function(e,t,i){if(i===j.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===j.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==j.Color){if(i===j.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=ni(i),r=i.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];"object"!=typeof(s=void 0!==s||t.hasOwnProperty(a)?s:Ti.getDefault(n[a+yf]))?e[a]=s:s?this._deserializeAndAssignField(e,s,a):e[a]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;i=t.a;e.a=void 0===i?255:i}},bf);function bf(e,t,i,n){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=i,this._onDereferenced=null==t?void 0:t.onDereferenced}function Tf(){return vf.call(this,function(e){e.clear()},1)||this}Sf.pool=new g;var Ef=[U,ce,Fr,gr,nr,Hr,qr,B];function Cf(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var wf=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},Cf,Cf,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){B.fromArray(e,t,1)}],Af=Rre("Details",((y=Pf.prototype).init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},y.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},y.push=function(e,t,i,n){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(i),this.uuidTypeList.push(n||"")},Pf));function Pf(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}function If(e,t){for(var i=e[4][t[0]],n=i[0],r=new n[0],o=n[1],a=n[2],s=i[i.length-1],c=1;c<s;++c)r[o[i[c]]]=t[c];for(;c<t.length;++c){var l=o[i[c]],u=n[i[c]+a];(0,Lf[u])(e,r,l,t[c])}return r}function Rf(e,t,i){var n=new t;return n._deserialize?n._deserialize(i,e[0]):ee(5303,He(t)),n}function Df(e,t,i,n){0<=n?t[i]=e[5][n]:e[7][3*~n]=t}function Of(o){return function(e,t,i,n){t[i]=n;for(var r=0;r<n.length;++r)o(e,n,r,n[r])}}function Mf(e,t,i,n){t[i]=null,e[8][n]=t}function Nf(e,t,i,n){t[i]=If(e,n)}Af.pool=new dt(function(e){e.reset()},5),Af.pool.get=function(){return this._get()||new Af};var Lf=new Array(13);function Bf(e,t,i){return e||i(t),Object}function Ff(t,e,i,n,r,o,a){var s,c,l,u=t(e);if(!u){if(r)return i[n]=(s=i,c=n,l=e,function(){var e=t(l)||Bf(o,l,a);return new(s[c]=e)});u=Bf(o,e,a)}i[n]=u}function zf(e,t,i,n){for(var r=i||pt,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Ff(r,s[0],s,0,t,i,n):Ff(r,s,o,a,t,i,n)}}function Uf(e){var t=e[4];if(t)for(var i=e[3],n=0;n<t.length;++n){var r=t[n];r[0]=i[r[0]]}}function kf(e,t,i){"string"==typeof e&&(e=JSON.parse(e));var n,r,o,a=!t;if(t=t||Af.pool.get(),function(e){if(Array.isArray(e))return"number"==typeof(e=e[0])||e instanceof Gf}(e)){t.init(e),i=i||{};var s=e[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(oe(5304,s));i._version=s,i.result=t,e[0]=i,c||(zf(e,!1,i.classFinder,null!=(s=i.reportMissingClass)?s:kf.reportMissingClass),Uf(e)),j.game._isCloning=!0;var c=e[5],s=function(e){var t=e[5],i=e[6],n=0===i?0:i.length,r=t[t.length-1],o=t.length-n;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=If(e,t[a]);for(var s=e[3],c=0;c<n;++c,++a){var l,u=i[c],h=t[a];0<=u?(l=s[u],t[a]=Rf(e,l,h)):(0,Lf[u=~u])(e,t,a,h)}return r}(e);if(j.game._isCloning=!1,e[7]){var l=e[7];var u=c;var h=e[2];for(var p=l.length-1,_=0,f=3*l[p];_<f;_+=3){var d=l[_],m=u[l[_+2]],g=l[_+1];0<=g?d[h[g]]=m:d[~g]=m}for(;_<p;_+=3){var v=u[l[_]],y=u[l[_+2]],x=l[_+1];0<=x?v[h[x]]=y:v[~x]=y}}for(var S=e,b=S[5],T=S[2],E=S[1],C=S[8],w=S[9],A=S[10],P=0;P<C.length;++P){var I=C[P],I=("number"==typeof I&&(C[P]=b[I]),w[P]),I=("number"==typeof I&&(I=0<=I?T[I]:~I,w[P]=I),A[P]);"number"==typeof I&&(A[P]=E[I])}S=c[s]}else c=e,s=t,i=(e=i||{}).classFinder||pt,n=e.createAssetRefs||af.platform===qi.EDITOR_CORE,r=e.customEnv,o=e.ignoreEditorOnly,e=null!=(e=e.reportMissingClass)?e:j.deserialize.reportMissingClass,s.init(),i=Sf.pool.get(s,i,e,r,o),j.game._isCloning=!0,e=i.deserialize(c),j.game._isCloning=!1,Sf.pool.put(i),n&&s.assignAssetsBy(EditorExtends.serialize.asAsset),S=e;return a&&Af.pool.put(t),S}Lf[0]=function(e,t,i,n){t[i]=n},Lf[1]=Df,Lf[2]=Of(Df),Lf[3]=Of(Mf),Lf[4]=Nf,Lf[5]=function(e,t,i,n){wf[n[0]](t[i],n)},Lf[6]=Mf,Lf[7]=function(e,t,i,n){t[i].set(n)},Lf[8]=function(e,t,i,n){var r=new Ef[n[0]];wf[n[0]](r,n),t[i]=r},Lf[9]=Of(Nf),Lf[10]=function(e,t,i,n){var r=e[3][n[0]];t[i]=Rf(e,r,n[1])},Lf[11]=function(e,t,i,n){var r=n[0];t[i]=r;for(var o=1;o<n.length;o+=3){var a=n[o],s=n[o+1],c=n[o+2];(0,Lf[s])(e,r,a,c)}},Lf[12]=function(e,t,i,n){var r=n[0];t[i]=r;for(var o=0;o<r.length;++o){var a=r[o],s=n[o+1];0!==s&&(0,Lf[s])(e,r,o,a)}},kf.Details=Af,kf.reportMissingClass=function(e){ee(5302,e)};var Gf=function(e){this.preprocessed=!0,this.version=e};j.deserialize=kf;var Hf,Vf,jf,Wf,qf,Xf,Yf=Pi.Flags.Destroyed,Kf=Pi.Flags.PersistentMask,Qf=[];function Zf(e){var t;if(e instanceof Pi){if(e._instantiate)return j.game._isCloning=!0,t=e._instantiate(null,!0),j.game._isCloning=!1,t;if(e instanceof j.Asset)throw new TypeError(oe(6903))}return j.game._isCloning=!0,t=Jf(e),j.game._isCloning=!1,t}function Jf(e,t){$f(e,e=e._iN$t||(e.constructor?new e.constructor:Object.create(null)),t);for(var i=0,n=Qf.length;i<n;++i)Qf[i]._iN$t=null;return Qf.length=0,e}function $f(e,t,i){gt.value(e,"_iN$t",t,!0),Qf.push(e);var n=e.constructor;if(j.Class._isCCClass(n)){var r=e;var o=t;var a=i;for(var s=n.__values__,c=0;c<s.length;c++){var l,u=s[c],h=r[u];"object"==typeof h&&h?(l=o[u])instanceof Bt&&l.constructor===h.constructor?l.set(h):o[u]=h._iN$t||ed(h,a):o[u]=h}}else for(var p in e)if(e.hasOwnProperty(p)&&(95!==p.charCodeAt(0)||95!==p.charCodeAt(1)||"__type__"===p||"__prefab"===p)){var _=e[p];if("object"==typeof _&&_){if(_===t)continue;t[p]=_._iN$t||ed(_,i)}else t[p]=_}e instanceof Pi&&(t._objFlags&=Kf)}function ed(e,t){if(e instanceof Bt)return e.clone();if(e instanceof j.Asset)return e;if(ArrayBuffer.isView(e)){var i=e.length,n=new e.constructor(i);e._iN$t=n,Qf.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,Qf.push(e);for(var a=0;a<o;++a){var s=e[a];n[a]="object"==typeof s&&s?s._iN$t||ed(s,t):s}return n}if(e._objFlags&Yf)return null;var c=e.constructor;if(j.Class._isCCClass(c)){if(t)if(t instanceof j.Component){if(e instanceof j._BaseNode||e instanceof j.Component)return e}else if(t instanceof j._BaseNode)if(e instanceof j._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof j.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return $f(e,n,t),n}function td(e,t){return(t<<3)+e}function id(e){return od[e]}function nd(e){switch(e){case qf.Uint8:return Uint8Array;case qf.Uint16:return Uint16Array;case qf.Uint32:return Uint32Array;case qf.Int8:return Int8Array;case qf.Int16:return Int16Array;case qf.Int32:return Int32Array;case qf.Float32:return Float32Array;case qf.Float64:return Float64Array}}function rd(){_(this,"_byteOffset",Hf,this),_(this,"_unitCount",Vf,this),_(this,"_unitElement",jf,this),_(this,"_length",Wf,this)}Zf._clone=Jf,j.instantiate=Zf,(Cp=qf=qf||{})[Cp.Uint8=0]="Uint8",Cp[Cp.Uint16=1]="Uint16",Cp[Cp.Uint32=2]="Uint32",Cp[Cp.Int8=3]="Int8",Cp[Cp.Int16=4]="Int16",Cp[Cp.Int32=5]="Int32",Cp[Cp.Float32=6]="Float32",Cp[Cp.Float64=7]="Float64",(kd=Xf=Xf||{})[kd.Scalar=0]="Scalar",kd[kd.Vec2=1]="Vec2",kd[kd.Vec3=2]="Vec3",kd[kd.Vec4=3]="Vec4",kd[kd.Quat=4]="Quat",kd[kd.Mat4=5]="Mat4",Rre("CompactValueTypeArray",f("cc.CompactValueTypeArray")((rd.lengthFor=function(e,t,i){return id(t).requiredUnits*e.length*nd(i).BYTES_PER_ELEMENT},rd.compress=function(e,t,i,n,r,o){for(var a=id(t),s=nd(i),c=a.requiredUnits*e.length,l=new s(n,r,c),u=0;u<e.length;++u)a.compress(l,u,e[u]);s=new rd;return s._unitElement=td(i,t),s._byteOffset=o,s._unitCount=c,s._length=e.length,s},rd.prototype.decompress=function(e){for(var t={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=id(t.elementType),n=new(nd(t.storageUnit))(e,this._byteOffset,this._unitCount),r=new Array(this._length),o=0;o<this._length;++o)r[o]=i.decompress(n,o);return r},g=c=rd,c.StorageUnit=qf,c.ElementType=Xf,Hf=i((y=g).prototype,"_byteOffset",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vf=i(y.prototype,"_unitCount",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jf=i(y.prototype,"_unitElement",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return td(qf.Uint8,Xf.Scalar)}}),Wf=i(y.prototype,"_length",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cp=y))||Cp);(kd={})[Xf.Scalar]={requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}},kd[Xf.Vec2]={requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new ce(e[2*t],e[2*t+1])}},kd[Xf.Vec3]={requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new ce(e[3*t],e[3*t+1],e[3*t+2])}},kd[Xf.Vec4]={requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new Fr(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},kd[Xf.Quat]={requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new gr(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},kd[Xf.Mat4]={requiredUnits:16,compress:function(e,t,i){B.toArray(e,i,16*t)},decompress:function(e,t){return B.fromArray(new B,e,16*t)}};var od=kd;function ad(){return 0}function sd(e){return e}function cd(e){return e*e}function ld(e){return e*(2-e)}function ud(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function hd(e){return e*e*e}function pd(e){return--e*e*e+1}function _d(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function fd(e){return e*e*e*e}function dd(e){return 1- --e*e*e*e}function md(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function gd(e){return e*e*e*e*e}function vd(e){return--e*e*e*e*e+1}function yd(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function xd(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function Sd(e){return Math.sin(e*Math.PI/2)}function bd(e){return.5*(1-Math.cos(Math.PI*e))}function Td(e){return 0===e?0:Math.pow(1024,e-1)}function Ed(e){return 1===e?1:1-Math.pow(2,-10*e)}function Cd(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function wd(e){return 1-Math.sqrt(1-e*e)}function Ad(e){return Math.sqrt(1- --e*e)}function Pd(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function Id(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*--e)*Math.sin(2*(e-t)*Math.PI/.4))}function Rd(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function Dd(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*--e)*Math.sin(2*(e-t)*Math.PI/.4)*-.5:i*Math.pow(2,-10*--e)*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function Od(e){if(1===e)return 1;return e*e*(2.70158*e-1.70158)}function Md(e){if(0===e)return 0;return--e*e*(2.70158*e+1.70158)+1}function Nd(e){var t=2.5949095;return(e*=2)<1?e*e*((1+t)*e-t)*.5:.5*((e-=2)*e*((1+t)*e+t)+2)}function Ld(e){return 1-Bd(1-e)}function Bd(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function Fd(e){return e<.5?.5*Ld(2*e):.5*Bd(2*e-1)+.5}function zd(e){return e<=0?0:1<=e?1:e*e*(3-2*e)}function Ud(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)}j._decorator=Qp;var c=Vd(cd,ld),g=Vd(hd,pd),y=Vd(fd,dd),Cp=Vd(gd,vd),kd=Vd(xd,Sd),Qp=Vd(Td,Ed),x=Vd(wd,Ad),Gd=Vd(Id,Rd),S=Vd(Od,Md),Hd=Vd(Ld,Bd);function Vd(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var jd,Wd=Object.freeze({__proto__:null,constant:ad,linear:sd,quadIn:cd,quadOut:ld,quadInOut:ud,cubicIn:hd,cubicOut:pd,cubicInOut:_d,quartIn:fd,quartOut:dd,quartInOut:md,quintIn:gd,quintOut:vd,quintInOut:yd,sineIn:xd,sineOut:Sd,sineInOut:bd,expoIn:Td,expoOut:Ed,expoInOut:Cd,circIn:wd,circOut:Ad,circInOut:Pd,elasticIn:Id,elasticOut:Rd,elasticInOut:Dd,backIn:Od,backOut:Md,backInOut:Nd,bounceIn:Ld,bounceOut:Bd,bounceInOut:Fd,smooth:zd,fade:Ud,quadOutIn:c,cubicOutIn:g,quartOutIn:y,quintOutIn:Cp,sineOutIn:kd,expoOutIn:Qp,circOutIn:x,elasticOutIn:Gd,backOutIn:S,bounceOutIn:Hd});Rre("easing",Wd),(b=jd=jd||{})[b.LINEAR=0]="LINEAR",b[b.CONSTANT=1]="CONSTANT",b[b.QUAD_IN=2]="QUAD_IN",b[b.QUAD_OUT=3]="QUAD_OUT",b[b.QUAD_IN_OUT=4]="QUAD_IN_OUT",b[b.QUAD_OUT_IN=5]="QUAD_OUT_IN",b[b.CUBIC_IN=6]="CUBIC_IN",b[b.CUBIC_OUT=7]="CUBIC_OUT",b[b.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",b[b.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",b[b.QUART_IN=10]="QUART_IN",b[b.QUART_OUT=11]="QUART_OUT",b[b.QUART_IN_OUT=12]="QUART_IN_OUT",b[b.QUART_OUT_IN=13]="QUART_OUT_IN",b[b.QUINT_IN=14]="QUINT_IN",b[b.QUINT_OUT=15]="QUINT_OUT",b[b.QUINT_IN_OUT=16]="QUINT_IN_OUT",b[b.QUINT_OUT_IN=17]="QUINT_OUT_IN",b[b.SINE_IN=18]="SINE_IN",b[b.SINE_OUT=19]="SINE_OUT",b[b.SINE_IN_OUT=20]="SINE_IN_OUT",b[b.SINE_OUT_IN=21]="SINE_OUT_IN",b[b.EXPO_IN=22]="EXPO_IN",b[b.EXPO_OUT=23]="EXPO_OUT",b[b.EXPO_IN_OUT=24]="EXPO_IN_OUT",b[b.EXPO_OUT_IN=25]="EXPO_OUT_IN",b[b.CIRC_IN=26]="CIRC_IN",b[b.CIRC_OUT=27]="CIRC_OUT",b[b.CIRC_IN_OUT=28]="CIRC_IN_OUT",b[b.CIRC_OUT_IN=29]="CIRC_OUT_IN",b[b.ELASTIC_IN=30]="ELASTIC_IN",b[b.ELASTIC_OUT=31]="ELASTIC_OUT",b[b.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",b[b.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",b[b.BACK_IN=34]="BACK_IN",b[b.BACK_OUT=35]="BACK_OUT",b[b.BACK_IN_OUT=36]="BACK_IN_OUT",b[b.BACK_OUT_IN=37]="BACK_OUT_IN",b[b.BOUNCE_IN=38]="BOUNCE_IN",b[b.BOUNCE_OUT=39]="BOUNCE_OUT",b[b.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",b[b.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",b[b.SMOOTH=42]="SMOOTH",b[b.FADE=43]="FADE";(b={})[jd.CONSTANT]=ad,b[jd.LINEAR]=sd,b[jd.QUAD_IN]=cd,b[jd.QUAD_OUT]=ld,b[jd.QUAD_IN_OUT]=ud,b[jd.QUAD_OUT_IN]=c,b[jd.CUBIC_IN]=hd,b[jd.CUBIC_OUT]=pd,b[jd.CUBIC_IN_OUT]=_d,b[jd.CUBIC_OUT_IN]=g,b[jd.QUART_IN]=fd,b[jd.QUART_OUT]=dd,b[jd.QUART_IN_OUT]=md,b[jd.QUART_OUT_IN]=y,b[jd.QUINT_IN]=gd,b[jd.QUINT_OUT]=vd,b[jd.QUINT_IN_OUT]=yd,b[jd.QUINT_OUT_IN]=Cp,b[jd.SINE_IN]=xd,b[jd.SINE_OUT]=Sd,b[jd.SINE_IN_OUT]=bd,b[jd.SINE_OUT_IN]=kd,b[jd.EXPO_IN]=Td,b[jd.EXPO_OUT]=Ed,b[jd.EXPO_IN_OUT]=Cd,b[jd.EXPO_OUT_IN]=Qp,b[jd.CIRC_IN]=wd,b[jd.CIRC_OUT]=Ad,b[jd.CIRC_IN_OUT]=Pd,b[jd.CIRC_OUT_IN]=x,b[jd.ELASTIC_IN]=Id,b[jd.ELASTIC_OUT]=Rd,b[jd.ELASTIC_IN_OUT]=Dd,b[jd.ELASTIC_OUT_IN]=Gd,b[jd.BACK_IN]=Od,b[jd.BACK_OUT]=Md,b[jd.BACK_IN_OUT]=Nd,b[jd.BACK_OUT_IN]=S,b[jd.BOUNCE_IN]=Ld,b[jd.BOUNCE_OUT]=Bd,b[jd.BOUNCE_IN_OUT]=Fd,b[jd.BOUNCE_OUT_IN]=Hd,b[jd.SMOOTH]=zd,b[jd.FADE]=Ud;var qd,Xd,Yd=b;function Kd(e){return Yd[e]}l(Jd,Qd=function(){});var Qd,Zd=Jd;function Jd(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=Qd.call.apply(Qd,[this].concat(i))||this).interpolationMode=jp.LINEAR,e.tangentWeightMode=qp.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=jd.LINEAR,e}function $d(e){var t,i,n,r,o,a,s,c,l=new Zd;return"number"==typeof e?l.value=e:(t=e.interpolationMode,i=e.tangentWeightMode,n=e.value,r=e.rightTangent,o=e.rightTangentWeight,a=e.leftTangent,s=e.leftTangentWeight,c=e.easingMethod,e=e[wi],l.value=null!=n?n:l.value,l.rightTangent=null!=r?r:l.rightTangent,l.rightTangentWeight=null!=o?o:l.rightTangentWeight,l.leftTangent=null!=a?a:l.leftTangent,l.leftTangentWeight=null!=s?s:l.leftTangentWeight,l.interpolationMode=null!=t?t:l.interpolationMode,l.tangentWeightMode=null!=i?i:l.tangentWeightMode,l.easingMethod=null!=c?c:l.easingMethod,e&&(l[wi]=e)),l}Ti.fastDefine("cc.RealKeyframeValue",Zd,{interpolationMode:jp.LINEAR,tangentWeightMode:qp.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:jd.LINEAR}),Ti.Attr.setClassAttr(Zd,wi,"editorOnly",!0),(null!=(g=(c=Zd)[vp])?g:c[vp]={}).uniquelyReferenced=!0;var em,tm,im=Rre("RealCurve",f("cc.RealCurve")((l(nm,tm=Xp),(y=nm.prototype).evaluate=function(e){var t=this._times,i=this._values,n=t.length;if(0===n)return 0;var r=t[0],o=t[n-1];if(e<r){var a=this.preExtrapolation,s=i[0];if(a===Wp.CLAMP||n<2)return s.value;switch(a){case Wp.LINEAR:return mm(r,i[0].value,t[1],i[1].value,e);case Wp.LOOP:e=fm(e,r,o);break;case Wp.PING_PONG:e=dm(e,r,o);break;default:return s.value}}else if(o<e){var a=this.postExtrapolation,c=i[n-1];if(a===Wp.CLAMP||n<2)return c.value;switch(a){case Wp.LINEAR:return mm(o,c.value,t[n-2],i[n-2].value,e);case Wp.LOOP:e=fm(e,r,o);break;case Wp.PING_PONG:e=dm(e,r,o);break;default:return c.value}}a=lp(t,e);if(0<=a)return i[a].value;var a=~a,l=a-1,u=t[l],l=i[l],h=t[a],p=u,_=l,f=h,d=i[a],m=(e-u)/(h-u),g=f-p;switch(_.interpolationMode){default:case jp.CONSTANT:return _.value;case jp.LINEAR:var v=_.easingMethod===jd.LINEAR?m:Kd(_.easingMethod)(m);return Un(_.value,d.value,v);case jp.CUBIC:var y,x,v=_.rightTangent,S=_.rightTangentWeight,b=0!=(_.tangentWeightMode&qp.RIGHT),T=d.leftTangent,E=d.leftTangentWeight,C=0!=(d.tangentWeightMode&qp.LEFT);if(b||C)return w=0,w=b?S:(b=g*v,Math.sqrt(g*g+b*b)*(1/3)),S=Math.atan(v),b=Math.cos(S)*w+p,S=Math.sin(S)*w+_.value,w=0,w=C?E:(C=g*T,Math.sqrt(g*g+C*C)*(1/3)),E=Math.atan(T),y=(b-p)/g,x=(-Math.cos(E)*w+f-p)/g,C=S,b=-Math.sin(E)*w+d.value,E=function(e,t){var i=m;if(1===t)i=e[0];else{for(var i=-1/0,n=0;n<t;++n){var r=e[n];0<=r&&r<=1&&i<r&&(i=r)}i===-1/0&&(i=0)}return i}(S=[0,0,0],function(e,t){var i=(3*x-6*y)/e,n=3*y/e,r=i*i,o=1/3*(-1/3*r+n),r=.5*(2/27*i*r-1/3*i*n+(0-m)/e),n=o*o*o,e=r*r+n,a=0;if(Kp(e)){if(Kp(r))return t[0]=0,1;var s=Math.cbrt(-r);return t[0]=2*s,t[1]=-s,2}for(var a=e<0?(s=1/3*Math.acos(-r/Math.sqrt(-n)),n=2*Math.sqrt(-o),t[0]=n*Math.cos(s),t[1]=-n*Math.cos(s+Math.PI/3),t[2]=-n*Math.cos(s-Math.PI/3),3):(o=Math.sqrt(e),n=Math.cbrt(o-r),s=-Math.cbrt(o+r),t[0]=n+s,1),c=1/3*i,l=0;l<a;++l)t[l]-=c;return a}(3*(y-x)+1,S)),gm(_.value,C,b,d.value,E);var w=_.value+1/3*v*g,S=d.value-1/3*T*g;return gm(_.value,w,S,d.value,m)}},y.addKeyFrame=function(e,t){return tm.prototype.addKeyFrame.call(this,e,$d(t))},y.assignSorted=function(e,t){void 0!==t?this.setKeyframes(e.slice(),t.map($d)):(t=Array.from(e),this.setKeyframes(t.map(function(e){return e[0]}),t.map(function(e){return $d(e[1])})))},y.isConstant=function(t){if(this._values.length<=1)return!0;var i=this._values[0].value;return this._values.every(function(e){return Bn(e.value,i,t)})},y[Z_]=function(e,t){if(t.toCCON){var t=this._times,i=this._values,n=t.length,r=new DataView(new ArrayBuffer(0+rm+rm+om+am*n+_m*n)),o=0;r.setUint8(o,this.preExtrapolation),o+=rm,r.setUint8(o,this.postExtrapolation),o+=rm,r.setUint32(o,n,!0),o+=om,t.forEach(function(e,t){return r.setFloat32(o+am*t,e,!0)}),o+=am*n;for(var a=ge(i);!(s=a()).done;){var s=s.value;c=r,y=v=g=m=d=f=_=p=h=void 0,h=0,p=u=o,u+=4,_=(l=s).value,f=s.interpolationMode,d=s.tangentWeightMode,m=s.rightTangent,g=s.rightTangentWeight,v=s.leftTangent,y=s.leftTangentWeight,l=s.easingMethod,c.setFloat32(u,_,!0),u+=4,f!==sm&&(h|=em.INTERPOLATION_MODE,c.setUint8(u,f),u+=1),d!==cm&&(h|=em.TANGENT_WEIGHT_MODE,c.setUint8(u,d),u+=1),v!==lm&&(h|=em.LEFT_TANGENT,c.setFloat32(u,v,!0),u+=4),y!==um&&(h|=em.LEFT_TANGENT_WEIGHT,c.setFloat32(u,y,!0),u+=4),m!==hm&&(h|=em.RIGHT_TANGENT,c.setFloat32(u,m,!0),u+=4),g!==pm&&(h|=em.RIGHT_TANGENT_WEIGHT,c.setFloat32(u,g,!0),u+=4),h|=l<<8,c.setUint32(p,h,!0),o=u}t=new Uint8Array(r.buffer,0,o),n=(e.writeProperty("bytes",t),i.map(function(e){return e[wi]}));n.some(function(e){return void 0!==e})&&e.writeProperty("keyframeValueEditorExtras",n)}else e.writeThis();var c,l,u,h,p,_,f,d,m,g,v,y},y[cf]=function(e,t){if(t.fromCCON){var t=e.readProperty("bytes"),i=new DataView(t.buffer,t.byteOffset,t.byteLength),n=0,r=(this.preExtrapolation=i.getUint8(n),n+=rm,this.postExtrapolation=i.getUint8(n),n+=rm,i.getUint32(n,!0)),o=(n+=om,Array.from({length:r},function(e,t){return i.getFloat32(n+am*t,!0)}));n+=am*r;for(var a=new Array(r),s=0;s<r;++s){var c=$d({});u=c,h=n,p=void 0,p=(l=i).getUint32(h,!0),h+=4,u.value=l.getFloat32(h,!0),h+=4,p&em.INTERPOLATION_MODE&&(u.interpolationMode=l.getUint8(h),h+=1),p&em.TANGENT_WEIGHT_MODE&&(u.tangentWeightMode=l.getUint8(h),h+=1),p&em.LEFT_TANGENT&&(u.leftTangent=l.getFloat32(h,!0),h+=4),p&em.LEFT_TANGENT_WEIGHT&&(u.leftTangentWeight=l.getFloat32(h,!0),h+=4),p&em.RIGHT_TANGENT&&(u.rightTangent=l.getFloat32(h,!0),h+=4),p&em.RIGHT_TANGENT_WEIGHT&&(u.rightTangentWeight=l.getFloat32(h,!0),h+=4),l=(65280&p)>>8,u.easingMethod=l,n=h,a[s]=c}t.byteLength;t=e.readProperty("keyframeValueEditorExtras");t&&(t.length,t.forEach(function(e,t){return a[t][wi]=e})),this._times=o,this._values=a}else e.readThis();var l,u,h,p},qd=i((Cp=nm).prototype,"preExtrapolation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wp.CLAMP}}),Xd=i(Cp.prototype,"postExtrapolation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wp.CLAMP}}),kd=Cp))||kd);function nm(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=tm.call.apply(tm,[this].concat(i))||this,"preExtrapolation",qd,p(e)),_(e,"postExtrapolation",Xd,p(e)),e}(Qp=em=em||{})[Qp.VALUE=1]="VALUE",Qp[Qp.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",Qp[Qp.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",Qp[Qp.LEFT_TANGENT=8]="LEFT_TANGENT",Qp[Qp.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",Qp[Qp.RIGHT_TANGENT=32]="RIGHT_TANGENT",Qp[Qp.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT";var rm=1,om=4,am=4,x=$d({}),sm=x.interpolationMode,cm=x.tangentWeightMode,lm=x.leftTangent,um=x.leftTangentWeight,hm=x.rightTangent,pm=x.rightTangentWeight,_m=26;function fm(e,t,i){return t+Kn(e-t,i-t)}function dm(e,t,i){return t+Qn(e-t,i-t)}function mm(e,t,i,n,r){return t+(n-t)/(i-e)*(r-e)}function gm(e,t,i,n,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*i+r*r*r*n}function vm(e,t,i,n,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*i*r*r)+n*r*r*r}j.bezier=vm;var ym,xm,Sm,bm,Tm,Em,Cm=Math.cos,wm=Math.acos,Am=Math.max,Pm=2*Math.PI,Im=Math.sqrt;function Rm(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function Dm(u,h){var e=function(){var e,t,i,n=+h,r=h-u[0],o=3*n,a=3*r,s=3*(h-u[2]),c=1/(a-n-s+(h-1)),r=(o-6*r+s)*c,s=1/3*r,a=(a-o)*c,o=1/3*(3*a-r*r),l=1/3*o,r=(2*r*r*r-9*r*a+n*c*27)/27,a=r/2,n=a*a+l*l*l;if(n<0)return l=Im((c=1/3*-o)*c*c),c=wm((o=-r/(2*l))<-1?-1:1<o?1:o),t=(r=2*Rm(l))*Cm(c*(1/3))-s,i=r*Cm((c+Pm)*(1/3))-s,o=r*Cm((c+2*Pm)*(1/3))-s,0<=t&&t<=1?0<=i&&i<=1?0<=o&&o<=1?Am(t,i,o):Am(t,i):0<=o&&o<=1?Am(t,o):t:0<=i&&i<=1?0<=o&&o<=1?Am(i,o):i:o;if(0==n)return i=-(e=a<0?Rm(-a):-Rm(a))-s,0<=(t=2*e-s)&&t<=1?0<=i&&i<=1?Am(t,i):t:i;l=Im(n);return(e=Rm(-a+l))-Rm(a+l)-s}(),t=u[1];return((1-e)*(t+(u[3]-t)*e)*3+e*e)*e}j.bezierByTime=Dm,(Gd=Em=Em||Rre("QuatInterpolationMode",{}))[Gd.SLERP=0]="SLERP",Gd[Gd.CONSTANT=1]="CONSTANT";var Om=f("cc.QuatKeyframeValue")(Hd=bp((ym=i((S=function(e){var e=void 0===e?{}:e,t=e.value,i=e.interpolationMode,e=e.easingMethod;_(this,"interpolationMode",ym,this),_(this,"value",xm,this),_(this,"easingMethod",Sm,this),this.value=t?gr.clone(t):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=e?e:this.easingMethod}).prototype,"interpolationMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Em.SLERP}}),xm=i(S.prototype,"value",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gr.clone(gr.IDENTITY)}}),Sm=i(S.prototype,"easingMethod",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jd.LINEAR}}),Hd=S))||Hd)||Hd;function Mm(e){return new Om(e)}var Nm,Lm,Bm=Rre("QuatCurve",f("cc.QuatCurve")((l(Fm,Lm=Xp),(b=Fm.prototype).evaluate=function(e,t){null==t&&(t=new gr);var i=this._times,n=this._values,r=this.postExtrapolation,o=this.preExtrapolation,a=i.length;if(0===a)return t;var s=i[0],c=i[a-1];if(e<s){var l=n[0];switch(o){case Wp.LOOP:e=s+Kn(e-s,c-s);break;case Wp.PING_PONG:e=s+Qn(e-s,c-s);break;default:Wp.CLAMP;return gr.copy(t,l.value)}}else if(c<e){var u=n[a-1];switch(r){case Wp.LOOP:e=s+Kn(e-s,c-s);break;case Wp.PING_PONG:e=s+Qn(e-s,c-s);break;default:Wp.CLAMP;return gr.copy(t,u.value)}}o=lp(i,e);if(0<=o)return gr.copy(t,n[o].value);var a=~o,r=a-1,o=i[r],h=n[r],r=i[a],p=n[a],_=(e-o)/(r-o);switch(h.interpolationMode){default:case Em.CONSTANT:return gr.copy(t,h.value);case Em.SLERP:var f=h.easingMethod,f=f===jd.LINEAR?_:Array.isArray(f)?Dm(f,_):Kd(f)(_);return gr.slerp(t,h.value,p.value,f)}},b.addKeyFrame=function(e,t){t=new Om(t);return Lm.prototype.addKeyFrame.call(this,e,t)},b.assignSorted=function(e,t){void 0!==t?this.setKeyframes(e.slice(),t.map(Mm)):(t=Array.from(e),this.setKeyframes(t.map(function(e){return e[0]}),t.map(function(e){return Mm(e[1])})))},b[Z_]=function(e,t){var i,n,r,o,a,s,c,l,u;t.toCCON?(t=this._times,i=this._values,n=!0,i.forEach(function(e,t,i){i=i[0];n&&e.interpolationMode!==i.interpolationMode&&(n=!1)}),r=t.length,o=Wm*(n?1:r),u=i.reduce(function(e,t){t=t.easingMethod;return e+(Array.isArray(t)?qm+4*Ym:qm)},0),c=0,a=new DataView(new ArrayBuffer(c+=Gm+Hm+Vm*r+4*jm*r+u+o+0)),u=s=0,n&&(u|=Nm.INTERPOLATION_MODE),a.setUint32(s,u,!0),s+=Gm,a.setUint32(s,r,!0),s+=Hm,t.forEach(function(e,t){return a.setFloat32(s+Vm*t,e,!0)}),s+=Vm*r,i.forEach(function(e,t){var e=e.value,i=e.x,n=e.y,r=e.z,e=e.w,t=s+4*jm*t;a.setFloat32(t+0*jm,i,!0),a.setFloat32(t+ +jm,n,!0),a.setFloat32(t+2*jm,r,!0),a.setFloat32(t+3*jm,e,!0)}),s+=4*jm*r,i.forEach(function(e){e=e.easingMethod;Array.isArray(e)?(a.setUint8(s,Xm),++s,a.setFloat32(s+0*Ym,e[0],!0),a.setFloat32(s+ +Ym,e[1],!0),a.setFloat32(s+2*Ym,e[2],!0),a.setFloat32(s+3*Ym,e[3],!0),s+=4*Ym):(a.setUint8(s,e),++s)}),c=s,s+=o,l=c,i.forEach(function(e){e=e.interpolationMode;a.setUint8(l,e),n||(l+=Wm)}),u=new Uint8Array(a.buffer),e.writeProperty("bytes",u)):e.writeThis()},b[cf]=function(e,t){if(t.fromCCON){var t=e.readProperty("bytes"),a=new DataView(t.buffer,t.byteOffset,t.byteLength),s=0,t=a.getUint32(s,!0),t=(s+=Gm,t&Nm.INTERPOLATION_MODE),i=a.getUint32(s,!0),n=(s+=Hm,Array.from({length:i},function(e,t){return a.getFloat32(s+Vm*t,!0)})),c=s+=Vm*i,r=(s+=4*jm*i,Array.from({length:i},function(e,t){var t=c+4*jm*t,i=a.getFloat32(t+0*jm,!0),n=a.getFloat32(t+ +jm,!0),r=a.getFloat32(t+2*jm,!0),t=a.getFloat32(t+3*jm,!0),o=a.getUint8(s),i=(++s,Mm({value:{x:i,y:n,z:r,w:t}}));return o!==Xm?i.easingMethod=o:(i.easingMethod=[a.getFloat32(s+0*Ym,!0),a.getFloat32(s+ +Ym,!0),a.getFloat32(s+2*Ym,!0),a.getFloat32(s+3*Ym,!0)],s+=4*Ym),i}));if(t){var o=a.getUint8(s);++s;for(var l=0;l<i;++l)r[l].interpolationMode=o}else{for(var u=0;u<i;++u){var h=a.getUint8(s+u);r[u].interpolationMode=h}s+=i}this._times=n,this._values=r}else e.readThis()},bm=i((g=Fm).prototype,"preExtrapolation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wp.CLAMP}}),Tm=i(g.prototype,"postExtrapolation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wp.CLAMP}}),c=g))||c);function Fm(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=Lm.call.apply(Lm,[this].concat(i))||this,"preExtrapolation",bm,p(e)),_(e,"postExtrapolation",Tm,p(e)),e}Nm=Nm||{},Nm[Nm.INTERPOLATION_MODE=1]="INTERPOLATION_MODE";function zm(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}var Um,km,Gm=1,Hm=4,Vm=4,jm=4,Wm=1,qm=1,Xm=255,Ym=4,Km=Rre("ObjectCurve",f("cc.ObjectCurve")((l(Qm,km=Xp),Qm.prototype.evaluate=function(e){e=this.searchKeyframe(e);if(0<=e)return this._values[e];e=Fn(~e-1,0,this._values.length-1);return this._values[e]},y=Qm))||y);function Qm(){return km.apply(this,arguments)||this}Ti.fastDefine("cc.Keyframe",zm,{time:0,value:0,inTangent:0,outTangent:0});eg.prototype.evaluate=function(e){return(e=e-this.time)*(e*(e*(e=this.coefficient)[0]+e[1])+e[2])+e[3]};var Zm=eg,Jm=f("cc.AnimationCurve")(((Cp=$m.prototype).addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:jp.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},Cp.evaluate_slow=function(e){return this._curve.evaluate(e)},Cp.evaluate=function(e){var t=this.cachedKey,i=this._curve,n=i.keyFramesCount-1,r=e,o=e<0?i.preExtrapolation:i.postExtrapolation,a=i.getKeyframeTime(0),s=i.getKeyframeTime(n);switch(o){case Wp.LOOP:r=Kn(e-a,s-a)+a;break;case Wp.PING_PONG:r=Qn(e-a,s-a)+a;break;default:Wp.CLAMP;r=Fn(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);i=this.findIndex(t,r),o=Math.min(i+1,n);return this.calcOptimizedKey(t,i,o),t.evaluate(r)},Cp.calcOptimizedKey=function(e,t,i){var n=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(i),o=this._curve.getKeyframeValue(t),a=o.value,o=o.leftTangent,i=this._curve.getKeyframeValue(i),s=i.value,i=i.rightTangent,t=(e.index=t,e.time=n,(e.endTime=r)-n),r=s-a,n=1/(t*t),s=o*t,i=i*t;e.coefficient[0]=(s+i-r-r)*n/t,e.coefficient[1]=(r+r+r-s-s-i)*n,e.coefficient[2]=o,e.coefficient[3]=a},Cp.findIndex=function(e,t){var i=this._curve,n=i.keyFramesCount,r=e.index;if(-1!==r)if(t>i.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<n&&i.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(0<=c&&i.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=n;1<h-u;)l=Math.floor((u+h)/2),i.getKeyframeTime(l)>=t?h=l:u=l;return u},e($m,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map(function(e){var t=e[0],e=e[1],i=new zm;return i.time=t,i.value=e.value,i.inTangent=e.leftTangent,i.outTangent=e.rightTangent,i})},set:function(e){this._curve.assignSorted(e.map(function(e){return[e.time,{interpolationMode:jp.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))}},{key:"preWrapMode",get:function(){return ig(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=tg(e)}},{key:"postWrapMode",get:function(){return ig(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=tg(e)}}]),$m.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Um=i((kd=$m).prototype,"_curve",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Qp=kd))||Qp;function $m(e){var t;void 0===e&&(e=null),_(this,"_curve",Um,this),this.cachedKey=void 0,e instanceof im?this._curve=e:(t=new im,(this._curve=t).preExtrapolation=Wp.LOOP,t.postExtrapolation=Wp.CLAMP,e?t.assignSorted(e.map(function(e){return[e.time,{interpolationMode:jp.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})):t.assignSorted([[0,{interpolationMode:jp.CUBIC,value:1}],[1,{interpolationMode:jp.CUBIC,value:1}]])),this.cachedKey=new Zm}function eg(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}function tg(e){switch(e){default:case ep.Default:case ep.Normal:case ep.Clamp:return Wp.CLAMP;case ep.PingPong:return Wp.PING_PONG;case ep.Loop:return Wp.LOOP}}function ig(e){switch(e){default:case Wp.LINEAR:case Wp.CLAMP:return ep.Clamp;case Wp.PING_PONG:return ep.PingPong;case Wp.LOOP:return ep.Loop}}function ng(){var e=new im;return e.assignSorted([[0,{interpolationMode:jp.CUBIC,value:1}],[1,{interpolationMode:jp.CUBIC,value:1}]]),e}function rg(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}In(Ch,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);l(bg,_g=n);var og,ag,sg,cg,lg,ug,hg,pg,_g,x=bg,Gd=(l(Sg,pg=Dh),Sg),S=(l(xg,hg=fo),xg),Hd=(l(yg,ug=r),yg),b=(l(vg,lg=ua),vg),g=(l(gg,cg=qh),gg),c=(l(mg,sg=o),mg),Xp=(l(dg,ag=s),dg),y=(l(fg,og=op),fg),Cp=Object.freeze({__proto__:null,distance:t,enums:_o,intersect:Ch,Line:n,Plane:Dh,Ray:fo,Triangle:r,Sphere:ua,AABB:qh,OBB:o,Capsule:s,Frustum:op,Keyframe:zm,AnimationCurve:Jm,get ERaycastMode(){return Nl},line:x,plane:Gd,ray:S,triangle:Hd,sphere:b,aabb:g,obb:c,capsule:Xp,frustum:y});function fg(){var e=og.call(this)||this;return rg("frustum","Frustum"),e}function dg(){var e=ag.call(this)||this;return rg("capsule","Capsule"),e}function mg(){var e=sg.call(this)||this;return rg("obb","OBB"),e}function gg(){var e=cg.call(this)||this;return rg("aabb","AABB"),e}function vg(){var e=lg.call(this)||this;return rg("sphere","Sphere"),e}function yg(){var e=ug.call(this)||this;return rg("triangle","Triangle"),e}function xg(){var e=hg.call(this)||this;return rg("ray","Ray"),e}function Sg(){var e=pg.call(this)||this;return rg("plane","Plane"),e}function bg(){var e=_g.call(this)||this;return rg("line","Line"),e}Rre("geometry",Cp);var kd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Tg=Rre("Layers",(Eg.makeMaskInclude=function(e){for(var t,i=0,n=ge(e);!(t=n()).done;)i|=t.value;return i},Eg.makeMaskExclude=function(e){return~Eg.makeMaskInclude(e)},Eg.addLayer=function(e,t){void 0!==t?19<t||t<0?console.warn("maximum layers reached."):(t=1<<t,Eg.Enum[e],oe(2104,e),Eg.Enum[e]=t,gt.value(Eg.Enum,String(t),e),Eg.BitMask[e]=t,gt.value(Eg.BitMask,String(t),e)):console.warn("bitNum can't be undefined")},Eg.deleteLayer=function(e){19<e||e<0?console.warn("do not change buildin layers."):(delete Eg.Enum[Eg.Enum[e=1<<e]],delete Eg.Enum[e],delete Eg.BitMask[Eg.BitMask[e]],delete Eg.BitMask[e])},Eg.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):mn(Eg.Enum[e])},Eg.layerToName=function(e){return 31<e||e<0?(console.warn("Unable to access unknown layer."),""):Eg.Enum[1<<e]},Eg));function Eg(){}Tg.Enum=Ot(kd),Tg.BitMask=Dt(ue({},kd)),j.Layers=Tg;var Cg,wg,Qp="MainFlow",t="ForwardFlow",n="ShadowFlow";(r=Cg=Cg||{})[r.DEFAULT=100]="DEFAULT",r[r.UI=200]="UI",j.RenderPassStage=Cg,(o=wg=wg||{})[o.MIN=0]="MIN",o[o.MAX=255]="MAX",o[o.DEFAULT=128]="DEFAULT";var Ag,Pg={bindings:[],layouts:{}},Ig={bindings:[],layouts:{}};(s=Ag=Ag||{})[s.UBO_GLOBAL=0]="UBO_GLOBAL",s[s.UBO_CAMERA=1]="UBO_CAMERA",s[s.UBO_SHADOW=2]="UBO_SHADOW",s[s.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",s[s.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",s[s.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",s[s.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",s[s.COUNT=7]="COUNT";var Rg,x=Ag.SAMPLER_SHADOWMAP,Gd=Ag.COUNT-x;(S=Rg=Rg||{})[S.UBO_LOCAL=0]="UBO_LOCAL",S[S.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",S[S.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",S[S.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",S[S.UBO_MORPH=4]="UBO_MORPH",S[S.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",S[S.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",S[S.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",S[S.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",S[S.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",S[S.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",S[S.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",S[S.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",S[S.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",S[S.COUNT=14]="COUNT";function Dg(){}function Og(){}function Mg(){}function Ng(){}function Lg(){}function Bg(){}function Fg(){}function zg(){}function Ug(){}function kg(){}function Gg(){}function Hg(){}function Vg(){}var jg,Hd=Rg.SAMPLER_JOINTS,b=Rg.COUNT-Hd,Wg=((g=jg=jg||{})[g.GLOBAL=0]="GLOBAL",g[g.MATERIAL=1]="MATERIAL",g[g.LOCAL=2]="LOCAL",new wa),qg=(Wg.bufferOffsets=[0,x+Hd,x],Wg.samplerOffsets=[-x,Gd+b,Gd-Hd],Wg.flexibleSet=1,Dg.SIZE=4*(Dg.COUNT=4+(Dg.SCREEN_SIZE_OFFSET=4+(Dg.NATIVE_SIZE_OFFSET=4+(Dg.TIME_OFFSET=0)))),Dg.NAME="CCGlobal",Dg.BINDING=Ag.UBO_GLOBAL,Dg.DESCRIPTOR=new is(Dg.BINDING,oa.UNIFORM_BUFFER,1,Xo.ALL),Dg.LAYOUT=new Fa(jg.GLOBAL,Dg.BINDING,Dg.NAME,[new Ba("cc_time",Ro.FLOAT4,1),new Ba("cc_screenSize",Ro.FLOAT4,1),new Ba("cc_nativeSize",Ro.FLOAT4,1)],1),Pg.layouts[Dg.NAME]=Dg.LAYOUT,Pg.bindings[Dg.BINDING]=Dg.DESCRIPTOR,Og.SIZE=4*(Og.COUNT=4+(Og.VIEW_PORT_OFFSET=4+(Og.NEAR_FAR_OFFSET=4+(Og.GLOBAL_FOG_ADD_OFFSET=4+(Og.GLOBAL_FOG_BASE_OFFSET=4+(Og.GLOBAL_FOG_COLOR_OFFSET=4+(Og.AMBIENT_GROUND_OFFSET=4+(Og.AMBIENT_SKY_OFFSET=4+(Og.MAIN_LIT_COLOR_OFFSET=4+(Og.MAIN_LIT_DIR_OFFSET=4+(Og.EXPOSURE_OFFSET=4+(Og.SCREEN_SCALE_OFFSET=4+(Og.CAMERA_POS_OFFSET=16+(Og.MAT_VIEW_PROJ_INV_OFFSET=16+(Og.MAT_VIEW_PROJ_OFFSET=16+(Og.MAT_PROJ_INV_OFFSET=16+(Og.MAT_PROJ_OFFSET=16+(Og.MAT_VIEW_INV_OFFSET=16+(Og.MAT_VIEW_OFFSET=0))))))))))))))))))),Og.NAME="CCCamera",Og.BINDING=Ag.UBO_CAMERA,Og.DESCRIPTOR=new is(Og.BINDING,oa.UNIFORM_BUFFER,1,Xo.ALL),Og.LAYOUT=new Fa(jg.GLOBAL,Og.BINDING,Og.NAME,[new Ba("cc_matView",Ro.MAT4,1),new Ba("cc_matViewInv",Ro.MAT4,1),new Ba("cc_matProj",Ro.MAT4,1),new Ba("cc_matProjInv",Ro.MAT4,1),new Ba("cc_matViewProj",Ro.MAT4,1),new Ba("cc_matViewProjInv",Ro.MAT4,1),new Ba("cc_cameraPos",Ro.FLOAT4,1),new Ba("cc_screenScale",Ro.FLOAT4,1),new Ba("cc_exposure",Ro.FLOAT4,1),new Ba("cc_mainLitDir",Ro.FLOAT4,1),new Ba("cc_mainLitColor",Ro.FLOAT4,1),new Ba("cc_ambientSky",Ro.FLOAT4,1),new Ba("cc_ambientGround",Ro.FLOAT4,1),new Ba("cc_fogColor",Ro.FLOAT4,1),new Ba("cc_fogBase",Ro.FLOAT4,1),new Ba("cc_fogAdd",Ro.FLOAT4,1),new Ba("cc_nearFar",Ro.FLOAT4,1),new Ba("cc_viewPort",Ro.FLOAT4,1)],1),Pg.layouts[Og.NAME]=Og.LAYOUT,Pg.bindings[Og.BINDING]=Og.DESCRIPTOR,Mg.SIZE=4*(Mg.COUNT=4+(Mg.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Mg.SHADOW_COLOR_OFFSET=4+(Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Mg.SHADOW_PROJ_INFO_OFFSET=4+(Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Mg.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Mg.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Mg.MAT_LIGHT_VIEW_OFFSET=16+(Mg.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Mg.NAME="CCShadow",Mg.BINDING=Ag.UBO_SHADOW,Mg.DESCRIPTOR=new is(Mg.BINDING,oa.UNIFORM_BUFFER,1,Xo.ALL),Mg.LAYOUT=new Fa(jg.GLOBAL,Mg.BINDING,Mg.NAME,[new Ba("cc_matLightPlaneProj",Ro.MAT4,1),new Ba("cc_matLightView",Ro.MAT4,1),new Ba("cc_matLightViewProj",Ro.MAT4,1),new Ba("cc_shadowInvProjDepthInfo",Ro.FLOAT4,1),new Ba("cc_shadowProjDepthInfo",Ro.FLOAT4,1),new Ba("cc_shadowProjInfo",Ro.FLOAT4,1),new Ba("cc_shadowNFLSInfo",Ro.FLOAT4,1),new Ba("cc_shadowWHPBInfo",Ro.FLOAT4,1),new Ba("cc_shadowLPNNInfo",Ro.FLOAT4,1),new Ba("cc_shadowColor",Ro.FLOAT4,1),new Ba("cc_planarNDInfo",Ro.FLOAT4,1)],1),Pg.layouts[Mg.NAME]=Mg.LAYOUT,Pg.bindings[Mg.BINDING]=Mg.DESCRIPTOR,Ag.SAMPLER_SHADOWMAP),c=new is(qg,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),Xp=new za(jg.GLOBAL,qg,"cc_shadowMap",Ro.SAMPLER2D,1),Xg=(Pg.layouts.cc_shadowMap=Xp,Pg.bindings[qg]=c,Ag.SAMPLER_ENVIRONMENT),y=new is(Xg,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),kd=new za(jg.GLOBAL,Xg,"cc_environment",Ro.SAMPLER_CUBE,1),Yg=(Pg.layouts.cc_environment=kd,Pg.bindings[Xg]=y,Ag.SAMPLER_DIFFUSEMAP),r=new is(Yg,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),o=new za(jg.GLOBAL,Yg,"cc_diffuseMap",Ro.SAMPLER_CUBE,1),Kg=(Pg.layouts.cc_diffuseMap=o,Pg.bindings[Yg]=r,Ag.SAMPLER_SPOT_LIGHTING_MAP),s=new is(Kg,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),S=new za(jg.GLOBAL,Kg,"cc_spotLightingMap",Ro.SAMPLER2D,1),Qg=(Pg.layouts.cc_spotLightingMap=S,Pg.bindings[Kg]=s,Ng.SIZE=4*(Ng.COUNT=4+(Ng.LIGHTINGMAP_UVPARAM=16+(Ng.MAT_WORLD_IT_OFFSET=16+(Ng.MAT_WORLD_OFFSET=0)))),Ng.NAME="CCLocal",Ng.BINDING=Rg.UBO_LOCAL,Ng.DESCRIPTOR=new is(Ng.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX|Xo.COMPUTE),Ng.LAYOUT=new Fa(jg.LOCAL,Ng.BINDING,Ng.NAME,[new Ba("cc_matWorld",Ro.MAT4,1),new Ba("cc_matWorldIT",Ro.MAT4,1),new Ba("cc_lightingMapUVParam",Ro.FLOAT4,1)],1),Ig.layouts[Ng.NAME]=Ng.LAYOUT,Ig.bindings[Ng.BINDING]=Ng.DESCRIPTOR,Lg.SIZE=4*(Lg.COUNT=4+(Lg.WORLD_BOUND_HALF_EXTENTS=4+(Lg.WORLD_BOUND_CENTER=0))),Lg.NAME="CCWorldBound",Lg.BINDING=Rg.UBO_LOCAL,Lg.DESCRIPTOR=new is(Lg.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX|Xo.COMPUTE),Lg.LAYOUT=new Fa(jg.LOCAL,Lg.BINDING,Lg.NAME,[new Ba("cc_worldBoundCenter",Ro.FLOAT4,1),new Ba("cc_worldBoundHalfExtents",Ro.FLOAT4,1)],1),Ig.layouts[Lg.NAME]=Lg.LAYOUT,Ig.bindings[Lg.BINDING]=Lg.DESCRIPTOR,"a_matWorld0"),Zg=(Bg.BATCHING_COUNT=10,Bg.MAT_WORLDS_OFFSET=0,Bg.SIZE=4*(Bg.COUNT=16*Bg.BATCHING_COUNT),Bg.NAME="CCLocalBatched",Bg.BINDING=Rg.UBO_LOCAL,Bg.DESCRIPTOR=new is(Bg.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX|Xo.COMPUTE),Bg.LAYOUT=new Fa(jg.LOCAL,Bg.BINDING,Bg.NAME,[new Ba("cc_matWorlds",Ro.MAT4,Bg.BATCHING_COUNT)],1),Ig.layouts[Bg.NAME]=Bg.LAYOUT,Ig.bindings[Bg.BINDING]=Bg.DESCRIPTOR,Fg.LIGHTS_PER_PASS=1,Fg.SIZE=4*(Fg.COUNT=(Fg.LIGHT_DIR_OFFSET=(Fg.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Fg.LIGHT_COLOR_OFFSET=(Fg.LIGHT_POS_OFFSET=0)+4*Fg.LIGHTS_PER_PASS)+4*Fg.LIGHTS_PER_PASS)+4*Fg.LIGHTS_PER_PASS)+4*Fg.LIGHTS_PER_PASS),Fg.NAME="CCForwardLight",Fg.BINDING=Rg.UBO_FORWARD_LIGHTS,Fg.DESCRIPTOR=new is(Fg.BINDING,oa.DYNAMIC_UNIFORM_BUFFER,1,Xo.FRAGMENT),Fg.LAYOUT=new Fa(jg.LOCAL,Fg.BINDING,Fg.NAME,[new Ba("cc_lightPos",Ro.FLOAT4,Fg.LIGHTS_PER_PASS),new Ba("cc_lightColor",Ro.FLOAT4,Fg.LIGHTS_PER_PASS),new Ba("cc_lightSizeRangeAngle",Ro.FLOAT4,Fg.LIGHTS_PER_PASS),new Ba("cc_lightDir",Ro.FLOAT4,Fg.LIGHTS_PER_PASS)],1),Ig.layouts[Fg.NAME]=Fg.LAYOUT,Ig.bindings[Fg.BINDING]=Fg.DESCRIPTOR,zg.LIGHTS_PER_PASS=10,Ug.SIZE=4*(Ug.COUNT=4+(Ug.JOINTS_TEXTURE_INFO_OFFSET=0)),Ug.NAME="CCSkinningTexture",Ug.BINDING=Rg.UBO_SKINNING_TEXTURE,Ug.DESCRIPTOR=new is(Ug.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX),Ug.LAYOUT=new Fa(jg.LOCAL,Ug.BINDING,Ug.NAME,[new Ba("cc_jointTextureInfo",Ro.FLOAT4,1)],1),Ig.layouts[Ug.NAME]=Ug.LAYOUT,Ig.bindings[Ug.BINDING]=Ug.DESCRIPTOR,kg.SIZE=4*(kg.COUNT=4+(kg.JOINTS_ANIM_INFO_OFFSET=0)),kg.NAME="CCSkinningAnimation",kg.BINDING=Rg.UBO_SKINNING_ANIMATION,kg.DESCRIPTOR=new is(kg.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX),kg.LAYOUT=new Fa(jg.LOCAL,kg.BINDING,kg.NAME,[new Ba("cc_jointAnimInfo",Ro.FLOAT4,1)],1),Ig.layouts[kg.NAME]=kg.LAYOUT,Ig.bindings[kg.BINDING]=kg.DESCRIPTOR,"a_jointAnimInfo"),Jg=(Gg.SIZE=4*(Gg.COUNT=360+(Gg.JOINTS_OFFSET=0)),Gg.NAME="CCSkinning",Gg.BINDING=Rg.UBO_SKINNING_TEXTURE,Gg.DESCRIPTOR=new is(Gg.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX),Gg.LAYOUT=new Fa(jg.LOCAL,Gg.BINDING,Gg.NAME,[new Ba("cc_joints",Ro.FLOAT4,90)],1),Ig.layouts[Gg.NAME]=Gg.LAYOUT,Ig.bindings[Gg.BINDING]=Gg.DESCRIPTOR,Hg.MAX_MORPH_TARGET_COUNT=60,Hg.OFFSET_OF_WEIGHTS=0,Hg.OFFSET_OF_VERTICES_COUNT=4+(Hg.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Hg.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Hg.MAX_MORPH_TARGET_COUNT)),Hg.COUNT_BASE_4_BYTES=4*Math.ceil(Hg.MAX_MORPH_TARGET_COUNT/4)+4,Hg.SIZE=4*Hg.COUNT_BASE_4_BYTES,Hg.NAME="CCMorph",Hg.BINDING=Rg.UBO_MORPH,Hg.DESCRIPTOR=new is(Hg.BINDING,oa.UNIFORM_BUFFER,1,Xo.VERTEX),Hg.LAYOUT=new Fa(jg.LOCAL,Hg.BINDING,Hg.NAME,[new Ba("cc_displacementWeights",Ro.FLOAT4,Hg.MAX_MORPH_TARGET_COUNT/4),new Ba("cc_displacementTextureInfo",Ro.FLOAT4,1)],1),Ig.layouts[Hg.NAME]=Hg.LAYOUT,Ig.bindings[Hg.BINDING]=Hg.DESCRIPTOR,Vg.NAME="CCUILocal",Vg.BINDING=Rg.UBO_UI_LOCAL,Vg.DESCRIPTOR=new is(Vg.BINDING,oa.DYNAMIC_UNIFORM_BUFFER,1,Xo.VERTEX),Vg.LAYOUT=new Fa(jg.LOCAL,Vg.BINDING,Vg.NAME,[new Ba("cc_local_data",Ro.FLOAT4,1)],1),Ig.layouts[Vg.NAME]=Vg.LAYOUT,Ig.bindings[Vg.BINDING]=Vg.DESCRIPTOR,Rg.SAMPLER_JOINTS),g=new is(Jg,oa.SAMPLER_TEXTURE,1,Xo.VERTEX),x=new za(jg.LOCAL,Jg,"cc_jointTexture",Ro.SAMPLER2D,1),$g=(Ig.layouts.cc_jointTexture=x,Ig.bindings[Jg]=g,Rg.SAMPLER_MORPH_POSITION),b=new is($g,oa.SAMPLER_TEXTURE,1,Xo.VERTEX),Gd=new za(jg.LOCAL,$g,"cc_PositionDisplacements",Ro.SAMPLER2D,1),ev=(Ig.layouts.cc_PositionDisplacements=Gd,Ig.bindings[$g]=b,Rg.SAMPLER_MORPH_NORMAL),Hd=new is(ev,oa.SAMPLER_TEXTURE,1,Xo.VERTEX),Xp=new za(jg.LOCAL,ev,"cc_NormalDisplacements",Ro.SAMPLER2D,1),tv=(Ig.layouts.cc_NormalDisplacements=Xp,Ig.bindings[ev]=Hd,Rg.SAMPLER_MORPH_TANGENT),c=new is(tv,oa.SAMPLER_TEXTURE,1,Xo.VERTEX),kd=new za(jg.LOCAL,tv,"cc_TangentDisplacements",Ro.SAMPLER2D,1),iv=(Ig.layouts.cc_TangentDisplacements=kd,Ig.bindings[tv]=c,Rg.SAMPLER_LIGHTMAP),y=new is(iv,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),o=new za(jg.LOCAL,iv,"cc_lightingMap",Ro.SAMPLER2D,1),r=(Ig.layouts.cc_lightingMap=o,Ig.bindings[iv]=y,Rg.SAMPLER_SPRITE),S=new is(r,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),s=new za(jg.LOCAL,r,"cc_spriteTexture",Ro.SAMPLER2D,1),nv=(Ig.layouts.cc_spriteTexture=s,Ig.bindings[r]=S,Rg.SAMPLER_REFLECTION),x=new is(nv,oa.SAMPLER_TEXTURE,1,Xo.FRAGMENT),g=new za(jg.LOCAL,nv,"cc_reflectionTexture",Ro.SAMPLER2D,1),rv=(Ig.layouts.cc_reflectionTexture=g,Ig.bindings[nv]=x,Rg.STORAGE_REFLECTION),Gd=new is(rv,oa.STORAGE_IMAGE,1,Xo.COMPUTE),b=new Ga(jg.LOCAL,rv,"cc_reflectionStorage",Ro.IMAGE2D,1);Ig.layouts.cc_reflectionStorage=b,Ig.bindings[rv]=Gd;var ov,av,sv,cv,lv,uv=Tg.makeMaskExclude([Tg.BitMask.UI_2D,Tg.BitMask.GIZMOS,Tg.BitMask.EDITOR,Tg.BitMask.SCENE_GIZMO,Tg.BitMask.PROFILER]),Xp=Tg.makeMaskExclude([Tg.BitMask.UI_2D,Tg.BitMask.PROFILER]),Hd=Tg.Enum.ALL;function hv(e){return e.hasFeature(Po.COLOR_FLOAT)&&e.hasFeature(Po.TEXTURE_FLOAT)&&!(e.gfxAPI===wo.WEBGL)}Rre("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Qp,PIPELINE_FLOW_FORWARD:t,PIPELINE_FLOW_SHADOW:n,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Cg},get RenderPriority(){return wg},globalDescriptorSetLayout:Pg,localDescriptorSetLayout:Ig,get PipelineGlobalBindings(){return Ag},get ModelLocalBindings(){return Rg},get SetIndex(){return jg},bindingMappingInfo:Wg,UBOGlobal:Dg,UBOCamera:Og,UBOShadow:Mg,UNIFORM_SHADOWMAP_BINDING:qg,UNIFORM_ENVIRONMENT_BINDING:Xg,UNIFORM_DIFFUSEMAP_BINDING:Yg,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Kg,UBOLocal:Ng,UBOWorldBound:Lg,INST_MAT_WORLD:Qg,UBOLocalBatched:Bg,UBOForwardLight:Fg,UBODeferredLight:zg,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Ug,UBOSkinningAnimation:kg,INST_JOINT_ANIM_INFO:Zg,UBOSkinning:Gg,UBOMorph:Hg,UBOUILocal:Vg,UNIFORM_JOINT_TEXTURE_BINDING:Jg,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:$g,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:ev,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:tv,UNIFORM_LIGHTMAP_TEXTURE_BINDING:iv,UNIFORM_SPRITE_TEXTURE_BINDING:r,UNIFORM_REFLECTION_TEXTURE_BINDING:nv,UNIFORM_REFLECTION_STORAGE_BINDING:rv,CAMERA_DEFAULT_MASK:uv,CAMERA_EDITOR_MASK:Xp,MODEL_ALWAYS_MASK:Hd,supportsHalfFloatTexture:function(e){return e.hasFeature(Po.COLOR_HALF_FLOAT)&&e.hasFeature(Po.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===wo.WEBGL)},supportsFloatTexture:hv})),(kd=ov=ov||{})[kd.VERTICAL=0]="VERTICAL",kd[kd.HORIZONTAL=1]="HORIZONTAL",(c=av=av||{})[c.ORTHO=0]="ORTHO",c[c.PERSPECTIVE=1]="PERSPECTIVE",(o=sv=sv||{})[o.F1_8=0]="F1_8",o[o.F2_0=1]="F2_0",o[o.F2_2=2]="F2_2",o[o.F2_5=3]="F2_5",o[o.F2_8=4]="F2_8",o[o.F3_2=5]="F3_2",o[o.F3_5=6]="F3_5",o[o.F4_0=7]="F4_0",o[o.F4_5=8]="F4_5",o[o.F5_0=9]="F5_0",o[o.F5_6=10]="F5_6",o[o.F6_3=11]="F6_3",o[o.F7_1=12]="F7_1",o[o.F8_0=13]="F8_0",o[o.F9_0=14]="F9_0",o[o.F10_0=15]="F10_0",o[o.F11_0=16]="F11_0",o[o.F13_0=17]="F13_0",o[o.F14_0=18]="F14_0",o[o.F16_0=19]="F16_0",o[o.F18_0=20]="F18_0",o[o.F20_0=21]="F20_0",o[o.F22_0=22]="F22_0",(y=cv=cv||{})[y.ISO100=0]="ISO100",y[y.ISO200=1]="ISO200",y[y.ISO400=2]="ISO400",y[y.ISO800=3]="ISO800",(s=lv=lv||{})[s.D1=0]="D1",s[s.D2=1]="D2",s[s.D4=2]="D4",s[s.D8=3]="D8",s[s.D15=4]="D15",s[s.D30=5]="D30",s[s.D60=6]="D60",s[s.D125=7]="D125",s[s.D250=8]="D250",s[s.D500=9]="D500",s[s.D1000=10]="D1000",s[s.D2000=11]="D2000",s[s.D4000=12]="D4000";var pv,_v,fv,dv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],mv=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],gv=[100,200,400,800],vv=new ce,yv=new ce,xv=new B,Sv=la.STENCIL<<1,bv=[],Tv=((S=Ev.prototype)._setWidth=function(e){this._width=e},S._setHeight=function(e){this._height=e},S._setScene=function(e){this._scene=e},S._updateAspect=function(e){void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e&&((e=this.window.swapchain)&&e.surfaceTransform||Ao.IDENTITY)%2&&(this._aspect=1/this._aspect),this._isProjDirty=!0},S._init=function(){},S.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=la.NONE,this.clearDepth=1,this.visibility=uv,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},S._destroy=function(){},S.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},S.attachToScene=function(e){this._enabled=!0,this._setScene(e)},S.detachFromScene=function(){this._enabled=!1,this._setScene(null)},S.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},S.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},S.syncCameraEditor=function(){},S.update=function(e){var t,i,n,r;void 0===e&&(e=!1),this._node&&(t=!1,(this._node.hasChangedFlags||e)&&(B.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),t=!0),e=(e=null==(e=this.window)?void 0:e.swapchain)&&e.surfaceTransform||Ao.IDENTITY,!this._isProjDirty&&this._curTransform===e||(this._curTransform=e,i=this._device.capabilities.clipSpaceSignY,this._proj===av.PERSPECTIVE?B.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===ov.VERTICAL,this._device.capabilities.clipSpaceMinZ,i,e):(n=this._orthoHeight*this._aspect,r=this._orthoHeight,B.ortho(this._matProj,-n,n,-r,r,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,i,e)),B.invert(this._matProjInv,this._matProj),this._isProjDirty=!(t=!0)),t&&(B.multiply(this._matViewProj,this._matProj,this._matView),B.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)))},S.setViewportInOrientedSpace=function(e){var t=e.x,i=e.width,n=e.height,r=this._device.capabilities.screenSpaceSignY<0?1-e.y-n:e.y,e=null==(e=this.window)?void 0:e.swapchain;switch(e&&e.surfaceTransform||Ao.IDENTITY){case Ao.ROTATE_90:this._viewport.x=1-r-n,this._viewport.y=t,this._viewport.width=n,this._viewport.height=i;break;case Ao.ROTATE_180:this._viewport.x=1-t-i,this._viewport.y=1-r-n,this._viewport.width=i,this._viewport.height=n;break;case Ao.ROTATE_270:this._viewport.x=r,this._viewport.y=1-t-i,this._viewport.width=n,this._viewport.height=i;break;case Ao.IDENTITY:this._viewport.x=t,this._viewport.y=r,this._viewport.width=i,this._viewport.height=n}this._orientedViewport.x=t,this._orientedViewport.y=r,this._orientedViewport.width=i,this._orientedViewport.height=n,this.resize(this.width,this.height)},S.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t,e=e||j.director.root.mainWindow;e&&(e.attachCamera(this),((t=(this.window=e).swapchain)&&t.surfaceTransform||Ao.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height))},S.detachCamera=function(){this._window&&this._window.detachCamera(this)},S.screenPointToRay=function(e,t,i){if(!this._node)return null;var n=this.width,r=this.height,o=this._orientedViewport.x*n,a=this._orientedViewport.y*r,n=this._orientedViewport.width*n,r=this._orientedViewport.height*r,s=this._proj===av.PERSPECTIVE,c=this._device.capabilities.clipSpaceSignY,l=wr[this._curTransform],t=(ce.set(vv,(t-o)/n*2-1,(i-a)/r*2-1,s?1:-1),vv.x),o=vv.y;return vv.x=t*l[0]+o*l[2]*c,vv.y=t*l[1]+o*l[3]*c,ce.transformMat4(s?vv:e.o,vv,this._matViewProjInv),s?(this._node.getWorldPosition(yv),fo.fromPoints(e,yv,vv)):ce.transformQuat(e.d,ce.FORWARD,this._node.worldRotation),e},S.screenToWorld=function(e,t){var i,n,r=this.width,o=this.height,a=this._orientedViewport.x*r,s=this._orientedViewport.y*o,r=this._orientedViewport.width*r,o=this._orientedViewport.height*o,c=this._device.capabilities.clipSpaceSignY,l=wr[this._curTransform];return this._proj===av.PERSPECTIVE?(ce.set(e,(t.x-a)/r*2-1,(t.y-s)/o*2-1,1),i=e.x,n=e.y,e.x=i*l[0]+n*l[2]*c,e.y=i*l[1]+n*l[3]*c,ce.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(vv),ce.lerp(e,vv,e,Un(this._nearClip/this._farClip,1,t.z))):(ce.set(e,(t.x-a)/r*2-1,(t.y-s)/o*2-1,2*t.z-1),i=e.x,n=e.y,e.x=i*l[0]+n*l[2]*c,e.y=i*l[1]+n*l[3]*c,ce.transformMat4(e,e,this._matViewProjInv)),e},S.worldToScreen=function(e,t){var i=this._device.capabilities.clipSpaceSignY,n=wr[this._curTransform],t=(ce.transformMat4(e,t,this._matViewProj),e.x),r=e.y,t=(e.x=t*n[0]+r*n[2]*i,e.y=t*n[1]+r*n[3]*i,this.width),r=this.height,n=this._orientedViewport.x*t,i=this._orientedViewport.y*r,t=this._orientedViewport.width*t,r=this._orientedViewport.height*r;return e.x=n+.5*(e.x+1)*t,e.y=i+.5*(e.y+1)*r,e.z=.5*e.z+.5,e},S.worldMatrixToScreen=function(e,t,i,n){B.multiply(e,this._matViewProj,t),B.multiply(e,bv[this._curTransform],e);t=i/2,i=n/2;return B.identity(xv),B.transform(xv,xv,ce.set(vv,t,i,0)),B.scale(xv,xv,ce.set(vv,t,i,1)),B.multiply(e,xv,e),e},S.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},S.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},e(Ev,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){J(8302),this.setViewportInOrientedSpace(e)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=dv[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=mv[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=gv[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),Ev),g=1024;function Ev(e){this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=ov.VERTICAL,this._fov=45*On,this._nearClip=1,this._farClip=1e3,this._clearColor=new Ca(.2,.2,.2,1),this._viewport=new qr(0,0,1,1),this._orientedViewport=new qr(0,0,1,1),this._curTransform=Ao.IDENTITY,this._isProjDirty=!0,this._matView=new B,this._matProj=new B,this._matProjInv=new B,this._matViewProj=new B,this._matViewProjInv=new B,this._frustum=new op,this._forward=new ce,this._position=new ce,this._priority=0,this._aperture=sv.F16_0,this._apertureValue=void 0,this._shutter=lv.D125,this._shutterValue=0,this._iso=cv.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=la.NONE,this._clearDepth=1,this._visibility=uv,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=dv[this._aperture],this._shutterValue=mv[this._shutter],this._isoValue=gv[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,bv.length||(e=e.capabilities.clipSpaceSignY,bv[Ao.IDENTITY]=new B(1,0,0,0,0,e),bv[Ao.ROTATE_90]=new B(0,1,0,0,-e,0),bv[Ao.ROTATE_180]=new B(-1,0,0,0,0,-e),bv[Ao.ROTATE_270]=new B(0,-1,0,0,e,0))}function Cv(e){return j.sys.hasFeature(j.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap}(x=pv=pv||{})[x.RGB565=W.R5G6B5]="RGB565",x[x.RGB5A1=W.RGB5A1]="RGB5A1",x[x.RGBA4444=W.RGBA4]="RGBA4444",x[x.RGB888=W.RGB8]="RGB888",x[x.RGB32F=W.RGB32F]="RGB32F",x[x.RGBA8888=W.RGBA8]="RGBA8888",x[x.RGBA32F=W.RGBA32F]="RGBA32F",x[x.A8=W.A8]="A8",x[x.I8=W.L8]="I8",x[x.AI8=W.LA8]="AI8",x[x.RGB_PVRTC_2BPPV1=W.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",x[x.RGBA_PVRTC_2BPPV1=W.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",x[x.RGB_A_PVRTC_2BPPV1=g++]="RGB_A_PVRTC_2BPPV1",x[x.RGB_PVRTC_4BPPV1=W.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",x[x.RGBA_PVRTC_4BPPV1=W.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",x[x.RGB_A_PVRTC_4BPPV1=+g]="RGB_A_PVRTC_4BPPV1",x[x.RGB_ETC1=W.ETC_RGB8]="RGB_ETC1",x[x.RGBA_ETC1=1026]="RGBA_ETC1",x[x.RGB_ETC2=W.ETC2_RGB8]="RGB_ETC2",x[x.RGBA_ETC2=W.ETC2_RGBA8]="RGBA_ETC2",x[x.RGBA_ASTC_4x4=W.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",x[x.RGBA_ASTC_5x4=W.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",x[x.RGBA_ASTC_5x5=W.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",x[x.RGBA_ASTC_6x5=W.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",x[x.RGBA_ASTC_6x6=W.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",x[x.RGBA_ASTC_8x5=W.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",x[x.RGBA_ASTC_8x6=W.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",x[x.RGBA_ASTC_8x8=W.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",x[x.RGBA_ASTC_10x5=W.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",x[x.RGBA_ASTC_10x6=W.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",x[x.RGBA_ASTC_10x8=W.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",x[x.RGBA_ASTC_10x10=W.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",x[x.RGBA_ASTC_12x10=W.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",x[x.RGBA_ASTC_12x12=W.ASTC_RGBA_12X12]="RGBA_ASTC_12x12",(b=_v=_v||{})[b.REPEAT=Go.WRAP]="REPEAT",b[b.CLAMP_TO_EDGE=Go.CLAMP]="CLAMP_TO_EDGE",b[b.MIRRORED_REPEAT=Go.MIRROR]="MIRRORED_REPEAT",b[b.CLAMP_TO_BORDER=Go.BORDER]="CLAMP_TO_BORDER",(Gd=fv=fv||{})[Gd.NONE=ko.NONE]="NONE",Gd[Gd.LINEAR=ko.LINEAR]="LINEAR",Gd[Gd.NEAREST=ko.POINT]="NEAREST";var wv,Av,Pv,Iv,Rv,Dv,Ov,Mv,Nv,Lv=Rre("ImageAsset",f("cc.ImageAsset")((l(Bv,Nv=P_),(r=Bv.prototype).reset=function(e){Cv(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},r.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Cv(this.data)&&this.data.close&&this.data.close(),Nv.prototype.destroy.call(this)},r._serialize=function(){},r._deserialize=function(e){for(var t="",t="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt),i=j.director.root?j.director.root.device:null,e=t.split("_"),n=Number.MAX_VALUE,r=this._format,o="",a=j.macro.SUPPORT_TEXTURE_FORMATS,s=ge(e);!(c=s()).done;){var c=c.value.split("@"),l=parseInt(c[0],void 0),l=Bv.extnames[l]||c[0],u=a.indexOf(l);-1!==u&&u<n&&(c=c[1]?parseInt(c[1]):this._format,(".astc"!==l||i&&i.hasFeature(Po.FORMAT_ASTC))&&(".pvr"!==l||i&&i.hasFeature(Po.FORMAT_PVRTC))&&(c!==pv.RGB_ETC1&&c!==pv.RGBA_ETC1||i&&i.hasFeature(Po.FORMAT_ETC1))&&(c!==pv.RGB_ETC2&&c!==pv.RGBA_ETC2||i&&i.hasFeature(Po.FORMAT_ETC2))&&(".webp"!==l||j.sys.hasFeature(j.sys.Feature.WEBP))&&(n=u,o=l,r=c))}o?(this._setRawAsset(o),this._format=r):J(3121)},r.initDefault=function(e){var t;Nv.prototype.initDefault.call(this,e),Bv._sharedPlaceHolderCanvas?this.reset(Bv._sharedPlaceHolderCanvas):(t=(e=document.createElement("canvas")).getContext("2d"),e.width=e.height=2,t.fillStyle="#ff00ff",t.fillRect(0,0,2,2),this.reset(e),Bv._sharedPlaceHolderCanvas=e)},r.validate=function(){return!!this.data},e(Bv,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Cv(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Cv(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=pv.RGB_ETC1&&this._format<=pv.RGBA_ASTC_12x12||this._format>=pv.RGB_A_PVRTC_2BPPV1&&this._format<=pv.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),Hd=Xp=Bv,Xp.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Xp._sharedPlaceHolderCanvas=null,i((kd=Hd).prototype,"_nativeAsset",[Gp],Object.getOwnPropertyDescriptor(kd.prototype,"_nativeAsset"),kd.prototype),c=kd))||c);function Bv(e){var t;return(t=Nv.call(this)||this)._nativeData=void 0,t._exportedExts=void 0,t._format=pv.RGBA8888,t._width=0,t._height=0,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&t.reset(e),t}j.ImageAsset=Lv,Lt(W);var Fv,zv=new Ce("Tex"),Uv=f("cc.TextureBase")((l(kv,Fv=P_),(o=kv.prototype).getId=function(){return this._id},o.getPixelFormat=function(){return this._format},o.getAnisotropy=function(){return this._anisotropy},o.setWrapMode=function(e,t,i){void 0===i&&(i=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},o.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},o.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},o.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},o.destroy=function(){var e,t=Fv.prototype.destroy.call(this);return t&&null!=(e=j.director.root)&&e.batcher2D&&j.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t},o.getHash=function(){return this._textureHash},o.getGFXTexture=function(){return null},o.getSamplerInfo=function(){return this._samplerInfo},o.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):ee(9302)),this._gfxSampler},o._serialize=function(){return""},o._deserialize=function(e){e=e.split(",");e.unshift(""),5<=e.length&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),7<=e.length&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},o._getGFXDevice=function(){return j.director.root?j.director.root.device:null},o._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},o._setGFXFormat=function(e){this._format=void 0===e?pv.RGBA8888:e},o._getGFXPixelFormat=function(e){return e===pv.RGBA_ETC1?e=pv.RGB_ETC1:e===pv.RGB_A_PVRTC_4BPPV1?e=pv.RGB_PVRTC_4BPPV1:e===pv.RGB_A_PVRTC_2BPPV1&&(e=pv.RGB_PVRTC_2BPPV1),e},e(kv,[{key:"isCompressed",get:function(){return this._format>=pv.RGB_ETC1&&this._format<=pv.RGBA_ASTC_12x12||this._format>=pv.RGB_A_PVRTC_2BPPV1&&this._format<=pv.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),s=y=kv,y.PixelFormat=pv,y.WrapMode=_v,y.Filter=fv,wv=i((S=s).prototype,"_format",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pv.RGBA8888}}),Av=i(S.prototype,"_minFilter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fv.LINEAR}}),Pv=i(S.prototype,"_magFilter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fv.LINEAR}}),Iv=i(S.prototype,"_mipFilter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fv.NONE}}),Rv=i(S.prototype,"_wrapS",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _v.REPEAT}}),Dv=i(S.prototype,"_wrapT",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _v.REPEAT}}),Ov=i(S.prototype,"_wrapR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _v.REPEAT}}),Mv=i(S.prototype,"_anisotropy",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g=S))||g;function kv(){var e;return _(e=Fv.call(this)||this,"_format",wv,p(e)),_(e,"_minFilter",Av,p(e)),_(e,"_magFilter",Pv,p(e)),_(e,"_mipFilter",Iv,p(e)),_(e,"_wrapS",Rv,p(e)),_(e,"_wrapT",Dv,p(e)),_(e,"_wrapR",Ov,p(e)),_(e,"_anisotropy",Mv,p(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new La,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=zv.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=Gc(e._id,666),e}j.TextureBase=Uv;var Gv=new WeakMap,Hv=new WeakSet,Vv=new WeakSet;function jv(e,t){var i,n=K_.safeFindClass,r=Af.pool.get();try{i=kf(e,r,{classFinder:n,customEnv:t})}catch(e){throw tt(e),Af.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:m_(h),owner:a[u],prop:s[u],type:gt._getClassById(c[u])}}return Gv.set(i,l),i._native&&Hv.add(i),Af.pool.put(r),i}(x=Xv.prototype).init=function(){this._depends.clear()},x.getNativeDep=function(e){e=this._depends.get(e);return e&&e.nativeDep?ue({},e.nativeDep):null},x.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},x.getDepsRecursively=function(e){var t=Object.create(null),i=[];return this._descend(e,t,i),i},x.remove=function(e){this._depends.remove(e)},x.parse=function(e,t){var i,n=null;if(Array.isArray(t)||t.__type__||t instanceof lf){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(i=t[5])[i.length-1])&&i<0)try{var r=jv(t,{__uuid__:e});(n=this._parseDepsFromAsset(r)).nativeDep&&(n.nativeDep.uuid=e),r_.add(e+"@import",r)}catch(t){n_.remove(e+"@import"),n={deps:[]}}else n={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(n=this._depends.get(e)).parsedFromExistAsset)return n;n=this._parseDepsFromAsset(t)}return this._depends.add(e,n),n},x._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},i=Gv.get(e),n=0,r=i.length;n<r;n++)t.deps.push(i[n].uuid);return Hv.has(e)&&(t.nativeDep=e._nativeDep),t},x._parseDepsFromJson=function(e){t=e[1];var t,i=e[10].map(function(e){return t[e]});return i.forEach(function(e,t){return i[t]=m_(e)}),i},x._descend=function(e,t,i){for(var n=this.getDeps(e),r=0;r<n.length;r++){var o=n[r];t[o]||(t[o]=!0,i.push(o),this._descend(o,t,i))}};var Wv=new Xv,qv=[new Ta];function Xv(){this._depends=new Zp}function Yv(e){return e&&0==(e&e-1)}var Kv,Qv,r=f("cc.SimpleTexture")((l(Zv,Qv=Uv),(b=Zv.prototype).getGFXTexture=function(){return this._gfxTexture},b.destroy=function(){return this._tryDestroyTexture(),Qv.prototype.destroy.call(this)},b.updateImage=function(){this.updateMipmaps(0)},b.updateMipmaps=function(){},b.uploadData=function(e,t,i){var n,r;void 0===t&&(t=0),void 0===i&&(i=0),!this._gfxTexture||this._mipmapLevel<=t||(n=this._getGFXDevice())&&((r=qv[0]).texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,qv):n.copyTexImagesToTexture([e],this._gfxTexture,qv))},b._assignImage=function(e,t,i){var n=e.data;n&&(this.uploadData(n,t,i),this._checkTextureLoaded(),zt.CLEANUP_IMAGE_CACHE)&&(-1!==(t=(n=Wv.getDeps(this._uuid)).indexOf(e._uuid))&&(Se(n,t),e.decRef()))},b._checkTextureLoaded=function(){this._textureReady()},b._textureReady=function(){this.loaded=!0,this.emit("load")},b._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},b._getGfxTextureCreateInfo=function(){return null},b._tryReset=function(){var e;this._tryDestroyTexture(),0!==this._mipmapLevel&&(e=this._getGFXDevice())&&this._createTexture(e)},b._createTexture=function(e){var t,i,n;0!==this._width&&0!==this._height&&(t=Fo.NONE,this._mipFilter!==fv.NONE&&(i=this._width,n=this._height,e.gfxAPI!==wo.WEBGL||Yv(i)&&Yv(n))&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=Fo.GEN_MIPMAP),(i=this._getGfxTextureCreateInfo({usage:Bo.SAMPLED|Bo.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t}))&&(n=e.createTexture(i),this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n))},b._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},e(Zv,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),Gd=Zv))||Gd;function Zv(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=Qv.call.apply(Qv,[this].concat(i))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}j.SimpleTexture=r;var Jv,$v,e0,t0,i0=Rre("Texture2D",(Xp=f("cc.Texture2D"),Hd=v([Lv]),Xp((l(n0,t0=r),(kd=n0.prototype).initialize=function(){this.mipmaps=this._mipmaps},kd.onLoaded=function(){this.initialize()},kd.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},kd.create=function(e,t,i,n){void 0===i&&(i=pv.RGBA8888),this.reset({width:e,height:t,format:i,mipmapLevel:n=void 0===n?1:n})},kd.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},kd.updateMipmaps=function(e,t){if(!((e=void 0===e?0:e)>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}},kd.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},kd.destroy=function(){return this._mipmaps=[],t0.prototype.destroy.call(this)},kd.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},kd.releaseTexture=function(){this.destroy()},kd._serialize=function(){return null},kd._deserialize=function(e,t){var i=e;t0.prototype._deserialize.call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n,r=0;r<i.mipmaps.length;++r)this._mipmaps[r]=new Lv,i.mipmaps[r]&&(n=i.mipmaps[r],t.result.push(this._mipmaps,""+r,n,gt._getClassId(Lv)))},kd._getGfxTextureCreateInfo=function(e){var t=new Na(Lo.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},kd.initDefault=function(e){t0.prototype.initDefault.call(this,e);e=new Lv;e.initDefault(),this.image=e},kd.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},e(n0,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length?(e=this._mipmaps[0],this.reset({width:e.width,height:e.height,format:e.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})):this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),Kv=i((c=n0).prototype,"_mipmaps",[Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o=c))||o));function n0(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=t0.call.apply(t0,[this].concat(i))||this,"_mipmaps",Kv,p(e)),e}j.Texture2D=i0,(y=e0=e0||{})[y.right=0]="right",y[y.left=1]="left",y[y.top=2]="top",y[y.bottom=3]="bottom",y[y.front=4]="front",y[y.back=5]="back";var r0,o0=Rre("TextureCube",f("cc.TextureCube")((l(a0,r0=r),a0.fromTexture2DArray=function(e,t){for(var i=[],n=e.length/6,r=0;r<n;r++){var o=6*r;i.push({front:e[o+e0.front].image,back:e[o+e0.back].image,left:e[o+e0.left].image,right:e[o+e0.right].image,top:e[o+e0.top].image,bottom:e[o+e0.bottom].image})}return(t=t||new a0).mipmaps=i,t},(s=a0.prototype).onLoaded=function(){this.mipmaps=this._mipmaps},s.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},s.updateMipmaps=function(t,e){var n=this;if(!((t=void 0===t?0:t)>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=0;r<i;++r)!function(e){var i=t+e;s0(n._mipmaps[i],function(e,t){n._assignImage(e,i,t)})}(r)},s.destroy=function(){return this._mipmaps=[],r0.prototype.destroy.call(this)},s.releaseTexture=function(){this.mipmaps=[]},s._serialize=function(){return null},s._deserialize=function(e,t){var i=e;r0.prototype._deserialize.call(this,i.base,t),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]={front:new Lv,back:new Lv,left:new Lv,right:new Lv,top:new Lv,bottom:new Lv};var r=i.mipmaps[n],o=gt._getClassId(Lv);t.result.push(this._mipmaps[n],"front",r.front,o),t.result.push(this._mipmaps[n],"back",r.back,o),t.result.push(this._mipmaps[n],"left",r.left,o),t.result.push(this._mipmaps[n],"right",r.right,o),t.result.push(this._mipmaps[n],"top",r.top,o),t.result.push(this._mipmaps[n],"bottom",r.bottom,o)}},s._getGfxTextureCreateInfo=function(e){var t=new Na(Lo.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},s.initDefault=function(e){r0.prototype.initDefault.call(this,e);e=new Lv;e.initDefault(),this.mipmaps=[{front:e,back:e,top:e,bottom:e,left:e,right:e}]},s.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find(function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)})},e(a0,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var n=this;this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),0<this._mipmaps.length?(e=this._mipmaps[0].front,this.reset({width:e.width,height:e.height,format:e.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){s0(e,function(e,t){n._assignImage(e,i,t)})})):this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),a0.FaceIndex=e0,Jv=i((S=a0).prototype,"isRGBE",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$v=i(S.prototype,"_mipmaps",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),g=S))||g);function a0(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=r0.call.apply(r0,[this].concat(i))||this,"isRGBE",Jv,p(e)),_(e,"_mipmaps",$v,p(e)),e}function s0(e,t){t(e.front,e0.front),t(e.back,e0.back),t(e.left,e0.left),t(e.right,e0.right),t(e.top,e0.top),t(e.bottom,e0.bottom)}j.TextureCube=o0;function c0(e,t,i,n){return t<<26&d0|e<<20&66060288|i<<12&1044480|4095&(n=void 0===n?0:n)}function l0(e){return(e&d0)>>>26}function u0(e){return(66060288&e)>>>20}function h0(e){return(1044480&e)>>>12}function p0(e){return 4095&e}function _0(e,t){return 67108863&e|t<<26&d0}var f0=Rre("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2766437914,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite-gpu",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",hash:2450198964,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCUILocal",defines:[]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_batch_id",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2672216600,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3653711100,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),d0=4227858432,m0=((x={})[Ro.UNKNOWN]=function(){return console.warn("illegal uniform handle")},x[Ro.INT]=function(e,t,i){return e[i=void 0===i?0:i]},x[Ro.INT2]=function(e,t,i){return U.fromArray(t,e,i=void 0===i?0:i)},x[Ro.INT3]=function(e,t,i){return ce.fromArray(t,e,i=void 0===i?0:i)},x[Ro.INT4]=function(e,t,i){return Fr.fromArray(t,e,i=void 0===i?0:i)},x[Ro.FLOAT]=function(e,t,i){return e[i=void 0===i?0:i]},x[Ro.FLOAT2]=function(e,t,i){return U.fromArray(t,e,i=void 0===i?0:i)},x[Ro.FLOAT3]=function(e,t,i){return ce.fromArray(t,e,i=void 0===i?0:i)},x[Ro.FLOAT4]=function(e,t,i){return Fr.fromArray(t,e,i=void 0===i?0:i)},x[Ro.MAT3]=function(e,t,i){return pr.fromArray(t,e,i=void 0===i?0:i)},x[Ro.MAT4]=function(e,t,i){return B.fromArray(t,e,i=void 0===i?0:i)},x),g0=((b={})[Ro.UNKNOWN]=function(){return console.warn("illegal uniform handle")},b[Ro.INT]=function(e,t,i){return e[i=void 0===i?0:i]=t},b[Ro.INT2]=function(e,t,i){return U.toArray(e,t,i=void 0===i?0:i)},b[Ro.INT3]=function(e,t,i){return ce.toArray(e,t,i=void 0===i?0:i)},b[Ro.INT4]=function(e,t,i){return Fr.toArray(e,t,i=void 0===i?0:i)},b[Ro.FLOAT]=function(e,t,i){return e[i=void 0===i?0:i]=t},b[Ro.FLOAT2]=function(e,t,i){return U.toArray(e,t,i=void 0===i?0:i)},b[Ro.FLOAT3]=function(e,t,i){return ce.toArray(e,t,i=void 0===i?0:i)},b[Ro.FLOAT4]=function(e,t,i){return Fr.toArray(e,t,i=void 0===i?0:i)},b[Ro.MAT3]=function(e,t,i){return pr.toArray(e,t,i=void 0===i?0:i)},b[Ro.MAT4]=function(e,t,i){return B.toArray(e,t,i=void 0===i?0:i)},b),v0=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function y0(e){switch(e){case Ro.BOOL:case Ro.INT:case Ro.UINT:case Ro.FLOAT:return v0[0];case Ro.BOOL2:case Ro.INT2:case Ro.UINT2:case Ro.FLOAT2:return v0[1];case Ro.BOOL4:case Ro.INT4:case Ro.UINT4:case Ro.FLOAT4:return v0[2];case Ro.MAT4:return v0[3];case Ro.SAMPLER2D:return"default-texture";case Ro.SAMPLER_CUBE:return"default-cube-texture"}return v0[0]}function x0(e,t){for(var i=Object.entries(t),n=!1,r=0;r<i.length;r++)e[i[r][0]]!==i[r][1]&&(e[i[r][0]]=i[r][1],n=!0);return n}var S0=new ns;function b0(e){return Math.ceil(Math.log2(Math.max(e,2)))}function T0(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=0;s<o.blocks.length;s++)!function(e){var e=o.blocks[e],t=n.layouts[e.name],i=t&&n.bindings.find(function(e){return e.binding===t.binding});if(!(t&&i&&i.descriptorType&mc))return console.warn("builtin UBO '"+e.name+"' not available!");a.push(t),r&&!r.includes(i)&&r.push(i)}(s);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var c=[],l=0;l<o.samplerTextures.length;l++)!function(e){var e=o.samplerTextures[e],t=n.layouts[e.name],i=t&&n.bindings.find(function(e){return e.binding===t.binding});if(!(t&&i&&i.descriptorType&gc))return console.warn("builtin samplerTexture '"+e.name+"' not available!");c.push(t),r&&!r.includes(i)&&r.push(i)}(l);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,c),r&&r.sort(function(e,t){return e.binding-t.binding})}function E0(e){switch(e.gfxAPI){case wo.GLES2:case wo.WEBGL:return"glsl1";case wo.GLES3:case wo.WEBGL2:return"glsl3";default:return"glsl4"}}(Gd=w0.prototype).register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var i=0;i<e.techniques.length;i++)for(var n=e.techniques[i],r=0;r<n.passes.length;r++){var o=n.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=n.passes[o.propertyIndex].properties)}},Gd.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var i,n=ue({},e),r=0,o=0;o<n.defines.length;o++)!function(e){var t,i=n.defines[e],e=1;"number"===i.type?(e=b0((t=i.range)[1]-t[0]+1),i._map=function(e){return e-t[0]}):"string"===i.type?(e=b0(i.options.length),i._map=function(t){return Math.max(0,i.options.findIndex(function(e){return e===t}))}):"boolean"===i.type&&(i._map=function(e){return e?1:0}),i._offset=r,r+=e}(o);for(i in 31<r&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+i+" "+n.builtins.statistics[i]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var a={};a.samplerStartBinding=n.blocks.length,a.shaderInfo=new qa,a.blockSizes=[],a.bindings=[];for(var s=0;s<n.blocks.length;s++){var c=n.blocks[s];a.blockSizes.push(c.members.reduce(function(e,t){return e+Tc(t.type)*t.count},0)),a.bindings.push(new is(c.binding,oa.UNIFORM_BUFFER,1,c.stageFlags)),a.shaderInfo.blocks.push(new Fa(jg.MATERIAL,c.binding,c.name,c.members.map(function(e){return new Ba(e.name,e.type,e.count)}),1))}for(var l=0;l<n.samplerTextures.length;l++){var u=n.samplerTextures[l];a.bindings.push(new is(u.binding,oa.SAMPLER_TEXTURE,u.count,u.stageFlags)),a.shaderInfo.samplerTextures.push(new za(jg.MATERIAL,u.binding,u.name,u.type,u.count))}for(var h=0;h<n.samplers.length;h++){var p=n.samplers[h];a.bindings.push(new is(p.binding,oa.SAMPLER,p.count,p.stageFlags)),a.shaderInfo.samplers.push(new Ua(jg.MATERIAL,p.binding,p.name,p.count))}for(var _=0;_<n.textures.length;_++){var f=n.textures[_];a.bindings.push(new is(f.binding,oa.TEXTURE,f.count,f.stageFlags)),a.shaderInfo.textures.push(new ka(jg.MATERIAL,f.binding,f.name,f.type,f.count))}for(var d=0;d<n.buffers.length;d++){var m=n.buffers[d];a.bindings.push(new is(m.binding,oa.STORAGE_BUFFER,1,m.stageFlags)),a.shaderInfo.buffers.push(new Ha(jg.MATERIAL,m.binding,m.name,1,m.memoryAccess))}for(var g=0;g<n.images.length;g++){var v=n.images[g];a.bindings.push(new is(v.binding,oa.STORAGE_IMAGE,v.count,v.stageFlags)),a.shaderInfo.images.push(new Ga(jg.MATERIAL,v.binding,v.name,v.type,v.count,v.memoryAccess))}for(var y=0;y<n.subpassInputs.length;y++){var x=n.subpassInputs[y];a.bindings.push(new is(x.binding,oa.INPUT_ATTACHMENT,x.count,x.stageFlags)),a.shaderInfo.subpassInputs.push(new Va(jg.MATERIAL,x.binding,x.name,x.count))}a.gfxAttributes=[];for(var S=0;S<n.attributes.length;S++){var b=n.attributes[S];a.gfxAttributes.push(new Wa(b.name,b.format,b.isNormalized,0,b.isInstanced,b.location))}T0(n,a,Ig,"locals"),a.shaderInfo.stages.push(new ja(Xo.VERTEX,"")),a.shaderInfo.stages.push(new ja(Xo.FRAGMENT,"")),a.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=c0(n.binding,s.type,s.count,o),o+=(Tc(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=c0(l.binding,l.type,l.count)}return t}(n),a.setLayouts=[],this._templateInfos[n.hash]=a}return n},Gd.getTemplate=function(e){return this._templates[e]},Gd.getTemplateInfo=function(e){e=this._templates[e].hash;return this._templateInfos[e]},Gd.getDescriptorSetLayout=function(e,t,i){void 0===i&&(i=!1);t=this._templates[t],t=this._templateInfos[t.hash];return t.setLayouts.length||(S0.bindings=t.bindings,t.setLayouts[jg.MATERIAL]=e.createDescriptorSetLayout(S0),S0.bindings=Ig.bindings,t.setLayouts[jg.LOCAL]=e.createDescriptorSetLayout(S0)),t.setLayouts[i?jg.LOCAL:jg.MATERIAL]},Gd.hasProgram=function(e){return void 0!==this._templates[e]},Gd.getKey=function(e,t){var e=this._templates[e],i=e.defines;if(e.uber){for(var n="",r=0;r<i.length;r++){var o=i[r],a=t[o.name];a&&o._map&&(a=o._map(a),n+=""+o._offset+a+"|")}return""+n+e.hash}for(var s=0,c=0;c<i.length;c++){var l=i[c],u=t[l.name];u&&l._map&&(s|=l._map(u)<<l._offset)}return s.toString(16)+"|"+e.hash},Gd.destroyShaderByDefines=function(i){var n=this,e=Object.keys(i);if(e.length)for(var r=e.map(function(e){var t=i[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(""+e+t)}),t=Object.keys(this._cache).filter(function(t){return r.every(function(e){return e.test(n._cache[t].name)})}),o=0;o<t.length;o++){var a=t[o],s=this._cache[a];fe("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},Gd.getGFXShader=function(e,t,i,n,r){Object.assign(i,n.macros),r=r||this.getKey(t,i);var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash],o=(s.pipelineLayout||(this.getDescriptorSetLayout(e,t),T0(a,s,Pg,"globals"),s.setLayouts[jg.GLOBAL]=n.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new os(s.setLayouts))),function(e,t){for(var i=[],n=0;n<t.length;n++){var r=t[n],o=r.name,a=e[o],r=function(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0]).toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}(r,a);i.push({name:o,value:r,isDefault:!a||"0"===a})}return i}(i,a.defines)),n=n.constantMacros+a.constantMacros+o.reduce(function(e,t){return e+"#define "+t.name+" "+t.value+"\n"},""),c=a.glsl3,l=E0(e);return l?c=a[l]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=n+c.vert,s.shaderInfo.stages[1].source=n+c.frag,s.shaderInfo.attributes=function(e){for(var t=[],i=a.attributes,n=s.gfxAttributes,r=0;r<i.length;r++)!function(e,t){for(var i=0;i<e.length;i++){var n=e[i];if("!"===n[0]){if(t[n.slice(1)])return}else if(!t[n])return}return 1}(i[r].defines,e)||t.push(n[r]);return t}(i),s.shaderInfo.name=t+o.reduce(function(e,t){return t.isDefault?e:e+"|"+t.name+t.value},""),this._cache[r]=e.createShader(s.shaderInfo)};var C0=new w0;function w0(){this._templates={},this._cache={},this._templateInfos={}}j.programLib=C0;var A0,P0,I0,R0={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute float a_batch_id;\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nuniform vec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nvarying vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * max(0.02, 0.001 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.02)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec2 a_texCoord;\nin float a_batch_id;\nout vec2 v_uv0;\nout float v_uvMode;\nout vec4 v_uvSizeOffset;\nout vec4 v_uvParams0;\nout vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nlayout(std140) uniform CCUILocal {\nvec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\n};\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nout vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\nin vec2 v_uv0;\nin float v_uvMode;\nin vec4 v_uvSizeOffset;\nin vec4 v_uvParams0;\nin vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * max(0.02, 0.001 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.02)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},kd=((Xp=k0.prototype).initBuiltinRes=function(e){var t=this;this._device=e;for(var i=this._resources,n=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)n[c]=0,n[c+1]=0,n[c+2]=0,n[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;for(var u=new Uint8Array(1024),c=0,h=0;h<256;h++)u[c]=221,u[c+1]=221,u[c+2]=221,u[c+3]=255,c+=4;for(var p=c=0;p<8;p++){for(var _=0;_<8;_++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}c+=32;for(var f=0;f<8;f++){for(var d=0;d<8;d++)u[c]=85,u[c+1]=85,u[c+2]=85,u[c+3]=255,c+=4;c+=32}var m={width:2,height:2,_data:n,_compressed:!1,format:i0.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:i0.PixelFormat.RGBA8888},v={width:2,height:2,_data:o,_compressed:!1,format:i0.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:i0.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:i0.PixelFormat.RGBA8888},S={width:16,height:16,_data:u,_compressed:!1,format:i0.PixelFormat.RGBA8888},b=new Lv(m),T=new i0,T=(T._uuid="black-texture",T.image=b,i[T._uuid]=T,new Lv(g)),g=new i0,T=(g._uuid="empty-texture",g.image=T,i[g._uuid]=g,new o0),g=(T._uuid="black-cube-texture",T.setMipFilter(o0.Filter.NEAREST),T.image={front:new Lv(m),back:new Lv(m),left:new Lv(m),right:new Lv(m),top:new Lv(m),bottom:new Lv(m)},i[T._uuid]=T,new Lv(v)),m=new i0,T=(m._uuid="grey-texture",m.image=g,i[m._uuid]=m,new Lv(y)),v=new i0,g=(v._uuid="white-texture",v.image=T,i[v._uuid]=v,new o0),m=(g._uuid="white-cube-texture",g.setMipFilter(o0.Filter.NEAREST),g.image={front:new Lv(y),back:new Lv(y),left:new Lv(y),right:new Lv(y),top:new Lv(y),bottom:new Lv(y)},i[g._uuid]=g,new Lv(x)),T=new i0,v=(T._uuid="normal-texture",T.image=m,i[T._uuid]=T,new Lv(S)),y=new i0,g=(y._uuid="default-texture",y.image=v,i[y._uuid]=y,new o0),E=(g.setMipFilter(o0.Filter.NEAREST),g._uuid="default-cube-texture",g.image={front:new Lv(S),back:new Lv(S),left:new Lv(S),right:new Lv(S),top:new Lv(S),bottom:new Lv(S)},i[g._uuid]=g,j.SpriteFrame&&(x=new j.SpriteFrame,m=b,(T=new i0).image=m,x.texture=T,x._uuid="default-spriteframe",i[x._uuid]=x),E0(e));if(!E)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var C=R0[E];return C?Promise.resolve().then(function(){f0.forEach(function(e,i){e=Object.assign(new j.EffectAsset,e);e.shaders.forEach(function(e,t){t=C[i][t];t&&(e[E]=t)}),e.hideInEditor=!0,e.onLoaded()}),t._initMaterials()}):Promise.reject(Error("Current device is requiring builtin shaders of version "+E+" but shaders of that version are not assembled in this build."))},Xp.get=function(e){return this._resources[e]},Xp._initMaterials=function(){var e=this._resources,n=[],t=new j.Material,t=(t._uuid="standard-material",t.initialize({effectName:"standard"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="missing-effect-material",t.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),t.setProperty("mainColor",j.color("#ffff00")),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="missing-material",t.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),t.setProperty("mainColor",j.color("#ff00ff")),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="default-clear-stencil",t.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-base-material",t.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-sprite-material",t.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-alpha-test-material",t.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-sprite-gray-material",t.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-sprite-alpha-sep-material",t.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-sprite-gray-alpha-sep-material",t.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="ui-graphics-material",t.initialize({effectName:"graphics"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="default-particle-material",t.initialize({effectName:"particle"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="default-particle-gpu-material",t.initialize({effectName:"particle-gpu"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="default-trail-material",t.initialize({effectName:"particle-trail"}),e[t._uuid]=t,n.push(t),new j.Material),t=(t._uuid="default-billboard-material",t.initialize({effectName:"billboard"}),e[t._uuid]=t,n.push(t),new j.Material);t._uuid="default-spine-material",t.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[t._uuid]=t,n.push(t),j.game.on(j.Game.EVENT_GAME_INITED,function(){for(var e=0;e<n.length;++e)for(var t=n[e],i=0;i<t.passes.length;++i)t.passes[i].tryCompile()})},k0),D0=Rre("builtinResMgr",j.builtinResMgr=new kd),O0=Rre("getPhaseID",(A0=new Map,P0=0,function(e){return"number"==typeof e?e:(A0.has(e)||(A0.set(e,1<<P0),P0++),A0.get(e))})),M0=Rre("InstancedBuffer",((Hd=U0.prototype).destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},Hd.merge=function(e,t,i,n){void 0===n&&(n=null);var r=t.buffer.length;if(r){for(var o=e.inputAssembler,a=e.descriptorSet.getTexture(iv),s=(s=n)||e.shaders[i],c=e.descriptorSet,l=0;l<this.instances.length;++l){var u,h,p=this.instances[l];if(!(p.ia.indexBuffer!==o.indexBuffer||1024<=p.count)&&p.lightingMap===a&&p.stride===r)return p.count>=p.capacity&&(p.capacity<<=1,u=p.stride*p.capacity,h=p.data,p.data=new Uint8Array(u),p.data.set(h),p.vb.resize(u)),p.shader!==s&&(p.shader=s),p.descriptorSet!==c&&(p.descriptorSet=c),p.data.set(t.buffer,p.stride*p.count++),void(this.hasPendingModels=!0)}for(var n=this._device.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,32*r,r)),i=new Uint8Array(32*r),_=o.vertexBuffers.slice(),f=o.attributes.slice(),e=o.indexBuffer,d=0;d<t.attributes.length;d++){var m=t.attributes[d],m=new Wa(m.name,m.format,m.isNormalized,_.length,!0);f.push(m)}i.set(t.buffer),_.push(n);e=new Xa(f,_,e),e=this._device.createInputAssembler(e);this.instances.push({count:1,capacity:32,vb:n,data:i,ia:e,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},Hd.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}},Hd.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},U0)),N0=((c=z0.prototype).destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},c.merge=function(e,t,i){var n=e.subMesh.flatBuffers;if(0!==n.length){for(var r,o=n[0].count,a=e.passes[t],s=e.shaders[t],c=e.descriptorSet,l=!1,u=0;u<this.batches.length;++u){var h=this.batches[u];if(h.vbs.length===n.length&&h.mergeCount<Bg.BATCHING_COUNT){for(var l=!0,p=0;p<h.vbs.length;++p)if(h.vbs[p].stride!==n[p].stride){l=!1;break}if(l){for(var _=0;_<h.vbs.length;++_){var f=n[_],d=h.vbs[_],m=h.vbDatas[_];(r=(o+h.vbCount)*f.stride)>d.size&&(d.resize(r),h.vbDatas[_]=new Uint8Array(r),h.vbDatas[_].set(m)),h.vbDatas[_].set(f.buffer,h.vbCount*f.stride)}var g=h.vbIdxData,v=((v=4*(o+h.vbCount))>h.vbIdx.size&&(h.vbIdx.resize(v),h.vbIdxData=new Float32Array(v/Float32Array.BYTES_PER_ELEMENT),h.vbIdxData.set(g),g=h.vbIdxData),h.vbCount),y=v+o,x=h.mergeCount;if(g[v]!==x||g[y-1]!==x)for(var S=v;S<y;S++)g[S]=x+.1;return B.toArray(h.uboData,i.transform.worldMatrix,Bg.MAT_WORLDS_OFFSET+16*h.mergeCount),h.mergeCount||(c.bindBuffer(Bg.BINDING,h.ubo),c.update(),h.pass=a,h.shader=s,h.descriptorSet=c),++h.mergeCount,h.vbCount+=o,void(h.ia.vertexCount+=o)}}}for(var b=[],T=[],E=[],C=0;C<n.length;++C){var w=n[C],A=this._device.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,w.count*w.stride,w.stride));A.update(w.buffer.buffer),b.push(A),T.push(new Uint8Array(A.size)),E.push(A)}var t=this._device.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,4*o,4)),P=new Float32Array(o);P.fill(0),t.update(P),E.push(t);for(var I=e.inputAssembler.attributes,R=new Array(I.length+1),D=0;D<I.length;++D)R[D]=I[D];R[I.length]=new Wa("a_dyn_batch_id",W.R32F,!1,n.length);var e=new Xa(R,E),e=this._device.createInputAssembler(e),O=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Bg.SIZE,Bg.SIZE)),M=(c.bindBuffer(Bg.BINDING,O),c.update(),new Float32Array(Bg.COUNT));B.toArray(M,i.transform.worldMatrix,Bg.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:b,vbDatas:T,vbIdx:t,vbIdxData:P,vbCount:o,ia:e,ubo:O,uboData:M,pass:a,shader:s,descriptorSet:c})}},c.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},z0),L0=new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.DEVICE),B0=new Ra(null),F0=new rs(null);function z0(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}function U0(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}function k0(){this._device=null,this._resources={}}(o=I0=I0||{})[o.NONE=0]="NONE",o[o.INSTANCING=1]="INSTANCING",o[o.VB_MERGING=2]="VB_MERGING";H0.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(O0(t.phase));var i,n,r=e._bs;t.blendState&&((n=(i=t.blendState).targets)&&n.forEach(function(e,t){r.setTarget(t,e)}),void 0!==i.isA2C&&(r.isA2C=i.isA2C),void 0!==i.isIndepend&&(r.isIndepend=i.isIndepend),void 0!==i.blendColor&&(r.blendColor=i.blendColor)),e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},H0.getPassHash=function(e){var t,i=C0.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return Gc((i+=function(e){for(var t=",bs,"+e.isA2C,i=ge(e.targets);!(n=i()).done;)var n=n.value,t=(t+=",bt,"+n.blend+","+n.blendEq+","+n.blendAlphaEq+","+n.blendColorMask)+(","+n.blendSrc+","+n.blendDst+","+n.blendSrcAlpha+","+n.blendDstAlpha);return t}(e._bs))+(i=e._dss,t=",dss,"+i.depthTest+","+i.depthWrite+","+i.depthFunc,(t+=","+i.stencilTestFront+","+i.stencilFuncFront+","+i.stencilRefFront+","+i.stencilReadMaskFront)+(","+i.stencilFailOpFront+","+i.stencilZFailOpFront+","+i.stencilPassOpFront+","+i.stencilWriteMaskFront)+(","+i.stencilTestBack+","+i.stencilFuncBack+","+i.stencilRefBack+","+i.stencilReadMaskBack)+","+i.stencilFailOpBack+","+i.stencilZFailOpBack+","+i.stencilPassOpBack+","+i.stencilWriteMaskBack)+(",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW),666)},(y=H0.prototype).initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},y.getHandle=function(e,t,i){void 0===t&&(t=0),void 0===i&&(i=Ro.UNKNOWN);e=this._propertyHandleMap[e];return e?(i?e=_0(e,i):t&&(e=_0(e,l0(e)-t)),e+t):0},y.getBinding=function(e){e=this.getHandle(e);return e?H0.getBindingFromHandle(e):-1},y.setUniform=function(e,t){var i=H0.getBindingFromHandle(e),n=H0.getTypeFromHandle(e),e=H0.getOffsetFromHandle(e),i=this._getBlockView(n,i);g0[n](i,t,e),this._setRootBufferDirty(!0)},y.getUniform=function(e,t){var i=H0.getBindingFromHandle(e),n=H0.getTypeFromHandle(e),e=H0.getOffsetFromHandle(e),i=this._getBlockView(n,i);return m0[n](i,t,e)},y.setUniformArray=function(e,t){for(var i=H0.getBindingFromHandle(e),n=H0.getTypeFromHandle(e),r=Tc(n)>>2,o=this._getBlockView(n,i),a=H0.getOffsetFromHandle(e),s=0;s<t.length;s++,a+=r)null!==t[s]&&g0[n](o,t[s],a);this._setRootBufferDirty(!0)},y.bindTexture=function(e,t,i){this._descriptorSet.bindTexture(e,t,i||0)},y.bindSampler=function(e,t,i){this._descriptorSet.bindSampler(e,t,i||0)},y.setDynamicState=function(e,t){e=this._dynamics[e];e&&e.value===t||(e.value=t,e.dirty=!0)},y.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},y._setRootBufferDirty=function(e){this._rootBufferDirty=e},y.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):ee(12006)},y.getInstancedBuffer=function(e){return this._instancedBuffers[e=void 0===e?0:e]||(this._instancedBuffers[e]=new M0(this))},y.getBatchedBuffer=function(e){return this._batchedBuffers[e=void 0===e?0:e]||(this._batchedBuffers[e]=new N0(this))},y._initNative=function(){},y._destroy=function(){},y.destroy=function(){for(var e,t,i=0;i<this._shaderInfo.blocks.length;i++){var n=this._shaderInfo.blocks[i];this._buffers[n.binding].destroy()}for(e in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[e].destroy();for(t in this._batchedBuffers)this._batchedBuffers[t].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},y.resetUniform=function(e){var t=this.getHandle(e);if(t){for(var i=H0.getTypeFromHandle(t),n=H0.getBindingFromHandle(t),r=H0.getOffsetFromHandle(t),t=H0.getCountFromHandle(t),o=this._getBlockView(i,n),n=this._properties[e],a=n&&n.value||y0(i),s=(Tc(i)>>2)*t,c=0;c+a.length<=s;c+=a.length)o.set(a,r+c);this._setRootBufferDirty(!0)}},y.resetTexture=function(e,t){var i,n,r=this.getHandle(e);r&&(n=H0.getTypeFromHandle(r),r=H0.getBindingFromHandle(r),i=(i=(e=this._properties[e])&&e.value)?i+"-texture":y0(n),i=(n=D0.get(i))&&n.getGFXTexture(),e=e&&void 0!==e.samplerHash?pl.unpackFromHash(e.samplerHash):n&&n.getSamplerInfo(),n=this._device.getSampler(e),this._descriptorSet.bindSampler(r,n,t),this._descriptorSet.bindTexture(r,i,t))},y.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],i=0,n=0;n<t.members.length;n++){for(var r=t.members[n],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||y0(r.type),c=(Tc(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,i+l);i+=c}this._setRootBufferDirty(!0)},y.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],i=0;i<t.count;i++)this.resetTexture(t.name,i)},y.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();e=C0.getGFXShader(this._device,this._programName,this._defines,e);return e?(this._shader=e,this._setPipelineLayout(C0.getTemplateInfo(this._programName).pipelineLayout),this._setHash(H0.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},y.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,i=0;i<e.length;i++){var n=e[i];this._defines[n.name]=n.value}for(var t=C0.getGFXShader(this._device,this._programName,this._defines,t),r=0;r<e.length;r++){var o=e[r];delete this._defines[o.name]}return t},y.beginChangeStatesSilently=function(){},y.endChangeStatesSilently=function(){},y._setPriority=function(e){this._priority=e},y._setStage=function(e){this._stage=e},y._setPhase=function(e){this._phase=e},y._setPrimitive=function(e){this._primitive=e},y._setState=function(e,t,i,n){this._bs=e,this._dss=t,this._rs=i,this._descriptorSet=n},y._doInit=function(e,t){void 0===t&&(t=!1),this._initNative(),this._setPriority(wg.DEFAULT),this._setStage(Cg.DEFAULT),this._setPhase(O0("default")),this._setPrimitive($o.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=t?ue({},e.defines):e.defines,this._shaderInfo=C0.getTemplate(e.program),this._properties=e.properties||this._properties;var i=this._device;H0.fillPipelineInfo(this,e),e.stateOverrides&&H0.fillPipelineInfo(this,e.stateOverrides),F0.layout=C0.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(F0),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var n=this._shaderInfo.blocks,t=C0.getTemplateInfo(e.program),r=t.blockSizes,e=t.handleMap,o=i.capabilities.uboOffsetAlignment,a=[],s=0,c=0,l=0;l<n.length;l++){var u=r[l];a.push(c),c+=Math.ceil(u/o)*o,s=u}t=a[a.length-1]+s;t&&(L0.size=16*Math.ceil(t/16),this._rootBuffer=i.createBuffer(L0),this._rootBlock=new ArrayBuffer(t));for(var h=0,p=0;h<n.length;h++){var _=n[h].binding,f=r[h],d=(B0.buffer=this._rootBuffer,B0.offset=a[p++],B0.range=16*Math.ceil(f/16),this._buffers[_]=i.createBuffer(B0));this._blocks[_]=new Float32Array(this._rootBlock,B0.offset,f/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[_]=new Int32Array(this._blocks[_].buffer,this._blocks[_].byteOffset,this._blocks[_].length),this._descriptorSet.bindBuffer(_,d)}var m,t=this._propertyHandleMap=e,g={};for(m in this._properties){var v=this._properties[m];v.handleInfo&&(g[m]=this.getHandle.apply(this,v.handleInfo))}Object.assign(t,g)},y._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(Po.INSTANCED_ARRAYS)?this._setBatchingScheme(I0.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(I0.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(I0.VB_MERGING):this._setBatchingScheme(I0.NONE)},y._setBatchingScheme=function(e){this._batchingScheme=e},y._setDynamicState=function(e){this._dynamicStates=e},y._setHash=function(e){this._hash=e},y._getBlockView=function(e,t){return(e<Ro.FLOAT?this._blocksInt:this._blocks)[t]},y._setPipelineLayout=function(e){this._pipelineLayout=e},y._initPassFromTarget=function(e,t,i,n){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(i,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(C0.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^n)},e(H0,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return C0.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]);var G0=H0;function H0(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new cl,this._dss=new al,this._rs=new ol,this._priority=wg.DEFAULT,this._stage=Cg.DEFAULT,this._phase=O0("default"),this._primitive=$o.TRIANGLE_LIST,this._batchingScheme=I0.NONE,this._dynamicStates=na.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}G0.getTypeFromHandle=l0,G0.getBindingFromHandle=u0,G0.getCountFromHandle=h0,G0.getOffsetFromHandle=p0;var V0,j0=new rs(null),W0=((r=Y0.prototype)._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},r._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},r._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},r._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},r._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},r._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},r._setSubMesh=function(e){this._subMesh=e},r._init=function(){},r.initialize=function(e,t,i){void 0===i&&(i=null);var n=j.director.root,r=(this._device=n.device,j0.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(j0),j.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass()),o=new rs(null);o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=i,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===I0.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=wg.DEFAULT,t[0].phase===O0("reflection")&&(r=n.mainWindow.width,o=(o=n.mainWindow.height)<r?(r=512*r/o,512):512*o/(r=512),this._reflectionTex=this._device.createTexture(new Na(Lo.TEX2D,Bo.STORAGE|Bo.TRANSFER_SRC|Bo.SAMPLED,W.RGBA8,r,o)),this.descriptorSet.bindTexture(nv,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new La(ko.LINEAR,ko.LINEAR,ko.NONE,Go.CLAMP,Go.CLAMP,Go.CLAMP)),this.descriptorSet.bindSampler(nv,this._reflectionSampler),this.descriptorSet.bindTexture(rv,this._reflectionTex))},r._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},r.initPlanarShadowShader=function(){var e=j.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},r._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},r.initPlanarShadowInstanceShader=function(){var e=j.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},r._destroy=function(){},r.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=wg.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},r.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},r.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},r.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var n=t[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},r._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},e(Y0,[{key:"passes",get:function(){return this._passes},set:function(e){8<e.length?ee(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===I0.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),j0.layout=e[0].localSetLayout,this._createDescriptorSet(j0)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===I0.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),Y0),q0=new B,X0=[{name:"CC_RECEIVE_SHADOW",value:!0}];function Y0(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=wg.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}(s=V0=V0||{})[s.DEFAULT=0]="DEFAULT",s[s.SKINNING=1]="SKINNING",s[s.BAKED_SKINNING=2]="BAKED_SKINNING",s[s.BATCH_2D=3]="BATCH_2D",s[s.PARTICLE_BATCH=4]="PARTICLE_BATCH",s[s.LINE=5]="LINE";var K0,Q0,Z0=new La(ko.LINEAR,ko.LINEAR,ko.NONE,Go.CLAMP,Go.CLAMP,Go.CLAMP),J0=new La(ko.LINEAR,ko.LINEAR,ko.LINEAR,Go.CLAMP,Go.CLAMP,Go.CLAMP),$0=((S=ey.prototype)._setReceiveShadow=function(e){this._receiveShadow=e},S._init=function(){},S.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Tg.Enum.NONE,this._inited=!0)},S._destroySubmodel=function(e){e.destroy()},S._destroy=function(){},S.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var i=this._subModels[t];this._destroySubmodel(i)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},S.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},S.detachFromScene=function(){this.scene=null},S.updateTransform=function(){var e,t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0,e=this._worldBounds,this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e))},S.updateWorldBound=function(){var e,t=this.transform;null!==t&&(t.updateWorldTransform(),this._localDataUpdated=!0,e=this._worldBounds,this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e))},S._applyLocalData=function(){},S._applyLocalBuffer=function(){},S._applyWorldBoundBuffer=function(){},S.updateUBOs=function(e){for(var t,i,n,r,o,a=this._subModels,s=0;s<a.length;s++)a[s].update();this._updateStamp=e,this._localDataUpdated&&(this._localDataUpdated=!1,e=this.transform._mat,0<=(t=this._instMatWorldIdx)?(o=this.instancedAttributes.views,i=e,n=o[t],r=o[t+1],o=o[t+2],n[0]=i.m00,n[1]=i.m01,n[2]=i.m02,n[3]=i.m12,r[0]=i.m04,r[1]=i.m05,r[2]=i.m06,r[3]=i.m13,o[0]=i.m08,o[1]=i.m09,o[2]=i.m10,o[3]=i.m14):this._localBuffer&&(B.toArray(this._localData,e,Ng.MAT_WORLD_OFFSET),B.inverseTranspose(q0,e),t=Math.abs(B.determinant(q0)),n=1/Math.sqrt(t),B.multiplyScalar(q0,q0,n),B.toArray(this._localData,q0,Ng.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()))},S._updateNativeBounds=function(){},S.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=qh.fromPoints(qh.create(),e,t),this._worldBounds=qh.clone(this._modelBounds),this._updateNativeBounds())},S._createSubModel=function(){return new W0},S.initSubModel=function(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},S.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},S.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},S.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},S.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},S.updateLightingmap=function(e,t){Fr.toArray(this._localData,t,Ng.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t;var i=(e=null===e?D0.get("empty-texture"):e).getGFXTexture();if(i)for(var n=this._device.getSampler(1<e.mipmaps.length?J0:Z0),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(iv,i),a.bindSampler(iv,n),a.update()}},S.getMacroPatches=function(){return this.receiveShadow?X0:null},S._updateAttributesAndBinding=function(e){var t=this._subModels[e];t&&(this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet),e=t.passes[0].getShaderVariant(t.patches),this._updateInstancedAttributes(e.attributes,t.passes[0]))},S._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1},S._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},S._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(Po.INSTANCED_ARRAYS)){for(var i=0,n=0;n<e.length;n++){var r=e[n];r.isInstanced&&(i+=dc[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(i);for(var a=o.views.length=o.attributes.length=0,s=0;s<e.length;s++){var c,l=e[s];l.isInstanced&&((c=new Wa).format=l.format,c.name=l.name,c.isNormalized=l.isNormalized,c.location=l.location,o.attributes.push(c),l=new(Ec(c=dc[l.format]))(o.buffer.buffer,a,c.count),o.views.push(l),a+=c.size)}t.batchingScheme===I0.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(Qg)),this._localDataUpdated=!0}},S._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.DEVICE,Ng.SIZE,Ng.SIZE)),this._applyLocalBuffer())},S._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.DEVICE,Lg.SIZE,Lg.SIZE)),this._applyWorldBoundBuffer())},S._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(Ng.BINDING,this._localBuffer)},S._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(Lg.BINDING,this._worldBoundBuffer)},e(ey,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return 0<=this._instMatWorldIdx}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),ey);function ey(){this.type=V0.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Ng.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Fr,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Tg.Enum.NONE,this._device=j.director.root.device}(g=K0=K0||{})[g.LOCAL=0]="LOCAL",g[g.WORLD=1]="WORLD",(x=Q0=Q0||{})[x.NONE=0]="NONE",x[x.POSITION=1]="POSITION",x[x.ROTATION=2]="ROTATION",x[x.SCALE=4]="SCALE",x[x.RS=x.ROTATION|x.SCALE]="RS",x[x.TRS=x.POSITION|x.ROTATION|x.SCALE]="TRS",x[x.TRS_MASK=~x.TRS]="TRS_MASK",j.internal.TransformBit=Q0;ly.registerCreateFunc=function(e){e._createSceneFun=function(e){return new ly(e)}},(b=ly.prototype).initialize=function(e){return this._name=e.name,!0},b.activate=function(){},b.update=function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},b._destroy=function(){},b.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},b.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},b.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},b.removeCameras=function(){for(var e,t=ge(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},b.setMainLight=function(e){this._mainLight=e},b.unsetMainLight=function(e){if(this._mainLight===e){e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Q0.ROTATION));this.setMainLight(null)}},b.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},b.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},b.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},b.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},b.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},b.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},b.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},b.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},b.addModel=function(e){e.attachToScene(this),this._models.push(e)},b.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},b.removeModels=function(){for(var e=ge(this._models);!(t=e()).done;){var t=t.value;t.detachFromScene(),t.destroy()}this._models.length=0},b.addBatch=function(e){this._batches.push(e)},b.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},b.removeBatches=function(){this._batches.length=0},b.onGlobalPipelineStateChanged=function(){for(var e,t=ge(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},b.generateModelId=function(){return this._modelId++},b._createNativeObject=function(){},e(ly,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]);var ty,iy,ny,ry,oy,ay=ly,sy=Rre("EffectAsset",f("cc.EffectAsset")((l(cy,oy=P_),cy.register=function(e){cy._effects[e.name]=e},cy.remove=function(e){if("string"!=typeof e)cy._effects[e.name]&&cy._effects[e.name].equals(e)&&delete cy._effects[e.name];else if(cy._effects[e])delete cy._effects[e];else for(var t in cy._effects)if(cy._effects[t]._uuid===e)return void delete cy._effects[t]},cy.get=function(e){if(cy._effects[e])return cy._effects[e];for(var t in cy._effects)if(cy._effects[t]._uuid===e)return cy._effects[t];return null},cy.getAll=function(){return cy._effects},(Gd=cy.prototype).onLoaded=function(){C0.register(this),cy.register(this),j.game.once(j.Game.EVENT_ENGINE_INITED,this._precompile,this)},Gd._precompile=function(){for(var i=this,n=j.director.root,e=0;e<this.shaders.length;e++)!function(e){var t=i.shaders[e],a=i.combinations[e];if(!a)return;Object.keys(a).reduce(function(e,o){return e.reduce(function(e,t){for(var i=a[o],n=0;n<i.length;++n){var r=ue({},t);r[o]=i[n],e.push(r)}return e},[])},[{}]).forEach(function(e){return C0.getGFXShader(n.device,t.name,e,n.pipeline)})}(e)},Gd.destroy=function(){return cy.remove(this),oy.prototype.destroy.call(this)},Gd.initDefault=function(e){oy.prototype.initDefault.call(this,e);e=cy.get("unlit");this.name="unlit",this.shaders=e.shaders,this.combinations=e.combinations,this.techniques=e.techniques},Gd.validate=function(){return 0<this.techniques.length&&0<this.shaders.length},cy._effects={},ty=i((Xp=cy).prototype,"techniques",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iy=i(Xp.prototype,"shaders",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ny=i(Xp.prototype,"combinations",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ry=i(Xp.prototype,"hideInEditor",[d,xp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kd=Xp))||kd);function cy(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=oy.call.apply(oy,[this].concat(i))||this,"techniques",ty,p(e)),_(e,"shaders",iy,p(e)),_(e,"combinations",ny,p(e)),_(e,"hideInEditor",ry,p(e)),e}function ly(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}j.EffectAsset=sy;var uy=Rre("PipelineStateManager",(hy.getOrCreatePipelineState=function(e,t,i,n,r){var o,a=t.hash^n.hash^r.attributesHash^i.typedID,s=this._PSOHashMap.get(a);return s||(o=t.pipelineLayout,r=new as(r.attributes),i=new Hc(i,o,n,r,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates),s=e.createPipelineState(i),this._PSOHashMap.set(a,s)),s},hy));function hy(){}uy._PSOHashMap=new Map;var py=new Ea,_y=new va;function fy(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var dy,my,gy,vy,yy,xy=null;function Sy(e,t,i,n,r){var o,a,s;n&&n.enabled&&r===xy&&(o=(n=n.subModels[0]).inputAssembler,a=n.passes,s=n.shaders,n=n.descriptorSet,py.width=_y.width=r.window.width,py.height=_y.height=r.window.height,r=uy.getOrCreatePipelineState(e,a[0],s[0],t,o),i.setViewport(py),i.setScissor(_y),i.bindPipelineState(r),i.bindDescriptorSet(jg.MATERIAL,a[0].descriptorSet),i.bindDescriptorSet(jg.LOCAL,n),i.bindInputAssembler(o),i.draw(o))}var by,Ty=new Fr,Ey=Rre("Material",(Hd=f("cc.Material"),c=v(sy),Hd((l(Cy,by=P_),Cy.getHash=function(e){for(var t,i=0,n=ge(e.passes);!(t=n()).done;)i^=t.value.hash;return i},(o=Cy.prototype).initialize=function(e){this._passes.length?J(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},o.reset=function(e){this.initialize(e)},o.destroy=function(){return this._doDestroy(),by.prototype.destroy.call(this)},o.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},o.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},o.onLoaded=function(){this._update()},o.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var i=ge(this._passes);!(n=i()).done;){var n=n.value;n.resetUBOs(),n.resetTextures()}},o.setProperty=function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: "+i+".");i=this._passes[i];this._uploadProperty(i,e,t)&&(this._props[i.propertyIndex][e]=t,n=!0)}n||console.warn("illegal property name: "+e+".")},o.getProperty=function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var o=i[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;t=this._props[this._passes[t].propertyIndex];if(e in t)return t[e]}return null},o.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var i=0;i<e._props.length;i++)this._props[i]=ue({},e._props[i]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=ue({},e._defines[n]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=ue({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},o._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=sy.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},o._prepareInfo=function(e,t){var i=e;Array.isArray(i)||(e=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1,i=Array(e).fill(i));for(var n=0;n<i.length;++n)Object.assign(t[n]||(t[n]={}),i[n])},o._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],n=0;n<t;++n){var r=e.passes[n],o=r.passIndex=n,a=r.defines=this._defines[o]||(this._defines[o]={});r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),r.switch&&!a[r.switch]||((o=new G0(j.director.root)).initialize(r),i.push(o))}return i},o._update=function(e){var r=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach(function(e,t){var i,n=(n=r._props[t])||(r._props[t]={});for(i in void 0!==e.propertyIndex&&Object.assign(n,r._props[e.propertyIndex]),n)r._uploadProperty(e,i,n[i])});else for(var i=0;i<this._props.length;i++)this._props[i]={}}this._hash=Cy.getHash(this)},o._uploadProperty=function(e,t,i){var n,r=e.getHandle(t);if(!r)return!1;if(G0.getTypeFromHandle(r)<Ro.SAMPLER1D)Array.isArray(i)?e.setUniformArray(r,i):null!==i?(null!=(n=e.properties[t])&&n.linear&&(fy(Ty,n=i),Ty.w=n.w,i=Ty),e.setUniform(r,i)):e.resetUniform(t);else if(Array.isArray(i))for(var o=0;o<i.length;o++)this._bindTexture(e,r,i[o],o);else i?this._bindTexture(e,r,i):e.resetTexture(t);return!0},o._bindTexture=function(e,t,i,n){var r,t=G0.getBindingFromHandle(t);i instanceof fl?e.bindTexture(t,i,n):i instanceof Uv&&((r=i.getGFXTexture())&&r.width&&r.height&&(e.bindTexture(t,r,n),e.bindSampler(t,i.getGFXSampler(),n)))},o._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=ge(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},o.initDefault=function(e){by.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new nr("#ff00ff"))},o.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&0<this.passes.length},e(Cy,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),dy=i((y=Cy).prototype,"_effectAsset",[c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),my=i(y.prototype,"_techIdx",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gy=i(y.prototype,"_defines",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vy=i(y.prototype,"_states",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yy=i(y.prototype,"_props",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),r=y))||r));function Cy(){var e;return _(e=by.call(this)||this,"_effectAsset",dy,p(e)),_(e,"_techIdx",my,p(e)),_(e,"_defines",gy,p(e)),_(e,"_states",vy,p(e)),_(e,"_props",yy,p(e)),e._passes=[],e._hash=0,e}j.Material=Ey;var s=Ot({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),wy=Ot({Planar:0,ShadowMap:1}),Ay=Ot({HARD:0,SOFT:1,SOFT_2X:2}),Py=wy.ShadowMap+1,Iy=((S=Ry.prototype).getPlanarShader=function(e){return this._material||(this._material=new Ey,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},S.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Ey,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},S._setEnable=function(e){this._enabled=e},S._setType=function(e){this._type=this.enabled?e:Py},S.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},S.activate=function(){this.enabled&&this.type===wy.Planar&&this._updatePlanarInfo()},S._updatePlanarInfo=function(){this._material||(this._material=new Ey,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Ey,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},S._destroy=function(){},S.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},e(Ry,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){ce.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),Ry);function Ry(){this.fixedSphere=new ua(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new B,this.matShadowProj=new B,this.matShadowViewProj=new B,this._normal=new ce(0,1,0),this._shadowColor=new nr(0,0,0,76),this._matLight=new B,this._material=null,this._instancingMaterial=null,this._size=new U(512,512),this._enabled=!1,this._distance=0,this._type=Py,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}Iy.MAX_FAR=2e3,Iy.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),j.Shadows=Iy,Ee(ay.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Ee(ay.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);g={};Ee(g,"CameraVisFlags",[{name:"GENERAL"}]),In(g,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Tg.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Tg.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Tg.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Tg.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Tg.BitMask,targetName:"UI_2D"}]),j.CameraVisFlags=g;var Dy,x={};function Oy(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),t=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),i=2*n-8*t+4,n=3*n/i,t=2*t/i,i=1/t*n,n=1/t*(1-n-t);e.x=3.2404542*i-1.5371385+-.4985314*n,e.y=-.969266*i+1.8760108+.041556*n,e.z=.0556434*i-.2040259+1.0572252*n}Ee(x,"VisibilityFlags",[{name:"GENERAL"}]),In(x,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Tg.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Tg.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Tg.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Tg.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Tg.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Tg.Enum,targetName:"UI_2D"}]),j.VisibilityFlags=x,In(G0.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),Ee(Tv.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),Ee(Iy.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),(b=Dy=Dy||{})[b.DIRECTIONAL=0]="DIRECTIONAL",b[b.SPHERE=1]="SPHERE",b[b.SPOT=2]="SPOT",b[b.UNKNOWN=3]="UNKNOWN";function My(e){return 4*Math.PI*Math.PI*e*e}(Gd=Qy.prototype)._init=function(){},Gd._destroy=function(){},Gd.initialize=function(){this._init(),this.color=new ce(1,1,1),this.colorTemperature=6550},Gd.attachToScene=function(e){this._scene=e},Gd.detachFromScene=function(){this._scene=null},Gd.destroy=function(){this._name=null,this._node=null,this._destroy()},Gd.update=function(){},e(Qy,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Oy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=Q0.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]);var Ny,Ly,By,Fy=Qy,zy=new ce(0,0,-1),Uy=new ce,ky=(l(Ky,By=Fy),(Xp=Ky.prototype).initialize=function(){By.prototype.initialize.call(this),this.illuminance=Jr.SUN_ILLUM,this.direction=new ce(1,-1,-1)},Xp.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=ce.transformQuat(Uy,zy,this._node.worldRotation))},e(Ky,[{key:"direction",get:function(){return this._dir},set:function(e){ce.normalize(this._dir,e)}},{key:"illuminance",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),Ky),Gy=(l(Yy,Ly=G0),(kd=Yy.prototype).overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),G0.fillPipelineInfo(this,e),G0.fillPipelineInfo(this,t),this._onStateChange()},kd.tryCompile=function(e){if(e&&!x0(this._defines,e))return!1;e=Ly.prototype.tryCompile.call(this);return this._onStateChange(),e},kd.beginChangeStatesSilently=function(){this._dontNotify=!0},kd.endChangeStatesSilently=function(){this._dontNotify=!1},kd._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(I0.NONE)},kd._onStateChange=function(){this._setHash(G0.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},e(Yy,[{key:"parent",get:function(){return this._parent}}]),Yy),Hy=(l(Xy,Ny=Ey),(Hd=Xy.prototype).recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=ge(this._passes);!(i=n()).done;)i.value.tryCompile(e);else this._passes[t].tryCompile(e)},Hd.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r,o=this._passes[n],a=this._states[n]||(this._states[n]={});for(r in e)a[r]=e[r];o.overridePipelineStates(i[o.passIndex],a)}else{var s,c=this._states[t]||(this._states[t]={});for(s in e)c[s]=e[s];this._passes[t].overridePipelineStates(i[t],c)}}},Hd.destroy=function(){return this._doDestroy(),!0},Hd.onPassStateChange=function(e){this._hash=Ey.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},Hd._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new Gy(t[i],this));return e},e(Xy,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),Xy),Vy=null,jy=null,Wy=((o=qy.prototype)._setEnabled=function(e){this._enabled=e},o._setUseIBL=function(e){this._useIBL=e},o._setUseHDR=function(e){this._useHDR=e},o._setUseDiffuseMap=function(e){this._useDiffuseMap=e},o.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},o.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t;var i=j.director.root;i.pipeline.pipelineSceneData.isHDR?e&&(i.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel):t&&(i.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},o.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},o.activate=function(){var e,t=j.director.root.pipeline,t=(this._globalDSManager=t.globalDSManager,this._default=D0.get("default-cube-texture"),this._model||(this._model=j.director.root.createModel(j.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){}),this._default.isRGBE);this.envmap&&(t=this.envmap.isRGBE),jy||((e=new Ey).initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),jy=new Hy({parent:e})),this.enabled&&(Vy=Vy||j.utils.createMesh(j.primitives.box({width:2,height:2,length:2})),this._model.initSubModel(0,Vy.renderingSubMeshes[0],jy)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},o._updatePipeline=function(){var e=j.director.root,t=e.pipeline,i=this.useIBL?this.isRGBE?2:1:0,n=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===i&&t.macros.CC_USE_DIFFUSEMAP===n&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=i,t.macros.CC_USE_DIFFUSEMAP=n,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&jy&&jy.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,jy)},o._updateGlobalBinding=function(){var e,t,i;this._globalDSManager&&(i=j.director.root.device,(e=this.envmap||this._default)&&(t=e.getGFXTexture(),e=i.getSampler(e.getSamplerInfo()),this._globalDSManager.bindSampler(Xg,e),this._globalDSManager.bindTexture(Xg,t)),(e=this.diffuseMap||this._default)&&(t=e.getGFXTexture(),i=i.getSampler(e.getSamplerInfo()),this._globalDSManager.bindSampler(Yg,i),this._globalDSManager.bindTexture(Yg,t)),this._globalDSManager.update())},o._destroy=function(){},o.destroy=function(){this._destroy()},e(qy,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),qy);function qy(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}function Xy(e){var t;return(t=Ny.call(this)||this)._passes=[],t._parent=void 0,t._owner=void 0,t._subModelIdx=0,t._parent=e.parent,t._owner=e.owner||null,t._subModelIdx=e.subModelIdx||0,t.copy(t._parent),t}function Yy(e,t){var i;(i=Ly.call(this,e.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=t,i._doInit(i._parent,!0);for(var n=0;n<i._shaderInfo.blocks.length;n++){var r=i._shaderInfo.blocks[n],o=i._blocks[r.binding],r=i._parent.blocks[r.binding];o.set(r)}i._setRootBufferDirty(!0);for(var a=i._parent,s=0;s<i._shaderInfo.samplerTextures.length;s++)for(var c=i._shaderInfo.samplerTextures[s],l=0;l<c.count;l++){var u=a._descriptorSet.getSampler(c.binding,l),h=a._descriptorSet.getTexture(c.binding,l);i._descriptorSet.bindSampler(c.binding,u,l),i._descriptorSet.bindTexture(c.binding,h,l)}return Ly.prototype.tryCompile.call(p(i)),i}function Ky(){var e;return(e=By.call(this)||this)._dir=new ce(1,-1,-1),e._illuminanceHDR=Jr.SUN_ILLUM,e._illuminanceLDR=1,e._type=Dy.DIRECTIONAL,e}function Qy(){this._baked=!1,this._color=new ce(1,1,1),this._colorTemp=6550,this._colorTempRGB=new ce(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Dy.UNKNOWN}j.Skybox=Wy;l(ux,ex=Fy),(c=ux.prototype)._init=function(){ex.prototype._init.call(this)},c._destroy=function(){ex.prototype._destroy.call(this)},c.initialize=function(){ex.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/My(.15),this.luminanceLDR=1},c.update=function(){var e;this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),e=this._range,qh.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1)},e(ux,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]);var Zy,Jy,$y,ex,tx=ux,ix=new ce(0,0,-1),nx=new gr,rx=new B,ox=new B,ax=new B,sx=new B,cx=(l(lx,$y=Fy),(y=lx.prototype)._init=function(){$y.prototype._init.call(this)},y._destroy=function(){$y.prototype._destroy.call(this)},y._setDirection=function(e){this._dir.set(e)},y.initialize=function(){$y.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/My(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new ce(1,-1,-1))},y.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),ce.transformQuat(this._dir,ix,this._node.getWorldRotation(nx)),ce.normalize(this._dir,this._dir),qh.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(rx),B.invert(rx,rx),B.perspective(ox,this._angle,1,.001,this._range),B.multiply(ax,ox,rx),this._frustum.update(ax,sx),this._needUpdate=!1)},e(lx,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),lx),r=Object.freeze({__proto__:null,Ambient:Jr,Octree:eo,get CameraFOVAxis(){return ov},get CameraProjection(){return av},get CameraAperture(){return sv},get CameraISO(){return cv},get CameraShutter(){return lv},SKYBOX_FLAG:Sv,Camera:Tv,CameraVisFlags:g,VisibilityFlags:x,DirectionalLight:ky,ColorTemperatureToRGB:Oy,get LightType(){return Dy},nt2lm:My,Light:Fy,get ModelType(){return V0},Model:$0,ShadowSize:s,ShadowType:wy,PCFType:Ay,Shadows:Iy,RenderScene:ay,Skybox:Wy,SphereLight:tx,SpotLight:cx,SubModel:W0,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function lx(){var e;return(e=$y.call(this)||this)._dir=new ce(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=qh.create(),e._frustum=op.create(),e._pos=new ce,e._type=Dy.SPOT,e}function ux(){var e;return(e=ex.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=qh.create(),e._pos=new ce,e._type=Dy.SPHERE,e}function hx(e){return--e,e=(e=(e=(e=(e|=e>>16)|e>>8)|e>>4)|e>>2)|e>>1,++e}function px(e,t){return Math.ceil(e/t)*t}(S=Zy=Zy||{})[S.OPAQUE=0]="OPAQUE",S[S.TRANSPARENT=1]="TRANSPARENT",S[S.OVERLAY=2]="OVERLAY",(b=Jy=Jy||{})[b.DEFAULT=1]="DEFAULT",b[b.FORWARD=2]="FORWARD",b[b.SHADOWCAST=4]="SHADOWCAST";(Gd=fx.prototype).initialize=function(e){var t=dc[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=Ec(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},Gd.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},Gd.alloc=function(e,t){e=px(e,this._alignment);var i=-1,n=-1;if((n=void 0!==t?this._findAvailableSpace(e,i=t):n)<0)for(var r=0;r<this._chunkCount&&(i=r,!(0<=(n=this._findAvailableSpace(e,i))));++r);if(0<=n)return(t=this._chunks[i]).start+=e,t={chunkIdx:i,start:n,end:n+e,texture:t.texture},this._handles.push(t),t;t=Math.sqrt(e/this._formatSize),t=this._roundUpFn&&this._roundUpFn(t,this._formatSize)||Math.max(1024,hx(t)),t=this._chunks[this.createChunk(t)],t.start+=e,t={chunkIdx:this._chunkCount-1,start:0,end:e,texture:t.texture};return this._handles.push(t),t},Gd.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},Gd.createChunk=function(e){var t=e*e*this._formatSize,e=(fe("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format),{texture:this._device.createTexture(new Na(Lo.TEX2D,Bo.SAMPLED|Bo.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t});return this._chunks[this._chunkCount]=e,this._chunkCount++},Gd.update=function(e,t){var i=[],n=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,r=Math.floor(r/e.texture.width),s=Math.min(e.texture.width-a,o),c=0;0<a&&(this._region0.texOffset.x=a,this._region0.texOffset.y=r,this._region0.texExtent.width=s,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,c*this._formatSize,s*this._channels)),n.push(this._region0),a=0,r+=1,o-=s,c+=s),0<o&&(this._region1.texOffset.x=a,this._region1.texOffset.y=r,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),s=this._region1.texExtent.width*this._region1.texExtent.height):(s=o,this._region1.texExtent.width=s,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,c*this._formatSize,s*this._channels)),n.push(this._region1),a=0,r+=this._region1.texExtent.height,o-=s,c+=s),0<o&&(this._region2.texOffset.x=a,this._region2.texOffset.y=r,this._region2.texExtent.width=o,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,c*this._formatSize,o*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)},Gd._findAvailableSpace=function(e,t){var i=this._chunks[t],n=!1;if((r=i.start)+e<=i.size)n=!0;else{for(var r=0,o=this._handles.filter(function(e){return e.chunkIdx===t}).sort(function(e,t){return e.start-t.start}),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){n=!0;break}r=s.end}!n&&r+e<=i.size&&(n=!0)}return n?r:-1},Gd._McDonaldAlloc=function(e){e=px(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.end?n=!0:r>i.end?r+e<=i.size?n=!0:e<=i.end&&(n=!(i.start=r=0)):r===i.end&&(i.start=r=0,i.end=i.size,e<=i.end&&(n=!0)),n)return i.start+=e,n={chunkIdx:t,start:r,end:r+e,texture:i.texture},this._handles.push(n),n}var o=Math.sqrt(e/this._formatSize),o=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,hx(o)),o=this._chunks[this.createChunk(o)],o=(o.start+=e,{chunkIdx:this._chunkCount,start:0,end:e,texture:o.texture});return this._handles.push(o),o};var _x=fx,Xp=Object.freeze({__proto__:null,addStage:function(e){var t;void 0===_n[e]&&(t=1<<pn,_n[e]=t,pn+=1)},scene:r,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[],a=(o.push(new Wa(fa.ATTR_POSITION,W.RGB32F)),t.normals&&o.push(new Wa(fa.ATTR_NORMAL,W.RGB32F)),t.uvs&&o.push(new Wa(fa.ATTR_TEX_COORD,W.RG32F)),t.colors&&o.push(new Wa(fa.ATTR_COLOR,W.RGB32F)),e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,4*i.length,4*i.length/n))),s=(a.update(new Float32Array(i)),null);return t.indices&&(s=e.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Xa(o,[a],s))},get RenderQueue(){return Zy},get PassStage(){return Jy},genHandle:c0,getTypeFromHandle:l0,getBindingFromHandle:u0,getCountFromHandle:h0,getOffsetFromHandle:p0,customizeType:_0,type2reader:m0,type2writer:g0,getDefaultFromType:y0,overrideMacros:x0,get BatchingSchemes(){return I0},Pass:G0,getDeviceShaderVersion:E0,programLib:C0,nearestPOT:hx,TextureBufferPool:_x,MaterialInstance:Hy,PassInstance:Gy,get PoolType(){return Lh},NULL_HANDLE:0,get NodeView(){return Bh},NodePool:a,get PassView(){return zh},PassPool:ba,get AABBView(){return kh},AABBPool:Sa});function fx(e){this._device=void 0,this._format=W.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Ta,this._region1=new Ta,this._region2=new Ta,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}Rre("renderer",Xp);var dx=new ce,mx=(new ce,new ce,new ce),gx=new B,vx=new qh,yx=new qh,xx=!1,Sx=ua.create(0,0,0,1),bx=new ua,Tx=new op,Ex=(Tx.accurate=!0,new op),Cx=(Ex.accurate=!0,new op),wx=new B,Ax=new B,Px=new B,Ix=new B,Rx=new B,Dx=new B,Ox=new B,Mx=new ce,Nx=new U,Lx=new ce,Bx=new ce,Fx=new ce(0,0,0),zx=(new qh,new Tt(function(){return{model:null,depth:0}},128)),Ux=new Tt(function(){return{model:null,depth:0}},128),kx=new Tt(function(){return{model:null,depth:0}},128);function Gx(e,t){var i=0,t=(e.node&&(ce.subtract(dx,e.node.worldPosition,t.position),i=ce.dot(dx,t.forward)),zx.alloc());return t.model=e,t.depth=i,t}function Hx(e,t,i){var t=t.direction,n=e.normal,r=e.distance+.001,o=1/ce.dot(n,t),a=t.x*o,s=t.y*o,t=t.z*o,o=n.x,c=n.y,n=n.z,e=e.matLight;e.m00=1-o*a,e.m01=-o*s,e.m02=-o*t,e.m03=0,e.m04=-c*a,e.m05=1-c*s,e.m06=-c*t,e.m07=0,e.m08=-n*a,e.m09=-n*s,e.m10=1-n*t,e.m11=0,e.m12=a*r,e.m13=s*r,e.m14=t*r,e.m15=1,B.toArray(i,e,Mg.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Vx(e,t){ce.normalize(dx,e.normal),t[Mg.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=dx.x,t[Mg.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=dx.y,t[Mg.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=dx.z,t[Mg.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function jx(e,t){var i,n=t.scene,r=n.mainLight,o=e.pipelineSceneData,a=o.shadows,s=o.skybox,c=o.renderObjects,l=(zx.freeArray(c),c.length=0,o.castShadowObjects),u=(kx.freeArray(l),l.length=0,xx=!1,null);if(a.enabled&&(e.pipelineUBO.updateShadowUBORange(Mg.SHADOW_COLOR_OFFSET,a.shadowColor),a.type===wy.ShadowMap))if(u=e.pipelineSceneData.dirShadowObjects,Ux.freeArray(u),u.length=0,r&&r.node){var h=Cx;var o=r;var p=t;var _=a;var f=e.device;if(_.fixedArea){var d=_.orthoSize,m=_.orthoSize,g=_.near,v=_.far;B.fromRT(wx,o.node.getWorldRotation(),o.node.getWorldPosition()),B.invert(Ax,wx),B.ortho(Ix,-d,d,-m,m,g,v,f.capabilities.clipSpaceMinZ,f.capabilities.clipSpaceSignY),B.multiply(Rx,Ix,Ax),B.invert(Px,Ax),_.matShadowView=Ax,_.matShadowProj=Ix,_.matShadowViewProj=Rx,op.createOrtho(h,2*d,2*m,g,v,Px)}else{var d=_.invisibleOcclusionRange,m=_.size.x,y=(g=gx,p.node&&(y=(v=p.node).getWorldPosition(),v=v.getWorldRotation(),B.fromRT(g,v,y),g.m08*=-1,g.m09*=-1,g.m10*=-1),op.split(Tx,p,gx,.1,_.shadowDistance),Ex=op.clone(Tx),B.fromRT(wx,o.node.rotation,Fx),B.invert(Ax,wx),B.invert(Px,Ax),Ax.clone()),p=(Ex.transform(Ax),qh.fromPoints(vx,new ce(1e7,1e7,1e7),new ce(-1e7,-1e7,-1e7)),vx.mergeFrustum(Ex),2*vx.halfExtents.z),x=(mx.set(vx.center.x,vx.center.y,vx.center.z+vx.halfExtents.z+d),ce.transformMat4(mx,mx,Px),B.fromRT(wx,o.node.rotation,mx),B.invert(Ax,wx),B.invert(Px,Ax),ce.distance(Tx.vertices[0],Tx.vertices[6])),x=(bx.center.set(0,0,0),bx.radius=-1,bx.mergePoints(Tx.vertices),.8*x+.4*bx.radius),p=(_.shadowCameraFar=p+d,.5*x);if(B.ortho(Ix,-p,p,-p,p,.1,_.shadowCameraFar,f.capabilities.clipSpaceMinZ,f.capabilities.clipSpaceSignY),0<m){B.multiply(Dx,Ix,y),ce.transformMat4(Mx,mx,Dx);d=2/m,p=(Nx.set(d,d),Mx.x%Nx.x),f=Mx.y%Nx.y;Lx.set(Mx.x-p,Mx.y-f,Mx.z),B.invert(Ox,Dx),ce.transformMat4(Bx,Lx,Ox),B.fromRT(wx,o.node.rotation,Bx),B.invert(Ax,wx),B.invert(Px,Ax),op.createOrtho(h,x,x,.1,_.shadowCameraFar,Px)}else{for(var S=0;S<8;S++)h.vertices[S].set(0,0,0);h.updatePlanes()}B.multiply(Rx,Ix,Ax),_.matShadowView=Ax,_.matShadowProj=Ix,_.matShadowViewProj=Rx}}else{for(var b=0;b<8;b++)Cx.vertices[b].set(0,0,0);Cx.updatePlanes()}r&&a.type===wy.Planar&&(d=(m=e).pipelineSceneData.shadows,p=r.direction,f=d.normal,o=d.distance+.001,x=1/ce.dot(f,p),_=p.x*x,e=p.y*x,p=p.z*x,x=f.x,r=f.y,f=f.z,(i=d.matLight).m00=1-x*_,i.m01=-x*e,i.m02=-x*p,i.m03=0,i.m04=-r*_,i.m05=1-r*e,i.m06=-r*p,i.m07=0,i.m08=-f*_,i.m09=-f*e,i.m10=1-f*p,i.m11=0,i.m12=_*o,i.m13=e*o,i.m14=p*o,i.m15=1,m.pipelineUBO.updateShadowUBORange(Mg.MAT_LIGHT_PLANE_PROJ_OFFSET,d.matLight)),s.enabled&&s.model&&t.clearFlag&Sv&&c.push(Gx(s.model,t));for(var T,E,C,w=n.models,A=t.visibility,P=0;P<w.length;P++){var I=w[P];I.enabled&&(I.castShadow&&l.push((E=t,void 0,C=0,(T=I).node&&(ce.subtract(dx,T.node.worldPosition,E.position),C=ce.dot(dx,E.forward)),(E=kx.alloc()).model=T,E.depth=C,E)),a.firstSetCSM&&I.worldBounds&&(xx||(yx.copy(I.worldBounds),xx=!0),qh.merge(yx,yx,I.worldBounds)),I.node&&(A&I.node.layer)===I.node.layer||A&I.visFlags)&&(null!=u&&I.castShadow&&I.worldBounds&&Ch.aabbFrustum(I.worldBounds,Cx)&&u.push((T=t,void 0,C=0,(E=I).node&&(ce.subtract(dx,E.node.worldPosition,T.position),C=ce.dot(dx,T.forward)),(T=Ux.alloc()).model=E,T.depth=C,T)),I.worldBounds&&!Ch.aabbFrustum(I.worldBounds,t.frustum)||c.push(Gx(I,t)))}a.firstSetCSM&&(a.shadowDistance=2*yx.halfExtents.length(),a.firstSetCSM=!1)}var Wx,qx,Xx,Yx=new La(ko.LINEAR,ko.LINEAR,ko.NONE,Go.CLAMP,Go.CLAMP,Go.CLAMP),Kx=new La(ko.POINT,ko.POINT,ko.NONE,Go.CLAMP,Go.CLAMP,Go.CLAMP),Qx=((kd=rS.prototype).bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindBuffer(e,t),n=i.next()},kd.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindSampler(e,t),n=i.next()},kd.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindTexture(e,t),n=i.next()},kd.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},kd.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=this._globalDescriptorSet,n=t.createDescriptorSet(new rs(this._descriptorSetLayout));this._descriptorSetMap.set(e,n);for(var r=Ag.UBO_GLOBAL;r<Ag.COUNT;r++)n.bindBuffer(r,i.getBuffer(r)),n.bindSampler(r,i.getSampler(r)),n.bindTexture(r,i.getTexture(r));t=t.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Mg.SIZE,Mg.SIZE));n.bindBuffer(Mg.BINDING,t),n.update()}return this._descriptorSetMap.get(e)},kd.destroy=function(){this._descriptorSetLayout.destroy()},e(rS,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),rS),Zx=new B,Jx=new B,$x=new B,eS=new Fr,tS=new Fr(0,0,1,0),iS=(nS.updateGlobalUBOView=function(e,t){var i=j.director.root,n=Math.floor(e.width),e=Math.floor(e.height);t[Dg.TIME_OFFSET]=i.cumulativeTime,t[Dg.TIME_OFFSET+1]=i.frameTime,t[Dg.TIME_OFFSET+2]=j.director.getTotalFrames(),t[Dg.SCREEN_SIZE_OFFSET]=n,t[Dg.SCREEN_SIZE_OFFSET+1]=e,t[Dg.SCREEN_SIZE_OFFSET+2]=1/n,t[Dg.SCREEN_SIZE_OFFSET+3]=1/e,t[Dg.NATIVE_SIZE_OFFSET]=n,t[Dg.NATIVE_SIZE_OFFSET+1]=e,t[Dg.NATIVE_SIZE_OFFSET+2]=1/t[Dg.NATIVE_SIZE_OFFSET],t[Dg.NATIVE_SIZE_OFFSET+3]=1/t[Dg.NATIVE_SIZE_OFFSET+1]},nS.updateCameraUBOView=function(e,t,i){var n=(i.scene||j.director.getScene().renderScene).mainLight,e=e.pipelineSceneData,r=e.ambient,o=e.fog,a=e.shadows,s=i.exposure,c=e.isHDR,a=(t[Og.SCREEN_SCALE_OFFSET]=e.shadingScale,t[Og.SCREEN_SCALE_OFFSET+1]=e.shadingScale,t[Og.SCREEN_SCALE_OFFSET+2]=1/t[Og.SCREEN_SCALE_OFFSET],t[Og.SCREEN_SCALE_OFFSET+3]=1/t[Og.SCREEN_SCALE_OFFSET+1],t[Og.EXPOSURE_OFFSET]=s,t[Og.EXPOSURE_OFFSET+1]=1/s,t[Og.EXPOSURE_OFFSET+2]=c?1:0,t[Og.EXPOSURE_OFFSET+3]=0,n?(a=a.enabled&&a.type===wy.ShadowMap?1:0,l=n.direction,tS.set(l.x,l.y,l.z,a),Fr.toArray(t,tS,Og.MAIN_LIT_DIR_OFFSET),ce.toArray(t,n.color,Og.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature&&(l=n.colorTemperatureRGB,t[Og.MAIN_LIT_COLOR_OFFSET]*=l.x,t[Og.MAIN_LIT_COLOR_OFFSET+1]*=l.y,t[Og.MAIN_LIT_COLOR_OFFSET+2]*=l.z),t[Og.MAIN_LIT_COLOR_OFFSET+3]=c?n.illuminance*s:n.illuminance):(tS.set(0,0,1,0),Fr.toArray(t,tS,Og.MAIN_LIT_DIR_OFFSET),Fr.toArray(t,Fr.ZERO,Og.MAIN_LIT_COLOR_OFFSET)),r.skyColor),l=(a.w=c?r.skyIllum*s:r.skyIllum,t[Og.AMBIENT_SKY_OFFSET+0]=a.x,t[Og.AMBIENT_SKY_OFFSET+1]=a.y,t[Og.AMBIENT_SKY_OFFSET+2]=a.z,t[Og.AMBIENT_SKY_OFFSET+3]=a.w,t[Og.AMBIENT_GROUND_OFFSET+0]=r.groundAlbedo.x,t[Og.AMBIENT_GROUND_OFFSET+1]=r.groundAlbedo.y,t[Og.AMBIENT_GROUND_OFFSET+2]=r.groundAlbedo.z,t[Og.AMBIENT_GROUND_OFFSET+3]=r.mipmapCount,B.toArray(t,i.matView,Og.MAT_VIEW_OFFSET),B.toArray(t,i.node.worldMatrix,Og.MAT_VIEW_INV_OFFSET),ce.toArray(t,i.position,Og.CAMERA_POS_OFFSET),B.toArray(t,i.matProj,Og.MAT_PROJ_OFFSET),B.toArray(t,i.matProjInv,Og.MAT_PROJ_INV_OFFSET),B.toArray(t,i.matViewProj,Og.MAT_VIEW_PROJ_OFFSET),B.toArray(t,i.matViewProjInv,Og.MAT_VIEW_PROJ_INV_OFFSET),t[Og.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),o.colorArray);t[Og.GLOBAL_FOG_COLOR_OFFSET]=l.x,t[Og.GLOBAL_FOG_COLOR_OFFSET+1]=l.y,t[Og.GLOBAL_FOG_COLOR_OFFSET+2]=l.z,t[Og.GLOBAL_FOG_COLOR_OFFSET+3]=l.z,t[Og.GLOBAL_FOG_BASE_OFFSET]=o.fogStart,t[Og.GLOBAL_FOG_BASE_OFFSET+1]=o.fogEnd,t[Og.GLOBAL_FOG_BASE_OFFSET+2]=o.fogDensity,t[Og.GLOBAL_FOG_ADD_OFFSET]=o.fogTop,t[Og.GLOBAL_FOG_ADD_OFFSET+1]=o.fogRange,t[Og.GLOBAL_FOG_ADD_OFFSET+2]=o.fogAtten,t[Og.NEAR_FAR_OFFSET]=i.nearClip,t[Og.NEAR_FAR_OFFSET+1]=i.farClip,t[Og.VIEW_PORT_OFFSET]=e.shadingScale*i.window.width*i.viewport.x,t[Og.VIEW_PORT_OFFSET+1]=e.shadingScale*i.window.height*i.viewport.y,t[Og.VIEW_PORT_OFFSET+2]=e.shadingScale*i.window.width*i.viewport.z,t[Og.VIEW_PORT_OFFSET+3]=e.shadingScale*i.window.height*i.viewport.w},nS.updateShadowUBOView=function(e,t,i){var n,r,o,a,s,c=e.device,i=i.scene.mainLight,e=e.pipelineSceneData.shadows,l=t;e.enabled&&(i&&e.type===wy.ShadowMap?(n=.1,a=0,s=e.matShadowView,r=e.matShadowProj,o=e.matShadowViewProj,a=e.fixedArea?(n=e.near,e.far):(n=.1,e.shadowCameraFar),B.toArray(t,s,Mg.MAT_LIGHT_VIEW_OFFSET),l[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=r.m10,l[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=r.m14,l[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=r.m11,l[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=r.m15,l[Mg.SHADOW_PROJ_INFO_OFFSET+0]=r.m00,l[Mg.SHADOW_PROJ_INFO_OFFSET+1]=r.m05,l[Mg.SHADOW_PROJ_INFO_OFFSET+2]=1/r.m00,l[Mg.SHADOW_PROJ_INFO_OFFSET+3]=1/r.m05,B.toArray(t,o,Mg.MAT_LIGHT_VIEW_PROJ_OFFSET),s=hv(c)?0:1,l[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=n,l[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=a,l[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,l[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-e.saturation,l[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=e.size.x,l[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=e.size.y,l[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=e.pcf,l[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=e.bias,l[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,l[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,l[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=e.normalBias,l[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0):i&&e.type===wy.Planar&&(Hx(e,i,l),Vx(e,l)),nr.toArray(l,e.shadowColor,Mg.SHADOW_COLOR_OFFSET))},nS.updateShadowUBOLightView=function(e,t,i){var n=e.device,r=e.pipelineSceneData.shadows,o=t,a=hv(n)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(i.type){case Dy.DIRECTIONAL:c=r.fixedArea?(s=r.near,r.far):(s=.1,r.shadowCameraFar),B.toArray(t,l,Mg.MAT_LIGHT_VIEW_OFFSET),o[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Mg.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Mg.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Mg.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Mg.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,B.toArray(t,h,Mg.MAT_LIGHT_VIEW_PROJ_OFFSET),eS.set(s,c,0,1-r.saturation),Fr.toArray(o,eS,Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),eS.set(0,a,r.normalBias,0),Fr.toArray(o,eS,Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Dy.SPOT:B.invert(Zx,i.node.getWorldMatrix()),B.toArray(o,Zx,Mg.MAT_LIGHT_VIEW_OFFSET),B.perspective(Jx,i.angle,i.aspect,.001,i.range),B.multiply($x,Jx,Zx),B.toArray(o,$x,Mg.MAT_LIGHT_VIEW_PROJ_OFFSET),eS.set(.01,i.range,0,1-r.saturation),Fr.toArray(o,eS,Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),eS.set(1,a,r.normalBias,0),Fr.toArray(o,eS,Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}eS.set(r.size.x,r.size.y,r.pcf,r.bias),Fr.toArray(o,eS,Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),nr.toArray(o,r.shadowColor,Mg.SHADOW_COLOR_OFFSET)},nS.getCombineSignY=function(){return nS._combineSignY},(Hd=nS.prototype)._initCombineSignY=function(){var e=this._device;nS._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},Hd.activate=function(e,t){this._device=e,this._pipeline=t;var t=this._pipeline.descriptorSet,i=(this._initCombineSignY(),e.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Dg.SIZE,Dg.SIZE))),i=(t.bindBuffer(Dg.BINDING,i),e.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Og.SIZE,Og.SIZE))),i=(t.bindBuffer(Og.BINDING,i),e.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Mg.SIZE,Mg.SIZE)));t.bindBuffer(Mg.BINDING,i)},Hd.updateGlobalUBO=function(e){var t=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;i.update(),nS.updateGlobalUBOView(e,this._globalUBO),n[0].updateBuffer(i.getBuffer(Dg.BINDING),this._globalUBO),t.bindBuffer(Dg.BINDING,i.getBuffer(Dg.BINDING)),t.update()},Hd.updateCameraUBO=function(e){var t=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;nS.updateCameraUBOView(this._pipeline,this._cameraUBO,e),n[0].updateBuffer(i.getBuffer(Og.BINDING),this._cameraUBO),t.bindBuffer(Og.BINDING,i.getBuffer(Og.BINDING)),t.update()},Hd.updateShadowUBO=function(e){var t,i,n,r=this._pipeline.pipelineSceneData;r.shadows.enabled&&(t=this._pipeline.descriptorSet,i=this._pipeline.commandBuffers,r=r.shadowFrameBufferMap,(n=e.scene.mainLight)&&r.has(n)&&t.bindTexture(qg,r.get(n).colorTextures[0]),nS.updateShadowUBOView(this._pipeline,this._shadowUBO,e),t.update(),i[0].updateBuffer(t.getBuffer(Mg.BINDING),this._shadowUBO))},Hd.updateShadowUBOLight=function(e,t){nS.updateShadowUBOLightView(this._pipeline,this._shadowUBO,t),e.bindTexture(qg,D0.get("default-texture").getGFXTexture()),e.bindTexture(Kg,D0.get("default-texture").getGFXTexture()),e.update(),e.getBuffer(Mg.BINDING).update(this._shadowUBO)},Hd.updateShadowUBORange=function(e,t){t instanceof B?B.toArray(this._shadowUBO,t,e):t instanceof nr&&nr.toArray(this._shadowUBO,t,e)},Hd.destroy=function(){},nS);function nS(){this._globalUBO=new Float32Array(Dg.COUNT),this._cameraUBO=new Float32Array(Og.COUNT),this._shadowUBO=new Float32Array(Mg.COUNT)}function rS(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(Yx),this._pointSampler=this._device.getSampler(Kx);e=new ns(Pg.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new rs(this._descriptorSetLayout))}iS._combineSignY=0;var oS,aS,sS,cS,Gd=Rre("RenderStage",(o=f("RenderStage"),c=m(),y=m(),g=m(),o(((x=lS.prototype).initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},x.activate=function(e,t){this._pipeline=e,this._flow=t},e(lS,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),Wx=i((S=lS).prototype,"_name",[c,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qx=i(S.prototype,"_priority",[y,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xx=i(S.prototype,"_tag",[g,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b=S))||b));function lS(){_(this,"_name",Wx,this),_(this,"_priority",qx,this),this._enabled=!0,_(this,"_tag",Xx,this)}j.RenderStage=Gd;var uS,y=Rre("RenderFlow",(r=f("RenderFlow"),a=m(),ba=m(),Sa=m(),kd=m(),Hd=v([Gd]),r(((o=hS.prototype).initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},o.activate=function(e){this._pipeline=e,this._stages.sort(function(e,t){return e.priority-t.priority});for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},o.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].enabled&&this._stages[t].render(e)},o.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},e(hS,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),oS=i((x=hS).prototype,"_name",[a,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aS=i(x.prototype,"_priority",[ba,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sS=i(x.prototype,"_tag",[Sa,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cS=i(x.prototype,"_stages",[kd,Hd,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c=x))||c));function hS(){_(this,"_name",oS,this),_(this,"_priority",aS,this),_(this,"_tag",sS,this),_(this,"_stages",cS,this)}j.RenderFlow=y,(g=uS=uS||Rre("PipelineEventType",{})).RENDER_FRAME_BEGIN="render-frame-begin",g.RENDER_FRAME_END="render-frame-end",g.RENDER_CAMERA_BEGIN="render-camera-begin",g.RENDER_CAMERA_END="render-camera-end",g.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed";function pS(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null}function _S(){this.quadIB=null,this.quadVB=null,this.quadIA=null}var fS,dS,mS,gS,vS=Rre("PipelineEventProcessor",(l(TS,gS=Ki),(S=TS.prototype).on=function(e,t,i,n){return this.eventTargetOn(e,t,i,n)},S.once=function(e,t,i){return this.eventTargetOnce(e,t,i)},TS)),yS=new va,xS=new Ea,SS=Rre("RenderPipeline",(b=f("cc.RenderPipeline"),r=m(),o=m(),a=v([y]),b((l(bS,mS=P_),(ba=bS.prototype).getPipelineRenderData=function(){return this._pipelineRenderData},ba.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},ba.createRenderPass=function(e,t,i){var n=this._device,r=new Ya,o=new Ka,t=(r.format=t,o.format=i,o.stencilStoreOp=Ko.DISCARD,o.depthStoreOp=Ko.DISCARD,e&la.COLOR||(e&Sv?r.loadOp=Yo.DISCARD:(r.loadOp=Yo.LOAD,r.beginAccesses=[Qo.COLOR_ATTACHMENT_WRITE])),(e&la.DEPTH_STENCIL)!==la.DEPTH_STENCIL&&(e&la.DEPTH||(o.depthLoadOp=Yo.LOAD),e&la.STENCIL||(o.stencilLoadOp=Yo.LOAD)),o.beginAccesses=[Qo.DEPTH_STENCIL_ATTACHMENT_WRITE],new Ja([r],o));return n.createRenderPass(t)},ba.getRenderPass=function(e,t){return this._renderPasses.get(e)||(t=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,t),t)},ba.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,i=this._width*t.shadingScale,n=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(i,n);e.depthStencilTexture&&e.depthStencilTexture.resize(i,n),e.destroy(),e.initialize(new ts(e.renderPass,r,e.depthStencilTexture))},ba.generateRenderArea=function(e,t){var i=e.viewport,n=e.window.width,e=e.window.height;t.x=i.x*n,t.y=i.y*e,t.width=i.width*n,t.height=i.height*e},ba.generateViewport=function(e,t){this.generateRenderArea(e,yS);e=this.pipelineSceneData.shadingScale;return(t=t||xS).left=yS.x*e,t.top=yS.y*e,t.width=yS.width*e,t.height=yS.height*e,t},ba.generateScissor=function(e,t){this.generateRenderArea(e,t=t||yS);e=this.pipelineSceneData.shadingScale;return t.x*=e,t.y*=e,t.width*=e,t.height*=e,t},ba.activate=function(){var e=j.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new Qx(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},ba._ensureEnoughSize=function(){},ba.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(uS.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;0<=t;--t){var i=e[t];if(i.window.swapchain)return xy=i}xy=null}(e);for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.emit(uS.RENDER_CAMERA_BEGIN,i),h=u=l=c=s=a=o=r=n=void 0;var n=this,r=i,o=n.pipelineSceneData.validPunctualLights;o.length=0;for(var a=r.scene.spotLights,s=0;s<a.length;s++){var c=a[s];c.baked||(ua.set(Sx,c.position.x,c.position.y,c.position.z,c.range),Ch.sphereFrustum(Sx,r.frustum)&&o.push(c))}for(var l=r.scene.sphereLights,u=0;u<l.length;u++){var h=l[u];h.baked||(ua.set(Sx,h.position.x,h.position.y,h.position.z,h.range),Ch.sphereFrustum(Sx,r.frustum)&&o.push(h))}jx(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var p=0;p<this._flows.length;p++)this._flows[p].render(i);this.emit(uS.RENDER_CAMERA_END,i)}}this.emit(uS.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},ba._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},ba._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var i=0;i<t.downsampleTexs.length;++i)t.downsampleTexs[i].destroy(),t.downsampleFramebuffers[i].destroy();t.downsampleTexs.length=0;for(var n=t.downsampleFramebuffers.length=0;n<t.upsampleTexs.length;++n)t.upsampleTexs[n].destroy(),t.upsampleFramebuffers[n].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null!=(e=t.renderPass)&&e.destroy(),this._pipelineRenderData.bloom=null}},ba._genQuadVertexData=function(e,t){var i=new Float32Array(16),n=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height,s=(0<this.device.capabilities.screenSpaceSignY&&(t=a,a=o,o=t),0);switch(e){case Ao.IDENTITY:s=0,i[s++]=-1,i[s++]=-1,i[s++]=n,i[s++]=a,i[s++]=1,i[s++]=-1,i[s++]=r,i[s++]=a,i[s++]=-1,i[s++]=1,i[s++]=n,i[s++]=o,i[s++]=1,i[s++]=1,i[s++]=r,i[s++]=o;break;case Ao.ROTATE_90:s=0,i[s++]=-1,i[s++]=-1,i[s++]=r,i[s++]=a,i[s++]=1,i[s++]=-1,i[s++]=r,i[s++]=o,i[s++]=-1,i[s++]=1,i[s++]=n,i[s++]=a,i[s++]=1,i[s++]=1,i[s++]=n,i[s++]=o;break;case Ao.ROTATE_180:s=0,i[s++]=-1,i[s++]=-1,i[s++]=n,i[s++]=o,i[s++]=1,i[s++]=-1,i[s++]=r,i[s++]=o,i[s++]=-1,i[s++]=1,i[s++]=n,i[s++]=a,i[s++]=1,i[s++]=1,i[s++]=r,i[s++]=a;break;case Ao.ROTATE_270:s=0,i[s++]=-1,i[s++]=-1,i[s++]=n,i[s++]=o,i[s++]=1,i[s++]=-1,i[s++]=n,i[s++]=a,i[s++]=-1,i[s++]=1,i[s++]=r,i[s++]=o,i[s++]=1,i[s++]=1,i[s++]=r,i[s++]=a}return i},ba._createQuadInputAssembler=function(){var e=new _S,t=4*Float32Array.BYTES_PER_ELEMENT,t=this._device.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE|No.HOST,4*t,t));if(!t)return e;var i=Uint8Array.BYTES_PER_ELEMENT,i=this._device.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,6*i,i));if(!i)return e;var n=new Uint8Array(6),n=(n[0]=0,n[1]=1,n[2]=2,n[3]=1,n[4]=3,n[5]=2,i.update(n),new Array(2)),n=(n[0]=new Wa("a_position",W.RG32F),n[1]=new Wa("a_texCoord",W.RG32F),this._device.createInputAssembler(new Xa(n,[t],i)));return e.quadIB=i,e.quadVB=t,e.quadIA=n,e},ba.updateQuadVertexData=function(e,t){var i,n=this._lastUsedRenderArea;n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height||(i=this._genQuadVertexData(Ao.IDENTITY,e),this._quadVBOffscreen.update(i),i=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Ao.IDENTITY,e),this._quadVBOnscreen.update(i),n.copy(e))},ba.destroy=function(){for(var e,t=0;t<this._flows.length;t++)this._flows[t].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null!=(e=this._globalDSManager)&&e.destroy();for(var i=0;i<this._commandBuffers.length;i++)this._commandBuffers[i].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null!=(e=this._pipelineSceneData)&&e.destroy(),mS.prototype.destroy.call(this)},ba._generateConstantMacros=function(){var e="",e=(e=(e=(e=(e=(e=(e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(Po.TEXTURE_FLOAT)?1:0)+"\n")+("#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n"))+("#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n"))+("#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n"))+("#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(Po.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n"))+("#define CC_PLATFORM_ANDROID_AND_WEBGL "+(Qi.os===Wi.ANDROID&&Qi.isBrowser?1:0)+"\n"))+("#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(zt.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n");this._constantMacros=e},ba.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new pS,t=this.device,i=new Ya,n=(i.format=W.RGBA8,i.loadOp=Yo.CLEAR,i.storeOp=Ko.STORE,i.endAccesses=[Qo.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new Ja([i])),this._width),r=this._height;e.prefiterTex=t.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,W.RGBA8,n>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new ts(e.renderPass,[e.prefiterTex])),n>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,W.RGBA8,n>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new ts(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,W.RGBA8,n,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new ts(e.renderPass,[e.upsampleTexs[o]])),n>>=1,r>>=1;e.combineTex=t.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,W.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new ts(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},ba.on=function(e,t,i,n){return this._eventProcessor.on(e,t,i,n)},ba.once=function(e,t,i){return this._eventProcessor.once(e,t,i)},ba.off=function(e,t,i){this._eventProcessor.off(e,t,i)},ba.emit=function(e,t,i,n,r,o){this._eventProcessor.emit(e,t,i,n,r,o)},ba.targetOff=function(e){this._eventProcessor.targetOff(e)},ba.removeAll=function(e){this._eventProcessor.removeAll(e)},ba.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},e(bS,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),fS=i((Sa=bS).prototype,"_tag",[r,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dS=i(Sa.prototype,"_flows",[o,a,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kd=Sa))||kd));function bS(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=mS.call.apply(mS,[this].concat(i))||this,"_tag",fS,p(e)),_(e,"_flows",dS,p(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new vS,e._commandBuffers=[],e._pipelineUBO=new iS,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new va,e._clusterEnabled=!1,e._bloomEnabled=!1,e}function TS(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=gS.call.apply(gS,[this].concat(i))||this).eventTargetOn=gS.prototype.on,e.eventTargetOnce=gS.prototype.once,e}j.RenderPipeline=SS,(Hd=L6=L6||{})[Hd.BLOOM=18]="BLOOM",Hd[Hd.POST_PROCESS=19]="POST_PROCESS",Hd[Hd.UI=20]="UI",B1=B1||{},B1[B1.FORWARD=10]="FORWARD",(x=R=R||{})[x.SHADOW=0]="SHADOW",x[x.FORWARD=1]="FORWARD",x[x.UI=10]="UI",(c=vI=vI||{})[c.GBUFFER=10]="GBUFFER",c[c.LIGHTING=15]="LIGHTING",c[c.TRANSPARENT=18]="TRANSPARENT",(g=Mne=Mne||{})[g.SHADOW=0]="SHADOW",g[g.MAIN=1]="MAIN",g[g.UI=10]="UI";S=new Ya,S.format=W.RGBA8,S.beginAccesses=[Qo.FRAGMENT_SHADER_READ_TEXTURE],S.endAccesses=[Qo.FRAGMENT_SHADER_READ_TEXTURE],b=new Ka;b.format=W.DEPTH_STENCIL;var ES,CS,wS,AS,PS,IS,RS,DS,OS,MS,NS,LS,BS,FS,zS,US,kS,GS,HS,VS,jS,WS,qS,XS,YS,KS,QS,ZS,JS,$S,eb,tb,ib,nb,rb,ob,ab=new Ja([S],b),sb={width:1,height:1,renderPassInfo:ab},cb=Rre("RenderTexture",f("cc.RenderTexture")((l(lb,ob=Uv),(ba=lb.prototype).initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},ba.reset=function(e){this.initialize(e)},ba.destroy=function(){var e;return this._window&&(null!=(e=j.director.root)&&e.destroyWindow(this._window),this._window=null),ob.prototype.destroy.call(this)},ba.resize=function(e,t){this._width=Math.floor(Fn(e,1,2048)),this._height=Math.floor(Fn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},ba._serialize=function(){return{}},ba._deserialize=function(e,t){this._width=e.w,this._height=e.h,this._name=e.n,ob.prototype._deserialize.call(this,e.base,t)},ba.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},ba.onLoaded=function(){this._initWindow()},ba._initWindow=function(e){var t=j.director.root;sb.title=this._name,sb.width=this._width,sb.height=this._height,sb.renderPassInfo=e&&e.passInfo?e.passInfo:ab,this._window?(this._window.destroy(),this._window.initialize(t.device,sb)):this._window=t.createWindow(sb)},ba.initDefault=function(e){ob.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},ba.validate=function(){return 1<=this.width&&this.width<=2048&&1<=this.height&&this.height<=2048},ba.readPixels=function(e,t,i,n,r){void 0===e&&(e=0),void 0===t&&(t=0),i=i||this.width,n=n||this.height;var o=this.getGFXTexture();if(!o)return ee(7606),null;var a=4*i*n;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return ee(7607,a),null;var a=this._getGFXDevice(),s=[],c=[],l=new Ta;return l.texOffset.x=e,l.texOffset.y=t,l.texExtent.width=i,l.texExtent.height=n,c.push(l),s.push(r),null!=a&&a.copyTextureToBuffers(o,s,c),r},e(lb,[{key:"window",get:function(){return this._window}}]),r=lb))||r);function lb(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=ob.call.apply(ob,[this].concat(i))||this)._window=null,e}j.RenderTexture=cb,Lt(Lo),Lt(Bo),Lt(Ko),Lt(Yo),Lt(Qo),(o=I=I||{})[o.SCENE=0]="SCENE",o[o.POSTPROCESS=1]="POSTPROCESS",o[o.UI=2]="UI",Lt(I),a=f("RenderTextureDesc"),Sa=v(Lo),kd=v(Bo),Hd=v(W),a((ES=i((x=function(){_(this,"name",ES,this),_(this,"type",CS,this),_(this,"usage",wS,this),_(this,"format",AS,this),_(this,"width",PS,this),_(this,"height",IS,this)}).prototype,"name",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),CS=i(x.prototype,"type",[Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lo.TEX2D}}),wS=i(x.prototype,"usage",[kd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bo.COLOR_ATTACHMENT}}),AS=i(x.prototype,"format",[Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W.UNKNOWN}}),PS=i(x.prototype,"width",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),IS=i(x.prototype,"height",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),x));c=f("RenderTextureConfig"),g=v(cb);var ub,ba=c((RS=i((S=function(){_(this,"name",RS,this),_(this,"texture",DS,this)}).prototype,"name",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DS=i(S.prototype,"texture",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b=S))||b,kd=(r=f("MaterialConfig"),o=v(Ey),r((OS=i((a=function(){_(this,"name",OS,this),_(this,"material",MS,this)}).prototype,"name",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MS=i(a.prototype,"material",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),a)),Sa=f("FrameBufferDesc"),kd=v([ui]),Hd=v(cb),Sa((NS=i((x=function(){_(this,"name",NS,this),_(this,"renderPass",LS,this),_(this,"colorTextures",BS,this),_(this,"depthStencilTexture",FS,this),_(this,"texture",zS,this)}).prototype,"name",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),LS=i(x.prototype,"renderPass",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BS=i(x.prototype,"colorTextures",[kd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FS=i(x.prototype,"depthStencilTexture",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zS=i(x.prototype,"texture",[Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x)),c=f("ColorDesc"),g=v(W),S=v(Yo),b=v(Ko),r=v([Qo]),o=v([Qo]),c((US=i((a=function(){_(this,"format",US,this),_(this,"loadOp",kS,this),_(this,"storeOp",GS,this),_(this,"sampleCount",HS,this),_(this,"beginAccesses",VS,this),_(this,"endAccesses",jS,this)}).prototype,"format",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W.UNKNOWN}}),kS=i(a.prototype,"loadOp",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yo.CLEAR}}),GS=i(a.prototype,"storeOp",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ko.STORE}}),HS=i(a.prototype,"sampleCount",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VS=i(a.prototype,"beginAccesses",[r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jS=i(a.prototype,"endAccesses",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Qo.COLOR_ATTACHMENT_WRITE]}}),Sa=a))||Sa),hb=(Hd=f("DepthStencilDesc"),x=v(W),c=v(Yo),g=v(Ko),S=v(Yo),b=v(Ko),r=v([Qo]),o=v([Qo]),Hd((WS=i((a=function(){_(this,"format",WS,this),_(this,"depthLoadOp",qS,this),_(this,"depthStoreOp",XS,this),_(this,"stencilLoadOp",YS,this),_(this,"stencilStoreOp",KS,this),_(this,"sampleCount",QS,this),_(this,"beginAccesses",ZS,this),_(this,"endAccesses",JS,this)}).prototype,"format",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W.UNKNOWN}}),qS=i(a.prototype,"depthLoadOp",[c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yo.CLEAR}}),XS=i(a.prototype,"depthStoreOp",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ko.STORE}}),YS=i(a.prototype,"stencilLoadOp",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yo.CLEAR}}),KS=i(a.prototype,"stencilStoreOp",[b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ko.STORE}}),QS=i(a.prototype,"sampleCount",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZS=i(a.prototype,"beginAccesses",[r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JS=i(a.prototype,"endAccesses",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Qo.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),Sa=a))||Sa),Hd=f("RenderPassDesc"),x=v([kd]),c=v(hb),kd=(Hd(($S=i((g=function(){_(this,"index",$S,this),_(this,"colorAttachments",eb,this),_(this,"depthStencilAttachment",tb,this)}).prototype,"index",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),eb=i(g.prototype,"colorAttachments",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tb=i(g.prototype,"depthStencilAttachment",[c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hb}}),g)),(S=ub=ub||{})[S.FRONT_TO_BACK=0]="FRONT_TO_BACK",S[S.BACK_TO_FRONT=1]="BACK_TO_FRONT",Lt(ub),b=f("RenderQueueDesc"),r=v(ub),o=v([ui]),b((ib=i((a=function(){_(this,"isTransparent",ib,this),_(this,"sortMode",nb,this),_(this,"stages",rb,this)}).prototype,"isTransparent",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nb=i(a.prototype,"sortMode",[r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ub.FRONT_TO_BACK}}),rb=i(a.prototype,"stages",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sa=a))||Sa);function pb(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function _b(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}(Hd=db.prototype).clear=function(){this.queue.clear(),this._passPool.reset()},Hd.insertRenderPass=function(e,t,i){var t=e.model.subModels[t],n=t.passes[i],r=t.shaders[i];if(n.blendState.targets[0].blend!==this._passDesc.isTransparent||!(n.phase&this._passDesc.phases))return!1;var n=0|n.priority<<16|t.priority<<8|i,o=this._passPool.add();return o.hash=n,o.depth=e.depth||0,o.shaderId=r.typedID,o.subModel=t,o.passIdx=i,this.queue.push(o),!0},Hd.sort=function(){this.queue.sort()},Hd.recordCommandBuffer=function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],o=r.subModel,r=r.passIdx,a=o.inputAssembler,s=o.passes[r],r=o.shaders[r],r=uy.getOrCreatePipelineState(e,s,r,t,a);i.bindPipelineState(r),i.bindDescriptorSet(jg.MATERIAL,s.descriptorSet),i.bindDescriptorSet(jg.LOCAL,o.descriptorSet),i.bindInputAssembler(a),i.draw(a)}};var fb=db;function db(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Et(function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}},64),this.queue=new Ct(64,this._passDesc.sortFunc)}function mb(e){for(var t=0,i=0;i<e.stages.length;i++)t|=O0(e.stages[i]);var n=pb;switch(e.sortMode){case ub.BACK_TO_FRONT:n=_b;break;case ub.FRONT_TO_BACK:n=pb}return new fb({isTransparent:e.isTransparent,phases:t,sortFunc:n})}function gb(e){e.clear()}function vb(e){e.sort()}(x=Pb.prototype).clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},x.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}i=t.next()}},x.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s,c=r.value.batches[a];c.mergeCount&&(o||(s=c.shader,s=uy.getOrCreatePipelineState(e,c.pass,s,t,c.ia),i.bindPipelineState(s),i.bindDescriptorSet(jg.MATERIAL,c.pass.descriptorSet),o=!0),i.bindDescriptorSet(jg.LOCAL,c.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(c.ia),i.draw(c.ia))}r=n.next()}};var yb=Pb,xb=((c=Ab.prototype).clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},c.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},c.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){i.bindDescriptorSet(jg.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u,h=a[l];h.count&&(u=h.shader,c!==(u=uy.getOrCreatePipelineState(e,s,u,t,h.ia))&&(i.bindPipelineState(u),c=u),i.bindDescriptorSet(jg.LOCAL,h.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(h.ia),i.draw(h.ia))}}r=n.next()}},Ab),Sb=new Tt(function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}},16),bb=new Float32Array(4),Tb=[],Eb=[],Cb=new B,wb=new B;function Ab(){this.queue=new Set}function Pb(){this.queue=new Set}var Ib=O0("forward-add"),Rb=[];(g=Zb.prototype).clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Sb.freeArray(this._lightPasses),this._lightPasses.length=0},g.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var n=t[i],r=e.get(n);r&&(r.getBuffer(Mg.BINDING).destroy(),r.getTexture(qg).destroy(),r.getTexture(Kg).destroy(),r.destroy()),e.delete(n)}},g.gatherLightPasses=function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var n=this._pipeline.pipelineSceneData.renderObjects,r=0;r<n.length;r++){var o=n[r].model,a=o.subModels;if(function(e,t){for(var i=!1,n=t.length=0;n<e.length;n++){for(var r=e[n].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===Ib){o=a,i=!0;break}t.push(o)}return i}(a,Rb)&&(Eb.length=0,this._lightCulling(o,i),Eb.length))for(var s=0;s<a.length;s++){var c,l,u=Rb[s];u<0||(l=(c=a[s]).passes[u],c.passes[0].blendState.targets[0].blend||(c.descriptorSet.bindBuffer(Fg.BINDING,this._firstLightBufferView),c.descriptorSet.update(),this._addRenderQueue(l,c,o,u)))}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},g.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,o=a.passes[s],s=a.shaders[s],u=a.inputAssembler,s=uy.getOrCreatePipelineState(e,o,s,t,u),o=o.descriptorSet,h=a.descriptorSet;i.bindPipelineState(s),i.bindDescriptorSet(jg.MATERIAL,o),i.bindInputAssembler(u);for(var p=0;p<c.length;++p){var _=l[p],_=n.getOrCreateDescriptorSet(_);Tb[0]=c[p],i.bindDescriptorSet(jg.GLOBAL,_),i.bindDescriptorSet(jg.LOCAL,h,Tb),i.draw(u)}}},g._lightCulling=function(e,t){for(var i,n,r=0;r<t.length;r++){var o=t[r],a=!1;switch(o.type){case Dy.SPHERE:i=o,a=!(!(n=e).worldBounds||Ch.aabbWithAABB(n.worldBounds,i.aabb));break;case Dy.SPOT:n=o,a=!(!(i=e).worldBounds||Ch.aabbWithAABB(i.worldBounds,n.aabb)&&Ch.aabbFrustum(i.worldBounds,n.frustum))}a||Eb.push(r)}},g._addRenderQueue=function(e,t,i,n){var r=e.batchingScheme;if(r===I0.INSTANCING)for(var o=0;o<Eb.length;o++){var a=Eb[o],s=e.getInstancedBuffer(a);s.merge(t,i.instancedAttributes,n),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===I0.VB_MERGING)for(var c=0;c<Eb.length;c++){var l=Eb[c],u=e.getBatchedBuffer(l);u.merge(t,n,i),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=Sb.alloc();h.subModel=t,h.passIdx=n;for(var p=0;p<Eb.length;p++){var _=Eb[p];h.lights.push(_),h.dynamicOffsets.push(this._lightBufferStride*_)}this._lightPasses.push(h)}},g._updateLightDescriptorSet=function(e,t){for(var i=this._pipeline.device,n=this._pipeline.pipelineSceneData,r=n.shadows,o=n.shadowFrameBufferMap,a=e.scene.mainLight,s=hv(i)?0:1,c=this._pipeline.globalDSManager,l=n.validPunctualLights,u=0;u<l.length;u++){var h=l[u],p=c.getOrCreateDescriptorSet(u);if(p){var _,f;switch(h.type){case Dy.SPHERE:a&&(Hx(r,a,this._shadowUBO),Vx(r,this._shadowUBO)),this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,nr.toArray(this._shadowUBO,r.shadowColor,Mg.SHADOW_COLOR_OFFSET);break;case Dy.SPOT:a&&(Hx(r,a,this._shadowUBO),Vx(r,this._shadowUBO)),B.invert(Cb,h.node.getWorldMatrix()),B.perspective(wb,h.angle,h.aspect,.001,h.range),f=wb.clone(),_=wb.clone().invert(),B.multiply(wb,wb,Cb),B.toArray(this._shadowUBO,Cb,Mg.MAT_LIGHT_VIEW_OFFSET),B.toArray(this._shadowUBO,wb,Mg.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Mg.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Mg.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Mg.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Mg.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Mg.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=_.m10,this._shadowUBO[Mg.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=_.m14,this._shadowUBO[Mg.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=_.m11,this._shadowUBO[Mg.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=_.m15,this._shadowUBO[Mg.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Mg.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Mg.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Mg.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,nr.toArray(this._shadowUBO,r.shadowColor,Mg.SHADOW_COLOR_OFFSET),o.has(h)&&(f=null==(_=o.get(h))?void 0:_.colorTextures[0])&&p.bindTexture(Kg,f)}p.update(),t.updateBuffer(p.getBuffer(Mg.BINDING),this._shadowUBO)}}},g._updateUBOs=function(e,t){var i=e.exposure,e=this._pipeline.pipelineSceneData,n=e.isHDR,r=e.shadows,o=e.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Yn(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Ra(this._lightBuffer,0,Fg.SIZE)));for(var a=0,s=0;a<o.length;a++,s+=this._lightBufferElementCount){var c,l=o[a];switch(l.type){case Dy.SPHERE:ce.toArray(bb,l.position),bb[3]=0,this._lightBufferData.set(bb,s+Fg.LIGHT_POS_OFFSET),bb[0]=l.size,bb[1]=l.range,bb[2]=0,bb[3]=r.enabled&&r.type===wy.ShadowMap?1:0,this._lightBufferData.set(bb,s+Fg.LIGHT_SIZE_RANGE_ANGLE_OFFSET),ce.toArray(bb,l.color),l.useColorTemperature&&(c=l.colorTemperatureRGB,bb[0]*=c.x,bb[1]*=c.y,bb[2]*=c.z),bb[3]=n?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(bb,s+Fg.LIGHT_COLOR_OFFSET);break;case Dy.SPOT:ce.toArray(bb,l.position),bb[3]=1,this._lightBufferData.set(bb,s+Fg.LIGHT_POS_OFFSET),bb[0]=l.size,bb[1]=l.range,bb[2]=l.spotAngle,bb[3]=r.enabled&&r.type===wy.ShadowMap?1:0,this._lightBufferData.set(bb,s+Fg.LIGHT_SIZE_RANGE_ANGLE_OFFSET),ce.toArray(bb,l.direction),this._lightBufferData.set(bb,s+Fg.LIGHT_DIR_OFFSET),ce.toArray(bb,l.color),l.useColorTemperature&&(c=l.colorTemperatureRGB,bb[0]*=c.x,bb[1]*=c.y,bb[2]*=c.z),bb[3]=n?l.luminance*i*this._lightMeterScale:l.luminance,this._lightBufferData.set(bb,s+Fg.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)};var Db,Ob,Mb,Nb=Zb,Lb=new qh,Bb=((S=Qb.prototype).gatherShadowPasses=function(e,t){var i=this._pipeline.pipelineSceneData,n=(this._pipeline.pipelineUBO,i.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,n.enabled&&n.type===wy.Planar&&!(n.normal.length()<1e-6)){var i=e.scene,r=e.frustum,e=0!=(e.visibility&Tg.BitMask.DEFAULT);if(i.mainLight&&e){for(var o=i.models,a=0;a<o.length;a++){var s=o[a];s.enabled&&s.node&&s.castShadow&&this._castModels.push(s)}var c=n.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(c);for(var l=0;l<this._castModels.length;l++){var u=this._castModels[l];if(!u.worldBounds||(qh.transform(Lb,u.worldBounds,n.matLight),Ch.aabbFrustum(Lb,r)))if(u.isInstancingEnabled)for(var h=u.subModels,p=0;p<h.length;p++){var _=h[p];c.merge(_,u.instancedAttributes,0,_.planarInstanceShader)}else this._pendingModels.push(u)}this._instancedQueue.uploadBuffers(t)}}},S.recordCommandBuffer=function(e,t,i){var n=this._pipeline.pipelineSceneData.shadows;if(n.enabled&&n.type===wy.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,i),this._pendingModels.length)){var r=n.material.passes[0],n=r.descriptorSet;i.bindDescriptorSet(jg.MATERIAL,n);for(var o=this._pendingModels.length,a=0;a<o;a++)for(var s=this._pendingModels[a],c=0;c<s.subModels.length;c++){var l=s.subModels[c],u=l.planarShader,h=l.inputAssembler,u=uy.getOrCreatePipelineState(e,r,u,t,h);i.bindPipelineState(u),i.bindDescriptorSet(jg.LOCAL,l.descriptorSet),i.bindInputAssembler(h),i.draw(h)}}},Qb),Fb=((b=Kb.prototype).activate=function(e){this._pipeline=e},b.render=function(e,t){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(c=e.visibility&s.visFlags?!0:c)for(var l=s.shaders.length,u=0;u<l;u++){var h,p,_=s.passes[u];_.phase===this._phaseID&&(p=s.shaders[u],h=s.inputAssembler,p=uy.getOrCreatePipelineState(n,_,p,t,h),r.bindPipelineState(p),r.bindDescriptorSet(jg.MATERIAL,_.descriptorSet),p=s.descriptorSet,r.bindDescriptorSet(jg.LOCAL,p),r.bindInputAssembler(h),r.draw(h))}}},Kb),zb=[new Ca(0,0,0,1)],Ub=Rre("ForwardStage",(r=f("ForwardStage"),o=v([kd]),a=m(),r((l(Yb,Mb=Gd),(Sa=Yb.prototype).initialize=function(e){return Mb.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},Sa.activate=function(e,t){Mb.prototype.activate.call(this,e,t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=mb(this.renderQueues[i]);this._additiveLightQueue=new Nb(this._pipeline),this._planarQueue=new Bb(this._pipeline),this._uiPhase.activate(e)},Sa.destroy=function(){},Sa.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(gb);for(var n=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<n.length;++s)for(var c=n[s],l=c.model.subModels,r=0;r<l.length;++r)for(var u=l[r],h=u.passes,o=0;o<h.length;++o){var p=h[o];if(p.phase===this._phaseID){var _=p.batchingScheme;if(_===I0.INSTANCING){var f=p.getInstancedBuffer();f.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(f)}else if(_===I0.VB_MERGING){f=p.getBatchedBuffer();f.merge(u,o,c.model),this._batchedQueue.queue.add(f)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}this._renderQueues.forEach(vb);var d=t.commandBuffers[0],m=(t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(d),this._batchedQueue.uploadBuffers(d),this._additiveLightQueue.gatherLightPasses(e,d),this._planarQueue.gatherShadowPasses(e,d),e.clearFlag&la.COLOR&&(zb[0].x=e.clearColor.x,zb[0].y=e.clearColor.y,zb[0].z=e.clearColor.z,zb[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea),e.window.framebuffer),g=t.getRenderPass(e.clearFlag&this._clearFlag,m);d.beginRenderPass(g,m,this._renderArea,zb,e.clearDepth,e.clearStencil),d.bindDescriptorSet(jg.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,g,d),this._instancedQueue.recordCommandBuffer(i,g,d),this._batchedQueue.recordCommandBuffer(i,g,d),this._additiveLightQueue.recordCommandBuffer(i,g,d),d.bindDescriptorSet(jg.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(i,g,d),this._renderQueues[1].recordCommandBuffer(i,g,d),this._uiPhase.render(e,g),Sy(i,g,d,t.profiler,e),d.endRenderPass()},Yb.initInfo={name:"ForwardStage",priority:B1.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:ub.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:ub.BACK_TO_FRONT,stages:["default","planarShadow"]}]},Db=i((Hd=Yb).prototype,"renderQueues",[o,d,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),x=Hd))||x)),kb=Rre("ForwardFlow",f("ForwardFlow")((l(Xb,Ob=y),(c=Xb.prototype).initialize=function(e){return Ob.prototype.initialize.call(this,e),0===this._stages.length&&((e=new Ub).initialize(Ub.initInfo),this._stages.push(e)),!0},c.activate=function(e){Ob.prototype.activate.call(this,e)},c.render=function(e){Ob.prototype.render.call(this,e)},c.destroy=function(){Ob.prototype.destroy.call(this)},Xb.initInfo={name:t,priority:R.FORWARD,stages:[]},g=Xb))||g),Gb=new B,Hb=new B,Vb=new B,jb=new qh,Wb=O0("shadow-caster"),qb=[];function Xb(){return Ob.apply(this,arguments)||this}function Yb(){var e;return _(e=Mb.call(this)||this,"renderQueues",Db,p(e)),e._renderQueues=[],e._renderArea=new va,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=O0("default"),e._clearFlag=4294967295,e._batchedQueue=new yb,e._instancedQueue=new xb,e._uiPhase=new Fb,e}function Kb(){this._phaseID=O0("default")}function Qb(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new xb,this._pipeline=void 0,this._pipeline=e}function Zb(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Mg.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new xb,this._batchedQueue=new yb;e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Fg.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Ra(this._lightBuffer,0,Fg.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}function Jb(e,t){for(var i=!1,n=t.length=0;n<e.length;n++){for(var r=e[n].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===Wb){o=a,i=!0;break}t.push(o)}return i}(S=_T.prototype).gatherLightPasses=function(e,t,i,n){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(i&&o.enabled&&o.type===wy.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(i.type){case Dy.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;Jb(l.subModels,qb)&&this.add(l,qb)}break;case Dy.SPOT:B.invert(Gb,i.node.getWorldMatrix()),B.perspective(Hb,i.angle,i.aspect,.001,i.range),B.multiply(Vb,Hb,Gb);for(var u=0;u<s.length;u++){var h=s[u].model;!Jb(h.subModels,qb)||h.worldBounds&&(qh.transform(jb,h.worldBounds,Vb),!Ch.aabbFrustum(jb,t.frustum))||this.add(h,qb)}}this._instancedQueue.uploadBuffers(n),this._batchedQueue.uploadBuffers(n)}},S.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},S.add=function(e,t){for(var i=e.subModels,n=0;n<i.length;n++){var r,o=i[n],a=t[n],s=o.passes[a];s.batchingScheme===I0.INSTANCING?((r=s.getInstancedBuffer()).merge(o,e.instancedAttributes,a),this._instancedQueue.queue.add(r)):s.batchingScheme===I0.VB_MERGING?((r=s.getBatchedBuffer()).merge(o,a,e),this._batchedQueue.queue.add(r)):(a=o.shaders[a],this._subModelsArray.push(o),a&&this._shaderArray.push(a),this._passArray.push(s))}},S.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],o=this._shaderArray[n],a=this._passArray[n],s=r.inputAssembler,o=uy.getOrCreatePipelineState(e,a,o,t,s),a=a.descriptorSet;i.bindPipelineState(o),i.bindDescriptorSet(jg.MATERIAL,a),i.bindDescriptorSet(jg.LOCAL,r.descriptorSet),i.bindInputAssembler(s),i.draw(s)}};var $b,eT,tT=_T,iT=[new Ca(1,1,1,1)],nT=Rre("ShadowStage",f("ShadowStage")((l(pT,eT=Gd),(b=pT.prototype).setUsage=function(e,t,i){this._globalDS=e,this._light=t,this._shadowFrameBuffer=i},b.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,(this._light=null)!=(e=this._additiveShadowQueue)&&e.clear()},b.clearFramebuffer=function(e){var t,i;this._light&&this._shadowFrameBuffer&&(iT[0].w=e.clearColor.w,t=this._pipeline.commandBuffers[0],i=this._shadowFrameBuffer.renderPass,t.beginRenderPass(i,this._shadowFrameBuffer,this._renderArea,iT,e.clearDepth,e.clearStencil),t.endRenderPass())},b.render=function(e){var t,i=this._pipeline,n=i.pipelineSceneData,r=n.shadows,n=n.shadingScale,o=this._globalDS,a=i.commandBuffers[0];this._light&&this._shadowFrameBuffer&&(this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a),t=e.viewport,r=r.size,this._renderArea.x=t.x*r.x,this._renderArea.y=t.y*r.y,this._renderArea.width=t.width*r.x*n,this._renderArea.height=t.height*r.y*n,t=i.device,r=this._shadowFrameBuffer.renderPass,a.beginRenderPass(r,this._shadowFrameBuffer,this._renderArea,iT,e.clearDepth,e.clearStencil),a.bindDescriptorSet(jg.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(t,r,a),a.endRenderPass())},b.activate=function(e,t){eT.prototype.activate.call(this,e,t),this._additiveShadowQueue=new tT(e)},pT.initInfo={name:"ShadowStage",priority:B1.FORWARD,tag:0},r=pT))||r),rT=[],oT=Rre("ShadowFlow",f("ShadowFlow")((l(hT,$b=y),(Sa=hT.prototype).initialize=function(e){return $b.prototype.initialize.call(this,e),0===this._stages.length&&((e=new nT).initialize(nT.initInfo),this._stages.push(e)),!0},Sa.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,n=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===wy.ShadowMap){for(var a=0,s=0;a<i.maxReceived&&s<o.length;){var c=o[s];c.type===Dy.SPOT&&(rT.push(c),a++),s++}if(0!==r.length){i.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;n.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=n.get(l),p=0;p<this._stages.length;p++){var _=this._stages[p];_.setUsage(u,l,h),_.render(e)}}for(var f=0;f<rT.length;f++){var d=rT[f],m=t.globalDSManager.getOrCreateDescriptorSet(f);n.has(d)||this._initShadowFrameBuffer(t,d,e.window.swapchain);for(var g=n.get(d),v=0;v<this._stages.length;v++){var y=this._stages[v];y.setUsage(m,d,g),y.render(e)}}rT.length=0}else this.clearShadowMap(rT,e)}},Sa.destroy=function(){if($b.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,t=Array.from(e.values()),i=0;i<t.length;i++){var n=t[i];if(n){for(var r=n.colorTextures,o=0;o<r.length;o++){var a=r[i];a&&a.destroy()}r.length=0;var s=n.depthStencilTexture;s&&s.destroy(),n.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},Sa._initShadowFrameBuffer=function(e,t){var i=e.device,n=e.pipelineSceneData.shadows.size,e=e.pipelineSceneData.shadowFrameBufferMap,r=hv(i)?W.R32F:W.RGBA8,o=(this._shadowRenderPass||((a=new Ya).format=r,a.loadOp=Yo.CLEAR,a.storeOp=Ko.STORE,a.sampleCount=1,(o=new Ka).format=W.DEPTH_STENCIL,o.depthLoadOp=Yo.CLEAR,o.depthStoreOp=Ko.DISCARD,o.stencilLoadOp=Yo.CLEAR,o.stencilStoreOp=Ko.DISCARD,o.sampleCount=1,a=new Ja([a],o),this._shadowRenderPass=i.createRenderPass(a)),[]),a=(o.push(i.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,r,n.x,n.y))),i.createTexture(new Na(Lo.TEX2D,Bo.DEPTH_STENCIL_ATTACHMENT,W.DEPTH_STENCIL,n.x,n.y))),r=i.createFramebuffer(new ts(this._shadowRenderPass,o,a));e.set(t,r)},Sa.clearShadowMap=function(e,t){var i=this._pipeline,n=i.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;n.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=n.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=n.shadowFrameBufferMap.get(u),p=i.globalDSManager.getOrCreateDescriptorSet(l);if(n.shadowFrameBufferMap.has(u))for(var _=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(p,u,h),f.clearFramebuffer(t)}}},Sa.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,i=this._pipeline,n=i.device,r=i.pipelineSceneData.shadowFrameBufferMap,o=hv(n)?W.R32F:W.RGBA8,a=r.values(),s=a.next();!s.done;)var c,l,u,h=s.value,s=(h&&((c=[]).push(i.device.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,o,t.x,t.y))),(l=h.depthStencilTexture)&&l.resize(t.x,t.y),u=h.renderPass,h.destroy(),h.initialize(new ts(u,c,l))),a.next());e.shadowMapDirty=!1},hT.initInfo={name:n,priority:R.SHADOW,tag:I.SCENE,stages:[]},o=hT))||o),aT=new Fr,sT=Ot({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),cT=sT.LAYERED+1,lT=((a=uT.prototype)._setType=function(e){this._type=this.enabled?e:cT},a._setEnable=function(e){this._enabled=e},a._setAccurate=function(e){this._accurate=e},a.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},a.activate=function(){this._updatePipeline()},a._updatePipeline=function(){var e=j.director.root,t=this.enabled?this.type:cT,i=this.accurate?1:0,n=e.pipeline;n.macros.CC_USE_FOG===t&&n.macros.CC_USE_ACCURATE_FOG===i||(n.macros.CC_USE_FOG=t,n.macros.CC_USE_ACCURATE_FOG=i,e.onGlobalPipelineStateChanged())},a._destroy=function(){},a.destroy=function(){this._destroy()},e(uT,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=cT,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),aT.set(e.x,e.y,e.z,e.w),fy(this._colorArray,aT)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),uT);function uT(){this._fogColor=new nr("#C8C8C8"),this._colorArray=new Fr(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}function hT(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=$b.call.apply($b,[this].concat(i))||this)._shadowRenderPass=null,e}function pT(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=eT.call.apply(eT,[this].concat(i))||this)._shadowFrameBuffer=null,e._renderArea=new va,e._light=null,e._globalDS=null,e}function _T(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new xb,this._batchedQueue=new yb}function fT(e){var t=[];return function e(t,i){for(var n=ge(i);!(r=n()).done;){var r=r.value;Array.isArray(r)?e(t,r):t.push(r)}}(t,e),t.join("")}j.Fog=lT;var dT=Pi.Flags.Destroyed,mT=Pi.Flags.PersistentMask,gT=Ti.IDENTIFIER_RE,vT={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},yT=Ti.escapeForJS,xT=(ST.prototype.toString=function(){return"var "+this.varName+"="+this.expression+";"},ST);function ST(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}function bT(e,t){return t instanceof xT?new xT(t.varName,e+t.expression):e+t}function TT(e,t,i){Array.isArray(i)?(i[0]=bT(t,i[0]),e.push(i)):e.push(bT(t,i)+";")}(Hd=CT.prototype).append=function(e,t){this._exps.push([e,t])},Hd.writeCode=function(e){var t;if(1<this._exps.length)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];TT(e,t+wT(n[0])+"=",n[1])}};var ET=CT;function CT(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}function wT(e){return gT.test(e)?"."+e:"["+yT(e)+"]"}ET.pool=void 0,ET.pool=new dt(function(e){e._exps.length=0,e._targetExp=null},1),ET.pool.get=function(e){var t=this._get()||new ET;return t._targetExp=e,t};(x=PT.prototype).getFuncModule=function(e,t){var i=He(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n)if(-1!==i.indexOf("."))try{if(e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}n=this.funcs.indexOf(e),n<0&&(n=this.funcs.length,this.funcs.push(e)),n="F["+n+"]";return this.funcModuleCache[i]=n=t?"("+n+")":n},x.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},x.setValueType=function(e,t,i,n){for(var r=ET.pool.get(n),o=(o=t.constructor.__props__)||Object.keys(t),a=0;a<o.length;a++){var s=o[a],c=i[s];t[s]!==c&&(c=this.enumerateField(i,s,c),r.append(s,c))}r.writeCode(e),ET.pool.put(r)},x.enumerateCCClass=function(e,t,i){for(var n=i.__values__,r=ni(i),o=0;o<n.length;o++){var a,s=n[o],c=t[s],l=r[s+"$_$default"];!function(e,t){if("function"==typeof e)try{e=e()}catch(e){return}if(e===t)return 1;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof j.ValueType){if(e.equals(t))return 1}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return Oe(e)&&Oe(t)}return}(l,c)&&("object"==typeof c&&c instanceof j.ValueType&&(l=Ti.getDefault(l))&&l.constructor===c.constructor?(a="o"+wT(s),this.setValueType(e,l,c,a)):this.setObjProp(e,t,s,c))}},x.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new xT(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n)TT(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]));return i},x.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var i="a"+ ++this.localVariableId,n=[new xT(i,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&TT(n,i+"["+r+"]=",e[r]);return n},x.enumerateField=function(e,t,i){var n,r,o;return"object"==typeof i&&i?(n=i._iN$t)?((r=n.globalVar)||(r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r),o=n.source[0],n.source[0]=bT(r+"=",o)),r):ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i):"function"==typeof i?this.getFuncModule(i):"string"==typeof i?yT(i):("_objFlags"===t&&e instanceof Pi&&(i&=mT),i)},x.setObjProp=function(e,t,i,n){TT(e,"o"+wT(i)+"=",this.enumerateField(t,i,n))},x.enumerateObject=function(e,t){var i,n=t.constructor;if(j.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var r in t)!t.hasOwnProperty(r)||95===r.charCodeAt(0)&&95===r.charCodeAt(1)&&"__type__"!==r||("object"==typeof(i=t[r])&&i&&i===t._iN$t||this.setObjProp(e,t,r,i))},x.instantiateObj=function(e){if(e instanceof j.ValueType)return Ti.getNewValueTypeCode(e);if(e instanceof j.Asset)return this.getObjRef(e);if(e._objFlags&dT)return null;var t,i=e.constructor;if(j.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof j.Component){if(e instanceof j._BaseNode||e instanceof j.Component)return this.getObjRef(e)}else if(this.parent instanceof j._BaseNode)if(e instanceof j._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof j.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new xT("o","new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new xT("o","{}");else{if(i)return this.getObjRef(e);t=new xT("o","Object.create(null)")}i=[t];return e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e),this.enumerateObject(i,e),["(function(){",i,"return o;})();"]};var AT=PT;function PT(e,t){this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Ge(),Je(this.funcModuleCache,vT),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e);var i,t=fT(["return (function(R){",(i=0<this.globalVariables.length?"var "+this.globalVariables.join(",")+";":i)||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",t)(this.objs,this.funcs);for(var n=0,r=this.objsToClear_iN$t.length;n<r;++n)this.objsToClear_iN$t[n]._iN$t=null;this.objsToClear_iN$t.length=0}LT.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},LT.markOpacityTree=function(){},e(LT,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?J(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]);var T,IT,RT,DT,OT,MT,NT=LT;function LT(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}Pi.Flags.Destroying,(c=T=T||{}).TOUCH_START="touch-start",c.TOUCH_MOVE="touch-move",c.TOUCH_END="touch-end",c.TOUCH_CANCEL="touch-cancel",c.MOUSE_DOWN="mouse-down",c.MOUSE_MOVE="mouse-move",c.MOUSE_UP="mouse-up",c.MOUSE_WHEEL="mouse-wheel",c.MOUSE_ENTER="mouse-enter",c.MOUSE_LEAVE="mouse-leave",c.KEY_DOWN="keydown",c.KEY_UP="keyup",c.DEVICEMOTION="devicemotion",c.TRANSFORM_CHANGED="transform-changed",c.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",c.SIZE_CHANGED="size-changed",c.ANCHOR_CHANGED="anchor-changed",c.COLOR_CHANGED="color-changed",c.CHILD_ADDED="child-added",c.CHILD_REMOVED="child-removed",c.PARENT_CHANGED="parent-changed",c.NODE_DESTROYED="node-destroyed",c.LAYER_CHANGED="layer-changed",c.SIBLING_ORDER_CHANGED="sibling-order-changed",c.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed";var BT=Pi.Flags.Destroying,FT=Pi.Flags.DontDestroy,zT=Pi.Flags.Deactivating,UT=new Ce("Node");function kT(e){return e?"string"==typeof e?_t(e):e:(ee(3804),null)}var GT,HT,VT,jT,WT,qT,XT=Rre("BaseNode",f("cc.BaseNode")((l(YT,qT=Pi),YT._setScene=function(e){e._updateScene()},YT._findComponent=function(e,t){var i=e._components;if(t._sealed)for(var n=0;n<i.length;++n){var r=i[n];if(r.constructor===t)return r}else for(var o=0;o<i.length;++o){var a=i[o];if(a instanceof t)return a}return null},YT._findComponents=function(e,t,i){var n=e._components;if(t._sealed)for(var r=0;r<n.length;++r){var o=n[r];o.constructor===t&&i.push(o)}else for(var a=0;a<n.length;++a){var s=n[a];s instanceof t&&i.push(s)}},YT._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var n=e[i],r=YT._findComponent(n,t);if(r)return r;if(0<n._children.length&&(r=YT._findChildComponent(n._children,t)))return r}return null},YT._findChildComponents=function(e,t,i){for(var n=0;n<e.length;++n){var r=e[n];YT._findComponents(r,t,i),0<r._children.length&&YT._findChildComponents(r._children,t,i)}},(t=YT.prototype)._updateScene=function(){null==this._parent?tt("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){Je(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){var i;void 0===t&&(t=!1),this._parent!==e&&(i=this._parent,this._parent=e=e,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(T.PARENT_CHANGED,i),!i||i._objFlags&BT||(t=i._children.indexOf(this),i._children.splice(t,1),i._updateSiblingIndex(),i.emit&&i.emit(T.CHILD_REMOVED,this)),e&&(e._children.push(this),this._siblingIndex=e._children.length-1,e.emit&&e.emit(T.CHILD_ADDED,this)),this._onHierarchyChanged(i))},t.getChildByUuid=function(e){if(!e)return H("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null},t.getChildByName=function(e){if(!e)return H("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null},t.getChildByPath=function(e){for(var i=e.split("/"),n=this,t=0;t<i.length;++t){var r=function(e){var t=i[e];return 0===t.length?"continue":(e=n.children.find(function(e){return e.name===t}))?void(n=e):{v:null}}(t);if("continue"!==r&&"object"==typeof r)return r.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){var t,i;this._parent&&(this._parent._objFlags&zT?ee(3821):(t=this._parent._children,(e=-1!==e?e:t.length-1)!==(i=t.indexOf(this))&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))))},t.walk=function(e,t){var i,n=1,r=null,o=0,a=YT._stacks[YT._stackId];a||YT._stacks.push(a=[]),YT._stackId++,a.length=0,a[0]=this;for(var s=null,c=!1;n;)if(i=a[--n])if(!c&&e?e(i):c&&t&&t(i),a[n]=null,c){if(s===this._parent)break;if(c=!1,r)if(r[++o])a[n]=r[o],n++;else if(s&&(a[n]=s,n++,c=!0,s._parent?(o=(r=s._parent._children).indexOf(s),s=s._parent):r=s=null,o<0))break}else 0<i._children.length?(r=(s=i)._children,a[n]=r[o=0],n++):(a[n]=i,n++,c=!0);a.length=0,YT._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){-1<this._children.indexOf(e)&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;0<=t;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0}while(t=t._parent);return!1},t.getComponent=function(e){e=kT(e);return e?YT._findComponent(this,e):null},t.getComponents=function(e){var e=kT(e),t=[];return e&&YT._findComponents(this,e,t),t},t.getComponentInChildren=function(e){e=kT(e);return e?YT._findChildComponent(this._children,e):null},t.getComponentsInChildren=function(e){var e=kT(e),t=[];return e&&(YT._findComponents(this,e,t),YT._findChildComponents(this._children,e,t)),t},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=_t(e)))throw j._RF.peek()&&ee(3808,e),TypeError(oe(3807,e))}else{if(!e)throw TypeError(oe(3804));t=e}if("function"!=typeof t)throw TypeError(oe(3809));if(!it(t,j.Component))throw TypeError(oe(3810));var i=t._requireComponent;if(i)if(Array.isArray(i))for(var n=0;n<i.length;n++){var r=i[n];this.getComponent(r)||this.addComponent(r)}else{e=i;this.getComponent(e)||this.addComponent(e)}e=new t;return(e.node=this)._components.push(e),this._activeInHierarchy&&j.director._nodeActivator.activateComp(e),e},t.removeComponent=function(e){var t;e?(t=null,(t=e instanceof W_?e:this.getComponent(e))&&t.destroy()):ee(3813)},t.on=function(e,t,i,n){void 0===n&&(n=!1),e===T.TRANSFORM_CHANGED&&(this._eventMask|=1),this._eventProcessor.on(e,t,i,n)},t.off=function(e,t,i,n){this._eventProcessor.off(e,t,i,n=void 0===n?!1:n),this._eventProcessor.hasEventListener(e)||e===T.TRANSFORM_CHANGED&&(this._eventMask&=-2)},t.once=function(e,t,i,n){this._eventProcessor.once(e,t,i,n)},t.emit=function(e,t,i,n,r,o){this._eventProcessor.emit(e,t,i,n,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(T.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!qT.prototype.destroy.call(this)&&!(this.active=!1)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){var t;e?this._objFlags&BT||(-1!==(t=this._components.indexOf(e))?this._components.splice(t,1):e.node!==this&&ee(3815)):ee(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(T.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){!this._parent||null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(YT._setScene)},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return(e=e||j.instantiate._clone(this,this))._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent,e=(!this._persistNode||e instanceof j.Scene||j.game.removePersistRootNode(this),this._active&&!(!e||!e._activeInHierarchy));this._activeInHierarchy!==e&&j.director._nodeActivator.activateNode(this,e)},t._onPreDestroyBase=function(){this._objFlags|=BT;var e,t=this._parent,i=!!t&&0!=(t._objFlags&BT);this._persistNode&&j.game.removePersistRootNode(this),!i&&t&&(this.emit(T.PARENT_CHANGED,this),e=t._children.indexOf(this),t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(T.CHILD_REMOVED,this)),this.emit(T.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return i},e(YT,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&FT)},set:function(e){e?this._objFlags|=FT:this._objFlags&=~FT}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){var t;this._active!==e&&(this._active=e,(t=this._parent)&&t._activeInHierarchy&&j.director._nodeActivator.activateNode(this,e))}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),S=g=YT,g.idGenerator=UT,g._stacks=[[]],g._stackId=0,i((b=S).prototype,"_persistNode",[gp],Object.getOwnPropertyDescriptor(b.prototype,"_persistNode"),b.prototype),i(b.prototype,"name",[Ap],Object.getOwnPropertyDescriptor(b.prototype,"name"),b.prototype),i(b.prototype,"children",[Ap],Object.getOwnPropertyDescriptor(b.prototype,"children"),b.prototype),i(b.prototype,"active",[Ap],Object.getOwnPropertyDescriptor(b.prototype,"active"),b.prototype),i(b.prototype,"activeInHierarchy",[Ap],Object.getOwnPropertyDescriptor(b.prototype,"activeInHierarchy"),b.prototype),i(b.prototype,"parent",[Ap],Object.getOwnPropertyDescriptor(b.prototype,"parent"),b.prototype),IT=i(b.prototype,"_parent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RT=i(b.prototype,"_children",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DT=i(b.prototype,"_active",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),OT=i(b.prototype,"_components",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MT=i(b.prototype,"_prefab",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B1=b))||B1);function YT(e){var t;return _(t=qT.call(this,e)||this,"_parent",IT,p(t)),_(t,"_children",RT,p(t)),_(t,"_active",DT,p(t)),_(t,"_components",OT,p(t)),_(t,"_prefab",MT,p(t)),t._scene=null,t._activeInHierarchy=!1,t._id=UT.getNewId(),t._name=void 0,t._eventProcessor=new j.NodeEventProcessor(p(t)),t._eventMask=0,t._siblingIndex=0,t._originalSceneId="",t._registerIfAttached=void 0,t._name=void 0!==e?e:"New Node",t}j._BaseNode=XT;var KT=new ce,QT=new gr,ZT=new gr,JT=new gr,$T=new pr,e1=new pr,t1=new B,i1=[],n1=[],r1=[],Sa=((r=o1.prototype).alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},r.free=function(e,t){for(var i=this._freelists.length,n=0;n<i;++n)if(this._chunks[n]===e)return void this._freelists[n].push(t)},r.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},r._createChunk=function(){this._chunks.push(new Uint32Array(o1.CAPACITY_PER_CHUNK));for(var e=[],t=o1.CAPACITY_PER_CHUNK-1;0<=t;t--)e.push(t);this._freelists.push(e)},r._createView=function(e){return r1[0]=this._chunks[e],r1[1]=this._freelists[e].pop(),r1},o1);function o1(){this._chunks=[],this._freelists=[],this._createChunk()}Sa.CAPACITY_PER_CHUNK=256;var a1,s1,c1,l1,u1,h1,p1,_1,f1,d1,m1,g1,v1,y1,x1,S1,b1,T1,E1,C1,w1,A1,P1,I1,R1,D1,O1,M1=new Sa,n=Symbol("ReserveContentsForAllSyncablePrefab"),N1=Rre("Node",(R=f("cc.Node"),I=v(ce),R((l(L1,O1=XT),(o=L1.prototype)._init=function(){var e=M1.alloc(),t=e[0],e=e[1],t=(this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=e,new Uint32Array(t.buffer,t.byteOffset+4*e,1));this._hasChangedFlags=t,this._pos=new ce,this._rot=new gr,this._scale=new ce(1,1,1),this._mat=new B},L1.isNode=function(e){return e instanceof L1&&(e.constructor===L1||!(e instanceof j.Scene))},o._onPreDestroy=function(){var e=this._onPreDestroyBase();return M1.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},o[Z_]=function(e){e.writeThis()},o.setParent=function(e,t){(t=void 0===t?!1:t)&&this.updateWorldTransform(),O1.prototype.setParent.call(this,e,t)},o._onSetParent=function(e,t){O1.prototype._onSetParent.call(this,e,t),t&&((e=this._parent)?(e.updateWorldTransform(),B.multiply(t1,B.invert(t1,e._mat),this._mat),B.toRTS(t1,this._lrot,this._lpos,this._lscale)):(ce.copy(this._lpos,this._pos),gr.copy(this._lrot,this._rot),ce.copy(this._lscale,this._scale)),this._eulerDirty=!0),this.invalidateChildren(Q0.TRS)},o._onHierarchyChanged=function(e){this.eventProcessor.reattach(),O1.prototype._onHierarchyChangedBase.call(this,e)},o._onBatchCreated=function(e){this.hasChangedFlags=Q0.TRS,this._dirtyFlags|=Q0.TRS;for(var t=this._children.length,i=0;i<t;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},o._onBeforeSerialize=function(){this.eulerAngles},o._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(Q0.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},o.translate=function(e,t){var t=t||K0.LOCAL;t===K0.LOCAL?(ce.transformQuat(KT,e,this._lrot),this._lpos.x+=KT.x,this._lpos.y+=KT.y,this._lpos.z+=KT.z):t===K0.WORLD&&(this._parent?(gr.invert(QT,this._parent.worldRotation),ce.transformQuat(KT,e,QT),t=this.worldScale,this._lpos.x+=KT.x/t.x,this._lpos.y+=KT.y/t.y,this._lpos.z+=KT.z/t.z):(this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z)),this.invalidateChildren(Q0.POSITION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.POSITION)},o.rotate=function(e,t){t=t||K0.LOCAL;gr.normalize(QT,e),t===K0.LOCAL?gr.multiply(this._lrot,this._lrot,QT):t===K0.WORLD&&(e=this.worldRotation,gr.multiply(ZT,QT,e),gr.invert(QT,e),gr.multiply(ZT,QT,ZT),gr.multiply(this._lrot,this._lrot,ZT)),this._eulerDirty=!0,this.invalidateChildren(Q0.ROTATION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.ROTATION)},o.lookAt=function(e,t){this.getWorldPosition(KT),ce.subtract(KT,KT,e),ce.normalize(KT,KT),gr.fromViewUp(QT,KT,t),this.setWorldRotation(QT)},o._setDirtyNode=function(e,t){i1[e]=t},o.invalidateChildren=function(e){var t,i,n,r,o,a=0,s=0,c=0,l=e|Q0.POSITION;for(i1[0]=this;0<=a;){if(o=(t=i1[a--])._hasChangedFlags[0],c=t._dirtyFlagsPri,t.isValid&&(c&o&e)!==e)for(c|=e,t._dirtyFlagsPri=c,t._hasChangedFlags[0]=o|e,r=(n=t._children).length,s=0;s<r;s++)i=n[s],i1[++a]=i;e=l}},o.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)this._setDirtyNode(i++,t),t=t._parent;for(var n=0;i;)n|=(e=i1[--i])._dirtyFlags,t?(n&Q0.POSITION&&(ce.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Q0.RS&&(B.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),B.multiply(e._mat,t._mat,e._mat),n&Q0.ROTATION&&gr.multiply(e._rot,t._rot,e._lrot),pr.fromQuat($T,gr.conjugate(JT,e._rot)),pr.multiplyMat4($T,$T,e._mat),e._scale.x=$T.m00,e._scale.y=$T.m04,e._scale.z=$T.m08)):(n&Q0.POSITION&&(ce.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),n&Q0.RS&&(n&Q0.ROTATION&&gr.copy(e._rot,e._lrot),n&Q0.SCALE&&(ce.copy(e._scale,e._lscale),B.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=Q0.NONE,t=e}},o.setPosition=function(e,t,i){void 0===t&&void 0===i?ce.copy(this._lpos,e):void 0===i?ce.set(this._lpos,e,t,this._lpos.z):ce.set(this._lpos,e,t,i),this.invalidateChildren(Q0.POSITION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.POSITION)},o.getPosition=function(e){return e?ce.set(e,this._lpos.x,this._lpos.y,this._lpos.z):ce.copy(new ce,this._lpos)},o.setRotation=function(e,t,i,n){void 0===t||void 0===i||void 0===n?gr.copy(this._lrot,e):gr.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(Q0.ROTATION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.ROTATION)},o.setRotationFromEuler=function(e,t,i){i=void 0===i?this._euler.z:i;void 0===t?(ce.copy(this._euler,e),gr.fromEuler(this._lrot,e.x,e.y,e.z)):(ce.set(this._euler,e,t,i),gr.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(Q0.ROTATION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.ROTATION)},o.getRotation=function(e){return e?gr.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):gr.copy(new gr,this._lrot)},o.setScale=function(e,t,i){void 0===t&&void 0===i?ce.copy(this._lscale,e):void 0===i?ce.set(this._lscale,e,t,this._lscale.z):ce.set(this._lscale,e,t,i),this.invalidateChildren(Q0.SCALE),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.SCALE)},o.getScale=function(e){return e?ce.set(e,this._lscale.x,this._lscale.y,this._lscale.z):ce.copy(new ce,this._lscale)},o.inverseTransformPoint=function(e,t){ce.copy(e,t);for(var i=this,n=0;i._parent;)this._setDirtyNode(n++,i),i=i._parent;for(;0<=n;)ce.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=i1[--n];return e},o.setWorldPosition=function(e,t,i){void 0===t||void 0===i?ce.copy(this._pos,e):ce.set(this._pos,e,t,i);e=this._parent,t=this._lpos;e?(e.updateWorldTransform(),ce.transformMat4(t,this._pos,B.invert(t1,e._mat))):ce.copy(t,this._pos),this.invalidateChildren(Q0.POSITION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.POSITION)},o.getWorldPosition=function(e){return this.updateWorldTransform(),e?ce.copy(e,this._pos):ce.copy(new ce,this._pos)},o.setWorldRotation=function(e,t,i,n){void 0===t||void 0===i||void 0===n?gr.copy(this._rot,e):gr.set(this._rot,e,t,i,n),this._parent?(this._parent.updateWorldTransform(),gr.multiply(this._lrot,gr.conjugate(this._lrot,this._parent._rot),this._rot)):gr.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Q0.ROTATION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.ROTATION)},o.setWorldRotationFromEuler=function(e,t,i){gr.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),gr.multiply(this._lrot,gr.conjugate(this._lrot,this._parent._rot),this._rot)):gr.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Q0.ROTATION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.ROTATION)},o.getWorldRotation=function(e){return this.updateWorldTransform(),e?gr.copy(e,this._rot):gr.copy(new gr,this._rot)},o.setWorldScale=function(e,t,i){void 0===t||void 0===i?ce.copy(this._scale,e):ce.set(this._scale,e,t,i);e=this._parent;e?(e.updateWorldTransform(),pr.fromQuat($T,gr.conjugate(JT,e._rot)),pr.multiplyMat4($T,$T,e._mat),e1.m00=this._scale.x,e1.m04=this._scale.y,e1.m08=this._scale.z,pr.multiply($T,e1,pr.invert($T,$T)),this._lscale.x=ce.set(KT,$T.m00,$T.m01,$T.m02).length(),this._lscale.y=ce.set(KT,$T.m03,$T.m04,$T.m05).length(),this._lscale.z=ce.set(KT,$T.m06,$T.m07,$T.m08).length()):ce.copy(this._lscale,this._scale),this.invalidateChildren(Q0.SCALE),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.SCALE)},o.getWorldScale=function(e){return this.updateWorldTransform(),e?ce.copy(e,this._scale):ce.copy(new ce,this._scale)},o.getWorldMatrix=function(e){this.updateWorldTransform();e=e||new B;return B.copy(e,this._mat)},o.getWorldRS=function(e){this.updateWorldTransform();e=e||new B;return B.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},o.getWorldRT=function(e){this.updateWorldTransform();e=e||new B;return B.fromRT(e,this._rot,this._pos)},o.setRTS=function(e,t,i){var n=0;e&&(n|=Q0.ROTATION,void 0!==e.w?(gr.copy(this._lrot,e),this._eulerDirty=!0):(ce.copy(this._euler,e),gr.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(ce.copy(this._lpos,t),n|=Q0.POSITION),i&&(ce.copy(this._lscale,i),n|=Q0.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,n))},o.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},o.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},L1.resetHasChangedFlags=function(){M1.clear()},L1.clearNodeArray=function(){L1.ClearFrame<L1.ClearRound?L1.ClearFrame++:(L1.ClearFrame=0,i1.length=0,n1.length=0)},e(L1,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(gr.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){ce.set(this._euler,0,0,e),gr.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(Q0.ROTATION),1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){B.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Q0.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(T.TRANSFORM_CHANGED,Q0.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return ce.transformQuat(new ce,ce.FORWARD,this.worldRotation)},set:function(e){var t=e.length();ce.multiplyScalar(KT,e,-1/t),gr.fromViewUp(QT,KT),this.setWorldRotation(QT)}},{key:"up",get:function(){return ce.transformQuat(new ce,ce.UP,this.worldRotation)}},{key:"right",get:function(){return ce.transformQuat(new ce,ce.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(T.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),Hd=a=L1,a.EventType=T,a.NodeSpace=K0,a.TransformDirtyBit=Q0,a.TransformBit=Q0,a.reserveContentsForAllSyncablePrefabTag=n,a.ClearFrame=0,a.ClearRound=1e3,GT=i((x=Hd).prototype,"_lpos",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),HT=i(x.prototype,"_lrot",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gr}}),VT=i(x.prototype,"_lscale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(1,1,1)}}),jT=i(x.prototype,"_layer",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tg.Enum.DEFAULT}}),WT=i(x.prototype,"_euler",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),i(x.prototype,"eulerAngles",[I],Object.getOwnPropertyDescriptor(x.prototype,"eulerAngles"),x.prototype),i(x.prototype,"angle",[Ap],Object.getOwnPropertyDescriptor(x.prototype,"angle"),x.prototype),i(x.prototype,"layer",[Ap],Object.getOwnPropertyDescriptor(x.prototype,"layer"),x.prototype),c=x))||c));function L1(e){return(e=O1.call(this,e)||this)._uiProps=new NT(p(e)),e._static=!1,_(e,"_lpos",GT,p(e)),_(e,"_lrot",HT,p(e)),_(e,"_lscale",VT,p(e)),_(e,"_layer",jT,p(e)),_(e,"_euler",WT,p(e)),e._dirtyFlagsPri=Q0.NONE,e._eulerDirty=!1,e._nodeHandle=0,e._init(),e}j.Node=N1;var S=f("cc.TargetInfo")((a1=i((t=function(){_(this,"localID",a1,this)}).prototype,"localID",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),g=t))||g,a=(b=f("cc.TargetOverrideInfo"),B1=v(Pi),r=v(S),Sa=v(N1),R=v(S),b((s1=i((o=function(){_(this,"source",s1,this),_(this,"sourceInfo",c1,this),_(this,"propertyPath",l1,this),_(this,"target",u1,this),_(this,"targetInfo",h1,this)}).prototype,"source",[d,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c1=i(o.prototype,"sourceInfo",[d,r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),l1=i(o.prototype,"propertyPath",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u1=i(o.prototype,"target",[d,Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h1=i(o.prototype,"targetInfo",[d,R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n=o))||n),x=f("cc.CompPrefabInfo")((p1=i((Hd=function(){_(this,"fileId",p1,this)}).prototype,"fileId",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),I=Hd))||I,B1=(c=f("CCPropertyOverrideInfo"),t=v(S),c((k1.prototype.isTarget=function(){},_1=i((g=k1).prototype,"targetInfo",[d,t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f1=i(g.prototype,"propertyPath",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),d1=i(g.prototype,"value",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b=g))||b),Hd=(r=f("cc.MountedChildrenInfo"),Sa=v(S),R=v([N1]),r((U1.prototype.isTarget=function(){},m1=i((o=U1).prototype,"targetInfo",[d,Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g1=i(o.prototype,"nodes",[d,R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n=o))||n),r=(I=f("cc.MountedComponentsInfo"),c=v(S),t=v([W_]),I((z1.prototype.isTarget=function(){},v1=i((g=z1).prototype,"targetInfo",[d,c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y1=i(g.prototype,"components",[d,t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),b=g))||b),Sa=(Sa=f("cc.PrefabInstance"),R=v(N1),o=v([Hd]),n=v([r]),I=v([B1]),c=v([S]),Sa(((t=F1.prototype).findPropertyOverride=function(){},t.removePropertyOverride=function(){},x1=i((g=F1).prototype,"fileId",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),S1=i(g.prototype,"prefabRootNode",[d,R],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),b1=i(g.prototype,"mountedChildren",[d,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),T1=i(g.prototype,"mountedComponents",[d,n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E1=i(g.prototype,"propertyOverrides",[d,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),C1=i(g.prototype,"removedComponents",[d,c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),b=g))||b),g=(t=f("cc.PrefabInfo"),R=v(N1),o=v(Sa),n=v([a]),t((w1=i((I=function(){_(this,"root",w1,this),_(this,"asset",A1,this),_(this,"fileId",P1,this),_(this,"instance",I1,this),_(this,"targetOverrides",R1,this),_(this,"nestedPrefabInstanceRoots",D1,this)}).prototype,"root",[d,R],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),A1=i(I.prototype,"asset",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),P1=i(I.prototype,"fileId",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),I1=i(I.prototype,"instance",[d,o],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),R1=i(I.prototype,"targetOverrides",[d,n],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),D1=i(I.prototype,"nestedPrefabInstanceRoots",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),c=I))||c);function F1(){_(this,"fileId",x1,this),_(this,"prefabRootNode",S1,this),_(this,"mountedChildren",b1,this),_(this,"mountedComponents",T1,this),_(this,"propertyOverrides",E1,this),_(this,"removedComponents",C1,this),this.targetMap={}}function z1(){_(this,"targetInfo",v1,this),_(this,"components",y1,this)}function U1(){_(this,"targetInfo",m1,this),_(this,"nodes",g1,this)}function k1(){_(this,"targetInfo",_1,this),_(this,"propertyPath",f1,this),_(this,"value",d1,this)}function G1(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return ee(3701,e.name),void(t.instance=void 0);var i=e._objFlags,n=e._parent,r=e._id,o=e._prefab;e[wi],j.game._isCloning=!0,t.asset._doInstantiate(e),j.game._isCloning=!1,e._objFlags=i,e._parent=n,e._id=r,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function H1(e,t,i){if(t&&e){var n=t,r=null==(r=e._prefab)?void 0:r.instance,i=(!i&&r&&(t[r.fileId]={},n=t[r.fileId]),e._prefab);i&&(n[i.fileId]=e);for(var o=e.components,a=0;a<o.length;a++){var s=o[a];s.__prefab&&(n[s.__prefab.fileId]=s)}for(var c=0;c<e.children.length;c++)H1(e.children[c],n,!1)}}function V1(e,t){if(!e)return null;for(var i=t,n=0;n<e.length;n++){if(!i)return null;i=i[e[n]]}return i}function j1(e,t,i){if(t)for(var n=0;n<t.length;n++){var r=t[n];if(r&&r.targetInfo){var o=V1(r.targetInfo.localID,i);if(o){var a=i,s=r.targetInfo.localID;if(0<s.length)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,H1(u,a,!1),u._siblingIndex=o._children.length-1,K1(u,!0))}}}}}function W1(e,t,i){if(t)for(var n=0;n<t.length;n++){var r=t[n];if(r&&r.targetInfo){var o=V1(r.targetInfo.localID,i);if(o&&r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o)._components.push(s)}}}}function q1(e,t,i){if(t)for(var n=0;n<t.length;n++){var r,o=t[n];!o||(o=V1(o.localID,i))&&o.node&&(0<=(r=o.node.components.indexOf(o))&&o.node._components.splice(r,1))}}function X1(e,t,i){if(!(t.length<=0))for(var n=0;n<t.length;n++){var r=t[n];if(r&&r.targetInfo&&(s=V1(r.targetInfo.localID,i))){var o=s,a=r.propertyPath.slice();if(0<a.length){var s=a.pop();if(s){for(var c,l=0;l<a.length&&(o=o[a[l]]);l++);o&&(Array.isArray(o)?"length"===s?o[s]=r.value:(c=Number.parseInt(s),Number.isInteger(c)&&c<o.length&&(o[s]=r.value)):o[s]instanceof Bt?o[s].set(r.value):o[s]=r.value)}}}}}function Y1(e){var t=null==(e=e._prefab)?void 0:e.targetOverrides;if(t)for(var i=0;i<t.length;i++){var n,r=t[i],o=r.source,a=r.sourceInfo;if(!a||(n=null==(n=r.source)||null==(n=n._prefab)?void 0:n.instance)&&n.targetMap&&(o=V1(a.localID,n.targetMap)),o){var a=r.targetInfo;if(a){var s=null==(n=r.target)||null==(s=n._prefab)?void 0:s.instance;if(s&&s.targetMap&&(a=V1(a.localID,s.targetMap))){var c=r.propertyPath.slice(),l=o;if(0<c.length){r=c.pop();if(!r)return;for(var u=0;u<c.length&&(l=l[c[u]]);u++);l&&(l[r]=a)}}}}}}function K1(e,t){void 0===t&&(t=!1);var i,n=e._prefab,n=null==n?void 0:n.instance;n&&(G1(e),H1(e,n.targetMap=i={},!0),j1(0,n.mountedChildren,i),q1(0,n.removedComponents,i),W1(0,n.mountedComponents,i),X1(0,n.propertyOverrides,i)),t&&e&&e.children&&e.children.forEach(function(e){K1(e,!0)})}function Q1(e){e=e._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach(function(e){K1(e)})}j._PrefabInfo=g;var Z1,J1,$1,eE,tE,iE,b=Object.freeze({__proto__:null,TargetInfo:S,TargetOverrideInfo:a,CompPrefabInfo:x,PropertyOverrideInfo:B1,MountedChildrenInfo:Hd,MountedComponentsInfo:r,PrefabInstance:Sa,PrefabInfo:g,createNodeWithPrefab:G1,generateTargetMap:H1,getTarget:V1,applyMountedChildren:j1,applyMountedComponents:W1,applyRemovedComponents:q1,applyPropertyOverrides:X1,applyTargetOverrides:Y1,expandPrefabInstanceNode:K1,expandNestedPrefabInstanceNode:Q1}),nE=Ot({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),c=Rre("Prefab",f("cc.Prefab")((l(rE,tE=P_),(t=rE.prototype).createNode=function(e){var t=j.instantiate(this);t.name=this.name,e(null,t)},t.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof j._BaseNode&&e,new AT(e,t).result)},t._doInstantiate=function(e){return this.data._prefab||J(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},t._instantiate=function(){var e;return this.optimizationPolicy!==nE.SINGLE_INSTANCE&&(this.optimizationPolicy===nE.MULTI_INSTANCE||this._instantiatedTimes+1>=rE.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},t.initDefault=function(e){tE.prototype.initDefault.call(this,e),this.data=new N1,this.data.name="(Missing Node)";e=new j._PrefabInfo;e.asset=this,e.root=this.data,this.data._prefab=e},t.validate=function(){return!!this.data},t.onLoaded=function(){var e=this.data;Q1(e),Y1(e)},o=R=rE,R.OptimizationPolicy=nE,R.OptimizationPolicyThreshold=3,Z1=i((n=o).prototype,"data",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J1=i(n.prototype,"optimizationPolicy",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nE.AUTO}}),$1=i(n.prototype,"persistent",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I=n))||I);function rE(){var e;return _(e=tE.call(this)||this,"data",Z1,p(e)),_(e,"optimizationPolicy",J1,p(e)),_(e,"persistent",$1,p(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}function oE(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=iE.call.apply(iE,[this].concat(i))||this,"prefab",eE,p(e)),e}gt.value(c,"_utils",b),j.Prefab=c,Ve(j,"cc._Prefab","Prefab"),Rre("PrefabLink",(S=f("cc.PrefabLink"),a=v(c),x=Pp(),S((l(oE,iE=W_),eE=i((B1=oE).prototype,"prefab",[a,d,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hd=B1))||Hd));var aE=new ce;function sE(e,t,i,n){n=n||new ce,e.convertToUINode(t,i,n);e=i.position;return n.add(e),n}function cE(e,t,i){return i=i||new ce,e.worldToScreen(t,i),i.x/=j.view.getScaleX(),i.y/=j.view.getScaleY(),i}r=Rre("convertUtils",{WorldNode3DToLocalNodeUI:sE,WorldNode3DToWorldNodeUI:cE});j.pipelineUtils=r,In(j.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[3]||aE;return n.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),Ee(Uv.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),In(cb.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var lE,uE=Rre("BufferAsset",f("cc.BufferAsset")((i((l(hE,lE=P_),(Sa=hE.prototype).buffer=function(){return this._buffer},Sa.validate=function(){return!!this.buffer},e(hE,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),g=hE).prototype,"_nativeAsset",[Gp],Object.getOwnPropertyDescriptor(g.prototype,"_nativeAsset"),g.prototype),t=g))||t);function hE(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=lE.call.apply(lE,[this].concat(i))||this)._buffer=null,e}j.BufferAsset=uE;(R={})[Io.UNORM]="Uint",R[Io.SNORM]="Int",R[Io.UINT]="Uint",R[Io.INT]="Int",R[Io.UFLOAT]="Float",R[Io.FLOAT]="Float",R.default="Uint";var pE=R;function _E(e){return""+(pE[e.type]||pE.default)+e.size/e.count*8}function fE(e,t,i,n,r){void 0===i&&(i=W.R32F),void 0===n&&(n=0);var o=dc[i];r=(r=void 0===r?0:r)||o.size;for(var a="set"+_E(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=af.isLittleEndian,u=0;u<c;++u)for(var h=n+r*u,p=0;p<o.count;++p)e[a](h+s*p,t[o.count*u+p],l)}function dE(e,t,i,n,r,o){void 0===t&&(t=W.R32F),void 0===i&&(i=0),void 0===n&&(n=e.byteLength-i),void 0===o&&(o=[]);var a=dc[t];r=(r=void 0===r?0:r)||a.size;for(var s="get"+_E(a),c=a.size/a.count,l=Math.floor(n/r),u=af.isLittleEndian,h=0;h<l;++h)for(var p=i+r*h,_=0;_<a.count;++_)o[a.count*h+_]=e[s](p+c*_,u);return o}function mE(e,t,i,n,r,o,a){void 0===i&&(i=W.R32F),void 0===n&&(n=0),void 0===r&&(r=e.byteLength-n),void 0===o&&(o=0),a=a||new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));var s=dc[i];o=o||s.size;for(var c="set"+_E(s),l="get"+_E(s),u=s.size/s.count,h=Math.floor(r/o),p=af.isLittleEndian,_=0;_<h;++_)for(var f=n+o*_,d=0;d<s.count;++d){var m=f+u*d,g=e[l](m,p);a[c](m,t(g,d,e),p)}return a}var gE,vE,yE=Rre("RenderingSubMesh",((o=xE.prototype)._init=function(){},o.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,i=e.struct.primitives[this.subMeshIdx];i.indexView&&(t=i.indexView.count);for(var n=0;n<i.vertexBundelIndices.length;n++){var r=i.vertexBundelIndices[n],r=e.struct.vertexBundles[r],o=(i.indexView||r.view).count,a=r.view.stride,s=a*o,c=new Uint8Array(e.data.buffer,r.view.offset,r.view.length),l=new Uint8Array(i.indexView?s:r.view.length);if(i.indexView){for(var u=e.readIndices(this.subMeshIdx),h=0;h<t;++h)for(var p=h*a,_=u[h]*a,f=0;f<a;++f)l[p+f]=c[_+f];this._flatBuffers.push({stride:a,count:o,buffer:l})}else l.set(e.data.subarray(r.view.offset,r.view.offset+r.view.length)),this._flatBuffers.push({stride:a,count:o,buffer:l})}}},o.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},o.enableVertexIdChannel=function(e){var t,i;this._vertexIdChannel||(t=this.vertexBuffers.length,i=this.attributes.length,e=this._allocVertexIdBuffer(e),this._vertexBuffers.push(e),this._attributes.push(new Wa("a_vertexId",W.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:i})},o._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t),n=0;n<t;++n)i[n]=n+.5;e=e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return e.update(i),e},e(xE,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:ce.ZERO,max:ce.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:ce.ZERO,max:ce.ZERO}};var e=this.mesh,t=this.subMeshIdx,i=e.readAttribute(t,fa.ATTR_POSITION),e=e.readIndices(t),n=new ce,r=new ce,t=this.attributes.find(function(e){return e.name===fa.ATTR_POSITION});if(t){var o=dc[t.format].count;2===o?(n.set(i[0],i[1],0),r.set(i[0],i[1],0)):(n.set(i[0],i[1],i[2]),r.set(i[0],i[1],i[2]));for(var a=0;a<i.length;a+=o)2===o?(n.x=i[a]>n.x?i[a]:n.x,n.y=i[a+1]>n.y?i[a+1]:n.y,r.x=i[a]<r.x?i[a]:r.x,r.y=i[a+1]<r.y?i[a+1]:r.y):(n.x=i[a]>n.x?i[a]:n.x,n.y=i[a+1]>n.y?i[a+1]:n.y,n.z=i[a+2]>n.z?i[a+2]:n.z,r.x=i[a]<r.x?i[a]:r.x,r.y=i[a+1]<r.y?i[a+1]:r.y,r.z=i[a+2]<r.z?i[a+2]:r.z)}return this._geometricInfo={positions:i,indices:e,boundingBox:{max:n,min:r}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var n=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var r=this._jointMappedBuffers=[],o=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var a=this.mesh.struct,s=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===s.jointMapIndex||!a.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=j.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){for(var u=a.vertexBundles[s.vertexBundelIndices[l]],h=0,p=W.UNKNOWN,e=0;e<u.attributes.length;e++){var t=u.attributes[e];if(t.name===fa.ATTR_JOINTS){p=t.format;break}h+=dc[t.format].size}p?function(){var e=new Uint8Array(n.mesh.data.buffer,u.view.offset,u.view.length),e=new DataView(e.slice().buffer),t=a.jointMaps[s.jointMapIndex],i=(mE(e,function(e){return t.indexOf(e)},p,h,u.view.length,u.view.stride,e),c.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,u.view.length,u.view.stride)));i.update(e.buffer),r.push(i),o.push(l)}():r.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&r.push(this._allocVertexIdBuffer(c)),r}},{key:"iaInfo",get:function(){return this._iaInfo}}]),xE));function xE(e,t,i,n,r){void 0===n&&(n=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=n,this._indirectBuffer=r,this._primitiveMode=i,this._iaInfo=new Xa(t,e,n,r),this._init()}(n=gE=gE||Rre("SystemEventType",{})).TOUCH_START="touch-start",n.TOUCH_MOVE="touch-move",n.TOUCH_END="touch-end",n.TOUCH_CANCEL="touch-cancel",n.MOUSE_DOWN="mouse-down",n.MOUSE_MOVE="mouse-move",n.MOUSE_UP="mouse-up",n.MOUSE_WHEEL="mouse-wheel",n.MOUSE_ENTER="mouse-enter",n.MOUSE_LEAVE="mouse-leave",n.KEY_DOWN="keydown",n.KEY_UP="keyup",n.DEVICEMOTION="devicemotion",n.TRANSFORM_CHANGED="transform-changed",n.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",n.SIZE_CHANGED="size-changed",n.ANCHOR_CHANGED="anchor-changed",n.COLOR_CHANGED="color-changed",n.CHILD_ADDED="child-added",n.CHILD_REMOVED="child-removed",n.PARENT_CHANGED="parent-changed",n.NODE_DESTROYED="node-destroyed",n.LAYER_CHANGED="layer-changed",n.SIBLING_ORDER_CHANGED="sibling-order-changed",(I=vE=vE||{}).TOUCH_START="touch-start",I.TOUCH_MOVE="touch-move",I.TOUCH_END="touch-end",I.TOUCH_CANCEL="touch-cancel",I.MOUSE_DOWN="mouse-down",I.MOUSE_MOVE="mouse-move",I.MOUSE_UP="mouse-up",I.MOUSE_WHEEL="mouse-wheel",I.KEY_DOWN="keydown",I.KEY_PRESSING="key-pressing",I.KEY_UP="keyup",I.DEVICEMOTION="devicemotion",j.SystemEventType=gE;var SE,bE=new Array(16),TE=null,EE=new U,CE=[T.TOUCH_START,T.TOUCH_MOVE,T.TOUCH_END,T.TOUCH_CANCEL],wE=[T.MOUSE_DOWN,T.MOUSE_ENTER,T.MOUSE_MOVE,T.MOUSE_LEAVE,T.MOUSE_UP,T.MOUSE_WHEEL];(b=SE=SE||{})[b.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",b[b.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",b[b.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY";(c=CC.prototype).setEnabled=function(e,t){if(void 0===t&&(t=!1),this._isEnabled!==e){this._isEnabled=e;var i=this.node.children;if(e&&this._attachMask(),CC.callbacksInvoker.emit(SE.MARK_LIST_DIRTY),t&&0<i.length)for(var n=0;n<i.length;++n)i[n]._eventProcessor.setEnabled(e,!0)}},c._searchComponentsInParent=function(e){var t=this.node;if(e){for(var i=0,n=[],r=t;r&&N1.isNode(r);r=r.parent,++i){var o=r.getComponent(e);o&&(o={index:i,comp:o},n?n.push(o):n=[o])}return 0<n.length?n:null}return null},c._attachMask=function(){this.maskList=this._searchComponentsInParent(CC._maskComp)},c.reattach=function(){var t,i=this;this.node.walk(function(e){t=t||i._searchComponentsInParent(CC._maskComp),e.eventProcessor.maskList=t})},c.destroy=function(){TE===this._node&&(TE=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),CC.callbacksInvoker.emit(SE.REMOVE_POINTER_EVENT_PROCESSOR,this)},c._isTouchEvent=function(e){return-1!==CE.indexOf(e)},c._isMouseEvent=function(e){return-1!==wE.indexOf(e)},c._hasTouchListeners=function(){for(var e=0;e<CE.length;++e){var t=CE[e];if(this.hasEventListener(t))return!0}return!1},c._hasMouseListeners=function(){for(var e=0;e<wE.length;++e){var t=wE[e];if(this.hasEventListener(t))return!0}return!1},c._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},c._tryEmittingAddEvent=function(e){var t=this._isTouchEvent(e),e=this._isMouseEvent(e);t?this.shouldHandleEventTouch=!0:e&&(this.shouldHandleEventMouse=!0),!t&&!e||this._hasPointerListeners()||CC.callbacksInvoker.emit(SE.ADD_POINTER_EVENT_PROCESSOR,this)},c._newCallbacksInvoker=function(){var e=this,t=new Fi;return t._registerOffCallback(function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||CC.callbacksInvoker.emit(SE.REMOVE_POINTER_EVENT_PROCESSOR,e)}),t},c.on=function(e,t,i,n){return this._tryEmittingAddEvent(e),((n=!!n)?null!=(n=this.capturingTarget)?n:this.capturingTarget=this._newCallbacksInvoker():null!=(n=this.bubblingTarget)?n:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i),t},c.once=function(e,t,i,n){return this._tryEmittingAddEvent(e),((n=!!n)?null!=(n=this.capturingTarget)?n:this.capturingTarget=this._newCallbacksInvoker():null!=(n=this.bubblingTarget)?n:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i,!0),t},c.off=function(e,t,i,n){null!=(n=(n=!!n)?this.capturingTarget:this.bubblingTarget)&&n.off(e,t,i)},c.targetOff=function(e){var t;null!=(t=this.capturingTarget)&&t.removeAll(e),null!=(t=this.bubblingTarget)&&t.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||CC.callbacksInvoker.emit(SE.REMOVE_POINTER_EVENT_PROCESSOR,this)},c.emit=function(e,t,i,n,r,o){var a;null!=(a=this.bubblingTarget)&&a.emit(e,t,i,n,r,o)},c.dispatchEvent=function(e){var t,i=this.node,n=0;for(e.target=i,bE.length=0,this.getCapturingTargets(e.type,bE),e.eventPhase=1,n=bE.length-1;0<=n;--n)if((t=bE[n]).eventProcessor.capturingTarget&&((e.currentTarget=t).eventProcessor.capturingTarget.emit(e.type,e,bE),e.propagationStopped))return void(bE.length=0);if(bE.length=0,e.eventPhase=2,e.currentTarget=i,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,bE),e.eventPhase=3,n=0;n<bE.length;++n)if((t=bE[n]).eventProcessor.bubblingTarget&&((e.currentTarget=t).eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(bE.length=0);bE.length=0},c.hasEventListener=function(e,t,i){var n=!1;return n=!(n=this.bubblingTarget?this.bubblingTarget.hasEventListener(e,t,i):n)&&this.capturingTarget?this.capturingTarget.hasEventListener(e,t,i):n},c.getCapturingTargets=function(e,t){for(var i,n=this._node.parent;n;)null!=(i=n.eventProcessor.capturingTarget)&&i.hasEventListener(e)&&t.push(n),n=n.parent},c.getBubblingTargets=function(e,t){for(var i,n=this._node.parent;n;)null!=(i=n.eventProcessor.bubblingTarget)&&i.hasEventListener(e)&&t.push(n),n=n.parent},c._handleEventMouse=function(e){switch(e.type){case vE.MOUSE_DOWN:return this._handleMouseDown(e);case vE.MOUSE_MOVE:return this._handleMouseMove(e);case vE.MOUSE_UP:return this._handleMouseUp(e);case vE.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},c._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(EE=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(EE)||(e.type=T.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},c._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(EE=e.getUILocation(),t._uiProps.uiTransformComp.isHit(EE)?(this.previousMouseIn||(TE&&TE!==t&&(e.type=T.MOUSE_LEAVE,TE.dispatchEvent(e),TE.eventProcessor.previousMouseIn=!1),TE=t,e.type=T.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=T.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=T.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,TE=null),1)))},c._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(EE=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(EE)||(e.type=T.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},c._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(EE=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(EE)||(e.type=T.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},c._handleEventTouch=function(e){switch(e.type){case vE.TOUCH_START:return this._handleTouchStart(e);case vE.TOUCH_MOVE:return this._handleTouchMove(e);case vE.TOUCH_END:return this._handleTouchEnd(e);case vE.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},c._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation(EE),!t._uiProps.uiTransformComp.isHit(EE)||(e.type=T.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},c._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=T.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},c._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation(EE),t._uiProps.uiTransformComp.isHit(EE)?e.type=T.TOUCH_END:e.type=T.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},c._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=T.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},e(CC,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]);var AE,PE,IE,RE,DE,OE,ME,NE,LE,BE,FE,zE,UE,kE,GE,HE,VE,jE,WE,qE,XE,YE,KE,QE,ZE,JE,$E,eC,tC,iC,nC,rC,oC,aC,sC,cC,lC,uC,hC,pC,_C,fC,dC,mC,gC,vC,yC,xC,SC,bC,TC,EC=CC;function CC(e){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=e}EC._maskComp=null,EC.callbacksInvoker=new Fi,j.NodeEventProcessor=EC;function wC(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)}var AC=new ce(0,1,0),PC=new ce,IC=new Fr,RC=new nr,DC=new gr,OC=(S=f("cc.AmbientInfo"),a=wp(),x=yp("_skyColor"),B1=yp("_skyIllum"),Hd=yp("_groundAlbedo"),r=Pp(),Sa=u(),g=v(ci),t=u(),R=Pp(),o=u(),S(I=a((MC.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},e(MC,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=j.director.root.pipeline.pipelineSceneData.isHDR;return IC.set(e?this._skyColorHDR:this._skyColorLDR),wC(IC),RC.set(255*IC.x,255*IC.y,255*IC.z,255)},set:function(e){IC.set(e.x,e.y,e.z,e.w),(j.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR).set(IC),this._resource&&this._resource.skyColor.set(IC)}},{key:"skyColor",set:function(e){(j.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR).set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=j.director.root.pipeline.pipelineSceneData.isHDR;return IC.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),wC(IC),RC.set(255*IC.x,255*IC.y,255*IC.z,255)},set:function(e){IC.set(e.x,e.y,e.z,e.w),(j.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR).set(IC),this._resource&&this._resource.groundAlbedo.set(IC)}},{key:"groundAlbedo",set:function(e){(j.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR).set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),AE=i((n=MC).prototype,"_skyColorHDR",[d,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fr(.2,.5,.8,1)}}),PE=i(n.prototype,"_skyIllumHDR",[d,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jr.SKY_ILLUM}}),IE=i(n.prototype,"_groundAlbedoHDR",[d,Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fr(.2,.2,.2,1)}}),RE=i(n.prototype,"_skyColorLDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fr(.2,.5,.8,1)}}),DE=i(n.prototype,"_skyIllumLDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jr.SKY_ILLUM}}),OE=i(n.prototype,"_groundAlbedoLDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fr(.2,.2,.2,1)}}),i(n.prototype,"skyLightingColor",[r,Ap,Sa],Object.getOwnPropertyDescriptor(n.prototype,"skyLightingColor"),n.prototype),i(n.prototype,"skyIllum",[Ap,g,t],Object.getOwnPropertyDescriptor(n.prototype,"skyIllum"),n.prototype),i(n.prototype,"groundLightingColor",[R,Ap,o],Object.getOwnPropertyDescriptor(n.prototype,"groundLightingColor"),n.prototype),I=n))||I)||I);function MC(){_(this,"_skyColorHDR",AE,this),_(this,"_skyIllumHDR",PE,this),_(this,"_groundAlbedoHDR",IE,this),_(this,"_skyColorLDR",RE,this),_(this,"_skyIllumLDR",DE,this),_(this,"_groundAlbedoLDR",OE,this),this._resource=null}j.AmbientInfo=OC;b=f("cc.SkyboxInfo"),c=wp(),S=v(o0),a=yp("_envmap"),x=v(o0),B1=v(o0),Hd=v(o0),r=Pp(),Sa=u(),g=u(),t=u(),R=u(),o=v(o0),n=u(),I=Pp(),vie=v(o0);var NC=b(c=c((LC.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},e(LC,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),ME=i((b=LC).prototype,"_applyDiffuseMap",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NE=i(b.prototype,"_envmapHDR",[d,S,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LE=i(b.prototype,"_envmapLDR",[d,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BE=i(b.prototype,"_diffuseMapHDR",[d,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FE=i(b.prototype,"_diffuseMapLDR",[d,Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zE=i(b.prototype,"_enabled",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UE=i(b.prototype,"_useIBL",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kE=i(b.prototype,"_useHDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i(b.prototype,"applyDiffuseMap",[r,Ap,Sa],Object.getOwnPropertyDescriptor(b.prototype,"applyDiffuseMap"),b.prototype),i(b.prototype,"enabled",[Ap,g],Object.getOwnPropertyDescriptor(b.prototype,"enabled"),b.prototype),i(b.prototype,"useIBL",[Ap,t],Object.getOwnPropertyDescriptor(b.prototype,"useIBL"),b.prototype),i(b.prototype,"useHDR",[Ap,R],Object.getOwnPropertyDescriptor(b.prototype,"useHDR"),b.prototype),i(b.prototype,"envmap",[Ap,o,n],Object.getOwnPropertyDescriptor(b.prototype,"envmap"),b.prototype),i(b.prototype,"diffuseMap",[I,Ap,Ip,vie],Object.getOwnPropertyDescriptor(b.prototype,"diffuseMap"),b.prototype),c=b))||c)||c;function LC(){_(this,"_applyDiffuseMap",ME,this),_(this,"_envmapHDR",NE,this),_(this,"_envmapLDR",LE,this),_(this,"_diffuseMapHDR",BE,this),_(this,"_diffuseMapLDR",FE,this),_(this,"_enabled",zE,this),_(this,"_useIBL",UE,this),_(this,"_useHDR",kE,this),this._resource=null}j.SkyboxInfo=NC;S=f("cc.FogInfo"),a=wp(),x=u(),B1=u(),Hd=u(),r=v(sT),Sa=u(),g=Pp(),t=v(ci),R=Dp(),o=h(),n=m(),I=u(),vie=Pp(),b=v(ci),c=h(),E2=m(),xH=u(),uI=Pp(),yI=v(ci),C=h(),C7=m(),Nk=u(),E=Pp(),A=v(ci),yU=Op(),Z5=h(),Y3=m(),EW=u(),P=Pp(),bne=v(ci),pF=h(),w=m(),Aw=u(),aie=Pp(),Nw=v(ci),h=h(),kw=m(),XN=u();var BC=S(a=a((UC.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},e(UC,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&((this._resource.enabled=e)&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&((this._resource.accurate=e)&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),UC.FogType=sT,GE=i((S=UC).prototype,"_type",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sT.LINEAR}}),HE=i(S.prototype,"_fogColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr("#C8C8C8")}}),VE=i(S.prototype,"_enabled",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jE=i(S.prototype,"_fogDensity",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),WE=i(S.prototype,"_fogStart",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),qE=i(S.prototype,"_fogEnd",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),XE=i(S.prototype,"_fogAtten",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),YE=i(S.prototype,"_fogTop",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),KE=i(S.prototype,"_fogRange",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),QE=i(S.prototype,"_accurate",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(S.prototype,"enabled",[Ap,x],Object.getOwnPropertyDescriptor(S.prototype,"enabled"),S.prototype),i(S.prototype,"accurate",[Ap,B1],Object.getOwnPropertyDescriptor(S.prototype,"accurate"),S.prototype),i(S.prototype,"fogColor",[Ap,Hd],Object.getOwnPropertyDescriptor(S.prototype,"fogColor"),S.prototype),i(S.prototype,"type",[Ap,r,Sa],Object.getOwnPropertyDescriptor(S.prototype,"type"),S.prototype),i(S.prototype,"fogDensity",[g,t,R,o,Np,n,I],Object.getOwnPropertyDescriptor(S.prototype,"fogDensity"),S.prototype),i(S.prototype,"fogStart",[vie,b,c,E2,xH],Object.getOwnPropertyDescriptor(S.prototype,"fogStart"),S.prototype),i(S.prototype,"fogEnd",[uI,yI,C,C7,Nk],Object.getOwnPropertyDescriptor(S.prototype,"fogEnd"),S.prototype),i(S.prototype,"fogAtten",[E,A,yU,Z5,Y3,EW],Object.getOwnPropertyDescriptor(S.prototype,"fogAtten"),S.prototype),i(S.prototype,"fogTop",[P,bne,pF,w,Aw],Object.getOwnPropertyDescriptor(S.prototype,"fogTop"),S.prototype),i(S.prototype,"fogRange",[aie,Nw,h,kw,XN],Object.getOwnPropertyDescriptor(S.prototype,"fogRange"),S.prototype),a=S))||a)||a,FC=(x=f("cc.ShadowsInfo"),B1=wp(),Hd=u(),r=v(wy),Sa=Pp(),g=Pp(),t=u(),R=v(ci),o=u(),n=Pp(),I=Dp(),vie=v(ci),b=u(),c=Pp(),E2=v(Ay),xH=u(),uI=Pp(),yI=v(ai),C=Pp(),C7=v(ci),Nk=u(),E=Pp(),A=v(ci),yU=u(),Z5=Pp(),Y3=v(s),EW=u(),P=Pp(),bne=v(li),pF=u(),w=Pp(),Aw=v(ci),aie=u(),Nw=Pp(),h=v(ci),kw=u(),XN=Pp(),S=Dp(),a=v(ci),s=u(),ane=Pp(),fie=Dp(),cM=v(ci),dU=u(),YD=Pp(),Iie=v(ci),W3=u(),Rie=Pp(),x(x=B1(((x=zC.prototype).setPlaneFromNode=function(e){e.getWorldRotation(DC),this.normal=ce.transformQuat(PC,AC,DC),e.getWorldPosition(PC),this.distance=ce.dot(this._normal,PC)},x.activate=function(e){this.pcf=Math.min(this._pcf,Ay.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()},e(zC,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&((this._resource.enabled=e)&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){ce.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){1<e?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,Iy.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,Iy.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,Iy.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),ZE=i((B1=zC).prototype,"_type",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wy.Planar}}),JE=i(B1.prototype,"_enabled",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$E=i(B1.prototype,"_normal",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(0,1,0)}}),eC=i(B1.prototype,"_distance",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tC=i(B1.prototype,"_shadowColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(0,0,0,76)}}),iC=i(B1.prototype,"_firstSetCSM",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nC=i(B1.prototype,"_fixedArea",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rC=i(B1.prototype,"_pcf",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ay.HARD}}),oC=i(B1.prototype,"_bias",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),aC=i(B1.prototype,"_normalBias",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sC=i(B1.prototype,"_near",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),cC=i(B1.prototype,"_far",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),lC=i(B1.prototype,"_shadowDistance",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),uC=i(B1.prototype,"_invisibleOcclusionRange",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),hC=i(B1.prototype,"_orthoSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),pC=i(B1.prototype,"_maxReceived",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),_C=i(B1.prototype,"_size",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(512,512)}}),fC=i(B1.prototype,"_saturation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),i(B1.prototype,"enabled",[Ap,Hd],Object.getOwnPropertyDescriptor(B1.prototype,"enabled"),B1.prototype),i(B1.prototype,"type",[Ap,r],Object.getOwnPropertyDescriptor(B1.prototype,"type"),B1.prototype),i(B1.prototype,"shadowColor",[Sa],Object.getOwnPropertyDescriptor(B1.prototype,"shadowColor"),B1.prototype),i(B1.prototype,"normal",[g,t],Object.getOwnPropertyDescriptor(B1.prototype,"normal"),B1.prototype),i(B1.prototype,"distance",[R,o,n],Object.getOwnPropertyDescriptor(B1.prototype,"distance"),B1.prototype),i(B1.prototype,"saturation",[Ap,I,Np,vie,b,c],Object.getOwnPropertyDescriptor(B1.prototype,"saturation"),B1.prototype),i(B1.prototype,"pcf",[E2,xH,uI],Object.getOwnPropertyDescriptor(B1.prototype,"pcf"),B1.prototype),i(B1.prototype,"maxReceived",[yI,C],Object.getOwnPropertyDescriptor(B1.prototype,"maxReceived"),B1.prototype),i(B1.prototype,"bias",[C7,Nk,E],Object.getOwnPropertyDescriptor(B1.prototype,"bias"),B1.prototype),i(B1.prototype,"normalBias",[A,yU,Z5],Object.getOwnPropertyDescriptor(B1.prototype,"normalBias"),B1.prototype),i(B1.prototype,"shadowMapSize",[Y3,EW,P],Object.getOwnPropertyDescriptor(B1.prototype,"shadowMapSize"),B1.prototype),i(B1.prototype,"fixedArea",[bne,pF,w],Object.getOwnPropertyDescriptor(B1.prototype,"fixedArea"),B1.prototype),i(B1.prototype,"near",[Aw,aie,Nw],Object.getOwnPropertyDescriptor(B1.prototype,"near"),B1.prototype),i(B1.prototype,"far",[h,kw,XN],Object.getOwnPropertyDescriptor(B1.prototype,"far"),B1.prototype),i(B1.prototype,"invisibleOcclusionRange",[Ap,S,Np,a,s,ane],Object.getOwnPropertyDescriptor(B1.prototype,"invisibleOcclusionRange"),B1.prototype),i(B1.prototype,"shadowDistance",[Ap,fie,Np,cM,dU,YD],Object.getOwnPropertyDescriptor(B1.prototype,"shadowDistance"),B1.prototype),i(B1.prototype,"orthoSize",[Iie,W3,Rie],Object.getOwnPropertyDescriptor(B1.prototype,"orthoSize"),B1.prototype),x=B1))||x)||x);function zC(){_(this,"_type",ZE,this),_(this,"_enabled",JE,this),_(this,"_normal",$E,this),_(this,"_distance",eC,this),_(this,"_shadowColor",tC,this),_(this,"_firstSetCSM",iC,this),_(this,"_fixedArea",nC,this),_(this,"_pcf",rC,this),_(this,"_bias",oC,this),_(this,"_normalBias",aC,this),_(this,"_near",sC,this),_(this,"_far",cC,this),_(this,"_shadowDistance",lC,this),_(this,"_invisibleOcclusionRange",uC,this),_(this,"_orthoSize",hC,this),_(this,"_maxReceived",pC,this),_(this,"_size",_C,this),_(this,"_saturation",fC,this),this._resource=null}function UC(){_(this,"_type",GE,this),_(this,"_fogColor",HE,this),_(this,"_enabled",VE,this),_(this,"_fogDensity",jE,this),_(this,"_fogStart",WE,this),_(this,"_fogEnd",qE,this),_(this,"_fogAtten",XE,this),_(this,"_fogTop",YE,this),_(this,"_fogRange",KE,this),_(this,"_accurate",QE,this),this._resource=null}j.ShadowsInfo=FC;var kC=new ce(-1024,-1024,-1024),GC=new ce(1024,1024,1024),HC=(Hd=f("cc.OctreeInfo"),r=wp(),Sa=u(),g=u(),t=Rp(),R=u(),o=Rp(),n=Dp(),I=v(ai),vie=u(),Hd(c=r((WC.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},e(WC,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),dC=i((b=WC).prototype,"_enabled",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mC=i(b.prototype,"_minPos",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(kC)}}),gC=i(b.prototype,"_maxPos",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(GC)}}),vC=i(b.prototype,"_depth",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),i(b.prototype,"enabled",[Ap,Sa],Object.getOwnPropertyDescriptor(b.prototype,"enabled"),b.prototype),i(b.prototype,"minPos",[Ap,g,t],Object.getOwnPropertyDescriptor(b.prototype,"minPos"),b.prototype),i(b.prototype,"maxPos",[Ap,R,o],Object.getOwnPropertyDescriptor(b.prototype,"maxPos"),b.prototype),i(b.prototype,"depth",[Ap,n,I,vie],Object.getOwnPropertyDescriptor(b.prototype,"depth"),b.prototype),c=b))||c)||c),VC=(E2=f("cc.SceneGlobals"),xH=v(NC),E2((jC.prototype.activate=function(){var e=j.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},e(jC,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),yC=i((uI=jC).prototype,"ambient",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OC}}),xC=i(uI.prototype,"shadows",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FC}}),SC=i(uI.prototype,"_skybox",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NC}}),bC=i(uI.prototype,"fog",[Ap,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BC}}),i(uI.prototype,"skybox",[Ap,xH],Object.getOwnPropertyDescriptor(uI.prototype,"skybox"),uI.prototype),TC=i(uI.prototype,"octree",[Ap,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HC}}),yI=uI))||yI);function jC(){_(this,"ambient",yC,this),_(this,"shadows",xC,this),_(this,"_skybox",SC,this),_(this,"fog",bC,this),_(this,"octree",TC,this)}function WC(){_(this,"_enabled",dC,this),_(this,"_minPos",mC,this),_(this,"_maxPos",gC,this),_(this,"_depth",vC,this),this._resource=null}j.SceneGlobals=VC;var qC=Rre("Event",((C=XC.prototype).unuse=function(){this.type=XC.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=XC.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},C.reuse=function(e,t){this.type=e,this.bubbles=t||!1},C.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},C.getCurrentTarget=function(){return this.currentTarget},C.getType=function(){return this.type},XC));function XC(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}qC.NO_TYPE="no_type",qC.TOUCH="touch",qC.MOUSE="mouse",qC.KEYBOARD="keyboard",qC.ACCELERATION="acceleration",qC.NONE=0,qC.CAPTURING_PHASE=1,qC.AT_TARGET=2,qC.BUBBLING_PHASE=3,j.Event=qC;var YC,KC=Rre("EventAcceleration",(l(QC,YC=qC),QC));function QC(e,t){return(t=YC.call(this,gE.DEVICEMOTION,t)||this).acc=void 0,t.acc=e,t}qC.EventAcceleration=KC;var ZC,JC=Rre("EventKeyboard",(l($C,ZC=qC),e($C,[{key:"isPressed",get:function(){return this._isPressed}}]),$C));function $C(e,t,i){return"boolean"==typeof t&&(t=t?gE.KEY_DOWN:gE.KEY_UP),(i=ZC.call(this,t,i)||this).keyCode=void 0,i.rawEvent=void 0,i._isPressed=void 0,i._isPressed=t!==gE.KEY_UP,"number"==typeof e?i.keyCode=e:(i.keyCode=e.keyCode,i.rawEvent=e),i}qC.EventKeyboard=JC;var ew,tw=Rre("EventMouse",(l(iw,ew=qC),(C7=iw.prototype).setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},C7.getScrollX=function(){return this._scrollX},C7.getScrollY=function(){return this._scrollY},C7.setLocation=function(e,t){this._x=e,this._y=t},C7.getLocation=function(e){return e=e||new U,U.set(e,this._x,this._y),e},C7.getLocationInView=function(e){return e=e||new U,U.set(e,this._x,j.view._designResolutionSize.height-this._y),e},C7.getUILocation=function(e){return e=e||new U,U.set(e,this._x,this._y),j.view._convertToUISpace(e),e},C7.getPreviousLocation=function(e){return e=e||new U,U.set(e,this._prevX,this._prevY),e},C7.getUIPreviousLocation=function(e){return e=e||new U,U.set(e,this._prevX,this._prevY),j.view._convertToUISpace(e),e},C7.getDelta=function(e){return e=e||new U,U.set(e,this._x-this._prevX,this._y-this._prevY),e},C7.getDeltaX=function(){return this._x-this._prevX},C7.getDeltaY=function(){return this._y-this._prevY},C7.getUIDelta=function(e){return e=e||new U,U.set(e,(this._x-this._prevX)/j.view.getScaleX(),(this._y-this._prevY)/j.view.getScaleY()),e},C7.getUIDeltaX=function(){return(this._x-this._prevX)/j.view.getScaleX()},C7.getUIDeltaY=function(){return(this._y-this._prevY)/j.view.getScaleY()},C7.setButton=function(e){this._button=e},C7.getButton=function(){return this._button},C7.getLocationX=function(){return this._x},C7.getLocationY=function(){return this._y},C7.getUILocationX=function(){var e=j.view.getViewportRect();return(this._x-e.x)/j.view.getScaleX()},C7.getUILocationY=function(){var e=j.view.getViewportRect();return(this._y-e.y)/j.view.getScaleY()},e(iw,[{key:"eventType",get:function(){return this._eventType}}]),iw));function iw(e,t,i){return(t=ew.call(this,e,t)||this).movementX=0,t.movementY=0,t.preventSwallow=!1,t._eventType=void 0,t._button=iw.BUTTON_MISSING,t._x=0,t._y=0,t._prevX=0,t._prevY=0,t._scrollX=0,t._scrollY=0,t._eventType=e,i&&(t._prevX=i.x,t._prevY=i.y),t}tw.BUTTON_MISSING=-1,tw.BUTTON_LEFT=0,tw.BUTTON_RIGHT=2,tw.BUTTON_MIDDLE=1,tw.BUTTON_4=3,tw.BUTTON_5=4,tw.BUTTON_6=5,tw.BUTTON_7=6,tw.BUTTON_8=7,qC.EventMouse=tw;var nw,rw=new U,ow=Rre("EventTouch",(l(aw,nw=qC),(Nk=aw.prototype).getEventCode=function(){return this._eventCode},Nk.getTouches=function(){return this._touches},Nk.getAllTouches=function(){return this._allTouches},Nk.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},Nk.getLocation=function(e){return this.touch?this.touch.getLocation(e):new U},Nk.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new U},Nk.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new U},Nk.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new U},Nk.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new U},Nk.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new U},Nk.getID=function(){return this.touch?this.touch.getID():null},Nk.getDelta=function(e){return this.touch?this.touch.getDelta(e):new U},Nk.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new U},Nk.getDeltaX=function(){return this.touch?this.touch.getDelta(rw).x:0},Nk.getDeltaY=function(){return this.touch?this.touch.getDelta(rw).y:0},Nk.getLocationX=function(){return this.touch?this.touch.getLocationX():0},Nk.getLocationY=function(){return this.touch?this.touch.getLocationY():0},aw));function aw(e,t,i,n){return void 0===n&&(n=[]),(t=nw.call(this,i,t)||this).touch=null,t.simulate=!1,t.preventSwallow=!1,t._eventCode=void 0,t._touches=void 0,t._allTouches=void 0,t._eventCode=i,t._touches=e||[],t._allTouches=n,t}ow.MAX_TOUCHES=5,qC.EventTouch=ow;var sw,cw=Rre("Acceleration",function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}),lw=((E=sw=sw||Rre("KeyCode",{}))[E.NONE=0]="NONE",E[E.MOBILE_BACK=6]="MOBILE_BACK",E[E.BACKSPACE=8]="BACKSPACE",E[E.TAB=9]="TAB",E[E.ENTER=13]="ENTER",E[E.SHIFT_LEFT=16]="SHIFT_LEFT",E[E.CTRL_LEFT=17]="CTRL_LEFT",E[E.ALT_LEFT=18]="ALT_LEFT",E[E.PAUSE=19]="PAUSE",E[E.CAPS_LOCK=20]="CAPS_LOCK",E[E.ESCAPE=27]="ESCAPE",E[E.SPACE=32]="SPACE",E[E.PAGE_UP=33]="PAGE_UP",E[E.PAGE_DOWN=34]="PAGE_DOWN",E[E.END=35]="END",E[E.HOME=36]="HOME",E[E.ARROW_LEFT=37]="ARROW_LEFT",E[E.ARROW_UP=38]="ARROW_UP",E[E.ARROW_RIGHT=39]="ARROW_RIGHT",E[E.ARROW_DOWN=40]="ARROW_DOWN",E[E.INSERT=45]="INSERT",E[E.DELETE=46]="DELETE",E[E.DIGIT_0=48]="DIGIT_0",E[E.DIGIT_1=49]="DIGIT_1",E[E.DIGIT_2=50]="DIGIT_2",E[E.DIGIT_3=51]="DIGIT_3",E[E.DIGIT_4=52]="DIGIT_4",E[E.DIGIT_5=53]="DIGIT_5",E[E.DIGIT_6=54]="DIGIT_6",E[E.DIGIT_7=55]="DIGIT_7",E[E.DIGIT_8=56]="DIGIT_8",E[E.DIGIT_9=57]="DIGIT_9",E[E.KEY_A=65]="KEY_A",E[E.KEY_B=66]="KEY_B",E[E.KEY_C=67]="KEY_C",E[E.KEY_D=68]="KEY_D",E[E.KEY_E=69]="KEY_E",E[E.KEY_F=70]="KEY_F",E[E.KEY_G=71]="KEY_G",E[E.KEY_H=72]="KEY_H",E[E.KEY_I=73]="KEY_I",E[E.KEY_J=74]="KEY_J",E[E.KEY_K=75]="KEY_K",E[E.KEY_L=76]="KEY_L",E[E.KEY_M=77]="KEY_M",E[E.KEY_N=78]="KEY_N",E[E.KEY_O=79]="KEY_O",E[E.KEY_P=80]="KEY_P",E[E.KEY_Q=81]="KEY_Q",E[E.KEY_R=82]="KEY_R",E[E.KEY_S=83]="KEY_S",E[E.KEY_T=84]="KEY_T",E[E.KEY_U=85]="KEY_U",E[E.KEY_V=86]="KEY_V",E[E.KEY_W=87]="KEY_W",E[E.KEY_X=88]="KEY_X",E[E.KEY_Y=89]="KEY_Y",E[E.KEY_Z=90]="KEY_Z",E[E.NUM_0=96]="NUM_0",E[E.NUM_1=97]="NUM_1",E[E.NUM_2=98]="NUM_2",E[E.NUM_3=99]="NUM_3",E[E.NUM_4=100]="NUM_4",E[E.NUM_5=101]="NUM_5",E[E.NUM_6=102]="NUM_6",E[E.NUM_7=103]="NUM_7",E[E.NUM_8=104]="NUM_8",E[E.NUM_9=105]="NUM_9",E[E.NUM_MULTIPLY=106]="NUM_MULTIPLY",E[E.NUM_PLUS=107]="NUM_PLUS",E[E.NUM_SUBTRACT=109]="NUM_SUBTRACT",E[E.NUM_DECIMAL=110]="NUM_DECIMAL",E[E.NUM_DIVIDE=111]="NUM_DIVIDE",E[E.F1=112]="F1",E[E.F2=113]="F2",E[E.F3=114]="F3",E[E.F4=115]="F4",E[E.F5=116]="F5",E[E.F6=117]="F6",E[E.F7=118]="F7",E[E.F8=119]="F8",E[E.F9=120]="F9",E[E.F10=121]="F10",E[E.F11=122]="F11",E[E.F12=123]="F12",E[E.NUM_LOCK=144]="NUM_LOCK",E[E.SCROLL_LOCK=145]="SCROLL_LOCK",E[E.SEMICOLON=186]="SEMICOLON",E[E.EQUAL=187]="EQUAL",E[E.COMMA=188]="COMMA",E[E.DASH=189]="DASH",E[E.PERIOD=190]="PERIOD",E[E.SLASH=191]="SLASH",E[E.BACK_QUOTE=192]="BACK_QUOTE",E[E.BRACKET_LEFT=219]="BRACKET_LEFT",E[E.BACKSLASH=220]="BACKSLASH",E[E.BRACKET_RIGHT=221]="BRACKET_RIGHT",E[E.QUOTE=222]="QUOTE",E[E.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",E[E.CTRL_RIGHT=2001]="CTRL_RIGHT",E[E.ALT_RIGHT=2002]="ALT_RIGHT",E[E.NUM_ENTER=2003]="NUM_ENTER",new U),uw=Rre("Touch",((A=hw.prototype).getLocation=function(e){return(e=e||new U).set(this._point.x,this._point.y),e},A.getLocationX=function(){return this._point.x},A.getLocationY=function(){return this._point.y},A.getUILocation=function(e){return(e=e||new U).set(this._point.x,this._point.y),j.view._convertToUISpace(e),e},A.getUILocationX=function(){var e=j.view.getViewportRect();return(this._point.x-e.x)/j.view.getScaleX()},A.getUILocationY=function(){var e=j.view.getViewportRect();return(this._point.y-e.y)/j.view.getScaleY()},A.getPreviousLocation=function(e){return(e=e||new U).set(this._prevPoint.x,this._prevPoint.y),e},A.getUIPreviousLocation=function(e){return(e=e||new U).set(this._prevPoint.x,this._prevPoint.y),j.view._convertToUISpace(e),e},A.getStartLocation=function(e){return(e=e||new U).set(this._startPoint.x,this._startPoint.y),e},A.getUIStartLocation=function(e){return(e=e||new U).set(this._startPoint.x,this._startPoint.y),j.view._convertToUISpace(e),e},A.getDelta=function(e){return(e=e||new U).set(this._point),e.subtract(this._prevPoint),e},A.getUIDelta=function(e){return e=e||new U,lw.set(this._point),lw.subtract(this._prevPoint),e.set(j.view.getScaleX(),j.view.getScaleY()),U.divide(e,lw,e),e},A.getLocationInView=function(e){return(e=e||new U).set(this._point.x,j.view._designResolutionSize.height-this._point.y),e},A.getPreviousLocationInView=function(e){return(e=e||new U).set(this._prevPoint.x,j.view._designResolutionSize.height-this._prevPoint.y),e},A.getStartLocationInView=function(e){return(e=e||new U).set(this._startPoint.x,j.view._designResolutionSize.height-this._startPoint.y),e},A.getID=function(){return this._id},A.setTouchInfo=function(e,t,i){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new U(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new U(this._point),this._startPointCaptured=!0)},A.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=j.game.frameStartTime},A.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new U(e.x,e.y):new U(e||0,t||0),this._lastModified=j.game.frameStartTime},e(hw,[{key:"lastModified",get:function(){return this._lastModified}}]),hw));function hw(e,t,i){void 0===i&&(i=0),this._point=new U,this._prevPoint=new U,this._lastModified=0,this._id=0,this._startPoint=new U,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}j.Touch=uw;(yU=Ew.prototype)._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},yU._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},yU._didAccelerate=function(e){var t,i,n,r=performance.now();r-this._accelTimer<this._intervalInMileSeconds||(this._accelTimer=r,i=t=r=0,i=this._globalEventClass===window.DeviceMotionEvent?(r=.1*((null==(n=e.accelerationIncludingGravity)?void 0:n.x)||0),t=.1*((null==n?void 0:n.y)||0),.1*((null==n?void 0:n.z)||0)):(r=(e.gamma||0)/90*.981,t=-(e.beta||0)/90*.981,(e.alpha||0)/90*.981),ef.isFrameRotated&&(n=r,r=-t,t=n),e=r,90===window.orientation?(r=-t,t=e):-90===window.orientation?(r=t,t=-e):180===window.orientation&&(r=-r,t=-t),Qi.os===Wi.ANDROID&&Qi.browserType!==Hi.MOBILE_QQ&&(r=-r,t=-t),n=performance.now(),e=new cw(r,t,i,n),r=new KC(e),this._eventTarget.emit(vE.DEVICEMOTION,r))},yU.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(function(e){"granted"===e&&t._registerEvent()}).catch(function(){}):this._registerEvent()},yU.stop=function(){this._unregisterEvent()},yU.setInterval=function(e){this._intervalInMileSeconds=e},yU.on=function(e,t,i){this._eventTarget.on(e,t,i)};var pw,_w=Ew,fw={Backspace:sw.BACKSPACE,Tab:sw.TAB,Enter:sw.ENTER,ShiftLeft:sw.SHIFT_LEFT,ControlLeft:sw.CTRL_LEFT,AltLeft:sw.ALT_LEFT,ShiftRight:sw.SHIFT_RIGHT,ControlRight:sw.CTRL_RIGHT,AltRight:sw.ALT_RIGHT,Pause:sw.PAUSE,CapsLock:sw.CAPS_LOCK,Escape:sw.ESCAPE,Space:sw.SPACE,PageUp:sw.PAGE_UP,PageDown:sw.PAGE_DOWN,End:sw.END,Home:sw.HOME,ArrowLeft:sw.ARROW_LEFT,ArrowUp:sw.ARROW_UP,ArrowRight:sw.ARROW_RIGHT,ArrowDown:sw.ARROW_DOWN,Insert:sw.INSERT,Delete:sw.DELETE,Digit0:sw.DIGIT_0,Digit1:sw.DIGIT_1,Digit2:sw.DIGIT_2,Digit3:sw.DIGIT_3,Digit4:sw.DIGIT_4,Digit5:sw.DIGIT_5,Digit6:sw.DIGIT_6,Digit7:sw.DIGIT_7,Digit8:sw.DIGIT_8,Digit9:sw.DIGIT_9,KeyA:sw.KEY_A,KeyB:sw.KEY_B,KeyC:sw.KEY_C,KeyD:sw.KEY_D,KeyE:sw.KEY_E,KeyF:sw.KEY_F,KeyG:sw.KEY_G,KeyH:sw.KEY_H,KeyI:sw.KEY_I,KeyJ:sw.KEY_J,KeyK:sw.KEY_K,KeyL:sw.KEY_L,KeyM:sw.KEY_M,KeyN:sw.KEY_N,KeyO:sw.KEY_O,KeyP:sw.KEY_P,KeyQ:sw.KEY_Q,KeyR:sw.KEY_R,KeyS:sw.KEY_S,KeyT:sw.KEY_T,KeyU:sw.KEY_U,KeyV:sw.KEY_V,KeyW:sw.KEY_W,KeyX:sw.KEY_X,KeyY:sw.KEY_Y,KeyZ:sw.KEY_Z,Numpad0:sw.NUM_0,Numpad1:sw.NUM_1,Numpad2:sw.NUM_2,Numpad3:sw.NUM_3,Numpad4:sw.NUM_4,Numpad5:sw.NUM_5,Numpad6:sw.NUM_6,Numpad7:sw.NUM_7,Numpad8:sw.NUM_8,Numpad9:sw.NUM_9,NumpadMultiply:sw.NUM_MULTIPLY,NumpadAdd:sw.NUM_PLUS,NumpadSubtract:sw.NUM_SUBTRACT,NumpadDecimal:sw.NUM_DECIMAL,NumpadDivide:sw.NUM_DIVIDE,NumpadEnter:sw.NUM_ENTER,F1:sw.F1,F2:sw.F2,F3:sw.F3,F4:sw.F4,F5:sw.F5,F6:sw.F6,F7:sw.F7,F8:sw.F8,F9:sw.F9,F10:sw.F10,F11:sw.F11,F12:sw.F12,NumLock:sw.NUM_LOCK,ScrollLock:sw.SCROLL_LOCK,Semicolon:sw.SEMICOLON,Equal:sw.EQUAL,Comma:sw.COMMA,Minus:sw.DASH,Period:sw.PERIOD,Slash:sw.SLASH,Backquote:sw.BACK_QUOTE,BracketLeft:sw.BRACKET_LEFT,Backslash:sw.BACKSLASH,BracketRight:sw.BRACKET_RIGHT,Quote:sw.QUOTE},dw=((Z5=Tw.prototype)._registerEvent=function(){var i=this,e=document.getElementById("GameCanvas");null!=e&&e.addEventListener("keydown",function(e){var t;e.stopPropagation(),e.preventDefault(),e.repeat?(t=i._getInputEvent(e,vE.KEY_PRESSING),i._eventTarget.emit(vE.KEY_PRESSING,t)):(t=i._getInputEvent(e,vE.KEY_DOWN),i._eventTarget.emit(vE.KEY_DOWN,t))}),null!=e&&e.addEventListener("keyup",function(e){var t=i._getInputEvent(e,vE.KEY_UP);e.stopPropagation(),e.preventDefault(),i._eventTarget.emit(vE.KEY_UP,t)})},Z5._getInputEvent=function(e,t){e=e.code;e=fw[e]||sw.NONE;return new JC(e,t)},Z5.on=function(e,t,i){this._eventTarget.on(e,t,i)},Tw),mw=((Y3=bw.prototype)._getCanvasRect=function(){var e=this._canvas,e=null==e?void 0:e.getBoundingClientRect();return e?new qr(e.x,e.y,e.width,e.height):new qr(0,0,0,0)},Y3._getLocation=function(e){var t=this._getCanvasRect(),i=ef.devicePixelRatio,n=this._pointLocked?this._preMousePos.x/i+e.movementX:e.clientX-t.x,t=this._pointLocked?this._preMousePos.y/i-e.movementY:t.y+t.height-e.clientY;return new U(n*=i,t*=i)},Y3._registerEvent=function(){var e,t=this,i=(window.addEventListener("mousedown",function(){t._isPressed=!0}),null!=(i=this._canvas)&&i.addEventListener("mousedown",this._createCallback(vE.MOUSE_DOWN)),null!=(i=this._canvas)&&i.addEventListener("mousemove",this._createCallback(vE.MOUSE_MOVE)),this._createCallback(vE.MOUSE_UP));window.addEventListener("mouseup",i),null!=(e=this._canvas)&&e.addEventListener("mouseup",i),null!=(e=this._canvas)&&e.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},Y3._registerPointerLockEvent=function(){function e(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1}var t=this;"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},Y3._createCallback=function(o){var a=this;return function(e){var t,i=a._getLocation(e),n=e.button;switch(o){case vE.MOUSE_DOWN:null!=(t=a._canvas)&&t.focus(),a._isPressed=!0;break;case vE.MOUSE_UP:a._isPressed=!1;break;case vE.MOUSE_MOVE:a._isPressed||(n=tw.BUTTON_MISSING)}var r=new tw(o,!1,a._preMousePos);r.setLocation(i.x,i.y),r.setButton(n),r.movementX=e.movementX,r.movementY=e.movementY,a._preMousePos.set(i.x,i.y),e.stopPropagation(),e.target===a._canvas&&e.preventDefault(),a._eventTarget.emit(o,r)}},Y3._handleMouseWheel=function(e){var t=vE.MOUSE_WHEEL,i=this._getLocation(e),n=e.button,r=new tw(t,!1,this._preMousePos);r.setLocation(i.x,i.y),r.setButton(n),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(i.x,i.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},Y3.on=function(e,t,i){this._eventTarget.on(e,t,i)},bw),gw=new U,vw=((EW=Sw.prototype)._cloneTouch=function(e){var t=e.getID(),t=(e.getStartLocation(gw),new uw(gw.x,gw.y,t));return e.getLocation(gw),t.setPoint(gw.x,gw.y),e.getPreviousLocation(gw),t.setPrevPoint(gw),t},EW._createTouch=function(e,t,i){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{var n;if(!this._checkTouchMapSizeMoreThanMax(e))return n=new uw(t,i,e),this._touchMap.set(e,n),this._updateTouch(n,t,i),this._cloneTouch(n);console.log("The touches is more than MAX_TOUCHES.")}},EW.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},EW.getTouch=function(e,t,i){var n=this._touchMap.get(e);return n?this._updateTouch(n,t,i):n=this._createTouch(e,t,i),n?this._cloneTouch(n):void 0},EW.getAllTouches=function(){var t=this,i=[];return this._touchMap.forEach(function(e){e&&(e=t._cloneTouch(e),i.push(e))}),i},EW._updateTouch=function(e,t,i){e.getLocation(gw),e.setPrevPoint(gw),e.setPoint(t,i)},EW._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;e=zt.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<e)return!1;var i=performance.now();return this._touchMap.forEach(function(e){i-e.lastModified>zt.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))}),e>=this._touchMap.size},new Sw),yw=((P=xw.prototype)._registerEvent=function(){var e;null!=(e=this._canvas)&&e.addEventListener("touchstart",this._createCallback(vE.TOUCH_START)),null!=(e=this._canvas)&&e.addEventListener("touchmove",this._createCallback(vE.TOUCH_MOVE)),null!=(e=this._canvas)&&e.addEventListener("touchend",this._createCallback(vE.TOUCH_END)),null!=(e=this._canvas)&&e.addEventListener("touchcancel",this._createCallback(vE.TOUCH_CANCEL))},P._createCallback=function(c){var l=this;return function(e){for(var t,i=l._getCanvasRect(),n=[],r=e.changedTouches.length,o=0;o<r;++o){var a=e.changedTouches[o],s=a.identifier;null!==s&&(a=l._getLocation(a,i),(a=vw.getTouch(s,a.x,a.y))&&(c!==vE.TOUCH_END&&c!==vE.TOUCH_CANCEL||vw.releaseTouch(s),n.push(a)))}e.stopPropagation(),e.target===l._canvas&&e.preventDefault(),c===vE.TOUCH_START&&null!=(t=l._canvas)&&t.focus(),0<n.length&&(t=new ow(n,!1,c,zt.ENABLE_MULTI_TOUCH?vw.getAllTouches():n),l._eventTarget.emit(c,t))}},P._getCanvasRect=function(){var e=this._canvas,e=null==e?void 0:e.getBoundingClientRect();return e?new qr(e.x,e.y,e.width,e.height):new qr(0,0,0,0)},P._getLocation=function(e,t){var i,n=e.clientX-t.x,e=t.y+t.height-e.clientY,t=(ef.isFrameRotated&&(i=n,n=t.height-e,e=i),ef.devicePixelRatio);return new U(n*=t,e*=t)},P.on=function(e,t,i){this._eventTarget.on(e,t,i)},xw);function xw(){this._canvas=void 0,this._eventTarget=new Ki,Qi.hasFeature(Xi.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}function Sw(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}function bw(){this._canvas=void 0,this._eventTarget=new Ki,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new U,Qi.hasFeature(Xi.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}function Tw(){this._eventTarget=new Ki,this._registerEvent()}function Ew(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new Ki,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,Qi.browserType===Hi.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}(bne=pw=pw||{})[bne.GLOBAL=0]="GLOBAL",bne[bne.UI=1]="UI";Iw.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0};var Cw=Iw,ww=((pF={})[vE.MOUSE_DOWN]=vE.TOUCH_START,pF[vE.MOUSE_MOVE]=vE.TOUCH_MOVE,pF[vE.MOUSE_UP]=vE.TOUCH_END,pF),Aw=Rre("Input",((w=Pw.prototype).on=function(e,t,i){return this._eventTarget.on(e,t,i),t},w.once=function(e,t,i){return this._eventTarget.once(e,t,i),t},w.off=function(e,t,i){this._eventTarget.off(e,t,i)},w.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},w.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},w._simulateEventTouch=function(e){var t=ww[e.type],e=vw.getTouch(0,e.getLocationX(),e.getLocationY());e&&(e=new ow(e=[e],!1,t,e),t===vE.TOUCH_END&&vw.releaseTouch(0),this._dispatchOrPushEventTouch(e,this._eventTouchList))},w._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort(function(e,t){return t.priority-e.priority})},w._emitEvent=function(e){for(var t=this._eventDispatcherList.length,i=0;i<t&&this._eventDispatcherList[i].dispatchEvent(e);++i);},w._registerEvent=function(){var t,i,n,r,o=this;af.hasFeature(af.Feature.INPUT_TOUCH)&&(t=this._eventTouchList,this._touchInput.on(vE.TOUCH_START,function(e){o._dispatchOrPushEventTouch(e,t)}),this._touchInput.on(vE.TOUCH_MOVE,function(e){o._dispatchOrPushEventTouch(e,t)}),this._touchInput.on(vE.TOUCH_END,function(e){o._dispatchOrPushEventTouch(e,t)}),this._touchInput.on(vE.TOUCH_CANCEL,function(e){o._dispatchOrPushEventTouch(e,t)})),af.hasFeature(af.Feature.EVENT_MOUSE)&&(i=this._eventMouseList,this._mouseInput.on(vE.MOUSE_DOWN,function(e){o._needSimulateTouchMoveEvent=!0,o._simulateEventTouch(e),o._dispatchOrPushEvent(e,i)}),this._mouseInput.on(vE.MOUSE_MOVE,function(e){o._needSimulateTouchMoveEvent&&o._simulateEventTouch(e),o._dispatchOrPushEvent(e,i)}),this._mouseInput.on(vE.MOUSE_UP,function(e){o._needSimulateTouchMoveEvent=!1,o._simulateEventTouch(e),o._dispatchOrPushEvent(e,i)}),this._mouseInput.on(vE.MOUSE_WHEEL,function(e){o._dispatchOrPushEvent(e,i)})),af.hasFeature(af.Feature.EVENT_KEYBOARD)&&(n=this._eventKeyboardList,this._keyboardInput.on(vE.KEY_DOWN,function(e){o._dispatchOrPushEvent(e,n)}),this._keyboardInput.on(vE.KEY_PRESSING,function(e){o._dispatchOrPushEvent(e,n)}),this._keyboardInput.on(vE.KEY_UP,function(e){o._dispatchOrPushEvent(e,n)})),af.hasFeature(af.Feature.EVENT_ACCELEROMETER)&&(r=this._eventAccelerationList,this._accelerometerInput.on(vE.DEVICEMOTION,function(e){o._dispatchOrPushEvent(e,r)}))},w._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},w._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},w._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var i=e.getTouches(),n=i.length,r=0;r<n;++r)e.touch=i[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},w._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,i=e.length;t<i;++t){var n=e[t];this._emitEvent(n)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,p=0,_=h.length;p<_;++p){var f=h[p];this._emitEvent(f)}for(var d=this._eventAccelerationList,m=0,g=d.length;m<g;++m){var v=d[m];this._emitEvent(v)}this._clearEvents()},Pw));function Pw(){this._dispatchImmediately=!0,this._eventTarget=new Ki,this._touchInput=new yw,this._mouseInput=new mw,this._keyboardInput=new dw,this._accelerometerInput=new _w,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new Cw(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}function Iw(e){this.priority=pw.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}Aw.EventType=vE;var Rw,Dw=Rre("input",new Aw),Ow=Rre("SystemEvent",(l(Mw,Rw=Ki),(aie=Mw.prototype).setAccelerometerEnabled=function(e){Dw.setAccelerometerEnabled(e)},aie.setAccelerometerInterval=function(e){Dw.setAccelerometerInterval(e)},aie.on=function(e,t,i,n){return Rw.prototype.on.call(this,e,t,i,n),t},aie.off=function(e,t,i){Rw.prototype.off.call(this,e,t,i)},Mw));function Mw(){var t=Rw.call(this)||this;return Dw.on(vE.MOUSE_DOWN,function(e){t.emit(gE.MOUSE_DOWN,e)}),Dw.on(vE.MOUSE_MOVE,function(e){t.emit(gE.MOUSE_MOVE,e)}),Dw.on(vE.MOUSE_UP,function(e){t.emit(gE.MOUSE_UP,e)}),Dw.on(vE.MOUSE_WHEEL,function(e){t.emit(gE.MOUSE_WHEEL,e)}),Dw.on(vE.TOUCH_START,function(e){t.emit(gE.TOUCH_START,e.touch,e)}),Dw.on(vE.TOUCH_MOVE,function(e){t.emit(gE.TOUCH_MOVE,e.touch,e)}),Dw.on(vE.TOUCH_END,function(e){t.emit(gE.TOUCH_END,e.touch,e)}),Dw.on(vE.TOUCH_CANCEL,function(e){t.emit(gE.TOUCH_CANCEL,e.touch,e)}),Dw.on(vE.KEY_DOWN,function(e){t.emit(gE.KEY_DOWN,e)}),Dw.on(vE.KEY_PRESSING,function(e){t.emit(gE.KEY_DOWN,e)}),Dw.on(vE.KEY_UP,function(e){t.emit(gE.KEY_UP,e)}),Dw.on(vE.DEVICEMOTION,function(e){t.emit(gE.DEVICEMOTION,e)}),t}Ow.EventType=gE,j.SystemEvent=Ow;var Nw=Rre("systemEvent",new Ow);j.systemEvent=Nw,In(gE,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),In(qC,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),D(qC,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),In(tw,"EventMouse",["DOWN","UP","MOVE"].map(function(e){return{name:e,newName:"MOUSE_"+e,target:Ow.EventType,targetName:"SystemEvent.EventType"}})),In(tw,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),D(tw.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),In(ow,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),In(ow,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),In(ow,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),In(ow,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),D(ow.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),In(ow.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:ow,targetName:"EventTouch"}]),D(zt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map(function(e){return{name:e}})),D(zt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),D(zt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),D(zt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),D(zt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),In(XT.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),In(N1.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return(e=e||new U).set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return(e=e||new Hr).set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),Ee(VC.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),Ee(N1.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),In(NT.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),Ee(Tg,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),In(Tg,"Layers",[{name:"Default",newName:"DEFAULT",target:Tg.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Tg.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Tg.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Tg.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Tg.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Tg.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Tg.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Tg.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Tg,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Tg,targetName:"Layers"}]),Ee(Tg.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Ee(Tg.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var Lw,Bw,Fw,zw=Pi.Flags.HideInHierarchy,Uw=Pi.Flags.DontSave,kw=Rre("PrivateNode",f("cc.PrivateNode")((l(Gw,Fw=N1),h=Gw))||h);function Gw(e){return J(12003,(e=Fw.call(this,e)||this).name),e.hideFlags|=Uw|zw,e}In(gE,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map(function(e){return{name:e,target:N1.EventType,targetName:"Node.EventType"}})),In(N1.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:Ow.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:Ow.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:Ow.EventType,targetName:"SystemEvent.EventType"}]),j.PrivateNode=kw;var Hw,Vw=Rre("Scene",f("cc.Scene")((i((l(jw,Hw=XT),(XN=jw.prototype)._updateScene=function(){this._scene=this},XN._init=function(){},XN.destroy=function(){var e=Pi.prototype.destroy.call(this);if(e)for(var t=this._children,i=0;i<t.length;++i)t[i].active=!1;return this._renderScene&&j.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},XN.addComponent=function(){throw new Error(oe(3822))},XN._onHierarchyChanged=function(){},XN._onBatchCreated=function(e){Hw.prototype._onBatchCreated.call(this,e);for(var t=this._children.length,i=0;i<t;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},XN.getPosition=function(e){return ce.copy(e||new ce,ce.ZERO)},XN.getRotation=function(e){return gr.copy(e||new gr,gr.IDENTITY)},XN.getScale=function(e){return ce.copy(e||new ce,ce.ONE)},XN.getWorldPosition=function(e){return ce.copy(e||new ce,ce.ZERO)},XN.getWorldRotation=function(e){return gr.copy(e||new gr,gr.IDENTITY)},XN.getWorldScale=function(e){return ce.copy(e||new ce,ce.ONE)},XN.getWorldMatrix=function(e){return B.copy(e||new B,B.IDENTITY)},XN.getWorldRS=function(e){return B.copy(e||new B,B.IDENTITY)},XN.getWorldRT=function(e){return B.copy(e||new B,B.IDENTITY)},XN.updateWorldTransform=function(){},XN._instantiate=function(){},XN._load=function(){this._inited||(Q1(this),Y1(this),this._onBatchCreated(!1),this._inited=!0),this.walk(XT._setScene)},XN._activate=function(e){j.director._nodeActivator.activateNode(this,e=!1!==e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},e(jw,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return ce.ZERO}},{key:"worldPosition",get:function(){return ce.ZERO}},{key:"rotation",get:function(){return gr.IDENTITY}},{key:"worldRotation",get:function(){return gr.IDENTITY}},{key:"scale",get:function(){return ce.ONE}},{key:"worldScale",get:function(){return ce.ONE}},{key:"eulerAngles",get:function(){return ce.ZERO}},{key:"worldMatrix",get:function(){return B.IDENTITY}}]),S=jw).prototype,"globals",[Ap],Object.getOwnPropertyDescriptor(S.prototype,"globals"),S.prototype),Lw=i(S.prototype,"autoReleaseAssets",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bw=i(S.prototype,"_globals",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VC}}),a=S))||a);function jw(e){return _(e=Hw.call(this,e)||this,"autoReleaseAssets",Lw,p(e)),_(e,"_globals",Bw,p(e)),e.dependAssets=null,e._renderScene=null,e._inited=void 0,e._prefabSyncedInLiveReload=!1,e._pos=ce.ZERO,e._rot=gr.IDENTITY,e._scale=ce.ONE,e._mat=B.IDENTITY,e._dirtyFlags=0,e._lpos=ce.ZERO,e._lrot=gr.IDENTITY,e._lscale=ce.ONE,e._activeInHierarchy=!1,j.director&&j.director.root&&(e._renderScene=j.director.root.createScene({})),e._inited=!j.game||!j.game._isCloning,e._init(),e}function Ww(e,t){if(!t){var i=j.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}j.Scene=Vw,j.find=Ww;var qw=mt.fastRemoveAt,Xw=Pi.Flags.IsStartCalled,Yw=Pi.Flags.IsOnEnableCalled;function Kw(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(i<c)o=a-1;else if(c<i)r=a+1;else{c=s._id;if(n<c)o=a-1;else{if(!(c<n))return a;r=a+1}}}return~r}function Qw(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}Pi.Flags.IsEditorOnEnableCalled;function Zw(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ve;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e}function Jw(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}Zw.stableRemoveInactive=Qw;l(rA,eA=Zw),(s=rA.prototype).add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},s.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},s.cancelInactive=function(e){Qw(this._zero,e),Qw(this._neg,e),Qw(this._pos,e)},s.invoke=function(){var e=this._neg,e=(0<e.array.length&&(e.array.sort(Jw),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0,this._pos);0<e.array.length&&(e.array.sort(Jw),this._invoke(e),e.array.length=0)};var $w,eA,tA=rA,iA=(l(nA,$w=Zw),(ane=nA.prototype).add=function(e){var t,i=e.constructor._executionOrder;0===i?this._zero.array.push(e):(t=Kw(i=(i<0?this._neg:this._pos).array,e))<0&&i.splice(~t,0,e)},ane.remove=function(e){var t=e.constructor._executionOrder;0===t?this._zero.fastRemove(e):0<=(e=Kw((t=t<0?this._neg:this._pos).array,e))&&t.removeAt(e)},ane.invoke=function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)},nA);function nA(){return $w.apply(this,arguments)||this}function rA(){return eA.apply(this,arguments)||this}function oA(e,t,i){var r,o,a,n="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",t=t?Function("it","dt",n):Function("it",n);return r=Function("c","dt",e),o=t,a=i,function(t,i){try{o(t,i)}catch(e){j._throw(e);var n=t.array;for(a&&(n[t.i]._objFlags|=a),++t.i;t.i<n.length;++t.i)try{r(n[t.i],i)}catch(e){j._throw(e),a&&(n[t.i]._objFlags|=a)}}}}function aA(e){var t=j.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];n._enabled&&(n.onEnable(),n.node._activeInHierarchy&&t._onEnabled(n))}}var sA,cA=oA("c.start();c._objFlags|="+Xw,!1,Xw),lA=oA("c.update(dt)",!0),uA=oA("c.lateUpdate(dt)",!0),hA=((fie=SA.prototype).unscheduleAll=function(){this.startInvoker=new tA(cA),this.updateInvoker=new iA(lA),this.lateUpdateInvoker=new iA(uA),this._updating=!1},fie._onEnabled=function(e){j.director.getScheduler().resumeTarget(e),e._objFlags|=Yw,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},fie._onDisabled=function(e){j.director.getScheduler().pauseTarget(e),e._objFlags&=~Yw;var t=this._deferredComps.indexOf(e);0<=t?qw(this._deferredComps,t):(!e.start||e._objFlags&Xw||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},fie.enableComp=function(e,t){if(!(e._objFlags&Yw)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},fie.disableComp=function(e){e._objFlags&Yw&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},fie.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},fie.updatePhase=function(e){this.updateInvoker.invoke(e)},fie.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},fie._startForNewComps=function(){0<this._deferredComps.length&&(this._deferredSchedule(),this.startInvoker.invoke())},fie._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&Xw||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},fie._deferredSchedule=function(){for(var e=this._deferredComps,t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0},SA),pA=Pi.Flags.IsPreloadStarted,_A=Pi.Flags.IsOnLoadStarted,fA=Pi.Flags.IsOnLoadCalled,dA=Pi.Flags.Deactivating,mA=(l(xA,sA=Zw),(cM=xA.prototype).add=function(e){this._zero.array.push(e)},cM.remove=function(e){this._zero.fastRemove(e)},cM.cancelInactive=function(e){Zw.stableRemoveInactive(this._zero,e)},cM.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},xA),gA=oA("c.__preload();"),vA=oA("c.onLoad();c._objFlags|="+fA,!1,fA),yA=new dt(4);function xA(){return sA.apply(this,arguments)||this}function SA(){this._deferredComps=[],this.unscheduleAll()}yA.get=function(){var e=this._get()||{preload:new mA(gA),onLoad:new tA(vA),onEnable:new tA(aA)},t=(e.preload._zero.i=-1,e.onLoad);return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var bA,TA,EA,CA=Rre("NodeActivator",((dU=PA.prototype).reset=function(){this._activatingStack=[]},dU.activateNode=function(e,t){if(t){t=yA.get();this._activatingStack.push(t),this._activateNodeRecursively(e,t.preload,t.onLoad,t.onEnable),t.preload.invoke(),t.onLoad.invoke(),t.onEnable.invoke(),this._activatingStack.pop(),yA.put(t)}else{this._deactivateNodeRecursively(e);for(var i=ge(this._activatingStack);!(n=i()).done;){var n=n.value;n.preload.cancelInactive(pA),n.onLoad.cancelInactive(_A),n.onEnable.cancelInactive()}}e.emit(T.ACTIVE_IN_HIERARCHY_CHANGED,e)},dU.activateComp=function(e,t,i,n){Ri(e,!0)&&(e._objFlags&pA||(e._objFlags|=pA,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&_A||(e._objFlags|=_A,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=fA):e._objFlags|=fA),e._enabled)&&e.node._activeInHierarchy&&j.director._compScheduler.enableComp(e,n)},dU.destroyComp=function(e){j.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&fA&&e.onDestroy()},dU._activateNodeRecursively=function(e,t,i,n){if(e._objFlags&dA)ee(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var a=e._components[o];a instanceof j.Component?this.activateComp(a,t,i,n):(a=a,h=o,ee(3817,(u=e).name,h),console.log("Corrupted component value:",a),a?u._removeComponent(a):mt.removeAt(u._components,h),--o,--r)}for(var s=0,c=e._children.length;s<c;++s){var l=e._children[s];l._active&&this._activateNodeRecursively(l,t,i,n)}e._onPostActivated(!0)}var u,h},dU._deactivateNodeRecursively=function(e){e._objFlags|=dA,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(j.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~dA)}for(var r=0,o=e._children.length;r<o;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~dA)}e._onPostActivated(!1),e._objFlags&=~dA},PA)),wA=Rre("SceneAsset",f("cc.SceneAsset")((l(AA,EA=P_),(YD=AA.prototype).initDefault=function(e){EA.prototype.initDefault.call(this,e),this.scene=new Vw("New Scene")},YD.validate=function(){return!!this.scene},bA=i((Iie=AA).prototype,"scene",[Ap,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W3=Iie))||W3);function AA(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=EA.call.apply(EA,[this].concat(i))||this,"scene",bA,p(e)),e}function PA(){this.resetComp=void 0,this.reset()}j.SceneAsset=wA;var IA,RA,DA=Rre("TextAsset",f("cc.TextAsset")((l(OA,RA=P_),OA.prototype.toString=function(){return this.text},TA=i((Rie=OA).prototype,"text",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),B1=Rie))||B1);function OA(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=RA.call.apply(RA,[this].concat(i))||this,"text",TA,p(e)),e}j.TextAsset=DA;var MA,NA=Rre("JsonAsset",f("cc.JsonAsset")((l(LA,MA=P_),IA=i((x=LA).prototype,"json",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hd=x))||Hd);function LA(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=MA.call.apply(MA,[this].concat(i))||this,"json",IA,p(e)),e}j.JsonAsset=NA;(r=oP.prototype)._init=function(){},r.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},r.initOcclusionQuery=function(){var e;this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),this._occlusionQueryMaterial||((e=new Ey)._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant())},r.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},r.onGlobalPipelineStateChanged=function(){},r.destroy=function(){var e;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null!=(e=this._occlusionQueryInputAssembler)&&e.destroy(),(this._occlusionQueryInputAssembler=null)!=(e=this._occlusionQueryVertexBuffer)&&e.destroy(),(this._occlusionQueryVertexBuffer=null)!=(e=this._occlusionQueryIndicesBuffer)&&e.destroy(),this._occlusionQueryIndicesBuffer=null},r._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,i=(this._occlusionQueryVertexBuffer=e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,8*i,i)),this._occlusionQueryVertexBuffer.update(t),new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3])),t=Uint16Array.BYTES_PER_ELEMENT,t=(this._occlusionQueryIndicesBuffer=e.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,36*t,t)),this._occlusionQueryIndicesBuffer.update(i),[new Wa("a_position",W.RGB32F)]),i=new Xa(t,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(i)},e(oP,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(uS.ATTACHMENT_SCALE_CAHNGED,e))}}]);var BA,FA,zA,UA,kA,GA,HA,VA,jA,WA,qA,XA=oP,YA=Rre("ForwardPipeline",(Sa=f("ForwardPipeline"),g=v([ba]),t=m(),Sa((l(rP,qA=SS),(R=rP.prototype).initialize=function(e){return qA.prototype.initialize.call(this,e),0===this._flows.length&&((e=new oT).initialize(oT.initInfo),this._flows.push(e),(e=new kb).initialize(kb.initInfo),this._flows.push(e)),!0},R.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new XA,!(!qA.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(ee(2402),1))},R._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,n=0;n<e.length;++n)var r=e[n].window,t=Math.max(r.width,t),i=Math.max(r.height,i);t===this._width&&i===this._height||(this._width=t,this._height=i)},R.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();return this._commandBuffers.length=0,qA.prototype.destroy.call(this)},R._activeRenderer=function(){var e=this.device,e=(this._commandBuffers.push(e.commandBuffer),this.globalDSManager.pointSampler);return this._descriptorSet.bindSampler(qg,e),this._descriptorSet.bindTexture(qg,D0.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Kg,e),this._descriptorSet.bindTexture(Kg,D0.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},R._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Dg.BINDING).destroy(),this._descriptorSet.getBuffer(Mg.BINDING).destroy(),this._descriptorSet.getBuffer(Og.BINDING).destroy(),this._descriptorSet.getTexture(qg).destroy(),this._descriptorSet.getTexture(Kg).destroy())},e(rP,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),BA=i((o=rP).prototype,"renderTextures",[g,d,t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),n=o))||n)),KA=[new Ca(0,0,0,0),new Ca(0,0,0,0),new Ca(0,0,0,0)],QA=Rre("GbufferStage",(I=f("GbufferStage"),vie=v([kd]),b=m(),I((l(nP,WA=Gd),(c=nP.prototype).initialize=function(e){return WA.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},c.activate=function(e,t){WA.prototype.activate.call(this,e,t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=mb(this.renderQueues[i])},c.destroy=function(){},c.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(gb),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var n=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<n.length;++s)for(var c=n[s],l=c.model.subModels,r=0;r<l.length;++r)for(var u=l[r],h=u.passes,o=0;o<h.length;++o){var p=h[o];if(p.phase===this._phaseID){var _=p.batchingScheme;if(_===I0.INSTANCING){var f=p.getInstancedBuffer();f.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(f)}else if(_===I0.VB_MERGING){f=p.getBatchedBuffer();f.merge(u,o,c.model),this._batchedQueue.queue.add(f)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}this._renderQueues.forEach(vb);var d=t.commandBuffers[0],m=(this._instancedQueue.uploadBuffers(d),this._batchedQueue.uploadBuffers(d),e.clearFlag&la.COLOR&&(t.pipelineSceneData.isHDR?fy(KA[0],e.clearColor):(KA[0].x=e.clearColor.x,KA[0].y=e.clearColor.y,KA[0].z=e.clearColor.z)),KA[0].w=e.clearColor.w,t.getPipelineRenderData().gbufferFrameBuffer),g=m.renderPass;d.beginRenderPass(g,m,this._renderArea,KA,e.clearDepth,e.clearStencil),d.setScissor(t.generateScissor(e)),d.setViewport(t.generateViewport(e)),d.bindDescriptorSet(jg.GLOBAL,t.descriptorSet);for(var v=0;v<this.renderQueues.length;v++)this._renderQueues[v].recordCommandBuffer(i,g,d);this._instancedQueue.recordCommandBuffer(i,g,d),this._batchedQueue.recordCommandBuffer(i,g,d),d.endRenderPass()},nP.initInfo={name:"GbufferStage",priority:vI.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:ub.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:ub.BACK_TO_FRONT,stages:["default"]}]},FA=i((E2=nP).prototype,"renderQueues",[vie,d,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xH=E2))||xH)),ZA=[new Ca(0,0,0,1)],JA=Rre("LightingStage",(uI=f("LightingStage"),yI=v(Ey),C=m(),C7=v([kd]),Nk=m(),uI((l(iP,jA=Gd),(E=iP.prototype).initialize=function(e){return jA.prototype.initialize.call(this,e),!0},E.gatherLights=function(e){for(var t=this._pipeline,i=t.commandBuffers[0],n=e.scene.sphereLights,r=e.scene.spotLights,o=ua.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Fr.length,u=l*this._maxDeferredLights,h=0;h<n.length&&c<this._maxDeferredLights;h++,++c){var p,_=n[h];ua.set(o,_.position.x,_.position.y,_.position.z,_.range),Ch.sphereFrustum(o,e.frustum)&&(ce.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),ce.toArray(a,_.color),_.useColorTemperature&&(p=_.colorTemperatureRGB,a[0]*=p.x,a[1]*=p.y,a[2]*=p.z),t.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u))}for(var f=0;f<r.length&&c<this._maxDeferredLights;f++,++c){var d,m=r[f];ua.set(o,m.position.x,m.position.y,m.position.z,m.range),Ch.sphereFrustum(o,e.frustum)&&(ce.toArray(a,m.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),ce.toArray(a,m.color),m.useColorTemperature&&(d=m.colorTemperatureRGB,a[0]*=d.x,a[1]*=d.y,a[2]*=d.z),t.pipelineSceneData.isHDR?a[3]=m.luminance*s*this._lightMeterScale:a[3]=m.luminance,this._lightBufferData.set(a,c*l+u),a[0]=m.size,a[1]=m.range,a[2]=m.spotAngle,this._lightBufferData.set(a,c*l+2*u),ce.toArray(a,m.direction),this._lightBufferData.set(a,c*l+3*u))}this._lightBufferData.set([c],3*u+3),i.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},E.activate=function(e,t){jA.prototype.activate.call(this,e,t),this._uiPhase.activate(e);for(var t=e.device,i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=mb(this.renderQueues[i]);var n=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights,n=Math.ceil(n/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,r=(this._deferredLitsBufs=t.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,n,t.capabilities.uboOffsetAlignment)),t.createBuffer(new Ra(this._deferredLitsBufs,0,n))),n=(this._lightBufferData=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),new ns(Ig.bindings));this._descriptorSetLayout=t.createDescriptorSetLayout(n),this._descriptorSet=t.createDescriptorSet(new rs(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Fg.BINDING,r),this._planarQueue=new Bb(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},E.destroy=function(){var e;null!=(e=this._deferredLitsBufs)&&e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},E.render=function(e){var t=this._pipeline,i=t.device,n=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects,a=(this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,n),n.bindDescriptorSet(jg.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&la.COLOR&&(ZA[0].x=e.clearColor.x,ZA[0].y=e.clearColor.y,ZA[0].z=e.clearColor.z),ZA[0].w=0,t.getPipelineRenderData()),s=a.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),n.beginRenderPass(c,s,this._renderArea,ZA,e.clearDepth,e.clearStencil),n.setScissor(t.generateScissor(e)),n.setViewport(t.generateViewport(e)),n.bindDescriptorSet(jg.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],s=l.getShaderVariant(),u=0;u<3;++u)l.descriptorSet.bindTexture(u,a.gbufferRenderTargets[u]),l.descriptorSet.bindSampler(u,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),n.bindDescriptorSet(jg.MATERIAL,l.descriptorSet);r=t.quadIAOffscreen,t=null;null!=(t=null!=l&&null!=s&&null!=r?uy.getOrCreatePipelineState(i,l,s,c,r):t)&&(n.bindPipelineState(t),n.bindInputAssembler(r),n.draw(r)),this._renderQueues.forEach(gb);for(var h=0,p=0,_=0,f=0;f<o.length;++f)for(var d=o[f],m=d.model.subModels,h=0;h<m.length;++h)for(var g=m[h].passes,p=0;p<g.length;++p)if(g[p].phase===this._phaseID)for(_=0;_<this._renderQueues.length;_++)this._renderQueues[_].insertRenderPass(d,h,p);if(0<o.length){this._renderQueues.forEach(vb);for(var v=0;v<this._renderQueues.length;v++)this._renderQueues[v].recordCommandBuffer(i,c,n);this._planarQueue.recordCommandBuffer(i,c,n)}this._uiPhase.render(e,c),n.endRenderPass()},iP.initInfo={name:"LightingStage",priority:vI.LIGHTING,tag:0},zA=i((A=iP).prototype,"_deferredMaterial",[yI,d,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UA=i(A.prototype,"renderQueues",[C7,d,Nk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yU=A))||yU)),$A=[new Ca(0,0,0,1)],eP=Rre("PostProcessStage",(Z5=f("PostProcessStage"),Y3=v(Ey),EW=m(),P=v([kd]),bne=m(),Z5((l(tP,VA=Gd),(pF=tP.prototype).initialize=function(e){return VA.prototype.initialize.call(this,e),!0},pF.activate=function(e,t){VA.prototype.activate.call(this,e,t),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},pF.destroy=function(){},pF.render=function(e){var t=this._pipeline,i=t.device,n=t.pipelineSceneData,r=t.commandBuffers[0],o=(t.pipelineUBO.updateCameraUBO(e),e.viewport),o=(this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height,t.getPipelineRenderData()),a=e.window.framebuffer,s=t.getRenderPass(e.clearFlag,a),a=(e.clearFlag&la.COLOR&&($A[0].x=e.clearColor.x,$A[0].y=e.clearColor.y,$A[0].z=e.clearColor.z),$A[0].w=e.clearColor.w,r.beginRenderPass(s,a,this._renderArea,$A,e.clearDepth,e.clearStencil),r.bindDescriptorSet(jg.GLOBAL,t.descriptorSet),n.postprocessMaterial.passes[0]),n=a.getShaderVariant(),o=(t.bloomEnabled?a.descriptorSet.bindTexture(0,o.bloom.combineTex):a.descriptorSet.bindTexture(0,o.outputRenderTargets[0]),a.descriptorSet.bindSampler(0,o.sampler),a.descriptorSet.update(),r.bindDescriptorSet(jg.MATERIAL,a.descriptorSet),e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen),c=null,a=(null!=a&&null!=n&&null!=o&&(c=uy.getOrCreatePipelineState(i,a,n,s,o)),t.pipelineSceneData.renderObjects);null!=c&&0<a.length&&(r.bindPipelineState(c),r.bindInputAssembler(o),r.draw(o)),this._uiPhase.render(e,s),Sy(i,s,r,t.profiler,e),r.endRenderPass()},tP.initInfo={name:"PostProcessStage",priority:L6.POST_PROCESS,tag:0},kA=i((w=tP).prototype,"_postProcessMaterial",[Y3,d,EW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GA=i(w.prototype,"renderQueues",[P,d,bne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aie=w))||aie));function tP(){var e;return _(e=VA.call(this)||this,"_postProcessMaterial",kA,p(e)),_(e,"renderQueues",GA,p(e)),e._renderArea=new va,e._uiPhase=new Fb,e}function iP(){var e;return(e=jA.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=zg.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new va,e._uiPhase=void 0,_(e,"_deferredMaterial",zA,p(e)),_(e,"renderQueues",UA,p(e)),e._phaseID=O0("default"),e._renderQueues=[],e._uiPhase=new Fb,e}function nP(){var e;return _(e=WA.call(this)||this,"renderQueues",FA,p(e)),e._renderQueues=[],e._renderArea=new va,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=O0("default"),e._batchedQueue=new yb,e._instancedQueue=new xb,e}function rP(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=qA.call.apply(qA,[this].concat(i))||this,"renderTextures",BA,p(e)),e._postRenderPass=null,e}function oP(){this.fog=new lT,this.ambient=new Jr,this.skybox=new Wy,this.shadows=new Iy,this.octree=new eo,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}(Nw=HA=HA||{})[Nw.NONE=0]="NONE",Nw[Nw.FXAA=1]="FXAA";function aP(){}l(hP,cP=XA),(h=hP.prototype).onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},h.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],i=[],n=0;n<6;++n){var r=this._bloomMaterial.passes[1+n],o=(r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently(),this._bloomMaterial.passes[7+n]);o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),i.push(o.native)}e=this._bloomMaterial.passes[13];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},h.updatePostProcessPass=function(){var e;this.postprocessMaterial&&((e=this.postprocessMaterial.passes[0]).beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently())},h.initPipelinePassInfo=function(){var e=new Ey;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new Ey;i._uuid="builtin-bloom-material",i.initialize({effectName:"bloom"});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._bloomMaterial=i;var r=new Ey;r._uuid="builtin-post-process-material",zt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=HA.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},h.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},h.activate=function(e,t){return cP.prototype.activate.call(this,e,t),this.initPipelinePassInfo(),!0},h.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},h.updateDeferredLightPass=function(){var e;this._deferredLightingMaterial&&(this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1),(e=this._deferredLightingMaterial.passes[0]).beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently())},e(hP,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines,i=(Object.assign(t,{ANTIALIAS_TYPE:e}),new Ey);i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]);var sP,cP,lP=hP,uP=[new Ca(0,0,0,1)];function hP(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=cP.call.apply(cP,[this].concat(i))||this)._antiAliasing=HA.NONE,e}aP.SIZE=4*(aP.COUNT=4+(aP.TEXTURE_SIZE_OFFSET=0));var pP,_P,fP,dP,mP,gP=Rre("BloomStage",(kw=f("BloomStage"),XN=v(Ey),S=m(),kw((l(EP,mP=Gd),(a=EP.prototype).initialize=function(e){return mP.prototype.initialize.call(this,e),!0},a.activate=function(e,t){mP.prototype.activate.call(this,e,t),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},a.destroy=function(){},a.render=function(e){var t,i=this._pipeline;if(i.generateBloomRenderData(),(null!=(t=e.window)&&t.swapchain||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var n=0;n<14;++n)this._bloomUBO[n]=i.device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,aP.SIZE,aP.SIZE));e.clearFlag&la.COLOR&&(uP[0].x=e.clearColor.x,uP[0].y=e.clearColor.y,uP[0].z=e.clearColor.z),uP[0].w=e.clearColor.w,this._prefilterPass(e,i),this._downsamplePass(e,i),this._upsamplePass(e,i),this._combinePass(e,i)}},a._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(aP.COUNT),a=(a[aP.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],a),i.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,uP,0,0),i.bindDescriptorSet(jg.GLOBAL,t.descriptorSet),n.descriptorSet.bindBuffer(0,this._bloomUBO[0]),n.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),n.descriptorSet.bindSampler(1,o.sampler),n.descriptorSet.update(),i.bindDescriptorSet(jg.MATERIAL,n.descriptorSet),e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen),r=null,e=n.getShaderVariant();null!=(r=null!=n&&null!=e&&null!=a?uy.getOrCreatePipelineState(t.device,n,e,o.renderPass,a):r)&&(i.bindPipelineState(r),i.bindInputAssembler(a),i.draw(a)),i.endRenderPass()},a._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(aP.COUNT),a=0;a<this.iterations;++a){o[aP.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[aP.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,uP,0,0);var s=n.passes[1+a],c=s.getShaderVariant(),l=(s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),i.bindDescriptorSet(jg.MATERIAL,s.descriptorSet),e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen),u=null;null!=(u=null!=s&&null!=c&&null!=l?uy.getOrCreatePipelineState(t.device,s,c,r.renderPass,l):u)&&(i.bindPipelineState(u),i.bindInputAssembler(l),i.draw(l)),i.endRenderPass()}},a._upsamplePass=function(e,t){var i=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var n=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(aP.COUNT),a=0;a<this.iterations;++a){var s=a+6+1,c=(o[aP.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[aP.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,n.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-a],this._renderArea,uP,0,0),r.passes[7+a]),l=c.getShaderVariant(),s=(c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,i.sampler),c.descriptorSet.update(),n.bindDescriptorSet(jg.MATERIAL,c.descriptorSet),e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen),u=null;null!=(u=null!=c&&null!=l&&null!=s?uy.getOrCreatePipelineState(t.device,c,l,i.renderPass,s):u)&&(n.bindPipelineState(u),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()}},a._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var i=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(aP.COUNT),a=(a[aP.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],a),i.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,uP,0,0),i.bindDescriptorSet(jg.GLOBAL,t.descriptorSet),n.passes[13]),n=(a.descriptorSet.bindBuffer(0,this._bloomUBO[13]),a.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),a.descriptorSet.bindTexture(2,o.upsampleTexs[0]),a.descriptorSet.bindSampler(1,o.sampler),a.descriptorSet.bindSampler(2,o.sampler),a.descriptorSet.update(),i.bindDescriptorSet(jg.MATERIAL,a.descriptorSet),e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen),r=null,e=a.getShaderVariant();null!=(r=null!=a&&null!=e&&null!=n?uy.getOrCreatePipelineState(t.device,a,e,o.renderPass,n):r)&&(i.bindPipelineState(r),i.bindInputAssembler(n),i.draw(n)),i.endRenderPass()},EP.initInfo={name:"BloomStage",priority:L6.BLOOM,tag:0},sP=i((s=EP).prototype,"_bloomMaterial",[XN,d,S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ane=s))||ane)),vP=Rre("MainFlow",f("MainFlow")((l(TP,dP=y),(fie=TP.prototype).initialize=function(e){return dP.prototype.initialize.call(this,e),0===this._stages.length&&((e=new QA).initialize(QA.initInfo),this._stages.push(e),(e=new JA).initialize(JA.initInfo),this._stages.push(e),(e=new gP).initialize(gP.initInfo),this._stages.push(e),(e=new eP).initialize(eP.initInfo),this._stages.push(e)),!0},fie.activate=function(e){dP.prototype.activate.call(this,e)},fie.render=function(e){dP.prototype.render.call(this,e)},fie.destroy=function(){dP.prototype.destroy.call(this)},TP.initInfo={name:Qp,priority:Mne.MAIN,stages:[]},cM=TP))||cM),yP=(l(bP,fP=function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null}),bP),xP=Rre("DeferredPipeline",(dU=f("DeferredPipeline"),YD=v([ba]),Iie=m(),dU((l(SP,_P=SS),(W3=SP.prototype).initialize=function(e){return _P.prototype.initialize.call(this,e),0===this._flows.length&&((e=new oT).initialize(oT.initInfo),this._flows.push(e),(e=new vP).initialize(vP.initInfo),this._flows.push(e)),!0},W3.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new lP,!(!_P.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(ee(2402),1))},W3.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();return this._commandBuffers.length=0,_P.prototype.destroy.call(this)},W3.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},W3._activeRenderer=function(e){var t=this.device,i=(this._commandBuffers.push(t.commandBuffer),this.globalDSManager.pointSampler);this._descriptorSet.bindSampler(qg,i),this._descriptorSet.bindTexture(qg,D0.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Kg,i),this._descriptorSet.bindTexture(Kg,D0.get("default-texture").getGFXTexture()),this._descriptorSet.update();if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var n,r,o,i=this._createQuadInputAssembler();return!!(i.quadIB&&i.quadVB&&i.quadIA)&&(this._quadVBOnscreen=i.quadVB,this._quadIAOnscreen=i.quadIA,this._gbufferRenderPass||((i=new Ya).format=W.RGBA16F,i.loadOp=Yo.CLEAR,i.storeOp=Ko.STORE,(n=new Ya).format=W.RGBA16F,n.loadOp=Yo.CLEAR,n.storeOp=Ko.STORE,(r=new Ya).format=W.RGBA16F,r.loadOp=Yo.CLEAR,r.storeOp=Ko.STORE,(o=new Ka).format=W.DEPTH_STENCIL,o.depthLoadOp=Yo.CLEAR,o.depthStoreOp=Ko.STORE,o.stencilLoadOp=Yo.CLEAR,o.stencilStoreOp=Ko.STORE,i=new Ja([i,n,r],o),this._gbufferRenderPass=t.createRenderPass(i)),this._lightingRenderPass||((n=new Ya).format=W.RGBA8,n.loadOp=Yo.CLEAR,n.storeOp=Ko.STORE,n.endAccesses=[Qo.COLOR_ATTACHMENT_WRITE],(r=new Ka).format=W.DEPTH_STENCIL,r.depthLoadOp=Yo.LOAD,r.depthStoreOp=Ko.DISCARD,r.stencilLoadOp=Yo.LOAD,r.stencilStoreOp=Ko.DISCARD,r.beginAccesses=[Qo.DEPTH_STENCIL_ATTACHMENT_WRITE],r.endAccesses=[Qo.DEPTH_STENCIL_ATTACHMENT_WRITE],o=new Ja([n],r),this._lightingRenderPass=t.createRenderPass(o)),this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0)},W3._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Dg.BINDING).destroy(),this._descriptorSet.getBuffer(Mg.BINDING).destroy(),this._descriptorSet.getBuffer(Og.BINDING).destroy(),this._descriptorSet.getTexture(qg).destroy(),this._descriptorSet.getTexture(Kg).destroy())},W3._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();for(var i=e.gbufferRenderTargets.length=0;i<e.outputRenderTargets.length;i++)e.outputRenderTargets[i].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},W3._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,n=0;n<e.length;++n)var r=e[n].window,t=Math.max(r.width,t),i=Math.max(r.height,i);t===this._width&&i===this._height||(this._width=t,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},W3._generateDeferredRenderData=function(){for(var t=this,e=this.device,i=this._pipelineRenderData=new yP,n=this.pipelineSceneData,r=0;r<3;++r)i.gbufferRenderTargets.push(e.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,W.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale)));i.outputDepth=e.createTexture(new Na(Lo.TEX2D,Bo.DEPTH_STENCIL_ATTACHMENT|Bo.SAMPLED,W.DEPTH_STENCIL,this._width*n.shadingScale,this._height*n.shadingScale)),i.gbufferFrameBuffer=e.createFramebuffer(new ts(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(e.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED,W.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale))),i.outputFrameBuffer=e.createFramebuffer(new ts(this._lightingRenderPass,i.outputRenderTargets,null)),this.on(uS.ATTACHMENT_SCALE_CAHNGED,function(e){i.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(i.gbufferFrameBuffer),t.applyFramebufferRatio(i.outputFrameBuffer)}),i.sampler=this.globalDSManager.linearSampler},pP=i((Rie=SP).prototype,"renderTextures",[YD,d,Iie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),B1=Rie))||B1));function SP(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=_P.call.apply(_P,[this].concat(i))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,_(e,"renderTextures",pP,p(e)),e}function bP(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=fP.call.apply(fP,[this].concat(i))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}function TP(){return dP.apply(this,arguments)||this}function EP(){var e;return(e=mP.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,_(e,"_bloomMaterial",sP,p(e)),e._renderArea=new va,e._bloomUBO=[],e}function CP(){var e=new YA;return e.initialize({flows:[]}),e}var wP=new U,Hd=((x=AP.prototype).pauseRendering=function(){this.isPause=!0},x.resumeRendering=function(){this.isPause=!1},x.main=function(e){var t;null!=e?(window._CCSettings&&window._CCSettings.splashScreen?((t=this.settings=window._CCSettings.splashScreen).totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new Ca(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark):this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Ca(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0},""===this.settings.base64src||this.settings.totalTime<=0?(this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0):(j.view.resizeWithBrowserSize(!0),(t=window._CCSettings.designResolution)?j.view.setDesignResolutionSize(t.width,t.height,t.policy):j.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,j.game.once(j.Game.EVENT_GAME_INITED,function(){j.director._lateUpdate=performance.now()},j.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src)):tt("RENDER ROOT IS NULL.")},x.setOnFinish=function(e){if(this._directCall&&e)return AP._ins=void 0,void e();this.callBack=e},x._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),j.game.resume())},x.preInit=function(){var e=this.settings.clearColor,e=(this.clearColors=[new Ca(e.x,e.y,e.z,e.w)],this.device),t=this.swapchain,i=(this.renderArea=new va(0,0,t.width,t.height),this.cmdBuff=e.commandBuffer,new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1])),n=4*Float32Array.BYTES_PER_ELEMENT,n=(this.vertexBuffers=e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,4*n,n)),this.vertexBuffers.update(i),new Uint16Array([0,1,2,1,3,2])),i=Uint16Array.BYTES_PER_ELEMENT,i=(this.indicesBuffers=e.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,6*i,i)),this.indicesBuffers.update(n),[new Wa("a_position",W.RG32F),new Wa("a_texCoord",W.RG32F)]),n=new Xa(i,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(n),this.projection=new B,B.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,t.surfaceTransform)},x.init=function(){var _=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),j.game.pause(),this.handle=requestAnimationFrame(function e(t){var i,n,r,o,a,s,c,l,u,h,p;_.cancelAnimate||(i=_.settings,r=_.device,n=_.swapchain,B.ortho(_.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,n.surfaceTransform),a=(r=n.width)<(o=n.height)?r:o,_.startTime<0&&(_.startTime=t),s=pd(zn((t=t-_.startTime)/i.totalTime)),"NONE"===i.effect&&(s=1),h=_.logoTexture.width,l=_.logoTexture.height,p=(u=a*i.displayRatio)*h/l,c=u,n.surfaceTransform!==Ao.ROTATE_90&&n.surfaceTransform!==Ao.ROTATE_270||(p=u*r/o,c=u*l/h*o/r),_.logoMat.setProperty("resolution",wP.set(r,o),0),_.logoMat.setProperty("scale",wP.set(p,c),0),_.logoMat.setProperty("translate",wP.set(.5*r,.5*o),0),_.logoMat.setProperty("percent",s),_.logoMat.setProperty("u_projection",_.projection),_.logoMat.passes[0].update(),i.displayWatermark&&_.watermarkMat&&(u=_.watermarkTexture.width,p=(h=l=.5*a)*_.watermarkTexture.height/u,n.surfaceTransform!==Ao.ROTATE_90&&n.surfaceTransform!==Ao.ROTATE_270||(h=.5*l,p=l*r/o*.5),_.watermarkMat.setProperty("resolution",wP.set(r,o),0),_.watermarkMat.setProperty("scale",wP.set(h,p),0),_.watermarkMat.setProperty("translate",wP.set(.5*r,.1*o),0),_.watermarkMat.setProperty("percent",s),_.watermarkMat.setProperty("u_projection",_.projection),_.watermarkMat.passes[0].update()),_.isPause||(_.frame(),t>i.totalTime&&(_.splashFinish=!0)),requestAnimationFrame(e))})},x.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},x.initLogo=function(){var e=this.device,t=(this.logoMat=new Ey,this.logoMat.initialize({effectName:"splash-screen"}),new La),t=(t.addressU=Go.CLAMP,t.addressV=Go.CLAMP,t.addressW=Go.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Na(Lo.TEX2D,Bo.SAMPLED|Bo.TRANSFER_DST,W.RGBA8,this.logoImage.width,this.logoImage.height)),this.logoMat.passes[0]),i=t.getBinding("mainTexture"),t=(t.bindTexture(i,this.logoTexture),this.shader=t.getShaderVariant(),t.descriptorSet),i=(t.bindSampler(i,this.sampler),t.update(),new Ta);i.texExtent.width=this.logoImage.width,i.texExtent.height=this.logoImage.height,i.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[i])},x.initWarterMark=function(){var e=document.createElement("canvas"),t=(e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height,e.getContext("2d")),i=(t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`","Powered by Cocos Creator"),n=t.measureText(i),t=(t.fillText(i,(330-n.width)/2,6),new Ta),i=(t.texExtent.width=e.width,t.texExtent.height=e.height,t.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Na(Lo.TEX2D,Bo.SAMPLED|Bo.TRANSFER_DST,W.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[t]),this.watermarkMat=new Ey,this.watermarkMat.initialize({effectName:"splash-screen"}),this.watermarkMat.passes[0]),n=i.getBinding("mainTexture");i.bindTexture(n,this.watermarkTexture),i.descriptorSet.update()},x.frame=function(){var e=this.device,t=this.swapchain,i=(e.acquire([t]),this.cmdBuff),n=this.framebuffer,r=this.renderArea,t=(r.width=t.width,r.height=t.height,i.begin(),i.beginRenderPass(n.renderPass,n,r,this.clearColors,1,0),this.logoMat.passes[0]),r=uy.getOrCreatePipelineState(e,t,this.shader,n.renderPass,this.quadAssmebler);i.bindPipelineState(r),i.bindDescriptorSet(jg.MATERIAL,t.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat&&(r=this.watermarkMat.passes[0],t=uy.getOrCreatePipelineState(e,r,this.shader,n.renderPass,this.quadAssmebler),i.bindPipelineState(t),i.bindDescriptorSet(jg.MATERIAL,r.descriptorSet),i.bindInputAssembler(this.quadAssmebler),i.draw(this.quadAssmebler)),i.endRenderPass(),i.end(),e.flushCommands([i]),e.queue.submit([i]),e.present()},x.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,AP._ins=void 0},e(AP,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return AP._ins=AP._ins?AP._ins:new AP}}]),AP);function AP(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}Hd._ins=void 0,j.internal.SplashScreen=Hd;var PP=Rre("System",(IP.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0},(r=IP.prototype).init=function(){},r.update=function(){},r.postUpdate=function(){},e(IP,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),IP));function IP(){this._id="",this._priority=0,this._executeInEditMode=!1}PP.Priority=Ot({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});function RP(e,t,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=i,this.markedForDeletion=n}function DP(e,t,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=i,this.callback=n}function OP(e,t,i,n,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=r,this.paused=o}var MP=new Ce("Scheduler"),NP=(RP.get=function(e,t,i,n){var r=RP._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new RP(e,t,i,n),r},RP.put=function(e){RP._listEntries.length<20&&(e.target=null,RP._listEntries.push(e))},RP._listEntries=[],DP.get=function(e,t,i,n){var r=DP._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new DP(e,t,i,n),r},DP.put=function(e){DP._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,DP._hashUpdateEntries.push(e))},DP._hashUpdateEntries=[],OP.get=function(e,t,i,n,r,o){var a=OP._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=i,a.currentTimer=n,a.currentTimerSalvaged=r,a.paused=o):a=new OP(e,t,i,n,r,o),a},OP.put=function(e){OP._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,OP._hashTimerEntries.push(e))},OP._hashTimerEntries=[],(Sa=LP.prototype).initWithCallback=function(e,t,i,n,r,o){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=o,this._useDelay=0<this._delay,this._repeat=r,this._runForever=this._repeat===j.macro.REPEAT_FOREVER,!0},Sa.getInterval=function(){return this._interval},Sa.setInterval=function(e){this._interval=e},Sa.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},Sa.getCallback=function(){return this._callback},Sa.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},Sa.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},LP);function LP(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}NP._timers=[],NP.get=function(){return NP._timers.pop()||new NP},NP.put=function(e){NP._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,NP._timers.push(e))};var BP,FP=Rre("Scheduler",(l(zP,BP=PP),zP.enableForTarget=function(e){var t=!1;(t=e.uuid||e.id?!0:t)||(e.__instanceId?J(1513):e.id=MP.getNewId())},(R=zP.prototype).setTimeScale=function(e){this._timeScale=e},R.getTimeScale=function(){return this._timeScale},R.update=function(e){var t,i,n,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),a=0,i=(t=this._updatesNegList).length;a<i;a++)(n=t[a]).paused||n.markedForDeletion||n.target.update(e);for(a=0,i=(t=this._updates0List).length;a<i;a++)(n=t[a]).paused||n.markedForDeletion||n.target.update(e);for(a=0,i=(t=this._updatesPosList).length;a<i;a++)(n=t[a]).paused||n.markedForDeletion||n.target.update(e);for(var o=this._arrayForTimers,a=0;a<o.length;a++){if(r=o[a],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(e),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--a)}for(a=0,t=this._updatesNegList;a<t.length;)(n=t[a]).markedForDeletion?this._removeUpdateFromHash(n):a++;for(a=0,t=this._updates0List;a<t.length;)(n=t[a]).markedForDeletion?this._removeUpdateFromHash(n):a++;for(a=0,t=this._updatesPosList;a<t.length;)(n=t[a]).markedForDeletion?this._removeUpdateFromHash(n):a++;this._updateHashLocked=!1,this._currentTarget=null},R.schedule=function(e,t,i,n,r,o){"function"!=typeof e&&(a=e,e=t,t=a),3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!n,n=j.macro.REPEAT_FOREVER,r=0),re(t,1502);var a=t.uuid||t.id;if(a){var s,c,l=this._hashForTimers[a];if(l?l.paused!==o&&J(1511):(l=OP.get(null,t,0,null,null,o),this._arrayForTimers.push(l),this._hashForTimers[a]=l),null==l.timers)l.timers=[];else for(c=0;c<l.timers.length;++c)if((s=l.timers[c])&&e===s._callback)return ne(1507,s.getInterval(),i),void(s._interval=i);(s=NP.get()).initWithCallback(this,e,t,i,n,r),l.timers.push(s),this._currentTarget===l&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else ee(1510)},R.scheduleUpdate=function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return ne(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var o,r=RP.get(e,t,i,!1);0===t?(o=this._updates0List,this._appendIn(o,r)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,r,t)),this._hashForUpdates[n]=DP.get(o,r,e,null)}else ee(1510)},R.unschedule=function(e,t){if(t&&e){t=t.uuid||t.id;if(t){var i=this._hashForTimers[t];if(i)for(var n=i.timers,r=0,o=n.length;r<o;r++){var a=n[r];if(e===a._callback)return a!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),n.splice(r,1),NP.put(a),i.timerIndex>=r&&i.timerIndex--,void(0===n.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else ee(1510)}},R.unscheduleUpdate=function(e){e&&((e=e.uuid||e.id)?(e=this._hashForUpdates[e])&&(this._updateHashLocked?e.entry.markedForDeletion=!0:this._removeUpdateFromHash(e.entry)):ee(1510))},R.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){t=this._hashForTimers[t];if(t){var i=t.timers;-1<i.indexOf(t.currentTimer)&&!t.currentTimerSalvaged&&(t.currentTimerSalvaged=!0);for(var n=0,r=i.length;n<r;n++)NP.put(i[n]);i.length=0,this._currentTarget===t?this._currentTargetSalvaged=!0:this._removeHashElement(t)}this.unscheduleUpdate(e)}else ee(1510)}},R.unscheduleAll=function(){this.unscheduleAllWithMinPriority(PP.Priority.SCHEDULER)},R.unscheduleAllWithMinPriority=function(e){for(var t,i,n=this._arrayForTimers,r=n.length-1;0<=r;r--)t=n[r],this.unscheduleAllForTarget(t.target);var o=0;if(e<0)for(r=0;r<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[r])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&r++;if(e<=0)for(r=0;r<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[r])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&r++;for(r=0;r<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[r])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&r++},R.isScheduled=function(e,t){re(e,1508),re(t,1509);t=t.uuid||t.id;if(!t)return ee(1510),!1;t=this._hashForTimers[t];if(!t)return!1;if(null==t.timers)return!1;for(var i=t.timers,n=0;n<i.length;++n)if(e===i[n]._callback)return!0;return!1},R.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(PP.Priority.SCHEDULER)},R.pauseAllTargetsWithMinPriority=function(e){for(var t,i,n=[],r=this._arrayForTimers,o=0,a=r.length;o<a;o++)(t=r[o])&&(t.paused=!0,n.push(t.target));if(e<0)for(o=0;o<this._updatesNegList.length;o++)(i=this._updatesNegList[o])&&i.priority>=e&&(i.paused=!0,n.push(i.target));if(e<=0)for(o=0;o<this._updates0List.length;o++)(i=this._updates0List[o])&&(i.paused=!0,n.push(i.target));for(o=0;o<this._updatesPosList.length;o++)(i=this._updatesPosList[o])&&i.priority>=e&&(i.paused=!0,n.push(i.target));return n},R.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},R.pauseTarget=function(e){re(e,1503);var t,e=e.uuid||e.id;e?((t=this._hashForTimers[e])&&(t.paused=!0),(t=this._hashForUpdates[e])&&(t.entry.paused=!0)):ee(1510)},R.resumeTarget=function(e){re(e,1504);var t,e=e.uuid||e.id;e?((t=this._hashForTimers[e])&&(t.paused=!1),(t=this._hashForUpdates[e])&&(t.entry.paused=!1)):ee(1510)},R.isTargetPaused=function(e){re(e,1505);e=e.uuid||e.id;if(!e)return ee(1510),!1;var t=this._hashForTimers[e];if(t)return t.paused;t=this._hashForUpdates[e];return!!t&&t.entry.paused},R._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}OP.put(e)},R._removeUpdateFromHash=function(e){var e=e.target.uuid||e.target.id,t=this._hashForUpdates[e];if(t){for(var i=t.list,n=t.entry,r=0,o=i.length;r<o;r++)if(i[r]===n){i.splice(r,1);break}delete this._hashForUpdates[e],RP.put(n),DP.put(t)}},R._priorityIn=function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)},R._appendIn=function(e,t){e.push(t)},zP));function zP(){var e;return(e=BP.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=Ge(!0),e._hashForTimers=Ge(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}FP.ID="scheduler",j.Scheduler=FP;(g={})[X_.PORTRAIT]=Ao.IDENTITY,g[X_.LANDSCAPE_RIGHT]=Ao.ROTATE_90,g[X_.PORTRAIT_UPSIDE_DOWN]=Ao.ROTATE_180,g[X_.LANDSCAPE_LEFT]=Ao.ROTATE_270;var UP=g,kP=(VP.registerCreateFunc=function(e){e._createWindowFun=function(e){return new VP}},(t=VP.prototype).initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var i=0;i<t.renderPassInfo.colorAttachments.length;i++)this._colorTextures.push(e.createTexture(new Na(Lo.TEX2D,Bo.COLOR_ATTACHMENT|Bo.SAMPLED|Bo.TRANSFER_SRC,t.renderPassInfo.colorAttachments[i].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==W.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Na(Lo.TEX2D,Bo.DEPTH_STENCIL_ATTACHMENT|Bo.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new ts(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,UP[ef.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new ts(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var n,r=ge(this._cameras);!(n=r()).done;)n.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];i.enabled&&(i.update(),e.push(i))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort(function(e,t){return e.priority-t.priority})},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},e(VP,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),VP),GP=((o=HP.prototype)._init=function(){},o._destroy=function(){},o._setCumulativeTime=function(e){this._cumulativeTime+=e},o._setFrameTime=function(e){this._frameTime=e},o.initialize=function(){this._init();var e=j.game._swapchain,t=new Ya,i=(t.format=e.colorTexture.format,new Ka),t=(i.format=e.depthStencilTexture.format,i.depthStoreOp=Ko.DISCARD,i.stencilStoreOp=Ko.DISCARD,new Ja([t],i));return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:t,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(D0.initBuiltinRes(this._device))},o.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},o.resize=function(e,t){for(var i=ge(this._windows);!(n=i()).done;){var n=n.value;n.swapchain&&n.resize(e,t)}},o.setRenderPipeline=function(e){e instanceof xP&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=CP(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(Po.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;e=j.director.getScene();return e&&e.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&j.internal.Batcher2D&&(this._batcher=new j.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},o.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},o.activeWindow=function(e){this._curWindow=e},o.resetCumulativeTime=function(){this._setCumulativeTime(0)},o.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var i=this._windows,n=[],r=0;r<i.length;r++)i[r].extractRenderCameras(n);if(this._pipeline&&0<n.length){this._device.acquire([j.game._swapchain]);var o=this._scenes,a=j.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);j.director.emit(j.Director.EVENT_BEFORE_COMMIT),n.sort(function(e,t){return e.priority-t.priority}),this._pipeline.render(n),this._device.present()}this._batcher&&this._batcher.reset()},o.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},o.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},o.destroyWindows=function(){for(var e,t=ge(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},o.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},o.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},o.destroyScenes=function(){for(var e,t=ge(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},o.createModel=function(e){var t=this._modelPools.get(e),t=(t||(this._modelPools.set(e,new Tt(function(){return new e},10,function(e){return e.destroy()})),t=this._modelPools.get(e)),t.alloc());return t.initialize(),t},o.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):J(1300,e.constructor.name),e.destroy()},o.createCamera=function(){return this._cameraPool.alloc()},o.createLight=function(e){var t=this._lightPools.get(e),t=(t||(this._lightPools.set(e,new Tt(function(){return new e},4,function(e){return e.destroy()})),t=this._lightPools.get(e)),t.alloc());return t.initialize(),t},o.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Dy.SPHERE:e.scene.removeSphereLight(e);break;case Dy.SPOT:e.scene.removeSpotLight(e)}e.destroy()},e(HP,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){0<e?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),HP);function HP(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=j.internal.DataPoolManager&&new j.internal.DataPoolManager(e),ay.registerCreateFunc(this),kP.registerCreateFunc(this),this._cameraPool=new Tt(function(){return new Tv(t._device)},4,function(e){return e.destroy()})}function VP(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}j.Root=GP;var jP,WP=Rre("Game",(l(qP,jP=Ki),(n=qP.prototype).setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){j.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(Dw._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var t=this;return new Promise(function(e){return j.director.once(j.Director.EVENT_END_FRAME,function(){return e()})}).then(function(){for(var e in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[e]);return j.director.getScene().destroy(),j.Object._deferredDestroy(),j.director.reset(),j.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then(function(){t.resume(),t._safeEmit(qP.EVENT_RESTART)})})},n.end=function(){Qi.close()},n.on=function(e,t,i,n){return(this._engineInited&&e===qP.EVENT_ENGINE_INITED||this._inited&&e===qP.EVENT_GAME_INITED||this._rendererInitialized&&e===qP.EVENT_RENDERER_INITED)&&t.call(i),this.eventTargetOn(e,t,i,n)},n.once=function(e,t,i){return this._engineInited&&e===qP.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)},n.init=function(e){var t=this;if(this._initConfig(e),nf._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&j.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,n=0;n<i.length;n++){var r=i[n],o=mn(r.value);Tg.addLayer(r.name,o)}return this._initEngine().then(function(){return t._initEvents(),j.director.root&&j.director.root.dataPoolManager&&j.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited})},n.run=function(e,t){var i,n=this;return"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,A_.init(),Promise.resolve(i).then(function(){return n._setRenderPipelineNShowSplash()}).then(function(){})},n.addPersistRootNode=function(e){if(j.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=j.director._scene;if(j.isValid(i))if(e.parent){if(!(e.parent instanceof j.Scene))return void J(3801);if(e.parent!==i)return void J(3802);e._originalSceneId=i.uuid}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0,j.assetManager._releaseManager._addPersistNodeRef(e)}}else J(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",j.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},n._initEngine=function(){var t=this,e=(this._initDevice(),j.director);return Promise.resolve(e._init()).then(function(){j.view.init(),H("Cocos Creator v"+O),t.emit(qP.EVENT_ENGINE_INITED),t._engineInited=!0,j.internal.dynamicAtlasManager&&(j.internal.dynamicAtlasManager.enabled=!zt.CLEANUP_IMAGE_CACHE)}).then(function(){var e=t._onEngineInitedCallback.map(function(e){return e()}).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)})},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),t=Math.max(0,t-this._startTime),t=Math.max(0,this.frameTime-t);return window.setTimeout(e,t)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e=e||performance.now(),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>qP.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var t,e,i=this,n=j.director;e=30===this._frameRate?(t=!0,function(e){i._intervalId=window.rAF(i._frameCB),(t=!t)||n.tick(i._calculateDT(e))}):function(e){n.tick(i._calculateDT(e)),i._intervalId=window.rAF(i._frameCB)},this._frameCB=e},n._runMainLoop=function(){var e,t;this._inited&&(e=this.config,t=j.director,se(!!e.showFPS),t.startAnimation(),this.resume())},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=te.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||3<t||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,X(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,e=parseInt(e.renderMode,10),t=(this.renderType=qP.RENDER_TYPE_CANVAS,!1);if(1===e?(this.renderType=qP.RENDER_TYPE_CANVAS,t=!0):0===e||2===e?(this.renderType=qP.RENDER_TYPE_WEBGL,t=!0):3===e&&(this.renderType=qP.RENDER_TYPE_HEADLESS,t=!0),!t)throw new Error(oe(3820,e))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===qP.RENDER_TYPE_WEBGL){var t=new Pa(Wg),e=!!window.WebGL2RenderingContext,i=window.navigator.userAgent.toLowerCase(),n=[];(e=-1!==i.indexOf("safari")&&-1===i.indexOf("chrome")||af.browserType===Hi.UC?!1:e)&&j.WebGL2Device&&n.push(j.WebGL2Device),j.WebGLDevice&&n.push(j.WebGLDevice),j.EmptyDevice&&n.push(j.EmptyDevice),Ic.canvas=this.canvas;for(var r=0;r<n.length&&(this._gfxDevice=new n[r],!this._gfxDevice.initialize(t));r++);}else this.renderType===qP.RENDER_TYPE_HEADLESS&&j.EmptyDevice&&(this._gfxDevice=new j.EmptyDevice,this._gfxDevice.initialize(new Pa(Wg)));if(!this._gfxDevice)return tt("can not support canvas rendering in 3D"),void(this.renderType=qP.RENDER_TYPE_CANVAS);i=new Aa(this.canvas),e=nf.windowSize;i.width=e.width,i.height=e.height,this._swapchain=this._gfxDevice.createSwapchain(i),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){Qi.on("show",this._onShow,this),Qi.on("hide",this._onHide,this)},n._onHide=function(){this.emit(qP.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(qP.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then(function(){return Promise.resolve(e._showSplashScreen()).then(function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(qP.EVENT_GAME_INITED),e.onStart&&e.onStart()})})},n._setupRenderPipeline=function(){var t=this,r=this.config.renderPipeline;return r?new Promise(function(i,n){j.assetManager.loadAny(r,function(e,t){return!e&&t instanceof SS?i(t):n(e)})}).then(function(e){t._setRenderPipeline(e)}).catch(function(e){V(e),V("Failed load render pipeline: "+r+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()}):this._setRenderPipeline()},n._showSplashScreen=function(){var t;return j.internal.SplashScreen?((t=j.internal.SplashScreen.instance).main(j.director.root),new Promise(function(e){t.setOnFinish(function(){return e()}),t.loadFinish=!0})):null},n._setRenderPipeline=function(e){j.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(qP.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},e(qP,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),qP));function qP(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=jP.call.apply(jP,[this].concat(i))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=jP.prototype.on,e.eventTargetOnce=jP.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}WP.EVENT_HIDE="game_on_hide",WP.EVENT_SHOW="game_on_show",WP.EVENT_LOW_MEMORY="game_on_low_memory",WP.EVENT_GAME_INITED="game_inited",WP.EVENT_ENGINE_INITED="engine_inited",WP.EVENT_RENDERER_INITED="renderer_inited",WP.EVENT_RESTART="game_on_restart",WP.RENDER_TYPE_CANVAS=0,WP.RENDER_TYPE_WEBGL=1,WP.RENDER_TYPE_OPENGL=2,WP.RENDER_TYPE_HEADLESS=3,WP.DEBUG_DT_THRESHOLD=1,j.Game=WP;var XP,YP=Rre("game",j.game=new WP),KP=Rre("Director",(l(QP,XP=Ki),(I=QP.prototype).calculateDeltaTime=function(){},I.end=function(){var e=this;this.once(QP.EVENT_END_FRAME,function(){e.purgeDirector()})},I.pause=function(){this._paused||(this._paused=!0)},I.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),j.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),j.assetManager.releaseAll()},I.reset=function(){this.purgeDirector(),this.emit(QP.EVENT_RESET),this.startAnimation()},I.runSceneImmediate=function(e,t,i){re((e=e instanceof wA?e.scene:e)instanceof Vw,1216),e._load();for(var n=Object.keys(YP._persistRootNodes).map(function(e){return YP._persistRootNodes[e]}),r=0;r<n.length;r++){var o,a=n[r],s=(a.emit(j.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene),e.uuid===a._originalSceneId&&e.getChildByUuid(a.uuid));s?(o=s.getSiblingIndex(),s._destroyImmediate(),e.insertChild(a,o)):a.parent=e}var c=this._scene;j.isValid(c)&&c.destroy(),j.assetManager._releaseManager._autoRelease(c,e,YP._persistRootNodes),this._scene=null,Pi._deferredDestroy(),t&&t(),this.emit(j.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(j.Director.EVENT_AFTER_SCENE_LAUNCH,e)},I.runScene=function(e,t,i){var n=this;re(e=e instanceof wA?e.scene:e,1205),re(e instanceof Vw,1216),e._load(),this.once(j.Director.EVENT_END_FRAME,function(){n.runSceneImmediate(e,t,i)})},I.loadScene=function(i,n,r){var o=this;if(this._loadingScene)return J(1208,i,this._loadingScene),!1;var e=j.assetManager.bundles.find(function(e){return!!e.getSceneInfo(i)});return e?(this.emit(j.Director.EVENT_BEFORE_SCENE_LOADING,i),this._loadingScene=i,console.time("LoadScene "+i),e.loadScene(i,function(e,t){console.timeEnd("LoadScene "+i),o._loadingScene="",e?(tt(e),n&&n(e)):o.runSceneImmediate(t,r,n)}),!0):(ee(1209,i),!1)},I.preloadScene=function(t,e,i){var n=j.assetManager.bundles.find(function(e){return!!e.getSceneInfo(t)});n?n.preloadScene(t,null,e,i):(n='Can not preload the scene "'+t+'" because it is not in the build settings.',i&&i(new Error(n)),tt("preloadScene: "+n))},I.resume=function(){this._paused&&(this._paused=!1)},I.getScene=function(){return this._scene},I.getDeltaTime=function(){return YP.deltaTime},I.getTotalTime=function(){return YP.totalTime},I.getCurrentTime=function(){return YP.frameStartTime},I.getTotalFrames=function(){return this._totalFrames},I.isPaused=function(){return this._paused},I.getScheduler=function(){return this._scheduler},I.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(FP.ID,e,200))},I.registerSystem=function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(PP.sortByPriority)},I.unregisterSystem=function(e){mt.fastRemove(this._systems,e),this._systems.sort(PP.sortByPriority)},I.getSystem=function(t){return this._systems.find(function(e){return e.id===t})},I.getAnimationManager=function(){return this.getSystem(j.AnimationManager.ID)},I.startAnimation=function(){this._invalid=!1},I.stopAnimation=function(){this._invalid=!0},I.mainLoop=function(e){e=YP._calculateDT(e);this.tick(e)},I.tick=function(e){if(!this._invalid){if(this.emit(QP.EVENT_BEGIN_FRAME),Dw._frameDispatchEvents(),!this._paused){this.emit(QP.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(QP.EVENT_AFTER_UPDATE),Pi._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(QP.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(QP.EVENT_AFTER_DRAW),N1.resetHasChangedFlags(),N1.clearNodeArray(),bt.update(e),this.emit(QP.EVENT_END_FRAME),this._totalFrames++}},I._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(FP.ID,this._scheduler,200),this.emit(QP.EVENT_INIT)},I._init=function(){return this._root=new GP(YP._gfxDevice),this._root.initialize({}).catch(function(e){return ee(1217),Promise.reject(e)})},e(QP,[{key:"root",get:function(){return this._root}}]),QP));function QP(){var e;return(e=XP.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new FP,e._compScheduler=new hA,e._nodeActivator=new CA,e._systems=[],YP.once(WP.EVENT_RENDERER_INITED,e._initOnRendererInitialized,p(e)),e}KP.EVENT_INIT="director_init",KP.EVENT_RESET="director_reset",KP.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",KP.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",KP.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",KP.EVENT_BEFORE_UPDATE="director_before_update",KP.EVENT_AFTER_UPDATE="director_after_update",KP.EVENT_BEFORE_DRAW="director_before_draw",KP.EVENT_AFTER_DRAW="director_after_draw",KP.EVENT_BEFORE_COMMIT="director_before_commit",KP.EVENT_BEFORE_PHYSICS="director_before_physics",KP.EVENT_AFTER_PHYSICS="director_after_physics",KP.EVENT_BEGIN_FRAME="director_begin_frame",KP.EVENT_END_FRAME="director_end_frame",KP.instance=void 0,j.Director=KP;var ZP=Rre("director",KP.instance=j.director=new KP),c={};In(c,"vmath",[{name:"vec2",newName:"Vec2",target:pi,targetName:"math"},{name:"vec3",newName:"Vec3",target:pi,targetName:"math"},{name:"vec4",newName:"Vec4",target:pi,targetName:"math"},{name:"quat",newName:"Quat",target:pi,targetName:"math"},{name:"mat3",newName:"Mat3",target:pi,targetName:"math"},{name:"mat4",newName:"Mat4",target:pi,targetName:"math"},{name:"color4",newName:"Color",target:pi,targetName:"math"},{name:"rect",newName:"Rect",target:pi,targetName:"math"},{name:"approx",newName:"approx",target:pi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:pi,targetName:"math"},{name:"equals",newName:"equals",target:pi,targetName:"math"},{name:"clamp",newName:"clamp",target:pi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:pi,targetName:"math"},{name:"lerp",newName:"lerp",target:pi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:pi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:pi,targetName:"math"},{name:"random",newName:"random",target:pi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:pi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:pi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:pi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:pi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:pi,targetName:"math"},{name:"repeat",newName:"repeat",target:pi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:pi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:pi,targetName:"math"}]),j.vmath=c,In(FP.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:FP,targetName:"Scheduler"}]),In(FP,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return PP.Priority.SCHEDULER}}]),Ee(FP,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),In(W0.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Ee(W0.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),In(GP.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),D(YP,"game",[{name:"collisionMatrix"},{name:"groupList"}]),D(KP.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),Ee(KP.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var JP,$P={topLeft:j.v2(0,0),topRight:j.v2(0,0),top:j.v2(0,0),bottomLeft:j.v2(0,0),bottomRight:j.v2(0,0),bottom:j.v2(0,0),center:j.v2(0,0),left:j.v2(0,0),right:j.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,e=e.y,r=e+i,o=n+t;this.topLeft.x=n,this.topLeft.y=r,this.topRight.x=o,this.topRight.y=r,this.top.x=n+t/2,this.top.y=r,this.bottomLeft.x=n,this.bottomLeft.y=e,this.bottomRight.x=o,this.bottomRight.y=e,this.bottom.x=n+t/2,this.bottom.y=e,this.center.x=n+t/2,this.center.y=e+i/2,this.left.x=n,this.left.y=e+i/2,this.right.x=o,this.right.y=e+i/2}},eI=(j.visibleRect=$P,new Hr),tI=((vie={})[zt.ORIENTATION_AUTO]=X_.AUTO,vie[zt.ORIENTATION_LANDSCAPE]=X_.LANDSCAPE,vie[zt.ORIENTATION_PORTRAIT]=X_.PORTRAIT,vie),iI=Rre("View",(l(nI,JP=Ki),(b=nI.prototype).init=function(){var e=nf.windowSize,t=e.width,e=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=e,this._viewportRect.width=t,this._viewportRect.height=e,this._visibleRect.width=t,this._visibleRect.height=e,eI.width=this._visibleRect.width,eI.height=this._visibleRect.height,$P&&$P.init(this._visibleRect),ef.on("window-resize",this._updateAdaptResult,this),ef.on("orientation-change",this._updateAdaptResult,this),ef.on("fullscreen-change",this._updateAdaptResult,this)},b.resizeWithBrowserSize=function(e){ef.handleResizeEvent=e},b.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},b.setOrientation=function(e){ef.orientation=tI[e]},b.adjustViewportMeta=function(){},b.enableRetina=function(e){this._retinaEnabled=!!e},b.isRetinaEnabled=function(){return this._retinaEnabled},b.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&((this._autoFullScreen=e)&&nf.requestFullScreen().catch(function(){}))},b.isAutoFullScreenEnabled=function(){return this._autoFullScreen},b.setCanvasSize=function(e,t){ef.resolutionScale=1;var i=ef.devicePixelRatio,e=new Hr(e*i,t*i);nf.windowSize=e},b.getCanvasSize=function(){return nf.windowSize},b.getFrameSize=function(){var e=ef.devicePixelRatio,t=nf.windowSize;return t.width/=e,t.height/=e,t},b.setFrameSize=function(e,t){var i=ef.devicePixelRatio;nf.windowSize=new Hr(e*i,t*i)},b.getVisibleSize=function(){return new Hr(this._visibleRect.width,this._visibleRect.height)},b.getVisibleSizeInPixel=function(){return new Hr(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},b.getVisibleOrigin=function(){return new U(this._visibleRect.x,this._visibleRect.y)},b.getVisibleOriginInPixel=function(){return new U(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},b.getResolutionPolicy=function(){return this._resolutionPolicy},b._updateResolutionPolicy=function(e){var t;e instanceof CI?this._resolutionPolicy=e:(e===(t=CI).EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth))},b.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=AI.getDesignResolutionSize();AI.setDesignResolutionSize(t.width,t.height,e)},b.setDesignResolutionSize=function(e,t,i){var n;0<e&&0<t?(this._updateResolutionPolicy(i),(i=this._resolutionPolicy)&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t,(e=i.apply(this,this._designResolutionSize)).scale&&2===e.scale.length&&(this._scaleX=e.scale[0],this._scaleY=e.scale[1]),e.viewport&&(t=this._viewportRect,n=this._visibleRect,e=e.viewport,t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,n.x=0,n.y=0,n.width=e.width/this._scaleX,n.height=e.height/this._scaleY),i.postApply(this),eI.width=this._visibleRect.width,eI.height=this._visibleRect.height,$P&&$P.init(this._visibleRect),this.emit("design-resolution-changed")):ee(2200)},b.getDesignResolutionSize=function(){return new Hr(this._designResolutionSize.width,this._designResolutionSize.height)},b.setRealPixelResolution=function(e,t,i){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,i)},b.getViewportRect=function(){return this._viewportRect},b.getScaleX=function(){return this._scaleX},b.getScaleY=function(){return this._scaleY},b.getDevicePixelRatio=function(){return ef.devicePixelRatio},b.convertToLocationInView=function(e,t,i,n){void 0===n&&(n=new U);e=ef.devicePixelRatio*(e-i.left),i=ef.devicePixelRatio*(i.top+i.height-t);return ef.isFrameRotated?(n.x=nf.windowSize.width-i,n.y=e):(n.x=e,n.y=i),n},b._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},b._updateAdaptResult=function(){j.director.root.resize(nf.windowSize.width,nf.windowSize.height);var e=this._designResolutionSize.width,t=this._designResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy),this.emit("canvas-resize"),null!=(e=this._resizeCallback)&&e.call(this)},nI));function nI(){(e=JP.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var e,t=rI,i=aI;return e._designResolutionSize=new Hr(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new qr(0,0,0,0),e._visibleRect=new qr(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new CI(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new CI(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new CI(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new CI(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new CI(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}iI.instance=void 0;(E2=oI.prototype).preApply=function(){},E2.apply=function(){},E2.postApply=function(){},E2._setupCanvas=function(){var e,t=YP.canvas;t&&(e=nf.windowSize,t.width=e.width,t.height=e.height)};var rI=oI;function oI(){this.name="ContainerStrategy"}rI.EQUAL_TO_FRAME=void 0,rI.PROPORTION_TO_FRAME=void 0;(xH=sI.prototype).preApply=function(){},xH.apply=function(){return{scale:[1,1]}},xH.postApply=function(){},xH._buildResult=function(e,t,i,n,r,o){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);e=new qr(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,o],this._result.viewport=e,this._result};var aI=sI;function sI(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}aI.EXACT_FIT=void 0,aI.SHOW_ALL=void 0,aI.NO_BORDER=void 0,aI.FIXED_HEIGHT=void 0,aI.FIXED_WIDTH=void 0,l(pI,lI=rI),pI.prototype.apply=function(){ef.isProportionalToFrame=!1,this._setupCanvas()};var cI,lI,uI=pI,E=(l(hI,cI=rI),hI.prototype.apply=function(){ef.isProportionalToFrame=!0,this._setupCanvas()},hI);function hI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=cI.call.apply(cI,[this].concat(i))||this).name="ProportionalToFrame",e}function pI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=lI.call.apply(lI,[this].concat(i))||this).name="EqualToFrame",e}rI.EQUAL_TO_FRAME=new uI,rI.PROPORTION_TO_FRAME=new E,l(EI,gI=aI),EI.prototype.apply=function(e,t){var i=nf.windowSize,n=i.width,i=i.height,r=n/t.width,t=i/t.height;return this._buildResult(n,i,n,i,r,t)};var _I,fI,dI,mI,gI,uI=EI,E=(l(TI,mI=aI),TI.prototype.apply=function(e,t){var i,n=nf.windowSize,r=n.width,n=n.height,o=t.width,t=t.height,a=r/o,s=n/t,c=0,t=a<s?(i=r,t*(c=a)):(i=o*(c=s),n);return this._buildResult(r,n,i,t,c,c)},TI),vI=(l(bI,dI=aI),bI.prototype.apply=function(e,t){var i,n,r=nf.windowSize,o=r.width,r=r.height,a=t.width,t=t.height,s=o/a,c=r/t,a=s<c?(n=a*(i=c),r):(n=o,t*(i=s));return this._buildResult(o,r,n,a,i,i)},bI),yI=(l(SI,fI=aI),SI.prototype.apply=function(e,t){var i=nf.windowSize,n=i.width,i=i.height,t=i/t.height;return this._buildResult(n,i,n,i,t,t)},SI),C=(l(xI,_I=aI),xI.prototype.apply=function(e,t){var i=nf.windowSize,n=i.width,i=i.height,t=n/t.width;return this._buildResult(n,i,n,i,t,t)},xI);function xI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=_I.call.apply(_I,[this].concat(i))||this).name="FixedWidth",e}function SI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=fI.call.apply(fI,[this].concat(i))||this).name="FixedHeight",e}function bI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=dI.call.apply(dI,[this].concat(i))||this).name="NoBorder",e}function TI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=mI.call.apply(mI,[this].concat(i))||this).name="ShowAll",e}function EI(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=gI.call.apply(gI,[this].concat(i))||this).name="ExactFit",e}aI.EXACT_FIT=new uI,aI.SHOW_ALL=new E,aI.NO_BORDER=new vI,aI.FIXED_HEIGHT=new yI,aI.FIXED_WIDTH=new C;var CI=Rre("ResolutionPolicy",((C7=wI.prototype).preApply=function(e){this._contentStrategy.preApply(e)},C7.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},C7.postApply=function(e){this._contentStrategy.postApply(e)},C7.setContainerStrategy=function(e){e instanceof rI&&(this._containerStrategy=e)},C7.setContentStrategy=function(e){e instanceof aI&&(this._contentStrategy=e)},e(wI,[{key:"canvasSize",get:function(){return nf.windowSize}}]),wI));function wI(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}CI.EXACT_FIT=0,CI.NO_BORDER=1,CI.SHOW_ALL=2,CI.FIXED_HEIGHT=3,CI.FIXED_WIDTH=4,CI.UNKNOWN=5,CI.ContainerStrategy=rI,CI.ContentStrategy=aI,j.ResolutionPolicy=CI;var AI=Rre("view",iI.instance=j.view=new iI),PI=(j.winSize=eI,Ee(iI.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),D(iI.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),D(j,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),D(af,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),In(af,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map(function(e){return{name:"LANGUAGE_"+e,newName:e,target:af.Language,targetName:"sys.Language"}})),In(af,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map(function(e){return{name:"OS_"+e,newName:e,target:af.OS,targetName:"sys.OS"}})),In(af,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map(function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:af.BrowserType,targetName:"sys.BrowserType"}})),In(af,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:af.BrowserType,targetName:"sys.BrowserType"}]),In(af,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map(function(e){return{name:e,target:af.Platform,targetName:"sys.Platform"}})),In(af,"sys",[{name:"IPHONE",newName:"IOS",target:af.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:af.Platform,targetName:"sys.Platform"}]),Ee(af,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map(function(e){return{name:e}})),In(af,"sys",[{name:"windowPixelResolution",target:nf,targetName:"screen",newName:"windowSize"}]),D(nf,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]),(Nk=II.prototype).init=function(e){var t,i=this,n=e,r=n.uuids,o=n.paths,a=n.types,s=n.deps,c=n.paths=Object.create(null);if(!1===n.debug){for(var l,u=0,h=r.length;u<h;u++)r[u]=m_(r[u]);for(l in o){var p=o[l],_=p[1];p[1]=a[_]}}else{for(var f=Object.create(null),d=0,m=r.length;d<m;d++){var g=r[d];r[d]=f[g]=m_(g)}r=f}for(t in o){var v=o[t];c[r[t]]=v}var y,x=n.scenes;for(y in x){var S=x[y];x[y]=r[S]}var b,T=n.packs;for(b in T)for(var E=T[b],C=0;C<E.length;++C)E[C]=r[E[C]];var w=n.versions;if(w)for(var A in w)for(var P=w[A],I=0;I<P.length;I+=2){var R=P[I];P[I]=r[R]||R}var D=n.redirect;if(D)for(var O=0;O<D.length;O+=2)D[O]=r[D[O]],D[O+1]=s[D[O+1]];if(n.extensionMap)for(var M in n.extensionMap)!function(i){if(!Object.prototype.hasOwnProperty.call(n.extensionMap,i))return;n.extensionMap[i].forEach(function(e,t){n.extensionMap[i][t]=r[e]||e})}(M);this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);for(var N in e.extensionMap)!function(t){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,t))return;e.extensionMap[t].forEach(function(e){e=i.assetInfos.get(e);e&&(e.extension=t)})}(N)},Nk.getInfoWithPath=function(e,t){if(!e)return null;e=S_(e);var i=this.paths.get(e);if(i){if(!t)return i[0];for(var n=0,r=i.length;n<r;n++){var o=i[n];if(gt.isChildClassOf(o.ctor,t))return o}}return null},Nk.getDirWithPath=function(a,s,e){"/"===(a=S_(a))[a.length-1]&&(a=a.slice(0,-1));var c=e||[];return this.paths.forEach(function(e,t){if(t.startsWith(a)&&(o=a,!((t=t).length>o.length)||47===t.charCodeAt(o.length))||!a)for(var i=0,n=e.length;i<n;i++){var r=e[i];s&&!gt.isChildClassOf(r.ctor,s)||c.push(r)}var o}),c},Nk.getAssetInfo=function(e){return this.assetInfos.get(e)||null},Nk.getSceneInfo=function(i){return i.endsWith(".scene")||(i+=".scene"),"/"===i[0]||i.startsWith("db://")||(i="/"+i),this.scenes.find(function(e,t){return t.endsWith(i)})},Nk.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},Nk._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,i=e.length;t<i;t++){var n=e[t];this.assetInfos.add(n,{uuid:n})}}},Nk._initPath=function(e){if(e){var t,i=this.paths;for(t in i.clear(),e){var n=e[t],r=n[0],o=n[1],n=3===n.length,a=this.assetInfos.get(t);a.path=r,a.ctor=gt._getClassById(o),i.has(r)?n?i.get(r).push(a):i.get(r).unshift(a):i.add(r,[a])}}},Nk._initScene=function(e){if(e){var t,i=this.scenes,n=(i.clear(),this.assetInfos);for(t in e){var r=e[t],r=n.get(r);r.url=t,i.add(t,r)}}},Nk._initPackage=function(e){if(e){var t,i=this.assetInfos;for(t in e){var n=e[t],r={uuid:t,packedUuids:n,ext:".json"};i.add(t,r);for(var o=0,a=n.length;o<a;o++){var s=n[o],s=i.get(s),c=s.packs;c?1===a?c.unshift(r):c.push(r):s.packs=[r]}}}},Nk._initVersion=function(e){if(e){var t=this.assetInfos,i=e.import;if(i)for(var n=0,r=i.length;n<r;n+=2){var o=i[n];t.get(o).ver=i[n+1]}if(i=e.native)for(var a=0,s=i.length;a<s;a+=2){var c=i[a];t.get(c).nativeVer=i[a+1]}}},Nk._initRedirect=function(e){if(e)for(var t=this.assetInfos,i=0,n=e.length;i<n;i+=2){var r=e[i];t.get(r).redirect=e[i+1]}},II);function II(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Zp,this.scenes=new Zp,this.paths=new Zp}function RI(e,t){e._uuid&&t.push(e._uuid)}function DI(e,t){for(var i=0;i<e._components.length;i++){n=void 0;r=void 0;o=void 0;a=void 0;s=void 0;c=void 0;l=void 0;u=void 0;h=void 0;p=void 0;_=void 0;var n=e._components[i];var r=t;for(var o=Object.getOwnPropertyNames(n),a=0;a<o.length;a++){var s=o[a];if("node"!==s&&"__eventTargets"!==s){var c=n[s];if("object"==typeof c&&c)if(Array.isArray(c))for(var l=0;l<c.length;l++){var u=c[l];u instanceof P_&&RI(u,r)}else if(c.constructor&&c.constructor!==Object)c instanceof P_&&RI(c,r);else for(var h=Object.getOwnPropertyNames(c),p=0;p<h.length;p++){var _=c[h[p]];_ instanceof P_&&RI(_,r)}}}}for(var f=0;f<e._children.length;f++)DI(e._children[f],t)}function OI(e,t,i,n){i.push(e._uuid);for(var r=Wv.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s,c=i_.get(r[o]);c&&((s=c._uuid)in t?t[s]+=n:t[s]=c.refCount+n,i.includes(s)||OI(c,t,i,n))}}var MI=[],NI=((A=BI.prototype).init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},A._addPersistNodeRef=function(e){var t=[];DI(e,t);for(var i=0,n=t.length;i<n;i++){var r=i_.get(t[i]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},A._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),i=0,n=t.length;i<n;i++){var r=i_.get(t[i]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},A._autoRelease=function(e,t,i){if(e){for(var n=Wv.getDeps(e.uuid),r=0,o=n.length;r<o;r++){var a=i_.get(n[r]);a&&a.decRef(e.autoReleaseAssets)}var s=Wv._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=i_.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Wv.remove(e.uuid)}var p,_=Wv._depends.get(t.uuid);for(p in _&&(_.persistDeps=[]),i){for(var f,d=i[p],d=this._persistNodeDeps.get(d.uuid),m=ge(d);!(g=m()).done;){var g=g.value,g=i_.get(g);g&&g.addRef()}_&&(f=_.persistDeps).push.apply(f,d)}},A.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof P_&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,Yt(this._freeAssets.bind(this)))))},A._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach(function(e){t._free(e)}),this._toDelete.clear()},A._free=function(e,t){void 0===t&&(t=!1);var i=e._uuid;if(this._toDelete.remove(i),Ri(e,!0)&&!(!t&&0<e.refCount&&0<function(e){var t,i=Object.create(null);if(i[e._uuid]=e.refCount,OI(e,i,MI,-1),(MI.length=0)!==i[e._uuid])return i[e._uuid];for(t in i)0!==i[t]&&OI(i_.get(t),i,MI,1);return MI.length=0,i[e._uuid]}(e))){i_.remove(i);for(var n=Wv.getDeps(i),r=0,o=n.length;r<o;r++){var a=i_.get(n[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Wv.remove(i)}},new BI),LI=null;function BI(){this._persistNodeDeps=new Zp,this._toDelete=new Zp,this._eventListener=!1}function FI(e,t){for(var i=0,n=e.input.length;i<n;i++){var r=e.input[i];t&&!r.isNative&&r.content instanceof P_&&r.content.decRef(!1),r.recycle()}e.input=null}function zI(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function UI(e,t,i,n,r){try{for(var o=Wv.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in i||(i[c]=!0,n.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),n.push(ue({},o.nativeDep)))}catch(e){tt(e.message,e.stack)}}function kI(e,t,i){t&&(i=void 0!==i?i:j.assetManager.cacheAsset,x_(t)||!i||t.isDefault||i_.add(e,t))}function GI(e,t,i){var n=0,r=[],o=e.length;0===o&&i&&i(r);for(var a=function(e){e&&r.push(e),++n===o&&i&&i(r)},s=0;s<o;s++)t(e[s],a)}function HI(e,t,i){var n=e,r=t,o=i;return void 0===i&&(i="function"==typeof e,t?(o=t,i||(r=null)):void 0===t&&i&&(o=e,r=n=null),void 0!==t&&i&&(r=e,n=null)),{options:n||Object.create(null),onProgress:r,onComplete:o}}function VI(e,t,i){var n=e,r=t,o=i;return void 0===i&&(i=gt.isChildClassOf(e,P_),t?(o=t,i&&(r=null)):void 0!==t||i||(o=e,n=r=null),void 0===t||i||(r=e,n=null)),{type:n,onProgress:r||LI,onComplete:o}}function jI(n){return function(e,t){var i;n&&(i=[],Array.isArray(t)?t.forEach(function(e){return e instanceof P_&&i.push(e.addRef())}):t instanceof P_&&i.push(t.addRef()),Yt(function(){i.forEach(function(e){return e.decRef(!1)}),n(e,t)}))}}(yU=XI.prototype).getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},yU.getDirWithPath=function(e,t,i){return this._config.getDirWithPath(e,t,i)},yU.getAssetInfo=function(e){return this._config.getAssetInfo(e)},yU.getSceneInfo=function(e){return this._config.getSceneInfo(e)},yU.init=function(e){this._config.init(e),o_.add(e.name,this)},yU.load=function(e,t,i,n){t=VI(t,i,n),i=t.type,n=t.onProgress,t=t.onComplete,i={__requestType__:t_.PATH,type:i,bundle:this.name,__outputAsArray__:Array.isArray(e)};j.assetManager.loadAny(e,i,n,t)},yU.preload=function(e,t,i,n){t=VI(t,i,n),i=t.type,n=t.onProgress,t=t.onComplete;j.assetManager.preloadAny(e,{__requestType__:t_.PATH,type:i,bundle:this.name},n,t)},yU.loadDir=function(e,t,i,n){t=VI(t,i,n),i=t.type,n=t.onProgress,t=t.onComplete;j.assetManager.loadAny(e,{__requestType__:t_.DIR,type:i,bundle:this.name,__outputAsArray__:!0},n,t)},yU.preloadDir=function(e,t,i,n){t=VI(t,i,n),i=t.type,n=t.onProgress,t=t.onComplete;j.assetManager.preloadAny(e,{__requestType__:t_.DIR,type:i,bundle:this.name},n,t)},yU.loadScene=function(e,t,i,n){var t=HI(t,i,n),i=t.options,n=t.onProgress,r=t.onComplete;i.preset=i.preset||"scene",i.bundle=this.name,j.assetManager.loadAny({scene:e},i,n,function(e,t){var i;e?tt(e.message,e.stack):t instanceof wA&&t.scene?((i=t.scene)._id=t._uuid,i.name=t.name):e=new Error("The asset "+t._uuid+" is not a scene"),r&&r(e,t)})},yU.preloadScene=function(t,e,i,n){var e=HI(e,i,n),i=e.options,n=e.onProgress,r=e.onComplete;i.bundle=this.name,j.assetManager.preloadAny({scene:t},i,n,function(e){e&&ee(1210,t,e.message),r&&r(e)})},yU.get=function(e,t){e=this.getInfoWithPath(e,t);return e&&i_.get(e.uuid)||null},yU.release=function(e,t){e=this.get(e,t);e&&NI.tryRelease(e,!0)},yU.releaseUnusedAssets=function(){var i=this;i_.forEach(function(e){var t=i.getAssetInfo(e._uuid);t&&!t.redirect&&NI.tryRelease(e)})},yU.releaseAll=function(){var i=this;i_.forEach(function(e){var t=i.getAssetInfo(e._uuid);t&&!t.redirect&&NI.tryRelease(e,!0)})},yU._destroy=function(){this._config.destroy()},e(XI,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]);var WI=XI,qI=Rre("resources",new WI);function XI(){this._config=new PI}function YI(e,t,i){var n=new Image;function r(){n.removeEventListener("load",r),n.removeEventListener("error",o),i&&i(null,n)}function o(){n.removeEventListener("load",r),n.removeEventListener("error",o),i&&i(new Error(oe(4930,e)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",r),n.addEventListener("error",o),n.src=e,n}function KI(e,t,i,n){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?n&&n(null,r.response):n&&n(new Error(o+r.status+"(no response)"))},i&&(r.onprogress=function(e){e.lengthComputable&&i(e.loaded,e.total)}),r.onerror=function(){n&&n(new Error(o+r.status+"(error)"))},r.ontimeout=function(){n&&n(new Error(o+r.status+"(time out)"))},r.onabort=function(){n&&n(new Error(o+r.status+"(abort)"))},r.send(null),r}j.resources=qI;var QI={};function ZI(e,t,i){if(QI[e])return i&&i(null),null;var n=document.createElement("script");function r(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",o,!1),QI[e]=!0,i&&i(null)}function o(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",o,!1),i&&i(new Error(oe(4928,e)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=t.scriptAsyncLoading||!1,n.src=e,n.addEventListener("load",r,!1),n.addEventListener("error",o,!1),document.body.appendChild(n),n}function JI(e,t,i){(af.hasFeature(af.Feature.IMAGE_BITMAP)&&j.assetManager.allowImageBitmap?rR:YI)(e,t,i)}function $I(o,e,i){oR(o,e,function(r,e){var t;r?i(r):(t=hf(e),Promise.all(t.chunks.map(function(e){return new Promise(function(i,n){aR(""+rn(o)+e,{},function(e,t){r?n(r):i(new Uint8Array(t))})})})).then(function(e){e=new lf(t.document,e);i(null,e)}).catch(function(e){i(e)}))})}function eR(e,t,n){aR(e,t,function(e,t){if(e)n(e);else try{var i=pf(new Uint8Array(t));n(null,i)}catch(e){n(e)}})}function tR(e,t,i){t.xhrResponseType="text",KI(e,t,t.onFileProgress,i)}function iR(e,t,i){var n=on(e),r=e,e=(nR.test(r)||(r=-1!==sR.remoteBundles.indexOf(n)?sR.remoteServerAddress+"remote/"+n:"assets/"+n),t.version||sR.bundleVers[n]),o=0,a=null,s=null;oR(r+"/config."+(e?e+".":"")+"json",t,function(e,t){s=e,(a=t)&&(a.base=r+"/"),2==++o&&i(s,a)}),ZI(r+"/index."+(e?e+".":"")+"js",t,function(e){s=e,2==++o&&i(e,a)})}var nR=/^(?:\w+:\/\/|\.+\/).+/,rR=function(e,t,i){t.xhrResponseType="blob",KI(e,t,t.onFileProgress,i)},oR=function(e,t,i){t.xhrResponseType="json",KI(e,t,t.onFileProgress,i)},aR=function(e,t,i){t.xhrResponseType="arraybuffer",KI(e,t,t.onFileProgress,i)},sR=((kd=cR.prototype).init=function(e,t,i){void 0===e&&(e=""),void 0===t&&(t={}),void 0===i&&(i=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=i},kd.register=function(e,t){"object"==typeof e?Je(this._downloaders,e):this._downloaders[e]=t},kd.download=function(o,t,e,n,r){var i,a,s,c,l=this,u=n_.get(o);u?r(null,u):(u=this._downloading.get(o))?(u.push(r),(u=this._queue.find(function(e){return e.id===o}))&&(i=n.priority||0,u.priority<i&&(u.priority=i,this._queueDirty=!0))):(u=(void 0!==n.maxRetryCount?n:this).maxRetryCount,a=(void 0!==n.maxConcurrency?n:this).maxConcurrency,s=(void 0!==n.maxRequestsPerFrame?n:this).maxRequestsPerFrame,c=this._downloaders[e]||this._downloaders.default,function i(n,r,o,a,s){n(s=void 0===s?0:s,function(e,t){s++,!e||r<s?a&&a(e,t):setTimeout(function(){i(n,r,o,a,s)},o)})}(function(e,i){0===e&&l._downloading.add(o,[r]),l.limited?(l._updateTime(),e=function(e,t){l._totalNum--,l._handleQueueInNextFrame(a,s),i(e,t)},l._totalNum<a&&l._totalNumThisPeriod<s?(c(zI(t,l.appendTimeStamp),n,e),l._totalNum++,l._totalNumThisPeriod++):(l._queue.push({id:o,priority:n.priority||0,url:t,options:n,done:e,handler:c}),l._queueDirty=!0,l._totalNum<a&&l._handleQueueInNextFrame(a,s))):c(zI(t,l.appendTimeStamp),n,i)},u,this.retryInterval,function(e,t){e||n_.add(o,t);for(var i=l._downloading.remove(o),n=0,r=i.length;n<r;n++)i[n](e,t)}))},kd.loadSubpackage=function(e,t){j.assetManager.loadBundle(e,null,t)},kd._updateTime=function(){var e=performance.now(),t=j.game.deltaTime,t=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*t&&(this._totalNumThisPeriod=0,this._lastDate=e)},kd._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();0<this._queue.length&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort(function(e,t){return e.priority-t.priority}),this._queueDirty=!1);var i=this._queue.pop();if(!i)break;this._totalNum++,this._totalNumThisPeriod++,i.handler(zI(i.url,this.appendTimeStamp),i.options,i.done)}this._handleQueueInNextFrame(e,t)},kd._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&0<this._queue.length&&(Yt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},e(cR,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),new cR);function cR(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=YI,this.downloadDomAudio=null,this.downloadFile=KI,this.downloadScript=ZI,this._downloaders={".png":JI,".jpg":JI,".bmp":JI,".jpeg":JI,".gif":JI,".ico":JI,".tiff":JI,".webp":JI,".image":JI,".pvr":aR,".pkm":aR,".astc":aR,".txt":tR,".xml":tR,".vsh":tR,".fsh":tR,".atlas":tR,".tmx":tR,".tsx":tR,".json":oR,".ExportJson":oR,".plist":tR,".ccon":$I,".cconb":eR,".fnt":tR,".binary":aR,".bin":aR,".dbbin":aR,".skel":aR,".js":ZI,bundle:iR,default:tR},this._downloading=new Zp,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}function lR(e,t,i,n){var r=null,o=null;try{(r=new Lv)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}n(o,r)}function uR(e,t,i,n){var r=new NA;r.json=t,n(null,r)}function hR(e,t,i,n){var r=new DA;r.text=t,n(null,r)}function pR(e,t,i,n){var r=new uE;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}function _R(e,t,i,n){var r=new P_;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}function fR(e,t,i,n){var r=o_.get(t.name);r||(r=t.name===l_.RESOURCES?qI:new WI,t.base=t.base||e+"/",r.init(t)),Dre.import("virtual:///prerequisite-imports/"+r.name).then(function(){n(null,r)}).catch(n)}(Z5=vR.prototype).register=function(e,t){"object"==typeof e?gt.mixin(this._producers,e):this._producers[e]=t},Z5.create=function(o,e,t,a,i){var n,s=this,t=this._producers[t]||this._producers.default,r=i_.get(o);a.reloadAsset||!r?(n=this._creating.get(o))?n.push(i):(this._creating.add(o,[i]),t(o,e,a,function(e,t){!e&&t instanceof P_&&kI(t._uuid=o,t,a.cacheAsset);for(var i=s._creating.remove(o),n=0,r=i.length;n<r;n++)i[n](e,t)})):i(null,r)};var dR=new vR,mR=((pF=gR.prototype).unpackJson=function(e,t,i,n){var r,o=gt.createMap(!0),a=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(oe(5304,e[0]));zf(e,!0,void 0,kf.reportMissingClass),Uf(e);for(var t=new Gf(e[0]),i=e[1],n=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,i,n,r,o);return a}(t)).length!==e.length&&ee(4915);for(var s=0;s<e.length;s++)o[e[s]+"@import"]=t[s]}else{var c=gt._getClassId(i0),l=gt._getClassId(Lv);if(t.type===c&&t.data){var u=t.data;u.length!==e.length&&ee(4915);for(var h=0;h<e.length;h++)o[e[h]+"@import"]=(r={base:u[h][0],mipmaps:u[h][1]},[1,0,0,[c],0,void 0?[r,-1]:[r],[0],0,[],[],[]])}else if(t.type===l&&t.data){var p=t.data;p.length!==e.length&&ee(4915);for(var _=0;_<e.length;_++)o[e[_]+"@import"]=p[_]}else a=new Error("unmatched type pack!"),o=null}n(a,o)},pF.init=function(){this._loading.clear()},pF.register=function(e,t){"object"==typeof e?gt.mixin(this._unpackers,e):this._unpackers[e]=t},pF.unpack=function(e,t,i,n,r){t?(0,this._unpackers[i])(e,t,n,r):r(new Error("package data is wrong!"))},pF.load=function(t,e,i){var l,n,u=this;!t.isNative&&t.info&&t.info.packs?n_.has(t.id)?i(null,n_.get(t.id)):(n=t.info.packs,(l=n.find(function(e){return u._loading.has(e.uuid)}))?this._loading.get(l.uuid).push({onComplete:i,id:t.id}):(l=n[0],this._loading.add(l.uuid,[{onComplete:i,id:t.id}]),n=b_(l.uuid,{ext:l.ext,bundle:t.config.name}),sR.download(l.uuid,n,l.ext,t.options,function(c,e){n_.remove(l.uuid),c&&tt(c.message,c.stack),u.unpack(l.packedUuids,e,l.ext,t.options,function(e,t){if(!e)for(var i in t)n_.add(i,t[i]);for(var n=u._loading.remove(l.uuid),r=0,o=n.length;r<o;r++){var a,s=n[r];c||e?s.onComplete(c||e):(a=t[s.id])?s.onComplete(null,a):s.onComplete(new Error("can not retrieve data from package"))}})}))):sR.download(t.id,t.url,t.ext,t.options,i)},new gR);function gR(){this._loading=new Zp,this._unpackers={".json":this.unpackJson}}function vR(){this._creating=new Zp,this._producers={".png":lR,".jpg":lR,".bmp":lR,".jpeg":lR,".gif":lR,".ico":lR,".tiff":lR,".webp":lR,".image":lR,".pvr":lR,".pkm":lR,".txt":hR,".xml":hR,".vsh":hR,".fsh":hR,".atlas":hR,".tmx":hR,".tsx":hR,".fnt":hR,".json":uR,".ExportJson":uR,".binary":pR,".bin":pR,".dbbin":pR,".skel":pR,bundle:fR,default:_R}}function yR(r,o){var a=!1,e=(r.progress||(r.progress={finish:0,total:r.input.length,canInvoke:!0},a=!0),r.options),s=r.progress,c=[],l=s.total,u=e.__exclude__=e.__exclude__||Object.create(null);r.output=[],GI(r.input,function(i,n){var e;if(!i.isNative&&i_.has(i.uuid))return e=i_.get(i.uuid),i.content=e.addRef(),r.output.push(i),s.canInvoke&&r.dispatch("progress",++s.finish,s.total,i),n();mR.load(i,r.options,function(e,t){e?r.isFinish||(!j.assetManager.force||a?(tt(e.message,e.stack),s.canInvoke=!1,o(e)):(r.output.push(i),s.canInvoke&&r.dispatch("progress",++s.finish,s.total,i))):r.isFinish||(i.file=t,r.output.push(i),i.isNative||(u[i.uuid]=!0,UI(i.uuid,t,u,c,i.config),s.total=l+c.length),s.canInvoke&&r.dispatch("progress",++s.finish,s.total,i)),n()})},function(){if(r.isFinish)return FI(r,!0),void r.dispatch("error");var i;0<c.length?(i=h_.create({input:c,progress:s,options:e,onProgress:r.onProgress,onError:h_.prototype.recycle,onComplete:function(e){var t;e||((t=r.output).push.apply(t,i.output),i.recycle()),a&&xR(r),o(e)}}),s_.async(i)):(a&&xR(r),o())})}function xR(e){for(var t=e.output,i=0,n=t.length;i<n;i++)t[i].content&&t[i].content.decRef(!1)}(Y3=ER.prototype).parse=function(e){return this._parseXML(e)},Y3._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},l(TR,SR=ER),(EW=TR.prototype).parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return J(5100),{};for(var i=null,n=0,r=t.childNodes.length;n<r&&1!==(i=t.childNodes[n]).nodeType;n++);return this._parseNode(i)},EW._parseNode=function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else for(var t="",n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue;else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t},EW._parseArray=function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t},EW._parseDict=function(e){for(var t={},i="",n=0,r=e.childNodes.length;n<r;n++){var o=e.childNodes[n];1===o.nodeType&&("key"===o.tagName?i=o.firstChild.nodeValue:t[i]=this._parseNode(o))}return t};var SR,bR=new TR;function TR(){return SR.apply(this,arguments)||this}function ER(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}function CR(e,t){return e[t]<<8|e[t+1]}(P=AR.prototype).parseImage=function(e,t,i){e instanceof HTMLImageElement?i(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then(function(e){i(null,e)},function(e){i(e,null)})},P.parsePVRTex=function(e,t,i){var n=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0])var s=a[7],c=a[6],l=a[12]+52,r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0};else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],p=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:p,height:h,format:0}}}catch(e){n=e}i(n,r)},P.parsePKMTex=function(e,t,i){var n=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=CR(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=CR(a,12),l=CR(a,14);CR(a,8),CR(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){n=e}i(n,r)},P.parseASTCTex=function(e,t,i){var n=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||6<s||c<3||6<c||l<3||6<l)&&(s<4||7===s||9===s||11===s||12<s||c<4||7===c||9===c||11===c||12<c||1!==l))throw new Error("Invalid block number in ASTC header");var u=4===s?pv.RGBA_ASTC_4x4:5===s?4===c?pv.RGBA_ASTC_5x4:pv.RGBA_ASTC_5x5:6===s?5===c?pv.RGBA_ASTC_6x5:pv.RGBA_ASTC_6x6:8===s?5===c?pv.RGBA_ASTC_8x5:6===c?pv.RGBA_ASTC_8x6:pv.RGBA_ASTC_8x8:10===s?5===c?pv.RGBA_ASTC_10x5:6===c?pv.RGBA_ASTC_10x6:8===c?pv.RGBA_ASTC_10x8:pv.RGBA_ASTC_10x10:10===c?pv.RGBA_ASTC_12x10:pv.RGBA_ASTC_12x12,h=a[7]+(a[8]<<8)+(a[9]<<16),p=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:p,format:u}}catch(e){n=e}i(n,r)},P.parsePlist=function(e,t,i){var n=null,e=bR.parse(e);i(n=e?n:new Error("parse failed"),e)},P.parseImport=function(e,t,i){if(e){var n=null,r=null;try{n=jv(e,t)}catch(e){r=e}i(r,n)}else i(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},P.init=function(){this._parsing.clear()},P.register=function(e,t){"object"==typeof e?Je(this._parsers,e):this._parsers[e]=t},P.parse=function(o,e,t,i,n){var a=this,r=r_.get(o);r?n(null,r):(r=this._parsing.get(o))?r.push(n):(r=this._parsers[t])?(this._parsing.add(o,[n]),r(e,i,function(e,t){e?n_.remove(o):x_(t)||r_.add(o,t);for(var i=a._parsing.remove(o),n=0,r=i.length;n<r;n++)i[n](e,t)})):n(null,e)};var wR=new AR;function AR(){this._parsing=new Zp,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}function PR(o,a){var s=!1,c=(o.progress||(o.progress={finish:0,total:o.input.length,canInvoke:!0},s=!0),o.options),l=o.progress;c.__exclude__=c.__exclude__||Object.create(null),o.output=[],GI(o.input,function(i,n){var r=h_.create({input:i,onProgress:o.onProgress,options:c,progress:l,onComplete:function(e,t){e&&!o.isFinish&&(!j.assetManager.force||s?(tt(e.message,e.stack),l.canInvoke=!1,a(e)):l.canInvoke&&o.dispatch("progress",++l.finish,l.total,i)),o.output.push(t),r.recycle(),n(null)}});IR.async(r)},function(){if(c.__exclude__=null,o.isFinish)return FI(o,!0),void o.dispatch("error");var e=o,t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var i=e.output=[],n=0,r=t.length;n<r;n++)i.push(t[n].content);else e.output=t[0].content;FI(o,!0),a()})}var IR=new Up("loadOneAsset",[function(e,i){var n=e.output=e.input,t=n.options,r=n.isNative,o=n.uuid,a=n.file,t=t.reloadAsset;a||!t&&!r&&i_.has(o)?i():mR.load(n,e.options,function(e,t){n.file=t,i(e)})},function(a,s){var e,t,i,n,r,o=a.output=a.input,c=a.progress,l=a.options.__exclude__,u=o.id,h=o.file,p=o.options;o.isNative?wR.parse(u,h,o.ext,p,function(e,t){e?s(e):(o.content=t,c.canInvoke&&a.dispatch("progress",++c.finish,c.total,o),n_.remove(u),r_.remove(u),s())}):(e=o.uuid)in l?(r=(n=l[e]).finish,t=n.content,i=n.err,n=n.callbacks,c.canInvoke&&a.dispatch("progress",++c.finish,c.total,o),r||function e(t,i,n,r){if(void 0===r&&(r={}),n[i]&&!r[i]){var o=!(r[i]=!0),a=Wv.getDeps(i);if(a)for(var s=0,c=a.length;s<c;s++){var l=a[s];if(l===t||e(t,l,n,r)){o=!0;break}}return o}}(e,e,l)?(t&&t.addRef(),o.content=t,s(i)):n.push({done:s,item:o})):!p.reloadAsset&&i_.has(e)?(r=i_.get(e),o.content=r.addRef(),c.canInvoke&&a.dispatch("progress",++c.finish,c.total,o),s()):(p.__uuid__=e,wR.parse(u,h,"import",p,function(e,t){var m,i,n,g,v,r,o,y,x,S;e?s(e):(m=t,e=s,i=(t=a).input,n=t.progress,g=i.uuid,v=i.id,r=i.options,o=i.config,y=r.cacheAsset,r=[],m.addRef&&m.addRef(),UI(g,m,Object.create(null),r,o),n.canInvoke&&t.dispatch("progress",++n.finish,n.total+=r.length,i),x=t.options.__exclude__[g]={content:m,finish:!1,callbacks:[{done:e,item:i}]},S=h_.create({input:r,options:t.options,onProgress:t.onProgress,onError:h_.prototype.recycle,progress:n,onComplete:function(e){if(m.decRef&&m.decRef(!1),x.finish=!0,!(x.err=e)){for(var t=Array.isArray(S.output)?S.output:[S.output],i=Object.create(null),n=ge(t);!(r=n()).done;){var r=r.value;r&&(i[r instanceof P_?r._uuid+"@import":g+"@native"]=r)}var t=g,o=m,a=i,s=Gv.get(o);if(s){for(var c=0,l=s.length;c<l;c++){var u=s[c],h=a[u.uuid+"@import"];h?u.owner[u.prop]=h.addRef():(tt("The asset "+u.uuid+" is missing!"),u.type&&u.type!==P_&&((h=new u.type).initDefault(u.uuid),u.owner[u.prop]=h))}Gv.delete(o)}Hv.has(o)&&(a[t+"@native"]?o._nativeAsset=a[t+"@native"]:console.error("the native asset of "+t+" is missing!"),Hv.delete(o));try{"function"!=typeof m.onLoaded||Vv.has(m)||Hv.has(m)||(m.onLoaded(),Vv.add(m))}catch(e){tt("The asset "+g+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}n_.remove(v),r_.remove(v),kI(g,m,y),S.recycle()}for(var p=x.callbacks,_=0,f=p.length;_<f;_++){var d=p[_];m.addRef&&m.addRef(),d.item.content=m,d.done(e)}p.length=0}}),a_.async(S))}))}]);function RR(e,t){var i,n=e.options,r=Object.create(null),o=Object.create(null);for(i in n)switch(i){case t_.PATH:case t_.UUID:case t_.DIR:case t_.SCENE:case t_.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":r[i]=n[i];break;case"__exclude__":case"__outputAsArray__":o[i]=n[i];break;default:r[i]=n[i],o[i]=n[i]}e.options=o;var a=h_.create({input:e.input,options:r}),s=null;try{e.output=e.source=c_.sync(a)}catch(e){for(var s=e,c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}OR.create=function(){return 0!==OR._deadPool.length?OR._deadPool.pop():new OR},OR.prototype.recycle=function(){OR._deadPool.length!==OR.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),OR._deadPool.push(this))},e(OR,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]);var DR=OR;function OR(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}DR.MAX_DEAD_NUM=500,DR._deadPool=[];var MR=[];function NR(l){var u=l.options,h=Array.isArray(l.input)?l.input:[l.input];l.output=[];for(var e=0;e<h.length;e++)!function(e){var t,i=h[e],n=DR.create(),r=null,o=null;if("string"==typeof i&&((i=Object.create(null))[u.__requestType__||t_.UUID]=h[e]),"object"==typeof i)for(var a in Ze(i,u),i.preset&&Ze(i,u_[i.preset]),i){switch(a){case t_.UUID:if("break"===function(){var e,t=n.uuid=m_(i.uuid);if(i.bundle||(e=o_.find(function(e){return!!e.getAssetInfo(t)}),i.bundle=e&&e.name),o_.has(i.bundle)){if(r=o_.get(i.bundle).config,(o=r.getAssetInfo(t))&&o.redirect){if(!o_.has(o.redirect))throw new Error("Please load bundle "+o.redirect+" first");r=o_.get(o.redirect).config,o=r.getAssetInfo(t)}n.config=r,n.info=o}return n.ext=i.ext||(null==(e=o)?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case t_.DIR:if(o_.has(i.bundle)){o_.get(i.bundle).config.getDirWithPath(i.dir,i.type,MR);for(var s=ge(MR);!(c=s()).done;){var c=c.value;h.push({uuid:c.uuid,__isNative__:!1,ext:c.extension||".json",bundle:i.bundle})}MR.length=0}n.recycle(),n=null;break;case t_.PATH:if(o_.has(i.bundle)){if(r=o_.get(i.bundle).config,(o=r.getInfoWithPath(i.path,i.type))&&o.redirect){if(!o_.has(o.redirect))throw new Error("you need to load bundle "+o.redirect+" first");r=o_.get(o.redirect).config,o=r.getAssetInfo(o.uuid)}if(!o)throw n.recycle(),new Error("Bundle "+i.bundle+" doesn't contain "+i.path);n.config=r,n.uuid=o.uuid,n.info=o}n.ext=i.ext||(null==(t=o)?void 0:t.extension)||".json";break;case t_.SCENE:if(i.bundle||(t=o_.find(function(e){return!!e.getSceneInfo(i.scene)}),i.bundle=t&&t.name),o_.has(i.bundle)){if(r=o_.get(i.bundle).config,(o=r.getSceneInfo(i.scene))&&o.redirect){if(!o_.has(o.redirect))throw new Error("you need to load bundle "+o.redirect+" first");r=o_.get(o.redirect).config,o=r.getAssetInfo(o.uuid)}if(!o)throw n.recycle(),new Error("Bundle "+r.name+" doesn't contain scene "+i.scene);n.config=r,n.uuid=o.uuid,n.info=o}break;case"__isNative__":n.isNative=i.__isNative__;break;case t_.URL:n.url=i.url,n.uuid=i.uuid||i.url,n.ext=i.ext||nn(i.url),n.isNative=void 0===i.__isNative__||i.__isNative__;break;default:n.options[a]=i[a]}if(!n)break}if(!n)return;if(l.output.push(n),!n.uuid&&!n.url)throw new Error("Can not parse this input:"+JSON.stringify(i))}(e);return null}function LR(e){for(var t=e.output=e.input,i=0;i<t.length;i++){var n,r,o,a=t[i];a.url||(n=a.config,n=a.isNative?n&&n.nativeBase?n.base+n.nativeBase:j.assetManager.generalNativeBase:n&&n.importBase?n.base+n.importBase:j.assetManager.generalImportBase,r=a.uuid,o="",a.info&&(o=a.isNative?a.info.nativeVer?"."+a.info.nativeVer:"":a.info.ver?"."+a.info.ver:""),n=".ttf"===a.ext?n+"/"+r.slice(0,2)+"/"+r+o+"/"+a.options.__nativeName__:n+"/"+r.slice(0,2)+"/"+r+o+a.ext,a.url=n)}return null}var w=Rre("AssetManager",((bne=BR.prototype).init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"",e=(t&&t.endsWith("/")&&(t=t.substr(0,t.length-1)),e.nativeBase||"");e&&e.endsWith("/")&&(e=e.substr(0,e.length-1)),this.generalImportBase=t,this.generalNativeBase=e},bne.getBundle=function(e){return o_.get(e)||null},bne.removeBundle=function(e){e._destroy(),o_.remove(e.name)},bne.loadAny=function(e,t,i,n){t=HI(t,i,n),i=t.options,n=t.onProgress,t=t.onComplete,i.preset=i.preset||"default",e=Array.isArray(e)?e.slice():e,e=h_.create({input:e,onProgress:n,onComplete:jI(t),options:i});a_.async(e)},bne.preloadAny=function(e,t,i,n){t=HI(t,i,n),i=t.options,n=t.onProgress,t=t.onComplete,i.preset=i.preset||"preload",e=Array.isArray(e)?e.slice():e,e=h_.create({input:e,onProgress:n,onComplete:jI(t),options:i});s_.async(e)},bne.loadRemote=function(i,e,t){var e=HI(e,void 0,t),n=e.options,r=e.onComplete;n.reloadAsset||!this.assets.has(i)?(n.__isNative__=!0,n.preset=n.preset||"remote",this.loadAny({url:i},n,null,function(e,t){e?(tt(e.message,e.stack),r&&r(e,t)):dR.create(i,t,n.ext||nn(i),n,function(e,t){r&&r(e,t)})})):jI(r)(null,this.assets.get(i))},bne.loadBundle=function(i,e,t){var e=HI(e,void 0,t),n=e.options,r=e.onComplete,t=on(i);this.bundles.has(t)?jI(r)(null,this.getBundle(t)):(n.preset=n.preset||"bundle",n.ext="bundle",n.__isNative__=!0,this.loadAny({url:i},n,null,function(e,t){e?(tt(e.message,e.stack),r&&r(e,t)):dR.create(i,t,"bundle",n,function(e,t){r&&r(e,t)})}))},bne.releaseAsset=function(e){NI.tryRelease(e,!0)},bne.releaseUnusedAssets=function(){i_.forEach(function(e){NI.tryRelease(e)})},bne.releaseAll=function(){i_.forEach(function(e){NI.tryRelease(e,!0)})},bne.loadWithJson=function(){throw new Error("Only valid in Editor")},e(BR,[{key:"main",get:function(){return o_.get(l_.MAIN)||null}},{key:"resources",get:function(){return o_.get(l_.RESOURCES)||null}}]),BR));function BR(){this.pipeline=a_.append(RR).append(PR),this.fetchPipeline=s_.append(RR).append(yR),this.transformPipeline=c_.append(NR).append(LR),this.bundles=o_,this.assets=i_,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Wv,this.force=!1,this.allowImageBitmap=!af.isMobile,this.utils=w_,this.downloader=sR,this.parser=wR,this.packManager=mR,this.cacheAsset=!0,this.cacheManager=null,this.presets=u_,this.factory=dR,this.preprocessPipe=RR,this.fetchPipe=yR,this.loadPipe=PR,this.references=null,this._releaseManager=NI,this._files=n_,this._parsed=r_,this._parsePipeline=null}w.Pipeline=Up,w.Task=h_,w.Cache=Zp,w.RequestItem=DR,w.Bundle=WI,w.BuiltinBundleName=l_;var FR=Rre("assetManager",j.assetManager=new w),zR=(j.AssetManager=w,[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"]),UR=[".mp3",".ogg",".wav",".m4a"];function kR(){return!0}var GR={transformURL:function(e){var t=v_(e);if(!t)return e;var i=o_.find(function(e){return!!e.getAssetInfo(t)});if(!i)return e;var n,r=i.getAssetInfo(t);if(!(n=e.startsWith(i.base+i.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(n))return e;var i=!1;return e=(i=".ttf"===nn(e)||i)?(r=an(e),i=on(e),r+"."+n+"/"+i):e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,function(e){return e+"."+n})}},Nw=Rre("CCLoader",((aie=WR.prototype).load=function(e,n,o){void 0===o&&void 0!==n&&(o=n,n=null);for(var a=Array.isArray(e)?e:[e],t=0;t<a.length;t++){var i=a[t];"string"==typeof i?a[t]={url:i,__isNative__:!0}:(i.type&&(i.ext="."+i.type,i.type=void 0),i.url&&(i.__isNative__=!0))}var s=[],c=[];FR.loadAny(a,null,function(e,t,i){i.content&&(zR.includes(i.ext)?s.push(i.content):UR.includes(i.ext)&&c.push(i.content)),n&&n(e,t,i)},function(e,r){var t=null;if(!e){r=Array.isArray(r)?r:[r];for(var i,n=0;n<r.length;n++)!function(i){var n,e,t=r[i];t instanceof P_||(n=t,e=a[i].url,s.includes(n)?dR.create(e,t,".png",{},function(e,t){n=r[i]=t}):c.includes(n)&&dR.create(e,t,".mp3",{},function(e,t){n=r[i]=t}),i_.add(e,n))}(n);t=1<r.length?(i=Object.create(null),r.forEach(function(e){i[e._uuid]=e}),{isCompleted:kR,_map:i}):r[0]}o&&o(e,t)})},aie.getXMLHttpRequest=function(){return new XMLHttpRequest},aie.getItem=function(e){return FR.assets.has(e)?{content:FR.assets.get(e)}:null},aie.loadRes=function(e,t,i,n){var t=this._parseLoadResArgs(t,i,n),i=t.type,n=t.onProgress,t=t.onComplete,r=nn(e);r&&!qI.getInfoWithPath(e,i)&&(e=e.slice(0,-r.length)),qI.load(e,i,n,t)},aie.loadResArray=function(n,e,t,i){var e=this._parseLoadResArgs(e,t,i),r=e.type,t=e.onProgress,i=e.onComplete;n.forEach(function(e,t){var i=nn(e);i&&!qI.getInfoWithPath(e,r)&&(n[t]=e.slice(0,-i.length))}),qI.load(n,r,t,i)},aie.loadResDir=function(n,e,t,i){var e=this._parseLoadResArgs(e,t,i),r=e.type,t=e.onProgress,o=e.onComplete;qI.loadDir(n,r,t,function(e,t){var i=[];e||(i=qI.getDirWithPath(n,r).map(function(e){return e.path})),o&&o(e,t,i)})},aie.getRes=function(e,t){return i_.has(e)?i_.get(e):qI.get(e,t)},aie.getResCount=function(){return i_.count},aie.getDependsRecursively=function(e){if(!e)return[];e="string"==typeof e?e:e._uuid;return Wv.getDepsRecursively(e).concat([e])},aie.addDownloadHandlers=function(t){var e,i=Object.create(null);for(e in t)!function(e){var n=t[e];i["."+e]=function(e,t,i){n({url:e},i)}}(e);sR.register(i)},aie.addLoadHandlers=function(t){var e,i=Object.create(null);for(e in t)!function(e){var n=t[e];i["."+e]=function(e,t,i){n({content:e},i)}}(e);wR.register(i)},aie.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];"string"==typeof i&&(i=i_.get(i)),FR.releaseAsset(i)}else e&&("string"==typeof e&&(e=i_.get(e)),FR.releaseAsset(e))},aie.releaseAsset=function(e){FR.releaseAsset(e)},aie.releaseRes=function(e,t){qI.release(e,t)},aie.releaseAll=function(){FR.releaseAll(),i_.clear()},aie.removeItem=function(e){return!!i_.remove(e)},aie.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},aie.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=t=!!t;for(var i=Wv.getDepsRecursively(e),n=0;n<i.length;n++)this._autoReleaseSetting[i[n]]=t},aie.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},e(WR,[{key:"onProgress",set:function(e){LI=e}},{key:"_cache",get:function(){if(i_ instanceof Zp)return i_._map;var i={};return i_.forEach(function(e,t){i[t]=e}),i}},{key:"md5Pipe",get:function(){return GR}},{key:"downloader",get:function(){return sR}},{key:"loader",get:function(){return FR.parser}}]),WR)),HR=Rre("loader",new Nw),VR=Rre("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,FR.init(e),e.rawAssets&&qI.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:l_.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){FR.loadAny(e,t)}}),jR=Rre("url",{});function WR(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=VI}In(jR,"url",[{name:"normalize",target:FR.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?b_({path:sn(e.substr(10)),bundle:l_.RESOURCES,__isNative__:!0,ext:nn(e)}):""}}]),Ee(VR,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),Ee(HR,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),In(j,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return HR}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return VR}},{name:"Pipeline",target:w,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return jR}}]),Ee(j,"cc",[{name:"LoadingItems",suggest:oe(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),In(zt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:sR,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),In(ZP,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){return FR.main?null==(e=FR.main.getSceneInfo(e))?void 0:e.uuid:""}}]),In(YP,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var t=[];return FR.main&&FR.main.config.scenes.forEach(function(e){t.push(e)}),t}}]);var qR,XR,YR,KR,QR,ZR=NI._autoRelease;NI._autoRelease=function(e,t,i){ZR.call(NI,e,t,i);for(var n=HR._autoReleaseSetting,r=Object.keys(n),o=0;o<r.length;o++){var a=r[o];!0!==n[a]||(a=i_.get(a))&&NI.tryRelease(a)}};var JR,$R,eD,tD,iD,nD,rD,oD,aD,sD,cD,lD,uD,hD,pD,_D,fD,dD,mD=Rre("EventHandler",(h=f("cc.ClickEvent"),kw=v(j.Node),Gd=u(),a=u(),L6=u(),XN=u(),h((gD.emitEvents=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,o=e.length;r<o;r++){var a=e[r];a instanceof gD&&a.emit(i)}},(S=gD.prototype).emit=function(e){var t,i=this.target;j.isValid(i)&&(this._genCompIdIfNeeded(),t=j.js._getClassById(this._componentId),i=i.getComponent(t),j.isValid(i)&&"function"==typeof(t=i[this.handler])&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),t.apply(i,e)))},S._compName2Id=function(e){e=j.js.getClassByName(e);return j.js._getClassId(e)},S._compId2Name=function(e){e=j.js._getClassById(e);return j.js.getClassName(e)},S._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},e(gD,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),qR=i((s=gD).prototype,"target",[d,kw,d,Gd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XR=i(s.prototype,"component",[d,Ap,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),YR=i(s.prototype,"_componentId",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),KR=i(s.prototype,"handler",[d,Ap,L6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QR=i(s.prototype,"customEventData",[d,Ap,XN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ane=s))||ane));function gD(){_(this,"target",qR,this),_(this,"component",XR,this),_(this,"_componentId",YR,this),_(this,"handler",KR,this),_(this,"customEventData",QR,this)}j.Component.EventHandler=mD;var vD,yD,xD,SD=new ce,bD=Ot(av),TD=Ot(ov),ED=Ot(sv),CD=Ot(lv),wD=Ot(cv),AD=Ot({SKYBOX:Sv|la.DEPTH_STENCIL,SOLID_COLOR:la.ALL,DEPTH_ONLY:la.DEPTH_STENCIL,DONT_CLEAR:la.NONE}),PD=(y=f("cc.Camera"),fie=wp(),Qp=Ep(),Mne=m(),cM=u(),ba=v(Tg.BitMask),dU=m(),W3=u(),YD=v(AD),Iie=m(),Rie=u(),B1=m(),x=u(),Hd=m(),r=u(),Ce=m(),Sa=u(),R=v(bD),g=m(),t=u(),o=v(TD),n=m(),I=u(),c=m(),vie=u(),b=m(),E2=u(),xH=m(),uI=u(),E=m(),vI=u(),yI=v(ED),C=m(),C7=u(),Nk=v(CD),A=m(),yU=u(),kd=v(wD),Z5=m(),pF=u(),Y3=m(),EW=u(),P=v(cb),bne=m(),Up=u(),kw=y(S=fie(S=Qp(S=Tp((l(ID,xD=W_),(aie=ID.prototype).onLoad=function(){this._createCamera()},aie.onEnable=function(){this.node.hasChangedFlags|=Q0.POSITION,this._camera&&this._attachToScene()},aie.onDisable=function(){this._camera&&this._detachFromScene()},aie.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},aie.screenPointToRay=function(e,t,i){return i=i||fo.create(),this._camera&&this._camera.screenPointToRay(i,e,t),i},aie.worldToScreen=function(e,t){return t=t||new ce,this._camera&&this._camera.worldToScreen(t,e),t},aie.screenToWorld=function(e,t){return t=t||this.node.getWorldPosition(),this._camera&&this._camera.screenToWorld(t,e),t},aie.convertToUINode=function(e,t,i){if(i=i||new ce,!this._camera)return i;this.worldToScreen(e,SD);var e=t.getComponent("cc.UITransform"),t=AI.getVisibleSize(),n=SD.x-.5*this._camera.width,r=SD.y-.5*this._camera.height;return SD.x=n/j.view.getScaleX()+.5*t.width,SD.y=r/j.view.getScaleY()+.5*t.height,e&&e.convertToNodeSpaceAR(SD,i),i},aie._createCamera=function(){this._camera||(this._camera=j.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?j.director.root&&j.director.root.mainWindow:j.director.root&&j.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=kn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},aie._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},aie._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},aie._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)},this)},aie._updateTargetTexture=function(){var e;this._camera&&this._targetTexture&&(e=this._targetTexture.window,this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height))},e(ID,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&((this._camera.fovAxis=e)===ov.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=e*On)}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){var t;this._targetTexture!==e&&(t=this._targetTexture,this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(ID.TARGET_TEXTURE_CHANGE,this))}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?j.director.root&&j.director.root.mainWindow:j.director.root&&j.director.root.tempWindow)}}]),w=Nw=ID,Nw.ProjectionType=bD,Nw.FOVAxis=TD,Nw.ClearFlag=AD,Nw.Aperture=ED,Nw.Shutter=CD,Nw.ISO=wD,Nw.TARGET_TEXTURE_CHANGE="tex-change",JR=i((h=w).prototype,"_projection",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bD.PERSPECTIVE}}),$R=i(h.prototype,"_priority",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eD=i(h.prototype,"_fov",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),tD=i(h.prototype,"_fovAxis",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TD.VERTICAL}}),iD=i(h.prototype,"_orthoHeight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),nD=i(h.prototype,"_near",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rD=i(h.prototype,"_far",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),oD=i(h.prototype,"_color",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr("#333333")}}),aD=i(h.prototype,"_depth",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sD=i(h.prototype,"_stencil",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cD=i(h.prototype,"_clearFlags",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AD.SOLID_COLOR}}),lD=i(h.prototype,"_rect",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qr(0,0,1,1)}}),uD=i(h.prototype,"_aperture",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ED.F16_0}}),hD=i(h.prototype,"_shutter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CD.D125}}),pD=i(h.prototype,"_iso",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wD.ISO100}}),_D=i(h.prototype,"_screenScale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fD=i(h.prototype,"_visibility",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uv}}),dD=i(h.prototype,"_targetTexture",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(h.prototype,"priority",[Mne,cM],Object.getOwnPropertyDescriptor(h.prototype,"priority"),h.prototype),i(h.prototype,"visibility",[ba,dU,W3],Object.getOwnPropertyDescriptor(h.prototype,"visibility"),h.prototype),i(h.prototype,"clearFlags",[YD,Iie,Rie],Object.getOwnPropertyDescriptor(h.prototype,"clearFlags"),h.prototype),i(h.prototype,"clearColor",[B1,x],Object.getOwnPropertyDescriptor(h.prototype,"clearColor"),h.prototype),i(h.prototype,"clearDepth",[Hd,r],Object.getOwnPropertyDescriptor(h.prototype,"clearDepth"),h.prototype),i(h.prototype,"clearStencil",[Ce,Sa],Object.getOwnPropertyDescriptor(h.prototype,"clearStencil"),h.prototype),i(h.prototype,"projection",[R,g,t],Object.getOwnPropertyDescriptor(h.prototype,"projection"),h.prototype),i(h.prototype,"fovAxis",[o,n,I],Object.getOwnPropertyDescriptor(h.prototype,"fovAxis"),h.prototype),i(h.prototype,"fov",[c,vie],Object.getOwnPropertyDescriptor(h.prototype,"fov"),h.prototype),i(h.prototype,"orthoHeight",[b,E2],Object.getOwnPropertyDescriptor(h.prototype,"orthoHeight"),h.prototype),i(h.prototype,"near",[xH,uI],Object.getOwnPropertyDescriptor(h.prototype,"near"),h.prototype),i(h.prototype,"far",[E,vI],Object.getOwnPropertyDescriptor(h.prototype,"far"),h.prototype),i(h.prototype,"aperture",[yI,C,C7],Object.getOwnPropertyDescriptor(h.prototype,"aperture"),h.prototype),i(h.prototype,"shutter",[Nk,A,yU],Object.getOwnPropertyDescriptor(h.prototype,"shutter"),h.prototype),i(h.prototype,"iso",[kd,Z5,pF],Object.getOwnPropertyDescriptor(h.prototype,"iso"),h.prototype),i(h.prototype,"rect",[Y3,EW],Object.getOwnPropertyDescriptor(h.prototype,"rect"),h.prototype),i(h.prototype,"targetTexture",[P,bne,Up],Object.getOwnPropertyDescriptor(h.prototype,"targetTexture"),h.prototype),S=h))||S)||S)||S)||S,Rre({Camera:kw,CameraComponent:kw}),kw);function ID(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=xD.call.apply(xD,[this].concat(i))||this,"_projection",JR,p(e)),_(e,"_priority",$R,p(e)),_(e,"_fov",eD,p(e)),_(e,"_fovAxis",tD,p(e)),_(e,"_orthoHeight",iD,p(e)),_(e,"_near",nD,p(e)),_(e,"_far",rD,p(e)),_(e,"_color",oD,p(e)),_(e,"_depth",aD,p(e)),_(e,"_stencil",sD,p(e)),_(e,"_clearFlags",cD,p(e)),_(e,"_rect",lD,p(e)),_(e,"_aperture",uD,p(e)),_(e,"_shutter",hD,p(e)),_(e,"_iso",pD,p(e)),_(e,"_screenScale",_D,p(e)),_(e,"_visibility",fD,p(e)),_(e,"_targetTexture",dD,p(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}j.Camera=PD;var RD,DD,OD,MD={parent:null,owner:null,subModelIdx:0},ND=Rre("RenderableComponent",(Gd=f("cc.RenderableComponent"),a=v([Ey]),L6=v(Ey),XN=m(),s=Rp(),Gd((l(LD,OD=W_),(ane=LD.prototype).getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},ane.setMaterial=function(e,t){e&&e instanceof Hy&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;e=this._materialInstances[t];e&&(e.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},ane.getMaterialInstance=function(e){return this._materials[e]?(this._materialInstances[e]||(MD.parent=this._materials[e],MD.owner=this,MD.subModelIdx=e,t=new Hy(MD),MD.parent=null,MD.owner=null,MD.subModelIdx=0,this.setMaterialInstance(t,e)),this._materialInstances[e]):null;var t},ane.setMaterialInstance=function(e,t){"number"==typeof e&&(J(12007),i=e,e=t,t=i);var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e===this._materials[t]&&!i||this.setMaterial(e,t)},ane.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},ane._collectModels=function(){return this._models},ane._attachToScene=function(){},ane._detachFromScene=function(){},ane._onMaterialModified=function(){},ane._onRebuildPSO=function(){},ane._clearMaterials=function(){},ane._onVisibilityChange=function(){},e(LD,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var i=this._materials.length-t;i<this._materials.length;++i)this.setMaterialInstance(null,i);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=e[n]&&this.setMaterialInstance(e[n],n)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&!this._materialInstances[0]&&this._materials[0]===e||this.setMaterialInstance(e,0)}}]),vD=i((y=LD).prototype,"_materials",[a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yD=i(y.prototype,"_visFlags",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tg.Enum.NONE}}),i(y.prototype,"sharedMaterials",[L6,XN,s],Object.getOwnPropertyDescriptor(y.prototype,"sharedMaterials"),y.prototype),fie=y))||fie));function LD(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=OD.call.apply(OD,[this].concat(i))||this,"_materials",vD,p(e)),_(e,"_visFlags",yD,p(e)),e._materialInstances=[],e._models=[],e}function BD(e){return"string"==typeof e||"number"==typeof e}j.RenderableComponent=ND,In(PD,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),In(PD.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),j.CameraComponent=PD,gt.setClassAlias(PD,"cc.CameraComponent");var FD,zD,UD,kD,GD,HD,VD,jD,WD,qD=f("cc.animation.HierarchyPath")((e2.prototype.get=function(e){return e instanceof N1?e.getChildByPath(this.path)||(J(3926,e.name,this.path),null):(J(3925),null)},RD=i((Qp=e2).prototype,"path",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aie=Qp))||aie,XD=f("cc.animation.ComponentPath")(($D.prototype.get=function(e){return e instanceof N1?e.getComponent(this.component)||(J(3928,e.name,this.component),null):(J(3927),null)},DD=i((Nw=$D).prototype,"component",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),w=Nw))||w,ba=f("cc.animation.UniformProxyFactory")((JD.prototype.forTarget=function(e){var o=e.passes[this.passIndex],t=o.getHandle(this.uniformName);if(!t)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(G0.getTypeFromHandle(t)<Ro.SAMPLER1D){var i=void 0===this.channelIndex?t:o.getHandle(this.uniformName,this.channelIndex,Ro.FLOAT);if(i)return function(e){for(var t,i=ge(o.shaderInfo.blocks);!(t=i()).done;)for(var n=ge(t.value.members);!(r=n()).done;){var r=r.value;if(r.name===e)return 1<r.count}}(this.uniformName)?{set:function(e){o.setUniformArray(i,e)}}:{set:function(e){o.setUniform(i,e)}};throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"')}var n=G0.getBindingFromHandle(t),e=o.properties[this.uniformName],t=e&&e.value?e.value+"-texture":y0(e.type),r=D0.get(t);return r||(V("Illegal texture default value: "+t+"."),r=D0.get("default-texture")),{set:function(e){var t=(e=e||r).getGFXTexture();t&&t.width&&t.height&&(o.bindTexture(n,t),e instanceof Uv&&o.bindSampler(n,j.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},FD=i((Mne=JD).prototype,"passIndex",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zD=i(Mne.prototype,"uniformName",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),UD=i(Mne.prototype,"channelIndex",[zp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),cM=Mne))||cM,YD=f("cc.animation.MorphWeightValueProxy")((ZD.prototype.forTarget=function(t){var i=this;return{set:function(e){t.setWeight(e,i.subMeshIndex,i.shapeIndex)}}},kD=i((dU=ZD).prototype,"subMeshIndex",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GD=i(dU.prototype,"shapeIndex",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),W3=dU))||W3,B1=f("cc.animation.MorphWeightsValueProxy")((QD.prototype.forTarget=function(t){var i=this;return{set:function(e){t.setWeights(e,i.subMeshIndex)}}},HD=i((Iie=QD).prototype,"subMeshIndex",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rie=Iie))||Rie,Hd=f("cc.animation.MorphWeightsAllValueProxy")((KD.prototype.forTarget=function(r){return{set:function(e){for(var t,i=null!=(t=null==(t=r.mesh)?void 0:t.struct.primitives.length)?t:0,n=0;n<i;++n)r.setWeights(e,n)}}},x=KD))||x;function KD(){}function QD(){_(this,"subMeshIndex",HD,this)}function ZD(){_(this,"subMeshIndex",kD,this),_(this,"shapeIndex",GD,this)}function JD(e,t){_(this,"passIndex",FD,this),_(this,"uniformName",zD,this),_(this,"channelIndex",UD,this),this.passIndex=t||0,this.uniformName=e||""}function $D(e){_(this,"component",DD,this),this.component=e||""}function e2(e){_(this,"path",RD,this),this.path=e||""}function t2(e,n,s,c){var r,o,a,l,u=new n,h=new n,p=new n,e=f(e)(((e=t.prototype).lerp=function(e,t,i){var n=this.dataPoint,r=e.dataPoint,e=(h=s(h,this.inTangent,i),p=s(p,e.outTangent,i),t*t*t),i=t*t,t=e-2*i+t,o=-2*e+3*i,a=e-i;return u=s(u,n,2*e-3*i+1),u=c(u,u,h,t),u=c(u,u,r,o),u=c(u,u,p,a)},e.getNoLerp=function(){return this.dataPoint},r=i((e=t).prototype,"dataPoint",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n}}),o=i(e.prototype,"inTangent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n}}),a=i(e.prototype,"outTangent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new n}}),e=e))||e;function t(e,t,i){_(this,"dataPoint",r,this),_(this,"inTangent",o,this),_(this,"outTangent",a,this),this.dataPoint=e||new n,this.inTangent=t||new n,this.outTangent=i||new n}return n===gr&&(l=e.prototype.lerp,e.prototype.lerp=function(e,t,i){e=l.call(this,e,t,i);return gr.normalize(e,e),e}),e}var i2=Rre("CubicSplineVec2Value",t2("cc.CubicSplineVec2Value",U,U.multiplyScalar,U.scaleAndAdd)),n2=(j.CubicSplineVec2Value=i2,Rre("CubicSplineVec3Value",t2("cc.CubicSplineVec3Value",ce,ce.multiplyScalar,ce.scaleAndAdd))),r2=(j.CubicSplineVec3Value=n2,Rre("CubicSplineVec4Value",t2("cc.CubicSplineVec4Value",Fr,Fr.multiplyScalar,Fr.scaleAndAdd))),o2=(j.CubicSplineVec4Value=r2,Rre("CubicSplineQuatValue",t2("cc.CubicSplineQuatValue",gr,gr.multiplyScalar,gr.scaleAndAdd))),a2=(j.CubicSplineQuatValue=o2,Rre("CubicSplineNumberValue",f("cc.CubicSplineNumberValue")(((r=s2.prototype).lerp=function(e,t,i){var n=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return n*(2*o-3*a+1)+this.outTangent*i*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*i*(o-a)},r.getNoLerp=function(){return this.dataPoint},VD=i((Ce=s2).prototype,"dataPoint",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jD=i(Ce.prototype,"inTangent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WD=i(Ce.prototype,"outTangent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sa=Ce))||Sa));function s2(e,t,i){_(this,"dataPoint",VD,this),_(this,"inTangent",jD,this),_(this,"outTangent",WD,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}j.CubicSplineNumberValue=a2;var c2,l2,u2,h2,p2,_2,f2,d2,m2,g2,v2=Symbol("CreateEval"),y2=Symbol("NormalizedFollow"),x2=Symbol("ConvertAsTrsPath"),S2=Symbol("TrackBinding"),b2=f("cc.animation.TrackPath")(((R=N2.prototype).toProperty=function(e){return this._paths.push(e),this},R.toElement=function(e){return this._paths.push(e),this},R.toHierarchy=function(e){return this._paths.push(new qD(e)),this},R.toComponent=function(e){e=new XD("string"==typeof e?e:gt.getClassName(e));return this._paths.push(e),this},R.toCustomized=function(e){return this._paths.push(e),this},R.append=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=(n=this._paths).concat.apply(n,t.map(function(e){return e._paths}));return this._paths=n,this},R.isPropertyAt=function(e){return"string"==typeof this._paths[e]},R.parsePropertyAt=function(e){return this._paths[e]},R.isElementAt=function(e){return"number"==typeof this._paths[e]},R.parseElementAt=function(e){return this._paths[e]},R.isHierarchyAt=function(e){return this._paths[e]instanceof qD},R.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},R.isComponentAt=function(e){return this._paths[e]instanceof XD},R.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},R.slice=function(e,t){var i=new N2;return i._paths=this._paths.slice(e,t),i},R.trace=function(e,t,i){return null==t&&(t=0),null==i&&(i=this._paths.length),this[y2](e,t,i)},R[x2]=function(){for(var e,t=this._paths,i=t.length,n=0,r="";n<i;++n){var o=t[n];if(!(o instanceof qD))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(n===i)return null;if(n!==i-1)return null;switch(t[n]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[n];break;default:return null}return{node:r,property:e}},R[y2]=function(e,t,i){for(var n=this._paths,r=e,o=t;o<i;++o){var a=n[o];if(BD(a)){if(!(a in r))return J(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},e(N2,[{key:"length",get:function(){return this._paths.length}}]),c2=i((g=N2).prototype,"_paths",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),t=g))||t,T2=f("cc.animation.TrackBinding")(I=bp(((o=M2.prototype).parseTrsPath=function(){return this.proxy?null:this.path[x2]()},o.createRuntimeBinding=function(e,t,i){var n=this.path,r=this.proxy,o=n.length,a=o-1;if(0===o||!n.isPropertyAt(a)&&!n.isElementAt(a)||r){if(r){var s=n[y2](e,0,o);if(null===s)return null;var c=r.forTarget(s),r={setValue:function(e){c.set(e)}},l=c.get;return l&&(r.getValue=function(){return l.call(c)}),r}return ee(3921),null}var u=n.isPropertyAt(a)?n.parsePropertyAt(a):n.parseElementAt(a),h=n[y2](e,0,o-1);return null===h?null:t&&h instanceof N1&&("position"===u||"rotation"===u||"scale"===u||"eulerAngles"===u)?t.createPoseWriter(h,u,i):{setValue:function(e){h[u]=e},getValue:function(){return h[u]}}},l2=i((n=M2).prototype,"path",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new b2}}),u2=i(n.prototype,"proxy",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),I=n))||I)||I,E2=f("cc.animation.Track")(((c=O2.prototype).channels=function(){return[]},c.range=function(){for(var e={min:1/0,max:-1/0},t=ge(this.channels());!(i=t()).done;){var i=i.value;e.min=Math.min(e.min,i.curve.rangeMin),e.max=Math.max(e.max,i.curve.rangeMax)}return e},e(O2,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:S2,get:function(){return this._binding}}]),h2=i((vie=O2).prototype,"_binding",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T2}}),b=vie))||b,C2=f("cc.animation.Channel")((e(D2,[{key:"curve",get:function(){return this._curve}}]),p2=i((xH=D2).prototype,"_curve",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uI=xH))||uI,C=f("cc.animation.SingleChannelTrack")((l(R2,g2=E2),(E=R2.prototype).channels=function(){return[this._channel]},E.createCurve=function(){throw new Error("Not impl")},E[v2]=function(){var e=this._channel.curve;return new w2(e)},e(R2,[{key:"channel",get:function(){return this._channel}}]),_2=i((vI=R2).prototype,"_channel",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yI=vI))||yI,w2=(I2.prototype.evaluate=function(e){return this._curve.evaluate(e)},I2),A2=f("cc.animation.RealTrack")((l(P2,m2=C),P2.prototype.createCurve=function(){return new im},C7=P2))||C7;function P2(){return m2.apply(this,arguments)||this}function I2(e){this._curve=e}function R2(){var e;return _(e=g2.call(this)||this,"_channel",_2,p(e)),e._channel=new C2(e.createCurve()),e}function D2(e){this.name="",_(this,"_curve",p2,this),this._curve=e}function O2(){_(this,"_binding",h2,this)}function M2(){_(this,"path",l2,this),_(this,"proxy",u2,this)}function N2(){_(this,"_paths",c2,this)}function L2(e){return 0===e.keyFramesCount?void 0:e}var B2,F2,z2,U2,k2,G2,H2,V2=["X","Y","Z","W"],j2=f("cc.animation.VectorTrack")((l(_O,H2=E2),(Nk=_O.prototype).channels=function(){return this._channels},Nk[v2]=function(){switch(this._nComponents){default:case 2:return new W2(L2(this._channels[0].curve),L2(this._channels[1].curve));case 3:return new q2(L2(this._channels[0].curve),L2(this._channels[1].curve),L2(this._channels[2].curve));case 4:return new X2(L2(this._channels[0].curve),L2(this._channels[1].curve),L2(this._channels[2].curve),L2(this._channels[3].curve))}},e(_O,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),f2=i((A=_O).prototype,"_channels",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),d2=i(A.prototype,"_nComponents",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),yU=A))||yU,W2=(pO.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||U.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},pO),q2=(hO.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||ce.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},hO),X2=(uO.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Fr.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},uO),Y2=f("cc.animation.QuatTrack")((l(lO,G2=C),(kd=lO.prototype).createCurve=function(){return new Bm},kd[v2]=function(){return new K2(this.channels()[0].curve)},Z5=lO))||Z5,K2=(cO.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},cO),Q2=["Red","Green","Blue","Alpha"],Z2=f("cc.animation.ColorTrack")((l(sO,k2=E2),(pF=sO.prototype).channels=function(){return this._channels},pF[v2]=function(){return new J2(L2(this._channels[0].curve),L2(this._channels[1].curve),L2(this._channels[2].curve),L2(this._channels[3].curve))},B2=i((Y3=sO).prototype,"_channels",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),EW=Y3))||EW,J2=(aO.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||nr.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},aO),$2=["Width","Height"],eO=f("cc.animation.SizeTrack")((l(oO,U2=E2),(P=oO.prototype).channels=function(){return this._channels},P[v2]=function(){return new tO(L2(this._channels[0].curve),L2(this._channels[1].curve))},F2=i((bne=oO).prototype,"_channels",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Up=bne))||Up,tO=(rO.prototype.evaluate=function(e,t){return this._width&&this._height||!t.getValue||(t=t.getValue(),this._result.x=t.x,this._result.y=t.y),this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},rO),iO=f("cc.animation.ObjectTrack")((l(nO,z2=C),nO.prototype.createCurve=function(){return new Km},h=nO))||h;function nO(){return z2.apply(this,arguments)||this}function rO(e,t){this._result=new Hr,this._width=e,this._height=t}function oO(){var e;_(e=U2.call(this)||this,"_channels",F2,p(e)),e._channels=new Array(2);for(var t=0;t<e._channels.length;++t){var i=new C2(new im);i.name=$2[t],e._channels[t]=i}return e}function aO(e,t,i,n){this._result=new nr,this._x=e,this._y=t,this._z=i,this._w=n}function sO(){var e;_(e=k2.call(this)||this,"_channels",B2,p(e)),e._channels=new Array(4);for(var t=0;t<e._channels.length;++t){var i=new C2(new im);i.name=Q2[t],e._channels[t]=i}return e}function cO(e){this._result=new gr,this._curve=e}function lO(){return G2.apply(this,arguments)||this}function uO(e,t,i,n){this._result=new Fr,this._x=e,this._y=t,this._z=i,this._w=n}function hO(e,t,i){this._result=new ce,this._x=e,this._y=t,this._z=i}function pO(e,t){this._result=new U,this._x=e,this._y=t}function _O(){var e;_(e=H2.call(this)||this,"_channels",f2,p(e)),_(e,"_nComponents",d2,p(e)),e._channels=new Array(4);for(var t=0;t<e._channels.length;++t){var i=new C2(new im);i.name=V2[t],e._channels[t]=i}return e}Rre("animation",Object.freeze({__proto__:null,UniformProxyFactory:ba,MorphWeightValueProxy:YD,MorphWeightsValueProxy:B1,MorphWeightsAllValueProxy:Hd,Track:E2,TrackPath:b2,RealTrack:A2,VectorTrack:j2,QuatTrack:Y2,ColorTrack:Z2,SizeTrack:eO,ObjectTrack:iO,isPropertyPath:BD,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:qD,ComponentPath:XD,CubicSplineVec2Value:i2,CubicSplineVec3Value:n2,CubicSplineVec4Value:r2,CubicSplineQuatValue:o2,CubicSplineNumberValue:a2}));var fO=Symbol("BakeNodeCurves"),dO=(mO.getOrExtract=function(e){var t,i,n=mO.pool.get(e);return n&&n.samples===e.sample||(n&&j.director.root.dataPoolManager.releaseAnimationClip(e),t=Math.ceil(e.sample*e.duration)+1,i=e.sample,n=e[fO](0,i,t),mO.pool.set(e,n)),n},mO.destroy=function(e){mO.pool.delete(e)},mO);function mO(){}dO.pool=new Map;var gO=Rre("RatioSampler",(vO.prototype.sample=function(e){return this._findRatio(this.ratios,e)},vO));function vO(e){var t,i;this.ratios=void 0;for(var n=!(this._findRatio=void 0),r=1,o=(this.ratios=e).length;r<o;r++)if(t=e[r]-e[r-1],1===r)i=t;else if(1e-6<Math.abs(t-i)){n=!1;break}this._findRatio=n?TO:lp}j.RatioSampler=gO;var yO=Rre("AnimCurve",(xO.Bezier=function(e){return e},(S=xO.prototype).hasLerp=function(){return!!this._lerp},S.valueAt=function(e){var t;if(void 0===this._array)return(t=this._values[e])&&t.getNoLerp?t.getNoLerp():t;for(var i=0;i<this._array.length;++i)this._array[i]=this._values[this._array.length*e+i];return this._array},S.valueBetween=function(e,t,i,n,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-i,s=(e-i)/a;if(o&&(s=bO(s,o)),void 0===this._array)return r=this._values[t],e=this._values[n],this._lerp(r,e,s,a*this._duration);for(var c=0;c<this._array.length;++c){var l=this._values[this._array.length*t+c],u=this._values[this._array.length*n+c];this._array[c]=this._lerp(l,u,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var h=0;h<this._array.length;++h)this._array[h]=this._values[this._array.length*t+h];return this._array},S.empty=function(){return 0===this._values.length},S.constant=function(){return 1===this._values.length},xO));function xO(e,t){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=t,this._values=e.values;function i(e){return"string"==typeof e?e:!Array.isArray(e)||e[0]===e[1]&&e[2]===e[3]?xO.Linear:xO.Bezier(e)}if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var n=0,r=Object.keys(e.easingMethods);n<r.length;n++){var o=r[n];this.types[o]=i(e.easingMethods[o])}}else this.type=null;t=e.values[0];void 0!==e.interpolate&&!e.interpolate||(this._lerp=IO(t)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}function SO(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function bO(e,t){var i;return"string"==typeof t?(i=Wd[t])?e=i(e):ee(3906,t):Array.isArray(t)&&(e=Dm(t,e)),e}function TO(e,t){var i=e.length-1;if(0==i)return 0;var n=e[0];if(t<n)return 0;e=e[i];if(e<t)return i;e=(t=(t-n)/(e-n))/(1/i),n=0|e;return e-n<1e-6?n:1+n-e<1e-6?1+n:~(1+n)}function EO(){this.events=[]}yO.Linear=null,j.AnimCurve=yO,Rre("EventInfo",(EO.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},EO)),j.sampleAnimationCurve=SO;var CO,wO,AO,PO,IO=function(e){var n,r,o;if(null!==e)return"number"==typeof e?Un:"object"==typeof e&&e.constructor?e instanceof gr?(n=new gr,function(e,t,i){return gr.slerp(n,e,t,i)}):e instanceof Bt?(r=e.constructor,o=new r,function(e,t,i){return r.lerp(o,e,t,i),o}):e.constructor===Number?Un:"function"==typeof e.lerp?BO:void 0:void 0},RO=f("cc.animation.UntypedTrackChannel")((l(LO,PO=C2),CO=i((kw=LO).prototype,"property",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gd=kw))||Gd,DO=f("cc.animation.UntypedTrack")((l(NO,AO=E2),(ane=NO.prototype).channels=function(){return this._channels},ane[v2]=function(e){var i=this;if(!e.getValue)throw new Error(oe(3930));function t(t){var e;return null==(e=i._channels.find(function(e){return e.property===t}))?void 0:e.curve}e=e.getValue();switch(!0){default:throw new Error(oe(3931));case e instanceof U:return new W2(t("x"),t("y"));case e instanceof ce:return new q2(t("x"),t("y"),t("z"));case e instanceof Fr:return new X2(t("x"),t("y"),t("z"),t("w"));case e instanceof nr:return new J2(t("r"),t("g"),t("b"),t("a"));case e instanceof Hr:return new tO(t("width"),t("height"))}},ane.addChannel=function(e){var t=new RO;return t.property=e,this._channels.push(t),t},ane.upgrade=function(e){function t(t,e){var i=n.channels().find(function(e){return e.property===t});i&&(e.name=i.name,e.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))}var n=this,i=e(this.path,this.proxy);switch(i){case"vec2":case"vec3":case"vec4":var r=new j2,o=(r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4,r.channels()),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":t("w",l);case"vec3":t("z",c);default:t("x",a),t("y",s)}return r;case"color":var o=new Z2,r=o.channels(),u=r[0],h=r[1],p=r[2],r=r[3];return t("r",u),t("g",h),t("b",p),t("a",r),t("x",u),t("y",h),t("z",p),t("w",r),o}return null},wO=i((a=NO).prototype,"_channels",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),L6=a))||L6,OO=((XN=MO.prototype).getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},XN.toTracks=function(){for(var N,L=[],B=this.keys,e=this.curves,t=this.commonTargets,F=function(e,t,i){for(var n=new b2,r=ge(t);!(o=r()).done;){var o=o.value;"string"==typeof o?n.toProperty(o):"number"==typeof o?n.toElement(o):o instanceof qD?n.toHierarchy(o.path):o instanceof XD?n.toComponent(o.component):n.toCustomized(o)}e.path=n,e.proxy=i},z=t.map(function(e){var t=new DO;return F(t,e.modifiers,e.valueAdapter),L.push(t),t}),i=ge(e);!(N=i()).done;)!function(){var t=N.value,e=t.data,i=e.values;if(0===i.length)return;function n(e){F(e,t.modifiers,t.valueAdapter)}var r,o,a=e.keys<0?[0]:B[e.keys],s=i[0],c=null==(u=e.interpolate)||u,l=(e._arrayLength,new zO(e,a.length)),u=void 0;if("number"==typeof t.commonTarget){if(!i.every(function(e){return"number"==typeof e}))return J(3932);if(t.valueAdapter||1!==t.modifiers.length||"string"!=typeof t.modifiers[0])return J(3933);e=t.modifiers[0],u=z[t.commonTarget].addChannel(e).curve}if("number"==typeof s)i.every(function(e){return"number"==typeof e})?(r=u||(r=new A2,n(r),L.push(r),r.channel.curve),o=c?jp.LINEAR:jp.CONSTANT,r.assignSorted(a,i.map(function(e){return{value:e,interpolationMode:o}})),l.convert(r)):J(3934);else{if("object"==typeof s)switch(!0){case FO(i,U):case FO(i,ce):case FO(i,Fr):var h=s instanceof U?2:s instanceof ce?3:4,p=new j2,_=(n(p),p.componentsCount=h,p.channels()),f=_[0].curve,d=_[1].curve,m=_[2].curve,g=_[3].curve,v=c?jp.LINEAR:jp.CONSTANT,y=function(e){return{value:e,interpolationMode:v}};switch(h){case 4:g.assignSorted(a,i.map(function(e){return y(e.w)})),l.convert(g);case 3:m.assignSorted(a,i.map(function(e){return y(e.z)})),l.convert(m);default:f.assignSorted(a,i.map(function(e){return y(e.x)})),l.convert(f),d.assignSorted(a,i.map(function(e){return y(e.y)})),l.convert(d)}return L.push(p);case FO(i,gr):var _=new Y2,x=(n(_),c?Em.SLERP:Em.CONSTANT);return _.channel.curve.assignSorted(a,i.map(function(e){return{value:gr.clone(e),interpolationMode:x}})),l.convertQuatCurve(_.channel.curve),L.push(_);case FO(i,nr):var h=new Z2,p=(n(h),h.channels()),_=p[0].curve,S=p[1].curve,b=p[2].curve,p=p[3].curve,T=c?jp.LINEAR:jp.CONSTANT,E=function(e){return{value:e,interpolationMode:T}};return _.assignSorted(a,i.map(function(e){return E(e.r)})),l.convert(_),S.assignSorted(a,i.map(function(e){return E(e.g)})),l.convert(S),b.assignSorted(a,i.map(function(e){return E(e.b)})),l.convert(b),p.assignSorted(a,i.map(function(e){return E(e.a)})),l.convert(p),L.push(h);case FO(i,Hr):var _=new eO,S=(n(_),_.channels()),b=S[0].curve,p=S[1].curve,C=c?jp.LINEAR:jp.CONSTANT,w=function(e){return{value:e,interpolationMode:C}};return b.assignSorted(a,i.map(function(e){return w(e.width)})),l.convert(b),p.assignSorted(a,i.map(function(e){return w(e.height)})),l.convert(p),L.push(_);case FO(i,a2):var h=new A2,A=(n(h),c?jp.CUBIC:jp.CONSTANT);return h.channel.curve.assignSorted(a,i.map(function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:A}})),L.push(h);case FO(i,i2):case FO(i,n2):case FO(i,r2):var S=s instanceof i2?2:s instanceof n2?3:4,b=new j2,p=(n(b),b.componentsCount=S,b.channels()),P=p[0],I=p[1],R=p[2],D=p[3],O=c?jp.LINEAR:jp.CONSTANT,M=function(e,t,i){return{value:e,leftTangent:t,rightTangent:i,interpolationMode:O}};switch(S){case 4:D.curve.assignSorted(a,i.map(function(e){return M(e.dataPoint.w,e.inTangent.w,e.outTangent.w)}));case 3:R.curve.assignSorted(a,i.map(function(e){return M(e.dataPoint.z,e.inTangent.z,e.outTangent.z)}));default:P.curve.assignSorted(a,i.map(function(e){return M(e.dataPoint.y,e.inTangent.y,e.outTangent.y)})),I.curve.assignSorted(a,i.map(function(e){return M(e.dataPoint.x,e.inTangent.x,e.outTangent.x)}))}return L.push(b);case i.every(function(e){return e instanceof o2}):J(3935)}r=new iO,n(r),r.channel.curve.assignSorted(a,i),L.push(r)}}();return L},XN._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new gO(e.map(function(e){return e/t._duration}))}),this._runtimeCurves=this._curves.map(function(e){return{curve:new yO(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}})},e(MO,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),MO);function MO(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}function NO(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=AO.call.apply(AO,[this].concat(i))||this,"_channels",wO,p(e)),e}function LO(){var e;return _(e=PO.call(this,new im)||this,"property",CO,p(e)),e}function BO(e,t,i,n){return e.lerp(t,i,n)}function FO(e,t){return e.every(function(e){return e instanceof t})}(s=UO.prototype).convert=function(e){var t,i,n,r,o,a,s=this._easingMethods;if(s){var c=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(s)&&s.length;for(var l=c-1,u=0;u<l;++u){var h=s[u];if(h)if(Array.isArray(h))p=h,f=e.getKeyframeTime(u),t=e.getKeyframeValue(u),a=e.getKeyframeTime(u+1),i=e.getKeyframeValue(u+1),0,n=p[0],o=p[1],r=p[2],p=p[3],_=t.value,a=(1-r)*(r=3*(a-f)),p=(1-p)*(f=3*(i.value-_)),f=(_=o*f)/(o=n*r),n=Math.sqrt(o*o+_*_)*(1/3),r=p/a,o=Math.sqrt(a*a+p*p)*(1/3),t.interpolationMode=jp.CUBIC,t.tangentWeightMode=(_=t.tangentWeightMode)===qp.NONE?qp.RIGHT:_===qp.LEFT?qp.BOTH:_,t.rightTangent=f,t.rightTangentWeight=n,i.tangentWeightMode=(a=i.tangentWeightMode)===qp.NONE?qp.LEFT:a===qp.RIGHT?qp.BOTH:a,i.leftTangent=r,i.leftTangentWeight=o;else{p=void 0;_=void 0;f=void 0;_=void 0;f=void 0;var p=h;var _=e;var f=u;_.keyFramesCount;_=_.getKeyframeValue(f),f=$O[p];f===jd.CONSTANT?_.interpolationMode=jp.CONSTANT:(_.interpolationMode=jp.LINEAR,_.easingMethod=f)}}}}},s.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var i=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var n=i-1,r=0;r<n;++r){var o=t[r];if(o)if(Array.isArray(o))e.getKeyframeValue(r).easingMethod=o.slice();else{a=void 0;s=void 0;c=void 0;s=void 0;c=void 0;var a=o;var s=e;var c=r;s.keyFramesCount;s=s.getKeyframeValue(c),c=$O[a];s.easingMethod=c}}}}},e(UO,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every(function(e){return null==e})}}]);var zO=UO;function UO(e,t){this._easingMethods=void 0;var i=e.easingMethods;Array.isArray(i)?0===i.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(t).fill(e.easingMethod):Array.from({length:t},function(e,t){return null!=(t=i[t])?t:null})}var kO,GO,HO,VO,jO,WO,qO,XO,YO,KO,QO,ZO,JO,$O={constant:jd.CONSTANT,linear:jd.LINEAR,quadIn:jd.QUAD_IN,quadOut:jd.QUAD_OUT,quadInOut:jd.QUAD_IN_OUT,quadOutIn:jd.QUAD_OUT_IN,cubicIn:jd.CUBIC_IN,cubicOut:jd.CUBIC_OUT,cubicInOut:jd.CUBIC_IN_OUT,cubicOutIn:jd.CUBIC_OUT_IN,quartIn:jd.QUART_IN,quartOut:jd.QUART_OUT,quartInOut:jd.QUART_IN_OUT,quartOutIn:jd.QUART_OUT_IN,quintIn:jd.QUINT_IN,quintOut:jd.QUINT_OUT,quintInOut:jd.QUINT_IN_OUT,quintOutIn:jd.QUINT_OUT_IN,sineIn:jd.SINE_IN,sineOut:jd.SINE_OUT,sineInOut:jd.SINE_IN_OUT,sineOutIn:jd.SINE_OUT_IN,expoIn:jd.EXPO_IN,expoOut:jd.EXPO_OUT,expoInOut:jd.EXPO_IN_OUT,expoOutIn:jd.EXPO_OUT_IN,circIn:jd.CIRC_IN,circOut:jd.CIRC_OUT,circInOut:jd.CIRC_IN_OUT,circOutIn:jd.CIRC_OUT_IN,elasticIn:jd.ELASTIC_IN,elasticOut:jd.ELASTIC_OUT,elasticInOut:jd.ELASTIC_IN_OUT,elasticOutIn:jd.ELASTIC_OUT_IN,backIn:jd.BACK_IN,backOut:jd.BACK_OUT,backInOut:jd.BACK_IN_OUT,backOutIn:jd.BACK_OUT_IN,bounceIn:jd.BOUNCE_IN,bounceOut:jd.BOUNCE_OUT,bounceInOut:jd.BOUNCE_IN_OUT,bounceOutIn:jd.BOUNCE_OUT_IN,smooth:jd.SMOOTH,fade:jd.FADE};function eM(){throw new Error("split() only valid in Editor.")}function tM(){_(this,"_nodeAnimations",kO,this)}f("cc.animation.ExoticAnimation")(((y=tM.prototype).createEvaluator=function(e){return new yM(this._nodeAnimations,e)},y.addNodeAnimation=function(e){e=new iM(e);return this._nodeAnimations.push(e),e},y.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map(function(e){return e.path})))},y.split=eM,y.toHashString=function(){return this._nodeAnimations.map(function(e){return e.toHashString()}).join("\n")},kO=i((fie=tM).prototype,"_nodeAnimations",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fie));var iM=f("cc.animation.ExoticNodeAnimation")(((Qp=nM.prototype).createPosition=function(e,t){this._position=new hM(e,new lM(t))},Qp.createRotation=function(e,t){this._rotation=new hM(e,new uM(t))},Qp.createScale=function(e,t){this._scale=new hM(e,new lM(t))},Qp.createEvaluator=function(e){return new xM(this._path,this._position,this._rotation,this._scale,e)},Qp.split=eM,Qp.toHashString=function(){var e;return this._path+"\n"+(null!=(e=null==(e=this._position)?void 0:e.toHashString())?e:"")+(null!=(e=null==(e=this._scale)?void 0:e.toHashString())?e:"")+(null!=(e=null==(e=this._rotation)?void 0:e.toHashString())?e:"")},e(nM,[{key:"path",get:function(){return this._path}}]),GO=i((aie=nM).prototype,"_path",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HO=i(aie.prototype,"_position",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VO=i(aie.prototype,"_rotation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jO=i(aie.prototype,"_scale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nw=aie))||Nw;function nM(e){_(this,"_path",GO,this),_(this,"_position",HO,this),_(this,"_rotation",VO,this),_(this,"_scale",jO,this),this._path=e}function rM(e){return e.toPrecision(2)}function oM(e){return e.map(rM).join(" ")}var aM,sM,cM=f("cc.animation.ExoticVectorLikeTrackValues")(((w=dM.prototype).quantize=function(e){var t,i,n,r,o;this._isQuantized,this._values=(t=this._values,e=bM[e],i=1<<e.BYTES_PER_ELEMENT,n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,t.forEach(function(e){n=Math.min(e,n),r=Math.max(e,r)}),o=r-n,e=e.from(t,function(e){return(e-n)/o*i}),new BM(wM(t),e,o,n)),this._isQuantized=!0},w.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():oM(t))},e(dM,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:wM(this._values)}}]),WO=i((zp=dM).prototype,"_values",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qO=i(zp.prototype,"_isQuantized",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mne=zp))||Mne,lM=f("cc.animation.ExoticVec3TrackValues")((l(fM,sM=cM),fM.imitate=function(e,t){e=new fM(e);return t._isQuantized&&e.quantize(t._values.quantizationType),e},(dU=fM.prototype).get=function(e,t){var i=this._values;this._isQuantized?kM(i,e,t):ce.fromArray(t,i,3*e)},dU.lerp=function(e,t,i,n,r,o){var a=this._values;this._isQuantized?(kM(a,e,n),kM(a,t,r)):(ce.fromArray(n,a,3*e),ce.fromArray(r,a,3*t)),ce.lerp(o,n,r,i)},W3=fM))||W3,uM=f("cc.animation.ExoticQuatTrackValues")((l(_M,aM=cM),_M.imitate=function(e,t){e=new _M(e);return t._isQuantized&&e.quantize(t._values.quantizationType),e},(Iie=_M.prototype).get=function(e,t){var i=this._values;this._isQuantized?GM(i,e,t):gr.fromArray(t,i,4*e)},Iie.lerp=function(e,t,i,n,r,o){var a=this._values;this._isQuantized?(GM(a,e,n),GM(a,t,r)):(gr.fromArray(n,a,4*e),gr.fromArray(r,a,4*t)),gr.slerp(o,n,r,i)},Rie=_M))||Rie,hM=f("cc.animation.ExoticTrack")((pM.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+oM(e)+"; values: "+t.toHashString()},XO=i((x=pM).prototype,"times",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YO=i(x.prototype,"values",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),r=x))||r;function pM(e,t){_(this,"times",XO,this),_(this,"values",YO,this),this.times=e,this.values=t}function _M(){return aM.apply(this,arguments)||this}function fM(){return sM.apply(this,arguments)||this}function dM(e){_(this,"_values",WO,this),_(this,"_isQuantized",qO,this),this._values=e,this._isQuantized=!1}function mM(e,t){e.length,e.length;var i,n=0,r=0,o=lp(e,t);return 0<=o?n=o:(i=e[o=~o],r=(t-(t=e[n=o-1]))/(i-t)),{index:n,ratio:r}}function gM(){this._reset()}(Ce=gM.prototype).transformTime=function(e){return e-this._timeOffset},Ce.calculate=function(e,t,i){this._reset();var n,r,o=e.length;o&&(r=e[0],o=e[o-1],t=Fn(t,r,o),i=Fn(i,r,o),this._timeOffset=t,r=i,i=(o=e).length,t<=r&&t>=o[0]&&o[i-1],i=mM(o,t),e=i.index,i=i.ratio,o=mM(o,r),e=!(r=(t={fromIndex:e,fromRatio:i,toIndex:o.index,toRatio:o.ratio}).fromRatio),o=!(i=t.toRatio),(n=t.fromIndex)!==(t=t.toIndex)||r!==i?(e||(this.preLerpIndex=n,this.preLerpRatio=r),this.directKeyframesBegin=e?n:n+1,this.directKeyframesEnd=t+1,o||(this.postLerpIndex=t,this.postLerpRatio=i)):e?(this.directKeyframesBegin=n,this.directKeyframesEnd=n+1):(this.preLerpIndex=n,this.preLerpRatio=r))},Ce._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},e(gM,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}]);CM.prototype.evaluate=function(t){this._nodeEvaluations.forEach(function(e){e.evaluate(t)})};var vM,yM=CM,xM=(EM.prototype.evaluate=function(e){var t;this._position&&(t=this._position.evaluator.evaluate(e),this._position.runtimeBinding.setValue(t)),this._rotation&&(t=this._rotation.evaluator.evaluate(e),this._rotation.runtimeBinding.setValue(t)),this._scale&&(t=this._scale.evaluator.evaluate(e),this._scale.runtimeBinding.setValue(t))},EM),SM=(TM.prototype.evaluate=function(e){var t=this._times,i=this._values,n=this._resultValue;if(0===t.length)return n;t=t,e=e,r=this._inputSampleResultCache,a=t.length,s=t[0],c=t[a-1],e<s?(r.just=!0,r.index=0):c<e?(r.just=!0,r.index=a-1):0<=(s=lp(t,e))?(r.just=!0,r.index=s):(s=t[a=(c=~s)-1],o=t[c],e=(e-t[a])/(o-s),r.just=!1,r.index=a,r.nextIndex=c,r.ratio=e);var r,o,a,s,c,t=r;return t.just?i.get(t.index,n):i.lerp(t.index,t.nextIndex,t.ratio,this._prevValue,this._nextValue,n),n},TM),bM={uint8:Uint8Array,uint16:Uint16Array};function TM(e,t,i){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}function EM(e,t,i,n,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=UM(t.times,t.values,ce,e,"position",r)),i&&(this._rotation=UM(i.times,i.values,gr,e,"rotation",r)),n&&(this._scale=UM(n.times,n.values,ce,e,"scale",r))}function CM(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map(function(e){return e.createEvaluator(t)})}function wM(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return vM.FLOAT_32;case 8:return vM.FLOAT_64}}(Sa=vM=vM||{})[Sa.FLOAT_32=0]="FLOAT_32",Sa[Sa.FLOAT_64=1]="FLOAT_64";var AM,PM,IM,RM,DM,OM,MM,NM,LM,BM=f("cc.animation.QuantizedFloatArray")((FM.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,i=this.extent,n=this.values;return e+" "+rM(t)+" "+rM(i)+" "+n.join(" ")},e(FM,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),KO=i((R=FM).prototype,"originalPrecision",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QO=i(R.prototype,"min",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZO=i(R.prototype,"extent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),JO=i(R.prototype,"values",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),g=R))||g;function FM(e,t,i,n){void 0===n&&(n=0),_(this,"originalPrecision",KO,this),_(this,"min",QO,this),_(this,"extent",ZO,this),_(this,"values",JO,this),this.originalPrecision=e,this.values=t,this.extent=i,this.min=n}function zM(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function UM(e,t,i,n,r,o){var a=new T2,n=(a.path=(new b2).toHierarchy(n).toProperty(r),o(a));return n?{runtimeBinding:n,evaluator:new SM(e,t,i)}:null}function kM(e,t,i){ce.set(i,zM(e,3*t+0),zM(e,3*t+1),zM(e,3*t+2))}function GM(e,t,i){gr.set(i,zM(e,4*t+0),zM(e,4*t+1),zM(e,4*t+2),zM(e,4*t+3))}var HM,t=Symbol("SearchForRootBonePath"),bp=Symbol("ExoticAnimation"),c=Rre("AnimationClip",f("cc.AnimationClip")((l(VM,HM=P_),VM.createWithSpriteFrames=function(e,t){var i=new VM,n=(i.sample=t||i.sample,i.duration=e.length/i.sample,1/i.sample),t=new iO;return t.path=(new b2).toComponent("cc.Sprite").toProperty("spriteFrame"),t.channels()[0].curve.assignSorted(e.map(function(e,t){return[n*t,e]})),i.addTrack(t),i},(o=VM.prototype).onLoaded=function(){this.frameRate=this.sample,this.events=this._events},o.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,i=t.length,n=0;n<i;++n){var r=t[n].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},o.getTrack=function(e){return this._tracks[e]},o.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},o.removeTrack=function(e){this._tracks.splice(e,1)},o.clearTracks=function(){this._tracks.length=0},o.createEventEvaluator=function(e){return new iN(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},o.createEvaluator=function(t){var i=this,n=t.target;return this._createEvalWithBinder(n,function(e){e=e.createRuntimeBinding(n,i.enableTrsBlending?t.pose:void 0,!1);return null!=e?e:void 0},t.rootMotion)},o.destroy=function(){var e;return null!=(e=j.director.root)&&e.dataPoolManager&&j.director.root.dataPoolManager.releaseAnimationClip(this),dO.destroy(this),HM.prototype.destroy.call(this)},o[fO]=function(e,t,i){for(var n=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:i},function(){return new B})};var c,l=r.reduce(function(e,t){return e[t]=new XM,e},{});for(c in l){var u=l[c],h=c.lastIndexOf("/");0<=h&&(h=c.substring(0,h),(h=l[h])&&(u.parent=h))}for(var p=this._createEvalWithBinder(void 0,function(e){e=e.parseTrsPath();if(e){var t=l[e.node];if(t)return tN(t,e.property)}},void 0),_=0;_<i;++_){p.evaluate(e+n*_);for(var f=0;f<o;++f){var d=r[f];B.copy(a[d].transforms[_],l[d].globalTransform)}for(var m=0;m<o;++m){var g=r[m];l[g].invalidate()}}return{samples:t,frames:i,joints:a}},o.upgradeUntypedTracks=function(e){for(var t=[],i=[],n=this._tracks,r=n.length,o=0;o<r;++o){var a,s=n[o];s instanceof DO&&((a=s.upgrade(e))&&(t.push(a),i.push(s)))}for(var c=i.length,l=0;l<c;++l)mt.remove(n,i[l]);n.push.apply(n,t)},o[t]=function(){return this._searchForRootBonePath()},o.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},o.updateEventDatas=function(){this.events=this._events},o.hasEvents=function(){return 0!==this.events.length},o.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},o._createEvalWithBinder=function(e,t,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var n,r=[];i&&(n=this._createRootMotionEvaluation(e,i,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u,h=s[l];r.includes(h)||Array.from(h.channels()).every(function(e){return 0===e.curve.keyFramesCount})||(u=t(h[S2]))&&(h=h[v2](u),a.push({binding:u,trackEval:h}))}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new WM(a,o,n)},o._createRootMotionEvaluation=function(e,t,i){if(e instanceof N1){var n=this._searchForRootBonePath();if(n){e=e.getChildByPath(n);if(e){for(var r=new qM,o=[],a=this._tracks,s=a.length,c=0;c<s;++c){var l=a[c],u=l[S2].parseTrsPath();u&&u.node===n&&(i.push(l),(u=tN(r,u.property))&&(l=l[v2](u),o.push({binding:u,trackEval:l})))}return new KM(e,this._duration,r,o)}J(3924)}else J(3923)}else ee(3920)},o._searchForRootBonePath=function(){var e=this._tracks.map(function(e){var e=e[S2].parseTrsPath();return e?{path:e=e.node,rank:e.split("/").length}:{path:"",rank:0}}),t=(e.sort(function(e,t){return e.rank-t.rank}),e.findIndex(function(e){return 0!==e.rank}));if(t<0)return"";for(var i=e.length,n=e[t],r=!0,o=t+1;o<i;++o){var a=e[o];if(a.rank!==n.rank)break;if(a.path!==n.path){r=!1;break}}return r?n.path:""},o._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},o._toLegacy=function(){var e=new OO(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},o._fromLegacy=function(e){for(var t=e.toTracks(),i=t.length,n=0;n<i;++n)this.addTrack(t[n])},o._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,i=t.length,n=0;n<i;++n){var r=t[n][S2].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},e(VM,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){if(this._hash)return this._hash;var e="Exotic:"+(null!=(e=null==(e=this._exoticAnimation)?void 0:e.toHashString())?e:"");return this._hash=Gc(e,666)}},{key:"events",get:function(){return this._events},set:function(e){var n=this;this._events=e;for(var r=[],o=[],a=this.events.sort(function(e,t){return e.frame-t.frame}),t=a.length,i=0;i<t;++i)!function(e){var e=a[e],t=e.frame/n._duration,i=r.findIndex(function(e){return e===t});i<0&&(i=r.length,r.push(t),o.push({events:[]})),o[i].events.push({functionName:e.func,parameters:e.params})}(i);this._runtimeEvents={ratios:r,eventGroups:o}}},{key:bp,get:function(){return this._exoticAnimation}},{key:bp,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),VM.WrapMode=tp,AM=i((n=VM).prototype,"sample",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),PM=i(n.prototype,"speed",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IM=i(n.prototype,"wrapMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tp.Normal}}),RM=i(n.prototype,"enableTrsBlending",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DM=i(n.prototype,"_duration",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OM=i(n.prototype,"_hash",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MM=i(n.prototype,"_tracks",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NM=i(n.prototype,"_exoticAnimation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LM=i(n.prototype,"_events",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),I=n))||I);function VM(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=HM.call.apply(HM,[this].concat(i))||this,"sample",AM,p(e)),_(e,"speed",PM,p(e)),_(e,"wrapMode",IM,p(e)),_(e,"enableTrsBlending",RM,p(e)),_(e,"_duration",DM,p(e)),_(e,"_hash",OM,p(e)),e.frameRate=0,_(e,"_tracks",MM,p(e)),_(e,"_exoticAnimation",NM,p(e)),e._legacyData=void 0,e._legacyDataDirty=!1,_(e,"_events",LM,p(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}j.AnimationClip=c;(vie=$M.prototype).evaluate=function(e){for(var t=this._trackEvalStatues,i=this._exoticAnimationEvaluator,n=t.length,r=0;r<n;++r){var o=t[r],a=o.trackEval,o=o.binding,a=a.evaluate(e,o);o.setValue(a)}i&&i.evaluate(e)},vie.evaluateRootMotion=function(e,t){var i=this._rootMotionEvaluation;i&&i.evaluate(e,t)};var jM,WM=$M,qM=(JM.prototype.getTransform=function(e){B.fromRTS(e,this.rotation,this.position,this.scale)},JM),XM=(l(ZM,jM=qM),ZM.prototype.invalidate=function(){this._dirty=!0},e(ZM,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,B.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&B.multiply(e,this.parent.globalTransform,e)),this._transform}}]),ZM),YM=new B,KM=((b=QM.prototype).evaluate=function(e,t){var e=this._calcMotionTransform(e,t,this._motionTransformCache),t=this._translationMotionCache,i=this._rotationMotionCache,n=this._scaleMotionCache,r=this._rootBone;B.toRTS(e,i,t,n),ce.add(t,t,r.position),r.setPosition(t),gr.multiply(i,i,r.rotation),r.setRotation(i),ce.multiply(n,n,r.scale),r.setScale(n)},b._calcMotionTransform=function(e,t,i){var n=this._duration,r=n-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){e=this._evaluateAt(e+t,this._endTransformCache);eN(i,o,e)}else{B.identity(i);var e=function(e,t){eN(YM,e,t),B.multiply(i,i,YM)},t=t-r,a=Math.floor(t/n),r=t-a*n,t=this._evaluateAt(0,this._initialTransformCache),n=this._evaluateAt(n,this._clipEndTransformCache),r=this._evaluateAt(r,this._endTransformCache);e(o,n),eN(YM,t,n);for(var s=0;s<a;++s)B.multiply(i,i,YM);e(t,r)}return i},b._evaluateAt=function(e,t){for(var i=this._trackEvalStatuses,n=i.length,r=0;r<n;++r){var o=i[r],a=o.trackEval,o=o.binding,a=a.evaluate(e,o);o.setValue(a)}return this._boneTransform.getTransform(t),t},QM);function QM(e,t,i,n){this._initialTransformCache=new B,this._clipEndTransformCache=new B,this._startTransformCache=new B,this._endTransformCache=new B,this._motionTransformCache=new B,this._translationMotionCache=new ce,this._rotationMotionCache=new gr,this._scaleMotionCache=new ce,this._rootBone=e,this._duration=t,this._boneTransform=i,this._trackEvalStatuses=n}function ZM(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=jM.call.apply(jM,[this].concat(i))||this).parent=null,e._dirty=!0,e._transform=new B,e}function JM(){this.position=new ce,this.scale=new ce(1,1,1),this.rotation=new gr,this.eulerAngles=new ce}function $M(e,t,i){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=i}function eN(e,t,i){B.invert(e,t),B.multiply(e,i,e)}function tN(t,e){switch(e){default:return;case"position":return{setValue:function(e){ce.copy(t.position,e)}};case"rotation":return{setValue:function(e){gr.copy(t.rotation,e)}};case"scale":return{setValue:function(e){ce.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){ce.copy(t.eulerAngles,e)}}}}(xH=nN.prototype).setWrapMode=function(e){this._wrapMode=e},xH.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;e=oN(e,this._ratios);e<0&&(e=~e-1,t<0&&(e+=1),this._ignoreIndex=e)},xH.sample=function(e,t,i){var n=this._eventGroups.length,r=oN(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=i,void(this._lastDirection=t);var o=this._wrapMode,a=rN(i),s=rN(this._lastIterations),c=this._lastFrameIndex,e=this._lastDirection,l=-1!==s&&a!==s;if(c===r&&l&&1===n)this._doFire(0,!1);else if(c!==r||l){t=e;do{if(c!==r){if(-1===t&&0===c&&0<r?((o&ep.PingPong)===ep.PingPong?t*=-1:c=n,s++):1===t&&c===n-1&&r<n-1&&((o&ep.PingPong)===ep.PingPong?t*=-1:c=-1,s++),c===r)break;if(a<s)break}}while(this._doFire(c+=t,!0),c!==r&&-1<c&&c<n)}this._lastFrameIndex=r,this._lastIterations=i,this._lastDirection=t},xH._doFire=function(e,t){t?j.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},xH._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var i=t[e],n=this._targetNode.components,r=i.events.length,o=0;o<r;++o)for(var a=i.events[o],s=a.functionName,c=n.length,l=0;l<c;++l){var u=n[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}};var iN=nN;function nN(e,t,i,n){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=i,this._wrapMode=n}function rN(e){return e-(0|e)==0&&--e,0|e}function oN(e,t){return lp(t,e)}(uI=lN.prototype).play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(oe(3912)):(this._isPlaying=!0,this.onPlay())},uI.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},uI.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},uI.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},uI.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},uI.update=function(){},uI.onPlay=function(){},uI.onPause=function(){},uI.onResume=function(){},uI.onStop=function(){},uI.onError=function(){},e(lN,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]);var aN,E=lN,sN=((vI=cN.prototype).destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},vI.createPoseWriter=function(e,t,i){e=this._pose.createWriter(e,t,this,i);return this._blendStateWriters.push(e),e},cN);function cN(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}function lN(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}(yI=aN=aN||{}).PLAY="play",yI.STOP="stop",yI.PAUSE="pause",yI.RESUME="resume",yI.LASTFRAME="lastframe",yI.FINISHED="finished",Lt(aN);var uN,hN=Rre("AnimationState",(l(pN,uN=E),(C7=pN.prototype).initialize=function(e,t){var i;this._curveLoaded||(this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e,i=this._clip,this.duration=i.duration,this._invDuration=1/this.duration,this.speed=i.speed,this.wrapMode=i.wrapMode,this.frameRate=i.sample,this._playbackRange.min=0,this._playbackRange.max=i.duration,this._playbackDuration=i.duration,(this.wrapMode&ep.Loop)===ep.Loop?this.repeatCount=1/0:this.repeatCount=1,this._doNotCreateEval||((t=null!=(t=null!=t?t:null==(t=j.director.getAnimationManager())?void 0:t.blendState)?t:null)&&(this._poseOutput=new sN(t)),this._clipEval=i.createEvaluator({target:e,pose:null!=(t=this._poseOutput)?t:void 0})),this._clipEventEval=i.createEventEvaluator(this._targetNode))},C7.destroy=function(){this.isMotionless||j.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},C7.emit=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];j.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},C7.on=function(e,t,i){return this._target&&this._target.isValid?this._target.on(e,t,i):null},C7.once=function(e,t,i){return this._target&&this._target.isValid?this._target.once(e,t,i):null},C7.off=function(e,t,i){this._target&&this._target.isValid&&this._target.off(e,t,i)},C7.allowLastFrameEvent=function(e){this._allowLastFrame=e},C7._setEventTarget=function(e){this._target=e},C7.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,e=this.getWrappedInfo(e,this._wrappedInfo);null!=(t=this._clipEventEval)&&t.ignore(e.ratio,e.direction)},C7.update=function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},C7.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},C7.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(aN.PLAY,this)},C7.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(aN.STOP,this)},C7.onResume=function(){this._onReplayOrResume(),this.emit(aN.RESUME,this)},C7.onPause=function(){this._onPauseOrStop(),this.emit(aN.PAUSE,this)},C7._sampleCurves=function(e){var t=this._poseOutput,i=this._clipEval;t&&(t.weight=this.weight),i&&i.evaluate(e)},C7._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},C7.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo||(this._lastWrapInfo=new sp(t)),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit(aN.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(aN.FINISHED,this))},C7.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,i=this.time%t,t=(i<0&&(i+=t),(e+i)*this._invDuration);this._sampleCurves(e+i),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=t),(0<this.time&&this._lastIterations>t||this.time<0&&this._lastIterations<t)&&this.emit(aN.LASTFRAME,this),this._lastIterations=t)},C7._needReverse=function(e){var t=this.wrapMode,i=!1;return(t&ep.PingPong)===ep.PingPong&&(e-(0|e)==0&&0<e&&--e,1&e&&(i=!i)),i=(t&ep.Reverse)===ep.Reverse?!i:i},C7.getWrappedInfo=function(e,t){t=t||new sp;var i=this._getPlaybackStart(),n=this._getPlaybackEnd()-i,r=!1,o=this.repeatCount,a=0<(e-=i)?e/n:-e/n,o=(o<=a&&(r=!0,e=(o=0===(o=(a=o)-(0|o))?1:o)*n*(0<e?1:-1)),n<e?e=0==(o=e%n)?n:o:e<0&&0!=(e%=n)&&(e+=n),!1),s=this._wrapMode&ep.ShouldWrap,c=(o=s?this._needReverse(a):o)?-1:1;return this.speed<0&&(c*=-1),t.time=i+(e=s&&o?n-e:e),t.ratio=t.time/this.duration,t.direction=c,t.stopped=r,t.iterations=a,t},C7._getPlaybackStart=function(){return this._playbackRange.min},C7._getPlaybackEnd=function(){return this._playbackRange.max},C7._sampleEvents=function(e){var t;null!=(t=this._clipEventEval)&&t.sample(e.ratio,e.direction,e.iterations)},C7._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},C7._onReplayOrResume=function(){j.director.getAnimationManager().addAnimation(this)},C7._onPauseOrStop=function(){j.director.getAnimationManager().removeAnimation(this)},e(pN,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&ep.Loop?this.repeatCount=1/0:this.repeatCount=1,null!=(t=this._clipEventEval)&&t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&ep.ShouldWrap,i=(this.wrapMode&ep.Reverse)===ep.Reverse;this._useSimpleProcess=e===1/0&&!t&&!i}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),pN));function pN(e,t){var i;return void 0===t&&(t=""),(i=uN.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=tp.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new sp,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=0,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=t||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||fe("Clip "+e.name+" has zero duration."),i}j.AnimationState=hN;l(SN,gN=E),(Nk=SN.prototype).update=function(e){var t,i,n;this.isMotionless||(t=this._managedStates,i=this._fadings,1===t.length&&1===i.length?(n=t[0].state)&&(n.weight=1):this._calculateWeights(e),1===t.length&&1===i.length&&this._unscheduleThis())},Nk.crossFade=function(t,e){0===(e=0===this._managedStates.length?0:e)&&this.clear();var i,n=this._managedStates.find(function(e){return e.state===t});n?null!=(i=n.state)&&i.isMotionless&&n.state.play():(n={state:t,reference:0},t&&t.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:n}),this.isMotionless||this._scheduleThis()},Nk.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},Nk.onPlay=function(){gN.prototype.onPlay.call(this),this._scheduleThis()},Nk.onPause=function(){gN.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.pause()}this._unscheduleThis()},Nk.onResume=function(){gN.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.resume()}this._scheduleThis()},Nk.onStop=function(){gN.prototype.onStop.call(this),this.clear()},Nk._calculateWeights=function(e){for(var t=this._managedStates,i=this._fadings,n=0;n<t.length;++n){var r=t[n].state;r&&(r.weight=0)}for(var o=1,a=i.length,s=0;s<i.length;++s){var c=i[s],l=(c.easeTime+=e,0===c.easeDuration?1:zn(c.easeTime/c.easeDuration)),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==i.length){for(var h=a;h<i.length;++h){var p=i[h];--p.target.reference,p.target.reference<=0&&(p.target.state&&p.target.state.stop(),be(this._managedStates,p.target))}i.splice(a)}},Nk._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},Nk._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)};var _N,fN,dN,mN,gN,vN=SN,yN=(A=f("cc.Animation"),yU=wp(),kd=Oa(99),Z5=Ep(),pF=v([c]),Y3=u(),EW=v(c),P=u(),bne=u(),Up=v([c]),B1=A(YD=yU(YD=kd(YD=Tp(YD=Z5((l(xN,mN=Gi(W_)),(C=xN.prototype).onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},C.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},C.onEnable=function(){this._crossFade.resume()},C.onDisable=function(){this._crossFade.pause()},C.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=Ge(!0)},C.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},C.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;e=this._nameToState[e];e&&this.doPlayOrCrossFade(e,t)},C.pause=function(){this._crossFade.pause()},C.resume=function(){this._crossFade.resume()},C.stop=function(){this._crossFade.stop()},C.getAnimationState=function(e){return this.getState(e)},C.getState=function(e){e=this._nameToState[e];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},C.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},C.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},C.addClip=function(e,t){return Te(this._clips,e)||this._clips.push(e),this.createState(e,t)},C.removeClip=function(t,e){var i,n;for(n in this._nameToState){var r=this._nameToState[n];if(r.clip===t){i=r;break}}if(t===this._defaultClip){if(!e)return void J(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void J(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]},C.on=function(e,t,i,n){t=mN.prototype.on.call(this,e,t,i,n);return e===aN.LASTFRAME&&this._syncAllowLastFrameEvent(),t},C.once=function(e,t,i){t=mN.prototype.once.call(this,e,t,i);return e===aN.LASTFRAME&&this._syncAllowLastFrameEvent(),t},C.off=function(e,t,i){mN.prototype.off.call(this,e,t,i),e===aN.LASTFRAME&&this._syncDisallowLastFrameEvent()},C._createState=function(e,t){return new hN(e,t)},C._doCreateState=function(e,t){e=this._createState(e,t);return e._setEventTarget(this),e.allowLastFrameEvent(this.hasEventListener(aN.LASTFRAME)),this.node&&e.initialize(this.node),this._nameToState[e.name]=e},C.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},C._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var i=this._nameToState[t];bN(e,i.clip)&&(i.stop(),delete this._nameToState[t])}},C._syncAllowLastFrameEvent=function(){if(this.hasEventListener(aN.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},C._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(aN.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},e(xN,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var i=ge(this._clips);!(n=i()).done;){var n=n.value;n&&this._removeStateOfAutomaticClip(n)}for(var r=ge(e);!(o=r()).done;){var o=o.value;o&&this.createState(o)}var a=e.find(function(e){return bN(e,t._defaultClip)});this._defaultClip=a||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){!(this._defaultClip=t)||0<=this._clips.findIndex(function(e){return bN(e,t)})||(this._clips.push(t),this.createState(t))}}]),xN.EventType=aN,i((h=xN).prototype,"clips",[pF,Y3],Object.getOwnPropertyDescriptor(h.prototype,"clips"),h.prototype),i(h.prototype,"defaultClip",[EW,P],Object.getOwnPropertyDescriptor(h.prototype,"defaultClip"),h.prototype),_N=i(h.prototype,"playOnLoad",[d,bne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fN=i(h.prototype,"_clips",[Up],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dN=i(h.prototype,"_defaultClip",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YD=h))||YD)||YD)||YD)||YD)||YD,Rre({AnimationComponent:B1,Animation:B1}),B1);function xN(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=mN.call.apply(mN,[this].concat(i))||this,"playOnLoad",_N,p(e)),e._crossFade=new vN,e._nameToState=Ge(!0),_(e,"_clips",fN,p(e)),_(e,"_defaultClip",dN,p(e)),e._hasBeenPlayed=!1,e}function SN(e){var t;return(t=gN.call(this)||this)._managedStates=[],t._fadings=[],t._scheduled=!1,t._scheduler=null!=e?e:j.director.getAnimationManager(),t}function bN(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}In(yN.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){return yN.prototype.removeState.call(this,(arguments.length<=0?void 0:arguments[0]).name)}}]),j.AnimationComponent=yN,gt.setClassAlias(yN,"cc.AnimationComponent");function TN(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e}(Hd=FN.prototype).createWriter=function(e,t,i,n){var r=this.ref(e,t);return new AN(e,t,r,i,n)},Hd.destroyWriter=function(e){this.deRef(e.node,e.property)},Hd.ref=function(e,t){var i=this._nodeBlendStates.get(e);return i||(i=new RN,this._nodeBlendStates.set(e,i)),i.refProperty(t)},Hd.deRef=function(e,t){var i=this._nodeBlendStates.get(e);i&&(i.deRefProperty(t),i.empty&&this._nodeBlendStates.delete(e))},Hd.apply=function(){this._nodeBlendStates.forEach(function(e,t){e.apply(t)})};var EN,CN,wN=FN,AN=((S=BN.prototype).getValue=function(){return this._node[this._property]},S.setValue=function(e){var t=this._propertyBlendState,i=this._host.weight;t.blend(e,i)},e(BN,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),BN),PN=(l(LN,CN=TN),(kw=LN.prototype).blend=function(e,t){var i=this.blendedValue;1===t?ce.copy(i,e):ce.scaleAndAdd(i,i,e,t),this.blendedWeight+=t},kw.reset=function(){this.blendedWeight=0,ce.zero(this.blendedValue)},LN),IN=(l(NN,EN=TN),(Gd=NN.prototype).blend=function(e,t){var i,n;0!==t&&(i=this.blendedValue,n=this.blendedWeight,1===t?gr.copy(i,e):gr.slerp(i,i,e,t/(n+t)),this.blendedWeight+=t)},Gd.reset=function(){this.blendedWeight=0,gr.identity(this.blendedValue)},NN),RN=((E2=MN.prototype).refProperty=function(e){var t,i,n=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!=(t=n[e])?t:n[e]=new PN;break;case"rotation":i=null!=(t=n[e])?t:n[e]=new IN}return++i.refCount,i},E2.deRefProperty=function(e){var t=this._properties,i=t[e];i&&(--i.refCount,0<i.refCount||delete t[e])},E2.apply=function(e){var t,i,n,r=this._properties,o=r.position,a=r.scale,s=r.rotation,r=r.eulerAngles,c=!1,l=!1,u=!1,h=!1;o&&o.blendedWeight&&(c=!0,o.blendedWeight<1&&o.blend(e.position,1-o.blendedWeight),t=o.blendedValue),a&&a.blendedWeight&&(l=!0,a.blendedWeight<1&&a.blend(e.scale,1-a.blendedWeight),i=a.blendedValue),r&&r.blendedWeight&&(h=!0,r.blendedWeight<1&&r.blend(e.eulerAngles,1-r.blendedWeight),n=r.blendedValue),s&&s.blendedWeight&&(u=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),n=s.blendedValue),(n||t||i)&&e.setRTS(n,t,i),c&&o.reset(),l&&a.reset(),u&&s.reset(),h&&r.reset()},e(MN,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),MN),DN=[],ON=new Map;function MN(){this._properties={}}function NN(){return EN.call(this,new gr)||this}function LN(){return CN.call(this,new ce)||this}function BN(e,t,i,n,r){this._node=e,this._property=t,this._propertyBlendState=i,this._host=n,this._constants=r}function FN(){this._nodeBlendStates=new Map}function zN(e,t){for(var i=0,n=B.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,e=(DN[i++]=e).parent}for(;0<i;){e=DN[--i],DN[i]=null;var r=e.node;B.fromRTS(e.local,r.rotation,r.position,r.scale),n=B.multiply(e.world,n,e.local)}return n}function UN(e,t){for(var i,n=null,r=0;e!==t;){var o=e.uuid;if(ON.has(o)){n=ON.get(o);break}n={node:e,local:new B,world:new B,stamp:-1,parent:null},ON.set(o,n),DN[r++]=n,e=e.parent,n=null}for(;0<r;)i=DN[--r],DN[r]=null,i.parent=n,n=i;return n}function kN(e){for(var t=ON.get(e.uuid)||null;t;)ON.delete(t.node.uuid),t=t.parent}var GN,HN=Rre("AnimationManager",f((l(VN,GN=PP),(ane=VN.prototype).addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},ane.removeCrossFade=function(e){e=this._crossFades.array.indexOf(e);0<=e?this._crossFades.fastRemoveAt(e):ee(3907)},ane.update=function(e){var t=this._delayEvents,i=this._crossFades,n=this._sockets,r=i.array;for(i.i=0;i.i<r.length;++i.i)r[i.i].update(e);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=j.director.getTotalFrames(),l=0,u=n.length;l<u;l++){var h=n[l],p=h.target,h=h.transform;p.matrix=zN(h,c)}for(var _=0,f=t.length;_<f;_++){var d=t[_];d.fn.apply(d.thisArg,d.args)}t.length=0},ane.destruct=function(){},ane.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},ane.removeAnimation=function(e){e=this._anims.array.indexOf(e);0<=e?this._anims.fastRemoveAt(e):ee(3907)},ane.pushDelayEvent=function(e,t,i){this._delayEvents.push({fn:e,thisArg:t,args:i})},ane.addSockets=function(i,n){for(var r=this,e=0;e<n.length;++e)!function(e){var t=n[e];if(r._sockets.find(function(e){return e.target===t.target}))return;e=i.getChildByPath(t.path),e=t.target&&e&&UN(e,i);e&&r._sockets.push({target:t.target,transform:e})}(e)},ane.removeSockets=function(e,t){for(var i=0;i<t.length;++i)for(var n=t[i],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===n.target){kN(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},e(VN,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),VN.ID="animation",a=VN))||a);function VN(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=GN.call.apply(GN,[this].concat(i))||this)._anims=new ve([]),e._crossFades=new ve([]),e._delayEvents=[],e._blendStateBuffer=new wN,e._sockets=[],e}ZP.on(KP.EVENT_INIT,function(){var e=new HN;ZP.registerSystem(HN.ID,e,PP.Priority.HIGH)}),j.AnimationManager=HN;var jN=new B;function WN(e,t,i){for(B.identity(i);e!==t;)B.fromRTS(jN,e.rotation,e.position,e.scale),B.multiply(i,jN,i),e=e.parent;return i}j.easing=Wd;var qN,XN=Rre("HierachyModifier",f("cc.HierachyModifier")((l(YN,qN=qD),L6=YN))||L6);function YN(){return qN.apply(this,arguments)||this}j.HierachyModifier=XN;var KN,y=Rre("ComponentModifier",f("cc.ComponentModifier")((l(QN,KN=XD),s=QN))||s);function QN(){return KN.apply(this,arguments)||this}j.ComponentModifier=y;Qp=Rre("CurveValueAdapter",f("cc.CurveValueAdapter")((ZN.prototype.forTarget=function(){return{set:function(){}}},fie=ZN))||fie);function ZN(){}j.CurveValueAdapter=Qp;var JN,Nw=Rre("UniformCurveValueAdapter",f("cc.UniformCurveValueAdapter")((l($N,JN=ba),aie=$N))||aie);function $N(){return JN.apply(this,arguments)||this}function eL(e){return"string"==typeof e}function tL(e){return"number"==typeof e}function iL(e,t){return e instanceof t}j.UniformCurveValueAdapter=Nw,j.isPropertyModifier=eL,j.isElementModifier=tL,j.isCustomTargetModifier=iL,j.math=pi,j.geometry=Cp;zp=Rre("NodePool",((w=nL.prototype).size=function(){return this._pool.length},w.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},w.put=function(e){var t;e&&-1===this._pool.indexOf(e)&&(e.removeFromParent(),(t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null)&&t.unuse&&t.unuse(),this._pool.push(e))},w.get=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=this._pool.length-1;if(n<0)return null;var r=this._pool[n],n=(this._pool.length=n,this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null);return n&&n.reuse&&n.reuse(arguments),r},nL));function nL(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}j.NodePool=zp,j.renderer=Xp;l(sL,oL=il),(Mne=sL.prototype).initialize=function(e){this._layout=e.layout;var e=e.layout.gpuDescriptorSetLayout,t=e.bindings,i=e.descriptorIndices,e=e.descriptorCount,n=(this._buffers=Array(e).fill(null),this._textures=Array(e).fill(null),this._samplers=Array(e).fill(null),[]);this._gpuDescriptorSet={gpuDescriptors:n,descriptorIndices:i};for(var r=0;r<t.length;++r)for(var o=t[r],a=0;a<o.count;a++)n.push({type:o.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},Mne.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},Mne.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e,t=this._gpuDescriptorSet.gpuDescriptors,i=0;i<t.length;++i)t[i].type&mc?(e=this._buffers[i])&&(t[i].gpuBuffer=e.gpuBuffer||e.gpuBufferView):t[i].type&gc&&(this._textures[i]&&(t[i].gpuTexture=this._textures[i].gpuTexture),this._samplers[i]&&(t[i].gpuSampler=this._samplers[i].gpuSampler));this._isDirty=!1}},e(sL,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]);var rL,oL,aL=sL;function sL(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=oL.call.apply(oL,[this].concat(i))||this)._gpuDescriptorSet=null,e}(dU=rL=rL||{})[dU.RGBA16F_EXT=34842]="RGBA16F_EXT",dU[dU.RGB16F_EXT=34843]="RGB16F_EXT",dU[dU.RGBA32F_EXT=34836]="RGBA32F_EXT",dU[dU.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",dU[dU.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",dU[dU.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",dU[dU.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",dU[dU.SRGB_EXT=35904]="SRGB_EXT",dU[dU.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",dU[dU.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",dU[dU.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",dU[dU.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",dU[dU.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",dU[dU.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",dU[dU.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",dU[dU.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",dU[dU.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",dU[dU.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",dU[dU.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",dU[dU.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",dU[dU.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",dU[dU.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",dU[dU.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",dU[dU.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",dU[dU.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",dU[dU.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",dU[dU.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",dU[dU.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",dU[dU.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",dU[dU.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",dU[dU.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",dU[dU.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",dU[dU.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",dU[dU.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",dU[dU.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",dU[dU.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",dU[dU.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",dU[dU.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",dU[dU.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",dU[dU.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",dU[dU.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",dU[dU.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",dU[dU.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",dU[dU.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",dU[dU.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",dU[dU.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",dU[dU.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",dU[dU.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR";lL.setInstance=function(e){lL._instance=e},e(lL,null,[{key:"instance",get:function(){return lL._instance}}]);var cL=lL;function lL(){}function uL(e,t){switch(e){case W.R8:return t.UNSIGNED_BYTE;case W.R8SN:return t.BYTE;case W.R8UI:return t.UNSIGNED_BYTE;case W.R8I:return t.BYTE;case W.R16F:return rL.HALF_FLOAT_OES;case W.R16UI:return t.UNSIGNED_SHORT;case W.R16I:return t.SHORT;case W.R32F:return t.FLOAT;case W.R32UI:return t.UNSIGNED_INT;case W.R32I:return t.INT;case W.RG8:return t.UNSIGNED_BYTE;case W.RG8SN:return t.BYTE;case W.RG8UI:return t.UNSIGNED_BYTE;case W.RG8I:return t.BYTE;case W.RG16F:return rL.HALF_FLOAT_OES;case W.RG16UI:return t.UNSIGNED_SHORT;case W.RG16I:return t.SHORT;case W.RG32F:return t.FLOAT;case W.RG32UI:return t.UNSIGNED_INT;case W.RG32I:return t.INT;case W.RGB8:case W.SRGB8:return t.UNSIGNED_BYTE;case W.RGB8SN:return t.BYTE;case W.RGB8UI:return t.UNSIGNED_BYTE;case W.RGB8I:return t.BYTE;case W.RGB16F:return rL.HALF_FLOAT_OES;case W.RGB16UI:return t.UNSIGNED_SHORT;case W.RGB16I:return t.SHORT;case W.RGB32F:return t.FLOAT;case W.RGB32UI:return t.UNSIGNED_INT;case W.RGB32I:return t.INT;case W.BGRA8:case W.RGBA8:case W.SRGB8_A8:return t.UNSIGNED_BYTE;case W.RGBA8SN:return t.BYTE;case W.RGBA8UI:return t.UNSIGNED_BYTE;case W.RGBA8I:return t.BYTE;case W.RGBA16F:return rL.HALF_FLOAT_OES;case W.RGBA16UI:return t.UNSIGNED_SHORT;case W.RGBA16I:return t.SHORT;case W.RGBA32F:return t.FLOAT;case W.RGBA32UI:return t.UNSIGNED_INT;case W.RGBA32I:return t.INT;case W.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case W.R11G11B10F:return t.FLOAT;case W.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case W.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case W.RGB10A2:return t.UNSIGNED_BYTE;case W.RGB10A2UI:return t.UNSIGNED_INT;case W.RGB9E5:return t.UNSIGNED_BYTE;case W.DEPTH:return t.UNSIGNED_INT;case W.DEPTH_STENCIL:return rL.UNSIGNED_INT_24_8_WEBGL;case W.BC1:case W.BC1_SRGB:case W.BC2:case W.BC2_SRGB:case W.BC3:case W.BC3_SRGB:case W.BC4:return t.UNSIGNED_BYTE;case W.BC4_SNORM:return t.BYTE;case W.BC5:return t.UNSIGNED_BYTE;case W.BC5_SNORM:return t.BYTE;case W.BC6H_SF16:case W.BC6H_UF16:return t.FLOAT;case W.BC7:case W.BC7_SRGB:case W.ETC_RGB8:case W.ETC2_RGB8:case W.ETC2_SRGB8:case W.ETC2_RGB8_A1:case W.ETC2_SRGB8_A1:case W.EAC_R11:return t.UNSIGNED_BYTE;case W.EAC_R11SN:return t.BYTE;case W.EAC_RG11:return t.UNSIGNED_BYTE;case W.EAC_RG11SN:return t.BYTE;case W.PVRTC_RGB2:case W.PVRTC_RGBA2:case W.PVRTC_RGB4:case W.PVRTC_RGBA4:case W.PVRTC2_2BPP:case W.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case W.ASTC_RGBA_4X4:case W.ASTC_RGBA_5X4:case W.ASTC_RGBA_5X5:case W.ASTC_RGBA_6X5:case W.ASTC_RGBA_6X6:case W.ASTC_RGBA_8X5:case W.ASTC_RGBA_8X6:case W.ASTC_RGBA_8X8:case W.ASTC_RGBA_10X5:case W.ASTC_RGBA_10X6:case W.ASTC_RGBA_10X8:case W.ASTC_RGBA_10X10:case W.ASTC_RGBA_12X10:case W.ASTC_RGBA_12X12:case W.ASTC_SRGBA_4X4:case W.ASTC_SRGBA_5X4:case W.ASTC_SRGBA_5X5:case W.ASTC_SRGBA_6X5:case W.ASTC_SRGBA_6X6:case W.ASTC_SRGBA_8X5:case W.ASTC_SRGBA_8X6:case W.ASTC_SRGBA_8X8:case W.ASTC_SRGBA_10X5:case W.ASTC_SRGBA_10X6:case W.ASTC_SRGBA_10X8:case W.ASTC_SRGBA_10X10:case W.ASTC_SRGBA_12X10:case W.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function hL(e,t){switch(e){case Ro.BOOL:return t.BOOL;case Ro.BOOL2:return t.BOOL_VEC2;case Ro.BOOL3:return t.BOOL_VEC3;case Ro.BOOL4:return t.BOOL_VEC4;case Ro.INT:return t.INT;case Ro.INT2:return t.INT_VEC2;case Ro.INT3:return t.INT_VEC3;case Ro.INT4:return t.INT_VEC4;case Ro.UINT:return t.UNSIGNED_INT;case Ro.FLOAT:return t.FLOAT;case Ro.FLOAT2:return t.FLOAT_VEC2;case Ro.FLOAT3:return t.FLOAT_VEC3;case Ro.FLOAT4:return t.FLOAT_VEC4;case Ro.MAT2:return t.FLOAT_MAT2;case Ro.MAT3:return t.FLOAT_MAT3;case Ro.MAT4:return t.FLOAT_MAT4;case Ro.SAMPLER2D:return t.SAMPLER_2D;case Ro.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ro.UNKNOWN}}function pL(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}cL._instance=null;function _L(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e}var fL,dL,mL,gL,vL,yL,xL=[512,513,514,515,516,517,518,519],SL=[0,7680,7681,7682,7683,5386,34055,34056],bL=[32774,32778,32779,32775,32776],TL=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772],EL=((W3=fL=fL||{})[W3.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",W3[W3.END_RENDER_PASS=1]="END_RENDER_PASS",W3[W3.BIND_STATES=2]="BIND_STATES",W3[W3.DRAW=3]="DRAW",W3[W3.UPDATE_BUFFER=4]="UPDATE_BUFFER",W3[W3.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",W3[W3.COUNT=6]="COUNT",l(LL,yL=_L),LL.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},LL),CL=(l(NL,vL=_L),NL.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},NL),wL=(l(ML,gL=_L),ML.prototype.clear=function(){},ML),AL=(l(OL,mL=_L),OL.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},OL),PL=(l(DL,dL=_L),DL.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},DL),IL=(RL.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},RL);function RL(){this.cmds=new Ct(1),this.beginRenderPassCmds=new Ct(1),this.bindStatesCmds=new Ct(1),this.drawCmds=new Ct(1),this.updateBufferCmds=new Ct(1),this.copyBufferToTextureCmds=new Ct(1)}function DL(){var e;return(e=dL.call(this,fL.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}function OL(){var e;return(e=mL.call(this,fL.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}function ML(){var e;return(e=gL.call(this,fL.DRAW)||this).drawInfo=new Da,e}function NL(){var e;return(e=vL.call(this,fL.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new ps,e}function LL(){var e;return(e=yL.call(this,fL.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new va,e.clearFlag=la.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}function BL(e,t,i,n,r){if(t.usage&Do.UNIFORM)ArrayBuffer.isView(i)?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Do.INDIRECT){t.indirects.clearDraws();for(var o=i.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(n+a,o[a])}else{var s=e.gl,c=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.extensions.useVAO&&c.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),c.glVAO=null),FL.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&c.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),c.glVAO=null),FL.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return console.error("Unsupported BufferType, update buffer failed.")}r===i.byteLength?s.bufferSubData(t.glTarget,n,i):s.bufferSubData(t.glTarget,n,i.slice(0,r))}}var FL={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function zL(e,t,i,n,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(i&&t){c.glFramebuffer!==i.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,i.glFramebuffer),c.glFramebuffer=i.glFramebuffer),c.viewport.left===n.x&&c.viewport.top===n.y&&c.viewport.width===n.width&&c.viewport.height===n.height||(s.viewport(n.x,n.y,n.width,n.height),c.viewport.left=n.x,c.viewport.top=n.y,c.viewport.width=n.width,c.viewport.height=n.height),c.scissorRect.x===n.x&&c.scissorRect.y===n.y&&c.scissorRect.width===n.width&&c.scissorRect.height===n.height||(s.scissor(n.x,n.y,n.width,n.height),c.scissorRect.x=n.x,c.scissorRect.y=n.y,c.scissorRect.width=n.width,c.scissorRect.height=n.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h,p=0;p<u;++p){var _=t.colorAttachments[p];if(_.format!==W.UNKNOWN)switch(_.loadOp){case Yo.LOAD:break;case Yo.CLEAR:c.bs.targets[0].blendColorMask!==qo.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Yo.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==W.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Yo.LOAD:break;case Yo.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Yo.DISCARD:}if(dc[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Yo.LOAD:break;case Yo.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Yo.DISCARD:}}l&&s.clear(l),l&s.COLOR_BUFFER_BIT&&(i=c.bs.targets[0].blendColorMask)!==qo.ALL&&(n=(i&qo.R)!==qo.NONE,e=(i&qo.G)!==qo.NONE,h=(i&qo.B)!==qo.NONE,i=(i&qo.A)!==qo.NONE,s.colorMask(n,e,h,i)),l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function UL(e,t,i,B,F,n){var r,o=e.gl,a=e.stateCache,s=t&&t.gpuShader,c=!1;if(t&&FL.gpuPipelineState!==t){FL.gpuPipelineState=t,FL.glPrimitive=t.glPrimitive,t.gpuShader&&(l=t.gpuShader.glProgram,a.glProgram!==l&&(o.useProgram(l),a.glProgram=l,c=!0));var l=t.rs;if(l){if(a.rs.cullMode!==l.cullMode){switch(l.cullMode){case ia.NONE:o.disable(o.CULL_FACE);break;case ia.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case ia.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}a.rs.cullMode=l.cullMode}var u=l.isFrontFaceCCW;a.rs.isFrontFaceCCW!==u&&(o.frontFace(u?o.CCW:o.CW),a.rs.isFrontFaceCCW=u),a.rs.depthBias===l.depthBias&&a.rs.depthBiasSlop===l.depthBiasSlop||(o.polygonOffset(l.depthBias,l.depthBiasSlop),a.rs.depthBias=l.depthBias,a.rs.depthBiasSlop=l.depthBiasSlop),a.rs.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),a.rs.lineWidth=l.lineWidth)}var u=t.dss,l=(u&&(a.dss.depthTest!==u.depthTest&&(u.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),a.dss.depthTest=u.depthTest),a.dss.depthWrite!==u.depthWrite&&(o.depthMask(u.depthWrite),a.dss.depthWrite=u.depthWrite),a.dss.depthFunc!==u.depthFunc&&(o.depthFunc(xL[u.depthFunc]),a.dss.depthFunc=u.depthFunc),a.dss.stencilTestFront===u.stencilTestFront&&a.dss.stencilTestBack===u.stencilTestBack||(u.stencilTestFront||u.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),a.dss.stencilTestFront=u.stencilTestFront,a.dss.stencilTestBack=u.stencilTestBack),a.dss.stencilFuncFront===u.stencilFuncFront&&a.dss.stencilRefFront===u.stencilRefFront&&a.dss.stencilReadMaskFront===u.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,xL[u.stencilFuncFront],u.stencilRefFront,u.stencilReadMaskFront),a.dss.stencilFuncFront=u.stencilFuncFront,a.dss.stencilRefFront=u.stencilRefFront,a.dss.stencilReadMaskFront=u.stencilReadMaskFront),a.dss.stencilFailOpFront===u.stencilFailOpFront&&a.dss.stencilZFailOpFront===u.stencilZFailOpFront&&a.dss.stencilPassOpFront===u.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,SL[u.stencilFailOpFront],SL[u.stencilZFailOpFront],SL[u.stencilPassOpFront]),a.dss.stencilFailOpFront=u.stencilFailOpFront,a.dss.stencilZFailOpFront=u.stencilZFailOpFront,a.dss.stencilPassOpFront=u.stencilPassOpFront),a.dss.stencilWriteMaskFront!==u.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,u.stencilWriteMaskFront),a.dss.stencilWriteMaskFront=u.stencilWriteMaskFront),a.dss.stencilFuncBack===u.stencilFuncBack&&a.dss.stencilRefBack===u.stencilRefBack&&a.dss.stencilReadMaskBack===u.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,xL[u.stencilFuncBack],u.stencilRefBack,u.stencilReadMaskBack),a.dss.stencilFuncBack=u.stencilFuncBack,a.dss.stencilRefBack=u.stencilRefBack,a.dss.stencilReadMaskBack=u.stencilReadMaskBack),a.dss.stencilFailOpBack===u.stencilFailOpBack&&a.dss.stencilZFailOpBack===u.stencilZFailOpBack&&a.dss.stencilPassOpBack===u.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,SL[u.stencilFailOpBack],SL[u.stencilZFailOpBack],SL[u.stencilPassOpBack]),a.dss.stencilFailOpBack=u.stencilFailOpBack,a.dss.stencilZFailOpBack=u.stencilZFailOpBack,a.dss.stencilPassOpBack=u.stencilPassOpBack),a.dss.stencilWriteMaskBack!==u.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,u.stencilWriteMaskBack),a.dss.stencilWriteMaskBack=u.stencilWriteMaskBack)),t.bs);l&&(a.bs.isA2C!==l.isA2C&&(l.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),a.bs.isA2C=l.isA2C),a.bs.blendColor.x===l.blendColor.x&&a.bs.blendColor.y===l.blendColor.y&&a.bs.blendColor.z===l.blendColor.z&&a.bs.blendColor.w===l.blendColor.w||(o.blendColor(l.blendColor.x,l.blendColor.y,l.blendColor.z,l.blendColor.w),a.bs.blendColor.x=l.blendColor.x,a.bs.blendColor.y=l.blendColor.y,a.bs.blendColor.z=l.blendColor.z,a.bs.blendColor.w=l.blendColor.w),u=l.targets[0],(l=a.bs.targets[0]).blend!==u.blend&&(u.blend?o.enable(o.BLEND):o.disable(o.BLEND),l.blend=u.blend),l.blendEq===u.blendEq&&l.blendAlphaEq===u.blendAlphaEq||(o.blendEquationSeparate(bL[u.blendEq],bL[u.blendAlphaEq]),l.blendEq=u.blendEq,l.blendAlphaEq=u.blendAlphaEq),l.blendSrc===u.blendSrc&&l.blendDst===u.blendDst&&l.blendSrcAlpha===u.blendSrcAlpha&&l.blendDstAlpha===u.blendDstAlpha||(o.blendFuncSeparate(TL[u.blendSrc],TL[u.blendDst],TL[u.blendSrcAlpha],TL[u.blendDstAlpha]),l.blendSrc=u.blendSrc,l.blendDst=u.blendDst,l.blendSrcAlpha=u.blendSrcAlpha,l.blendDstAlpha=u.blendDstAlpha),l.blendColorMask!==u.blendColorMask&&(o.colorMask((u.blendColorMask&qo.R)!==qo.NONE,(u.blendColorMask&qo.G)!==qo.NONE,(u.blendColorMask&qo.B)!==qo.NONE,(u.blendColorMask&qo.A)!==qo.NONE),l.blendColorMask=u.blendColorMask))}if(t&&t.gpuPipelineLayout&&s){for(var z=s.glBlocks.length,U=t.gpuPipelineLayout.dynamicOffsetIndices,k=0;k<z;k++){var h=s.glBlocks[k],p=B[h.set],_=p&&p.descriptorIndices[h.binding],p=0<=_&&p.gpuDescriptors[_],f=null,d=0;if(p&&p.gpuBuffer&&(_=p.gpuBuffer,0<=(p=(p=U[h.set])&&p[h.binding])&&(d=F[p]),f="vf32"in _?_.vf32:(d+=_.offset,_.gpuBuffer.vf32),d>>=2),f)for(var G=h.glActiveUniforms.length,H=0;H<G;H++){var m=h.glActiveUniforms[H];switch(m.glType){case o.BOOL:case o.INT:for(var g=0;g<m.array.length;++g){var V=m.offset+d+g;if(f[V]!==m.array[g]){for(var j=g,W=V;j<m.array.length;++j,++W)m.array[j]=f[W];o.uniform1iv(m.glLoc,m.array);break}}break;case o.BOOL_VEC2:case o.INT_VEC2:for(var v=0;v<m.array.length;++v){var q=m.offset+d+v;if(f[q]!==m.array[v]){for(var X=v,Y=q;X<m.array.length;++X,++Y)m.array[X]=f[Y];o.uniform2iv(m.glLoc,m.array);break}}break;case o.BOOL_VEC3:case o.INT_VEC3:for(var y=0;y<m.array.length;++y){var K=m.offset+d+y;if(f[K]!==m.array[y]){for(var Q=y,Z=K;Q<m.array.length;++Q,++Z)m.array[Q]=f[Z];o.uniform3iv(m.glLoc,m.array);break}}break;case o.BOOL_VEC4:case o.INT_VEC4:for(var x=0;x<m.array.length;++x){var J=m.offset+d+x;if(f[J]!==m.array[x]){for(var $=x,ee=J;$<m.array.length;++$,++ee)m.array[$]=f[ee];o.uniform4iv(m.glLoc,m.array);break}}break;case o.FLOAT:for(var S=0;S<m.array.length;++S){var te=m.offset+d+S;if(f[te]!==m.array[S]){for(var ie=S,ne=te;ie<m.array.length;++ie,++ne)m.array[ie]=f[ne];o.uniform1fv(m.glLoc,m.array);break}}break;case o.FLOAT_VEC2:for(var b=0;b<m.array.length;++b){var re=m.offset+d+b;if(f[re]!==m.array[b]){for(var oe=b,ae=re;oe<m.array.length;++oe,++ae)m.array[oe]=f[ae];o.uniform2fv(m.glLoc,m.array);break}}break;case o.FLOAT_VEC3:for(var T=0;T<m.array.length;++T){var se=m.offset+d+T;if(f[se]!==m.array[T]){for(var ce=T,le=se;ce<m.array.length;++ce,++le)m.array[ce]=f[le];o.uniform3fv(m.glLoc,m.array);break}}break;case o.FLOAT_VEC4:for(var ue=0;ue<m.array.length;++ue){var he=m.offset+d+ue;if(f[he]!==m.array[ue]){for(var pe=ue,_e=he;pe<m.array.length;++pe,++_e)m.array[pe]=f[_e];o.uniform4fv(m.glLoc,m.array);break}}break;case o.FLOAT_MAT2:for(var fe=0;fe<m.array.length;++fe){var de=m.offset+d+fe;if(f[de]!==m.array[fe]){for(var me=fe,ge=de;me<m.array.length;++me,++ge)m.array[me]=f[ge];o.uniformMatrix2fv(m.glLoc,!1,m.array);break}}break;case o.FLOAT_MAT3:for(var ve=0;ve<m.array.length;++ve){var ye=m.offset+d+ve;if(f[ye]!==m.array[ve]){for(var xe=ve,Se=ye;xe<m.array.length;++xe,++Se)m.array[xe]=f[Se];o.uniformMatrix3fv(m.glLoc,!1,m.array);break}}break;case o.FLOAT_MAT4:for(var be=0;be<m.array.length;++be){var Te=m.offset+d+be;if(f[Te]!==m.array[be]){for(var Ee=be,Ce=Te;Ee<m.array.length;++Ee,++Ce)m.array[Ee]=f[Ce];o.uniformMatrix4fv(m.glLoc,!1,m.array);break}}}}else tt("Buffer binding '"+h.name+"' at set "+h.set+" binding "+h.binding+" is not bounded")}for(var we=s.glSamplerTextures.length,Ae=0;Ae<we;Ae++)for(var E=s.glSamplerTextures[Ae],Pe=B[E.set],Ie=Pe&&Pe.descriptorIndices[E.binding],C=0<=Ie&&Pe.gpuDescriptors[Ie],Re=E.units.length,De=0;De<Re;De++){var w,A,Oe,Me,P=E.units[De];C&&C.gpuSampler?(C.gpuTexture&&0<C.gpuTexture.size&&(w=C.gpuTexture,(A=a.glTexUnits[P]).glTexture!==w.glTexture&&(a.texUnit!==P&&(o.activeTexture(o.TEXTURE0+P),a.texUnit=P),w.glTexture?o.bindTexture(w.glTarget,w.glTexture):o.bindTexture(w.glTarget,e.nullTex2D.gpuTexture.glTexture),A.glTexture=w.glTexture),A=C.gpuSampler,Oe=w.isPowerOf2?(r=A.glWrapS,A.glWrapT):(r=o.CLAMP_TO_EDGE,o.CLAMP_TO_EDGE),Me=w.isPowerOf2?w.mipLevel<=1&&(A.glMinFilter===o.LINEAR_MIPMAP_NEAREST||A.glMinFilter===o.LINEAR_MIPMAP_LINEAR)?o.LINEAR:A.glMinFilter:A.glMinFilter===o.LINEAR||A.glMinFilter===o.LINEAR_MIPMAP_NEAREST||A.glMinFilter===o.LINEAR_MIPMAP_LINEAR?o.LINEAR:o.NEAREST,w.glWrapS!==r&&(a.texUnit!==P&&(o.activeTexture(o.TEXTURE0+P),a.texUnit=P),o.texParameteri(w.glTarget,o.TEXTURE_WRAP_S,r),w.glWrapS=r),w.glWrapT!==Oe&&(a.texUnit!==P&&(o.activeTexture(o.TEXTURE0+P),a.texUnit=P),o.texParameteri(w.glTarget,o.TEXTURE_WRAP_T,Oe),w.glWrapT=Oe),w.glMinFilter!==Me&&(a.texUnit!==P&&(o.activeTexture(o.TEXTURE0+P),a.texUnit=P),o.texParameteri(w.glTarget,o.TEXTURE_MIN_FILTER,Me),w.glMinFilter=Me),w.glMagFilter!==A.glMagFilter&&(a.texUnit!==P&&(o.activeTexture(o.TEXTURE0+P),a.texUnit=P),o.texParameteri(w.glTarget,o.TEXTURE_MAG_FILTER,A.glMagFilter),w.glMagFilter=A.glMagFilter)),C=Pe.gpuDescriptors[++Ie]):tt("Sampler binding '"+E.name+"' at set "+E.set+" binding "+E.binding+" index "+De+" is not bounded")}}if(i&&s&&(c||FL.gpuInputAssembler!==i)){FL.gpuInputAssembler=i;var Ne=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){l=e.extensions.OES_vertex_array_object;if(!(u=i.glVAOs.get(s.glProgram))){u=l.createVertexArrayOES();i.glVAOs.set(s.glProgram,u),l.bindVertexArrayOES(u),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;for(var Le=s.glInputs.length,Be=0;Be<Le;Be++){for(var Fe=s.glInputs[Be],I=null,ze=i.glAttribs.length,Ue=0;Ue<ze;Ue++){var ke=i.glAttribs[Ue];if(ke.name===Fe.name){I=ke;break}}if(I){a.glArrayBuffer!==I.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,I.glBuffer),a.glArrayBuffer=I.glBuffer);for(var Ge=0;Ge<I.componentCount;++Ge){var He=Fe.glLoc+Ge,Ve=I.offset+I.size*Ge;o.enableVertexAttribArray(He),a.glCurrentAttribLocs[He]=!0,o.vertexAttribPointer(He,I.count,I.glType,I.isNormalized,I.stride,Ve),Ne&&Ne.vertexAttribDivisorANGLE(He,I.isInstanced?1:0)}}}c=i.gpuIndexBuffer;c&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,c.glBuffer),l.bindVertexArrayOES(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==u&&(l.bindVertexArrayOES(u),a.glVAO=u)}else{for(var je=0;je<e.capabilities.maxVertexAttributes;++je)a.glCurrentAttribLocs[je]=!1;for(var We=s.glInputs.length,qe=0;qe<We;qe++){for(var Xe=s.glInputs[qe],R=null,Ye=i.glAttribs.length,Ke=0;Ke<Ye;Ke++){var Qe=i.glAttribs[Ke];if(Qe.name===Xe.name){R=Qe;break}}if(R){a.glArrayBuffer!==R.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,R.glBuffer),a.glArrayBuffer=R.glBuffer);for(var Ze=0;Ze<R.componentCount;++Ze){var D=Xe.glLoc+Ze,Je=R.offset+R.size*Ze;!a.glEnabledAttribLocs[D]&&0<=D&&(o.enableVertexAttribArray(D),a.glEnabledAttribLocs[D]=!0),a.glCurrentAttribLocs[D]=!0,o.vertexAttribPointer(D,R.count,R.glType,R.isNormalized,R.stride,Je),Ne&&Ne.vertexAttribDivisorANGLE(D,R.isInstanced?1:0)}}}c=i.gpuIndexBuffer;c&&a.glElementArrayBuffer!==c.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,c.glBuffer),a.glElementArrayBuffer=c.glBuffer);for(var O=0;O<e.capabilities.maxVertexAttributes;++O)a.glEnabledAttribLocs[O]!==a.glCurrentAttribLocs[O]&&(o.disableVertexAttribArray(O),a.glEnabledAttribLocs[O]=!1)}}if(t&&t.dynamicStates.length)for(var $e=t.dynamicStates.length,et=0;et<$e;et++)switch(t.dynamicStates[et]){case na.LINE_WIDTH:a.rs.lineWidth!==n.lineWidth&&(o.lineWidth(n.lineWidth),a.rs.lineWidth=n.lineWidth);break;case na.DEPTH_BIAS:a.rs.depthBias===n.depthBiasConstant&&a.rs.depthBiasSlop===n.depthBiasSlope||(o.polygonOffset(n.depthBiasConstant,n.depthBiasSlope),a.rs.depthBias=n.depthBiasConstant,a.rs.depthBiasSlop=n.depthBiasSlope);break;case na.BLEND_CONSTANTS:var M=n.blendConstant;a.bs.blendColor.x===M.x&&a.bs.blendColor.y===M.y&&a.bs.blendColor.z===M.z&&a.bs.blendColor.w===M.w||(o.blendColor(M.x,M.y,M.z,M.w),a.bs.blendColor.copy(M));break;case na.STENCIL_WRITE_MASK:var M=n.stencilStatesFront,N=n.stencilStatesBack;a.dss.stencilWriteMaskFront!==M.writeMask&&(o.stencilMaskSeparate(o.FRONT,M.writeMask),a.dss.stencilWriteMaskFront=M.writeMask),a.dss.stencilWriteMaskBack!==N.writeMask&&(o.stencilMaskSeparate(o.BACK,N.writeMask),a.dss.stencilWriteMaskBack=N.writeMask);break;case na.STENCIL_COMPARE_MASK:var N=n.stencilStatesFront,L=n.stencilStatesBack;a.dss.stencilRefFront===N.reference&&a.dss.stencilReadMaskFront===N.compareMask||(o.stencilFuncSeparate(o.FRONT,xL[a.dss.stencilFuncFront],N.reference,N.compareMask),a.dss.stencilRefFront=N.reference,a.dss.stencilReadMaskFront=N.compareMask),a.dss.stencilRefBack===L.reference&&a.dss.stencilReadMaskBack===L.compareMask||(o.stencilFuncSeparate(o.BACK,xL[a.dss.stencilFuncBack],L.reference,L.compareMask),a.dss.stencilRefBack=L.reference,a.dss.stencilReadMaskBack=L.compareMask)}}function kL(e,t){var i=e.gl,e=e.extensions,n=e.ANGLE_instanced_arrays,e=e.WEBGL_multi_draw,r=FL.gpuInputAssembler,o=FL.glPrimitive;if(r){var a=r.gpuIndexBuffer;if(r.gpuIndirectBuffer){var s=r.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(e)s.instancedDraw?e.multiDrawElementsInstancedWEBGL(o,s.counts,0,r.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):e.multiDrawElementsWEBGL(o,s.counts,0,r.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]&&n?n.drawElementsInstancedANGLE(o,s.counts[l],r.glIndexType,s.byteOffsets[l],s.instances[l]):i.drawElements(o,s.counts[l],r.glIndexType,s.byteOffsets[l])}else if(e)s.instancedDraw?e.multiDrawArraysInstancedWEBGL(o,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):e.multiDrawArraysWEBGL(o,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]&&n?n.drawArraysInstancedANGLE(o,s.offsets[u],s.counts[u],s.instances[u]):i.drawArrays(o,s.offsets[u],s.counts[u])}else t.instanceCount&&n?a?0<t.indexCount&&(e=t.firstIndex*a.stride,n.drawElementsInstancedANGLE(o,t.indexCount,r.glIndexType,e,t.instanceCount)):0<t.vertexCount&&n.drawArraysInstancedANGLE(o,t.firstVertex,t.vertexCount,t.instanceCount):a?0<t.indexCount&&(e=t.firstIndex*a.stride,i.drawElements(o,t.indexCount,r.glIndexType,e)):0<t.vertexCount&&i.drawArrays(o,t.firstVertex,t.vertexCount)}}var GL=new Array(fL.COUNT);function HL(e,t,i,n){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit],a=(o.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),o.glTexture=i.glTexture),0),s=1,c=1,l=0,u=dc[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var h=0;h<n.length;h++){var p=n[h],s=p.texExtent.width,c=p.texExtent.height,_=t[a++];u?i.glInternalFmt===rL.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,p.texSubres.mipLevel,i.glInternalFmt,s,c,0,_):r.compressedTexSubImage2D(r.TEXTURE_2D,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,i.glFormat,_):r.texSubImage2D(r.TEXTURE_2D,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,i.glFormat,i.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var f=0;f<n.length;f++)for(var d=n[f],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount,l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var g=t[a++];u?i.glInternalFmt===rL.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,i.glInternalFmt,s,c,0,g):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,i.glFormat,g):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,i.glFormat,i.glType,g)}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Fo.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}(cM=zB.prototype).clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},cM.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=0<t.indexCount,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},cM._ensureCapacity=function(e){var t,i;this._capacity>e||(this._capacity=vn(e),e=new Int32Array(this._capacity),t=new Int32Array(this._capacity),i=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),t.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=t,this.instances=i)};var VL,jL,WL,qL,XL,YL,KL,QL,ZL,JL,$L,eB,tB,iB=zB,nB=(l(FB,tB=Ac),(Iie=FB.prototype).initialize=function(e){var t,i,n,r,o;"buffer"in e?(this._isBufferView=!0,t=e.buffer,this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}):(this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Do.UNIFORM&&0<this._size&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new iB,glTarget:0,glBuffer:null},this._usage&Do.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),t=cL.instance,e=this._gpuBuffer,n=t.gl,r=t.stateCache,o=e.memUsage&No.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW,e.usage&Do.VERTEX?(e.glTarget=n.ARRAY_BUFFER,(i=n.createBuffer())&&(e.glBuffer=i,0<e.size&&(t.extensions.useVAO&&r.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),FL.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,o),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))):e.usage&Do.INDEX?(e.glTarget=n.ELEMENT_ARRAY_BUFFER,(i=n.createBuffer())&&(e.glBuffer=i,0<e.size&&(t.extensions.useVAO&&r.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),FL.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,o),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))):e.usage&Do.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&Do.INDIRECT||e.usage&Do.TRANSFER_DST||e.usage&Do.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE),cL.instance.memoryStatus.bufferSize+=this._size)},Iie.destroy=function(){if(this._gpuBuffer){var e=cL.instance,t=this._gpuBuffer,i=e.gl,n=e.stateCache;if(t.glBuffer){switch(t.glTarget){case i.ARRAY_BUFFER:e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),FL.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&n.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),FL.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}i.deleteBuffer(t.glBuffer),t.glBuffer=null}cL.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null}this._gpuBufferView&&(this._gpuBufferView=null)},Iie.resize=function(e){var t,i,n,r,o,a;this._isBufferView?console.warn("cannot resize buffer views!"):(t=this._size)!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),0<(this._gpuBuffer.size=e)&&(i=cL.instance,n=this._gpuBuffer,r=i.gl,o=i.stateCache,a=n.memUsage&No.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW,n.usage&Do.VERTEX?(i.extensions.useVAO&&o.glVAO&&(i.extensions.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),FL.gpuInputAssembler=null,i.stateCache.glArrayBuffer!==n.glBuffer&&r.bindBuffer(r.ARRAY_BUFFER,n.glBuffer),n.buffer?r.bufferData(r.ARRAY_BUFFER,n.buffer,a):r.bufferData(r.ARRAY_BUFFER,n.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),i.stateCache.glArrayBuffer=null):n.usage&Do.INDEX?(i.extensions.useVAO&&o.glVAO&&(i.extensions.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),FL.gpuInputAssembler=null,i.stateCache.glElementArrayBuffer!==n.glBuffer&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n.glBuffer),n.buffer?r.bufferData(r.ELEMENT_ARRAY_BUFFER,n.buffer,a):r.bufferData(r.ELEMENT_ARRAY_BUFFER,n.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),i.stateCache.glElementArrayBuffer=null):n.usage&Do.UNIFORM?n.buffer&&(n.vf32=new Float32Array(n.buffer.buffer)):(n.usage&Do.INDIRECT||n.usage&Do.TRANSFER_DST||n.usage&Do.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),n.glTarget=r.NONE),cL.instance.memoryStatus.bufferSize-=t,cL.instance.memoryStatus.bufferSize+=e)))},Iie.update=function(e,t){this._isBufferView?console.warn("cannot update through buffer views!"):(t=void 0!==t?t:this._usage&Do.INDIRECT?0:e.byteLength,BL(cL.instance,this._gpuBuffer,e,0,t))},e(FB,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),FB),rB=((Rie=BB.prototype).alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var o=n,a=0;o<t;++o,++a)this._frees[o]=i[a];this._freeIdx+=n}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},Rie.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},Rie.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},Rie.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},BB),oB=((x=LB.prototype).clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},x.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},LB),aB=(l(NB,eB=Pc),(r=NB.prototype).initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=cL.instance.bindingMappingInfo.bufferOffsets.length,i=0;i<t;i++)this._curGPUDescriptorSets.push(null)},r.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},r.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},r.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},r.beginRenderPass=function(e,t,i,n,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(EL);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=i,a.clearColors.length=n.length;for(var s=0;s<n.length;++s)a.clearColors[s]=n[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(fL.BEGIN_RENDER_PASS),this._isInRenderPass=!0},r.endRenderPass=function(){this._isInRenderPass=!1},r.bindPipelineState=function(e){e=e.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},r.bindDescriptorSet=function(e,t,i){t=t.gpuDescriptorSet;if(t!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=t,this._isStateInvalied=!0),i){t=null==(t=this._curGPUPipelineState)?void 0:t.gpuPipelineLayout;if(t){for(var n=this._curDynamicOffsets,r=t.dynamicOffsetOffsets[e],o=0;o<i.length;o++)n[r+o]=i[o];this._isStateInvalied=!0}}},r.bindInputAssembler=function(e){e=e.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},r.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},r.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},r.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},r.setDepthBias=function(e,t,i){var n=this._curDynamicStates;n.depthBiasConstant===e&&n.depthBiasClamp===t&&n.depthBiasSlope===i||(n.depthBiasConstant=e,n.depthBiasClamp=t,n.depthBiasSlope=i,this._isStateInvalied=!0)},r.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},r.setDepthBound=function(e,t){var i=this._curDynamicStates;i.depthMinBounds===e&&i.depthMaxBounds===t||(i.depthMinBounds=e,i.depthMaxBounds=t,this._isStateInvalied=!0)},r.setStencilWriteMask=function(e,t){var i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;e&ra.FRONT&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0),e&ra.BACK&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0)},r.setStencilCompareMask=function(e,t,i){var n=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&ra.FRONT&&(n.compareMask===i&&n.reference===t||(n.reference=t,n.compareMask=i,this._isStateInvalied=!0)),e&ra.BACK&&(r.compareMask===i&&r.reference===t||(r.reference=t,r.compareMask=i,this._isStateInvalied=!0))},r.draw=function(e){if(this._type===ca.PRIMARY&&this._isInRenderPass||this._type===ca.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,e=this._cmdAllocator.drawCmdPool.alloc(wL),i=(e.drawInfo.copy(t),this.cmdPackage.drawCmds.push(e),this.cmdPackage.cmds.push(fL.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount,t.indexCount||t.vertexCount);if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},r.updateBuffer=function(e,t,i){var n,r,o;this._type===ca.PRIMARY&&!this._isInRenderPass||this._type===ca.SECONDARY?(n=e.gpuBuffer)&&(r=this._cmdAllocator.updateBufferCmdPool.alloc(AL),o=0,e.usage&Do.INDIRECT||(o=void 0!==i?i:t.byteLength),e=t,r.gpuBuffer=n,r.buffer=e,r.offset=0,r.size=o,this.cmdPackage.updateBufferCmds.push(r),this.cmdPackage.cmds.push(fL.UPDATE_BUFFER)):console.error("Command 'updateBuffer' must be recorded outside a render pass.")},r.copyBuffersToTexture=function(e,t,i){var n;this._type===ca.PRIMARY&&!this._isInRenderPass||this._type===ca.SECONDARY?(t=t.gpuTexture)&&(n=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(PL))&&(n.gpuTexture=t,n.regions=i,n.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(n),this.cmdPackage.cmds.push(fL.COPY_BUFFER_TO_TEXTURE)):console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},r.execute=function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var o=n.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<n.cmdPackage.bindStatesCmds.length;++a){var s=n.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<n.cmdPackage.drawCmds.length;++c){var l=n.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var p=0;p<n.cmdPackage.copyBufferToTextureCmds.length;++p){var _=n.cmdPackage.copyBufferToTextureCmds.array[p];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}},r.pipelineBarrier=function(){},r.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(CL);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(fL.BIND_STATES),this._isStateInvalied=!1)},NB),sB=(l(MB,$L=Bc),(Ce=MB.prototype).initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],i=0;i<e.colorTextures.length;++i){var n=e.colorTextures[i];n&&t.push(n.gpuTexture)}for(var r=null,o=(e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture),Number.MAX_SAFE_INTEGER),a=Number.MAX_SAFE_INTEGER,r=(this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},cL.instance),s=this._gpuFramebuffer,c=0;c<s.gpuColorTextures.length;++c)if(s.gpuColorTextures[c].isSwapchainTexture)return void(s.isOffscreen=!1);var l=r.gl,u=[];if(_=l.createFramebuffer()){s.glFramebuffer=_,r.stateCache.glFramebuffer!==s.glFramebuffer&&l.bindFramebuffer(l.FRAMEBUFFER,s.glFramebuffer);for(var h=0;h<s.gpuColorTextures.length;++h){var p=s.gpuColorTextures[h];p&&(p.glTexture?l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0+h,p.glTarget,p.glTexture,0):l.framebufferRenderbuffer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0+h,l.RENDERBUFFER,p.glRenderbuffer),u.push(l.COLOR_ATTACHMENT0+h),s.width=Math.min(s.width,p.width),s.height=Math.min(s.height,p.height))}var _=s.gpuDepthStencilTexture,f=(_&&(f=dc[_.format].hasStencil?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT,_.glTexture?l.framebufferTexture2D(l.FRAMEBUFFER,f,_.glTarget,_.glTexture,0):l.framebufferRenderbuffer(l.FRAMEBUFFER,f,l.RENDERBUFFER,_.glRenderbuffer),s.width=Math.min(s.width,_.width),s.height=Math.min(s.height,_.height)),r.extensions.WEBGL_draw_buffers&&r.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(u),l.checkFramebufferStatus(l.FRAMEBUFFER));if(f!==l.FRAMEBUFFER_COMPLETE)switch(f){case l.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case l.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case l.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case l.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}r.stateCache.glFramebuffer!==s.glFramebuffer&&l.bindFramebuffer(l.FRAMEBUFFER,r.stateCache.glFramebuffer)}},Ce.destroy=function(){var e,t;this._gpuFramebuffer&&(e=cL.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},e(MB,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),MB),cB=(l(OB,JL=tl),(Sa=OB.prototype).initialize=function(e){if(0!==e.vertexBuffers.length){this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer?(this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0):(r=this._vertexBuffers[0],this._drawInfo.vertexCount=r.size/r.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0),this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var t=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var n=e.vertexBuffers[i];n.gpuBuffer&&(t[i]=n.gpuBuffer)}var r=null,o=0;if(e.indexBuffer&&(r=e.indexBuffer.gpuBuffer))switch(r.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Error index buffer stride.")}var a=null,r=(e.indirectBuffer&&(a=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:t,gpuIndexBuffer:r,gpuIndirectBuffer:a,glAttribs:[],glIndexType:o,glVAOs:new Map},cL.instance),s=this._gpuInputAssembler,c=r.gl;s.glAttribs=new Array(s.attributes.length);for(var l=[0,0,0,0,0,0,0,0],u=0;u<s.attributes.length;++u){var h=s.attributes[u],p=void 0!==h.stream?h.stream:0,_=s.gpuVertexBuffers[p],f=uL(h.format,c),d=dc[h.format].size;s.glAttribs[u]={name:h.name,glBuffer:_.glBuffer,glType:f,size:d,count:dc[h.format].count,stride:_.stride,componentCount:function(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}(f,c),isNormalized:void 0!==h.isNormalized&&h.isNormalized,isInstanced:void 0!==h.isInstanced&&h.isInstanced,offset:l[p]},l[p]+=d}}else console.error("InputAssemblerInfo.vertexBuffers is null.")},Sa.destroy=function(){var e=cL.instance;if(this._gpuInputAssembler&&e.extensions.useVAO){for(var t=this._gpuInputAssembler,i=t.glVAOs.values(),n=i.next(),r=e.extensions.OES_vertex_array_object,o=e.stateCache.glVAO;!n.done;)r.deleteVertexArrayOES(n.value),o===n.value&&(r.bindVertexArrayOES(null),o=null),n=i.next();e.stateCache.glVAO=o,t.glVAOs.clear()}this._gpuInputAssembler=null},e(OB,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),OB),lB=(l(DB,ZL=nl),(R=DB.prototype).initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,i=-1,n=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];n.push(t),t+=o.count,o.binding>i&&(i=o.binding)}this._bindingIndices=Array(i+1).fill(-1);for(var a=this._descriptorIndices=Array(i+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=n[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&vc)for(var p=0;p<h.count;p++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},R.destroy=function(){this._bindings.length=0},e(DB,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),DB),uB=(l(RB,QL=rl),(g=RB.prototype).initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],i=[],n=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=n+l)}i.push(a.gpuDescriptorSetLayout),t.push(c),r.push(n),n+=s.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:t,dynamicOffsetCount:n,dynamicOffsetOffsets:r}},g.destroy=function(){this._setLayouts.length=0},e(RB,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),RB),hB=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],pB=(l(IB,KL=ll),(t=IB.prototype).initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t,i,n=this._bs;e.blendState&&((i=(t=e.blendState).targets)&&i.forEach(function(e,t){n.setTarget(t,e)}),void 0!==t.isA2C&&(n.isA2C=t.isA2C),void 0!==t.isIndepend&&(n.isIndepend=t.isIndepend),void 0!==t.blendColor&&(n.blendColor=t.blendColor)),Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:hB[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},t.destroy=function(){this._gpuPipelineState=null},e(IB,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),IB),_B=(l(PB,YL=aB),(o=PB.prototype).beginRenderPass=function(e,t,i,n,r,o){zL(cL.instance,e.gpuRenderPass,t.gpuFramebuffer,i,n,r,o),this._isInRenderPass=!0},o.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,i=(kL(cL.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount,t.indexCount||t.vertexCount);if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},o.setViewport=function(e){var t=cL.instance,i=t.stateCache,t=t.gl;i.viewport.left===e.left&&i.viewport.top===e.top&&i.viewport.width===e.width&&i.viewport.height===e.height||(t.viewport(e.left,e.top,e.width,e.height),i.viewport.left=e.left,i.viewport.top=e.top,i.viewport.width=e.width,i.viewport.height=e.height)},o.setScissor=function(e){var t=cL.instance,i=t.stateCache,t=t.gl;i.scissorRect.x===e.x&&i.scissorRect.y===e.y&&i.scissorRect.width===e.width&&i.scissorRect.height===e.height||(t.scissor(e.x,e.y,e.width,e.height),i.scissorRect.x=e.x,i.scissorRect.y=e.y,i.scissorRect.width=e.width,i.scissorRect.height=e.height)},o.updateBuffer=function(e,t,i){var n;this._isInRenderPass?console.error("Command 'updateBuffer' must be recorded outside a render pass."):(n=e.gpuBuffer)&&(i=void 0!==i?i:e.usage&Do.INDIRECT?0:t.byteLength,BL(cL.instance,n,t,0,i))},o.copyBuffersToTexture=function(e,t,i){this._isInRenderPass?console.error("Command 'copyBufferToTexture' must be recorded outside a render pass."):(t=t.gpuTexture)&&HL(cL.instance,e,t,i)},o.execute=function(e,t){for(var i=0;i<t;++i){var n=e[i],r=(u=u=l=l=c=s=a=o=r=void 0,cL.instance),o=n.cmdPackage;GL.fill(0);for(var a=0;a<o.cmds.length;++a){var s=o.cmds.array[a],c=GL[s]++;switch(s){case fL.BEGIN_RENDER_PASS:var l=o.beginRenderPassCmds.array[c];zL(r,l.gpuRenderPass,l.gpuFramebuffer,l.renderArea,l.clearColors,l.clearDepth,l.clearStencil);break;case fL.BIND_STATES:l=o.bindStatesCmds.array[c];UL(r,l.gpuPipelineState,l.gpuInputAssembler,l.gpuDescriptorSets,l.dynamicOffsets,l.dynamicStates);break;case fL.DRAW:kL(r,o.drawCmds.array[c].drawInfo);break;case fL.UPDATE_BUFFER:var u=o.updateBufferCmds.array[c];BL(r,u.gpuBuffer,u.buffer,u.offset,u.size);break;case fL.COPY_BUFFER_TO_TEXTURE:u=o.copyBufferToTextureCmds.array[c];HL(r,u.buffers,u.gpuTexture,u.regions)}}this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}},o.bindStates=function(){UL(cL.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},PB),fB=(l(AB,XL=ul),(bp=AB.prototype).initialize=function(e){this._type=e.type},bp.destroy=function(){},bp.submit=function(e){for(var t=e.length,i=0;i<t;i++){var n=e[i];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},bp.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},AB),dB=(l(wB,qL=hl),(n=wB.prototype).initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},e(wB,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),wB),mB=[10497,33648,33071,33071],gB=(l(CB,WL=pl),e(CB,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),CB),vB=(l(EB,jL=_l),(I=EB.prototype).initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var B=e.stages[t];this._gpuShader.gpuStages[t]={type:B.stage,source:B.source,glShader:null}}for(var i=cL.instance,c=this._gpuShader,l=i.gl,n=0;n<c.gpuStages.length;n++){var F=function(e){var t=c.gpuStages[e],i=0,n="",r=1;switch(t.type){case Xo.VERTEX:n="VertexShader",i=l.VERTEX_SHADER;break;case Xo.FRAGMENT:n="FragmentShader",i=l.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var o=l.createShader(i);if(o&&(t.glShader=o,l.shaderSource(t.glShader,t.source),l.compileShader(t.glShader),!l.getShaderParameter(t.glShader,l.COMPILE_STATUS))){console.error(n+" in '"+c.name+"' compilation failed."),console.error("Shader source dump:",t.source.replace(/^|\n/g,function(){return"\n"+r+++" "})),console.error(l.getShaderInfoLog(t.glShader));for(var a=0;a<c.gpuStages.length;a++){var s=c.gpuStages[e];s.glShader&&(l.deleteShader(s.glShader),s.glShader=null)}return{v:void 0}}}(n);if("object"==typeof F)return void F.v}var z=l.createProgram();if(z){c.glProgram=z;for(var r=0;r<c.gpuStages.length;r++){var U=c.gpuStages[r];l.attachShader(c.glProgram,U.glShader)}if(l.linkProgram(c.glProgram),i.extensions.destroyShadersImmediately)for(var o=0;o<c.gpuStages.length;o++){var a=c.gpuStages[o];a.glShader&&(l.detachShader(c.glProgram,a.glShader),l.deleteShader(a.glShader),a.glShader=null)}if(!l.getProgramParameter(c.glProgram,l.LINK_STATUS))return void(console.error("Failed to link shader '"+c.name+"'."),console.error(l.getProgramInfoLog(c.glProgram)));fe("Shader '"+c.name+"' compilation succeeded.");var k=l.getProgramParameter(c.glProgram,l.ACTIVE_ATTRIBUTES);c.glInputs=new Array(k);for(var s=0;s<k;++s){var u,G,H,V,h=l.getActiveAttrib(c.glProgram,s);h&&(u=-1!==(u=h.name.indexOf("["))?h.name.substr(0,u):h.name,G=l.getAttribLocation(c.glProgram,u),H=function(e,t){switch(e){case t.BOOL:return Ro.BOOL;case t.BOOL_VEC2:return Ro.BOOL2;case t.BOOL_VEC3:return Ro.BOOL3;case t.BOOL_VEC4:return Ro.BOOL4;case t.INT:return Ro.INT;case t.INT_VEC2:return Ro.INT2;case t.INT_VEC3:return Ro.INT3;case t.INT_VEC4:return Ro.INT4;case t.UNSIGNED_INT:return Ro.UINT;case t.FLOAT:return Ro.FLOAT;case t.FLOAT_VEC2:return Ro.FLOAT2;case t.FLOAT_VEC3:return Ro.FLOAT3;case t.FLOAT_VEC4:return Ro.FLOAT4;case t.FLOAT_MAT2:return Ro.MAT2;case t.FLOAT_MAT3:return Ro.MAT3;case t.FLOAT_MAT4:return Ro.MAT4;case t.SAMPLER_2D:return Ro.SAMPLER2D;case t.SAMPLER_CUBE:return Ro.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Ro.UNKNOWN}}(h.type,l),V=pL(h.type,l),c.glInputs[s]={binding:G,name:u,type:H,stride:V,count:h.size,size:V*h.size,glType:h.type,glLoc:G})}if(0<c.blocks.length){c.glBlocks=new Array(c.blocks.length);for(var p=0;p<c.blocks.length;++p){var _=c.blocks[p],j={set:_.set,binding:_.binding,name:_.name,size:0,glUniforms:new Array(_.members.length),glActiveUniforms:[]};c.glBlocks[p]=j;for(var f=0;f<_.members.length;++f){var d=_.members[f],W=hL(d.type,l),q=pL(W,l),X=q*d.count;j.glUniforms[f]={binding:-1,name:d.name,type:d.type,stride:q,count:d.count,size:X,offset:0,glType:W,glLoc:null,array:null}}}}for(var Y=0;Y<c.subpassInputs.length;++Y){var m=c.subpassInputs[Y];c.samplerTextures.push(new za(m.set,m.binding,m.name,Ro.SAMPLER2D,m.count))}if(0<c.samplerTextures.length){c.glSamplerTextures=new Array(c.samplerTextures.length);for(var g=0;g<c.samplerTextures.length;++g){var v=c.samplerTextures[g];c.glSamplerTextures[g]={set:v.set,binding:v.binding,name:v.name,type:v.type,count:v.count,units:[],glUnits:null,glType:hL(v.type,l),glLoc:null}}}for(var K=l.getProgramParameter(c.glProgram,l.ACTIVE_UNIFORMS),Q=0;Q<K;++Q){var y=l.getActiveUniform(c.glProgram,Q);if(y&&y.type!==l.SAMPLER_2D&&y.type!==l.SAMPLER_CUBE){var Z=l.getUniformLocation(c.glProgram,y.name);if(i.extensions.isLocationActive(Z))for(var J=y.name.indexOf("["),$=-1!==J?y.name.substr(0,J):y.name,ee=0;ee<c.glBlocks.length;ee++)for(var te=c.glBlocks[ee],ie=0;ie<te.glUniforms.length;ie++){var x=te.glUniforms[ie];if(x.name===$){x.glLoc=Z,x.count=y.size,x.size=x.stride*x.count,x.array=new(function(e){switch(e){case Ro.BOOL:case Ro.BOOL2:case Ro.BOOL3:case Ro.BOOL4:case Ro.INT:case Ro.INT2:case Ro.INT3:case Ro.INT4:case Ro.UINT:return Int32Array;case Ro.FLOAT:case Ro.FLOAT2:case Ro.FLOAT3:case Ro.FLOAT4:case Ro.MAT2:case Ro.MAT3:case Ro.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}(x.type))(x.size/4),te.glActiveUniforms.push(x);break}}}}for(var ne=0;ne<c.glBlocks.length;ne++)for(var S=c.glBlocks[ne],re=0;re<S.glUniforms.length;re++){var oe=S.glUniforms[re];oe.offset=S.size/4,S.size+=oe.size}for(var b=[],ae=[],se=i.bindingMappingInfo,T=i.stateCache.texUnitCacheMap,ce=0,le=0;le<c.blocks.length;++le)c.blocks[le].set===se.flexibleSet&&ce++;for(var ue=0,E=0;E<c.samplerTextures.length;++E){var C=c.samplerTextures[E],w=l.getUniformLocation(c.glProgram,C.name);i.extensions.isLocationActive(w)&&(b.push(c.glSamplerTextures[E]),ae.push(w)),void 0===T[C.name]&&(w=C.binding+se.samplerOffsets[C.set]+ue,C.set===se.flexibleSet&&(w-=ce),T[C.name]=w%i.capabilities.maxTextureUnits,ue+=C.count-1)}if(b.length){for(var A=[],P=0;P<b.length;++P){var I=b[P],R=T[I.name];if(void 0!==R){I.glLoc=ae[P];for(var he=0;he<I.count;++he){for(;A[R];)R=(R+1)%i.capabilities.maxTextureUnits;I.units.push(R),A[R]=!0}}}for(var D=0,O=0;O<b.length;++O){var M=b[O];if(!i.extensions.isLocationActive(M.glLoc)){M.glLoc=ae[O];for(var pe=0;pe<M.count;++pe){for(;A[D];)D=(D+1)%i.capabilities.maxTextureUnits;void 0===T[M.name]&&(T[M.name]=D),M.units.push(D),A[D]=!0}}}i.stateCache.glProgram!==c.glProgram&&l.useProgram(c.glProgram);for(var _e=0;_e<b.length;_e++){var N=b[_e];N.glUnits=new Int32Array(N.units),l.uniform1iv(N.glLoc,N.glUnits)}i.stateCache.glProgram!==c.glProgram&&l.useProgram(i.stateCache.glProgram)}for(var L=0;L<c.glBlocks.length;)c.glBlocks[L].glActiveUniforms.length?L++:(c.glBlocks[L]=c.glBlocks[c.glBlocks.length-1],c.glBlocks.length--);c.glSamplerTextures=b}},I.destroy=function(){if(this._gpuShader){var e=cL.instance,t=this._gpuShader;if(t.glProgram){var i=e.gl;if(!e.extensions.destroyShadersImmediately)for(var n=0;n<t.gpuStages.length;n++){var r=t.gpuStages[n];r.glShader&&(i.detachShader(t.glProgram,r.glShader),i.deleteShader(r.glShader),r.glShader=null)}i.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}this._gpuShader=null}},e(EB,[{key:"gpuShader",get:function(){return this._gpuShader}}]),EB),yB=(TB.prototype.initialize=function(e,t){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},TB),xB=(l(bB,VL=fl),(vie=bB.prototype).initialize=function(e,t){if("texture"in e)console.log("WebGL does not support texture view.");else{this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=yc(this._width)&&yc(this._height),this._size=Sc(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1};var i=cL.instance,n=this._gpuTexture,r=i.gl,o=(n.glFormat=n.glInternalFmt=function(e,t){switch(e){case W.A8:return t.ALPHA;case W.L8:return t.LUMINANCE;case W.LA8:return t.LUMINANCE_ALPHA;case W.RGB8:case W.RGB16F:case W.RGB32F:return t.RGB;case W.BGRA8:case W.RGBA8:case W.SRGB8_A8:case W.RGBA16F:case W.RGBA32F:return t.RGBA;case W.R5G6B5:return t.RGB;case W.RGB5A1:case W.RGBA4:return t.RGBA;case W.DEPTH:return t.DEPTH_COMPONENT;case W.DEPTH_STENCIL:return t.DEPTH_STENCIL;case W.BC1:return rL.COMPRESSED_RGB_S3TC_DXT1_EXT;case W.BC1_ALPHA:return rL.COMPRESSED_RGBA_S3TC_DXT1_EXT;case W.BC1_SRGB:return rL.COMPRESSED_SRGB_S3TC_DXT1_EXT;case W.BC1_SRGB_ALPHA:return rL.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case W.BC2:return rL.COMPRESSED_RGBA_S3TC_DXT3_EXT;case W.BC2_SRGB:return rL.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case W.BC3:return rL.COMPRESSED_RGBA_S3TC_DXT5_EXT;case W.BC3_SRGB:return rL.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case W.ETC_RGB8:return rL.COMPRESSED_RGB_ETC1_WEBGL;case W.ETC2_RGB8:return rL.COMPRESSED_RGB8_ETC2;case W.ETC2_SRGB8:return rL.COMPRESSED_SRGB8_ETC2;case W.ETC2_RGB8_A1:return rL.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case W.ETC2_SRGB8_A1:return rL.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case W.ETC2_RGBA8:return rL.COMPRESSED_RGBA8_ETC2_EAC;case W.ETC2_SRGB8_A8:return rL.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case W.EAC_R11:return rL.COMPRESSED_R11_EAC;case W.EAC_R11SN:return rL.COMPRESSED_SIGNED_R11_EAC;case W.EAC_RG11:return rL.COMPRESSED_RG11_EAC;case W.EAC_RG11SN:return rL.COMPRESSED_SIGNED_RG11_EAC;case W.PVRTC_RGB2:return rL.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case W.PVRTC_RGBA2:return rL.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case W.PVRTC_RGB4:return rL.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case W.PVRTC_RGBA4:return rL.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case W.ASTC_RGBA_4X4:return rL.COMPRESSED_RGBA_ASTC_4x4_KHR;case W.ASTC_RGBA_5X4:return rL.COMPRESSED_RGBA_ASTC_5x4_KHR;case W.ASTC_RGBA_5X5:return rL.COMPRESSED_RGBA_ASTC_5x5_KHR;case W.ASTC_RGBA_6X5:return rL.COMPRESSED_RGBA_ASTC_6x5_KHR;case W.ASTC_RGBA_6X6:return rL.COMPRESSED_RGBA_ASTC_6x6_KHR;case W.ASTC_RGBA_8X5:return rL.COMPRESSED_RGBA_ASTC_8x5_KHR;case W.ASTC_RGBA_8X6:return rL.COMPRESSED_RGBA_ASTC_8x6_KHR;case W.ASTC_RGBA_8X8:return rL.COMPRESSED_RGBA_ASTC_8x8_KHR;case W.ASTC_RGBA_10X5:return rL.COMPRESSED_RGBA_ASTC_10x5_KHR;case W.ASTC_RGBA_10X6:return rL.COMPRESSED_RGBA_ASTC_10x6_KHR;case W.ASTC_RGBA_10X8:return rL.COMPRESSED_RGBA_ASTC_10x8_KHR;case W.ASTC_RGBA_10X10:return rL.COMPRESSED_RGBA_ASTC_10x10_KHR;case W.ASTC_RGBA_12X10:return rL.COMPRESSED_RGBA_ASTC_12x10_KHR;case W.ASTC_RGBA_12X12:return rL.COMPRESSED_RGBA_ASTC_12x12_KHR;case W.ASTC_SRGBA_4X4:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case W.ASTC_SRGBA_5X4:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case W.ASTC_SRGBA_5X5:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case W.ASTC_SRGBA_6X5:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case W.ASTC_SRGBA_6X6:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case W.ASTC_SRGBA_8X5:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case W.ASTC_SRGBA_8X6:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case W.ASTC_SRGBA_8X8:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case W.ASTC_SRGBA_10X5:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case W.ASTC_SRGBA_10X6:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case W.ASTC_SRGBA_10X8:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case W.ASTC_SRGBA_10X10:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case W.ASTC_SRGBA_12X10:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case W.ASTC_SRGBA_12X12:return rL.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(n.format,r),n.glType=uL(n.format,r),n.width),a=n.height;switch(n.type){case Lo.TEX2D:if(n.glTarget=r.TEXTURE_2D,n.isSwapchainTexture)break;var s=Math.max(o,a);if(s>i.capabilities.maxTextureSize&&ee(9100,s,i.capabilities.maxTextureSize),!i.extensions.WEBGL_depth_texture&&dc[n.format].hasDepth)n.glInternalFmt=function(e,t){switch(e){case W.R5G6B5:return t.RGB565;case W.RGB5A1:return t.RGB5_A1;case W.RGBA4:return t.RGBA4;case W.RGBA16F:return rL.RGBA16F_EXT;case W.RGBA32F:return rL.RGBA32F_EXT;case W.SRGB8_A8:return rL.SRGB8_ALPHA8_EXT;case W.DEPTH:return t.DEPTH_COMPONENT16;case W.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(n.format,r),n.glRenderbuffer=r.createRenderbuffer(),0<n.size&&(i.stateCache.glRenderbuffer!==n.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,n.glRenderbuffer),i.stateCache.glRenderbuffer=n.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,n.glInternalFmt,o,a));else if(n.glTexture=r.createTexture(),0<n.size){s=i.stateCache.glTexUnits[i.stateCache.texUnit];if(s.glTexture!==n.glTexture&&(r.bindTexture(r.TEXTURE_2D,n.glTexture),s.glTexture=n.glTexture),dc[n.format].isCompressed)for(var c=0;c<n.mipLevel;++c){var l=xc(n.format,o,a,1),l=new Uint8Array(l);r.compressedTexImage2D(r.TEXTURE_2D,c,n.glInternalFmt,o,a,0,l),o=Math.max(1,o>>1),a=Math.max(1,a>>1)}else for(var u=0;u<n.mipLevel;++u)r.texImage2D(r.TEXTURE_2D,u,n.glInternalFmt,o,a,0,n.glFormat,n.glType,null),o=Math.max(1,o>>1),a=Math.max(1,a>>1);n.isPowerOf2?(n.glWrapS=r.REPEAT,n.glWrapT=r.REPEAT):(n.glWrapS=r.CLAMP_TO_EDGE,n.glWrapT=r.CLAMP_TO_EDGE),n.glMinFilter=r.LINEAR,n.glMagFilter=r.LINEAR,r.texParameteri(n.glTarget,r.TEXTURE_WRAP_S,n.glWrapS),r.texParameteri(n.glTarget,r.TEXTURE_WRAP_T,n.glWrapT),r.texParameteri(n.glTarget,r.TEXTURE_MIN_FILTER,n.glMinFilter),r.texParameteri(n.glTarget,r.TEXTURE_MAG_FILTER,n.glMagFilter)}break;case Lo.CUBE:n.glTarget=r.TEXTURE_CUBE_MAP;s=Math.max(o,a);if(s>i.capabilities.maxCubeMapTextureSize&&ee(9100,s,i.capabilities.maxTextureSize),n.glTexture=r.createTexture(),0<n.size){s=i.stateCache.glTexUnits[i.stateCache.texUnit];if(s.glTexture!==n.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,n.glTexture),s.glTexture=n.glTexture),dc[n.format].isCompressed)for(var h=0;h<6;++h)for(var o=n.width,a=n.height,p=0;p<n.mipLevel;++p){var _=xc(n.format,o,a,1),_=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+h,p,n.glInternalFmt,o,a,0,_),o=Math.max(1,o>>1),a=Math.max(1,a>>1)}else for(var f=0;f<6;++f){o=n.width,a=n.height;for(var d=0;d<n.mipLevel;++d)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,n.glInternalFmt,o,a,0,n.glFormat,n.glType,null),o=Math.max(1,o>>1),a=Math.max(1,a>>1)}n.isPowerOf2?(n.glWrapS=r.REPEAT,n.glWrapT=r.REPEAT):(n.glWrapS=r.CLAMP_TO_EDGE,n.glWrapT=r.CLAMP_TO_EDGE),n.glMinFilter=r.LINEAR,n.glMagFilter=r.LINEAR,r.texParameteri(n.glTarget,r.TEXTURE_WRAP_S,n.glWrapS),r.texParameteri(n.glTarget,r.TEXTURE_WRAP_T,n.glWrapT),r.texParameteri(n.glTarget,r.TEXTURE_MIN_FILTER,n.glMinFilter),r.texParameteri(n.glTarget,r.TEXTURE_MAG_FILTER,n.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),n.type=Lo.TEX2D,n.glTarget=r.TEXTURE_2D}cL.instance.memoryStatus.textureSize+=this._size}},vie.destroy=function(){if(this._gpuTexture){var e=cL.instance,t=this._gpuTexture,i=e.gl;if(t.glTexture){var n=e.stateCache.glTexUnits,r=e.stateCache.texUnit;i.deleteTexture(t.glTexture);for(var o=0;o<n.length;o++)n[o].glTexture===t.glTexture&&(i.activeTexture(i.TEXTURE0+o),r=o,i.bindTexture(t.glTarget,null),n[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}t.glRenderbuffer&&(e=e.stateCache.glRenderbuffer,i.deleteRenderbuffer(t.glRenderbuffer),e===t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),e=null),t.glRenderbuffer=null),cL.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null}},vie.resize=function(e,t){var i=this._size;if(this._width=e,this._height=t,this._size=Sc(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture){this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size;var n=cL.instance,r=this._gpuTexture;if(r.size){var o=n.gl,a=r.width,s=r.height;switch(r.type){case Lo.TEX2D:r.glTarget=o.TEXTURE_2D;var c=Math.max(a,s);if(c>n.capabilities.maxTextureSize&&ee(9100,c,n.capabilities.maxTextureSize),r.glRenderbuffer)n.stateCache.glRenderbuffer!==r.glRenderbuffer&&(o.bindRenderbuffer(o.RENDERBUFFER,r.glRenderbuffer),n.stateCache.glRenderbuffer=r.glRenderbuffer),o.renderbufferStorage(o.RENDERBUFFER,r.glInternalFmt,a,s);else if(r.glTexture){c=n.stateCache.glTexUnits[n.stateCache.texUnit];if(c.glTexture!==r.glTexture&&(o.bindTexture(o.TEXTURE_2D,r.glTexture),c.glTexture=r.glTexture),dc[r.format].isCompressed)for(var l=0;l<r.mipLevel;++l){var u=xc(r.format,a,s,1),u=new Uint8Array(u);o.compressedTexImage2D(o.TEXTURE_2D,l,r.glInternalFmt,a,s,0,u),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}else for(var h=0;h<r.mipLevel;++h)o.texImage2D(o.TEXTURE_2D,h,r.glInternalFmt,a,s,0,r.glFormat,r.glType,null),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}break;case Lo.CUBE:r.glTarget=o.TEXTURE_CUBE_MAP;c=Math.max(a,s),c=(c>n.capabilities.maxCubeMapTextureSize&&ee(9100,c,n.capabilities.maxTextureSize),n.stateCache.glTexUnits[n.stateCache.texUnit]);if(c.glTexture!==r.glTexture&&(o.bindTexture(o.TEXTURE_CUBE_MAP,r.glTexture),c.glTexture=r.glTexture),dc[r.format].isCompressed)for(var p=0;p<6;++p)for(var a=r.width,s=r.height,_=0;_<r.mipLevel;++_){var f=xc(r.format,a,s,1),f=new Uint8Array(f);o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+p,_,r.glInternalFmt,a,s,0,f),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}else for(var d=0;d<6;++d){a=r.width,s=r.height;for(var m=0;m<r.mipLevel;++m)o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,m,r.glInternalFmt,a,s,0,r.glFormat,r.glType,null),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),r.type=Lo.TEX2D,r.glTarget=o.TEXTURE_2D}}cL.instance.memoryStatus.textureSize-=i,cL.instance.memoryStatus.textureSize+=this._size}},vie.initAsSwapchainTexture=function(e){var t=new Na;t.format=e.format,t.usage=dc[e.format].hasDepth?Bo.DEPTH_STENCIL_ATTACHMENT:Bo.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},e(bB,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),bB),SB="webglcontextlost";function bB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=VL.call.apply(VL,[this].concat(i))||this)._gpuTexture=null,e}function TB(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Ea,this.scissorRect=new va(0,0,0,0),this.rs=new ol,this.dss=new al,this.bs=new cl,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}function EB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=jL.call.apply(jL,[this].concat(i))||this)._gpuShader=null,e}function CB(e,t){(e=WL.call(this,e,t)||this)._gpuSampler=null;var t=e._info.minFilter,i=e._info.magFilter,n=e._info.mipFilter,t=t===ko.LINEAR||t===ko.ANISOTROPIC?n===ko.LINEAR||n===ko.ANISOTROPIC?9987:n===ko.POINT?9985:9729:n===ko.LINEAR||n===ko.ANISOTROPIC?9986:n===ko.POINT?9984:9728,n=i===ko.LINEAR||i===ko.ANISOTROPIC?9729:9728,i=mB[e._info.addressU],r=mB[e._info.addressV],o=mB[e._info.addressW];return e._gpuSampler={glMinFilter:t,glMagFilter:n,glWrapS:i,glWrapT:r,glWrapR:o},e}function wB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=qL.call.apply(qL,[this].concat(i))||this)._gpuRenderPass=null,e}function AB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=XL.call.apply(XL,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}function PB(){return YL.apply(this,arguments)||this}function IB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=KL.call.apply(KL,[this].concat(i))||this)._gpuPipelineState=null,e}function RB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=QL.call.apply(QL,[this].concat(i))||this)._gpuPipelineLayout=null,e}function DB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=ZL.call.apply(ZL,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}function OB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=JL.call.apply(JL,[this].concat(i))||this)._gpuInputAssembler=null,e}function MB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=$L.call.apply($L,[this].concat(i))||this)._gpuFramebuffer=null,e}function NB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=eB.call.apply(eB,[this].concat(i))||this).cmdPackage=new IL,e._cmdAllocator=new oB,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new ps,e._isStateInvalied=!1,e}function LB(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new rB(EL,1),this.bindStatesCmdPool=new rB(CL,1),this.drawCmdPool=new rB(wL,1),this.updateBufferCmdPool=new rB(AL,1),this.copyBufferToTextureCmdPool=new rB(PL,1)}function BB(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Ct(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}function FB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=tB.call.apply(tB,[this].concat(i))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}function zB(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}function UB(e,t){for(var i=["","WEBKIT_","MOZ_"],n=0;n<i.length;++n){var r=e.getExtension(i[n]+t);if(r)return r}return null}function kB(e){var t={EXT_texture_filter_anisotropic:UB(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:UB(e,"EXT_blend_minmax"),EXT_frag_depth:UB(e,"EXT_frag_depth"),EXT_shader_texture_lod:UB(e,"EXT_shader_texture_lod"),EXT_sRGB:UB(e,"EXT_sRGB"),OES_vertex_array_object:UB(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:UB(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:UB(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:UB(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:UB(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:UB(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:UB(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:UB(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:UB(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:UB(e,"WEBGL_draw_buffers"),WEBGL_lose_context:UB(e,"WEBGL_lose_context"),WEBGL_depth_texture:UB(e,"WEBGL_depth_texture"),OES_texture_half_float:UB(e,"OES_texture_half_float"),OES_texture_half_float_linear:UB(e,"OES_texture_half_float_linear"),OES_texture_float:UB(e,"OES_texture_float"),OES_texture_float_linear:UB(e,"OES_texture_float_linear"),OES_standard_derivatives:UB(e,"OES_standard_derivatives"),OES_element_index_uint:UB(e,"OES_element_index_uint"),ANGLE_instanced_arrays:UB(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:UB(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return Qi.os===Wi.IOS&&14===Qi.osMainVersion&&Qi.isBrowser||(t.WEBGL_compressed_texture_astc=UB(e,"WEBGL_compressed_texture_astc")),Qi.os!==Wi.ANDROID&&Qi.os!==Wi.IOS&&(t.WEBGL_multi_draw=UB(e,"WEBGL_multi_draw")),Qi.browserType===Hi.UC&&(t.ANGLE_instanced_arrays=null),Qi.os===Wi.IOS&&Qi.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}l(WB,HB=Lc),(b=WB.prototype).initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(SB,this._onWebGLContextLost);var t=cL.instance.gl,i=(this.stateCache.initialize(cL.instance.capabilities.maxTextureUnits,cL.instance.capabilities.maxVertexAttributes),this._extensions=kB(t),(i=t).activeTexture(i.TEXTURE0),i.pixelStorei(i.PACK_ALIGNMENT,1),i.pixelStorei(i.UNPACK_ALIGNMENT,1),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.bindFramebuffer(i.FRAMEBUFFER,null),i.enable(i.SCISSOR_TEST),i.enable(i.CULL_FACE),i.cullFace(i.BACK),i.frontFace(i.CCW),i.disable(i.POLYGON_OFFSET_FILL),i.polygonOffset(0,0),i.enable(i.DEPTH_TEST),i.depthMask(!0),i.depthFunc(i.LESS),i.depthRange(0,1),i.stencilFuncSeparate(i.FRONT,i.ALWAYS,1,65535),i.stencilOpSeparate(i.FRONT,i.KEEP,i.KEEP,i.KEEP),i.stencilMaskSeparate(i.FRONT,65535),i.stencilFuncSeparate(i.BACK,i.ALWAYS,1,65535),i.stencilOpSeparate(i.BACK,i.KEEP,i.KEEP,i.KEEP),i.stencilMaskSeparate(i.BACK,65535),i.disable(i.STENCIL_TEST),i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),i.disable(i.BLEND),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.blendFuncSeparate(i.ONE,i.ZERO,i.ONE,i.ZERO),i.colorMask(!0,!0,!0,!0),i.blendColor(0,0,0,0),W.RGBA8),n=W.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),t=t.getParameter(t.STENCIL_BITS),t=(r&&t?n=W.DEPTH_STENCIL:r&&(n=W.DEPTH),this._colorTexture=new xB,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this._depthStencilTexture=new xB,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this.nullTex2D=cL.instance.createTexture(new Na(Lo.TEX2D,Bo.SAMPLED,W.RGBA8,2,2,Fo.GEN_MIPMAP)),this.nullTexCube=cL.instance.createTexture(new Na(Lo.CUBE,Bo.SAMPLED,W.RGBA8,2,2,Fo.GEN_MIPMAP,6)),new Ta),r=(t.texExtent.width=2,t.texExtent.height=2,new Uint8Array(this.nullTex2D.size));r.fill(0),cL.instance.copyBuffersToTexture([r],this.nullTex2D,[t]),t.texSubres.layerCount=6,cL.instance.copyBuffersToTexture([r,r,r,r,r,r],this.nullTexCube,[t])},b.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(SB,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},b.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(fe("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},b._onWebGLContextLost=function(e){J(11e3),V(e)},e(WB,[{key:"extensions",get:function(){return this._extensions}}]);var GB,HB,VB=WB,uI=Rre("WebGLDevice",(l(jB,GB=Ic),(xH=jB.prototype).initialize=function(e){cL.setInstance(this),this._gfxAPI=wo.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);e=this._context=function(e){var t=null;try{var i={alpha:zt.ENABLE_TRANSPARENT_CANVAS,antialias:zt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1},t=e.getContext("webgl",i)}catch(e){return null}return t}(Ic.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new cs(aa.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ss(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var t=e.getSupportedExtensions(),i="";if(t)for(var n,r=ge(t);!(n=r()).done;)i+=n.value+" ";var t=kB(e),e=(t.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(t.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(t.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR)),e.getParameter(e.VERSION)),o=(this._features.fill(!1),t.EXT_sRGB&&(this._features[Po.FORMAT_SRGB]=!0),t.EXT_blend_minmax&&(this._features[Po.BLEND_MINMAX]=!0),t.WEBGL_color_buffer_float&&(this._features[Po.COLOR_FLOAT]=!0),t.EXT_color_buffer_half_float&&(this._features[Po.COLOR_HALF_FLOAT]=!0),t.OES_texture_float&&(this._features[Po.TEXTURE_FLOAT]=!0),t.OES_texture_half_float&&(this._features[Po.TEXTURE_HALF_FLOAT]=!0),t.OES_texture_float_linear&&(this._features[Po.TEXTURE_FLOAT_LINEAR]=!0),t.OES_texture_half_float_linear&&(this._features[Po.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Po.FORMAT_RGB8]=!0,t.OES_element_index_uint&&(this._features[Po.ELEMENT_INDEX_UINT]=!0),t.ANGLE_instanced_arrays&&(this._features[Po.INSTANCED_ARRAYS]=!0),t.WEBGL_draw_buffers&&(this._features[Po.MULTIPLE_RENDER_TARGETS]=!0),"");return t.WEBGL_compressed_texture_etc1&&(this._features[Po.FORMAT_ETC1]=!0,o+="etc1 "),t.WEBGL_compressed_texture_etc&&(this._features[Po.FORMAT_ETC2]=!0,o+="etc2 "),t.WEBGL_compressed_texture_s3tc&&(this._features[Po.FORMAT_DXT]=!0,o+="dxt "),t.WEBGL_compressed_texture_pvrtc&&(this._features[Po.FORMAT_PVRTC]=!0,o+="pvrtc "),t.WEBGL_compressed_texture_astc&&(this._features[Po.FORMAT_ASTC]=!0,o+="astc "),fe("WebGL device initialized."),fe("RENDERER: "+this._renderer),fe("VENDOR: "+this._vendor),fe("VERSION: "+e),fe("COMPRESSED_FORMAT: "+o),fe("EXTENSIONS: "+i),!0},xH.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},xH.flushCommands=function(){},xH.acquire=function(){},xH.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},xH.createCommandBuffer=function(e){var t=new(e.type===ca.PRIMARY?_B:aB);return t.initialize(e),t},xH.createSwapchain=function(e){var t=new VB;return(this._swapchain=t).initialize(e),t},xH.createBuffer=function(e){var t=new nB;return t.initialize(e),t},xH.createTexture=function(e){var t=new xB;return t.initialize(e),t},xH.createDescriptorSet=function(e){var t=new aL;return t.initialize(e),t},xH.createShader=function(e){var t=new vB;return t.initialize(e),t},xH.createInputAssembler=function(e){var t=new cB;return t.initialize(e),t},xH.createRenderPass=function(e){var t=new dB;return t.initialize(e),t},xH.createFramebuffer=function(e){var t=new sB;return t.initialize(e),t},xH.createDescriptorSetLayout=function(e){var t=new lB;return t.initialize(e),t},xH.createPipelineLayout=function(e){var t=new uB;return t.initialize(e),t},xH.createPipelineState=function(e){var t=new pB;return t.initialize(e),t},xH.createQueue=function(e){var t=new fB;return t.initialize(e),t},xH.getSampler=function(e){var t=pl.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new gB(e,t)),this._samplers.get(t)},xH.getGlobalBarrier=function(e){var t=dl.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new dl(e,t)),this._globalBarriers.get(t)},xH.getTextureBarrier=function(e){var t=ml.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new ml(e,t)),this._textureBarriers.get(t)},xH.copyBuffersToTexture=function(e,t,i){HL(this,e,t.gpuTexture,i)},xH.copyTextureToBuffers=function(e,t,i){var n,r,o,a=this,s=e.gpuTexture,c=t,l=i,u=a.gl,a=a.stateCache,e=u.createFramebuffer();if(u.bindFramebuffer(u.FRAMEBUFFER,e),s.glTarget===u.TEXTURE_2D)for(var h=0;h<l.length;h++){var p=l[h];u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,s.glTarget,s.glTexture,p.texSubres.mipLevel),n=p.texOffset.x,r=p.texOffset.y,o=p.texExtent.width,p=p.texExtent.height,u.readPixels(n,r,o,p,s.glFormat,s.glType,c[h])}else console.error("Unsupported GL texture type, copy texture to buffers failed.");u.bindFramebuffer(u.FRAMEBUFFER,null),a.glFramebuffer=null,u.deleteFramebuffer(e)},xH.copyTexImagesToTexture=function(e,t,i){var n=this,r=e,o=t.gpuTexture,a=i,s=n.gl,c=((n=n.stateCache.glTexUnits[n.stateCache.texUnit]).glTexture!==o.glTexture&&(s.bindTexture(o.glTarget,o.glTexture),n.glTexture=o.glTexture),0),l=0;switch(o.glTarget){case s.TEXTURE_2D:for(var u=0;u<a.length;u++){var h=a[u];s.texSubImage2D(s.TEXTURE_2D,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,o.glFormat,o.glType,r[c++])}break;case s.TEXTURE_CUBE_MAP:for(var p=0;p<a.length;p++)for(var _=a[p],f=_.texSubres.baseArrayLayer+_.texSubres.layerCount,l=_.texSubres.baseArrayLayer;l<f;++l)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,o.glFormat,o.glType,r[c++]);break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}o.flags&Fo.GEN_MIPMAP&&o.isPowerOf2&&s.generateMipmap(o.glTarget)},e(jB,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),jB));function jB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=GB.call.apply(GB,[this].concat(i))||this)._swapchain=null,e._context=null,e}function WB(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=HB.call.apply(HB,[this].concat(i))||this).stateCache=new yB,e.cmdAllocator=new oB,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}j.WebGLDevice=uI;var qB=[new Wa(fa.ATTR_POSITION,W.RGB32F)],vI=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_COLOR,W.RGBA32F)],XB=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RG32F),new Wa(fa.ATTR_COLOR,W.RGBA32F)],yI=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RG32F),new Wa(fa.ATTR_COLOR,W.RGBA32F),new Wa(fa.ATTR_COLOR2,W.RGBA32F)];function YB(e){for(var t=0,i=0;i<e.length;i++){var n=e[i];t+=dc[n.format].count}return t}function KB(e){for(var t=0,i=0;i<e.length;i++){var n=e[i];t+=dc[n.format].size}return t}j.internal.vfmtPosUvColor=XB,j.internal.vfmtPosUvTwoColor=yI,Rre("UIVertexFormat",Object.freeze({__proto__:null,vfmt:qB,vfmtPosColor:vI,vfmtPosUvColor:XB,vfmtPosUvTwoColor:yI,getComponentPerVertex:YB,getAttributeStride:KB}));var QB=new ce,ZB=new B;function JB(e,t,i,n){var r=i.chunk,o=i.data,a=r.vb,s=i.vertexCount;e.getWorldMatrix(ZB);for(var c=0,l=0;l<s;l++){var u=o[l];ce.set(QB,u.x,u.y,0),ce.transformMat4(QB,QB,ZB),a[c++]=QB.x,a[c++]=QB.y,a[c++]=QB.z,nr.toArray(a,n,c+2),c+=6}for(var e=r.bufferId,h=r.vertexOffset,p=r.vertexAccessor.getMeshBuffer(r.bufferId),_=r.vertexAccessor.getIndexBuffer(e),f=p.indexOffset,d=0,m=s/4;d<m;d++){var g=h+4*d;_[f++]=g,_[f++]=g+1,_[f++]=g+2,_[f++]=g+1,_[f++]=g+3,_[f++]=g+2}p.indexOffset+=i.indexCount,p.setDirty()}(C7=rF.prototype).insertSpriteFrame=function(e){var t=e.rect,i=e.texture,n=this._innerTextureInfos[i.getId()],r=t.x,t=t.y;if(n)r+=n.x,t+=n.y;else{var n=i.width,o=i.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nexty),this._y+o+2>this._nexty&&(this._nexty=this._y+o+2),this._nexty>this._height)return null;j.internal.dynamicAtlasManager.textureBleeding&&((n<=8||o<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,r+=this._x,t+=this._y,this._x+=n+2}o={x:r,y:t,texture:this._texture};return this._innerSpriteFrames.push(e),o},C7.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},C7.isEmpty=function(){return this._count<=0},C7.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,i=e.length;t<i;t++){var n=e[t];n.isValid&&n._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},C7.destroy=function(){this.reset(),this._texture.destroy()};var $B,eF=rF,tF=(l(nF,$B=i0),(E=nF.prototype).initWithSize=function(e,t,i){void 0===i&&(i=pv.RGBA8888),this.reset({width:e,height:t,format:i})},E.drawTextureAt=function(e,t,i){var n,r,o=this.getGFXTexture();e&&o&&((n=this._getGFXDevice())?((r=new Ta).texOffset.x=t,r.texOffset.y=i,r.texExtent.width=e.width,r.texExtent.height=e.height,n.copyTexImagesToTexture([e.data],o,[r])):console.warn("Unable to get device"))},nF),c=((Nk=iF.prototype).newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new eF(this._textureSize,this._textureSize),this._atlases.push(e)),e},Nk.beforeSceneLoad=function(){this.reset()},Nk.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==fv.LINEAR||t.magFilter!==fv.LINEAR||t.mipFilter!==fv.NONE)return null;t=(this._atlases[this._atlasIndex]||this.newAtlas()).insertSpriteFrame(e);return t||this._atlasIndex===this._maxAtlasCount?t:this.newAtlas().insertSpriteFrame(e)},Nk.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},Nk.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,i=this._atlases.length-1;0<=i;i--)t=this._atlases[i],gt.array.fastRemove(t._innerSpriteFrames,e);var n=e._original._texture;this.deleteAtlasTexture(n)}},Nk.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;0<=t;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},Nk.packToDynamicAtlas=function(e,t){var i;t&&!t._original&&t.packable&&(i=this.insertSpriteFrame(t))&&t._setDynamicAtlasFrame(i)},e(iF,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),j.director.on(j.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),j.director.off(j.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),iF);function iF(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}function nF(){return $B.apply(this,arguments)||this}function rF(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var i=new tF;i.initWithSize(e,t),this._texture=i,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}c.instance=void 0;var oF=Rre("dynamicAtlasManager",c.instance=new c);j.internal.dynamicAtlasManager=oF;var aF,sF,cF=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],lF=Rre("SpriteFrame",f("cc.SpriteFrame")((l(uF,sF=P_),uF.createWithImage=function(e){var e=e instanceof Lv?e:new Lv(e),t=new i0,e=(t.image=e,new uF);return e.texture=t,e},(A=uF.prototype).textureLoaded=function(){return!!this.texture},A.isRotated=function(){return this._rotated},A.setRotated=function(e){this.rotated=e},A.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},A.setRect=function(e){this.rect=e},A.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},A.setOriginalSize=function(e){this.originalSize=e},A.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},A.setOffset=function(e){this.offset=e},A.getGFXTexture=function(){return this._texture.getGFXTexture()},A.getGFXSampler=function(){return this._texture.getGFXSampler()},A.getHash=function(){return this._texture.getHash()},A.getSamplerInfo=function(){return this._texture.getSamplerInfo()},A.reset=function(e,t){var i=!1;(t=void 0===t?!1:t)&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],i=!(this._rotated=!1)),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()},A.checkRect=function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(ee(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height&&(ee(3301,this.name+"/"+e.name,n,e.height),1))},A.destroy=function(){return this._packable&&oF&&oF.deleteAtlasSpriteFrame(this),sF.prototype.destroy.call(this)},A._calculateSlicedUV=function(){var e=this._rect,t=this.texture,i=t.width,t=t.height,n=this._capInsets[0],r=this._capInsets[2],r=e.width-n-r,o=this._capInsets[1],a=this._capInsets[3],s=e.height-o-a,c=this.uvSliced;if(c.length=0,this._rotated){cF[0].u=e.x/i,cF[1].u=(e.x+a)/i,cF[2].u=(e.x+a+s)/i,cF[3].u=(e.x+e.height)/i,cF[3].v=e.y/t,cF[2].v=(e.y+n)/t,cF[1].v=(e.y+n+r)/t,cF[0].v=(e.y+e.width)/t;for(var l=0;l<4;++l)for(var u=cF[l],h=0;h<4;++h){var p=cF[3-h];c.push({u:u.u,v:p.v})}}else{cF[0].u=e.x/i,cF[1].u=(e.x+n)/i,cF[2].u=(e.x+n+r)/i,cF[3].u=(e.x+e.width)/i,cF[3].v=e.y/t,cF[2].v=(e.y+o)/t,cF[1].v=(e.y+o+s)/t,cF[0].v=(e.y+e.height)/t;for(var _=0;_<4;++_)for(var f=cF[_],d=0;d<4;++d){var m=cF[d];c.push({u:m.u,v:f.v})}}this.emit(uF.EVENT_UV_UPDATED,this)},A._calculateUV=function(){var e,t,i,n=this._rect,r=this.uv,o=this.unbiasUV,a=this.texture,s=a.width,c=a.height,l=(this._rotated?(a=0===s?0:n.x/s,i=0===s?1:(n.x+n.height)/s,t=0===c?0:n.y/c,e=0===c?1:(n.y+n.width)/c,this._isFlipUVX&&this._isFlipUVY?(r[0]=i,r[1]=e,r[2]=i,r[3]=t,r[4]=a,r[5]=e,r[6]=a,r[7]=t):this._isFlipUVX?(r[0]=i,r[1]=t,r[2]=i,r[3]=e,r[4]=a,r[5]=t,r[6]=a,r[7]=e):this._isFlipUVY?(r[0]=a,r[1]=e,r[2]=a,r[3]=t,r[4]=i,r[5]=e,r[6]=i,r[7]=t):(r[0]=a,r[1]=t,r[2]=a,r[3]=e,r[4]=i,r[5]=t,r[6]=i,r[7]=e),a=0===s?0:n.x/s,t=0===s?1:(n.x+n.height)/s,i=0===c?0:n.y/c,e=0===c?1:(n.y+n.width)/c,this._isFlipUVX&&this._isFlipUVY?(o[0]=t,o[1]=e,o[2]=t,o[3]=i,o[4]=a,o[5]=e,o[6]=a,o[7]=i):this._isFlipUVX?(o[0]=t,o[1]=i,o[2]=t,o[3]=e,o[4]=a,o[5]=i,o[6]=a,o[7]=e):this._isFlipUVY?(o[0]=a,o[1]=e,o[2]=a,o[3]=i,o[4]=t,o[5]=e,o[6]=t,o[7]=i):(o[0]=a,o[1]=i,o[2]=a,o[3]=e,o[4]=t,o[5]=i,o[6]=t,o[7]=e)):(a=0===s?0:n.x/s,i=0===s?1:(n.x+n.width)/s,t=0===c?1:(n.y+n.height)/c,e=0===c?0:n.y/c,this._isFlipUVX&&this._isFlipUVY?(r[0]=i,r[1]=e,r[2]=a,r[3]=e,r[4]=i,r[5]=t,r[6]=a,r[7]=t):this._isFlipUVX?(r[0]=i,r[1]=t,r[2]=a,r[3]=t,r[4]=i,r[5]=e,r[6]=a,r[7]=e):this._isFlipUVY?(r[0]=a,r[1]=e,r[2]=i,r[3]=e,r[4]=a,r[5]=t,r[6]=i,r[7]=t):(r[0]=a,r[1]=t,r[2]=i,r[3]=t,r[4]=a,r[5]=e,r[6]=i,r[7]=e),t=0===s?0:n.x/s,a=0===s?1:(n.x+n.width)/s,i=0===c?1:(n.y+n.height)/c,r=0===c?0:n.y/c,this._isFlipUVX&&this._isFlipUVY?(o[0]=a,o[1]=r,o[2]=t,o[3]=r,o[4]=a,o[5]=i,o[6]=t,o[7]=i):this._isFlipUVX?(o[0]=a,o[1]=i,o[2]=t,o[3]=i,o[4]=a,o[5]=r,o[6]=t,o[7]=r):this._isFlipUVY?(o[0]=t,o[1]=r,o[2]=a,o[3]=r,o[4]=t,o[5]=i,o[6]=a,o[7]=i):(o[0]=t,o[1]=i,o[2]=a,o[3]=i,o[4]=t,o[5]=r,o[6]=a,o[7]=r)),this.vertices);if(l){l.nu.length=0;for(var u=l.nv.length=0;u<l.u.length;u++)l.nu[u]=l.u[u]/s,l.nv[u]=l.v[u]/c}this._calculateSlicedUV()},A._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},A._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},A._checkPackable=function(){var e,t,i;oF&&((e=this._texture)instanceof i0&&!e.isCompressed?(t=this.width,i=this.height,!e.image||t>oF.maxFrameSize||i>oF.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)):this._packable=!1)},A._serialize=function(){return null},A._deserialize=function(e){var t=e.rect,t=(t&&(this._rect=new qr(t.x,t.y,t.width,t.height)),e.offset),t=(e.offset&&(this._offset=new U(t.x,t.y)),e.originalSize),t=(e.originalSize&&(this._originalSize=new Hr(t.width,t.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable,e.capInsets);t&&(this._capInsets[0]=t[0],this._capInsets[1]=t[1],this._capInsets[2]=t[2],this._capInsets[3]=t[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},A.clone=function(){var e,t=new uF,i=this.vertices;return t.vertices=i?{x:i.x,y:i.y,triangles:i.triangles,nu:null==(e=i.nu)?void 0:e.slice(0),u:null==(e=i.u)?void 0:e.slice(0),nv:null==(e=i.nv)?void 0:e.slice(0),v:null==(e=i.v)?void 0:e.slice(0)}:null,(i=t.uv).splice.apply(i,[0,t.uv.length].concat(this.uv)),(e=t.unbiasUV).splice.apply(e,[0,t.unbiasUV.length].concat(this.unbiasUV)),(i=t.uvSliced).splice.apply(i,[0,t.uvSliced.length].concat(this.uvSliced)),t._rect.set(this._rect),t._offset.set(this._offset),t._originalSize.set(this._originalSize),t._rotated=this._rotated,(e=t._capInsets).splice.apply(e,[0,t._capInsets.length].concat(this._capInsets)),t._atlasUuid=this._atlasUuid,t._texture=this._texture,t._isFlipUVX=this._isFlipUVX,t._isFlipUVY=this._isFlipUVY,t},A._refreshTexture=function(e){this._texture=e;var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new qr(0,0,e.width,e.height),i=!0),0!==this._originalSize.width&&0!==this._originalSize.height&&!i||(t.originalSize=new Hr(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded()),this._checkPackable()},A.initDefault=function(e){sF.prototype.initDefault.call(this,e);e=new i0;e.initDefault(),this._refreshTexture(e),this._calculateUV()},A.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},A._calculateTillingOffset=function(){this._rotated?(this.tillingOffset[0]=this.uv[4]-this.uv[0],this.tillingOffset[1]=this.uv[3]-this.uv[5],this.tillingOffset[2]=this.uv[0],this.tillingOffset[3]=this.uv[5],this.tillingOffset[0]=-this.tillingOffset[0]):(this.tillingOffset[0]=this.uv[2]-this.uv[0],this.tillingOffset[1]=this.uv[1]-this.uv[5],this.tillingOffset[2]=this.uv[4],this.tillingOffset[3]=this.uv[5])},A._calculateSlicedData=function(){var e=this._rect,t=this._capInsets[0],i=this._capInsets[2],i=e.width-t-i,n=this._capInsets[1],r=this._capInsets[3],r=e.height-n-r,o=this.slicedData;o.length=0,o[0]=t/e.width,o[1]=n/e.height,o[2]=(t+i)/e.width,o[3]=(n+r)/e.height},e(uF,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),uF.EVENT_UV_UPDATED="uv_updated",yU=uF))||yU);function uF(){var e;return(e=sF.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new qr,e._offset=new U,e._originalSize=new Hr,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}j.SpriteFrame=lF;var hF,pF=Rre("SpriteAtlas",f("cc.SpriteAtlas")((l(_F,hF=P_),(kd=_F.prototype).getTexture=function(){var e=Object.keys(this.spriteFrames);return 0<e.length?(e=this.spriteFrames[e[0]])&&e.texture:null},kd.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},kd.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e},kd._serialize=function(){},kd._deserialize=function(e,t){this._name=e.name;var i=e.spriteFrames;this.spriteFrames=Ge();for(var n=0;n<i.length;n+=2)t.result.push(this.spriteFrames,i[n],i[n+1],ft(lF))},aF=i((Z5=_F).prototype,"spriteFrames",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ge()}}),C=Z5))||C);function _F(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=hF.call.apply(hF,[this].concat(i))||this,"spriteFrames",aF,p(e)),e}j.SpriteAtlas=pF;var fF,dF,mF=Rre("Font",f("cc.Font")((l(gF,dF=P_),Y3=gF))||Y3);function gF(){return dF.apply(this,arguments)||this}j.Font=mF;var vF,yF,xF,SF,bF,TF=Rre("TTFFont",f("cc.TTFFont")((l(EF,bF=mF),EF.prototype.initDefault=function(e){this._fontFamily="Arial",bF.prototype.initDefault.call(this,e)},e(EF,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:nn(this._native),__isNative__:!0}}}]),fF=i((EW=EF).prototype,"_fontFamily",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(EW.prototype,"_nativeAsset",[Gp,kp],Object.getOwnPropertyDescriptor(EW.prototype,"_nativeAsset"),EW.prototype),i(EW.prototype,"_nativeDep",[Gp],Object.getOwnPropertyDescriptor(EW.prototype,"_nativeDep"),EW.prototype),P=EW))||P);function EF(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=bF.call.apply(bF,[this].concat(i))||this,"_fontFamily",fF,p(e)),e}j.TTFFont=TF;function CF(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}(bne=RF.prototype).addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},bne.cloneLetterDefinition=function(){for(var e={},t=0,i=Object.keys(this.letterDefinitions);t<i.length;t++){var n=i[t],r=new CF;Je(r,this.letterDefinitions[n]),e[n]=r}return e},bne.getTexture=function(){return this.texture},bne.getLetter=function(e){return this.letterDefinitions[e]},bne.getLetterDefinitionForChar=function(e){e=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},bne.clear=function(){this.letterDefinitions={}};var wF,AF=RF,PF=Rre("BitmapFont",(Up=f("cc.BitmapFont"),h=v(lF),Up((l(IF,wF=mF),IF.prototype.onLoaded=function(){var e=this.spriteFrame,e=(!this.fontDefDictionary&&e&&(this.fontDefDictionary=new AF(e.texture)),this.fntConfig);if(e){var t,i=e.fontDefDictionary;for(t in i){var n=new CF,r=i[t].rect;n.offsetX=i[t].xOffset,n.offsetY=i[t].yOffset,n.w=r.width,n.h=r.height,n.u=r.x,n.v=r.y,n.textureID=0,n.valid=!0,n.xAdvance=i[t].xAdvance,this.fontDefDictionary.addLetterDefinitions(t,n)}}else V("The fnt config is not exists!")},vF=i((YD=IF).prototype,"fntDataStr",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yF=i(YD.prototype,"spriteFrame",[h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xF=i(YD.prototype,"fontSize",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),SF=i(YD.prototype,"fntConfig",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B1=YD))||B1));function IF(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=wF.call.apply(wF,[this].concat(i))||this,"fntDataStr",vF,p(e)),_(e,"spriteFrame",yF,p(e)),_(e,"fontSize",xF,p(e)),_(e,"fntConfig",SF,p(e)),e}function RF(e){this.letterDefinitions={},this.texture=e}j.BitmapFont=PF;var DF,S=Rre("LabelAtlas",f("cc.LabelAtlas")((l(OF,DF=PF),Hd=OF))||Hd);function OF(){return DF.apply(this,arguments)||this}j.LabelAtlas=S;var MF=Rre("BASELINE_RATIO",.26),NF=Rre("MIDDLE_RATIO",(MF+1)/2-MF),LF=new dt(2);LF.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};(kw=VF.prototype).moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},kw.put=function(e,t){var i=LF.get();i.key=e,i.value=t,this.count>=this.limit&&(e=this.tail,delete this.datas[e.key],this.count--,this.tail=e.prev,this.tail.next=null,e.prev=null,e.next=null,LF.put(e)),this.moveToHead(i)},kw.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},kw.get=function(e){e=this.datas[e];return e?(this.remove(e),this.moveToHead(e),e.value):null},kw.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},kw.has=function(e){return!!this.datas[e]},kw.delete=function(e){e=this.datas[e];this.remove(e)};var BF,FF=new VF(100),zF=/([a-zA-Z0-9--]+|\S)/,UF=/^[!,.:;'}\]%\?>]/,kF=/([a-zA-Z0-9--]+|\S)$/,GF=/[a-zA-Z0-9--]+$/,HF=/^[a-zA-Z0-9--]/;function VF(e){this.count=0,this.limit=0,this.datas={},this.limit=e}function jF(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function WF(e){e=e.charCodeAt(0);return 9<=e&&e<=13||32===e||133===e||160===e||5760===e||8192<=e&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function qF(e,t,i){var i=(i||e.font)+""+t,n=FF.get(i);if(null!==n)return n;n=e.measureText(t),e=n&&n.width||0;return FF.put(i,e),e}function XF(e,t,i){var n=t,r=i,o=e[t];return"\udc00"<=o&&o<="\udfff"&&n--,void 0!==i&&(i-1!==t?"\ud800"<=(t=e[i-1])&&t<="\udbff"&&r--:"\ud800"<=o&&o<="\udbff"&&r++),e.substring(n,r)}function YF(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var o=e;i<t&&1<o.length;){for(var a,s=o.length*(i/t)|0,c=XF(o,s),l=t-n(c),u=c,h=0,p=0;i<l&&p++<10;)l=t-n(c=XF(o,s=s*(i/l)|0));for(p=0;l<=i&&p++<10;)c&&(h=(a=zF.exec(c))?a[0].length:1,u=c),l=t-n(c=XF(o,s+=h));0==(s-=h)?u=XF(o,s=1):1===s&&"\ud800"<=o[0]&&o[0]<="\udbff"&&(u=XF(o,s=2));var _=XF(o,0,s),f=void 0;UF.test(u||c)&&(u=XF(o,s=0==(s-=(f=kF.exec(_))?f[0].length:0)?1:s),_=XF(o,0,s)),HF.test(u)&&(f=GF.exec(_))&&_!==f[0]&&(u=XF(o,s-=f[0].length),_=XF(o,0,s)),(0===r.length||0<(_=_.trim()).length)&&r.push(_),t=n(o=u||c)}return(0===r.length||0<(o=o.trim()).length)&&r.push(o),r}function KF(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}var QF,ZF,JF,$F,ez,tz,iz,nz,rz=Rre("CanvasPool",(Nz.getInstance=function(){return BF=BF||new Nz},(Gd=Nz.prototype).get=function(){var e,t,i=this.pool.pop();return i||(t=(e=document.createElement("canvas")).getContext("2d"),i={canvas:e,context:t}),i},Gd.put=function(e){this.pool.length>=zt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},Nz)),oz=nr.WHITE.clone(),az="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",sz=((E2=Mz.prototype).updateRenderData=function(){this._updateProperties(),this._updateTexture()},E2.destroy=function(){this.image=null},E2._updateProperties=function(){var e,t;this.data=rz.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context&&(this.context.font=this.labelInfo.fontDesc,e=qF(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2,this.width=parseFloat(e.toFixed(2))+t,this.height=(1+MF)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*MF/2),this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Lv),this.image.reset(this.canvas)},E2._updateTexture=function(){var e,t,i,n,r;this.context&&this.canvas&&(e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height,e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,i,n),e.fillStyle=az,e.fillRect(0,0,i,n),e.font=t.fontDesc,i=i/2,n=n/2+(n=t.fontSize)*NF+0*n,r=t.color,e.lineJoin="round",e.fillStyle="rgba("+r.r+", "+r.g+", "+r.b+", 1)",t.isOutlined&&(r=t.out||oz,e.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+r.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,i,n)),e.fillText(this.char,i,n))},Mz),cz=(l(Oz,nz=i0),(ane=Oz.prototype).initWithSize=function(e,t,i){void 0===i&&(i=pv.RGBA8888),this.reset({width:e,height:t,format:i})},ane.drawTextureAt=function(e,t,i){var n,r,o=this.getGFXTexture();e&&o&&((n=this._getGFXDevice())?((r=new Ta).texOffset.x=t,r.texOffset.y=i,r.texExtent.width=e.width,r.texExtent.height=e.height,n.copyTexImagesToTexture([e.data],o,[r])):console.warn("Unable to get device"))},Oz),lz=((a=Dz.prototype).insertLetterTexture=function(e){var t=e.image,i=ZP.root.device;if(!t||!this.fontDefDictionary||!i)return null;var i=t.width,n=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+n>this._nextY&&(this._nextY=this._y+n+0),this._nextY>this._height)return J(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;n=new KF;return n.u=this._x+this._halfBleed,n.v=this._y+this._halfBleed,n.texture=this.fontDefDictionary.texture,n.valid=!0,n.w=e.width-2,n.h=e.height-2,n.xAdvance=n.w,n.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,n),n},a.update=function(){this._dirty&&(this._dirty=!1)},a.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},a.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},a.getTexture=function(){return this.fontDefDictionary.getTexture()},a.beforeSceneLoad=function(){this.clearAllCache()},a.clearAllCache=function(){this.destroy();var e=new cz;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},a.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},a.getLetterDefinitionForChar=function(e,t){var i=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[i];return i||((e=new sz(e,t)).updateRenderData(),i=this.insertLetterTexture(e),e.destroy()),i},e(Dz,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),Dz),uz={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:nr.WHITE.clone(),isOutlined:!1,out:nr.WHITE.clone(),margin:0},hz=KB(XB)>>2,XN=Rre("BaseRenderData",((L6=Rz.prototype).isValid=function(){return 0<this._ic&&this.chunk.vertexAccessor},L6.resize=function(e,t){var i;e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,i=ZP.root.batcher2D.switchBufferAccessor(this._vertexFormat),this.chunk&&(i.recycleChunk(this.chunk),this.chunk=null),this.chunk=i.allocateChunk(e,t))},e(Rz,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),Rz)),pz=Rre("RenderData",(l(Iz,iz=XN),Iz.add=function(e){void 0===e&&(e=XB);var t=dz.add();return t._floatStride=e===XB?hz:KB(e)>>2,t._vertexFormat=e,t},Iz.remove=function(e){e=dz.data.indexOf(e);-1!==e&&(dz.data[e].clear(),dz.removeAt(e))},(s=Iz.prototype).resize=function(e,t){iz.prototype.resize.call(this,e,t),this.updateHash()},s.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},s.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},s.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},s.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Gc(e,666),this.hashDirty=!1},s.updateRenderData=function(e,t){var i;this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty&&(i=e.node.scene?e._getRenderScene():null,this.layer=e.node.layer,null!==i&&(this.nodeDirty=!1),this.hashDirty=!0),this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},s.updateSizeNPivot=function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)},s.clear=function(){this.resize(0,0),this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0,this._vertexFormat=XB},e(Iz,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){for(var i=t.length,n=0,n=e;n<i;n++)fz.free(t[n]);for(n=i;n<e;n++)t[n]=fz.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),Iz)),_z=Rre("MeshRenderData",(l(Pz,tz=XN),Pz.add=function(e){void 0===e&&(e=XB);var t=mz.add();return t._floatStride=e===XB?hz:KB(e)>>2,t._vertexFormat=e,t},Pz.remove=function(e){e=mz.data.indexOf(e);-1!==e&&(mz.data[e].clear(),mz.removeAt(e))},(y=Pz.prototype).request=function(e,t){var i=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=i,!0)},y.reserve=function(e,t){var i=this._byteLength+e*this.stride,n=this.indexCount+t;if(65535<e+this.vertexCount)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(r<i||o<n){for(;r<i||o<n;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},y.resize=function(e,t){var i=e*this.stride;0<=e&&0<=t&&i<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=i,this.updateRange(0,e,0,t)},y.updateRange=function(e,t,i,n){0<=t&&0<=n&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=i,this.vertexRange=t,this.indexRange=n},y.requestIA=function(e){this._initIAInfo(e);e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},y.uploadBuffers=function(){var e,t,i,n;0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer&&(e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),i=new Uint16Array(this.iData.buffer,0,e),n=this._vertexBuffers[0],this._byteLength>n.size&&n.resize(this._byteLength),n.update(t),(n=e<<1)>this._indexBuffer.size&&this._indexBuffer.resize(n),this._indexBuffer.update(i))},y.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},y.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},y.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},y._initIAInfo=function(e){var t,i,n=this;this._iaInfo||(i=this.stride,(t=this._vertexBuffers).length||t.push(e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,i,i))),i=Uint16Array.BYTES_PER_ELEMENT,this._indexBuffer||(this._indexBuffer=e.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,i,i))),this._iaInfo=new Xa(this._vertexFormat,t,this._indexBuffer),this._iaPool=new Et(function(){return e.createInputAssembler(n._iaInfo)},1,function(e){e.destroy()}))},y._reallocBuffer=function(e,t){var i=this.vData,e=(this.vData=new Float32Array(e),i&&this.vData.set(i,0),this.iData);this.iData=new Uint16Array(t),e&&this.iData.set(e,0)},e(Pz,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),Pz)),Qp=Rre("QuadRenderData",(l(Az,ez=_z),(fie=Az.prototype)._fillQuadBuffer=function(){for(var e=this.iData.length/6,t=this.iData,i=0,n=0;i<e;i++){var r=4*i;t[n++]=r,t[n++]=1+r,t[n++]=2+r,t[n++]=1+r,t[n++]=3+r,t[n++]=2+r}},fie._reallocBuffer=function(e,t){ez.prototype._reallocBuffer.call(this,e,t),this._fillQuadBuffer()},Az)),fz=new Tt(function(){return{x:0,y:0,z:0,u:0,v:0,color:nr.WHITE.clone()}},128),dz=new Et(function(){return new pz},32),mz=new Et(function(){return new _z},32),gz=new U,vz=new U,yz=new ce,xz=new B,Sz=new B,bz=new B,Tz=new B(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),Ez=new qr,Cz=(ba=f("cc.UITransform"),aie=wp(),Nw=Oa(110),pi=Ep(),Cp=m(),w=u(),zp=m(),Xp=u(),Ac=ba(cM=aie(cM=Nw(cM=pi(cM=ls(cM=Tp((l(wz,$F=W_),(il=wz.prototype).__preload=function(){this.node._uiProps.uiTransformComp=this},il.onLoad=function(){this.node.parent&&wz.insertChangeMap(this.node.parent)},il.onEnable=function(){this.node.on(T.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},il.onDisable=function(){this.node.off(T.PARENT_CHANGED,this._parentChanged,this)},il.onDestroy=function(){this.node._uiProps.uiTransformComp=null},il.setContentSize=function(e,t){var i=this._contentSize;if(void 0===t){if(e.width===i.width&&e.height===i.height)return;i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;i.width=e,i.height=t}this.node.emit(T.SIZE_CHANGED),this._markRenderDataDirty()},il.setAnchorPoint=function(e,t){var i=this._anchorPoint;if(void 0===t){if(e.x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(T.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},il.isHit=function(e){for(var t,i=this._contentSize.width,n=this._contentSize.height,r=gz,o=vz,a=null==(t=this.node)?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(xz);var l=xz.m12,u=xz.m13,h=$P.center;if(xz.m12=h.x-(xz.m00*l+xz.m04*u),xz.m13=h.y-(xz.m01*l+xz.m05*u),B.invert(xz,xz),U.transformMat4(r,e,xz),this.node.getWorldMatrix(bz),B.invert(xz,bz),!B.strictEquals(xz,Tz)){U.transformMat4(o,r,xz),o.x+=this._anchorPoint.x*i,o.y+=this._anchorPoint.y*n;var p=!1;if(0<=o.x&&0<=o.y&&o.x<=i&&o.y<=n&&(p=!0,a&&a.maskList))for(var _=a.maskList,f=this.node,d=_?_.length:0,m=0,g=0;f&&g<d;++m,f=f.parent){var v=_[g];if(m===v.index){if(f!==v.comp.node){_.length=g;break}var y=v.comp;if(y&&y._enabled&&!y.isHit(r)){p=!1;break}g++}else if(m>v.index){_.length=g;break}}if(p)return!0}}}return!1},il.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(bz),B.invert(xz,bz),t=t||new ce,ce.transformMat4(t,e,xz)},il.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(bz),t=t||new ce,ce.transformMat4(t,e,bz)},il.getBoundingBox=function(){B.fromRTS(Sz,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,e=new qr(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return e.transformMat4(Sz),e},il.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(bz),this.getBoundingBoxTo(bz)):this.getBoundingBox()},il.getBoundingBoxTo=function(e){B.fromRTS(Sz,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,n=new qr(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(B.multiply(bz,e,Sz),n.transformMat4(bz),!this.node.children)return n;for(var r=ge(this.node.children);!(o=r()).done;){var o=o.value;o&&o.active&&(o=o.getComponent(wz))&&(o=o.getBoundingBoxTo(e))&&qr.union(n,n,o)}return n},il.getComputeAABB=function(e){var t=this._contentSize.width,i=this._contentSize.height,t=(Ez.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),Ez.transformMat4(this.node.worldMatrix),Ez.x+.5*Ez.width),i=Ez.y+.5*Ez.height,n=this.node.worldPosition.z,r=Ez.width/2,o=Ez.height/2;return null!=e?(qh.set(e,t,i,n,r,o,.001),e):new qh(t,i,n,r,o,.001)},il._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&wz.insertChangeMap(this.node.parent)},il._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},il.checkAndUpdateRect=function(e,t){var i;this._rectDirty&&(this._rectWithScale.x=t.x*this.width,this._rectWithScale.y=t.y*this.height,this._rectWithScale.z=t.z,i=(.5-this.anchorPoint.x)*this.width*t.x,t=(.5-this.anchorPoint.y)*this.height*t.y,ce.transformQuat(this._anchorCache,yz.set(i,t,0),e))},il.setRectDirty=function(e){e&Q0.RS&&(this._rectDirty=!0)},wz.insertChangeMap=function(e){var t=e.uuid;wz.priorityChangeNodeMap.has(t)||wz.priorityChangeNodeMap.set(t,e)},wz._sortChildrenSibling=function(e){e=e.children;e&&e.sort(function(e,t){var i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,i=(i?i._priority:0)-(n?n._priority:0);return 0==i?e.getSiblingIndex()-t.getSiblingIndex():i})},wz._sortSiblings=function(){wz.priorityChangeNodeMap.forEach(function(e){wz._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")}),wz.priorityChangeNodeMap.clear()},wz._cleanChangeMap=function(){wz.priorityChangeNodeMap.clear()},e(wz,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(T.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(T.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(T.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(T.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(T.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(T.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?J(6706):(this._priority=e,this.node.parent&&wz.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=ZP.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=ZP.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),dU=Mne=wz,Mne.EventType=T,Mne.priorityChangeNodeMap=new Map,i((W3=dU).prototype,"contentSize",[Cp,w],Object.getOwnPropertyDescriptor(W3.prototype,"contentSize"),W3.prototype),i(W3.prototype,"anchorPoint",[zp,Xp],Object.getOwnPropertyDescriptor(W3.prototype,"anchorPoint"),W3.prototype),QF=i(W3.prototype,"_contentSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(100,100)}}),ZF=i(W3.prototype,"_anchorPoint",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(.5,.5)}}),cM=W3))||cM)||cM)||cM)||cM)||cM)||cM,Rre({UITransform:Ac,UITransformComponent:Ac}),Ac);function wz(){var e;return(e=$F.call(this)||this)._priority=0,_(e,"_contentSize",QF,p(e)),_(e,"_anchorPoint",ZF,p(e)),e}function Az(){return ez.apply(this,arguments)||this}function Pz(e){return(e=tz.call(this,e=void 0===e?XB:e)||this).isMeshBuffer=!0,e.vData=void 0,e.iData=void 0,e.vertexStart=0,e.vertexRange=0,e.indexStart=0,e.indexRange=0,e.lastFilledIndex=0,e.lastFilledVertex=0,e._byteLength=0,e._vertexBuffers=[],e._indexBuffer=null,e._iaPool=null,e._iaInfo=null,e.vData=new Float32Array(256*e.stride),e.iData=new Uint16Array(1536),e}function Iz(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=iz.call.apply(iz,[this].concat(i))||this).vertDirty=!0,e._data=[],e._indices=[],e._pivotX=0,e._pivotY=0,e._width=0,e._height=0,e.frame=void 0,e.layer=0,e.blendHash=-1,e.textureHash=0,e.nodeDirty=!0,e.passDirty=!0,e.textureDirty=!0,e.hashDirty=!0,e}function Rz(e){void 0===e&&(e=XB),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=XB,this._floatStride=e===XB?hz:KB(e)>>2,this._vertexFormat=e}function Dz(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var i=new cz;i.initWithSize(e,t),this.fontDefDictionary=new AF(i),this._halfBleed=1,this._width=e,this._height=t,ZP.on(KP.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}function Oz(){return nz.apply(this,arguments)||this}function Mz(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}function Nz(){this.pool=[]}ZP.on(KP.EVENT_AFTER_UPDATE,Cz._sortSiblings),ZP.on(KP.EVENT_BEFORE_SCENE_LAUNCH,Cz._cleanChangeMap),(Iie=JF=JF||{})[Iie.DISABLED=0]="DISABLED",Iie[Iie.CLEAR=1]="CLEAR",Iie[Iie.ENTER_LEVEL=2]="ENTER_LEVEL",Iie[Iie.ENABLED=3]="ENABLED",Iie[Iie.EXIT_LEVEL=4]="EXIT_LEVEL",Iie[Iie.CLEAR_INVERTED=5]="CLEAR_INVERTED",Iie[Iie.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED";var Lz,Bz,Fz,zz,Uz,kz,Gz=Rre("StencilManager",((Rie=Hz.prototype).pushMask=function(e){this._maskStack.push(e)},Rie.clear=function(e){e.stencilStage=e.inverted?JF.CLEAR_INVERTED:JF.CLEAR},Rie.enterLevel=function(e){e.graphics.stencilStage=e.inverted?JF.ENTER_LEVEL_INVERTED:JF.ENTER_LEVEL},Rie.enableMask=function(){this.stage=JF.ENABLED},Rie.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=JF.DISABLED:this.stage=JF.ENABLED)},Rie.getWriteMask=function(){return 1<<this._maskStack.length-1},Rie.getExitWriteMask=function(){return 1<<this._maskStack.length},Rie.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},Rie.reset=function(){this._maskStack.length=0,this.stage=JF.DISABLED},Rie.destroy=function(){this.stencilStateMap.forEach(function(e){e.destroy()}),this.stencilStateMap.clear()},Rie.getStencilStage=function(e,t){var i,n=0,r=!1,o=!1,a=Ho.LESS,s=this.stencilStateMap;if(t&&t.passes[0]?(i=c=0,n=(c=(t=t.passes[0].depthStencilState).depthTest?1:c)|(i=t.depthWrite?1:i)<<1|t.depthFunc<<2|e<<6|this._maskStack.length<<9,r=t.depthTest,o=t.depthWrite,a=t.depthFunc,s=this.stencilStateMapWithDepth):n=e<<16|this._maskStack.length,s&&s.has(n))return s.get(n);this.setStateFromStage(e);var c=new al(r,o,a,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return s.set(n,c),c},Rie.getStencilHash=function(e){return e<<8|this._maskStack.length},Rie.setStateFromStage=function(e){var t=this._stencilPattern;e===JF.DISABLED?(t.stencilTest=!1,t.func=Ho.ALWAYS,t.failOp=Vo.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===JF.ENABLED?(t.func=Ho.EQUAL,t.failOp=Vo.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===JF.CLEAR?(t.func=Ho.NEVER,t.failOp=Vo.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===JF.CLEAR_INVERTED||e===JF.ENTER_LEVEL?(t.func=Ho.NEVER,t.failOp=Vo.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===JF.ENTER_LEVEL_INVERTED&&(t.func=Ho.NEVER,t.failOp=Vo.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},e(Hz,[{key:"pattern",get:function(){return this._stencilPattern}}]),Hz));function Hz(){this.stage=JF.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Ho.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Vo.KEEP,zFailOp:Vo.KEEP,passOp:Vo.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}Gz.sharedManager=null,Gz.sharedManager=new Gz,Lt(jo),(x=kz=kz||Rre("InstanceMaterialType",{}))[x.ADD_COLOR=0]="ADD_COLOR",x[x.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",x[x.GRAYSCALE=2]="GRAYSCALE",x[x.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",x[x.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY";Pc=f("cc.Renderable2D"),r=gl(Cz),Bc=Pp(),Ce=v(Ey),tl=v(Ey),Sa=m(),nl=u(),R=Rp(),rl=m(),g=u(),hl=Pc(bp=r(bp=ls(bp=Tp((l(p4,u4=ND),(ll=p4.prototype).updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},ll.__preload=function(){(this.node._uiProps.uiComp=this)._flushAssembler&&this._flushAssembler()},ll.onEnable=function(){this.node.on(T.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(T.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},ll.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},ll.onDisable=function(){this.node.off(T.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(T.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},ll.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._renderData=null,this._blendState&&this._blendState.destroy()},ll.markForUpdateRenderData=function(e){var t;void 0===e&&(e=!0),this._renderFlag=this._canRender(),e&&this._renderFlag?((t=this._renderData)&&(t.vertDirty=!0),this._renderDataFlag=e):e||(this._renderDataFlag=e)},ll.requestRenderData=function(){var e=pz.add();return this._renderData=e},ll.destroyRenderData=function(){this._renderData&&(pz.remove(this._renderData),this._renderData=null)},ll.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},ll.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},ll._render=function(){},ll._postRender=function(){},ll._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&0<this._color.a},ll._postCanRender=function(){},ll.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},ll._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},ll._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new sl,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=jo.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},ll.getBlendState=function(){return this._blendState},ll._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var t=this.node.children[e].getComponent(p4);t&&t.markForUpdateRenderData()}},ll._onMaterialModified=function(e,t){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),u4.prototype._onMaterialModified.call(this,e,t)},ll._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case kz.ADD_COLOR:e=D0.get("ui-base-material");break;case kz.GRAYSCALE:e=D0.get("ui-sprite-gray-material");break;case kz.USE_ALPHA_SEPARATED:e=D0.get("ui-sprite-alpha-sep-material");break;case kz.USE_ALPHA_SEPARATED_AND_GRAY:e=D0.get("ui-sprite-gray-alpha-sep-material");break;default:e=D0.get("ui-sprite-material")}return e},ll.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},ll.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},e(p4,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&J(12001),this._srcBlendFactor},set:function(e){this._customMaterial?J(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&J(12001),this._dstBlendFactor},set:function(e){this._customMaterial?J(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),o=t=p4,t.BlendState=jo,t.Assembler=null,t.PostAssembler=null,Lz=i((ul=o).prototype,"_materials",[Gp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),i(ul.prototype,"sharedMaterials",[Gp,Bc],Object.getOwnPropertyDescriptor(ul.prototype,"sharedMaterials"),ul.prototype),Bz=i(ul.prototype,"_customMaterial",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(ul.prototype,"customMaterial",[tl,Sa,nl,R],Object.getOwnPropertyDescriptor(ul.prototype,"customMaterial"),ul.prototype),i(ul.prototype,"color",[rl,g],Object.getOwnPropertyDescriptor(ul.prototype,"color"),ul.prototype),Fz=i(ul.prototype,"_srcBlendFactor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jo.SRC_ALPHA}}),zz=i(ul.prototype,"_dstBlendFactor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jo.ONE_MINUS_SRC_ALPHA}}),Uz=i(ul.prototype,"_color",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),bp=ul))||bp)||bp)||bp)||bp,Rre({Renderable2D:hl,RenderComponent:hl,UIRenderable:hl});var Vz,jz,Wz,qz,Xz,Yz,Kz,Qz,Zz,Jz,$z,e4,t4,i4,n4,r4,o4,a4,s4,c4,l4,u4,h4=hl;function p4(){var e;return _(e=u4.call(this)||this,"_materials",Lz,p(e)),_(e,"_customMaterial",Bz,p(e)),e.stencilStage=JF.DISABLED,_(e,"_srcBlendFactor",Fz,p(e)),_(e,"_dstBlendFactor",zz,p(e)),_(e,"_color",Uz,p(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new cl,e._blendHash=0,e._lastParent=null,e}j.internal.Renderable2D=h4,(n=a4=a4||Rre("HorizontalTextAlignment",{}))[n.LEFT=0]="LEFT",n[n.CENTER=1]="CENTER",n[n.RIGHT=2]="RIGHT",Lt(a4),(_l=s4=s4||Rre("VerticalTextAlignment",{}))[_l.TOP=0]="TOP",_l[_l.CENTER=1]="CENTER",_l[_l.BOTTOM=2]="BOTTOM",Lt(s4),(I=c4=c4||Rre("Overflow",{}))[I.NONE=0]="NONE",I[I.CLAMP=1]="CLAMP",I[I.SHRINK=2]="SHRINK",I[I.RESIZE_HEIGHT=3]="RESIZE_HEIGHT",Lt(c4),(vie=l4=l4||Rre("CacheMode",{}))[vie.NONE=0]="NONE",vie[vie.BITMAP=1]="BITMAP",vie[vie.CHAR=2]="CHAR",Lt(l4);Lc=f("cc.Label"),b=wp(),xH=Oa(110),uI=Ep(),yI=m(),C7=u(),E=v(a4),Nk=m(),c=u(),A=v(s4),yU=m(),kd=u(),Z5=m(),C=u(),Y3=m(),kp=Pp(),EW=u(),P=m(),bne=u(),Up=Pp(),h=m(),YD=u(),B1=v(c4),Hd=m(),S=u(),kw=m(),Gd=u(),E2=v(mF),ane=m(),a=Pp(),L6=u(),s=m(),XN=u(),y=v(l4),fie=m(),ba=u(),aie=m(),Nw=u(),pi=m(),il=u(),Mne=m(),dU=u(),Cp=Pp(),w=m(),zp=u(),Rie=Lc(Iie=b(Iie=xH(Iie=uI((l(v4,m4=h4),(Xp=v4.prototype).onEnable=function(){m4.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},Xp.onDestroy=function(){var e;this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame&&(this._ttfSpriteFrame._resetDynamicAtlasFrame(),e=this._ttfSpriteFrame.texture,this._ttfSpriteFrame.destroy(),e&&(e.image&&e.image.destroy(),e.destroy()),this._ttfSpriteFrame=null),this._letterTexture=null,m4.prototype.onDestroy.call(this)},Xp.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},Xp._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},Xp._updateColor=function(){m4.prototype._updateColor.call(this),this.updateRenderData(!1)},Xp._canRender=function(){if(!m4.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof PF){e=e.spriteFrame;if(!e||!e.texture)return!1}return!0},Xp._flushAssembler=function(){var e=v4.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},Xp._applyFontTexture=function(){this.markForUpdateRenderData();var e,t=this._font;t instanceof PF?(t=t.spriteFrame)&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this)):(this.cacheMode===l4.CHAR?(this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture):this._ttfSpriteFrame||(this._ttfSpriteFrame=new lF,this._assemblerData=this._assembler.getAssemblerData(),t=new Lv(this._assemblerData.canvas),(e=new i0).image=t,this._ttfSpriteFrame.texture=e),this.cacheMode!==l4.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine())},Xp.changeMaterialForDefine=function(){var e,t;this._texture&&(t=!1,this.cacheMode!==l4.CHAR&&(e=this._texture.texture)instanceof Uv&&(t=(e=e.getPixelFormat())===pv.RGBA_ETC1||e===pv.RGB_A_PVRTC_4BPPV1||e===pv.RGB_A_PVRTC_2BPPV1),this._instanceMaterialType=t?kz.USE_ALPHA_SEPARATED:kz.ADD_COLOR_AND_TEXTURE,this.updateMaterial())},e(v4,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==l4.BITMAP||this._font instanceof PF||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===l4.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof PF?this._font.fontSize:-1}}]),cM=W3=v4,W3.HorizontalAlign=a4,W3.VerticalAlign=s4,W3.Overflow=c4,W3.CacheMode=l4,W3._canvasPool=rz.getInstance(),i((Ac=cM).prototype,"string",[yI,C7,Bp],Object.getOwnPropertyDescriptor(Ac.prototype,"string"),Ac.prototype),i(Ac.prototype,"horizontalAlign",[E,Nk,c],Object.getOwnPropertyDescriptor(Ac.prototype,"horizontalAlign"),Ac.prototype),i(Ac.prototype,"verticalAlign",[A,yU,kd],Object.getOwnPropertyDescriptor(Ac.prototype,"verticalAlign"),Ac.prototype),i(Ac.prototype,"fontSize",[Z5,C],Object.getOwnPropertyDescriptor(Ac.prototype,"fontSize"),Ac.prototype),i(Ac.prototype,"fontFamily",[Y3,kp,EW],Object.getOwnPropertyDescriptor(Ac.prototype,"fontFamily"),Ac.prototype),i(Ac.prototype,"lineHeight",[P,bne],Object.getOwnPropertyDescriptor(Ac.prototype,"lineHeight"),Ac.prototype),i(Ac.prototype,"spacingX",[Up,h,YD],Object.getOwnPropertyDescriptor(Ac.prototype,"spacingX"),Ac.prototype),i(Ac.prototype,"overflow",[B1,Hd,S],Object.getOwnPropertyDescriptor(Ac.prototype,"overflow"),Ac.prototype),i(Ac.prototype,"enableWrapText",[kw,Gd],Object.getOwnPropertyDescriptor(Ac.prototype,"enableWrapText"),Ac.prototype),i(Ac.prototype,"font",[E2,ane,a,L6],Object.getOwnPropertyDescriptor(Ac.prototype,"font"),Ac.prototype),i(Ac.prototype,"useSystemFont",[s,XN],Object.getOwnPropertyDescriptor(Ac.prototype,"useSystemFont"),Ac.prototype),i(Ac.prototype,"cacheMode",[y,fie,ba],Object.getOwnPropertyDescriptor(Ac.prototype,"cacheMode"),Ac.prototype),i(Ac.prototype,"isBold",[aie,Nw],Object.getOwnPropertyDescriptor(Ac.prototype,"isBold"),Ac.prototype),i(Ac.prototype,"isItalic",[pi,il],Object.getOwnPropertyDescriptor(Ac.prototype,"isItalic"),Ac.prototype),i(Ac.prototype,"isUnderline",[Mne,dU],Object.getOwnPropertyDescriptor(Ac.prototype,"isUnderline"),Ac.prototype),i(Ac.prototype,"underlineHeight",[Cp,Ap,w,zp],Object.getOwnPropertyDescriptor(Ac.prototype,"underlineHeight"),Ac.prototype),Vz=i(Ac.prototype,"_string",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),jz=i(Ac.prototype,"_horizontalAlign",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a4.CENTER}}),Wz=i(Ac.prototype,"_verticalAlign",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s4.CENTER}}),qz=i(Ac.prototype,"_actualFontSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xz=i(Ac.prototype,"_fontSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Yz=i(Ac.prototype,"_fontFamily",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Kz=i(Ac.prototype,"_lineHeight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Qz=i(Ac.prototype,"_overflow",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c4.NONE}}),Zz=i(Ac.prototype,"_enableWrapText",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jz=i(Ac.prototype,"_font",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$z=i(Ac.prototype,"_isSystemFontUsed",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),e4=i(Ac.prototype,"_spacingX",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),t4=i(Ac.prototype,"_isItalic",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i4=i(Ac.prototype,"_isBold",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n4=i(Ac.prototype,"_isUnderline",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r4=i(Ac.prototype,"_underlineHeight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),o4=i(Ac.prototype,"_cacheMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l4.NONE}}),Iie=Ac))||Iie)||Iie)||Iie)||Iie,Rre({Label:Rie,LabelComponent:Rie});var _4,f4,d4,m4,g4=Rie;function v4(){var e;return _(e=m4.call(this)||this,"_string",Vz,p(e)),_(e,"_horizontalAlign",jz,p(e)),_(e,"_verticalAlign",Wz,p(e)),_(e,"_actualFontSize",qz,p(e)),_(e,"_fontSize",Xz,p(e)),_(e,"_fontFamily",Yz,p(e)),_(e,"_lineHeight",Kz,p(e)),_(e,"_overflow",Qz,p(e)),_(e,"_enableWrapText",Zz,p(e)),_(e,"_font",Jz,p(e)),_(e,"_isSystemFontUsed",$z,p(e)),_(e,"_spacingX",e4,p(e)),_(e,"_isItalic",t4,p(e)),_(e,"_isBold",i4,p(e)),_(e,"_isUnderline",n4,p(e)),_(e,"_underlineHeight",r4,p(e)),_(e,"_cacheMode",o4,p(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}(x=_4=_4||{})[x.BUTT=0]="BUTT",x[x.ROUND=1]="ROUND",x[x.SQUARE=2]="SQUARE",Lt(_4),(Pc=f4=f4||{})[Pc.BEVEL=0]="BEVEL",Pc[Pc.ROUND=1]="ROUND",Pc[Pc.MITER=2]="MITER",Lt(f4),(r=d4=d4||{})[r.PT_CORNER=1]="PT_CORNER",r[r.PT_LEFT=2]="PT_LEFT",r[r.PT_BEVEL=4]="PT_BEVEL",r[r.PT_INNERBEVEL=8]="PT_INNERBEVEL",Lt(d4);var y4=Math.PI,x4=Math.min,S4=Math.max,b4=Math.cos,T4=Math.sin,E4=Math.abs,C4=Math.sign,w4=.5522847493;function A4(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*w4,t-n*w4,i+r,t,i+r),e.bezierCurveTo(t+n*w4,i+r,t+n,i+r*w4,t+n,i),e.bezierCurveTo(t+n,i-r*w4,t+n*w4,i-r,t,i-r),e.bezierCurveTo(t-n*w4,i-r,t-n,i-r*w4,t-n,i),e.close()}l(i3,G4=U),i3.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0};var P4,I4,R4,D4,O4,M4,N4,L4,B4,F4,z4,U4,k4,G4,H4=i3,V4=(t3.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t3),j4=((ll=e3.prototype).moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,d4.PT_CORNER),this._commandX=e,this._commandY=t},ll.lineTo=function(e,t){this.addPoint(e,t,d4.PT_CORNER),this._commandX=e,this._commandY=t},ll.bezierCurveTo=function(e,t,i,n,r,o){var a=this._curPath,a=a.points[a.points.length-1];a&&(a.x!==e||a.y!==t||i!==r||n!==o?(function e(t,i,n,r,o,a,s,c,l,u,h){var p,_,f,d,m,g,v,y,x;10<u||(m=.5*(a+c),g=.5*(s+l),v=.5*((p=.5*(i+r))+(f=.5*(r+a))),y=.5*((_=.5*(n+o))+(d=.5*(o+s))),((x=E4((r-c)*(r=l-n)-(o-l)*(o=c-i)))+(a=E4((a-c)*r-(s-l)*o)))*(x+a)<t.tessTol*(o*o+r*r)?t.addPoint(c,l,0===h?h|d4.PT_BEVEL:h):(e(t,i,n,p,_,v,y,x=.5*(v+(s=.5*(f+m))),o=.5*(y+(a=.5*(d+g))),u+1,0),e(t,x,o,s,a,m,g,c,l,u+1,h)))}(this,a.x,a.y,e,t,i,n,r,o,0,d4.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},ll.quadraticCurveTo=function(e,t,i,n){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),i+2/3*(e-i),n+2/3*(t-n),i,n)},ll.arc=function(e,t,i,n,r,o){var a,s,c,l,u,h=this,p=e,_=t,f=i,d=n,e=void 0,m=0,g=0,v=0,y=0,x=0,S=0,b=0,m=r-d;if(e=o||!1)if(E4(m)>=2*y4)m=2*y4;else for(;m<0;)m+=2*y4;else if(E4(m)>=2*y4)m=2*-y4;else for(;0<m;)m-=2*y4;for(a=0|S4(1,x4(E4(m)/(.5*y4)+.5,5)),g=E4(4/3*(1-b4(t=m/a/2))/T4(t)),e||(g=-g),b=0;b<=a;b++)s=p+(u=b4(l=d+m*(b/a)))*f,c=_+(l=T4(l))*f,l=-l*f*g,u=u*f*g,0===b?h.moveTo(s,c):h.bezierCurveTo(v+x,y+S,s-l,c-u,s,c),v=s,y=c,x=l,S=u},ll.ellipse=function(e,t,i,n){A4(this,e,t,i,n),this._curPath.complex=!1},ll.circle=function(e,t,i){A4(this,e,t,i,i),this._curPath.complex=!1},ll.rect=function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1},ll.roundRect=function(e,t,i,n,r){var o,a;o=this,e=e,t=t,i=i,n=n,(r=r)<.1?o.rect(e,t,i,n):(a=x4(r,.5*E4(i))*C4(i),r=x4(r,.5*E4(n))*C4(n),o.moveTo(e,t+r),o.lineTo(e,t+n-r),o.bezierCurveTo(e,t+n-r*(1-w4),e+a*(1-w4),t+n,e+a,t+n),o.lineTo(e+i-a,t+n),o.bezierCurveTo(e+i-a*(1-w4),t+n,e+i,t+n-r*(1-w4),e+i,t+n-r),o.lineTo(e+i,t+r),o.bezierCurveTo(e+i,t+r*(1-w4),e+i-a*(1-w4),t,e+i-a,t),o.lineTo(e+a,t),o.bezierCurveTo(e+a*(1-w4),t,e,t+r*(1-w4),e,t+r),o.close()),this._curPath.complex=!1},ll.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,i=e.length;t<i;t++){var n=e[t];n&&_z.remove(n)}this._renderDataList.length=0},ll.close=function(){this._curPath.closed=!0},ll.requestRenderData=function(){var e=_z.add();return this._renderDataList.push(e),e},ll.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},ll.addPoint=function(e,t,i){var n,r,o=this._curPath;o&&(n=this._points,o=o.points,(r=n[this.pointsOffset++])?(r.x=e,r.y=t):(r=new H4(e,t),n.push(r)),r.flags=i,o.push(r))},ll._addPath=function(){var e=this.pathLength,e=this.paths[e];return e?e.reset():(e=new V4,this.paths.push(e)),this.pathLength++,this._curPath=e},e3),W4=vI.concat([new Wa("a_dist",W.R32F)]),q4=YB(W4),X4=KB(W4),Y4=(t=f("cc.Graphics"),o=wp(),Bc=Oa(110),Ce=Ep(),tl=u(),Sa=v(f4),nl=u(),R=v(_4),rl=u(),g=u(),ul=u(),bp=u(),hl=Pp(),b=t(Lc=o(Lc=Bc(Lc=Ce((l($4,k4=h4),(n=$4.prototype).onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=ZP.root.createModel($0),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){k4.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){k4.prototype.onDisable.call(this)},n.onDestroy=function(){k4.prototype.onDestroy.call(this),this._sceneGetter=null,this.model&&(ZP.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(0<e){for(var t=0;t<e;++t)this._graphicsUseSubMeshes[t].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,i,n,r,o){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,o)},n.quadraticCurveTo=function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)},n.arc=function(e,t,i,n,r,o){this.impl&&this.impl.arc(e,t,i,n,r,o)},n.ellipse=function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)},n.circle=function(e,t,i){this.impl&&this.impl.circle(e,t,i)},n.rect=function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)},n.roundRect=function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)},n.fillRect=function(e,t,i,n){this.rect(e,t,i,n),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?this.getMaterialInstance(0):(e=D0.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){var t,i;this.model?this.model.subModels.length<=e&&(i=(t=j.director.root.device).createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,65535*X4,X4)),t=t.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),(i=new yE([i],W4,$o.TRIANGLE_LIST,t)).subMeshIdx=0,this.model.initSubModel(e,i,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(i)):J(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var i=this.model.subModels,n=0;n<t.length;n++){var r,o=t[n],a=i[n].inputAssembler;o.lastFilledVertex!==o.vertexStart&&(r=new Float32Array(o.vData.buffer,0,o.vertexStart*q4),a.vertexBuffers[0].update(r),a.vertexCount=o.vertexStart,r=new Uint16Array(o.iData.buffer,0,o.indexStart),a.indexBuffer.update(r),a.indexCount=o.indexStart,o.lastFilledVertex=o.vertexStart,o.lastFilledIndex=o.indexStart)}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),i=this.model.subModels.length;if(t.length>i)for(var n=i;n<t.length;n++)this.activeSubModel(n)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=$4.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!k4.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},e($4,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),I=_l=$4,_l.LineJoin=f4,_l.LineCap=_4,i((vie=I).prototype,"lineWidth",[Ap,tl],Object.getOwnPropertyDescriptor(vie.prototype,"lineWidth"),vie.prototype),i(vie.prototype,"lineJoin",[Sa,nl],Object.getOwnPropertyDescriptor(vie.prototype,"lineJoin"),vie.prototype),i(vie.prototype,"lineCap",[R,rl],Object.getOwnPropertyDescriptor(vie.prototype,"lineCap"),vie.prototype),i(vie.prototype,"strokeColor",[g],Object.getOwnPropertyDescriptor(vie.prototype,"strokeColor"),vie.prototype),i(vie.prototype,"fillColor",[ul],Object.getOwnPropertyDescriptor(vie.prototype,"fillColor"),vie.prototype),i(vie.prototype,"miterLimit",[bp],Object.getOwnPropertyDescriptor(vie.prototype,"miterLimit"),vie.prototype),i(vie.prototype,"color",[Gp,hl],Object.getOwnPropertyDescriptor(vie.prototype,"color"),vie.prototype),P4=i(vie.prototype,"_lineWidth",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),I4=i(vie.prototype,"_strokeColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.BLACK.clone()}}),R4=i(vie.prototype,"_lineJoin",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f4.MITER}}),D4=i(vie.prototype,"_lineCap",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _4.BUTT}}),O4=i(vie.prototype,"_fillColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),M4=i(vie.prototype,"_miterLimit",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Lc=vie))||Lc)||Lc)||Lc)||Lc,Rre({Graphics:b,GraphicsComponent:b}),b),K4=new B,Q4=new U,Z4=new B,J4=[];function $4(){var e;return(e=k4.call(this)||this).impl=null,e.model=null,_(e,"_lineWidth",P4,p(e)),_(e,"_strokeColor",I4,p(e)),_(e,"_lineJoin",R4,p(e)),_(e,"_lineCap",D4,p(e)),_(e,"_fillColor",O4,p(e)),_(e,"_miterLimit",M4,p(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=kz.ADD_COLOR,e.impl=new j4,e}function e3(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=nr.WHITE.clone(),this.lineCap=_4.BUTT,this.strokeColor=nr.BLACK.clone(),this.lineJoin=f4.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}function t3(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}function i3(e,t){return(e=G4.call(this,e,t)||this).dx=0,e.dy=0,e.dmx=0,e.dmy=0,e.flags=0,e.len=0,e.reset(),e}(xH=U4=U4||{})[xH.RECT=0]="RECT",xH[xH.ELLIPSE=1]="ELLIPSE",xH[xH.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",xH[xH.IMAGE_STENCIL=3]="IMAGE_STENCIL",Lt(U4);uI=f("cc.Mask"),Xp=wp(),W3=Oa(110),cM=Ep(),yI=v(U4),C7=m(),E=u(),Nk=m(),c=u(),A=Pp(),yU=v(lF),kd=Pp(),Z5=Pp(),C=Dp(),Y3=Pp(),kp=Pp(),Up=uI(bne=Xp(bne=W3(bne=cM((l(r3,n3=h4),(EW=r3.prototype).onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},EW.onEnable=function(){n3.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},EW.onRestore=function(){this._createGraphics(),n3.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},EW.onDisable=function(){n3.prototype.onDisable.call(this),this._disableGraphics()},EW.onDestroy=function(){n3.prototype.onDestroy.call(this),this._clearModel&&this._clearModelMesh&&(ZP.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()},EW.isHit=function(e){var t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=i.width,i=i.height,r=Q4,e=(this.node.getWorldMatrix(K4),B.invert(Z4,K4),U.transformMat4(r,e,Z4),t.anchorPoint),t=(r.x+=e.x*n,r.y+=e.y*i,!1);return this.type===U4.RECT||this.type===U4.GRAPHICS_STENCIL||this.type===U4.IMAGE_STENCIL?t=0<=r.x&&0<=r.y&&r.x<=n&&r.y<=i:this.type===U4.ELLIPSE&&(t=(e=r.x-.5*n)*e/((e=n/2)*e)+(n=r.y-.5*i)*n/((e=i/2)*e)<1),t=this._inverted?!t:t},EW._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},EW._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},EW._nodeStateChange=function(e){n3.prototype._nodeStateChange.call(this,e),this._updateGraphics()},EW._canRender=function(){return!!n3.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==U4.IMAGE_STENCIL||null!==this._spriteFrame)},EW._flushAssembler=function(){var e=r3.Assembler.getAssembler(this),t=r3.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._useRenderData()},EW._createGraphics=function(){var e,t;this._graphics||((e=this._graphics=new Y4)._objFlags|=Pi.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0,(t=nr.WHITE.clone()).a=0,e.fillColor=t),this._updateMaterial()},EW._updateGraphics=function(){if(this._graphics&&(this._type===U4.RECT||this._type===U4.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics,i=(t.clear(),e.contentSize),n=i.width,i=i.height,e=e.anchorPoint,r=-n*e.x,e=-i*e.y;if(this._type===U4.RECT)t.rect(r,e,n,i);else if(this._type===U4.ELLIPSE){for(var o=function(e,t,i){J4.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)J4.push(new ce(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return J4}(new ce(r+n/2,e+i/2,0),new ce(n/2,i/2,0),this._segments),a=0;a<o.length;++a){var s=o[a];0===a?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y)}t.close()}t.fill()}},EW._createClearModel=function(){var e,t,i;this._clearModel||(e=D0.get("default-clear-stencil"),this._clearStencilMtl=new Hy({parent:e,owner:this,subModelIdx:0}),this._clearModel=ZP.root.createModel($0),this._clearModel.node=this._clearModel.transform=this.node,e=KB(qB),e=(i=j.director.root.device).createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,4*e,e)),t=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]),e.update(t),t=i.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),i=new Uint16Array([0,1,2,2,1,3]),t.update(i),this._clearModelMesh=new yE([e],qB,$o.TRIANGLE_LIST,t),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl))},EW._updateMaterial=function(){var e,t;this._graphics&&((t=this._graphics).stencilStage=JF.DISABLED,this._type===U4.IMAGE_STENCIL?(e=D0.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=D0.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0)))},EW._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},EW._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},EW._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},EW._useRenderData=function(){this._type!==U4.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},e(r3,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==U4.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=JF.DISABLED,this._graphics&&(this._graphics.stencilStage=JF.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=Fn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){var t;this._spriteFrame!==e&&(t=this._spriteFrame,this._spriteFrame=e,this._type===U4.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData())}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===U4.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),r3.Type=U4,i((P=r3).prototype,"type",[yI,C7,E],Object.getOwnPropertyDescriptor(P.prototype,"type"),P.prototype),i(P.prototype,"inverted",[Nk,c],Object.getOwnPropertyDescriptor(P.prototype,"inverted"),P.prototype),i(P.prototype,"segments",[A],Object.getOwnPropertyDescriptor(P.prototype,"segments"),P.prototype),i(P.prototype,"spriteFrame",[yU,kd],Object.getOwnPropertyDescriptor(P.prototype,"spriteFrame"),P.prototype),i(P.prototype,"alphaThreshold",[Z5,C,Np],Object.getOwnPropertyDescriptor(P.prototype,"alphaThreshold"),P.prototype),i(P.prototype,"color",[Gp,Y3],Object.getOwnPropertyDescriptor(P.prototype,"color"),P.prototype),i(P.prototype,"customMaterial",[Gp,kp],Object.getOwnPropertyDescriptor(P.prototype,"customMaterial"),P.prototype),N4=i(P.prototype,"_type",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U4.RECT}}),L4=i(P.prototype,"_inverted",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B4=i(P.prototype,"_segments",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),F4=i(P.prototype,"_spriteFrame",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),z4=i(P.prototype,"_alphaThreshold",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),bne=P))||bne)||bne)||bne)||bne,Rre({Mask:Up,MaskComponent:Up});var n3,h=Up;function r3(){var e;return(e=n3.call(this)||this)._clearStencilMtl=null,e._clearModel=null,_(e,"_type",N4,p(e)),_(e,"_inverted",L4,p(e)),_(e,"_segments",B4,p(e)),_(e,"_spriteFrame",F4,p(e)),_(e,"_alphaThreshold",z4,p(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=kz.ADD_COLOR,e}EC._maskComp=h,j.Mask=h;var o3,a3,s3,c3,l3,u3,h3,p3,_3,f3,d3,m3,g3,v3,y3,x3,S3=/^(click)(\s)*=|(param)(\s)*=/,b3=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,B1=Rre("HtmlTextParser",((YD=C3.prototype).parse=function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var n,r,o=e.indexOf(">",t),a=-1;0<=o&&(a=e.lastIndexOf("<",o))<t-1&&(a=e.indexOf("<",o+1),o=e.indexOf(">",a+1)),t=a<0?(this._stack.pop(),this._processResult(e.substring(t)),i):(n=e.substring(t,a),""===(r=e.substring(a+1,o))&&(n=e.substring(t,o+1)),this._processResult(n),-1===o?o=a:"/"===e.charAt(a+1)?this._stack.pop():this._addToStack(r),o+1)}return this._resultObjectArray},YD._attributeToObject=function(e){e=e.trim();var t,i={},n="",r=0;if(s=/^(color|size)(\s)*=/.exec(e)){if(n=s[0],""===(e=e.substring(n.length).trim()))return i;switch(r=e.indexOf(" "),n[0]){case"c":i.color=-1<r?e.substring(0,r).trim():e;break;case"s":i.size=parseInt(e)}return-1<r&&(t=e.substring(r+1).trim(),i.event=this._processEventHandler(t)),i}if((s=/^(br(\s)*\/)/.exec(e))&&0<s[0].length&&(n=s[0].trim()).startsWith("br")&&"/"===n[n.length-1])return i.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),i;var o="";if((s=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&0<s[0].length&&(n=s[0].trim()).startsWith("img")&&"/"===n[n.length-1]){for(var a,s=b3.exec(e),c=!1;s;){if(n=(e=e.substring(e.indexOf(s[0]))).substr(0,s[0].length),a=-1<(r=(o=e.substring(n.length).trim()).indexOf(" "))?o.substr(0,r):o,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),a.endsWith("/")&&(a=a.slice(0,-1)),"src"===n){switch(a.charCodeAt(0)){case 34:case 39:c=!0,a=a.slice(1,-1)}i.isImage=!0,i.src=a}else if("height"===n)i.imageHeight=parseInt(a);else if("width"===n)i.imageWidth=parseInt(a);else if("align"===n){switch(a.charCodeAt(0)){case 34:case 39:a=a.slice(1,-1)}i.imageAlign=a.toLowerCase()}else"offset"===n?i.imageOffset=a:"click"===n&&(i.event=this._processEventHandler(n+"="+a));i.event&&"param"===n&&(i.event[n]=a.replace(/^"|"$/g,"")),s=b3.exec(e)}return c&&i.isImage&&this._resultObjectArray.push({text:"",style:i}),{}}if(s=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=s[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(s=h.exec(e);s;)n=(e=e.substring(e.indexOf(s[0]))).substr(0,s[0].length),u=-1<(r=(o=e.substring(n.length).trim()).indexOf(" "))?o.substr(0,r):o,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=o.substring(r).trim(),"click"===n?i.event=this._processEventHandler(n+"="+u):"color"===n?l.color=u:"width"===n&&(l.width=parseInt(u)),i.event&&"param"===n&&(i.event[n]=u.replace(/^"|"$/g,"")),s=h.exec(e)}i.outline=l}if((s=/^(on|u|b|i)(\s)*/.exec(e))&&0<s[0].length){switch(n=s[0],e=e.substring(n.length).trim(),n[0]){case"u":i.underline=!0;break;case"i":i.italic=!0;break;case"b":i.bold=!0}if(""===e)return i;i.event=this._processEventHandler(e)}return i},YD._processEventHandler=function(e){for(var t={},i=0,n=!1,r=S3.exec(e);r;){var o,a=r[0],s="",n=!1;'"'===(e=e.substring(a.length).trim()).charAt(0)?(-1<(i=e.indexOf('"',1))&&(s=e.substring(1,i).trim(),n=!0),i++):"'"===e.charAt(0)?(-1<(i=e.indexOf("'",1))&&(s=e.substring(1,i).trim(),n=!0),i++):i=(s=(o=/(\S)+/.exec(e))?o[0]:"").length,n&&(t[a=a.substring(0,a.length-1).trim()]=s),e=e.substring(i).trim(),r=S3.exec(e)}return t},YD._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else if(!t.isNewLine&&!t.isImage){var i,n=this._stack[this._stack.length-1];for(i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},YD._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},YD._escapeSpecialSymbol=function(e){for(var t=ge(this._specialSymbolArray);!(i=t()).done;){var i=i.value,n=i[0],i=i[1];e=e.replace(n,i)}return e},C3)),T3=(Hd=f("cc.LabelOutline"),S=wp(),kw=Oa(110),Gd=Ep(),E2=gl(g4),ane=u(),a=u(),y=Hd(XN=S(XN=kw(XN=Gd(XN=E2(XN=Tp((l(E3,x3=W_),(L6=E3.prototype).onEnable=function(){this._updateRenderData()},L6.onDisable=function(){this._updateRenderData()},L6._updateRenderData=function(){var e=this.node.getComponent(g4);e&&e.updateRenderData(!0)},e(E3,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),o3=i((s=E3).prototype,"_color",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(0,0,0,255)}}),a3=i(s.prototype,"_width",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),i(s.prototype,"color",[ane],Object.getOwnPropertyDescriptor(s.prototype,"color"),s.prototype),i(s.prototype,"width",[a],Object.getOwnPropertyDescriptor(s.prototype,"width"),s.prototype),XN=s))||XN)||XN)||XN)||XN)||XN)||XN,Rre({LabelOutline:y,LabelOutlineComponent:y}),y);function E3(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=x3.call.apply(x3,[this].concat(i))||this,"_color",o3,p(e)),_(e,"_width",a3,p(e)),e}function C3(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}(fie=g3=g3||{})[fie.SIMPLE=0]="SIMPLE",fie[fie.SLICED=1]="SLICED",fie[fie.TILED=2]="TILED",fie[fie.FILLED=3]="FILLED",Lt(g3),(ba=v3=v3||{})[ba.HORIZONTAL=0]="HORIZONTAL",ba[ba.VERTICAL=1]="VERTICAL",ba[ba.RADIAL=2]="RADIAL",Lt(v3),(aie=y3=y3||{})[aie.CUSTOM=0]="CUSTOM",aie[aie.TRIMMED=1]="TRIMMED",aie[aie.RAW=2]="RAW",Lt(y3),(die=die||{}).SPRITE_FRAME_CHANGED="spriteframe-changed";Nw=f("cc.Sprite"),pi=wp(),il=Oa(110),Mne=Ep(),dU=v(Ey),Cp=m(),w=Rp(),zp=v(pF),Ac=m(),Iie=u(),Rie=v(lF),x=m(),Pc=u(),r=v(g3),ll=m(),vI=u(),t=v(v3),o=u(),Bc=u(),Ce=Dp(),n=u(),_l=Dp(),I=u(),tl=Pp(),Sa=m(),nl=u(),R=u(),rl=v(y3),g=m(),ul=u(),xH=Nw(b=pi(b=il(b=Mne((l(Z3,H3=h4),(bp=Z3.prototype).__preload=function(){this.changeMaterialForDefine(),H3.prototype.__preload.call(this)},bp.onEnable=function(){H3.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===g3.SLICED&&e.on(lF.EVENT_UV_UPDATED,this._updateUVs,this))},bp.onDisable=function(){this._spriteFrame&&this._type===g3.SLICED&&this._spriteFrame.off(lF.EVENT_UV_UPDATED,this._updateUVs,this)},bp.onDestroy=function(){this.destroyRenderData(),H3.prototype.onDestroy.call(this)},bp.changeSpriteFrameFromAtlas=function(e){this._atlas?(e=this._atlas.getSpriteFrame(e),this.spriteFrame=e):console.warn("SpriteAtlas is null.")},bp.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType,i=!1;(i=(e=this._spriteFrame?this._spriteFrame.texture:e)instanceof Uv?(e=e.getPixelFormat())===pv.RGBA_ETC1||e===pv.RGB_A_PVRTC_4BPPV1||e===pv.RGB_A_PVRTC_2BPPV1:i)&&this.grayscale?this._instanceMaterialType=kz.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=kz.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=kz.GRAYSCALE:this._instanceMaterialType=kz.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},bp._updateBuiltinMaterial=function(){var e,t,i=H3.prototype._updateBuiltinMaterial.call(this);return this.spriteFrame&&this.spriteFrame.texture instanceof cb&&(e=ue({SAMPLE_FROM_RT:!0},i.passes[0].defines),(t=new Ey).initialize({effectAsset:i.effectAsset,defines:e}),i=t),i},bp._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},bp._canRender=function(){if(!H3.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},bp._flushAssembler=function(){var e=Z3.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===g3.SLICED?this._spriteFrame.on(lF.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(lF.EVENT_UV_UPDATED,this._updateUVs,this))},bp._applySpriteSize=function(){var e;this._spriteFrame&&(this._spriteFrame.isDefault||(y3.RAW===this._sizeMode?(e=this._spriteFrame.originalSize,this.node._uiProps.uiTransformComp.setContentSize(e)):y3.TRIMMED===this._sizeMode&&(e=this._spriteFrame.rect,this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height))),this._activateMaterial())},bp._resized=function(){},bp._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},bp._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},bp._applySpriteFrame=function(e){var t=this._spriteFrame,i=(e&&this._type===g3.SLICED&&e.off(lF.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs(),!1);t&&((i=e&&e.texture===t.texture?i:!0)&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===g3.SLICED&&t.on(lF.EVENT_UV_UPDATED,this._updateUVs,this))},bp._calculateSlicedData=function(e){var t=this.node._uiProps.uiTransformComp.contentSize,i=t.width,t=t.height,n=this.spriteFrame.insetLeft,r=i-n-this.spriteFrame.insetRight,o=this.spriteFrame.insetTop,a=t-o-this.spriteFrame.insetBottom;return e.length=0,e[0]=n/i,e[1]=o/t,e[2]=(n+r)/i,e[3]=(o+a)/t,e},bp.calculateTiledData=function(e){var t=this.node._uiProps.uiTransformComp.contentSize,i=this.spriteFrame.rect;e.x=t.width/i.width,e.y=t.height/i.height},bp._updateUVWithTrim=function(){this.tillingOffsetWithTrim.length=0;var e=this.spriteFrame,t=e.originalSize,i=e.rect,n=e.texture,r=n.width,n=n.height,o=0,a=0,i=(e.original&&(o=i.x-e.original._x,a=i.y-e.original._y),0===r?0:o/r),s=0===r?1:(o+t.width)/r,c=0===n?1:(a+t.height)/n,l=0===n?0:a/n;e.rotated&&(i=0===r?0:o/r,s=0===r?1:(o+t.height)/r,l=0===n?0:a/n,c=0===n?1:(a+t.width)/n),this.tillingOffsetWithTrim[0]=s-i,this.tillingOffsetWithTrim[1]=c-l,this.tillingOffsetWithTrim[2]=i,this.tillingOffsetWithTrim[3]=l,e.rotated&&(this.tillingOffsetWithTrim[0]=-this.tillingOffsetWithTrim[0])},e(Z3,[{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){var t;this._spriteFrame!==e&&(t=this._spriteFrame,this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t))}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===v3.RADIAL||this._fillType===v3.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===g3.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=Fn(e,0,1),this._type===g3.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=Fn(e,-1,1),this._type===g3.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===g3.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?kz.GRAYSCALE:kz.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&((this._sizeMode=e)!==y3.CUSTOM&&this._applySpriteSize())}}]),vie=hl=Z3,hl.FillType=v3,hl.Type=g3,hl.SizeMode=y3,hl.EventType=die,i((Lc=vie).prototype,"customMaterial",[dU,Cp,w,Gp],Object.getOwnPropertyDescriptor(Lc.prototype,"customMaterial"),Lc.prototype),i(Lc.prototype,"spriteAtlas",[zp,Ac,Iie],Object.getOwnPropertyDescriptor(Lc.prototype,"spriteAtlas"),Lc.prototype),i(Lc.prototype,"spriteFrame",[Rie,x,Pc],Object.getOwnPropertyDescriptor(Lc.prototype,"spriteFrame"),Lc.prototype),i(Lc.prototype,"type",[r,ll,vI],Object.getOwnPropertyDescriptor(Lc.prototype,"type"),Lc.prototype),i(Lc.prototype,"fillType",[t,o],Object.getOwnPropertyDescriptor(Lc.prototype,"fillType"),Lc.prototype),i(Lc.prototype,"fillCenter",[Bc],Object.getOwnPropertyDescriptor(Lc.prototype,"fillCenter"),Lc.prototype),i(Lc.prototype,"fillStart",[Ce,n],Object.getOwnPropertyDescriptor(Lc.prototype,"fillStart"),Lc.prototype),i(Lc.prototype,"fillRange",[_l,I],Object.getOwnPropertyDescriptor(Lc.prototype,"fillRange"),Lc.prototype),i(Lc.prototype,"trim",[tl,Sa,nl],Object.getOwnPropertyDescriptor(Lc.prototype,"trim"),Lc.prototype),i(Lc.prototype,"grayscale",[Ap,R],Object.getOwnPropertyDescriptor(Lc.prototype,"grayscale"),Lc.prototype),i(Lc.prototype,"sizeMode",[rl,g,ul],Object.getOwnPropertyDescriptor(Lc.prototype,"sizeMode"),Lc.prototype),s3=i(Lc.prototype,"_spriteFrame",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c3=i(Lc.prototype,"_type",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return g3.SIMPLE}}),l3=i(Lc.prototype,"_fillType",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return v3.HORIZONTAL}}),u3=i(Lc.prototype,"_sizeMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return y3.TRIMMED}}),h3=i(Lc.prototype,"_fillCenter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(0,0)}}),p3=i(Lc.prototype,"_fillStart",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_3=i(Lc.prototype,"_fillRange",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f3=i(Lc.prototype,"_isTrimmedMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),d3=i(Lc.prototype,"_useGrayscale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m3=i(Lc.prototype,"_atlas",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),b=Lc))||b)||b)||b)||b,Rre({Sprite:xH,SpriteComponent:xH});var w3,A3,P3,I3,R3,D3,O3,M3,N3,L3,B3,F3,z3,U3,k3,G3,H3,V3,j3=xH,W3=Rre("RenderRoot2D",f("cc.RenderRoot2D")(Xp=Oa(100)(Xp=Ep()(Xp=gl(Cz)(Xp=ls(Xp=Tp((l(Q3,G3=W_),(uI=Q3.prototype).onEnable=function(){j.director.root.batcher2D.addScreen(this)},uI.onDisable=function(){j.director.root.batcher2D.removeScreen(this)},uI.onDestroy=function(){j.director.root.batcher2D.removeScreen(this)},Xp=Q3))||Xp)||Xp)||Xp)||Xp)||Xp)||Xp),q3=new ce,X3=Ot({OVERLAY:0,INTERSPERSE:1}),Y3=(cM=f("cc.Canvas"),EW=wp(),yI=Oa(100),C7=Ep(),E=v(PD),Nk=u(),c=u(),A=v(PD),C=cM(Z5=EW(Z5=yI(Z5=C7(Z5=Tp(Z5=ls((i((l(K3,k3=W3),(yU=K3.prototype).__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(PD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(T.TRANSFORM_CHANGED,this._thisOnCameraResized)},yU.onEnable=function(){k3.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(PD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},yU.onDisable=function(){k3.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(PD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},yU.onDestroy=function(){k3.prototype.onDestroy.call(this),this.node.off(T.TRANSFORM_CHANGED,this._thisOnCameraResized)},yU._onResizeCamera=function(){var e;this._cameraComponent&&this._alignCanvasWithScreen&&(this._cameraComponent.targetTexture?this._cameraComponent.orthoHeight=$P.height/2:(e=nf.windowSize,this._cameraComponent.orthoHeight=e.height/AI.getScaleY()/2),this.node.getWorldPosition(q3),this._cameraComponent.node.setWorldPosition(q3.x,q3.y,1e3))},yU._getViewPriority=function(){var e;return this._cameraComponent?(e=null==(e=this.cameraComponent)?void 0:e.priority,this._renderMode===X3.OVERLAY?e|1<<30:e&~(1<<30)):0},e(K3,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),kd=K3).prototype,"cameraComponent",[E,Nk],Object.getOwnPropertyDescriptor(kd.prototype,"cameraComponent"),kd.prototype),i(kd.prototype,"alignCanvasWithScreen",[c],Object.getOwnPropertyDescriptor(kd.prototype,"alignCanvasWithScreen"),kd.prototype),w3=i(kd.prototype,"_cameraComponent",[A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A3=i(kd.prototype,"_alignCanvasWithScreen",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Z5=kd))||Z5)||Z5)||Z5)||Z5)||Z5)||Z5,Rre({Canvas:C,CanvasComponent:C}),C);function K3(){var e;return _(e=k3.call(this)||this,"_cameraComponent",w3,p(e)),_(e,"_alignCanvasWithScreen",A3,p(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new ce,e._renderMode=X3.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(p(e)),e}function Q3(){return G3.apply(this,arguments)||this}function Z3(){var e;return _(e=H3.call(this)||this,"_spriteFrame",s3,p(e)),_(e,"_type",c3,p(e)),_(e,"_fillType",l3,p(e)),_(e,"_sizeMode",u3,p(e)),_(e,"_fillCenter",h3,p(e)),_(e,"_fillStart",p3,p(e)),_(e,"_fillRange",_3,p(e)),_(e,"_isTrimmedMode",f3,p(e)),_(e,"_useGrayscale",d3,p(e)),_(e,"_atlas",m3,p(e)),e}function J3(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=V3.call.apply(V3,[this].concat(i))||this)._lastParent=null,e.stencilStage=JF.DISABLED,e}j.Canvas=Y3,Ee(Rre("UIComponent",f("cc.UIComponent")(P=gl(Cz)(P=Oa(110)(P=ls(P=Tp((l(J3,V3=W_),(kp=J3.prototype).__preload=function(){this.node._uiProps.uiComp=this},kp.onEnable=function(){},kp.onDisable=function(){},kp.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},kp.updateAssembler=function(){},kp.postUpdateAssembler=function(){},kp.markForUpdateRenderData=function(){},kp.setNodeDirty=function(){},kp.setTextureDirty=function(){},P=J3))||P)||P)||P)||P)||P).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),In(Y3.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:nr.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),D(h4.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),D(Cz.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),j.UITransformComponent=Cz,gt.setClassAlias(Cz,"cc.UITransformComponent"),gt.setClassAlias(h4,"cc.RenderComponent"),j.CanvasComponent=Y3,gt.setClassAlias(Y3,"cc.CanvasComponent");var $3=new B1,eU="RICHTEXT_CHILD",tU="RICHTEXT_Image_CHILD",iU=new dt(function(e){if(!j.isValid(e.node))return!1;e=e.node.getComponent(T3);return e&&(e.width=0),!0},20),nU=new dt(function(e){return j.isValid(e.node)},10);function rU(e){return{node:new N1(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function oU(e,t){e===eU?i=iU._get():e===tU&&(i=nU._get());var i,n=(i=i||rU(e)).node;return(n=n||new N1(e)).hideFlags|=Pi.Flags.DontSave|Pi.Flags.HideInHierarchy,e===tU?(i.comp=n.getComponent(j3)||n.addComponent(j3),i.comp.spriteFrame=t,i.comp.type=j3.Type.SLICED,i.comp.sizeMode=j3.SizeMode.CUSTOM):(i.comp=n.getComponent(g4)||n.addComponent(g4),i.comp.string=t,i.comp.horizontalAlign=a4.LEFT,i.comp.verticalAlign=s4.TOP),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}bne=f("cc.RichText"),Up=wp(),YD=Oa(110),Hd=Ep(),S=u(),kw=v(a4),Gd=u(),E2=u(),L6=u(),ane=v(mF),a=u(),s=u(),XN=v(l4),y=u(),fie=u(),ba=u(),aie=v(pF),Nw=u(),pi=u(),vie=bne(die=Up(die=YD(die=Hd(die=Tp((l(CU,fU=W_),(il=CU.prototype).onLoad=function(){this.node.on(T.LAYER_CHANGED,this._applyLayer,this)},il.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},il.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},il.start=function(){this._onTTFLoaded(),this.node.on(T.ANCHOR_CHANGED,this._updateRichTextPosition,this)},il.onRestore=function(){},il.onDestroy=function(){for(var e=ge(this._segments);!(t=e()).done;){var t=t.value;t.node.removeFromParent(),t.type===eU?iU.put(t):t.type===tU&&nU.put(t)}this.node.off(T.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(T.LAYER_CHANGED,this._applyLayer,this)},il._addEventListeners=function(){this.node.on(T.TOUCH_END,this._onTouchEnded,this)},il._removeEventListeners=function(){this.node.off(T.TOUCH_END,this._onTouchEnded,this)},il._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach(function(e){t._applyTextAttribute(e)})},il._createFontLabel=function(e){return oU(eU,e)},il._createImage=function(e){return oU(tU,e)},il._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},il._measureText=function(i,e){function t(e){var t;return 0===n._labelSegmentsCache.length?(t=n._createFontLabel(e),n._labelSegmentsCache.push(t)):(t=n._labelSegmentsCache[0]).node.getComponent(g4).string=e,t.styleIndex=i,n._applyTextAttribute(t),t.node._uiProps.uiTransformComp.contentSize.width}var n=this;return e?t(e):t},il._onTouchEnded=function(r){for(var t,o=this,a=this.node.getComponents(W_),e=ge(this._segments);!(t=e()).done;)!function(){var e=t.value,i=e.clickHandler,n=e.clickParam;i&&o._containsTouchLocation(e,r.touch.getUILocation())&&(a.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(e,r,n)}),r.propagationStopped=!0)}()},il._containsTouchLocation=function(e,t){e=e.node.getComponent(Cz);return!!e&&e.getBoundingBoxToWorld().contains(t)},il._resetState=function(){for(var e=this.node.children,t=e.length-1;0<=t;t--){var i,n=e[t];n.name!==eU&&n.name!==tU||(n.parent===this.node?n.parent=null:e.splice(t,1),((i=rU(n.name)).node=n).name===eU?(i.comp=n.getComponent(g4),iU.put(i)):(i.comp=n.getComponent(j3),nU.put(i)))}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},il._activateChildren=function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==eU&&i.name!==tU||(i.active=e)}},il._addLabelSegment=function(e,t){var i,n;return 0===this._labelSegmentsCache.length?i=this._createFontLabel(e):(n=(i=this._labelSegmentsCache.pop()).node.getComponent(g4))&&(n.string=e),i.styleIndex=t,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this.node.addChild(i.node),this._applyTextAttribute(i),this._segments.push(i),i},il._updateRichTextWithMaxWidth=function(e,t,i){var n=t;if(0<this._lineOffsetX&&n+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o,a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),s=this._measureText(i,s);if(!(this._lineOffsetX+s<=this._maxWidth)){0<r&&(o=e.substr(0,r),this._addLabelSegment(o,i),e=e.substr(r,e.length),n=this._measureText(i,e)),this._updateLineInfo();break}this._lineOffsetX+=s,r+=a}if(n>this._maxWidth)for(var c=YF(e,n,this._maxWidth,this._measureText(i)),l=0;l<c.length;++l){var u=c[l],u=this._addLabelSegment(u,i).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=u.width,1<c.length&&l<c.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)},il._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},il._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},il._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;i=i.style,n=n.style;if(i){if(n){if(!!n.outline!=!!i.outline)return!0;if(i.size!==n.size||i.italic!==n.italic||i.isImage!==n.isImage)return!0;if(i.src!==n.src||i.imageAlign!==n.imageAlign||i.imageHeight!==n.imageHeight||i.imageWidth!==n.imageWidth||i.imageOffset!==n.imageOffset)return!0}else if(i.size||i.italic||i.isImage||i.outline)return!0}else if(n&&(n.size||n.italic||n.isImage||n.outline))return!0}return!1},il._addRichTextImageElement=function(e){if(e.style){var e=e.style,t=e.src,t=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(t){var i=this._createImage(t);switch(i.comp,e.imageAlign){case"top":i.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":i.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:i.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(i.imageOffset=e.imageOffset),i.node.layer=this.node.layer,this.node.addChild(i.node),this._segments.push(i);var t=t.rect.clone(),n=1,r=t.width,t=t.height,o=e.imageWidth||0,a=e.imageHeight||0,a=(r*=n=0<a?a/t:this._lineHeight/t,t*=n,0<o&&(r=o),0<this._maxWidth?(this._lineOffsetX+r>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=r):(this._lineOffsetX+=r,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),i.node._uiProps.uiTransformComp.setContentSize(r,t),i.lineCount=this._lineCount,i.clickHandler="",i.clickParam="",e.event);a&&(i.clickHandler=a.click,i.clickParam=a.param)}else J(4400)}},il._updateRichText=function(){if(this.enabledInHierarchy){var e=$3.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t=!1,i=0;i<this._textArray.length;++i){var n=this._textArray[i],r=n.text;if(void 0!==r){if(""===r){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this._imageAtlas){this._addRichTextImageElement(n);continue}}for(var o=r.split("\n"),a=0;a<o.length;++a){var s,c=o[a];""!==c?(t=!1,0<this._maxWidth?(s=this._measureText(i,c),this._updateRichTextWithMaxWidth(c,s,i)):(s=this._addLabelSegment(c,i),this._lineOffsetX+=s.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),1<o.length&&a<o.length-1&&this._updateLineInfo()):this._isLastComponentCR(r)&&a===o.length-1||(this._updateLineInfo(),t=!0)}}}t||this._linesWidth.push(this._lineOffsetX),0<this._maxWidth&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+MF)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},il._getFirstWordLen=function(e,t,i){var n=e.charAt(t);if(jF(n)||WF(n))return 1;for(var r=1,o=t+1;o<i&&!WF(n=e.charAt(o))&&!jF(n);++o)r++;return r},il._updateRichTextPosition=function(){for(var e=0,t=1,i=this._lineCount,n=this.node._uiProps.uiTransformComp,r=n.anchorX,o=n.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount,l=(t<c&&(e=0,t=c),this._labelWidth*(.5*this._horizontalAlign-r));switch(this._horizontalAlign){case a4.LEFT:break;case a4.CENTER:l-=this._linesWidth[c-1]/2;break;case a4.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(i-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(j3)){var h,p=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+MF);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:p.y+=_+(f-_)/2;break;case.5:p.y+=f/2;break;default:p.y+=(f-_)/2}s.imageOffset&&(1===(u=s.imageOffset.split(",")).length&&u[0]?(h=parseFloat(u[0]),Number.isInteger(h)&&(p.y+=h)):2===u.length&&(h=parseFloat(u[0]),u=parseFloat(u[1]),Number.isInteger(h)&&(p.x+=h),Number.isInteger(u)&&(p.y+=u))),s.node.position=p}var d,u=s.node.getComponent(T3);u&&((d=s.node.position.clone()).y-=u.width,s.node.position=d)}},il._convertLiteralColorValue=function(e){var t=e.toUpperCase();return nr[t]||(new nr).fromHEX(e)},il._applyTextAttribute=function(e){var t,i,n=e.node.getComponent(g4);n&&(this._resetLabelState(n),t=e.styleIndex,(i=this._textArray[t]?this._textArray[t].style:i)&&(n.color=this._convertLiteralColorValue(i.color||"white"),n.isBold=!!i.bold,n.isItalic=!!i.italic,n.isUnderline=!!i.underline,i.outline&&((t=(t=e.node.getComponent(T3))||e.node.addComponent(T3)).color=this._convertLiteralColorValue(i.outline.color),t.width=i.outline.width),n.fontSize=i.size||this._fontSize,e.clickHandler="",e.clickParam="",(t=i.event)&&(e.clickHandler=t.click||"",e.clickParam=t.param||"")),n.cacheMode=this._cacheMode,this._font instanceof mF&&!this._isSystemFontUsed?n.font=this._font:n.fontFamily=this._fontFamily,n.useSystemFont=this._isSystemFontUsed,n.lineHeight=this._lineHeight,n.updateRenderData(!0),(i=n._assembler)&&i.updateRenderData(n))},il._applyLayer=function(){for(var e,t=ge(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},il._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=nr.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},e(CU,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),bp=Mne=CU,Mne.HorizontalAlign=a4,Mne.VerticalAlign=s4,i((hl=bp).prototype,"string",[Bp,S],Object.getOwnPropertyDescriptor(hl.prototype,"string"),hl.prototype),i(hl.prototype,"horizontalAlign",[kw,Gd],Object.getOwnPropertyDescriptor(hl.prototype,"horizontalAlign"),hl.prototype),i(hl.prototype,"fontSize",[E2],Object.getOwnPropertyDescriptor(hl.prototype,"fontSize"),hl.prototype),i(hl.prototype,"fontFamily",[L6],Object.getOwnPropertyDescriptor(hl.prototype,"fontFamily"),hl.prototype),i(hl.prototype,"font",[ane,a],Object.getOwnPropertyDescriptor(hl.prototype,"font"),hl.prototype),i(hl.prototype,"useSystemFont",[s],Object.getOwnPropertyDescriptor(hl.prototype,"useSystemFont"),hl.prototype),i(hl.prototype,"cacheMode",[XN,y],Object.getOwnPropertyDescriptor(hl.prototype,"cacheMode"),hl.prototype),i(hl.prototype,"maxWidth",[fie],Object.getOwnPropertyDescriptor(hl.prototype,"maxWidth"),hl.prototype),i(hl.prototype,"lineHeight",[ba],Object.getOwnPropertyDescriptor(hl.prototype,"lineHeight"),hl.prototype),i(hl.prototype,"imageAtlas",[aie,Nw],Object.getOwnPropertyDescriptor(hl.prototype,"imageAtlas"),hl.prototype),i(hl.prototype,"handleTouchEvent",[pi],Object.getOwnPropertyDescriptor(hl.prototype,"handleTouchEvent"),hl.prototype),P3=i(hl.prototype,"_lineHeight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),I3=i(hl.prototype,"_string",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),R3=i(hl.prototype,"_horizontalAlign",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a4.LEFT}}),D3=i(hl.prototype,"_fontSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),O3=i(hl.prototype,"_maxWidth",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M3=i(hl.prototype,"_fontFamily",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),N3=i(hl.prototype,"_font",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L3=i(hl.prototype,"_isSystemFontUsed",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),B3=i(hl.prototype,"_userDefinedFont",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F3=i(hl.prototype,"_cacheMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l4.NONE}}),z3=i(hl.prototype,"_imageAtlas",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U3=i(hl.prototype,"_handleTouchEvent",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),die=hl))||die)||die)||die)||die)||die,Rre({RichText:vie,RichTextComponent:vie});var aU,sU,cU,lU,uU,hU,pU,_U,fU,dU=vie,Ac=(zp=f("cc.UIMeshRenderer")(w=wp()(w=Oa(110)(w=Ep()((l(EU,_U=W_),(Cp=EU.prototype).__preload=function(){this.node._uiProps.uiComp=this},Cp.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},Cp.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},Cp.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t=ge(this._models);!(i=t()).done;){var i=i.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},Cp.postUpdateAssembler=function(){},Cp.update=function(){this._fitUIRenderQueue()},Cp._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterialInstance(t);if(null!=i)for(var n=i.passes,r=n.length,o=0;o<r;o++)n[o]._priority=wg.MAX-11,i.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},Cp.markForUpdateRenderData=function(){},Cp.setNodeDirty=function(){},Cp.setTextureDirty=function(){},e(EU,[{key:"modelComponent",get:function(){return this._modelComponent}}]),w=EU))||w)||w)||w)||w,Rre({UIMeshRenderer:zp,UIModelComponent:zp}),zp),mU=Tg.Enum.NONE|Tg.Enum.UI_3D,gU=Rre("UIDrawBatch",((Iie=TU.prototype).destroy=function(){this._passes=[]},Iie.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=mU,this.renderScene=null},Iie.fillPasses=function(e,t,i,n,r,o){if(e){var a=e.passes;if(a){this._shaders.length=a.length;for(var s=0;s<a.length;s++){this._passes[s]||(this._passes[s]=new G0(j.director.root));var c=a[s],l=this._passes[s];c.update(),t||(t=c.depthStencilState,i=0),n||(n=c.blendState,r=0),-1===r&&(r=0),l._initPassFromTarget(c,t,n,i<<16|r),this._shaders[s]=l.getShaderVariant(o)}}}},e(TU,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),TU)),Ce=(Rie=f("cc.UIStaticBatch"),x=wp(),Pc=Ep(),r=Oa(110),ll=Pp(),Bc=Rie(o=x(o=Pc(o=r((i((l(bU,pU=h4),(vI=bU.prototype).onLoad=function(){},vI.onDestroy=function(){},vI.updateAssembler=function(){},vI.postUpdateAssembler=function(){},vI.markAsDirty=function(){},vI._requireDrawBatch=function(){var e=new gU;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},vI._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},vI._getBatcher=function(){return ZP.root&&ZP.root.batcher2D?ZP.root.batcher2D:(J(9301),null)},e(bU,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t=bU).prototype,"color",[Gp,ll],Object.getOwnPropertyDescriptor(t.prototype,"color"),t.prototype),o=t))||o)||o)||o)||o,Rre({UIStaticBatch:Bc,UIStaticBatchComponent:Bc}),Bc),vU=Rre("LabelShadow",(n=f("cc.LabelShadow"),_l=wp(),I=Oa(110),tl=Ep(),Sa=gl(g4),nl=u(),R=u(),rl=u(),n(Lc=_l(Lc=I(Lc=tl(Lc=Sa(Lc=Tp((l(SU,hU=W_),(g=SU.prototype).onEnable=function(){this._updateRenderData()},g.onDisable=function(){this._updateRenderData()},g._updateRenderData=function(){var e=this.node.getComponent(g4);e&&e.updateRenderData(!0)},e(SU,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),aU=i((ul=SU).prototype,"_color",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(0,0,0,255)}}),sU=i(ul.prototype,"_offset",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(2,2)}}),cU=i(ul.prototype,"_blur",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),i(ul.prototype,"color",[nl],Object.getOwnPropertyDescriptor(ul.prototype,"color"),ul.prototype),i(ul.prototype,"offset",[R],Object.getOwnPropertyDescriptor(ul.prototype,"offset"),ul.prototype),i(ul.prototype,"blur",[rl],Object.getOwnPropertyDescriptor(ul.prototype,"blur"),ul.prototype),Lc=ul))||Lc)||Lc)||Lc)||Lc)||Lc)||Lc)),yU=(b=f("cc.UIOpacity"),xH=wp(),uI=Oa(110),Xp=Ep(),cM=u(),W3=b(C7=xH(C7=uI(C7=Xp(C7=Tp((i((l(xU,uU=W_),(EW=xU.prototype).onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},EW.onDisable=function(){this.node._uiProps.localOpacity=1},e(xU,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=Qt(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),yI=xU).prototype,"opacity",[Ap,cM],Object.getOwnPropertyDescriptor(yI.prototype,"opacity"),yI.prototype),lU=i(yI.prototype,"_opacity",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),C7=yI))||C7)||C7)||C7)||C7)||C7,Rre({UIOpacity:W3,UIOpacityComponent:W3}),W3);function xU(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=uU.call.apply(uU,[this].concat(i))||this,"_opacity",lU,p(e)),e}function SU(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=hU.call.apply(hU,[this].concat(i))||this,"_color",aU,p(e)),_(e,"_offset",sU,p(e)),_(e,"_blur",cU,p(e)),e}function bU(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=pU.call.apply(pU,[this].concat(i))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}function TU(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=mU,this._inputAssembler=null,this._descriptorSet=null}function EU(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=_U.call.apply(_U,[this].concat(i))||this)._models=null,e._modelComponent=null,e.stencilStage=JF.DISABLED,e}function CU(){var e;return _(e=fU.call(this)||this,"_lineHeight",P3,p(e)),_(e,"_string",I3,p(e)),_(e,"_horizontalAlign",R3,p(e)),_(e,"_fontSize",D3,p(e)),_(e,"_maxWidth",O3,p(e)),_(e,"_fontFamily",M3,p(e)),_(e,"_font",N3,p(e)),_(e,"_isSystemFontUsed",L3,p(e)),_(e,"_userDefinedFont",B3,p(e)),_(e,"_cacheMode",F3,p(e)),_(e,"_imageAtlas",z3,p(e)),_(e,"_handleTouchEvent",U3,p(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}j.MaskComponent=h,gt.setClassAlias(h,"cc.MaskComponent"),j.LabelComponent=g4,gt.setClassAlias(g4,"cc.LabelComponent"),j.LabelOutlineComponent=T3,gt.setClassAlias(T3,"cc.LabelOutlineComponent"),j.RichTextComponent=dU,gt.setClassAlias(dU,"cc.RichTextComponent"),j.SpriteComponent=j3,gt.setClassAlias(j3,"cc.SpriteComponent"),j.UIModelComponent=Ac,gt.setClassAlias(Ac,"cc.UIModelComponent"),j.GraphicsComponent=Y4,gt.setClassAlias(Y4,"cc.GraphicsComponent"),gt.setClassAlias(Ce,"cc.UIStaticBatchComponent"),gt.setClassAlias(yU,"cc.UIOpacityComponent");var wU=function(e,t,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=i};function AU(e,a,t,i,n){var r=0,o=null;if(n===0<function(e,t,i){for(var n=0,r=a,o=t-i;r<t;r+=i)n+=(e[o]-e[r])*(e[r+1]+e[o+1]),o=r;return n}(e,t,i))for(r=a;r<t;r+=i)o=zU(r,e[r],e[r+1],o);else for(r=t-i;a<=r;r-=i)o=zU(r,e[r],e[r+1],o);return o&&NU(o,o.next)&&(UU(o),o=o.next),o}function PU(e,t){if(!e)return e;t=(t=void 0===t?null:t)||e;var i=e,n=!1;do{if(n=!1,i.steiner||!NU(i,i.next)&&0!==MU(i.prev,i,i.next))i=i.next;else{if(UU(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function IU(e,t,i,n,r,o,a){if(void 0===a&&(a=0),e){if(!a&&o){var s=e;var c=n;var l=r;var u=o;for(var h=s;null===h.z&&(h.z=DU(h.x,h.y,c,l,u)),h.prevZ=h.prev,h.nextZ=h.next,(h=h.next)!==s;);h.prevZ.nextZ=null,h.prevZ=null;var p=h,_=0,f=null,d=null,m=null,g=null,v=0,y=0,x=0,S=1;do{for(f=p,g=p=null,v=0;f;){for(v++,d=f,_=y=0;_<S&&(y++,d=d.nextZ);_++);for(x=S;0<y||0<x&&d;)0!==y&&(0===x||!d||f.z<=d.z)?(f=(m=f).nextZ,y--):(d=(m=d).nextZ,x--),g?g.nextZ=m:p=m,m.prevZ=g,g=m;f=d}}while(g.nextZ=null,S*=2,1<v)}for(var b,T,E=e;e.prev!==e.next;)if(b=e.prev,T=e.next,o?function(e,t,i,n){var r=e.prev,o=e,a=e.next;if(0<=MU(r,o,a))return;for(var s=(r.x<o.x?r.x<a.x?r:a:o.x<a.x?o:a).x,c=(r.y<o.y?r.y<a.y?r:a:o.y<a.y?o:a).y,l=(r.x>o.x?r.x>a.x?r:a:o.x>a.x?o:a).x,u=(r.y>o.y?r.y>a.y?r:a:o.y>a.y?o:a).y,h=DU(s,c,t,i,n),p=DU(l,u,t,i,n),_=e.nextZ;_&&_.z<=p;){if(_!==e.prev&&_!==e.next&&OU(r.x,r.y,o.x,o.y,a.x,a.y,_.x,_.y)&&0<=MU(_.prev,_,_.next))return;_=_.nextZ}for(_=e.prevZ;_&&_.z>=h;){if(_!==e.prev&&_!==e.next&&OU(r.x,r.y,o.x,o.y,a.x,a.y,_.x,_.y)&&0<=MU(_.prev,_,_.next))return;_=_.prevZ}return 1}(e,n,r,o):function(e){var t=e.prev,i=e,n=e.next;if(0<=MU(t,i,n))return;for(var r=e.next.next;r!==e.prev;){if(OU(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=MU(r.prev,r,r.next))return;r=r.next}return 1}(e))t.push(b.i/i),t.push(e.i/i),t.push(T.i/i),UU(e),e=T.next,E=T.next;else if((e=T)===E){a?1===a?IU(e=function(e,t,i){var n=e;do{var r=n.prev,o=n.next.next}while(!NU(r,o)&&LU(r,n,n.next,o)&&BU(r,o)&&BU(o,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(o.i/i),UU(n),UU(n.next),n=e=o),n=n.next,n!==e);return n}(e,t,i),t,i,n,r,o,2):2===a&&function(e,t,i,n,r,o){var a=e;do{for(var s,c=a.next.next;c!==a.prev;){if(a.i!==c.i&&function(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&LU(i,i.next,e,t))return 1}while((i=i.next)!==e)}(e,t)&&BU(e,t)&&BU(t,e)&&function(e,t){for(var i=e,n=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;i.y>o!=i.next.y>o&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),(i=i.next)!==e;);return n}(e,t)}(a,c))return s=FU(a,c),a=PU(a,a.next),s=PU(s,s.next),IU(a,t,i,n,r,o),IU(s,t,i,n,r,o);c=c.next}}while(a=a.next,a!==e)}(e,t,i,n,r,o):IU(PU(e),t,i,n,r,o,1);break}}}function RU(e,t){return e.x-t.x}function DU(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function OU(e,t,i,n,r,o,a,s){return 0<=(r-a)*(t-s)-(e-a)*(o-s)&&0<=(e-a)*(n-s)-(i-a)*(t-s)&&0<=(i-a)*(o-s)-(r-a)*(n-s)}function MU(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function NU(e,t){return e.x===t.x&&e.y===t.y}function LU(e,t,i,n){return NU(e,t)&&NU(i,n)||NU(e,n)&&NU(i,t)||0<MU(e,t,i)!=0<MU(e,t,n)&&0<MU(i,n,e)!=0<MU(i,n,t)}function BU(e,t){return MU(e.prev,e,e.next)<0?0<=MU(e,t,e.next)&&0<=MU(e,e.prev,t):MU(e,t,e.prev)<0||MU(e,e.next,t)<0}function FU(e,t){var i=new wU(e.i,e.x,e.y),n=new wU(t.i,t.x,t.y),r=e.next,o=t.prev;return(e.next=t).prev=e,(i.next=r).prev=i,(n.next=i).prev=n,(o.next=n).prev=o,n}function zU(e,t,i,n){e=new wU(e,t,i);return n?(e.next=n.next,(e.prev=n).next.prev=e,n.next=e):(e.prev=e).next=e,e}function UU(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function kU(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,o=AU(e,0,r,i,!0),a=[];if(!o)return a;var s,c,l=0,u=0,h=0,p=0,_=0;if(n&&(o=function(e,t,i,n){for(var r,o,a=[],s=0,c=null,s=0,l=t.length;s<l;s++)(c=AU(e,t[s]*n,s<l-1?t[s+1]*n:e.length,n,!1))&&(c===c.next&&(c.steiner=!0),a.push(function(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}(c)));if(a.sort(RU),!i)return i;for(s=0;s<a.length;s++)r=a[s],(o=function(e,t){var i=t,n=e.x,r=e.y,o=-1/0,a=null;do{if(r<=i.y&&r>=i.next.y){var s=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&o<s){if((o=s)===n){if(r===i.y)return i;if(r===i.next.y)return i.next}a=i.x<i.next.x?i:i.next}}}while((i=i.next)!==t);if(!a)return null;if(n===o)return a.prev;for(var c,l=a,u=a.x,h=a.y,p=1/0,i=a.next;i!==l;)n>=i.x&&i.x>=u&&OU(r<h?n:o,r,u,h,r<h?o:n,r,i.x,i.y)&&((c=Math.abs(r-i.y)/(n-i.x))<p||c===p&&i.x>a.x)&&BU(i,e)&&(a=i,p=c),i=i.next;return a}(r,o=i))&&PU(o=FU(o,r),o.next),i=PU(i,i.next);return i}(e,t,o,i)),e.length>80*i){for(var l=h=e[0],u=p=e[1],f=i;f<r;f+=i)(s=e[f])<l&&(l=s),(c=e[f+1])<u&&(u=c),h<s&&(h=s),p<c&&(p=c);_=Math.max(h-l,p-u)}return IU(o,a,i,l,u,_),a}for(var GU=Math.PI,HU=Math.min,VU=Math.max,jU=Math.ceil,WU=Math.acos,qU=Math.cos,XU=Math.sin,YU=Math.atan2,KU=null,QU=null,ZU=new nr,JU=[],$U=0;$U<4;$U++)JU.push(new ce);function ek(e,t,i){return e<t?t:i<e?i:e}function tk(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}var ik,nk={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!QU)return null;var i=QU.getRenderDataList(),n=i[QU.dataOffset];if(!n)return null;var r=n,o=r?r.vertexStart+t:0;return(65535<o||131070<3*o)&&(++QU.dataOffset,QU.dataOffset<i.length?n=i[QU.dataOffset]:(n=QU.requestRenderData(),i[QU.dataOffset]=n),r=n),r&&r.vertexCount<o&&r.request(t,3*t),n},stroke:function(e){nr.copy(ZU,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){nr.copy(ZU,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,i,n=.5*e.lineWidth,r=e.lineCap,o=e.lineJoin,a=e.miterLimit;if(QU=e.impl){t=GU,i=QU.tessTol,i=2*WU(n/(n+i));var s=VU(2,jU(t/i));this._calculateJoins(QU,n,o,a);for(var c=QU.paths,l=0,u=QU.pathOffset,h=QU.pathLength;u<h;u++){var p=c[u],_=p.points.length;o===f4.ROUND?l+=2*(_+p.bevel*(s+2)+1):l+=2*(_+5*p.bevel+1),p.closed||(r===_4.ROUND?l+=2*(2*s+2):l+=12)}var f=KU=this.getRenderData(e,l);if(f){for(var d=f.vData,m=f.iData,g=QU.pathOffset,v=QU.pathLength;g<v;g++){var y=c[g],x=y.points,S=x.length,b=f.vertexStart,T=void 0,E=void 0,C=0,w=0,y=y.closed,w=y?(T=x[S-1],E=x[0],C=0,S):(T=x[0],E=x[1],S-(C=1)),E=E||T;y||((S=new H4(E.x,E.y)).subtract(T),S.normalize(),A=S.x,S=S.y,r===_4.BUTT?this._buttCapStart(T,A,S,n,0):r===_4.SQUARE?this._buttCapStart(T,A,S,n,n):r===_4.ROUND&&this._roundCapStart(T,A,S,n,s));for(var A,P=C;P<w;++P)o===f4.ROUND?this._roundJoin(T,E,n,n,s):0!=(E.flags&(d4.PT_BEVEL|d4.PT_INNERBEVEL))?this._bevelJoin(T,E,n,n):(this._vSet(E.x+E.dmx*n,E.y+E.dmy*n,1),this._vSet(E.x-E.dmx*n,E.y-E.dmy*n,-1)),T=E,E=x[P+1];y?(this._vSet(d[A=8*b],d[1+A],1),this._vSet(d[8+A],d[8+A+1],-1)):((S=new H4(E.x,E.y)).subtract(T),S.normalize(),C=S.x,y=S.y,r===_4.BUTT?this._buttCapEnd(E,C,y,n,0):r===_4.SQUARE?this._buttCapEnd(E,C,y,n,n):r===_4.ROUND&&this._roundCapEnd(E,C,y,n,s));for(var I=f.indexStart,R=b+2,D=f.vertexStart;R<D;R++)m[I++]=R-2,m[I++]=R-1,m[I++]=R;f.indexStart=I}QU=KU=null}}},_expandFill:function(e){if(QU=e.impl){for(var t=QU.paths,i=0,n=QU.pathOffset,r=QU.pathLength;n<r;n++)i+=t[n].points.length;var o=KU=this.getRenderData(e,i);if(o){for(var a=o,s=a.vData,c=a.iData,l=QU.pathOffset,u=QU.pathLength;l<u;l++){var h=t[l],p=h.points,_=p.length;if(0!==_){for(var f=o.vertexStart,d=0;d<_;++d)this._vSet(p[d].x,p[d].y);var m=o.indexStart;if(h.complex){for(var g=[],v=f,y=o.vertexStart;v<y;v++){var x=8*v;g.push(s[x++]),g.push(s[x++]),g.push(s[+x])}var S=kU(g,null,3);if(!S||0===S.length)continue;for(var b=0,T=S.length;b<T;b++)c[m++]=S[b]+f}else for(var E=f,C=f+2,w=a.vertexStart;C<w;C++)c[m++]=E,c[m++]=C-1,c[m++]=C;a.indexStart=m}}QU=KU=null}}},_calculateJoins:function(e,t,i,n){var r=0;0<t&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++)for(var c=o[a],l=c.points,u=l.length,h=l[u-1],p=l[0],_=c.bevel=0;_<u;_++){var f=h.dy,d=-h.dx,m=p.dy,g=-p.dx;p.dmx=.5*(f+m),p.dmy=.5*(d+g),1e-6<(f=p.dmx*p.dmx+p.dmy*p.dmy)&&(600<(m=1/f)&&(m=600),p.dmx*=m,p.dmy*=m),0<p.dx*h.dy-h.dx*p.dy&&(p.flags|=d4.PT_LEFT),f*(d=VU(11,HU(h.len,p.len)*r))*d<1&&(p.flags|=d4.PT_INNERBEVEL),p.flags&d4.PT_CORNER&&(f*n*n<1||i===f4.BEVEL||i===f4.ROUND)&&(p.flags|=d4.PT_BEVEL),0!=(p.flags&(d4.PT_BEVEL|d4.PT_INNERBEVEL))&&c.bevel++,h=p,p=l[_+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],o=r.points,a=o[o.length-1],s=o[0];2<o.length&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new H4(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,o=i.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*n,s=o-t.dx*n,c=r+i.dy*n,l=o-i.dx*n):(a=c=r+i.dmx*n,s=l=o+i.dmy*n),[a,s,c,l]},_buttCapStart:function(e,t,i,n,r){var o=e.x-t*r,e=e.y-i*r,r=i,i=-t;this._vSet(o+r*n,e+i*n,1),this._vSet(o-r*n,e-i*n,-1)},_buttCapEnd:function(e,t,i,n,r){var o=e.x+t*r,e=e.y+i*r,r=i,i=-t;this._vSet(o+r*n,e+i*n,1),this._vSet(o-r*n,e-i*n,-1)},_roundCapStart:function(e,t,i,n,r){for(var o=e.x,a=e.y,s=i,c=-t,l=0;l<r;l++){var u=l/(r-1)*GU,h=qU(u)*n,u=XU(u)*n;this._vSet(o-s*h-t*u,a-c*h-i*u,1),this._vSet(o,a,0)}this._vSet(o+s*n,a+c*n,1),this._vSet(o-s*n,a-c*n,-1)},_roundCapEnd:function(e,t,i,n,r){var o=e.x,a=e.y,s=i,c=-t;this._vSet(o+s*n,a+c*n,1),this._vSet(o-s*n,a-c*n,-1);for(var l=0;l<r;l++){var u=l/(r-1)*GU,h=qU(u)*n,u=XU(u)*n;this._vSet(o,a,0),this._vSet(o-s*h+t*u,a-c*h+i*u,1)}},_roundJoin:function(e,t,i,n,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&d4.PT_LEFT)){var h=this._chooseBevel(t.flags&d4.PT_INNERBEVEL,e,t,i),p=h[0],_=h[1],f=h[2],h=h[3],d=YU(-a,-o),m=YU(-c,-s);d<m&&(m-=2*GU),this._vSet(p,_,1),this._vSet(l-o*n,t.y-a*n,-1);for(var g=ek(jU((d-m)/GU)*r,2,r),v=0;v<g;v++){var y=d+v/(g-1)*(m-d),x=l+qU(y)*n,y=u+XU(y)*n;this._vSet(l,u,0),this._vSet(x,y,-1)}this._vSet(f,h,1),this._vSet(l-s*n,u-c*n,-1)}else{var p=this._chooseBevel(t.flags&d4.PT_INNERBEVEL,e,t,-n),_=p[0],f=p[1],h=p[2],e=p[3],S=YU(a,o),b=YU(c,s);b<S&&(b+=2*GU),this._vSet(l+o*n,u+a*n,1),this._vSet(_,f,-1);for(var T=ek(jU((b-S)/GU)*r,2,r),E=0;E<T;E++){var C=S+E/(T-1)*(b-S),w=l+qU(C)*i,C=u+XU(C)*i;this._vSet(w,C,1),this._vSet(l,u,0)}this._vSet(l+s*n,u+c*n,1),this._vSet(h,e,-1)}},_bevelJoin:function(e,t,i,n){var r,o=0,a=0,s=0,c=0,l=0,u=0,h=0,p=0,_=e.dy,f=-e.dx,d=t.dy,m=-t.dx;t.flags&d4.PT_LEFT?(l=(r=this._chooseBevel(t.flags&d4.PT_INNERBEVEL,e,t,i))[0],u=r[1],h=r[2],p=r[3],this._vSet(l,u,1),this._vSet(t.x-_*n,t.y-f*n,-1),this._vSet(h,p,1),this._vSet(t.x-d*n,t.y-m*n,-1)):(o=(r=this._chooseBevel(t.flags&d4.PT_INNERBEVEL,e,t,-n))[0],a=r[1],s=r[2],c=r[3],this._vSet(t.x+_*i,t.y+f*i,1),this._vSet(o,a,-1),this._vSet(t.x+d*i,t.y+m*i,1),this._vSet(s,c,-1))},_vSet:function(e,t,i){var n,r,o;void 0===i&&(i=0),KU&&(r=8*(n=KU).vertexStart,(o=n.vData)[r++]=e,o[r++]=t,o[r++]=0,nr.toArray(o,ZU,r),r+=4,o[r++]=i,n.vertexStart++)}},E=Rre("graphicsAssembler",{getAssembler:function(){return nk}}),rk=(Y4.Assembler=E,new qr),ok=null,ak=null,sk=[],ck=[],lk=[],uk=[],hk=new Hr,pk=new Hr,_k=new U,fk=null,dk=0,mk=0,gk=0,vk=0,yk=0,xk=1,Sk=null,bk="",Tk=0,Ek=0,Ck=0,wk=0,Ak=0,Pk=0,Ik=0,Rk=!1,Dk=0,Ok=0,Mk=0,Nk={updateRenderData:function(e){e.renderData&&ok!==e&&(e.renderData.vertDirty&&(ak=(ok=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),ok.actualFontSize=Tk,ak.setContentSize(pk),this.updateUVs(e),ok.renderData.vertDirty=!1,ok.markForUpdateRenderData(!1),ok=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var e=e.renderData,t=e.chunk.vb,i=e.vertexCount,n=e.data,r=3,o=0;o<i;o++){var a=n[o];t[r]=a.u,t[r+1]=a.v,r+=9}},_updateFontScale:function(){xk=Tk/Ek},_updateFontFamily:function(e){var t=e.font;Sk=t.spriteFrame,fk=t.fntConfig,uz.fontAtlas=t.fontDefDictionary,oF.packToDynamicAtlas(e,Sk)},_updateLabelInfo:function(){uz.hash="",uz.margin=0},_updateProperties:function(e){bk=e.string.toString(),Tk=e.fontSize,Ek=(fk||e).fontSize,Ck=e.horizontalAlign,wk=e.verticalAlign,Ak=e.spacingX,Ik=e.overflow,Pk=e._lineHeight;var t=ak.contentSize;pk.width=t.width,pk.height=t.height,Ik===c4.NONE?(Rk=!1,pk.width+=2*uz.margin,pk.height+=2*uz.margin):Ik===c4.RESIZE_HEIGHT?(Rk=!0,pk.height+=2*uz.margin):Rk=e.enableWrapText,uz.lineHeight=Pk,uz.fontSize=Tk,this._setupBMFontOverflowMetrics()},_resetProperties:function(){Sk=fk=null,uz.hash="",uz.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=bk,t=e.length,i=fk.kerningDict,n=sk,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=i[r<<16|65535&a]||0;n[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t,i=bk.length,n=0,r=0,o=0,a=0,s=0,c=0,l=0,u=0;u<i;){var h=bk.charAt(u);if("\n"!==h){for(var p=e(bk,u,i),_=c,f=l,d=s,m=r,g=!1,v=0;v<p;++v){var y=u+v;if("\r"!==(h=bk.charAt(y)))if(t=uz.fontAtlas.getLetterDefinitionForChar(h,uz)){var x=m+t.offsetX*xk-uz.margin;if(Rk&&0<Mk&&0<r&&x+t.w*xk>Mk&&!WF(h)){lk.push(s),n++,r=s=0,o-=Pk*this._getFontScale()+0,g=!0;break}_k.x=x,_k.y=o-t.offsetY*xk,this._recordLetterInfo(_k,h,y,n),y+1<sk.length&&y<i-1&&(m+=sk[y+1]),m+=t.xAdvance*xk+Ak,d=_k.x+t.w*xk,_<_k.y&&(_=_k.y),f>_k.y-t.h*xk&&(f=_k.y-t.h*xk)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+fk.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}g||(r=m,c<_&&(c=_),f<l&&(l=f),a<(s=d)&&(a=s),u+=p)}else lk.push(s),n++,r=s=0,o-=Pk*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return lk.push(s),mk=(dk=n+1)*Pk*this._getFontScale(),1<dk&&(mk+=0*(dk-1)),pk.width=Dk,pk.height=Ok,Dk<=0&&(pk.width=parseFloat(a.toFixed(2))+2*uz.margin),Ok<=0&&(pk.height=parseFloat(mk.toFixed(2))+2*uz.margin),vk=pk.height,(yk=0)<c&&(vk=pk.height+c),l<-mk&&(yk=mk+l),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return Ik===c4.SHRINK?xk:1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(jF(n)||"\n"===n||WF(n))return 1;var r=1,o=uz.fontAtlas.getLetterDefinitionForChar(n,uz);if(!o)return r;for(var a=o.xAdvance*xk+Ak,s=t+1;s<i&&(n=e.charAt(s),o=uz.fontAtlas.getLetterDefinitionForChar(n,uz));++s){if(a+o.offsetX*xk+o.w*xk>Mk&&!WF(n)&&0<Mk)return r;if(a+=o.xAdvance*xk+Ak,"\n"===n||WF(n)||jF(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){var i;e>=ck.length&&(i=new tk,ck.push(i)),ck[e].char=t,ck[e].hash=""+t.charCodeAt(0)+uz.hash,ck[e].valid=!1},_recordLetterInfo:function(e,t,i,n){i>=ck.length&&(r=new tk,ck.push(r));var r=""+t.charCodeAt(0)+uz.hash;ck[i].line=n,ck[i].char=t,ck[i].hash=r,ck[i].valid=uz.fontAtlas.getLetter(r).valid,ck[i].x=e.x,ck[i].y=e.y},_alignText:function(){mk=0,lk.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),Ik===c4.SHRINK&&0<Tk&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||Ik===c4.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),Tk=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t,i=0,n=0|Tk;i<n;){var r=t=i+n+1>>1;if(r<=0)break;xk=r/Ek,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=t-1:i=t}0<=i&&this._scaleFontSizeDown(i)},_isVerticalClamp:function(){return mk>pk.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=bk.length;t<i;++t){var n=ck[t];if(n.valid){var r=uz.fontAtlas.getLetterDefinitionForChar(n.char,uz);if(r){r=n.x+r.w*xk,n=n.line;if(0<Dk)if(Rk){if(lk[n]>pk.width&&(r>pk.width||r<0)){e=!0;break}}else if(r>pk.width){e=!0;break}}}}return e},_isHorizontalClamped:function(e,t){t=lk[t],e=e>pk.width||e<0;return(!Rk||t>pk.width)&&e},_updateQuads:function(){if(!ok)return!1;var e=Sk?Sk.texture:uz.fontAtlas.getTexture(),t=ok.renderData;t.dataLength=0,t.resize(0,0);for(var t=ak.anchorPoint,i=pk,n=t.x*i.width,r=t.y*i.height,o=!0,a=0,s=bk.length;a<s;++a){var c=ck[a];if(c.valid){var l=uz.fontAtlas.getLetter(c.hash);if(l){rk.height=l.h,rk.width=l.w,rk.x=l.u,rk.y=l.v;var u=c.y+gk,h=(0<Ok&&(vk<u&&(h=u-vk,rk.y+=h,rk.height-=h,u-=h),u-l.h*xk<yk&&Ik===c4.CLAMP&&(rk.height=u<yk?0:(u-yk)/xk)),c.line),p=c.x+l.w/2*xk+uk[h];if(0<Dk&&this._isHorizontalClamped(p,h))if(Ik===c4.CLAMP)rk.width=0;else if(Ik===c4.SHRINK){if(pk.width>l.w){o=!1;break}rk.width=0}0<rk.height&&0<rk.width&&(p=this._determineRect(),l=c.x+uk[c.line],this.appendQuad(ok,e,rk,p,l-n,u-r,xk))}else console.warn("Can't find letter in this bitmap-font")}}return o},appendQuad:function(){},_determineRect:function(){var e=Sk.isRotated(),t=Sk.getOriginalSize(),i=Sk.getRect(),n=Sk.getOffset(),r=n.x+(t.width-i.width)/2,n=n.y-(t.height-i.height)/2;return e?(t=rk.x,rk.x=i.x+i.height-rk.y-rk.height-n,rk.y=t+i.y-r,rk.y<0&&(rk.height+=n)):(rk.x+=i.x-r,rk.y+=i.y+n),e},_computeAlignmentOffset:function(){switch(uk.length=0,Ck){case a4.LEFT:for(var e=0;e<dk;++e)uk.push(0);break;case a4.CENTER:for(var t=0,i=lk.length;t<i;t++)uk.push((pk.width-lk[t])/2);break;case a4.RIGHT:for(var n=0,r=lk.length;n<r;n++)uk.push(pk.width-lk[n])}var o;gk=pk.height,wk!==s4.TOP&&(o=pk.height-mk+Pk*this._getFontScale()-Ek*xk,wk===s4.BOTTOM?gk-=o:gk-=o/2)},_setupBMFontOverflowMetrics:function(){var e=pk.width,t=pk.height;Ik===c4.RESIZE_HEIGHT&&(t=0),Ik===c4.NONE&&(t=e=0),Dk=e,Ok=t,hk.width=e,hk.height=t,Mk=e}},Lk=new nr(255,255,255,255),Bk={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;Lk.set(e.color),Lk.a=255*t._uiProps.opacity,JB(t,0,e.renderData,Lk)},appendQuad:function(e,t,i,n,r,o,a){var s,c,l,u,h,p,_,f,e=e.renderData;e&&(s=e.dataLength,e.dataLength+=4,e.resize(e.dataLength,e.dataLength/2*3),e=e.data,c=t.width,t=t.height,l=i.width,u=i.height,f=_=p=h=0,n?(h=i.x/c,f=(i.x+u)/c,p=(i.y+l)/t,_=i.y/t,e[s].u=h,e[s].v=_,e[s+1].u=h,e[s+1].v=p,e[s+2].u=f,e[s+2].v=_,e[s+3].u=f,e[s+3].v=p):(h=i.x/c,f=(i.x+l)/c,p=(i.y+u)/t,_=i.y/t,e[s].u=h,e[s].v=p,e[s+1].u=f,e[s+1].v=p,e[s+2].u=h,e[s+2].v=_,e[s+3].u=f,e[s+3].v=_),e[s].x=r,e[s].y=o-u*a,e[s+1].x=r+l*a,e[s+1].y=o-u*a,e[s+2].x=r,e[s+2].y=o,e[s+3].x=r+l*a,e[s+3].y=o)},updateColor:function(){}},Fk=(Ze(Bk,Nk),null),c=Je(Nk,{getAssemblerData:function(){return(Fk=Fk||new lz(1024,1024)).getTexture()},_updateFontFamily:function(e){uz.fontAtlas=Fk,uz.fontFamily=this._getFontFamily(e);var t=e.getComponent(T3);t&&t.enabled?(uz.isOutlined=!0,uz.margin=t.width,uz.out=t.color.clone(),uz.out.a=t.color.a*e.color.a/255):(uz.isOutlined=!1,uz.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){var t,i;uz.fontDesc=this._getFontDesc(),uz.color=e.color,uz.hash=(t=(e=uz).color.toHEX(),i="",e.isOutlined&&0<e.margin&&(i=i+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+i)},_getFontDesc:function(){return uz.fontSize.toString()+"px "+uz.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),zk=new nr(255,255,255,255),Uk={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t;e.renderData&&(t=e.node,zk.a=255*t._uiProps.opacity,JB(t,0,e.renderData,zk))},updateColor:function(){},appendQuad:Bk.appendQuad},kk=(Ze(Uk,c),g4.Overflow),Gk=(1/255).toFixed(3),Hk=null,Vk=null,jk=null,Wk="",qk="",Xk=0,Yk=0,Kk=[],Qk=new Hr,Zk=0,Jk=0,$k=0,e5=new nr,t5="",i5=kk.NONE,n5=!1,r5=null,o5=nr.BLACK.clone(),a5=null,s5=nr.BLACK.clone(),c5=new qr,l5=Hr.ZERO.clone(),u5=Hr.ZERO.clone(),h5=U.ZERO.clone(),p5=U.ZERO.clone(),_5=0,f5=!1,d5=!1,m5=!1,g5=["left","center","right"],A={getAssemblerData:function(){return g4._canvasPool.get()},resetAssemblerData:function(e){e&&g4._canvasPool.put(e)},updateRenderData:function(e){var t;e.renderData&&(e.renderData.vertDirty&&(t=e.node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=Xk,t.setContentSize(Qk),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),jk=Vk=Hk=null),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){t5=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var i=e.assemblerData;i&&(Hk=i.context,Vk=i.canvas,jk=e.spriteFrame,qk=e.string.toString(),Xk=e.fontSize,Yk=Xk,i5=e.overflow,u5.width=Qk.width=t.width,u5.height=Qk.height=t.height,_5=e.underlineHeight,Zk=e.lineHeight,Jk=e.horizontalAlign,$k=e.verticalAlign,e5=e.color,e.node._uiProps.opacity,f5=e.isBold,d5=e.isItalic,m5=e.isUnderline,n5=i5!==kk.NONE&&(i5===kk.RESIZE_HEIGHT||e.enableWrapText),(r5=(r5=T3&&e.getComponent(T3))&&r5.enabled&&0<r5.width?r5:null)&&o5.set(r5.color),(a5=(a5=vU&&e.getComponent(vU))&&a5.enabled?a5:null)&&s5.set(a5.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e,t,i=0,n=0,r=0,o=0,a=0;l5.width=l5.height=0,r5&&(i=n=r=o=a=r5.width,l5.width=l5.height=2*a),a5&&(a=a5.blur+a,t=a5.offset.x,e=a5.offset.y,r=Math.max(r,-t+a),o=Math.max(o,t+a),i=Math.max(i,e+a),n=Math.max(n,-e+a)),d5&&(o+=t=Yk*Math.tan(.20943951),l5.width+=t),c5.x=r,c5.y=i,c5.width=r+o,c5.height=i+n},_calculateFillTextStartPosition:function(){var e=0,t=(Jk===a4.RIGHT?e=Qk.width-c5.width:Jk===a4.CENTER&&(e=(Qk.width-c5.width)/2),this._getLineHeight()*(Kk.length-1)),i=Xk*(1-MF/2);$k!==s4.TOP&&(t=t+c5.height+Xk-Qk.height,$k===s4.BOTTOM?i-=t+=MF/2*Xk:i-=t/2),i+=0*Xk,h5.set(e+c5.x,i+c5.y)},_updateTexture:function(e){if(Hk&&Vk){Hk.clearRect(0,0,Vk.width,Vk.height),Hk.font=Wk,this._calculateFillTextStartPosition();var t,i=this._getLineHeight(),n=(Hk.lineJoin="round",r5?(Hk.fillStyle="rgba("+o5.r+", "+o5.g+", "+o5.b+", "+Gk+")",Hk.fillRect(0,0,Vk.width,Vk.height)):e._srcBlendFactor===jo.SRC_ALPHA&&(Hk.fillStyle="rgba("+e5.r+", "+e5.g+", "+e5.b+", "+Gk+")",Hk.fillRect(0,0,Vk.width,Vk.height)),Hk.fillStyle="rgb("+e5.r+", "+e5.g+", "+e5.b+")",h5.x);this._drawTextEffect(h5,i);for(var r=0;r<Kk.length;++r)t=h5.y+r*i,r5&&Hk.strokeText(Kk[r],n,t),Hk.fillText(Kk[r],n,t);a5&&(Hk.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){var t;e.cacheMode===g4.CacheMode.BITMAP&&(t=e.ttfSpriteFrame,oF.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()),jk&&Vk&&(t=jk instanceof lF?jk.texture:jk,0!==Vk.width&&0!==Vk.height&&(t.reset({width:Vk.width,height:Vk.height,mipmapLevel:1}),t.uploadData(Vk),jk instanceof lF&&(jk.rect=new qr(0,0,Vk.width,Vk.height),jk._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),j.director.root&&j.director.root.batcher2D&&j.director.root.batcher2D._releaseDescriptorSetCache(t.getHash())))},_calDynamicAtlas:function(e){var t;e.cacheMode===g4.CacheMode.BITMAP&&(t=e.ttfSpriteFrame,oF.packToDynamicAtlas(e,t))},_setupOutline:function(){Hk.strokeStyle="rgba("+o5.r+", "+o5.g+", "+o5.b+", "+o5.a/255+")",Hk.lineWidth=2*r5.width},_setupShadow:function(){Hk.shadowColor="rgba("+s5.r+", "+s5.g+", "+s5.b+", "+s5.a/255+")",Hk.shadowBlur=a5.blur,Hk.shadowOffsetX=a5.offset.x,Hk.shadowOffsetY=-a5.offset.y},_drawTextEffect:function(e,t){if(a5||r5||m5){var i,n,r=1<Kk.length&&a5,o=this._measureText(Hk,Wk);a5&&this._setupShadow(),r5&&this._setupOutline();for(var a=0;a<Kk.length;++a)i=e.x,n=e.y+a*t,r&&(r5&&Hk.strokeText(Kk[a],i,n),Hk.fillText(Kk[a],i,n)),m5&&(ik=o(Kk[a]),Jk===a4.RIGHT?p5.x=e.x-ik:Jk===a4.CENTER?p5.x=e.x-ik/2:p5.x=e.x,p5.y=n+Yk/8,Hk.fillRect(p5.x,p5.y,ik,_5));r&&(Hk.shadowColor="transparent")}},_updateLabelDimensions:function(){Qk.width=Math.min(Qk.width,2048),Qk.height=Math.min(Qk.height,2048);var e=!1;Vk.width!==Qk.width&&(Vk.width=Qk.width,e=!0),Vk.height!==Qk.height&&(Vk.height=Qk.height,e=!0),e&&(Hk.font=Wk),Hk.textAlign=g5[Jk],Hk.textBaseline="alphabetic"},_getFontDesc:function(){var e=Xk.toString()+"px ";return e+=t5,f5&&(e="bold "+e),e=d5?"italic "+e:e},_getLineHeight:function(){return 0|(0===Zk?Xk:Zk*Xk/Yk)},_calculateParagraphLength:function(e,t){for(var i=[],n=ge(e);!(r=n()).done;){var r=qF(t,r.value,Wk);i.push(r)}return i},_measureText:function(t,i){return function(e){return qF(t,e,i)}},_calculateShrinkFont:function(e){if(Hk){var t=this._calculateParagraphLength(e,Hk),i=0,n=0,r=0;if(n5){var o=u5.width,a=u5.height;if(!(o<0||a<0)){n=a+1;for(var s,c=0,l=0|Xk+1;c<l;){if((s=c+l+1>>1)<=0){ne(4003);break}Xk=s,Wk=this._getFontDesc(),Hk.font=Wk;for(var u=this._getLineHeight(),n=0,i=0;i<e.length;++i){var h=qF(Hk,e[i],Wk);n+=YF(e[i],h,o,this._measureText(Hk,Wk)).length*u}a<n?l=s-1:c=s}0===c?ne(4003):(Xk=c,Wk=this._getFontDesc(),Hk.font=Wk)}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var p=(Qk.width-c5.width)/r,_=Qk.height/n;Xk=Yk*Math.min(1,p,_)|0,Wk=this._getFontDesc(),Hk.font=Wk}}},_calculateWrapText:function(e){if(n5&&Hk){Kk=[];for(var t=u5.width,i=0;i<e.length;++i){var n=qF(Hk,e[i],Wk),n=YF(e[i],n,t,this._measureText(Hk,Wk));Kk=Kk.concat(n)}}},_calculateLabelFont:function(){if(Hk){var e=qk.split("\n");switch(Kk=e,Wk=this._getFontDesc(),Hk.font=Wk,i5){case kk.NONE:for(var t=0,i=0,n=0;n<e.length;++n)var r=qF(Hk,e[n],Wk),t=r<t?t:r;var i=(Kk.length+MF)*this._getLineHeight(),o=parseFloat(t.toFixed(2)),i=parseFloat(i.toFixed(2));Qk.width=o+c5.width,Qk.height=i+c5.height,u5.width=o+l5.width,u5.height=i+l5.height;break;case kk.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case kk.CLAMP:this._calculateWrapText(e);break;case kk.RESIZE_HEIGHT:this._calculateWrapText(e);o=(Kk.length+MF)*this._getLineHeight();Qk.height=o+c5.height,u5.height=o+l5.height}}}},v5=nr.WHITE.clone(),y5={createData:function(e){var e=e.requestRenderData(),t=(e.dataLength=2,e.resize(4,6),e.chunk.vb);t[3]=t[21]=t[22]=t[31]=0,t[4]=t[12]=t[13]=t[30]=1;for(var i=5,n=0;n<4;n++)nr.toArray(t,v5,i),i+=9;return e},fillBuffers:function(e){var t=e.renderData.chunk,i=e.renderData.data,e=e.node,n=t.vb,r=i[0],i=i[1],o=(e.updateWorldTransform(),e._pos),a=e._rot,e=e._scale,s=r.x*e.x,c=i.x*e.x,r=r.y*e.y,i=i.y*e.y,e=a.x,l=a.y,u=a.z,a=a.w,h=e*l,p=u*a,e=e*e-l*l,l=a*a-u*u,a=l+e,u=2*(h-p),l=l-e,e=2*(h+p),h=o.x,p=o.y,o=(n[0]=a*s+u*r+h,n[1]=l*r+e*s+p,n[9]=a*c+u*r+h,n[10]=l*r+e*c+p,n[18]=a*s+u*i+h,n[19]=l*i+e*s+p,n[27]=a*c+u*i+h,n[28]=l*i+e*c+p,t.bufferId),r=t.vertexOffset,s=t.vertexAccessor.getMeshBuffer(t.bufferId),a=t.vertexAccessor.getIndexBuffer(o),u=s.indexOffset;a[u++]=r,a[u++]=r+1,a[u++]=r+2,a[u++]=r+2,a[u++]=r+1,a[+u]=r+3,s.indexOffset+=6},updateVertexData:function(e){var t,i,n,r=e.renderData;r&&(t=(e=e.node._uiProps.uiTransformComp).width,i=e.height,n=e.anchorX*t,e=e.anchorY*i,(r=r.data)[0].x=-n,r[0].y=-e,r[1].x=t-n,r[1].y=i-e)},updateUVs:function(e){var t=e.renderData;t&&e.ttfSpriteFrame&&(t=t.chunk.vb,e=e.ttfSpriteFrame.uv,t[3]=e[0],t[4]=e[1],t[12]=e[2],t[13]=e[3],t[21]=e[4],t[22]=e[5],t[30]=e[6],t[31]=e[7])},updateColor:function(){}},kd=(Ze(y5,A),Rre("labelAssembler",{getAssembler:function(e){var t=y5;return e.font instanceof PF?t=Bk:e.cacheMode===g4.CacheMode.CHAR&&(t=Uk),t}})),x5=(g4.Assembler=kd,j3.FillType),S5=new B,b5=new ce,T5={updateRenderData:function(e){var t=e.spriteFrame,i=(oF.packToDynamicAtlas(e,t),e.renderData);i&&t&&(i.updateRenderData(e,t),i.vertDirty&&(t=e.fillStart,(i=e.fillRange)<0&&(t+=i,i=-i),i=(i=1<(i=t+i)?1:i)<0?0:i,i=1<(i=(t=(t=1<t?1:t)<0?0:t)+(i=(i-=t)<0?0:i))?1:i,this.updateUVs(e,t,i),this.updateVertexData(e,t,i)))},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData.chunk.vb,o=n.width,a=n.height,s=n.rect,c=0,l=0,u=0,h=0,p=0,_=0,f=0,d=0,m=0,g=0;switch(n.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=p=c,f=m=(s.x+s.height)/o,_=g=l,h=d=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=f=c,p=m=(s.x+s.width)/o,h=_=l,d=g=s.y/a),e.fillType){case x5.HORIZONTAL:r[3]=u+(p-u)*t,r[4]=h+(_-h)*t,r[12]=u+(p-u)*i,r[13]=h+(_-h)*i,r[21]=f+(m-f)*t,r[22]=d+(g-d)*t,r[30]=f+(m-f)*i,r[31]=d+(g-d)*i;break;case x5.VERTICAL:r[3]=u+(f-u)*t,r[4]=h+(d-h)*t,r[12]=p+(m-p)*t,r[13]=_+(g-_)*t,r[21]=u+(f-u)*i,r[22]=h+(d-h)*i,r[30]=p+(m-p)*i,r[31]=_+(g-_)*i;break;default:ee(2626)}},updateVertexData:function(e,t,i){var n=e.renderData.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,r=r.anchorY*a,c=-s,l=-r,u=o-s,h=a-r,p=0;switch(e.fillType){case x5.HORIZONTAL:p=c+(u-c)*i,c+=(u-c)*t,u=p;break;case x5.VERTICAL:p=l+(h-l)*i,l+=(h-l)*t,h=p;break;default:ee(2626)}n[0].x=c,n[0].y=l,n[1].x=u,n[1].y=l,n[2].x=c,n[2].y=h,n[3].x=u,n[3].y=h},createData:function(e){e=e.requestRenderData();e.dataLength=4,e.resize(4,6);for(var t,i=ge(e.data);!(t=i()).done;)t.value.z=0;return e},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(S5);for(var i=e.renderData.floatStride,n=e.renderData.data,r=t.vb,o=0;o<4;o++){var a=n[o];ce.transformMat4(b5,a,S5),r[a=o*i]=b5.x,r[1+a]=b5.y,r[2+a]=b5.z}},fillBuffers:function(e){var t=e.renderData,i=t.chunk,e=((e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,i),t.vertDirty=!1),i.bufferId),t=i.vertexOffset,n=i.vertexAccessor.getMeshBuffer(i.bufferId),i=i.vertexAccessor.getIndexBuffer(e),e=n.indexOffset;i[e++]=t,i[e++]=t+1,i[e++]=t+2,i[e++]=t+2,i[e++]=t+1,i[+e]=t+3,n.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=5,t=e.color,o=t.r/255,a=t.g/255,s=t.b/255,c=e.node._uiProps.opacity,l=0;l<4;l++)i[r]=o,i[r+1]=a,i[r+2]=s,i[r+3]=c,r+=n}},E5=2*Math.PI,C5=new B,w5=new ce,A5=[new U,new U,new U,new U],P5=new Array(4),I5=new Array(8),R5=[new U,new U,new U,new U],D5=[new U,new U,new U,new U],O5=new U,M5=[new U,new U,new U,new U];function N5(e,t,i,n,r,o,a){var s,c=Math.sin(o),c=1e-6<Math.abs(c)?c:0,o=Math.cos(o),l=0,u=0;0!==(o=1e-6<Math.abs(o)?o:0)&&(l=c/o,0<(e-r.x)*o&&(s=r.y+l*(e-r.x),a[0].x=e,a[0].y=s),0<(t-r.x)*o&&(e=r.y+l*(t-r.x),a[2].x=t,a[2].y=e)),0!==c&&(u=o/c,0<(n-r.y)*c&&(s=r.x+u*(n-r.y),a[3].x=s,a[3].y=n),0<(i-r.y)*c&&(l=r.x+u*(i-r.y),a[1].x=l,a[1].y=i))}function L5(e,t){var i=t.x-e.x,t=t.y-e.y;if(0==i&&0==t)return 0;if(0==i)return 0<t?.5*Math.PI:1.5*Math.PI;e=Math.atan(t/i);return i<0&&(e+=Math.PI),e}function B5(e,t,i,n,r){var o=P5[0],a=P5[1],s=P5[2],c=P5[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y,F5((i.x-o)/(s-o),(i.y-a)/(c-a),e,t),F5((n.x-o)/(s-o),(n.y-a)/(c-a),e,t+1),F5((r.x-o)/(s-o),(r.y-a)/(c-a),e,t+2)}function F5(e,t,i,n){var r=I5,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,r=r[5]+(r[7]-r[5])*e,e=i[n];e.u=o+(a-o)*t,e.v=s+(r-s)*t}for(var z5={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t,i,n=e.spriteFrame,r=(oF.packToDynamicAtlas(e,n),this.updateUVs(e),e.renderData);if(r&&n&&r.vertDirty){var o=r.data,a=e.fillStart,s=e.fillRange;for(s<0&&(a+=s,s=-s);1<=a;)--a;for(;a<0;)a+=1;var c=(a*=E5)+(s*=E5),l=(p=(d=e).node._uiProps.uiTransformComp).width,u=p.height,h=p.anchorX*l,p=p.anchorY*u,_=-h,f=-p,l=l-h,h=u-p,p=((u=P5)[0]=_,u[1]=f,u[2]=l,u[3]=h,d.fillCenter),d=O5.x=Math.min(Math.max(0,p.x),1)*(l-_)+_,p=O5.y=Math.min(Math.max(0,p.y),1)*(h-f)+f;A5[0].x=A5[3].x=_,A5[1].x=A5[2].x=l,A5[0].y=A5[1].y=f,A5[2].y=A5[3].y=h;for(var m=ge(M5);!(g=m()).done;){var g=g.value;U.set(g,0,0)}d!==u[0]&&U.set(M5[0],3,0),d!==u[2]&&U.set(M5[2],1,2),p!==u[1]&&U.set(M5[1],0,1),p!==u[3]&&U.set(M5[3],2,3),l=(_=n).width,f=_.height,h=_.getRect(),t=u=p=d=0,i=I5,_.isRotated()?(d=h.x/l,p=(h.x+h.height)/l,u=h.y/f,t=(h.y+h.width)/f,i[0]=i[2]=d,i[4]=i[6]=p,i[3]=i[7]=t,i[1]=i[5]=u):(d=h.x/l,p=(h.x+h.width)/l,u=h.y/f,t=(h.y+h.height)/f,i[0]=i[4]=d,i[2]=i[6]=p,i[1]=i[3]=t,i[5]=i[7]=u),N5(P5[0],P5[2],P5[1],P5[3],O5,a,R5),N5(P5[0],P5[2],P5[1],P5[3],O5,a+s,D5);for(var v=0,y=0;y<4;++y){var x=M5[y];if(x)if(E5<=s)r.dataLength=v+3,B5(o,v,O5,A5[x.x],A5[x.y]),v+=3;else{var S=L5(O5,A5[x.x]),b=L5(O5,A5[x.y]);b<S&&(b+=E5),S-=E5,b-=E5;for(var T=0;T<3;++T)c<=S||(a<=S?(r.dataLength=v+3,B5(o,v,O5,A5[x.x],c<=b?D5[y]:A5[x.y]),v+=3):a<b&&(b<=c?(r.dataLength=v+3,B5(o,v,O5,R5[y],A5[x.y])):(r.dataLength=v+3,B5(o,v,O5,R5[y],D5[y])),v+=3)),S+=E5,b+=E5}}r.resize(v,v),r.updateRenderData(e,n)}},fillBuffers:function(e){var t=e.node,i=e.renderData,n=i.chunk;(t.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexAndUVData(e,n),i.vertDirty=!1),this.updataColorLate(e);for(var t=n.bufferId,r=n.vertexOffset,e=n.vertexAccessor.getMeshBuffer(n.bufferId),o=n.vertexAccessor.getIndexBuffer(t),a=e.indexOffset,s=0;s<i.indexCount;s++)o[a+s]=r+s;e.indexOffset+=i.indexCount,e.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(C5);for(var i=e.renderData,n=i.floatStride,r=e.renderData.data,o=t.vb,a=i.vertexCount,s=0,c=0;c<a;c++){var l=r[c];ce.set(w5,l.x,l.y,0),ce.transformMat4(w5,w5,C5),o[s+0]=w5.x,o[s+1]=w5.y,o[s+2]=w5.z,o[s+3]=l.u,o[s+4]=l.v,s+=n}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=t.vertexCount,o=5,t=e.color,a=t.r/255,s=t.g/255,c=t.b/255,l=e.node._uiProps.opacity,u=0;u<r;u++)i[o]=a,i[o+1]=s,i[o+2]=c,i[o+3]=l,o+=n},updateColor:function(){}},U5=[],k5=0;k5<4;k5++)U5.push(new ce);for(var G5={createData:function(e){e=e.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(e){var t=e.spriteFrame,i=(oF.packToDynamicAtlas(e,t),this.updateUVs(e),e.renderData);i&&t&&(i.vertDirty&&this.updateVertexData(e),i.updateRenderData(e,t))},updateWorldVerts:function(e,t){var i,n,r,o,a=e.renderData,t=t.vb,a=a.data,e=e.node,s=a[0],a=a[1],e=e.worldMatrix,c=e.m00,l=e.m01,u=e.m04,h=e.m05,p=e.m12,e=e.m13,_=s.x,f=a.x,s=s.y,a=a.y;1===c&&0===l&&0===u&&1===h?(r=f+p,i=s+e,o=a+e,t[0]=n=_+p,t[1]=i,t[9]=r,t[10]=i,t[18]=n,t[19]=o,t[27]=r,t[28]=o):(i=c*f,n=l*_,r=l*f,o=u*a+p,l=h*s+e,f=h*a+e,t[0]=(h=c*_)+(a=u*s+p),t[1]=n+l,t[9]=i+a,t[10]=r+l,t[18]=h+o,t[19]=n+f,t[27]=i+o,t[28]=r+f)},fillBuffers:function(e){var t,i,n;null!==e&&(n=(t=e.renderData).chunk,(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1),e=n.bufferId,t=n.vertexOffset,i=n.vertexAccessor.getMeshBuffer(n.bufferId),n=n.vertexAccessor.getIndexBuffer(e),e=i.indexOffset,n[e++]=t,n[e++]=t+1,n[e++]=t+2,n[e++]=t+2,n[e++]=t+1,n[e++]=t+3,i.indexOffset+=6)},updateVertexData:function(e){var t,i,n,r,o,a,s,c,l,u,h,p,_,f,d=e.renderData;d&&(o=e.node._uiProps.uiTransformComp,t=d.data,i=o.width,n=o.height,r=o.anchorX*i,o=o.anchorY*n,f=_=p=h=0,f=e.trim?(h=-r,p=-o,_=i-r,n-o):(a=(e=e.spriteFrame).getOriginalSize(),s=e.getRect(),c=a.width,a=a.height,u=s.width,s=s.height,l=(e=e.getOffset()).x+(c-u)/2,u=e.x-(c-u)/2,h=l*(l=i/c)-r,p=(e.y+(a-s)/2)*(c=n/a)-o,_=i+u*l-r,n+(e.y-(a-s)/2)*c-o),t[0].x=h,t[0].y=p,t[1].x=_,t[1].y=f,d.vertDirty=!0)},updateUVs:function(e){var t;e.spriteFrame&&(t=e.renderData.chunk.vb,e=e.spriteFrame.uv,t[3]=e[0],t[4]=e[1],t[12]=e[2],t[13]=e[3],t[21]=e[4],t[22]=e[5],t[30]=e[6],t[31]=e[7])},updateColor:function(e){for(var t=e.renderData,i=t.chunk.vb,n=5,e=e.color,r=e.r/255,o=e.g/255,a=e.b/255,s=e.a/255,c=0;c<4;c++,n+=t.floatStride)i[n]=r,i[n+1]=o,i[n+2]=a,i[n+3]=s}},H5=new ce,V5=new B,j5={createData:function(e){e=e.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(e){var t=e.spriteFrame,i=(oF.packToDynamicAtlas(e,t),this.updateUVs(e),e.renderData);i&&t&&(i.vertDirty&&this.updateVertexData(e),i.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,i=e.node._uiProps.uiTransformComp,n=i.width,r=i.height,o=i.anchorX*n,i=i.anchorY*r,e=e.spriteFrame,a=e.insetLeft,s=e.insetRight,c=e.insetTop,e=e.insetBottom,l=n-a-s,u=r-c-e,s=n/(a+s),c=r/(c+e),s=Number.isNaN(s)||1<s?1:s,c=Number.isNaN(c)||1<c?1:c,l=l<0?0:l,u=u<0?0:u;t[0].x=-o,t[0].y=-i,t[1].x=a*s-o,t[1].y=e*c-i,t[2].x=t[1].x+l,t[2].y=t[1].y+u,t[3].x=n-o,t[3].y=r-i},fillBuffers:function(e){var t=e.renderData,i=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,i),t.vertDirty=!1);for(var e=i.bufferId,n=i.vertexOffset,t=i.vertexAccessor.getMeshBuffer(i.bufferId),r=i.vertexAccessor.getIndexBuffer(e),o=t.indexOffset,a=0;a<3;++a)for(var s=0;s<3;++s){var c=n+4*a+s;r[o++]=c,r[o++]=c+1,r[o++]=c+4,r[o++]=c+1,r[o++]=c+5,r[o++]=c+4}t.indexOffset=o},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(V5);for(var e=e.renderData,i=e.floatStride,n=e.data,r=t.vb,o=0;o<4;++o)for(var a=n[o],s=0;s<4;++s){var c=n[s];ce.set(H5,c.x,a.y,0),ce.transformMat4(H5,H5,V5),c=(4*o+s)*i,r[c++]=H5.x,r[c++]=H5.y,r[+c]=H5.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=e.spriteFrame.uvSliced,o=3,a=0;a<16;a++)i[o]=r[a].u,i[o+1]=r[a].v,o+=n},updateColor:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=5,t=e.color,o=t.r/255,a=t.g/255,s=t.b/255,c=e.node._uiProps.opacity,l=0;l<16;l++)i[r]=o,i[r+1]=a,i[r+2]=s,i[r+3]=c,r+=n}},W5=[],q5=0;q5<4;q5++)W5.push(new ce);var X5=new B,Y5={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t,i,n,r,o,a,s,c=e.renderData,l=e.spriteFrame;l&&c&&(c.updateRenderData(e,l),c.vertDirty)&&(a=e.node._uiProps.uiTransformComp,n=Math.abs(a.width),a=Math.abs(a.height),i=l.getRect(),r=l.insetLeft,o=l.insetRight,t=i.width-r-o,s=l.insetTop,l=l.insetBottom,i=i.height-s-l,n=0<(n=n-r-o)?n:0,r=0<(r=a-s-l)?r:0,o=0==t?n:n/t,a=Math.ceil((0==i?r:r/i)+2),s=Math.ceil(o+2),c.dataLength=Math.max(8,a+1,s+1),this.updateVerts(e,n,r,a,s),c.resize(a*s*4,a*s*6))},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,i=e.renderData,n=i.chunk;(t.hasChangedFlags||i.vertDirty)&&(this.updateWorldVertexAndUVData(e,n),i.vertDirty=!1),this.updataColorLate(e);for(var t=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(t),s=o.indexOffset,c=0;c<i.indexCount;c+=6)a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,a[s++]=r+2,r+=4,o.indexOffset+=6;o.setDirty()},updateWorldVertexAndUVData:function(e,t){for(var i,n,r=e.node,o=(r.getWorldMatrix(X5),e.renderData),a=o.floatStride,s=o.data,c=t.vb,o=r._uiProps.uiTransformComp,t=Math.abs(o.width),r=Math.abs(o.height),o=e.spriteFrame,B=o.rotated,F=o.uv,l=o.uvSliced,e=o.rect,u=o.insetLeft,h=o.insetRight,p=e.width-u-h,_=o.insetTop,o=o.insetBottom,f=e.height-_-o,d=0<(d=t-u-h)?d:0,m=0<(m=r-_-o)?m:0,g=0==p?d:d/p,v=0==f?m:m/f,y=Math.ceil(v+2),x=Math.ceil(g+2),S=0,b=0,z=y;b<z;++b)for(var T=s[b].y,U=s[b+1].y,E=0,k=x;E<k;++E){i=s[E].x,n=s[E+1].x,ce.set(W5[0],i,T,0),ce.set(W5[1],n,T,0),ce.set(W5[2],i,U,0),ce.set(W5[3],n,U,0);for(var C=0;C<4;C++){var w=W5[C],A=(ce.transformMat4(w,w,X5),C*a);c[S+A]=w.x,c[S+A+1]=w.y,c[S+A+2]=w.z}S+=4*a}for(var S=0,G=a,H=2*a,V=3*a,j=4*a,P=[],I=[],R=0,W=y;R<W;++R)for(var D=f<m?R*f<=m?1:v%1:v,O=0,q=x;O<q;++O){var M=p<d?O*p<=d?1:g%1:g,N=S+3,L=N+1;B?(0===R?(P[0]=l[0].u,P[1]=l[0].u,P[2]=l[4].u+(l[8].u-l[4].u)*D):R<y-1?(P[0]=l[4].u,P[1]=l[4].u,P[2]=l[4].u+(l[8].u-l[4].u)*D):R===y-1&&(P[0]=l[8].u,P[1]=l[8].u,P[2]=l[12].u),0===O?(I[0]=l[0].v,I[1]=l[1].v+(l[2].v-l[1].v)*M,I[2]=l[0].v):O<x-1?(I[0]=l[1].v,I[1]=l[1].v+(l[2].v-l[1].v)*M,I[2]=l[1].v):O===x-1&&(I[0]=l[2].v,I[1]=l[3].v,I[2]=l[2].v),P[3]=P[2],I[3]=I[1]):(0===O?(P[0]=l[0].u,P[1]=l[1].u+(l[2].u-l[1].u)*M,P[2]=F[0]):O<x-1?(P[0]=l[1].u,P[1]=l[1].u+(l[2].u-l[1].u)*M,P[2]=l[1].u):O===x-1&&(P[0]=l[2].u,P[1]=l[3].u,P[2]=l[2].u),0===R?(I[0]=l[0].v,I[1]=l[0].v,I[2]=l[4].v+(l[8].v-l[4].v)*D):R<y-1?(I[0]=l[4].v,I[1]=l[4].v,I[2]=l[4].v+(l[8].v-l[4].v)*D):R===y-1&&(I[0]=l[8].v,I[1]=l[8].v,I[2]=l[12].v),P[3]=P[1],I[3]=I[2]),c[N]=P[0],c[L]=I[0],c[N+G]=P[1],c[L+G]=I[1],c[N+H]=P[2],c[L+H]=I[2],c[N+V]=P[3],c[L+V]=I[3],S+=j}},updateVerts:function(e,t,i,n,r){for(var o=e.node._uiProps.uiTransformComp,a=e.renderData.data,e=e.spriteFrame,s=e.rect,c=Math.abs(o.width),l=Math.abs(o.height),u=o.anchorX*c,h=o.anchorY*l,p=e.insetLeft,_=e.insetRight,f=s.width-p-_,d=e.insetTop,m=e.insetBottom,g=s.height-d-m,v=1<o.width/(p+_)?1:o.width/(p+_),y=1<o.height/(d+m)?1:o.height/(d+m),x=0<f?Math.floor(1e3*t)/1e3%f==0?f:t%f:t,S=0<g?Math.floor(1e3*i)/1e3%g==0?g:i%g:i,b=0;b<=r;b++)0===b?a[b].x=-u:0<b&&b<r?a[b].x=1===b?p*v+Math.min(f,t)-u:0<f?b===r-1?p+x+f*(b-2)-u:p+Math.min(f,t)+f*(b-2)-u:p+t-u:b===r&&(a[b].x=Math.min(p+t+_,c)-u);for(var T=0;T<=n;T++)0===T?a[T].y=-h:0<T&&T<n?a[T].y=1===T?m*y+Math.min(g,i)-h:0<g?T===n-1?m+S+(T-2)*g-h:m+Math.min(g,i)+(T-2)*g-h:m+i-h:T===n&&(a[T].y=Math.min(m+i+d,l)-h)},updataColorLate:function(e){for(var t=e.renderData,i=t.chunk.vb,n=t.floatStride,r=t.vertexCount,o=5,t=e.color,a=t.r/255,s=t.g/255,c=t.b/255,l=e.node._uiProps.opacity,u=0;u<r;u++)i[o]=a,i[o+1]=s,i[o+2]=c,i[o+3]=l,o+=n},updateColor:function(){}},K5=j3.Type,Q5=j3.FillType,Z5=Rre("spriteAssembler",{getAssembler:function(e){var t=G5,i=e;switch(i.type){case K5.SLICED:t=j5;break;case K5.TILED:t=Y5;break;case K5.FILLED:t=i.fillType===Q5.RADIAL?z5:T5}return t}}),J5=(j3.Assembler=Z5,Gz.sharedManager),$5={createData:function(e){e=e.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(e){e.type===U4.IMAGE_STENCIL&&(G5.updateRenderData(e),G5.updateColor(e))},fillBuffers:function(e,t){var i,n;e.type===U4.IMAGE_STENCIL&&!e.spriteFrame||(J5.pushMask(e),t.finishMergeBatches(),i=e,n=t,J5.clear(i),n.commitModel(i,i._clearModel,i._clearStencilMtl),n=e,i=t,J5.enterLevel(n),n.type===U4.IMAGE_STENCIL?(G5.fillBuffers(n,i),e=n.graphics.getMaterialInstance(0),i.forceMergeBatches(e,n.spriteFrame,n.graphics)):n.graphics.updateAssembler(i),J5.enableMask())}},eG={fillBuffers:function(){J5.exitMask()}},C={getAssembler:function(){return eG}},tG=(h.Assembler={getAssembler:function(){return $5}},h.PostAssembler=C,Rre("MeshBuffer",((kp=iG.prototype).initialize=function(e,t){this._initVDataCount=1024*zt.BATCHER2D_MEM_INCREMENT/Float32Array.BYTES_PER_ELEMENT,this._initVDataCount,oe(9005),this._initIDataCount=this._initVDataCount*iG.IB_SCALE,this._attributes=t,this._floatsPerVertex=YB(t),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},kp.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},kp.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},kp.setDirty=function(){this._dirty=!0},kp.request=function(){return J(9002),!1},kp.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},kp.recycleIA=function(e){for(var t,i=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===i[n].ia)return t=i[n],i[n]=i[--this._nextFreeIAHandle],void(i[this._nextFreeIAHandle]=t)},kp.checkCapacity=function(e,t){e=this.vertexOffset+e,t=this.indexOffset+t;return!(e>this._initVDataCount||t>this._initIDataCount)},kp.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=af.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,i=this.indexOffset,n=0;n<e;++n){var r=this._iaPool[n],o=new Float32Array(this.vData.buffer,0,t>>2),a=new Uint16Array(this.iData.buffer,0,i),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(o),2*i>r.indexBuffer.size&&r.indexBuffer.resize(2*i),r.indexBuffer.update(a)}this._dirty=!1}},kp.createNewIA=function(e){var t,i,n;return af.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]?(n=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,i=Uint16Array.BYTES_PER_ELEMENT,n=e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,n,n)),i=e.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,i,i)),this._iaInfo=new Xa(this._attributes,n=[n],i),t=e.createInputAssembler(this._iaInfo)):(t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer),{ia:t,vertexBuffers:n,indexBuffer:i}},e(iG,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),iG)));function iG(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}tG.IB_SCALE=4;function nG(e,t,i,n){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=i,this.vb=n}var rG,oG=[Aw.EventType.MOUSE_DOWN,Aw.EventType.MOUSE_MOVE,Aw.EventType.MOUSE_UP,Aw.EventType.MOUSE_WHEEL],aG=[Aw.EventType.TOUCH_START,Aw.EventType.TOUCH_MOVE,Aw.EventType.TOUCH_END,Aw.EventType.TOUCH_CANCEL],B1=((P=vG.prototype).dispatchEvent=function(e){var t=e.type;return aG.includes(t)?this.dispatchEventTouch(e):!oG.includes(t)||this.dispatchEventMouse(e)},P.addPointerEventProcessor=function(e){0===this._inDispatchCount?(this._pointerEventProcessorList.push(e),this._isListDirty=!0):(gt.array.remove(this._processorListToRemove,e),this._processorListToAdd.push(e))},P.removePointerEventProcessor=function(e){0===this._inDispatchCount?(gt.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):(gt.array.remove(this._processorListToAdd,e),this._processorListToRemove.push(e))},P.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,i=t.length,n=!0,r=0;r<i;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)){if(n=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),n},P.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,i=t.length,n=e.touch,r=!0,o=0;o<i;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===vE.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(n.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(0<a.claimedTouchIdList.length){var s=a.claimedTouchIdList.indexOf(n.getID());if(-1!==s){if(a._handleEventTouch(e),e.type!==vE.TOUCH_END&&e.type!==vE.TOUCH_CANCEL||gt.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},P._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,i=0;i<t;++i)this.addPointerEventProcessor(e[i]);e.length=0;for(var n=this._processorListToRemove,r=n.length,o=0;o<r;++o)this.removePointerEventProcessor(n[o]);n.length=0},P._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,i=0;i<t;++i){var n=e[i],r=n.node._uiProps.uiTransformComp;n.cachedCameraPriority=r.cameraPriority}e.sort(this._sortByPriority),this._isListDirty=!1}},P._sortByPriority=function(e,t){var i=e.node,n=t.node;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=i,o=n,a=!1;(null==(s=r.parent)?void 0:s._id)!==(null==(s=o.parent)?void 0:s._id);)var s,r=null===(null==(s=r)||null==(s=s.parent)?void 0:s.parent)?(a=!0,n):r&&r.parent,o=null===(null==(s=o)||null==(s=s.parent)?void 0:s.parent)?(a=!0,i):o&&o.parent;if(r._id===o._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}t=r?r.getSiblingIndex():0,e=o?o.getSiblingIndex():0;return a?t-e:e-t},P._markListDirty=function(){this._isListDirty=!0},new vG,(Y3=gG.prototype).initialize=function(){},Y3.reset=function(){},Y3.request=function(){},Y3.appendBuffers=function(){},Y3.uploadBuffers=function(){},Y3.destroy=function(){this._attributes.length=0},e(gG,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),gG),sG=new Tt(function(){return{offset:0,length:0}},32),cG=(l(mG,rG=B1),(pF=mG.prototype).destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var t=this._freeLists[e],i=0;i<t.length;++i)sG.free(t[i])}this._buffers.length=0,this._freeLists.length=0,rG.prototype.destroy.call(this)},pF.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},pF.getVertexBuffer=function(e){return this._buffers[e].vData},pF.getIndexBuffer=function(e){return this._buffers[e].iData},pF.getMeshBuffer=function(e){return this._buffers[e]},pF.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],i=this._buffers[e];(!t||t.length<i.vData.byteLength)&&i.uploadBuffers()}},pF.appendIndices=function(){},pF.allocateChunk=function(e,t){for(var i=e*this.vertexFormatBytes,n=null,r=0,o=-1,a=null,s=0;s<this._buffers.length;++s){for(var n=this._buffers[s],c=this._freeLists[s],l=0;l<c.length;++l)if(c[l].length>=i){a=c[l],r=s,o=l;break}if(a)break}return a||(r=this._allocateBuffer(),(n=this._buffers[r])&&n.checkCapacity(e,t)&&(a=this._freeLists[r][o=0])),a?(e=a.offset/this.vertexFormatBytes,t=new Float32Array(n.vData.buffer,a.offset,i>>2).fill(0),this._allocateChunkFromEntry(r,o,a,i),new nG(this,r,e,t)):(J(9004,i),null)},pF.recycleChunk=function(e){var t=this._freeLists[e.bufferId],i=this._buffers[e.bufferId],n=e.vertexOffset*this.vertexFormatBytes,e=e.vb.byteLength;if(0!==e){for(var r,o=!1,a=0,s=null,c=t[a];c&&c.offset<n;)s=c,c=t[++a];s&&0==n-(s.offset+s.length)&&(s.length+=e,n=s.offset,e=s.length,c&&c.offset-(n+e)==0&&(s.length+=c.length,t.splice(a,1),sG.free(c),c=null),o=!0),!o&&c&&(0==c.offset-(n+e)?(c.offset=n,c.length+=e):((r=sG.alloc()).offset=n,r.length=e,t.splice(a,0,r)),o=!0),o?n+e===i.byteOffset&&(i.byteOffset=n):((r=sG.alloc()).offset=n,r.length=e,t.push(r))}},pF._allocateChunkFromEntry=function(e,t,i,n){var r=i.length-n,o=i.offset+n,a=this._buffers[e];a.byteOffset<o&&(a.byteOffset=o),re(0<=r,9004,e,i.offset,i.length),0==r?(this._freeLists[e].splice(t,1),sG.free(i)):(i.offset+=n,i.length=r)},pF._allocateBuffer=function(){re(this._buffers.length===this._freeLists.length,9003);var e=new tG,t=(e.initialize(this._device,this._attributes),this._buffers.push(e),sG.alloc());return t.offset=0,t.length=e.vData.byteLength,this._freeLists.push([t]),this._buffers.length-1},mG),lG=new rs(null),uG=new B,Up=Rre("UI",((bne=dG.prototype).initialize=function(){return!0},bne.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach(function(e){e.destroy()}),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),Gz.sharedManager.destroy()},bne.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},bne.removeScreen=function(e){e=this._screens.indexOf(e);-1!==e&&this._screens.splice(e,1)},bne.sortScreens=function(){this._screens.sort(this._screenSort)},bne.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,i=0;i<t.length;i++){var n=t[i];if(n.visibility&e.layer)return n}return null},bne.update=function(){for(var e=this._screens,t=0,i=0;i<e.length;++i){var n=e[i],r=n._getRenderScene();if(n.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(n.node),this.autoMergeBatches(this._currComponent);var o=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},bne.uploadBuffers=function(){0<this._batches.length&&(this._meshDataArray.forEach(function(e){e.uploadBuffers()}),this._bufferAccessors.forEach(function(e){e.uploadBuffers(),e.reset()}),this._descriptorSetCache.update())},bne.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach(function(e){e.reset()}),this._meshDataArray.forEach(function(e){e.freeIAPool()}),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._meshBufferUseCount.clear(),this._batches.clear(),Gz.sharedManager.reset()},bne.switchBufferAccessor=function(e){var t,i=(e=void 0===e?XB:e)===XB?36:KB(e);return this._staticVBBuffer&&this._staticVBBuffer.vertexFormatBytes===i||((t=this._bufferAccessors.get(i))||(t=new cG(this.device,e),this._bufferAccessors.set(i,t)),this._staticVBBuffer=t,this._currBID=-1),this._staticVBBuffer},bne.updateBuffer=function(e,t){e=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=e.getMeshBuffer(t).indexOffset)},bne.commitComp=function(e,t,i,n,r){var o,a=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,o=t.material,s=t.chunk.bufferId}e.stencilStage=Gz.sharedManager.stage;var c=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,i?(this._currTexture=i.getGFXTexture(),this._currSampler=i.getGFXSampler(),this._currTextureHash=i.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),n.fillBuffers(e,this)},bne.commitModel=function(e,t,i){this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);var n,r=0,o=(i&&(e.stencilStage!==JF.ENABLED&&e.stencilStage!==JF.DISABLED||(e.stencilStage=Gz.sharedManager.stage),n=Gz.sharedManager.getStencilStage(e.stencilStage,i),r=Gz.sharedManager.getStencilHash(e.stencilStage)),j.director.getTotalFrames());t&&(t.updateTransform(o),t.updateUBOs(o));for(var a=0;a<t.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=t.subModels[a];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,s.fillPasses(i,n=n||null,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currLayer=0},bne.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},bne.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},bne.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},bne.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var i,n,r,o=this._currRenderData,a=this._staticVBBuffer;if(o&&o.isMeshBuffer)i=o.requestIA(this.device),-1===this._meshDataArray.indexOf(o)&&this._meshDataArray.push(o);else if(a){var o=this._currBID,a=a.getMeshBuffer(o);if(!a)return;o=a.indexOffset-this._indexStart;if(o<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(i=a.requireFreeIA(this.device)).firstIndex=this._indexStart,i.indexCount=o,this._indexStart=a.indexOffset}this._currBID=-1,i&&(a=o=0,e&&(n=-1===e.blendHash?null:e.getBlendState(),a=e.blendHash,r=null!==e.customMaterial?Gz.sharedManager.getStencilStage(e.stencilStage,t):Gz.sharedManager.getStencilStage(e.stencilStage),o=Gz.sharedManager.getStencilHash(e.stencilStage)),(e=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc()).visFlags=this._currLayer,e.texture=this._currTexture,e.sampler=this._currSampler,e.inputAssembler=i,e.useLocalData=this._currTransform,e.textureHash=this._currTextureHash,e.samplerHash=this._currSamplerHash,e.fillPasses(t,r,o,n,a,null,this),this._batches.push(e))}},bne.forceMergeBatches=function(e,t,i){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this.autoMergeBatches(i)},bne.finishMergeBatches=function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},bne.flushMaterial=function(e){this._currMaterial=e},bne.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var i=e.children,n=e._uiProps,r=n.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*n.localOpacity,n._opacity=a,n.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&0<r.renderData.vertexCount){s=r.renderData;var c=a;s.vertexFormat;for(var l=s.chunk.vb,u=s.floatStride,h=u-1;h<l.length;h+=u)l[h]=c}if(0<i.length&&!e._static)for(var p=0;p<i.length;++p){var _=i[p];this.walk(_,t)}n.colorDirty&&(this._opacityDirty--,n.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this)}},bne._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},bne._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},e(dG,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),dG)),hG=((YD=fG.prototype).initialize=function(e){var t=j.director.root.device,t=(this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,lG.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(lG),this._descriptorSet.bindBuffer(Ng.BINDING,this._localBuffer),Rg.SAMPLER_SPRITE);this._descriptorSet.bindTexture(t,e.texture),this._descriptorSet.bindSampler(t,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},YD.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},YD.equals=function(e,t,i){return this._transform===e&&this._textureHash===t&&this._samplerHash===i},YD.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},YD.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},YD.isValid=function(){return this._transform&&this._transform.isValid},YD.uploadLocalData=function(){var e=this._transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate&&(e=e.worldMatrix,B.toArray(this._localData,e,Ng.MAT_WORLD_OFFSET),B.inverseTranspose(uG,e),e=B.determinant(uG),e=1/Math.sqrt(e),B.multiplyScalar(uG,uG,e),B.toArray(this._localData,uG,Ng.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1)},e(fG,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),fG),pG=((Hd=_G.prototype).getDescriptorSet=function(e){var t=j.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,n=0,r=i.length;n<r;n++){var o=i[n];if(o.equals(e.useLocalData,e.textureHash,e.samplerHash))return o.descriptorSet}var a=this._localCachePool.alloc();return a.initialize(e),this._localDescriptorSetCache.push(a),a.descriptorSet}if(a=e.textureHash^e.samplerHash,this._descriptorSetCache.has(a))return this._descriptorSetCache.get(a);lG.layout=e.passes[0].localSetLayout;var t=t.device.createDescriptorSet(lG),s=Rg.SAMPLER_SPRITE;return t.bindTexture(s,e.texture),t.bindSampler(s,e.sampler),t.update(),this._descriptorSetCache.set(a,t),this._dsCacheHashByTexture.set(e.textureHash,a),t},Hd.update=function(){var t=this._localDescriptorSetCache,i=[];t.forEach(function(e){e.isValid()?e.uploadLocalData():(e.reset(),e=t.indexOf(e),i.push(e))});for(var e=i.length-1;0<=e;e--)t.splice(i[e],1)},Hd.reset=function(){var t=this;this._localDescriptorSetCache.forEach(function(e){t._localCachePool.free(e)}),this._localDescriptorSetCache.length=0},Hd.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},Hd.destroy=function(){this._descriptorSetCache.forEach(function(e){e.destroy()}),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},_G);function _G(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Tt(function(){return new hG},16,function(e){return e.destroy()})}function fG(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=j.director.root.device;this._localData=new Float32Array(Ng.COUNT),this._localBuffer=e.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Ng.SIZE,Ng.SIZE))}function dG(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._meshBufferUseCount=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Ey,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new pG,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new Ct(64),this._drawBatchPool=new Tt(function(){return new gU},128,function(e){return e.destroy(t)})}function mG(e,t){return(e=rG.call(this,e,t)||this)._freeLists=[],e._allocateBuffer(),e}function gG(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=YB(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}function vG(){this.priority=pw.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],Dw._registerEventDispatcher(this),EC.callbacksInvoker.on(SE.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),EC.callbacksInvoker.on(SE.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),EC.callbacksInvoker.on(SE.MARK_LIST_DIRTY,this._markListDirty,this)}j.internal.Batcher2D=Up,D(tG.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map(function(e){return{name:e,suggest:"please use meshBuffer.accessor."+e+" instead"}})),In(tG.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),Ee(tG.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),In(Up.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),Ee(_z.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),In(_z.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]);var yG,xG,SG,bG,TG,EG,CG,wG,AG,PG,IG,RG,DG,OG,MG,NG=null,LG=-1,BG="BES bswy:->@123",FG=Object.create(null),zG=[],UG=3e3;function kG(){for(var e=!0,t=Date.now(),i=zG.length-1;0<=i;i--){var n,r,o=zG[i],a=o.fontFamilyName;t-o.startTime>UG?(J(4933,a),o.onComplete(null,a),zG.splice(i,1)):(n=o.refWidth,NG.font=r="40px "+a,n!==qF(NG,BG,r)?(zG.splice(i,1),o.onComplete(null,a)):e=!1)}e&&(clearInterval(LG),LG=-1)}function GG(e,t,i){var n,r,o,a,s,c,l,u=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i=e.lastIndexOf("/");return e=-1!==(e=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")?'"'+e+'"':e}(e);FG[u]?i(null,u):(NG||((n=document.createElement("canvas")).width=100,n.height=100,NG=n.getContext("2d")),n=qF(NG,BG,"40px "+u),(r=document.createElement("style")).type="text/css",l="",Number.isNaN(u)?l+="@font-face { font-family:"+u+"; src:":l+='@font-face { font-family:"'+u+'"; src:',r.textContent=(l+='url("'+e+'");')+"}",document.body.appendChild(r),(l=(e=document.createElement("div")).style).fontFamily=u,e.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(e),(yG=void 0===yG?"FontFace"in window&&(l=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor),l?42<parseInt(l[1],10):!e):yG)?(o=Date.now(),a=u,s=i,l=new Promise(function(i,e){!function t(){Date.now()-o>=UG?e():document.fonts.load("40px "+a).then(function(e){1<=e.length?i():setTimeout(t,100)},function(){e()})}()}),c=null,e=new Promise(function(e,t){c=setTimeout(t,UG)}),Promise.race([e,l]).then(function(){c&&(clearTimeout(c),c=null),s(null,a)},function(){J(4933,a),s(null,a)})):(e={fontFamilyName:u,refWidth:n,onComplete:i,startTime:Date.now()},zG.push(e),-1===LG&&(LG=setInterval(kG,100))),FG[u]=r)}function HG(e,t,i,n){var r=new TF;r._nativeUrl=e,r._nativeAsset=t,n(null,r)}sR.register({".font":GG,".eot":GG,".ttf":GG,".woff":GG,".svg":GG,".ttc":GG}),dR.register({".font":HG,".eot":HG,".ttf":HG,".woff":HG,".svg":HG,".ttc":HG}),j.UI={MeshBuffer:tG,spriteAssembler:Z5,graphicsAssembler:E,labelAssembler:kd,RenderData:pz,MeshRenderData:_z,QuadRenderData:Qp};var VG,jG,WG,qG=new nr;(il=VG=VG||{})[il.NONE=0]="NONE",il[il.COLOR=1]="COLOR",il[il.SPRITE=2]="SPRITE",il[il.SCALE=3]="SCALE",Lt(VG),(Mne=jG=jG||{}).NORMAL="normal",Mne.HOVER="hover",Mne.PRESSED="pressed",Mne.DISABLED="disabled",(WG=WG||{}).CLICK="click";bp=f("cc.Button"),Bp=wp(),S=Oa(110),kw=Ep(),Gd=gl(Cz),E2=v(N1),L6=m(),ane=u(),a=m(),s=u(),XN=v(VG),y=m(),fie=u(),ba=u(),aie=u(),Nw=u(),pi=u(),hl=Op(),die=Mp(),vie=u(),Cp=u(),w=v(lF),zp=u(),Iie=v(lF),Rie=u(),x=v(lF),Pc=u(),r=v(lF),vI=u(),ll=v([mD]),t=m(),o=u(),Sa=bp(tl=Bp(tl=S(tl=kw(tl=Gd(tl=Tp((l($G,QG=W_),(Bc=$G.prototype).__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(j3);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},Bc.onEnable=function(){this._registerNodeEvent()},Bc.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},Bc.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},Bc.update=function(e){var t,i=this.target;this._transitionFinished||!i||this._transition!==VG.COLOR&&this._transition!==VG.SCALE||(this._time+=e,(e=1)<=(e=0<this._duration?this._time/this._duration:e)&&(e=1),this._transition===VG.COLOR?(t=i._uiProps.uiComp,nr.lerp(qG,this._fromColor,this._toColor,e),t&&(t.color=qG)):this.transition===VG.SCALE&&(i.getScale(this._targetScale),this._targetScale.x=Un(this._fromScale.x,this._toScale.x,e),this._targetScale.y=Un(this._fromScale.y,this._toScale.y,e),i.setScale(this._targetScale)),1===e&&(this._transitionFinished=!0))},Bc._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},Bc._resetState=function(){this._pressed=!1,this._hovered=!1;var e,t,i=this.target;i&&((e=this._transition)===VG.COLOR&&this._interactable?(t=i.getComponent(h4))&&(t.color=this._normalColor):e===VG.SCALE&&this._originalScale&&i.setScale(this._originalScale),this._transitionFinished=!0)},Bc._registerNodeEvent=function(){this.node.on(T.TOUCH_START,this._onTouchBegan,this),this.node.on(T.TOUCH_MOVE,this._onTouchMove,this),this.node.on(T.TOUCH_END,this._onTouchEnded,this),this.node.on(T.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(T.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(T.MOUSE_LEAVE,this._onMouseMoveOut,this)},Bc._registerTargetEvent=function(e){e.on(T.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},Bc._unregisterNodeEvent=function(){this.node.off(T.TOUCH_START,this._onTouchBegan,this),this.node.off(T.TOUCH_MOVE,this._onTouchMove,this),this.node.off(T.TOUCH_END,this._onTouchEnded,this),this.node.off(T.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(T.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(T.MOUSE_LEAVE,this._onMouseMoveOut,this)},Bc._unregisterTargetEvent=function(e){e.off(T.TRANSFORM_CHANGED)},Bc._getTargetSprite=function(e){var t=null;return t=e?e.getComponent(j3):t},Bc._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new ce),ce.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},Bc._onTargetSpriteFrameChanged=function(e){this._transition===VG.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},Bc._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case jG.NORMAL:this._normalSprite=e;break;case jG.HOVER:this._hoverSprite=e;break;case jG.PRESSED:this._pressedSprite=e;break;case jG.DISABLED:this._disabledSprite=e}},Bc._onTargetColorChanged=function(e){this._transition===VG.COLOR&&this._setCurrentStateColor(e)},Bc._setCurrentStateColor=function(e){switch(this._getButtonState()){case jG.NORMAL:this._normalColor=e;break;case jG.HOVER:this._hoverColor=e;break;case jG.PRESSED:this._pressedColor=e;break;case jG.DISABLED:this._disabledColor=e}},Bc._onTargetTransformChanged=function(e){e&Q0.SCALE&&this._originalScale&&this._transition===VG.SCALE&&this._transitionFinished&&ce.copy(this._originalScale,this.target.getScale())},Bc._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},Bc._onTouchMove=function(e){var t;this._interactable&&this.enabledInHierarchy&&this._pressed&&e&&((t=e.touch)&&(t=this.node._uiProps.uiTransformComp.isHit(t.getUILocation()),this._transition===VG.SCALE&&this.target&&this._originalScale?t?(ce.copy(this._fromScale,this._originalScale),ce.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(t=t?jG.PRESSED:jG.NORMAL,this._applyTransition(t)),e&&(e.propagationStopped=!0)))},Bc._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(mD.emitEvents(this.clickEvents,e),this.node.emit(WG.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},Bc._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},Bc._onMouseMoveIn=function(){this._pressed||!this.interactable||!this.enabledInHierarchy||this._transition===VG.SPRITE&&!this._hoverSprite||this._hovered||(this._hovered=!0,this._updateState())},Bc._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},Bc._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},Bc._getButtonState=function(){var e=jG.NORMAL;return this._interactable?this._pressed?e=jG.PRESSED:this._hovered&&(e=jG.HOVER):e=jG.DISABLED,e.toString()},Bc._updateColorTransition=function(e){var t=this[e+"Color"],i=null==(i=this.target)?void 0:i.getComponent(h4);i&&(e===jG.DISABLED?i.color=t:(this._fromColor=i.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))},Bc._updateSpriteTransition=function(e){e=this[e+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},Bc._updateScaleTransition=function(e){this._interactable&&(e===jG.PRESSED?this._zoomUp():this._zoomBack())},Bc._zoomUp=function(){this._originalScale&&(ce.copy(this._fromScale,this._originalScale),ce.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},Bc._zoomBack=function(){this.target&&this._originalScale&&(ce.copy(this._fromScale,this.target.getScale()),ce.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},Bc._applyTransition=function(e){var t=this._transition;t===VG.COLOR?this._updateColorTransition(e):t===VG.SPRITE?this._updateSpriteTransition(e):t===VG.SCALE&&this._updateScaleTransition(e)},e($G,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===VG.COLOR?this._updateColorTransition(jG.NORMAL):this._transition===VG.SPRITE&&this._updateSpriteTransition(jG.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){var t;this._normalSprite!==e&&(this._normalSprite=e,(t=this.node.getComponent(j3))&&(t.spriteFrame=e),this._updateState())}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),_l=n=$G,n.Transition=VG,n.EventType=WG,i((I=_l).prototype,"target",[E2,L6,ane],Object.getOwnPropertyDescriptor(I.prototype,"target"),I.prototype),i(I.prototype,"interactable",[a,s],Object.getOwnPropertyDescriptor(I.prototype,"interactable"),I.prototype),i(I.prototype,"transition",[XN,y,fie],Object.getOwnPropertyDescriptor(I.prototype,"transition"),I.prototype),i(I.prototype,"normalColor",[ba],Object.getOwnPropertyDescriptor(I.prototype,"normalColor"),I.prototype),i(I.prototype,"pressedColor",[aie],Object.getOwnPropertyDescriptor(I.prototype,"pressedColor"),I.prototype),i(I.prototype,"hoverColor",[Nw],Object.getOwnPropertyDescriptor(I.prototype,"hoverColor"),I.prototype),i(I.prototype,"disabledColor",[pi],Object.getOwnPropertyDescriptor(I.prototype,"disabledColor"),I.prototype),i(I.prototype,"duration",[hl,die,vie],Object.getOwnPropertyDescriptor(I.prototype,"duration"),I.prototype),i(I.prototype,"zoomScale",[Cp],Object.getOwnPropertyDescriptor(I.prototype,"zoomScale"),I.prototype),i(I.prototype,"normalSprite",[w,zp],Object.getOwnPropertyDescriptor(I.prototype,"normalSprite"),I.prototype),i(I.prototype,"pressedSprite",[Iie,Rie],Object.getOwnPropertyDescriptor(I.prototype,"pressedSprite"),I.prototype),i(I.prototype,"hoverSprite",[x,Pc],Object.getOwnPropertyDescriptor(I.prototype,"hoverSprite"),I.prototype),i(I.prototype,"disabledSprite",[r,vI],Object.getOwnPropertyDescriptor(I.prototype,"disabledSprite"),I.prototype),xG=i(I.prototype,"clickEvents",[ll,d,t,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SG=i(I.prototype,"_interactable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),bG=i(I.prototype,"_transition",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VG.NONE}}),TG=i(I.prototype,"_normalColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),EG=i(I.prototype,"_hoverColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(211,211,211,255)}}),CG=i(I.prototype,"_pressedColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),wG=i(I.prototype,"_disabledColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(124,124,124,255)}}),AG=i(I.prototype,"_normalSprite",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PG=i(I.prototype,"_hoverSprite",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IG=i(I.prototype,"_pressedSprite",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RG=i(I.prototype,"_disabledSprite",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DG=i(I.prototype,"_duration",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),OG=i(I.prototype,"_zoomScale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),MG=i(I.prototype,"_target",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tl=I))||tl)||tl)||tl)||tl)||tl)||tl,Rre({Button:Sa,ButtonComponent:Sa});var XG,YG,KG,QG,g=Sa,ZG=(JG.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},JG.remove=function(e){var t=this._tabIndexList,e=t.indexOf(e);-1!==e&&t.splice(e,1)},JG.resort=function(){this._tabIndexList.sort(function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex})},JG.next=function(e){var t=this._tabIndexList,i=t.indexOf(e);e.setFocus(!1),-1!==i&&(e=t[i+1])&&0<=e._delegate.tabIndex&&e.setFocus(!0)},JG);function JG(){}function $G(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=QG.call.apply(QG,[this].concat(i))||this,"clickEvents",xG,p(e)),_(e,"_interactable",SG,p(e)),_(e,"_transition",bG,p(e)),_(e,"_normalColor",TG,p(e)),_(e,"_hoverColor",EG,p(e)),_(e,"_pressedColor",CG,p(e)),_(e,"_disabledColor",wG,p(e)),_(e,"_normalSprite",AG,p(e)),_(e,"_hoverSprite",PG,p(e)),_(e,"_pressedSprite",IG,p(e)),_(e,"_disabledSprite",RG,p(e)),_(e,"_duration",DG,p(e)),_(e,"_zoomScale",OG,p(e)),_(e,"_target",MG,p(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new nr,e._toColor=new nr,e._time=0,e._transitionFinished=!0,e._fromScale=new ce,e._toScale=new ce,e._originalScale=null,e._sprite=null,e._targetScale=new ce,e}ZG._tabIndexList=[],(nl=XG=XG||{})[nl.DEFAULT=0]="DEFAULT",nl[nl.DONE=1]="DONE",nl[nl.SEND=2]="SEND",nl[nl.SEARCH=3]="SEARCH",nl[nl.GO=4]="GO",nl[nl.NEXT=5]="NEXT",Ot(XG),(R=YG=YG||{})[R.ANY=0]="ANY",R[R.EMAIL_ADDR=1]="EMAIL_ADDR",R[R.NUMERIC=2]="NUMERIC",R[R.PHONE_NUMBER=3]="PHONE_NUMBER",R[R.URL=4]="URL",R[R.DECIMAL=5]="DECIMAL",R[R.SINGLE_LINE=6]="SINGLE_LINE",Ot(YG),(rl=KG=KG||{})[rl.PASSWORD=0]="PASSWORD",rl[rl.SENSITIVE=1]="SENSITIVE",rl[rl.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",rl[rl.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",rl[rl.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",rl[rl.DEFAULT=5]="DEFAULT",Ot(KG);(ul=bH.prototype).init=function(){},ul.onEnable=function(){},ul.update=function(){},ul.onDisable=function(){this._editing&&this.endEditing()},ul.clear=function(){this._delegate=null},ul.setTabIndex=function(){},ul.setSize=function(){},ul.setFocus=function(e){e?this.beginEditing():this.endEditing()},ul.isFocused=function(){return this._editing},ul.beginEditing=function(){},ul.endEditing=function(){};var eH,tH,iH,nH,rH,oH,aH,sH,cH,lH,uH,hH,pH,_H,fH,Lc=bH,dH=new B,mH=new B,gH=new ce,vH=null,yH=0,xH=(l(SH,fH=Lc),(b=SH.prototype).init=function(e){e&&((this._delegate=e).inputMode===YG.ANY?this._createTextArea():this._createInput(),ZG.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},b.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),ZG.remove(this),vH===this&&(vH=null),this._delegate=null},b.update=function(){this._updateMatrix()},b.setTabIndex=function(e){this._edTxt.tabIndex=e,ZG.resort()},b.setSize=function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")},b.beginEditing=function(){vH&&vH!==this&&vH.setFocus(!1),this._editing=!0,(vH=this)._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},b.endEditing=function(){this._edTxt.blur()},b._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},b._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},b._addDomToGameContainer=function(){j.GAME_VIEW&&this._edTxt?(j.gameView.container.appendChild(this._edTxt),j.gameView.head.appendChild(this._placeholderStyleSheet)):YP.container&&this._edTxt&&(YP.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},b._removeDomFromGameContainer=function(){(j.GAME_VIEW?qt(j.gameView.container,this._edTxt):qt(YP.container,this._edTxt))&&this._edTxt&&(j.GAME_VIEW?j.gameView:YP).container.removeChild(this._edTxt),(j.GAME_VIEW?qt(j.gameView.head,this._placeholderStyleSheet):qt(document.head,this._placeholderStyleSheet))&&(j.GAME_VIEW?j.gameView:document).head.removeChild(this._placeholderStyleSheet),this._edTxt=null,this._placeholderStyleSheet=null},b._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),af.isMobile&&this._showDomOnMobile()},b._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),af.isMobile&&this._hideDomOnMobile()},b._showDomOnMobile=function(){af.os!==Wi.ANDROID&&af.os!==Wi.OHOS||(ef.handleResizeEvent=!1,this._adjustWindowScroll())},b._hideDomOnMobile=function(){af.os!==Wi.ANDROID&&af.os!==Wi.OHOS||(ef.handleResizeEvent=!0),this._scrollBackWindow()},b._adjustWindowScroll=function(){var e=this;setTimeout(function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},400)},b._scrollBackWindow=function(){setTimeout(function(){af.browserType!==Hi.WECHAT||af.os!==Wi.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)},400)},b._updateMatrix=function(){var e,t,i,n,r,o,a,s,c,l,u;this._edTxt&&(r=this._delegate.node,e=AI.getScaleX(),t=AI.getScaleY(),i=l=1,j.GAME_VIEW&&(l=j.gameView.canvas.width/j.game.canvas.width,i=j.gameView.canvas.height/j.game.canvas.height),e*=l,t*=i,i=AI.getViewportRect(),n=ef.devicePixelRatio,r.getWorldMatrix(dH),(o=r._uiProps.uiTransformComp)&&ce.set(gH,-o.anchorX*o.width,-o.anchorY*o.height,gH.z),B.transform(dH,dH,gH),r._uiProps.uiTransformComp&&(o=ZP.root.batcher2D.getFirstRenderCamera(r))&&(o.node.getWorldRT(mH),r=mH.m12,o=mH.m13,u=$P.center,mH.m12=u.x-(mH.m00*r+mH.m04*o),mH.m13=u.y-(mH.m01*r+mH.m05*o),B.multiply(mH,mH,dH),u=(j.GAME_VIEW?j.gameView:YP).container,r=mH.m00*(e/=n),o=dH.m01,a=dH.m04,s=mH.m05*(t/=n),c=parseInt(u&&u.style.paddingLeft||"0"),c+=i.x*l/n,l=parseInt(u&&u.style.paddingBottom||"0"),l+=i.y/n,u="matrix("+r+","+-o+","+-a+","+s+","+(mH.m12*e+c)+","+-(mH.m13*t+l)+")",this._edTxt.style.transform=u,this._edTxt.style["-webkit-transform"]=u,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"))},b._updateInputType=function(){var e=this._delegate,t=e.inputMode,i=e.inputFlag,e=e.returnType,n=this._edTxt;if(this._inputMode!==t||this._inputFlag!==i||this._returnType!==e){if(this._inputMode=t,this._inputFlag=i,this._returnType=e,this._isTextArea)return r="none",i===KG.INITIAL_CAPS_ALL_CHARACTERS?r="uppercase":i===KG.INITIAL_CAPS_WORD&&(r="capitalize"),void(n.style.textTransform=r);if(i===KG.PASSWORD)return n.type="password",void(n.style.textTransform="none");var r=n.type,t=(t===YG.EMAIL_ADDR?r="email":t===YG.NUMERIC||t===YG.DECIMAL?r="number":t===YG.PHONE_NUMBER?(r="number",n.pattern="[0-9]*",n.addEventListener("wheel",function(){return!1})):t===YG.URL?r="url":(r="text",e===XG.SEARCH&&(r="search")),n.type=r,"none");i===KG.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":i===KG.INITIAL_CAPS_WORD&&(t="capitalize"),n.style.textTransform=t}},b._updateMaxLength=function(){var e=this._delegate.maxLength;this._edTxt.maxLength=e=e<0?65535:e},b._initStyleSheet=function(){var e;this._edTxt&&((e=this._edTxt).style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):(e.type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style"))},b._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))},b._updateTextLabel=function(e){if(e){var t=!(t=e.font)||t instanceof PF?e.fontFamily:t._fontFamily,i=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==i||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=i,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var n=this._edTxt;switch(n.style.fontSize=i+"px",n.style.color=e.color.toCSS(),n.style.fontFamily=t,e.horizontalAlign){case g4.HorizontalAlign.LEFT:n.style.textAlign="left";break;case g4.HorizontalAlign.CENTER:n.style.textAlign="center";break;case g4.HorizontalAlign.RIGHT:n.style.textAlign="right"}}}},b._updatePlaceholderLabel=function(e){if(e){var t=!(t=e.font)||t instanceof PF?e.fontFamily:e.font._fontFamily,i=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==i||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=i,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var n=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case g4.HorizontalAlign.LEFT:a="left";break;case g4.HorizontalAlign.CENTER:a="center";break;case g4.HorizontalAlign.RIGHT:a="right"}n.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+i+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+i+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+i+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",af.browserType===Hi.EDGE&&(n.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},b._registerEventListeners=function(){var i,n,e,r=this;this._edTxt&&(i=this._edTxt,n=!1,(e=this.__eventListeners).compositionStart=function(){n=!0},e.compositionEnd=function(){n=!1,r._delegate._editBoxTextChanged(i.value)},e.onInput=function(){var e,t;n||(0<=(t=(e=r._delegate).maxLength)&&(i.value=i.value.slice(0,t)),e._editBoxTextChanged(i.value))},e.onClick=function(){r._editing&&af.isMobile&&r._adjustWindowScroll()},e.onKeydown=function(e){e.keyCode===sw.ENTER?(e.propagationStopped=!0,r._delegate._editBoxEditingReturn(),r._isTextArea||i.blur()):e.keyCode===sw.TAB&&(e.propagationStopped=!0,e.preventDefault(),ZG.next(r))},e.onBlur=function(){af.isMobile&&n&&e.compositionEnd(),r._editing=!1,vH=null,r._hideDom(),r._delegate._editBoxEditingDidEnded()},i.addEventListener("compositionstart",e.compositionStart),i.addEventListener("compositionend",e.compositionEnd),i.addEventListener("input",e.onInput),i.addEventListener("keydown",e.onKeydown),i.addEventListener("blur",e.onBlur),i.addEventListener("touchstart",e.onClick))},b._removeEventListeners=function(){var e,t;this._edTxt&&(e=this._edTxt,t=this.__eventListeners,e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null)},SH);function SH(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=fH.call.apply(fH,[this].concat(i))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++yH,e}function bH(){this._editing=!1,this._delegate=null}(uI=_H=_H||{}).EDITING_DID_BEGAN="editing-did-began",uI.EDITING_DID_ENDED="editing-did-ended",uI.TEXT_CHANGED="text-changed",uI.EDITING_RETURN="editing-return";Xp=f("cc.EditBox"),EW=wp(),cM=Oa(110),yI=Ep(),C7=gl(Cz),W3=m(),dU=u(),Ac=m(),Ce=u(),yU=v(g4),Nk=m(),c=u(),A=v(g4),h=m(),C=u(),kp=v(lF),Aw=m(),P=u(),Y3=v(KG),B1=m(),pF=u(),bne=v(YG),YD=m(),Hd=u(),Up=v(XG),Z5=m(),E=u(),kd=m(),Qp=u(),il=m(),Mne=u(),Op=v([mD]),Mp=m(),bp=u(),Bp=v([mD]),S=m(),kw=u(),Gd=v([mD]),Bc=m(),n=u(),_l=v([mD]),E2=m(),L6=u(),fie=Xp(y=EW(y=cM(y=yI(y=C7(y=Tp((l(qH,WH=W_),(ane=qH.prototype).__preload=function(){this._init()},ane.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},ane.update=function(){this._impl&&this._impl.update()},ane.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},ane.onDestroy=function(){this._impl&&this._impl.clear()},ane.setFocus=function(){this._impl&&this._impl.setFocus(!0)},ane.focus=function(){this._impl&&this._impl.setFocus(!0)},ane.blur=function(){this._impl&&this._impl.setFocus(!1)},ane.isFocused=function(){return!!this._impl&&this._impl.isFocused()},ane._editBoxEditingDidBegan=function(){mD.emitEvents(this.editingDidBegan,this),this.node.emit(_H.EDITING_DID_BEGAN,this)},ane._editBoxEditingDidEnded=function(){mD.emitEvents(this.editingDidEnded,this),this.node.emit(_H.EDITING_DID_ENDED,this)},ane._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,mD.emitEvents(this.textChanged,e,this),this.node.emit(_H.TEXT_CHANGED,this)},ane._editBoxEditingReturn=function(){mD.emitEvents(this.editingReturn,this),this.node.emit(_H.EDITING_RETURN,this)},ane._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},ane._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},ane._onTouchBegan=function(e){e.propagationStopped=!0},ane._onTouchCancel=function(e){e.propagationStopped=!0},ane._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},ane._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(T.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new qH._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},ane._ensureBackgroundSprite=function(){var e;this._background||(e=(e=this.node.getComponent(j3))||this.node.addComponent(j3))!==this._background&&(e.type=j3.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())},ane._updateTextLabel=function(){var e,t=this._textLabel;t||((e=this.node.getChildByName("TEXT_LABEL"))||((e=new N1("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(g4))||(t=e.addComponent(g4)),e.parent=this.node,this._textLabel=t),this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=g4.Overflow.CLAMP,this._inputMode===YG.ANY?(t.verticalAlign=s4.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},ane._updatePlaceholderLabel=function(){var e,t=this._placeholderLabel;t||((e=this.node.getChildByName("PLACEHOLDER_LABEL"))||((e=new N1("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(g4))||(t=e.addComponent(g4)),e.parent=this.node,this._placeholderLabel=t),this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=g4.Overflow.CLAMP,this._inputMode===YG.ANY?(t.verticalAlign=s4.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},ane._syncSize=function(){var e,t=this.node._uiProps.uiTransformComp,i=t.contentSize;this._background&&((e=this._background.node._uiProps.uiTransformComp).anchorPoint=t.anchorPoint,e.setContentSize(i)),this._updateLabelPosition(i),this._impl&&this._impl.setSize(i.width,i.height)},ane._updateLabels=function(){var e;this._isLabelVisible&&(e=this._string,this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e))},ane._updateString=function(e){var t=this._textLabel;t&&(e=(e=e)&&this._updateLabelStringStyle(e),t.string=e,this._updateLabels())},ane._updateLabelStringStyle=function(e,t){var i=this._inputFlag;if((t=void 0===t?!1:t)||i!==KG.PASSWORD)i===KG.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===KG.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):i===KG.INITIAL_CAPS_SENTENCE&&(e=(t=e).charAt(0).toUpperCase()+t.slice(1));else{for(var n="",r=e.length,o=0;o<r;++o)n+="";e=n}return e},ane._registerEvent=function(){this.node.on(T.TOUCH_START,this._onTouchBegan,this),this.node.on(T.TOUCH_END,this._onTouchEnded,this)},ane._unregisterEvent=function(){this.node.off(T.TOUCH_START,this._onTouchBegan,this),this.node.off(T.TOUCH_END,this._onTouchEnded,this)},ane._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},ane._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null!=e&&e.on(j3.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},ane._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null!=e&&e.off(j3.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},ane._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,i=-t.anchorX*t.width,t=-t.anchorY*t.height,n=this._placeholderLabel,r=this._textLabel;r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.node.setPosition(2+i,t+e.height,r.node.position.z),this._inputMode===YG.ANY&&(r.verticalAlign=s4.TOP),r.enableWrapText=this._inputMode===YG.ANY),n&&(n.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),n.lineHeight=e.height,n.node.setPosition(2+i,t+e.height,n.node.position.z),this._inputMode===YG.ANY&&(n.verticalAlign=s4.TOP),n.enableWrapText=this._inputMode===YG.ANY)},ane._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node,t=(t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize)),this._placeholderLabel&&this._placeholderLabel.node),t=(t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize)),this._background&&this._background.node);t&&t._uiProps.uiTransformComp.setContentSize(e.contentSize)},e(qH,[{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),s=a=qH,a._EditBoxImpl=Lc,a.KeyboardReturnType=XG,a.InputFlag=KG,a.InputMode=YG,a.EventType=_H,i((XN=s).prototype,"string",[W3,dU],Object.getOwnPropertyDescriptor(XN.prototype,"string"),XN.prototype),i(XN.prototype,"placeholder",[Ac,Ce],Object.getOwnPropertyDescriptor(XN.prototype,"placeholder"),XN.prototype),i(XN.prototype,"textLabel",[yU,Nk,c],Object.getOwnPropertyDescriptor(XN.prototype,"textLabel"),XN.prototype),i(XN.prototype,"placeholderLabel",[A,h,C],Object.getOwnPropertyDescriptor(XN.prototype,"placeholderLabel"),XN.prototype),i(XN.prototype,"backgroundImage",[kp,Aw,P],Object.getOwnPropertyDescriptor(XN.prototype,"backgroundImage"),XN.prototype),i(XN.prototype,"inputFlag",[Y3,B1,pF],Object.getOwnPropertyDescriptor(XN.prototype,"inputFlag"),XN.prototype),i(XN.prototype,"inputMode",[bne,YD,Hd],Object.getOwnPropertyDescriptor(XN.prototype,"inputMode"),XN.prototype),i(XN.prototype,"returnType",[Up,Z5,E],Object.getOwnPropertyDescriptor(XN.prototype,"returnType"),XN.prototype),i(XN.prototype,"maxLength",[kd,Qp],Object.getOwnPropertyDescriptor(XN.prototype,"maxLength"),XN.prototype),i(XN.prototype,"tabIndex",[il,Mne],Object.getOwnPropertyDescriptor(XN.prototype,"tabIndex"),XN.prototype),eH=i(XN.prototype,"editingDidBegan",[Op,d,Mp,bp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tH=i(XN.prototype,"textChanged",[Bp,d,S,kw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iH=i(XN.prototype,"editingDidEnded",[Gd,d,Bc,n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nH=i(XN.prototype,"editingReturn",[_l,d,E2,L6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rH=i(XN.prototype,"_textLabel",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oH=i(XN.prototype,"_placeholderLabel",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aH=i(XN.prototype,"_returnType",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XG.DEFAULT}}),sH=i(XN.prototype,"_string",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cH=i(XN.prototype,"_tabIndex",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lH=i(XN.prototype,"_backgroundImage",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uH=i(XN.prototype,"_inputFlag",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KG.DEFAULT}}),hH=i(XN.prototype,"_inputMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YG.ANY}}),pH=i(XN.prototype,"_maxLength",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),y=XN))||y)||y)||y)||y)||y)||y,Rre({EditBox:fie,EditBoxComponent:fie});var TH,EH,CH,wH,AH,PH,IH,RH,DH,OH,MH,NH,LH,BH,FH,zH,UH,kH,GH,HH,VH,jH,WH,ba=fie;function qH(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=WH.call.apply(WH,[this].concat(i))||this,"editingDidBegan",eH,p(e)),_(e,"textChanged",tH,p(e)),_(e,"editingDidEnded",iH,p(e)),_(e,"editingReturn",nH,p(e)),e._impl=null,e._background=null,_(e,"_textLabel",rH,p(e)),_(e,"_placeholderLabel",oH,p(e)),_(e,"_returnType",aH,p(e)),_(e,"_string",sH,p(e)),_(e,"_tabIndex",cH,p(e)),_(e,"_backgroundImage",lH,p(e)),_(e,"_inputFlag",uH,p(e)),_(e,"_inputMode",hH,p(e)),_(e,"_maxLength",pH,p(e)),e._isLabelVisible=!1,e}"object"==typeof window&&"object"==typeof document&&(ba._EditBoxImpl=xH),j.internal.EditBox=ba,(aie=UH=UH||{})[aie.NONE=0]="NONE",aie[aie.HORIZONTAL=1]="HORIZONTAL",aie[aie.VERTICAL=2]="VERTICAL",aie[aie.GRID=3]="GRID",Lt(UH),(Nw=kH=kH||{})[Nw.NONE=0]="NONE",Nw[Nw.CONTAINER=1]="CONTAINER",Nw[Nw.CHILDREN=2]="CHILDREN",Lt(kH),(pi=GH=GH||{})[pi.HORIZONTAL=0]="HORIZONTAL",pi[pi.VERTICAL=1]="VERTICAL",Lt(GH),(hl=HH=HH||{})[hl.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",hl[hl.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM",Lt(HH),(die=VH=VH||{})[die.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",die[die.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT",Lt(VH),(vie=jH=jH||{})[vie.NONE=0]="NONE",vie[vie.FIXED_ROW=1]="FIXED_ROW",vie[vie.FIXED_COL=2]="FIXED_COL",Lt(jH);var XH,YH,KH,QH,ZH,JH,$H,eV=new ce,tV=(Cp=f("cc.Layout"),w=wp(),zp=Oa(110),Iie=Ep(),Rie=gl(Cz),x=Pp(),Pc=u(),r=Pp(),vI=u(),ll=v(UH),t=u(),o=v(kH),I=Pp(),tl=u(),Sa=Pp(),nl=u(),R=v(GH),rl=u(),ul=u(),b=u(),uI=u(),Xp=u(),EW=u(),cM=u(),yI=v(HH),C7=u(),ane=v(VH),Lc=u(),a=v(jH),s=Pp(),W3=u(),dU=Pp(),Ac=u(),Ce=u(),C=Cp(h=w(h=zp(h=Iie(h=Rie(h=Tp((l(iV,$H=W_),(yU=iV.prototype).updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)},yU.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(Hr.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},yU.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},yU._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}},yU._addEventListeners=function(){ZP.on(KP.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(T.SIZE_CHANGED,this._resized,this),this.node.on(T.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(T.CHILD_ADDED,this._childAdded,this),this.node.on(T.CHILD_REMOVED,this._childRemoved,this),this.node.on(T.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},yU._removeEventListeners=function(){ZP.off(KP.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(T.SIZE_CHANGED,this._resized,this),this.node.off(T.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(T.CHILD_ADDED,this._childAdded,this),this.node.off(T.CHILD_REMOVED,this._childRemoved,this),this.node.off(T.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},yU._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t];i.on(T.SIZE_CHANGED,this._doLayoutDirty,this),i.on(T.TRANSFORM_CHANGED,this._transformDirty,this),i.on(T.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on(T.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},yU._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t];i.off(T.SIZE_CHANGED,this._doLayoutDirty,this),i.off(T.TRANSFORM_CHANGED,this._transformDirty,this),i.off(T.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off(T.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},yU._childAdded=function(e){e.on(T.SIZE_CHANGED,this._doLayoutDirty,this),e.on(T.TRANSFORM_CHANGED,this._transformDirty,this),e.on(T.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(T.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},yU._childRemoved=function(e){e.off(T.SIZE_CHANGED,this._doLayoutDirty,this),e.off(T.TRANSFORM_CHANGED,this._transformDirty,this),e.off(T.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(T.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},yU._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},yU._doLayoutHorizontally=function(e,t,i,n){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft,c=(this._horizontalDirection===VH.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight),(this._horizontalDirection-r.x)*e+a*s),l=c-a*this._spacingX,u=0,h=0,p=0,_=0,f=!1,s=this._usefulLayoutObj.length,d=this._cellSize.width,m=this._getPaddingH();this._layoutType!==UH.GRID&&this._resizeMode===kH.CHILDREN&&(d=(e-m-(s-1)*this._spacingX)/s);for(var g=this._usefulLayoutObj,v=0;v<g.length;++v){var y,x=g[v],S=x.node,b=S.scale,T=this._getUsedScaleValue(b.x),b=this._getUsedScaleValue(b.y),E=(this._resizeMode===kH.CHILDREN&&(x.width=d/T,this._layoutType===UH.GRID&&(x.height=this._cellSize.height/b)),Math.abs(this._horizontalDirection-x.anchorX)),T=x.width*T,b=x.height*b,C=(p<b&&(_=Math.max(p,_),h=p||b,p=b),l+=a*(E*T+this._spacingX),a*(1-E)*T),w=(t&&(0<o?(f=0<v/o&&v%o==0)&&(h=b<p?p:h):e-m<T?c+a*E*T<l&&(f=!0):(y=(1-this._horizontalDirection-r.x)*e,w=l+C+a*(0<a?this._paddingRight:this._paddingLeft),f=Math.abs(w)>Math.abs(y)),f&&(l=c+a*E*T,u+=(h=b!==p?p:h)+this._spacingY,h=p=b)),i(S,x,u));n&&S.setPosition(l,w),l+=C}return h=Math.max(h,p),Math.max(_,u+h)+this._getPaddingV()},yU._doLayoutVertically=function(e,t,i,n){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom,c=(this._verticalDirection===HH.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop),(this._verticalDirection-r.y)*e+a*s),l=c-a*this._spacingY,u=0,h=0,p=0,_=0,f=!1,s=this._usefulLayoutObj.length,d=this._cellSize.height,m=this._getPaddingV();this._layoutType!==UH.GRID&&this._resizeMode===kH.CHILDREN&&(d=(e-m-(s-1)*this._spacingY)/s);for(var g=this._usefulLayoutObj,v=0;v<g.length;++v){var y,x=g[v],S=x.node,b=S.scale,T=this._getUsedScaleValue(b.x),b=this._getUsedScaleValue(b.y),E=(this._resizeMode===kH.CHILDREN&&(x.height=d/b,this._layoutType===UH.GRID&&(x.width=this._cellSize.width/T)),Math.abs(this._verticalDirection-x.anchorY)),T=x.width*T,b=x.height*b,C=(u<T&&(h=Math.max(u,h),p=u||T,u=T),l+=a*(E*b+this._spacingY),a*(1-E)*b),w=(t&&(0<o?(f=0<v/o&&v%o==0)&&(p=b<u?u:p):e-m<b?c+a*E*b<l&&(f=!0):(y=(1-this._verticalDirection-r.y)*e,w=l+C+a*(0<a?this._paddingTop:this._paddingBottom),f=Math.abs(w)>Math.abs(y)),f&&(l=c+a*E*b,_+=(p=T!==u?u:p)+this._spacingX,p=u=T)),i(S,x,_));n&&(S.getPosition(eV),S.setPosition(w,l,eV.z)),l+=C}return p=Math.max(p,u),Math.max(h,_+p)+this._getPaddingH()},yU._doLayoutGridAxisHorizontal=function(e,t){function i(e,t,i){return a+o*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+s)}var n=this,r=t.width,o=1,a=-e.y*t.height,s=this._paddingBottom,t=(this._verticalDirection===HH.TOP_TO_BOTTOM&&(o=-1,a=(1-e.y)*t.height,s=this._paddingTop),0);this._resizeMode===kH.CONTAINER&&(t=this._doLayoutHorizontally(r,!0,i,!1),a=-e.y*t,this._verticalDirection===HH.TOP_TO_BOTTOM&&(o=-1,a=(1-e.y)*t)),this._doLayoutHorizontally(r,!0,i,!0),this._resizeMode===kH.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(r,t)},yU._doLayoutGridAxisVertical=function(e,t){function i(e,t,i){return a+o*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+s)}var n=this,r=t.height,o=1,a=-e.x*t.width,s=this._paddingLeft,t=(this._horizontalDirection===VH.RIGHT_TO_LEFT&&(o=-1,a=(1-e.x)*t.width,s=this._paddingRight),0);this._resizeMode===kH.CONTAINER&&(t=this._doLayoutVertically(r,!0,i,!1),a=-e.x*t,this._horizontalDirection===VH.RIGHT_TO_LEFT&&(o=-1,a=(1-e.x)*t)),this._doLayoutVertically(r,!0,i,!0),this._resizeMode===kH.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(t,r)},yU._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,e=e.contentSize;this.startAxis===GH.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,e):this.startAxis===GH.VERTICAL&&this._doLayoutGridAxisVertical(t,e)},yU._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,i=e.length;if(this._resizeMode===kH.CONTAINER){for(var n=0;n<e.length;++n){var r=e[n],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(i-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},yU._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,i=e.length;if(this._resizeMode===kH.CONTAINER){for(var n=0;n<e.length;++n){var r=e[n],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(i-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},yU._doLayout=function(){var e,t=this;this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===UH.HORIZONTAL?(e=this._getHorizontalBaseWidth(),this._doLayoutHorizontally(e,!1,function(e){return(t._isAlign?ce.ZERO:e.position).y},!0),this.node._uiProps.uiTransformComp.width=e):this._layoutType===UH.VERTICAL?(e=this._getVerticalBaseHeight(),this._doLayoutVertically(e,!1,function(e){return(t._isAlign?ce.ZERO:e.position).x},!0),this.node._uiProps.uiTransformComp.height=e):this._layoutType===UH.GRID&&this._doLayoutGrid()},yU._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},yU._transformDirty=function(e){e&Q0.SCALE&&e&Q0.POSITION&&this._affectedByScale&&this._doLayoutDirty()},yU._doLayoutDirty=function(){this._layoutDirty=!0},yU._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},yU._getPaddingH=function(){return this._paddingLeft+this._paddingRight},yU._getPaddingV=function(){return this._paddingTop+this._paddingBottom},yU._getFixedBreakingNum=function(){if(this._layoutType!==UH.GRID||this._constraint===jH.NONE||this._constraintNum<=0)return 0;var e=this._constraint===jH.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return e=this._startAxis===GH.VERTICAL?this._constraint===jH.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum:e},e(iV,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===UH.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===UH.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==UH.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==UH.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==jH.NONE&&this._constraintNum!==e&&(e<=0&&V("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),c=Nk=iV,Nk.Type=UH,Nk.VerticalDirection=HH,Nk.HorizontalDirection=VH,Nk.ResizeMode=kH,Nk.AxisDirection=GH,Nk.Constraint=jH,i((A=c).prototype,"alignHorizontal",[x,Pc],Object.getOwnPropertyDescriptor(A.prototype,"alignHorizontal"),A.prototype),i(A.prototype,"alignVertical",[r,vI],Object.getOwnPropertyDescriptor(A.prototype,"alignVertical"),A.prototype),i(A.prototype,"type",[ll,t],Object.getOwnPropertyDescriptor(A.prototype,"type"),A.prototype),i(A.prototype,"resizeMode",[o,I,tl],Object.getOwnPropertyDescriptor(A.prototype,"resizeMode"),A.prototype),i(A.prototype,"cellSize",[Sa,nl],Object.getOwnPropertyDescriptor(A.prototype,"cellSize"),A.prototype),i(A.prototype,"startAxis",[R,rl],Object.getOwnPropertyDescriptor(A.prototype,"startAxis"),A.prototype),i(A.prototype,"paddingLeft",[ul],Object.getOwnPropertyDescriptor(A.prototype,"paddingLeft"),A.prototype),i(A.prototype,"paddingRight",[b],Object.getOwnPropertyDescriptor(A.prototype,"paddingRight"),A.prototype),i(A.prototype,"paddingTop",[uI],Object.getOwnPropertyDescriptor(A.prototype,"paddingTop"),A.prototype),i(A.prototype,"paddingBottom",[Xp],Object.getOwnPropertyDescriptor(A.prototype,"paddingBottom"),A.prototype),i(A.prototype,"spacingX",[EW],Object.getOwnPropertyDescriptor(A.prototype,"spacingX"),A.prototype),i(A.prototype,"spacingY",[cM],Object.getOwnPropertyDescriptor(A.prototype,"spacingY"),A.prototype),i(A.prototype,"verticalDirection",[yI,C7],Object.getOwnPropertyDescriptor(A.prototype,"verticalDirection"),A.prototype),i(A.prototype,"horizontalDirection",[ane,Lc],Object.getOwnPropertyDescriptor(A.prototype,"horizontalDirection"),A.prototype),i(A.prototype,"constraint",[a,s,W3],Object.getOwnPropertyDescriptor(A.prototype,"constraint"),A.prototype),i(A.prototype,"constraintNum",[dU,Ac],Object.getOwnPropertyDescriptor(A.prototype,"constraintNum"),A.prototype),i(A.prototype,"affectedByScale",[Ce],Object.getOwnPropertyDescriptor(A.prototype,"affectedByScale"),A.prototype),TH=i(A.prototype,"_resizeMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kH.NONE}}),EH=i(A.prototype,"_layoutType",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UH.NONE}}),CH=i(A.prototype,"_cellSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(40,40)}}),wH=i(A.prototype,"_startAxis",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GH.HORIZONTAL}}),AH=i(A.prototype,"_paddingLeft",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PH=i(A.prototype,"_paddingRight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IH=i(A.prototype,"_paddingTop",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RH=i(A.prototype,"_paddingBottom",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DH=i(A.prototype,"_spacingX",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OH=i(A.prototype,"_spacingY",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MH=i(A.prototype,"_verticalDirection",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HH.TOP_TO_BOTTOM}}),NH=i(A.prototype,"_horizontalDirection",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VH.LEFT_TO_RIGHT}}),LH=i(A.prototype,"_constraint",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jH.NONE}}),BH=i(A.prototype,"_constraintNum",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),FH=i(A.prototype,"_affectedByScale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zH=i(A.prototype,"_isAlign",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h=A))||h)||h)||h)||h)||h)||h,Rre({Layout:C,LayoutComponent:C}),C);function iV(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=$H.call.apply($H,[this].concat(i))||this,"_resizeMode",TH,p(e)),_(e,"_layoutType",EH,p(e)),_(e,"_cellSize",CH,p(e)),_(e,"_startAxis",wH,p(e)),_(e,"_paddingLeft",AH,p(e)),_(e,"_paddingRight",PH,p(e)),_(e,"_paddingTop",IH,p(e)),_(e,"_paddingBottom",RH,p(e)),_(e,"_spacingX",DH,p(e)),_(e,"_spacingY",OH,p(e)),_(e,"_verticalDirection",MH,p(e)),_(e,"_horizontalDirection",NH,p(e)),_(e,"_constraint",LH,p(e)),_(e,"_constraintNum",BH,p(e)),_(e,"_affectedByScale",FH,p(e)),_(e,"_isAlign",zH,p(e)),e._layoutSize=new Hr(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}(kp=JH=JH||{})[kp.HORIZONTAL=0]="HORIZONTAL",kp[kp.VERTICAL=1]="VERTICAL",kp[kp.FILLED=2]="FILLED",Ot(JH);Aw=f("cc.ProgressBar"),P=wp(),Y3=Oa(110),B1=Ep(),pF=gl(Cz),bne=v(j3),YD=u(),Hd=v(JH),Up=u(),Z5=u(),E=Dp(),kd=u(),Qp=u(),Mp=Aw(Op=P(Op=Y3(Op=B1(Op=pF((l(mV,lV=W_),(il=mV.prototype)._initBarSprite=function(){var e,t,i,n;this._barSprite&&(e=this._barSprite.node)&&(t=(i=this.node._uiProps.uiTransformComp).contentSize,i=i.anchorPoint,n=e._uiProps.uiTransformComp.contentSize,this._barSprite.fillType===j3.FillType.RADIAL&&(this._mode=JH.FILLED),this._mode===JH.HORIZONTAL?this.totalLength=n.width:this._mode===JH.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node&&(n=-t.width*i.x,e.setPosition(n,0,0)))},il._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(e){var t=e._uiProps.uiTransformComp,i=t.anchorPoint,n=t.contentSize,r=e.getPosition(),o=new U(0,.5),a=zn(this._progress),s=this._totalLength*a,c=n,l=0,u=0;switch(this._mode){case JH.HORIZONTAL:this._reverse&&(o=new U(1,.5)),c=new Hr(s,n.height),l=this._totalLength,u=n.height;break;case JH.VERTICAL:o=this._reverse?new U(.5,1):new U(.5,0),c=new Hr(n.width,s),l=n.width,u=this._totalLength}this._mode===JH.FILLED?this._barSprite.type!==j3.Type.FILLED?V("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s):this._barSprite.type!==j3.Type.FILLED?(a=o.x-i.x,i=o.y-i.y,a=new ce(l*a,u*i,0),e.setPosition(r.x+a.x,r.y+a.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)):V("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},e(mV,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode!==e&&(this._mode=e,this._barSprite)&&(e=this._barSprite.node)&&(e=e._uiProps.uiTransformComp.contentSize,this._mode===JH.HORIZONTAL?this.totalLength=e.width:this._mode===JH.VERTICAL?this.totalLength=e.height:this._mode===JH.FILLED&&(this.totalLength=this._barSprite.fillRange))}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===JH.FILLED&&(e=zn(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),mV.Mode=JH,i((Mne=mV).prototype,"barSprite",[bne,YD],Object.getOwnPropertyDescriptor(Mne.prototype,"barSprite"),Mne.prototype),i(Mne.prototype,"mode",[Hd,Up],Object.getOwnPropertyDescriptor(Mne.prototype,"mode"),Mne.prototype),i(Mne.prototype,"totalLength",[Z5],Object.getOwnPropertyDescriptor(Mne.prototype,"totalLength"),Mne.prototype),i(Mne.prototype,"progress",[E,Np,kd],Object.getOwnPropertyDescriptor(Mne.prototype,"progress"),Mne.prototype),i(Mne.prototype,"reverse",[Qp],Object.getOwnPropertyDescriptor(Mne.prototype,"reverse"),Mne.prototype),XH=i(Mne.prototype,"_barSprite",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YH=i(Mne.prototype,"_mode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JH.HORIZONTAL}}),KH=i(Mne.prototype,"_totalLength",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QH=i(Mne.prototype,"_progress",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),ZH=i(Mne.prototype,"_reverse",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Op=Mne))||Op)||Op)||Op)||Op)||Op,Rre({ProgressBar:Mp,ProgressBarComponent:Mp});var nV,rV,oV,aV,sV,cV,lV,bp=Mp,uV=new ce,hV=new ce,pV=new ce,_V=new U,fV=new nr,dV=new U;function mV(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=lV.call.apply(lV,[this].concat(i))||this,"_barSprite",XH,p(e)),_(e,"_mode",YH,p(e)),_(e,"_totalLength",KH,p(e)),_(e,"_progress",QH,p(e)),_(e,"_reverse",ZH,p(e)),e}(Bp=cV=cV||{})[Bp.HORIZONTAL=0]="HORIZONTAL",Bp[Bp.VERTICAL=1]="VERTICAL",Lt(cV);S=f("cc.ScrollBar"),kw=wp(),Gd=Oa(110),Bc=Ep(),n=gl(Cz),_l=v(j3),E2=m(),L6=u(),XN=v(cV),y=m(),fie=u(),xH=m(),aie=u(),Nw=m(),pi=u(),Cp=S(vie=kw(vie=Gd(vie=Bc(vie=n((l(OV,IV=W_),(hl=OV.prototype).hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},hl.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},hl.onScroll=function(e){var t,i,n,r,o,a,s,c,l,u;this._scrollView&&(t=this._scrollView.content)&&(l=t._uiProps.uiTransformComp.contentSize,u=this._scrollView.node._uiProps.uiTransformComp.contentSize,i=this.node._uiProps.uiTransformComp.contentSize,this._conditionalDisableScrollBar(l,u)||(this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)),(c=dV).set(s=a=o=r=n=0,0),this._direction===cV.HORIZONTAL?(n=l.width,r=u.width,s=i.width,o=e.x,this._convertToScrollViewSpace(c,t),a=-c.x):this._direction===cV.VERTICAL&&(n=l.height,r=u.height,s=i.height,o=e.y,this._convertToScrollViewSpace(c,t),a=-c.y),l=this._calculateLength(n,r,s,o),this._calculatePosition(u=dV,n,r,s,a,o,l),this._updateLength(l),this._updateHandlerPosition(u)))},hl.setScrollView=function(e){this._scrollView=e},hl.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},hl.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var e=e._uiProps.uiTransformComp.contentSize,t=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,t))return}}this._autoHideRemainingTime=this._autoHideTime}},hl.onEnable=function(){var e=this.node.getComponent(j3);e&&(this._opacity=e.color.a)},hl.start=function(){this._enableAutoHide&&this._setOpacity(0)},hl.update=function(e){this._processAutoHide(e)},hl._convertToScrollViewSpace=function(e,t){var i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,t=t._uiProps.uiTransformComp;i&&t?(uV.set(-t.anchorX*t.width,-t.anchorY*t.height,0),t.convertToWorldSpaceAR(uV,hV),(t=i.convertToNodeSpaceAR(hV)).x+=i.anchorX*i.width,t.y+=i.anchorY*i.height,e.set(t.x,t.y)):e.set(U.ZERO)},hl._setOpacity=function(e){var t;this._handle&&((t=this.node.getComponent(j3))&&(fV.set(t.color),fV.a=e,t.color=fV),(t=this._handle.getComponent(j3))&&(fV.set(t.color),fV.a=e,t.color=fV))},hl._updateHandlerPosition=function(e){var t;this._handle&&(this._fixupHandlerPosition(t=pV),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z))},hl._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,i=t.contentSize,t=t.anchorPoint,n=this.handle.node._uiProps.uiTransformComp.contentSize,r=this.handle.node.parent,t=(ce.set(uV,-i.width*t.x,-i.height*t.y,0),this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(uV,hV));e.set(0,0,0),r._uiProps.uiTransformComp.convertToNodeSpaceAR(t,e),this.direction===cV.HORIZONTAL?e.set(e.x,e.y+(i.height-n.height)/2,e.z):this.direction===cV.VERTICAL&&e.set(e.x+(i.width-n.width)/2,e.y,e.z),this.handle.node.setPosition(e)},hl._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===cV.HORIZONTAL||e.height<=t.height&&this._direction===cV.VERTICAL},hl._calculateLength=function(e,t,i,n){return n&&(e+=20*(0<n?n:-n)),i*(t/e)},hl._calculatePosition=function(e,t,i,n,r,o,a){t-=i,o&&(t+=Math.abs(o)),i=0,o=(n-a)*(i=t?zn(i=r/t):i);this._direction===cV.VERTICAL?e.set(0,o):e.set(o,0)},hl._updateLength=function(e){var t,i,n;this._handle&&(i=(t=this._handle.node._uiProps.uiTransformComp).contentSize,(n=t.anchorPoint).x===_V.x&&n.y===_V.y||t.setAnchorPoint(_V),this._direction===cV.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e))},hl._processAutoHide=function(e){this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)&&(this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime),e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime),this._setOpacity(e))},e(OV,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(U.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(U.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),OV.Direction=cV,i((die=OV).prototype,"handle",[_l,E2,L6],Object.getOwnPropertyDescriptor(die.prototype,"handle"),die.prototype),i(die.prototype,"direction",[XN,y,fie],Object.getOwnPropertyDescriptor(die.prototype,"direction"),die.prototype),i(die.prototype,"enableAutoHide",[xH,aie],Object.getOwnPropertyDescriptor(die.prototype,"enableAutoHide"),die.prototype),i(die.prototype,"autoHideTime",[Nw,pi],Object.getOwnPropertyDescriptor(die.prototype,"autoHideTime"),die.prototype),nV=i(die.prototype,"_scrollView",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rV=i(die.prototype,"_handle",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oV=i(die.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cV.HORIZONTAL}}),aV=i(die.prototype,"_enableAutoHide",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sV=i(die.prototype,"_autoHideTime",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),vie=die))||vie)||vie)||vie)||vie)||vie,Rre({ScrollBar:Cp,ScrollBarComponent:Cp});var gV,vV,yV,xV,SV,bV,TV,EV,CV,wV,AV,PV,IV,w=Cp,RV=Rre("ViewGroup",f("cc.ViewGroup")(zp=Oa(110)((l(DV,PV=W_),zp=DV))||zp)||zp);function DV(){return PV.apply(this,arguments)||this}function OV(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=IV.call.apply(IV,[this].concat(i))||this,"_scrollView",nV,p(e)),_(e,"_handle",rV,p(e)),_(e,"_direction",oV,p(e)),_(e,"_enableAutoHide",aV,p(e)),_(e,"_autoHideTime",sV,p(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}j.ViewGroup=RV;function MV(){return(new Date).getMilliseconds()}var NV,LV=1e-4,BV=new ce,FV=new ce,zV=new U,UV=new U,kV={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};(Iie=NV=NV||{}).SCROLL_TO_TOP="scroll-to-top",Iie.SCROLL_TO_BOTTOM="scroll-to-bottom",Iie.SCROLL_TO_LEFT="scroll-to-left",Iie.SCROLL_TO_RIGHT="scroll-to-right",Iie.SCROLL_BEGAN="scroll-began",Iie.SCROLL_ENDED="scroll-ended",Iie.BOUNCE_TOP="bounce-top",Iie.BOUNCE_BOTTOM="bounce-bottom",Iie.BOUNCE_LEFT="bounce-left",Iie.BOUNCE_RIGHT="bounce-right",Iie.SCROLLING="scrolling",Iie.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",Iie.TOUCH_UP="touch-up";Rie=f("cc.ScrollView"),yU=wp(),Nk=Oa(110),c=Ep(),x=gl(Cz),Pc=Dp(),r=m(),vI=u(),ll=Dp(),t=m(),o=u(),I=m(),tl=u(),Sa=m(),nl=u(),R=v(N1),rl=m(),ul=u(),b=m(),uI=u(),Xp=v(w),EW=m(),cM=u(),yI=m(),C7=u(),ane=v(w),Lc=m(),a=u(),s=m(),W3=u(),dU=v([mD]),Ac=m(),Ce=u(),kp=Rie(C=yU(C=Nk(C=c(C=x((l(YV,qV=RV),(A=YV.prototype).scrollToBottom=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)},A.scrollToTop=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToLeft=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToRight=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var i=this._calculateMovePercentDelta({anchor:new U(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)},A.scrollToOffset=function(e,t,i){void 0===i&&(i=!0);var n=this.getMaxScrollOffset(),r=new U(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)},A.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new U(t,e)},A.getMaxScrollOffset=function(){if(!this._content||!this.view)return U.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,e=e.height-this.view.height;return new U(t=0<=t?t:0,e=0<=e?e:0)},A.scrollToPercentHorizontal=function(e,t,i){e=this._calculateMovePercentDelta({anchor:new U(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(e,t,!1!==i):this._moveContent(e)},A.scrollTo=function(e,t,i){e=this._calculateMovePercentDelta({anchor:new U(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(e,t,i):this._moveContent(e)},A.scrollToPercentVertical=function(e,t,i){e=this._calculateMovePercentDelta({anchor:new U(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(e,t,i):this._moveContent(e)},A.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},A.setContentPosition=function(e){this._setContentPosition(e)},A._setContentPosition=function(e){var t;this._content&&(t=this._getContentPosition(),Math.abs(e.x-t.x)<LV&&Math.abs(e.y-t.y)<LV||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0))},A.getContentPosition=function(){return this._getContentPosition()},A._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):ce.ZERO.clone()},A.isScrolling=function(){return this._scrolling},A.isAutoScrolling=function(){return this._autoScrolling},A.getScrollEndedEventTiming=function(){return LV},A.start=function(){this._calculateBoundary(),this._content&&ZP.once(KP.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},A.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(T.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(T.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(T.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(T.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},A.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},A.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(T.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(T.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(T.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(T.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},A._registerEvent=function(){this.node.on(T.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(T.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(T.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(T.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(T.MOUSE_WHEEL,this._onMouseWheel,this,!0)},A._unregisterEvent=function(){this.node.off(T.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(T.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(T.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(T.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(T.MOUSE_WHEEL,this._onMouseWheel,this,!0)},A._onMouseWheel=function(e,t){var i;this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)&&(t=new ce,i=e.getScrollY(),this.vertical?t.set(0,-.1*i,0):this.horizontal&&t.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(t),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e))},A._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},A._onTouchMoved=function(e,t){var i;this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)&&(t=e.touch,this._handleMoveLogic(t),this.cancelInnerEvents&&((i=t.getUILocation(zV)).subtract(t.getUIStartLocation(UV)),7<i.length()&&!this._touchMoved&&e.target!==this.node&&((t=new ow(e.getTouches(),e.bubbles,gE.TOUCH_CANCEL)).touch=e.touch,t.simulate=!0,e.target.dispatchEvent(t),this._touchMoved=!0),this._stopPropagationIfTargetIsMe(e)))},A._onTouchEnded=function(e,t){this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)&&(this._dispatchEvent(NV.TOUCH_UP),t=e.touch,this._handleReleaseLogic(t),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e))},A._onTouchCancelled=function(e,t){this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)&&(e&&!e.simulate&&(t=e.touch,this._handleReleaseLogic(t)),this._stopPropagationIfTargetIsMe(e))},A._calculateBoundary=function(){var e,t,i;this._content&&this.view&&((e=this._content.getComponent(tV))&&e.enabledInHierarchy&&e.updateLayout(),t=(e=this.view).width*e.anchorX,i=e.height*e.anchorY,this._leftBoundary=-t,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize))},A._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==qC.CAPTURING_PHASE)return!1;if(t)for(var i=ge(t);!(n=i()).done;){var n=n.value;if(this.node===n)return!(!e.target||!e.target.getComponent(RV));if(n.getComponent(RV))return!0}return!1},A._startInertiaScroll=function(e){var t=new ce(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},A._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},A._startAttenuatingAutoScroll=function(e,t){var i,n=e.clone(),r=(n.normalize(),this._content&&this.view&&(i=this._content._uiProps.uiTransformComp.contentSize,o=this.view.contentSize,r=i.width-o.width,i=i.height-o.height,o=this._calculateAttenuatedFactor(r),a=this._calculateAttenuatedFactor(i),n.x=n.x*r*(1-this.brake)*o,n.y=n.y*i*a*(1-this.brake),n.z=0),e.length()),o=n.length()/r,a=(n.add(e),0<this.brake&&7<o&&(o=Math.sqrt(o),(i=e.clone()).multiplyScalar(o),n.set(i),n.add(e)),this._calculateAutoScrollTimeByInitialSpeed(t.length()));0<this.brake&&3<o&&(a*=o=3),0===this.brake&&1<o&&(a*=o),this._startAutoScroll(n,a,!0)},A._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},A._startAutoScroll=function(e,t,i){void 0===i&&(i=!1);e=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=e,this._autoScrollAttenuate=i,ce.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(ce.ZERO,LV)||(this._autoScrollCurrentlyOutOfBoundary=!0)},A._calculateTouchMoveVelocity=function(){var e,t,i=new ce;return(e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},0))<=0||.5<=e?i.set(ce.ZERO):(t=new ce,t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t),e},t),i.set(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,t.z)),i},A._flattenVectorByDirection=function(e){return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},A._moveContent=function(e,t){e=this._flattenVectorByDirection(e),BV.set(this._getContentPosition()),BV.add(e),BV.set(Math.round(1e4*BV.x)*LV,Math.round(1e4*BV.y)*LV,BV.z),this._setContentPosition(BV),e=this._getHowMuchOutOfBoundary();zV.set(e.x,e.y),this._updateScrollBar(zV),this.elastic&&t&&this._startBounceBackIfNeeded()},A._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},A._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},A._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},A._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},A._getHowMuchOutOfBoundary=function(e){if((e=e||new ce).equals(ce.ZERO,LV)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new ce,i=this._getContentLeftBoundary(),n=this._getContentRightBoundary(),i=(i+e.x>this._leftBoundary?t.x=this._leftBoundary-(i+e.x):n+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(n+e.x)),this._getContentTopBoundary()),n=this._getContentBottomBoundary();return i+e.y<this._topBoundary?t.y=this._topBoundary-(i+e.y):n+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(n+e.y)),e.equals(ce.ZERO,LV)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},A._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},A._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},A._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},A._dispatchEvent=function(e){if(e===NV.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===NV.SCROLL_TO_TOP||e===NV.SCROLL_TO_BOTTOM||e===NV.SCROLL_TO_LEFT||e===NV.SCROLL_TO_RIGHT){var t=1<<kV[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}mD.emitEvents(this.scrollEvents,this,kV[e]),this.node.emit(e,this)},A._adjustContentOutOfBoundary=function(){var e;this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())&&(e=this._getHowMuchOutOfBoundary(),BV.set(this._getContentPosition()),BV.add(e),this._content.setPosition(BV),this._updateScrollBar(U.ZERO))},A._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},A._updateScrollBarState=function(){var e,t;this._content&&this.view&&(e=this.view,t=this._content._uiProps.uiTransformComp,this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show()))},A._stopPropagationIfTargetIsMe=function(e){e.eventPhase===qC.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},A._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},A._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},A._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(NV.SCROLL_ENDED))},A._getLocalAxisAlignDelta=function(e,t){var i=this.node._uiProps.uiTransformComp,n=new ce;i&&(t.getUILocation(zV),t.getUIPreviousLocation(UV),BV.set(zV.x,zV.y,0),FV.set(UV.x,UV.y,0),i.convertToNodeSpaceAR(BV,BV),i.convertToNodeSpaceAR(FV,FV),ce.subtract(n,BV,FV)),e.set(n)},A._scrollChildren=function(e){this._clampDelta(e);this.elastic&&(a=this._getHowMuchOutOfBoundary(),e.x*=0===a.x?1:.5,e.y*=0===a.y?1:.5),this.elastic||(a=this._getHowMuchOutOfBoundary(e),e.add(a));var t,i,n,r,o,a="",s="";this._content&&(t=(r=this._content._uiProps.uiTransformComp).anchorX,i=r.anchorY,n=r.width,r=r.height,o=this._content.position||ce.ZERO,this.vertical&&(0<e.y?o.y-i*r+e.y>=this._bottomBoundary&&(a=NV.SCROLL_TO_BOTTOM):e.y<0&&o.y-i*r+r+e.y<=this._topBoundary&&(a=NV.SCROLL_TO_TOP)),this.horizontal&&(e.x<0?o.x-t*n+n+e.x<=this._rightBoundary&&(s=NV.SCROLL_TO_RIGHT):0<e.x&&o.x-t*n+e.x>=this._leftBoundary&&(s=NV.SCROLL_TO_LEFT))),this._moveContent(e,!1),(this.horizontal&&0!==e.x||this.vertical&&0!==e.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(NV.SCROLL_BEGAN)),this._dispatchEvent(NV.SCROLLING)),""!==a&&this._dispatchEvent(a),""!==s&&this._dispatchEvent(s)},A._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(NV.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=MV(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},A._clampDelta=function(e){var t,i;this._content&&this.view&&(t=this.view.contentSize,(i=this._content._uiProps.uiTransformComp).width<t.width&&(e.x=0),i.height<t.height&&(e.y=0))},A._gatherTouchMove=function(e){e=e.clone();for(this._clampDelta(e);5<=this._touchMoveDisplacements.length;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);e=MV();this._touchMoveTimeDeltas.push((e-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=e},A._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(ce.ZERO,LV))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent(NV.BOUNCE_TOP),e.y<0&&this._dispatchEvent(NV.BOUNCE_BOTTOM),0<e.x&&this._dispatchEvent(NV.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(NV.BOUNCE_LEFT),this._isBouncing=!0),!0},A._processInertiaScroll=function(){var e;!this._startBounceBackIfNeeded()&&this.inertia&&!(e=this._calculateTouchMoveVelocity()).equals(BV,LV)&&this.brake<1&&this._startInertiaScroll(e),this._onScrollBarTouchEnded()},A._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(ce.ZERO,LV)},A._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},A._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var e=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime),n=(this._autoScrollAttenuate&&(n=e,e=--n*n*n*n*n+1),this._autoScrollTargetDelta.clone()),r=(n.multiplyScalar(e),this._autoScrollStartPosition.clone()),n=(r.add(n),Math.abs(e-1)<=LV),e=(Math.abs(e-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(NV.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic?((e=r.clone()).subtract(this._autoScrollBrakingStartPosition),t&&e.multiplyScalar(i),r.set(this._autoScrollBrakingStartPosition),r.add(e)):((t=r.clone()).subtract(this.getContentPosition()),(i=this._getHowMuchOutOfBoundary(t)).equals(ce.ZERO,LV)||(r.add(i),n=!0)),n&&(this._autoScrolling=!1),r.clone());e.subtract(this._getContentPosition()),this._clampDelta(e),this._moveContent(e,n),this._dispatchEvent(NV.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(NV.SCROLL_ENDED))},A._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(ce.ZERO,LV))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(NV.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(NV.SCROLL_ENDED),this._stopMouseWheel=!1)},A._calculateMovePercentDelta=function(e){var t=e.anchor,i=e.applyToHorizontal,e=e.applyToVertical;this._calculateBoundary(),t.clampf(U.ZERO,U.ONE);var n,r,o,a=-(this._getContentBottomBoundary()-this._bottomBoundary),s=-(this._getContentLeftBoundary()-this._leftBoundary),c=new ce;return this._content&&this.view&&(n=0,r=this._content._uiProps.uiTransformComp.contentSize,o=this.view.contentSize,i&&(n=r.width-o.width,c.x=s-n*t.x),e&&(n=r.height-o.height,c.y=a-n*t.y)),c},A._moveContentToTopLeft=function(e){var t,i=-(this._getContentBottomBoundary()-this._bottomBoundary),n=new ce,r=0,o=-(this._getContentLeftBoundary()-this._leftBoundary);this._content&&((t=this._content._uiProps.uiTransformComp.contentSize).height<e.height&&(r=t.height-e.height,n.y=i-r),t.width<e.width&&(r=t.width-e.width,n.x=o)),this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},A._scaleChanged=function(e){e===Q0.SCALE&&this._calculateBoundary()},e(YV,[{key:"content",get:function(){return this._content},set:function(e){var t;this._content!==e&&(t=e&&e.parent&&e.parent._uiProps.uiTransformComp,!e||t?(this._content=e,this._calculateBoundary()):ne(4302))}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(U.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(U.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),YV.EventType=NV,gV=i((h=YV).prototype,"bounceDuration",[d,Pc,r,vI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),vV=i(h.prototype,"brake",[d,ll,t,o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),yV=i(h.prototype,"elastic",[d,I,tl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xV=i(h.prototype,"inertia",[d,Sa,nl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i(h.prototype,"content",[R,rl,ul],Object.getOwnPropertyDescriptor(h.prototype,"content"),h.prototype),SV=i(h.prototype,"horizontal",[d,b,uI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i(h.prototype,"horizontalScrollBar",[Xp,EW,cM],Object.getOwnPropertyDescriptor(h.prototype,"horizontalScrollBar"),h.prototype),bV=i(h.prototype,"vertical",[d,yI,C7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i(h.prototype,"verticalScrollBar",[ane,Lc,a],Object.getOwnPropertyDescriptor(h.prototype,"verticalScrollBar"),h.prototype),TV=i(h.prototype,"cancelInnerEvents",[d,s,W3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EV=i(h.prototype,"scrollEvents",[dU,d,Ac,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CV=i(h.prototype,"_content",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wV=i(h.prototype,"_horizontalScrollBar",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AV=i(h.prototype,"_verticalScrollBar",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),C=h))||C)||C)||C)||C)||C,Rre({ScrollView:kp,ScrollViewComponent:kp});var GV,HV,VV,jV,WV,qV,Aw=kp,XV=new ce;function YV(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=qV.call.apply(qV,[this].concat(i))||this,"bounceDuration",gV,p(e)),_(e,"brake",vV,p(e)),_(e,"elastic",yV,p(e)),_(e,"inertia",xV,p(e)),_(e,"horizontal",SV,p(e)),_(e,"vertical",bV,p(e)),_(e,"cancelInnerEvents",TV,p(e)),_(e,"scrollEvents",EV,p(e)),e._autoScrolling=!1,e._scrolling=!1,_(e,"_content",CV,p(e)),_(e,"_horizontalScrollBar",wV,p(e)),_(e,"_verticalScrollBar",AV,p(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new ce,e._autoScrollTargetDelta=new ce,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new ce,e._outOfBoundaryAmount=new ce,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new ce,e._deltaPos=new ce,e}(P=WV=WV||{})[P.Horizontal=0]="Horizontal",P[P.Vertical=1]="Vertical",Lt(WV);Y3=f("cc.Slider"),B1=wp(),pF=Oa(110),il=Ep(),bne=gl(Cz),YD=v(j3),Hd=u(),Up=v(WV),Z5=u(),E=Dp(),kd=u(),Qp=v([mD]),Mne=u(),S=Y3(Bp=B1(Bp=pF(Bp=il(Bp=bne((l($V,JV=W_),(Op=$V.prototype).__preload=function(){this._updateHandlePosition()},Op.onEnable=function(){this._updateHandlePosition(),this.node.on(T.TOUCH_START,this._onTouchBegan,this),this.node.on(T.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(T.TOUCH_END,this._onTouchEnded,this),this.node.on(T.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(T.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(T.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(T.TOUCH_END,this._onTouchEnded,this))},Op.onDisable=function(){this.node.off(T.TOUCH_START,this._onTouchBegan,this),this.node.off(T.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(T.TOUCH_END,this._onTouchEnded,this),this.node.off(T.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(T.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(T.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(T.TOUCH_END,this._onTouchEnded,this))},Op._onHandleDragStart=function(e){var t;e&&this._handle&&this._handle.node._uiProps.uiTransformComp&&(this._dragging=!0,this._touchHandle=!0,t=e.touch.getUILocation(),ce.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0)},Op._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},Op._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},Op._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new ce,e&&(e.propagationStopped=!0)},Op._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},Op._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},Op._emitSlideEvent=function(){mD.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},Op._updateProgress=function(e){var t;this._handle&&e&&(e=e.getUILocation(),ce.set(this._touchPos,e.x,e.y,0),t=(e=this.node._uiProps.uiTransformComp).convertToNodeSpaceAR(this._touchPos,XV),this.direction===WV.Horizontal?this.progress=zn(.5+(t.x-this._offset.x)/e.width):this.progress=zn(.5+(t.y-this._offset.y)/e.height))},Op._updateHandlePosition=function(){var e;this._handle&&(this._handleLocalPos.set(this._handle.node.getPosition()),e=this.node._uiProps.uiTransformComp,this._direction===WV.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos))},Op._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;e.setContentSize(t.height,t.width),this._handle&&(e=this._handle.node.position,this._direction===WV.Horizontal?this._handle.node.setPosition(e.x,0,e.z):this._handle.node.setPosition(0,e.y,e.z),this._updateHandlePosition())},e($V,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),$V.Direction=WV,i((Mp=$V).prototype,"handle",[YD,Hd],Object.getOwnPropertyDescriptor(Mp.prototype,"handle"),Mp.prototype),i(Mp.prototype,"direction",[Up,Z5],Object.getOwnPropertyDescriptor(Mp.prototype,"direction"),Mp.prototype),i(Mp.prototype,"progress",[Np,E,kd],Object.getOwnPropertyDescriptor(Mp.prototype,"progress"),Mp.prototype),GV=i(Mp.prototype,"slideEvents",[Qp,d,Mne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HV=i(Mp.prototype,"_handle",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VV=i(Mp.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WV.Horizontal}}),jV=i(Mp.prototype,"_progress",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Bp=Mp))||Bp)||Bp)||Bp)||Bp)||Bp,Rre({Slider:S,SliderComponent:S});var KV,QV,ZV,JV,kw=S;function $V(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=JV.call.apply(JV,[this].concat(i))||this,"slideEvents",GV,p(e)),_(e,"_handle",HV,p(e)),_(e,"_direction",VV,p(e)),_(e,"_progress",jV,p(e)),e._offset=new ce,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new ce,e._touchPos=new ce,e}function ej(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Object.assign.apply(Object,[{}].concat(t))}(pte=pte||{}).TOGGLE="toggle";Gd=f("cc.Toggle"),Bc=wp(),n=Oa(110),hl=Ep(),_l=gl(Cz),E2=m(),L6=u(),XN=v(j3),y=m(),fie=u(),xH=v([mD]),aie=u(),Cp=Gd(vie=Bc(vie=n(vie=hl(vie=_l((l(Aj,Ej=g),(Nw=Aj.prototype)._internalToggle=function(){this.isChecked=!this.isChecked},Nw._set=function(e,t){var i;void 0===t&&(t=!0),this._isChecked!=e&&(this._isChecked=e,(i=this._toggleContainer)&&i.enabled&&this.enabled&&(e||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents())},Nw.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},Nw.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},Nw.onEnable=function(){Ej.prototype.onEnable.call(this),this.playEffect(),this.node.on(Aj.EventType.CLICK,this._internalToggle,this)},Nw.onDisable=function(){Ej.prototype.onDisable.call(this),this.node.off(Aj.EventType.CLICK,this._internalToggle,this)},Nw.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},Nw._emitToggleEvents=function(){this.node.emit(Aj.EventType.TOGGLE,this),this.checkEvents&&mD.emitEvents(this.checkEvents,this)},e(Aj,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return j.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),(pi=Aj).EventType=ej(pte,WG),i((die=pi).prototype,"isChecked",[E2,L6],Object.getOwnPropertyDescriptor(die.prototype,"isChecked"),die.prototype),i(die.prototype,"checkMark",[XN,y,fie],Object.getOwnPropertyDescriptor(die.prototype,"checkMark"),die.prototype),KV=i(die.prototype,"checkEvents",[xH,d,aie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QV=i(die.prototype,"_isChecked",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZV=i(die.prototype,"_checkMark",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vie=die))||vie)||vie)||vie)||vie)||vie,Rre({Toggle:Cp,ToggleComponent:Cp});var tj,ij,nj,rj,oj,aj,sj,cj,lj,uj,hj,pj,_j,fj,dj,mj,gj,vj,yj,xj,Sj,bj,Tj,Ej,zp=Cp,t=(Iie=f("cc.ToggleContainer"),Rie=wp(),yU=Oa(110),Nk=Ep(),c=u(),x=v([mD]),A=u(),ll=Iie(vI=Rie(vI=yU(vI=Nk(vI=Tp((l(wj,Tj=W_),(Pc=wj.prototype).onEnable=function(){this.ensureValidState(),this.node.on(T.CHILD_ADDED,this.ensureValidState,this),this.node.on(T.CHILD_REMOVED,this.ensureValidState,this)},Pc.onDisable=function(){this.node.off(T.CHILD_ADDED,this.ensureValidState,this),this.node.off(T.CHILD_REMOVED,this.ensureValidState,this)},Pc.activeToggles=function(){return this.toggleItems.filter(function(e){return e.isChecked})},Pc.anyTogglesChecked=function(){return!!this.toggleItems.find(function(e){return e.isChecked})},Pc.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var i=0;i<this.toggleItems.length;i++){var n=this.toggleItems[i];n!==e&&(t?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&j.Component.EventHandler.emitEvents(this.checkEvents,e)}},Pc.ensureValidState=function(){var e=this.toggleItems,t=(this._allowSwitchOff||this.anyTogglesChecked()||0===e.length||((e=e[0]).isChecked=!0,this.notifyToggleCheck(e)),this.activeToggles());if(1<t.length)for(var i=t[0],n=0;n<t.length;++n){var r=t[n];r!==i&&(r.isChecked=!1)}},e(wj,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map(function(e){e=e.getComponent("cc.Toggle");return e&&e.enabled?e:null}).filter(Boolean)}}]),tj=i((r=wj).prototype,"_allowSwitchOff",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(r.prototype,"allowSwitchOff",[c],Object.getOwnPropertyDescriptor(r.prototype,"allowSwitchOff"),r.prototype),ij=i(r.prototype,"checkEvents",[x,d,A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vI=r))||vI)||vI)||vI)||vI)||vI,Rre({ToggleContainer:ll,ToggleContainerComponent:ll}),ll),Cj=new U;function wj(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=Tj.call.apply(Tj,[this].concat(i))||this,"_allowSwitchOff",tj,p(e)),_(e,"checkEvents",ij,p(e)),e}function Aj(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=Ej.call.apply(Ej,[this].concat(i))||this,"checkEvents",KV,p(e)),_(e,"_isChecked",QV,p(e)),_(e,"_checkMark",ZV,p(e)),e}function Pj(e){return e instanceof Vw?$P:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:Hr.ZERO}function Ij(e,t,i,n){e.parent?Cj.set(e.parent.getScale().x,e.parent.getScale().y):Cj.set(0,0);for(var r=Cj.x,o=Cj.y,a=0,s=0,c=e.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?Cj.set(c.getScale().x,c.getScale().y):Cj.set(0,0);var l=Cj.x,u=Cj.y;a*=l,s*=u,r*=l,o*=u}n.x=0!==r?1/r:1,n.y=0!==o?1/o:1,i.x=-a,i.y=-s}(o=Sj=Sj||{})[o.ONCE=0]="ONCE",o[o.ALWAYS=1]="ALWAYS",o[o.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE",Lt(Sj),(I=bj=bj||{})[I.TOP=1]="TOP",I[I.MID=2]="MID",I[I.BOT=4]="BOT",I[I.LEFT=8]="LEFT",I[I.CENTER=16]="CENTER",I[I.RIGHT=32]="RIGHT",I[I.HORIZONTAL=56]="HORIZONTAL",I[I.VERTICAL=7]="VERTICAL";var Rj,Dj,Oj,Mj,Nj,Lj=bj.TOP|bj.BOT,Bj=bj.LEFT|bj.RIGHT,Fj=(tl=f("cc.Widget"),Sa=wp(),nl=Oa(110),R=Ep(),rl=gl(Cz),ul=v(N1),b=u(),uI=u(),Xp=u(),EW=u(),cM=u(),yI=u(),C7=u(),ane=Pp(),Lc=Pp(),a=u(),s=u(),W3=u(),dU=u(),Ac=u(),Ce=u(),h=v(Sj),C=u(),B1=tl(Y3=Sa(Y3=nl(Y3=R(Y3=rl(Y3=Tp((l(zj,Nj=W_),(kp=zj.prototype).updateAlignment=function(){j._widgetManager.updateAlignment(this.node)},kp._validateTargetInDEV=function(){},kp.setDirty=function(){this._recursiveDirty()},kp.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),j._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},kp.onDisable=function(){j._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},kp.onDestroy=function(){this._removeParentEvent()},kp._adjustWidgetToAllowMovingInEditor=function(){},kp._adjustWidgetToAllowResizingInEditor=function(){},kp._adjustWidgetToAnchorChanged=function(){this.setDirty()},kp._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},kp._registerEvent=function(){this.node.on(T.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(T.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(T.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(T.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},kp._unregisterEvent=function(){this.node.off(T.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(T.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(T.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},kp._removeParentEvent=function(){this.node.off(T.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},kp._autoChangedValue=function(e,t){var i;0<(this._alignFlags&e)&&(i=(i=(i=this.node.parent&&this.node.parent._uiProps)&&i.uiTransformComp)?i.contentSize:$P,this.isAlignLeft&&e===bj.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===bj.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===bj.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===bj.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===bj.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===bj.MID&&(this._verticalCenter=this._verticalCenter/i.height),this._recursiveDirty())},kp._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(Cz)&&(e.on(T.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(T.SIZE_CHANGED,this._setDirtyByMode,this),e.on(T.ANCHOR_CHANGED,this._setDirtyByMode,this))},kp._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(T.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(T.SIZE_CHANGED,this._setDirtyByMode,this),e.off(T.ANCHOR_CHANGED,this._setDirtyByMode,this))},kp._unregisterOldParentEvents=function(e){e=this._target||e;e&&(e.off(T.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(T.SIZE_CHANGED,this._setDirtyByMode,this))},kp._setDirtyByMode=function(){this.alignMode===Sj.ALWAYS&&this._recursiveDirty()},kp._setAlign=function(e,t){var i,n;t!==0<(this._alignFlags&e)&&(i=0<(e&Bj),n=this.node._uiProps.uiTransformComp,t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~e))},kp._recursiveDirty=function(){this._dirty||(this._dirty=!0)},e(zj,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&bj.TOP)},set:function(e){this._setAlign(bj.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&bj.BOT)},set:function(e){this._setAlign(bj.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&bj.LEFT)},set:function(e){this._setAlign(bj.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&bj.RIGHT)},set:function(e){this._setAlign(bj.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&bj.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=bj.MID):this._alignFlags&=~bj.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&bj.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=bj.CENTER):this._alignFlags&=~bj.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&Bj)==Bj}},{key:"isStretchHeight",get:function(){return(this._alignFlags&Lj)==Lj}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(bj.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(bj.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(bj.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(bj.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(bj.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(bj.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),zj.AlignMode=Sj,i((P=zj).prototype,"target",[ul,b],Object.getOwnPropertyDescriptor(P.prototype,"target"),P.prototype),i(P.prototype,"isAlignTop",[uI],Object.getOwnPropertyDescriptor(P.prototype,"isAlignTop"),P.prototype),i(P.prototype,"isAlignBottom",[Xp],Object.getOwnPropertyDescriptor(P.prototype,"isAlignBottom"),P.prototype),i(P.prototype,"isAlignLeft",[EW],Object.getOwnPropertyDescriptor(P.prototype,"isAlignLeft"),P.prototype),i(P.prototype,"isAlignRight",[cM],Object.getOwnPropertyDescriptor(P.prototype,"isAlignRight"),P.prototype),i(P.prototype,"isAlignVerticalCenter",[yI],Object.getOwnPropertyDescriptor(P.prototype,"isAlignVerticalCenter"),P.prototype),i(P.prototype,"isAlignHorizontalCenter",[C7],Object.getOwnPropertyDescriptor(P.prototype,"isAlignHorizontalCenter"),P.prototype),i(P.prototype,"isStretchWidth",[ane],Object.getOwnPropertyDescriptor(P.prototype,"isStretchWidth"),P.prototype),i(P.prototype,"isStretchHeight",[Lc],Object.getOwnPropertyDescriptor(P.prototype,"isStretchHeight"),P.prototype),i(P.prototype,"top",[a],Object.getOwnPropertyDescriptor(P.prototype,"top"),P.prototype),i(P.prototype,"editorTop",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"editorTop"),P.prototype),i(P.prototype,"bottom",[s],Object.getOwnPropertyDescriptor(P.prototype,"bottom"),P.prototype),i(P.prototype,"editorBottom",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"editorBottom"),P.prototype),i(P.prototype,"left",[W3],Object.getOwnPropertyDescriptor(P.prototype,"left"),P.prototype),i(P.prototype,"editorLeft",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"editorLeft"),P.prototype),i(P.prototype,"right",[dU],Object.getOwnPropertyDescriptor(P.prototype,"right"),P.prototype),i(P.prototype,"editorRight",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"editorRight"),P.prototype),i(P.prototype,"horizontalCenter",[Ac],Object.getOwnPropertyDescriptor(P.prototype,"horizontalCenter"),P.prototype),i(P.prototype,"editorHorizontalCenter",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"editorHorizontalCenter"),P.prototype),i(P.prototype,"verticalCenter",[Ce],Object.getOwnPropertyDescriptor(P.prototype,"verticalCenter"),P.prototype),i(P.prototype,"editorVerticalCenter",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"editorVerticalCenter"),P.prototype),i(P.prototype,"isAbsoluteTop",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"isAbsoluteTop"),P.prototype),i(P.prototype,"isAbsoluteBottom",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"isAbsoluteBottom"),P.prototype),i(P.prototype,"isAbsoluteLeft",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"isAbsoluteLeft"),P.prototype),i(P.prototype,"isAbsoluteRight",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"isAbsoluteRight"),P.prototype),i(P.prototype,"isAbsoluteHorizontalCenter",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"isAbsoluteHorizontalCenter"),P.prototype),i(P.prototype,"isAbsoluteVerticalCenter",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"isAbsoluteVerticalCenter"),P.prototype),i(P.prototype,"alignMode",[h,C],Object.getOwnPropertyDescriptor(P.prototype,"alignMode"),P.prototype),i(P.prototype,"alignFlags",[Ap],Object.getOwnPropertyDescriptor(P.prototype,"alignFlags"),P.prototype),nj=i(P.prototype,"_alignFlags",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rj=i(P.prototype,"_target",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oj=i(P.prototype,"_left",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aj=i(P.prototype,"_right",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sj=i(P.prototype,"_top",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cj=i(P.prototype,"_bottom",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lj=i(P.prototype,"_horizontalCenter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uj=i(P.prototype,"_verticalCenter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hj=i(P.prototype,"_isAbsLeft",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pj=i(P.prototype,"_isAbsRight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_j=i(P.prototype,"_isAbsTop",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fj=i(P.prototype,"_isAbsBottom",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dj=i(P.prototype,"_isAbsHorizontalCenter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),mj=i(P.prototype,"_isAbsVerticalCenter",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gj=i(P.prototype,"_originalWidth",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vj=i(P.prototype,"_originalHeight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yj=i(P.prototype,"_alignMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sj.ON_WINDOW_RESIZE}}),xj=i(P.prototype,"_lockFlags",[d,xp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y3=P))||Y3)||Y3)||Y3)||Y3)||Y3)||Y3,Rre({Widget:B1,WidgetComponent:B1}),B1);function zj(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=Nj.call.apply(Nj,[this].concat(i))||this)._lastPos=new ce,e._lastSize=new Hr,e._dirty=!0,e._hadAlignOnce=!1,_(e,"_alignFlags",nj,p(e)),_(e,"_target",rj,p(e)),_(e,"_left",oj,p(e)),_(e,"_right",aj,p(e)),_(e,"_top",sj,p(e)),_(e,"_bottom",cj,p(e)),_(e,"_horizontalCenter",lj,p(e)),_(e,"_verticalCenter",uj,p(e)),_(e,"_isAbsLeft",hj,p(e)),_(e,"_isAbsRight",pj,p(e)),_(e,"_isAbsTop",_j,p(e)),_(e,"_isAbsBottom",fj,p(e)),_(e,"_isAbsHorizontalCenter",dj,p(e)),_(e,"_isAbsVerticalCenter",mj,p(e)),_(e,"_originalWidth",gj,p(e)),_(e,"_originalHeight",vj,p(e)),_(e,"_alignMode",yj,p(e)),_(e,"_lockFlags",xj,p(e)),e}j.internal.computeInverseTransForTarget=Ij,j.internal.getReadonlyNodeSize=Pj;var Uj,kj=new nr;(pF=Uj=Uj||{})[pF.HORIZONTAL=0]="HORIZONTAL",pF[pF.VERTICAL=1]="VERTICAL",Lt(Uj);il=f("cc.PageViewIndicator"),bne=wp(),Op=Oa(110),YD=Ep(),Hd=v(lF),Up=u(),Z5=v(Uj),E=u(),kd=v(Hr),Qp=u(),Mne=u(),Gd=il(S=bne(S=Op(S=YD((l(rW,iW=W_),(Mp=rW.prototype).onLoad=function(){this._updateLayout()},Mp.setPageView=function(e){this._pageView=e,this._refresh()},Mp._updateLayout=function(){this._layout=this.getComponent(tV),this._layout||(this._layout=this.addComponent(tV));var e=this._layout;this.direction===Uj.HORIZONTAL?(e.type=tV.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Uj.VERTICAL&&(e.type=tV.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=tV.ResizeMode.CONTAINER},Mp._createIndicator=function(){var e=new N1,t=(e.layer=this.node.layer,e.addComponent(j3));return t.spriteFrame=this.spriteFrame,t.sizeMode=j3.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},Mp._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];n._uiProps.uiComp&&(n=n._uiProps.uiComp,kj.set(n.color),kj.a=127.5,n.color=kj)}e[t]._uiProps.uiComp&&(t=e[t]._uiProps.uiComp,kj.set(t.color),kj.a=255,t.color=kj)}}},Mp._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;0<i;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},e(rW,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),rW.Direction=Uj,i((Bp=rW).prototype,"spriteFrame",[Hd,Up],Object.getOwnPropertyDescriptor(Bp.prototype,"spriteFrame"),Bp.prototype),i(Bp.prototype,"direction",[Z5,E],Object.getOwnPropertyDescriptor(Bp.prototype,"direction"),Bp.prototype),i(Bp.prototype,"cellSize",[kd,Qp],Object.getOwnPropertyDescriptor(Bp.prototype,"cellSize"),Bp.prototype),Rj=i(Bp.prototype,"spacing",[d,Mne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dj=i(Bp.prototype,"_spriteFrame",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oj=i(Bp.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uj.HORIZONTAL}}),Mj=i(Bp.prototype,"_cellSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(20,20)}}),S=Bp))||S)||S)||S)||S,Rre({PageViewIndicator:Gd,PageViewIndicatorComponent:Gd});var Gj,Hj,Vj,jj,Wj,qj,Xj,Yj,Kj,Qj,Zj,Jj,$j,eW,tW,iW,Bc=Gd,nW=new U;function rW(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=iW.call.apply(iW,[this].concat(i))||this,"spacing",Rj,p(e)),_(e,"_spriteFrame",Dj,p(e)),_(e,"_direction",Oj,p(e)),_(e,"_cellSize",Mj,p(e)),e._layout=null,e._pageView=null,e._indicators=[],e}(n=$j=$j||{})[n.Unified=0]="Unified",n[n.Free=1]="Free",Lt($j),(hl=eW=eW||{})[hl.Horizontal=0]="Horizontal",hl[hl.Vertical=1]="Vertical",Lt(eW),(tW=tW||{}).PAGE_TURNING="page-turning";_l=f("cc.PageView"),Nw=wp(),pte=Oa(110),pi=Ep(),E2=v($j),L6=u(),XN=v(eW),y=u(),fie=Dp(),xH=u(),aie=Dp(),die=u(),vie=v(Bc),Cp=u(),Iie=u(),Rie=v(w),yU=Pp(),Nk=v(w),Pc=Pp(),c=Pp(),x=Pp(),A=Pp(),r=v([mD]),vI=Pp(),ll=u(),o=v([mD]),I=u(),kp=_l(rl=Nw(rl=pte(rl=pi((l(pW,oW=Aw),(tl=pW.prototype).onEnable=function(){oW.prototype.onEnable.call(this),this.node.on(T.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(pW.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},tl.onDisable=function(){oW.prototype.onDisable.call(this),this.node.off(T.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(pW.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},tl.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},tl.getCurrentPageIndex=function(){return this._curPageIdx},tl.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},tl.getPages=function(){return this._pages},tl.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):ne(4301))},tl.insertPage=function(e,t){t<0||!e||-1!==this._pages.indexOf(e)||!this.content||(t>=this._pages.length?this.addPage(e):e._uiProps.uiTransformComp?(this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()):ne(4301))},tl.removePage=function(e){var t;e&&this.content&&(-1!==(t=this._pages.indexOf(e))?this.removePageAtIndex(t):J(4300,e.name))},tl.removePageAtIndex=function(e){var t,i=this._pages;e<0||e>=i.length||(t=i[e])&&this.content&&(this.content.removeChild(t),i.splice(e,1),this._updatePageView())},tl.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},tl.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},tl.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},tl._updatePageView=function(){if(this.content){var e=this.content.getComponent(tV),t=(e&&e.enabled&&e.updateLayout(),this._pages.length);this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===eW.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}},tl._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===$j.Unified)for(var t=this._pages,i=e.contentSize,n=0,r=t.length;n<r;n++)t[n]._uiProps.uiTransformComp.setContentSize(i)},tl._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(pW.EventType.SCROLL_ENDED))},tl._onTouchBegan=function(e,t){e.touch.getUILocation(nW),U.set(this._touchBeganPosition,nW.x,nW.y),oW.prototype._onTouchBegan.call(this,e,t)},tl._onTouchMoved=function(e,t){oW.prototype._onTouchMoved.call(this,e,t)},tl._onTouchEnded=function(e,t){e.touch.getUILocation(nW),U.set(this._touchEndPosition,nW.x,nW.y),oW.prototype._onTouchEnded.call(this,e,t)},tl._onTouchCancelled=function(e,t){e.touch.getUILocation(nW),U.set(this._touchEndPosition,nW.x,nW.y),oW.prototype._onTouchCancelled.call(this,e,t)},tl._onMouseWheel=function(){},tl._syncScrollDirection=function(){this.horizontal=this.direction===eW.Horizontal,this.vertical=this.direction===eW.Vertical},tl._syncSizeMode=function(){var e,t,i,n=this.view;this.content&&n&&((e=this.content.getComponent(tV))&&(this._sizeMode===$j.Free&&0<this._pages.length&&(t=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp,this.direction===eW.Horizontal?(e.paddingLeft=(n.width-t.width)/2,e.paddingRight=(n.width-i.width)/2):this.direction===eW.Vertical&&(e.paddingTop=(n.height-t.height)/2,e.paddingBottom=(n.height-i.height)/2)),e.updateLayout()))},tl._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];0<=this._pages.indexOf(i)||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},tl._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,mD.emitEvents(this.pageEvents,this,tW.PAGE_TURNING),this.node.emit(tW.PAGE_TURNING,this))},tl._isQuicklyScrollable=function(e){if(this.direction===eW.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===eW.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},tl._moveOffsetValue=function(e){var t=new U;if(this._sizeMode===$j.Free)this.direction===eW.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===eW.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===eW.Horizontal?t.x=e*i.width:this.direction===eW.Vertical&&(t.y=e*i.height)}return t},tl._getDragDirection=function(e){return this._direction===eW.Horizontal?0===e.x?0:0<e.x?1:-1:0===e.y?0:e.y<0?1:-1},tl._isScrollable=function(e,t,i){if(this._sizeMode===$j.Free){var n=0,r=0;if(this.direction===eW.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===eW.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{t=this.view;if(!t)return!1;if(this.direction===eW.Horizontal)return Math.abs(e.x)>=t.width*this.scrollThreshold;if(this.direction===eW.Vertical)return Math.abs(e.y)>=t.height*this.scrollThreshold}return!1},tl._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(0<e.x||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||0<e.y)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new U,t=(U.subtract(e,this._touchBeganPosition,this._touchEndPosition),this._curPageIdx),i=t+this._getDragDirection(e),n=this.pageTurningSpeed*Math.abs(t-i);if(i<this._pages.length){if(this._isScrollable(e,t,i))return void this.scrollToPage(i,n);e=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(e))return void this.scrollToPage(i,n)}this.scrollToPage(t,n)}},e(pW,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return oW.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return oW.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),nl=Sa=pW,Sa.SizeMode=$j,Sa.Direction=eW,Sa.EventType=ej(tW,NV),i((R=nl).prototype,"sizeMode",[E2,L6],Object.getOwnPropertyDescriptor(R.prototype,"sizeMode"),R.prototype),i(R.prototype,"direction",[XN,y],Object.getOwnPropertyDescriptor(R.prototype,"direction"),R.prototype),i(R.prototype,"scrollThreshold",[Np,fie,xH],Object.getOwnPropertyDescriptor(R.prototype,"scrollThreshold"),R.prototype),i(R.prototype,"pageTurningEventTiming",[Np,aie,die],Object.getOwnPropertyDescriptor(R.prototype,"pageTurningEventTiming"),R.prototype),i(R.prototype,"indicator",[vie,Cp],Object.getOwnPropertyDescriptor(R.prototype,"indicator"),R.prototype),Gj=i(R.prototype,"autoPageTurningThreshold",[d,Iie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),i(R.prototype,"verticalScrollBar",[Rie,Gp,yU],Object.getOwnPropertyDescriptor(R.prototype,"verticalScrollBar"),R.prototype),i(R.prototype,"horizontalScrollBar",[Nk,Gp,Pc],Object.getOwnPropertyDescriptor(R.prototype,"horizontalScrollBar"),R.prototype),Hj=i(R.prototype,"horizontal",[Gp,d,c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vj=i(R.prototype,"vertical",[Gp,d,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jj=i(R.prototype,"cancelInnerEvents",[Gp,d,A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Wj=i(R.prototype,"scrollEvents",[r,d,Gp,vI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qj=i(R.prototype,"pageTurningSpeed",[d,Ap,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Xj=i(R.prototype,"pageEvents",[o,d,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yj=i(R.prototype,"_sizeMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $j.Unified}}),Kj=i(R.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eW.Horizontal}}),Qj=i(R.prototype,"_scrollThreshold",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Zj=i(R.prototype,"_pageTurningEventTiming",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Jj=i(R.prototype,"_indicator",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rl=R))||rl)||rl)||rl)||rl,Rre({PageView:kp,PageViewComponent:kp});var oW,ul=kp,aW=new ce,sW=new U,cW=new U,lW=new U(1,1),uW=new U,hW=new U;function pW(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=oW.call.apply(oW,[this].concat(i))||this,"autoPageTurningThreshold",Gj,p(e)),_(e,"horizontal",Hj,p(e)),_(e,"vertical",Vj,p(e)),_(e,"cancelInnerEvents",jj,p(e)),_(e,"scrollEvents",Wj,p(e)),_(e,"pageTurningSpeed",qj,p(e)),_(e,"pageEvents",Xj,p(e)),_(e,"_sizeMode",Yj,p(e)),_(e,"_direction",Kj,p(e)),_(e,"_scrollThreshold",Qj,p(e)),_(e,"_pageTurningEventTiming",Zj,p(e)),_(e,"_indicator",Jj,p(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new ce,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new U,e._touchEndPosition=new U,e}function _W(e,t){var i,n,r,o,a,s,c,l,u,h,p,_,f,d,m,g,v;t._hadAlignOnce||(t.alignMode===Sj.ONCE&&(t._hadAlignOnce=!0),i=t.target,n=cW,r=lW,i?Ij(e,a=i,n,r):a=e.parent,o=Pj(a),a=(g=a instanceof Vw||!a.getComponent(Cz))?sW:a.getComponent(Cz).anchorPoint,g=g,e.getPosition(aW),s=e._uiProps.uiTransformComp,c=aW.x,l=aW.y,v=s.anchorPoint,u=e.getScale(),t.alignFlags&bj.HORIZONTAL&&(d=p=0,_=o.width,d=g?(p=$P.left.x,$P.right.x):(p=-a.x*_)+_,p+=t.isAbsoluteLeft?t.left:t.left*_,d-=t.isAbsoluteRight?t.right:t.right*_,i&&(p=(p+=n.x)*r.x,d=(d+=n.x)*r.x),m=v.x,(h=u.x)<(f=0)&&(m=1-m,h=-h),c=t.isStretchWidth?(f=d-p,0!==h&&(s.width=f/h),p+m*f):(f=s.width*h,t.isAlignHorizontalCenter?(h=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*_,_=(.5-a.x)*o.width,i&&(h*=r.x,_=(_+=n.x)*r.x),_+(m-.5)*f+h):t.isAlignLeft?p+m*f:d+(m-1)*f),t._lastSize.width=f),t.alignFlags&bj.VERTICAL&&(h=_=0,p=o.height,_=g?(h=$P.bottom.y,$P.top.y):(h=-a.y*p)+p,h+=t.isAbsoluteBottom?t.bottom:t.bottom*p,_-=t.isAbsoluteTop?t.top:t.top*p,i&&(h=(h+=n.y)*r.y,_=(_+=n.y)*r.y),d=v.y,(m=u.y)<(f=0)&&(d=1-d,m=-m),l=t.isStretchHeight?(f=_-h,0!==m&&(s.height=f/m),h+d*f):(f=s.height*m,t.isAlignVerticalCenter?(g=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*p,v=(.5-a.y)*o.height,i&&(g*=r.y,v=(v+=n.y)*r.y),v+(d-.5)*f+g):t.isAlignBottom?h+d*f:_+(d-1)*f),t._lastSize.height=f),e.setPosition(c,l,aW.z),ce.set(t._lastPos,c,l,aW.z))}function fW(){var e=ZP.getScene();if(e){mW.isAligning=!0,mW._nodesOrderDirty&&(dW.length=0,function e(t){var i=t.getComponent(Fj);if(i&&i.enabled){if(!j.isValid(t,!0))return;dW.push(i)}for(var n=ge(t.children);!(r=n()).done;){var r=r.value;r.active&&e(r)}}(e),mW._nodesOrderDirty=!1);var t=null,i=mW._activeWidgetsIterator;for(i.i=0;i.i<dW.length;++i.i)(t=dW[i.i])._dirty&&(_W(t.node,t),t._dirty=!1);mW.isAligning=!1}}var dW=[],mW=Rre("widgetManager",j._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new mt.MutableForwardIterator(dW),animationState:null,init:function(){ZP.on(KP.EVENT_AFTER_SCENE_LAUNCH,fW),ZP.on(KP.EVENT_AFTER_UPDATE,fW),iI.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);iI.instance.on("canvas-resize",e),ef.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=ZP.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=N1.isNode(e)&&e.getComponent(Fj);t&&t.enabled&&(t.alignMode===Sj.ON_WINDOW_RESIZE||t.alignMode===Sj.ALWAYS)&&t.setDirty();for(var i=ge(e.children);!(n=i()).done;){var n=n.value;this.refreshWidgetOnResized(n)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var n,r,o,a,s,c,l,u,h,p=e.node,_=p.parent;_&&((n=uW).set(0,0),(r=hW).set(1,1),e.target&&Ij(p,_=e.target,n,r),t&&(o=(o=_._uiProps&&_._uiProps.uiTransformComp)?o.anchorPoint:sW,a=p._uiProps.uiTransformComp,_=Pj(_),s=a.anchorPoint,c=p.getPosition(),l=bj,p=p.getScale(),u=0,t&l.LEFT&&(h=-o.x*_.width,h=(h+=n.x)*r.x,u=c.x-s.x*a.width*p.x-h,e.isAbsoluteLeft||(u/=_.width),u/=r.x,e.left=i(e.left,u)),t&l.RIGHT&&(h=(1-o.x)*_.width,u=(h=(h+=n.x)*r.x)-(c.x+(1-s.x)*a.width*p.x),e.isAbsoluteRight||(u/=_.width),u/=r.x,e.right=i(e.right,u)),t&l.TOP&&(h=(1-o.y)*_.height,u=(h=(h+=n.y)*r.y)-(c.y+(1-s.y)*a.height*p.y),e.isAbsoluteTop||(u/=_.height),u/=r.y,e.top=i(e.top,u)),t&l.BOT&&(h=-o.y*_.height,h=(h+=n.y)*r.y,u=c.y-s.y*a.height*p.y-h,e.isAbsoluteBottom||(u/=_.height),u/=r.y,e.bottom=i(e.bottom,u))))},updateAlignment:function e(t){var i=t.parent,n=(i&&N1.isNode(i)&&e(i),t.getComponent(Fj));n&&i&&_W(t,n)},AlignMode:Sj,AlignFlags:bj});ZP.on(KP.EVENT_INIT,function(){mW.init()});Xp=f("cc.SafeArea")(uI=wp()(uI=Oa(110)(uI=Tp(uI=Ep()(uI=gl(Fj)((l(AW,TW=W_),(b=AW.prototype).onEnable=function(){this.updateArea(),ef.on("window-resize",this.updateArea,this),ef.on("orientation-change",this.updateArea,this)},b.onDisable=function(){ef.off("window-resize",this.updateArea,this),ef.off("orientation-change",this.updateArea,this)},b.updateArea=function(){var e,t,i,n,r,o=this.node.getComponent(Fj),a=this.node.getComponent(Cz);o&&a&&(o.updateAlignment(),e=this.node.position.clone(),t=a.anchorPoint.clone(),o.isAlignTop=o.isAlignBottom=o.isAlignLeft=o.isAlignRight=!0,n=(i=AI.getVisibleSize()).width,i=i.height,r=af.getSafeAreaRect(),o.top=i-r.y-r.height,o.bottom=r.y,o.left=r.x,o.right=n-r.x-r.width,o.updateAlignment(),i=this.node.position.clone(),n=t.x-(i.x-e.x)/a.width,r=t.y-(i.y-e.y)/a.height,a.setAnchorPoint(n,r),mW.add(o))},uI=AW))||uI)||uI)||uI)||uI)||uI)||uI,Rre({SafeArea:Xp,SafeAreaComponent:Xp});var gW,vW,yW,xW,SW,bW,TW,EW=Xp,pF=(cM=f("cc.UICoordinateTracker"),yI=wp(),C7=Ep(),ane=Oa(110),Lc=v(N1),a=u(),s=v(PD),W3=u(),dU=u(),Ac=u(),Ce=v([mD]),h=u(),B1=cM(Y3=yI(Y3=C7(Y3=ane((i((l(wW,bW=W_),(C=wW.prototype).onEnable=function(){this._checkCanMove()},C.update=function(){var e=this.node.worldPosition,t=this._camera;this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&ce.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),0<this.syncEvents.length)&&(e=this._distance/Math.abs(this._viewPos.z),mD.emitEvents(this.syncEvents,this._transformPos,e))},C._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},e(wW,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),P=wW).prototype,"target",[Lc,a],Object.getOwnPropertyDescriptor(P.prototype,"target"),P.prototype),i(P.prototype,"camera",[s,W3],Object.getOwnPropertyDescriptor(P.prototype,"camera"),P.prototype),i(P.prototype,"useScale",[dU],Object.getOwnPropertyDescriptor(P.prototype,"useScale"),P.prototype),i(P.prototype,"distance",[Ac],Object.getOwnPropertyDescriptor(P.prototype,"distance"),P.prototype),gW=i(P.prototype,"syncEvents",[Ce,d,h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vW=i(P.prototype,"_target",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yW=i(P.prototype,"_camera",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xW=i(P.prototype,"_useScale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SW=i(P.prototype,"_distance",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Y3=P))||Y3)||Y3)||Y3)||Y3,Rre({UICoordinateTracker:B1,UICoordinateTrackerComponent:B1}),B1),CW=[T.TOUCH_START,T.TOUCH_END,T.TOUCH_MOVE,T.MOUSE_DOWN,T.MOUSE_MOVE,T.MOUSE_UP,T.MOUSE_ENTER,T.MOUSE_LEAVE,T.MOUSE_WHEEL];function wW(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=bW.call.apply(bW,[this].concat(i))||this,"syncEvents",gW,p(e)),_(e,"_target",vW,p(e)),_(e,"_camera",yW,p(e)),_(e,"_useScale",xW,p(e)),_(e,"_distance",SW,p(e)),e._transformPos=new ce,e._viewPos=new ce,e._canMove=!0,e._lastWPos=new ce,e._lastCameraPos=new ce,e}function AW(){return TW.apply(this,arguments)||this}function PW(e){e.propagationStopped=!0}Op=f("cc.BlockInputEvents")(bne=wp()(bne=Ep()((l(LW,OW=W_),(il=LW.prototype).onEnable=function(){for(var e=0;e<CW.length;e++)this.node.on(CW[e],PW,this)},il.onDisable=function(){for(var e=0;e<CW.length;e++)this.node.off(CW[e],PW,this)},bne=LW))||bne)||bne)||bne,Rre({BlockInputEvents:Op,BlockInputEventsComponent:Op});var IW,RW,DW,OW,YD=Op,MW={},Gd=Rre("SubContextView",(Mp=f("cc.SubContextView"),Hd=wp(),Up=Oa(110),Z5=gl(Cz),E=Ep(),kd=u(),Qp=u(),Mp(S=Hd(S=Up(S=Z5(S=E((i((l(NW,DW=W_),(Mne=NW.prototype).onLoad=function(){MW.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=MW.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},Mne.onEnable=function(){this._registerNodeEvent()},Mne.onDisable=function(){this._unregisterNodeEvent()},Mne._initSharedCanvas=function(){var e;this._openDataContext&&((e=this._openDataContext.canvas).width=this._designResolutionSize.width,e.height=this._designResolutionSize.height)},Mne._initContentNode=function(){var e,t;this._openDataContext&&(e=this._openDataContext.canvas,(t=this._imageAsset).reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(j3),this._sprite||(this._sprite=this._content.addComponent(j3)),this._sprite.spriteFrame?this._sprite.spriteFrame.texture=this._texture:((t=new lF).texture=this._texture,this._sprite.spriteFrame=t),this._content.parent=this.node)},Mne._updateSubContextView=function(){var e,t,i,n,r,o,a;this._openDataContext&&(e=this.node.getComponent(Cz),t=this._content.getComponent(Cz),a=e.width/t.width,e=e.height/t.height,t.width*=e=e<a?e:a,t.height*=e,a=AI.getViewportRect(),e=t.getBoundingBoxToWorld(),t=AI.getVisibleSize(),i=ef.devicePixelRatio,n=(a.width*(e.x/t.width)+a.x)/i,r=(a.height*(e.y/t.height)+a.y)/i,o=a.width*(e.width/t.width)/i,a=a.height*(e.height/t.height)/i,this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:n,y:r,width:o,height:a}))},Mne._updateSubContextTexture=function(){var e,t=this._imageAsset;t&&this._openDataContext&&!(t.width<=0||t.height<=0)&&(e=this._openDataContext.canvas,t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e))},Mne._registerNodeEvent=function(){this.node.on(T.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(T.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(T.LAYER_CHANGED,this._updateContentLayer,this)},Mne._unregisterNodeEvent=function(){this.node.off(T.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(T.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(T.LAYER_CHANGED,this._updateContentLayer,this)},Mne._updateContentLayer=function(){this._content.layer=this.node.layer},Mne.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},Mne.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},e(NW,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),Bp=NW).prototype,"designResolutionSize",[kd],Object.getOwnPropertyDescriptor(Bp.prototype,"designResolutionSize"),Bp.prototype),i(Bp.prototype,"fps",[Qp],Object.getOwnPropertyDescriptor(Bp.prototype,"fps"),Bp.prototype),IW=i(Bp.prototype,"_fps",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),RW=i(Bp.prototype,"_designResolutionSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(640,960)}}),S=Bp))||S)||S)||S)||S)||S));function NW(){var e;return _(e=DW.call(this)||this,"_fps",IW,p(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,_(e,"_designResolutionSize",RW,p(e)),e._content=new N1("content"),e._content.hideFlags|=Pi.Flags.DontSave|Pi.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new Lv,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new i0,e}function LW(){return OW.apply(this,arguments)||this}j.SubContextView=Gd;var BW,hl=Rre("UIReorderComponent",f("cc.UIReorderComponent")(n=function(){J(1408,"UIReorderComponent")})||n);j.UIReorderComponent=hl,j.ButtonComponent=g,gt.setClassAlias(g,"cc.ButtonComponent"),j.EditBoxComponent=ba,gt.setClassAlias(ba,"cc.EditBoxComponent"),j.LayoutComponent=tV,gt.setClassAlias(tV,"cc.LayoutComponent"),j.ProgressBarComponent=bp,gt.setClassAlias(bp,"cc.ProgressBarComponent"),j.ScrollViewComponent=Aw,gt.setClassAlias(Aw,"cc.ScrollViewComponent"),j.ScrollBarComponent=w,gt.setClassAlias(w,"cc.ScrollBarComponent"),j.SliderComponent=kw,gt.setClassAlias(kw,"cc.SliderComponent"),j.ToggleComponent=zp,gt.setClassAlias(zp,"cc.ToggleComponent"),j.ToggleContainerComponent=t,gt.setClassAlias(t,"cc.ToggleContainerComponent"),j.WidgetComponent=Fj,gt.setClassAlias(Fj,"cc.WidgetComponent"),j.PageViewComponent=ul,gt.setClassAlias(ul,"cc.PageViewComponent"),j.PageViewIndicatorComponent=Bc,gt.setClassAlias(Bc,"cc.PageViewIndicatorComponent"),j.SafeAreaComponent=EW,gt.setClassAlias(EW,"cc.SafeAreaComponent"),gt.setClassAlias(pF,"cc.UICoordinateTrackerComponent"),j.BlockInputEventsComponent=YD,gt.setClassAlias(YD,"cc.BlockInputEventsComponent"),(_l=BW=BW||{})[_l.positions=fa.ATTR_POSITION]="positions",_l[_l.normals=fa.ATTR_NORMAL]="normals",_l[_l.uvs=fa.ATTR_TEX_COORD]="uvs",_l[_l.colors=fa.ATTR_COLOR]="colors";(Nw=QW.prototype).setNextAlignment=function(e){var t;0!==e&&0!=(t=this._length%e)&&(this._arrayBufferOrPaddings.push(e=e-t),this._length+=e)},Nw.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},Nw.getLength=function(){return this._length},Nw.getCombined=function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer};var FW,zW,UW=QW,kW=(KW.prototype.createInstance=function(){for(var e,n=this,t=this._mesh.struct.primitives.length,r=new Array(t),i=0;i<t;++i)r[i]=null!=(e=null==(e=this._subMeshRenderings[i])?void 0:e.createInstance())?e:null;return{setWeights:function(e,t){null!=(e=r[e])&&e.setWeights(t)},requiredPatches:function(e){n._mesh.struct.morph;var t=n._mesh.struct.morph.subMeshMorphs[e],e=r[e];if(null===e)return null;var i=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:t.targets.length}];return t.attributes.includes(fa.ATTR_POSITION)&&i.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),t.attributes.includes(fa.ATTR_NORMAL)&&i.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),t.attributes.includes(fa.ATTR_TANGENT)&&i.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),i.push.apply(i,e.requiredPatches()),i},adaptPipelineState:function(e,t){null!=(e=r[e])&&e.adaptPipelineState(t)},destroy:function(){for(var e=ge(r);!(t=e()).done;){var t=t.value;null!=t&&t.destroy()}}}},KW),GW=((pte=YW.prototype).destroy=function(){for(var e,t=ge(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},pte.createInstance=function(){var r=this,o=new jW(this._gfxDevice,this._subMeshMorph.targets.length);return o.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),o.setVerticesCount(this._verticesCount),o.commit(),{setWeights:function(e){o.setWeights(e),o.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(e){for(var t=ge(r._attributes);!(i=t()).done;){var i=i.value,n=void 0;switch(i.name){case fa.ATTR_POSITION:n=$g;break;case fa.ATTR_NORMAL:n=ev;break;case fa.ATTR_TANGENT:n=tv;break;default:V("Unexpected attribute!")}void 0!==n&&(e.bindSampler(n,i.morphTexture.sampler),e.bindTexture(n,i.morphTexture.texture))}e.bindBuffer(Hg.BINDING,o.buffer),e.update()},destroy:function(){}}},YW),HW=(XW.prototype.createInstance=function(){return new VW(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},e(XW,[{key:"data",get:function(){return this._attributes}}]),XW),VW=((pi=qW.prototype).setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var i=this._attributes[t],n=i.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)n[4*l+0]=a[3*l+0]*s,n[4*l+1]=a[3*l+1]*s,n[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)n[4*u+0]+=a[3*u+0]*s,n[4*u+1]+=a[3*u+1]*s,n[4*u+2]+=a[3*u+2]*s}i.morphTexture.updatePixels()}},pi.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},pi.adaptPipelineState=function(e){for(var t=ge(this._attributes);!(i=t()).done;){var i=i.value,n=void 0;switch(i.attributeName){case fa.ATTR_POSITION:n=$g;break;case fa.ATTR_NORMAL:n=ev;break;case fa.ATTR_TANGENT:n=tv;break;default:V("Unexpected attribute!")}void 0!==n&&(e.bindSampler(n,i.morphTexture.sampler),e.bindTexture(n,i.morphTexture.texture))}e.bindBuffer(Hg.BINDING,this._morphUniforms.buffer),e.update()},pi.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},qW),jW=((tl=WW.prototype).destroy=function(){this._remoteBuffer.destroy()},tl.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Hg.OFFSET_OF_WEIGHTS+4*t,e[t],j.sys.isLittleEndian)},tl.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(Hg.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,j.sys.isLittleEndian),this._localBuffer.setFloat32(Hg.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,j.sys.isLittleEndian)},tl.setVerticesCount=function(e){this._localBuffer.setFloat32(Hg.OFFSET_OF_VERTICES_COUNT,e,j.sys.isLittleEndian)},tl.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},e(WW,[{key:"buffer",get:function(){return this._remoteBuffer}}]),WW);function WW(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(Hg.SIZE)),this._remoteBuffer=e.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Hg.SIZE,Hg.SIZE))}function qW(e,t,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new jW(i,0);var n=ZW(i,t);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map(function(e){var t=n.create();return{attributeName:e.name,morphTexture:t}})}function XW(i,e,t,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;var r=t.subMeshMorphs[e];JW(i,e,n),this._attributes=r.attributes.map(function(e,t){return{name:e,targets:r.targets.map(function(e){return{displacements:new Float32Array(i.data.buffer,i.data.byteOffset+e.displacements[t].offset,e.displacements[t].count)}})}})}function YW(s,e,t,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var n=t.subMeshMorphs[e],c=(this._subMeshMorph=n,JW(s,e,i),s.struct.vertexBundles[s.struct.primitives[e].vertexBundelIndices[0]].view.count),t=(this._verticesCount=c,n.targets.length),r=ZW(i,c*t);this._textureInfo={width:r.width,height:r.height},this._attributes=n.attributes.map(function(e,o){var t=r.create(),a=t.valueView;return n.targets.forEach(function(e,t){for(var e=e.displacements[o],i=new Float32Array(s.data.buffer,s.data.byteOffset+e.offset,e.count),n=c*t*4,r=0;r<c;++r)a[n+4*r]=i[3*r+0],a[n+4*r+1]=i[3*r+1],a[n+4*r+2]=i[3*r+2]}),t.updatePixels(),{name:e,morphTexture:t}})}function KW(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var n=0;n<i;++n){var r=this._mesh.struct.morph.subMeshMorphs[n];r&&(r.targets.length>Hg.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[n]=new HW(this._mesh,n,this._mesh.struct.morph,t):this._subMeshRenderings[n]=new GW(this._mesh,n,this._mesh.struct.morph,t))}}}function QW(){this._arrayBufferOrPaddings=[],this._length=0}function ZW(o,e){var t,a,s,i,c=o.hasFeature(Po.TEXTURE_FLOAT)?(t=e,s=16,a=i0.PixelFormat.RGBA32F,Float32Array):(t=4*e,s=4,a=i0.PixelFormat.RGBA8888,Uint8Array),e=(e=mn(vn(t<5?5:t)),i=e>>1,{width:1<<(1&e?1+i:i),height:1<<i}),l=e.width,u=e.height;return{width:l,height:u,create:function(){var e=new ArrayBuffer(l*u*s),t=new Float32Array(e),i=c===Float32Array?t:new c(e),e=new Lv({width:l,height:u,_data:i,_compressed:!1,format:a}),n=new i0,r=(n.setFilters(i0.Filter.NEAREST,i0.Filter.NEAREST),n.setMipFilter(i0.Filter.NONE),n.setWrapMode(i0.WrapMode.CLAMP_TO_EDGE,i0.WrapMode.CLAMP_TO_EDGE,i0.WrapMode.CLAMP_TO_EDGE),n.image=e,n.getGFXTexture()||V("Unexpected: failed to create morph texture?"),o.getSampler(n.getSamplerInfo()));return{get texture(){return n.getGFXTexture()},get sampler(){return r},get valueView(){return t},destroy:function(){n.destroy()},updatePixels:function(){n.uploadData(i)}}}}}function JW(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}function $W(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var e6,t6=new ce,i6=new ce,n6=new Uint8Array,r6=f("cc.Mesh")((l(o6,e6=P_),(Sa=o6.prototype).onLoaded=function(){this.initialize()},Sa.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=j.director.root.device,i=this._createVertexBuffers(t,e),n=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,u=c.length;if(4===l&&!t.hasFeature(Po.ELEMENT_INDEX_UINT)){var h=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(65536<=h){J(10001,h,65536);continue}l>>=1,u>>=1}a=t.createBuffer(new Ia(Do.INDEX,No.DEVICE,u,l)),s=new($W(c.stride))(e,c.offset,c.count),c.stride!==l&&(s=$W(l).from(s)),a.update(s)}var h=o.vertexBundelIndices.map(function(e){return i[e]}),p=[];if(0<o.vertexBundelIndices.length)for(var u=o.vertexBundelIndices[0],_=this._struct.vertexBundles[u].attributes,f=0;f<_.length;++f){var d=_[f];p[f]=new Wa(d.name,d.format,d.isNormalized,d.stream,d.isInstanced,d.location)}c=new yE(h,p,o.primitiveMode,a);c.mesh=this,c.subMeshIdx=r,n.push(c)}}this._renderingSubMeshes=n,this._struct.morph&&(this.morphRendering=new kW(this,t))}},Sa.destroy=function(){return this.destroyRenderingMesh(),e6.prototype.destroy.call(this)},Sa.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},Sa.assign=function(e,t){this.reset({struct:e,data:t})},Sa.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},Sa.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var i=[],n=e.bindposes,r=0;r<n.length;r++)t.push(new qh(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,fa.ATTR_JOINTS),c=this.readAttribute(a,fa.ATTR_WEIGHTS),l=this.readAttribute(a,fa.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){ce.set(t6,l[3*h+0],l[3*h+1],l[3*h+2]);for(var p=0;p<4;++p){var _=4*h+p,f=s[_];0===c[_]||f>=n.length||(ce.transformMat4(i6,t6,n[f]),i[f]=!0,_=t[f],ce.min(_.center,_.center,i6),ce.max(_.halfExtents,_.halfExtents,i6))}}}for(var d=0;d<n.length;d++){var m=t[d];i[d]?qh.fromPoints(m,m.center,m.halfExtents):t[d]=null}return t},Sa.merge=function(e,t,i){if(i&&!this.validateMergingMesh(e))return!1;var n=new ce,r=t&&new gr,i=t&&new qh;if(r&&t.getRotation(r),!this._initialized){var o=JSON.parse(JSON.stringify(e._struct)),B=e._data.slice();if(t){o.maxPosition&&o.minPosition&&(ce.add(i.center,o.maxPosition,o.minPosition),ce.multiplyScalar(i.center,i.center,.5),ce.subtract(i.halfExtents,o.maxPosition,o.minPosition),ce.multiplyScalar(i.halfExtents,i.halfExtents,.5),qh.transform(i,i,t),ce.add(o.maxPosition,i.center,i.halfExtents),ce.subtract(o.minPosition,i.center,i.halfExtents));for(var a=0;a<o.vertexBundles.length;a++)for(var s=o.vertexBundles[a],c=0;c<s.attributes.length;c++)if(s.attributes[c].name===fa.ATTR_POSITION||s.attributes[c].name===fa.ATTR_NORMAL){var l=s.attributes[c].format,F=new DataView(B.buffer,s.view.offset+a6(s.attributes,c)),u=l6(F,l),h=u6(F,l);if(!u||!h)continue;for(var z=s.view.count,U=s.view.stride,k=c6(l),p=0;p<z;p++){var _=p*U,f=_+k,G=f+k;switch(n.set(u(_),u(f),u(G)),s.attributes[c].name){case fa.ATTR_POSITION:n.transformMat4(t);break;case fa.ATTR_NORMAL:ce.transformQuat(n,n,r)}h(_,n.x),h(f,n.y),h(G,n.z)}}}return this.reset({struct:o,data:B}),this.initialize(),!0}for(var H,V,d=new UW,m=0,g=0,j=0,v=0,y=0,W=!1,q=new Array(this._struct.vertexBundles.length),x=0;x<this._struct.vertexBundles.length;++x){var S=this._struct.vertexBundles[x],b=e._struct.vertexBundles[x],m=S.view.offset,g=b.view.offset,X=S.view.stride,Y=S.view.count+b.view.count,T=new ArrayBuffer(Y*X),E=new Uint8Array(T);m+=(H=this._data.subarray(m,m+S.view.length)).length,g+=(V=e._data.subarray(g,g+b.view.length)).length,E.set(H);for(var K,j=0,Q=ge(S.attributes);!(K=Q()).done;){for(var C=K.value,y=0,W=!1,Z=ge(b.attributes);!(w=Z()).done;){var w=w.value;if(C.name===w.name&&C.format===w.format){W=!0;break}y+=dc[w.format].size}if(W)for(var J=dc[C.format].size,v=S.view.length+j,$=0;$<b.view.count;++$){if(A=V.subarray(y,y+J),E.set(A,v),(C.name===fa.ATTR_POSITION||C.name===fa.ATTR_NORMAL)&&t){var A=new Float32Array(E.buffer,v,3);switch(n.set(A[0],A[1],A[2]),C.name){case fa.ATTR_POSITION:n.transformMat4(t);break;case fa.ATTR_NORMAL:ce.transformQuat(n,n,r)}A[0]=n.x,A[1]=n.y,A[2]=n.z}v+=S.view.stride,y+=b.view.stride}j+=dc[C.format].size}q[x]={attributes:S.attributes,view:{offset:d.getLength(),length:T.byteLength,count:Y,stride:X}},d.addBuffer(T)}for(var P,ee=0,te=new Array(this._struct.primitives.length),I=0;I<this._struct.primitives.length;++I){var R=this._struct.primitives[I],D=e._struct.primitives[I];te[I]={primitiveMode:R.primitiveMode,vertexBundelIndices:R.vertexBundelIndices};for(var ie=ge(R.vertexBundelIndices);!(ne=ie()).done;)var ne=ne.value,ee=Math.max(ee,this._struct.vertexBundles[ne].view.count);if(R.indexView&&D.indexView){P=R.indexView.count,P+=D.indexView.count,m=R.indexView.offset,g=D.indexView.offset;var O=P<256?1:P<65536?2:4,re=new ArrayBuffer(P*O),oe=new(2==O?Uint16Array:1==O?Uint8Array:Uint32Array)(re),ae=new(2===R.indexView.stride?Uint16Array:1===R.indexView.stride?Uint8Array:Uint32Array)(this._data.buffer,m,R.indexView.count);if(O===R.indexView.stride)oe.set(ae);else for(var M=0;M<R.indexView.count;++M)oe[M]=ae[M];m+=R.indexView.length;for(var se=new(2===D.indexView.stride?Uint16Array:1===D.indexView.stride?Uint8Array:Uint32Array)(e._data.buffer,g,D.indexView.count),N=0;N<D.indexView.count;++N)oe[R.indexView.count+N]=ee+se[N];g+=D.indexView.length,te[I].indexView={offset:d.getLength(),length:re.byteLength,count:P,stride:O},d.setNextAlignment(O),d.addBuffer(re)}}var L={vertexBundles:q,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return L.minPosition&&e._struct.minPosition&&L.maxPosition&&e._struct.maxPosition&&(t?(ce.add(i.center,e._struct.maxPosition,e._struct.minPosition),ce.multiplyScalar(i.center,i.center,.5),ce.subtract(i.halfExtents,e._struct.maxPosition,e._struct.minPosition),ce.multiplyScalar(i.halfExtents,i.halfExtents,.5),qh.transform(i,i,t),ce.add(n,i.center,i.halfExtents),ce.max(L.maxPosition,L.maxPosition,n),ce.subtract(n,i.center,i.halfExtents),ce.min(L.minPosition,L.minPosition,n)):(ce.min(L.minPosition,L.minPosition,e._struct.minPosition),ce.max(L.maxPosition,L.maxPosition,e._struct.maxPosition))),this.reset({struct:L,data:new Uint8Array(d.getCombined())}),this.initialize(),!0},Sa.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},Sa.readAttribute=function(e,t){var p=this,_=null;return this._accessAttribute(e,t,function(e,t){var i=e.view.count,n=e.attributes[t].format,r=Ec(dc[n]);if(0!==i){var t=new DataView(p._data.buffer,e.view.offset+a6(e.attributes,t)),o=dc[n],a=l6(t,n);if(r&&a){for(var s=o.count,c=new r(i*s),l=e.view.stride,u=0;u<i;++u)for(var h=0;h<s;++h)c[s*u+h]=a(l*u+c.BYTES_PER_ELEMENT*h);_=c}}}),_},Sa.copyAttribute=function(e,t,d,m,g){var v=this,y=!1;return this._accessAttribute(e,t,function(e,t){var i=e.view.count;if(0!==i){var n=e.attributes[t].format,t=new DataView(v._data.buffer,e.view.offset+a6(e.attributes,t)),r=new DataView(d,g),o=dc[n],a=l6(t,n),s=u6(r,n);if(a&&s){for(var c=o.count,l=e.view.stride,u=c6(n),h=m,p=u,_=0;_<i;++_)for(var f=0;f<c;++f)s(h*_+p*f,a(l*_+u*f));y=!0}}else y=!0}),y},Sa.readIndices=function(e){if(e>=this._struct.primitives.length)return null;e=this._struct.primitives[e];if(!e.indexView)return null;var t=e.indexView.stride;return new(1===t?Uint8Array:2===t?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},Sa.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?W.R8UI:2===i.indexView.stride?W.R16UI:W.R32UI,o=l6(new DataView(this._data.buffer),r),a=0;a<n;++a)t[a]=o(i.indexView.offset+dc[r].size*a);return!0},Sa._accessAttribute=function(e,t,i){if(!(e>=this._struct.primitives.length))for(var n=ge(this._struct.primitives[e].vertexBundelIndices);!(r=n()).done;){var r=r.value,r=this._struct.vertexBundles[r],o=r.attributes.findIndex(function(e){return e.name===t});if(!(o<0)){i(r,o);break}}},Sa._createVertexBuffers=function(i,n){return this._struct.vertexBundles.map(function(e){var t=i.createBuffer(new Ia(Do.VERTEX,No.DEVICE,e.view.length,e.view.stride)),e=new Uint8Array(n,e.view.offset,e.view.length);return t.update(e),t})},Sa.initDefault=function(e){e6.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:n6})},e(o6,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=Gc(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices||(this._jointBufferIndices=this._struct.primitives.map(function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),FW=i((nl=o6).prototype,"_struct",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),zW=i(nl.prototype,"_hash",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E2=nl))||E2;function o6(){var e;return(e=e6.call(this)||this).morphRendering=null,_(e,"_struct",FW,p(e)),_(e,"_hash",zW,p(e)),e._data=n6,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}function a6(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=dc[r.format].size}return i}j.Mesh=r6;var s6=af.isLittleEndian;function c6(e){e=dc[e];return e.size/e.count}function l6(t,e){var e=dc[e],i=e.size/e.count;switch(e.type){case Io.UNORM:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,s6)};case 4:return function(e){return t.getUint32(e,s6)}}break;case Io.SNORM:case Io.INT:switch(i){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,s6)};case 4:return function(e){return t.getInt32(e,s6)}}break;case Io.UINT:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,s6)};case 4:return function(e){return t.getUint32(e,s6)}}break;case Io.FLOAT:return function(e){return t.getFloat32(e,s6)}}return null}function u6(i,e){var e=dc[e],t=e.size/e.count;switch(e.type){case Io.UNORM:switch(t){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,s6)};case 4:return function(e,t){return i.setUint32(e,t,s6)}}break;case Io.SNORM:case Io.INT:switch(t){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,s6)};case 4:return function(e,t){return i.setInt32(e,t,s6)}}break;case Io.UINT:switch(t){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,s6)};case 4:return function(e,t){return i.setUint32(e,t,s6)}}break;case Io.FLOAT:return function(e,t){return i.setFloat32(e,t,s6)}}return null}var h6=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_NORMAL,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RG32F),new Wa(fa.ATTR_TANGENT,W.RGBA32F),new Wa(fa.ATTR_COLOR,W.RGBA32F)],p6=new ce;function _6(e,t,i){i=i||{};var n=[],r=0,o=[],a=0,s=e.positions.slice();if(0<s.length){if(_=null,e.attributes)for(var c=ge(e.attributes);!(l=c()).done;){var l=l.value;if(l.name===fa.ATTR_POSITION){_=l;break}}n.push(_=_||h6[0]);var u=dc[_.format],a=Math.max(a,Math.floor(s.length/u.count));o.push({offset:r,data:s,attribute:_}),r+=u.size}if(e.normals&&0<e.normals.length){if(_=null,e.attributes)for(var h=ge(e.attributes);!(p=h()).done;){var p=p.value;if(p.name===fa.ATTR_NORMAL){_=p;break}}var _,u=dc[(_=_||h6[1]).format];n.push(_),a=Math.max(a,Math.floor(e.normals.length/u.count)),o.push({offset:r,data:e.normals,attribute:_}),r+=u.size}if(e.uvs&&0<e.uvs.length){if(_=null,e.attributes)for(var f=ge(e.attributes);!(d=f()).done;){var d=d.value;if(d.name===fa.ATTR_TEX_COORD){_=d;break}}u=dc[(_=_||h6[2]).format];n.push(_),a=Math.max(a,Math.floor(e.uvs.length/u.count)),o.push({offset:r,data:e.uvs,attribute:_}),r+=u.size}if(e.tangents&&0<e.tangents.length){if(_=null,e.attributes)for(var m=ge(e.attributes);!(g=m()).done;){var g=g.value;if(g.name===fa.ATTR_TANGENT){_=g;break}}u=dc[(_=_||h6[3]).format];n.push(_),a=Math.max(a,Math.floor(e.tangents.length/u.count)),o.push({offset:r,data:e.tangents,attribute:_}),r+=u.size}if(e.colors&&0<e.colors.length){if(_=null,e.attributes)for(var v=ge(e.attributes);!(y=v()).done;){var y=y.value;if(y.name===fa.ATTR_COLOR){_=y;break}}u=dc[(_=_||h6[4]).format];n.push(_),a=Math.max(a,Math.floor(e.colors.length/u.count)),o.push({offset:r,data:e.colors,attribute:_}),r+=u.size}if(e.customAttributes)for(var x=ge(e.customAttributes);!(S=x()).done;){var S=S.value,b=dc[S.attr.format];n.push(S.attr),a=Math.max(a,Math.floor(S.values.length/b.count)),o.push({offset:r,data:S.values,attribute:S.attr}),r+=b.size}for(var u=new UW,T=new ArrayBuffer(a*r),E=new DataView(T),C=0,w=o;C<w.length;C++){var A=w[C];fE(E,A.data,A.attribute.format,A.offset,r)}u.setNextAlignment(0);var P={attributes:n,view:{offset:u.getLength(),length:T.byteLength,count:a,stride:r}},T=(u.addBuffer(T),null),I=0,R=(e.indices&&(I=(R=e.indices).length,T=new ArrayBuffer(2*I),fE(new DataView(T),R,W.R16UI)),{primitiveMode:e.primitiveMode||$o.TRIANGLE_LIST,vertexBundelIndices:[0]});if(T&&(u.setNextAlignment(2),R.indexView={offset:u.getLength(),length:T.byteLength,count:I,stride:2},u.addBuffer(T)),!(D=e.minPos)&&i.calculateBounds)for(var D=ce.set(new ce,1/0,1/0,1/0),O=0;O<a;++O)ce.set(p6,s[3*O+0],s[3*O+1],s[3*O+2]),ce.min(D,D,p6);if(!(M=e.maxPos)&&i.calculateBounds)for(var M=ce.set(new ce,-1/0,-1/0,-1/0),N=0;N<a;++N)ce.set(p6,s[3*N+0],s[3*N+1],s[3*N+2]),ce.max(M,M,p6);I={vertexBundles:[P],primitives:[R]};return D&&(I.minPosition=new ce(D.x,D.y,D.z)),M&&(I.maxPosition=new ce(M.x,M.y,M.z)),(t=t||new r6).reset({struct:I,data:new Uint8Array(u.getCombined())}),t}var f6,d6,m6,g6,v6,y6,x6,S6,b6,T6,E6,C6,w6,A6,P6,I6,R6,D6,O6,M6,N6,L6=Object.freeze({__proto__:null,find:Ww,toPPM:function(e,t,i){return"P3 "+t+" "+i+" 255\n"+e.filter(function(e,t){return t%4<3}).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var i={positions:[]},n=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),r=e.struct,e=r.primitives[t],o=ge(e.vertexBundelIndices);!(a=o()).done;)for(var a=a.value,a=r.vertexBundles[a],s=a.view.offset,c=a.view,l=c.length,u=c.stride,h=ge(a.attributes);!(p=h()).done;){var p=p.value,_=BW[p.name];_&&(i[_]=(i[_]||[]).concat(dE(n,p.format,s,l,u))),s+=dc[p.format].size}t=e.indexView;return i.indices=dE(n,W["R"+8*t.stride+"UI"],t.offset,t.length),i},createMesh:_6,readBuffer:dE,writeBuffer:fE,mapBuffer:mE}),c=(XN=f("cc.Billboard"),y=wp(),fie=Ep(),xH=v(i0),aie=v(i0),die=u(),vie=u(),Cp=u(),Iie=u(),Pc=XN(Nk=y(Nk=fie(Nk=Tp((l(W6,N6=W_),(Rie=W6.prototype).onLoad=function(){this.createModel()},Rie.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},Rie.onDisable=function(){this.detachFromScene()},Rie.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},Rie.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},Rie.createModel=function(){this._mesh=_6({primitiveMode:$o.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[nr.WHITE.r,nr.WHITE.g,nr.WHITE.b,nr.WHITE.a,nr.WHITE.r,nr.WHITE.g,nr.WHITE.b,nr.WHITE.a,nr.WHITE.r,nr.WHITE.g,nr.WHITE.b,nr.WHITE.a,nr.WHITE.r,nr.WHITE.g,nr.WHITE.b,nr.WHITE.a],attributes:[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RG32F),new Wa(fa.ATTR_COLOR,W.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=j.director.root.createModel($0,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new Ey,this._material.copy(D0.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},e(W6,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*Gn(this._rotation))/100},set:function(e){this._rotation=e*On,this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),f6=i((yU=W6).prototype,"_texture",[xH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(yU.prototype,"texture",[aie,die],Object.getOwnPropertyDescriptor(yU.prototype,"texture"),yU.prototype),d6=i(yU.prototype,"_height",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(yU.prototype,"height",[vie],Object.getOwnPropertyDescriptor(yU.prototype,"height"),yU.prototype),m6=i(yU.prototype,"_width",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(yU.prototype,"width",[Cp],Object.getOwnPropertyDescriptor(yU.prototype,"width"),yU.prototype),g6=i(yU.prototype,"_rotation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(yU.prototype,"rotation",[Iie],Object.getOwnPropertyDescriptor(yU.prototype,"rotation"),yU.prototype),Nk=yU))||Nk)||Nk)||Nk)||Nk,Rre({Billboard:Pc,BillboardComponent:Pc}),Pc),B6=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RGBA32F),new Wa(fa.ATTR_TEX_COORD1,W.RGB32F),new Wa(fa.ATTR_COLOR,W.RGBA8,!0)],F6=new ce,z6=new ce,U6=(l(j6,M6=$0),(x=j6.prototype).setCapacity=function(e){this._capacity=e,this.createBuffer()},x.createBuffer=function(){this._vertSize=0;for(var e=ge(B6);!(t=e()).done;){var t=t.value;t.offset=this._vertSize,this._vertSize+=dc[t.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},x.updateMaterial=function(e){this._material=e,M6.prototype.setSubModelMaterial.call(this,0,e)},x.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var o=2*r;i[n++]=o,i[n++]=1+o,i[n++]=2+o,i[n++]=3+o,i[n++]=2+o,i[n++]=1+o}var a=this._device.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new yE([e],B6,$o.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},x.addLineVertexData=function(e,t,i){if(1<e.length){var n=0;ce.subtract(F6,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=F6.x,this._vdataF32[n++]=F6.y,this._vdataF32[n++]=F6.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=F6.x,this._vdataF32[n++]=F6.y,this._vdataF32[n++]=F6.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){ce.subtract(F6,e[r-1],e[r]),ce.subtract(z6,e[r+1],e[r]),ce.subtract(z6,z6,F6);var o=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(o,1),this._vdataF32[n++]=o,this._vdataF32[n++]=0,this._vdataF32[n++]=z6.x,this._vdataF32[n++]=z6.y,this._vdataF32[n++]=z6.z,this._vdataUint32[n++]=i.evaluate(o,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(o,1),this._vdataF32[n++]=o,this._vdataF32[n++]=1,this._vdataF32[n++]=z6.x,this._vdataF32[n++]=z6.y,this._vdataF32[n++]=z6.z,this._vdataUint32[n++]=i.evaluate(o,1)._val}ce.subtract(F6,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=F6.x,this._vdataF32[n++]=F6.y,this._vdataF32[n++]=F6.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=F6.x,this._vdataF32[n++]=F6.y,this._vdataF32[n++]=F6.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))},x.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},x.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},j6),k6=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],G6=Ot({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),H6=Rre("CurveRange",(A=f("cc.CurveRange"),r=v(G6),vI=v(im),ll=v(im),o=v(im),A(((I=V6.prototype).evaluate=function(e,t){switch(this.mode){default:case G6.Constant:return this.constant;case G6.Curve:return this.spline.evaluate(e)*this.multiplier;case G6.TwoCurves:return Un(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case G6.TwoConstants:return Un(this.constantMin,this.constantMax,t)}},I.getMax=function(){switch(this.mode){default:case G6.Constant:return this.constant;case G6.Curve:return this.multiplier;case G6.TwoConstants:return this.constantMax;case G6.TwoCurves:return this.multiplier}},I._onBeforeSerialize=function(){return k6[this.mode]},e(V6,[{key:"curve",get:function(){return this._curve},set:function(e){this._curve=e,this.spline=e._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(e){this._curveMin=e,this.splineMin=e._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(e){this._curveMax=e,this.splineMax=e._internalCurve}}]),V6.Mode=G6,v6=i((R=V6).prototype,"mode",[r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G6.Constant}}),y6=i(R.prototype,"spline",[vI],{configurable:!0,enumerable:!0,writable:!0,initializer:ng}),x6=i(R.prototype,"splineMin",[ll],{configurable:!0,enumerable:!0,writable:!0,initializer:ng}),S6=i(R.prototype,"splineMax",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:ng}),b6=i(R.prototype,"constant",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T6=i(R.prototype,"constantMin",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E6=i(R.prototype,"constantMax",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C6=i(R.prototype,"multiplier",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rl=R))||rl));function V6(){_(this,"mode",v6,this),_(this,"spline",y6,this),_(this,"splineMin",x6,this),_(this,"splineMax",S6,this),_(this,"constant",b6,this),_(this,"constantMin",T6,this),_(this,"constantMax",E6,this),_(this,"multiplier",C6,this),this._curve=new Jm(this.spline),this._curveMin=new Jm(this.splineMin),this._curveMax=new Jm(this.splineMax)}function j6(){var e;return(e=M6.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=V0.LINE,e._capacity=100,e._iaInfo=new Ma([new Da]),e._iaInfoBuffer=e._device.createBuffer(new Ia(Do.INDIRECT,No.DEVICE,28,28)),e}function W6(){var e;return _(e=N6.call(this)||this,"_texture",f6,p(e)),_(e,"_height",d6,p(e)),_(e,"_width",m6,p(e)),_(e,"_rotation",g6,p(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new Fr(1,1,0,0),e}function q6(e,t,i){switch(e.mode){case G6.Constant:return e.constant;case G6.Curve:return e.spline.evaluate(t)*e.multiplier;case G6.TwoCurves:return 0===i?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case G6.TwoConstants:return 0===i?e.constantMin:e.constantMax;default:return 0}}function X6(e){switch(e.mode){case G6.TwoConstants:case G6.TwoCurves:return 2;default:return 1}}function Y6(e,t,i){t=new Lv({width:t,height:i,_data:e,_compressed:!1,format:pv.RGBA32F}),i=new i0;return i.setFilters(fv.NEAREST,fv.NEAREST),i.setMipFilter(fv.NONE),i.setWrapMode(_v.CLAMP_TO_EDGE,_v.CLAMP_TO_EDGE,_v.CLAMP_TO_EDGE),i.image=t,i}function K6(e,t,i,n,r){for(var o=Math.max(X6(t),X6(i),X6(n)),a=new Float32Array(e*o*4),s=[t,i,n],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],p=0,_=0;_<e;_++){var f=q6(h,c*_,l),f=r?f:(p+=f)/(_+1);a[4*_+u]=f}return Y6(a,e,o)}var Q6,Z6,J6,$6,e8,t8,i8,n8,r8,o8,a8,s8,c8,l8,u8=Ot({Blend:0,Fixed:1}),h8=(Rre("ColorKey",f("cc.ColorKey")((w6=i((kp=function(){_(this,"color",w6,this),_(this,"time",A6,this)}).prototype,"color",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),A6=i(kp.prototype,"time",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b=kp))||b),Rre("AlphaKey",f("cc.AlphaKey")((P6=i((uI=function(){_(this,"alpha",P6,this),_(this,"time",I6,this)}).prototype,"alpha",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),I6=i(uI.prototype,"time",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xp=uI))||Xp),Rre("Gradient",f("cc.Gradient")(((cM=d8.prototype).setKeys=function(e,t){this.colorKeys=e,this.alphaKeys=t},cM.sortKeys=function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})},cM.evaluate=function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color},cM.randomColor=function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color},cM.getRGB=function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(nr.WHITE),this._color;e=Kn(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(i<=e&&e<n)return this.mode===u8.Fixed?this.colorKeys[t].color:(nr.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,(e-i)/(n-i)),this._color)}var r=this.colorKeys.length-1;e<this.colorKeys[0].time?nr.lerp(this._color,nr.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[r].time&&nr.lerp(this._color,this.colorKeys[r].color,nr.BLACK,(e-this.colorKeys[r].time)/(1-this.colorKeys[r].time))},cM.getAlpha=function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Kn(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(i<=e&&e<n)return this.mode===u8.Fixed?this.alphaKeys[t].alpha:Un(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,(e-i)/(n-i))}var r=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?Un(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[r].time?Un(this.alphaKeys[r].alpha,0,(e-this.alphaKeys[r].time)/(1-this.alphaKeys[r].time)):void 0},d8.Mode=u8,R6=i((yI=d8).prototype,"colorKeys",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),D6=i(yI.prototype,"alphaKeys",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),O6=i(yI.prototype,"mode",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return u8.Blend}}),C7=yI))||C7)),p8=Ot({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),_8=Rre("GradientRange",(ane=f("cc.GradientRange"),C=v(p8),Lc=v(h8),a=v(h8),s=v(h8),W3=v(p8),ane(((dU=f8.prototype).evaluate=function(e,t){switch(this._mode){case p8.Color:return this.color;case p8.TwoColors:return nr.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case p8.RandomColor:return this.gradient.randomColor();case p8.Gradient:return this.gradient.evaluate(e);case p8.TwoGradients:return nr.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}},dU._onBeforeSerialize=function(){return(!1)[this._mode]},e(f8,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),f8.Mode=p8,i((Ac=f8).prototype,"mode",[C],Object.getOwnPropertyDescriptor(Ac.prototype,"mode"),Ac.prototype),Q6=i(Ac.prototype,"color",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),Z6=i(Ac.prototype,"colorMin",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),J6=i(Ac.prototype,"colorMax",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),$6=i(Ac.prototype,"gradient",[Lc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h8}}),e8=i(Ac.prototype,"gradientMin",[a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h8}}),t8=i(Ac.prototype,"gradientMax",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h8}}),i8=i(Ac.prototype,"_mode",[W3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p8.Color}}),Ce=Ac))||Ce));function f8(){_(this,"color",Q6,this),_(this,"colorMin",Z6,this),_(this,"colorMax",J6,this),_(this,"gradient",$6,this),_(this,"gradientMin",e8,this),_(this,"gradientMax",t8,this),_(this,"_mode",i8,this),this._color=nr.WHITE.clone()}function d8(){_(this,"colorKeys",R6,this),_(this,"alphaKeys",D6,this),_(this,"mode",O6,this),this._color=void 0,this._color=nr.WHITE.clone()}var m8,g8={parent:null,owner:null,subModelIdx:0},v8={CC_USE_WORLD_SPACE:!1},YD=(h=f("cc.Line"),P=wp(),Y3=Ep(),B1=v(i0),il=v(i0),bne=m(),Op=u(),Mp=m(),Hd=u(),Up=v([ce]),Z5=v([ce]),E=m(),Mne=u(),kd=v(H6),Qp=v(H6),Bp=Dp(),S=m(),Gd=u(),n=v(U),hl=m(),g=u(),ba=v(U),bp=m(),Aw=u(),w=v(_8),kw=v(_8),zp=m(),t=u(),pF=h(EW=P(EW=Y3(EW=Tp((l(S8,m8=W_),(ul=S8.prototype).onLoad=function(){var e=this._model=j.director.root.createModel(U6);e.node=e.transform=this.node,null===this._material&&(this._material=new Ey,this._material.copy(D0.get("default-trail-material")),v8.CC_USE_WORLD_SPACE=this.worldSpace,g8.parent=this._material,g8.subModelIdx=0,this._materialInstance=new Hy(g8),g8.parent=null,g8.subModelIdx=0,this._materialInstance.recompileShaders(v8)),e.updateMaterial(this._materialInstance),e.setCapacity(100)},ul.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},ul.onDisable=function(){this._model&&this._detachFromScene()},ul._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},ul._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e(S8,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&(v8.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(v8),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),n8=i((Bc=S8).prototype,"_texture",[B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(Bc.prototype,"texture",[il,bne,Op],Object.getOwnPropertyDescriptor(Bc.prototype,"texture"),Bc.prototype),r8=i(Bc.prototype,"_worldSpace",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(Bc.prototype,"worldSpace",[Mp,Hd],Object.getOwnPropertyDescriptor(Bc.prototype,"worldSpace"),Bc.prototype),o8=i(Bc.prototype,"_positions",[Up],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),i(Bc.prototype,"positions",[Z5,E,Mne],Object.getOwnPropertyDescriptor(Bc.prototype,"positions"),Bc.prototype),a8=i(Bc.prototype,"_width",[kd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),i(Bc.prototype,"width",[Qp,Bp,S,Gd],Object.getOwnPropertyDescriptor(Bc.prototype,"width"),Bc.prototype),s8=i(Bc.prototype,"_tile",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(1,1)}}),i(Bc.prototype,"tile",[n,hl,g],Object.getOwnPropertyDescriptor(Bc.prototype,"tile"),Bc.prototype),c8=i(Bc.prototype,"_offset",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(0,0)}}),i(Bc.prototype,"offset",[ba,bp,Aw],Object.getOwnPropertyDescriptor(Bc.prototype,"offset"),Bc.prototype),l8=i(Bc.prototype,"_color",[w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _8}}),i(Bc.prototype,"color",[kw,zp,t],Object.getOwnPropertyDescriptor(Bc.prototype,"color"),Bc.prototype),EW=Bc))||EW)||EW)||EW)||EW,Rre({Line:pF,LineComponent:pF}),pF),y8=(x8.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},x8);function x8(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new ce(0,0,0),this.velocity=new ce(0,0,0),this.animatedVelocity=new ce(0,0,0),this.ultimateVelocity=new ce(0,0,0),this.angularVelocity=new ce(0,0,0),this.axisOfRotation=new ce(0,0,0),this.rotation=new ce(0,0,0),this.startEuler=new ce(0,0,0),this.startRotation=new gr,this.startRotated=!1,this.deltaQuat=new gr,this.deltaMat=new B,this.localMat=new B,this.startSize=new ce(0,0,0),this.size=new ce(0,0,0),this.startColor=nr.WHITE.clone(),this.color=nr.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}function S8(){var e;return _(e=m8.call(this)||this,"_texture",n8,p(e)),e._material=null,e._materialInstance=null,_(e,"_worldSpace",r8,p(e)),_(e,"_positions",o8,p(e)),_(e,"_width",a8,p(e)),_(e,"_tile",s8,p(e)),_(e,"_offset",c8,p(e)),_(e,"_color",l8,p(e)),e._model=null,e._tile_offset=new Fr,e}y8.INDENTIFY_NEG_QUAT=10,y8.R2D=180/Math.PI;var b8,T8,E8,C8,w8,A8,P8,I8,R8=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],D8=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],Nw=((_l=V8.prototype).bindTarget=function(e){this.target=e},_l.update=function(){},V8),O8=Ot({World:0,Local:1,Custom:2}),M8=Ot({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),N8=Ot({World:0,Local:1,View:2}),L8=Ot({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),B8=Ot({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),F8=Ot({Base:0,Edge:1,Shell:2,Volume:3}),z8=Ot({Random:0,Loop:1,PingPong:2}),U8=Ot({Particles:0}),k8=Ot({Stretch:0}),XN=(pte=f("cc.ColorOvertimeModule"),pi=m(),tl=v(_8),Sa=m(),pte((l(H8,I8=Nw),H8.prototype.animate=function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,Wn(e.randomSeed+91041)))},e(H8,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),b8=i((nl=H8).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(nl.prototype,"enable",[pi],Object.getOwnPropertyDescriptor(nl.prototype,"enable"),nl.prototype),T8=i(nl.prototype,"color",[tl,d,Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _8}}),E2=nl))||E2),G8=new ce(0,0,-1);function H8(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=I8.call.apply(I8,[this].concat(i))||this,"_enable",b8,p(e)),_(e,"color",T8,p(e)),e.name="colorModule",e}function V8(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}function j8(e,t,i,n){return t!==e?(e!==O8.World&&B.invert(i,i),B.getRotation(n,i),!0):(gr.set(n,0,0,0,1),!1)}function W8(e,t){U.set(e,Math.cos(t),Math.sin(t))}function q8(e){var t=Vn(-1,1),i=Vn(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),n=n*Math.sin(i);ce.set(e,r,n,t)}function X8(e,t,i){q8(e),ce.multiplyScalar(e,e,t+(i-t)*Hn())}function Y8(e,t,i,n){W8(e,n),e.z=0,ce.multiplyScalar(e,e,t+(i-t)*Hn())}function K8(e){for(var t=0;t<e.length;t++){var i=t+jn(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function Q8(){var e=Vn(-1,1);return 0===e&&e++,dn(e)}var Z8,J8,$8,eq,tq,iq,nq,rq,oq,aq,sq,cq,lq,uq,hq,pq=new ce,rl=(y=f("cc.ForceOvertimeModule"),fie=m(),Rie=v(H6),xH=Dp(),aie=m(),die=u(),vie=v(H6),Cp=Dp(),Iie=m(),yU=u(),Nk=v(H6),Pc=Dp(),x=m(),A=u(),I=v(O8),r=m(),vI=u(),y((l(mq,hq=Nw),(ll=mq.prototype).update=function(e,t){this.needTransform=j8(e,this.space,t,this.rotation)},ll.animate=function(e,t){var i=1-e.remainingLifetime/e.startLifetime,i=ce.set(pq,this.x.evaluate(i,Wn(e.randomSeed+212165)),this.y.evaluate(i,Wn(e.randomSeed+212165)),this.z.evaluate(i,Wn(e.randomSeed+212165)));this.needTransform&&ce.transformQuat(i,i,this.rotation),ce.scaleAndAdd(e.velocity,e.velocity,i,t),ce.copy(e.ultimateVelocity,e.velocity)},e(mq,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),E8=i((o=mq).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(o.prototype,"enable",[fie],Object.getOwnPropertyDescriptor(o.prototype,"enable"),o.prototype),C8=i(o.prototype,"x",[Rie,d,xH,aie,die],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),w8=i(o.prototype,"y",[vie,d,Cp,Iie,yU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),A8=i(o.prototype,"z",[Nk,d,Pc,x,A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),P8=i(o.prototype,"space",[I,d,r,vI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O8.Local}}),R=o))||R),_q=new ce,fq=new ce,E=(kp=f("cc.LimitVelocityOvertimeModule"),b=m(),uI=v(H6),Xp=Dp(),cM=m(),yI=u(),C7=v(H6),ane=Dp(),dU=m(),C=u(),Lc=v(H6),a=Dp(),s=m(),W3=u(),Ac=v(H6),Ce=Dp(),h=m(),P=u(),Y3=m(),ul=u(),B1=m(),il=u(),bne=v(O8),Op=m(),Mp=u(),kp((l(dq,uq=Nw),(Hd=dq.prototype).update=function(e,t){this.needTransform=j8(e,this.space,t,this.rotation)},Hd.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,i=_q;this.separateAxes?(ce.set(fq,this.limitX.evaluate(t,Wn(e.randomSeed+23541)),this.limitY.evaluate(t,Wn(e.randomSeed+23541)),this.limitZ.evaluate(t,Wn(e.randomSeed+23541))),this.needTransform&&ce.transformQuat(fq,fq,this.rotation),ce.set(i,gq(e.ultimateVelocity.x,fq.x,this.dampen),gq(e.ultimateVelocity.y,fq.y,this.dampen),gq(e.ultimateVelocity.z,fq.z,this.dampen))):(ce.normalize(i,e.ultimateVelocity),ce.multiplyScalar(i,i,gq(e.ultimateVelocity.length(),this.limit.evaluate(t,Wn(e.randomSeed+23541)),this.dampen))),ce.copy(e.ultimateVelocity,i)},e(dq,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),Z8=i((Up=dq).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(Up.prototype,"enable",[b],Object.getOwnPropertyDescriptor(Up.prototype,"enable"),Up.prototype),J8=i(Up.prototype,"limitX",[uI,d,Xp,cM,yI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),$8=i(Up.prototype,"limitY",[C7,d,ane,dU,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),eq=i(Up.prototype,"limitZ",[Lc,d,a,s,W3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),tq=i(Up.prototype,"limit",[Ac,d,Ce,h,P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),iq=i(Up.prototype,"dampen",[d,Y3,ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),nq=i(Up.prototype,"separateAxes",[d,B1,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rq=i(Up.prototype,"space",[bne,d,Op,Mp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O8.Local}}),Z5=Up))||Z5);function dq(){var e;return _(e=uq.call(this)||this,"_enable",Z8,p(e)),_(e,"limitX",J8,p(e)),_(e,"limitY",$8,p(e)),_(e,"limitZ",eq,p(e)),_(e,"limit",tq,p(e)),_(e,"dampen",iq,p(e)),_(e,"separateAxes",nq,p(e)),_(e,"space",rq,p(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new gr,e.needTransform=!1,e.needUpdate=!0,e}function mq(){var e;return _(e=hq.call(this)||this,"_enable",E8,p(e)),_(e,"x",C8,p(e)),_(e,"y",w8,p(e)),_(e,"z",A8,p(e)),_(e,"space",P8,p(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new gr,e.needTransform=!1,e.needUpdate=!0,e}function gq(e,t,i){var n=Math.sign(e),e=Math.abs(e);return(e=t<e?Un(e,t,i):e)*n}Mne=f("cc.RotationOvertimeModule"),kd=m(),Qp=m(),Bp=u(),S=v(H6),Gd=Dp(),n=m(),hl=u(),g=v(H6),ba=Dp(),bp=m(),Aw=u(),w=v(H6),kw=Dp(),zp=m(),t=u();var vq,yq,xq,Sq,bq,Tq,Eq,Cq,wq,Aq,Pq,Iq,Rq,Dq,Oq,Mq,Nq,Lq,Bq,Fq,zq,Uq,kq,Gq,Hq,Vq,jq,Wq,qq,Xq,Yq,Kq,Qq,Zq,Jq,$q,eX,tX,iX,nX,rX,oX,aX,sX,cX,lX,uX,hX,pX,_X,fX,dX,_l=Mne((l(AX,dX=Nw),(Bc=AX.prototype)._processRotation=function(e){e=e.particleSystem.processor.getInfo().renderMode;e!==L8.Mesh&&e===L8.StrecthedBillboard&&this._quatRot.set(0,0,0,1),gr.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=y8.INDENTIFY_NEG_QUAT)},Bc.animate=function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Wn(e.randomSeed+125292),r=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==L8.VerticalBillboard&&r!==L8.HorizontalBillboard?gr.fromEuler(e.deltaQuat,this.x.evaluate(i,n)*t*y8.R2D,this.y.evaluate(i,n)*t*y8.R2D,this.z.evaluate(i,n)*t*y8.R2D):gr.fromEuler(e.deltaQuat,0,0,this.z.evaluate(i,n)*t*y8.R2D),e.deltaMat=B.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),e.startRotated||(r!==L8.Mesh&&(r===L8.StrecthedBillboard?e.startEuler.set(0,0,0):r!==L8.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),gr.fromEuler(e.startRotation,e.startEuler.x*y8.R2D,e.startEuler.y*y8.R2D,e.startEuler.z*y8.R2D),e.startRotated=!0),this._startMat=B.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),B.getRotation(this._quatRot,this._matRot),this._processRotation(e,y8.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},e(AX,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),oq=i((EW=AX).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(EW.prototype,"enable",[kd],Object.getOwnPropertyDescriptor(EW.prototype,"enable"),EW.prototype),aq=i(EW.prototype,"_separateAxes",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(EW.prototype,"separateAxes",[Qp,Bp],Object.getOwnPropertyDescriptor(EW.prototype,"separateAxes"),EW.prototype),sq=i(EW.prototype,"x",[S,d,Gd,Lp,n,hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),cq=i(EW.prototype,"y",[g,d,ba,Lp,bp,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),lq=i(EW.prototype,"z",[w,d,kw,Lp,zp,t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),pF=EW))||pF,r=(pte=f("cc.SizeOvertimeModule"),pi=m(),tl=m(),Sa=u(),nl=v(H6),E2=Dp(),y=m(),ll=u(),fie=v(H6),Rie=Dp(),xH=m(),aie=u(),die=v(H6),vie=Dp(),Cp=m(),Iie=u(),yU=v(H6),Nk=Dp(),Pc=m(),x=u(),pte((l(wX,fX=Nw),wX.prototype.animate=function(e){var t,i;this.separateAxes?(t=1-e.remainingLifetime/e.startLifetime,i=Wn(e.randomSeed+39825),e.size.x=e.startSize.x*this.x.evaluate(t,i),e.size.y=e.startSize.y*this.y.evaluate(t,i),e.size.z=e.startSize.z*this.z.evaluate(t,i)):ce.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,Wn(e.randomSeed+39825)))},e(wX,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),vq=i((A=wX).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(A.prototype,"enable",[pi],Object.getOwnPropertyDescriptor(A.prototype,"enable"),A.prototype),yq=i(A.prototype,"separateAxes",[d,tl,Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xq=i(A.prototype,"size",[nl,d,E2,y,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Sq=i(A.prototype,"x",[fie,d,Rie,xH,aie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),bq=i(A.prototype,"y",[die,d,vie,Cp,Iie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Tq=i(A.prototype,"z",[yU,d,Nk,Pc,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),I=A))||I),mX=Ot({Grid:0}),gX=Ot({WholeSheet:0,SingleRow:1}),Bc=(vI=f("cc.TextureAnimationModule"),o=yp("numTilesX"),R=yp("numTilesY"),kp=m(),Hd=v(mX),b=v(mX),uI=m(),Xp=u(),cM=m(),yI=u(),C7=m(),ane=u(),dU=v(gX),C=m(),Lc=u(),a=v(H6),s=Dp(),W3=m(),Ac=u(),Ce=v(H6),h=Dp(),P=m(),Y3=u(),ul=m(),B1=u(),il=m(),bne=u(),Op=m(),Mp=u(),vI((l(CX,_X=Nw),(Up=CX.prototype).init=function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)},Up.animate=function(e){var t,i,n,r=1-e.remainingLifetime/e.startLifetime,o=this.startFrame.evaluate(r,Wn(e.randomSeed+90794))/(this.numTilesX*this.numTilesY);this.animation===gX.WholeSheet?e.frameIndex=Kn(this.cycleCount*(this.frameOverTime.evaluate(r,Wn(e.randomSeed+90794))+o),1):this.animation===gX.SingleRow&&(t=1/this.numTilesY,this.randomRow?(i=Kn(this.cycleCount*(this.frameOverTime.evaluate(r,Wn(e.randomSeed+90794))+o),1),n=e.startRow*t,e.frameIndex=Un(n,n+t,i)):(n=this.rowIndex*t,e.frameIndex=Un(n,n+t,Kn(this.cycleCount*(this.frameOverTime.evaluate(r,Wn(e.randomSeed+90794))+o),1))))},e(CX,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e!==mX.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),Eq=i((Z5=CX).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cq=i(Z5.prototype,"_numTilesX",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wq=i(Z5.prototype,"_numTilesY",[R],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(Z5.prototype,"enable",[kp],Object.getOwnPropertyDescriptor(Z5.prototype,"enable"),Z5.prototype),Aq=i(Z5.prototype,"_mode",[Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mX.Grid}}),i(Z5.prototype,"mode",[b,uI,Xp],Object.getOwnPropertyDescriptor(Z5.prototype,"mode"),Z5.prototype),i(Z5.prototype,"numTilesX",[cM,yI],Object.getOwnPropertyDescriptor(Z5.prototype,"numTilesX"),Z5.prototype),i(Z5.prototype,"numTilesY",[C7,ane],Object.getOwnPropertyDescriptor(Z5.prototype,"numTilesY"),Z5.prototype),Pq=i(Z5.prototype,"animation",[dU,d,C,Lc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gX.WholeSheet}}),Iq=i(Z5.prototype,"frameOverTime",[a,d,s,W3,Ac],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Rq=i(Z5.prototype,"startFrame",[Ce,d,h,P,Y3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Dq=i(Z5.prototype,"cycleCount",[d,ul,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oq=i(Z5.prototype,"_flipU",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mq=i(Z5.prototype,"_flipV",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nq=i(Z5.prototype,"_uvChannelMask",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Lq=i(Z5.prototype,"randomRow",[d,il,bne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bq=i(Z5.prototype,"rowIndex",[d,Op,Mp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mne=Z5))||Mne),vX=new ce,ll=(kd=f("cc.VelocityOvertimeModule"),Qp=m(),Bp=v(H6),S=Dp(),Gd=m(),n=u(),hl=v(H6),g=Dp(),ba=m(),bp=u(),Aw=v(H6),w=Dp(),kw=m(),zp=u(),t=v(H6),EW=Dp(),pF=m(),pte=u(),pi=v(O8),tl=m(),Sa=u(),kd((l(EX,pX=Nw),(nl=EX.prototype).update=function(e,t){this.needTransform=j8(e,this.space,t,this.rotation)},nl.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,t=ce.set(vX,this.x.evaluate(t,Wn(197866^e.randomSeed)),this.y.evaluate(t,Wn(156497^e.randomSeed)),this.z.evaluate(t,Wn(984136^e.randomSeed)));this.needTransform&&ce.transformQuat(t,t,this.rotation),ce.add(e.animatedVelocity,e.animatedVelocity,t),ce.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),ce.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,Wn(e.randomSeed+197866)))},e(EX,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),Fq=i((E2=EX).prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(E2.prototype,"enable",[Qp],Object.getOwnPropertyDescriptor(E2.prototype,"enable"),E2.prototype),zq=i(E2.prototype,"x",[Bp,d,S,Gd,n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Uq=i(E2.prototype,"y",[hl,d,g,ba,bp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),kq=i(E2.prototype,"z",[Aw,d,w,kw,zp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Gq=i(E2.prototype,"speedModifier",[t,d,EW,pF,pte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Hq=i(E2.prototype,"space",[pi,d,tl,Sa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O8.Local}}),y=E2))||y),Cp=Rre("Burst",(fie=f("cc.Burst"),Rie=v(H6),xH=Dp(),fie(((aie=TX.prototype).update=function(e,t){var i,n;0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount&&(i=0<(i=Kn(e._time-e.startDelay.evaluate(0,1),e.duration)-t)?i:0,n=Kn(e.time-e.startDelay.evaluate(0,1),e.duration),this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount))},aie.reset=function(){this._remainingCount=0,this._curTime=0},aie.getMaxCount=function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)},e(TX,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),Vq=i((die=TX).prototype,"_time",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(die.prototype,"time",[Ap],Object.getOwnPropertyDescriptor(die.prototype,"time"),die.prototype),jq=i(die.prototype,"_repeatCount",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i(die.prototype,"repeatCount",[Ap],Object.getOwnPropertyDescriptor(die.prototype,"repeatCount"),die.prototype),Wq=i(die.prototype,"repeatInterval",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qq=i(die.prototype,"count",[Rie,d,xH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),vie=die))||vie)),yX=new ce(0,0,0),xX=[],SX=new ce(.5,.5,.5),bp=(Iie=f("cc.ShapeModule"),yU=m(),Nk=u(),Pc=m(),x=u(),A=m(),I=u(),vI=m(),Up=u(),o=m(),R=u(),kp=m(),Hd=v(B8),b=yp("shapeType"),uI=m(),Xp=v(B8),cM=u(),yI=v(F8),C7=m(),ane=u(),dU=m(),C=u(),Lc=m(),a=u(),s=m(),W3=u(),Ac=m(),Ce=u(),h=m(),P=u(),Y3=m(),ul=u(),B1=v(z8),il=m(),bne=u(),Op=Pp(),Mp=m(),Z5=u(),Mne=v(H6),kd=Pp(),Nw=Dp(),nl=m(),Qp=u(),Bp=m(),S=u(),Gd=m(),n=u(),Iie((i(((hl=bX.prototype).onInit=function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time},hl.emit=function(e){switch(this.shapeType){case B8.Box:var t,i=this.emitFrom,n=this.boxThickness,r=e.position,o=e.velocity;switch(i){case F8.Volume:ce.set(r,Vn(-(t=SX).x,t.x),Vn(-t.y,t.y),Vn(-t.z,t.z));break;case F8.Shell:xX.splice(0,xX.length),xX.push(Vn(-.5,.5)),xX.push(Vn(-.5,.5)),xX.push(.5*Q8()),K8(xX),PX(xX,n),ce.set(r,xX[0],xX[1],xX[2]);break;case F8.Edge:xX.splice(0,xX.length),xX.push(Vn(-.5,.5)),xX.push(.5*Q8()),xX.push(.5*Q8()),K8(xX),PX(xX,n),ce.set(r,xX[0],xX[1],xX[2]);break;default:console.warn(i+" is not supported for box emitter.")}ce.copy(o,G8);break;case B8.Circle:o=this.radius,E=this.radiusThickness,C=this.generateArcAngle(),w=e.position,A=e.velocity,Y8(w,o*(1-E),o,C),ce.normalize(A,w);break;case B8.Cone:var a=this.emitFrom,s=this.radius,c=this.radiusThickness,l=this.generateArcAngle(),u=this._angle,h=this.length,p=e.position,_=e.velocity;switch(a){case F8.Base:Y8(p,s*(1-c),s,l),U.multiplyScalar(_,p,Math.sin(u)),_.z=-Math.cos(u)*s,ce.normalize(_,_),p.z=0;break;case F8.Shell:W8(p,l),U.multiplyScalar(_,p,Math.sin(u)),_.z=-Math.cos(u),ce.normalize(_,_),U.multiplyScalar(p,p,s),p.z=0;break;case F8.Volume:Y8(p,s*(1-c),s,l),U.multiplyScalar(_,p,Math.sin(u)),_.z=-Math.cos(u)*s,ce.normalize(_,_),p.z=0,ce.add(p,p,ce.multiplyScalar(yX,_,h*Hn()/-_.z));break;default:console.warn(a+" is not supported for cone emitter.")}break;case B8.Sphere:var f=this.emitFrom,d=this.radius,m=this.radiusThickness,g=e.position,v=e.velocity;switch(f){case F8.Volume:X8(g,d*(1-m),d),ce.normalize(v,g);break;case F8.Shell:q8(g),ce.multiplyScalar(g,g,d),ce.normalize(v,g);break;default:console.warn(f+" is not supported for sphere emitter.")}break;case B8.Hemisphere:var y=this.emitFrom,x=this.radius,S=this.radiusThickness,b=e.position,T=e.velocity;switch(y){case F8.Volume:X8(b,x*(1-S),x),0<b.z&&(b.z*=-1),ce.normalize(T,b);break;case F8.Shell:q8(b),ce.multiplyScalar(b,b,x),0<b.z&&(b.z*=-1),ce.normalize(T,b);break;default:console.warn(y+" is not supported for hemisphere emitter.")}break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}var E,C,w,A,P;0<this.randomPositionAmount&&(e.position.x+=Vn(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=Vn(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=Vn(-this.randomPositionAmount,this.randomPositionAmount)),ce.transformQuat(e.velocity,e.velocity,this.quat),ce.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount&&(P=ce.normalize(yX,e.position),ce.lerp(e.velocity,e.velocity,P,this.sphericalDirectionAmount)),this.lastTime=this.particleSystem._time},hl.constructMat=function(){gr.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),B.fromRTS(this.mat,this.quat,this._position,this._scale)},hl.generateArcAngle=function(){if(this.arcMode===z8.Random)return Vn(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case z8.Loop:return Kn(e,this._arc);case z8.PingPong:return Qn(e,this._arc);default:return Kn(e,this._arc)}},e(bX,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return Gn(this._arc)},set:function(e){this._arc=e*On}},{key:"angle",get:function(){return Math.round(100*Gn(this._angle))/100},set:function(e){this._angle=e*On}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case B8.Box:this.emitFrom===F8.Base&&(this.emitFrom=F8.Volume);break;case B8.Cone:this.emitFrom===F8.Edge&&(this.emitFrom=F8.Base);break;case B8.Sphere:case B8.Hemisphere:this.emitFrom!==F8.Base&&this.emitFrom!==F8.Edge||(this.emitFrom=F8.Volume)}}}]),g=bX).prototype,"position",[yU,Nk],Object.getOwnPropertyDescriptor(g.prototype,"position"),g.prototype),i(g.prototype,"rotation",[Pc,x],Object.getOwnPropertyDescriptor(g.prototype,"rotation"),g.prototype),i(g.prototype,"scale",[A,I],Object.getOwnPropertyDescriptor(g.prototype,"scale"),g.prototype),i(g.prototype,"arc",[vI,Up],Object.getOwnPropertyDescriptor(g.prototype,"arc"),g.prototype),i(g.prototype,"angle",[o,R],Object.getOwnPropertyDescriptor(g.prototype,"angle"),g.prototype),Xq=i(g.prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(g.prototype,"enable",[kp],Object.getOwnPropertyDescriptor(g.prototype,"enable"),g.prototype),Yq=i(g.prototype,"_shapeType",[Hd,b,uI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B8.Cone}}),i(g.prototype,"shapeType",[Xp,cM],Object.getOwnPropertyDescriptor(g.prototype,"shapeType"),g.prototype),Kq=i(g.prototype,"emitFrom",[yI,d,C7,ane],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return F8.Volume}}),Qq=i(g.prototype,"alignToDirection",[d,dU,C],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zq=i(g.prototype,"randomDirectionAmount",[d,Lc,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jq=i(g.prototype,"sphericalDirectionAmount",[d,s,W3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$q=i(g.prototype,"randomPositionAmount",[d,Ac,Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eX=i(g.prototype,"radius",[d,h,P],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tX=i(g.prototype,"radiusThickness",[d,Y3,ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iX=i(g.prototype,"arcMode",[B1,d,il,bne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return z8.Random}}),nX=i(g.prototype,"arcSpread",[Op,d,Mp,Z5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rX=i(g.prototype,"arcSpeed",[Mne,kd,Nw,d,nl,Qp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),oX=i(g.prototype,"length",[d,Bp,S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),aX=i(g.prototype,"boxThickness",[d,Gd,n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(0,0,0)}}),sX=i(g.prototype,"_position",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(0,0,0)}}),cX=i(g.prototype,"_rotation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(0,0,0)}}),lX=i(g.prototype,"_scale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(1,1,1)}}),uX=i(g.prototype,"_arc",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 360*On}}),hX=i(g.prototype,"_angle",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 25*On}}),ba=g))||ba);function bX(){_(this,"_enable",Xq,this),_(this,"_shapeType",Yq,this),_(this,"emitFrom",Kq,this),_(this,"alignToDirection",Qq,this),_(this,"randomDirectionAmount",Zq,this),_(this,"sphericalDirectionAmount",Jq,this),_(this,"randomPositionAmount",$q,this),_(this,"radius",eX,this),_(this,"radiusThickness",tX,this),_(this,"arcMode",iX,this),_(this,"arcSpread",nX,this),_(this,"arcSpeed",rX,this),_(this,"length",oX,this),_(this,"boxThickness",aX,this),_(this,"_position",sX,this),_(this,"_rotation",cX,this),_(this,"_scale",lX,this),_(this,"_arc",uX,this),_(this,"_angle",hX,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new B,this.quat=new gr,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}function TX(){_(this,"_time",Vq,this),_(this,"_repeatCount",jq,this),_(this,"repeatInterval",Wq,this),_(this,"count",qq,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}function EX(){var e;return _(e=pX.call(this)||this,"_enable",Fq,p(e)),_(e,"x",zq,p(e)),_(e,"y",Uq,p(e)),_(e,"z",kq,p(e)),_(e,"speedModifier",Gq,p(e)),_(e,"space",Hq,p(e)),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new gr,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}function CX(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=_X.call.apply(_X,[this].concat(i))||this,"_enable",Eq,p(e)),_(e,"_numTilesX",Cq,p(e)),_(e,"_numTilesY",wq,p(e)),_(e,"_mode",Aq,p(e)),_(e,"animation",Pq,p(e)),_(e,"frameOverTime",Iq,p(e)),_(e,"startFrame",Rq,p(e)),_(e,"cycleCount",Dq,p(e)),_(e,"_flipU",Oq,p(e)),_(e,"_flipV",Mq,p(e)),_(e,"_uvChannelMask",Nq,p(e)),_(e,"randomRow",Lq,p(e)),_(e,"rowIndex",Bq,p(e)),e.name="textureModule",e}function wX(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=fX.call.apply(fX,[this].concat(i))||this,"_enable",vq,p(e)),_(e,"separateAxes",yq,p(e)),_(e,"size",xq,p(e)),_(e,"x",Sq,p(e)),_(e,"y",bq,p(e)),_(e,"z",Tq,p(e)),e.name="sizeModule",e}function AX(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=dX.call.apply(dX,[this].concat(i))||this,"_enable",oq,p(e)),_(e,"_separateAxes",aq,p(e)),_(e,"x",sq,p(e)),_(e,"y",cq,p(e)),_(e,"z",lq,p(e)),e.name="rotationModule",e._startMat=new B,e._matRot=new B,e._quatRot=new gr,e._otherEuler=new ce,e}function PX(e,t){0<t.x&&(e[0]+=.5*Vn(-t.x,t.x),e[0]=Fn(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*Vn(-t.y,t.y),e[1]=Fn(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*Vn(-t.z,t.z),e[2]=Fn(e[2],-.5,.5))}l(ZX,jX=$0),(Aw=ZX.prototype).getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):jX.prototype.getMacroPatches.call(this,e)},Aw.initSubModel=function(e,t,i){return jX.prototype.initSubModel.call(this,e,t,this._launderMaterial(i))},Aw.destroy=function(){jX.prototype.destroy.call(this),this._morphRenderingInstance=null},Aw.setSubModelMaterial=function(e,t){return jX.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(t))},Aw._updateLocalDescriptors=function(e,t){jX.prototype._updateLocalDescriptors.call(this,e,t),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,t)},Aw._launderMaterial=function(e){return e},Aw.setMorphRendering=function(e){this._morphRenderingInstance=e};var IX,RX,DX,OX,MX,NX,LX,BX,FX,zX,UX,kX,GX,HX,VX,jX,WX=ZX,qX=Ot({OFF:0,ON:1}),XX=Ot({OFF:0,ON:1}),YX=(w=f("cc.ModelLightmapSettings"),kw=yp("_recieveShadow"),w((e(QX,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),IX=i((zp=QX).prototype,"texture",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RX=i(zp.prototype,"uvParam",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fr}}),DX=i(zp.prototype,"_bakeable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),OX=i(zp.prototype,"_castShadow",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MX=i(zp.prototype,"_receiveShadow",[kw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NX=i(zp.prototype,"_lightmapSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),i(zp.prototype,"bakeable",[Ap],Object.getOwnPropertyDescriptor(zp.prototype,"bakeable"),zp.prototype),i(zp.prototype,"castShadow",[Ap],Object.getOwnPropertyDescriptor(zp.prototype,"castShadow"),zp.prototype),i(zp.prototype,"receiveShadow",[Ap],Object.getOwnPropertyDescriptor(zp.prototype,"receiveShadow"),zp.prototype),i(zp.prototype,"lightmapSize",[Ap],Object.getOwnPropertyDescriptor(zp.prototype,"lightmapSize"),zp.prototype),t=zp))||t),yU=(EW=f("cc.MeshRenderer"),pF=wp(),pte=Oa(100),pi=Ep(),tl=v(qX),Sa=u(),E2=v(XX),y=u(),fie=v(r6),aie=u(),Rie=Pp(),EW(hl=pF(hl=pte(hl=pi(hl=Tp((l(KX,VX=ND),(xH=KX.prototype).onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},xH.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},xH.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},xH.onDisable=function(){this._model&&this._detachFromScene()},xH.onDestroy=function(){this._model&&(j.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},xH.getWeight=function(e,t){this._subMeshShapesWeights.length;e=this._subMeshShapesWeights[e];return e.length,e[t]},xH.setWeights=function(e,t){var i=this._subMeshShapesWeights;t>=i.length||i[t].length===e.length&&(i[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},xH.setWeight=function(e,t,i){var n=this._subMeshShapesWeights;t>=n.length||(i>=(n=n[t]).length||(n[i]=e,this._uploadSubMeshShapesWeights(t)))},xH.setInstancedAttribute=function(e,t){if(this.model)for(var i=this.model.instancedAttributes,n=i.attributes,r=i.views,o=0;o<n.length;o++)if(n[o].name===e){r[o].set(t);break}},xH._updateLightmap=function(e,t,i,n,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},xH._updateModels=function(){var e;this.enabledInHierarchy&&this._mesh&&((e=this._model)?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap()))},xH._createModel=function(){var e=this._morphInstance&&this._modelType===$0?WX:this._modelType,e=this._model=j.director.root.createModel(e);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof WX&&e.setMorphRendering(this._morphInstance)},xH._attachToScene=function(){var e;this.node.scene&&this._model&&(e=this._getRenderScene(),null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model))},xH._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},xH._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Q0.POSITION,this._model.transform.hasChangedFlags|=Q0.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var n=this.getRenderMaterial(i),r=(n&&!n.isValid&&(n=null),t[i]);r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.enabled=!0}},xH._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},xH._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},xH._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},xH._onMeshChanged=function(){},xH._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},xH._getBuiltinMaterial=function(){return D0.get("missing-material")},xH._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},xH._updateCastShadow=function(){this._model&&(this._shadowCastingMode===qX.OFF?this._model.castShadow=!1:(this._shadowCastingMode,qX.ON,this._shadowCastingMode,this._model.castShadow=!0))},xH._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===XX.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},xH._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i)if(t.passes[i].batchingScheme)return!0}return!1},xH._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof WX&&this._model.setMorphRendering(this._morphInstance)}},xH._initSubMeshShapesWeights=function(){var t,e=this._mesh;this._subMeshShapesWeights.length=0,e&&(e=e.struct.morph)&&(t=e.weights,this._subMeshShapesWeights=e.subMeshMorphs.map(function(e){return e?e.weights?e.weights.slice(0):t?(t.length,e.targets.length,t.slice(0)):new Array(e.targets.length).fill(0):[]}))},xH._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var i=e.struct.morph;return i.subMeshMorphs.length===t.length&&t.every(function(e,t){e=e.length;return(null!=(t=null==(t=i.subMeshMorphs[t])?void 0:t.targets.length)?t:0)===e})},xH._uploadSubMeshShapesWeights=function(e){var t;null!=(t=this._morphInstance)&&t.setWeights(e,this._subMeshShapesWeights[e])},e(KX,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,e=this._mesh=e;null!=e&&e.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),vie=die=KX,die.ShadowCastingMode=qX,die.ShadowReceivingMode=XX,LX=i((Iie=vie).prototype,"lightmapSettings",[d,Ap,Fp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new YX}}),BX=i(Iie.prototype,"_mesh",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FX=i(Iie.prototype,"_shadowCastingMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qX.OFF}}),zX=i(Iie.prototype,"_shadowReceivingMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XX.ON}}),i(Iie.prototype,"shadowCastingMode",[tl,Sa,Fp],Object.getOwnPropertyDescriptor(Iie.prototype,"shadowCastingMode"),Iie.prototype),i(Iie.prototype,"receiveShadow",[E2,y,Fp],Object.getOwnPropertyDescriptor(Iie.prototype,"receiveShadow"),Iie.prototype),i(Iie.prototype,"mesh",[fie,aie],Object.getOwnPropertyDescriptor(Iie.prototype,"mesh"),Iie.prototype),i(Iie.prototype,"enableMorph",[Rie,Fp],Object.getOwnPropertyDescriptor(Iie.prototype,"enableMorph"),Iie.prototype),UX=i(Iie.prototype,"_enableMorph",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hl=Iie))||hl)||hl)||hl)||hl)||hl);function KX(){var e;return _(e=VX.call(this)||this,"lightmapSettings",LX,p(e)),_(e,"_mesh",BX,p(e)),_(e,"_shadowCastingMode",FX,p(e)),_(e,"_shadowReceivingMode",zX,p(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,_(e,"_enableMorph",UX,p(e)),e._modelType=$0,e}function QX(){_(this,"texture",IX,this),_(this,"uvParam",RX,this),_(this,"_bakeable",DX,this),_(this,"_castShadow",OX,this),_(this,"_receiveShadow",MX,this),_(this,"_lightmapSize",NX,this)}function ZX(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=jX.call.apply(jX,[this].concat(i))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}In(r6.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),Ee(r6.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);Nk=f("cc.Skeleton"),Pc=v([ui]),x=v([B]);var JX,$X,eY,tY,iY,nY,rY,oY,aY,sY=Nk((l(cY,aY=P_),(A=cY.prototype).destroy=function(){var e;return null!=(e=null==(e=j.director.root)?void 0:e.dataPoolManager)&&e.releaseSkeleton(this),aY.prototype.destroy.call(this)},A.validate=function(){return 0<this.joints.length&&0<this.bindposes.length},e(cY,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new B;B.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var i=this._bindposes[t];e+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=Gc(e,666)}return this._hash}}]),kX=i((I=cY).prototype,"_joints",[Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GX=i(I.prototype,"_bindposes",[x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HX=i(I.prototype,"_hash",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vI=I))||vI;function cY(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=aY.call.apply(aY,[this].concat(i))||this,"_joints",kX,p(e)),_(e,"_bindposes",GX,p(e)),_(e,"_hash",HX,p(e)),e._invBindposes=null,e}j.Skeleton=sY,Ee(yU.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),j.ModelComponent=yU,gt.setClassAlias(yU,"cc.ModelComponent");var lY,uY,hY,pY,_Y,fY,dY,mY,gY,vY,yY,xY,SY,bY,TY,EY,CY,wY=Ot({LUMINOUS_FLUX:0,LUMINANCE:1}),AY=new ce,PY=f("cc.StaticLightSettings")((e(MY,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),JX=i((Up=MY).prototype,"_baked",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$X=i(Up.prototype,"_editorOnly",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eY=i(Up.prototype,"_bakeable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tY=i(Up.prototype,"_castShadow",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(Up.prototype,"editorOnly",[Ap],Object.getOwnPropertyDescriptor(Up.prototype,"editorOnly"),Up.prototype),i(Up.prototype,"bakeable",[Ap],Object.getOwnPropertyDescriptor(Up.prototype,"bakeable"),Up.prototype),i(Up.prototype,"castShadow",[Ap],Object.getOwnPropertyDescriptor(Up.prototype,"castShadow"),Up.prototype),o=Up))||o,C=(R=f("cc.Light"),kp=u(),Hd=u(),b=Dp(),uI=u(),Xp=v(PY),R((l(OY,CY=W_),(cM=OY.prototype).onLoad=function(){this._createLight()},cM.onEnable=function(){this._attachToScene()},cM.onDisable=function(){this._detachFromScene()},cM.onDestroy=function(){this._destroyLight()},cM._createLight=function(){this._light||(this._light=j.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},cM._destroyLight=function(){this._light&&(j.director.root.destroyLight(this),this._light=null)},cM._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case Dy.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case Dy.SPHERE:e.addSphereLight(this._light);break;case Dy.SPOT:e.addSpotLight(this._light)}}},cM._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case Dy.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case Dy.SPHERE:e.removeSphereLight(this._light);break;case Dy.SPOT:e.removeSpotLight(this._light)}}},e(OY,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(AY.x=e.r/255,AY.y=e.g/255,AY.z=e.b/255,this._light.color=AY)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),C7=yI=OY,yI.Type=Dy,yI.PhotometricTerm=wY,iY=i((ane=C7).prototype,"_color",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nr.WHITE.clone()}}),nY=i(ane.prototype,"_useColorTemperature",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rY=i(ane.prototype,"_colorTemperature",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),oY=i(ane.prototype,"_staticSettings",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new PY}}),i(ane.prototype,"color",[kp],Object.getOwnPropertyDescriptor(ane.prototype,"color"),ane.prototype),i(ane.prototype,"useColorTemperature",[Hd],Object.getOwnPropertyDescriptor(ane.prototype,"useColorTemperature"),ane.prototype),i(ane.prototype,"colorTemperature",[Np,b,uI],Object.getOwnPropertyDescriptor(ane.prototype,"colorTemperature"),ane.prototype),i(ane.prototype,"staticSettings",[Xp],Object.getOwnPropertyDescriptor(ane.prototype,"staticSettings"),ane.prototype),dU=ane))||dU),P=(Lc=f("cc.DirectionalLight"),a=wp(),s=Ep(),W3=yp("_illuminance"),Ac=u(),Lc(h=a(h=s(h=Tp((l(DY,EY=C),DY.prototype._createLight=function(){EY.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*Tv.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},e(DY,[{key:"illuminance",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),lY=i((Ce=DY).prototype,"_illuminanceHDR",[gp,W3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),uY=i(Ce.prototype,"_illuminanceLDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i(Ce.prototype,"illuminance",[Ac],Object.getOwnPropertyDescriptor(Ce.prototype,"illuminance"),Ce.prototype),h=Ce))||h)||h)||h)||h),Qp=(Y3=f("cc.SphereLight"),ul=wp(),B1=Ep(),il=yp("_luminance"),bne=u(),Op=u(),Mp=v(wY),Z5=u(),Mne=u(),kd=u(),Y3(nl=ul(nl=B1(nl=Tp((l(RY,TY=C),RY.prototype._createLight=function(){TY.prototype._createLight.call(this),this.size=this._size,this.range=this._range,j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*Tv.standardExposureValue*Tv.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/Tv.standardExposureValue/Tv.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},e(RY,[{key:"luminousFlux",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*My(this._size):this._luminanceLDR},set:function(e){var t=0,t=j.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/My(this._size),this._luminanceHDR):(this._luminanceLDR=e,this._luminanceLDR);this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),hY=i((Nw=RY).prototype,"_size",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),pY=i(Nw.prototype,"_luminanceHDR",[d,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/My(.15)}}),_Y=i(Nw.prototype,"_luminanceLDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fY=i(Nw.prototype,"_term",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wY.LUMINOUS_FLUX}}),dY=i(Nw.prototype,"_range",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i(Nw.prototype,"luminousFlux",[bne],Object.getOwnPropertyDescriptor(Nw.prototype,"luminousFlux"),Nw.prototype),i(Nw.prototype,"luminance",[Op],Object.getOwnPropertyDescriptor(Nw.prototype,"luminance"),Nw.prototype),i(Nw.prototype,"term",[Mp,Z5],Object.getOwnPropertyDescriptor(Nw.prototype,"term"),Nw.prototype),i(Nw.prototype,"size",[Mne],Object.getOwnPropertyDescriptor(Nw.prototype,"size"),Nw.prototype),i(Nw.prototype,"range",[kd],Object.getOwnPropertyDescriptor(Nw.prototype,"range"),Nw.prototype),nl=Nw))||nl)||nl)||nl)||nl),pi=(Bp=f("cc.SpotLight"),S=wp(),Gd=Ep(),n=yp("_luminance"),g=u(),ba=u(),Aw=v(wY),w=u(),kw=u(),zp=u(),t=Dp(),EW=u(),Bp(pte=S(pte=Gd(pte=Tp((l(IY,bY=C),IY.prototype._createLight=function(){bY.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*Tv.standardExposureValue*Tv.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/Tv.standardExposureValue/Tv.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},e(IY,[{key:"luminousFlux",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*My(this._size):this._luminanceLDR},set:function(e){var t=0,t=j.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/My(this._size),this._luminanceHDR):(this._luminanceLDR=e,this._luminanceLDR);this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return j.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){j.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=e*On)}}]),mY=i((pF=IY).prototype,"_size",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),gY=i(pF.prototype,"_luminanceHDR",[d,n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/My(.15)}}),vY=i(pF.prototype,"_luminanceLDR",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yY=i(pF.prototype,"_term",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wY.LUMINOUS_FLUX}}),xY=i(pF.prototype,"_range",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SY=i(pF.prototype,"_spotAngle",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),i(pF.prototype,"luminousFlux",[g],Object.getOwnPropertyDescriptor(pF.prototype,"luminousFlux"),pF.prototype),i(pF.prototype,"luminance",[ba],Object.getOwnPropertyDescriptor(pF.prototype,"luminance"),pF.prototype),i(pF.prototype,"term",[Aw,w],Object.getOwnPropertyDescriptor(pF.prototype,"term"),pF.prototype),i(pF.prototype,"size",[kw],Object.getOwnPropertyDescriptor(pF.prototype,"size"),pF.prototype),i(pF.prototype,"range",[zp],Object.getOwnPropertyDescriptor(pF.prototype,"range"),pF.prototype),i(pF.prototype,"spotAngle",[Np,t,EW],Object.getOwnPropertyDescriptor(pF.prototype,"spotAngle"),pF.prototype),pte=pF))||pte)||pte)||pte)||pte);function IY(){var e;return _(e=bY.call(this)||this,"_size",mY,p(e)),_(e,"_luminanceHDR",gY,p(e)),_(e,"_luminanceLDR",vY,p(e)),_(e,"_term",yY,p(e)),_(e,"_range",xY,p(e)),_(e,"_spotAngle",SY,p(e)),e._type=Dy.SPOT,e._light=null,e._lightType=cx,e}function RY(){var e;return _(e=TY.call(this)||this,"_size",hY,p(e)),_(e,"_luminanceHDR",pY,p(e)),_(e,"_luminanceLDR",_Y,p(e)),_(e,"_term",fY,p(e)),_(e,"_range",dY,p(e)),e._type=Dy.SPHERE,e._light=null,e._lightType=tx,e}function DY(){var e;return _(e=EY.call(this)||this,"_illuminanceHDR",lY,p(e)),_(e,"_illuminanceLDR",uY,p(e)),e._type=Dy.DIRECTIONAL,e._light=null,e._lightType=ky,e}function OY(){var e;return _(e=CY.call(this)||this,"_color",iY,p(e)),_(e,"_useColorTemperature",nY,p(e)),_(e,"_colorTemperature",rY,p(e)),_(e,"_staticSettings",oY,p(e)),e._type=Dy.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=Fy,e}function MY(){_(this,"_baked",JX,this),_(this,"_editorOnly",$X,this),_(this,"_bakeable",eY,this),_(this,"_castShadow",tY,this)}j.LightComponent=C,gt.setClassAlias(C,"cc.LightComponent"),j.DirectionalLightComponent=P,gt.setClassAlias(P,"cc.DirectionalLightComponent"),j.SphereLightComponent=Qp,gt.setClassAlias(Qp,"cc.SphereLightComponent"),j.SpotLightComponent=pi,gt.setClassAlias(pi,"cc.SpotLightComponent"),In(pi.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),In(Qp.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),In(C.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);function NY(e,t,i){e[t+0]=i.m00,e[t+1]=i.m01,e[t+2]=i.m02,e[t+3]=i.m12,e[t+4]=i.m04,e[t+5]=i.m05,e[t+6]=i.m06,e[t+7]=i.m13,e[t+8]=i.m08,e[t+9]=i.m09,e[t+10]=i.m10,e[t+11]=i.m14}function LY(e,t){t=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*t,e)/12)}new gr,new gr,new ce,new gr,new ce;var BY=new La(ko.POINT,ko.POINT,ko.NONE,Go.CLAMP,Go.CLAMP,Go.CLAMP),FY=new ce,zY=new ce,UY=new ce,kY=new ce,GY=new B,HY=new B,VY=new qh,jY=Number.MAX_SAFE_INTEGER,WY=((xH=KY.prototype).clear=function(){this._pool.destroy(),this._textureBuffers.clear()},xH.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var i=e[t],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var o=i.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,n);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,n)}}},xH.getDefaultPoseTexture=function(e,t,i){var n=0^e.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(n),h=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!h)return r;r={pixelOffset:h.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:h},s=new Float32Array(u),c=!0}ce.set(UY,jY,jY,jY),ce.set(kY,-jY,-jY,-jY);for(var p=t.getBoneSpaceBounds(e),_=0,f=0;_<l;_++,f+=12){var d=i.getChildByPath(o[_]),m=d?WN(d,i,GY):e.inverseBindposes[_],g=p[_];g&&(qh.transform(VY,g,m),VY.getBoundary(FY,zY),ce.min(UY,UY,FY),ce.max(kY,kY,zY)),c&&(d&&B.multiply(m,m,a[_]),NY(s,f,d?m:B.IDENTITY))}h=[new qh];return r.bounds.set(t.hash,h),qh.fromPoints(h[0],UY,kY),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(n,r)),r},xH.getSequencePoseTexture=function(e,t,i,n){var r=e.hash^t.hash;if((p=this._textureBuffers.get(r)||null)&&p.bounds.has(i.hash))return p.refCount++,p;var o=e.joints,a=e.bindposes,s=dO.getOrExtract(t).frames,c=null,l=!1,u=o.length;if(p)p.refCount++;else{var o=12*u*s,h=this._chunkIdxMap.get(r),h=void 0!==h?this._customPool.alloc(o*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(o*Float32Array.BYTES_PER_ELEMENT);if(!h)return null;var n=this._createAnimInfos(e,t,n),p={pixelOffset:h.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:h,animInfos:n},c=new Float32Array(o),l=!0}var _=i.getBoneSpaceBounds(e),f=[];p.bounds.set(i.hash,f);for(var d=0;d<s;d++)f.push(new qh(jY,jY,jY,-jY,-jY,-jY));for(var m=0,g=0;m<s;m++){for(var v=f[m],y=0;y<u;y++,g+=12){var x=p.animInfos[y],S=x.curveData,b=x.downstream,T=x.bindposeIdx,x=x.bindposeCorrection,E=void 0,C=!0,S=(S&&b?E=B.multiply(GY,S[m],b):S?E=S[m]:b?E=b:(E=e.inverseBindposes[T],C=!1),_[y]);S&&(b=x?B.multiply(HY,E,x):E,qh.transform(VY,S,b),VY.getBoundary(FY,zY),ce.min(v.center,v.center,FY),ce.max(v.halfExtents,v.halfExtents,zY)),l&&(C&&B.multiply(GY,E,a[T]),NY(c,g,C?GY:B.IDENTITY))}qh.fromPoints(v,v.center,v.halfExtents)}return l&&(this._pool.update(p.handle,c.buffer),this._textureBuffers.set(r,p)),p},xH.releaseHandle=function(e){var t;0<e.refCount&&e.refCount--,!e.refCount&&e.readyToBeDeleted&&(t=e.skeletonHash^e.clipHash,(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t))},xH.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.skeletonHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}},xH.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.clipHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}},xH._createAnimInfos=function(e,t,i){for(var n=[],r=e.joints,o=e.bindposes,a=r.length,s=dO.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=i.getChildByPath(l),p=void 0,_=void 0;!u;){var f=l.lastIndexOf("/"),l=l.substring(0,f),u=s.joints[l];if(h?(p=p||new B,B.fromRTS(GY,h.rotation,h.position,h.scale),B.multiply(p,GY,p),h=h.parent):_=l,f<0)break}var d=c,m=void 0;if(void 0!==_&&u)for(var d=c-1,g=0;g<a;g++)if(r[g]===_){d=g,m=new B,B.multiply(m,o[g],e.inverseBindposes[c]);break}n.push({curveData:u&&u.transforms,downstream:p,bindposeIdx:d,bindposeCorrection:m})}return n},e(KY,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),KY),qY=((die=YY.prototype).getData=function(e){var t=this._pool.get(e=void 0===e?"-1":e);if(t)return t;var t=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,kg.SIZE,kg.SIZE)),i=new Float32Array([0,0,0,0]),t=(t.update(i),{buffer:t,data:i,dirty:!1});return this._setAnimInfoDirty(t,!1),this._pool.set(e,t),t},die.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},die._setAnimInfoDirty=function(e,t){e.dirty=t},die.switchClip=function(e){return e.data[0]=0,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},die.clear=function(){for(var e,t=ge(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},YY);function XY(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new WY(e),this.jointAnimationInfo=new qY(e)}function YY(e){this._pool=new Map,this._device=void 0,this._device=e}function KY(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=this._device.hasFeature(Po.TEXTURE_FLOAT)?W.RGBA32F:W.RGBA8;this._formatSize=dc[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new _x(e),this._pool.initialize({format:t,roundUpFn:LY}),this._customPool=new _x(e),this._customPool.initialize({format:t,roundUpFn:LY})}(vie=XY.prototype).releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},vie.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},vie.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},j.internal.DataPoolManager=XY;var QY=[{name:"CC_USE_SKINNING",value:!0}];var ZY,JY,$Y,e7,t7,i7,n7,r7,o7,a7,s7,c7,l7,u7,h7,p7=new ce,_7=new ce,f7=new ce,d7=new ce,m7=new B,g7=new qh,v7=(l(O7,h7=WX),(tl=O7.prototype)._init=function(){},tl.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}h7.prototype.destroy.call(this)},tl.bindSkeleton=function(e,t,i){void 0===e&&(e=null),void 0===t&&(t=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)kN(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&i){this.transform=t;var r=i.getBoneSpaceBounds(e),o=i.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=i.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=UN(c,t),u=e.bindposes[a],h=[],p=[];if(o){_=void 0;f=void 0;d=void 0;m=void 0;g=void 0;v=void 0;y=void 0;x=void 0;var _=h;var f=p;var d=o;var m=a;for(var g=0;g<d.length;g++){for(var v=d[g],y=-1,x=0;x<v.length;x++)if(v[x]===m){y=x;break}0<=y&&(f.push(g),_.push(y))}}else h.push(a),p.push(0);this._joints.push({indices:h,buffers:p,bound:s,target:c,bindpose:u,transform:l})}}}},tl.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),ce.set(p7,1/0,1/0,1/0),ce.set(_7,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,n=zN(n.transform,e);qh.transform(g7,r,n),g7.getBoundary(f7,d7),ce.min(p7,p7,f7),ce.max(_7,_7,d7)}var o=this._worldBounds;this._modelBounds&&o&&(qh.fromPoints(this._modelBounds,p7,_7),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},tl.updateUBOs=function(e){h7.prototype.updateUBOs.call(this,e);for(var t=0;t<this._joints.length;t++){var i=this._joints[t],n=i.indices,r=i.buffers,o=i.transform,i=i.bindpose;B.multiply(m7,o.world,i);for(var a=0;a<r.length;a++)NY(this._dataArray[r[a]],12*n[a],m7)}for(var s=0;s<this._buffers.length;s++)this._buffers[s].update(this._dataArray[s]);return!0},tl.initSubModel=function(e,t,i){var n=t.vertexBuffers,r=t.iaInfo;r.vertexBuffers=t.jointMappedBuffers,h7.prototype.initSubModel.call(this,e,t,i),r.vertexBuffers=n},tl.getMacroPatches=function(e){e=h7.prototype.getMacroPatches.call(this,e);return e?QY.concat(e):QY},tl._updateLocalDescriptors=function(e,t){h7.prototype._updateLocalDescriptors.call(this,e,t);e=this._buffers[this._bufferIndices[e]];e&&t.bindBuffer(Gg.BINDING,e)},tl._updateInstancedAttributes=function(e,t){t.batchingScheme!==I0.NONE&&J(3936,this.node.name),h7.prototype._updateInstancedAttributes.call(this,e,t)},tl._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.HOST|No.DEVICE,Gg.SIZE,Gg.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(Gg.COUNT))},O7),y7=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],x7=(l(D7,u7=WX),(Sa=D7.prototype)._init=function(){},Sa.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),u7.prototype.destroy.call(this)},Sa.bindSkeleton=function(e,t,i){void 0===t&&(t=null),void 0===i&&(i=null),this._skeleton=e=void 0===e?null:e,this._mesh=i,e&&t&&i&&(this.transform=t,e=this._dataPoolManager,this._jointsMedium.animInfo=e.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new Ia(Do.UNIFORM|Do.TRANSFER_DST,No.DEVICE,Ug.SIZE,Ug.SIZE))))},Sa.updateTransform=function(e){var t,i;u7.prototype.updateTransform.call(this,e),this.uploadedAnim&&(t=(e=this._jointsMedium).animInfo,e=e.boundsInfo[t.data[0]],(t=this._worldBounds)&&e&&(i=this.transform,e.transform(i._mat,i._pos,i._rot,i._scale,t)))},Sa.updateUBOs=function(e){u7.prototype.updateUBOs.call(this,e);var e=this._jointsMedium.animInfo,t=this._instAnimInfoIdx;return 0<=t?this.instancedAttributes.views[t][0]=e.data[0]:e.dirty&&(e.buffer.update(e.data),e.dirty=!1),!0},Sa._applyNativeJointMedium=function(){},Sa._updateModelBounds=function(e){this._modelBounds=e},Sa.uploadAnimation=function(e){var t,i;this._skeleton&&this._mesh&&this.uploadedAnim!==e&&(this.uploadedAnim=e,t=this._dataPoolManager,i=null,e?(i=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(i=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(i&&i.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(i),this._applyNativeJointMedium())},Sa._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e){var t=this._jointsMedium,i=t.buffer,t=t.jointTextureInfo;t[0]=e.handle.texture.width,t[1]=this._skeleton.joints.length,t[2]=e.pixelOffset+.1,t[3]=1/t[0],this.updateInstancedJointTextureInfo(),i&&i.update(t);for(var n=e.handle.texture,r=0;r<this._subModels.length;++r)this._subModels[r].descriptorSet.bindTexture(Jg,n)}},Sa.getMacroPatches=function(e){e=u7.prototype.getMacroPatches.call(this,e);return e?e.concat(y7):y7},Sa._updateLocalDescriptors=function(e,t){u7.prototype._updateLocalDescriptors.call(this,e,t);var e=this._jointsMedium,i=e.buffer,n=e.texture,e=e.animInfo;t.bindBuffer(Ug.BINDING,i),t.bindBuffer(kg.BINDING,e.buffer),n&&(i=this._device.getSampler(BY),t.bindTexture(Jg,n.handle.texture),t.bindSampler(Jg,i))},Sa._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},Sa._updateInstancedAttributes=function(e,t){u7.prototype._updateInstancedAttributes.call(this,e,t),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(Zg)),this.updateInstancedJointTextureInfo()},Sa.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,e=e.animInfo,i=this._instAnimInfoIdx;0<=i&&((i=this.instancedAttributes.views[i])[0]=e.data[0],i[1]=t[1],i[2]=t[2])},D7),S7=(E2=f("cc.SkinnedMeshRenderer"),y=wp(),fie=Oa(100),aie=Ep(),Rie=v(sY),Fp=v(N1),Iie=v(sY),hl=v(N1),Nk=u(),E2(x=y(x=fie(x=Tp(x=aie((l(R7,l7=yU),(A=R7.prototype).onDestroy=function(){this._animation&&(this._animation.removeUser(this),this._animation=null),l7.prototype.onDestroy.call(this)},A.__preload=function(){this._tryBindAnimation()},A.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},A.setUseBakedAnimation=function(e,t){e=(e=void 0===e?!0:e)?x7:v7;!(t=void 0===t?!1:t)&&this._modelType===e||(this._modelType=e,this._model&&(j.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},A.setMaterial=function(e,t){l7.prototype.setMaterial.call(this,e,t),this._modelType===v7&&this.getMaterialInstance(t)},A.notifyAnimationUsable=function(e){this._animation&&(this._animation.removeUser(this),this._animation=null),e.addUser(this),this._animation=e},A.notifyAnimationUnusable=function(){this._animation=null},A._updateModelParams=function(){this._update(),l7.prototype._updateModelParams.call(this)},A._tryBindAnimation=function(){var e=this._skinningRoot;e&&((e=e.getComponent("cc.SkeletalAnimation"))?e.addUser(this):this.setUseBakedAnimation(!1))},A._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},e(R7,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._tryBindAnimation(),this._update())}},{key:"model",get:function(){return this._model}}]),ZY=i((Pc=R7).prototype,"_skeleton",[Rie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JY=i(Pc.prototype,"_skinningRoot",[Fp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(Pc.prototype,"skeleton",[Iie],Object.getOwnPropertyDescriptor(Pc.prototype,"skeleton"),Pc.prototype),i(Pc.prototype,"skinningRoot",[hl,Nk],Object.getOwnPropertyDescriptor(Pc.prototype,"skinningRoot"),Pc.prototype),x=Pc))||x)||x)||x)||x)||x),b7=new Wa(fa.ATTR_BATCH_ID,W.R32F),T7=new Wa(fa.ATTR_BATCH_UV,W.RG32F),E7=dc[b7.format].size+dc[T7.format].size,C7=(I=f("cc.SkinnedMeshUnit"),vI=v(r6),Up=v(sY),o=v(Ey),R=v(S7),I((e(I7,[{key:"offset",get:function(){return this._offset},set:function(e){U.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){U.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&WN(e.node,e.skinningRoot,this._localTransform))}}]),$Y=i((cM=I7).prototype,"mesh",[vI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),e7=i(cM.prototype,"skeleton",[Up],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t7=i(cM.prototype,"material",[o],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i7=i(cM.prototype,"_localTransform",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new B}}),n7=i(cM.prototype,"_offset",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(0,0)}}),r7=i(cM.prototype,"_size",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new U(1,1)}}),i(cM.prototype,"offset",[Ap],Object.getOwnPropertyDescriptor(cM.prototype,"offset"),cM.prototype),i(cM.prototype,"size",[Ap],Object.getOwnPropertyDescriptor(cM.prototype,"size"),cM.prototype),i(cM.prototype,"copyFrom",[R],Object.getOwnPropertyDescriptor(cM.prototype,"copyFrom"),cM.prototype),yI=cM))||yI),w7=new B,A7=(new B,new ce),Y3=(kp=f("cc.SkinnedMeshBatchRenderer"),Hd=wp(),b=Oa(100),uI=Ep(),Xp=u(),ane=v([ui]),dU=u(),Lc=v([C7]),a=u(),s=Pp(),W3=Pp(),kp(h=Hd(h=b(h=Tp(h=uI((l(P7,c7=S7),(Ac=P7.prototype).onLoad=function(){c7.prototype.onLoad.call(this),this.cook()},Ac.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),c7.prototype.onDestroy.call(this)},Ac._onMaterialModified=function(e){this.cookMaterials(),c7.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},Ac.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},Ac.cookMaterials=function(){var s=this,c=(this._batchMaterial||(this._batchMaterial=this.getMaterial(0)),this.getMaterialInstance(0));if(c&&this._batchMaterial&&this._batchMaterial.effectAsset){c.copy(this._batchMaterial),this.resizeAtlases();for(var t=c.effectAsset.techniques[c.technique],e=function(o){var a=t.passes[o];if(!a.properties)return"continue";for(var e in a.properties)!function(t){if(a.properties[t].type>=Ro.SAMPLER1D){var i=null;s.batchableTextureNames.find(function(e){return e===t})?((i=s._textures[t])||(i=s.createTexture(t)),s.cookTextures(i,t,o)):s.units.some(function(e){return i=e.material&&e.material.getProperty(t,o)}),i&&c.setProperty(t,i,o)}else{for(var e=[],n=0;n<s.units.length;n++){var r=s.units[n];r.material&&e.push(r.material.getProperty(t.slice(0,-3),o))}c.setProperty(t,e,o)}}(e)},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")},Ac.cookSkeletons=function(){if(this._skinningRoot){for(var i=[],n=[],e=0;e<this.units.length;e++){var t=this.units[e];if(t&&t.skeleton){var r=t.skeleton;B.invert(w7,t._localTransform);for(var o=0;o<r.joints.length;o++)!function(e){var t=r.joints[e];if(0<=i.findIndex(function(e){return e===t}))return;i.push(t),n.push(B.multiply(new B,r.bindposes[e]||B.IDENTITY,w7))}(o)}}var a=Array.from(Array(i.length).keys()).sort(function(e,t){return i[e]>i[t]?1:i[e]<i[t]?-1:0}),s=new sY;s.joints=i.map(function(e,t,i){return i[a[t]]}),s.bindposes=n.map(function(e,t,i){return i[a[t]]}),this._skeleton&&this._skeleton.destroy(),this.skeleton=s}else console.warn("no skinning root specified!")},Ac.cookMeshes=function(){for(var i=this,e=!1,t=0;t<this.units.length;t++)if(this.units[t].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new r6;for(var C=0,w=W.UNKNOWN,A=0,P=W.UNKNOWN,I=0,R=W.UNKNOWN,D=0,O=W.UNKNOWN,M=0,N=W.UNKNOWN,L=new Array(this.units.length),n=this.units.length,r=0;r<n;r++){var o=this.units[r];o&&o.skeleton&&(L[r]=o.skeleton.joints.map(function(t){return i._skeleton.joints.findIndex(function(e){return t===e})}))}for(var a=0;a<n;a++)!function(y){var x=i.units[y];if(!x||!x.mesh||!x.mesh.data)return;var S=i._createUnitMesh(y,x.mesh),b=new DataView(S.data.buffer);B.inverseTranspose(w7,x._localTransform);for(var T=x.offset,E=x.size,e=0;e<S.struct.vertexBundles.length;e++)!function(e){var t=S.struct.vertexBundles[e];C=t.view.offset,w=W.UNKNOWN;for(var i=0;i<t.attributes.length;i++){var n=t.attributes[i];if(n.name===fa.ATTR_POSITION){w=n.format;break}C+=dc[n.format].size}if(w){for(var r=dE(b,w,C,t.view.length,t.view.stride),o=0;o<r.length;o+=3)ce.fromArray(A7,r,o),ce.transformMat4(A7,A7,x._localTransform),ce.toArray(r,A7,o);fE(b,r,w,C,t.view.stride)}A=t.view.offset,P=W.UNKNOWN;for(var a=0;a<t.attributes.length;a++){var s=t.attributes[a];if(s.name===fa.ATTR_NORMAL){P=s.format;break}A+=dc[s.format].size}if(P){for(var c=dE(b,P,A,t.view.length,t.view.stride),l=0;l<c.length;l+=3)ce.fromArray(A7,c,l),ce.transformMat4Normal(A7,A7,w7),ce.toArray(c,A7,l);fE(b,c,P,A,t.view.stride)}I=t.view.offset,R=W.UNKNOWN;for(var u=0;u<t.attributes.length;u++){var h=t.attributes[u];if(h.name===fa.ATTR_TANGENT){R=h.format;break}I+=dc[h.format].size}if(R){for(var p=dE(b,R,I,t.view.length,t.view.stride),_=0;_<p.length;_+=3)ce.fromArray(A7,p,_),ce.transformMat4Normal(A7,A7,w7),ce.toArray(p,A7,_);fE(b,p,R,I,t.view.stride)}D=t.view.offset,O=W.UNKNOWN;for(var f=0;f<t.attributes.length;f++){var d=t.attributes[f];if(d.name===fa.ATTR_BATCH_UV){O=d.format;break}D+=dc[d.format].size}O&&mE(b,function(e,t){var i,t=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*E[t]+T[t]},O,D,t.view.length,t.view.stride,b);var m=L[y];if(!m)return;M=t.view.offset,N=W.UNKNOWN;for(var g=0;g<t.attributes.length;g++){var v=t.attributes[g];if(v.name===fa.ATTR_JOINTS){N=v.format;break}M+=dc[v.format].size}N&&mE(b,function(e){return m[e]},N,M,t.view.length,t.view.stride,b)}(e);i._mesh.merge(S)}(a);this._onMeshChanged(this._mesh),this._updateModels()}},Ac.cookTextures=function(e,t,i){for(var n=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c,l,u=this.units[s];!u.material||(c=u.material.getProperty(t,i))&&c.image&&c.image.data&&((l=new Ta).texOffset.x=u.offset.x*this.atlasSize,l.texOffset.y=u.offset.y*this.atlasSize,l.texExtent.width=u.size.x*this.atlasSize,l.texExtent.height=u.size.y*this.atlasSize,u=c.image.data,ArrayBuffer.isView(u)?(o.push(u),a.push(l)):(n.push(u),r.push(l)))}var e=e.getGFXTexture(),h=j.director.root.device;0<o.length&&h.copyBuffersToTexture(o,e,a),0<n.length&&h.copyTexImagesToTexture(n,e,r)},Ac.createTexture=function(e){var t=new i0;return t.setFilters(fv.LINEAR,fv.LINEAR),t.setMipFilter(fv.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:pv.RGBA8888}),this._textures[e]=t},Ac.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:pv.RGBA8888})},Ac._createUnitMesh=function(B,e){for(var t=JSON.parse(JSON.stringify(e.struct)),i={},n=0;n<e.struct.primitives.length;n++){for(var r,o=e.struct.primitives[n],a=0,s=W.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){for(var l=e.struct.vertexBundles[o.vertexBundelIndices[c]],a=l.view.offset,s=W.UNKNOWN,u=0;u<l.attributes.length;u++){var h=l.attributes[u];if(h.name===fa.ATTR_TEX_COORD){s=h.format;break}a+=dc[h.format].size}if(s)break}void 0===i[c]&&(i[c]=[s,a],(r=t.vertexBundles[c]).attributes.push(b7),r.attributes.push(T7),r.view.offset=0,r.view.length+=r.view.count*E7,r.view.stride+=E7)}for(var p=0,_=0;_<t.vertexBundles.length;_++)p+=t.vertexBundles[_].view.length;for(var f=0;f<t.primitives.length;f++){var d=t.primitives[f];d.indexView&&(d.indexView.offset=p,p+=d.indexView.length)}var m,g=new Uint8Array(p),v=e.data,y=new DataView(g.buffer),F=new DataView(v.buffer),x=j.sys.isLittleEndian;for(m in i)for(var z=t.vertexBundles[m],S=e.struct.vertexBundles[m],b=i[m],T=dE(F,b[0],b[1],S.view.length,S.view.stride),b=S.view,E=z.view,C=b.stride,U=E.stride,w=b.offset,A=E.offset,P=0;P<E.count;P++){var k=v.subarray(w,w+C);g.set(k,A),y.setFloat32(A+C,B),y.setFloat32(A+C+4,T[2*P],x),y.setFloat32(A+C+8,T[2*P+1],x),A+=U,w+=C}for(var I=0;I<t.primitives.length;I++){var R=e.struct.primitives[I],D=t.primitives[I];if(R.indexView&&D.indexView)for(var O=R.indexView.stride,G=D.indexView.stride,M=R.indexView.offset,N=D.indexView.offset,L=0;L<D.indexView.count;L++){var H=v.subarray(M,M+O);g.set(H,N),N+=G,M+=O}}var V=new r6;return V.reset({struct:t,data:g}),V},e(P7,[{key:"mesh",get:function(){return c7.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return c7.prototype.skeleton},set:function(e){this.skeleton=e}}]),o7=i((Ce=P7).prototype,"atlasSize",[d,Xp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),a7=i(Ce.prototype,"batchableTextureNames",[ane,d,dU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),s7=i(Ce.prototype,"units",[Lc,d,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),i(Ce.prototype,"mesh",[Gp,s],Object.getOwnPropertyDescriptor(Ce.prototype,"mesh"),Ce.prototype),i(Ce.prototype,"skeleton",[Gp,W3],Object.getOwnPropertyDescriptor(Ce.prototype,"skeleton"),Ce.prototype),h=Ce))||h)||h)||h)||h)||h);function P7(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=c7.call.apply(c7,[this].concat(i))||this,"atlasSize",o7,p(e)),_(e,"batchableTextureNames",a7,p(e)),_(e,"units",s7,p(e)),e._textures={},e._batchMaterial=null,e}function I7(){_(this,"mesh",$Y,this),_(this,"skeleton",e7,this),_(this,"material",t7,this),_(this,"_localTransform",i7,this),_(this,"_offset",n7,this),_(this,"_size",r7,this)}function R7(){var e;return _(e=l7.call(this)||this,"_skeleton",ZY,p(e)),_(e,"_skinningRoot",JY,p(e)),e._clip=null,e._animation=null,e._modelType=x7,e}function D7(){(e=u7.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=V0.BAKED_SKINNING,e._dataPoolManager=j.director.root.dataPoolManager;var e,t=new Float32Array(4),i=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:t,animInfo:i,texture:null,boundsInfo:null},e}function O7(){var e;return(e=h7.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=V0.SKINNING,e}j.SkinningModelComponent=S7,gt.setClassAlias(S7,"cc.SkinningModelComponent"),j.SkinningModelUnit=C7,gt.setClassAlias(C7,"cc.SkinningModelUnit"),j.BatchedSkinningModelComponent=Y3,gt.setClassAlias(Y3,"cc.BatchedSkinningModelComponent");var M7,N7,L7,B7,F7,z7=new B,U7=new B,k7=(l(H7,F7=hN),(ul=H7.prototype).initialize=function(e){var t,i;this._curveLoaded||(this._parent=e.getComponent("cc.SkeletalAnimation"),i=this._parent.useBakedAnimation,this._doNotCreateEval=i,F7.prototype.initialize.call(this,e),this._curvesInited=!i,t=(i=dO.getOrExtract(this.clip)).frames,i=i.samples,this._frames=t-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/i)},ul.onPlay=function(){var t=this;F7.prototype.onPlay.call(this),this._parent.useBakedAnimation?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip),this._parent.getUsers().forEach(function(e){e.uploadAnimation(t.clip)})):(this._sampleCurves=F7.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,F7.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},ul.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,i=0;i<e.length;++i){var n=e[i],r=t.getChildByPath(n.path);if(n.target){for(var o=dO.getOrExtract(this.clip),a=n.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/"),a=a.substring(0,u),s=o.joints[a];if(c&&(l=l||B.identity(U7),B.fromRTS(z7,c.rotation,c.position,c.scale),B.multiply(l,z7,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,p=o.frames,_=[],f=0;f<p;f++){var d=h&&l?B.multiply(z7,h[f],l):h?h[f]:l||new B,m={pos:new ce,rot:new gr,scale:new ce};B.toRTS(d,m.rot,m.pos,m.scale),_.push(m)}this._sockets.push({target:n.target,frames:_})}}},ul._setAnimInfoDirty=function(e,t){e.dirty=t},ul._sampleCurvesBaked=function(e){var e=e/this.duration,t=this._animInfo,i=e*this._frames+.5|0;if(i!==t.data[0]){t.data[0]=i,this._setAnimInfoDirty(t,!0);for(var n=0;n<this._sockets.length;++n){var r=this._sockets[n],o=r.target,r=r.frames[i],a=r.pos,s=r.rot,r=r.scale;o.setRTS(s,a,r)}}},H7),G7=(B1=f("cc.SkeletalAnimation.Socket"),il=v(N1),B1((M7=i((bne=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),_(this,"path",M7,this),_(this,"target",N7,this),this.path=e,this.target=t}).prototype,"path",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),N7=i(bne.prototype,"target",[il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Op=bne))||Op);function H7(e,t){return(e=F7.call(this,e,t=void 0===t?"":t)||this)._frames=1,e._bakedDuration=0,e._animInfo=null,e._sockets=[],e._animInfoMgr=void 0,e._parent=null,e._curvesInited=!1,e._animInfoMgr=j.director.root.dataPoolManager.jointAnimationInfo,e}gt.setClassAlias(G7,"cc.SkeletalAnimationComponent.Socket");var V7=new B,j7=new B;Mp=f("cc.SkeletalAnimation"),Z5=wp(),Mne=Oa(99),kd=Ep(),Nw=v([G7]),nl=u(),Bp=u(),S=v([G7]);var W7,ba=Mp(g=Z5(g=Mne(g=Tp(g=kd((l(q7,W7=yN),(Gd=q7.prototype).onDestroy=function(){W7.prototype.onDestroy.call(this),j.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),j.director.getAnimationManager().removeSockets(this.node,this._sockets)},Gd.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,W7.prototype.start.call(this)},Gd.pause=function(){var e;this._useBakedAnimation?null!=(e=this._currentBakedState)&&e.pause():W7.prototype.pause.call(this)},Gd.resume=function(){var e;this._useBakedAnimation?null!=(e=this._currentBakedState)&&e.resume():W7.prototype.resume.call(this)},Gd.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):W7.prototype.stop.call(this)},Gd.querySockets=function(){var e=this._defaultClip&&Object.keys(dO.getOrExtract(this._defaultClip).joints).sort().reduce(function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e},[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],i=0;i<e.length;i++){var n=e[i],r=this.node.getChildByPath(n);r&&(t.push(n),function e(t,i,n){void 0===i&&(i=""),void 0===n&&(n=[]);for(var r=0;r<t.children.length;r++){var o,a=t.children[r];a&&(o=i?i+"/"+a.name:a.name,n.push(o),e(a,o,n))}}(r,n,t))}return t},Gd.rebuildSocketAnimations=function(){for(var e=ge(this._sockets);!(t=e()).done;){var t=t.value,i=this.node.getChildByPath(t.path),n=t.target;i&&n&&(n.name=t.path.substring(t.path.lastIndexOf("/")+1)+" Socket",n.parent=this.node,WN(i,this.node,V7),B.fromRTS(j7,n.rotation,n.position,n.scale),B.equals(j7,V7)||(n.matrix=V7))}for(var r=0,o=Object.keys(this._nameToState);r<o.length;r++){var a=o[r];this._nameToState[a].rebuildSocketCurves(this._sockets)}},Gd.createSocket=function(t){var e=this._sockets.find(function(e){return e.path===t});if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;e=new N1;return e.parent=this.node,this._sockets.push(new G7(t,e)),this.rebuildSocketAnimations(),e},Gd.addUser=function(e){this._users.add(e);var t=this._useBakedAnimation;e.setUseBakedAnimation(t,!0),t&&(t=this._currentBakedState)&&e.uploadAnimation(t.clip)},Gd.removeUser=function(e){e.setUseBakedAnimation(!1),e.notifyAnimationUnusable(),this._users.delete(e)},Gd.getUsers=function(){return this._users},Gd._createState=function(e,t){return new k7(e,t)},Gd._doCreateState=function(e,t){e=W7.prototype._doCreateState.call(this,e,t);return e.rebuildSocketCurves(this._sockets),e},Gd.doPlayOrCrossFade=function(e,t){this._useBakedAnimation?(this._currentBakedState&&this._currentBakedState.stop(),(this._currentBakedState=e).play()):W7.prototype.doPlayOrCrossFade.call(this,e,t)},Gd._removeAllUsers=function(){var t=this;Array.from(this._users).forEach(function(e){t.removeUser(e)})},e(q7,[{key:"sockets",get:function(){return this._sockets},set:function(e){var t;this._useBakedAnimation||((t=j.director.getAnimationManager()).removeSockets(this.node,this._sockets),t.addSockets(this.node,e)),this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){this._useBakedAnimation=e,this._removeAllUsers();for(var t=this.node.getComponentsInChildren(S7),i=0;i<t.length;++i){var n=t[i];n.skinningRoot===this.node&&n.notifyAnimationUsable(this)}this._useBakedAnimation?j.director.getAnimationManager().removeSockets(this.node,this._sockets):(j.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),q7.Socket=G7,i((n=q7).prototype,"sockets",[Nw,nl],Object.getOwnPropertyDescriptor(n.prototype,"sockets"),n.prototype),i(n.prototype,"useBakedAnimation",[Bp],Object.getOwnPropertyDescriptor(n.prototype,"useBakedAnimation"),n.prototype),L7=i(n.prototype,"_useBakedAnimation",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),B7=i(n.prototype,"_sockets",[S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),g=n))||g)||g)||g)||g)||g;function q7(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=W7.call.apply(W7,[this].concat(i))||this,"_useBakedAnimation",L7,p(e)),_(e,"_sockets",B7,p(e)),e._users=new Set,e._currentBakedState=null,e}j.SkeletalAnimationComponent=ba,gt.setClassAlias(ba,"cc.SkeletalAnimationComponent"),j.utils=L6;var X7,Y7,K7,Q7,Z7,J7,$7,e9,t9,i9,n9=[0,0,1,0,0,1,1,1],r9=(l(w9,i9=$0),(Aw=w9.prototype).setCapacity=function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()},Aw.setVertexAttributes=function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var i=ge(this._vertAttrs);!(n=i()).done;){var n=n.value;n.offset=this._vertSize,this._vertSize+=dc[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},Aw.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&0<this._capacity){var i=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===fa.ATTR_TEX_COORD})].offset,n=(this._mesh.copyAttribute(0,fa.ATTR_TEX_COORD,t,this._vertSize,i),this._vertAttrs.findIndex(function(e){return e.name===fa.ATTR_TEX_COORD3})),i=this._vertAttrs[n++].offset;if(this._mesh.copyAttribute(0,fa.ATTR_POSITION,t,this._vertSize,i),i=this._vertAttrs[n++].offset,this._mesh.copyAttribute(0,fa.ATTR_NORMAL,t,this._vertSize,i),i=this._vertAttrs[+n].offset,!this._mesh.copyAttribute(0,fa.ATTR_COLOR,t,this._vertSize,i))for(var r=new Uint32Array(t),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+i/4]=nr.WHITE._val;for(var a=new Float32Array(t),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&0<this._capacity){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,p=0;p<this._capacity;++p){var _=4*p;c[h++]=_,c[h++]=1+_,c[h++]=2+_,c[h++]=3+_,c[h++]=2+_,c[h++]=1+_}n=this._device.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return n.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new Ia(Do.INDIRECT,No.HOST|No.DEVICE,28,28))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new yE([e],this._vertAttrs,$o.TRIANGLE_LIST,n,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},Aw.updateMaterial=function(e){this._material=e,this.setSubModelMaterial(0,e)},Aw.addParticleVertexData=function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[+n]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[+r]=t[5].z)}},Aw.addGPUParticleVertexData=function(e,t,i){for(var n=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=n;this._vdataF32[o++]=e.position.x,this._vdataF32[o++]=e.position.y,this._vdataF32[o++]=e.position.z,this._vdataF32[o++]=i,this._vdataF32[o++]=e.startSize.x,this._vdataF32[o++]=e.startSize.y,this._vdataF32[o++]=e.startSize.z,this._vdataF32[o++]=n9[2*r],this._vdataF32[o++]=e.rotation.x,this._vdataF32[o++]=e.rotation.y,this._vdataF32[o++]=e.rotation.z,this._vdataF32[o++]=n9[2*r+1],this._vdataF32[o++]=e.startColor.r/255,this._vdataF32[o++]=e.startColor.g/255,this._vdataF32[o++]=e.startColor.b/255,this._vdataF32[o++]=e.startColor.a/255,this._vdataF32[o++]=e.velocity.x,this._vdataF32[o++]=e.velocity.y,this._vdataF32[o++]=e.velocity.z,this._vdataF32[o++]=e.startLifetime,this._vdataF32[+o]=e.randomSeed,n+=this._vertAttrsFloatCount}},Aw.updateGPUParticles=function(e,t,i){for(var n,r,o=this._vertAttrsFloatCount*this._vertCount,a=0;a<e;++a)r=this._vdataF32[(n=a*o)+this._startTimeOffset],this._vdataF32[n+this._lifeTimeOffset]-(t-r)<i&&(r=--e*o,this._vdataF32.copyWithin(n,r,r+o),a--);return e},Aw.constructAttributeIndex=function(){var e,t;this._vertAttrs&&(e=this._vertAttrs.findIndex(function(e){return"a_position_starttime"===e.name}),t=this._vertAttrs[e].offset,this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex(function(e){return"a_dir_life"===e.name}),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3)},Aw.updateIA=function(e){e<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo))},Aw.clear=function(){this._subModels[0].inputAssembler.indexCount=0},Aw.destroy=function(){i9.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},Aw.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},Aw.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},w9),kw=((w=C9.prototype).getInfo=function(){return this._renderInfo},w.onInit=function(e){this._particleSystem=e},w.onEnable=function(){var e;this._particleSystem&&(this.attachToScene(),(e=this._model)&&(e.node=e.transform=this._particleSystem.node))},w.onDisable=function(){this.detachFromScene()},w.onDestroy=function(){this._model&&(j.director.root.destroyModel(this._model),this._model=null)},w.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},w.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},w.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===L8.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},w.clear=function(){this._model&&(this._model.enabled=!1)},w.getModel=function(){return this._model},w._initModel=function(){this._model||(this._model=j.director.root.createModel(r9),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},w.updateTrailMaterial=function(){},w.getDefaultTrailMaterial=function(){return null},C9),o9=new ce,a9=new B,s9=new gr,c9=(new ce,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),l9=[0,0,1,0,0,1,1,1],u9=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RGB32F),new Wa(fa.ATTR_TEX_COORD1,W.RGB32F),new Wa(fa.ATTR_TEX_COORD2,W.RGB32F),new Wa(fa.ATTR_COLOR,W.RGBA8,!0)],h9=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RGB32F),new Wa(fa.ATTR_TEX_COORD1,W.RGB32F),new Wa(fa.ATTR_TEX_COORD2,W.RGB32F),new Wa(fa.ATTR_COLOR,W.RGBA8,!0),new Wa(fa.ATTR_COLOR1,W.RGB32F)],p9=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RGB32F),new Wa(fa.ATTR_TEX_COORD1,W.RGB32F),new Wa(fa.ATTR_TEX_COORD2,W.RGB32F),new Wa(fa.ATTR_COLOR,W.RGBA8,!0),new Wa(fa.ATTR_TEX_COORD3,W.RGB32F),new Wa(fa.ATTR_NORMAL,W.RGB32F),new Wa(fa.ATTR_COLOR1,W.RGBA8,!0)],_9={parent:null,owner:null,subModelIdx:0},f9=(l(E9,t9=kw),(zp=E9.prototype).onInit=function(e){var t=this;t9.prototype.onInit.call(this,e),this._particles=new Et(function(){return new y8(t)},16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},zp.clear=function(){t9.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},zp.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},zp.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},zp.getDefaultTrailMaterial=function(){return this._defaultTrailMat},zp.setNewParticle=function(){},zp._initModuleList=function(){var t=this;c9.forEach(function(e){e=t._particleSystem[e];e&&e.enable&&(e.needUpdate&&(t._updateList[e.name]=e),e.needAnimate&&(t._animateList[e.name]=e))});for(var e=this._runAnimateList.length=0,i=R8.length;e<i;e++){var n=this._animateList[R8[e]];n&&this._runAnimateList.push(n)}},zp.enableModule=function(e,t,i){t?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[e],delete this._updateList[e]);for(var n=this._runAnimateList.length=0,r=R8.length;n<r;n++){var o=this._animateList[R8[n]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},zp.updateAlignSpace=function(e){this._alignSpace=e},zp.getDefaultMaterial=function(){return this._defaultMat},zp.updateRotation=function(e){e&&this.doUpdateRotation(e)},zp.doUpdateRotation=function(e){if(this._renderInfo.renderMode===L8.Mesh||this._alignSpace!==N8.View){if(this._alignSpace===N8.Local)this._particleSystem.node.getRotation(s9);else if(this._alignSpace===N8.World)this._particleSystem.node.getWorldRotation(s9);else if(this._alignSpace===N8.View){s9.set(0,0,0,1);var t,i=null==(t=this._particleSystem.node.scene.renderScene)?void 0:t.cameras;if(void 0!==i)for(var n=0;n<(null==i?void 0:i.length);++n){var r=i[n];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){gr.fromViewUp(s9,r.forward);break}}}else s9.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,s9)}},zp.updateScale=function(e){e&&this.doUpdateScale(e)},zp.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case O8.Local:this._particleSystem.node.getScale(this._node_scale);break;case O8.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(this._uScaleHandle,this._node_scale)},zp.updateParticles=function(n){var r=this,o=this._particleSystem;if(!o)return this._particles.length;o.node.getWorldMatrix(a9);var e=(o.getMaterialInstance(0)||this._defaultMat).passes[0],a=(this.doUpdateScale(e),this.doUpdateRotation(e),this._updateList.forEach(function(e){e.update(o._simulationSpace,a9)}),o._trailModule),s=a&&a.enable;s&&a.update(),o.simulationSpace===O8.Local&&(e=o.node.getRotation(),B.fromQuat(this._localMat,e),this._localMat.transpose());for(var c=0;c<this._particles.length;++c)!function(e){var t,i=r._particles.data[e];if(i.remainingLifetime-=n,ce.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0)return s&&a.removeParticle(i),r._particles.removeAt(e),c=--e;o.simulationSpace===O8.Local?(t=9.8*-o.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,Wn(i.randomSeed))*n,r._gravity.x=0,r._gravity.y=t,r._gravity.z=0,r._gravity.w=1,r._gravity=r._gravity.transformMat4(r._localMat),i.velocity.x+=r._gravity.x,i.velocity.y+=r._gravity.y,i.velocity.z+=r._gravity.z):i.velocity.y-=9.8*o.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,Wn(i.randomSeed))*n,ce.copy(i.ultimateVelocity,i.velocity),r._runAnimateList.forEach(function(e){e.animate(i,n)}),ce.scaleAndAdd(i.position,i.position,i.ultimateVelocity,n),s&&a.animate(i,n),c=e}(c);return this._model.enabled=0<this._particles.length,this._particles.length},zp.updateRenderData=function(){for(var e=0;e<this._particles.length;++e){var t=this._particles.data[e],i=0,n=this._particleSystem._textureAnimationModule;n&&n.enable&&(i=t.frameIndex),this._fillDataFunc(t,4*e,i)}},zp.beforeRender=function(){this._model.updateIA(this._particles.length)},zp.getParticleCount=function(){return this._particles.length},zp.onMaterialModified=function(e){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())},zp.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===e&&i._trailModel.setSubModelMaterial(0,t)},zp._setFillFunc=function(){this._renderInfo.renderMode===L8.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===L8.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},zp._fillMeshData=function(e,t,i){t/=4;this._attrs[0]=e.position,o9.z=i,this._attrs[1]=o9,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(t,this._attrs)},zp._fillStrecthedData=function(e,t,i){for(var n=0;n<4;++n)this._attrs[0]=e.position,o9.x=l9[2*n],o9.y=l9[2*n+1],o9.z=i,this._attrs[1]=o9,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)},zp._fillNormalData=function(e,t,i){for(var n=0;n<4;++n)this._attrs[0]=e.position,o9.x=l9[2*n],o9.y=l9[2*n+1],o9.z=i,this._attrs[1]=o9,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)},zp._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case L8.StrecthedBillboard:this._vertAttrs=h9.slice();break;case L8.Mesh:this._vertAttrs=p9.slice();break;default:this._vertAttrs=u9.slice()}},zp.updateMaterialParams=function(){var e,t,i,n,r;this._particleSystem&&(null!=(e=(n=this._particleSystem).sharedMaterial)&&(t=e._effectAsset._name,this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1!==t.indexOf("particle")&&-1===t.indexOf("particle-gpu")||n.setMaterial(null,0)),null==n.sharedMaterial&&null==this._defaultMat&&(_9.parent=D0.get("default-particle-material"),_9.owner=this._particleSystem,_9.subModelIdx=0,this._defaultMat=new Hy(_9),_9.parent=null,_9.owner=null,_9.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture)),e=n.getMaterialInstance(0)||this._defaultMat,n._simulationSpace===O8.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1,t=e.passes[0],this._uScaleHandle=t.getHandle("scale"),this._uLenHandle=t.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=t.getHandle("nodeRotation"),r=this._renderInfo.renderMode,i=this._frameTile_velLenScale,r===L8.Billboard?this._defines.CC_RENDER_MODE=0:r===L8.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,i.z=this._renderInfo.velocityScale,i.w=this._renderInfo.lengthScale):r===L8.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===L8.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===L8.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support."),(r=n._textureAnimationModule)&&r.enable?(Fr.copy(this._tmp_velLenScale,i),U.set(this._tmp_velLenScale,r.numTilesX,r.numTilesY),t.setUniform(this._uLenHandle,this._tmp_velLenScale)):t.setUniform(this._uLenHandle,i),r=(n=this._particleSystem._rotationOvertimeModule)&&n.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=r,e.recompileShaders(this._defines),this._model&&this._model.updateMaterial(e))},zp.updateTrailMaterial=function(){var e,t;this._particleSystem&&(e=(t=this._particleSystem)._trailModule)&&e.enable&&(t.simulationSpace===O8.World||e.space===O8.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1,null===(t=t.getMaterialInstance(1))&&null===this._defaultTrailMat&&(_9.parent=D0.get("default-trail-material"),_9.owner=this._particleSystem,_9.subModelIdx=1,this._defaultTrailMat=new Hy(_9),_9.parent=null,_9.owner=null,_9.subModelIdx=0),(t=t||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial())},E9),d9=new B,m9=new Fr,g9=new gr,v9=new gr,Np=(new ce,"a_position_starttime"),t="a_rotation_uv",EW="a_dir_life",y9=[new Wa(Np,W.RGBA32F),new Wa("a_size_uv",W.RGBA32F),new Wa(t,W.RGBA32F),new Wa("a_color",W.RGBA32F),new Wa(EW,W.RGBA32F),new Wa("a_rndSeed",W.R32F)],x9=[new Wa(Np,W.RGBA32F),new Wa("a_size_uv",W.RGBA32F),new Wa(t,W.RGBA32F),new Wa("a_color",W.RGBA32F),new Wa(EW,W.RGBA32F),new Wa("a_rndSeed",W.R32F),new Wa(fa.ATTR_TEX_COORD,W.RGB32F),new Wa(fa.ATTR_TEX_COORD3,W.RGB32F),new Wa(fa.ATTR_NORMAL,W.RGB32F),new Wa(fa.ATTR_COLOR1,W.RGBA8,!0)],S9={parent:null,owner:null,subModelIdx:0},b9=(l(T9,e9=kw),(pF=T9.prototype).onInit=function(e){e9.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},pF.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},pF.setVertexAttributes=function(){e9.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},pF.clear=function(){e9.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},pF.onDestroy=function(){e9.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},pF.enableModule=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},pF.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},pF.setNewParticle=function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++},pF.getDefaultMaterial=function(){return this._defaultMat},pF.updateRotation=function(e){e&&this.doUpdateRotation(e)},pF.doUpdateRotation=function(e){if(this._renderInfo.renderMode===L8.Mesh||this._alignSpace!==N8.View){if(this._alignSpace===N8.Local)this._particleSystem.node.getRotation(v9);else if(this._alignSpace===N8.World)this._particleSystem.node.getWorldRotation(v9);else if(this._alignSpace===N8.View){v9.set(0,0,0,1);var t,i=null==(t=this._particleSystem.node.scene.renderScene)?void 0:t.cameras;if(void 0!==i)for(var n=0;n<(null==i?void 0:i.length);++n){var r=i[n];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){gr.fromViewUp(v9,r.forward);break}}}else v9.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,v9)}},pF.updateScale=function(e){e&&this.doUpdateScale(e)},pF.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case O8.Local:this._particleSystem.node.getScale(this._node_scale);break;case O8.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(e.getHandle("scale"),this._node_scale)},pF.updateParticles=function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=0<this._particleNum,this._particleNum},pF.updateRenderData=function(){},pF.beforeRender=function(){this._model.updateIA(this._particleNum)},pF.updateAlignSpace=function(e){this._alignSpace=e},pF.updateShaderUniform=function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(t=t.passes[0],m9.x=this._particleSystem._time,m9.y=e,t.setUniform(this._uTimeHandle,m9),this._particleSystem.node.getWorldRotation(g9),t.setUniform(this._uRotHandle,g9),this.doUpdateRotation(t))},pF.initShaderUniform=function(e){var t,e=e.passes[0],i=(this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),this._uNodeRotHandle=e.getHandle("nodeRotation"),this.doUpdateScale(e),e.setUniform(e.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),m9.x=32,m9.y=.03125,e.setUniform(e.getHandle("u_sampleInfo"),m9),this._particleSystem._forceOvertimeModule),n=i&&i.enable,i=((this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n)&&(this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=K6(32,i.x,i.y,i.z),t=e.getHandle("force_over_time_tex0"),t=G0.getBindingFromHandle(t),e.bindSampler(t,this._forceTexture.getGFXSampler()),e.bindTexture(t,this._forceTexture.getGFXTexture()),t=e.getHandle("u_force_space"),e.setUniform(t,i.space),t=e.getHandle("u_force_mode"),e.setUniform(t,this._forceTexture.height)),this._particleSystem._velocityOvertimeModule),i=(n=i&&i.enable,(this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n)&&(this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,i,n){for(var r=Math.max(X6(e),X6(t),X6(i),X6(n)),o=new Float32Array(32*r*4),a=[e,t,i,n],s=0;s<r;s++)for(var c=0;c<4;c++)for(var l=a[c],u=0,h=0;h<32;h++){var p=(u+=q6(l,1/31*h,s))/(h+1);o[4*h+c]=p}return Y6(o,32,r)}(i.x,i.y,i.z,i.speedModifier),t=e.getHandle("velocity_over_time_tex0"),t=G0.getBindingFromHandle(t),e.bindSampler(t,this._velocityTexture.getGFXSampler()),e.bindTexture(t,this._velocityTexture.getGFXTexture()),t=e.getHandle("u_velocity_space"),e.setUniform(t,i.space),t=e.getHandle("u_velocity_mode"),e.setUniform(t,this._velocityTexture.height)),this._particleSystem._colorOverLifetimeModule),i=(n=i&&i.enable,(this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n)&&(this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e){for(var t=function(){switch(e.mode){case p8.TwoColors:case p8.TwoGradients:return 2;default:return 1}}(),i=new Uint8Array(32*t*4),n=0,r=0;r<t;r++)for(var o=0;o<32;o++){var a=function(e,t,i){switch(e.mode){case p8.Color:return e.color;case p8.TwoColors:return 0===i?e.colorMin:e.colorMax;case p8.RandomColor:return e.gradient.randomColor();case p8.Gradient:return e.gradient.evaluate(t);case p8.TwoGradients:return(0===i?e.gradientMin:e.gradientMax).evaluate(t);default:return e.color}}(e,1/31*o,r);i[n]=a.r,i[n+1]=a.g,i[n+2]=a.b,i[n+3]=a.a,n+=4}var s=new i0;return s.create(32,t,pv.RGBA8888),s.setFilters(fv.LINEAR,fv.LINEAR),s.setWrapMode(_v.CLAMP_TO_EDGE,_v.CLAMP_TO_EDGE),s.uploadData(i),s}(i.color),t=e.getHandle("color_over_time_tex0"),i=G0.getBindingFromHandle(t),e.bindSampler(i,this._colorTexture.getGFXSampler()),e.bindTexture(i,this._colorTexture.getGFXTexture()),t=e.getHandle("u_color_mode"),e.setUniform(t,this._colorTexture.height)),this._particleSystem._rotationOvertimeModule),i=(n=i&&i.enable,(this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n)&&(this._rotationTexture&&this._rotationTexture.destroy(),i.separateAxes?this._rotationTexture=K6(32,i.x,i.y,i.z):this._rotationTexture=function(e){for(var t=X6(e),i=new Float32Array(32*t*4),n=0,r=0;r<t;r++)for(var o=0;o<32;o++){var a=q6(e,1/31*o,r);i[n+2]=a,n+=4}return Y6(i,32,t)}(i.z),t=e.getHandle("rotation_over_time_tex0"),i=G0.getBindingFromHandle(t),e.bindSampler(i,this._rotationTexture.getGFXSampler()),e.bindTexture(i,this._rotationTexture.getGFXTexture()),t=e.getHandle("u_rotation_mode"),e.setUniform(t,this._rotationTexture.height)),this._particleSystem._sizeOvertimeModule),i=(n=i&&i.enable,(this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n)&&(this._sizeTexture&&this._sizeTexture.destroy(),i.separateAxes?this._sizeTexture=K6(32,i.x,i.y,i.z,!0):this._sizeTexture=function(e){for(var t=X6(e),i=new Float32Array(32*t*4),n=0,r=0;r<t;r++)for(var o=0;o<32;o++){var a=q6(e,1/31*o,r);i[n]=a=a,i[n+1]=a,i[n+2]=a,n+=4}return Y6(i,32,t)}(i.size),t=e.getHandle("size_over_time_tex0"),i=G0.getBindingFromHandle(t),e.bindSampler(i,this._sizeTexture.getGFXSampler()),e.bindTexture(i,this._sizeTexture.getGFXTexture()),t=e.getHandle("u_size_mode"),e.setUniform(t,this._sizeTexture.height)),this._particleSystem._textureAnimationModule);n=i&&i.enable,(this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n)&&(this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t){for(var i=Math.max(X6(e),X6(t)),n=new Float32Array(32*i*4),r=[e,t],o=0;o<i;o++)for(var a=0;a<2;a++)for(var s=r[a],c=0,l=0;l<32;l++){var u=(c+=q6(s,1/31*l,o))/(l+1);n[4*l+a]=u}return Y6(n,32,i)}(i.startFrame,i.frameOverTime),t=e.getHandle("texture_animation_tex0"),n=G0.getBindingFromHandle(t),e.bindSampler(n,this._animTexture.getGFXSampler()),e.bindTexture(n,this._animTexture.getGFXTexture()),t=e.getHandle("u_anim_info"),m9.x=this._animTexture.height,m9.y=i.numTilesX*i.numTilesY,m9.z=i.cycleCount,e.setUniform(t,m9)),this._defines.USE_VK_SHADER=j.game._gfxDevice.gfxAPI===wo.VULKAN},pF.getParticleCount=function(){return this._particleNum},pF.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},pF.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)},pF._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case L8.StrecthedBillboard:this._vertAttrs=y9.slice();break;case L8.Mesh:this._vertAttrs=x9.slice();break;default:this._vertAttrs=y9.slice()}},pF.updateMaterialParams=function(){var e,t,i;this._particleSystem&&(null!==(i=(e=this._particleSystem).sharedMaterial)&&(t=i._effectAsset._name,this._renderInfo.mainTexture=i.getProperty("mainTexture",0),-1===t.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=i.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))),null==e.sharedMaterial&&null==this._defaultMat&&(S9.parent=D0.get("default-particle-gpu-material"),S9.owner=e,S9.subModelIdx=0,this._defaultMat=new Hy(S9),S9.parent=null,S9.owner=null,S9.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture)),t=e.getMaterialInstance(0)||this._defaultMat,e.node.getWorldMatrix(d9),e._simulationSpace===O8.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1,(i=this._renderInfo.renderMode)===L8.Billboard?this._defines.CC_RENDER_MODE=0:i===L8.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):i===L8.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:i===L8.VerticalBillboard?this._defines.CC_RENDER_MODE=3:i===L8.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+i+" not support."),(i=e._textureAnimationModule)&&i.enable?(U.set(this._frameTile_velLenScale,i.numTilesX,i.numTilesY),Fr.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,Fr.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.updateMaterial(t))},T9);function T9(e){return(e=e9.call(this,e)||this)._defines=void 0,e._frameTile_velLenScale=void 0,e._unifrom_velLenScale=void 0,e._tmp_velLenScale=void 0,e._node_scale=void 0,e._vertAttrs=[],e._defaultMat=null,e._particleNum=0,e._tempParticle=null,e._colorTexture=null,e._forceTexture=null,e._velocityTexture=null,e._rotationTexture=null,e._sizeTexture=null,e._animTexture=null,e._uTimeHandle=0,e._uRotHandle=0,e._uNodeRotHandle=0,e._alignSpace=N8.View,e._inited=!1,e._frameTile_velLenScale=new Fr(1,1,0,0),e._unifrom_velLenScale=e._frameTile_velLenScale.clone(),e._tmp_velLenScale=e._frameTile_velLenScale.clone(),e._node_scale=new Fr,e._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},e._tempParticle=new y8(null),e._particleNum=0,e}function E9(e){return(e=t9.call(this,e)||this)._defines=void 0,e._trailDefines=void 0,e._frameTile_velLenScale=void 0,e._tmp_velLenScale=void 0,e._defaultMat=null,e._node_scale=void 0,e._attrs=void 0,e._particles=null,e._defaultTrailMat=null,e._updateList=new Map,e._animateList=new Map,e._runAnimateList=new Array,e._fillDataFunc=null,e._uScaleHandle=0,e._uLenHandle=0,e._uNodeRotHandle=0,e._alignSpace=N8.View,e._inited=!1,e._localMat=new B,e._gravity=new Fr,e._model=null,e._frameTile_velLenScale=new Fr(1,1,0,0),e._tmp_velLenScale=e._frameTile_velLenScale.clone(),e._node_scale=new Fr,e._attrs=new Array(5),e._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},e._trailDefines={CC_USE_WORLD_SPACE:!0},e}function C9(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}function w9(){var e;return(e=i9.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e.type=V0.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=new Ma([new Da]),e._iaInfoBuffer=e._device.createBuffer(new Ia(Do.INDIRECT,No.HOST|No.DEVICE,28,28)),e._subMeshData=null,e._mesh=null,e}function A9(){var e=ZP.root.device;return!!(8<=e.capabilities.maxVertexTextureUnits&&e.hasFeature(Po.TEXTURE_FLOAT))||(j.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}pte=f("cc.ParticleSystemRenderer"),P=v(L8),pi=m(),Qp=u(),C=m(),xH=u(),die=m(),vie=u(),tl=v(L8),Sa=v(r6),E2=m(),y=u(),fie=v(Ey),aie=m(),yU=u(),A=v(Ey),Rie=m(),Fp=u(),Iie=m(),hl=u(),Nk=v(N8),Pc=m(),x=u();var P9,I9,R9,D9,O9,M9,N9,L9,B9,F9,z9,U9,k9,G9,H9,V9,j9,W9,q9,X9,Y9,K9,Q9,Z9,J9,$9,eK,tK,iK,nK,rK,oK,aK,sK,cK,lK,uK,hK,pK,_K,fK,dK,mK,gK,vK,yK,xK,SK,bK,TK,EK,CK,wK,AK,PK=pte(((I=ZK.prototype).create=function(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&ee(6033)},I.onInit=function(e){var t;this.create(e),this._particleSystem.processor?ee(6034):(t=this._useGPU&&A9(),this._particleSystem.processor=new(t?b9:f9)(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(e))},I._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=new(this._useGPU?b9:f9)(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},e(ZK,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(A9()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(e){this._alignSpace=e,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),ZK.AlignmentSpace=N8,i((vI=ZK).prototype,"renderMode",[P,pi,Qp],Object.getOwnPropertyDescriptor(vI.prototype,"renderMode"),vI.prototype),i(vI.prototype,"velocityScale",[C,xH],Object.getOwnPropertyDescriptor(vI.prototype,"velocityScale"),vI.prototype),i(vI.prototype,"lengthScale",[die,vie],Object.getOwnPropertyDescriptor(vI.prototype,"lengthScale"),vI.prototype),X7=i(vI.prototype,"_renderMode",[tl,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L8.Billboard}}),Y7=i(vI.prototype,"_velocityScale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),K7=i(vI.prototype,"_lengthScale",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Q7=i(vI.prototype,"_mesh",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(vI.prototype,"mesh",[Sa,E2,y],Object.getOwnPropertyDescriptor(vI.prototype,"mesh"),vI.prototype),i(vI.prototype,"particleMaterial",[fie,aie,yU],Object.getOwnPropertyDescriptor(vI.prototype,"particleMaterial"),vI.prototype),i(vI.prototype,"trailMaterial",[A,Rie,Fp],Object.getOwnPropertyDescriptor(vI.prototype,"trailMaterial"),vI.prototype),Z7=i(vI.prototype,"_mainTexture",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J7=i(vI.prototype,"_useGPU",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(vI.prototype,"useGPU",[Iie,hl],Object.getOwnPropertyDescriptor(vI.prototype,"useGPU"),vI.prototype),i(vI.prototype,"alignSpace",[Nk,Pc,x],Object.getOwnPropertyDescriptor(vI.prototype,"alignSpace"),vI.prototype),$7=i(vI.prototype,"_alignSpace",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N8.View}}),Up=vI))||Up,IK=Math.cos(100*On),RK={position:new ce,velocity:new ce},DK=new gr,OK=new B,MK=new ce,NK=new ce,LK=new nr,BK=((o=QK.prototype).getElement=function(e){return-1===this.start?null:((e=e<0?(e+this.trailElements.length)%this.trailElements.length:e)>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])},o.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new ce,lifetime:0,width:0,velocity:new ce,direction:0,color:new nr}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]},o.iterateElement=function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)t(e,this.trailElements[o%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},o.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},o.clear=function(){this.start=-1,this.end=-1},QK),ba=(R=f("cc.TrailModule"),cM=m(),yI=v(U8),kp=m(),Hd=u(),b=v(H6),uI=Dp(),Ac=m(),Xp=u(),ane=m(),dU=u(),Lc=v(O8),a=m(),s=u(),W3=v(k8),Ce=m(),h=u(),C7=m(),Y3=u(),ul=v(H6),B1=Dp(),il=m(),bne=u(),Op=m(),Mp=u(),Z5=v(_8),Mne=m(),kd=u(),Gd=v(_8),Nw=m(),nl=u(),Bp=v(O8),R((i(((S=KK.prototype).onInit=function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,i=e.startLifetime.getMax(),n=e.rateOverTime.getMax(),r=e.duration,o=0,a=e.bursts.length;o<a;o++)t+=e.bursts[o].getMaxCount(e)*Math.ceil(i/r);this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(n*r+t)),this._trailSegments=new Tt(function(){return new BK(10)},Math.ceil(n*r),function(e){return e.trailElements.length=0}),this._enable&&(this.enable=this._enable)},S.onEnable=function(){this._attachToScene()},S.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},S._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},S._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},S.destroy=function(){this.destroySubMeshData(),this._trailModel&&(ZP.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},S.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},S.clear=function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},S.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},S.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===O8.World&&this._particleSystem._simulationSpace===O8.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(OK),this._particleSystem.node.getWorldRotation(DK)):this._needTransform=!1},S.animate=function(e,t){if(this._trailSegments)if(e.loopCount>e.lastLoop)1<e.trailDelay?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++;else{var i=this._particleTrail.get(e);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(e,i);var n,r=i.getElement(i.end-1);this._needTransform?ce.transformMat4(MK,e.position,OK):ce.copy(MK,e.position),r&&(i.iterateElement(this,this._updateTrailElement,e,t),ce.squaredDistance(r.position,MK)<this._minSquaredDistance)||!(r=i.addElement())||(ce.copy(r.position,MK),r.lifetime=0,this.widthFromParticle?r.width=e.size.x*this.widthRatio.evaluate(0,1):r.width=this.widthRatio.evaluate(0,1),2===(t=i.count())?(n=i.getElement(i.end-2),ce.subtract(n.velocity,r.position,n.position)):2<t&&(n=i.getElement(i.end-2),t=i.getElement(i.end-3),ce.subtract(MK,t.position,n.position),ce.subtract(NK,r.position,n.position),ce.subtract(n.velocity,NK,MK),ce.equals(ce.ZERO,n.velocity)&&ce.copy(n.velocity,MK),ce.normalize(n.velocity,n.velocity),this._checkDirectionReverse(n,t)),this.colorFromParticle?r.color.set(e.color):r.color.set(this.colorOvertime.evaluate(0,1)))}},S.removeParticle=function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))},S.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var e=ge(this._particleTrail.keys());!(t=e()).done;){var t=t.value,i=this._particleTrail.get(t);if(-1!==i.start){var n=4*this.vbOffset/this._vertSize,r=i.start>=i.end?i.end+i.trailElements.length:i.end,o=r-i.start,a=1/o,s=i.trailElements[i.start];this._fillVertexBuffer(s,this.colorOverTrail.evaluate(1,1),n,1,0,4);for(var c=i.start+1;c<r;c++){var l=i.trailElements[c%i.trailElements.length],u=c-i.start;this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1-u/o,1),n,1-u*a,u,5)}this._needTransform?ce.transformMat4(RK.position,t.position,OK):ce.copy(RK.position,t.position);var h,s=this._trailModel;s&&s.node.invalidateChildren(Q0.POSITION),1==o||2==o?(s=i.getElement(i.end-1),ce.subtract(s.velocity,RK.position,s.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=s.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=s.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=s.velocity.z,this._vbF32[this.vbOffset-4]=s.velocity.x,this._vbF32[this.vbOffset-3]=s.velocity.y,this._vbF32[this.vbOffset-2]=s.velocity.z,ce.subtract(RK.velocity,RK.position,s.position),this._checkDirectionReverse(RK,s)):2<o&&(s=i.getElement(i.end-1),h=i.getElement(i.end-2),ce.subtract(MK,h.position,s.position),ce.subtract(NK,RK.position,s.position),ce.normalize(MK,MK),ce.normalize(NK,NK),ce.subtract(s.velocity,NK,MK),ce.normalize(s.velocity,s.velocity),this._checkDirectionReverse(s,h),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(s,this.colorOverTrail.evaluate(a,1),n,a,o-1,5),ce.subtract(RK.velocity,RK.position,s.position),ce.normalize(RK.velocity,RK.velocity),this._checkDirectionReverse(RK,s)),this.widthFromParticle?RK.width=t.size.x*this.widthRatio.evaluate(0,1):RK.width=this.widthRatio.evaluate(0,1),RK.color=t.color,ce.equals(RK.velocity,ce.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(RK,this.colorOverTrail.evaluate(0,1),n,0,o,1)}}this._trailModel.enabled=0<this.ibOffset},S.updateIA=function(e){var t=this._trailModel&&this._trailModel.subModels;t&&0<t.length&&((t=t[0]).inputAssembler.vertexBuffers[0].update(this._vbF32),t.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo))},S.beforeRender=function(){this.updateIA(this.ibOffset)},S._createModel=function(){this._trailModel||(this._trailModel=j.director.root.createModel($0))},S.rebuild=function(){var e=ZP.root.device,t=e.createBuffer(new Ia(Do.VERTEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2),i=(this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i),e.createBuffer(new Ia(Do.INDEX|Do.TRANSFER_DST,No.HOST|No.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT))),e=(this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new Ia(Do.INDIRECT,No.HOST|No.DEVICE,28,28)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new yE([t],this._vertAttrs,$o.TRIANGLE_LIST,i,this._iaInfoBuffer),this._trailModel);e&&(e.node=e.transform=this._particleSystem.node,e.visFlags=this._particleSystem.visibility,e.initSubModel(0,this._subMeshData,this._material),e.enabled=!0)},S._updateTrailElement=function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime},S._fillVertexBuffer=function(e,t,i,n,r,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,LK.set(e.color),LK.multiply(t),this._vbUint32[this.vbOffset++]=LK._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=LK._val,1&o&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)},S._checkDirectionReverse=function(e,t){ce.dot(e.velocity,t.velocity)<IK?e.direction=1-t.direction:e.direction=t.direction},S.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e(KK,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e;e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}}]),n=KK).prototype,"enable",[cM],Object.getOwnPropertyDescriptor(n.prototype,"enable"),n.prototype),P9=i(n.prototype,"_enable",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I9=i(n.prototype,"mode",[yI,d,kp,Hd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U8.Particles}}),R9=i(n.prototype,"lifeTime",[b,d,uI,Ac,Xp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),D9=i(n.prototype,"_minParticleDistance",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),i(n.prototype,"minParticleDistance",[ane,dU],Object.getOwnPropertyDescriptor(n.prototype,"minParticleDistance"),n.prototype),i(n.prototype,"space",[Lc,a,s],Object.getOwnPropertyDescriptor(n.prototype,"space"),n.prototype),O9=i(n.prototype,"existWithParticles",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),M9=i(n.prototype,"textureMode",[W3,d,Ce,h],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k8.Stretch}}),N9=i(n.prototype,"widthFromParticle",[d,C7,Y3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),L9=i(n.prototype,"widthRatio",[ul,d,B1,il,bne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),B9=i(n.prototype,"colorFromParticle",[d,Op,Mp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),F9=i(n.prototype,"colorOverTrail",[Z5,d,Mne,kd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _8}}),z9=i(n.prototype,"colorOvertime",[Gd,d,Nw,nl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _8}}),U9=i(n.prototype,"_space",[Bp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O8.World}}),k9=i(n.prototype,"_particleSystem",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g=n))||g),FK=new B,zK=new gr,UK=new ce,kK=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],GK=((L6=YK.prototype)._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},L6.setBoundingBoxSize=function(e){this.maxPos.x=this._nodePos.x+e.x,this.maxPos.y=this._nodePos.y+e.y,this.maxPos.z=this._nodePos.z+e.z,this.minPos.x=this._nodePos.x-e.x,this.minPos.y=this._nodePos.y-e.y,this.minPos.z=this._nodePos.z-e.z,this._updateBoundingNode()},L6.setBoundingBoxCenter=function(e,t,i){this.maxPos.x=e+.5*this._nodeSize.x,this.maxPos.y=t+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=e-.5*this._nodeSize.x,this.minPos.y=t-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()},L6._initModuleList=function(){var t=this;kK.forEach(function(e){e=t._particleSystem[e];e&&e.enable&&(e.needUpdate&&(t._updateList[e.name]=e),e.needAnimate&&(t._animateList[e.name]=e))});for(var e=this._runAnimateList.length=0,i=R8.length;e<i;e++){var n=this._animateList[R8[e]];n&&this._runAnimateList.push(n)}},L6._emit=function(e,t,i){var n=this._particleSystem,r=this._node,o=n.time%n.duration/n.duration;r.invalidateChildren(Q0.POSITION),n.simulationSpace===O8.World&&(r.getWorldMatrix(FK),r.getWorldRotation(zK));for(var a=0;a<e;++a){var s=new y8(n),c=(s.particleSystem=n,s.reset(),Wn(jn(0,fn))),l=(n._shapeModule&&n._shapeModule.enable?n._shapeModule.emit(s):(ce.set(s.position,0,0,0),ce.copy(s.velocity,G8)),n._textureAnimationModule&&n._textureAnimationModule.enable&&n._textureAnimationModule.init(s),n.startSpeed.evaluate(o,c));ce.multiplyScalar(s.velocity,s.velocity,l),n.simulationSpace===O8.World&&(ce.transformMat4(s.position,s.position,FK),ce.transformQuat(s.velocity,s.velocity,zK)),ce.copy(s.ultimateVelocity,s.velocity),ce.set(s.rotation,0,0,0),n.startSize3D?ce.set(s.startSize,n.startSizeX.evaluate(o,c),n.startSizeY.evaluate(o,c),n.startSizeZ.evaluate(o,c)):(ce.set(s.startSize,n.startSizeX.evaluate(o,c),1,1),s.startSize.y=s.startSize.x),ce.copy(s.size,s.startSize),s.startLifetime=n.startLifetime.evaluate(o,c)+t,s.remainingLifetime=s.startLifetime,i.push(s)}},L6._updateParticles=function(i,n){var e,r=this,o=this._particleSystem;switch(o.node.getWorldMatrix(FK),o.scaleSpace){case O8.Local:o.node.getScale(UK);break;case O8.World:o.node.getWorldScale(UK)}this._updateList.forEach(function(e){e.update(o.simulationSpace,FK)}),o.simulationSpace===O8.Local&&(e=o.node.getRotation(),B.fromQuat(this._localMat,e),this._localMat.transpose());for(var t=0;t<n.length;++t)!function(e){var t=n[e];t.remainingLifetime-=i,ce.set(t.animatedVelocity,0,0,0),o.simulationSpace===O8.Local?(e=9.8*-o.gravityModifier.evaluate(1-t.remainingLifetime/t.startLifetime,Wn(t.randomSeed))*i,r._gravity.x=0,r._gravity.y=e,r._gravity.z=0,r._gravity.w=1,r._gravity=r._gravity.transformMat4(r._localMat),t.velocity.x+=r._gravity.x,t.velocity.y+=r._gravity.y,t.velocity.z+=r._gravity.z):t.velocity.y-=9.8*o.gravityModifier.evaluate(1-t.remainingLifetime/t.startLifetime,Wn(t.randomSeed))*i,ce.copy(t.ultimateVelocity,t.velocity),r._runAnimateList.forEach(function(e){e.animate(t,i)}),ce.scaleAndAdd(t.position,t.position,t.ultimateVelocity,i)}(t)},L6._calculateBounding=function(e){var t,i,n=new ce,r=new ce,o=new ce,a=new ce,s=new ce(1,1,1);this._processor.getInfo().renderMode===L8.Mesh&&(i=this._processor.getInfo().mesh)&&i.struct.minPosition&&i.struct.maxPosition&&(t=new qh,qh.fromPoints(t,i.struct.minPosition,i.struct.maxPosition),i=Math.max(t.halfExtents.x,t.halfExtents.y,t.halfExtents.z),s.set(i,i,i));for(var c=0;c<this._particlesAll.length;++c){var l=this._particlesAll[c];ce.multiply(n,UK,l.size),ce.multiply(n,n,s),r.set(l.position),this._particleSystem.simulationSpace!==O8.World&&ce.transformMat4(r,r,this._particleSystem.node._mat),e&&0===c?(ce.subtract(this.minPos,r,n),ce.add(this.maxPos,r,n)):(ce.subtract(o,r,n),ce.add(a,r,n),ce.min(this.minPos,this.minPos,o),ce.max(this.maxPos,this.maxPos,a))}},L6.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var e=Wn(jn(0,fn));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,e),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},L6.clear=function(){this._particlesAll.length=0},L6.destroy=function(){},YK),HK=new B,VK=new gr,jK=Object.getOwnPropertyDescriptor(ND.prototype,"sharedMaterials"),WK=(Aw=f("cc.ParticleSystem"),w=wp(),zp=Ep(),Np=Oa(99),t=Dp(),EW=m(),kw=u(),pF=v(_8),pte=m(),I=u(),P=v(O8),pi=m(),Qp=u(),C=m(),xH=u(),die=yp("startSize"),vie=Dp(),tl=v(H6),Sa=m(),E2=u(),y=v(H6),fie=Dp(),aie=m(),yU=u(),A=v(H6),Rie=Dp(),Fp=m(),Iie=u(),hl=v(H6),Nk=Dp(),Pc=m(),x=u(),vI=m(),Up=u(),o=v(H6),R=Dp(),S=m(),cM=u(),yI=v(H6),kp=Dp(),Hd=m(),b=u(),uI=v(H6),Ac=yp("startRotation"),Xp=Dp(),ane=m(),dU=u(),Lc=v(H6),a=Dp(),s=m(),W3=u(),Ce=v(H6),h=Dp(),C7=m(),Y3=u(),ul=m(),B1=u(),il=m(),bne=u(),Op=m(),Mp=u(),Z5=v(O8),Mne=m(),kd=u(),Gd=m(),Nw=u(),nl=m(),Bp=u(),n=v(H6),g=Dp(),L6=m(),SJ=u(),EJ=v(H6),vre=Dp(),mre=m(),GZ=u(),UJ=v(H6),zJ=Dp(),KJ=m(),u$=u(),c$=v([Cp]),a$=m(),r$=u(),i$=v(Boolean),HZ=m(),N$=u(),O$=v(M8),R$=m(),q$=u(),X$=v(Number),W$=m(),V$=u(),VZ=v(Number),aee=m(),nee=u(),iee=v(Number),bee=m(),Cee=u(),Eee=m(),Bee=u(),vee=yp("enableCulling"),nie=Pp(),Fee=v(Ey),zee=Rp(),jZ=v(XN),XN=v(XN),Uee=m(),kee=u(),Gee=v(bp),bp=v(bp),Hee=m(),Vee=u(),jee=v(r),r=v(r),Wee=m(),WZ=u(),qee=v(ll),ll=v(ll),Xee=m(),Yee=u(),Kee=v(rl),rl=v(rl),Qee=m(),Zee=u(),Jee=v(E),E=v(E),$ee=m(),ete=u(),tte=v(_l),_l=v(_l),ite=m(),nte=u(),rte=v(Bc),Bc=v(Bc),ote=m(),qZ=u(),ate=v(ba),ba=v(ba),ste=m(),cte=u(),lte=v(PK),ute=m(),hte=u(),Np=Aw(zp=w(zp=zp(zp=Np(zp=Tp((l(XK,AK=ND),(Aw=XK.prototype).onFocusInEditor=function(){this.renderer.create(this)},Aw.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},Aw._onMaterialModified=function(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)},Aw._onRebuildPSO=function(e,t){this.processor.onRebuildPSO(e,t)},Aw._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},Aw._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},Aw._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},Aw.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},Aw.play=function(){var e;this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor&&(e=this.processor.getModel())&&(e.enabled=this.enabledInHierarchy)},Aw.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},Aw.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var e,t=ge(this.bursts);!(e=t()).done;)e.value.reset()},Aw.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},Aw.getParticleCount=function(){return this.processor.getParticleCount()},Aw.setCustomData1=function(e,t){U.set(this._customData1,e,t)},Aw.setCustomData2=function(e,t){U.set(this._customData2,e,t)},Aw.onDestroy=function(){j.director.off(j.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},Aw.onEnable=function(){j.director.on(j.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},Aw.onDisable=function(){j.director.off(j.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},Aw._calculateBounding=function(e){this._boundingBox&&(this._culler||(this._culler=new GK(this)),this._culler.calculatePositions(),qh.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),e?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},Aw.update=function(e){e*=this.simulationSpeed;if(this.renderCulling){this._boundingBox||(this._boundingBox=new qh,this._calculateBounding(!1)),this._curPos||(this._curPos=new ce),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new ce,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler&&(t=this._curPos.x-this._oldPos.x,i=this._curPos.y-this._oldPos.y,n=this._curPos.z-this._oldPos.z,(r=this._boundingBox.center).x+=t,r.y+=i,r.z+=n,this._culler.setBoundingBoxCenter(r.x,r.y,r.z),this._oldPos.set(this._curPos));var t,i,n,r,o=null==(t=this.node.scene.renderScene)?void 0:t.cameras,a=!0;if(void 0!==o&&this._boundingBox)for(var s=0;s<o.length;++s){var c=o[s];if((c.visibility&this.node.layer)===this.node.layer&&Ch.aabbFrustum(this._boundingBox,c.frustum)){a=!1;break}}if(a){if(this._cullingMode!==M8.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===M8.PauseAndCatchup&&(this._time+=e),this._cullingMode!==M8.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;this._isPlaying?(this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop()):(i=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0],this.processor.updateRotation(i),this.processor.updateScale(i)),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},Aw.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},Aw._onVisibilityChange=function(e){this.processor._model&&(this.processor._model.visFlags=e)},Aw.emit=function(e,t){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(Q0.POSITION),this._needRefresh=!1),this._simulationSpace===O8.World&&(this.node.getWorldMatrix(HK),this.node.getWorldRotation(VK));for(var n=0;n<e;++n){var r=this.processor.getFreeParticle();if(null===r)return;r.particleSystem=this,r.reset();var o=Wn(jn(0,fn)),a=(this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(ce.set(r.position,0,0,0),ce.copy(r.velocity,G8)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r),this.startSpeed.evaluate(i,o));ce.multiplyScalar(r.velocity,r.velocity,a),this._simulationSpace===O8.World&&(ce.transformMat4(r.position,r.position,HK),ce.transformQuat(r.velocity,r.velocity,VK)),ce.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?r.startEuler.set(this.startRotationX.evaluate(i,o),this.startRotationY.evaluate(i,o),this.startRotationZ.evaluate(i,o)):r.startEuler.set(0,0,this.startRotationZ.evaluate(i,o)),r.rotation.set(r.startEuler),this.startSize3D?ce.set(r.startSize,this.startSizeX.evaluate(i,o),this.startSizeY.evaluate(i,o),this.startSizeZ.evaluate(i,o)):(ce.set(r.startSize,this.startSizeX.evaluate(i,o),1,1),r.startSize.y=r.startSize.x),ce.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(i,o)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(i,o)+t,r.remainingLifetime=r.startLifetime,r.randomSeed=jn(0,233280),r.loopCount++,this.processor.setNewParticle(r)}},Aw._prewarmSystem=function(){this.startDelay.mode=G6.Constant,this.startDelay.constant=0;for(var e=+this.duration,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)},Aw._emit=function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t)if(this._time>this.duration+t&&!this.loop)this._isEmitting=!1;else{this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting&&(t=Math.floor(this._emitRateTimeCounter),this._emitRateTimeCounter-=t,this.emit(t,e)),this.node.getWorldPosition(this._curWPos);var t=ce.distance(this._curWPos,this._oldWPos);ce.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=t*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting&&(t=Math.floor(this._emitRateDistanceCounter),this._emitRateDistanceCounter-=t,this.emit(t,e));for(var i,n=ge(this.bursts);!(i=n()).done;)i.value.update(this,e)}},Aw._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),ce.copy(this._curWPos,this._oldWPos)},Aw.addSubEmitter=function(e){this._subEmitters.push(e)},Aw.removeSubEmitter=function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)},Aw.addBurst=function(e){this.bursts.push(e)},Aw.removeBurst=function(e){this.bursts.splice(this.bursts.indexOf(e),1)},Aw.getBoundingX=function(){return this._aabbHalfX},Aw.getBoundingY=function(){return this._aabbHalfY},Aw.getBoundingZ=function(){return this._aabbHalfZ},Aw.setBoundingX=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=e)},Aw.setBoundingY=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=e)},Aw.setBoundingZ=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=e)},Aw._onBeforeSerialize=function(e){var t=this;return this.dataCulling?e.filter(function(e){return!D8.includes(e)||t[e]&&t[e].enable}):e},e(XK,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(0<e?e:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(e){!(this._renderCulling=e)||this._boundingBox||(this._boundingBox=new qh,this._calculateBounding(!1))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(e){this._cullingMode=e}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(e){this.setBoundingX(e)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(e){this.setBoundingY(e)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(e){this.setBoundingZ(e)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(e){this._dataCulling=e}},{key:"sharedMaterials",get:function(){return jK.get.call(this)},set:function(e){jK.set.call(this,e)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),XK.CullingMode=M8,i((w=XK).prototype,"capacity",[t,EW,kw],Object.getOwnPropertyDescriptor(w.prototype,"capacity"),w.prototype),G9=i(w.prototype,"startColor",[pF,d,pte,I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _8}}),H9=i(w.prototype,"scaleSpace",[P,d,pi,Qp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O8.Local}}),V9=i(w.prototype,"startSize3D",[d,C,xH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),j9=i(w.prototype,"startSizeX",[die,vie,tl,Sa,E2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),W9=i(w.prototype,"startSizeY",[y,d,fie,aie,yU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),q9=i(w.prototype,"startSizeZ",[A,d,Rie,Fp,Iie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),X9=i(w.prototype,"startSpeed",[hl,d,Nk,Pc,x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Y9=i(w.prototype,"startRotation3D",[d,vI,Up],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K9=i(w.prototype,"startRotationX",[o,d,R,Lp,S,cM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Q9=i(w.prototype,"startRotationY",[yI,d,kp,Lp,Hd,b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),Z9=i(w.prototype,"startRotationZ",[uI,Ac,Xp,Lp,ane,dU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),J9=i(w.prototype,"startDelay",[Lc,d,a,s,W3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),$9=i(w.prototype,"startLifetime",[Ce,d,h,C7,Y3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),eK=i(w.prototype,"duration",[d,ul,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),tK=i(w.prototype,"loop",[d,il,bne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i(w.prototype,"prewarm",[Op,Mp],Object.getOwnPropertyDescriptor(w.prototype,"prewarm"),w.prototype),i(w.prototype,"simulationSpace",[Z5,d,Mne,kd],Object.getOwnPropertyDescriptor(w.prototype,"simulationSpace"),w.prototype),iK=i(w.prototype,"simulationSpeed",[d,Gd,Nw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nK=i(w.prototype,"playOnAwake",[d,nl,Bp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rK=i(w.prototype,"gravityModifier",[n,d,g,L6,SJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),oK=i(w.prototype,"rateOverTime",[EJ,d,vre,mre,GZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),aK=i(w.prototype,"rateOverDistance",[UJ,d,zJ,KJ,u$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H6}}),sK=i(w.prototype,"bursts",[c$,d,a$,r$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),i(w.prototype,"renderCulling",[i$,HZ,N$],Object.getOwnPropertyDescriptor(w.prototype,"renderCulling"),w.prototype),cK=i(w.prototype,"_renderCulling",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(w.prototype,"cullingMode",[O$,R$,q$],Object.getOwnPropertyDescriptor(w.prototype,"cullingMode"),w.prototype),lK=i(w.prototype,"_cullingMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M8.Pause}}),i(w.prototype,"aabbHalfX",[X$,W$,V$],Object.getOwnPropertyDescriptor(w.prototype,"aabbHalfX"),w.prototype),uK=i(w.prototype,"_aabbHalfX",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(w.prototype,"aabbHalfY",[VZ,aee,nee],Object.getOwnPropertyDescriptor(w.prototype,"aabbHalfY"),w.prototype),hK=i(w.prototype,"_aabbHalfY",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(w.prototype,"aabbHalfZ",[iee,bee,Cee],Object.getOwnPropertyDescriptor(w.prototype,"aabbHalfZ"),w.prototype),pK=i(w.prototype,"_aabbHalfZ",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(w.prototype,"dataCulling",[Eee,Bee],Object.getOwnPropertyDescriptor(w.prototype,"dataCulling"),w.prototype),_K=i(w.prototype,"_dataCulling",[d,vee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i(w.prototype,"sharedMaterials",[Gp,nie,Fee,d,zee],Object.getOwnPropertyDescriptor(w.prototype,"sharedMaterials"),w.prototype),fK=i(w.prototype,"_colorOverLifetimeModule",[jZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"colorOverLifetimeModule",[XN,Uee,kee],Object.getOwnPropertyDescriptor(w.prototype,"colorOverLifetimeModule"),w.prototype),dK=i(w.prototype,"_shapeModule",[Gee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"shapeModule",[bp,Hee,Vee],Object.getOwnPropertyDescriptor(w.prototype,"shapeModule"),w.prototype),mK=i(w.prototype,"_sizeOvertimeModule",[jee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"sizeOvertimeModule",[r,Wee,WZ],Object.getOwnPropertyDescriptor(w.prototype,"sizeOvertimeModule"),w.prototype),gK=i(w.prototype,"_velocityOvertimeModule",[qee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"velocityOvertimeModule",[ll,Xee,Yee],Object.getOwnPropertyDescriptor(w.prototype,"velocityOvertimeModule"),w.prototype),vK=i(w.prototype,"_forceOvertimeModule",[Kee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"forceOvertimeModule",[rl,Qee,Zee],Object.getOwnPropertyDescriptor(w.prototype,"forceOvertimeModule"),w.prototype),yK=i(w.prototype,"_limitVelocityOvertimeModule",[Jee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"limitVelocityOvertimeModule",[E,$ee,ete],Object.getOwnPropertyDescriptor(w.prototype,"limitVelocityOvertimeModule"),w.prototype),xK=i(w.prototype,"_rotationOvertimeModule",[tte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"rotationOvertimeModule",[_l,ite,nte],Object.getOwnPropertyDescriptor(w.prototype,"rotationOvertimeModule"),w.prototype),SK=i(w.prototype,"_textureAnimationModule",[rte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"textureAnimationModule",[Bc,ote,qZ],Object.getOwnPropertyDescriptor(w.prototype,"textureAnimationModule"),w.prototype),bK=i(w.prototype,"_trailModule",[ate],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i(w.prototype,"trailModule",[ba,ste,cte],Object.getOwnPropertyDescriptor(w.prototype,"trailModule"),w.prototype),TK=i(w.prototype,"renderer",[lte,d,ute,hte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new PK}}),EK=i(w.prototype,"_prewarm",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CK=i(w.prototype,"_capacity",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),wK=i(w.prototype,"_simulationSpace",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O8.Local}}),zp=w))||zp)||zp)||zp)||zp)||zp,Rre({ParticleSystem:Np,ParticleSystemComponent:Np}),Np),Aw=Rre("ParticleUtils",(qK.instantiate=function(e){return this.registeredSceneEvent||(ZP.on(KP.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new Tt(function(){return Zf(e)||new N1},1,function(e){return e.destroy()})),this.particleSystemPool.get(e._uuid).alloc()},qK.destroy=function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))},qK.play=function(e){for(var t,i=ge(e.getComponentsInChildren(WK));!(t=i()).done;)t.value.play()},qK.stop=function(e){for(var t,i=ge(e.getComponentsInChildren(WK));!(t=i()).done;)t.value.stop()},qK.onSceneUnload=function(){this.particleSystemPool.forEach(function(e){return e.destroy()}),this.particleSystemPool.clear()},qK));function qK(){}function XK(){var e;return _(e=AK.call(this)||this,"startColor",G9,p(e)),_(e,"scaleSpace",H9,p(e)),_(e,"startSize3D",V9,p(e)),_(e,"startSizeX",j9,p(e)),_(e,"startSizeY",W9,p(e)),_(e,"startSizeZ",q9,p(e)),_(e,"startSpeed",X9,p(e)),_(e,"startRotation3D",Y9,p(e)),_(e,"startRotationX",K9,p(e)),_(e,"startRotationY",Q9,p(e)),_(e,"startRotationZ",Z9,p(e)),_(e,"startDelay",J9,p(e)),_(e,"startLifetime",$9,p(e)),_(e,"duration",eK,p(e)),_(e,"loop",tK,p(e)),_(e,"simulationSpeed",iK,p(e)),_(e,"playOnAwake",nK,p(e)),_(e,"gravityModifier",rK,p(e)),_(e,"rateOverTime",oK,p(e)),_(e,"rateOverDistance",aK,p(e)),_(e,"bursts",sK,p(e)),_(e,"_renderCulling",cK,p(e)),_(e,"_cullingMode",lK,p(e)),_(e,"_aabbHalfX",uK,p(e)),_(e,"_aabbHalfY",hK,p(e)),_(e,"_aabbHalfZ",pK,p(e)),_(e,"_dataCulling",_K,p(e)),_(e,"_colorOverLifetimeModule",fK,p(e)),_(e,"_shapeModule",dK,p(e)),_(e,"_sizeOvertimeModule",mK,p(e)),_(e,"_velocityOvertimeModule",gK,p(e)),_(e,"_forceOvertimeModule",vK,p(e)),_(e,"_limitVelocityOvertimeModule",yK,p(e)),_(e,"_rotationOvertimeModule",xK,p(e)),_(e,"_textureAnimationModule",SK,p(e)),_(e,"_trailModule",bK,p(e)),_(e,"renderer",TK,p(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,_(e,"_prewarm",EK,p(e)),_(e,"_capacity",CK,p(e)),_(e,"_simulationSpace",wK,p(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needRefresh=!0,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new ce,e._curWPos=new ce,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new U,e._customData2=new U,e._subEmitters=[],e}function YK(e){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new B,this._gravity=new Fr,this.minPos=new ce,this.maxPos=new ce,this._nodePos=new ce,this._nodeSize=new ce,this._particleSystem=e,this._processor=this._particleSystem.processor,this._node=e.node,this._particlesAll=[],this._initModuleList()}function KK(){_(this,"_enable",P9,this),_(this,"mode",I9,this),_(this,"lifeTime",R9,this),_(this,"_minParticleDistance",D9,this),_(this,"existWithParticles",O9,this),_(this,"textureMode",M9,this),_(this,"widthFromParticle",N9,this),_(this,"widthRatio",L9,this),_(this,"colorFromParticle",B9,this),_(this,"colorOverTrail",F9,this),_(this,"colorOvertime",z9,this),_(this,"_space",U9,this),_(this,"_particleSystem",k9,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new Ma([new Da]),this._vertAttrs=[new Wa(fa.ATTR_POSITION,W.RGB32F),new Wa(fa.ATTR_TEX_COORD,W.RGBA32F),new Wa(fa.ATTR_TEX_COORD1,W.RGB32F),new Wa(fa.ATTR_COLOR,W.RGBA8,!0)],this._vertSize=0;for(var e=ge(this._vertAttrs);!(t=e()).done;){var t=t.value;this._vertSize+=dc[t.format].size}this._particleTrail=new Map}function QK(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new ce,lifetime:0,width:0,velocity:new ce,direction:0,color:new nr})}function ZK(){_(this,"_renderMode",X7,this),_(this,"_velocityScale",Y7,this),_(this,"_lengthScale",K7,this),_(this,"_mesh",Q7,this),_(this,"_mainTexture",Z7,this),_(this,"_useGPU",J7,this),_(this,"_alignSpace",$7,this),this._particleSystem=null}function JK(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}Aw.particleSystemPool=new Map,Aw.registeredSceneEvent=!1,Ee(Cp.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),In(WK.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),j.ParticleSystemComponent=WK,gt.setClassAlias(WK,"cc.ParticleSystemComponent"),j.BillboardComponent=c,gt.setClassAlias(c,"cc.BillboardComponent"),j.LineComponent=YD,gt.setClassAlias(YD,"cc.LineComponent"),j.ParticleUtils=Aw;var $K,eQ,tQ,iQ,nQ,rQ,oQ,aQ=function i(n,r,o){function a(t,e){if(!r[t]){if(!n[t]){if(!e&&JK)return JK();if(s)return s(t,!0);throw new Error("Cannot find module '"+t+"'")}e=r[t]={exports:{}};n[t][0].call(e.exports,function(e){return a(n[t][1][e]||e)},e,e.exports,i,n,r,o)}return r[t].exports}for(var s=JK,e=0;e<o.length;e++)a(o[e]);return a}({1:[function(e,t){t.exports={name:"@cocos/cannon",version:"1.2.8",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m",postpublish:"cnpm sync @cocos/cannon"},main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World"),Octree:e("./utils/Octree")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Octree":51,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t){var i=e("../math/Vec3");function n(e){e=e||{},this.lowerBound=new i,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new i,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=n;var l=new i,o=(n.prototype.setFromPoints=function(e,t,i,n){var r=this.lowerBound,o=this.upperBound,a=i;r.copy(e[0]),a&&a.vmult(r,r),o.copy(r);for(var s=1;s<e.length;s++){var c=e[s];a&&(a.vmult(c,l),c=l),c.x>o.x&&(o.x=c.x),c.x<r.x&&(r.x=c.x),c.y>o.y&&(o.y=c.y),c.y<r.y&&(r.y=c.y),c.z>o.z&&(o.z=c.z),c.z<r.z&&(r.z=c.z)}return t&&(t.vadd(r,r),t.vadd(o,o)),n&&(r.x-=n,r.y-=n,r.z-=n,o.x+=n,o.y+=n,o.z+=n),this},n.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},n.prototype.clone=function(){return(new n).copy(this)},n.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},n.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,e=e.upperBound,r=n.x<=i.x&&i.x<=e.x||t.x<=e.x&&e.x<=i.x,o=n.y<=i.y&&i.y<=e.y||t.y<=e.y&&e.y<=i.y,n=n.z<=i.z&&i.z<=e.z||t.z<=e.z&&e.z<=i.z;return r&&o&&n},n.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},n.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,e=e.upperBound;return t.x<=n.x&&i.x>=e.x&&t.y<=n.y&&i.y>=e.y&&t.z<=n.z&&i.z>=e.z},n.prototype.getCorners=function(e,t,i,n,r,o,a,s){var c=this.lowerBound,l=this.upperBound;e.copy(c),t.set(l.x,c.y,c.z),i.set(l.x,l.y,c.z),n.set(c.x,l.y,l.z),r.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),a.set(c.x,c.y,l.z),s.copy(l)},[new i,new i,new i,new i,new i,new i,new i,new i]);n.prototype.toLocalFrame=function(e,t){var i=o;this.getCorners(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]);for(var n=0;8!==n;n++){var r=i[n];e.pointToLocal(r,r)}return t.setFromPoints(i)},n.prototype.toWorldFrame=function(e,t){var i=o;this.getCorners(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7]);for(var n=0;8!==n;n++){var r=i[n];e.pointToWorld(r,r)}return t.setFromPoints(i)},n.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,t=(this.upperBound.x-e.from.x)*t,o=(this.lowerBound.y-e.from.y)*i,i=(this.upperBound.y-e.from.y)*i,a=(this.lowerBound.z-e.from.z)*n,e=(this.upperBound.z-e.from.z)*n,n=Math.max(Math.max(Math.min(r,t),Math.min(o,i)),Math.min(a,e)),r=Math.min(Math.min(Math.max(r,t),Math.max(o,i)),Math.max(a,e));return!(r<0||r<n)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t){function i(){this.matrix=[]}(t.exports=i).prototype.get=function(e,t){var i;return e=e.index,(t=t.index)>e&&(i=t,t=e,e=i),this.matrix[(e*(e+1)>>1)+t-1]},i.prototype.set=function(e,t,i){var n;e=e.index,(t=t.index)>e&&(n=t,t=e,e=n),this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},i.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},i.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t){var r=e("../objects/Body"),i=e("../math/Vec3"),n=e("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=o).prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(e,t){if(0==(e.collisionFilterGroup&t.collisionFilterMask)||0==(t.collisionFilterGroup&e.collisionFilterMask))return!1;var i=0!=(e.type&r.STATIC),n=0!=(t.type&r.STATIC);return!(i&&n||!e.hasTrigger&&!t.hasTrigger&&e.sleepState===r.SLEEPING&&t.sleepState===r.SLEEPING)},o.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var a=new i,h=(new i,new n,new i,o.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var r=a,o=(t.position.vsub(e.position,r),Math.pow(e.boundingRadius+t.boundingRadius,2));r.norm2()<o&&(i.push(e),n.push(t))},o.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))},{keys:[]}),p=[],_=[],s=(o.prototype.makePairsUnique=function(e,t){for(var i=h,n=p,r=_,o=e.length,a=0;a!==o;a++)n[a]=e[a],r[a]=t[a];for(e.length=0,a=t.length=0;a!==o;a++){var s=n[a].id,c=r[a].id;i[l=s<c?s+","+c:c+","+s]=a,i.keys.push(l)}for(a=0;a!==i.keys.length;a++){var l=i.keys.pop(),u=i[l];e.push(n[u]),t.push(r[u]),delete i[l]}},o.prototype.setWorld=function(){},new i);o.boundingSphereCheck=function(e,t){var i=s;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t){t.exports=i;var s=e("./Broadphase"),c=e("../math/Vec3"),J=e("../shapes/Shape");function i(e,t,i,n,r){s.apply(this),this.nx=i||10,this.ny=n||10,this.nz=r||10,this.aabbMin=e||new c(100,100,100),this.aabbMax=t||new c(-100,-100,-100);var o=this.nx*this.ny*this.nz;if(o<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=o,this.binLengths.length=o;for(var a=0;a<o;a++)this.bins[a]=[],this.binLengths[a]=0}(i.prototype=new s).constructor=i;var $=new c;new c,i.prototype.collisionPairs=function(e,t,i){for(var B=e.numObjects(),F=e.bodies,e=this.aabbMax,n=this.aabbMin,m=this.nx,g=this.ny,v=this.nz,y=g*v,x=v,S=1,r=e.x,o=e.y,e=e.z,b=n.x,T=n.y,E=n.z,C=m/(r-b),w=g/(o-T),A=v/(e-E),a=(r-b)/m,s=(o-T)/g,c=(e-E)/v,z=.5*Math.sqrt(a*a+s*s+c*c),n=J.types,U=n.SPHERE,k=n.PLANE,P=(n.BOX,n.COMPOUND,n.CONVEXPOLYHEDRON,this.bins),I=this.binLengths,l=this.bins.length,u=0;u!==l;u++)I[u]=0;var R=Math.ceil;function h(e,t,i,n,r,o,a){var e=(e-b)*C|0,s=(t-T)*w|0,c=(i-E)*A|0,l=R((n-b)*C),u=R((r-T)*w),h=R((o-E)*A);e<0?e=0:m<=e&&(e=m-1),s<0?s=0:g<=s&&(s=g-1),c<0?c=0:v<=c&&(c=v-1),l<0?l=0:m<=l&&(l=m-1),u<0?u=0:g<=u&&(u=g-1),h<0?h=0:v<=h&&(h=v-1),s*=x,c*=S,l*=y,u*=x,h*=S;for(var p=e*=y;p<=l;p+=y)for(var _=s;_<=u;_+=x)for(var f=c;f<=h;f+=S){var d=p+_+f;P[d][I[d]++]=a}}for(Math.min,Math.max,u=0;u!==B;u++){var p=(L=F[u]).shape;switch(p.type){case U:var _=L.position.x,f=L.position.y,d=L.position.z,D=p.radius;h(_-D,f-D,d-D,_+D,f+D,d+D,L);break;case k:p.worldNormalNeedsUpdate&&p.computeWorldNormal(L.quaternion);var G=p.worldNormal,_=b+.5*a-L.position.x,H=T+.5*s-L.position.y,V=E+.5*c-L.position.z,O=$;O.set(_,H,V);for(var j,M=0,W=0;M!==m;M++,W+=y,O.y=H,O.x+=a)for(var N=0,q=0;N!==g;N++,q+=x,O.z=V,O.y+=s)for(var X=0,Y=0;X!==v;X++,Y+=S,O.z+=c)O.dot(G)<z&&(P[j=W+q+Y][I[j]++]=L);break;default:L.aabbNeedsUpdate&&L.computeAABB(),h(L.aabb.lowerBound.x,L.aabb.lowerBound.y,L.aabb.lowerBound.z,L.aabb.upperBound.x,L.aabb.upperBound.y,L.aabb.upperBound.z,L)}}for(u=0;u!==l;u++){var K=I[u];if(1<K)for(var Q=P[u],M=0;M!==K;M++)for(var L=Q[M],N=0;N!==M;N++){var Z=Q[N];this.needBroadphaseCollision(L,Z)&&this.intersectionTest(L,Z,t,i)}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t){t.exports=n;var i=e("./Broadphase"),t=e("./AABB");function n(){i.apply(this)}((n.prototype=new i).constructor=n).prototype.collisionPairs=function(e,t,i){for(var n,r,o,a=e.bodies,s=a.length,c=0;c!==s;c++)for(n=0;n!==c;n++)r=a[c],o=a[n],this.needBroadphaseCollision(r,o)&&this.intersectionTest(r,o,t,i)},new t,n.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var r=e.bodies[n];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t){function i(){this.matrix={}}(t.exports=i).prototype.get=function(e,t){var i;return e=e.id,(t=t.id)>e&&(i=t,t=e,e=i),e+"-"+t in this.matrix},i.prototype.set=function(e,t,i){var n;e=e.id,(t=t.id)>e&&(n=t,t=e,e=n),i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},i.prototype.reset=function(){this.matrix={}},i.prototype.setNumObjects=function(){}},{}],9:[function(e,t){function i(){this.current=[],this.previous=[]}function u(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=i).prototype.getKey=function(e,t){var i;return t<e&&(i=t,t=e,e=i),e<<16|t},i.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,r=0;i>n[r];)r++;if(i!==n[r]){for(t=n.length-1;r<=t;t--)n[t+1]=n[t];n[r]=i}},i.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},i.prototype.getDiff=function(e,t){for(var i=this.current,n=this.previous,r=i.length,o=n.length,a=0,s=0;s<r;s++){for(var c=i[s];c>n[a];)a++;c!==n[a]&&u(e,c)}for(s=a=0;s<o;s++){for(var l=n[s];l>i[a];)a++;i[a]!==l&&u(t,l)}}},{}],10:[function(e,t){t.exports=l;var h=e("../math/Vec3"),t=e("../math/Quaternion"),T=e("../math/Transform"),i=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),n=e("../shapes/Shape"),f=e("../collision/AABB");function l(e,t){this.from=e?e.clone():new h,this.to=t?t.clone():new h,this._direction=new h,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=l.ANY,this.result=new i,this.hasHit=!1,this.callback=function(){}}(l.prototype.constructor=l).CLOSEST=1,l.ANY=2,l.ALL=4;var r=new f,o=[],a=(l.prototype.intersectWorld=function(e,t){return this.mode=t.mode||l.ANY,this.result=t.result||new i,this.skipBackfaces=!!t.skipBackfaces,this.checkCollisionResponse=!!t.checkCollisionResponse,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(r),o.length=0,e.broadphase.aabbQuery(e,r,o),this.intersectBodies(o),this.hasHit},new h),s=new h;function C(e,t,i,n){n.vsub(t,y),i.vsub(t,a),e.vsub(t,s);var r,n=y.dot(y),i=y.dot(a),e=y.dot(s),t=a.dot(a),o=a.dot(s);return 0<=(r=t*e-i*o)&&0<=(o=n*o-i*e)&&r+o<n*t-i*i}l.pointInTriangle=C;var c=new h,u=new t,w=(l.prototype.intersectBody=function(e,t){if(t&&(this.result=t,this._updateDirection()),(!this.checkCollisionResponse||e.collisionResponse)&&l.perBodyFilter(this,e))for(var i=c,n=u,r=0,o=e.shapes.length;r<o;r++){var a=e.shapes[r];if(l.perShapeFilter(this,a)&&(e.quaternion.mult(e.shapeOrientations[r],n),e.quaternion.vmult(e.shapeOffsets[r],i),i.vadd(e.position,i),this.intersectShape(a,n,i,e),this.result._shouldStop))break}},l.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},l.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},l.prototype.intersectShape=function(e,t,i,n){var r,o,a,s;r=this.from,o=this._direction,(a=i).vsub(r,y),s=y.dot(o),o.mult(s,x),x.vadd(r,x),a.distanceTo(x)>e.boundingSphereRadius||(o=this[e.type])&&o.call(this,e,t,i,n,e)},new h,new h,new h),A=new h,P=new h,I=new h,d=(new h,new i,l.prototype[n.types.BOX]=l.prototype.intersectBox=function(e,t,i,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,r)},l.prototype[n.types.PLANE]=l.prototype.intersectPlane=function(e,t,i,n,r){var o,a=this.from,s=this.to,c=this._direction,l=new h(0,0,1),t=(t.vmult(l,l),new h),u=(a.vsub(i,t),t.dot(l));s.vsub(i,t),0<u*t.dot(l)||a.distanceTo(s)<u||(t=l.dot(c),Math.abs(t)<this.precision||(s=new h,u=new h,o=new h,a.vsub(i,s),i=-l.dot(s)/t,c.scale(i,u),a.vadd(u,o),this.reportIntersection(l,o,r,n,-1)))},l.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)},{faceList:[0]}),m=new h,g=new l,v=[],p=(l.prototype[n.types.HEIGHTFIELD]=l.prototype.intersectHeightfield=function(e,t,i,n,r){e.data,e.elementSize;var o=g;o.from.copy(this.from),o.to.copy(this.to),T.pointToLocalFrame(i,t,o.from,o.from),T.pointToLocalFrame(i,t,o.to,o.to),o._updateDirection();var a,s,c=v,l=h=e.data.length-1,u=new f;o.getAABB(u),e.getIndexOfPosition(u.lowerBound.x,u.lowerBound.y,c,!0),s=Math.max(0,c[0]),a=Math.max(0,c[1]),e.getIndexOfPosition(u.upperBound.x,u.upperBound.y,c,!0),l=Math.min(l,c[0]+1);for(var h=Math.min(h,c[1]+1),p=s;p<l;p++)for(var _=a;_<h;_++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(p,_,u),u.overlapsRay(o)){if(e.getConvexTrianglePillar(p,_,!1),T.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,d),this.result._shouldStop)return;e.getConvexTrianglePillar(p,_,!0),T.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,d)}}},new h),_=new h,R=(l.prototype[n.types.SPHERE]=l.prototype.intersectSphere=function(e,t,i,n,r){var o,a=this.from,s=this.to,e=e.radius,c=Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2)+Math.pow(s.z-a.z,2),l=2*((s.x-a.x)*(a.x-i.x)+(s.y-a.y)*(a.y-i.y)+(s.z-a.z)*(a.z-i.z)),e=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(e,2),e=Math.pow(l,2)-4*c*e,u=p,h=_;e<0||(0==e?(a.lerp(s,e,u),u.vsub(i,h),h.normalize(),this.reportIntersection(h,u,r,n,-1)):(o=(-l-Math.sqrt(e))/(2*c),l=(-l+Math.sqrt(e))/(2*c),0<=o&&o<=1&&(a.lerp(s,o,u),u.vsub(i,h),h.normalize(),this.reportIntersection(h,u,r,n,-1)),this.result._shouldStop||0<=l&&l<=1&&(a.lerp(s,l,u),u.vsub(i,h),h.normalize(),this.reportIntersection(h,u,r,n,-1))))},new h),D=(new h,new h,new h),E=(l.prototype[n.types.CONVEXPOLYHEDRON]=l.prototype.intersectConvex=function(e,t,i,n,r,o){for(var a=R,s=D,c=o&&o.faceList||null,l=e.faces,u=e.vertices,h=e.faceNormals,p=this._direction,_=this.from,o=this.to,f=_.distanceTo(o),d=(c||l).length,m=this.result,g=0;!m._shouldStop&&g<d;g++){var v=c?c[g]:g,y=l[v],x=h[v],S=t,b=i,x=(s.copy(u[y[0]]),S.vmult(s,s),s.vadd(b,s),s.vsub(_,s),S.vmult(x,a),p.dot(a));if(!(Math.abs(x)<this.precision)){x=a.dot(s)/x;if(!(x<0)){p.mult(x,w),w.vadd(_,w),A.copy(u[y[0]]),S.vmult(A,A),b.vadd(A,A);for(var T=1;!m._shouldStop&&T<y.length-1;T++){P.copy(u[y[T]]),I.copy(u[y[T+1]]),S.vmult(P,P),S.vmult(I,I),b.vadd(P,P),b.vadd(I,I);var E=w.distanceTo(_);!C(w,A,P,I)&&!C(w,P,A,I)||f<E||this.reportIntersection(a,w,r,n,v)}}}}},new h),O=new h,M=new h,N=new h,L=new h,B=new h,F=(new f,[]),z=new T,y=(l.prototype[n.types.TRIMESH]=l.prototype.intersectTrimesh=function(e,t,i,n,r,o){var a=E,s=F,c=z,l=D,u=O,h=M,p=N,_=B,f=L,d=(o&&o.faceList,e.indices),o=(e.vertices,e.faceNormals,this.from),m=this.to,g=this._direction,v=(c.position.copy(i),c.quaternion.copy(t),T.vectorToLocalFrame(i,t,g,u),T.pointToLocalFrame(i,t,o,h),T.pointToLocalFrame(i,t,m,p),p.x*=e.scale.x,p.y*=e.scale.y,p.z*=e.scale.z,h.x*=e.scale.x,h.y*=e.scale.y,h.z*=e.scale.z,p.vsub(h,u),u.normalize(),h.distanceSquared(p));e.tree.rayQuery(this,c,s);for(var y=0,x=s.length;!this.result._shouldStop&&y!==x;y++){var S=s[y],b=(e.getNormal(S,a),e.getVertex(d[3*S],A),A.vsub(h,l),u.dot(a)),b=a.dot(l)/b;b<0||(u.scale(b,w),w.vadd(h,w),e.getVertex(d[3*S+1],P),e.getVertex(d[3*S+2],I),b=w.distanceSquared(h),!C(w,P,A,I)&&!C(w,A,P,I)||v<b||(T.vectorToWorldFrame(t,a,f),T.pointToWorldFrame(i,t,w,_),this.reportIntersection(f,_,r,n,S)))}s.length=0},l.prototype.reportIntersection=function(e,t,i,n,r){var o=this.from,a=this.to,s=o.distanceTo(t),c=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(c.hitFaceIndex=void 0!==r?r:-1,this.mode){case l.ALL:this.hasHit=!0,c.set(o,a,e,t,i,n,s),c.hasHit=!0,this.callback(c);break;case l.CLOSEST:(s<c.distance||!c.hasHit)&&(this.hasHit=!0,c.hasHit=!0,c.set(o,a,e,t,i,n,s));break;case l.ANY:this.hasHit=!0,c.hasHit=!0,c.set(o,a,e,t,i,n,s),c._shouldStop=!0}},new h),x=new h;l.perBodyFilter=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)},l.perShapeFilter=function(e,t){return!(e.checkCollisionResponse&&!t.collisionResponse)}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t){var i=e("../math/Vec3");function n(){this.rayFromWorld=new i,this.rayToWorld=new i,this.hitNormalWorld=new i,this.hitPointWorld=new i,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=n).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},n.prototype.abort=function(){this._shouldStop=!0},n.prototype.set=function(e,t,i,n,r,o,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=r,this.body=o,this.distance=a}},{"../math/Vec3":31}],12:[function(e,t){e("../shapes/Shape");var i=e("../collision/Broadphase");function u(e){i.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){e=t.indexOf(e.body);-1!==e&&t.splice(e,1)},e&&this.setWorld(e)}((t.exports=u).prototype=new i).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},u.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.x<=n.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=n}return e},u.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.y<=n.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=n}return e},u.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.z<=n.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=n}return e},u.prototype.collisionPairs=function(e,t,i){var n,r=this.axisList,o=r.length,a=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==o;n++)for(var s=r[n],c=n+1;c<o;c++){var l=r[c];if(this.needBroadphaseCollision(s,l)){if(!u.checkBounds(s,l,a))break;this.intersectionTest(s,l,t,i)}}},u.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var r=e[n];r.aabbNeedsUpdate&&r.computeAABB()}0===t?u.insertionSortX(e):1===t?u.insertionSortY(e):2===t&&u.insertionSortZ(e)},u.checkBounds=function(e,t,i){0===i?(n=e.position.x,r=t.position.x):1===i?(n=e.position.y,r=t.position.y):2===i&&(n=e.position.z,r=t.position.z);var n,r,i=e.boundingRadius;return r-t.boundingRadius<n+i},u.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,r=0,o=0,a=this.axisList,s=a.length,c=1/s,l=0;l!==s;l++){var u=a[l],h=u.position.x,h=(e+=h,t+=h*h,u.position.y),h=(i+=h,n+=h*h,u.position.z);r+=h,o+=h*h}var p=t-e*e*c,_=n-i*i*c,c=o-r*r*c;this.axisIndex=_<p?c<p?0:2:c<_?1:2},u.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);for(var n=this.axisIndex,n=2===n?"z":1===n?"y":"x",r=this.axisList,o=(t.lowerBound[n],t.upperBound[n],0);o<r.length;o++){var a=r[o];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(t)&&i.push(a)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t){t.exports=i,e("./Constraint");var a=e("./PointToPointConstraint"),s=e("../equations/ConeEquation"),c=e("../equations/RotationalEquation"),l=(e("../equations/ContactEquation"),e("../math/Vec3"));function i(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new l,o=i.pivotB?i.pivotB.clone():new l,r=(this.axisA=i.axisA?i.axisA.clone():new l,this.axisB=i.axisB?i.axisB.clone():new l,a.call(this,e,r,t,o,n),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0,this.coneEquation=new s(e,t,i)),o=this.twistEquation=new c(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,r.maxForce=0,r.minForce=-n,o.maxForce=0,o.minForce=-n,this.equations.push(r,o)}i.prototype=new a,i.constructor=i,new l,new l,i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;a.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),e.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t){t.exports=r;var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":54}],15:[function(e,t){t.exports=i;var r=e("./Constraint"),o=e("../equations/ContactEquation");function i(e,t,i,n){r.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===n&&(n=1e6),this.distance=i;i=this.distanceEquation=new o(e,t);this.equations.push(i),i.minForce=-n,i.maxForce=n}(i.prototype=new r).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,r=i.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(n,i.ri),r.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t){t.exports=i,e("./Constraint");var l=e("./PointToPointConstraint"),a=e("../equations/RotationalEquation"),s=e("../equations/RotationalMotorEquation"),c=(e("../equations/ContactEquation"),e("../math/Vec3"));function i(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new c,o=i.pivotB?i.pivotB.clone():new c,r=(l.call(this,e,r,t,o,n),(this.axisA=i.axisA?i.axisA.clone():new c(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new c(1,0,0)).normalize(),this.rotationalEquation1=new a(e,t,i)),o=this.rotationalEquation2=new a(e,t,i),i=this.motorEquation=new s(e,t,n);i.enabled=!1,this.equations.push(r,o,i)}i.prototype=new l,(i.constructor=i).prototype.enableMotor=function(){this.motorEquation.enabled=!0},i.prototype.disableMotor=function(){this.motorEquation.enabled=!1},i.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},i.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var u=new c,h=new c;i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,n=this.rotationalEquation1,r=this.rotationalEquation2,o=u,a=h,s=this.axisA,c=this.axisB;l.prototype.update.call(this),e.quaternion.vmult(s,o),t.quaternion.vmult(c,a),o.tangents(n.axisA,r.axisA),n.axisB.copy(a),r.axisB.copy(a),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t){t.exports=i,e("./Constraint");var s=e("./PointToPointConstraint"),c=e("../equations/RotationalEquation"),l=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function i(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=new l,o=new l,a=new l,a=(e.position.vadd(t.position,a),a.scale(.5,a),t.pointToLocalFrame(a,o),e.pointToLocalFrame(a,r),s.call(this,e,r,t,o,n),this.xA=e.vectorToLocalFrame(l.UNIT_X),this.xB=t.vectorToLocalFrame(l.UNIT_X),this.yA=e.vectorToLocalFrame(l.UNIT_Y),this.yB=t.vectorToLocalFrame(l.UNIT_Y),this.zA=e.vectorToLocalFrame(l.UNIT_Z),this.zB=t.vectorToLocalFrame(l.UNIT_Z),this.rotationalEquation1=new c(e,t,i)),r=this.rotationalEquation2=new c(e,t,i),o=this.rotationalEquation3=new c(e,t,i);this.equations.push(a,r,o)}i.prototype=new s,i.constructor=i,new l,new l,i.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),n=this.rotationalEquation2,r=this.rotationalEquation3;s.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,n.axisA),t.vectorToWorldFrame(this.zB,n.axisB),e.vectorToWorldFrame(this.zA,r.axisA),t.vectorToWorldFrame(this.xB,r.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t){t.exports=i;var o=e("./Constraint"),a=e("../equations/ContactEquation"),s=e("../math/Vec3");function i(e,t,i,n,r){o.call(this,e,i),r=void 0!==r?r:1e6,this.pivotA=t?t.clone():new s,this.pivotB=n?n.clone():new s;t=this.equationX=new a(e,i),n=this.equationY=new a(e,i),e=this.equationZ=new a(e,i);this.equations.push(t,n,e),t.minForce=n.minForce=e.minForce=-r,t.maxForce=n.maxForce=e.maxForce=r,t.ni.set(1,0,0),n.ni.set(0,1,0),e.ni.set(0,0,1)}(i.prototype=new o).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t){t.exports=i;var r=e("../math/Vec3"),o=(e("../math/Mat3"),e("./Equation"));function i(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;o.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(i.prototype=new o).constructor=i;var l=new r,u=new r;i.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,o=l,a=u,s=this.jacobianElementA,c=this.jacobianElementB;return n.cross(r,o),r.cross(n,a),s.rotational.copy(a),c.rotational.copy(o),-(Math.cos(this.angle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t){t.exports=i;var n=e("./Equation"),r=e("../math/Vec3");function i(e,t,i){n.call(this,e,t,0,i=void 0!==i?i:1e6),this.si=null,this.sj=null,this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),(i.prototype=new n).constructor=i;var g=new r,v=new r,y=new r,o=(i.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,r=this.bj,o=this.ri,a=this.rj,s=g,c=v,l=n.velocity,u=n.angularVelocity,h=(n.force,n.torque,r.velocity),p=r.angularVelocity,_=(r.force,r.torque,y),f=this.jacobianElementA,d=this.jacobianElementB,m=this.ni,f=(o.cross(m,s),a.cross(m,c),m.negate(f.spatial),s.negate(f.rotational),d.spatial.copy(m),d.rotational.copy(c),_.copy(r.position),_.vadd(a,_),_.vsub(n.position,_),_.vsub(o,_),m.dot(_)),d=this.restitution+1;return-f*t-(d*h.dot(m)-d*l.dot(m)+p.dot(c)-u.dot(s))*i-e*this.computeGiMf()},new r),a=new r,s=new r,c=new r,l=new r;i.prototype.getImpactVelocityAlongNormal=function(){var e=o,t=a,i=s,n=c,r=l;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t){t.exports=o;var r=e("../math/JacobianElement"),t=e("../math/Vec3");function o(e,t,i,n){this.id=o.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===n?1e6:n,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new r,this.jacobianElementB=new r,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(o.prototype.constructor=o).id=0,o.prototype.setSpookParams=function(e,t,i){this.a=4/(i*(1+4*t)),this.b=4*t/(1+4*t),this.eps=4/(i*i*e*(1+4*t))},o.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},o.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,i=i.position,n=n.position;return e.spatial.dot(i)+t.spatial.dot(n)},new t,o.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.velocity,o=n.velocity,i=i.angularVelocity,n=n.angularVelocity;return e.multiplyVectors(r,i)+t.multiplyVectors(o,n)},o.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.vlambda,o=n.vlambda,i=i.wlambda,n=n.wlambda;return e.multiplyVectors(r,i)+t.multiplyVectors(o,n)};var u=new t,h=new t,p=new t,_=new t,a=(o.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.force,o=i.torque,a=n.force,s=n.torque,c=i.invMassSolve,l=n.invMassSolve;return r.scale(c,u),a.scale(l,h),i.invInertiaWorldSolve.vmult(o,p),n.invInertiaWorldSolve.vmult(s,_),e.multiplyVectors(u,p)+t.multiplyVectors(h,_)},new t),s=(o.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.invMassSolve,o=n.invMassSolve,i=i.invInertiaWorldSolve,n=n.invInertiaWorldSolve,r=r+o;return i.vmult(e.rotational,a),r+=a.dot(e.rotational),n.vmult(t.rotational,a),r+a.dot(t.rotational)},new t);new t,new t,new t,new t,new t,o.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,r=this.bj,o=s;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,i.spatial,r.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,o),n.wlambda.addScaledVector(e,o,n.wlambda),r.invInertiaWorldSolve.vmult(i.rotational,o),r.wlambda.addScaledVector(e,o,r.wlambda)},o.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t){t.exports=i;var n=e("./Equation"),r=e("../math/Vec3");function i(e,t,i){n.call(this,e,t,-i,i),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),(i.prototype=new n).constructor=i;var s=new r,c=new r;i.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,r=s,o=c,a=this.t,i=(i.cross(a,r),n.cross(a,o),this.jacobianElementA),n=this.jacobianElementB;return a.negate(i.spatial),r.negate(i.rotational),n.spatial.copy(a),n.rotational.copy(o),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t){t.exports=i;var r=e("../math/Vec3"),o=(e("../math/Mat3"),e("./Equation"));function i(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;o.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.maxAngle=Math.PI/2}(i.prototype=new o).constructor=i;var l=new r,u=new r;i.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,o=l,a=u,s=this.jacobianElementA,c=this.jacobianElementB;return n.cross(r,o),r.cross(n,a),s.rotational.copy(a),c.rotational.copy(o),-(Math.cos(this.maxAngle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t){t.exports=i;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function i(e,t,i){r.call(this,e,t,-(i=void 0!==i?i:1e6),i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}((i.prototype=new r).constructor=i).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,r=this.jacobianElementA,o=this.jacobianElementB;return r.rotational.copy(i),n.negate(o.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t){var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=r.idCounter++,this.materials=[e,t],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}(t.exports=r).idCounter=0},{"../utils/Utils":54}],26:[function(e,t){function i(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=i.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1,this.correctInelastic=0}(t.exports=i).idCounter=0},{}],27:[function(e,t){t.exports=n;var i=e("./Vec3");function n(){this.spatial=new i,this.rotational=new i}n.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},n.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t){t.exports=l;var u=e("./Vec3");function l(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}l.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},l.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},l.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},l.prototype.getTrace=function(e){e=e||new u;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},l.prototype.vmult=function(e,t){t=t||new u;var i=this.elements,n=e.x,r=e.y,e=e.z;return t.x=i[0]*n+i[1]*r+i[2]*e,t.y=i[3]*n+i[4]*r+i[5]*e,t.z=i[6]*n+i[7]*r+i[8]*e,t},l.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},l.prototype.mmult=function(e,t){for(var i=t||new l,n=0;n<3;n++)for(var r=0;r<3;r++){for(var o=0,a=0;a<3;a++)o+=e.elements[n+3*a]*this.elements[a+3*r];i.elements[n+3*r]=o}return i},l.prototype.scale=function(e,t){t=t||new l;for(var i=this.elements,n=t.elements,r=0;3!==r;r++)n[3*r+0]=e.x*i[3*r+0],n[3*r+1]=e.y*i[3*r+1],n[3*r+2]=e.z*i[3*r+2];return t},l.prototype.solve=function(e,t){t=t||new u;for(var i,n=[],r=0;r<12;r++)n.push(0);for(r=0;r<3;r++)for(i=0;i<3;i++)n[r+4*i]=this.elements[r+3*i];n[3]=e.x,n[7]=e.y,n[11]=e.z;var o,a=3,s=a;do{if(0===n[(r=s-a)+4*r])for(i=r+1;i<s;i++)if(0!==n[r+4*i]){for(l=4;n[(o=4-l)+4*r]+=n[o+4*i],--l;);break}if(0!==n[r+4*r])for(i=r+1;i<s;i++)for(var c=n[r+4*i]/n[r+4*r],l=4;n[(o=4-l)+4*i]=o<=r?0:n[o+4*i]-n[o+4*r]*c,--l;);}while(--a);if(t.z=n[11]/n[10],t.y=(n[7]-n[6]*t.z)/n[5],t.x=(n[3]-n[2]*t.z-n[1]*t.y)/n[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},l.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},l.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},l.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},l.prototype.reverse=function(e){e=e||new l;for(var t,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(t=0;t<3;t++)i[n+6*t]=this.elements[n+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,o=3,a=o;do{if(0===i[(n=a-o)+6*n])for(t=n+1;t<a;t++)if(0!==i[n+6*t]){for(c=6;i[(r=6-c)+6*n]+=i[r+6*t],--c;);break}if(0!==i[n+6*n])for(t=n+1;t<a;t++)for(var s=i[n+6*t]/i[n+6*n],c=6;i[(r=6-c)+6*t]=r<=n?0:i[r+6*t]-i[r+6*n]*s,--c;);}while(--o);n=2;do{t=n-1;do{for(s=i[n+6*t]/i[n+6*n],c=6;i[(r=6-c)+6*t]=i[r+6*t]-i[r+6*n]*s,--c;);}while(t--)}while(--n);n=2;do{for(s=1/i[n+6*n],c=6;i[(r=6-c)+6*n]=i[r+6*n]*s,--c;);}while(n--);n=2;do{t=2;do{if(r=i[3+t+6*n],isNaN(r)||r===1/0)throw"Could not reverse! A=["+this.toString()+"]"}while(e.e(n,t,r),t--)}while(n--);return e},l.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,e=e.w,r=t+t,o=i+i,a=n+n,s=t*r,c=t*o,t=t*a,l=i*o,i=i*a,n=n*a,r=e*r,o=e*o,e=e*a,a=this.elements;return a[0]=1-(l+n),a[1]=c-e,a[2]=t+o,a[3]=c+e,a[4]=1-(s+n),a[5]=i-r,a[6]=t-o,a[7]=i+r,a[8]=1-(s+l),this},l.prototype.transpose=function(e){for(var t=(e=e||new l).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)t[3*n+r]=i[3*r+n];return e}},{"./Vec3":31}],29:[function(e,t){t.exports=_;var h=e("./Vec3");function _(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}_.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},_.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},_.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},_.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},_.prototype.toAxisAngle=function(e){e=e||new h,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var n=new h,r=new h;_.prototype.setFromVectors=function(e,t){var i;return e.isAntiparallelTo(t)?(e.tangents(i=n,r),this.setFromAxisAngle(i,Math.PI)):(i=e.cross(t),this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()),this},new h,new h,new h,_.prototype.mult=function(e,t){t=t||new _;var i=this.x,n=this.y,r=this.z,o=this.w,a=e.x,s=e.y,c=e.z,e=e.w;return t.x=i*e+o*a+n*c-r*s,t.y=n*e+o*s+r*a-i*c,t.z=r*e+o*c+i*s-n*a,t.w=o*e-i*a-n*s-r*c,t},_.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,r=this.w,t=(e=e||new _,this.conjugate(e),1/(t*t+i*i+n*n+r*r));return e.x*=t,e.y*=t,e.z*=t,e.w*=t,e},_.prototype.conjugate=function(e){return(e=e||new _).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},_.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e=1/e,this.y*=e,this.z*=e,this.w*=e),this},_.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},_.prototype.vmult=function(e,t){t=t||new h;var i=e.x,n=e.y,e=e.z,r=this.x,o=this.y,a=this.z,s=this.w,c=s*i+o*e-a*n,l=s*n+a*i-r*e,u=s*e+r*n-o*i,i=-r*i-o*n-a*e;return t.x=c*s+i*-r+l*-a-u*-o,t.y=l*s+i*-o+u*-r-c*-a,t.z=u*s+i*-a+c*-o-l*-r,t},_.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},_.prototype.toEuler=function(e,t){t=t||"YZX";var i=this.x,n=this.y,r=this.z,o=this.w;if("YZX"!==t)throw new Error("Euler order "+t+" not supported yet.");var a,s,c,l,u,t=i*n+r*o;.499<t&&(c=2*Math.atan2(i,o),l=Math.PI/2,u=0),t<-.499&&(c=-2*Math.atan2(i,o),l=-Math.PI/2,u=0),isNaN(c)&&(a=i*i,s=r*r,c=Math.atan2(2*n*o-2*i*r,1-2*(n*n)-2*s),l=Math.asin(2*t),u=Math.atan2(2*i*o-2*n*r,1-2*a-2*s)),e.y=c,e.z=l,e.x=u},_.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var r=Math.cos(e/2),o=Math.cos(t/2),a=Math.cos(i/2),e=Math.sin(e/2),t=Math.sin(t/2),i=Math.sin(i/2);return"XYZ"===n?(this.x=e*o*a+r*t*i,this.y=r*t*a-e*o*i,this.z=r*o*i+e*t*a,this.w=r*o*a-e*t*i):"YXZ"===n?(this.x=e*o*a+r*t*i,this.y=r*t*a-e*o*i,this.z=r*o*i-e*t*a,this.w=r*o*a+e*t*i):"ZXY"===n?(this.x=e*o*a-r*t*i,this.y=r*t*a+e*o*i,this.z=r*o*i+e*t*a,this.w=r*o*a-e*t*i):"ZYX"===n?(this.x=e*o*a-r*t*i,this.y=r*t*a+e*o*i,this.z=r*o*i-e*t*a,this.w=r*o*a+e*t*i):"YZX"===n?(this.x=e*o*a+r*t*i,this.y=r*t*a+e*o*i,this.z=r*o*i-e*t*a,this.w=r*o*a-e*t*i):"XZY"===n&&(this.x=e*o*a-r*t*i,this.y=r*t*a-e*o*i,this.z=r*o*i+e*t*a,this.w=r*o*a+e*t*i),this},_.prototype.clone=function(){return new _(this.x,this.y,this.z,this.w)},_.prototype.slerp=function(e,t,i){i=i||new _;var n,r,o,a=this.x,s=this.y,c=this.z,l=this.w,u=e.x,h=e.y,p=e.z,e=e.w;return(o=a*u+s*h+c*p+l*e)<0&&(o=-o,u=-u,h=-h,p=-p,e=-e),o=1e-6<1-o?(o=Math.acos(o),n=Math.sin(o),r=Math.sin((1-t)*o)/n,Math.sin(t*o)/n):(r=1-t,t),i.x=r*a+o*u,i.y=r*s+o*h,i.z=r*c+o*p,i.w=r*l+o*e,i},_.prototype.integrate=function(e,t,i,n){n=n||new _;var r=e.x*i.x,o=e.y*i.y,e=e.z*i.z,i=this.x,a=this.y,s=this.z,c=this.w,t=.5*t;return n.x+=t*(r*c+o*s-e*a),n.y+=t*(o*c+e*i-r*s),n.z+=t*(e*c+r*a-o*i),n.w+=t*(-r*i-o*a-e*s),n},_.prototype.euqals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{"./Vec3":31}],30:[function(e,t){var r=e("./Vec3"),i=e("./Quaternion");function n(e){e=e||{},this.position=new r,e.position&&this.position.copy(e.position),this.quaternion=new i,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=n;var o=new i;n.pointToLocalFrame=function(e,t,i,n){return n=n||new r,i.vsub(e,n),t.conjugate(o),o.vmult(n,n),n},n.prototype.pointToLocal=function(e,t){return n.pointToLocalFrame(this.position,this.quaternion,e,t)},n.pointToWorldFrame=function(e,t,i,n){return n=n||new r,t.vmult(i,n),n.vadd(e,n),n},n.prototype.pointToWorld=function(e,t){return n.pointToWorldFrame(this.position,this.quaternion,e,t)},n.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t},n.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},n.vectorToLocalFrame=function(e,t,i,n){return n=n||new r,t.w*=-1,t.vmult(i,n),t.w*=-1,n}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t){t.exports=s;var i=e("./Mat3");function s(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1),s.prototype.cross=function(e,t){var i=e.x,n=e.y,e=e.z,r=this.x,o=this.y,a=this.z;return(t=t||new s).x=o*e-a*n,t.y=a*i-r*e,t.z=r*n-o*i,t},s.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},s.prototype.setZero=function(){this.x=this.y=this.z=0},s.prototype.vadd=function(e,t){if(!t)return new s(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},s.prototype.vsub=function(e,t){if(!t)return new s(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},s.prototype.crossmat=function(){return new i([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},s.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,e=Math.sqrt(e*e+t*t+i*i);return 0<e?(this.x*=t=1/e,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),e},s.prototype.unit=function(e){e=e||new s;var t=this.x,i=this.y,n=this.z,r=Math.sqrt(t*t+i*i+n*n);return 0<r?(e.x=t*(r=1/r),e.y=i*r,e.z=n*r):(e.x=1,e.y=0,e.z=0),e},s.prototype.length=s.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},s.prototype.lengthSquared=s.prototype.norm2=function(){return this.dot(this)},s.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,o=e.y,e=e.z;return Math.sqrt((r-t)*(r-t)+(o-i)*(o-i)+(e-n)*(e-n))},s.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,o=e.y,e=e.z;return(r-t)*(r-t)+(o-i)*(o-i)+(e-n)*(e-n)},s.prototype.mult=function(e,t){t=t||new s;var i=this.x,n=this.y,r=this.z;return t.x=e*i,t.y=e*n,t.z=e*r,t},s.prototype.vmul=function(e,t){return(t=t||new s).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},s.prototype.scale=s.prototype.mult,s.prototype.addScaledVector=function(e,t,i){return(i=i||new s).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},s.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},s.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},s.prototype.negate=function(e){return(e=e||new s).x=-this.x,e.y=-this.y,e.z=-this.z,e};var r=new s,o=new s,n=(s.prototype.tangents=function(e,t){var i,n=this.norm();0<n?((i=r).set(this.x*(n=1/n),this.y*n,this.z*n),n=o,Math.abs(i.x)<.9?n.set(1,0,0):n.set(0,1,0),i.cross(n,e),i.cross(e,t)):(e.set(1,0,0),t.set(0,1,0))},s.prototype.toString=function(){return this.x+","+this.y+","+this.z},s.prototype.toArray=function(){return[this.x,this.y,this.z]},s.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},s.prototype.lerp=function(e,t,i){var n=this.x,r=this.y,o=this.z;i.x=n+(e.x-n)*t,i.y=r+(e.y-r)*t,i.z=o+(e.z-o)*t},s.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},s.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)},new s);s.prototype.isAntiparallelTo=function(e,t){return this.negate(n),n.almostEquals(e,t)},s.prototype.clone=function(){return new s(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t){t.exports=m;var i=e("../utils/EventTarget"),f=e("../shapes/Shape"),o=e("../math/Vec3"),n=e("../math/Mat3"),a=e("../math/Quaternion"),r=(e("../material/Material"),e("../collision/AABB")),s=e("../shapes/Box"),t=e("../collision/RaycastResult"),d=e("../world/World");function m(e){e=e||{},i.apply(this),this.id=m.idCounter++,this.world=null,this.preStep=null,this.ccdSpeedThreshold=void 0!==e.ccdSpeedThreshold?e.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==e.ccdIterations?e.ccdIterations:5,this.postStep=null,this.vlambda=new o,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new o,this.previousPosition=new o,this.interpolatedPosition=new o,this.initPosition=new o,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new o,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new o,this.force=new o;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?m.STATIC:m.DYNAMIC,typeof e.type==typeof m.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new o,this.quaternion=new a,this.initQuaternion=new a,this.previousQuaternion=new a,this.interpolatedQuaternion=new a,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new o,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new o,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new o,this.invInertia=new o,this.invInertiaWorld=new n,this.invMassSolve=0,this.invInertiaSolve=new o,this.invInertiaWorldSolve=new n,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new o(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new o(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new r,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new o,e.shape&&this.addShape(e.shape),this.hasTrigger=!0,this.updateMassProperties()}((m.prototype=new i).constructor=m).COLLIDE_EVENT_NAME="collide",m.DYNAMIC=1,m.STATIC=2,m.KINEMATIC=4,m.AWAKE=0,m.SLEEPY=1,m.SLEEPING=2,m.idCounter=0,m.wakeupEvent={type:"wakeup"},m.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===m.SLEEPING&&this.dispatchEvent(m.wakeupEvent)},m.prototype.sleep=function(){this.sleepState=m.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},m.sleepyEvent={type:"sleepy"},m.sleepEvent={type:"sleep"},m.prototype.sleepTick=function(e){var t,i,n;this.allowSleep&&(t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2),t===m.AWAKE&&i<n?(this.sleepState=m.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(m.sleepyEvent)):t===m.SLEEPY&&n<i?this.wakeUp():t===m.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(m.sleepEvent)))},m.prototype.updateSolveMassProperties=function(){this.sleepState===m.SLEEPING||this.type===m.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},m.prototype.pointToLocalFrame=function(e,t){return t=t||new o,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},m.prototype.vectorToLocalFrame=function(e,t){return t=t||new o,this.quaternion.conjugate().vmult(e,t),t},m.prototype.pointToWorldFrame=function(e,t){return t=t||new o,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},m.prototype.vectorToWorldFrame=function(e,t){return t=t||new o,this.quaternion.vmult(e,t),t};var h=new o,p=new a,_=(m.prototype.addShape=function(e,t,i){var n=new o,r=new a;return t&&n.copy(t),i&&r.copy(i),this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(r),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),(d.idToShapeMap[e.id]=e).body=this},m.prototype.removeShape=function(e){e=this.shapes.indexOf(e);-1!==e&&(this.shapes.splice(e,1),this.shapeOffsets.splice(e,1),this.shapeOrientations.splice(e,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},m.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,r=0;r!==i;r++){var o=e[r],a=(o.updateBoundingSphereRadius(),t[r].norm()),o=o.boundingSphereRadius;n<a+o&&(n=a+o)}this.boundingRadius=n},new r),c=(m.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,r=h,o=p,a=this.quaternion,s=this.aabb,c=_,l=0;l!==n;l++){var u=e[l];a.vmult(t[l],r),r.vadd(this.position,r),i[l].mult(a,o),u.calculateWorldAABB(r,o,c.lowerBound,c.upperBound),0===l?s.copy(c):s.extend(c)}this.aabbNeedsUpdate=!1},new n),l=new n,u=(new n,m.prototype.updateInertiaWorld=function(e){var t,i=this.invInertia;i.x===i.y&&i.y===i.z&&!e||(e=l,(t=c).setRotationFromQuaternion(this.quaternion),t.transpose(e),t.scale(i,t),t.mmult(e,this.invInertiaWorld))},new o,new o),g=(m.prototype.applyForce=function(e,t){this.type===m.DYNAMIC&&(t.cross(e,t=u),this.force.vadd(e,this.force),this.torque.vadd(t,this.torque))},new o),v=new o,y=(m.prototype.applyLocalForce=function(e,t){var i;this.type===m.DYNAMIC&&(i=v,this.vectorToWorldFrame(e,e=g),this.vectorToWorldFrame(t,i),this.applyForce(e,i))},new o,new o),x=new o,B=(m.prototype.applyImpulse=function(e,t){var i;this.type===m.DYNAMIC&&(t=t,(i=y).copy(e),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity),t.cross(e,i=x),this.invInertiaWorld.vmult(i,i),this.angularVelocity.vadd(i,this.angularVelocity))},new o),F=new o,z=(m.prototype.applyLocalImpulse=function(e,t){var i;this.type===m.DYNAMIC&&(i=F,this.vectorToWorldFrame(e,e=B),this.vectorToWorldFrame(t,i),this.applyImpulse(e,i))},new o),S=(m.prototype.updateMassProperties=function(){var e=z,t=(this.invMass=0<this.mass?1/this.mass:0,this.inertia),i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),s.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},m.prototype.getVelocityAtWorldPoint=function(e,t){var i=new o;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},new o,new o,new o),b=(new a,new a),T=(m.prototype.integrate=function(e,t,i){var n,r,o,a,s,c,l,u,h;this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===m.DYNAMIC||d.integrateKinematic&&this.type===m.KINEMATIC)&&this.sleepState!==m.SLEEPING&&(n=this.velocity,r=this.angularVelocity,o=this.position,s=this.force,h=this.torque,a=this.quaternion,c=this.invMass,u=this.invInertiaWorld,l=this.linearFactor,n.x+=s.x*(c=c*e)*l.x,n.y+=s.y*c*l.y,n.z+=s.z*c*l.z,s=u.elements,c=this.angularFactor,l=h.x*c.x,u=h.y*c.y,h=h.z*c.z,r.x+=e*(s[0]*l+s[1]*u+s[2]*h),r.y+=e*(s[3]*l+s[4]*u+s[5]*h),r.z+=e*(s[6]*l+s[7]*u+s[8]*h),a.integrate(this.angularVelocity,e,this.angularFactor,a),t&&(i?a.normalizeFast():a.normalize()),this.type===m.DYNAMIC&&0<this.ccdSpeedThreshold&&this.velocity.length()>=Math.pow(this.ccdSpeedThreshold,2)&&this.integrateToTimeOfImpact(e)||(n.mult(e,S),o.vadd(S,o)),this.aabbNeedsUpdate=!0,this.updateInertiaWorld())},m.prototype.updateKinematic=function(e){this.type===m.KINEMATIC&&0!==e&&(this.velocity.setZero(),this.angularVelocity.setZero(),e=1/e,this.previousPosition.almostEquals(this.position)||(this.position.vsub(this.previousPosition,this.velocity),this.velocity.mult(e,this.velocity),this.aabbNeedsUpdate=!0),this.previousQuaternion.euqals(this.quaternion)||(this.previousQuaternion.conjugate(b),b.mult(this.quaternion,b),b.toEuler(this.angularVelocity),this.angularVelocity.mult(e,this.angularVelocity),this.aabbNeedsUpdate=!0))},m.prototype.applyGravity=function(e){var t,i,n,r;this.type===m.DYNAMIC&&(1==this.linearDamping?this.force.setZero():this.useGravity&&(t=e.x,i=e.y,e=e.z,n=this.force,r=this.mass,n.x+=r*t,n.y+=r*i,n.z+=r*e),1==this.angularDamping&&this.torque.setZero())},new o),E=new o,C=new o,w=new o,A=new o,P=new o,I=new t,R=new t,D=new t,O=new o,M=new o,N=new o,L=new n;m.prototype.integrateToTimeOfImpact=function(e){T.copy(this.velocity),T.normalize(),this.velocity.mult(e,C),C.vadd(this.position,E),E.vsub(this.position,A);for(var t,e=A.length(),i=this.collisionFilterGroup,n=1,r=this.collisionFilterGroup=0;r<this.shapes.length;r++){var o,a=this.shapes[r],s={collisionFilterMask:a.collisionFilterMask,collisionFilterGroup:a.collisionFilterGroup,skipBackfaces:!0};if(O.copy(this.position),O.vadd(A,M),m.DrawLine(O,M),this.world.raycastClosest(O,M,s,I),t=I.body,a.type===f.types.SPHERE&&(n=a.radius,d.ccdSphereAdvance)&&(N.copy(this.velocity),N.y=0,N.normalize(),O.copy(N),L.identity(),L.elements[0]=O.x,L.elements[1]=-O.z,L.elements[3]=O.z,L.elements[4]=O.x,w.set(0,a.radius,0),L.vmult(w,w),w.z=w.y,w.y=0,w.vadd(this.position,O),C.vadd(O,M),m.DrawLine(O,M),this.world.raycastClosest(O,M,s,R),w.negate(w),w.vadd(this.position,O),C.vadd(O,M),m.DrawLine(O,M),this.world.raycastClosest(O,M,s,D),R.hasHit&&(R.hitPointWorld.vsub(this.position,O),o=T.dot(O),(!I.hasHit||I.distance>o)&&(I.hasHit=!0,I.distance=o,t=R.body,T.mult(o,O),O.vadd(this.position,I.hitPointWorld))),D.hasHit&&(D.hitPointWorld.vsub(this.position,O),o=T.dot(O),(!I.hasHit||I.distance>o)&&(I.hasHit=!0,I.distance=o,t=D.body,T.mult(o,O),O.vadd(this.position,I.hitPointWorld)))),t)break}if(this.collisionFilterGroup=i,!t)return!1;I.hasHit&&m.DrawSphere(I.hitPointWorld,.05),R.hasHit&&m.DrawSphere(R.hitPointWorld,.05),D.hasHit&&m.DrawSphere(D.hitPointWorld,.05);(E=I.hitPointWorld).vsub(this.position,A),I.distance,P.copy(this.position);for(var c,l=0,u=0,h=1;u<=h&&l<this.ccdIterations;){l++,A.mult(c=(h+u)/2,S),P.vadd(S,this.position),this.computeAABB(),m.DrawSphere(this.position,n);var p,_=this.aabb.overlaps(t.aabb);_&&(this.world.narrowphase.getContacts([this],[t],this.world,p=[],[],[],[]),_=0<p.length),_?h=c:u=c}return i=h,this.position.copy(P),A.mult(i,S),this.position.vadd(S,this.position),!0},m.DrawSphere=m.DrawLine=function(){},m.prototype.isSleeping=function(){return this.sleepState===m.SLEEPING},m.prototype.isSleepy=function(){return this.sleepState===m.SLEEPY},m.prototype.isAwake=function(){return this.sleepState===m.AWAKE},m.prototype.updateHasTrigger=function(){for(var e=this.shapes.length;e--&&(this.hasTrigger=!this.shapes[e].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t){e("./Body");var P=e("../math/Vec3"),o=e("../math/Quaternion"),i=(e("../collision/RaycastResult"),e("../collision/Ray")),n=e("../objects/WheelInfo");function r(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=r,new P,new P,new P;var a=new P,s=new P,c=new P,l=(new i,r.prototype.addWheel=function(e){var e=new n(e=e||{}),t=this.wheelInfos.length;return this.wheelInfos.push(e),t},r.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new P,r.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},r.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},r.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},r.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},r.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,n=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var o=new P;for(this.getVehicleAxisWorld(this.indexForwardAxis,o),o.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<i;r++)this.castRay(t[r]);this.updateSuspension(e);for(var a=new P,s=new P,r=0;r<i;r++){var c=(_=t[r]).suspensionForce;c>_.maxSuspensionForce&&(c=_.maxSuspensionForce),_.raycastResult.hitNormalWorld.scale(c*e,a),_.raycastResult.hitPointWorld.vsub(n.position,s),n.applyImpulse(a,s)}this.updateFriction(e);var l=new P,u=new P,h=new P;for(r=0;r<i;r++){var p,_=t[r],f=(n.getVelocityAtWorldPoint(_.chassisConnectionPointWorld,h),1);1===this.indexUpAxis&&(f=-1),_.isInContact&&(this.getVehicleAxisWorld(this.indexForwardAxis,u),p=u.dot(_.raycastResult.hitNormalWorld),_.raycastResult.hitNormalWorld.scale(p,l),u.vsub(l,u),p=u.dot(h),_.deltaRotation=f*p*e/_.radius),!_.sliding&&_.isInContact||0===_.engineForce||!_.useCustomSlidingRotationalSpeed||(_.deltaRotation=(0<_.engineForce?1:-1)*_.customSlidingRotationalSpeed*e),Math.abs(_.brake)>Math.abs(_.engineForce)&&(_.deltaRotation=0),_.rotation+=_.deltaRotation,_.deltaRotation*=.99}},r.prototype.updateSuspension=function(){for(var e=this.chassisBody.mass,t=this.wheelInfos,i=t.length,n=0;n<i;n++){var r,o,a=t[n];a.isInContact?(r=a.suspensionRestLength-a.suspensionLength,r=a.suspensionStiffness*r*a.clippedInvContactDotSuspension,r-=((o=a.suspensionRelativeVelocity)<0?a.dampingCompression:a.dampingRelaxation)*o,a.suspensionForce=r*e,a.suspensionForce<0&&(a.suspensionForce=0)):a.suspensionForce=0}},r.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null},new P),u=new P,I=(r.prototype.castRay=function(e){var t=l,i=u,n=(this.updateWheelTransformWorld(e),this.chassisBody),r=-1,o=e.suspensionRestLength+e.radius,o=(e.directionWorld.scale(o,t),e.chassisConnectionPointWorld),t=(o.vadd(t,i),e.raycastResult),a=(t.reset(),n.collisionResponse),o=(n.collisionResponse=!1,this.world.rayTest(o,i,t),n.collisionResponse=a,t.body);return e.raycastResult.groundObject=0,o?(r=t.distance,e.raycastResult.hitNormalWorld=t.hitNormalWorld,e.isInContact=!0,i=t.distance,e.suspensionLength=i-e.radius,a=e.suspensionRestLength-e.maxSuspensionTravel,o=e.suspensionRestLength+e.maxSuspensionTravel,e.suspensionLength<a&&(e.suspensionLength=a),e.suspensionLength>o&&(e.suspensionLength=o,e.raycastResult.reset()),t=e.raycastResult.hitNormalWorld.dot(e.directionWorld),i=new P,n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,i),a=e.raycastResult.hitNormalWorld.dot(i),-.1<=t?(e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10):(e.suspensionRelativeVelocity=a*(o=-1/t),e.clippedInvContactDotSuspension=o)):(e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1),r},r.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},r.prototype.updateWheelTransform=function(e){var t=a,i=s,n=c,e=this.wheelInfos[e],n=(this.updateWheelTransformWorld(e),e.directionLocal.scale(-1,t),i.copy(e.axleLocal),t.cross(i,n),n.normalize(),i.normalize(),e.steering),r=new o,t=(r.setFromAxisAngle(t,n),new o),n=(t.setFromAxisAngle(i,e.rotation),e.worldTransform.quaternion),i=(this.chassisBody.quaternion.mult(r,n),n.mult(t,n),n.normalize(),e.worldTransform.position);i.copy(e.directionWorld),i.scale(e.suspensionLength,i),i.vadd(e.chassisConnectionPointWorld,i)},[new P(1,0,0),new P(0,1,0),new P(0,0,1)]),R=(r.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform},new P),D=[],O=[],M=(r.prototype.updateFriction=function(e){for(var t,i,n,r=R,o=this.wheelInfos,a=o.length,s=this.chassisBody,c=O,l=D,u=0;u<a;u++){var h=(w=o[u]).raycastResult.body;w.sideImpulse=0,w.forwardImpulse=0,c[u]||(c[u]=new P),l[u]||(l[u]=new P)}for(u=0;u<a;u++)(h=(w=o[u]).raycastResult.body)&&(t=l[u],this.getWheelTransformWorld(u).vectorToWorldFrame(I[this.indexRightAxis],t),i=w.raycastResult.hitNormalWorld,n=t.dot(i),i.scale(n,r),t.vsub(r,t),t.normalize(),i.cross(t,c[u]),c[u].normalize(),w.sideImpulse=function(e,t,i,n,r){if(1.1<r.norm2())return 0;var o=F,a=z,s=U;return e.getVelocityAtWorldPoint(t,o),i.getVelocityAtWorldPoint(n,a),o.vsub(a,s),-.2*r.dot(s)*(1/(e.invMass+i.invMass))}(s,w.raycastResult.hitPointWorld,h,w.raycastResult.hitPointWorld,t),w.sideImpulse*=1);var p,_,f,d;for(this.sliding=!1,u=0;u<a;u++){var m,g,v,y,x,S,b,h=(w=o[u]).raycastResult.body,T=0;w.slipInfo=1,h&&(m=w.brake||0,S=s,b=h,p=w.raycastResult.hitPointWorld,_=c[u],f=m,x=y=v=g=d=void 0,d=0,g=p,v=M,y=N,x=L,S.getVelocityAtWorldPoint(g,v),b.getVelocityAtWorldPoint(g,y),v.vsub(y,x),T=d=(d=f<(d=-_.dot(x)*(1/(B(S,p,_)+B(b,p,_))))?f:d)<-f?-f:d,g=m/(T+=w.engineForce*e),w.slipInfo*=g),w.forwardImpulse=0,w.skidInfo=1,h&&(w.skidInfo=1,y=(v=w.suspensionForce*e*w.frictionSlip)*v,w.forwardImpulse=T,b=(x=.5*w.forwardImpulse)*x+(S=+w.sideImpulse)*S,w.sliding=!1,y<b&&(this.sliding=!0,w.sliding=!0,g=v/Math.sqrt(b),w.skidInfo*=g))}if(this.sliding)for(u=0;u<a;u++)0!==(w=o[u]).sideImpulse&&w.skidInfo<1&&(w.forwardImpulse*=w.skidInfo,w.sideImpulse*=w.skidInfo);for(u=0;u<a;u++){var E,C,w=o[u],A=new P;w.raycastResult.hitPointWorld.vsub(s.position,A),0!==w.forwardImpulse&&(E=new P,c[u].scale(w.forwardImpulse,E),s.applyImpulse(E,A)),0!==w.sideImpulse&&(h=w.raycastResult.body,E=new P,w.raycastResult.hitPointWorld.vsub(h.position,E),C=new P,l[u].scale(w.sideImpulse,C),s.vectorToLocalFrame(A,A),A["xyz"[this.indexUpAxis]]*=w.rollInfluence,s.vectorToWorldFrame(A,A),s.applyImpulse(C,A),C.scale(-1,C),h.applyImpulse(C,E))}},new P),N=new P,L=new P;var h=new P,p=new P,_=new P,f=new P;function B(e,t,i){var n=h,r=p,o=_,a=f;return t.vsub(e.position,n),n.cross(i,r),e.invInertiaWorld.vmult(r,a),a.cross(n,o),e.invMass+i.dot(o)}var F=new P,z=new P,U=new P},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t){var r=e("./Body"),o=e("../shapes/Sphere"),i=e("../shapes/Box"),a=e("../math/Vec3"),s=e("../constraints/HingeConstraint");function n(e){this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new a(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,this.chassisBody||(e=new i(new a(5,2,.5)),this.chassisBody=new r(1,e)),this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=n).prototype.addWheel=function(e){var t=(t=(e=e||{}).body)||new r(1,new o(1.2)),i=(this.wheelBodies.push(t),this.wheelForces.push(0),new a,void 0!==e.position?e.position.clone():new a),n=new a,n=(this.chassisBody.pointToWorldFrame(i,n),t.position.set(n.x,n.y,n.z),void 0!==e.axis?e.axis.clone():new a(0,1,0)),e=(this.wheelAxes.push(n),new s(this.chassisBody,t,{pivotA:i,axisA:n,pivotB:a.ZERO,axisB:n,collideConnected:!1}));return this.constraints.push(e),this.wheelBodies.length-1},n.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=Math.cos(e),e=Math.sin(e),r=i.x,i=i.y;this.constraints[t].axisA.set(n*r-e*i,e*r+n*i,0)},n.prototype.setMotorSpeed=function(e,t){t=this.constraints[t];t.enableMotor(),t.motorTargetVelocity=e},n.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var c=new a,l=(n.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},n.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],t=this.wheelBodies[t],n=t.torque;i.scale(e,c),t.vectorToWorldFrame(c,c),n.vadd(c,n)},n.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},n.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},n.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])},new a);n.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],e=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,l),e.dot(l)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t){t.exports=i,e("../shapes/Shape");t=e("../math/Vec3");function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),i.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(e){e=this.particles.indexOf(e);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var c=new t,x=(i.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,r=this.smoothingRadius*this.smoothingRadius,o=c,a=0;a!==i;a++){var s=this.particles[a];s.position.vsub(e.position,o),n!==s.id&&o.norm2()<r&&t.push(s)}},new t),S=new t,b=new t,T=new t,E=new t,C=new t;i.prototype.update=function(){for(var e=this.particles.length,t=x,i=this.speedOfSound,n=this.eps,r=0;r!==e;r++){var o=this.particles[r];(d=this.neighbors[r]).length=0,this.getNeighbors(o,d),d.push(this.particles[r]);for(var a=d.length,s=0,c=0;c!==a;c++){o.position.vsub(d[c].position,t);var l=t.norm(),l=this.w(l);s+=d[c].mass*l}this.densities[r]=s,this.pressures[r]=i*i*(this.densities[r]-this.density)}for(var u=S,h=b,p=T,_=E,f=C,r=0;r!==e;r++){var d,m=this.particles[r];for(u.set(0,0,0),h.set(0,0,0),a=(d=this.neighbors[r]).length,c=0;c!==a;c++){var g=d[c],v=(m.position.vsub(g.position,_),_.norm()),y=-g.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[c]/(this.densities[c]*this.densities[c]+n));this.gradw(_,p),p.mult(y,p),u.vadd(p,u),g.velocity.vsub(m.velocity,f),f.mult(1/(1e-4+this.densities[r]*this.densities[c])*this.viscosity*g.mass,f),y=this.nablaw(v),f.mult(y,f),h.vadd(f,h)}h.mult(m.mass,h),u.mult(m.mass,u),m.force.vadd(h,m.force),m.force.vadd(u,m.force)}},i.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},i.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},i.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t){var n=e("../math/Vec3");function i(e,t,i){this.restLength="number"==typeof(i=i||{}).restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=i).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},i.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},i.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},i.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var m=new n,g=new n,v=new n,y=new n,x=new n,S=new n,b=new n,T=new n,E=new n,C=new n,w=new n;i.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,r=this.bodyB,o=m,a=g,s=v,c=y,l=w,u=x,h=S,p=b,_=T,f=E,d=C,h=(this.getWorldAnchorA(u),this.getWorldAnchorB(h),u.vsub(n.position,p),h.vsub(r.position,_),h.vsub(u,o),o.norm());a.copy(o),a.normalize(),r.velocity.vsub(n.velocity,s),r.angularVelocity.cross(_,l),s.vadd(l,s),n.angularVelocity.cross(p,l),s.vsub(l,s),a.mult(-e*(h-i)-t*s.dot(a),c),n.force.vsub(c,n.force),r.force.vadd(c,r.force),p.cross(c,f),_.cross(c,d),n.torque.vsub(f,n.torque),r.torque.vadd(d,r.torque)}},{"../math/Vec3":31}],37:[function(e,t){var i=e("../math/Vec3"),n=e("../math/Transform"),r=e("../collision/RaycastResult"),o=e("../utils/Utils");function a(e){e=o.defaults(e,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,axleWorld:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new n,this.isInContact=!1}t.exports=a;new i;var s=new i,c=new i;a.prototype.updateWheel=function(e){var t,i=this.raycastResult;this.isInContact?(t=i.hitNormalWorld.dot(i.directionWorld),i.hitPointWorld.vsub(e.position,s),e.getVelocityAtWorldPoint(s,c),e=i.hitNormalWorld.dot(c),-.1<=t?(this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10):(this.suspensionRelativeVelocity=e*(e=-1/t),this.clippedInvContactDotSuspension=e)):(i.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,i.directionWorld.scale(-1,i.hitNormalWorld),this.clippedInvContactDotSuspension=1)}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t){t.exports=n;var i=e("./Shape"),r=e("../math/Vec3"),o=e("./ConvexPolyhedron");function n(e){i.call(this,{type:i.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((n.prototype=new i).constructor=n).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=r,e=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],t=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new o(e,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=t).material=this.material},n.prototype.calculateLocalInertia=function(e,t){return t=t||new r,n.calculateInertia(this.halfExtents,e,t),t},n.calculateInertia=function(e,t,i){e.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(4*e.y*e.y+4*e.z*e.z),i.y=1/12*t*(4*e.x*e.x+4*e.z*e.z),i.z=1/12*t*(4*e.y*e.y+4*e.x*e.x))},n.prototype.getSideNormals=function(e,t){var i=e,e=this.halfExtents;if(i[0].set(e.x,0,0),i[1].set(0,e.y,0),i[2].set(0,0,e.z),i[3].set(-e.x,0,0),i[4].set(0,-e.y,0),i[5].set(0,0,-e.z),void 0!==t)for(var n=0;n!==i.length;n++)t.vmult(i[n],i[n]);return i},n.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},n.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new r,u=(new r,n.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],o=0;o<r.length;o++)a.set(r[o][0],r[o][1],r[o][2]),t.vmult(a,a),e.vadd(a,a),i(a.x,a.y,a.z)},[new r,new r,new r,new r,new r,new r,new r,new r]);n.prototype.calculateWorldAABB=function(e,t,i,n){var r=this.halfExtents,o=(u[0].set(r.x,r.y,r.z),u[1].set(-r.x,r.y,r.z),u[2].set(-r.x,-r.y,r.z),u[3].set(-r.x,-r.y,-r.z),u[4].set(r.x,-r.y,-r.z),u[5].set(r.x,r.y,-r.z),u[6].set(-r.x,r.y,-r.z),u[7].set(r.x,-r.y,r.z),u[0]);t.vmult(o,o),e.vadd(o,o),n.copy(o),i.copy(o);for(var a=1;a<8;a++){o=u[a],t.vmult(o,o),e.vadd(o,o);var s=o.x,c=o.y,l=o.z;s>n.x&&(n.x=s),c>n.y&&(n.y=c),l>n.z&&(n.z=l),s<i.x&&(i.x=s),c<i.y&&(i.y=c),l<i.z&&(i.z=l)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t){t.exports=a;var n=e("./Shape"),x=e("../math/Vec3"),_=(e("../math/Quaternion"),e("../math/Transform"));function a(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(a.prototype=new n).constructor=a;var u=new x,r=(a.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=u,r=0;r!==e.length;r++)for(var o=e[r],a=o.length,s=0;s!==a;s++){t[o[s]].vsub(t[o[(s+1)%a]],n),n.normalize();for(var c=!1,l=0;l!==i.length;l++)if(i[l].almostEquals(n)||i[l].almostEquals(n)){c=!0;break}c||i.push(n.clone())}},a.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new x;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i}},new x),o=new x,S=(a.computeNormal=function(e,t,i,n){t.vsub(e,o),i.vsub(t,r),r.cross(o,n),n.isZero()||n.normalize()},a.prototype.getFaceNormal=function(e,t){var e=this.faces[e],i=this.vertices[e[0]],n=this.vertices[e[1]],e=this.vertices[e[2]];return a.computeNormal(i,n,e,t)},new x),E=(a.prototype.clipAgainstHull=function(e,t,i,n,r,o,a,s,c){for(var l=S,u=-1,h=-Number.MAX_VALUE,p=0;p<i.faces.length;p++){l.copy(i.faceNormals[p]),r.vmult(l,l);var _=l.dot(o);h<_&&(h=_,u=p)}for(var f=[],d=i.faces[u],m=d.length,g=0;g<m;g++){var v=i.vertices[d[g]],y=new x;y.copy(v),r.vmult(y,y),n.vadd(y,y),f.push(y)}0<=u&&this.clipFaceAgainstHull(o,e,t,f,a,s,c)},new x),C=new x,w=new x,A=new x,P=new x,I=new x,s=(a.prototype.findSeparatingAxis=function(e,t,i,n,r,o,a,s){var c=E,l=C,u=w,h=A,p=P,_=I,f=Number.MAX_VALUE,d=this;if(d.uniqueAxes)for(g=0;g!==d.uniqueAxes.length;g++){if(i.vmult(d.uniqueAxes[g],c),!1===(x=d.testSepAxis(c,e,t,i,n,r)))return!1;x<f&&(f=x,o.copy(c))}else for(var m=(a||d.faces).length,g=0;g<m;g++){var v=a?a[g]:g;if(c.copy(d.faceNormals[v]),i.vmult(c,c),!1===(x=d.testSepAxis(c,e,t,i,n,r)))return!1;x<f&&(f=x,o.copy(c))}if(e.uniqueAxes)for(g=0;g!==e.uniqueAxes.length;g++){if(r.vmult(e.uniqueAxes[g],l),!1===(x=d.testSepAxis(l,e,t,i,n,r)))return!1;x<f&&(f=x,o.copy(l))}else for(var y=(s||e.faces).length,g=0;g<y;g++){var x,v=s?s[g]:g;if(l.copy(e.faceNormals[v]),r.vmult(l,l),!1===(x=d.testSepAxis(l,e,t,i,n,r)))return!1;x<f&&(f=x,o.copy(l))}for(var S=0;S!==d.uniqueEdges.length;S++){i.vmult(d.uniqueEdges[S],h);for(var b=0;b!==e.uniqueEdges.length;b++)if(r.vmult(e.uniqueEdges[b],p),h.cross(p,_),!_.almostZero()){_.normalize();var T=d.testSepAxis(_,e,t,i,n,r);if(!1===T)return!1;T<f&&(f=T,o.copy(_))}}return n.vsub(t,u),0<u.dot(o)&&o.negate(o),!0},[]),c=[],l=(a.prototype.testSepAxis=function(e,t,i,n,r,o){a.project(this,e,i,n,s),a.project(t,e,r,o,c);i=s[0],n=s[1],t=c[0],e=c[1];if(i<e||t<n)return!1;r=i-e,o=t-n;return r<o?r:o},new x),h=new x,O=(a.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(l,h);var i=h.x-l.x,n=h.y-l.y,r=h.z-l.z;t.x=1/12*e*(4*n*n+4*r*r),t.y=1/12*e*(4*i*i+4*r*r),t.z=1/12*e*(4*n*n+4*i*i)},a.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],e=this.faceNormals[e],t=this.vertices[t[0]];return-e.dot(t)},new x),M=new x,N=new x,L=new x,B=new x,F=new x,z=new x,U=new x,f=(a.prototype.clipFaceAgainstHull=function(e,t,i,n,r,o,a){for(var s=O,c=M,l=N,u=L,h=B,p=F,_=z,f=U,d=n,m=[],g=-1,v=Number.MAX_VALUE,y=0;y<this.faces.length;y++){s.copy(this.faceNormals[y]),i.vmult(s,s);var x=s.dot(e);x<v&&(v=x,g=y)}if(!(g<0)){var S=this.faces[g];S.connectedFaces=[];for(var b=0;b<this.faces.length;b++)for(var T=0;T<this.faces[b].length;T++)-1!==S.indexOf(this.faces[b][T])&&b!==g&&-1===S.connectedFaces.indexOf(b)&&S.connectedFaces.push(b);d.length;for(var E=S.length,C=0;C<E;C++){var w=this.vertices[S[C]],A=this.vertices[S[(C+1)%E]],A=(w.vsub(A,c),l.copy(c),i.vmult(l,l),t.vadd(l,l),u.copy(this.faceNormals[g]),i.vmult(u,u),t.vadd(u,u),l.cross(u,h),h.negate(h),p.copy(w),i.vmult(p,p),t.vadd(p,p),p.dot(h),S.connectedFaces[C]),P=(_.copy(this.faceNormals[A]),this.getPlaneConstantOfFace(A)),I=(f.copy(_),i.vmult(f,f),P-f.dot(t));for(this.clipFaceAgainstPlane(d,m,f,I);d.length;)d.shift();for(;m.length;)d.push(m.shift())}for(_.copy(this.faceNormals[g]),P=this.getPlaneConstantOfFace(g),f.copy(_),i.vmult(f,f),I=P-f.dot(t),b=0;b<d.length;b++){var R,D=f.dot(d[b])+I;(D=D<=r?r:D)<=o&&(R=d[b],D<=0&&a.push({point:R,normal:f,depth:D}))}}},a.prototype.clipFaceAgainstPlane=function(e,t,i,n){var r=e.length;if(r<2)return t;for(var o=e[e.length-1],a=(e[0],i.dot(o)+n),s=0;s<r;s++){var c,l=e[s],u=i.dot(l)+n;a<0?(u<0?(c=new x).copy(l):(c=new x,o.lerp(l,a/(a-u),c)),t.push(c)):u<0&&(c=new x,o.lerp(l,a/(a-u),c),t.push(c),t.push(l)),o=l,a=u}return t},a.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new x);for(var n=this.vertices,r=this.worldVertices,o=0;o!==i;o++)t.vmult(n[o],r[o]),e.vadd(r[o],r[o]);this.worldVerticesNeedsUpdate=!1},new x,a.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<i;r++){var o=n[r];o.x<e.x?e.x=o.x:o.x>t.x&&(t.x=o.x),o.y<e.y?e.y=o.y:o.y>t.y&&(t.y=o.y),o.z<e.z?e.z=o.z:o.z>t.z&&(t.z=o.z)}},a.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new x);for(var i=this.faceNormals,n=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(i[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},a.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var r=t[i].norm2();e<r&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)},new x),p=(a.prototype.calculateWorldAABB=function(e,t,i,n){for(var r,o,a,s,c,l,u=this.vertices.length,h=this.vertices,p=0;p<u;p++)f.copy(h[p]),t.vmult(f,f),e.vadd(f,f),(f.x<r||void 0===r)&&(r=f.x),(f.x>s||void 0===s)&&(s=f.x),(f.y<o||void 0===o)&&(o=f.y),(f.y>c||void 0===c)&&(c=f.y),(f.z<a||void 0===a)&&(a=f.z),(f.z>l||void 0===l)&&(l=f.z);i.set(r,o,a),n.set(s,c,l)},a.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},a.prototype.getAveragePointLocal=function(e){e=e||new x;for(var t=this.vertices.length,i=this.vertices,n=0;n<t;n++)e.vadd(i[n],e);return e.mult(1/t,e),e},a.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var r=0;r<i;r++){var o=n[r];t.vmult(o,o)}for(r=0;r<this.faceNormals.length;r++)o=this.faceNormals[r],t.vmult(o,o)}if(e)for(r=0;r<i;r++)(o=n[r]).vadd(e,o)},new x),d=new x,m=new x,g=(a.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,o=this.faces.length,a=p;this.getAveragePointLocal(a);for(var s=0;s<o;s++){this.faces[s].length;var t=r[s],c=i[n[s][0]],l=d,l=(e.vsub(c,l),t.dot(l)),u=m,c=(a.vsub(c,u),t.dot(u));if(l<0&&0<c||0<l&&c<0)return!1}return-1},new x,new x),v=new x;a.project=function(e,t,i,n,r){var o=e.vertices.length,a=g,s=0,c=0,l=v,u=e.vertices,e=(l.setZero(),_.vectorToLocalFrame(i,n,t,a),_.pointToLocalFrame(i,n,l,l),l.dot(a));c=s=u[0].dot(a);for(var h=1;h<o;h++){var p=u[h].dot(a);s<p&&(s=p),p<c&&(c=p)}(c-=e)>(s-=e)&&(t=c,c=s,s=t),r[0]=s,r[1]=c}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t){t.exports=i,e("./Shape");var b=e("../math/Vec3"),T=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function i(e,t,i,n,r){if(r){for(var o=n,a=Math.cos,s=Math.sin,c=i/2,l=[],u=[],h=[0],p=[1],_=[],f=2*Math.PI/o,d=0;d<o;d++)l.push(new b(e*a(f*d),c,e*s(f*d))),l.push(new b(e*a(f*d),-c,e*s(f*d))),d<o-1?(u.push([2*d+2,2*d+3,2*d+1,2*d]),h.push(2*d+2),p.push(2*d+3)):u.push([0,1,2*d+1,2*d]),(o%2==1||d<o/2)&&_.push(new b(a(f*(d+.5)),0,s(f*(d+.5))));u.push(p);for(var m=[],d=0;d<h.length;d++)m.push(h[h.length-d-1]);return u.push(m),_.push(new b(0,1,0)),void T.call(this,l,u,_)}var o=n,g=[],v=(_=[],[]),y=[],x=[],a=Math.cos,s=Math.sin;for(g.push(new b(t*a(0),t*s(0),.5*-i)),y.push(0),g.push(new b(e*a(0),e*s(0),.5*i)),x.push(1),d=0;d<o;d++){var f=2*Math.PI/o*(d+1),S=2*Math.PI/o*(d+.5);d<o-1?(g.push(new b(t*a(f),t*s(f),.5*-i)),y.push(2*d+2),g.push(new b(e*a(f),e*s(f),.5*i)),x.push(2*d+3),v.push([2*d+2,2*d+3,2*d+1,2*d])):v.push([0,1,2*d+1,2*d]),(o%2==1||d<o/2)&&_.push(new b(a(S),s(S),0))}for(v.push(x),_.push(new b(0,0,1)),m=[],d=0;d<y.length;d++)m.push(y[y.length-d-1]);v.push(m),T.call(this,g,v,_)}i.prototype=new T},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t){var i=e("./Shape"),h=e("./ConvexPolyhedron"),p=e("../math/Vec3"),n=e("../utils/Utils");function r(e,t){t=n.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,i.call(this,{type:i.types.HEIGHTFIELD}),this.pillarConvex=new h,this.pillarOffset=new p,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=r).prototype=new i).update=function(){this._cachedPillars={}},r.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];r<t&&(t=r)}this.minValue=t},r.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];t<r&&(t=r)}this.maxValue=t},r.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},r.prototype.getRectMinMax=function(e,t,i,n,r){r=r||[];for(var o=this.data,a=this.minValue,s=e;s<=i;s++)for(var c=t;c<=n;c++){var l=o[s][c];a<l&&(a=l)}r[0]=this.minValue,r[1]=a},r.prototype.getIndexOfPosition=function(e,t,i,n){var r=this.elementSize,o=this.data,e=Math.floor(e/r),t=Math.floor(t/r);return i[0]=e,i[1]=t,n&&((e=e<0?0:e)>=o.length-1&&(e=o.length-1),(t=t<0?0:t)>=o[0].length-1&&(t=o[0].length-1)),!(e<0||t<0||e>=o.length-1||t>=o[0].length-1)};var _=[],f=new p,d=new p,m=new p,g=new p,l=(r.prototype.getTriangleAt=function(e,t,i,n,r,o){var a=_,s=(this.getIndexOfPosition(e,t,a,i),a[0]),a=a[1],c=this.data,i=(i&&(s=Math.min(c.length-2,Math.max(0,s)),a=Math.min(c[0].length-2,Math.max(0,a))),this.elementSize),c=Math.pow(e/i-s,2)+Math.pow(t/i-a,2)>Math.pow(e/i-(s+1),2)+Math.pow(t/i-(a+1),2);return this.getTriangle(s,a,c,n,r,o),c},new p),u=new p,v=new p,y=new p,x=new p;r.prototype.getNormalAt=function(e,t,i,n){var r=l,o=u,a=v,s=y,c=x;this.getTriangleAt(e,t,i,r,o,a),o.vsub(r,s),a.vsub(r,c),s.cross(c,n),n.normalize()},r.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,r=this.elementSize;i.lowerBound.set(e*r,t*r,n[e][t]),i.upperBound.set((e+1)*r,(t+1)*r,n[e+1][t+1])},r.prototype.getHeightAt=function(e,t,i){var n,r,o,a,s=this.data,c=d,l=m,u=g,h=_,p=(this.getIndexOfPosition(e,t,h,i),h[0]),h=h[1],i=(i&&(p=Math.min(s.length-2,Math.max(0,p)),h=Math.min(s[0].length-2,Math.max(0,h))),this.getTriangleAt(e,t,i,c,l,u));return e=e,t=t,n=c.x,c=c.y,r=l.x,l=l.y,o=u.x,u=u.y,(a=f).x=((l-u)*(e-o)+(o-r)*(t-u))/((l-u)*(n-o)+(o-r)*(c-u)),a.y=((u-c)*(e-o)+(n-o)*(t-u))/((l-u)*(n-o)+(o-r)*(c-u)),a.z=1-a.x-a.y,i?s[p+1][h+1]*f.x+s[p][h+1]*f.y+s[p+1][h]*f.z:s[p][h]*f.x+s[p+1][h]*f.y+s[p][h+1]*f.z},r.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},r.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},r.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:r}},r.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},r.prototype.getTriangle=function(e,t,i,n,r,o){var a=this.data,s=this.elementSize;i?(n.set((e+1)*s,(t+1)*s,a[e+1][t+1]),r.set(e*s,(t+1)*s,a[e][t+1]),o.set((e+1)*s,t*s,a[e+1][t])):(n.set(e*s,t*s,a[e][t]),r.set((e+1)*s,t*s,a[e+1][t]),o.set(e*s,(t+1)*s,a[e][t+1]))},r.prototype.getConvexTrianglePillar=function(e,t,i){var n=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(o=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=o.convex,void(this.pillarOffset=o.offset);n=new h,r=new p,this.pillarConvex=n,this.pillarOffset=r}var o=this.data,a=this.elementSize,s=n.faces;n.vertices.length=6;for(var c=0;c<6;c++)n.vertices[c]||(n.vertices[c]=new p);for(s.length=5,c=0;c<5;c++)s[c]||(s[c]=[]);var l=n.vertices,u=(Math.min(o[e][t],o[e+1][t],o[e][t+1],o[e+1][t+1])-this.minValue)/2+this.minValue;i?(r.set((e+.75)*a,(t+.75)*a,u),l[0].set(.25*a,.25*a,o[e+1][t+1]-u),l[1].set(-.75*a,.25*a,o[e][t+1]-u),l[2].set(.25*a,-.75*a,o[e+1][t]-u),l[3].set(.25*a,.25*a,-u-1),l[4].set(-.75*a,.25*a,-u-1),l[5].set(.25*a,-.75*a,-u-1),s[0][0]=0,s[0][1]=1,s[0][2]=2,s[1][0]=5,s[1][1]=4,s[1][2]=3,s[2][0]=2,s[2][1]=5,s[2][2]=3,s[2][3]=0,s[3][0]=3,s[3][1]=4,s[3][2]=1,s[3][3]=0,s[4][0]=1,s[4][1]=4,s[4][2]=5,s[4][3]=2):(r.set((e+.25)*a,(t+.25)*a,u),l[0].set(-.25*a,-.25*a,o[e][t]-u),l[1].set(.75*a,-.25*a,o[e+1][t]-u),l[2].set(-.25*a,.75*a,o[e][t+1]-u),l[3].set(-.25*a,-.25*a,-u-1),l[4].set(.75*a,-.25*a,-u-1),l[5].set(-.25*a,.75*a,-u-1),s[0][0]=0,s[0][1]=1,s[0][2]=2,s[1][0]=5,s[1][1]=4,s[1][2]=3,s[2][0]=0,s[2][1]=2,s[2][2]=5,s[2][3]=3,s[3][0]=1,s[3][1]=0,s[3][2]=3,s[3][3]=4,s[4][0]=4,s[4][1]=5,s[4][2]=2,s[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,r)},r.prototype.calculateLocalInertia=function(e,t){return(t=t||new p).set(0,0,0),t},r.prototype.volume=function(){return Number.MAX_VALUE},r.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},r.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new p(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},r.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas"),i=(i.width=e.width,i.height=e.height,i.getContext("2d")),n=(i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height)),r=this.data;r.length=0,this.elementSize=Math.abs(t.x)/n.width;for(var o=0;o<n.height;o++){for(var a=[],s=0;s<n.width;s++){var c=(n.data[4*(o*n.height+s)]+n.data[4*(o*n.height+s)+1]+n.data[4*(o*n.height+s)+2])/4/255*t.z;t.x<0?a.push(c):a.unshift(c)}t.y<0?r.unshift(a):r.push(a)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t){t.exports=r;var i=e("./Shape"),n=e("../math/Vec3");function r(){i.call(this,{type:i.types.PARTICLE})}((r.prototype=new i).constructor=r).prototype.calculateLocalInertia=function(e,t){return(t=t||new n).set(0,0,0),t},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t){t.exports=r;var i=e("./Shape"),n=e("../math/Vec3");function r(){i.call(this,{type:i.types.PLANE}),this.worldNormal=new n,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((r.prototype=new i).constructor=r).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(e,t){return t||new n},r.prototype.volume=function(){return Number.MAX_VALUE};var o=new n;r.prototype.calculateWorldAABB=function(e,t,i,n){o.set(0,0,1),t.vmult(o,o);t=Number.MAX_VALUE;i.set(-t,-t,-t),n.set(t,t,t),1===o.x&&(n.x=e.x),1===o.y&&(n.y=e.y),1===o.z&&(n.z=e.z),-1===o.x&&(i.x=e.x),-1===o.y&&(i.y=e.y),-1===o.z&&(i.z=e.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t){t.exports=n;var i=e("../utils/EventTarget"),n=e("./Shape");function n(e){e=e||{},i.apply(this),this.id=n.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material||null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),n.prototype=new i,(n.prototype.constructor=n).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.idCounter=0,n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t){t.exports=r;var i=e("./Shape"),n=e("../math/Vec3");function r(e){if(i.call(this,{type:i.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((r.prototype=new i).constructor=r).prototype.calculateLocalInertia=function(e,t){t=t||new n;e=2*e*this.radius*this.radius/5;return t.x=e,t.y=e,t.z=e,t},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(e,t,i,n){for(var r=this.radius,o=["x","y","z"],a=0;a<o.length;a++){var s=o[a];i[s]=e[s]-r,n[s]=e[s]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t){t.exports=d;var i=e("./Shape"),l=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),u=e("../collision/AABB"),n=e("../utils/Octree");function d(e,t){i.call(this,{type:i.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new u,this.edges=null,this.scale=new l(1,1,1),this.tree=new n,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(d.prototype=new i).constructor=d;var s=new l,a=(d.prototype.updateTree=function(){var e=this.tree,t=(e.reset(),e.aabb.copy(this.aabb),this.scale);e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new u,n=new l,r=new l,o=new l,a=[n,r,o],s=0;s<this.indices.length/3;s++){var c=3*s;this._getUnscaledVertex(this.indices[c],n),this._getUnscaledVertex(this.indices[1+c],r),this._getUnscaledVertex(this.indices[2+c],o),i.setFromPoints(a),e.insert(i,s)}e.removeEmptyNodes()},new u),o=(d.prototype.getTrianglesInAABB=function(e,t){a.copy(e);var e=this.scale,i=e.x,n=e.y,e=e.z,r=a.lowerBound,o=a.upperBound;return r.x/=i,r.y/=n,r.z/=e,o.x/=i,o.y/=n,o.z/=e,this.tree.aabbQuery(a,t)},d.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},d.prototype.updateNormals=function(){for(var e=s,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],o=this.indices[1+n],a=this.indices[2+n];this.getVertex(r,_),this.getVertex(o,f),this.getVertex(a,m),d.computeNormal(f,_,m,e),t[n]=e.x,t[1+n]=e.y,t[2+n]=e.z}},d.prototype.updateEdges=function(){for(var e={},t=function(){e[r<o?r+"_"+o:o+"_"+r]=!0},i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],o=this.indices[1+n];this.indices[2+n],t(),t(),t()}var a=Object.keys(e);for(this.edges=new Int16Array(2*a.length),i=0;i<a.length;i++){var s=a[i].split("_");this.edges[2*i]=parseInt(s[0],10),this.edges[2*i+1]=parseInt(s[1],10)}},d.prototype.getEdgeVertex=function(e,t,i){e=this.edges[2*e+(t?1:0)];this.getVertex(e,i)},new l),c=new l,h=(d.prototype.getEdgeVector=function(e,t){var i=o,n=c;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)},new l),p=new l,_=(d.computeNormal=function(e,t,i,n){t.vsub(e,p),i.vsub(t,h),h.cross(p,n),n.isZero()||n.normalize()},new l),f=new l,m=new l,g=(d.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},d.prototype._getUnscaledVertex=function(e,t){var e=3*e,i=this.vertices;return t.set(i[e],i[1+e],i[2+e])},d.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),r.pointToWorldFrame(t,i,n,n),n},d.prototype.getTriangleVertices=function(e,t,i,n){e*=3;this.getVertex(this.indices[e],t),this.getVertex(this.indices[1+e],i),this.getVertex(this.indices[2+e],n)},d.prototype.getNormal=function(e,t){e*=3;return t.set(this.normals[e],this.normals[1+e],this.normals[2+e])},new u),v=(d.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(g);var i=g.upperBound.x-g.lowerBound.x,n=g.upperBound.y-g.lowerBound.y,r=g.upperBound.z-g.lowerBound.z;return t.set(1/12*e*(4*n*n+4*r*r),1/12*e*(4*i*i+4*r*r),1/12*e*(4*n*n+4*i*i))},new l),y=(d.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length/3,r=v;if(0!=n){this.getVertex(0,r),t.copy(r),i.copy(r);for(var o=0;o!==n;o++)this.getVertex(o,r),r.x<t.x?t.x=r.x:r.x>i.x&&(i.x=r.x),r.y<t.y?t.y=r.y:r.y>i.y&&(i.y=r.y),r.z<t.z?t.z=r.z:r.z>i.z&&(i.z=r.z)}},d.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},d.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new l,n=0,r=t.length/3;n!==r;n++){this.getVertex(n,i);var o=i.norm2();e<o&&(e=o)}this.boundingSphereRadius=Math.sqrt(e)},new l,new r),x=new u;d.prototype.calculateWorldAABB=function(e,t,i,n){var r=y,o=x;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,o),i.copy(o.lowerBound),n.copy(o.upperBound)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.createTorus=function(e,t,i,n,r){e=e||1,t=t||.5,i=i||8,n=n||6,r=r||2*Math.PI;for(var o=[],a=[],s=0;s<=i;s++)for(var c=0;c<=n;c++){var l=c/n*r,u=s/i*Math.PI*2,h=(e+t*Math.cos(u))*Math.cos(l),l=(e+t*Math.cos(u))*Math.sin(l),u=t*Math.sin(u);o.push(h,l,u)}for(s=1;s<=i;s++)for(c=1;c<=n;c++){var p=(n+1)*(s-1)+c-1,_=(n+1)*(s-1)+c,f=(n+1)*s+c;a.push((n+1)*s+c-1,p,f),a.push(p,_,f)}return new d(o,a)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t){t.exports=n,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver");function n(){i.call(this),this.iterations=10,this.tolerance=1e-7}n.prototype=new i;var A=[],P=[],I=[];n.prototype.solve=function(e,t){var i,n,r,o=0,a=this.iterations,s=this.tolerance*this.tolerance,c=this.equations,l=c.length,u=t.bodies,h=u.length,p=e;if(0!==l)for(var _=0;_!==h;_++)u[_].updateSolveMassProperties();var f=P,d=I,m=A;for(f.length=l,d.length=l,m.length=l,_=0;_!==l;_++){var g=c[_];m[_]=0,d[_]=g.computeB(p),f[_]=1/g.computeC()}if(0!==l){for(_=0;_!==h;_++){var v=(b=u[_]).vlambda,y=b.wlambda;v.set(0,0,0),y.set(0,0,0)}for(o=0;o!==a;o++){for(var x=0,S=0;S!==l;S++)g=c[S],i=d[S],n=f[S],(r=m[S])+(n=n*(i-g.computeGWlambda()-g.eps*r))<g.minForce?n=g.minForce-r:r+n>g.maxForce&&(n=g.maxForce-r),m[S]+=n,x+=0<n?n:-n,g.addToWlambda(n);if(x*x<s)break}for(_=0;_!==h;_++){var b,T=(b=u[_]).velocity,E=b.angularVelocity;b.vlambda.vmul(b.linearFactor,b.vlambda),T.vadd(b.vlambda,T),b.wlambda.vmul(b.angularFactor,b.wlambda),E.vadd(b.wlambda,E)}for(var C=c.length,w=1/p;C--;)c[C].multiplier=m[C]*w}return o}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t){function i(){this.equations=[]}(t.exports=i).prototype.solve=function(){return 0},i.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},i.prototype.removeEquation=function(e){var t=this.equations,e=t.indexOf(e);-1!==e&&t.splice(e,1)},i.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t){t.exports=n,e("../math/Vec3"),e("../math/Quaternion");var i=e("./Solver"),t=e("../objects/Body");function n(e){for(i.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}n.prototype=new i;var w=[],A=[],P={bodies:[]},r=t.STATIC;function I(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&r))return n}return!1}var R=[];function D(e,t,i){t.push(e.body);for(var n=e.eqs.length,r=0;r!==n;r++){var o=e.eqs[r];-1===i.indexOf(o)&&i.push(o)}}function O(e,t){return t.id-e.id}n.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},n.prototype.solve=function(e,t){for(var i=w,n=this.nodePool,r=t.bodies,o=this.equations,a=o.length,s=r.length,c=this.subsolver;n.length<s;)n.push(this.createNode());i.length=s;for(var l=0;l<s;l++)i[l]=n[l];for(l=0;l!==s;l++){var u=i[l];u.body=r[l],u.children.length=0,u.eqs.length=0,u.visited=!1}for(var h=0;h!==a;h++){var p=o[h],_=(l=r.indexOf(p.bi),r.indexOf(p.bj)),f=i[l],_=i[_];f.children.push(_),f.eqs.push(p),_.children.push(f),_.eqs.push(p)}var d,m=0,g=A;c.tolerance=this.tolerance,c.iterations=this.iterations;for(var v=P;d=I(i);){g.length=0,v.bodies.length=0,E=T=b=S=x=y=void 0;var y=d,x=D,S=v.bodies,b=g;for(R.push(y),y.visited=!0,x(y,S,b);R.length;)for(var T,E=R.pop();T=I(E.children);)T.visited=!0,x(T,S,b),R.push(T);for(var C=g.length,g=g.sort(O),l=0;l!==C;l++)c.addEquation(g[l]);c.solve(e,v),c.removeAllEquations(),m++}return m}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t){function i(){}(t.exports=i).prototype={constructor:i,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;t=i[e].indexOf(t);return-1!==t&&i[e].splice(t,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t){var s=e("../collision/AABB"),c=e("../math/Vec3");function l(e){this.root=(e=e||{}).root||null,this.aabb=e.aabb?e.aabb.clone():new s,this.data=[],this.children=[]}function i(e,t){(t=t||{}).root=null,t.aabb=e,l.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}(t.exports=i).prototype=new l,l.prototype.reset=function(){this.children.length=this.data.length=0},l.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var o=!1;r.length||(this.subdivide(),o=!0);for(var a=0;8!==a;a++)if(r[a].insert(e,t,i+1))return!0;o&&(r.length=0)}return n.push(t),!0};var u=new c,n=(l.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,e=e.upperBound,i=this.children;i.push(new l({aabb:new s({lowerBound:new c(0,0,0)})}),new l({aabb:new s({lowerBound:new c(1,0,0)})}),new l({aabb:new s({lowerBound:new c(1,1,0)})}),new l({aabb:new s({lowerBound:new c(1,1,1)})}),new l({aabb:new s({lowerBound:new c(0,1,1)})}),new l({aabb:new s({lowerBound:new c(0,0,1)})}),new l({aabb:new s({lowerBound:new c(1,0,1)})}),new l({aabb:new s({lowerBound:new c(0,1,0)})})),e.vsub(t,u),u.scale(.5,u);for(var n=this.root||this,r=0;8!==r;r++){var o=i[r],a=(o.root=n,o.aabb.lowerBound);a.x*=u.x,a.y*=u.y,a.z*=u.z,a.vadd(t,a),a.vadd(u,o.aabb.upperBound)}},l.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t},new s);l.prototype.rayQuery=function(e,t,i){return e.getAABB(n),n.toLocalFrame(t,n),this.aabbQuery(n,i),i},l.prototype.removeEmptyNodes=function(){for(var e=this.children.length-1;0<=e;e--)this.children[e].removeEmptyNodes(),this.children[e].children.length||this.children[e].data.length||this.children.splice(e,1)}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t){function i(){this.objects=[],this.type=Object}(t.exports=i).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},i.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},i.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},i.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t){function i(){this.data={keys:[]}}(t.exports=i).prototype.get=function(e,t){var i;return t<e&&(i=t,t=e,e=i),this.data[e+"-"+t]},i.prototype.set=function(e,t,i){t<e&&(n=t,t=e,e=n);var n=e+"-"+t;return this.get(e,t)||this.data.keys.push(n),this.data[n]=i,this.data[n]},i.prototype.del=function(e,t){t<e&&(i=t,t=e,e=i);var i=e+"-"+t,e=this.data.keys.indexOf(i);return 0<=e&&(this.data.keys.splice(e,1),delete this.data[i],!0)},i.prototype.reset=function(){this.data={keys:[]}},i.prototype.getLength=function(){return this.data.keys.length},i.prototype.getKeyByIndex=function(e){return this.data.keys[e]},i.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t){function i(){}(t.exports=i).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t){t.exports=r;var i=e("../math/Vec3"),n=e("./Pool");function r(){n.call(this),this.type=i}(r.prototype=new n).constructObject=function(){return new i}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t){t.exports=o;var t=e("../collision/AABB"),i=(e("../objects/Body"),e("../shapes/Shape")),N=e("../collision/Ray"),g=e("../math/Vec3"),L=e("../math/Transform"),n=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),r=(e("../solver/Solver"),e("../utils/Vec3Pool")),l=e("../equations/ContactEquation"),u=e("../equations/FrictionEquation");function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new r,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}o.prototype.createContactEquation=function(e,t,i,n,r,o){this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new l(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&i.collisionResponse&&n.collisionResponse;var a,s=this.currentContactMaterial,c=s.contactEquationRelaxation,e=(a.restitution=s.restitution,i.material||e.material),t=n.material||t.material;return e&&t&&(0<=e.restitution&&0<=t.restitution&&(a.restitution=e.restitution*t.restitution),(e=e.correctInelastic||t.correctInelastic)&&(c*=e)),a.setSpookParams(s.contactEquationStiffness,c,this.world.dt),a.si=r||i,a.sj=o||n,a},o.prototype.createFrictionEquationsFromContact=function(e,t){var i,n=e.bi,r=e.bj,o=e.si,a=e.sj,s=this.world,c=this.currentContactMaterial,l=c.friction,o=o.material||n.material,a=a.material||r.material;return 0<(l=o&&a&&0<=o.friction&&0<=a.friction?o.friction*a.friction:l)&&(o=l*s.gravity.length(),0<(a=n.invMass+r.invMass)&&(a=1/a),i=(l=this.frictionEquationPool).length?l.pop():new u(n,r,o*a),l=l.length?l.pop():new u(n,r,o*a),i.bi=l.bi=n,i.bj=l.bj=r,i.minForce=l.minForce=-o*a,i.maxForce=l.maxForce=o*a,i.ri.copy(e.ri),i.rj.copy(e.rj),l.ri.copy(e.ri),l.rj.copy(e.rj),e.ni.tangents(i.t,l.t),i.setSpookParams(c.frictionEquationStiffness,c.frictionEquationRelaxation,s.dt),l.setSpookParams(c.frictionEquationStiffness,c.frictionEquationRelaxation,s.dt),i.enabled=l.enabled=e.enabled,t.push(i,l),!0)};var s=new g,c=new g,h=new g,b=(o.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];s.setZero(),c.setZero(),h.setZero();for(var r=t.bi,o=(t.bj,0);o!==e;o++)(t=this.result[this.result.length-1-o]).bodyA!==r?(s.vadd(t.ni,s),c.vadd(t.ri,c),h.vadd(t.rj,h)):(s.vsub(t.ni,s),c.vadd(t.rj,c),h.vadd(t.ri,h));var a=1/e;c.scale(a,i.ri),h.scale(a,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),s.normalize(),s.tangents(i.t,n.t)}},new g),T=new g,E=new n,C=new n,v=(o.prototype.getContacts=function(e,t,i,n,r,o,a){this.contactPointPool=r,this.frictionEquationPool=a,this.result=n,this.frictionResult=o;for(var s=E,c=C,l=b,u=T,h=0,p=e.length;h!==p;h++){var _=e[h],f=t[h],d=null;_.material&&f.material&&(d=i.getContactMaterial(_.material,f.material)||null);for(var m=0==_.collisionResponse||0==f.collisionResponse,g=0;g<_.shapes.length;g++){_.quaternion.mult(_.shapeOrientations[g],s),_.quaternion.vmult(_.shapeOffsets[g],l),l.vadd(_.position,l);for(var v=_.shapes[g],y=0;y<f.shapes.length;y++){f.quaternion.mult(f.shapeOrientations[y],c),f.quaternion.vmult(f.shapeOffsets[y],u),u.vadd(f.position,u);var x,S=f.shapes[y];v.collisionFilterMask&S.collisionFilterGroup&&S.collisionFilterMask&v.collisionFilterGroup&&!(l.distanceTo(u)>v.boundingSphereRadius+S.boundingSphereRadius)&&(m|=0==v.collisionResponse||0==S.collisionResponse,x=null,v.material&&S.material&&(x=i.getContactMaterial(v.material,S.material)||null),this.currentContactMaterial=x||d||i.defaultContactMaterial,(x=this[v.type|S.type])&&(v.type<S.type?x.call(this,v,S,l,u,s,c,_,f,v,S,m):x.call(this,S,v,u,l,c,s,f,_,v,S,m))&&m&&(i.shapeOverlapKeeper.set(v.id,S.id),i.bodyOverlapKeeper.set(_.id,f.id),i.triggerDic.set(v.id,S.id,x={si:v,sj:S}),i.oldTriggerDic.set(v.id,S.id,x)))}}}},o.prototype[i.types.BOX|i.types.BOX]=o.prototype.boxBox=function(e,t,i,n,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,r,o,a,s,e,t,u)},o.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,t,i,n,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,r,o,a,s,e,t,u)},o.prototype[i.types.BOX|i.types.PARTICLE]=o.prototype.boxParticle=function(e,t,i,n,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,r,o,a,s,e,t,u)},o.prototype[i.types.SPHERE]=o.prototype.sphereSphere=function(e,t,i,n,r,o,a,s,c,l,u){if(u)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);u=this.createContactEquation(a,s,e,t,c,l);n.vsub(i,u.ni),u.ni.normalize(),u.ri.copy(u.ni),u.rj.copy(u.ni),u.ri.mult(e.radius,u.ri),u.rj.mult(-t.radius,u.rj),u.ri.vadd(i,u.ri),u.ri.vsub(a.position,u.ri),u.rj.vadd(n,u.rj),u.rj.vsub(s.position,u.rj),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)},new g),y=new g,x=new g,B=(o.prototype[i.types.PLANE|i.types.TRIMESH]=o.prototype.planeTrimesh=function(e,t,i,n,r,o,a,s,c,l,u){var h=new g,p=v;p.set(0,0,1),r.vmult(p,p);for(var _=0;_<t.vertices.length/3;_++){t.getVertex(_,h);var f=new g,f=(f.copy(h),L.pointToWorldFrame(n,o,f,h),y);if(h.vsub(i,f),p.dot(f)<=0){if(u)return!0;var d=this.createContactEquation(a,s,e,t,c,l),m=(d.ni.copy(p),x);p.scale(f.dot(p),m),h.vsub(m,m),d.ri.copy(m),d.ri.vsub(a.position,d.ri),d.rj.copy(h),d.rj.vsub(s.position,d.rj),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}}},new g),F=new g,z=(new g,new g),U=new g,k=new g,G=new g,H=new g,V=new g,j=new g,W=new g,q=new g,Y=new g,K=new g,Q=new t,Z=[],p=(o.prototype[i.types.SPHERE|i.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,t,i,n,r,o,a,s,c,l,u){var h=k,p=G,_=H,f=V,d=j,m=W,g=Q,v=U,y=F,x=Z,S=(L.pointToLocalFrame(n,o,i,d),e.radius);g.lowerBound.set(d.x-S,d.y-S,d.z-S),g.upperBound.set(d.x+S,d.y+S,d.z+S),t.getTrianglesInAABB(g,x);for(var b=z,T=e.radius*e.radius,E=0;E<x.length;E++)for(var C=0;C<3;C++)if(t.getVertex(t.indices[3*x[E]+C],b),b.vsub(d,y),y.norm2()<=T){if(v.copy(b),L.pointToWorldFrame(n,o,v,b),b.vsub(i,y),u)return!0;(A=this.createContactEquation(a,s,e,t,c,l)).ni.copy(y),A.ni.normalize(),A.ri.copy(A.ni),A.ri.scale(e.radius,A.ri),A.ri.vadd(i,A.ri),A.ri.vsub(a.position,A.ri),A.rj.copy(b),A.rj.vsub(s.position,A.rj),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult)}for(E=0;E<x.length;E++)for(C=0;C<3;C++){t.getVertex(t.indices[3*x[E]+C],h),t.getVertex(t.indices[3*x[E]+(C+1)%3],p),p.vsub(h,_),d.vsub(p,m);var w=m.dot(_);if(d.vsub(h,m),0<m.dot(_)&&w<0&&(d.vsub(h,m),f.copy(_),f.normalize(),w=m.dot(f),f.scale(w,m),m.vadd(h,m),(M=m.distanceTo(d))<e.radius)){if(u)return!0;var A=this.createContactEquation(a,s,e,t,c,l);m.vsub(d,A.ni),A.ni.normalize(),A.ni.scale(e.radius,A.ri),L.pointToWorldFrame(n,o,m,m),m.vsub(s.position,A.rj),L.vectorToWorldFrame(o,A.ni,A.ni),L.vectorToWorldFrame(o,A.ri,A.ri),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult)}}for(var P=q,I=Y,R=K,D=B,O=(E=0,x.length);E!==O;E++){t.getTriangleVertices(x[E],P,I,R),t.getNormal(x[E],D),d.vsub(P,m);var M=m.dot(D);if(D.scale(M,m),d.vsub(m,m),M=m.distanceTo(d),N.pointInTriangle(m,P,I,R)&&M<e.radius){if(u)return!0;A=this.createContactEquation(a,s,e,t,c,l),m.vsub(d,A.ni),A.ni.normalize(),A.ni.scale(e.radius,A.ri),L.pointToWorldFrame(n,o,m,m),m.vsub(s.position,A.rj),L.vectorToWorldFrame(o,A.ni,A.ni),L.vectorToWorldFrame(o,A.ri,A.ri),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult)}}x.length=0},new g),_=new g,f=new g,d=new g,m=new g,J=(o.prototype[i.types.SPHERE|i.types.PLANE]=o.prototype.spherePlane=function(e,t,i,n,r,o,a,s,c,l,u){if(f.set(0,0,1),o.vmult(f,f),f.negate(f),f.normalize(),f.mult(e.radius,d),i.vsub(n,p),f.mult(f.dot(p),_),p.vsub(_,m),-p.dot(f)<=e.radius){if(u)return!0;o=this.createContactEquation(a,s,e,t,c,l),u=(o.ni.copy(f),o.ri.copy(d),o.rj.copy(m),o.ri),e=o.rj;u.vadd(i,u),u.vsub(a.position,u),e.vadd(n,e),e.vsub(s.position,e),this.result.push(o),this.createFrictionEquationsFromContact(o,this.frictionResult)}return!1},new g),$=new g,ee=new g;var X=new g,te=new g,ie=new g,ne=new g,re=[new g,new g,new g,new g,new g,new g],oe=new g,ae=new g,se=new g,ce=new g,le=(o.prototype[i.types.SPHERE|i.types.BOX]=o.prototype.sphereBox=function(e,t,i,n,B,F,r,o,a,s,c){var l=this.v3pool,u=re;i.vsub(n,X),t.getSideNormals(u,F);for(var h,p=e.radius,_=!1,f=ae,d=se,m=ce,z=null,U=0,k=0,G=0,g=null,v=0,H=u.length;v!==H&&!1===_;v++){var y=te,x=(y.copy(u[v]),y.norm()),S=(y.normalize(),X.dot(y));if(S<x+p&&0<S){var b=ie,T=ne,V=(b.copy(u[(v+1)%3]),T.copy(u[(v+2)%3]),b.norm()),j=T.norm(),E=(b.normalize(),T.normalize(),X.dot(b)),C=X.dot(T);if(E<V&&-V<E&&C<j&&-j<C){var w=Math.abs(S-x-p);if((null===g||w<g)&&(g=w,k=E,G=C,z=x,f.copy(y),d.copy(b),m.copy(T),U++,c))return!0}}}U&&(_=!0,h=this.createContactEquation(r,o,e,t,a,s),f.mult(-p,h.ri),h.ni.copy(f),h.ni.negate(h.ni),f.mult(z,f),d.mult(k,d),f.vadd(d,f),m.mult(G,m),f.vadd(m,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(r.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult));for(var A=l.get(),P=oe,I=0;2!==I&&!_;I++)for(var R=0;2!==R&&!_;R++)for(var D=0;2!==D&&!_;D++)if(A.set(0,0,0),I?A.vadd(u[0],A):A.vsub(u[0],A),R?A.vadd(u[1],A):A.vsub(u[1],A),D?A.vadd(u[2],A):A.vsub(u[2],A),n.vadd(A,P),P.vsub(i,P),P.norm2()<p*p){if(c)return!0;_=!0,(h=this.createContactEquation(r,o,e,t,a,s)).ri.copy(P),h.ri.normalize(),h.ni.copy(h.ri),h.ri.mult(p,h.ri),h.rj.copy(A),h.ri.vadd(i,h.ri),h.ri.vsub(r.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}l.release(A);for(var A=null,O=l.get(),M=l.get(),N=(h=l.get(),l.get()),W=(w=l.get(),u.length),I=0;I!==W&&!_;I++)for(R=0;R!==W&&!_;R++)if(I%3!=R%3){u[R].cross(u[I],O),O.normalize(),u[I].vadd(u[R],M),h.copy(i),h.vsub(M,h),h.vsub(n,h);var L=h.dot(O);for(O.mult(L,N),D=0;D===I%3||D===R%3;)D++;w.copy(i),w.vsub(N,w),w.vsub(M,w),w.vsub(n,w);var L=Math.abs(L),q=w.norm();if(L<u[D].norm()&&q<p){if(c)return!0;_=!0;L=this.createContactEquation(r,o,e,t,a,s);M.vadd(N,L.rj),L.rj.copy(L.rj),w.negate(L.ni),L.ni.normalize(),L.ri.copy(L.rj),L.ri.vadd(n,L.ri),L.ri.vsub(i,L.ri),L.ri.normalize(),L.ri.mult(p,L.ri),L.ri.vadd(i,L.ri),L.ri.vsub(r.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(o.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}}l.release(O,M,h,N,w)},new g),ue=new g,he=new g,pe=new g,_e=new g,fe=new g,de=new g,me=new g,ge=new g,ve=new g,A=(o.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,t,i,n,B,r,o,a,s,c,l){var u=this.v3pool;i.vsub(n,le);for(var h=t.faceNormals,p=t.faces,_=t.vertices,f=e.radius,d=0;d!==_.length;d++){var m=_[d],g=_e,m=(r.vmult(m,g),n.vadd(g,g),pe);if(g.vsub(i,m),m.norm2()<f*f)return!!l||(v=!0,(A=this.createContactEquation(o,a,e,t,s,c)).ri.copy(m),A.ri.normalize(),A.ni.copy(A.ri),A.ri.mult(f,A.ri),g.vsub(n,A.rj),A.ri.vadd(i,A.ri),A.ri.vsub(o.position,A.ri),A.rj.vadd(n,A.rj),A.rj.vsub(a.position,A.rj),this.result.push(A),void this.createFrictionEquationsFromContact(A,this.frictionResult))}for(var v=!1,F=(d=0,p.length);d!==F&&!1===v;d++){var y=h[d],x=p[d],S=fe,y=(r.vmult(y,S),de),b=(r.vmult(_[x[0]],y),y.vadd(n,y),me),T=(S.mult(-f,b),i.vadd(b,b),ge),b=(b.vsub(y,T),T.dot(S)),T=ve;if(i.vsub(y,T),b<0&&0<T.dot(S)){for(var E=[],C=0,z=x.length;C!==z;C++){var w=u.get();r.vmult(_[x[C]],w),n.vadd(w,w),E.push(w)}if(function(e,t,i){for(var n=null,r=e.length,o=0;o!==r;o++){var a=e[o],s=J,c=(e[(o+1)%r].vsub(a,s),$),s=(s.cross(t,c),ee),a=(i.vsub(a,s),c.dot(s));if(!(null===n||0<a&&!0===n||a<=0&&!1===n))return;null===n&&(n=0<a)}return 1}(E,S,i)){if(l)return!0;var v=!0,A=this.createContactEquation(o,a,e,t,s,c),y=(S.mult(-f,A.ri),S.negate(A.ni),u.get()),T=(S.mult(-b,y),u.get());S.mult(-f,T),i.vsub(n,A.rj),A.rj.vadd(T,A.rj),A.rj.vadd(y,A.rj),A.rj.vadd(n,A.rj),A.rj.vsub(a.position,A.rj),A.ri.vadd(i,A.ri),A.ri.vsub(o.position,A.ri),u.release(y),u.release(T),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult);for(var C=0,P=E.length;C!==P;C++)u.release(E[C]);return}for(C=0;C!==x.length;C++){var I=u.get(),R=u.get(),D=(r.vmult(_[x[(C+1)%x.length]],I),r.vmult(_[x[(C+2)%x.length]],R),n.vadd(I,I),n.vadd(R,R),ue),O=(R.vsub(I,D),he),M=(D.unit(O),u.get()),N=u.get(),L=(i.vsub(I,N),N.dot(O)),O=(O.mult(L,M),M.vadd(I,M),u.get());if(M.vsub(i,O),0<L&&L*L<D.norm2()&&O.norm2()<f*f){if(l)return!0;for(A=this.createContactEquation(o,a,e,t,s,c),M.vsub(n,A.rj),M.vsub(i,A.ni),A.ni.normalize(),A.ni.mult(f,A.ri),A.rj.vadd(n,A.rj),A.rj.vsub(a.position,A.rj),A.ri.vadd(i,A.ri),A.ri.vsub(o.position,A.ri),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult),C=0,P=E.length;C!==P;C++)u.release(E[C]);return u.release(I),u.release(R),u.release(M),u.release(O),void u.release(N)}u.release(I),u.release(R),u.release(M),u.release(O),u.release(N)}for(C=0,P=E.length;C!==P;C++)u.release(E[C])}}},new g,new g,o.prototype[i.types.PLANE|i.types.BOX]=o.prototype.planeBox=function(e,t,i,n,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,r,o,a,s,e,t,u)},new g),P=new g,I=new g,R=new g,D=(o.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,t,i,n,r,o,a,s,c,l,u){var h=A,p=P;p.set(0,0,1),r.vmult(p,p);for(var _=0,f=I,d=0;d!==t.vertices.length;d++)if(h.copy(t.vertices[d]),o.vmult(h,h),n.vadd(h,h),h.vsub(i,f),p.dot(f)<=0){if(u)return!0;var m=this.createContactEquation(a,s,e,t,c,l),g=R;p.mult(p.dot(f),g),h.vsub(g,g),g.vsub(i,m.ri),m.ni.copy(p),h.vsub(n,m.rj),m.ri.vadd(i,m.ri),m.ri.vsub(a.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),_++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&_&&this.createFrictionFromAverage(_)},new g),O=new g,M=(o.prototype[i.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,t,i,n,r,o,a,s,c,l,u,h,p){var _=D;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,r,n,o,_,h,p)){var f=[],d=O;e.clipAgainstHull(i,r,t,n,o,_,-100,100,f);for(var m=0,g=0;g!==f.length;g++){if(u)return!0;var v=this.createContactEquation(a,s,e,t,c,l),y=v.ri,x=v.rj;_.negate(v.ni),f[g].normal.negate(d),d.mult(f[g].depth,d),f[g].point.vadd(d,y),x.copy(f[g].point),y.vsub(i,y),x.vsub(n,x),y.vadd(i,y),y.vsub(a.position,y),x.vadd(n,x),x.vsub(s.position,x),this.result.push(v),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}},new g),ye=new g,xe=new g,Se=(o.prototype[i.types.PLANE|i.types.PARTICLE]=o.prototype.planeParticle=function(e,t,i,n,r,o,a,s,c,l,u){var h=M,p=(h.set(0,0,1),a.quaternion.vmult(h,h),ye);if(n.vsub(a.position,p),h.dot(p)<=0){if(u)return!0;p=this.createContactEquation(s,a,t,e,c,l),u=(p.ni.copy(h),p.ni.negate(p.ni),p.ri.set(0,0,0),xe);h.mult(h.dot(n),u),n.vsub(u,u),p.rj.copy(u),this.result.push(p),this.createFrictionEquationsFromContact(p,this.frictionResult)}},new g),S=(o.prototype[i.types.PARTICLE|i.types.SPHERE]=o.prototype.sphereParticle=function(e,t,i,n,r,o,a,s,c,l,u){var h=Se;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=e.radius*e.radius){if(u)return!0;n=this.createContactEquation(s,a,t,e,c,l);h.normalize(),n.rj.copy(h),n.rj.mult(e.radius,n.rj),n.ni.copy(h),n.ni.negate(n.ni),n.ri.set(0,0,0),this.result.push(n),this.createFrictionEquationsFromContact(n,this.frictionResult)}},new n),be=new g,Te=(new g,new g),w=new g,Ee=new g,Ce=(o.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,t,i,n,r,o,a,s,c,l,u){var h=-1,p=Te,_=Ee,f=null,d=be;if(d.copy(n),d.vsub(i,d),r.conjugate(S),S.vmult(d,d),e.pointIsInside(d)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var m=0,g=e.faces.length;m!==g;m++){var v=[e.worldVertices[e.faces[m][0]]],y=e.worldFaceNormals[m],v=(n.vsub(v[0],w),-y.dot(w));if(null===f||Math.abs(v)<Math.abs(f)){if(u)return!0;f=v,h=m,p.copy(y)}}-1!==h?(d=this.createContactEquation(s,a,t,e,c,l),p.mult(f,_),_.vadd(n,_),_.vsub(i,_),d.rj.copy(_),p.negate(d.ni),d.ri.set(0,0,0),r=d.ri,t=d.rj,r.vadd(n,r),r.vsub(s.position,r),t.vadd(i,t),t.vsub(a.position,t),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)):console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[i.types.BOX|i.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,t,i,n,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,r,o,a,s,e,t,u)},new g),we=new g,Ae=[0],Pe=(o.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,t,i,n,r,o,a,s,c,l,u){var h=t.data,p=t.elementSize,_=e.boundingSphereRadius,f=we,d=Ae,m=Ce,g=(L.pointToLocalFrame(n,o,i,m),Math.floor((m.x-_)/p)-1),v=Math.ceil((m.x+_)/p)+1,y=Math.floor((m.y-_)/p)-1,x=Math.ceil((m.y+_)/p)+1;if(!(v<0||x<0||g>h.length||y>h[0].length)){(g=g<0?0:g)>=h.length&&(g=h.length-1),(v=v<0?0:v)>=h.length&&(v=h.length-1),(x=x<0?0:x)>=h[0].length&&(x=h[0].length-1),(y=y<0?0:y)>=h[0].length&&(y=h[0].length-1);p=[],h=(t.getRectMinMax(g,y,v,x,p),p[0]);if(!(m.z-_>p[1]||m.z+_<h))for(var S=g;S<v;S++)for(var b=y;b<x;b++){var T=!1;if(t.getConvexTrianglePillar(S,b,!1),L.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(T=this.convexConvex(e,t.pillarConvex,i,f,r,o,a,s,c,l,u,d,null)),u&&T)return!0;if(t.getConvexTrianglePillar(S,b,!0),L.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(T=this.convexConvex(e,t.pillarConvex,i,f,r,o,a,s,c,l,u,d,null)),u&&T)return!0}}},new g),Ie=new g;o.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,t,i,n,r,o,a,s,c,l,u){var h=t.data,p=e.radius,_=t.elementSize,f=Ie,d=Pe,m=(L.pointToLocalFrame(n,o,i,d),Math.floor((d.x-p)/_)-1),g=Math.ceil((d.x+p)/_)+1,v=Math.floor((d.y-p)/_)-1,y=Math.ceil((d.y+p)/_)+1;if(!(g<0||y<0||m>h.length||v>h[0].length)){(m=m<0?0:m)>=h.length&&(m=h.length-1),(g=g<0?0:g)>=h.length&&(g=h.length-1),(y=y<0?0:y)>=h[0].length&&(y=h[0].length-1),(v=v<0?0:v)>=h[0].length&&(v=h[0].length-1);_=[],h=(t.getRectMinMax(m,v,g,y,_),_[0]);if(!(d.z-p>_[1]||d.z+p<h))for(var x=this.result,S=m;S<g;S++)for(var b=v;b<y;b++){var T=x.length,E=!1;if(t.getConvexTrianglePillar(S,b,!1),L.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(E=this.sphereConvex(e,t.pillarConvex,i,f,r,o,a,s,e,t,u)),u&&E)return!0;if(t.getConvexTrianglePillar(S,b,!0),L.pointToWorldFrame(n,o,t.pillarOffset,f),i.distanceTo(f)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(E=this.sphereConvex(e,t.pillarConvex,i,f,r,o,a,s,e,t,u)),u&&E)return!0;if(2<x.length-T)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(e,t){t.exports=m,e("../shapes/Shape");var i=e("../math/Vec3"),t=e("../math/Quaternion"),n=e("../solver/GSSolver"),r=(e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),o=e("../utils/EventTarget"),a=e("../collision/ArrayCollisionMatrix"),s=e("../collision/ObjectCollisionMatrix"),c=e("../collision/OverlapKeeper"),l=e("../material/Material"),u=e("../material/ContactMaterial"),L=e("../objects/Body"),h=e("../utils/TupleDictionary"),p=e("../collision/RaycastResult"),_=e("../collision/AABB"),f=e("../collision/Ray"),d=e("../collision/NaiveBroadphase");function m(e){e=e||{},o.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new i,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new d,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new n,this.constraints=[],this.narrowphase=new r(this),this.collisionMatrix=new a,this.collisionMatrixPrevious=new a,this.bodyOverlapKeeper=new c,this.shapeOverlapKeeper=new c,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new h,this.defaultMaterial=new l("default"),this.defaultContactMaterial=new u(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new s,this.tm=new s,this.triggerDic=new h,this.oldTriggerDic=new h,this.contactsDic=new h,this.oldContactsDic=new h}m.idToBodyMap={},m.idToShapeMap={},m.integrateKinematic=!1,m.ccdSphereAdvance=!1,m.prototype=new o,new _;var g,v=new f;m.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},m.prototype.numObjects=function(){return this.bodies.length},m.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},m.prototype.add=m.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof L&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.cm.setNumObjects(this.bodies.length),m.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},m.prototype.addConstraint=function(e){this.constraints.push(e)},m.prototype.removeConstraint=function(e){e=this.constraints.indexOf(e);-1!==e&&this.constraints.splice(e,1)},m.prototype.rayTest=function(e,t,i){i instanceof p?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},m.prototype.raycastAll=function(e,t,i,n){return i.mode=f.ALL,i.from=e,i.to=t,i.callback=n,v.intersectWorld(this,i)},m.prototype.raycastAny=function(e,t,i,n){return i.mode=f.ANY,i.from=e,i.to=t,i.result=n,v.intersectWorld(this,i)},m.prototype.raycastClosest=function(e,t,i,n){return i.mode=f.CLOSEST,i.from=e,i.to=t,i.result=n,v.intersectWorld(this,i)},m.prototype.removeBody=m.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete m.idToBodyMap[e.id],this.cm.setNumObjects(t),this.dispatchEvent(this.removeBodyEvent)}},m.prototype.getBodyById=function(e){return m.idToBodyMap[e]},m.prototype.getShapeById=function(e){return m.idToShapeMap[e]},m.prototype.addMaterial=function(e){this.materials.push(e)},m.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},(performance="undefined"==typeof performance?{}:performance).now||(g=Date.now(),performance.timing&&performance.timing.navigationStart&&(g=performance.timing.navigationStart),performance.now=function(){return Date.now()-g}),m.prototype.saveKinematicAndApplyGravity=function(e){for(var t=this.bodies,i=this.bodies.length,n=0;n!==i;n++){var r=t[n];r.type===L.DYNAMIC?r.applyGravity(this.gravity):r.type===L.KINEMATIC&&r.updateKinematic(e)}},m.prototype.step=function(e,t,i){if(i=i||10,0===(t=t||0))this.saveKinematicAndApplyGravity(e),this.internalStep(e),this.time+=e,this.substeps=1;else{for(this.saveKinematicAndApplyGravity(t),this.accumulator+=t,this.substeps=0;this.accumulator>=e&&this.substeps<i;)this.internalStep(e),this.accumulator-=e,this.substeps++;for(var n=this.accumulator%e/e,r=0;r!==this.bodies.length;r++){var o=this.bodies[r];o.previousPosition.lerp(o.position,n,o.interpolatedPosition),o.previousQuaternion.slerp(o.quaternion,n,o.interpolatedQuaternion),o.previousQuaternion.normalize()}this.time+=t}this.clearForces()};var y,x,S,b,T,E,B={type:"postStep"},F={type:"preStep"},z={type:"collide",body:null,contact:null},U=[],k=[],G=[],H=[],C=(new i,new i,new i,new i,new i,new i,new i,new i,new i,new t,new t,new t,new i,m.prototype.internalStep=function(e){this.dt=e;var t,i=this.contacts,n=G,r=H,o=this.numObjects(),a=this.bodies,s=this.solver,c=this.doProfiling,l=this.profile,u=L.DYNAMIC,h=this.constraints,p=k,_=0;c&&(t=performance.now());for(var _=0,f=this.subsystems.length;_!==f;_++)this.subsystems[_].update();c&&(t=performance.now()),n.length=0,r.length=0,this.broadphase.collisionPairs(this,n,r),c&&(l.broadphase=performance.now()-t);var d=h.length;for(_=0;_!==d;_++)if(!(x=h[_]).collideConnected)for(var m=n.length-1;0<=m;--m)(x.bodyA===n[m]&&x.bodyB===r[m]||x.bodyB===n[m]&&x.bodyA===r[m])&&(n.splice(m,1),r.splice(m,1));this.collisionMatrixTick(),c&&(t=performance.now());var g=U,v=i.length;for(_=0;_!==v;_++)g.push(i[_]);i.length=0;var y=this.frictionEquations.length;for(_=0;_!==y;_++)p.push(this.frictionEquations[_]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(n,r,this,i,g,this.frictionEquations,p),c&&(l.narrowphase=performance.now()-t),c&&(t=performance.now()),_=0;_<this.frictionEquations.length;_++)s.addEquation(this.frictionEquations[_]);for(var x,S=i.length,b=0;b!==S;b++){var T=(x=i[b]).bi,E=x.bj,C=x.si,w=x.sj;C.material&&w.material?0<=C.material.restitution&&0<=w.material.restitution&&(x.restitution=C.material.restitution*w.material.restitution):T.material&&E.material&&0<=T.material.restitution&&0<=E.material.restitution&&(x.restitution=T.material.restitution*E.material.restitution),s.addEquation(x),T.allowSleep&&T.type===L.DYNAMIC&&T.sleepState===L.SLEEPING&&E.sleepState===L.AWAKE&&E.type!==L.STATIC&&E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(T._wakeUpAfterNarrowphase=!0),E.allowSleep&&E.type===L.DYNAMIC&&E.sleepState===L.SLEEPING&&T.sleepState===L.AWAKE&&T.type!==L.STATIC&&T.velocity.norm2()+T.angularVelocity.norm2()>=2*Math.pow(T.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(T,E,!0),this.collisionMatrixPrevious.get(T,E)||(z.body=E,z.contact=x,T.dispatchEvent(z),z.body=T,E.dispatchEvent(z)),this.bodyOverlapKeeper.set(T.id,E.id),this.shapeOverlapKeeper.set(C.id,w.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=performance.now()-t,t=performance.now()),_=0;_!==o;_++)(T=a[_])._wakeUpAfterNarrowphase&&(T.wakeUp(),T._wakeUpAfterNarrowphase=!1);for(d=h.length,_=0;_!==d;_++){(x=h[_]).update();for(var m=0,A=x.equations.length;m!==A;m++){var P=x.equations[m];s.addEquation(P)}}for(s.solve(e,this),c&&(l.solve=performance.now()-t),s.removeAllEquations(),this.dispatchEvent(F),_=0;_!==o;_++)(T=a[_]).preStep&&T.preStep.call(T);c&&(t=performance.now());var I=this.stepnumber%(this.quatNormalizeSkip+1)==0,R=this.quatNormalizeFast;for(_=0;_!==o;_++)a[_].integrate(e,I,R);var D,O,M=Math.pow;for(_=0;_!==o;_++)(T=a[_]).type&u&&(D=M(1-T.linearDamping,e),(O=T.velocity).mult(D,O),(D=T.angularVelocity)&&(O=M(1-T.angularDamping,e),D.mult(O,D)));for(this.broadphase.dirty=!0,c&&(l.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(B),_=0;_!==o;_++){var N=(T=a[_]).postStep;N&&N.call(T)}if(this.allowSleep)for(_=0;_!==o;_++)a[_].sleepTick(this.time)},m.prototype.emitContactEvents=(y=[],x=[],S={type:"beginContact",bodyA:null,bodyB:null},b={type:"endContact",bodyA:null,bodyB:null},T={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},E={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var e=this.hasAnyEventListener("beginContact"),t=this.hasAnyEventListener("endContact");if((e||t)&&this.bodyOverlapKeeper.getDiff(y,x),e){for(var i=0,n=y.length;i<n;i+=2)S.bodyA=this.getBodyById(y[i]),S.bodyB=this.getBodyById(y[i+1]),this.dispatchEvent(S);S.bodyA=S.bodyB=null}if(t){for(i=0,n=x.length;i<n;i+=2)b.bodyA=this.getBodyById(x[i]),b.bodyB=this.getBodyById(x[i+1]),this.dispatchEvent(b);b.bodyA=b.bodyB=null}y.length=x.length=0;e=this.hasAnyEventListener("beginShapeContact"),t=this.hasAnyEventListener("endShapeContact");if((e||t)&&this.shapeOverlapKeeper.getDiff(y,x),e){for(i=0,n=y.length;i<n;i+=2){var r=this.getShapeById(y[i]),o=this.getShapeById(y[i+1]);T.shapeA=r,T.shapeB=o,T.bodyA=r.body,T.bodyB=o.body,this.dispatchEvent(T)}T.bodyA=T.bodyB=T.shapeA=T.shapeB=null}if(t){for(i=0,n=x.length;i<n;i+=2)r=this.getShapeById(x[i]),o=this.getShapeById(x[i+1]),E.shapeA=r,E.shapeB=o,E.bodyA=r.body,E.bodyB=o.body,this.dispatchEvent(E);E.bodyA=E.bodyB=E.shapeA=E.shapeB=null}}),m.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force,n.torque,n.force.set(0,0,0),n.torque.set(0,0,0)}},{type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null}),w={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},A=[];m.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var e,t=this.triggerDic.getLength();t--;){var i,n,r=this.triggerDic.getKeyByIndex(t);null!=(e=this.triggerDic.getDataByKey(r))&&(i=e.si,n=e.sj,this.tm.get(i,n)?C.event="onTriggerStay":(this.tm.set(i,n,!0),C.event="onTriggerEnter"),C.selfShape=i,C.otherShape=n,C.selfBody=i.body,C.otherBody=n.body,i.dispatchEvent(C),C.selfShape=n,C.otherShape=i,C.selfBody=n.body,C.otherBody=i.body,n.dispatchEvent(C))}for(t=this.oldTriggerDic.getLength();0<t;)r=this.oldTriggerDic.getKeyByIndex(--t),null==this.triggerDic.getDataByKey(r)&&null!=(e=this.oldTriggerDic.getDataByKey(r))&&(i=e.si,n=e.sj,this.tm.set(i,n,!1),this.oldTriggerDic.del(i.id,n.id)&&t--,C.event="onTriggerExit",C.selfShape=i,C.otherShape=n,C.selfBody=i.body,C.otherBody=n.body,i.dispatchEvent(C),C.selfShape=n,C.otherShape=i,C.selfBody=n.body,C.otherBody=i.body,n.dispatchEvent(C));this.triggerDic.reset()}},m.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var e,t=this.contacts,i=this.contacts.length;i--;){var n=(l=t[i]).si,r=l.sj,o=this.contactsDic.get(n.id,r.id);(o=null==o?this.contactsDic.set(n.id,r.id,[]):o).push(l)}for(i=this.contactsDic.getLength();i--;){var a,s,c=this.contactsDic.getKeyByIndex(i);null!=(e=this.contactsDic.getDataByKey(c))&&(n=e[0].si,r=e[0].sj,a=n.body,s=r.body,this.cm.get(a,s)?w.event="onCollisionStay":(this.cm.set(a,s,!0),w.event="onCollisionEnter"),w.bi=a,w.contact=e[0],w.contacts=e,w.body=s,w.selfShape=n,w.otherShape=r,a.dispatchEvent(w),w.body=a,w.selfShape=r,w.otherShape=n,s.dispatchEvent(w))}for(var l,u=A,i=u.length;i--;)n=(l=u[i]).si,r=l.sj,null==this.oldContactsDic.get(n.id,r.id)&&this.oldContactsDic.set(n.id,r.id,l);for(i=this.oldContactsDic.getLength();i--;)c=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(c)&&(n=(e=this.oldContactsDic.getDataByKey(c)).si,r=e.sj,a=n.body,s=r.body,!this.cm.get(a,s)||a.isSleeping()&&s.isSleeping()||(this.cm.set(a,s,!1),w.bi=a,w.contact=e,w.event="onCollisionExit",w.body=s,w.selfShape=n,w.otherShape=r,w.contacts.length=0,w.contacts.push(e),a.dispatchEvent(w),w.body=a,w.selfShape=r,w.otherShape=n,s.dispatchEvent(w)));this.contactsDic.reset(),this.oldContactsDic.reset(),U=A,A=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2);function sQ(e){j._global.CC_PHYSICS_BUILTIN="builtin"===e,j._global.CC_PHYSICS_CANNON="cannon.js"===e,j._global.CC_PHYSICS_AMMO="ammo.js"===e}(t=$K=$K||Rre("ERigidBodyType",{}))[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC",Ot($K),(EW=eQ=eQ||Rre("EAxisDirection",{}))[EW.X_AXIS=0]="X_AXIS",EW[EW.Y_AXIS=1]="Y_AXIS",EW[EW.Z_AXIS=2]="Z_AXIS",Ot(eQ),(kw=tQ=tQ||{})[kw.VERTEX=1]="VERTEX",kw[kw.LINE=2]="LINE",kw[kw.TRIANGLE=3]="TRIANGLE",kw[kw.TETRAHEDRON=4]="TETRAHEDRON",Ot(tQ),(pF=iQ=iQ||{})[pF.BOX=0]="BOX",pF[pF.SPHERE=1]="SPHERE",pF[pF.CAPSULE=2]="CAPSULE",pF[pF.CYLINDER=3]="CYLINDER",pF[pF.CONE=4]="CONE",pF[pF.MESH=5]="MESH",pF[pF.PLANE=6]="PLANE",pF[pF.SIMPLEX=7]="SIMPLEX",pF[pF.TERRAIN=8]="TERRAIN",Ot(iQ),(pte=nQ=nQ||{})[pte.POINT_TO_POINT=0]="POINT_TO_POINT",pte[pte.HINGE=1]="HINGE",pte[pte.CONE_TWIST=2]="CONE_TWIST",Ot(nQ),rQ=rQ||{},rQ[rQ.DEFAULT=1]="DEFAULT",Ot(rQ);function cQ(){return 0}var lQ,uQ={id:"",switchTo:function(e){var t;uQ.runInEditor&&((t=uQ).physicsWorld&&e!==uQ.id&&null!=uQ.backend[e]?(uQ.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+uQ.id+" to "+e+"."),sQ(e),t.id=e,t.wrapper=uQ.backend[e]):console.info("[PHYSICS]: using "+e+"."),t.physicsWorld=_Q(),oQ&&((e=t.physicsWorld).setGravity(oQ.gravity),e.setAllowSleep(oQ.allowSleep),e.setDefaultMaterial(oQ.defaultMaterial)))},register:function(e,t){var i;console.info("[PHYSICS]: register "+e+"."),uQ.backend[e]=t,uQ.physicsWorld&&uQ.id!==e||(sQ(e),(i=uQ).id=e,i.wrapper=t)},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},hQ={impl:null,setGravity:cQ,setAllowSleep:cQ,setDefaultMaterial:cQ,step:cQ,syncAfterEvents:cQ,syncSceneToPhysics:cQ,raycast:cQ,raycastClosest:cQ,emitEvents:cQ,destroy:cQ};function pQ(e,t){return null==e&&(uQ.id?V(uQ.id+" physics does not support "+lQ[t]):ee(9600),1)}function _Q(){return pQ(uQ.wrapper.PhysicsWorld,lQ.World)?hQ:new uQ.wrapper.PhysicsWorld}(I=lQ=lQ||{})[I.World=0]="World",I[I.RigidBody=1]="RigidBody",I[I.BoxCollider=2]="BoxCollider",I[I.SphereCollider=3]="SphereCollider",I[I.CapsuleCollider=4]="CapsuleCollider",I[I.MeshCollider=5]="MeshCollider",I[I.CylinderCollider=6]="CylinderCollider",I[I.ConeCollider=7]="ConeCollider",I[I.TerrainCollider=8]="TerrainCollider",I[I.SimplexCollider=9]="SimplexCollider",I[I.PlaneCollider=10]="PlaneCollider",I[I.PointToPointConstraint=11]="PointToPointConstraint",I[I.HingeConstraint=12]="HingeConstraint";function fQ(e){if(1===e){for(var n=this,t=0;t<32;t++)!function(t){var i="_"+(1<<t);n[i]=0,n.updateArray=[],Object.defineProperty(n,1<<t,{get:function(){return this[i]},set:function(e){this[i]!==e&&(this[i]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})}(t);this._1=rQ.DEFAULT}else{for(var i=0;i<32;i++)this[""+(1<<i)]=0;this[1]=rQ.DEFAULT}}var dQ,mQ,gQ,vQ,yQ,xQ={impl:null,rigidBody:null,isAwake:!(I[I.ConeTwistConstraint=13]="ConeTwistConstraint"),isSleepy:!1,isSleeping:!1,initialize:cQ,onEnable:cQ,onDisable:cQ,onDestroy:cQ,setType:cQ,setMass:cQ,setLinearDamping:cQ,setAngularDamping:cQ,useGravity:cQ,setLinearFactor:cQ,setAngularFactor:cQ,setAllowSleep:cQ,wakeUp:cQ,sleep:cQ,clearState:cQ,clearForces:cQ,clearVelocity:cQ,setSleepThreshold:cQ,getSleepThreshold:cQ,getLinearVelocity:cQ,setLinearVelocity:cQ,getAngularVelocity:cQ,setAngularVelocity:cQ,applyForce:cQ,applyLocalForce:cQ,applyImpulse:cQ,applyLocalImpulse:cQ,applyTorque:cQ,applyLocalTorque:cQ,setGroup:cQ,getGroup:cQ,addGroup:cQ,removeGroup:cQ,setMask:cQ,getMask:cQ,addMask:cQ,removeMask:cQ,isUsingCCD:cQ,useCCD:cQ},SQ={INITED:!1},bQ={impl:null,collider:null,attachedRigidBody:null,initialize:cQ,onLoad:cQ,onEnable:cQ,onDisable:cQ,onDestroy:cQ,setGroup:cQ,getGroup:cQ,addGroup:cQ,removeGroup:cQ,setMask:cQ,getMask:cQ,addMask:cQ,removeMask:cQ,setMaterial:cQ,setAsTrigger:cQ,setCenter:cQ,getAABB:cQ,getBoundingSphere:cQ,updateSize:cQ,updateRadius:cQ,setRadius:cQ,setCylinderHeight:cQ,setDirection:cQ,setHeight:cQ,setShapeType:cQ,setVertices:cQ,setMesh:cQ,setTerrain:cQ,setNormal:cQ,setConstant:cQ,updateEventListener:cQ},TQ={INITED:!1},EQ={impl:null,initialize:cQ,onLoad:cQ,onEnable:cQ,onDisable:cQ,onDestroy:cQ,setEnableCollision:cQ,setConnectedBody:cQ,setPivotA:cQ,setPivotB:cQ,setAxis:cQ},CQ=(die=f("cc.PhysicsMaterial")((l(PQ,yQ=P_),(P=PQ.prototype).clone=function(){var e=new PQ;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e},P.destroy=function(){var e;return!!yQ.prototype.destroy.call(this)&&(0<=(e=PQ.allMaterials.indexOf(this))&&PQ.allMaterials.splice(e,1),!0)},P.setValues=function(e,t,i,n){var r=this._friction!==e||this._rollingFriction!==t||this._spinningFriction!==i||this._restitution!==n;this._friction=e,this._rollingFriction=t,this._spinningFriction=i,this._restitution=n,r&&this.emit(PQ.EVENT_UPDATE)},e(PQ,[{key:"friction",get:function(){return this._friction},set:function(e){Ln(this._friction,e)||(this._friction=e,this.emit(PQ.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){Ln(this._rollingFriction,e)||(this._rollingFriction=e,this.emit(PQ.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(e){Ln(this._spinningFriction,e)||(this._spinningFriction=e,this.emit(PQ.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(e){Ln(this._restitution,e)||(this._restitution=e,this.emit(PQ.EVENT_UPDATE))}}]),Qp=pi=PQ,pi.allMaterials=[],pi.EVENT_UPDATE="event_update",pi._idCounter=0,i((C=Qp).prototype,"friction",[Ap],Object.getOwnPropertyDescriptor(C.prototype,"friction"),C.prototype),i(C.prototype,"rollingFriction",[Ap],Object.getOwnPropertyDescriptor(C.prototype,"rollingFriction"),C.prototype),i(C.prototype,"spinningFriction",[Ap],Object.getOwnPropertyDescriptor(C.prototype,"spinningFriction"),C.prototype),i(C.prototype,"restitution",[Ap],Object.getOwnPropertyDescriptor(C.prototype,"restitution"),C.prototype),dQ=i(C.prototype,"_friction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),mQ=i(C.prototype,"_rollingFriction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gQ=i(C.prototype,"_spinningFriction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vQ=i(C.prototype,"_restitution",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xH=C))||xH,Rre({PhysicsMaterial:die,PhysicMaterial:die}),die),wQ=Rre("PhysicsRayResult",((vie=AQ.prototype)._assign=function(e,t,i,n){ce.copy(this._hitPoint,e),ce.copy(this._hitNormal,n),this._distance=t,this._collider=i},vie.clone=function(){var e=new AQ;return ce.copy(e._hitPoint,this._hitPoint),ce.copy(e._hitNormal,this._hitNormal),e._distance=this._distance,e._collider=this._collider,e},e(AQ,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),AQ));function AQ(){this._hitPoint=new ce,this._hitNormal=new ce,this._distance=0,this._collider=null}function PQ(){var e;return(e=yQ.call(this)||this).id=void 0,_(e,"_friction",dQ,p(e)),_(e,"_rollingFriction",mQ,p(e)),_(e,"_spinningFriction",gQ,p(e)),_(e,"_restitution",vQ,p(e)),PQ.allMaterials.push(p(e)),e.id=PQ._idCounter++,e._uuid||(e._uuid="pm_"+e.id),e}j.internal.PhysicsGroup=rQ;var IQ,RQ,DQ,OQ,MQ,NQ,LQ,BQ,FQ,zQ,UQ=Rre("PhysicsSystem",(l(kQ,zQ=PP),(tl=kQ.prototype).postUpdate=function(e){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,ZP.emit(KP.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}ZP.emit(KP.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},tl.resetConfiguration=function(e){var t=e||(YP.config?YP.config.physics:null);if(t){if("boolean"==typeof t.allowSleep&&(this._allowSleep=t.allowSleep),"number"==typeof t.fixedTimeStep&&(this._fixedTimeStep=t.fixedTimeStep),"number"==typeof t.maxSubSteps&&(this._maxSubSteps=t.maxSubSteps),"number"==typeof t.sleepThreshold&&(this._sleepThreshold=t.sleepThreshold),"boolean"==typeof t.autoSimulation&&(this.autoSimulation=t.autoSimulation),t.gravity&&ce.copy(this._gravity,t.gravity),t.defaultMaterial&&this._material.setValues(t.defaultMaterial.friction,t.defaultMaterial.rollingFriction,t.defaultMaterial.spinningFriction,t.defaultMaterial.restitution),t.collisionMatrix)for(var i in t.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(i))]=t.collisionMatrix[i];!t.collisionGroups||(e=t.collisionGroups)instanceof Array&&(e.forEach(function(e){rQ[e.name]=1<<e.index}),Ot.update(rQ))}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},tl.resetAccumulator=function(e){this._accumulator=e=void 0===e?0:e},tl.step=function(e,t,i){this.physicsWorld&&this.physicsWorld.step(e,t,i)},tl.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},tl.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},tl.raycast=function(e,t,i,n){return void 0===t&&(t=4294967295),void 0===i&&(i=1e7),void 0===n&&(n=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults))},tl.raycastClosest=function(e,t,i,n){return void 0===t&&(t=4294967295),void 0===i&&(i=1e7),void 0===n&&(n=!0),!!this.physicsWorld&&(this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult))},tl._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},kQ.constructAndRegister=function(){var e,t;kQ._instance||((e=new kQ).resetConfiguration(),oQ=oQ||e,uQ.runInEditor&&!uQ.physicsWorld&&(console.info("[PHYSICS]: using "+uQ.id+"."),(t=uQ.physicsWorld=_Q()).setGravity(oQ.gravity),t.setAllowSleep(oQ.allowSleep),t.setDefaultMaterial(oQ.defaultMaterial)),kQ._instance=e,ZP.registerSystem(kQ.ID,e,e.priority))},e(kQ,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld&&this.physicsWorld.setAllowSleep(e)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld&&this.physicsWorld.setGravity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return uQ.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!uQ.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===uQ.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===uQ.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===uQ.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===uQ.id}},{key:"PhysicsGroup",get:function(){return rQ}},{key:"instance",get:function(){return kQ._instance}}]),kQ));function kQ(){var e;return(e=zQ.call(this)||this).raycastClosestResult=new wQ,e.raycastResults=[],e.collisionMatrix=new fQ(1),e.minVolumeSize=1e-5,e.useNodeChains=!1,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._subStepCount=0,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._sleepThreshold=.1,e._gravity=new ce(0,-10,0),e._material=new CQ,e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},e.raycastResultPool=new Et(function(){return new wQ},1),e._material.on(CQ.EVENT_UPDATE,e._updateMaterial,p(e)),e}UQ.ID="PHYSICS",UQ._instance=null,ZP.once(KP.EVENT_INIT,function(){UQ.constructAndRegister()});Sa=f("cc.RigidBody"),E2=wp(),y=Ep(),fie=Oa(-1),aie=v(UQ.PhysicsGroup),yU=m(),A=u(),Rie=v($K),Fp=m(),Iie=u(),hl=Pp(),Nk=m(),Pc=u(),x=Pp(),vI=m(),Up=u(),o=Pp(),R=m(),S=u(),cM=Pp(),yI=m(),kp=u(),Hd=Pp(),b=m(),uI=u(),Ac=Pp(),Xp=m(),Lp=u(),ane=Pp(),dU=m(),Lc=u(),Ce=Sa(W3=E2(W3=y(W3=Tp(W3=ls(W3=fie((l(qQ,jQ=W_),(a=qQ.prototype).onLoad=function(){uQ.runInEditor&&(this._body=pQ(uQ.wrapper.RigidBody,lQ.RigidBody)?xQ:new uQ.wrapper.RigidBody,this._body.initialize(this))},a.onEnable=function(){this._body&&this._body.onEnable()},a.onDisable=function(){this._body&&this._body.onDisable()},a.onDestroy=function(){this._body&&this._body.onDestroy()},a.applyForce=function(e,t){this._isInitialized&&this._body.applyForce(e,t)},a.applyLocalForce=function(e,t){this._isInitialized&&this._body.applyLocalForce(e,t)},a.applyImpulse=function(e,t){this._isInitialized&&this._body.applyImpulse(e,t)},a.applyLocalImpulse=function(e,t){this._isInitialized&&this._body.applyLocalImpulse(e,t)},a.applyTorque=function(e){this._isInitialized&&this._body.applyTorque(e)},a.applyLocalTorque=function(e){this._isInitialized&&this._body.applyLocalTorque(e)},a.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},a.sleep=function(){this._isInitialized&&this._body.sleep()},a.clearState=function(){this._isInitialized&&this._body.clearState()},a.clearForces=function(){this._isInitialized&&this._body.clearForces()},a.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},a.getLinearVelocity=function(e){this._isInitialized&&this._body.getLinearVelocity(e)},a.setLinearVelocity=function(e){this._isInitialized&&this._body.setLinearVelocity(e)},a.getAngularVelocity=function(e){this._isInitialized&&this._body.getAngularVelocity(e)},a.setAngularVelocity=function(e){this._isInitialized&&this._body.setAngularVelocity(e)},a.getGroup=function(){return this._isInitialized?this._body.getGroup():0},a.setGroup=function(e){this._isInitialized&&this._body.setGroup(e)},a.addGroup=function(e){this._isInitialized&&this._body.addGroup(e)},a.removeGroup=function(e){this._isInitialized&&this._body.removeGroup(e)},a.getMask=function(){return this._isInitialized?this._body.getMask():0},a.setMask=function(e){this._isInitialized&&this._body.setMask(e)},a.addMask=function(e){this._isInitialized&&this._body.addMask(e)},a.removeMask=function(e){this._isInitialized&&this._body.removeMask(e)},e(qQ,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._body&&this._body.getGroup()!==e&&this._body.setGroup(e)}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._body&&this._body.setType(e))}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(this._mass=e=e<=0?1e-4:e,this._body&&this._body.setMass(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body&&this._body.useGravity(e)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){ce.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){ce.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(e){this._isInitialized&&this._body.setSleepThreshold(e)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(e){this._isInitialized&&this._body.useCCD(e)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===$K.STATIC},set:function(e){e&&this.isStatic||!e&&!this.isStatic||(this.type=e?$K.STATIC:$K.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===$K.DYNAMIC},set:function(e){e&&this.isDynamic||!e&&!this.isDynamic||(this.type=e?$K.DYNAMIC:$K.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===$K.KINEMATIC},set:function(e){e&&this.isKinematic||!e&&!this.isKinematic||(this.type=e?$K.KINEMATIC:$K.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var e=null===this._body;return e&&tt("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),qQ.Type=$K,i((s=qQ).prototype,"group",[aie,yU,A],Object.getOwnPropertyDescriptor(s.prototype,"group"),s.prototype),i(s.prototype,"type",[Rie,Fp,Iie],Object.getOwnPropertyDescriptor(s.prototype,"type"),s.prototype),i(s.prototype,"mass",[hl,Nk,Pc],Object.getOwnPropertyDescriptor(s.prototype,"mass"),s.prototype),i(s.prototype,"allowSleep",[x,vI,Up],Object.getOwnPropertyDescriptor(s.prototype,"allowSleep"),s.prototype),i(s.prototype,"linearDamping",[o,R,S],Object.getOwnPropertyDescriptor(s.prototype,"linearDamping"),s.prototype),i(s.prototype,"angularDamping",[cM,yI,kp],Object.getOwnPropertyDescriptor(s.prototype,"angularDamping"),s.prototype),i(s.prototype,"useGravity",[Hd,b,uI],Object.getOwnPropertyDescriptor(s.prototype,"useGravity"),s.prototype),i(s.prototype,"linearFactor",[Ac,Xp,Lp],Object.getOwnPropertyDescriptor(s.prototype,"linearFactor"),s.prototype),i(s.prototype,"angularFactor",[ane,dU,Lc],Object.getOwnPropertyDescriptor(s.prototype,"angularFactor"),s.prototype),IQ=i(s.prototype,"_group",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UQ.PhysicsGroup.DEFAULT}}),RQ=i(s.prototype,"_type",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $K.DYNAMIC}}),DQ=i(s.prototype,"_mass",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),OQ=i(s.prototype,"_allowSleep",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),MQ=i(s.prototype,"_linearDamping",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),NQ=i(s.prototype,"_angularDamping",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),LQ=i(s.prototype,"_useGravity",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),BQ=i(s.prototype,"_linearFactor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(1,1,1)}}),FQ=i(s.prototype,"_angularFactor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(1,1,1)}}),W3=s))||W3)||W3)||W3)||W3)||W3)||W3,Rre({RigidBody:Ce,RigidBodyComponent:Ce});var GQ,HQ,VQ,jQ,WQ=Ce;function qQ(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=jQ.call.apply(jQ,[this].concat(i))||this)._body=null,_(e,"_group",IQ,p(e)),_(e,"_type",RQ,p(e)),_(e,"_mass",DQ,p(e)),_(e,"_allowSleep",OQ,p(e)),_(e,"_linearDamping",MQ,p(e)),_(e,"_angularDamping",NQ,p(e)),_(e,"_useGravity",LQ,p(e)),_(e,"_linearFactor",BQ,p(e)),_(e,"_angularFactor",FQ,p(e)),e}WQ||(Rre({RigidBody:h={},RigidBodyComponent:h}),WQ=h);C7=f("cc.Collider"),Y3=v(WQ),ul=Rp(),B1=m(),il=u(),bne=v(CQ),Op=Rp(),Mp=m(),Z5=u(),Mne=m(),kd=u(),Gd=v(ce),Nw=m(),nl=u(),Bp=v(CQ),vre=C7((l(KQ,XQ=Gi(W_)),(n=KQ.prototype).on=function(e,t,i,n){t=XQ.prototype.on.call(this,e,t,i,n);return this._updateNeedEvent(e),t},n.off=function(e,t,i){XQ.prototype.off.call(this,e,t,i),this._updateNeedEvent()},n.once=function(e,t,i){t=XQ.prototype.once.call(this,e,t,i);return this._updateNeedEvent(e),t},n.removeAll=function(e){XQ.prototype.removeAll.call(this,e),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._shape.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._shape.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._shape.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(e){this._isInitialized&&this._shape.setMask(e)},n.addMask=function(e){this._isInitialized&&this._shape.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._shape.removeMask(e)},n.onLoad=function(){var e;uQ.runInEditor&&(this.sharedMaterial=null==this._material?UQ.instance.defaultMaterial:this._material,this._shape=(e=this.type,SQ.INITED||(SQ.INITED=!0,SQ[iQ.BOX]=function(){return pQ(uQ.wrapper.BoxShape,lQ.BoxCollider)?bQ:new uQ.wrapper.BoxShape},SQ[iQ.SPHERE]=function(){return pQ(uQ.wrapper.SphereShape,lQ.SphereCollider)?bQ:new uQ.wrapper.SphereShape},SQ[iQ.CAPSULE]=function(){return pQ(uQ.wrapper.CapsuleShape,lQ.CapsuleCollider)?bQ:new uQ.wrapper.CapsuleShape},SQ[iQ.CYLINDER]=function(){return pQ(uQ.wrapper.CylinderShape,lQ.CylinderCollider)?bQ:new uQ.wrapper.CylinderShape},SQ[iQ.CONE]=function(){return pQ(uQ.wrapper.ConeShape,lQ.ConeCollider)?bQ:new uQ.wrapper.ConeShape},SQ[iQ.MESH]=function(){return pQ(uQ.wrapper.TrimeshShape,lQ.MeshCollider)?bQ:new uQ.wrapper.TrimeshShape},SQ[iQ.TERRAIN]=function(){return pQ(uQ.wrapper.TerrainShape,lQ.TerrainCollider)?bQ:new uQ.wrapper.TerrainShape},SQ[iQ.SIMPLEX]=function(){return pQ(uQ.wrapper.SimplexShape,lQ.SimplexCollider)?bQ:new uQ.wrapper.SimplexShape},SQ[iQ.PLANE]=function(){return pQ(uQ.wrapper.PlaneShape,lQ.PlaneCollider)?bQ:new uQ.wrapper.PlaneShape}),SQ[e]()),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(CQ.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(e){this.isValid&&(void 0!==e?("onCollisionEnter"!==e&&"onCollisionStay"!==e&&"onCollisionExit"!==e||(this._needCollisionEvent=!0),"onTriggerEnter"!==e&&"onTriggerStay"!==e&&"onTriggerExit"!==e||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},e(KQ,[{key:"attachedRigidBody",get:function(){return(e=this.node.getComponent(WQ))&&e.isValid?e:null;var e}},{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off(CQ.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(CQ.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){this._shape?(e&&this._material?this._material.id!==e.id&&(this._material.off(CQ.EVENT_UPDATE,this._updateMaterial,this),e.on(CQ.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):e&&!this._material?(e.on(CQ.EVENT_UPDATE,this._updateMaterial,this),this._material=e):!e&&this._material&&(this._material.off(CQ.EVENT_UPDATE,this._updateMaterial,this),this._material=e),this._updateMaterial()):this._material=e}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){ce.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new qh),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new ua),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var e=null===this._shape;return e&&tt("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),L6=g=KQ,g.Type=iQ,g.Axis=eQ,i((SJ=L6).prototype,"attachedRigidBody",[Y3,Ip,ul,B1,il],Object.getOwnPropertyDescriptor(SJ.prototype,"attachedRigidBody"),SJ.prototype),i(SJ.prototype,"sharedMaterial",[bne,Op,Mp,Z5],Object.getOwnPropertyDescriptor(SJ.prototype,"sharedMaterial"),SJ.prototype),i(SJ.prototype,"isTrigger",[Mne,kd],Object.getOwnPropertyDescriptor(SJ.prototype,"isTrigger"),SJ.prototype),i(SJ.prototype,"center",[Gd,Nw,nl],Object.getOwnPropertyDescriptor(SJ.prototype,"center"),SJ.prototype),GQ=i(SJ.prototype,"_material",[Bp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HQ=i(SJ.prototype,"_isTrigger",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VQ=i(SJ.prototype,"_center",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),EJ=SJ))||EJ,Rre({Collider:vre,ColliderComponent:vre});var XQ,YQ=vre;function KQ(e){var t;return(t=XQ.call(this)||this).type=void 0,t._shape=null,t._aabb=null,t._boundingSphere=null,t._isSharedMaterial=!0,t._needTriggerEvent=!1,t._needCollisionEvent=!1,_(t,"_material",GQ,p(t)),_(t,"_isTrigger",HQ,p(t)),_(t,"_center",VQ,p(t)),t.type=e,t}YQ||(Rre({Collider:mre={},ColliderComponent:mre}),YQ=mre),new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce;var QQ=new ce(0,0,0),ZQ=new ce(0,0,0);function JQ(e,t){e.__cc_wrapper__=t}function $Q(e){return e.__cc_wrapper__}new ce(0,0,0),new ce(0,0,0),new ce(0,0,0),new ce(0,0,0),new ce(0,0,0),new ce(0,0,0),new ce(0,0,0),new ce(0,0,0),new ce(0,0,0);var eZ=new ce;function tZ(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}var iZ,nZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,pZ,_Z,fZ,dZ,mZ,gZ,vZ,yZ,xZ,SZ,bZ,TZ,EZ,CZ,wZ,AZ,PZ,IZ,RZ,DZ,OZ,MZ,NZ,LZ,BZ,FZ,zZ,UZ,kZ,GZ=Object.freeze({__proto__:null,setWrap:JQ,getWrap:$Q,maxComponent:function(e){return Math.max(e.x,Math.max(e.y,e.z))},VEC3_0:eZ,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(e){var t=[];if(3<=e.length){t[0]=e[0],t[1]=e[1],t[2]=e[2];for(var i=e.length,n=3;n<i;n+=3){for(var r=e[n],o=e[n+1],a=e[n+2],s=t.length,c=!0,l=0;l<s;l+=3)if(Ln(r,t[l])&&Ln(o,t[l+1])&&Ln(a,t[l+2])){c=!1;break}c&&(t.push(r),t.push(o),t.push(a))}}return t},absolute:tZ,cylinder:function(p,_,e,t){void 0===p&&(p=.5),void 0===_&&(_=.5);for(var f=.5*(e=void 0===e?2:e),d=(t=void 0===t?{}:t).radialSegments||32,i=t.heightSegments||1,n=void 0===t.capped||t.capped,m=t.arc||2*Math.PI,t=0,r=(n||(0<p&&t++,0<_&&t++),(d+1)*(i+1)),o=(n&&(r+=(d+1)*t+d*t),d*i*6),g=(n&&(o+=d*t*3),new Array(o)),v=new Array(3*r),y=new Array(3*r),x=new Array(2*r),t=Math.max(p,_),o=new ce(-t,-f,-t),r=new ce(t,f,t),t=Math.sqrt(t*t+f*f),S=0,b=0,a=[],s=p-_,c=s*s/e*Math.sign(s),l=0;l<=i;l++){for(var u=[],h=l/i,T=h*s+_,E=0;E<=d;++E){var C=E/d,w=C*m,A=Math.sin(w),w=Math.cos(w);v[3*S]=T*A,v[3*S+1]=h*e-f,v[3*S+2]=T*w,ce.normalize(QQ,ce.set(ZQ,A,-c,w)),y[3*S]=QQ.x,y[3*S+1]=QQ.y,y[3*S+2]=QQ.z,x[2*S]=2*(1-C)%1,x[2*S+1]=h,u.push(S),++S}a.push(u)}for(var P=0;P<i;++P)for(var I=0;I<d;++I){var R=a[P][I],D=a[P+1][I],O=a[P+1][I+1],M=a[P][I+1];g[b]=R,g[++b]=M,g[++b]=D,g[++b]=M,g[++b]=O,g[++b]=D,++b}return n&&(0<_&&N(!1),0<p&&N(!0)),{positions:v,normals:y,uvs:x,indices:g,minPos:o,maxPos:r,boundingRadius:t};function N(e){for(var t=e?p:_,i=e?1:-1,n=S,r=1;r<=d;++r)v[3*S]=0,v[3*S+1]=f*i,v[3*S+2]=0,y[3*S]=0,y[3*S+1]=i,y[3*S+2]=0,x[2*S]=.5,x[2*S+1]=.5,++S;for(var o=S,a=0;a<=d;++a){var s=a/d*m,c=Math.cos(s),s=Math.sin(s);v[3*S]=t*s,v[3*S+1]=f*i,v[3*S+2]=t*c,y[3*S]=0,y[3*S+1]=i,y[3*S+2]=0,x[2*S]=.5-.5*s*i,x[2*S+1]=.5+.5*c,++S}for(var l=0;l<d;++l){var u=n+l,h=o+l;e?(g[b]=h+1,g[++b]=u):(g[b]=u,g[++b]=h+1),g[++b]=h,++b}}}}),HZ=(UJ=f("cc.BoxCollider"),zJ=wp(),KJ=Ep(),u$=v(ce),c$=u(),i$=UJ(r$=zJ(r$=KJ(r$=Tp((i((l(oJ,kZ=YQ),e(oJ,[{key:"size",get:function(){return this._size},set:function(e){ce.strictEquals(this._size,e)||(ce.copy(this._size,e),tZ(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),a$=oJ).prototype,"size",[u$,c$],Object.getOwnPropertyDescriptor(a$.prototype,"size"),a$.prototype),iZ=i(a$.prototype,"_size",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(1,1,1)}}),r$=a$))||r$)||r$)||r$)||r$,Rre({BoxCollider:i$,BoxColliderComponent:i$}),i$),VZ=(N$=f("cc.SphereCollider"),O$=wp(),R$=Ep(),q$=u(),V$=N$(W$=O$(W$=R$(W$=Tp((i((l(rJ,UZ=YQ),e(rJ,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),X$=rJ).prototype,"radius",[q$],Object.getOwnPropertyDescriptor(X$.prototype,"radius"),X$.prototype),nZ=i(X$.prototype,"_radius",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),W$=X$))||W$)||W$)||W$)||W$,Rre({SphereCollider:V$,SphereColliderComponent:V$}),V$),jZ=(aee=f("cc.CapsuleCollider"),nee=wp(),iee=Ep(),bee=u(),Cee=u(),Eee=v(eQ),Bee=u(),zee=aee(Fee=nee(Fee=iee(Fee=Tp((i((l(nJ,zZ=YQ),(vee=nJ.prototype)._getRadiusScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===eQ.Y_AXIS?Math.abs($n(e.x,e.z)):this._direction===eQ.X_AXIS?Math.abs($n(e.y,e.z)):Math.abs($n(e.x,e.y))},vee._getHeightScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===eQ.Y_AXIS?Math.abs(e.y):this._direction===eQ.X_AXIS?Math.abs(e.x):Math.abs(e.z)},e(nJ,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){this._cylinderHeight!==e&&(this._cylinderHeight=Math.abs(e),this._shape&&this.shape.setCylinderHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<eQ.X_AXIS||e>eQ.Z_AXIS||this._direction!==e&&(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){e-=2*this._radius;this.cylinderHeight=e=e<0?0:e}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),nie=nJ).prototype,"radius",[bee],Object.getOwnPropertyDescriptor(nie.prototype,"radius"),nie.prototype),i(nie.prototype,"cylinderHeight",[Cee],Object.getOwnPropertyDescriptor(nie.prototype,"cylinderHeight"),nie.prototype),i(nie.prototype,"direction",[Eee,Bee],Object.getOwnPropertyDescriptor(nie.prototype,"direction"),nie.prototype),rZ=i(nie.prototype,"_radius",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),oZ=i(nie.prototype,"_cylinderHeight",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),aZ=i(nie.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eQ.Y_AXIS}}),Fee=nie))||Fee)||Fee)||Fee)||Fee,Rre({CapsuleCollider:zee,CapsuleColliderComponent:zee}),zee),WZ=(XN=f("cc.CylinderCollider"),Uee=wp(),kee=Ep(),Gee=u(),bp=u(),Hee=v(eQ),Vee=u(),Wee=XN(r=Uee(r=kee(r=Tp((i((l(iJ,FZ=YQ),e(iJ,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=Math.abs(e),this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction===e||e<eQ.X_AXIS||e>eQ.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"shape",get:function(){return this._shape}}]),jee=iJ).prototype,"radius",[Gee],Object.getOwnPropertyDescriptor(jee.prototype,"radius"),jee.prototype),i(jee.prototype,"height",[bp],Object.getOwnPropertyDescriptor(jee.prototype,"height"),jee.prototype),i(jee.prototype,"direction",[Hee,Vee],Object.getOwnPropertyDescriptor(jee.prototype,"direction"),jee.prototype),sZ=i(jee.prototype,"_radius",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),cZ=i(jee.prototype,"_height",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),lZ=i(jee.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eQ.Y_AXIS}}),r=jee))||r)||r)||r)||r,Rre({CylinderCollider:Wee,CylinderColliderComponent:Wee}),Wee),E=Rre("ConeCollider",(qee=f("cc.ConeCollider"),ll=wp(),Xee=Ep(),Yee=u(),Kee=u(),rl=v(eQ),Qee=u(),qee(Jee=ll(Jee=Xee(Jee=Tp((i((l(tJ,BZ=YQ),e(tJ,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e=e<0?0:e,this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction===e||e<eQ.X_AXIS||e>eQ.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"shape",get:function(){return this._shape}}]),Zee=tJ).prototype,"radius",[Yee],Object.getOwnPropertyDescriptor(Zee.prototype,"radius"),Zee.prototype),i(Zee.prototype,"height",[Kee],Object.getOwnPropertyDescriptor(Zee.prototype,"height"),Zee.prototype),i(Zee.prototype,"direction",[rl,Qee],Object.getOwnPropertyDescriptor(Zee.prototype,"direction"),Zee.prototype),uZ=i(Zee.prototype,"_radius",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),hZ=i(Zee.prototype,"_height",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pZ=i(Zee.prototype,"_direction",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eQ.Y_AXIS}}),Jee=Zee))||Jee)||Jee)||Jee)||Jee)),qZ=($ee=f("cc.MeshCollider"),ete=wp(),tte=Ep(),_l=v(r6),ite=u(),nte=u(),ote=$ee(Bc=ete(Bc=tte(Bc=Tp((i((l(eJ,LZ=YQ),e(eJ,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex!==e&&(this._convex=e)}},{key:"shape",get:function(){return this._shape}}]),rte=eJ).prototype,"mesh",[_l,ite],Object.getOwnPropertyDescriptor(rte.prototype,"mesh"),rte.prototype),i(rte.prototype,"convex",[Ap,nte],Object.getOwnPropertyDescriptor(rte.prototype,"convex"),rte.prototype),_Z=i(rte.prototype,"_mesh",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fZ=i(rte.prototype,"_convex",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bc=rte))||Bc)||Bc)||Bc)||Bc,Rre({MeshCollider:ote,MeshColliderComponent:ote}),ote),EW=Rre("ConstantForce",(ate=f("cc.ConstantForce"),ba=wp(),ste=gl(WQ),cte=Ep(),lte=m(),ute=u(),hte=m(),w=u(),zp=m(),Np=u(),Cp=m(),c=u(),ate(t=ba(t=ste(t=cte(t=ls(t=Tp((l($Z,NZ=W_),(YD=$Z.prototype).onLoad=function(){this._rigidBody=this.node.getComponent(WQ),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},YD.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},YD._maskUpdate=function(e,t){e.strictEquals(ce.ZERO)?this._mask&=~t:this._mask|=t},e($Z,[{key:"force",get:function(){return this._force},set:function(e){ce.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){ce.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){ce.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){ce.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),dZ=i((Aw=$Z).prototype,"_force",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),mZ=i(Aw.prototype,"_localForce",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),gZ=i(Aw.prototype,"_torque",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),vZ=i(Aw.prototype,"_localTorque",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),i(Aw.prototype,"force",[lte,ute],Object.getOwnPropertyDescriptor(Aw.prototype,"force"),Aw.prototype),i(Aw.prototype,"localForce",[hte,w],Object.getOwnPropertyDescriptor(Aw.prototype,"localForce"),Aw.prototype),i(Aw.prototype,"torque",[zp,Np],Object.getOwnPropertyDescriptor(Aw.prototype,"torque"),Aw.prototype),i(Aw.prototype,"localTorque",[Cp,c],Object.getOwnPropertyDescriptor(Aw.prototype,"localTorque"),Aw.prototype),t=Aw))||t)||t)||t)||t)||t)||t)),XZ=((kw=JZ.prototype).reserve=function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var i=new Uint8Array(t),n=0;n<this.length;++n)i[n]=this.buffer[n];this.buffer=i,this._buffView=new DataView(this.buffer.buffer)}},kw.assign=function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)},kw.writeInt8=function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1},kw.writeInt16=function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2},kw.writeInt32=function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4},kw.writeIntArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length},kw.writeFloat=function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4},kw.writeFloatArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length},kw.writeString=function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4},kw.readInt8=function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e},kw.readInt16=function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e},kw.readInt=function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e},kw.readIntArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},kw.readFloat=function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e},kw.readFloatArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},kw.readString=function(){for(var e=this.readInt(),t="",i=0;i<e;++i)t+=String.fromCharCode(this.readInt8());return t},JZ),YZ=(f("cc.TerrainLayerInfo")((yZ=i((pF=function(){_(this,"slot",yZ,this),_(this,"tileSize",xZ,this),_(this,"detailMap",SZ,this),_(this,"normalMap",bZ,this),_(this,"roughness",TZ,this),_(this,"metallic",EZ,this)}).prototype,"slot",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xZ=i(pF.prototype,"tileSize",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SZ=i(pF.prototype,"detailMap",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bZ=i(pF.prototype,"normalMap",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TZ=i(pF.prototype,"roughness",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EZ=i(pF.prototype,"metallic",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pF)),f("cc.TerrainLayerBinaryInfo")(pte=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||pte),Qp=f("cc.TerrainAsset")((l(ZZ,MZ=P_),(I=ZZ.prototype).getLayer=function(e,t,i){i=4*(t*this.blockCount[0]+e)+i;return e<this.blockCount[0]&&t<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},I.getHeight=function(e,t){var i=32*this._blockCount[0]+1;return.001953125*(this._heights[t*i+e]-32768)},I.getVertexCountI=function(){return this._blockCount.length<1?0:32*this._blockCount[0]+1},I.getVertexCountJ=function(){return this._blockCount.length<2?0:32*this._blockCount[1]+1},I._setNativeData=function(e){this._data=e},I._loadNativeData=function(e){if(!e||0===e.length)return!1;var t=new XZ;if(t.assign(e),this._version=t.readInt(),16843025===this._version)return!0;if(16842753!==this._version&&16842754!==this._version&&16842755!==this._version&&16842756!==this._version&&16842757!==this._version)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();e=t.readInt();this.heights=new Uint16Array(e);for(var i=0;i<this.heights.length;++i)this.heights[i]=t.readInt16();e=t.readInt();this.weights=new Uint8Array(e);for(var n=0;n<this.weights.length;++n)this.weights[n]=t.readInt8();if(16842754<=this._version){e=t.readInt();this.layerBuffer=new Array(e);for(var r=0;r<this.layerBuffer.length;++r)this.layerBuffer[r]=t.readInt16()}if(16842755<=this._version){e=t.readInt();this._layerBinaryInfos=new Array(e);for(var o=0;o<this._layerBinaryInfos.length;++o)this._layerBinaryInfos[o]=new YZ,this._layerBinaryInfos[o].slot=t.readInt(),this._layerBinaryInfos[o].tileSize=t.readFloat(),this._layerBinaryInfos[o].detailMapId=t.readString(),16842756<=this._version&&(this._layerBinaryInfos[o].normalMapId=t.readString(),this._layerBinaryInfos[o].roughness=t.readFloat(),this._layerBinaryInfos[o].metallic=t.readFloat())}return!0},I._exportNativeData=function(){var e=new XZ;e.writeInt32(16842757),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var i=0;i<this.weights.length;++i)e.writeInt8(this.weights[i]);e.writeInt32(this.layerBuffer.length);for(var n=0;n<this.layerBuffer.length;++n)e.writeInt16(this.layerBuffer[n]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new YZ;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}e.writeInt32(r.length);for(var c=0;c<r.length;++c)e.writeInt32(r[c].slot),e.writeFloat(r[c].tileSize),e.writeString(r[c].detailMapId),e.writeString(r[c].normalMapId),e.writeFloat(r[c].roughness),e.writeFloat(r[c].metallic);return e.buffer},I._exportDefaultNativeData=function(){var e=new XZ;return e.writeInt32(16843025),e.buffer},e(ZZ,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(e){this._tileSize=e}},{key:"blockCount",get:function(){return this._blockCount},set:function(e){this._blockCount=e}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(e){this._lightMapSize=e}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(e){this._weightMapSize=e}},{key:"heights",get:function(){return this._heights},set:function(e){this._heights=e}},{key:"weights",get:function(){return this._weights},set:function(e){this._weights=e}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(e){this._layerBuffer=e}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(e){this._layerInfos=e}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),CZ=i((P=ZZ).prototype,"_layerInfos",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pi=P))||pi,E2=Rre("TerrainCollider",(C=f("cc.TerrainCollider"),xH=wp(),die=Ep(),vie=v(Qp),tl=u(),C(Sa=xH(Sa=die(Sa=Tp((i((l(QZ,OZ=YQ),e(QZ,[{key:"terrain",get:function(){return this._terrain},set:function(e){this._terrain=e,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),Oa=QZ).prototype,"terrain",[vie,tl],Object.getOwnPropertyDescriptor(Oa.prototype,"terrain"),Oa.prototype),wZ=i(Oa.prototype,"_terrain",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sa=Oa))||Sa)||Sa)||Sa)||Sa));function KZ(){var e;return _(e=DZ.call(this,iQ.SIMPLEX)||this,"_shapeType",AZ,p(e)),_(e,"_vertices",PZ,p(e)),e}function QZ(){var e;return _(e=OZ.call(this,iQ.TERRAIN)||this,"_terrain",wZ,p(e)),e}function ZZ(){var e;return(e=MZ.call(this)||this)._version=0,e._data=null,e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._layerBuffer=[-1,-1,-1,-1],e._layerBinaryInfos=[],_(e,"_layerInfos",CZ,p(e)),e}function JZ(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}function $Z(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=NZ.call.apply(NZ,[this].concat(i))||this)._rigidBody=null,_(e,"_force",dZ,p(e)),_(e,"_localForce",mZ,p(e)),_(e,"_torque",gZ,p(e)),_(e,"_localTorque",vZ,p(e)),e._mask=0,e}function eJ(){var e;return _(e=LZ.call(this,iQ.MESH)||this,"_mesh",_Z,p(e)),_(e,"_convex",fZ,p(e)),e}function tJ(){var e;return _(e=BZ.call(this,iQ.CONE)||this,"_radius",uZ,p(e)),_(e,"_height",hZ,p(e)),_(e,"_direction",pZ,p(e)),e}function iJ(){var e;return _(e=FZ.call(this,iQ.CYLINDER)||this,"_radius",sZ,p(e)),_(e,"_height",cZ,p(e)),_(e,"_direction",lZ,p(e)),e}function nJ(){var e;return _(e=zZ.call(this,iQ.CAPSULE)||this,"_radius",rZ,p(e)),_(e,"_cylinderHeight",oZ,p(e)),_(e,"_direction",aZ,p(e)),e}function rJ(){var e;return _(e=UZ.call(this,iQ.SPHERE)||this,"_radius",nZ,p(e)),e}function oJ(){var e;return _(e=kZ.call(this,iQ.BOX)||this,"_size",iZ,p(e)),e}var aJ,sJ,cJ,lJ,uJ,hJ,pJ,_J=(_J=Rre("SimplexCollider",(y=f("cc.SimplexCollider"),fie=wp(),a=Ep(),aie=v(tQ),yU=u(),A=u(),Rie=Pp(),Fp=u(),Iie=Pp(),hl=u(),Nk=Pp(),Pc=u(),y(vI=fie(vI=a(vI=Tp((l(KZ,DZ=YQ),KZ.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},e(KZ,[{key:"shapeType",get:function(){return this._shapeType},set:function(e){this._shapeType=e,this._shape&&this.shape.setShapeType(e)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(e){ce.copy(this._vertices[0],e),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(e){ce.copy(this._vertices[1],e),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(e){ce.copy(this._vertices[2],e),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(e){ce.copy(this._vertices[3],e),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),KZ.ESimplexType=tQ,i((x=KZ).prototype,"shapeType",[aie,yU],Object.getOwnPropertyDescriptor(x.prototype,"shapeType"),x.prototype),i(x.prototype,"vertex0",[Ap,A],Object.getOwnPropertyDescriptor(x.prototype,"vertex0"),x.prototype),i(x.prototype,"vertex1",[Rie,Fp],Object.getOwnPropertyDescriptor(x.prototype,"vertex1"),x.prototype),i(x.prototype,"vertex2",[Iie,hl],Object.getOwnPropertyDescriptor(x.prototype,"vertex2"),x.prototype),i(x.prototype,"vertex3",[Nk,Pc],Object.getOwnPropertyDescriptor(x.prototype,"vertex3"),x.prototype),AZ=i(x.prototype,"_shapeType",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tQ.TETRAHEDRON}}),PZ=i(x.prototype,"_vertices",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new ce(0,0,0),new ce(0,0,1),new ce(1,0,0),new ce(0,1,0)]}}),vI=x))||vI)||vI)||vI)||vI)))||Rre("SimplexCollider",{}),b=Rre("PlaneCollider",(Up=f("cc.PlaneCollider"),o=wp(),R=Ep(),S=v(ce),cM=u(),yI=u(),Up(Hd=o(Hd=R(Hd=Tp((i((l(dJ,pJ=YQ),e(dJ,[{key:"normal",get:function(){return this._normal},set:function(e){ce.strictEquals(this._normal,e)||(ce.copy(this._normal,e),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(e){this._constant!==e&&(this._constant=e,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),kp=dJ).prototype,"normal",[S,cM],Object.getOwnPropertyDescriptor(kp.prototype,"normal"),kp.prototype),i(kp.prototype,"constant",[Ap,yI],Object.getOwnPropertyDescriptor(kp.prototype,"constant"),kp.prototype),IZ=i(kp.prototype,"_normal",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce(0,1,0)}}),RZ=i(kp.prototype,"_constant",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hd=kp))||Hd)||Hd)||Hd)||Hd));function fJ(e){var t;return(t=hJ.call(this)||this).TYPE=void 0,_(t,"_enableCollision",aJ,p(t)),_(t,"_connectedBody",sJ,p(t)),t._constraint=null,t.TYPE=e,t}function dJ(){var e;return _(e=pJ.call(this,iQ.PLANE)||this,"_normal",IZ,p(e)),_(e,"_constant",RZ,p(e)),e}var mJ,gJ,vJ,yJ,xJ=(xJ=Rre("Constraint",(uI=f("cc.Constraint"),Ac=gl(WQ),Xp=v(WQ),Lp=m(),ane=v(WQ),dU=m(),Lc=m(),s=v(WQ),uI(h=Ac((l(fJ,hJ=Gi(W_)),(W3=fJ.prototype).onLoad=function(){var e;uQ.runInEditor&&(this._constraint=(e=this.TYPE,TQ.INITED||(TQ.INITED=!0,TQ[nQ.POINT_TO_POINT]=function(){return pQ(uQ.wrapper.PointToPointConstraint,lQ.PointToPointConstraint)?EQ:new uQ.wrapper.PointToPointConstraint},TQ[nQ.HINGE]=function(){return pQ(uQ.wrapper.HingeConstraint,lQ.HingeConstraint)?EQ:new uQ.wrapper.HingeConstraint},TQ[nQ.CONE_TWIST]=function(){return pQ(uQ.wrapper.ConeTwistConstraint,lQ.ConeTwistConstraint)?EQ:new uQ.wrapper.ConeTwistConstraint}),TQ[e]()),this._constraint.initialize(this))},W3.onEnable=function(){this._constraint&&this._constraint.onEnable()},W3.onDisable=function(){this._constraint&&this._constraint.onDisable()},W3.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},e(fJ,[{key:"attachedBody",get:function(){return this.getComponent(WQ)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}}]),fJ.Type=nQ,i((Ce=fJ).prototype,"attachedBody",[Xp,Ip,Lp],Object.getOwnPropertyDescriptor(Ce.prototype,"attachedBody"),Ce.prototype),i(Ce.prototype,"connectedBody",[ane,dU],Object.getOwnPropertyDescriptor(Ce.prototype,"connectedBody"),Ce.prototype),i(Ce.prototype,"enableCollision",[Lc],Object.getOwnPropertyDescriptor(Ce.prototype,"enableCollision"),Ce.prototype),aJ=i(Ce.prototype,"_enableCollision",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sJ=i(Ce.prototype,"_connectedBody",[s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),h=Ce))||h)||h)))||Rre("Constraint",{}),Mp=Rre("HingeConstraint",(Rp=f("cc.HingeConstraint"),C7=wp(),n=Ep(),g=v(ce),L6=v(ce),Y3=v(ce),ul=yp("axisA"),B1=yp("pivotA"),il=yp("pivotB"),Rp(Op=C7(Op=n((i((l(TJ,yJ=xJ),e(TJ,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){ce.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){ce.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(e){ce.copy(this._axis,e),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),bne=TJ).prototype,"pivotA",[g],Object.getOwnPropertyDescriptor(bne.prototype,"pivotA"),bne.prototype),i(bne.prototype,"pivotB",[L6],Object.getOwnPropertyDescriptor(bne.prototype,"pivotB"),bne.prototype),i(bne.prototype,"axis",[Y3],Object.getOwnPropertyDescriptor(bne.prototype,"axis"),bne.prototype),cJ=i(bne.prototype,"_axis",[d,ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),lJ=i(bne.prototype,"_pivotA",[d,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),uJ=i(bne.prototype,"_pivotB",[d,il],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),Op=bne))||Op)||Op)||Op)),SJ=Rre("PointToPointConstraint",(Z5=f("cc.PointToPointConstraint"),Mne=wp(),kd=Ep(),Gd=v(ce),Nw=v(ce),Z5(Bp=Mne(Bp=kd((i((l(bJ,vJ=xJ),e(bJ,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){ce.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){ce.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),nl=bJ).prototype,"pivotA",[Gd],Object.getOwnPropertyDescriptor(nl.prototype,"pivotA"),nl.prototype),i(nl.prototype,"pivotB",[Nw],Object.getOwnPropertyDescriptor(nl.prototype,"pivotB"),nl.prototype),mJ=i(nl.prototype,"_pivotA",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),gJ=i(nl.prototype,"_pivotB",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),Bp=nl))||Bp)||Bp)||Bp));function bJ(){var e;return _(e=vJ.call(this,nQ.POINT_TO_POINT)||this,"_pivotA",mJ,p(e)),_(e,"_pivotB",gJ,p(e)),e}function TJ(){var e;return _(e=yJ.call(this,nQ.HINGE)||this,"_axis",cJ,p(e)),_(e,"_pivotA",lJ,p(e)),_(e,"_pivotB",uJ,p(e)),e}j.PhysicsSystem=UQ,j.PhysicsMaterial=CQ,j.PhysicsRayResult=wQ,j.ConstantForce=EW;var EJ=Object.freeze({__proto__:null,PhysicsSystem:UQ,PhysicsRayResult:wQ,get Collider(){return YQ},BoxCollider:HZ,SphereCollider:VZ,CapsuleCollider:jZ,MeshCollider:qZ,CylinderCollider:WZ,ConeCollider:E,TerrainCollider:E2,get SimplexCollider(){return _J},PlaneCollider:b,get Constraint(){return xJ},HingeConstraint:Mp,PointToPointConstraint:SJ,get RigidBody(){return WQ},PhysicsMaterial:CQ,ConstantForce:EW,selector:uQ,utils:GZ,get ERigidBodyType(){return $K},get EAxisDirection(){return eQ},get ESimplexType(){return tQ},get EColliderType(){return iQ},get EConstraintType(){return nQ},get PhysicsGroup(){return rQ}}),CJ=(Rre("physics",EJ),new aQ.Vec3),wJ=new aQ.Vec3,AJ=((vre=PJ.prototype).setAllowSleep=function(e){this.impl.type===aQ.Body.DYNAMIC&&(this.impl.allowSleep=e,this._wakeUpIfSleep())},vre.setMass=function(e){this.impl.type===aQ.Body.DYNAMIC&&(this.impl.mass=e,this.impl.updateMassProperties(),this._wakeUpIfSleep())},vre.setType=function(e){switch(e){case $K.DYNAMIC:this.impl.type=aQ.Body.DYNAMIC,this.impl.allowSleep=this._rigidBody.allowSleep,this.setMass(this._rigidBody.mass);break;case $K.KINEMATIC:this.impl.type=aQ.Body.KINEMATIC,this.impl.mass=0,this.impl.allowSleep=!1,this.impl.sleepState=aQ.Body.AWAKE,this.impl.updateMassProperties();break;default:$K.STATIC;this.impl.type=aQ.Body.STATIC,this.impl.mass=0,this.impl.allowSleep=!0,this.impl.updateMassProperties(),this.clearState()}},vre.setLinearDamping=function(e){this.impl.linearDamping=e},vre.setAngularDamping=function(e){this.impl.angularDamping=e},vre.useGravity=function(e){this.impl.useGravity=e,this._wakeUpIfSleep()},vre.useCCD=function(e){this.impl.ccdSpeedThreshold=e?.01:-1},vre.isUsingCCD=function(){return-1!==this.impl.ccdSpeedThreshold},vre.setLinearFactor=function(e){ce.copy(this.impl.linearFactor,e),this._wakeUpIfSleep()},vre.setAngularFactor=function(e){ce.copy(this.impl.angularFactor,e);e=ce.equals(this.impl.angularFactor,ce.ZERO);e!==this.impl.fixedRotation&&(this.impl.fixedRotation=e,this.impl.updateMassProperties()),this._wakeUpIfSleep()},vre.initialize=function(e){this._rigidBody=e,this._sharedBody=UQ.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this},vre.onLoad=function(){},vre.onEnable=function(){this._isEnabled=!0,this.setType(this._rigidBody.type),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0},vre.onDisable=function(){this._isEnabled=!1,this._sharedBody.enabled=!1},vre.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},vre.clearVelocity=function(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()},vre.clearForces=function(){this.impl.force.setZero(),this.impl.torque.setZero()},vre.clearState=function(){this.clearVelocity(),this.clearForces()},vre.wakeUp=function(){return this.impl.wakeUp()},vre.sleep=function(){return this.impl.sleep()},vre.setSleepThreshold=function(e){this.impl.sleepSpeedLimit=e,this._wakeUpIfSleep()},vre.getSleepThreshold=function(){return this.impl.sleepSpeedLimit},vre.getLinearVelocity=function(e){return ce.copy(e,this.impl.velocity),e},vre.setLinearVelocity=function(e){this._wakeUpIfSleep(),ce.copy(this.impl.velocity,e)},vre.getAngularVelocity=function(e){return ce.copy(e,this.impl.angularVelocity),e},vre.setAngularVelocity=function(e){this._wakeUpIfSleep(),ce.copy(this.impl.angularVelocity,e)},vre.applyForce=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=ce.ZERO),this.impl.applyForce(ce.copy(CJ,e),ce.copy(wJ,t))},vre.applyImpulse=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=ce.ZERO),this.impl.applyImpulse(ce.copy(CJ,e),ce.copy(wJ,t))},vre.applyLocalForce=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=ce.ZERO),this.impl.applyLocalForce(ce.copy(CJ,e),ce.copy(wJ,t))},vre.applyLocalImpulse=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=ce.ZERO),this.impl.applyLocalImpulse(ce.copy(CJ,e),ce.copy(wJ,t))},vre.applyTorque=function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),ce.add(this.impl.torque,this.impl.torque,e)},vre.applyLocalTorque=function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),ce.copy(CJ,e),this.impl.vectorToWorldFrame(CJ,CJ),ce.add(this.impl.torque,this.impl.torque,CJ)},vre.getGroup=function(){return this.impl.collisionFilterGroup},vre.setGroup=function(e){this.impl.collisionFilterGroup=e,this._wakeUpIfSleep()},vre.addGroup=function(e){this.impl.collisionFilterGroup|=e,this._wakeUpIfSleep()},vre.removeGroup=function(e){this.impl.collisionFilterGroup&=~e,this._wakeUpIfSleep()},vre.getMask=function(){return this.impl.collisionFilterMask},vre.setMask=function(e){this.impl.collisionFilterMask=e,this._wakeUpIfSleep()},vre.addMask=function(e){this.impl.collisionFilterMask|=e,this._wakeUpIfSleep()},vre.removeMask=function(e){this.impl.collisionFilterMask&=~e,this._wakeUpIfSleep()},vre._wakeUpIfSleep=function(){this.impl.isAwake()||this.impl.wakeUp()},e(PJ,[{key:"isAwake",get:function(){return this.impl.isAwake()}},{key:"isSleepy",get:function(){return this.impl.isSleepy()}},{key:"isSleeping",get:function(){return this.impl.isSleeping()}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),PJ);function PJ(){this._isEnabled=!1}function IJ(e,t){e.checkCollisionResponse=!t.queryTrigger,e.collisionFilterGroup=-1,e.collisionFilterMask=t.mask}function RJ(e,t){e._assign(t.hitPointWorld,t.distance,$Q(t.shape).collider,t.hitNormalWorld)}function DJ(e){e.aabbNeedsUpdate=!0,e.updateMassProperties(),e.updateBoundingRadius()}var OJ={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},MJ=new aQ.Quaternion,NJ=new aQ.Vec3,LJ=new aQ.Vec3,BJ=((mre=FJ.prototype).updateEventListener=function(){},mre.setMaterial=function(e){var t;null==e?this._shape.material=null:(null==FJ.idToMaterial[e.id]&&(FJ.idToMaterial[e.id]=new aQ.Material(e.id)),this._shape.material=FJ.idToMaterial[e.id],(t=this._shape.material).friction=e.friction,t.restitution=e.restitution,e=aQ.CC_CONFIG.correctInelastic,t.correctInelastic=0===t.restitution?e:0)},mre.setAsTrigger=function(e){this._shape.collisionResponse=!e,0<=this._index&&this._body.updateHasTrigger()},mre.setCenter=function(e){this._setCenter(e),0<=this._index&&DJ(this._body)},mre.setAttachedBody=function(e){if(e){if(this._sharedBody){if(this._sharedBody.wrappedBody===e.body)return;this._sharedBody.reference=!1}this._sharedBody=UQ.instance.physicsWorld.getSharedBody(e.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=UQ.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},mre.getAABB=function(e){gr.copy(MJ,this._collider.node.worldRotation),this._shape.calculateWorldAABB(aQ.Vec3.ZERO,MJ,NJ,LJ),ce.subtract(e.halfExtents,LJ,NJ),ce.multiplyScalar(e.halfExtents,e.halfExtents,.5),ce.add(e.center,this._collider.node.worldPosition,this._collider.center)},mre.getBoundingSphere=function(e){e.radius=this._shape.boundingSphereRadius,ce.add(e.center,this._collider.node.worldPosition,this._collider.center)},mre.initialize=function(e){this._collider=e,this._isBinding=!0,this._sharedBody=UQ.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),JQ(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener)},mre.onComponentSet=function(){},mre.onLoad=function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},mre.onEnable=function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0},mre.onDisable=function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1},mre.onDestroy=function(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete aQ.World.idToShapeMap[this._shape.id],this._sharedBody=null,JQ(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null},mre.getGroup=function(){return this._body.collisionFilterGroup},mre.setGroup=function(e){this._body.collisionFilterGroup=e,this._body.isAwake()||this._body.wakeUp()},mre.addGroup=function(e){this._body.collisionFilterGroup|=e,this._body.isAwake()||this._body.wakeUp()},mre.removeGroup=function(e){this._body.collisionFilterGroup&=~e,this._body.isAwake()||this._body.wakeUp()},mre.getMask=function(){return this._body.collisionFilterMask},mre.setMask=function(e){this._body.collisionFilterMask=e,this._body.isAwake()||this._body.wakeUp()},mre.addMask=function(e){this._body.collisionFilterMask|=e,this._body.isAwake()||this._body.wakeUp()},mre.removeMask=function(e){this._body.collisionFilterMask&=~e,this._body.isAwake()||this._body.wakeUp()},mre.setScale=function(){this._setCenter(this._collider.center)},mre.setIndex=function(e){this._index=e},mre.setOffsetAndOrient=function(e,t){ce.copy(e,this._offset),gr.copy(t,this._orient),this._offset=e,this._orient=t},mre._setCenter=function(e){var t=this._offset;ce.subtract(t,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),ce.add(t,t,e),ce.multiply(t,t,this._collider.node.worldScale)},mre._onTrigger=function(e){OJ.type=e.event;var t=$Q(e.selfShape),i=$Q(e.otherShape);t&&t.collider.needTriggerEvent&&(OJ.selfCollider=t.collider,OJ.otherCollider=i?i.collider:null,OJ.impl=e,this._collider.emit(OJ.type,OJ))},e(FJ,[{key:"impl",get:function(){return this._shape}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_body",get:function(){return this._sharedBody.body}}]),FJ);function FJ(){this._offset=new aQ.Vec3,this._orient=new aQ.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}BJ.idToMaterial={},In(UQ,"PhysicsSystem",[{name:"ins",newName:"instance"},{name:"PHYSICS_AMMO",newName:"PHYSICS_BULLET"}]),In(UQ.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),Ee(UQ.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),In(YQ.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),In(YQ,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),In(xJ,"Constraint",[{name:"EConstraintType",newName:"Type"}]),In(HZ.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),In(VZ.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),In(jZ.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),In(WQ.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),In(WQ,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),Ee(WQ.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),j.RigidBodyComponent=WQ,gt.setClassAlias(WQ,"cc.RigidBodyComponent"),j.ColliderComponent=YQ,gt.setClassAlias(YQ,"cc.ColliderComponent"),j.BoxColliderComponent=HZ,gt.setClassAlias(HZ,"cc.BoxColliderComponent"),j.SphereColliderComponent=VZ,gt.setClassAlias(VZ,"cc.SphereColliderComponent"),gt.setClassAlias(jZ,"cc.CapsuleColliderComponent"),gt.setClassAlias(qZ,"cc.MeshColliderComponent"),gt.setClassAlias(WZ,"cc.CylinderColliderComponent"),j.PhysicMaterial=CQ,gt.setClassAlias(CQ,"cc.PhysicMaterial"),j.physics=EJ;var zJ,UJ,kJ=new gr,GJ=((UJ=YJ.prototype).getLocalPointOnA=function(e){this.impl&&ce.copy(e,this.impl.rj)},UJ.getLocalPointOnB=function(e){this.impl&&ce.copy(e,this.impl.ri)},UJ.getWorldPointOnA=function(e){this.impl&&ce.add(e,this.impl.rj,this.impl.bj.position)},UJ.getWorldPointOnB=function(e){this.impl&&ce.add(e,this.impl.ri,this.impl.bi.position)},UJ.getLocalNormalOnA=function(e){this.impl&&(this.getWorldNormalOnA(e),gr.conjugate(kJ,this.impl.bi.quaternion),ce.transformQuat(e,e,kJ))},UJ.getLocalNormalOnB=function(e){this.impl&&(gr.conjugate(kJ,this.impl.bj.quaternion),ce.transformQuat(e,this.impl.ni,kJ))},UJ.getWorldNormalOnA=function(e){this.impl&&(this.getWorldNormalOnB(e),this.isBodyA||ce.negate(e,e))},UJ.getWorldNormalOnB=function(e){this.impl&&ce.copy(e,this.impl.ni)},e(YJ,[{key:"isBodyA",get:function(){var e,t;return!!this.impl&&(e=this.event.selfCollider.shape.impl,t=this.impl.bj,e.body.id===t.id)}}]),YJ),HJ=new ce,VJ=new gr,jJ=[],WJ={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},qJ=(XJ.getSharedBody=function(e,t,i){var n,r=e.uuid;return XJ.sharedBodesMap.has(r)?n=XJ.sharedBodesMap.get(r):(n=new XJ(e,t),r=rQ.DEFAULT,t=UQ.instance.collisionMatrix[r],n.body.collisionFilterGroup=r,n.body.collisionFilterMask=t,XJ.sharedBodesMap.set(e.uuid,n)),i&&(r=(n.wrappedBody=i).rigidBody.group,t=UQ.instance.collisionMatrix[r],n.body.collisionFilterGroup=r,n.body.collisionFilterMask=t),n},(zJ=XJ.prototype).addShape=function(e){var t,i;this.wrappedShapes.indexOf(e)<0&&(i=this.body.shapes.length,this.body.addShape(e.impl),this.wrappedShapes.push(e),e.setIndex(i),t=this.body.shapeOffsets[i],i=this.body.shapeOrientations[i],e.setOffsetAndOrient(t,i),this.body.isSleeping()&&this.body.wakeUp())},zJ.removeShape=function(e){var t=this.wrappedShapes.indexOf(e);0<=t&&(Se(this.wrappedShapes,t),this.body.removeShape(e.impl),e.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())},zJ.addJoint=function(e,t){t?this.wrappedJoints1.indexOf(e)<0&&this.wrappedJoints1.push(e):this.wrappedJoints0.indexOf(e)<0&&this.wrappedJoints0.push(e)},zJ.removeJoint=function(e,t){t?0<=(t=this.wrappedJoints1.indexOf(e))&&Se(this.wrappedJoints1,t):0<=(t=this.wrappedJoints0.indexOf(e))&&Se(this.wrappedJoints0,t)},zJ.syncSceneToPhysics=function(){var e=this.node,t=this.body;e.hasChangedFlags&&(t.isSleeping()&&t.wakeUp(),ce.copy(t.position,e.worldPosition),gr.copy(t.quaternion,e.worldRotation),t.aabbNeedsUpdate=!0,e.hasChangedFlags&Q0.SCALE&&this.syncScale())},zJ.syncPhysicsToScene=function(){var e=this.node,t=this.body;t.type!==$K.DYNAMIC||t.isSleeping()||(ce.copy(HJ,t.position),gr.copy(VJ,t.quaternion),e.worldPosition=HJ,e.worldRotation=VJ)},zJ.syncInitial=function(){var e=this.node,t=this.body;ce.copy(t.position,e.worldPosition),gr.copy(t.quaternion,e.worldRotation),ce.copy(t.previousPosition,e.worldPosition),gr.copy(t.previousQuaternion,e.worldRotation),t.aabbNeedsUpdate=!0,this.syncScale(),t.isSleeping()&&t.wakeUp()},zJ.syncScale=function(){for(var e=0;e<this.wrappedShapes.length;e++)this.wrappedShapes[e].setScale(this.node.worldScale);for(var t=0;t<this.wrappedJoints0.length;t++)this.wrappedJoints0[t].updateScale0();for(var i=0;i<this.wrappedJoints1.length;i++)this.wrappedJoints1[i].updateScale1();DJ(this.body)},zJ.destroy=function(){JQ(this.body,null),this.body.removeEventListener("cc-collide",this.onCollidedListener),XJ.sharedBodesMap.delete(this.node.uuid),delete aQ.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.wrappedShapes=null,this.wrappedJoints0=null,this.wrappedJoints1=null,this.onCollidedListener=null},zJ.onCollided=function(e){WJ.type=e.event;var t=$Q(e.selfShape),i=$Q(e.otherShape);if(t&&t.collider.needCollisionEvent){jJ.push.apply(jJ,WJ.contacts),WJ.contacts.length=0,WJ.impl=e,WJ.selfCollider=t.collider,WJ.otherCollider=i?i.collider:null;var n=0;if("onCollisionExit"!==WJ.type)for(n=0;n<e.contacts.length;n++){var r,o=e.contacts[n];0<jJ.length?((r=jJ.pop()).impl=o,WJ.contacts.push(r)):((r=new GJ(WJ)).impl=o,WJ.contacts.push(r))}for(n=0;n<this.wrappedShapes.length;n++)this.wrappedShapes[n].collider.emit(WJ.type,WJ)}},e(XJ,[{key:"enabled",set:function(e){e?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):0<=this.index&&(0===this.wrappedShapes.length&&null==this.wrappedBody||0===this.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"reference",set:function(e){e?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),XJ);function XJ(e,t){this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=t,this.node=e,this.body=new aQ.Body,JQ(this.body,this),this.body.collisionFilterGroup=UQ.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=UQ.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}function YJ(e){this.impl=null,this.event=void 0,this.event=e}qJ.sharedBodesMap=new Map;(KJ=ZJ.prototype).setDefaultMaterial=function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=BJ.idToMaterial[e.id]&&(BJ.idToMaterial[e.id]=this._world.defaultMaterial)},KJ.setAllowSleep=function(e){this._world.allowSleep=e},KJ.setGravity=function(e){ce.copy(this._world.gravity,e)},KJ.destroy=function(){(this.constraints.length||this.bodies.length)&&tt("You should destroy all physics component first."),this._world.broadphase=null,this._world=null},KJ.emitEvents=function(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()},KJ.syncSceneToPhysics=function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()},KJ.syncAfterEvents=function(){this.syncSceneToPhysics()},KJ.step=function(e,t,i){if(0!==this.bodies.length){this._world.step(e,t,i);for(var n=0;n<this.bodies.length;n++)this.bodies[n].syncPhysicsToScene()}},KJ.raycastClosest=function(e,t,i){e$(e,t.maxDistance),IJ(h$,t);e=this._world.raycastClosest(JJ,$J,h$,ZJ.rayResult);return e&&RJ(i,ZJ.rayResult),e},KJ.raycast=function(e,t,i,n){return e$(e,t.maxDistance),IJ(h$,t),this._world.raycastAll(JJ,$J,h$,function(e){var t=i.add();RJ(t,e),n.push(t)})},KJ.getSharedBody=function(e,t){return qJ.getSharedBody(e,this,t)},KJ.addSharedBody=function(e){this.bodies.indexOf(e)<0&&(this.bodies.push(e),this._world.addBody(e.body))},KJ.removeSharedBody=function(e){var t=this.bodies.indexOf(e);0<=t&&(Se(this.bodies,t),this._world.remove(e.body))},KJ.addConstraint=function(e){this.constraints.indexOf(e)<0&&(this.constraints.push(e),this._world.addConstraint(e.impl))},KJ.removeConstraint=function(e){var t=this.constraints.indexOf(e);0<=t&&(Se(this.constraints,t),this._world.removeConstraint(e.impl))},e(ZJ,[{key:"impl",get:function(){return this._world}}]);var KJ,QJ=ZJ;function ZJ(){this.bodies=[],this.constraints=[],this._world=void 0,this._world=new aQ.World,this._world.broadphase=new aQ.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}QJ.rayResult=new aQ.RaycastResult;var JJ=new aQ.Vec3,$J=new aQ.Vec3;function e$(e,t){ce.copy(JJ,e.o),e.computeHit($J,t)}var t$,i$,n$,r$,o$,a$,s$,c$,l$,u$,h$={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackfaces:!0},p$=(l(A$,l$=BJ),(u$=A$.prototype).updateSize=function(){ce.multiplyScalar(this.halfExtent,this.collider.size,.5);var e=tZ(eZ.set(this.collider.node.worldScale)),t=this.halfExtent.x*e.x,i=this.halfExtent.y*e.y,e=this.halfExtent.z*e.z,n=UQ.instance.minVolumeSize;this.impl.halfExtents.x=Fn(t,n,Number.MAX_VALUE),this.impl.halfExtents.y=Fn(i,n,Number.MAX_VALUE),this.impl.halfExtents.z=Fn(e,n,Number.MAX_VALUE),this.impl.updateConvexPolyhedronRepresentation(),-1!==this._index&&DJ(this._body)},u$.onLoad=function(){l$.prototype.onLoad.call(this),this.updateSize()},u$.setScale=function(e){l$.prototype.setScale.call(this,e),this.updateSize()},e(A$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),A$),_$=(l(w$,s$=BJ),(c$=w$.prototype).updateRadius=function(){var e=Math.abs(Jn(this.collider.node.worldScale));this.impl.radius=Fn(this.collider.radius*Math.abs(e),UQ.instance.minVolumeSize,Number.MAX_VALUE),this.impl.updateBoundingSphereRadius(),-1!==this._index&&DJ(this._body)},c$.onLoad=function(){s$.prototype.onLoad.call(this),this.updateRadius()},c$.setScale=function(e){s$.prototype.setScale.call(this,e),this.updateRadius()},e(w$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),w$),f$=new aQ.Vec3,d$=(l(C$,o$=BJ),(a$=C$.prototype).setMesh=function(e){var t,i;this._isBinding&&(e=e,null!=this._shape?e&&0<e.renderingSubMeshes.length?(t=e.renderingSubMeshes[0].geometricInfo.positions,i=e.renderingSubMeshes[0].geometricInfo.indices,this.updateProperties(t,i)):this.updateProperties(new Float32Array,new Uint16Array):e&&0<e.renderingSubMeshes.length?(t=e.renderingSubMeshes[0].geometricInfo.positions,i=e.renderingSubMeshes[0].geometricInfo.indices,this._shape=new aQ.Trimesh(t,i)):this._shape=new aQ.Trimesh(new Float32Array,new Uint16Array))},a$.onComponentSet=function(){this.setMesh(this.collider.mesh)},a$.onLoad=function(){o$.prototype.onLoad.call(this),this.setMesh(this.collider.mesh)},a$.setScale=function(e){o$.prototype.setScale.call(this,e),ce.copy(f$,e),this.impl.setScale(f$)},a$.updateProperties=function(e,t){this.impl.vertices=new Float32Array(e),this.impl.indices=new Int16Array(t),this.impl.normals=new Float32Array(t.length),this.impl.aabb=new aQ.AABB,this.impl.edges=[],this.impl.tree=new aQ.Octree(new aQ.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),0<=this._index&&DJ(this._body)},e(C$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),C$),m$=(l(E$,n$=BJ),(r$=E$.prototype).setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,aQ.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&DJ(this._body)},r$.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,aQ.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&DJ(this._body)},r$.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,aQ.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&DJ(this._body)},r$.onLoad=function(){n$.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},r$.setScale=function(e){n$.prototype.setScale.call(this,e),this.setRadius(this.collider.radius)},r$.updateProperties=function(e,t,B,i,n){var r=t,o=e,a=Math.cos,s=Math.sin,c=Math.abs,l=Math.max,o=1===i?(r=c(n.y)*t,l(c(n.x),c(n.z))*e):2===i?(r=c(n.z)*t,l(c(n.x),c(n.y))*e):(r=c(n.x)*t,l(c(n.y),c(n.z))*e),u=B,h=r/2,p=[],_=[],f=[],d=2*Math.PI/u;if(1===i){for(var m=[1],g=[0],v=0;v<u;v++){var y=o*a(d*v),x=o*s(d*v);p.push(new aQ.Vec3(y,h,x)),p.push(new aQ.Vec3(y,-h,x)),v<u-1?(_.push([2*v+2,2*v+3,2*v+1,2*v]),g.push(2*v+2),m.push(2*v+3)):_.push([0,1,2*v+1,2*v]),(u%2==1||v<u/2)&&f.push(new aQ.Vec3(a(d*(v+.5)),0,s(d*(v+.5))))}_.push(m);for(var S=[],b=0;b<g.length;b++)S.push(g[g.length-b-1]);_.push(S),f.push(new aQ.Vec3(0,1,0))}else if(2===i){for(var T=[0],E=[1],C=0;C<u;C++){var w=o*a(d*C),A=o*s(d*C);p.push(new aQ.Vec3(w,A,h)),p.push(new aQ.Vec3(w,A,-h)),C<u-1?(_.push([2*C,2*C+1,2*C+3,2*C+2]),T.push(2*C+2),E.push(2*C+3)):_.push([2*C,2*C+1,0,1]),(u%2==1||C<u/2)&&f.push(new aQ.Vec3(a(d*(C+.5)),s(d*(C+.5)),0))}_.push(T);for(var P=[],I=0;I<E.length;I++)P.push(E[E.length-I-1]);_.push(P),f.push(new aQ.Vec3(0,0,1))}else{for(var R=[0],D=[1],O=0;O<u;O++){var M=o*a(d*O),N=o*s(d*O);p.push(new aQ.Vec3(h,M,N)),p.push(new aQ.Vec3(-h,M,N)),O<u-1?(_.push([2*O,2*O+1,2*O+3,2*O+2]),R.push(2*O+2),D.push(2*O+3)):_.push([2*O,2*O+1,0,1]),(u%2==1||O<u/2)&&f.push(new aQ.Vec3(0,a(d*(O+.5)),s(d*(O+.5))))}_.push(R);for(var F=[],L=0;L<D.length;L++)F.push(D[D.length-L-1]);_.push(F),f.push(new aQ.Vec3(1,0,0))}this.impl.vertices=p,this.impl.faces=_,this.impl.uniqueAxes=f,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},e(E$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),E$),g$=new ce,v$=new ce,y$=(l(T$,t$=BJ),(i$=T$.prototype).setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,aQ.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&DJ(this._body)},i$.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,aQ.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&DJ(this._body)},i$.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,aQ.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&DJ(this._body)},i$.onLoad=function(){t$.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},i$.setScale=function(e){t$.prototype.setScale.call(this,e),this.setRadius(this.collider.radius)},i$.updateProperties=function(e,t,i,n,r){var o=t,a=e,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max,a=1===n?(o=l(r.y)*t,u(l(r.x),l(r.z))*e):2===n?(o=l(r.z)*t,u(l(r.x),l(r.y))*e):(o=l(r.x)*t,u(l(r.y),l(r.z))*e),h=i,p=o/2,_=[],f=[],d=[],m=2*Math.PI/h;if(1===n){var g=[];f.push(g),_.push(new aQ.Vec3(0,p,0));for(var v=0;v<h;v++){var y=a*s(m*v),x=a*c(m*v);_.push(new aQ.Vec3(y,-p,x))}for(var S,b=0;b<h;b++)0!==b&&g.push(b),f.push(S=b<h-1?[0,b+2,b+1]:[0,1,b+1]),ce.subtract(g$,_[0],_[S[1]]),ce.subtract(v$,_[S[2]],_[S[1]]),ce.cross(g$,v$,g$),g$.normalize(),d.push(new aQ.Vec3(g$.x,g$.y,g$.z));d.push(new aQ.Vec3(0,-1,0))}else if(2===n){var T=[];f.push(T),_.push(new aQ.Vec3(0,0,p));for(var E=0;E<h;E++){var C=a*s(m*E),w=a*c(m*E);_.push(new aQ.Vec3(C,w,-p))}for(var A,P=0;P<h;P++)0!==P&&T.push(h-P),f.push(A=P<h-1?[0,P+1,P+2]:[0,P+1,1]),ce.subtract(g$,_[0],_[A[1]]),ce.subtract(v$,_[A[2]],_[A[1]]),ce.cross(g$,g$,v$),g$.normalize(),d.push(new aQ.Vec3(g$.x,g$.y,g$.z));d.push(new aQ.Vec3(0,0,-1))}else{var I=[];f.push(I),_.push(new aQ.Vec3(p,0,0));for(var R=0;R<h;R++){var D=a*s(m*R),O=a*c(m*R);_.push(new aQ.Vec3(-p,D,O))}for(var M,N=0;N<h;N++)0!==N&&I.push(h-N),f.push(M=N<h-1?[0,N+1,N+2]:[0,N+1,1]),ce.subtract(g$,_[0],_[M[1]]),ce.subtract(v$,_[M[2]],_[M[1]]),ce.cross(g$,g$,v$),g$.normalize(),d.push(new aQ.Vec3(g$.x,g$.y,g$.z));d.push(new aQ.Vec3(-1,0,0))}this.impl.vertices=_,this.impl.faces=f,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},e(T$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),T$),x$=new aQ.AABB,S$=new aQ.AABB,b$=new aQ.Transform;function T$(e,t,i){var n;return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===i&&(i=eQ.Y_AXIS),(n=t$.call(this)||this)._shape=new aQ.Cylinder(0,e,t,aQ.CC_CONFIG.numSegmentsCone,i===eQ.Y_AXIS),n}function E$(e,t,i){var n;return void 0===e&&(e=.5),void 0===t&&(t=2),void 0===i&&(i=eQ.Y_AXIS),(n=n$.call(this)||this)._shape=new aQ.Cylinder(e,e,t,aQ.CC_CONFIG.numSegmentsCylinder,i===eQ.Y_AXIS),n}function C$(){return o$.apply(this,arguments)||this}function w$(e){var t;return void 0===e&&(e=.5),(t=s$.call(this)||this)._shape=new aQ.Sphere(e),t}function A$(){var e;return(e=l$.call(this)||this).halfExtent=void 0,e.halfExtent=new aQ.Vec3(.5,.5,.5),e._shape=new aQ.Box(e.halfExtent.clone()),e}aQ.Heightfield.prototype.calculateWorldAABB=function(e,t,i,n){var r=b$,o=S$,e=(ce.copy(r.position,e),gr.copy(r.quaternion,t),this.elementSize),t=this.data;x$.lowerBound.set(0,0,this.minValue),x$.upperBound.set((t.length-1)*e,(t[0].length-1)*e,this.maxValue),x$.toWorldFrame(r,o),i.copy(o.lowerBound),n.copy(o.upperBound)};l(G$,M$=BJ),(N$=G$.prototype).setTerrain=function(e){if(e){if(this._terrainID!==e._uuid){var t=e,i=t.getVertexCountI(),n=t.getVertexCountJ();this._terrainID=t._uuid,this.data.length=i-1;for(var r=0;r<i;r++){null==this.data[r]&&(this.data[r]=[]),this.data[r].length=n-1;for(var o=0;o<n;o++)this.data[r][o]=t.getHeight(r,n-1-o)}this.options.elementSize=t.tileSize,this.updateProperties(this.data,this.options.elementSize)}}else""!==this._terrainID&&(this._terrainID="",this.data.length=1,this.data[0]=this.data[0]||[],this.data[0].length=0,this.options.elementSize=0,this.updateProperties(this.data,this.options.elementSize))},N$.onComponentSet=function(){var e=this.collider.terrain;if(e){for(var t=e.getVertexCountI(),i=e.getVertexCountJ(),n=0;n<t;n++){null==this.data[n]&&(this.data[n]=[]);for(var r=0;r<i;r++)this.data[n][r]=e.getHeight(n,i-1-r)}this.options.elementSize=e.tileSize,this._terrainID=e._uuid}this._shape=new aQ.Heightfield(this.data,this.options)},N$.onLoad=function(){M$.prototype.onLoad.call(this),this.setTerrain(this.collider.terrain)},N$.updateProperties=function(e,t){var i=this.impl;i.data=e,i.elementSize=t,i.updateMinValue(),i.updateMaxValue(),i.updateBoundingSphereRadius(),i.update(),0<=this._index&&DJ(this._body)},N$._setCenter=function(e){var t,i=this.collider.terrain;i&&(gr.fromEuler(this._orient,-90,0,0),t=this._offset,ce.set(t,0,0,(i.getVertexCountJ()-1)*i.tileSize),ce.add(t,t,e))},e(G$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]);var P$,I$,R$,D$,O$,M$,N$,L$=G$,B$=(l(k$,D$=BJ),(O$=k$.prototype).setShapeType=function(){this._isBinding},O$.setVertices=function(e){var t=this.vertices.length;if(4===t){for(var i=this._collider.node.worldScale,n=0;n<t;n++)ce.multiply(this.vertices[n],i,e[n]);var r=this.impl;r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius()}-1!==this._index&&DJ(this._body)},O$.onComponentSet=function(){if(this.collider.shapeType===_J.ESimplexType.TETRAHEDRON){for(var e=0;e<4;e++)this.vertices[e]=new aQ.Vec3(0,0,0);this._shape=F$(this.vertices)}else _J.ESimplexType.VERTEX,this._shape=new aQ.Particle},O$.onLoad=function(){D$.prototype.onLoad.call(this),this.collider.updateVertices()},O$.setScale=function(e){D$.prototype.setScale.call(this,e),this.collider.updateVertices()},e(k$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),k$),F$=(P$=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]],function(e){return new aQ.ConvexPolyhedron(e,P$)}),z$=(l(U$,I$=BJ),(R$=U$.prototype).setNormal=function(e){gr.rotationTo(this._orient,ce.UNIT_Z,e),-1!==this._index&&DJ(this._body)},R$.setConstant=function(e){ce.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,e)},R$.onLoad=function(){I$.prototype.onLoad.call(this),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)},R$._setCenter=function(e){I$.prototype._setCenter.call(this,e),this.setConstant(this.collider.constant)},e(U$,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),U$);function U$(){var e;return(e=I$.call(this)||this)._shape=new aQ.Plane,e}function k$(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=D$.call.apply(D$,[this].concat(i))||this).vertices=[],e}function G$(){var e;return(e=M$.call(this)||this).data=void 0,e.options=void 0,e._terrainID=void 0,e.data=[[]],e.options={elementSize:0},e._terrainID="",e}aQ.World.staticBody=new aQ.Body,aQ.World.idToConstraintMap={};(q$=eee.prototype).setConnectedBody=function(e){var t=$Q(this.impl.bodyB),i=(t&&t.removeJoint(this,1),e?(this._impl.bodyB=e.body.impl,e.body.sharedBody.addJoint(this,1)):this._impl.bodyB=aQ.World.staticBody,this._impl.bodyB);this._impl.equations.forEach(function(e){e.bj=i})},q$.setEnableCollision=function(e){this._impl.collideConnected=e},q$.initialize=function(e){this._com=e,this._rigidBody=e.attachedBody,this.onComponentSet(),this.setEnableCollision(e.enableCollision),aQ.World.idToConstraintMap[this._impl.id]=this._impl},q$.onComponentSet=function(){},q$.updateScale0=function(){},q$.updateScale1=function(){},q$.onEnable=function(){var e=this._rigidBody.body.sharedBody,e=(e.wrappedWorld.addConstraint(this),e.addJoint(this,0),this.constraint.connectedBody);e&&e.body.sharedBody.addJoint(this,1)},q$.onDisable=function(){var e=this._rigidBody.body.sharedBody,e=(e.wrappedWorld.removeConstraint(this),e.removeJoint(this,0),this.constraint.connectedBody);e&&e.body.sharedBody.removeJoint(this,1)},q$.onDestroy=function(){delete aQ.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null},e(eee,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]);var H$,V$,j$,W$,q$,X$=eee,Y$=new ce,K$=(l($$,j$=X$),(W$=$$.prototype).setPivotA=function(){var e=this.constraint;ce.multiply(this.impl.pivotA,e.node.worldScale,e.pivotA),e.connectedBody||this.setPivotB(e.pivotB)},W$.setPivotB=function(){var e=this.constraint,t=e.connectedBody;t?ce.multiply(this.impl.pivotB,t.node.worldScale,e.pivotB):(t=e.node,ce.multiply(Y$,t.worldScale,e.pivotA),ce.add(Y$,Y$,t.worldPosition),ce.add(Y$,Y$,e.pivotB),ce.copy(this.impl.pivotB,Y$))},W$.onComponentSet=function(){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,i=aQ.World.staticBody;t&&(i=t.body.impl),this._impl=new aQ.PointToPointConstraint(e,null,i),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},W$.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},W$.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},e($$,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),$$),Q$=new ce,Z$=(l(J$,H$=X$),(V$=J$.prototype).setPivotA=function(){var e=this.constraint;ce.multiply(this.impl.pivotA,this.constraint.node.worldScale,e.pivotA),e.connectedBody||this.setPivotB(e.pivotB)},V$.setPivotB=function(){var e=this.constraint,t=e.connectedBody;t?ce.multiply(this.impl.pivotB,t.node.worldScale,e.pivotB):(t=this.constraint.node,ce.multiply(Q$,t.worldScale,e.pivotA),ce.add(Q$,Q$,t.worldPosition),ce.add(Q$,Q$,e.pivotB),ce.copy(this.impl.pivotB,Q$))},V$.setAxis=function(e){ce.copy(this.impl.axisA,e),ce.copy(this.impl.equations[3].axisA,e),ce.copy(this.impl.equations[4].axisA,e),ce.copy(this.impl.equations[5].axisA,e),this.constraint.connectedBody?(ce.copy(this.impl.axisB,e),ce.copy(this.impl.equations[3].axisB,e),ce.copy(this.impl.equations[4].axisB,e),ce.copy(this.impl.equations[5].axisB,e)):(ce.transformQuat(this.impl.axisB,e,this.constraint.node.worldRotation),ce.copy(this.impl.equations[3].axisB,this.impl.axisB),ce.copy(this.impl.equations[4].axisB,this.impl.axisB),ce.copy(this.impl.equations[5].axisB,this.impl.axisB))},V$.onComponentSet=function(){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,i=aQ.World.staticBody;t&&(i=t.body.impl),this._impl=new aQ.HingeConstraint(e,i),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxis(this.constraint.axis)},V$.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},V$.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},e(J$,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),J$);function J$(){return H$.apply(this,arguments)||this}function $$(){return j$.apply(this,arguments)||this}function eee(){}YP.once(WP.EVENT_ENGINE_INITED,function(){uQ.register("cannon.js",{PhysicsWorld:QJ,RigidBody:AJ,BoxShape:p$,SphereShape:_$,TrimeshShape:d$,CylinderShape:m$,ConeShape:y$,TerrainShape:L$,SimplexShape:B$,PlaneShape:z$,PointToPointConstraint:K$,HingeConstraint:Z$})}),window&&(window.CANNON=aQ),aQ.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0,correctInelastic:3},aQ.ArrayCollisionMatrix.prototype.reset=function(){for(var e in this.matrix)delete this.matrix[e]},aQ.Ray.perBodyFilter=function(e,t){return 0!=(e.collisionFilterMask&t.collisionFilterGroup)};function tee(){this.pos=new U(0,0),this.startPos=new U(0,0),this.color=new nr(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new U(0,0),this.aspectRatio=1,this.dir=new U(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0}var iee,nee,ree,oee,aee,see,cee=Ot({GRAVITY:0,RADIUS:1}),lee=Ot({FREE:0,RELATIVE:1,GROUPED:2}),uee=new U(0,0),hee=new U,pee=new U,_ee=new U,fee=new U,dee=YB(XB),mee=(l(See,see=dt),See.prototype.get=function(){return this._get()||new tee},new See(function(e){e.pos.set(uee),e.startPos.set(uee),e.color._val=4278190080,e.deltaColor.r=e.deltaColor.g=e.deltaColor.b=0,e.deltaColor.a=255,e.size=0,e.deltaSize=0,e.rotation=0,e.deltaRotation=0,e.timeToLive=0,e.drawPos.set(uee),e.aspectRatio=1,e.dir.set(uee),e.radialAccel=0,e.tangentialAccel=0,e.angle=0,e.degreesPerSecond=0,e.radius=0,e.deltaRadius=0},1024)),gee=((aee=xee.prototype).stop=function(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0},aee.reset=function(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;for(var e=this.particles,t=0;t<e.length;++t)mee.put(e[t]);e.length=0},aee.emitParticle=function(e){var t=this.sys,i=mee.get(),n=(this.particles.push(i),i.timeToLive=t.life+t.lifeVar*(Math.random()-.5)*2,i.timeToLive=Math.max(0,i.timeToLive));i.pos.x=t.sourcePos.x+t.posVar.x*(Math.random()-.5)*2,i.pos.y=t.sourcePos.y+t.posVar.y*(Math.random()-.5)*2;var r,o=t.startColor,a=t.startColorVar,s=t.endColor,c=t.endColorVar,a=(i.color.r=r=Qt(o.r+a.r*(Math.random()-.5)*2,0,255),i.color.g=l=Qt(o.g+a.g*(Math.random()-.5)*2,0,255),i.color.b=u=Qt(o.b+a.b*(Math.random()-.5)*2,0,255),i.color.a=o=Qt(o.a+a.a*(Math.random()-.5)*2,0,255),i.deltaColor.r=(Qt(s.r+c.r*(Math.random()-.5)*2,0,255)-r)/n,i.deltaColor.g=(Qt(s.g+c.g*(Math.random()-.5)*2,0,255)-l)/n,i.deltaColor.b=(Qt(s.b+c.b*(Math.random()-.5)*2,0,255)-u)/n,i.deltaColor.a=(Qt(s.a+c.a*(Math.random()-.5)*2,0,255)-o)/n,t.startSize+t.startSizeVar*(Math.random()-.5)*2),a=Math.max(0,a),l=(i.size=a,-1===t.endSize?i.deltaSize=0:(r=t.endSize+t.endSizeVar*(Math.random()-.5)*2,r=Math.max(0,r),i.deltaSize=(r-a)/n),t.startSpin+t.startSpinVar*(Math.random()-.5)*2),u=t.endSpin+t.endSpinVar*(Math.random()-.5)*2,s=(i.rotation=l,i.deltaRotation=(u-l)/n,i.startPos.x=e.x,i.startPos.y=e.y,i.aspectRatio=t.aspectRatio||1,Zt(t.angle+this._worldRotation+t.angleVar*(Math.random()-.5)*2));t.emitterMode===cee.GRAVITY?(c=t.speed+t.speedVar*(Math.random()-.5)*2,i.dir.x=Math.cos(s),i.dir.y=Math.sin(s),i.dir.multiplyScalar(c),i.radialAccel=t.radialAccel+t.radialAccelVar*(Math.random()-.5)*2,i.tangentialAccel=t.tangentialAccel+t.tangentialAccelVar*(Math.random()-.5)*2,t.rotationIsDir&&(i.rotation=-Jt(Math.atan2(i.dir.y,i.dir.x)))):(o=t.startRadius+t.startRadiusVar*(Math.random()-.5)*2,r=t.endRadius+t.endRadiusVar*(Math.random()-.5)*2,i.radius=o,i.deltaRadius=-1===t.endRadius?0:(r-o)/n,i.angle=s,i.degreesPerSecond=Zt(t.rotatePerS+t.rotatePerSVar*(Math.random()-.5)*2))},aee.updateUVs=function(e){var t=this.renderData;if(t&&this.sys._renderSpriteFrame){for(var i=t.vData,n=this.sys._renderSpriteFrame.uv,t=e?0:this.uvFilled,r=this.particles.length,o=t;o<r;o++){var a=o*dee*4;i[3+a]=n[0],i[4+a]=n[1],i[12+a]=n[2],i[13+a]=n[3],i[21+a]=n[4],i[22+a]=n[5],i[30+a]=n[6],i[31+a]=n[7]}this.uvFilled=r}},aee.updateParticleBuffer=function(e,t,i,n){var r,o,a,s,c,i=i.vData,l=t.x,t=t.y,u=e.size,h=u,p=e.aspectRatio,p=(1<p?h=u/p:u=h*p,u/2),u=h/2;e.rotation?(h=-p,r=-u,o=p,a=u,c=-Zt(e.rotation),s=Math.cos(c),c=Math.sin(c),i[n]=h*s-r*c+l,i[n+1]=h*c+r*s+t,i[n+2]=0,i[n+9]=o*s-r*c+l,i[n+10]=o*c+r*s+t,i[n+11]=0,i[n+18]=h*s-a*c+l,i[n+19]=h*c+a*s+t,i[n+20]=0,i[n+27]=o*s-a*c+l,i[n+28]=o*c+a*s+t):(i[n]=l-p,i[n+1]=t-u,i[n+2]=0,i[n+9]=l+p,i[n+10]=t-u,i[n+11]=0,i[n+18]=l-p,i[n+19]=t+u,i[n+20]=0,i[n+27]=l+p,i[n+28]=t+u),i[n+29]=0,nr.toArray(i,e.color,n+5),nr.toArray(i,e.color,n+14),nr.toArray(i,e.color,n+23),nr.toArray(i,e.color,n+32)},aee.step=function(e){var t=this.sys.assembler,i=this.sys,n=i.node,r=this.particles;if(e=e>t.maxParticleDeltaTime?t.maxParticleDeltaTime:e,n.updateWorldTransform(),i.positionType===lee.FREE?(this._worldRotation=function(){for(var e=0,t=n;t;)e+=t.eulerAngles.z,t=t.parent;return e}(),t=n.worldMatrix,hee.x=t.m12,hee.y=t.m13):i.positionType===lee.RELATIVE?(this._worldRotation=n.eulerAngles.z,hee.x=n.position.x,hee.y=n.position.y):this._worldRotation=0,this.active&&i.emissionRate){var o=1/i.emissionRate;for(r.length<i.totalParticles&&(this.emitCounter+=e);r.length<i.totalParticles&&this.emitCounter>o;)this.emitParticle(hee),this.emitCounter-=o;this.elapsed+=e,-1!==i.duration&&i.duration<this.elapsed&&i.stopSystem()}var a=this.renderData,t=r.length;a.reset(),this.requestData(4*t,6*t),t>this.uvFilled&&this.updateUVs();for(var s=0;s<r.length;){pee.x=pee.y=_ee.x=_ee.y=fee.x=fee.y=0;var c,l,u,h,p=r[s];p.timeToLive-=e,0<p.timeToLive?(i.emitterMode===cee.GRAVITY?(c=fee,h=pee,l=_ee,(p.pos.x||p.pos.y)&&(h.set(p.pos),h.normalize()),l.set(h),h.multiplyScalar(p.radialAccel),u=l.x,l.x=-l.y,l.y=u,l.multiplyScalar(p.tangentialAccel),c.set(h),c.add(l),c.add(i.gravity),c.multiplyScalar(e),p.dir.add(c),c.set(p.dir),c.multiplyScalar(e),p.pos.add(c)):(p.angle+=p.degreesPerSecond*e,p.radius+=p.deltaRadius*e,p.pos.x=-Math.cos(p.angle)*p.radius,p.pos.y=-Math.sin(p.angle)*p.radius),p.color.r+=p.deltaColor.r*e,p.color.g+=p.deltaColor.g*e,p.color.b+=p.deltaColor.b*e,p.color.a+=p.deltaColor.a*e,p.size+=p.deltaSize*e,p.size<0&&(p.size=0),p.rotation+=p.deltaRotation*e,(u=pee).set(p.pos),i.positionType!==lee.GROUPED&&u.add(p.startPos),this.updateParticleBuffer(p,u,a,dee*s*4),++s):(h=r[s],s!==r.length-1&&(r[s]=r[r.length-1]),mee.put(h),r.length--,a.resize(a.vertexCount-4,a.indexCount-6))}0!==r.length||this.active||this.readyToPlay||(this.finished=!0,i._finishedSimulation())},aee.requestData=function(e,t){var i=this.renderData.indexCount;this.renderData.request(e,t);for(var n=this.renderData.indexCount/6,r=this.renderData.iData,o=i;o<n;o++){var a=4*o;r[i++]=a,r[i++]=1+a,r[i++]=2+a,r[i++]=1+a,r[i++]=3+a,r[i++]=2+a}},xee),vee=Rre("ParticleAsset",f("cc.ParticleAsset")((l(yee,oee=P_),ree=i((nee=yee).prototype,"spriteFrame",[d,Ap],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iee=nee))||iee);function yee(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=oee.call.apply(oee,[this].concat(i))||this,"spriteFrame",ree,p(e)),e}function xee(e){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=e,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}function See(){return see.apply(this,arguments)||this}j.ParticleAsset=vee;var bee={},Tee=(!function(){function J(e){throw e}var $=void 0,ee=!0,A=this;function e(e,t){var i,n=e.split("."),r=A;n[0]in r||!r.execScript||r.execScript("var "+n[0]);for(;n.length&&(i=n.shift());)n.length||t===$?r=r[i]||(r[i]={}):r[i]=t}var te="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function P(e){if("string"==typeof e){for(var t=e.split(""),i=0,n=t.length;i<n;i++)t[i]=(255&t[i].charCodeAt(0))>>>0;e=t}for(var r,o=1,a=0,s=e.length,c=0;0<s;){for(s-=r=1024<s?1024:s;a+=o+=e[c++],--r;);o%=65521,a%=65521}return(a<<16|o)>>>0}function ie(e,t){this.index="number"==typeof t?t:0,this.i=0,this.buffer=e instanceof(te?Uint8Array:Array)?e:new(te?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&J(Error("invalid index")),this.buffer.length<=this.index&&this.f()}ie.prototype.f=function(){var e,t=this.buffer,i=t.length,n=new(te?Uint8Array:Array)(i<<1);if(te)n.set(t);else for(e=0;e<i;++e)n[e]=t[e];return this.buffer=n},ie.prototype.d=function(e,t,i){var n,r=this.buffer,o=this.index,a=this.i,s=r[o];if(i&&1<t&&(e=8<t?(c[255&e]<<24|c[e>>>8&255]<<16|c[e>>>16&255]<<8|c[e>>>24&255])>>32-t:c[e]>>8-t),t+a<8)s=s<<t|e,a+=t;else for(n=0;n<t;++n)s=s<<1|e>>t-n-1&1,8==++a&&(a=0,r[o++]=c[s],s=0,o===r.length&&(r=this.f()));r[o]=s,this.buffer=r,this.i=a,this.index=o},ie.prototype.finish=function(){var e=this.buffer,t=this.index;return 0<this.i&&(e[t]<<=8-this.i,e[t]=c[e[t]],t++),te?e.subarray(0,t):(e.length=t,e)};for(var I=new(te?Uint8Array:Array)(256),t=0;t<256;++t){for(var i=n=t,R=7,n=n>>>1;n;n>>>=1)i=i<<1|1&n,--R;I[t]=(i<<R&255)>>>0}var c=I;function E(e){this.buffer=new(te?Uint16Array:Array)(2*e),this.length=0}function v(e){for(var t,i,n,r,o,a,s,c,l=e.length,u=0,h=Number.POSITIVE_INFINITY,p=0;p<l;++p)e[p]>u&&(u=e[p]),e[p]<h&&(h=e[p]);for(t=1<<u,i=new(te?Uint32Array:Array)(t),n=1,r=0,o=2;n<=u;){for(p=0;p<l;++p)if(e[p]===n){for(s=r,c=a=0;c<n;++c)a=a<<1|1&s,s>>=1;for(c=a;c<t;c+=o)i[c]=n<<16|p;++r}++n,r<<=1,o<<=1}return[i,u,h]}function D(e,t){this.h=ne,this.w=0,this.input=e,this.b=0,t&&(t.lazy&&(this.w=t.lazy),"number"==typeof t.compressionType&&(this.h=t.compressionType),t.outputBuffer&&(this.a=te&&t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.b=t.outputIndex)),this.a||(this.a=new(te?Uint8Array:Array)(32768))}E.prototype.getParent=function(e){return 2*((e-2)/4|0)},E.prototype.push=function(e,t){var i,n,r=this.buffer,o=this.length;for(r[this.length++]=t,r[this.length++]=e;0<o&&(i=this.getParent(o),r[o]>r[i]);)n=r[o],r[o]=r[i],r[i]=n,n=r[o+1],r[o+1]=r[i+1],r[i+1]=n,o=i;return this.length},E.prototype.pop=function(){var e,t,i,n=this.buffer,r=n[0],o=n[1];for(this.length-=2,n[0]=n[this.length],n[1]=n[this.length+1],i=0;!((t=2*i+2)>=this.length)&&(t+2<this.length&&n[t+2]>n[t]&&(t+=2),n[t]>n[i]);)e=n[i],n[i]=n[t],n[t]=e,e=n[i+1],n[i+1]=n[t+1],n[t+1]=e,i=t;return{index:o,value:r,length:this.length}};for(var ne=2,r={NONE:0,r:1,j:ne,N:3},re=[],o=0;o<288;o++)switch(ee){case o<=143:re.push([o+48,8]);break;case o<=255:re.push([o-144+400,9]);break;case o<=279:re.push([o-256,7]);break;case o<=287:re.push([o-280+192,8]);break;default:J("invalid literal: "+o)}function O(e,t){this.length=e,this.G=t}D.prototype.n=function(){var e,t,B,i=this.input;switch(this.h){case 0:for(t=0,B=i.length;t<B;){var F,z,n=r=te?i.subarray(t,t+65535):i.slice(t,t+65535),r=(t+=r.length)===B,o=$,a=this.a,s=this.b;if(te){for(a=new Uint8Array(this.a.buffer);a.length<=s+n.length+5;)a=new Uint8Array(a.length<<1);a.set(this.a)}if(a[s++]=0|(r?1:0),F=65536+~(r=n.length)&65535,a[s++]=255&r,a[s++]=r>>>8&255,a[s++]=255&F,a[s++]=F>>>8&255,te)a.set(n,s),s+=n.length,a=a.subarray(0,s);else{for(o=0,z=n.length;o<z;++o)a[s++]=n[o];a.length=s}this.b=s,this.a=a}break;case 1:var c=new ie(new Uint8Array(this.a.buffer),this.b);c.d(1,1,ee),c.d(1,2,ee);for(var l,u=se(this,i),h=0,U=u.length;h<U;h++)if(l=u[h],ie.prototype.d.apply(c,re[l]),256<l)c.d(u[++h],u[++h],ee),c.d(u[++h],5),c.d(u[++h],u[++h],ee);else if(256===l)break;this.a=c.finish(),this.b=this.a.length;break;case ne:var p,_,f,d,m,g,v,k,y,x,S,G,b=new ie(new Uint8Array(this.a),this.b),H=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=Array(19),T=ne;for(b.d(1,1,ee),b.d(T,2,ee),p=se(this,i),T=ae(m=oe(this.L,15)),N=ae(g=oe(this.K,7)),_=286;257<_&&0===m[_-1];_--);for(f=30;1<f&&0===g[f-1];f--);for(var E,C,w,A,P,j=_,W=f,I=new(te?Uint32Array:Array)(j+W),R=new(te?Uint32Array:Array)(316),D=new(te?Uint8Array:Array)(19),O=E=0;O<j;O++)I[E++]=m[O];for(O=0;O<W;O++)I[E++]=g[O];if(!te)for(O=0,w=D.length;O<w;++O)D[O]=0;for(O=A=0,w=I.length;O<w;O+=E){for(E=1;O+E<w&&I[O+E]===I[O];++E);if(C=E,0===I[O])if(C<3)for(;0<C--;)D[R[A++]=0]++;else for(;0<C;)(P=(P=C<138?C:138)>C-3&&P<C?C-3:P)<=10?(R[A++]=17,R[A++]=P-3,D[17]++):(R[A++]=18,R[A++]=P-11,D[18]++),C-=P;else if(R[A++]=I[O],D[I[O]]++,--C<3)for(;0<C--;)R[A++]=I[O],D[I[O]]++;else for(;0<C;)(P=C<6?C:6)>C-3&&P<C&&(P=C-3),R[A++]=16,R[A++]=P-3,D[16]++,C-=P}for(e=te?R.subarray(0,A):R.slice(0,A),v=oe(D,7),S=0;S<19;S++)V[S]=v[H[S]];for(d=19;4<d&&0===V[d-1];d--);for(k=ae(v),b.d(_-257,5,ee),b.d(f-1,5,ee),b.d(d-4,4,ee),S=0;S<d;S++)b.d(V[S],3,ee);for(S=0,G=e.length;S<G;S++)if(y=e[S],b.d(k[y],v[y],ee),16<=y){switch(S++,y){case 16:x=2;break;case 17:x=3;break;case 18:x=7;break;default:J("invalid code: "+y)}b.d(e[S],x,ee)}for(var M,q,T=[T,m],N=[N,g],X=T[0],Y=T[1],K=N[0],Q=N[1],L=0,Z=p.length;L<Z;++L)if(M=p[L],b.d(X[M],Y[M],ee),256<M)b.d(p[++L],p[++L],ee),q=p[++L],b.d(K[q],Q[q],ee),b.d(p[++L],p[++L],ee);else if(256===M)break;this.a=b.finish(),this.b=this.a.length;break;default:J("invalid compression type")}return this.a};for(var a,s=[],l=3;l<=258;l++)a=function(){var e=l;switch(ee){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case e<=12:return[265,e-11,1];case e<=14:return[266,e-13,1];case e<=16:return[267,e-15,1];case e<=18:return[268,e-17,1];case e<=22:return[269,e-19,2];case e<=26:return[270,e-23,2];case e<=30:return[271,e-27,2];case e<=34:return[272,e-31,2];case e<=42:return[273,e-35,3];case e<=50:return[274,e-43,3];case e<=58:return[275,e-51,3];case e<=66:return[276,e-59,3];case e<=82:return[277,e-67,4];case e<=98:return[278,e-83,4];case e<=114:return[279,e-99,4];case e<=130:return[280,e-115,4];case e<=162:return[281,e-131,5];case e<=194:return[282,e-163,5];case e<=226:return[283,e-195,5];case e<=257:return[284,e-227,5];case 258===e:return[285,e-258,0];default:J("invalid length: "+e)}}(),s[l]=a[2]<<24|a[1]<<16|a[0];var M=te?new Uint32Array(s):s;function se(e,t){function i(e,t){var i,n,r,o=e.G,a=[],s=0,c=M[e.length];switch(a[s++]=65535&c,a[s++]=c>>16&255,a[s++]=c>>24,ee){case 1===o:i=[0,o-1,0];break;case 2===o:i=[1,o-2,0];break;case 3===o:i=[2,o-3,0];break;case 4===o:i=[3,o-4,0];break;case o<=6:i=[4,o-5,1];break;case o<=8:i=[5,o-7,1];break;case o<=12:i=[6,o-9,2];break;case o<=16:i=[7,o-13,2];break;case o<=24:i=[8,o-17,3];break;case o<=32:i=[9,o-25,3];break;case o<=48:i=[10,o-33,4];break;case o<=64:i=[11,o-49,4];break;case o<=96:i=[12,o-65,5];break;case o<=128:i=[13,o-97,5];break;case o<=192:i=[14,o-129,6];break;case o<=256:i=[15,o-193,6];break;case o<=384:i=[16,o-257,7];break;case o<=512:i=[17,o-385,7];break;case o<=768:i=[18,o-513,8];break;case o<=1024:i=[19,o-769,8];break;case o<=1536:i=[20,o-1025,9];break;case o<=2048:i=[21,o-1537,9];break;case o<=3072:i=[22,o-2049,10];break;case o<=4096:i=[23,o-3073,10];break;case o<=6144:i=[24,o-4097,11];break;case o<=8192:i=[25,o-6145,11];break;case o<=12288:i=[26,o-8193,12];break;case o<=16384:i=[27,o-12289,12];break;case o<=24576:i=[28,o-16385,13];break;case o<=32768:i=[29,o-24577,13];break;default:J("invalid distance")}for(c=i,a[s++]=c[0],a[+s]=c[1],a[5]=c[2],n=0,r=a.length;n<r;++n)_[f++]=a[n];m[a[0]]++,g[a[3]]++,d=e.length+t-1,u=null}var n,r,o,a,s,c,l,u,h,p={},_=te?new Uint16Array(2*t.length):[],f=0,d=0,m=new(te?Uint32Array:Array)(286),g=new(te?Uint32Array:Array)(30),v=e.w;if(!te){for(o=0;o<=285;)m[o++]=0;for(o=0;o<=29;)g[o++]=0}for(m[256]=1,n=0,r=t.length;n<r;++n){for(o=s=0,a=3;o<a&&n+o!==r;++o)s=s<<8|t[n+o];if(p[s]===$&&(p[s]=[]),c=p[s],!(0<d--)){for(;0<c.length&&32768<n-c[0];)c.shift();if(r<=n+3){for(u&&i(u,-1),o=0,a=r-n;o<a;++o)h=t[n+o],_[f++]=h,++m[h];break}if(0<c.length){var y,x=$,S=0,b=$,T=$,E=$,C=t.length,w=(T=0,c.length);e:for(;T<w;T++){if(y=c[w-T-1],(b=3)<S){for(E=S;3<E;E--)if(t[y+E-1]!==t[n+E-1])continue e;b=S}for(;b<258&&n+b<C&&t[y+b]===t[n+b];)++b;if(S<b&&(x=y,S=b),258===b)break}l=new O(S,n-x),u?u.length<l.length?(h=t[n-1],_[f++]=h,++m[h],i(l,0)):i(u,-1):l.length<v?u=l:i(l,0)}else u?i(u,-1):(h=t[n],_[f++]=h,++m[h])}c.push(n)}return _[f++]=256,m[256]++,e.L=m,e.K=g,te?_.subarray(0,f):_}function oe(e,t){var i,n,r,o,a,s=e.length,c=new E(572),l=new(te?Uint8Array:Array)(s);if(!te)for(o=0;o<s;o++)l[o]=0;for(o=0;o<s;++o)0<e[o]&&c.push(o,e[o]);if(i=Array(c.length/2),n=new(te?Uint32Array:Array)(c.length/2),1===i.length)return l[c.pop().index]=1,l;for(o=0,a=c.length/2;o<a;++o)i[o]=c.pop(),n[o]=i[o].value;var u,h,p,_,f,d=n.length,m=new(te?Uint16Array:Array)(t),g=new(te?Uint8Array:Array)(t),v=new(te?Uint8Array:Array)(d),y=Array(t),x=Array(t),S=Array(t),b=(1<<t)-d,T=1<<t-1;for(m[t-1]=d,h=0;h<t;++h)b<T?g[h]=0:(g[h]=1,b-=T),b<<=1,m[t-2-h]=(m[t-1-h]/2|0)+d;for(m[0]=g[0],y[0]=Array(m[0]),x[0]=Array(m[0]),h=1;h<t;++h)m[h]>2*m[h-1]+g[h]&&(m[h]=2*m[h-1]+g[h]),y[h]=Array(m[h]),x[h]=Array(m[h]);for(u=0;u<d;++u)v[u]=t;for(p=0;p<m[t-1];++p)y[t-1][p]=n[p],x[t-1][p]=p;for(u=0;u<t;++u)S[u]=0;for(1===g[t-1]&&(--v[0],++S[t-1]),h=t-2;0<=h;--h){for(u=0,f=S[h+1],p=0;p<m[h];p++)(_=y[h+1][f]+y[h+1][f+1])>n[u]?(y[h][p]=_,x[h][p]=d,f+=2):(y[h][p]=n[u],x[h][p]=u,++u);S[h]=0,1===g[h]&&function e(t){var i=x[t][S[t]];i===d?(e(t+1),e(t+1)):--v[i],++S[t]}(h)}for(r=v,o=0,a=i.length;o<a;++o)l[i[o].index]=r[o];return l}function ae(e){for(var t,i,n=new(te?Uint16Array:Array)(e.length),r=[],o=[],a=0,s=0,c=e.length;s<c;s++)r[e[s]]=1+(0|r[e[s]]);for(s=1,c=16;s<=c;s++)o[s]=a,(a+=0|r[s])>1<<s&&J("overcommitted"),a<<=1;for(a<65536&&J("undercommitted"),s=0,c=e.length;s<c;s++)for(a=o[e[s]],o[e[s]]+=1,t=n[s]=0,i=e[s];t<i;t++)n[s]=n[s]<<1|1&a,a>>>=1;return n}function u(e,t){this.input=e,this.a=new(te?Uint8Array:Array)(32768),this.h=h.j;var i,n={};for(i in(t?"number"!=typeof t.compressionType:t={})||(this.h=t.compressionType),t)n[i]=t[i];n.outputBuffer=this.a,this.z=new D(this.input,n)}var h=r;function p(e,t){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=te?new Uint8Array(e):e,this.s=!1,this.m=x,this.B=!1,t?(t.index&&(this.c=t.index),t.bufferSize&&(this.l=t.bufferSize),t.bufferType&&(this.m=t.bufferType),t.resize&&(this.B=t.resize)):t={},this.m){case y:this.b=32768,this.a=new(te?Uint8Array:Array)(32768+this.l+258);break;case x:this.b=0,this.a=new(te?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:J(Error("invalid inflate mode"))}}u.prototype.n=function(){var e,t,i,n=0,r=this.a;if((e=w)===w?i=Math.LOG2E*Math.log(32768)-8:J(Error("invalid compression method")),r[n++]=i=i<<4|e,e===w)switch(this.h){case h.NONE:t=0;break;case h.r:t=1;break;case h.j:t=2;break;default:J(Error("unsupported compression type"))}else J(Error("invalid compression method"));return r[n++]=(e=t<<6|0)|31-(256*i+e)%31,i=P(this.input),this.z.b=n,n=(r=this.z.n()).length,te&&((r=new Uint8Array(r.buffer)).length<=n+4&&(this.a=new Uint8Array(r.length+4),this.a.set(r),r=this.a),r=r.subarray(0,n+4)),r[n++]=i>>24&255,r[n++]=i>>16&255,r[n++]=i>>8&255,r[n++]=255&i,r},e("Zlib.Deflate",u),e("Zlib.Deflate.compress",function(e,t){return new u(e,t).n()}),e("Zlib.Deflate.CompressionType",h),e("Zlib.Deflate.CompressionType.NONE",h.NONE),e("Zlib.Deflate.CompressionType.FIXED",h.r),e("Zlib.Deflate.CompressionType.DYNAMIC",h.j);var y=0,x=1,r={D:y,C:x};p.prototype.p=function(){for(;!this.s;){var e=b(this,3);switch(1&e&&(this.s=ee),e>>>=1){case 0:var t=this.input,i=this.c,n=this.a,r=this.b,o=$,a=n.length,s=$;switch(this.e=this.g=0,(c=t[i++])===$&&J(Error("invalid uncompressed block header: LEN (first byte)")),o=c,(c=t[i++])===$&&J(Error("invalid uncompressed block header: LEN (second byte)")),o|=c<<8,(c=t[i++])===$&&J(Error("invalid uncompressed block header: NLEN (first byte)")),l=c,(c=t[i++])===$&&J(Error("invalid uncompressed block header: NLEN (second byte)")),o===~(l|=c<<8)&&J(Error("invalid uncompressed block header: length verify")),i+o>t.length&&J(Error("input buffer is broken")),this.m){case y:for(;r+o>n.length;){if(o-=s=a-r,te)n.set(t.subarray(i,i+s),r),r+=s,i+=s;else for(;s--;)n[r++]=t[i++];this.b=r,n=this.f(),r=this.b}break;case x:for(;r+o>n.length;)n=this.f({v:2});break;default:J(Error("invalid inflate mode"))}if(te)n.set(t.subarray(i,i+o),r),r+=o,i+=o;else for(;o--;)n[r++]=t[i++];this.c=i,this.b=r,this.a=n;break;case 1:this.o(z,G);break;case 2:g=m=d=f=h=u=l=c=p=void 0;var c,l,u,h,p=this,_=function(e,t,i){for(var n,r,o,a=0;a<e;)switch(n=T(this,t)){case 16:for(o=3+b(this,2);o--;)i[a++]=r;break;case 17:for(o=3+b(this,3);o--;)i[a++]=0;r=0;break;case 18:for(o=11+b(this,7);o--;)i[a++]=0;r=0;break;default:r=i[a++]=n}return i},f=b(p,5)+257,d=b(p,5)+1,m=b(p,4)+4,g=new(te?Uint8Array:Array)(N.length);for(h=0;h<m;++h)g[N[h]]=b(p,3);c=v(g),l=new(te?Uint8Array:Array)(f),u=new(te?Uint8Array:Array)(d),p.o(v(_.call(p,f,c,l)),v(_.call(p,d,c,u)));break;default:J(Error("unknown BTYPE: "+e))}}return this.t()};for(var _=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],N=te?new Uint16Array(_):_,_=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],L=te?new Uint16Array(_):_,_=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],f=te?new Uint8Array(_):_,_=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],B=te?new Uint16Array(_):_,_=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],d=te?new Uint8Array(_):_,m=new(te?Uint8Array:Array)(288),g=0,F=m.length;g<F;++g)m[g]=g<=143?8:g<=255?9:g<=279?7:8;for(var z=v(m),S=new(te?Uint8Array:Array)(30),U=0,k=S.length;U<k;++U)S[U]=5;var G=v(S);function b(e,t){for(var i,n=e.g,r=e.e,o=e.input,a=e.c;r<t;)(i=o[a++])===$&&J(Error("input buffer is broken")),n|=i<<r,r+=8;return i=n&(1<<t)-1,e.g=n>>>t,e.e=r-t,e.c=a,i}function T(e,t){for(var i,n=e.g,r=e.e,o=e.input,a=e.c,s=t[0],c=t[1];r<c;)(i=o[a++])===$&&J(Error("input buffer is broken")),n|=i<<r,r+=8;return s=(t=s[n&(1<<c)-1])>>>16,e.g=n>>s,e.e=r-s,e.c=a,65535&t}function H(e,t){var i,n;this.input=e,this.c=0,t?(t.index&&(this.c=t.index),t.verify&&(this.M=t.verify)):t={},i=e[this.c++],n=e[this.c++],(15&i)===w?this.method=w:J(Error("unsupported compression method")),0!=((i<<8)+n)%31&&J(Error("invalid fcheck flag:"+((i<<8)+n)%31)),32&n&&J(Error("fdict flag is not supported")),this.A=new p(e,{index:this.c,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}p.prototype.o=function(e,t){var i=this.a,n=this.b;this.u=e;for(var r,o,a,s,c=i.length-258;256!==(r=T(this,e));)if(r<256)c<=n&&(this.b=n,i=this.f(),n=this.b),i[n++]=r;else for(s=L[o=r-257],0<f[o]&&(s+=b(this,f[o])),r=T(this,t),a=B[r],0<d[r]&&(a+=b(this,d[r])),c<=n&&(this.b=n,i=this.f(),n=this.b);s--;)i[n]=i[n++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},p.prototype.I=function(e,t){var i=this.a,n=this.b;this.u=e;for(var r,o,a,s,c=i.length;256!==(r=T(this,e));)if(r<256)c<=n&&(c=(i=this.f()).length),i[n++]=r;else for(s=L[o=r-257],0<f[o]&&(s+=b(this,f[o])),r=T(this,t),a=B[r],0<d[r]&&(a+=b(this,d[r])),c<n+s&&(c=(i=this.f()).length);s--;)i[n]=i[n++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},p.prototype.f=function(){var e,t,i=new(te?Uint8Array:Array)(this.b-32768),n=this.b-32768,r=this.a;if(te)i.set(r.subarray(32768,i.length));else for(e=0,t=i.length;e<t;++e)i[e]=r[e+32768];if(this.k.push(i),this.q+=i.length,te)r.set(r.subarray(n,32768+n));else for(e=0;e<32768;++e)r[e]=r[n+e];return this.b=32768,r},p.prototype.J=function(e){var t,i=this.input.length/this.c+1|0,n=this.input,r=this.a;return e&&("number"==typeof e.v&&(i=e.v),"number"==typeof e.F&&(i+=e.F)),n=i<2?(e=(n.length-this.c)/this.u[2]/2*258|0)<r.length?r.length+e:r.length<<1:r.length*i,te?(t=new Uint8Array(n)).set(r):t=r,this.a=t},p.prototype.t=function(){var e,t,i,n,r,o=0,a=this.a,s=this.k,c=new(te?Uint8Array:Array)(this.q+(this.b-32768));if(0===s.length)return te?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(t=0,i=s.length;t<i;++t)for(n=0,r=(e=s[t]).length;n<r;++n)c[o++]=e[n];for(t=32768,i=this.b;t<i;++t)c[o++]=a[t];return this.k=[],this.buffer=c},p.prototype.H=function(){var e,t=this.b;return te?this.B?(e=new Uint8Array(t)).set(this.a.subarray(0,t)):e=this.a.subarray(0,t):(this.a.length>t&&(this.a.length=t),e=this.a),this.buffer=e},H.prototype.p=function(){var e=this.input,t=this.A.p();return this.c=this.A.c,this.M&&(e[this.c++]<<24|e[this.c++]<<16|e[this.c++]<<8|e[this.c++])>>>0!==P(t)&&J(Error("invalid adler-32 checksum")),t},e("Zlib.Inflate",H),e("Zlib.Inflate.BufferType",r),r.ADAPTIVE=r.C,r.BLOCK=r.D,e("Zlib.Inflate.prototype.decompress",H.prototype.p);for(var V=new(te?Uint8Array:Array)(288),C=0,j=V.length;C<j;++C)V[C]=C<=143?8:C<=255?9:C<=279?7:8;v(V);for(var W=new(te?Uint8Array:Array)(30),q=0,X=W.length;q<X;++q)W[q]=5;v(W);var w=8}.call(bee),bee.Zlib);Tee.Deflate=Tee.Deflate,Tee.Deflate.compress=Tee.Deflate.compress,Tee.Inflate=Tee.Inflate,Tee.Inflate.BufferType=Tee.Inflate.BufferType,Tee.Inflate.prototype.decompress=Tee.Inflate.prototype.decompress;(Cee=Mee.prototype).read=function(e){for(var t=0,i=[],t=0;0<=e?t<e:e<t;0<=e?++t:--t)i.push(this.data[this.pos++]);return i},Cee.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},Cee.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},Cee.decodePixels=function(e){if(0===(e=null==e?this.imgData:e).length)return new Uint8Array(0);e=new Tee.Inflate(e,{index:0,verify:!1}).decompress();for(var t,i,n,r=this.pixelBitlength/8,o=r*this.width,a=new Uint8Array(o*this.height),s=e.length,c=0,l=0,u=0,h=0,p=0,_=0,f=0,d=0,m=0,g=0,v=0,y=0,x=0,S=0;l<s;){switch(e[l++]){case 0:for(_=f=0;f<o;_=f+=1)a[u++]=e[l++];break;case 1:for(_=d=0;d<o;_=d+=1)h=e[l++],y=_<r?0:a[u-r],a[u++]=(h+y)%256;break;case 2:for(_=m=0;m<o;_=m+=1)h=e[l++],p=(_-_%r)/r,x=c&&a[(c-1)*o+p*r+_%r],a[u++]=(x+h)%256;break;case 3:for(_=g=0;g<o;_=g+=1)h=e[l++],p=(_-_%r)/r,y=_<r?0:a[u-r],x=c&&a[(c-1)*o+p*r+_%r],a[u++]=(h+Math.floor((y+x)/2))%256;break;case 4:for(_=v=0;v<o;_=v+=1)h=e[l++],p=(_-_%r)/r,y=_<r?0:a[u-r],0===c?x=S=0:(x=a[(c-1)*o+p*r+_%r],S=p&&a[(c-1)*o+(p-1)*r+_%r]),n=y+x-S,t=Math.abs(n-y),i=Math.abs(n-x),n=Math.abs(n-S),a[u++]=(h+(t<=i&&t<=n?y:i<=n?x:S))%256;break;default:throw new Error(oe(6018,e[l-1]))}c++}return a},Cee.copyToImageData=function(e,t){var i,n,r=this.hasAlphaChannel,o=this.colors,a=(this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),o=4,r=!0),e.data||e),s=a.length,c=i||t,l=0,u=0,h=0;if(1===o)for(;l<s;)h=i?4*t[l/4]:u,n=c[h++],a[l++]=n,a[l++]=n,a[l++]=n,a[l++]=r?c[h++]:255,u=h;else for(;l<s;)h=i?4*t[l/4]:u,a[l++]=c[h++],a[l++]=c[h++],a[l++]=c[h++],a[l++]=r?c[h++]:255,u=h},Cee.decodePalette=function(){for(var e,t=this.palette,i=this.transparency.indexed||[],n=new Uint8Array((i.length||0)+t.length),r=0,o=0,a=0,s=0,c=t.length;s<c;a=s+=3)n[r++]=t[a],n[r++]=t[a+1],n[r++]=t[a+2],e=i[o++],n[r++]=null!=e?e:255;return n},Cee.render=function(e){e.width=this.width,e.height=this.height;var e=e.getContext("2d"),t=e.createImageData(this.width,this.height);return this.copyToImageData(t,this.decodePixels(null)),e.putImageData(t,0,0)};for(var Eee,Cee,wee=Mee,Aee=((Eee=Oee.prototype).getUint8=function(e){return this._tiffData[e]},Eee.getUint16=function(e){return this._littleEndian?this._tiffData[e+1]<<8|this._tiffData[e]:this._tiffData[e]<<8|this._tiffData[e+1]},Eee.getUint32=function(e){var t=this._tiffData;return this._littleEndian?t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]:t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]},Eee.checkLittleEndian=function(){var e=this.getUint16(0);if(18761===e)this._littleEndian=!0;else{if(19789!==e)throw console.log(e),TypeError(oe(6019));this._littleEndian=!1}return this._littleEndian},Eee.hasTowel=function(){if(42!==this.getUint16(2))throw RangeError(oe(6020));return!0},Eee.getFieldTypeName=function(e){return e in Iee?Iee[e]:null},Eee.getFieldTagName=function(e){return e in Pee?Pee[e]:(ne(6021,e),"Tag"+e)},Eee.getFieldTypeLength=function(e){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(e)?1:-1!==["SHORT","SSHORT"].indexOf(e)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(e)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(e)?8:0},Eee.getFieldValues=function(e,t,i,n){var r=[],o=this.getFieldTypeLength(t);if(o*i<=4)!1===this._littleEndian?r.push(n>>>8*(4-o)):r.push(n);else for(var a=0;a<i;a++){var s=o*a;8<=o?-1!==["RATIONAL","SRATIONAL"].indexOf(t)?(r.push(this.getUint32(n+s)),r.push(this.getUint32(n+s+4))):ne(8e3):r.push(this.getBytes(o,n+s))}return"ASCII"===t&&r.forEach(function(e,t,i){i[t]=String.fromCharCode(e)}),r},Eee.getBytes=function(e,t){if(e<=0)ne(8001);else{if(e<=1)return this.getUint8(t);if(e<=2)return this.getUint16(t);if(e<=3)return this.getUint32(t)>>>8;if(e<=4)return this.getUint32(t);ne(8002)}return 0},Eee.getBits=function(e,t,i){i=i||0;var t=t+Math.floor(i/8),n=i+e,e=32-e,r=0,o=0;return n<=0?ne(6023):n<=8?(r=24+i,o=this.getUint8(t)):n<=16?(r=16+i,o=this.getUint16(t)):n<=32?(r=i,o=this.getUint32(t)):ne(6022),{bits:o<<r>>>e,byteOffset:t+Math.floor(n/8),bitOffset:n%8}},Eee.parseFileDirectory=function(e){for(var t=this.getUint16(e),i=[],n=0,r=0,n=e+2,r=0;r<t;n+=12,r++){var o=this.getUint16(n),a=this.getUint16(n+2),s=this.getUint32(n+4),c=this.getUint32(n+8),o=this.getFieldTagName(o),a=this.getFieldTypeName(a),s=this.getFieldValues(o,a,s,c);i[o]={type:a,values:s}}this._fileDirectories.push(i);e=this.getUint32(n);0!==e&&this.parseFileDirectory(e)},Eee.clampColorSample=function(e,t){t=Math.pow(2,8-t);return Math.floor(e*t+(t-1))},Eee.parseTIFF=function(e,t){var i=this;if(t=t||document.createElement("canvas"),this._tiffData=e,this._canvas=t,this.checkLittleEndian(),this.hasTowel()){var e=this.getUint32(4),e=(this._fileDirectories.length=0,this.parseFileDirectory(e),this._fileDirectories[0]),n=e.ImageWidth.values[0],r=e.ImageLength.values[0],o=(this._canvas.width=n,this._canvas.height=r,[]),B=e.Compression?e.Compression.values[0]:1,F=e.SamplesPerPixel.values[0],a=[],s=0,z=!1,U=(e.BitsPerSample.values.forEach(function(e,t){a[t]={bitsPerSample:e,hasBytesPerSample:!1,bytesPerSample:void 0},e%8==0&&(a[t].hasBytesPerSample=!0,a[t].bytesPerSample=e/8),s+=e},this),0);s%8==0&&(z=!0,U=s/8);var c,k=e.StripOffsets.values,G=k.length;if(e.StripByteCounts)c=e.StripByteCounts.values;else{if(ne(8003),1!==G)throw Error(oe(6024));c=[Math.ceil(n*r*s/8)]}for(var H=1,V=1,l=0;l<G;l++){var u=k[l];o[l]=[];for(var j=c[l],h=0,W=0,p=1,_=!0,f=[],d=0,m=0,g=0;h<j;h+=p)switch(B){case 1:for(var f=[],v=0;v<F;v++){var y=a[v];if(!y.hasBytesPerSample)throw x=this.getBits(y.bitsPerSample,u+h,W),f.push(x.bits),h=x.byteOffset-u,W=x.bitOffset,RangeError(oe(6025));var x=y.bytesPerSample*v;f.push(this.getBytes(y.bytesPerSample,u+h+x))}if(o[l].push(f),!z)throw p=0,RangeError(oe(6026));p=U;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(_){var _=!1,S=this.getUint8(u+h);0<=S&&S<=127?H=S+1:-127<=S&&S<=-1?V=1-S:_=!0}else{for(var q=this.getUint8(u+h),X=0;X<V;X++){var Y=a[m];if(!Y.hasBytesPerSample)throw RangeError(oe(6025));g=g<<8*d|q,++d===Y.bytesPerSample&&(f.push(g),g=d=0,m++),m===F&&(o[l].push(f),f=[],m=0)}0==--H&&(_=!0)}p=1}}if(t.getContext){var b=this._canvas.getContext("2d"),t=(b.fillStyle="rgba(255, 255, 255, 0)",e.RowsPerStrip?e.RowsPerStrip.values[0]:r),K=o.length,r=r%t,Q=0==r?t:r,T=t,Z=0,J=e.PhotometricInterpretation.values[0],E=[],C=0,w=(e.ExtraSamples&&(C=(E=e.ExtraSamples.values).length),[]),A=0;e.ColorMap&&(w=e.ColorMap.values,A=Math.pow(2,a[0].bitsPerSample));for(var P=0;P<K;P++){P+1===K&&(T=Q);for(var $=o[P].length,ee=Z*P,I=0,R=0;I<T&&R<$;I++)for(var te=0;te<n;te++,R++){var D=o[P][R],O=0,M=0,N=0,ie=1;if(0<C)for(var L=0;L<C;L++)if(1===E[L]||2===E[L]){ie=D[3+L]/256;break}!function(){switch(J){case 0:var n=0;a[0].hasBytesPerSample&&(n=Math.pow(16,2*a[0].bytesPerSample)),D.forEach(function(e,t,i){i[t]=n-e});case 1:O=M=N=i.clampColorSample(D[0],a[0].bitsPerSample);break;case 2:O=i.clampColorSample(D[0],a[0].bitsPerSample),M=i.clampColorSample(D[1],a[1].bitsPerSample),N=i.clampColorSample(D[2],a[2].bitsPerSample);break;case 3:if(void 0===w)throw Error(oe(6027));var e=D[0];O=i.clampColorSample(w[e],16),M=i.clampColorSample(w[A+e],16),N=i.clampColorSample(w[2*A+e],16);break;default:throw RangeError(oe(6028,J))}}(),b.fillStyle="rgba("+O+", "+M+", "+N+", "+ie+")",b.fillRect(te,ee+I,1,1)}Z=T}}return this._canvas}},Oee),Pee={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},Iee={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},Ree=new Array(123),Dee=0;Dee<123;++Dee)Ree[Dee]=64;function Oee(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}function Mee(e){var t=this;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=e,this.transparency={indexed:[],rgb:0,grayscale:0};for(var i=0,n=0,r=0;;){var r=this.readUInt32(),o=function(){var e=[];for(i=0;i<4;++i)e.push(String.fromCharCode(t.data[t.pos++]));return e}.call(this).join("");switch(o){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(r);break;case"fcTL":a&&this.animation.frames.push(a),this.pos+=4;var a={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},s=this.readUInt16(),c=this.readUInt16()||100;a.delay=1e3*s/c,a.disposeOp=this.data[this.pos++],a.blendOp=this.data[this.pos++],a.data=[];break;case"IDAT":case"fdAT":for("fdAT"===o&&(this.pos+=4,r-=4),e=(null!=a?a.data:void 0)||this.imgData,i=0;0<=r?i<r:r<i;0<=r?++i:--i)e.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(r);var l=255-this.transparency.indexed.length;if(0<l)for(n=0;0<=l?n<l:l<n;0<=l?++n:--n)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(r)[0];break;case 2:this.transparency.rgb=this.read(r)}break;case"tEXt":var s=this.read(r),c=s.indexOf(0),u=String.fromCharCode.apply(String,s.slice(0,c));this.text[u]=String.fromCharCode.apply(String,s.slice(c+1));break;case"IEND":a&&this.animation.frames.push(a),this.colors=function(){switch(t.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this);var u=this.colorType,h=(this.hasAlphaChannel=4===u||6===u,this.colors+(this.hasAlphaChannel?1:0));return this.pixelBitlength=this.bits*h,this.colorSpace=function(){switch(t.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=r}if(this.pos+=4,this.pos>this.data.length)throw new Error(oe(6017))}}for(var Nee=0;Nee<64;++Nee)Ree["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Nee)]=Nee;function Lee(e){this.data=e,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(Lee.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0}var Bee={name:"Jacob__Codec__Base64",decode:function(e){var t,i,n,r,o,a=[],s=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");s<e.length;)t=Ree[e.charCodeAt(s++)]<<2|(r=Ree[e.charCodeAt(s++)])>>4,i=(15&r)<<4|(r=Ree[e.charCodeAt(s++)])>>2,n=(3&r)<<6|(o=Ree[e.charCodeAt(s++)]),a.push(String.fromCharCode(t)),64!==r&&a.push(String.fromCharCode(i)),64!==o&&a.push(String.fromCharCode(n));return a.join("")},decodeAsArray:function(e,t){for(var i,n=this.decode(e),r=[],o=0,a=n.length/t;o<a;o++)for(r[o]=0,i=t-1;0<=i;--i)r[o]+=n.charCodeAt(o*t+i)<<8*i;return r}};Lee.gunzip=function(e){return e.constructor!==Array&&e.constructor,new Lee(e).gunzip()[0][0]},Lee.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},Lee.LITERALS=288,Lee.NAMEMAX=256,Lee.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],Lee.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Lee.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],Lee.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Lee.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Lee.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Lee.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},Lee.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},Lee.prototype.byteAlign=function(){this.bb=1},Lee.prototype.readBit=function(){var e;return this.bits++,e=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),e=1&this.bb,this.bb=this.bb>>1|128),e},Lee.prototype.readBits=function(e){for(var t=0,i=e;i--;)t=t<<1|this.readBit();return t=e?Lee.bitReverse[t]>>8-e:t},Lee.prototype.flushBuffer=function(){this.bIdx=0},Lee.prototype.addBuffer=function(e){this.buf32k[this.bIdx++]=e,this.outputArr.push(String.fromCharCode(e)),32768===this.bIdx&&(this.bIdx=0)},Lee.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},Lee.prototype.Rec=function(){var e,t=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,0<=(e=this.IsPat()))t.b0=e;else if(t.b0=32768,this.Rec())return-1;if(0<=(e=this.IsPat()))t.b1=e,t.jump=null;else if(t.b1=32768,t.jump=this.Places[this.treepos],t.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},Lee.prototype.CreateTree=function(e,t,i){var n;for(this.Places=e,this.treepos=0,this.flens=i,this.fmax=t,n=0;n<17;n++)this.fpos[n]=0;return this.len=0,this.Rec()?-1:0},Lee.prototype.DecodeValue=function(e){for(var t,i,n=0,r=e[n];;)if(this.readBit()){if(!(32768&r.b1))return r.b1;for(r=r.jump,t=e.length,i=0;i<t;i++)if(e[i]===r){n=i;break}}else{if(!(32768&r.b0))return r.b0;r=e[++n]}return-1},Lee.prototype.DeflateLoop=function(){var e;do{var t,i=this.readBit();if(0===(e=this.readBits(2)))for(this.byteAlign(),t=this.readByte(),t|=this.readByte()<<8,c=this.readByte(),65535&(t^~(c|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");t--;)n=this.readByte(),this.addBuffer(n);else if(1===e)for(;;)if(23<(u=Lee.bitReverse[this.readBits(7)]>>1)?199<(u=u<<1|this.readBit())?u=(u-=128)<<1|this.readBit():143<(u-=48)&&(u+=136):u+=256,u<256)this.addBuffer(u);else{if(256===u)break;for(u-=257,h=this.readBits(Lee.cplext[u])+Lee.cplens[u],u=Lee.bitReverse[this.readBits(5)]>>3,8<Lee.cpdext[u]?(p=this.readBits(8),p|=this.readBits(Lee.cpdext[u]-8)<<8):p=this.readBits(Lee.cpdext[u]),p+=Lee.cpdist[u],u=0;u<h;u++){var n=this.buf32k[this.bIdx-p&32767];this.addBuffer(n)}}else if(2===e){for(var r,o,a=new Array(320),s=257+this.readBits(5),c=1+this.readBits(5),l=4+this.readBits(4),u=0;u<19;u++)a[u]=0;for(u=0;u<l;u++)a[Lee.border[u]]=this.readBits(3);for(h=this.distanceTree.length,f=0;f<h;f++)this.distanceTree[f]=new Lee.HufNode;if(this.CreateTree(this.distanceTree,19,a,0))return this.flushBuffer(),1;for(r=s+c,f=0;f<r;)if((u=this.DecodeValue(this.distanceTree))<16)a[f++]=u;else if(16===u){if(f+(u=3+this.readBits(2))>r)return this.flushBuffer(),1;for(o=f?a[f-1]:0;u--;)a[f++]=o}else{if(f+(u=17===u?3+this.readBits(3):11+this.readBits(7))>r)return this.flushBuffer(),1;for(;u--;)a[f++]=0}for(h=this.literalTree.length,f=0;f<h;f++)this.literalTree[f]=new Lee.HufNode;if(this.CreateTree(this.literalTree,s,a,0))return this.flushBuffer(),1;for(h=this.literalTree.length,f=0;f<h;f++)this.distanceTree[f]=new Lee.HufNode;for(var h,p,_=new Array,f=s;f<a.length;f++)_[f-s]=a[f];if(this.CreateTree(this.distanceTree,c,_,0))return this.flushBuffer(),1;for(;;)if(256<=(u=this.DecodeValue(this.literalTree))){if(0==(u-=256))break;for(u--,h=this.readBits(Lee.cplext[u])+Lee.cplens[u],u=this.DecodeValue(this.distanceTree),8<Lee.cpdext[u]?(p=this.readBits(8),p|=this.readBits(Lee.cpdext[u]-8)<<8):p=this.readBits(Lee.cpdext[u]),p+=Lee.cpdist[u];h--;)n=this.buf32k[this.bIdx-p&32767],this.addBuffer(n)}else this.addBuffer(u)}}while(!i);return this.flushBuffer(),this.byteAlign(),0},Lee.prototype.unzipFile=function(e){var t;for(this.gunzip(),t=0;t<this.unzipped.length;t++)if(this.unzipped[t][1]===e)return this.unzipped[t][0]},Lee.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var e=[];if(e[0]=this.readByte(),e[1]=this.readByte(),120===e[0]&&218===e[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===e[0]&&139===e[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===e[0]&&75===e[1]&&(this.modeZIP=!0,e[2]=this.readByte(),e[3]=this.readByte(),3===e[2]&&4===e[3])){e[0]=this.readByte(),e[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte(),t=(e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),i=(t|=this.readByte()<<8,this.readByte());for(i|=this.readByte()<<8,r=0,this.nameBuf=[];t--;){var n=this.readByte();"/"===n|":"===n?r=0:r<Lee.NAMEMAX-1&&(this.nameBuf[r++]=String.fromCharCode(n))}this.fileout||(this.fileout=this.nameBuf);for(var r=0;r<i;)n=this.readByte(),r++;8==e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},Lee.prototype.skipdir=function(){var e,t,i=[];if(8&this.gpflags&&(i[0]=this.readByte(),i[1]=this.readByte(),i[2]=this.readByte(),i[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),i[0]=this.readByte(),8!==i[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(i[0]=this.readByte(),i[2]=this.readByte(),this.len=i[0]+256*i[1],e=0;e<this.len;e++)this.readByte();if(8&this.gpflags)for(e=0,this.nameBuf=[];t=this.readByte();)(e="7"!==t&&":"!==t?e:0)<Lee.NAMEMAX-1&&(this.nameBuf[e++]=t);if(16&this.gpflags)for(;t=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var Fee,zee,Uee,kee,Gee,Hee,Vee,jee,Wee,qee,Xee,Yee,Kee,Qee,Zee,Jee,$ee,ete,tte,ite,nte,rte,ote,ate,ste,cte,lte,ute,hte,pte,I,_te,fte,dte,mte,gte,vte,yte,xte,Ste,bte,Tte,Ete,Cte,wte,Ate,Pte,Ite,Rte,Dte,Ote,Mte,Nte,Lte,Bte,Fte,zte,Ute,kte,Gte,Hte,Vte,jte,Wte,qte,Xte,Yte,Kte,Qte,Zte,Jte,$te,eie,tie,iie,nie,rie={name:"Jacob__Codec"};function oie(e){var t=e.parent,i=e.getComponent(gie);return t&&i?oie(t):e.getComponentsInChildren(gie)}rie.Base64=Bee,rie.GZip=Lee,rie.unzip=function(){return rie.GZip.gunzip.apply(rie.GZip,arguments)},rie.unzipBase64=function(){var t=rie.Base64.decode.apply(rie.Base64,arguments);try{return rie.GZip.gunzip.call(rie.GZip,t)}catch(e){return t.slice(7)}},rie.unzipBase64AsArray=function(e,t){t=t||1;for(var i,n=this.unzipBase64(e),r=[],o=0,a=n.length/t;o<a;o++)for(r[o]=0,i=t-1;0<=i;--i)r[o]+=n.charCodeAt(o*t+i)<<8*i;return r},rie.unzipAsArray=function(e,t){t=t||1;for(var i,n=this.unzip(e),r=[],o=0,a=n.length/t;o<a;o++)for(r[o]=0,i=t-1;0<=i;--i)r[o]+=n.charCodeAt(o*t+i)<<8*i;return r},(nie=iie=iie||{})[nie.JPG=0]="JPG",nie[nie.PNG=1]="PNG",nie[nie.TIFF=2]="TIFF",nie[nie.WEBP=3]="WEBP",nie[nie.PVR=4]="PVR",nie[nie.ETC=5]="ETC",nie[nie.S3TC=6]="S3TC",nie[nie.ATITC=7]="ATITC",nie[nie.TGA=8]="TGA",nie[nie.RAWDATA=9]="RAWDATA",nie[nie.UNKNOWN=10]="UNKNOWN";var aie,sie,cie,lie,uie,hie,pie,_ie,fie,die,mie,gie=Rre("ParticleSystem2D",(Fee=f("cc.ParticleSystem2D"),zee=Ep(),XN=u(),Uee=v(vee),kee=u(),Gee=v(lF),bp=u(),Hee=u(),Vee=u(),jee=u(),r=u(),Wee=u(),qee=u(),ll=u(),Xee=Pp(),Yee=u(),Kee=u(),rl=u(),Qee=u(),Zee=u(),Jee=u(),$ee=u(),ete=u(),tte=u(),_l=u(),ite=u(),nte=u(),rte=u(),Bc=v(lee),ote=u(),ate=u(),ba=v(cee),ste=u(),cte=u(),ls=u(),YD=u(),lte=u(),ute=u(),hte=u(),w=u(),zp=u(),Np=u(),Cp=u(),c=u(),Aw=u(),t=u(),kw=u(),pF=u(),pte=u(),I=yp("preview"),Fee(xH=zee(xH=_s(xH=Tp((l(Eie,mie=h4),(P=Eie.prototype).onEnable=function(){mie.prototype.onEnable.call(this),this._updateMaterial()},P.onDestroy=function(){mie.prototype.onDestroy.call(this),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)},P.initProperties=function(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new gee(this)},P.onFocusInEditor=function(){this._focused=!0;for(var e=oie(this.node),t=0;t<e.length;++t)e[t]._startPreview()},P.onLostFocusInEditor=function(){this._focused=!1;for(var e=oie(this.node),t=0;t<e.length;++t)e[t]._stopPreview()},P._startPreview=function(){this._preview&&this.resetSystem()},P._stopPreview=function(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)},P.__preload=function(){mie.prototype.__preload.call(this),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():!this._file||this._custom&&this._getTexture()||this._applyFile(),this.playOnLoad&&this.resetSystem()},P._flushAssembler=function(){var e=Eie.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))},P.lateUpdate=function(e){this._simulator.finished||this._simulator.step(e)},P.addParticle=function(){},P.stopSystem=function(){this._stopped=!0,this._simulator.stop()},P.resetSystem=function(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()},P.isFull=function(){return this.particleCount>=this.totalParticles},P._applyFile=function(){var e=this._file;e&&this.isValid&&(this._plistFile=e.nativeUrl,this._custom||(this._spriteFrame!==e.spriteFrame&&(this.spriteFrame=e.spriteFrame),this._initWithDictionary(e._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():e.spriteFrame?this.spriteFrame=e.spriteFrame:this._custom&&this._initTextureWithDictionary(e._nativeAsset))},P._initTextureWithDictionary=function(i){var n=this;if(i.spriteFrameUuid){var e=i.spriteFrameUuid;FR.loadAny(e,function(e,t){e?(i.spriteFrameUuid=void 0,n._initTextureWithDictionary(i),tt(e)):n.spriteFrame=t})}else{e=cn(this._plistFile,i.textureFileName||"");if(i.textureFileName)FR.loadRemote(e,function(e,t){e?(i.textureFileName=void 0,n._initTextureWithDictionary(i),tt(e)):n.spriteFrame=t?lF.createWithImage(t):lF.createWithImage(D0.get("white-texture"))});else if(i.textureImageData){var t=i.textureImageData;if(!(t&&0<t.length))return!1;var r=FR.assets.get(e);if(!r){t=rie.unzipBase64AsArray(t,1);if(!t)return J(6030,this._file.name),!1;var o=8<t.length&&137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]?iie.PNG:2<t.length&&(73===t[0]&&73===t[1]||77===t[0]&&77===t[1]||255===t[0]&&216===t[1])?iie.TIFF:iie.UNKNOWN;if(o!==iie.TIFF&&o!==iie.PNG)return J(6031,this._file.name),!1;var a=document.createElement("canvas");o===iie.PNG?new wee(t).render(a):(this._tiffReader||(this._tiffReader=new Aee),this._tiffReader.parseTIFF(t,a)),r=new Lv(a),FR.assets.add(e,r)}r||J(6032,this._file.name),this.spriteFrame=r?lF.createWithImage(r):lF.createWithImage(D0.get("white-texture"))}}return!0},P._initWithDictionary=function(e){this.totalParticles=parseInt(e.maxParticles||0),this.life=parseFloat(e.particleLifespan||0),this.lifeVar=parseFloat(e.particleLifespanVariance||0);var t=e.emissionRate,t=(this.emissionRate=t||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(e.duration||0),this._srcBlendFactor=parseInt(e.blendFuncSource||jo.SRC_ALPHA),this._dstBlendFactor=parseInt(e.blendFuncDestination||jo.ONE_MINUS_SRC_ALPHA),this._startColor),t=(t.r=255*parseFloat(e.startColorRed||0),t.g=255*parseFloat(e.startColorGreen||0),t.b=255*parseFloat(e.startColorBlue||0),t.a=255*parseFloat(e.startColorAlpha||0),this._startColorVar),t=(t.r=255*parseFloat(e.startColorVarianceRed||0),t.g=255*parseFloat(e.startColorVarianceGreen||0),t.b=255*parseFloat(e.startColorVarianceBlue||0),t.a=255*parseFloat(e.startColorVarianceAlpha||0),this._endColor),t=(t.r=255*parseFloat(e.finishColorRed||0),t.g=255*parseFloat(e.finishColorGreen||0),t.b=255*parseFloat(e.finishColorBlue||0),t.a=255*parseFloat(e.finishColorAlpha||0),this._endColorVar);if(t.r=255*parseFloat(e.finishColorVarianceRed||0),t.g=255*parseFloat(e.finishColorVarianceGreen||0),t.b=255*parseFloat(e.finishColorVarianceBlue||0),t.a=255*parseFloat(e.finishColorVarianceAlpha||0),this.startSize=parseFloat(e.startParticleSize||0),this.startSizeVar=parseFloat(e.startParticleSizeVariance||0),this.endSize=parseFloat(e.finishParticleSize||0),this.endSizeVar=parseFloat(e.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==e.positionType?e.positionType:lee.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(e.sourcePositionVariancex||0),parseFloat(e.sourcePositionVariancey||0)),this.angle=parseFloat(e.angle||0),this.angleVar=parseFloat(e.angleVariance||0),this.startSpin=parseFloat(e.rotationStart||0),this.startSpinVar=parseFloat(e.rotationStartVariance||0),this.endSpin=parseFloat(e.rotationEnd||0),this.endSpinVar=parseFloat(e.rotationEndVariance||0),this.emitterMode=parseInt(e.emitterType||cee.GRAVITY),this.emitterMode===cee.GRAVITY){this.gravity.set(parseFloat(e.gravityx||0),parseFloat(e.gravityy||0)),this.speed=parseFloat(e.speed||0),this.speedVar=parseFloat(e.speedVariance||0),this.radialAccel=parseFloat(e.radialAcceleration||0),this.radialAccelVar=parseFloat(e.radialAccelVariance||0),this.tangentialAccel=parseFloat(e.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(e.tangentialAccelVariance||0);t=e.rotationIsDir||"";null!==t?(t=t.toString().toLowerCase(),this.rotationIsDir="true"===t||"1"===t):this.rotationIsDir=!1}else{if(this.emitterMode!==cee.RADIUS)return J(6009),!1;this.startRadius=parseFloat(e.maxRadius||0),this.startRadiusVar=parseFloat(e.maxRadiusVariance||0),this.endRadius=parseFloat(e.minRadius||0),this.endRadiusVar=parseFloat(e.minRadiusVariance||0),this.rotatePerS=parseFloat(e.rotatePerSecond||0),this.rotatePerSVar=parseFloat(e.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(e),!0},P._syncAspect=function(){var e;this._renderSpriteFrame&&(e=this._renderSpriteFrame.rect,this.aspectRatio=e.width/e.height)},P._applySpriteFrame=function(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()},P._getTexture=function(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture},P._updateMaterial=function(){var e=this.getMaterialInstance(0);e&&e.recompileShaders({USE_LOCAL:this._positionType!==lee.FREE})},P._finishedSimulation=function(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()},P._canRender=function(){return mie.prototype._canRender.call(this)&&!this._stopped&&null!==this._renderSpriteFrame},P._render=function(e){this._positionType===lee.RELATIVE?e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===lee.GROUPED?e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)},e(Eie,[{key:"custom",get:function(){return this._custom},set:function(e){this._custom!==e&&(this._custom=e,this._applyFile())}},{key:"file",get:function(){return this._file},set:function(e){this._file!==e&&((this._file=e)?this._applyFile():this.custom=!0)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._renderSpriteFrame!==e&&((this._renderSpriteFrame=e)&&!e._uuid||(this._spriteFrame=e),this._applySpriteFrame())}},{key:"particleCount",get:function(){return this._simulator.particles.length}},{key:"totalParticles",get:function(){return this._totalParticles},set:function(e){this._totalParticles!==e&&(this._totalParticles=e)}},{key:"startColor",get:function(){return this._startColor},set:function(e){this._startColor.r=e.r,this._startColor.g=e.g,this._startColor.b=e.b,this._startColor.a=e.a}},{key:"startColorVar",get:function(){return this._startColorVar},set:function(e){this._startColorVar.r=e.r,this._startColorVar.g=e.g,this._startColorVar.b=e.b,this._startColorVar.a=e.a}},{key:"color",get:function(){return this._color},set:function(){}},{key:"endColor",get:function(){return this._endColor},set:function(e){this._endColor.r=e.r,this._endColor.g=e.g,this._endColor.b=e.b,this._endColor.a=e.a}},{key:"endColorVar",get:function(){return this._endColorVar},set:function(e){this._endColorVar.r=e.r,this._endColorVar.g=e.g,this._endColorVar.b=e.b,this._endColorVar.a=e.a}},{key:"positionType",get:function(){return this._positionType},set:function(e){this._positionType=e,this._updateMaterial()}},{key:"preview",get:function(){return this._preview},set:function(e){e?this._startPreview():this._stopPreview(),this._preview=e}},{key:"stopped",get:function(){return this._stopped}},{key:"active",get:function(){return this._simulator.active}},{key:"assembler",get:function(){return this._assembler}}]),Qp=pi=Eie,pi.EmitterMode=cee,pi.PositionType=lee,pi.DURATION_INFINITY=-1,pi.START_SIZE_EQUAL_TO_END_SIZE=-1,pi.START_RADIUS_EQUAL_TO_END_RADIUS=-1,i((C=Qp).prototype,"custom",[Ap,XN],Object.getOwnPropertyDescriptor(C.prototype,"custom"),C.prototype),i(C.prototype,"file",[Uee,kee],Object.getOwnPropertyDescriptor(C.prototype,"file"),C.prototype),i(C.prototype,"spriteFrame",[Gee,bp],Object.getOwnPropertyDescriptor(C.prototype,"spriteFrame"),C.prototype),i(C.prototype,"totalParticles",[Ap,Hee],Object.getOwnPropertyDescriptor(C.prototype,"totalParticles"),C.prototype),_te=i(C.prototype,"duration",[d,Ap,Vee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),fte=i(C.prototype,"emissionRate",[d,Ap,jee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),dte=i(C.prototype,"life",[d,Ap,r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mte=i(C.prototype,"lifeVar",[d,Ap,Wee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(C.prototype,"startColor",[Ap,qee],Object.getOwnPropertyDescriptor(C.prototype,"startColor"),C.prototype),i(C.prototype,"startColorVar",[Ap,ll],Object.getOwnPropertyDescriptor(C.prototype,"startColorVar"),C.prototype),i(C.prototype,"color",[Xee],Object.getOwnPropertyDescriptor(C.prototype,"color"),C.prototype),i(C.prototype,"endColor",[Ap,Yee],Object.getOwnPropertyDescriptor(C.prototype,"endColor"),C.prototype),i(C.prototype,"endColorVar",[Ap,Kee],Object.getOwnPropertyDescriptor(C.prototype,"endColorVar"),C.prototype),gte=i(C.prototype,"angle",[d,Ap,rl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),vte=i(C.prototype,"angleVar",[d,Ap,Qee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),yte=i(C.prototype,"startSize",[d,Ap,Zee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),xte=i(C.prototype,"startSizeVar",[d,Ap,Jee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ste=i(C.prototype,"endSize",[d,Ap,$ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bte=i(C.prototype,"endSizeVar",[d,Ap,ete],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tte=i(C.prototype,"startSpin",[d,Ap,tte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ete=i(C.prototype,"startSpinVar",[d,Ap,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cte=i(C.prototype,"endSpin",[d,Ap,ite],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wte=i(C.prototype,"endSpinVar",[d,Ap,nte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ate=i(C.prototype,"sourcePos",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U.ZERO.clone()}}),Pte=i(C.prototype,"posVar",[d,Ap,rte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U.ZERO.clone()}}),i(C.prototype,"positionType",[Bc,ote],Object.getOwnPropertyDescriptor(C.prototype,"positionType"),C.prototype),i(C.prototype,"preview",[Ap,ate],Object.getOwnPropertyDescriptor(C.prototype,"preview"),C.prototype),Ite=i(C.prototype,"emitterMode",[d,Ap,ba,ste],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cee.GRAVITY}}),Rte=i(C.prototype,"gravity",[d,Ap,cte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return U.ZERO.clone()}}),Dte=i(C.prototype,"speed",[d,Ap,ls],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),Ote=i(C.prototype,"speedVar",[d,Ap,YD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),Mte=i(C.prototype,"tangentialAccel",[d,Ap,lte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),Nte=i(C.prototype,"tangentialAccelVar",[d,Ap,ute],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lte=i(C.prototype,"radialAccel",[d,Ap,hte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bte=i(C.prototype,"radialAccelVar",[d,Ap,w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fte=i(C.prototype,"rotationIsDir",[d,Ap,zp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zte=i(C.prototype,"startRadius",[d,Ap,Np],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ute=i(C.prototype,"startRadiusVar",[d,Ap,Cp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kte=i(C.prototype,"endRadius",[d,Ap,c],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gte=i(C.prototype,"endRadiusVar",[d,Ap,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hte=i(C.prototype,"rotatePerS",[d,Ap,t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vte=i(C.prototype,"rotatePerSVar",[d,Ap,kw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jte=i(C.prototype,"playOnLoad",[d,Ap,pF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Wte=i(C.prototype,"autoRemoveOnFinish",[d,Ap,pte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qte=i(C.prototype,"_preview",[I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xte=i(C.prototype,"_custom",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yte=i(C.prototype,"_file",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kte=i(C.prototype,"_spriteFrame",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qte=i(C.prototype,"_totalParticles",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),Zte=i(C.prototype,"_startColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(255,255,255,255)}}),Jte=i(C.prototype,"_startColorVar",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(0,0,0,0)}}),$te=i(C.prototype,"_endColor",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(255,255,255,0)}}),eie=i(C.prototype,"_endColorVar",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nr(0,0,0,0)}}),tie=i(C.prototype,"_positionType",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lee.FREE}}),xH=C))||xH)||xH)||xH)||xH)),vie=((die=Tie.prototype).setPoint=function(e,t){this.point.x=e,this.point.y=t},die.setDir=function(e,t){this.dir.x=e,this.dir.y=t},Tie),yie=Rre("MotionStreak",(tl=f("cc.MotionStreak"),Oa=Ep(),Sa=wp(),y=v(i0),tl(aie=Tp(aie=_s(aie=Oa(aie=Sa((l(bie,_ie=h4),(fie=bie.prototype).onEnable=function(){_ie.prototype.onEnable.call(this),this.reset()},fie._flushAssembler=function(){var e=bie.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},fie.onFocusInEditor=function(){this._preview&&this.reset()},fie.onLostFocusInEditor=function(){this._preview&&this.reset()},fie.reset=function(){this._points.length=0,this._renderData&&this._renderData.clear()},fie.lateUpdate=function(e){this._assembler&&this._assembler.update(this,e)},fie._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},e(bie,[{key:"preview",get:function(){return this._preview},set:function(e){this._preview=e,this.reset()}},{key:"fadeTime",get:function(){return this._fadeTime},set:function(e){this._fadeTime=e,this.reset()}},{key:"minSeg",get:function(){return this._minSeg},set:function(e){this._minSeg=e}},{key:"stroke",get:function(){return this._stroke},set:function(e){this._stroke=e}},{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e)}},{key:"fastMode",get:function(){return this._fastMode},set:function(e){this._fastMode=e}},{key:"points",get:function(){return this._points}}]),bie.Point=vie,i((a=bie).prototype,"preview",[Ap],Object.getOwnPropertyDescriptor(a.prototype,"preview"),a.prototype),i(a.prototype,"fadeTime",[Ap],Object.getOwnPropertyDescriptor(a.prototype,"fadeTime"),a.prototype),i(a.prototype,"minSeg",[Ap],Object.getOwnPropertyDescriptor(a.prototype,"minSeg"),a.prototype),i(a.prototype,"stroke",[Ap],Object.getOwnPropertyDescriptor(a.prototype,"stroke"),a.prototype),i(a.prototype,"texture",[y],Object.getOwnPropertyDescriptor(a.prototype,"texture"),a.prototype),i(a.prototype,"fastMode",[Ap],Object.getOwnPropertyDescriptor(a.prototype,"fastMode"),a.prototype),sie=i(a.prototype,"_preview",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cie=i(a.prototype,"_fadeTime",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lie=i(a.prototype,"_minSeg",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uie=i(a.prototype,"_stroke",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),hie=i(a.prototype,"_texture",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pie=i(a.prototype,"_fastMode",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),aie=a))||aie)||aie)||aie)||aie)||aie)),xie=(new U,new U),Sie=new U;function bie(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=_ie.call.apply(_ie,[this].concat(i))||this,"_preview",sie,p(e)),_(e,"_fadeTime",cie,p(e)),_(e,"_minSeg",lie,p(e)),_(e,"_stroke",uie,p(e)),_(e,"_texture",hie,p(e)),_(e,"_fastMode",pie,p(e)),e._points=[],e}function Tie(e,t){this.point=new U,this.dir=new U,this.distance=0,this.time=0,e&&this.point.set(e),t&&this.dir.set(t)}function Eie(){var e;return _(e=mie.call(this)||this,"duration",_te,p(e)),_(e,"emissionRate",fte,p(e)),_(e,"life",dte,p(e)),_(e,"lifeVar",mte,p(e)),_(e,"angle",gte,p(e)),_(e,"angleVar",vte,p(e)),_(e,"startSize",yte,p(e)),_(e,"startSizeVar",xte,p(e)),_(e,"endSize",Ste,p(e)),_(e,"endSizeVar",bte,p(e)),_(e,"startSpin",Tte,p(e)),_(e,"startSpinVar",Ete,p(e)),_(e,"endSpin",Cte,p(e)),_(e,"endSpinVar",wte,p(e)),_(e,"sourcePos",Ate,p(e)),_(e,"posVar",Pte,p(e)),_(e,"emitterMode",Ite,p(e)),_(e,"gravity",Rte,p(e)),_(e,"speed",Dte,p(e)),_(e,"speedVar",Ote,p(e)),_(e,"tangentialAccel",Mte,p(e)),_(e,"tangentialAccelVar",Nte,p(e)),_(e,"radialAccel",Lte,p(e)),_(e,"radialAccelVar",Bte,p(e)),_(e,"rotationIsDir",Fte,p(e)),_(e,"startRadius",zte,p(e)),_(e,"startRadiusVar",Ute,p(e)),_(e,"endRadius",kte,p(e)),_(e,"endRadiusVar",Gte,p(e)),_(e,"rotatePerS",Hte,p(e)),_(e,"rotatePerSVar",Vte,p(e)),e.aspectRatio=1,_(e,"playOnLoad",jte,p(e)),_(e,"autoRemoveOnFinish",Wte,p(e)),_(e,"_preview",qte,p(e)),_(e,"_custom",Xte,p(e)),_(e,"_file",Yte,p(e)),_(e,"_spriteFrame",Kte,p(e)),_(e,"_totalParticles",Qte,p(e)),_(e,"_startColor",Zte,p(e)),_(e,"_startColorVar",Jte,p(e)),_(e,"_endColor",$te,p(e)),_(e,"_endColorVar",eie,p(e)),_(e,"_positionType",tie,p(e)),e._stopped=!0,e.initProperties(),e}var Cie={createData:function(e){e=e.requestRenderData();return e.dataLength=4,e.resize(16,42),e},update:function(e,t){var i,n=e.stroke/2,r=e.node.worldMatrix,o=r.m12,r=r.m13,a=e.points;1<a.length&&((c=(l=a[0]).point.x-o)*c+(c=l.point.y-r)*c<e.minSeg&&(i=l)),i||(i=new yie.Point,a.unshift(i)),i.setPoint(o,r),i.time=e.fadeTime+t;var s=0;if(!(a.length<2)){var c=e.renderData,l=(this.updateRenderDataCache(e,c),e.color),u=l.r,h=l.g,p=l.b,_=l.a,o=a[1];o.distance=U.subtract(Sie,i.point,o.point).length(),Sie.normalize(),o.setDir(Sie.x,Sie.y),i.setDir(Sie.x,Sie.y),c.dataLength=2*a.length;for(var f=c.data,d=e.fadeTime,m=!1,g=a.length-1;0<=g;g--){var v=a[g],y=v.point,x=v.dir;if(v.time-=t,v.time<0)a.splice(g,1);else{var v=v.time/d,S=a[g-1];if(!m){if(!S){a.splice(g,1);continue}y.x=S.point.x-x.x*v,y.y=S.point.y-x.y*v}m=!0,S=x,(x=xie).x=-S.y,x.y=S.x;x=(v*_<<24>>>0)+(p<<16)+(h<<8)+u,S=s;f[S].x=y.x+xie.x*n,f[S].y=y.y+xie.y*n,f[S].u=1,f[S].v=v,f[S].color._val=x,f[S+=1].x=y.x-xie.x*n,f[S].y=y.y-xie.y*n,f[S].u=0,f[S].v=v,f[S].color._val=x,s+=2}}c.resize(s,s<=2?0:3*(s-2))}},updateRenderDataCache:function(e,t){t.passDirty&&t.updatePass(e),t.nodeDirty&&t.updateNode(e),t.textureDirty&&e.texture&&(t.updateTexture(e.texture),t.material=e.getRenderMaterial(0)),t.hashDirty&&t.updateHash()},updateRenderData:function(){},fillBuffers:function(e){for(var e=e.renderData,t=e.chunk,i=e.data,n=e.vertexCount,r=e.indexCount,o=t.vb,a=0,s=0;s<n;s++){var c=i[s];o[a++]=c.x,o[a++]=c.y,o[a++]=c.z,o[a++]=c.u,o[a++]=c.v,nr.toArray(o,c.color,a),a+=4}for(var l=t.bufferId,u=t.vertexOffset,h=t.vertexAccessor.getMeshBuffer(t.bufferId),p=t.vertexAccessor.getIndexBuffer(l),_=h.indexOffset,f=0,d=r;f<d;f+=2){var m=u+f;p[_++]=m,p[_++]=m+2,p[_++]=m+1,p[_++]=m+1,p[_++]=m+2,p[_++]=m+3}h.indexOffset+=e.indexCount,h.setDirty()}},yU=Rre("MotionStreakAssemblerManager",{getAssembler:function(){return Cie}});yie.Assembler=yU;var wie,Aie,Pie,Iie,Rie,Die={maxParticleDeltaTime:0,createData:function(){return _z.add()},removeData:function(e){_z.remove(e)},updateRenderData:function(){},fillBuffers:function(){}},A=Rre("ParticleSystem2DAssembler",{getAssembler:function(){return Die.maxParticleDeltaTime||(Die.maxParticleDeltaTime=j.game.frameTime/1e3*2),Die}});gie.Assembler=A,(Rie=wie=wie||{}).PLAYED="play",Rie.PAUSED="pause",Rie.STOPPED="stop",Rie.SEEKED="seeked",Rie.ENDED="ended",Rie.INTERRUPTION_BEGIN="interruptionBegin",Rie.INTERRUPTION_END="interruptionEnd",Rie.USER_GESTURE="on_gesture",(Fp=Aie=Aie||{})[Fp.DOM_AUDIO=0]="DOM_AUDIO",Fp[Fp.WEB_AUDIO=1]="WEB_AUDIO",Fp[Fp.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",Fp[Fp.NATIVE_AUDIO=3]="NATIVE_AUDIO",Fp[Fp.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO",(Iie=Pie=Pie||{})[Iie.INIT=0]="INIT",Iie[Iie.PLAYING=1]="PLAYING",Iie[Iie.PAUSED=2]="PAUSED",Iie[Iie.STOPPED=3]="STOPPED",Iie[Iie.INTERRUPTED=4]="INTERRUPTED";var Oie=0;function Mie(e,t,i){var o=i.value;i.value=function(){for(var n=this,e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];return new Promise(function(e){var t=Oie++,i=n;i._operationQueue.push({id:t,func:o,args:r,invoking:!1}),i._eventTarget.once(t.toString(),e),function t(i,n){var e;n.invoking||(n.invoking=!0,(e=n.func).call.apply(e,[i].concat(n.args)).then(function(){n.invoking=!1,i._operationQueue.shift(),i._eventTarget.emit(n.id.toString());var e=i._operationQueue[0];e&&t(i,e)}).catch(function(){}))}(i,i._operationQueue[0])})}}function Nie(n){return new Promise(function(i){var e=n.play();return void 0===e?i():(e.then(i).catch(function(){function e(){n.play().catch(function(){}),i()}var t=document.getElementById("GameCanvas");null!=t&&t.addEventListener("touchend",e,{once:!0}),null!=t&&t.addEventListener("mousedown",e,{once:!0})}),null)})}(hl=Wie.prototype).play=function(){var t=this;Nie(this._domAudio).then(function(){var e;null!=(e=t.onPlay)&&e.call(t)}).catch(function(){})},hl.stop=function(){this._domAudio.pause()},e(Wie,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),(this._onEndCb=e)&&this._domAudio.addEventListener("ended",e)}}]);var Lie,Bie=Wie,Fie=(i(((Nk=jie.prototype).destroy=function(){Qi.off("hide",this._onHide,this),Qi.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},jie.load=function(e){return new Promise(function(t){jie.loadNative(e).then(function(e){t(new jie(e))}).catch(function(){})})},jie.loadNative=function(c){return new Promise(function(e,t){function i(){clearTimeout(o),n.removeEventListener(r,a,!1),n.removeEventListener("error",s,!1)}var n=document.createElement("audio"),r="canplaythrough",o=(Qi.os===Wi.IOS?r="loadedmetadata":Qi.browserType===Hi.FIREFOX&&(r="canplay"),setTimeout(function(){(0===n.readyState?s:a)()},8e3)),a=function(){i(),e(n)},s=function(){i(),t("load audio failure - "+c)};n.addEventListener(r,a,!1),n.addEventListener("error",s,!1),n.src=c})},jie.loadOneShotAudio=function(i,n){return new Promise(function(t,e){jie.loadNative(i).then(function(e){e=new Bie(e,n);t(e)}).catch(e)})},Nk._onHide=function(){var e=this;this._state===Pie.PLAYING&&this.pause().then(function(){e._state=Pie.INTERRUPTED,e._eventTarget.emit(wie.INTERRUPTION_BEGIN)}).catch(function(){})},Nk._onShow=function(){var e=this;this._state===Pie.INTERRUPTED&&this.play().then(function(){e._eventTarget.emit(wie.INTERRUPTION_END)}).catch(function(){})},Nk.seek=function(e){return e=Fn(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},Nk.play=function(){var t=this;return new Promise(function(e){Nie(t._domAudio).then(function(){t._state=Pie.PLAYING,e()}).catch(function(){})})},Nk.pause=function(){return this._domAudio.pause(),this._state=Pie.PAUSED,Promise.resolve()},Nk.stop=function(){var t=this;return new Promise(function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=Pie.STOPPED,e()})},Nk.onInterruptionBegin=function(e){this._eventTarget.on(wie.INTERRUPTION_BEGIN,e)},Nk.offInterruptionBegin=function(e){this._eventTarget.off(wie.INTERRUPTION_BEGIN,e)},Nk.onInterruptionEnd=function(e){this._eventTarget.on(wie.INTERRUPTION_END,e)},Nk.offInterruptionEnd=function(e){this._eventTarget.off(wie.INTERRUPTION_END,e)},Nk.onEnded=function(e){this._eventTarget.on(wie.ENDED,e)},Nk.offEnded=function(e){this._eventTarget.off(wie.ENDED,e)},e(jie,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return Aie.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=zn(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),Pc=jie).prototype,"seek",[Mie],Object.getOwnPropertyDescriptor(Pc.prototype,"seek"),Pc.prototype),i(Pc.prototype,"play",[Mie],Object.getOwnPropertyDescriptor(Pc.prototype,"play"),Pc.prototype),i(Pc.prototype,"pause",[Mie],Object.getOwnPropertyDescriptor(Pc.prototype,"pause"),Pc.prototype),i(Pc.prototype,"stop",[Mie],Object.getOwnPropertyDescriptor(Pc.prototype,"stop"),Pc.prototype),Pc),zie=((x=Vie.prototype).destroy=function(){this._nativeAudio=void 0},x._now=function(){return performance.now()/1e3},x._calculateCurrentTime=function(){var e=this._now()-this._startTime,e=this._startOffset+e;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},x.start=function(){this._isPaused=!1,this._startTime=this._now()},x.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},x.stop=function(){this._isPaused=!0,this._startOffset=0},x.seek=function(e){this._startTime=this._now(),this._startOffset=Fn(e,0,this.duration)},e(Vie,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),Vie),Uie=((vI=Hie.prototype).addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},vI.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},vI.getCache=function(e){e=this._audioBufferDataMap[e];return null==e?void 0:e.audioBuffer},vI.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},new Hie),Up=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,kie=((o=Gie.prototype).decodeAudioData=function(i){var n=this;return new Promise(function(t){var e=n._context.decodeAudioData(i,function(e){t(e)},function(e){console.error("failed to load Web Audio",e)});null!=e&&e.catch(function(){})})},o.runContext=function(){var r=this;return new Promise(function(e){var t,i,n=r._context;n.resume&&"running"!==n.state?(i=function(){n.resume().then(e).catch(function(){})},null!=(t=document.getElementById("GameCanvas"))&&t.addEventListener("touchend",i,{once:!0,capture:!0}),null!=t&&t.addEventListener("mouseup",i,{once:!0,capture:!0})):e()})},o.createBufferSource=function(e,t){var i=this._context.createBufferSource();return void 0!==e&&(i.buffer=e),void 0!==t&&(i.loop=t),i},o.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},o.setGainValue=function(t,i){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(i,this._context.currentTime,0)}catch(e){t.gain.setTargetAtTime(i,this._context.currentTime,.01)}else t.gain.value=i},o.connectContext=function(e){this._context&&e.connect(this._context.destination)},e(Gie,[{key:"currentTime",get:function(){return this._context.currentTime}}]),Gie);function Gie(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}function Hie(){this._audioBufferDataMap={}}function Vie(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}function jie(e){var t=this;this._domAudio=void 0,this._state=Pie.INIT,this._onEnded=void 0,this._eventTarget=new Ki,this._operationQueue=[],this._domAudio=e,Qi.on("hide",this._onHide,this),Qi.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch(function(){}),t._state=Pie.INIT,t._eventTarget.emit(wie.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}function Wie(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,(this._domAudio=e).volume=t}kie.support=!!Up,kie.support&&(Lie=new kie);(R=ene.prototype).play=function(){var t=this;this._bufferSourceNode.start(),Lie.runContext().then(function(){var e;null!=(e=t.onPlay)&&e.call(t),t._currentTimer=window.setTimeout(function(){var e;Uie.tryReleasingCache(t._url),null!=(e=t.onEnd)&&e.call(t)},1e3*t._duration)}).catch(function(){})},R.stop=function(){clearTimeout(this._currentTimer),Uie.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},e(ene,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]);var qie,R,Xie=ene,Yie=(i(((S=$ie.prototype).destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),Uie.tryReleasingCache(this._src),Qi.off("hide",this._onHide,this),Qi.off("show",this._onShow,this)},$ie.load=function(i){return new Promise(function(t){$ie.loadNative(i).then(function(e){t(new $ie(e,i))}).catch(function(){})})},$ie.loadNative=function(o){return new Promise(function(t,e){var i=Uie.getCache(o);if(i)return Uie.retainCache(o),void t(i);var n=new XMLHttpRequest,r="load audio failed: "+o+", status: ";n.open("GET",o,!0),n.responseType="arraybuffer",n.onload=function(){200===n.status||0===n.status?Lie.decodeAudioData(n.response).then(function(e){Uie.addCache(o,e),t(e)}).catch(function(){}):e(new Error(r+n.status+"(no response)"))},n.onerror=function(){e(new Error(r+n.status+"(error)"))},n.ontimeout=function(){e(new Error(r+n.status+"(time out)"))},n.onabort=function(){e(new Error(r+n.status+"(abort)"))},n.send(null)})},$ie.loadOneShotAudio=function(i,n){return new Promise(function(t,e){$ie.loadNative(i).then(function(e){e=new Xie(e,n,i);t(e)}).catch(e)})},S._onHide=function(){var e=this;this._state===Pie.PLAYING&&this.pause().then(function(){e._state=Pie.INTERRUPTED,e._eventTarget.emit(wie.INTERRUPTION_BEGIN)}).catch(function(){})},S._onShow=function(){var e=this;this._state===Pie.INTERRUPTED&&this.play().then(function(){e._eventTarget.emit(wie.INTERRUPTION_END)}).catch(function(){})},S.seek=function(t){var i=this;return new Promise(function(e){i._audioTimer.seek(t),i._state===Pie.PLAYING?i._doPlay().then(e).catch(function(){}):e()})},S.play=function(){return this._doPlay()},S._doPlay=function(){var t=this;return new Promise(function(e){t._stopSourceNode(),t._sourceNode=Lie.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),Lie.runContext().then(function(){t._state=Pie.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout(function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(wie.ENDED),t._state=Pie.INIT)},1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()}).catch(function(){})})},S._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},S.pause=function(){return this._state===Pie.PLAYING&&this._sourceNode&&(this._audioTimer.pause(),this._state=Pie.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode()),Promise.resolve()},S.stop=function(){return this._sourceNode&&(this._audioTimer.stop(),this._state=Pie.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode()),Promise.resolve()},S.onInterruptionBegin=function(e){this._eventTarget.on(wie.INTERRUPTION_BEGIN,e)},S.offInterruptionBegin=function(e){this._eventTarget.off(wie.INTERRUPTION_BEGIN,e)},S.onInterruptionEnd=function(e){this._eventTarget.on(wie.INTERRUPTION_END,e)},S.offInterruptionEnd=function(e){this._eventTarget.off(wie.INTERRUPTION_END,e)},S.onEnded=function(e){this._eventTarget.on(wie.ENDED,e)},S.offEnded=function(e){this._eventTarget.off(wie.ENDED,e)},e($ie,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return Aie.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=zn(e),this._volume=e,Lie.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),cM=$ie).prototype,"seek",[Mie],Object.getOwnPropertyDescriptor(cM.prototype,"seek"),cM.prototype),i(cM.prototype,"play",[Mie],Object.getOwnPropertyDescriptor(cM.prototype,"play"),cM.prototype),i(cM.prototype,"pause",[Mie],Object.getOwnPropertyDescriptor(cM.prototype,"pause"),cM.prototype),i(cM.prototype,"stop",[Mie],Object.getOwnPropertyDescriptor(cM.prototype,"stop"),cM.prototype),cM),Kie=((yI=Jie.prototype).play=function(){this._audio.play()},yI.stop=function(){this._audio.stop()},e(Jie,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),Jie),Qie=(Zie.load=function(e,i){return new Promise(function(t){(null==i?void 0:i.audioLoadMode)!==Aie.DOM_AUDIO&&kie.support?Yie.load(e).then(function(e){t(new Zie(e))}).catch(function(){}):(kie.support||J(5201),Fie.load(e).then(function(e){t(new Zie(e))}).catch(function(){}))})},(kp=Zie.prototype).destroy=function(){this._player.destroy()},Zie.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==Aie.DOM_AUDIO&&kie.support?Yie.loadNative(e):(kie.support||J(5201),Fie.loadNative(e))},Zie.loadOneShotAudio=function(i,n,r){return new Promise(function(t,e){(null==r?void 0:r.audioLoadMode)!==Aie.DOM_AUDIO&&kie.support?Yie.loadOneShotAudio(i,n).then(function(e){t(new Kie(e))}).catch(e):(kie.support||J(5201),Fie.loadOneShotAudio(i,n).then(function(e){t(new Kie(e))}).catch(e))})},kp.seek=function(e){return this._player.seek(e)},kp.play=function(){return this._player.play()},kp.pause=function(){return this._player.pause()},kp.stop=function(){return this._player.stop()},kp.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},kp.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},kp.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},kp.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},kp.onEnded=function(e){this._player.onEnded(e)},kp.offEnded=function(e){this._player.offEnded(e)},e(Zie,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),Zie);function Zie(e){this._player=void 0,this._player=e}function Jie(e){this._audio=void 0,this._audio=e}function $ie(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=Pie.INIT,this._audioTimer=void 0,this._eventTarget=new Ki,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new zie(e),this._gainNode=Lie.createGain(),Lie.connectContext(this._gainNode),this._src=t,Qi.on("hide",this._onHide,this),Qi.on("show",this._onShow,this)}function ene(e,t,i){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=i,this._bufferSourceNode=Lie.createBufferSource(e,!1);i=Lie.createGain(t);this._bufferSourceNode.connect(i),Lie.connectContext(i)}Qie.maxAudioChannel=24;var tne,ine=Rre("AudioClip",f("cc.AudioClip")((l(nne,tne=P_),(Hd=nne.prototype).destroy=function(){var e,t=tne.prototype.destroy.call(this);return null!=(e=this._player)&&e.destroy(),this._player=null,this._meta&&(this._meta.player=null),t},Hd.validate=function(){return!!this._meta},Hd.getDuration=function(){return this._duration||(this._meta?this._meta.duration:0)},Hd.getCurrentTime=function(){return this._player?this._player.currentTime:0},Hd.getVolume=function(){return this._player?this._player.volume:0},Hd.getLoop=function(){return!!this._player&&this._player.loop},Hd.setCurrentTime=function(e){var t;null!=(t=this._player)&&t.seek(e).catch(function(){})},Hd.setVolume=function(e){this._player&&(this._player.volume=e)},Hd.setLoop=function(e){this._player&&(this._player.loop=e)},Hd.play=function(){var e;null!=(e=this._player)&&e.play().catch(function(){})},Hd.pause=function(){var e;null!=(e=this._player)&&e.pause().catch(function(){})},Hd.stop=function(){var e;null!=(e=this._player)&&e.stop().catch(function(){})},Hd.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&Qie.loadOneShotAudio(this._nativeAsset.url,e).then(function(e){e.play()}).catch(function(){})},e(nne,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){(this._meta=e)?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=Aie.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:Pie.INIT}}]),nne.AudioType=Aie,qie=i((gl=nne).prototype,"_duration",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),i(gl.prototype,"_nativeDep",[Gp],Object.getOwnPropertyDescriptor(gl.prototype,"_nativeDep"),gl.prototype),m=gl))||m);function nne(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=tne.call.apply(tne,[this].concat(i))||this,"_duration",qie,p(e)),e._loadMode=Aie.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}function rne(t,e,i){Qie.load(t,{audioLoadMode:e.audioLoadMode}).then(function(e){e={player:e,url:t,duration:e.duration,type:e.type};i(null,e)}).catch(function(e){i(e)})}function one(e,t,i,n){var r=new ine;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,n(null,r)}j.AudioClip=ine,sR.register({".mp3":rne,".ogg":rne,".wav":rne,".m4a":rne}),dR.register({".mp3":one,".ogg":one,".wav":one,".m4a":one});(uI=_ne.prototype)._findIndex=function(e,t){return e.findIndex(function(e){return e.audio===t})},uI._tryAddPlaying=function(e,t){var i=this._findIndex(e,t);return-1<i?(e[i].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},uI.addPlaying=function(e){e instanceof Qie?this._tryAddPlaying(this._audioPlayerInfoList,e):this._tryAddPlaying(this._oneShotAudioInfoList,e)},uI._tryRemovePlaying=function(e,t){t=this._findIndex(e,t);return-1!==t&&(Se(e,t),!0)},uI.removePlaying=function(e){e instanceof Qie?this._tryRemovePlaying(this._audioPlayerInfoList,e):this._tryRemovePlaying(this._oneShotAudioInfoList,e)},uI.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<Qie.maxAudioChannel||(0<this._oneShotAudioInfoList.length?this._oneShotAudioInfoList.forEach(function(e){(!t||e.playTime<t.playTime)&&(t=e)}):this._audioPlayerInfoList.forEach(function(e){(!t||e.playTime<t.playTime)&&(t=e)}),t&&(t.audio.stop(),this.removePlaying(t.audio)))};var ane,sne,cne,lne,une,hne,pne=new _ne;function _ne(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}(Ac=hne=hne||{}).STARTED="started",Ac.ENDED="ended";W3=f("cc.AudioSource"),Xp=wp(),Ip=Ep(),Lp=v(ine),ane=v(ine),dU=u(),Lc=u(),s=u(),Ce=Dp(),h=u(),Y3=W3(L6=Xp(L6=Ip((l(dne,fne=W_),(Rp=dne.prototype)._syncPlayer=function(){var t=this,i=this._clip;this._isLoaded=!1,this._lastSetClip!==i&&(i?i._nativeAsset?(this._lastSetClip=i,Qie.load(i._nativeAsset.url,{audioLoadMode:i.loadMode}).then(function(e){t._lastSetClip===i?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),(t._player=e).onEnded(function(){pne.removePlaying(e),t.node.emit(hne.ENDED,t)}),e.onInterruptionBegin(function(){pne.removePlaying(e)}),e.onInterruptionEnd(function(){pne.addPlaying(e)}),t._syncStates()):e.destroy()}).catch(function(){})):console.error("Invalid audio clip"):this._lastSetClip=null)},Rp.onLoad=function(){this._syncPlayer()},Rp.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},Rp.onDisable=function(){var e=this._getRootNode();null!=e&&e._persistNode||this.pause()},Rp.onDestroy=function(){var e;this.stop(),null!=(e=this._player)&&e.destroy(),this._player=null},Rp._getRootNode=function(){for(var e,t=this.node,i=null==(e=t)||null==(e=e.parent)?void 0:e.parent;i;)var n,i=null==(n=t=null==(n=t)?void 0:n.parent)||null==(n=n.parent)?void 0:n.parent;return t},Rp.play=function(){var e,t=this;this._isLoaded?(pne.discardOnePlayingIfNeeded(),this.state===Pie.PLAYING&&null!=(e=this._player)&&e.stop().catch(function(){}),null!=(e=this._player)&&e.play().then(function(){pne.addPlaying(t._player),t.node.emit(hne.STARTED,t)}).catch(function(){})):this._operationsBeforeLoading.push("play")},Rp.pause=function(){var e,t=this;this._isLoaded?null!=(e=this._player)&&e.pause().then(function(){pne.removePlaying(t._player)}).catch(function(){}):this._operationsBeforeLoading.push("pause")},Rp.stop=function(){var e,t=this;this._isLoaded?null!=(e=this._player)&&e.stop().then(function(){pne.removePlaying(t._player)}).catch(function(){}):this._operationsBeforeLoading.push("stop")},Rp.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?Qie.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then(function(e){pne.discardOnePlayingIfNeeded(),e.onPlay=function(){pne.addPlaying(e)},e.onEnd=function(){pne.removePlaying(e)},e.play()}).catch(function(){}):console.error("Invalid audio clip")},Rp._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then(function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach(function(e){null!=(e=t[e])&&e.call(t)}),t._operationsBeforeLoading.length=0)}).catch(function(){})},e(dne,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=Fn(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){Number.isNaN(e)?console.warn("illegal audio time!"):(e=Fn(e,0,this.duration),this._cachedCurrentTime=e,null!=(e=this._player)&&e.seek(this._cachedCurrentTime).catch(function(){}))}},{key:"duration",get:function(){var e;return null!=(e=null==(e=this._clip)?void 0:e.getDuration())?e:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:Pie.INIT}},{key:"playing",get:function(){return this.state===dne.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return Qie.maxAudioChannel}}]),n=C7=dne,C7.AudioState=Pie,C7.EventType=hne,sne=i((g=n).prototype,"_clip",[Lp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cne=i(g.prototype,"_loop",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lne=i(g.prototype,"_playOnAwake",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),une=i(g.prototype,"_volume",[d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),i(g.prototype,"clip",[ane,dU],Object.getOwnPropertyDescriptor(g.prototype,"clip"),g.prototype),i(g.prototype,"loop",[Lc],Object.getOwnPropertyDescriptor(g.prototype,"loop"),g.prototype),i(g.prototype,"playOnAwake",[s],Object.getOwnPropertyDescriptor(g.prototype,"playOnAwake"),g.prototype),i(g.prototype,"volume",[Ce,h],Object.getOwnPropertyDescriptor(g.prototype,"volume"),g.prototype),L6=g))||L6)||L6)||L6,Rre({AudioSource:Y3,AudioSourceComponent:Y3});var fne,ul=Y3;function dne(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return _(e=fne.call.apply(fne,[this].concat(i))||this,"_clip",sne,p(e)),e._player=null,_(e,"_loop",cne,p(e)),_(e,"_playOnAwake",lne,p(e)),_(e,"_volume",une,p(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}In(ine,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:ul,targetName:"AudioSource"}]),D(ine.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map(function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}})),j.AudioSourceComponent=ul,gt.setClassAlias(ul,"cc.AudioSourceComponent");(B1=gne.prototype).clone=function(){var e=new gne;return e.originalTarget=null,e.target=null,e.tag=this.tag,e},B1.isDone=function(){return!0},B1.startWithTarget=function(e){this.originalTarget=e,this.target=e},B1.stop=function(){this.target=null},B1.step=function(){ne(1006)},B1.update=function(){ne(1007)},B1.getTarget=function(){return this.target},B1.setTarget=function(e){this.target=e},B1.getOriginalTarget=function(){return this.originalTarget},B1.setOriginalTarget=function(e){this.originalTarget=e},B1.getTag=function(){return this.tag},B1.setTag=function(e){this.tag=e},B1.reverse=function(){return ne(1008),null},B1.retain=function(){},B1.release=function(){};var mne=gne;function gne(){this.originalTarget=null,this.target=null,this.tag=gne.TAG_INVALID}mne.TAG_INVALID=-1;function vne(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}l(Ine,Sne=mne),(il=Ine.prototype).getDuration=function(){return this._duration*(this._timesForRepeat||1)},il.setDuration=function(e){this._duration=e},il.clone=function(){return new Ine};var yne,xne,Sne,bne=Ine,Tne=(l(Pne,xne=mne),(Op=Pne.prototype).getSpeed=function(){return this._speed},Op.setSpeed=function(e){this._speed=e},Op.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(ee(1021),!1)},Op.clone=function(){var e=new Pne;return e.initWithAction(this._innerAction.clone(),this._speed),e},Op.startWithTarget=function(e){mne.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},Op.stop=function(){this._innerAction.stop(),mne.prototype.stop.call(this)},Op.step=function(e){this._innerAction.step(e*this._speed)},Op.isDone=function(){return this._innerAction.isDone()},Op.reverse=function(){return new Pne(this._innerAction.reverse(),this._speed)},Op.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},Op.getInnerAction=function(){return this._innerAction},0),Ene=((Z5=Ane.prototype)._searchElementByTarget=function(e,t){for(var i=0;i<e.length;i++)if(t===e[i].target)return e[i];return null},Z5._getElement=function(e,t){var i=this._elementPool.pop();return(i=i||new vne).target=e,i.paused=!!t,i},Z5._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},Z5.addAction=function(e,t,i){var n;e&&t?(null==t.uuid&&(t.uuid="_TWEEN_UUID_"+Tne++),(n=this._hashTargets.get(t))?n.actions||(n.actions=[]):(n=this._getElement(t,i),this._hashTargets.set(t,n),this._arrayTargets.push(n)),n.target=t,n.actions.push(e),e.startWithTarget(t)):ee(1e3)},Z5.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var i=e[t];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map},Z5.removeAllActionsFromTarget=function(e){null!=e&&(e=this._hashTargets.get(e))&&(e.actions.length=0,this._deleteHashElement(e))},Z5.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),i=this._hashTargets.get(t);if(i)for(var n=0;n<i.actions.length;n++)if(i.actions[n]===e){i.actions.splice(n,1),i.actionIndex>=n&&i.actionIndex--;break}}},Z5._removeActionByTag=function(e,t,i){for(var n=0,r=t.actions.length;n<r;++n){var o=t.actions[n];if(o&&o.getTag()===e&&(!i||o.getOriginalTarget()===i)){this._removeActionAtIndex(n,t);break}}},Z5._removeAllActionsByTag=function(e,t,i){for(var n=t.actions.length-1;0<=n;--n){var r=t.actions[n];!r||r.getTag()!==e||i&&r.getOriginalTarget()!==i||this._removeActionAtIndex(n,t)}},Z5.removeActionByTag=function(t,e){var i,n=this,r=(t===mne.TAG_INVALID&&ne(1002),this._hashTargets);e?(i=r.get(e))&&this._removeActionByTag(t,i,e):r.forEach(function(e){n._removeActionByTag(t,e)})},Z5.removeAllActionsByTag=function(t,e){var i,n=this,r=(t===mne.TAG_INVALID&&ne(1002),this._hashTargets);e?(i=r.get(e))&&this._removeAllActionsByTag(t,i,e):r.forEach(function(e){n._removeAllActionsByTag(t,e)})},Z5.getActionByTag=function(e,t){e===mne.TAG_INVALID&&ne(1004);var i=this._hashTargets.get(t);if(i){if(null!=i.actions)for(var n=0;n<i.actions.length;++n){var r=i.actions[n];if(r&&r.getTag()===e)return r}ne(1005,e)}return null},Z5.getNumberOfRunningActionsInTarget=function(e){e=this._hashTargets.get(e);return e&&e.actions?e.actions.length:0},Z5.pauseTarget=function(e){e=this._hashTargets.get(e);e&&(e.paused=!0)},Z5.resumeTarget=function(e){e=this._hashTargets.get(e);e&&(e.paused=!1)},Z5.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,i=0;i<t.length;i++){var n=t[i];n&&!n.paused&&(n.paused=!0,e.push(n.target))}return e},Z5.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},Z5.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},Z5.purgeSharedManager=function(){j.director.getScheduler().unscheduleUpdate(this)},Z5._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},Z5._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var i=this._arrayTargets,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}this._putElement(e),t=!0}return t},Z5.update=function(e){for(var t,i=this._arrayTargets,n=0;n<i.length;n++){this._currentTarget=i[n];var r,o=(t=this._currentTarget).target;if(o instanceof Pi&&!o.isValid)this.removeAllActionsFromTarget(o),n--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)t.currentAction=t.actions[t.actionIndex],t.currentAction&&(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()&&(t.currentAction.stop(),r=t.currentAction,t.currentAction=null,this.removeAction(r)),t.currentAction=null);t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&n--}}},Ane),Cne=Rre("TweenSystem",(l(wne,yne=PP),wne.prototype.update=function(e){this.actionMgr.update(e)},e(wne,[{key:"ActionManager",get:function(){return this.actionMgr}}]),wne));function wne(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=yne.call.apply(yne,[this].concat(i))||this).actionMgr=new Ene,e}function Ane(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}function Pne(e,t){var i;return void 0===t&&(t=1),(i=xne.call(this)||this)._speed=0,i._innerAction=null,e&&i.initWithAction(e,t),i}function Ine(){for(var e,t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(e=Sne.call.apply(Sne,[this].concat(i))||this)._duration=0,e._timesForRepeat=1,e}Cne.ID="TWEEN",Cne.instance=void 0,ZP.on(KP.EVENT_INIT,function(){var e=new Cne;Cne.instance=e,ZP.registerSystem(Cne.ID,e,PP.Priority.MEDIUM)});l(kne,One=bne),(Mne=kne.prototype).isDone=function(){return!0},Mne.step=function(){this.update(1)},Mne.update=function(){},Mne.reverse=function(){return this.clone()},Mne.clone=function(){return new kne};var Rne,Dne,One,Mne,Nne,Lne=kne,Bne=(l(Une,Dne=Lne),(kd=Une.prototype).update=function(){for(var e=this.target.getComponentsInChildren(ND),t=0;t<e.length;++t)e[t].enabled=!0},kd.reverse=function(){return new Fne},kd.clone=function(){return new Une},Une),Fne=(l(zne,Rne=Lne),(Gd=zne.prototype).update=function(){for(var e=this.target.getComponentsInChildren(ND),t=0;t<e.length;++t)e[t].enabled=!1},Gd.reverse=function(){return new Bne},Gd.clone=function(){return new zne},zne);function zne(){return Rne.apply(this,arguments)||this}function Une(){return Dne.apply(this,arguments)||this}function kne(){return One.apply(this,arguments)||this}function Gne(){return Nne.apply(this,arguments)||this}l(Gne,Nne=Lne),(Nw=Gne.prototype).update=function(){for(var e=this.target.getComponentsInChildren(ND),t=0;t<e.length;++t){var i=e[t];i.enabled=!i.enabled}},Nw.reverse=function(){return new Gne},Nw.clone=function(){return new Gne};l($ne,Wne=Lne),(nl=$ne.prototype).update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},nl.init=function(e){return this._isNeedCleanUp=e,!0},nl.reverse=function(){return new $ne(this._isNeedCleanUp)},nl.clone=function(){return new $ne(this._isNeedCleanUp)};var Hne,Vne,jne,Wne,qne=$ne,Xne=(l(Jne,jne=Lne),(Bp=Jne.prototype).initWithFunction=function(e,t,i){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==i&&(this._data=i),!0},Bp.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},Bp.update=function(){this.execute()},Bp.getTargetCallback=function(){return this._selectorTarget},Bp.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},Bp.clone=function(){var e=new Jne;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},Jne),Yne=(l(Zne,Vne=bne),(E=Zne.prototype).getElapsed=function(){return this._elapsed},E.initWithDuration=function(e){return this._duration=0===e?zt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0},E.isDone=function(){return this._elapsed>=this._duration},E._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},E._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},E.clone=function(){var e=new Zne(this._duration);return this._cloneDecoration(e),e},E.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},E._computeEaseTime=function(e){return e},E.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;e=(e=this._elapsed/(1.192092896e-7<this._duration?this._duration:1.192092896e-7))<1?e:1;this.update(0<e?e:0),this._repeatMethod&&1<this._timesForRepeat&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},E.startWithTarget=function(e){mne.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},E.reverse=function(){return ne(1010),this},E.setAmplitudeRate=function(){ne(1011)},E.getAmplitudeRate=function(){return ne(1012),0},E.speed=function(e){return e<=0?ne(1013):(this._speedMethod=!0,this._speed*=e),this},E.getSpeed=function(){return this._speed},E.setSpeed=function(e){return this._speed=e,this},E.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?ne(1014):(this._repeatMethod=!0,this._timesForRepeat*=e),this},E.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},Zne),Kne=(l(Qne,Hne=Yne),(E2=Qne.prototype).initWithTwoActions=function(e,t){if(!e||!t)return ee(1025),!1;var i=e._duration,n=t._duration,i=(i*=e._repeatMethod?e._timesForRepeat:1)+(n*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(i),this._actions[0]=e,this._actions[1]=t,!0},E2.clone=function(){var e=new Qne;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},E2.startWithTarget=function(e){Yne.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},E2.stop=function(){-1!==this._last&&this._actions[this._last].stop(),mne.prototype.stop.call(this)},E2.update=function(e){var t,i=0,n=this._split,r=this._actions,o=this._last;(e=this._computeEaseTime(e))<n?(t=0!==n?e/n:1,0===i&&1===o&&this._reversed&&(r[1].update(0),r[1].stop())):(t=(i=1)===n?1:(e-n)/(1-n),-1===o&&(r[0].startWithTarget(this.target),r[0].update(1),r[0].stop()),0===o&&(r[0].update(1),r[0].stop())),e=r[i],o===i&&e.isDone()||(o!==i&&e.startWithTarget(this.target),t*=e._timesForRepeat,e.update(1<t?t%1:t),this._last=i)},E2.reverse=function(){var e=Qne._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},Qne);function Qne(e){(t=Hne.call(this)||this)._actions=[],t._split=0,t._last=0,t._reversed=!1;var t,i=e instanceof Array?e:arguments;if(1===i.length)return ee(1019),p(t);var n=i.length-1;if(0<=n&&null==i[n]&&ne(1015),0<=n){for(var r,o=i[0],a=1;a<n;a++)i[a]&&(r=o,o=Qne._actionOneTwo(r,i[a]));t.initWithTwoActions(o,i[n])}return t}function Zne(e){var t;return(t=Vne.call(this)||this).MAX_VALUE=2,t._elapsed=0,t._firstTick=!1,t._easeList=[],t._speed=1,t._repeatForever=!1,t._repeatMethod=!1,t._speedMethod=!1,void 0===e||isNaN(e)||t.initWithDuration(e),t}function Jne(e,t,i){var n;return(n=jne.call(this)||this)._selectorTarget=null,n._function=null,n._data=null,n.initWithFunction(e,t,i),n}function $ne(e){var t;return(t=Wne.call(this)||this)._isNeedCleanUp=!0,void 0!==e&&t.init(e),t}function ere(e){var t=e instanceof Array?e:arguments;if(1===t.length)return ee(1019),null;var i=t.length-1,n=(0<=i&&null==t[i]&&ne(1015),null);if(0<=i)for(var n=t[0],r=1;r<=i;r++)t[r]&&(n=Kne._actionOneTwo(n,t[r]));return n}Kne._actionOneTwo=function(e,t){var i=new Kne;return i.initWithTwoActions(e,t),i};l(lre,nre=Yne),(b=lre.prototype).initWithAction=function(e,t){var i=e._duration*t;return!!this.initWithDuration(i)&&(this._times=t,(this._innerAction=e)instanceof Lne&&(this._actionInstant=!0,--this._times),!(this._total=0))},b.clone=function(){var e=new lre;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},b.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Yne.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},b.stop=function(){this._innerAction.stop(),mne.prototype.stop.call(this)},b.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,i=this._duration,n=this._times,r=this._nextDt;if(r<=e){for(;r<e&&this._total<n;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/i,this._nextDt=1<r?1:r;1<=e&&this._total<n&&(t.update(1),this._total++),this._actionInstant||(this._total===n?t.stop():t.update(e-(r-t._duration/i)))}else t.update(e*n%1)},b.isDone=function(){return this._total===this._times},b.reverse=function(){var e=new lre(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},b.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},b.getInnerAction=function(){return this._innerAction};var tre,ire,nre,rre=lre,ore=(l(cre,ire=Yne),(Mp=cre.prototype).initWithAction=function(e){return e?(this._innerAction=e,!0):(ee(1026),!1)},Mp.clone=function(){var e=new cre;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},Mp.startWithTarget=function(e){Yne.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},Mp.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},Mp.isDone=function(){return!1},Mp.reverse=function(){var e=new cre(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},Mp.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},Mp.getInnerAction=function(){return this._innerAction},cre),are=(l(sre,tre=Yne),(SJ=sre.prototype).initWithTwoActions=function(e,t){if(!e||!t)return ee(1027),!1;var i=!1,n=e._duration,r=t._duration;return this.initWithDuration(Math.max(n,r))&&(this._one=e,this._two=t,r<n?this._two=Kne._actionOneTwo(t,fre(n-r)):n<r&&(this._one=Kne._actionOneTwo(e,fre(r-n))),i=!0),i},SJ.clone=function(){var e=new sre;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},SJ.startWithTarget=function(e){Yne.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},SJ.stop=function(){this._one.stop(),this._two.stop(),mne.prototype.stop.call(this)},SJ.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},SJ.reverse=function(){var e=sre._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},sre);function sre(e){(t=tre.call(this)||this)._one=null,t._two=null;var t,i=e instanceof Array?e:arguments;if(1===i.length)return ee(1020),p(t);var n=i.length-1;if(0<=n&&null==i[n]&&ne(1015),0<=n){for(var r,o=i[0],a=1;a<n;a++)i[a]&&(r=o,o=sre._actionOneTwo(r,i[a]));t.initWithTwoActions(o,i[n])}return t}function cre(e){var t;return(t=ire.call(this)||this)._innerAction=null,e&&t.initWithAction(e),t}function lre(e,t){var i;return(i=nre.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==t&&i.initWithAction(e,t),i}function ure(e){var t=e instanceof Array?e:arguments;if(1===t.length)return ee(1020),null;0<t.length&&null==t[t.length-1]&&ne(1015);for(var i=t[0],n=1;n<t.length;n++)null!=t[n]&&(i=are._actionOneTwo(i,t[n]));return i}are._actionOneTwo=function(e,t){var i=new are;return i.initWithTwoActions(e,t),i};l(_re,hre=Yne),(EW=_re.prototype).update=function(){},EW.reverse=function(){var e=new _re(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},EW.clone=function(){var e=new _re;return this._cloneDecoration(e),e.initWithDuration(this._duration),e};var hre,pre=_re;function _re(){return hre.apply(this,arguments)||this}function fre(e){return new pre(e)}l(Are,yre=Yne),(GZ=Are.prototype).initWithAction=function(e){return e?e===this._other?(ee(1029),!1):!!Yne.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(ee(1028),!1)},GZ.clone=function(){var e=new Are;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},GZ.startWithTarget=function(e){Yne.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},GZ.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},GZ.reverse=function(){return this._other.clone()},GZ.stop=function(){this._other.stop(),mne.prototype.stop.call(this)};var dre,mre,gre,vre,yre,xre=Are,Sre=Rre("TweenAction",(l(wre,gre=Yne),(vre=wre.prototype).clone=function(){var e=new wre(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},vre.startWithTarget=function(e){Yne.prototype.startWithTarget.call(this,e);var t,i=!!this._opts.relative,n=this._props;for(t in n){var r=e[t];if(void 0!==r){var o=n[t],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=i?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=i?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},vre.update=function(e){var t=this.target;if(t){var i,n=this._props,r=this._opts,o=e,a=(r.easing&&(o=r.easing(e)),r.progress);for(i in n){var s=n[i],c=s.easing?s.easing(e):o,l=s.progress||a,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var p in u)s.current[p]=l(u[p],h[p],s.current[p],c);t[i]=s.current}r.onUpdate&&r.onUpdate(this.target,e),1===e&&r.onComplete&&r.onComplete(this.target)}},vre.progress=function(e,t,i,n){return e+(t-e)*n},wre)),bre=(l(Cre,dre=Lne),(mre=Cre.prototype).init=function(e){for(var t in e)this._props[t]=e[t];return!0},mre.update=function(){var e,t=this._props,i=this.target;for(e in t)i[e]=t[e]},mre.clone=function(){var e=new Cre;return e.init(this._props),e},Cre),Tre=Rre("Tween",((Ee=Ere.prototype).tag=function(e){return this._tag=e,this},Ee.then=function(e){return e instanceof mne?this._actions.push(e.clone()):this._actions.push(e._union()),this},Ee.target=function(e){return this._target=e,this},Ee.start=function(){return this._target?(this._finalAction&&Cne.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),Cne.instance.ActionManager.addAction(this._finalAction,this._target,!1)):V("Please set target to tween first"),this},Ee.stop=function(){return this._finalAction&&Cne.instance.ActionManager.removeAction(this._finalAction),this},Ee.clone=function(e){var t=this._union();return Pre(e).then(t.clone())},Ee.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},Ee.to=function(e,t,i){(i=i||Object.create(null)).relative=!1;e=new Sre(e,t,i);return this._actions.push(e),this},Ee.by=function(e,t,i){(i=i||Object.create(null)).relative=!0;e=new Sre(e,t,i);return this._actions.push(e),this},Ee.set=function(e){e=new bre(e);return this._actions.push(e),this},Ee.delay=function(e){e=fre(e);return this._actions.push(e),this},Ee.call=function(e){e=new Xne(e,void 0,void 0);return this._actions.push(e),this},Ee.sequence=function(){var e=Ere._wrappedSequence.apply(Ere,arguments);return this._actions.push(e),this},Ee.parallel=function(){var e=Ere._wrappedParallel.apply(Ere,arguments);return this._actions.push(e),this},Ee.repeat=function(e,t){if(e===1/0)return this.repeatForever(t);var i=this._actions,t=t instanceof Ere?t._union():i.pop();return i.push(new rre(t,e)),this},Ee.repeatForever=function(e){var t=this._actions,e=e instanceof Ere?e._union():t.pop();return t.push(new ore(e)),this},Ee.reverseTime=function(e){var t=this._actions,e=e instanceof Ere?e._union():t.pop();return t.push(new xre(e)),this},Ee.hide=function(){var e=new Fne;return this._actions.push(e),this},Ee.show=function(){var e=new Bne;return this._actions.push(e),this},Ee.removeSelf=function(){var e=new qne(!1);return this._actions.push(e),this},Ere.stopAll=function(){Cne.instance.ActionManager.removeAllActions()},Ere.stopAllByTag=function(e,t){Cne.instance.ActionManager.removeAllActionsByTag(e,t)},Ere.stopAllByTarget=function(e){Cne.instance.ActionManager.removeAllActionsFromTarget(e)},Ee._union=function(){var e=this._actions;return 1===e.length?e[0]:ere(e)},Ee._destroy=function(){this.stop()},Ere._wrappedSequence=function(){var e=Ere._tmp_args;e.length=0;for(var t=arguments.length,i=0;i<t;i++){var n=e[i]=i<0||arguments.length<=i?void 0:arguments[i];n instanceof Ere&&(e[i]=n._union())}return ere.apply(ere,e)},Ere._wrappedParallel=function(){var e=Ere._tmp_args;e.length=0;for(var t=arguments.length,i=0;i<t;i++){var n=e[i]=i<0||arguments.length<=i?void 0:arguments[i];n instanceof Ere&&(e[i]=n._union())}return ure.apply(ure,e)},Ere));function Ere(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=mne.TAG_INVALID,this._target=void 0===e?null:e}function Cre(e){var t;return(t=dre.call(this)||this)._props=void 0,t._props={},void 0!==e&&t.init(e),t}function wre(e,t,i){var n,r,o,a,s,c,l,u,h;for(s in(n=gre.call(this)||this)._opts=void 0,n._props=void 0,n._originProps=void 0,null==i?i=Object.create(null):(r=" [Tween:] ",o=" option is not support in v + "+O,(a=i).delay&&V(r+"delay"+o),a.repeat&&V(r+"repeat"+o),a.repeatDelay&&V(r+"repeatDelay"+o),a.interpolation&&V(r+"interpolation"+o),a.onStop&&V(r+"onStop"+o),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){t=(e=e.replace(t,t.toLowerCase())).split("-");if(2===t.length){var i=t[0];if("linear"===i)e="linear";else{var n=t[1];switch(i){case"quadratic":e="quad"+n;break;case"quartic":e="quart"+n;break;case"quintic":e="quint"+n;break;case"sinusoidal":e="sine"+n;break;case"exponential":e="expo"+n;break;case"circular":e="circ"+n;break;default:e=i+n}}}}return e}(i.easing)),i.progress||(i.progress=n.progress),i.easing&&"string"==typeof i.easing&&(a=i.easing,i.easing=Wd[a],i.easing||J(1031,a))),n._opts=i,n._props=Object.create(null),t)!t.hasOwnProperty(s)||null!=(c="function"==typeof(c=t[s])?c():c)&&"string"!=typeof c&&((u=l=void 0)!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?(l=Wd[c.easing])||J(1031,c.easing):l=c.easing,u=c.progress,c=c.value),(h=Object.create(null)).value=c,h.easing=l,h.progress=u,n._props[s]=h);return n._originProps=t,n.initWithDuration(e),n}function Are(e){var t;return(t=yre.call(this)||this)._other=null,e&&t.initWithAction(e),t}function Pre(e){return new Tre(e)}function Ire(e){return V("tweenUtil' is deprecated, please use 'tween' instead "),new Tre(e)}Tre._tmp_args=[],j.Tween=Tre,j.tween=Pre,j.tweenUtil=Ire}}});